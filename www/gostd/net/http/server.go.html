<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3550159">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3550214">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3550268">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3550319">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3550351">package</span>&nbsp;<span class="ident" id="3550359">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3550365">import</span>&nbsp;<span class="op" id="3550372">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550375">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550384">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550398">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550408">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550415">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550421">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550434">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550441">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550448">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550459">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550465">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550473">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550484">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550495">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550506">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550514">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550529">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3550536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3550539">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3550580">var</span>&nbsp;<span class="op" id="3550584">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550587">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3550606">=</span>&nbsp;<span class="ident" id="3550608">errors</span><span class="op" id="3550614">.</span><span class="ident" id="3550615">New</span><span class="op" id="3550618">(</span><span class="string" id="3550619">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3550650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550653">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3550672">=</span>&nbsp;<span class="ident" id="3550674">errors</span><span class="op" id="3550680">.</span><span class="ident" id="3550681">New</span><span class="op" id="3550684">(</span><span class="string" id="3550685">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3550751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550754">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3550773">=</span>&nbsp;<span class="ident" id="3550775">errors</span><span class="op" id="3550781">.</span><span class="ident" id="3550782">New</span><span class="op" id="3550785">(</span><span class="string" id="3550786">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3550810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550813">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3550832">=</span>&nbsp;<span class="ident" id="3550834">errors</span><span class="op" id="3550840">.</span><span class="ident" id="3550841">New</span><span class="op" id="3550844">(</span><span class="string" id="3550845">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3550901">)</span><br>
<span class="lineno">35</span><span class="op" id="3550903">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3550906">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3550959">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3551011">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3551034">//</span><br>
<span class="lineno"></span><span class="comment" id="3551037">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3551108">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3551176">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3551239">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3551258">//</span><br>
<span class="lineno"></span><span class="comment" id="3551261">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3551330">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3551398">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3551468">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3551500">//</span><br>
<span class="lineno"></span><span class="keyword" id="3551503">type</span>&nbsp;<span class="ident" id="3551508">Handler</span>&nbsp;<span class="keyword" id="3551516">interface</span>&nbsp;<span class="op" id="3551526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3551529">ServeHTTP</span><span class="op" id="3551538">(</span><span class="ident" id="3551539">ResponseWriter</span><span class="op" id="3551553">,</span>&nbsp;<span class="op" id="3551555">*</span><span class="ident" id="3551556">Request</span><span class="op" id="3551563">)</span><br>
<span class="lineno"></span><span class="op" id="3551565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3551568">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3551628">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3551659">type</span>&nbsp;<span class="ident" id="3551664">ResponseWriter</span>&nbsp;<span class="keyword" id="3551679">interface</span>&nbsp;<span class="op" id="3551689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3551692">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3551760">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3551827">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3551842">Header</span><span class="op" id="3551848">(</span><span class="op" id="3551849">)</span>&nbsp;<span class="ident" id="3551851">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3551860">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3551930">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552013">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552076">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552154">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552218">Write</span><span class="op" id="3552223">(</span><span class="op" id="3552224">[</span><span class="op" id="3552225">]</span><span class="builtintype" id="3552226">byte</span><span class="op" id="3552230">)</span>&nbsp;<span class="op" id="3552232">(</span><span class="builtintype" id="3552233">int</span><span class="op" id="3552236">,</span>&nbsp;<span class="builtintype" id="3552238">error</span><span class="op" id="3552243">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552247">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552311">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552380">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552437">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552495">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552517">WriteHeader</span><span class="op" id="3552528">(</span><span class="builtintype" id="3552529">int</span><span class="op" id="3552532">)</span><br>
<span class="lineno"></span><span class="op" id="3552534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3552537">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3552607">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3552664">//</span><br>
<span class="lineno"></span><span class="comment" id="3552667">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3552725">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3552778">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3552843">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3552857">type</span>&nbsp;<span class="ident" id="3552862">Flusher</span>&nbsp;<span class="keyword" id="3552870">interface</span>&nbsp;<span class="op" id="3552880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552883">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552932">Flush</span><span class="op" id="3552937">(</span><span class="op" id="3552938">)</span><br>
<span class="lineno"></span><span class="op" id="3552940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3552943">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3553014">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3553062">type</span>&nbsp;<span class="ident" id="3553067">Hijacker</span>&nbsp;<span class="keyword" id="3553076">interface</span>&nbsp;<span class="op" id="3553086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553089">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553142">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553196">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553247">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553300">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553330">Hijack</span><span class="op" id="3553336">(</span><span class="op" id="3553337">)</span>&nbsp;<span class="op" id="3553339">(</span><span class="ident" id="3553340">net</span><span class="op" id="3553343">.</span><span class="ident" id="3553344">Conn</span><span class="op" id="3553348">,</span>&nbsp;<span class="op" id="3553350">*</span><span class="ident" id="3553351">bufio</span><span class="op" id="3553356">.</span><span class="ident" id="3553357">ReadWriter</span><span class="op" id="3553367">,</span>&nbsp;<span class="builtintype" id="3553369">error</span><span class="op" id="3553374">)</span><br>
<span class="lineno"></span><span class="op" id="3553376">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3553379">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3553450">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3553515">//</span><br>
<span class="lineno"></span><span class="comment" id="3553518">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3553588">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3553652">type</span>&nbsp;<span class="ident" id="3553657">CloseNotifier</span>&nbsp;<span class="keyword" id="3553671">interface</span>&nbsp;<span class="op" id="3553681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553684">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553747">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553793">CloseNotify</span><span class="op" id="3553804">(</span><span class="op" id="3553805">)</span>&nbsp;<span class="op" id="3553807">&lt;-</span><span class="keyword" id="3553809">chan</span>&nbsp;<span class="builtintype" id="3553814">bool</span><br>
<span class="lineno">110</span><span class="op" id="3553819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3553822">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3553882">type</span>&nbsp;<span class="ident" id="3553887">conn</span>&nbsp;<span class="keyword" id="3553892">struct</span>&nbsp;<span class="op" id="3553899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553902">remoteAddr</span>&nbsp;<span class="builtintype" id="3553913">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553934">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553969">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3553980">*</span><span class="ident" id="3553981">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554001">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554048">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554059">net</span><span class="op" id="3554062">.</span><span class="ident" id="3554063">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554080">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554099">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554110">io</span><span class="op" id="3554112">.</span><span class="ident" id="3554113">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554131">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554192">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3554203">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554224">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554252">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554263">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554284">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554338">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3554349">*</span><span class="ident" id="3554350">io</span><span class="op" id="3554352">.</span><span class="ident" id="3554353">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554370">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554393">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3554404">*</span><span class="ident" id="3554405">bufio</span><span class="op" id="3554410">.</span><span class="ident" id="3554411">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554425">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554488">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3554499">*</span><span class="ident" id="3554500">tls</span><span class="op" id="3554503">.</span><span class="ident" id="3554504">ConnectionState</span>&nbsp;<span class="comment" id="3554520">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554551">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554564">sync</span><span class="op" id="3554568">.</span><span class="ident" id="3554569">Mutex</span>&nbsp;<span class="comment" id="3554575">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554600">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3554613">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554624">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554667">closeNotifyc</span>&nbsp;<span class="keyword" id="3554680">chan</span>&nbsp;<span class="builtintype" id="3554685">bool</span>&nbsp;&nbsp;<span class="comment" id="3554691">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554707">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3554720">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554731">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3554774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3554777">func</span>&nbsp;<span class="op" id="3554782">(</span><span class="ident" id="3554783">c</span>&nbsp;<span class="op" id="3554785">*</span><span class="ident" id="3554786">conn</span><span class="op" id="3554790">)</span>&nbsp;<span class="ident" id="3554792">hijacked</span><span class="op" id="3554800">(</span><span class="op" id="3554801">)</span>&nbsp;<span class="builtintype" id="3554803">bool</span>&nbsp;<span class="op" id="3554808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554811">c</span><span class="op" id="3554812">.</span><span class="ident" id="3554813">mu</span><span class="op" id="3554815">.</span><span class="ident" id="3554816">Lock</span><span class="op" id="3554820">(</span><span class="op" id="3554821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3554824">defer</span>&nbsp;<span class="ident" id="3554830">c</span><span class="op" id="3554831">.</span><span class="ident" id="3554832">mu</span><span class="op" id="3554834">.</span><span class="ident" id="3554835">Unlock</span><span class="op" id="3554841">(</span><span class="op" id="3554842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3554845">return</span>&nbsp;<span class="ident" id="3554852">c</span><span class="op" id="3554853">.</span><span class="ident" id="3554854">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3554864">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3554867">func</span>&nbsp;<span class="op" id="3554872">(</span><span class="ident" id="3554873">c</span>&nbsp;<span class="op" id="3554875">*</span><span class="ident" id="3554876">conn</span><span class="op" id="3554880">)</span>&nbsp;<span class="ident" id="3554882">hijack</span><span class="op" id="3554888">(</span><span class="op" id="3554889">)</span>&nbsp;<span class="op" id="3554891">(</span><span class="ident" id="3554892">rwc</span>&nbsp;<span class="ident" id="3554896">net</span><span class="op" id="3554899">.</span><span class="ident" id="3554900">Conn</span><span class="op" id="3554904">,</span>&nbsp;<span class="ident" id="3554906">buf</span>&nbsp;<span class="op" id="3554910">*</span><span class="ident" id="3554911">bufio</span><span class="op" id="3554916">.</span><span class="ident" id="3554917">ReadWriter</span><span class="op" id="3554927">,</span>&nbsp;<span class="ident" id="3554929">err</span>&nbsp;<span class="builtintype" id="3554933">error</span><span class="op" id="3554938">)</span>&nbsp;<span class="op" id="3554940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554943">c</span><span class="op" id="3554944">.</span><span class="ident" id="3554945">mu</span><span class="op" id="3554947">.</span><span class="ident" id="3554948">Lock</span><span class="op" id="3554952">(</span><span class="op" id="3554953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3554956">defer</span>&nbsp;<span class="ident" id="3554962">c</span><span class="op" id="3554963">.</span><span class="ident" id="3554964">mu</span><span class="op" id="3554966">.</span><span class="ident" id="3554967">Unlock</span><span class="op" id="3554973">(</span><span class="op" id="3554974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3554977">if</span>&nbsp;<span class="ident" id="3554980">c</span><span class="op" id="3554981">.</span><span class="ident" id="3554982">hijackedv</span>&nbsp;<span class="op" id="3554992">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3554996">return</span>&nbsp;<span class="builtintype" id="3555003">nil</span><span class="op" id="3555006">,</span>&nbsp;<span class="builtintype" id="3555008">nil</span><span class="op" id="3555011">,</span>&nbsp;<span class="ident" id="3555013">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555029">if</span>&nbsp;<span class="ident" id="3555032">c</span><span class="op" id="3555033">.</span><span class="ident" id="3555034">closeNotifyc</span>&nbsp;<span class="op" id="3555047">!=</span>&nbsp;<span class="builtintype" id="3555050">nil</span>&nbsp;<span class="op" id="3555054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555058">return</span>&nbsp;<span class="builtintype" id="3555065">nil</span><span class="op" id="3555068">,</span>&nbsp;<span class="builtintype" id="3555070">nil</span><span class="op" id="3555073">,</span>&nbsp;<span class="ident" id="3555075">errors</span><span class="op" id="3555081">.</span><span class="ident" id="3555082">New</span><span class="op" id="3555085">(</span><span class="string" id="3555086">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3555142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555145">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555148">c</span><span class="op" id="3555149">.</span><span class="ident" id="3555150">hijackedv</span>&nbsp;<span class="op" id="3555160">=</span>&nbsp;<span class="builtintype" id="3555162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555168">rwc</span>&nbsp;<span class="op" id="3555172">=</span>&nbsp;<span class="ident" id="3555174">c</span><span class="op" id="3555175">.</span><span class="ident" id="3555176">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555181">buf</span>&nbsp;<span class="op" id="3555185">=</span>&nbsp;<span class="ident" id="3555187">c</span><span class="op" id="3555188">.</span><span class="ident" id="3555189">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555194">c</span><span class="op" id="3555195">.</span><span class="ident" id="3555196">rwc</span>&nbsp;<span class="op" id="3555200">=</span>&nbsp;<span class="builtintype" id="3555202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555207">c</span><span class="op" id="3555208">.</span><span class="ident" id="3555209">buf</span>&nbsp;<span class="op" id="3555213">=</span>&nbsp;<span class="builtintype" id="3555215">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555220">c</span><span class="op" id="3555221">.</span><span class="ident" id="3555222">setState</span><span class="op" id="3555230">(</span><span class="ident" id="3555231">rwc</span><span class="op" id="3555234">,</span>&nbsp;<span class="ident" id="3555236">StateHijacked</span><span class="op" id="3555249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555252">return</span><br>
<span class="lineno"></span><span class="op" id="3555259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3555262">func</span>&nbsp;<span class="op" id="3555267">(</span><span class="ident" id="3555268">c</span>&nbsp;<span class="op" id="3555270">*</span><span class="ident" id="3555271">conn</span><span class="op" id="3555275">)</span>&nbsp;<span class="ident" id="3555277">closeNotify</span><span class="op" id="3555288">(</span><span class="op" id="3555289">)</span>&nbsp;<span class="op" id="3555291">&lt;-</span><span class="keyword" id="3555293">chan</span>&nbsp;<span class="builtintype" id="3555298">bool</span>&nbsp;<span class="op" id="3555303">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555306">c</span><span class="op" id="3555307">.</span><span class="ident" id="3555308">mu</span><span class="op" id="3555310">.</span><span class="ident" id="3555311">Lock</span><span class="op" id="3555315">(</span><span class="op" id="3555316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555319">defer</span>&nbsp;<span class="ident" id="3555325">c</span><span class="op" id="3555326">.</span><span class="ident" id="3555327">mu</span><span class="op" id="3555329">.</span><span class="ident" id="3555330">Unlock</span><span class="op" id="3555336">(</span><span class="op" id="3555337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555340">if</span>&nbsp;<span class="ident" id="3555343">c</span><span class="op" id="3555344">.</span><span class="ident" id="3555345">closeNotifyc</span>&nbsp;<span class="op" id="3555358">==</span>&nbsp;<span class="builtintype" id="3555361">nil</span>&nbsp;<span class="op" id="3555365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555369">c</span><span class="op" id="3555370">.</span><span class="ident" id="3555371">closeNotifyc</span>&nbsp;<span class="op" id="3555384">=</span>&nbsp;<span class="builtinfunc" id="3555386">make</span><span class="op" id="3555390">(</span><span class="keyword" id="3555391">chan</span>&nbsp;<span class="builtintype" id="3555396">bool</span><span class="op" id="3555400">,</span>&nbsp;<span class="num" id="3555402">1</span><span class="op" id="3555403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555407">if</span>&nbsp;<span class="ident" id="3555410">c</span><span class="op" id="3555411">.</span><span class="ident" id="3555412">hijackedv</span>&nbsp;<span class="op" id="3555422">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3555427">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3555477">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555512">return</span>&nbsp;<span class="ident" id="3555519">c</span><span class="op" id="3555520">.</span><span class="ident" id="3555521">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555540">pr</span><span class="op" id="3555542">,</span>&nbsp;<span class="ident" id="3555544">pw</span>&nbsp;<span class="op" id="3555547">:=</span>&nbsp;<span class="ident" id="3555550">io</span><span class="op" id="3555552">.</span><span class="ident" id="3555553">Pipe</span><span class="op" id="3555557">(</span><span class="op" id="3555558">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555563">readSource</span>&nbsp;<span class="op" id="3555574">:=</span>&nbsp;<span class="ident" id="3555577">c</span><span class="op" id="3555578">.</span><span class="ident" id="3555579">sr</span><span class="op" id="3555581">.</span><span class="ident" id="3555582">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555586">c</span><span class="op" id="3555587">.</span><span class="ident" id="3555588">sr</span><span class="op" id="3555590">.</span><span class="ident" id="3555591">Lock</span><span class="op" id="3555595">(</span><span class="op" id="3555596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555600">c</span><span class="op" id="3555601">.</span><span class="ident" id="3555602">sr</span><span class="op" id="3555604">.</span><span class="ident" id="3555605">r</span>&nbsp;<span class="op" id="3555607">=</span>&nbsp;<span class="ident" id="3555609">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555614">c</span><span class="op" id="3555615">.</span><span class="ident" id="3555616">sr</span><span class="op" id="3555618">.</span><span class="ident" id="3555619">Unlock</span><span class="op" id="3555625">(</span><span class="op" id="3555626">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555630">go</span>&nbsp;<span class="keyword" id="3555633">func</span><span class="op" id="3555637">(</span><span class="op" id="3555638">)</span>&nbsp;<span class="op" id="3555640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555645">_</span><span class="op" id="3555646">,</span>&nbsp;<span class="ident" id="3555648">err</span>&nbsp;<span class="op" id="3555652">:=</span>&nbsp;<span class="ident" id="3555655">io</span><span class="op" id="3555657">.</span><span class="ident" id="3555658">Copy</span><span class="op" id="3555662">(</span><span class="ident" id="3555663">pw</span><span class="op" id="3555665">,</span>&nbsp;<span class="ident" id="3555667">readSource</span><span class="op" id="3555677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555682">if</span>&nbsp;<span class="ident" id="3555685">err</span>&nbsp;<span class="op" id="3555689">==</span>&nbsp;<span class="builtintype" id="3555692">nil</span>&nbsp;<span class="op" id="3555696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555702">err</span>&nbsp;<span class="op" id="3555706">=</span>&nbsp;<span class="ident" id="3555708">io</span><span class="op" id="3555710">.</span><span class="ident" id="3555711">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555718">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555723">pw</span><span class="op" id="3555725">.</span><span class="ident" id="3555726">CloseWithError</span><span class="op" id="3555740">(</span><span class="ident" id="3555741">err</span><span class="op" id="3555744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555749">c</span><span class="op" id="3555750">.</span><span class="ident" id="3555751">noteClientGone</span><span class="op" id="3555765">(</span><span class="op" id="3555766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555770">}</span><span class="op" id="3555771">(</span><span class="op" id="3555772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555778">return</span>&nbsp;<span class="ident" id="3555785">c</span><span class="op" id="3555786">.</span><span class="ident" id="3555787">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3555800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3555803">func</span>&nbsp;<span class="op" id="3555808">(</span><span class="ident" id="3555809">c</span>&nbsp;<span class="op" id="3555811">*</span><span class="ident" id="3555812">conn</span><span class="op" id="3555816">)</span>&nbsp;<span class="ident" id="3555818">noteClientGone</span><span class="op" id="3555832">(</span><span class="op" id="3555833">)</span>&nbsp;<span class="op" id="3555835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555838">c</span><span class="op" id="3555839">.</span><span class="ident" id="3555840">mu</span><span class="op" id="3555842">.</span><span class="ident" id="3555843">Lock</span><span class="op" id="3555847">(</span><span class="op" id="3555848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555851">defer</span>&nbsp;<span class="ident" id="3555857">c</span><span class="op" id="3555858">.</span><span class="ident" id="3555859">mu</span><span class="op" id="3555861">.</span><span class="ident" id="3555862">Unlock</span><span class="op" id="3555868">(</span><span class="op" id="3555869">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555872">if</span>&nbsp;<span class="ident" id="3555875">c</span><span class="op" id="3555876">.</span><span class="ident" id="3555877">closeNotifyc</span>&nbsp;<span class="op" id="3555890">!=</span>&nbsp;<span class="builtintype" id="3555893">nil</span>&nbsp;<span class="op" id="3555897">&amp;&amp;</span>&nbsp;<span class="op" id="3555900">!</span><span class="ident" id="3555901">c</span><span class="op" id="3555902">.</span><span class="ident" id="3555903">clientGone</span>&nbsp;<span class="op" id="3555914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555918">c</span><span class="op" id="3555919">.</span><span class="ident" id="3555920">closeNotifyc</span>&nbsp;<span class="op" id="3555933">&lt;-</span>&nbsp;<span class="builtintype" id="3555936">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555945">c</span><span class="op" id="3555946">.</span><span class="ident" id="3555947">clientGone</span>&nbsp;<span class="op" id="3555958">=</span>&nbsp;<span class="builtintype" id="3555960">true</span><br>
<span class="lineno"></span><span class="op" id="3555965">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3555968">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3556026">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3556078">type</span>&nbsp;<span class="ident" id="3556083">switchReader</span>&nbsp;<span class="keyword" id="3556096">struct</span>&nbsp;<span class="op" id="3556103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556106">io</span><span class="op" id="3556108">.</span><span class="ident" id="3556109">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3556116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3556119">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3556177">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3556230">type</span>&nbsp;<span class="ident" id="3556235">switchWriter</span>&nbsp;<span class="keyword" id="3556248">struct</span>&nbsp;<span class="op" id="3556255">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556258">io</span><span class="op" id="3556260">.</span><span class="ident" id="3556261">Writer</span><br>
<span class="lineno"></span><span class="op" id="3556268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3556271">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3556338">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3556383">type</span>&nbsp;<span class="ident" id="3556388">liveSwitchReader</span>&nbsp;<span class="keyword" id="3556405">struct</span>&nbsp;<span class="op" id="3556412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556415">sync</span><span class="op" id="3556419">.</span><span class="ident" id="3556420">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556427">r</span>&nbsp;<span class="ident" id="3556429">io</span><span class="op" id="3556431">.</span><span class="ident" id="3556432">Reader</span><br>
<span class="lineno"></span><span class="op" id="3556439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3556442">func</span>&nbsp;<span class="op" id="3556447">(</span><span class="ident" id="3556448">sr</span>&nbsp;<span class="op" id="3556451">*</span><span class="ident" id="3556452">liveSwitchReader</span><span class="op" id="3556468">)</span>&nbsp;<span class="ident" id="3556470">Read</span><span class="op" id="3556474">(</span><span class="ident" id="3556475">p</span>&nbsp;<span class="op" id="3556477">[</span><span class="op" id="3556478">]</span><span class="builtintype" id="3556479">byte</span><span class="op" id="3556483">)</span>&nbsp;<span class="op" id="3556485">(</span><span class="ident" id="3556486">n</span>&nbsp;<span class="builtintype" id="3556488">int</span><span class="op" id="3556491">,</span>&nbsp;<span class="ident" id="3556493">err</span>&nbsp;<span class="builtintype" id="3556497">error</span><span class="op" id="3556502">)</span>&nbsp;<span class="op" id="3556504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556507">sr</span><span class="op" id="3556509">.</span><span class="ident" id="3556510">Lock</span><span class="op" id="3556514">(</span><span class="op" id="3556515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556518">r</span>&nbsp;<span class="op" id="3556520">:=</span>&nbsp;<span class="ident" id="3556523">sr</span><span class="op" id="3556525">.</span><span class="ident" id="3556526">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556529">sr</span><span class="op" id="3556531">.</span><span class="ident" id="3556532">Unlock</span><span class="op" id="3556538">(</span><span class="op" id="3556539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556542">return</span>&nbsp;<span class="ident" id="3556549">r</span><span class="op" id="3556550">.</span><span class="ident" id="3556551">Read</span><span class="op" id="3556555">(</span><span class="ident" id="3556556">p</span><span class="op" id="3556557">)</span><br>
<span class="lineno">215</span><span class="op" id="3556559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3556562">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3556616">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3556658">const</span>&nbsp;<span class="ident" id="3556664">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3556689">=</span>&nbsp;<span class="num" id="3556691">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3556697">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3556766">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3556815">//</span><br>
<span class="lineno"></span><span class="comment" id="3556818">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3556890">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3556961">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3557033">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3557107">//</span><br>
<span class="lineno"></span><span class="comment" id="3557110">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3557180">type</span>&nbsp;<span class="ident" id="3557185">chunkWriter</span>&nbsp;<span class="keyword" id="3557197">struct</span>&nbsp;<span class="op" id="3557204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557207">res</span>&nbsp;<span class="op" id="3557211">*</span><span class="ident" id="3557212">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557223">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557285">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557343">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557401">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557441">header</span>&nbsp;<span class="ident" id="3557448">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557457">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557521">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557571">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557632">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557655">wroteHeader</span>&nbsp;<span class="builtintype" id="3557667">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557674">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557709">chunking</span>&nbsp;<span class="builtintype" id="3557718">bool</span>&nbsp;<span class="comment" id="3557723">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3557773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3557776">var</span>&nbsp;<span class="op" id="3557780">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557783">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3557794">=</span>&nbsp;<span class="op" id="3557796">[</span><span class="op" id="3557797">]</span><span class="builtintype" id="3557798">byte</span><span class="op" id="3557802">(</span><span class="string" id="3557803">&#34;\r\n&#34;</span><span class="op" id="3557809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557812">colonSpace</span>&nbsp;<span class="op" id="3557823">=</span>&nbsp;<span class="op" id="3557825">[</span><span class="op" id="3557826">]</span><span class="builtintype" id="3557827">byte</span><span class="op" id="3557831">(</span><span class="string" id="3557832">&#34;:&nbsp;&#34;</span><span class="op" id="3557836">)</span><br>
<span class="lineno"></span><span class="op" id="3557838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3557841">func</span>&nbsp;<span class="op" id="3557846">(</span><span class="ident" id="3557847">cw</span>&nbsp;<span class="op" id="3557850">*</span><span class="ident" id="3557851">chunkWriter</span><span class="op" id="3557862">)</span>&nbsp;<span class="ident" id="3557864">Write</span><span class="op" id="3557869">(</span><span class="ident" id="3557870">p</span>&nbsp;<span class="op" id="3557872">[</span><span class="op" id="3557873">]</span><span class="builtintype" id="3557874">byte</span><span class="op" id="3557878">)</span>&nbsp;<span class="op" id="3557880">(</span><span class="ident" id="3557881">n</span>&nbsp;<span class="builtintype" id="3557883">int</span><span class="op" id="3557886">,</span>&nbsp;<span class="ident" id="3557888">err</span>&nbsp;<span class="builtintype" id="3557892">error</span><span class="op" id="3557897">)</span>&nbsp;<span class="op" id="3557899">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3557902">if</span>&nbsp;<span class="op" id="3557905">!</span><span class="ident" id="3557906">cw</span><span class="op" id="3557908">.</span><span class="ident" id="3557909">wroteHeader</span>&nbsp;<span class="op" id="3557921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557925">cw</span><span class="op" id="3557927">.</span><span class="ident" id="3557928">writeHeader</span><span class="op" id="3557939">(</span><span class="ident" id="3557940">p</span><span class="op" id="3557941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3557944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3557947">if</span>&nbsp;<span class="ident" id="3557950">cw</span><span class="op" id="3557952">.</span><span class="ident" id="3557953">res</span><span class="op" id="3557956">.</span><span class="ident" id="3557957">req</span><span class="op" id="3557960">.</span><span class="ident" id="3557961">Method</span>&nbsp;<span class="op" id="3557968">==</span>&nbsp;<span class="string" id="3557971">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3557978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557982">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3557999">return</span>&nbsp;<span class="builtinfunc" id="3558006">len</span><span class="op" id="3558009">(</span><span class="ident" id="3558010">p</span><span class="op" id="3558011">)</span><span class="op" id="3558012">,</span>&nbsp;<span class="builtintype" id="3558014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558022">if</span>&nbsp;<span class="ident" id="3558025">cw</span><span class="op" id="3558027">.</span><span class="ident" id="3558028">chunking</span>&nbsp;<span class="op" id="3558037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558041">_</span><span class="op" id="3558042">,</span>&nbsp;<span class="ident" id="3558044">err</span>&nbsp;<span class="op" id="3558048">=</span>&nbsp;<span class="ident" id="3558050">fmt</span><span class="op" id="3558053">.</span><span class="ident" id="3558054">Fprintf</span><span class="op" id="3558061">(</span><span class="ident" id="3558062">cw</span><span class="op" id="3558064">.</span><span class="ident" id="3558065">res</span><span class="op" id="3558068">.</span><span class="ident" id="3558069">conn</span><span class="op" id="3558073">.</span><span class="ident" id="3558074">buf</span><span class="op" id="3558077">,</span>&nbsp;<span class="string" id="3558079">&#34;%x\r\n&#34;</span><span class="op" id="3558087">,</span>&nbsp;<span class="builtinfunc" id="3558089">len</span><span class="op" id="3558092">(</span><span class="ident" id="3558093">p</span><span class="op" id="3558094">)</span><span class="op" id="3558095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558099">if</span>&nbsp;<span class="ident" id="3558102">err</span>&nbsp;<span class="op" id="3558106">!=</span>&nbsp;<span class="builtintype" id="3558109">nil</span>&nbsp;<span class="op" id="3558113">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558118">cw</span><span class="op" id="3558120">.</span><span class="ident" id="3558121">res</span><span class="op" id="3558124">.</span><span class="ident" id="3558125">conn</span><span class="op" id="3558129">.</span><span class="ident" id="3558130">rwc</span><span class="op" id="3558133">.</span><span class="ident" id="3558134">Close</span><span class="op" id="3558139">(</span><span class="op" id="3558140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558145">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558160">n</span><span class="op" id="3558161">,</span>&nbsp;<span class="ident" id="3558163">err</span>&nbsp;<span class="op" id="3558167">=</span>&nbsp;<span class="ident" id="3558169">cw</span><span class="op" id="3558171">.</span><span class="ident" id="3558172">res</span><span class="op" id="3558175">.</span><span class="ident" id="3558176">conn</span><span class="op" id="3558180">.</span><span class="ident" id="3558181">buf</span><span class="op" id="3558184">.</span><span class="ident" id="3558185">Write</span><span class="op" id="3558190">(</span><span class="ident" id="3558191">p</span><span class="op" id="3558192">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558195">if</span>&nbsp;<span class="ident" id="3558198">cw</span><span class="op" id="3558200">.</span><span class="ident" id="3558201">chunking</span>&nbsp;<span class="op" id="3558210">&amp;&amp;</span>&nbsp;<span class="ident" id="3558213">err</span>&nbsp;<span class="op" id="3558217">==</span>&nbsp;<span class="builtintype" id="3558220">nil</span>&nbsp;<span class="op" id="3558224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558228">_</span><span class="op" id="3558229">,</span>&nbsp;<span class="ident" id="3558231">err</span>&nbsp;<span class="op" id="3558235">=</span>&nbsp;<span class="ident" id="3558237">cw</span><span class="op" id="3558239">.</span><span class="ident" id="3558240">res</span><span class="op" id="3558243">.</span><span class="ident" id="3558244">conn</span><span class="op" id="3558248">.</span><span class="ident" id="3558249">buf</span><span class="op" id="3558252">.</span><span class="ident" id="3558253">Write</span><span class="op" id="3558258">(</span><span class="ident" id="3558259">crlf</span><span class="op" id="3558263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558269">if</span>&nbsp;<span class="ident" id="3558272">err</span>&nbsp;<span class="op" id="3558276">!=</span>&nbsp;<span class="builtintype" id="3558279">nil</span>&nbsp;<span class="op" id="3558283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558287">cw</span><span class="op" id="3558289">.</span><span class="ident" id="3558290">res</span><span class="op" id="3558293">.</span><span class="ident" id="3558294">conn</span><span class="op" id="3558298">.</span><span class="ident" id="3558299">rwc</span><span class="op" id="3558302">.</span><span class="ident" id="3558303">Close</span><span class="op" id="3558308">(</span><span class="op" id="3558309">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558315">return</span><br>
<span class="lineno"></span><span class="op" id="3558322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3558325">func</span>&nbsp;<span class="op" id="3558330">(</span><span class="ident" id="3558331">cw</span>&nbsp;<span class="op" id="3558334">*</span><span class="ident" id="3558335">chunkWriter</span><span class="op" id="3558346">)</span>&nbsp;<span class="ident" id="3558348">flush</span><span class="op" id="3558353">(</span><span class="op" id="3558354">)</span>&nbsp;<span class="op" id="3558356">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558359">if</span>&nbsp;<span class="op" id="3558362">!</span><span class="ident" id="3558363">cw</span><span class="op" id="3558365">.</span><span class="ident" id="3558366">wroteHeader</span>&nbsp;<span class="op" id="3558378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558382">cw</span><span class="op" id="3558384">.</span><span class="ident" id="3558385">writeHeader</span><span class="op" id="3558396">(</span><span class="builtintype" id="3558397">nil</span><span class="op" id="3558400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558406">cw</span><span class="op" id="3558408">.</span><span class="ident" id="3558409">res</span><span class="op" id="3558412">.</span><span class="ident" id="3558413">conn</span><span class="op" id="3558417">.</span><span class="ident" id="3558418">buf</span><span class="op" id="3558421">.</span><span class="ident" id="3558422">Flush</span><span class="op" id="3558427">(</span><span class="op" id="3558428">)</span><br>
<span class="lineno"></span><span class="op" id="3558430">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3558433">func</span>&nbsp;<span class="op" id="3558438">(</span><span class="ident" id="3558439">cw</span>&nbsp;<span class="op" id="3558442">*</span><span class="ident" id="3558443">chunkWriter</span><span class="op" id="3558454">)</span>&nbsp;<span class="builtinfunc" id="3558456">close</span><span class="op" id="3558461">(</span><span class="op" id="3558462">)</span>&nbsp;<span class="op" id="3558464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558467">if</span>&nbsp;<span class="op" id="3558470">!</span><span class="ident" id="3558471">cw</span><span class="op" id="3558473">.</span><span class="ident" id="3558474">wroteHeader</span>&nbsp;<span class="op" id="3558486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558490">cw</span><span class="op" id="3558492">.</span><span class="ident" id="3558493">writeHeader</span><span class="op" id="3558504">(</span><span class="builtintype" id="3558505">nil</span><span class="op" id="3558508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558511">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558514">if</span>&nbsp;<span class="ident" id="3558517">cw</span><span class="op" id="3558519">.</span><span class="ident" id="3558520">chunking</span>&nbsp;<span class="op" id="3558529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3558533">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3558589">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3558643">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558654">cw</span><span class="op" id="3558656">.</span><span class="ident" id="3558657">res</span><span class="op" id="3558660">.</span><span class="ident" id="3558661">conn</span><span class="op" id="3558665">.</span><span class="ident" id="3558666">buf</span><span class="op" id="3558669">.</span><span class="ident" id="3558670">WriteString</span><span class="op" id="3558681">(</span><span class="string" id="3558682">&#34;0\r\n\r\n&#34;</span><span class="op" id="3558693">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558696">}</span><br>
<span class="lineno"></span><span class="op" id="3558698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3558701">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3558763">type</span>&nbsp;<span class="ident" id="3558768">response</span>&nbsp;<span class="keyword" id="3558777">struct</span>&nbsp;<span class="op" id="3558784">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558787">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558801">*</span><span class="ident" id="3558802">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558808">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3558822">*</span><span class="ident" id="3558823">Request</span>&nbsp;<span class="comment" id="3558831">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558861">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3558875">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3558884">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558930">wroteContinue</span>&nbsp;<span class="builtintype" id="3558944">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3558953">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558992">w</span>&nbsp;&nbsp;<span class="op" id="3558995">*</span><span class="ident" id="3558996">bufio</span><span class="op" id="3559001">.</span><span class="ident" id="3559002">Writer</span>&nbsp;<span class="comment" id="3559009">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559053">cw</span>&nbsp;<span class="ident" id="3559056">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559069">sw</span>&nbsp;<span class="op" id="3559072">*</span><span class="ident" id="3559073">switchWriter</span>&nbsp;<span class="comment" id="3559086">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559141">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559202">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559264">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559322">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559366">handlerHeader</span>&nbsp;<span class="ident" id="3559380">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559388">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3559402">bool</span>&nbsp;<span class="comment" id="3559407">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559454">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3559468">int64</span>&nbsp;<span class="comment" id="3559474">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559510">contentLength</span>&nbsp;<span class="builtintype" id="3559524">int64</span>&nbsp;<span class="comment" id="3559530">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559576">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3559590">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3559596">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559635">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559694">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559747">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559798">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559818">closeAfterReply</span>&nbsp;<span class="builtintype" id="3559834">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559841">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559896">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3559951">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3560002">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3560064">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3560120">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3560180">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560199">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3560219">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560226">handlerDone</span>&nbsp;<span class="builtintype" id="3560238">bool</span>&nbsp;<span class="comment" id="3560243">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3560280">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560320">dateBuf</span>&nbsp;<span class="op" id="3560328">[</span><span class="builtinfunc" id="3560329">len</span><span class="op" id="3560332">(</span><span class="ident" id="3560333">TimeFormat</span><span class="op" id="3560343">)</span><span class="op" id="3560344">]</span><span class="builtintype" id="3560345">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560351">clenBuf</span>&nbsp;<span class="op" id="3560359">[</span><span class="num" id="3560360">10</span><span class="op" id="3560362">]</span><span class="builtintype" id="3560363">byte</span><br>
<span class="lineno">340</span><span class="op" id="3560368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3560371">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3560442">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3560472">func</span>&nbsp;<span class="op" id="3560477">(</span><span class="ident" id="3560478">w</span>&nbsp;<span class="op" id="3560480">*</span><span class="ident" id="3560481">response</span><span class="op" id="3560489">)</span>&nbsp;<span class="ident" id="3560491">requestTooLarge</span><span class="op" id="3560506">(</span><span class="op" id="3560507">)</span>&nbsp;<span class="op" id="3560509">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560512">w</span><span class="op" id="3560513">.</span><span class="ident" id="3560514">closeAfterReply</span>&nbsp;<span class="op" id="3560530">=</span>&nbsp;<span class="builtintype" id="3560532">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560538">w</span><span class="op" id="3560539">.</span><span class="ident" id="3560540">requestBodyLimitHit</span>&nbsp;<span class="op" id="3560560">=</span>&nbsp;<span class="builtintype" id="3560562">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560568">if</span>&nbsp;<span class="op" id="3560571">!</span><span class="ident" id="3560572">w</span><span class="op" id="3560573">.</span><span class="ident" id="3560574">wroteHeader</span>&nbsp;<span class="op" id="3560586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560590">w</span><span class="op" id="3560591">.</span><span class="ident" id="3560592">Header</span><span class="op" id="3560598">(</span><span class="op" id="3560599">)</span><span class="op" id="3560600">.</span><span class="ident" id="3560601">Set</span><span class="op" id="3560604">(</span><span class="string" id="3560605">&#34;Connection&#34;</span><span class="op" id="3560617">,</span>&nbsp;<span class="string" id="3560619">&#34;close&#34;</span><span class="op" id="3560626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3560629">}</span><br>
<span class="lineno">350</span><span class="op" id="3560631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3560634">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3560706">func</span>&nbsp;<span class="op" id="3560711">(</span><span class="ident" id="3560712">w</span>&nbsp;<span class="op" id="3560714">*</span><span class="ident" id="3560715">response</span><span class="op" id="3560723">)</span>&nbsp;<span class="ident" id="3560725">needsSniff</span><span class="op" id="3560735">(</span><span class="op" id="3560736">)</span>&nbsp;<span class="builtintype" id="3560738">bool</span>&nbsp;<span class="op" id="3560743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560746">_</span><span class="op" id="3560747">,</span>&nbsp;<span class="ident" id="3560749">haveType</span>&nbsp;<span class="op" id="3560758">:=</span>&nbsp;<span class="ident" id="3560761">w</span><span class="op" id="3560762">.</span><span class="ident" id="3560763">handlerHeader</span><span class="op" id="3560776">[</span><span class="string" id="3560777">&#34;Content-Type&#34;</span><span class="op" id="3560791">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560794">return</span>&nbsp;<span class="op" id="3560801">!</span><span class="ident" id="3560802">w</span><span class="op" id="3560803">.</span><span class="ident" id="3560804">cw</span><span class="op" id="3560806">.</span><span class="ident" id="3560807">wroteHeader</span>&nbsp;<span class="op" id="3560819">&amp;&amp;</span>&nbsp;<span class="op" id="3560822">!</span><span class="ident" id="3560823">haveType</span>&nbsp;<span class="op" id="3560832">&amp;&amp;</span>&nbsp;<span class="ident" id="3560835">w</span><span class="op" id="3560836">.</span><span class="ident" id="3560837">written</span>&nbsp;<span class="op" id="3560845">&lt;</span>&nbsp;<span class="ident" id="3560847">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3560856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3560859">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3560925">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3560942">type</span>&nbsp;<span class="ident" id="3560947">writerOnly</span>&nbsp;<span class="keyword" id="3560958">struct</span>&nbsp;<span class="op" id="3560965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560968">io</span><span class="op" id="3560970">.</span><span class="ident" id="3560971">Writer</span><br>
<span class="lineno"></span><span class="op" id="3560978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3560981">func</span>&nbsp;<span class="ident" id="3560986">srcIsRegularFile</span><span class="op" id="3561002">(</span><span class="ident" id="3561003">src</span>&nbsp;<span class="ident" id="3561007">io</span><span class="op" id="3561009">.</span><span class="ident" id="3561010">Reader</span><span class="op" id="3561016">)</span>&nbsp;<span class="op" id="3561018">(</span><span class="ident" id="3561019">isRegular</span>&nbsp;<span class="builtintype" id="3561029">bool</span><span class="op" id="3561033">,</span>&nbsp;<span class="ident" id="3561035">err</span>&nbsp;<span class="builtintype" id="3561039">error</span><span class="op" id="3561044">)</span>&nbsp;<span class="op" id="3561046">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561049">switch</span>&nbsp;<span class="ident" id="3561056">v</span>&nbsp;<span class="op" id="3561058">:=</span>&nbsp;<span class="ident" id="3561061">src</span><span class="op" id="3561064">.</span><span class="op" id="3561065">(</span><span class="keyword" id="3561066">type</span><span class="op" id="3561070">)</span>&nbsp;<span class="op" id="3561072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561075">case</span>&nbsp;<span class="op" id="3561080">*</span><span class="ident" id="3561081">os</span><span class="op" id="3561083">.</span><span class="ident" id="3561084">File</span><span class="op" id="3561088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561092">fi</span><span class="op" id="3561094">,</span>&nbsp;<span class="ident" id="3561096">err</span>&nbsp;<span class="op" id="3561100">:=</span>&nbsp;<span class="ident" id="3561103">v</span><span class="op" id="3561104">.</span><span class="ident" id="3561105">Stat</span><span class="op" id="3561109">(</span><span class="op" id="3561110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561114">if</span>&nbsp;<span class="ident" id="3561117">err</span>&nbsp;<span class="op" id="3561121">!=</span>&nbsp;<span class="builtintype" id="3561124">nil</span>&nbsp;<span class="op" id="3561128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561133">return</span>&nbsp;<span class="builtintype" id="3561140">false</span><span class="op" id="3561145">,</span>&nbsp;<span class="ident" id="3561147">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561157">return</span>&nbsp;<span class="ident" id="3561164">fi</span><span class="op" id="3561166">.</span><span class="ident" id="3561167">Mode</span><span class="op" id="3561171">(</span><span class="op" id="3561172">)</span><span class="op" id="3561173">.</span><span class="ident" id="3561174">IsRegular</span><span class="op" id="3561183">(</span><span class="op" id="3561184">)</span><span class="op" id="3561185">,</span>&nbsp;<span class="builtintype" id="3561187">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561192">case</span>&nbsp;<span class="op" id="3561197">*</span><span class="ident" id="3561198">io</span><span class="op" id="3561200">.</span><span class="ident" id="3561201">LimitedReader</span><span class="op" id="3561214">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561218">return</span>&nbsp;<span class="ident" id="3561225">srcIsRegularFile</span><span class="op" id="3561241">(</span><span class="ident" id="3561242">v</span><span class="op" id="3561243">.</span><span class="ident" id="3561244">R</span><span class="op" id="3561245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561248">default</span><span class="op" id="3561255">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561259">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561267">}</span><br>
<span class="lineno"></span><span class="op" id="3561269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3561272">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3561342">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3561378">func</span>&nbsp;<span class="op" id="3561383">(</span><span class="ident" id="3561384">w</span>&nbsp;<span class="op" id="3561386">*</span><span class="ident" id="3561387">response</span><span class="op" id="3561395">)</span>&nbsp;<span class="ident" id="3561397">ReadFrom</span><span class="op" id="3561405">(</span><span class="ident" id="3561406">src</span>&nbsp;<span class="ident" id="3561410">io</span><span class="op" id="3561412">.</span><span class="ident" id="3561413">Reader</span><span class="op" id="3561419">)</span>&nbsp;<span class="op" id="3561421">(</span><span class="ident" id="3561422">n</span>&nbsp;<span class="builtintype" id="3561424">int64</span><span class="op" id="3561429">,</span>&nbsp;<span class="ident" id="3561431">err</span>&nbsp;<span class="builtintype" id="3561435">error</span><span class="op" id="3561440">)</span>&nbsp;<span class="op" id="3561442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3561445">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3561507">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3561571">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561623">rf</span><span class="op" id="3561625">,</span>&nbsp;<span class="ident" id="3561627">ok</span>&nbsp;<span class="op" id="3561630">:=</span>&nbsp;<span class="ident" id="3561633">w</span><span class="op" id="3561634">.</span><span class="ident" id="3561635">conn</span><span class="op" id="3561639">.</span><span class="ident" id="3561640">rwc</span><span class="op" id="3561643">.</span><span class="op" id="3561644">(</span><span class="ident" id="3561645">io</span><span class="op" id="3561647">.</span><span class="ident" id="3561648">ReaderFrom</span><span class="op" id="3561658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561661">regFile</span><span class="op" id="3561668">,</span>&nbsp;<span class="ident" id="3561670">err</span>&nbsp;<span class="op" id="3561674">:=</span>&nbsp;<span class="ident" id="3561677">srcIsRegularFile</span><span class="op" id="3561693">(</span><span class="ident" id="3561694">src</span><span class="op" id="3561697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561700">if</span>&nbsp;<span class="ident" id="3561703">err</span>&nbsp;<span class="op" id="3561707">!=</span>&nbsp;<span class="builtintype" id="3561710">nil</span>&nbsp;<span class="op" id="3561714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561718">return</span>&nbsp;<span class="num" id="3561725">0</span><span class="op" id="3561726">,</span>&nbsp;<span class="ident" id="3561728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561733">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561736">if</span>&nbsp;<span class="op" id="3561739">!</span><span class="ident" id="3561740">ok</span>&nbsp;<span class="op" id="3561743">||</span>&nbsp;<span class="op" id="3561746">!</span><span class="ident" id="3561747">regFile</span>&nbsp;<span class="op" id="3561755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561759">return</span>&nbsp;<span class="ident" id="3561766">io</span><span class="op" id="3561768">.</span><span class="ident" id="3561769">Copy</span><span class="op" id="3561773">(</span><span class="ident" id="3561774">writerOnly</span><span class="op" id="3561784">{</span><span class="ident" id="3561785">w</span><span class="op" id="3561786">}</span><span class="op" id="3561787">,</span>&nbsp;<span class="ident" id="3561789">src</span><span class="op" id="3561792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3561799">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561819">if</span>&nbsp;<span class="op" id="3561822">!</span><span class="ident" id="3561823">w</span><span class="op" id="3561824">.</span><span class="ident" id="3561825">wroteHeader</span>&nbsp;<span class="op" id="3561837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561841">w</span><span class="op" id="3561842">.</span><span class="ident" id="3561843">WriteHeader</span><span class="op" id="3561854">(</span><span class="ident" id="3561855">StatusOK</span><span class="op" id="3561863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561870">if</span>&nbsp;<span class="ident" id="3561873">w</span><span class="op" id="3561874">.</span><span class="ident" id="3561875">needsSniff</span><span class="op" id="3561885">(</span><span class="op" id="3561886">)</span>&nbsp;<span class="op" id="3561888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561892">n0</span><span class="op" id="3561894">,</span>&nbsp;<span class="ident" id="3561896">err</span>&nbsp;<span class="op" id="3561900">:=</span>&nbsp;<span class="ident" id="3561903">io</span><span class="op" id="3561905">.</span><span class="ident" id="3561906">Copy</span><span class="op" id="3561910">(</span><span class="ident" id="3561911">writerOnly</span><span class="op" id="3561921">{</span><span class="ident" id="3561922">w</span><span class="op" id="3561923">}</span><span class="op" id="3561924">,</span>&nbsp;<span class="ident" id="3561926">io</span><span class="op" id="3561928">.</span><span class="ident" id="3561929">LimitReader</span><span class="op" id="3561940">(</span><span class="ident" id="3561941">src</span><span class="op" id="3561944">,</span>&nbsp;<span class="ident" id="3561946">sniffLen</span><span class="op" id="3561954">)</span><span class="op" id="3561955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561959">n</span>&nbsp;<span class="op" id="3561961">+=</span>&nbsp;<span class="ident" id="3561964">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561969">if</span>&nbsp;<span class="ident" id="3561972">err</span>&nbsp;<span class="op" id="3561976">!=</span>&nbsp;<span class="builtintype" id="3561979">nil</span>&nbsp;<span class="op" id="3561983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561988">return</span>&nbsp;<span class="ident" id="3561995">n</span><span class="op" id="3561996">,</span>&nbsp;<span class="ident" id="3561998">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562011">w</span><span class="op" id="3562012">.</span><span class="ident" id="3562013">w</span><span class="op" id="3562014">.</span><span class="ident" id="3562015">Flush</span><span class="op" id="3562020">(</span><span class="op" id="3562021">)</span>&nbsp;&nbsp;<span class="comment" id="3562024">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562059">w</span><span class="op" id="3562060">.</span><span class="ident" id="3562061">cw</span><span class="op" id="3562063">.</span><span class="ident" id="3562064">flush</span><span class="op" id="3562069">(</span><span class="op" id="3562070">)</span>&nbsp;<span class="comment" id="3562072">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3562124">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562204">if</span>&nbsp;<span class="op" id="3562207">!</span><span class="ident" id="3562208">w</span><span class="op" id="3562209">.</span><span class="ident" id="3562210">cw</span><span class="op" id="3562212">.</span><span class="ident" id="3562213">chunking</span>&nbsp;<span class="op" id="3562222">&amp;&amp;</span>&nbsp;<span class="ident" id="3562225">w</span><span class="op" id="3562226">.</span><span class="ident" id="3562227">bodyAllowed</span><span class="op" id="3562238">(</span><span class="op" id="3562239">)</span>&nbsp;<span class="op" id="3562241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562245">n0</span><span class="op" id="3562247">,</span>&nbsp;<span class="ident" id="3562249">err</span>&nbsp;<span class="op" id="3562253">:=</span>&nbsp;<span class="ident" id="3562256">rf</span><span class="op" id="3562258">.</span><span class="ident" id="3562259">ReadFrom</span><span class="op" id="3562267">(</span><span class="ident" id="3562268">src</span><span class="op" id="3562271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562275">n</span>&nbsp;<span class="op" id="3562277">+=</span>&nbsp;<span class="ident" id="3562280">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562285">w</span><span class="op" id="3562286">.</span><span class="ident" id="3562287">written</span>&nbsp;<span class="op" id="3562295">+=</span>&nbsp;<span class="ident" id="3562298">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562303">return</span>&nbsp;<span class="ident" id="3562310">n</span><span class="op" id="3562311">,</span>&nbsp;<span class="ident" id="3562313">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562322">n0</span><span class="op" id="3562324">,</span>&nbsp;<span class="ident" id="3562326">err</span>&nbsp;<span class="op" id="3562330">:=</span>&nbsp;<span class="ident" id="3562333">io</span><span class="op" id="3562335">.</span><span class="ident" id="3562336">Copy</span><span class="op" id="3562340">(</span><span class="ident" id="3562341">writerOnly</span><span class="op" id="3562351">{</span><span class="ident" id="3562352">w</span><span class="op" id="3562353">}</span><span class="op" id="3562354">,</span>&nbsp;<span class="ident" id="3562356">src</span><span class="op" id="3562359">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562362">n</span>&nbsp;<span class="op" id="3562364">+=</span>&nbsp;<span class="ident" id="3562367">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562371">return</span>&nbsp;<span class="ident" id="3562378">n</span><span class="op" id="3562379">,</span>&nbsp;<span class="ident" id="3562381">err</span><br>
<span class="lineno"></span><span class="op" id="3562385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3562388">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3562457">const</span>&nbsp;<span class="ident" id="3562463">noLimit</span>&nbsp;<span class="builtintype" id="3562471">int64</span>&nbsp;<span class="op" id="3562477">=</span>&nbsp;<span class="op" id="3562479">(</span><span class="num" id="3562480">1</span>&nbsp;<span class="op" id="3562482">&lt;&lt;</span>&nbsp;<span class="num" id="3562485">63</span><span class="op" id="3562487">)</span>&nbsp;<span class="op" id="3562489">-</span>&nbsp;<span class="num" id="3562491">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3562494">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3562572">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3562607">const</span>&nbsp;<span class="ident" id="3562613">debugServerConnections</span>&nbsp;<span class="op" id="3562636">=</span>&nbsp;<span class="builtintype" id="3562638">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3562645">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3562680">func</span>&nbsp;<span class="op" id="3562685">(</span><span class="ident" id="3562686">srv</span>&nbsp;<span class="op" id="3562690">*</span><span class="ident" id="3562691">Server</span><span class="op" id="3562697">)</span>&nbsp;<span class="ident" id="3562699">newConn</span><span class="op" id="3562706">(</span><span class="ident" id="3562707">rwc</span>&nbsp;<span class="ident" id="3562711">net</span><span class="op" id="3562714">.</span><span class="ident" id="3562715">Conn</span><span class="op" id="3562719">)</span>&nbsp;<span class="op" id="3562721">(</span><span class="ident" id="3562722">c</span>&nbsp;<span class="op" id="3562724">*</span><span class="ident" id="3562725">conn</span><span class="op" id="3562729">,</span>&nbsp;<span class="ident" id="3562731">err</span>&nbsp;<span class="builtintype" id="3562735">error</span><span class="op" id="3562740">)</span>&nbsp;<span class="op" id="3562742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562745">c</span>&nbsp;<span class="op" id="3562747">=</span>&nbsp;<span class="builtinfunc" id="3562749">new</span><span class="op" id="3562752">(</span><span class="ident" id="3562753">conn</span><span class="op" id="3562757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562760">c</span><span class="op" id="3562761">.</span><span class="ident" id="3562762">remoteAddr</span>&nbsp;<span class="op" id="3562773">=</span>&nbsp;<span class="ident" id="3562775">rwc</span><span class="op" id="3562778">.</span><span class="ident" id="3562779">RemoteAddr</span><span class="op" id="3562789">(</span><span class="op" id="3562790">)</span><span class="op" id="3562791">.</span><span class="ident" id="3562792">String</span><span class="op" id="3562798">(</span><span class="op" id="3562799">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562802">c</span><span class="op" id="3562803">.</span><span class="ident" id="3562804">server</span>&nbsp;<span class="op" id="3562811">=</span>&nbsp;<span class="ident" id="3562813">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562818">c</span><span class="op" id="3562819">.</span><span class="ident" id="3562820">rwc</span>&nbsp;<span class="op" id="3562824">=</span>&nbsp;<span class="ident" id="3562826">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562831">c</span><span class="op" id="3562832">.</span><span class="ident" id="3562833">w</span>&nbsp;<span class="op" id="3562835">=</span>&nbsp;<span class="ident" id="3562837">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562842">if</span>&nbsp;<span class="ident" id="3562845">debugServerConnections</span>&nbsp;<span class="op" id="3562868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562872">c</span><span class="op" id="3562873">.</span><span class="ident" id="3562874">rwc</span>&nbsp;<span class="op" id="3562878">=</span>&nbsp;<span class="ident" id="3562880">newLoggingConn</span><span class="op" id="3562894">(</span><span class="string" id="3562895">&#34;server&#34;</span><span class="op" id="3562903">,</span>&nbsp;<span class="ident" id="3562905">c</span><span class="op" id="3562906">.</span><span class="ident" id="3562907">rwc</span><span class="op" id="3562910">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562916">c</span><span class="op" id="3562917">.</span><span class="ident" id="3562918">sr</span>&nbsp;<span class="op" id="3562921">=</span>&nbsp;<span class="ident" id="3562923">liveSwitchReader</span><span class="op" id="3562939">{</span><span class="ident" id="3562940">r</span><span class="op" id="3562941">:</span>&nbsp;<span class="ident" id="3562943">c</span><span class="op" id="3562944">.</span><span class="ident" id="3562945">rwc</span><span class="op" id="3562948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562951">c</span><span class="op" id="3562952">.</span><span class="ident" id="3562953">lr</span>&nbsp;<span class="op" id="3562956">=</span>&nbsp;<span class="ident" id="3562958">io</span><span class="op" id="3562960">.</span><span class="ident" id="3562961">LimitReader</span><span class="op" id="3562972">(</span><span class="op" id="3562973">&amp;</span><span class="ident" id="3562974">c</span><span class="op" id="3562975">.</span><span class="ident" id="3562976">sr</span><span class="op" id="3562978">,</span>&nbsp;<span class="ident" id="3562980">noLimit</span><span class="op" id="3562987">)</span><span class="op" id="3562988">.</span><span class="op" id="3562989">(</span><span class="op" id="3562990">*</span><span class="ident" id="3562991">io</span><span class="op" id="3562993">.</span><span class="ident" id="3562994">LimitedReader</span><span class="op" id="3563007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563010">br</span>&nbsp;<span class="op" id="3563013">:=</span>&nbsp;<span class="ident" id="3563016">newBufioReader</span><span class="op" id="3563030">(</span><span class="ident" id="3563031">c</span><span class="op" id="3563032">.</span><span class="ident" id="3563033">lr</span><span class="op" id="3563035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563038">bw</span>&nbsp;<span class="op" id="3563041">:=</span>&nbsp;<span class="ident" id="3563044">newBufioWriterSize</span><span class="op" id="3563062">(</span><span class="ident" id="3563063">checkConnErrorWriter</span><span class="op" id="3563083">{</span><span class="ident" id="3563084">c</span><span class="op" id="3563085">}</span><span class="op" id="3563086">,</span>&nbsp;<span class="num" id="3563088">4</span><span class="op" id="3563089">&lt;&lt;</span><span class="num" id="3563091">10</span><span class="op" id="3563093">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563096">c</span><span class="op" id="3563097">.</span><span class="ident" id="3563098">buf</span>&nbsp;<span class="op" id="3563102">=</span>&nbsp;<span class="ident" id="3563104">bufio</span><span class="op" id="3563109">.</span><span class="ident" id="3563110">NewReadWriter</span><span class="op" id="3563123">(</span><span class="ident" id="3563124">br</span><span class="op" id="3563126">,</span>&nbsp;<span class="ident" id="3563128">bw</span><span class="op" id="3563130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563133">return</span>&nbsp;<span class="ident" id="3563140">c</span><span class="op" id="3563141">,</span>&nbsp;<span class="builtintype" id="3563143">nil</span><br>
<span class="lineno"></span><span class="op" id="3563147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3563150">var</span>&nbsp;<span class="op" id="3563154">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563157">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3563175">sync</span><span class="op" id="3563179">.</span><span class="ident" id="3563180">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563186">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3563204">sync</span><span class="op" id="3563208">.</span><span class="ident" id="3563209">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563215">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3563233">sync</span><span class="op" id="3563237">.</span><span class="ident" id="3563238">Pool</span><br>
<span class="lineno"></span><span class="op" id="3563243">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3563246">func</span>&nbsp;<span class="ident" id="3563251">bufioWriterPool</span><span class="op" id="3563266">(</span><span class="ident" id="3563267">size</span>&nbsp;<span class="builtintype" id="3563272">int</span><span class="op" id="3563275">)</span>&nbsp;<span class="op" id="3563277">*</span><span class="ident" id="3563278">sync</span><span class="op" id="3563282">.</span><span class="ident" id="3563283">Pool</span>&nbsp;<span class="op" id="3563288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563291">switch</span>&nbsp;<span class="ident" id="3563298">size</span>&nbsp;<span class="op" id="3563303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563306">case</span>&nbsp;<span class="num" id="3563311">2</span>&nbsp;<span class="op" id="3563313">&lt;&lt;</span>&nbsp;<span class="num" id="3563316">10</span><span class="op" id="3563318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563322">return</span>&nbsp;<span class="op" id="3563329">&amp;</span><span class="ident" id="3563330">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563349">case</span>&nbsp;<span class="num" id="3563354">4</span>&nbsp;<span class="op" id="3563356">&lt;&lt;</span>&nbsp;<span class="num" id="3563359">10</span><span class="op" id="3563361">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563365">return</span>&nbsp;<span class="op" id="3563372">&amp;</span><span class="ident" id="3563373">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563395">return</span>&nbsp;<span class="builtintype" id="3563402">nil</span><br>
<span class="lineno"></span><span class="op" id="3563406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3563409">func</span>&nbsp;<span class="ident" id="3563414">newBufioReader</span><span class="op" id="3563428">(</span><span class="ident" id="3563429">r</span>&nbsp;<span class="ident" id="3563431">io</span><span class="op" id="3563433">.</span><span class="ident" id="3563434">Reader</span><span class="op" id="3563440">)</span>&nbsp;<span class="op" id="3563442">*</span><span class="ident" id="3563443">bufio</span><span class="op" id="3563448">.</span><span class="ident" id="3563449">Reader</span>&nbsp;<span class="op" id="3563456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563459">if</span>&nbsp;<span class="ident" id="3563462">v</span>&nbsp;<span class="op" id="3563464">:=</span>&nbsp;<span class="ident" id="3563467">bufioReaderPool</span><span class="op" id="3563482">.</span><span class="ident" id="3563483">Get</span><span class="op" id="3563486">(</span><span class="op" id="3563487">)</span><span class="op" id="3563488">;</span>&nbsp;<span class="ident" id="3563490">v</span>&nbsp;<span class="op" id="3563492">!=</span>&nbsp;<span class="builtintype" id="3563495">nil</span>&nbsp;<span class="op" id="3563499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563503">br</span>&nbsp;<span class="op" id="3563506">:=</span>&nbsp;<span class="ident" id="3563509">v</span><span class="op" id="3563510">.</span><span class="op" id="3563511">(</span><span class="op" id="3563512">*</span><span class="ident" id="3563513">bufio</span><span class="op" id="3563518">.</span><span class="ident" id="3563519">Reader</span><span class="op" id="3563525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563529">br</span><span class="op" id="3563531">.</span><span class="ident" id="3563532">Reset</span><span class="op" id="3563537">(</span><span class="ident" id="3563538">r</span><span class="op" id="3563539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563543">return</span>&nbsp;<span class="ident" id="3563550">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563557">return</span>&nbsp;<span class="ident" id="3563564">bufio</span><span class="op" id="3563569">.</span><span class="ident" id="3563570">NewReader</span><span class="op" id="3563579">(</span><span class="ident" id="3563580">r</span><span class="op" id="3563581">)</span><br>
<span class="lineno"></span><span class="op" id="3563583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3563586">func</span>&nbsp;<span class="ident" id="3563591">putBufioReader</span><span class="op" id="3563605">(</span><span class="ident" id="3563606">br</span>&nbsp;<span class="op" id="3563609">*</span><span class="ident" id="3563610">bufio</span><span class="op" id="3563615">.</span><span class="ident" id="3563616">Reader</span><span class="op" id="3563622">)</span>&nbsp;<span class="op" id="3563624">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563627">br</span><span class="op" id="3563629">.</span><span class="ident" id="3563630">Reset</span><span class="op" id="3563635">(</span><span class="builtintype" id="3563636">nil</span><span class="op" id="3563639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563642">bufioReaderPool</span><span class="op" id="3563657">.</span><span class="ident" id="3563658">Put</span><span class="op" id="3563661">(</span><span class="ident" id="3563662">br</span><span class="op" id="3563664">)</span><br>
<span class="lineno"></span><span class="op" id="3563666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3563669">func</span>&nbsp;<span class="ident" id="3563674">newBufioWriterSize</span><span class="op" id="3563692">(</span><span class="ident" id="3563693">w</span>&nbsp;<span class="ident" id="3563695">io</span><span class="op" id="3563697">.</span><span class="ident" id="3563698">Writer</span><span class="op" id="3563704">,</span>&nbsp;<span class="ident" id="3563706">size</span>&nbsp;<span class="builtintype" id="3563711">int</span><span class="op" id="3563714">)</span>&nbsp;<span class="op" id="3563716">*</span><span class="ident" id="3563717">bufio</span><span class="op" id="3563722">.</span><span class="ident" id="3563723">Writer</span>&nbsp;<span class="op" id="3563730">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563733">pool</span>&nbsp;<span class="op" id="3563738">:=</span>&nbsp;<span class="ident" id="3563741">bufioWriterPool</span><span class="op" id="3563756">(</span><span class="ident" id="3563757">size</span><span class="op" id="3563761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563764">if</span>&nbsp;<span class="ident" id="3563767">pool</span>&nbsp;<span class="op" id="3563772">!=</span>&nbsp;<span class="builtintype" id="3563775">nil</span>&nbsp;<span class="op" id="3563779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563783">if</span>&nbsp;<span class="ident" id="3563786">v</span>&nbsp;<span class="op" id="3563788">:=</span>&nbsp;<span class="ident" id="3563791">pool</span><span class="op" id="3563795">.</span><span class="ident" id="3563796">Get</span><span class="op" id="3563799">(</span><span class="op" id="3563800">)</span><span class="op" id="3563801">;</span>&nbsp;<span class="ident" id="3563803">v</span>&nbsp;<span class="op" id="3563805">!=</span>&nbsp;<span class="builtintype" id="3563808">nil</span>&nbsp;<span class="op" id="3563812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563817">bw</span>&nbsp;<span class="op" id="3563820">:=</span>&nbsp;<span class="ident" id="3563823">v</span><span class="op" id="3563824">.</span><span class="op" id="3563825">(</span><span class="op" id="3563826">*</span><span class="ident" id="3563827">bufio</span><span class="op" id="3563832">.</span><span class="ident" id="3563833">Writer</span><span class="op" id="3563839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563844">bw</span><span class="op" id="3563846">.</span><span class="ident" id="3563847">Reset</span><span class="op" id="3563852">(</span><span class="ident" id="3563853">w</span><span class="op" id="3563854">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563859">return</span>&nbsp;<span class="ident" id="3563866">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563877">return</span>&nbsp;<span class="ident" id="3563884">bufio</span><span class="op" id="3563889">.</span><span class="ident" id="3563890">NewWriterSize</span><span class="op" id="3563903">(</span><span class="ident" id="3563904">w</span><span class="op" id="3563905">,</span>&nbsp;<span class="ident" id="3563907">size</span><span class="op" id="3563911">)</span><br>
<span class="lineno"></span><span class="op" id="3563913">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3563916">func</span>&nbsp;<span class="ident" id="3563921">putBufioWriter</span><span class="op" id="3563935">(</span><span class="ident" id="3563936">bw</span>&nbsp;<span class="op" id="3563939">*</span><span class="ident" id="3563940">bufio</span><span class="op" id="3563945">.</span><span class="ident" id="3563946">Writer</span><span class="op" id="3563952">)</span>&nbsp;<span class="op" id="3563954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563957">bw</span><span class="op" id="3563959">.</span><span class="ident" id="3563960">Reset</span><span class="op" id="3563965">(</span><span class="builtintype" id="3563966">nil</span><span class="op" id="3563969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563972">if</span>&nbsp;<span class="ident" id="3563975">pool</span>&nbsp;<span class="op" id="3563980">:=</span>&nbsp;<span class="ident" id="3563983">bufioWriterPool</span><span class="op" id="3563998">(</span><span class="ident" id="3563999">bw</span><span class="op" id="3564001">.</span><span class="ident" id="3564002">Available</span><span class="op" id="3564011">(</span><span class="op" id="3564012">)</span><span class="op" id="3564013">)</span><span class="op" id="3564014">;</span>&nbsp;<span class="ident" id="3564016">pool</span>&nbsp;<span class="op" id="3564021">!=</span>&nbsp;<span class="builtintype" id="3564024">nil</span>&nbsp;<span class="op" id="3564028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564032">pool</span><span class="op" id="3564036">.</span><span class="ident" id="3564037">Put</span><span class="op" id="3564040">(</span><span class="ident" id="3564041">bw</span><span class="op" id="3564043">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564046">}</span><br>
<span class="lineno"></span><span class="op" id="3564048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3564051">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3564121">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3564144">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3564204">const</span>&nbsp;<span class="ident" id="3564210">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3564232">=</span>&nbsp;<span class="num" id="3564234">1</span>&nbsp;<span class="op" id="3564236">&lt;&lt;</span>&nbsp;<span class="num" id="3564239">20</span>&nbsp;<span class="comment" id="3564242">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564251">func</span>&nbsp;<span class="op" id="3564256">(</span><span class="ident" id="3564257">srv</span>&nbsp;<span class="op" id="3564261">*</span><span class="ident" id="3564262">Server</span><span class="op" id="3564268">)</span>&nbsp;<span class="ident" id="3564270">maxHeaderBytes</span><span class="op" id="3564284">(</span><span class="op" id="3564285">)</span>&nbsp;<span class="builtintype" id="3564287">int</span>&nbsp;<span class="op" id="3564291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564294">if</span>&nbsp;<span class="ident" id="3564297">srv</span><span class="op" id="3564300">.</span><span class="ident" id="3564301">MaxHeaderBytes</span>&nbsp;<span class="op" id="3564316">&gt;</span>&nbsp;<span class="num" id="3564318">0</span>&nbsp;<span class="op" id="3564320">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564324">return</span>&nbsp;<span class="ident" id="3564331">srv</span><span class="op" id="3564334">.</span><span class="ident" id="3564335">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564354">return</span>&nbsp;<span class="ident" id="3564361">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3564383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3564386">func</span>&nbsp;<span class="op" id="3564391">(</span><span class="ident" id="3564392">srv</span>&nbsp;<span class="op" id="3564396">*</span><span class="ident" id="3564397">Server</span><span class="op" id="3564403">)</span>&nbsp;<span class="ident" id="3564405">initialLimitedReaderSize</span><span class="op" id="3564429">(</span><span class="op" id="3564430">)</span>&nbsp;<span class="builtintype" id="3564432">int64</span>&nbsp;<span class="op" id="3564438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564441">return</span>&nbsp;<span class="builtintype" id="3564448">int64</span><span class="op" id="3564453">(</span><span class="ident" id="3564454">srv</span><span class="op" id="3564457">.</span><span class="ident" id="3564458">maxHeaderBytes</span><span class="op" id="3564472">(</span><span class="op" id="3564473">)</span><span class="op" id="3564474">)</span>&nbsp;<span class="op" id="3564476">+</span>&nbsp;<span class="num" id="3564478">4096</span>&nbsp;<span class="comment" id="3564483">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3564497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3564500">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3564564">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3564596">type</span>&nbsp;<span class="ident" id="3564601">expectContinueReader</span>&nbsp;<span class="keyword" id="3564622">struct</span>&nbsp;<span class="op" id="3564629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564632">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564643">*</span><span class="ident" id="3564644">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564654">readCloser</span>&nbsp;<span class="ident" id="3564665">io</span><span class="op" id="3564667">.</span><span class="ident" id="3564668">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564680">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3564691">bool</span><br>
<span class="lineno">520</span><span class="op" id="3564696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564699">func</span>&nbsp;<span class="op" id="3564704">(</span><span class="ident" id="3564705">ecr</span>&nbsp;<span class="op" id="3564709">*</span><span class="ident" id="3564710">expectContinueReader</span><span class="op" id="3564730">)</span>&nbsp;<span class="ident" id="3564732">Read</span><span class="op" id="3564736">(</span><span class="ident" id="3564737">p</span>&nbsp;<span class="op" id="3564739">[</span><span class="op" id="3564740">]</span><span class="builtintype" id="3564741">byte</span><span class="op" id="3564745">)</span>&nbsp;<span class="op" id="3564747">(</span><span class="ident" id="3564748">n</span>&nbsp;<span class="builtintype" id="3564750">int</span><span class="op" id="3564753">,</span>&nbsp;<span class="ident" id="3564755">err</span>&nbsp;<span class="builtintype" id="3564759">error</span><span class="op" id="3564764">)</span>&nbsp;<span class="op" id="3564766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564769">if</span>&nbsp;<span class="ident" id="3564772">ecr</span><span class="op" id="3564775">.</span><span class="ident" id="3564776">closed</span>&nbsp;<span class="op" id="3564783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564787">return</span>&nbsp;<span class="num" id="3564794">0</span><span class="op" id="3564795">,</span>&nbsp;<span class="ident" id="3564797">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564823">if</span>&nbsp;<span class="op" id="3564826">!</span><span class="ident" id="3564827">ecr</span><span class="op" id="3564830">.</span><span class="ident" id="3564831">resp</span><span class="op" id="3564835">.</span><span class="ident" id="3564836">wroteContinue</span>&nbsp;<span class="op" id="3564850">&amp;&amp;</span>&nbsp;<span class="op" id="3564853">!</span><span class="ident" id="3564854">ecr</span><span class="op" id="3564857">.</span><span class="ident" id="3564858">resp</span><span class="op" id="3564862">.</span><span class="ident" id="3564863">conn</span><span class="op" id="3564867">.</span><span class="ident" id="3564868">hijacked</span><span class="op" id="3564876">(</span><span class="op" id="3564877">)</span>&nbsp;<span class="op" id="3564879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564883">ecr</span><span class="op" id="3564886">.</span><span class="ident" id="3564887">resp</span><span class="op" id="3564891">.</span><span class="ident" id="3564892">wroteContinue</span>&nbsp;<span class="op" id="3564906">=</span>&nbsp;<span class="builtintype" id="3564908">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564915">ecr</span><span class="op" id="3564918">.</span><span class="ident" id="3564919">resp</span><span class="op" id="3564923">.</span><span class="ident" id="3564924">conn</span><span class="op" id="3564928">.</span><span class="ident" id="3564929">buf</span><span class="op" id="3564932">.</span><span class="ident" id="3564933">WriteString</span><span class="op" id="3564944">(</span><span class="string" id="3564945">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3564976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564980">ecr</span><span class="op" id="3564983">.</span><span class="ident" id="3564984">resp</span><span class="op" id="3564988">.</span><span class="ident" id="3564989">conn</span><span class="op" id="3564993">.</span><span class="ident" id="3564994">buf</span><span class="op" id="3564997">.</span><span class="ident" id="3564998">Flush</span><span class="op" id="3565003">(</span><span class="op" id="3565004">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3565007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565010">return</span>&nbsp;<span class="ident" id="3565017">ecr</span><span class="op" id="3565020">.</span><span class="ident" id="3565021">readCloser</span><span class="op" id="3565031">.</span><span class="ident" id="3565032">Read</span><span class="op" id="3565036">(</span><span class="ident" id="3565037">p</span><span class="op" id="3565038">)</span><br>
<span class="lineno"></span><span class="op" id="3565040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3565043">func</span>&nbsp;<span class="op" id="3565048">(</span><span class="ident" id="3565049">ecr</span>&nbsp;<span class="op" id="3565053">*</span><span class="ident" id="3565054">expectContinueReader</span><span class="op" id="3565074">)</span>&nbsp;<span class="ident" id="3565076">Close</span><span class="op" id="3565081">(</span><span class="op" id="3565082">)</span>&nbsp;<span class="builtintype" id="3565084">error</span>&nbsp;<span class="op" id="3565090">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565093">ecr</span><span class="op" id="3565096">.</span><span class="ident" id="3565097">closed</span>&nbsp;<span class="op" id="3565104">=</span>&nbsp;<span class="builtintype" id="3565106">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565112">return</span>&nbsp;<span class="ident" id="3565119">ecr</span><span class="op" id="3565122">.</span><span class="ident" id="3565123">readCloser</span><span class="op" id="3565133">.</span><span class="ident" id="3565134">Close</span><span class="op" id="3565139">(</span><span class="op" id="3565140">)</span><br>
<span class="lineno"></span><span class="op" id="3565142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3565145">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3565190">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3565238">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3565278">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3565342">const</span>&nbsp;<span class="ident" id="3565348">TimeFormat</span>&nbsp;<span class="op" id="3565359">=</span>&nbsp;<span class="string" id="3565361">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3565394">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3565474">func</span>&nbsp;<span class="ident" id="3565479">appendTime</span><span class="op" id="3565489">(</span><span class="ident" id="3565490">b</span>&nbsp;<span class="op" id="3565492">[</span><span class="op" id="3565493">]</span><span class="builtintype" id="3565494">byte</span><span class="op" id="3565498">,</span>&nbsp;<span class="ident" id="3565500">t</span>&nbsp;<span class="ident" id="3565502">time</span><span class="op" id="3565506">.</span><span class="ident" id="3565507">Time</span><span class="op" id="3565511">)</span>&nbsp;<span class="op" id="3565513">[</span><span class="op" id="3565514">]</span><span class="builtintype" id="3565515">byte</span>&nbsp;<span class="op" id="3565520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565523">const</span>&nbsp;<span class="ident" id="3565529">days</span>&nbsp;<span class="op" id="3565534">=</span>&nbsp;<span class="string" id="3565536">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565561">const</span>&nbsp;<span class="ident" id="3565567">months</span>&nbsp;<span class="op" id="3565574">=</span>&nbsp;<span class="string" id="3565576">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565617">t</span>&nbsp;<span class="op" id="3565619">=</span>&nbsp;<span class="ident" id="3565621">t</span><span class="op" id="3565622">.</span><span class="ident" id="3565623">UTC</span><span class="op" id="3565626">(</span><span class="op" id="3565627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565630">yy</span><span class="op" id="3565632">,</span>&nbsp;<span class="ident" id="3565634">mm</span><span class="op" id="3565636">,</span>&nbsp;<span class="ident" id="3565638">dd</span>&nbsp;<span class="op" id="3565641">:=</span>&nbsp;<span class="ident" id="3565644">t</span><span class="op" id="3565645">.</span><span class="ident" id="3565646">Date</span><span class="op" id="3565650">(</span><span class="op" id="3565651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565654">hh</span><span class="op" id="3565656">,</span>&nbsp;<span class="ident" id="3565658">mn</span><span class="op" id="3565660">,</span>&nbsp;<span class="ident" id="3565662">ss</span>&nbsp;<span class="op" id="3565665">:=</span>&nbsp;<span class="ident" id="3565668">t</span><span class="op" id="3565669">.</span><span class="ident" id="3565670">Clock</span><span class="op" id="3565675">(</span><span class="op" id="3565676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565679">day</span>&nbsp;<span class="op" id="3565683">:=</span>&nbsp;<span class="ident" id="3565686">days</span><span class="op" id="3565690">[</span><span class="num" id="3565691">3</span><span class="op" id="3565692">*</span><span class="ident" id="3565693">t</span><span class="op" id="3565694">.</span><span class="ident" id="3565695">Weekday</span><span class="op" id="3565702">(</span><span class="op" id="3565703">)</span><span class="op" id="3565704">:</span><span class="op" id="3565705">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565708">mon</span>&nbsp;<span class="op" id="3565712">:=</span>&nbsp;<span class="ident" id="3565715">months</span><span class="op" id="3565721">[</span><span class="num" id="3565722">3</span><span class="op" id="3565723">*</span><span class="op" id="3565724">(</span><span class="ident" id="3565725">mm</span><span class="op" id="3565727">-</span><span class="num" id="3565728">1</span><span class="op" id="3565729">)</span><span class="op" id="3565730">:</span><span class="op" id="3565731">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565735">return</span>&nbsp;<span class="builtinfunc" id="3565742">append</span><span class="op" id="3565748">(</span><span class="ident" id="3565749">b</span><span class="op" id="3565750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565754">day</span><span class="op" id="3565757">[</span><span class="num" id="3565758">0</span><span class="op" id="3565759">]</span><span class="op" id="3565760">,</span>&nbsp;<span class="ident" id="3565762">day</span><span class="op" id="3565765">[</span><span class="num" id="3565766">1</span><span class="op" id="3565767">]</span><span class="op" id="3565768">,</span>&nbsp;<span class="ident" id="3565770">day</span><span class="op" id="3565773">[</span><span class="num" id="3565774">2</span><span class="op" id="3565775">]</span><span class="op" id="3565776">,</span>&nbsp;<span class="string" id="3565778">&#39;,&#39;</span><span class="op" id="3565781">,</span>&nbsp;<span class="string" id="3565783">&#39;&nbsp;&#39;</span><span class="op" id="3565786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3565790">byte</span><span class="op" id="3565794">(</span><span class="string" id="3565795">&#39;0&#39;</span><span class="op" id="3565798">+</span><span class="ident" id="3565799">dd</span><span class="op" id="3565801">/</span><span class="num" id="3565802">10</span><span class="op" id="3565804">)</span><span class="op" id="3565805">,</span>&nbsp;<span class="builtintype" id="3565807">byte</span><span class="op" id="3565811">(</span><span class="string" id="3565812">&#39;0&#39;</span><span class="op" id="3565815">+</span><span class="ident" id="3565816">dd</span><span class="op" id="3565818">%</span><span class="num" id="3565819">10</span><span class="op" id="3565821">)</span><span class="op" id="3565822">,</span>&nbsp;<span class="string" id="3565824">&#39;&nbsp;&#39;</span><span class="op" id="3565827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565831">mon</span><span class="op" id="3565834">[</span><span class="num" id="3565835">0</span><span class="op" id="3565836">]</span><span class="op" id="3565837">,</span>&nbsp;<span class="ident" id="3565839">mon</span><span class="op" id="3565842">[</span><span class="num" id="3565843">1</span><span class="op" id="3565844">]</span><span class="op" id="3565845">,</span>&nbsp;<span class="ident" id="3565847">mon</span><span class="op" id="3565850">[</span><span class="num" id="3565851">2</span><span class="op" id="3565852">]</span><span class="op" id="3565853">,</span>&nbsp;<span class="string" id="3565855">&#39;&nbsp;&#39;</span><span class="op" id="3565858">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3565862">byte</span><span class="op" id="3565866">(</span><span class="string" id="3565867">&#39;0&#39;</span><span class="op" id="3565870">+</span><span class="ident" id="3565871">yy</span><span class="op" id="3565873">/</span><span class="num" id="3565874">1000</span><span class="op" id="3565878">)</span><span class="op" id="3565879">,</span>&nbsp;<span class="builtintype" id="3565881">byte</span><span class="op" id="3565885">(</span><span class="string" id="3565886">&#39;0&#39;</span><span class="op" id="3565889">+</span><span class="op" id="3565890">(</span><span class="ident" id="3565891">yy</span><span class="op" id="3565893">/</span><span class="num" id="3565894">100</span><span class="op" id="3565897">)</span><span class="op" id="3565898">%</span><span class="num" id="3565899">10</span><span class="op" id="3565901">)</span><span class="op" id="3565902">,</span>&nbsp;<span class="builtintype" id="3565904">byte</span><span class="op" id="3565908">(</span><span class="string" id="3565909">&#39;0&#39;</span><span class="op" id="3565912">+</span><span class="op" id="3565913">(</span><span class="ident" id="3565914">yy</span><span class="op" id="3565916">/</span><span class="num" id="3565917">10</span><span class="op" id="3565919">)</span><span class="op" id="3565920">%</span><span class="num" id="3565921">10</span><span class="op" id="3565923">)</span><span class="op" id="3565924">,</span>&nbsp;<span class="builtintype" id="3565926">byte</span><span class="op" id="3565930">(</span><span class="string" id="3565931">&#39;0&#39;</span><span class="op" id="3565934">+</span><span class="ident" id="3565935">yy</span><span class="op" id="3565937">%</span><span class="num" id="3565938">10</span><span class="op" id="3565940">)</span><span class="op" id="3565941">,</span>&nbsp;<span class="string" id="3565943">&#39;&nbsp;&#39;</span><span class="op" id="3565946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3565950">byte</span><span class="op" id="3565954">(</span><span class="string" id="3565955">&#39;0&#39;</span><span class="op" id="3565958">+</span><span class="ident" id="3565959">hh</span><span class="op" id="3565961">/</span><span class="num" id="3565962">10</span><span class="op" id="3565964">)</span><span class="op" id="3565965">,</span>&nbsp;<span class="builtintype" id="3565967">byte</span><span class="op" id="3565971">(</span><span class="string" id="3565972">&#39;0&#39;</span><span class="op" id="3565975">+</span><span class="ident" id="3565976">hh</span><span class="op" id="3565978">%</span><span class="num" id="3565979">10</span><span class="op" id="3565981">)</span><span class="op" id="3565982">,</span>&nbsp;<span class="string" id="3565984">&#39;:&#39;</span><span class="op" id="3565987">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3565991">byte</span><span class="op" id="3565995">(</span><span class="string" id="3565996">&#39;0&#39;</span><span class="op" id="3565999">+</span><span class="ident" id="3566000">mn</span><span class="op" id="3566002">/</span><span class="num" id="3566003">10</span><span class="op" id="3566005">)</span><span class="op" id="3566006">,</span>&nbsp;<span class="builtintype" id="3566008">byte</span><span class="op" id="3566012">(</span><span class="string" id="3566013">&#39;0&#39;</span><span class="op" id="3566016">+</span><span class="ident" id="3566017">mn</span><span class="op" id="3566019">%</span><span class="num" id="3566020">10</span><span class="op" id="3566022">)</span><span class="op" id="3566023">,</span>&nbsp;<span class="string" id="3566025">&#39;:&#39;</span><span class="op" id="3566028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3566032">byte</span><span class="op" id="3566036">(</span><span class="string" id="3566037">&#39;0&#39;</span><span class="op" id="3566040">+</span><span class="ident" id="3566041">ss</span><span class="op" id="3566043">/</span><span class="num" id="3566044">10</span><span class="op" id="3566046">)</span><span class="op" id="3566047">,</span>&nbsp;<span class="builtintype" id="3566049">byte</span><span class="op" id="3566053">(</span><span class="string" id="3566054">&#39;0&#39;</span><span class="op" id="3566057">+</span><span class="ident" id="3566058">ss</span><span class="op" id="3566060">%</span><span class="num" id="3566061">10</span><span class="op" id="3566063">)</span><span class="op" id="3566064">,</span>&nbsp;<span class="string" id="3566066">&#39;&nbsp;&#39;</span><span class="op" id="3566069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3566073">&#39;G&#39;</span><span class="op" id="3566076">,</span>&nbsp;<span class="string" id="3566078">&#39;M&#39;</span><span class="op" id="3566081">,</span>&nbsp;<span class="string" id="3566083">&#39;T&#39;</span><span class="op" id="3566086">)</span><br>
<span class="lineno">565</span><span class="op" id="3566088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3566091">var</span>&nbsp;<span class="ident" id="3566095">errTooLarge</span>&nbsp;<span class="op" id="3566107">=</span>&nbsp;<span class="ident" id="3566109">errors</span><span class="op" id="3566115">.</span><span class="ident" id="3566116">New</span><span class="op" id="3566119">(</span><span class="string" id="3566120">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3566145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3566148">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3566186">func</span>&nbsp;<span class="op" id="3566191">(</span><span class="ident" id="3566192">c</span>&nbsp;<span class="op" id="3566194">*</span><span class="ident" id="3566195">conn</span><span class="op" id="3566199">)</span>&nbsp;<span class="ident" id="3566201">readRequest</span><span class="op" id="3566212">(</span><span class="op" id="3566213">)</span>&nbsp;<span class="op" id="3566215">(</span><span class="ident" id="3566216">w</span>&nbsp;<span class="op" id="3566218">*</span><span class="ident" id="3566219">response</span><span class="op" id="3566227">,</span>&nbsp;<span class="ident" id="3566229">err</span>&nbsp;<span class="builtintype" id="3566233">error</span><span class="op" id="3566238">)</span>&nbsp;<span class="op" id="3566240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566243">if</span>&nbsp;<span class="ident" id="3566246">c</span><span class="op" id="3566247">.</span><span class="ident" id="3566248">hijacked</span><span class="op" id="3566256">(</span><span class="op" id="3566257">)</span>&nbsp;<span class="op" id="3566259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566263">return</span>&nbsp;<span class="builtintype" id="3566270">nil</span><span class="op" id="3566273">,</span>&nbsp;<span class="ident" id="3566275">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566292">if</span>&nbsp;<span class="ident" id="3566295">d</span>&nbsp;<span class="op" id="3566297">:=</span>&nbsp;<span class="ident" id="3566300">c</span><span class="op" id="3566301">.</span><span class="ident" id="3566302">server</span><span class="op" id="3566308">.</span><span class="ident" id="3566309">ReadTimeout</span><span class="op" id="3566320">;</span>&nbsp;<span class="ident" id="3566322">d</span>&nbsp;<span class="op" id="3566324">!=</span>&nbsp;<span class="num" id="3566327">0</span>&nbsp;<span class="op" id="3566329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566333">c</span><span class="op" id="3566334">.</span><span class="ident" id="3566335">rwc</span><span class="op" id="3566338">.</span><span class="ident" id="3566339">SetReadDeadline</span><span class="op" id="3566354">(</span><span class="ident" id="3566355">time</span><span class="op" id="3566359">.</span><span class="ident" id="3566360">Now</span><span class="op" id="3566363">(</span><span class="op" id="3566364">)</span><span class="op" id="3566365">.</span><span class="ident" id="3566366">Add</span><span class="op" id="3566369">(</span><span class="ident" id="3566370">d</span><span class="op" id="3566371">)</span><span class="op" id="3566372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566378">if</span>&nbsp;<span class="ident" id="3566381">d</span>&nbsp;<span class="op" id="3566383">:=</span>&nbsp;<span class="ident" id="3566386">c</span><span class="op" id="3566387">.</span><span class="ident" id="3566388">server</span><span class="op" id="3566394">.</span><span class="ident" id="3566395">WriteTimeout</span><span class="op" id="3566407">;</span>&nbsp;<span class="ident" id="3566409">d</span>&nbsp;<span class="op" id="3566411">!=</span>&nbsp;<span class="num" id="3566414">0</span>&nbsp;<span class="op" id="3566416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566420">defer</span>&nbsp;<span class="keyword" id="3566426">func</span><span class="op" id="3566430">(</span><span class="op" id="3566431">)</span>&nbsp;<span class="op" id="3566433">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566438">c</span><span class="op" id="3566439">.</span><span class="ident" id="3566440">rwc</span><span class="op" id="3566443">.</span><span class="ident" id="3566444">SetWriteDeadline</span><span class="op" id="3566460">(</span><span class="ident" id="3566461">time</span><span class="op" id="3566465">.</span><span class="ident" id="3566466">Now</span><span class="op" id="3566469">(</span><span class="op" id="3566470">)</span><span class="op" id="3566471">.</span><span class="ident" id="3566472">Add</span><span class="op" id="3566475">(</span><span class="ident" id="3566476">d</span><span class="op" id="3566477">)</span><span class="op" id="3566478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566482">}</span><span class="op" id="3566483">(</span><span class="op" id="3566484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566491">c</span><span class="op" id="3566492">.</span><span class="ident" id="3566493">lr</span><span class="op" id="3566495">.</span><span class="ident" id="3566496">N</span>&nbsp;<span class="op" id="3566498">=</span>&nbsp;<span class="ident" id="3566500">c</span><span class="op" id="3566501">.</span><span class="ident" id="3566502">server</span><span class="op" id="3566508">.</span><span class="ident" id="3566509">initialLimitedReaderSize</span><span class="op" id="3566533">(</span><span class="op" id="3566534">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566537">var</span>&nbsp;<span class="ident" id="3566541">req</span>&nbsp;<span class="op" id="3566545">*</span><span class="ident" id="3566546">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566555">if</span>&nbsp;<span class="ident" id="3566558">req</span><span class="op" id="3566561">,</span>&nbsp;<span class="ident" id="3566563">err</span>&nbsp;<span class="op" id="3566567">=</span>&nbsp;<span class="ident" id="3566569">ReadRequest</span><span class="op" id="3566580">(</span><span class="ident" id="3566581">c</span><span class="op" id="3566582">.</span><span class="ident" id="3566583">buf</span><span class="op" id="3566586">.</span><span class="ident" id="3566587">Reader</span><span class="op" id="3566593">)</span><span class="op" id="3566594">;</span>&nbsp;<span class="ident" id="3566596">err</span>&nbsp;<span class="op" id="3566600">!=</span>&nbsp;<span class="builtintype" id="3566603">nil</span>&nbsp;<span class="op" id="3566607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566611">if</span>&nbsp;<span class="ident" id="3566614">c</span><span class="op" id="3566615">.</span><span class="ident" id="3566616">lr</span><span class="op" id="3566618">.</span><span class="ident" id="3566619">N</span>&nbsp;<span class="op" id="3566621">==</span>&nbsp;<span class="num" id="3566624">0</span>&nbsp;<span class="op" id="3566626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566631">return</span>&nbsp;<span class="builtintype" id="3566638">nil</span><span class="op" id="3566641">,</span>&nbsp;<span class="ident" id="3566643">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566657">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566661">return</span>&nbsp;<span class="builtintype" id="3566668">nil</span><span class="op" id="3566671">,</span>&nbsp;<span class="ident" id="3566673">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566681">c</span><span class="op" id="3566682">.</span><span class="ident" id="3566683">lr</span><span class="op" id="3566685">.</span><span class="ident" id="3566686">N</span>&nbsp;<span class="op" id="3566688">=</span>&nbsp;<span class="ident" id="3566690">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566700">req</span><span class="op" id="3566703">.</span><span class="ident" id="3566704">RemoteAddr</span>&nbsp;<span class="op" id="3566715">=</span>&nbsp;<span class="ident" id="3566717">c</span><span class="op" id="3566718">.</span><span class="ident" id="3566719">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566731">req</span><span class="op" id="3566734">.</span><span class="ident" id="3566735">TLS</span>&nbsp;<span class="op" id="3566739">=</span>&nbsp;<span class="ident" id="3566741">c</span><span class="op" id="3566742">.</span><span class="ident" id="3566743">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566754">w</span>&nbsp;<span class="op" id="3566756">=</span>&nbsp;<span class="op" id="3566758">&amp;</span><span class="ident" id="3566759">response</span><span class="op" id="3566767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566771">conn</span><span class="op" id="3566775">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566786">c</span><span class="op" id="3566787">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566791">req</span><span class="op" id="3566794">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566806">req</span><span class="op" id="3566809">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566813">handlerHeader</span><span class="op" id="3566826">:</span>&nbsp;<span class="builtinfunc" id="3566828">make</span><span class="op" id="3566832">(</span><span class="ident" id="3566833">Header</span><span class="op" id="3566839">)</span><span class="op" id="3566840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566844">contentLength</span><span class="op" id="3566857">:</span>&nbsp;<span class="op" id="3566859">-</span><span class="num" id="3566860">1</span><span class="op" id="3566861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566867">w</span><span class="op" id="3566868">.</span><span class="ident" id="3566869">cw</span><span class="op" id="3566871">.</span><span class="ident" id="3566872">res</span>&nbsp;<span class="op" id="3566876">=</span>&nbsp;<span class="ident" id="3566878">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566881">w</span><span class="op" id="3566882">.</span><span class="ident" id="3566883">w</span>&nbsp;<span class="op" id="3566885">=</span>&nbsp;<span class="ident" id="3566887">newBufioWriterSize</span><span class="op" id="3566905">(</span><span class="op" id="3566906">&amp;</span><span class="ident" id="3566907">w</span><span class="op" id="3566908">.</span><span class="ident" id="3566909">cw</span><span class="op" id="3566911">,</span>&nbsp;<span class="ident" id="3566913">bufferBeforeChunkingSize</span><span class="op" id="3566937">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566940">return</span>&nbsp;<span class="ident" id="3566947">w</span><span class="op" id="3566948">,</span>&nbsp;<span class="builtintype" id="3566950">nil</span><br>
<span class="lineno"></span><span class="op" id="3566954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3566957">func</span>&nbsp;<span class="op" id="3566962">(</span><span class="ident" id="3566963">w</span>&nbsp;<span class="op" id="3566965">*</span><span class="ident" id="3566966">response</span><span class="op" id="3566974">)</span>&nbsp;<span class="ident" id="3566976">Header</span><span class="op" id="3566982">(</span><span class="op" id="3566983">)</span>&nbsp;<span class="ident" id="3566985">Header</span>&nbsp;<span class="op" id="3566992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566995">if</span>&nbsp;<span class="ident" id="3566998">w</span><span class="op" id="3566999">.</span><span class="ident" id="3567000">cw</span><span class="op" id="3567002">.</span><span class="ident" id="3567003">header</span>&nbsp;<span class="op" id="3567010">==</span>&nbsp;<span class="builtintype" id="3567013">nil</span>&nbsp;<span class="op" id="3567017">&amp;&amp;</span>&nbsp;<span class="ident" id="3567020">w</span><span class="op" id="3567021">.</span><span class="ident" id="3567022">wroteHeader</span>&nbsp;<span class="op" id="3567034">&amp;&amp;</span>&nbsp;<span class="op" id="3567037">!</span><span class="ident" id="3567038">w</span><span class="op" id="3567039">.</span><span class="ident" id="3567040">cw</span><span class="op" id="3567042">.</span><span class="ident" id="3567043">wroteHeader</span>&nbsp;<span class="op" id="3567055">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3567059">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3567114">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3567171">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3567225">w</span><span class="op" id="3567226">.</span><span class="ident" id="3567227">cw</span><span class="op" id="3567229">.</span><span class="ident" id="3567230">header</span>&nbsp;<span class="op" id="3567237">=</span>&nbsp;<span class="ident" id="3567239">w</span><span class="op" id="3567240">.</span><span class="ident" id="3567241">handlerHeader</span><span class="op" id="3567254">.</span><span class="ident" id="3567255">clone</span><span class="op" id="3567260">(</span><span class="op" id="3567261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3567264">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3567267">w</span><span class="op" id="3567268">.</span><span class="ident" id="3567269">calledHeader</span>&nbsp;<span class="op" id="3567282">=</span>&nbsp;<span class="builtintype" id="3567284">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3567290">return</span>&nbsp;<span class="ident" id="3567297">w</span><span class="op" id="3567298">.</span><span class="ident" id="3567299">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3567313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3567316">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3567387">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3567454">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3567524">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3567592">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3567612">//</span><br>
<span class="lineno">625</span><span class="comment" id="3567615">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3567683">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3567753">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3567772">const</span>&nbsp;<span class="ident" id="3567778">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3567802">=</span>&nbsp;<span class="num" id="3567804">256</span>&nbsp;<span class="op" id="3567808">&lt;&lt;</span>&nbsp;<span class="num" id="3567811">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3567815">func</span>&nbsp;<span class="op" id="3567820">(</span><span class="ident" id="3567821">w</span>&nbsp;<span class="op" id="3567823">*</span><span class="ident" id="3567824">response</span><span class="op" id="3567832">)</span>&nbsp;<span class="ident" id="3567834">WriteHeader</span><span class="op" id="3567845">(</span><span class="ident" id="3567846">code</span>&nbsp;<span class="builtintype" id="3567851">int</span><span class="op" id="3567854">)</span>&nbsp;<span class="op" id="3567856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3567859">if</span>&nbsp;<span class="ident" id="3567862">w</span><span class="op" id="3567863">.</span><span class="ident" id="3567864">conn</span><span class="op" id="3567868">.</span><span class="ident" id="3567869">hijacked</span><span class="op" id="3567877">(</span><span class="op" id="3567878">)</span>&nbsp;<span class="op" id="3567880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3567884">w</span><span class="op" id="3567885">.</span><span class="ident" id="3567886">conn</span><span class="op" id="3567890">.</span><span class="ident" id="3567891">server</span><span class="op" id="3567897">.</span><span class="ident" id="3567898">logf</span><span class="op" id="3567902">(</span><span class="string" id="3567903">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3567954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3567958">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3567966">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3567969">if</span>&nbsp;<span class="ident" id="3567972">w</span><span class="op" id="3567973">.</span><span class="ident" id="3567974">wroteHeader</span>&nbsp;<span class="op" id="3567986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3567990">w</span><span class="op" id="3567991">.</span><span class="ident" id="3567992">conn</span><span class="op" id="3567996">.</span><span class="ident" id="3567997">server</span><span class="op" id="3568003">.</span><span class="ident" id="3568004">logf</span><span class="op" id="3568008">(</span><span class="string" id="3568009">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3568052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3568056">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568067">w</span><span class="op" id="3568068">.</span><span class="ident" id="3568069">wroteHeader</span>&nbsp;<span class="op" id="3568081">=</span>&nbsp;<span class="builtintype" id="3568083">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568089">w</span><span class="op" id="3568090">.</span><span class="ident" id="3568091">status</span>&nbsp;<span class="op" id="3568098">=</span>&nbsp;<span class="ident" id="3568100">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3568107">if</span>&nbsp;<span class="ident" id="3568110">w</span><span class="op" id="3568111">.</span><span class="ident" id="3568112">calledHeader</span>&nbsp;<span class="op" id="3568125">&amp;&amp;</span>&nbsp;<span class="ident" id="3568128">w</span><span class="op" id="3568129">.</span><span class="ident" id="3568130">cw</span><span class="op" id="3568132">.</span><span class="ident" id="3568133">header</span>&nbsp;<span class="op" id="3568140">==</span>&nbsp;<span class="builtintype" id="3568143">nil</span>&nbsp;<span class="op" id="3568147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568151">w</span><span class="op" id="3568152">.</span><span class="ident" id="3568153">cw</span><span class="op" id="3568155">.</span><span class="ident" id="3568156">header</span>&nbsp;<span class="op" id="3568163">=</span>&nbsp;<span class="ident" id="3568165">w</span><span class="op" id="3568166">.</span><span class="ident" id="3568167">handlerHeader</span><span class="op" id="3568180">.</span><span class="ident" id="3568181">clone</span><span class="op" id="3568186">(</span><span class="op" id="3568187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568190">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3568194">if</span>&nbsp;<span class="ident" id="3568197">cl</span>&nbsp;<span class="op" id="3568200">:=</span>&nbsp;<span class="ident" id="3568203">w</span><span class="op" id="3568204">.</span><span class="ident" id="3568205">handlerHeader</span><span class="op" id="3568218">.</span><span class="ident" id="3568219">get</span><span class="op" id="3568222">(</span><span class="string" id="3568223">&#34;Content-Length&#34;</span><span class="op" id="3568239">)</span><span class="op" id="3568240">;</span>&nbsp;<span class="ident" id="3568242">cl</span>&nbsp;<span class="op" id="3568245">!=</span>&nbsp;<span class="string" id="3568248">&#34;&#34;</span>&nbsp;<span class="op" id="3568251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568255">v</span><span class="op" id="3568256">,</span>&nbsp;<span class="ident" id="3568258">err</span>&nbsp;<span class="op" id="3568262">:=</span>&nbsp;<span class="ident" id="3568265">strconv</span><span class="op" id="3568272">.</span><span class="ident" id="3568273">ParseInt</span><span class="op" id="3568281">(</span><span class="ident" id="3568282">cl</span><span class="op" id="3568284">,</span>&nbsp;<span class="num" id="3568286">10</span><span class="op" id="3568288">,</span>&nbsp;<span class="num" id="3568290">64</span><span class="op" id="3568292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3568296">if</span>&nbsp;<span class="ident" id="3568299">err</span>&nbsp;<span class="op" id="3568303">==</span>&nbsp;<span class="builtintype" id="3568306">nil</span>&nbsp;<span class="op" id="3568310">&amp;&amp;</span>&nbsp;<span class="ident" id="3568313">v</span>&nbsp;<span class="op" id="3568315">&gt;=</span>&nbsp;<span class="num" id="3568318">0</span>&nbsp;<span class="op" id="3568320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568325">w</span><span class="op" id="3568326">.</span><span class="ident" id="3568327">contentLength</span>&nbsp;<span class="op" id="3568341">=</span>&nbsp;<span class="ident" id="3568343">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568347">}</span>&nbsp;<span class="keyword" id="3568349">else</span>&nbsp;<span class="op" id="3568354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568359">w</span><span class="op" id="3568360">.</span><span class="ident" id="3568361">conn</span><span class="op" id="3568365">.</span><span class="ident" id="3568366">server</span><span class="op" id="3568372">.</span><span class="ident" id="3568373">logf</span><span class="op" id="3568377">(</span><span class="string" id="3568378">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3568414">,</span>&nbsp;<span class="ident" id="3568416">cl</span><span class="op" id="3568418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568423">w</span><span class="op" id="3568424">.</span><span class="ident" id="3568425">handlerHeader</span><span class="op" id="3568438">.</span><span class="ident" id="3568439">Del</span><span class="op" id="3568442">(</span><span class="string" id="3568443">&#34;Content-Length&#34;</span><span class="op" id="3568459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568466">}</span><br>
<span class="lineno">655</span><span class="op" id="3568468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3568471">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3568552">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3568631">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3568688">type</span>&nbsp;<span class="ident" id="3568693">extraHeader</span>&nbsp;<span class="keyword" id="3568705">struct</span>&nbsp;<span class="op" id="3568712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568715">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3568732">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568740">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3568757">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568765">transferEncoding</span>&nbsp;<span class="builtintype" id="3568782">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568790">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568807">[</span><span class="op" id="3568808">]</span><span class="builtintype" id="3568809">byte</span>&nbsp;<span class="comment" id="3568814">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3568837">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568854">[</span><span class="op" id="3568855">]</span><span class="builtintype" id="3568856">byte</span>&nbsp;<span class="comment" id="3568861">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3568883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3568886">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3568934">var</span>&nbsp;<span class="ident" id="3568938">extraHeaderKeys</span>&nbsp;<span class="op" id="3568954">=</span>&nbsp;<span class="op" id="3568956">[</span><span class="op" id="3568957">]</span><span class="op" id="3568958">[</span><span class="op" id="3568959">]</span><span class="builtintype" id="3568960">byte</span><span class="op" id="3568964">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568967">[</span><span class="op" id="3568968">]</span><span class="builtintype" id="3568969">byte</span><span class="op" id="3568973">(</span><span class="string" id="3568974">&#34;Content-Type&#34;</span><span class="op" id="3568988">)</span><span class="op" id="3568989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3568992">[</span><span class="op" id="3568993">]</span><span class="builtintype" id="3568994">byte</span><span class="op" id="3568998">(</span><span class="string" id="3568999">&#34;Connection&#34;</span><span class="op" id="3569011">)</span><span class="op" id="3569012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3569015">[</span><span class="op" id="3569016">]</span><span class="builtintype" id="3569017">byte</span><span class="op" id="3569021">(</span><span class="string" id="3569022">&#34;Transfer-Encoding&#34;</span><span class="op" id="3569041">)</span><span class="op" id="3569042">,</span><br>
<span class="lineno"></span><span class="op" id="3569044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3569047">var</span>&nbsp;<span class="op" id="3569051">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569054">headerContentLength</span>&nbsp;<span class="op" id="3569074">=</span>&nbsp;<span class="op" id="3569076">[</span><span class="op" id="3569077">]</span><span class="builtintype" id="3569078">byte</span><span class="op" id="3569082">(</span><span class="string" id="3569083">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3569101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569104">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3569124">=</span>&nbsp;<span class="op" id="3569126">[</span><span class="op" id="3569127">]</span><span class="builtintype" id="3569128">byte</span><span class="op" id="3569132">(</span><span class="string" id="3569133">&#34;Date:&nbsp;&#34;</span><span class="op" id="3569141">)</span><br>
<span class="lineno"></span><span class="op" id="3569143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3569146">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3569195">//</span><br>
<span class="lineno"></span><span class="comment" id="3569198">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3569267">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3569337">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3569396">func</span>&nbsp;<span class="op" id="3569401">(</span><span class="ident" id="3569402">h</span>&nbsp;<span class="ident" id="3569404">extraHeader</span><span class="op" id="3569415">)</span>&nbsp;<span class="ident" id="3569417">Write</span><span class="op" id="3569422">(</span><span class="ident" id="3569423">w</span>&nbsp;<span class="op" id="3569425">*</span><span class="ident" id="3569426">bufio</span><span class="op" id="3569431">.</span><span class="ident" id="3569432">Writer</span><span class="op" id="3569438">)</span>&nbsp;<span class="op" id="3569440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3569443">if</span>&nbsp;<span class="ident" id="3569446">h</span><span class="op" id="3569447">.</span><span class="ident" id="3569448">date</span>&nbsp;<span class="op" id="3569453">!=</span>&nbsp;<span class="builtintype" id="3569456">nil</span>&nbsp;<span class="op" id="3569460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569464">w</span><span class="op" id="3569465">.</span><span class="ident" id="3569466">Write</span><span class="op" id="3569471">(</span><span class="ident" id="3569472">headerDate</span><span class="op" id="3569482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569486">w</span><span class="op" id="3569487">.</span><span class="ident" id="3569488">Write</span><span class="op" id="3569493">(</span><span class="ident" id="3569494">h</span><span class="op" id="3569495">.</span><span class="ident" id="3569496">date</span><span class="op" id="3569500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569504">w</span><span class="op" id="3569505">.</span><span class="ident" id="3569506">Write</span><span class="op" id="3569511">(</span><span class="ident" id="3569512">crlf</span><span class="op" id="3569516">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3569519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3569522">if</span>&nbsp;<span class="ident" id="3569525">h</span><span class="op" id="3569526">.</span><span class="ident" id="3569527">contentLength</span>&nbsp;<span class="op" id="3569541">!=</span>&nbsp;<span class="builtintype" id="3569544">nil</span>&nbsp;<span class="op" id="3569548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569552">w</span><span class="op" id="3569553">.</span><span class="ident" id="3569554">Write</span><span class="op" id="3569559">(</span><span class="ident" id="3569560">headerContentLength</span><span class="op" id="3569579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569583">w</span><span class="op" id="3569584">.</span><span class="ident" id="3569585">Write</span><span class="op" id="3569590">(</span><span class="ident" id="3569591">h</span><span class="op" id="3569592">.</span><span class="ident" id="3569593">contentLength</span><span class="op" id="3569606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569610">w</span><span class="op" id="3569611">.</span><span class="ident" id="3569612">Write</span><span class="op" id="3569617">(</span><span class="ident" id="3569618">crlf</span><span class="op" id="3569622">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3569625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3569628">for</span>&nbsp;<span class="ident" id="3569632">i</span><span class="op" id="3569633">,</span>&nbsp;<span class="ident" id="3569635">v</span>&nbsp;<span class="op" id="3569637">:=</span>&nbsp;<span class="keyword" id="3569640">range</span>&nbsp;<span class="op" id="3569646">[</span><span class="op" id="3569647">]</span><span class="builtintype" id="3569648">string</span><span class="op" id="3569654">{</span><span class="ident" id="3569655">h</span><span class="op" id="3569656">.</span><span class="ident" id="3569657">contentType</span><span class="op" id="3569668">,</span>&nbsp;<span class="ident" id="3569670">h</span><span class="op" id="3569671">.</span><span class="ident" id="3569672">connection</span><span class="op" id="3569682">,</span>&nbsp;<span class="ident" id="3569684">h</span><span class="op" id="3569685">.</span><span class="ident" id="3569686">transferEncoding</span><span class="op" id="3569702">}</span>&nbsp;<span class="op" id="3569704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3569708">if</span>&nbsp;<span class="ident" id="3569711">v</span>&nbsp;<span class="op" id="3569713">!=</span>&nbsp;<span class="string" id="3569716">&#34;&#34;</span>&nbsp;<span class="op" id="3569719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569724">w</span><span class="op" id="3569725">.</span><span class="ident" id="3569726">Write</span><span class="op" id="3569731">(</span><span class="ident" id="3569732">extraHeaderKeys</span><span class="op" id="3569747">[</span><span class="ident" id="3569748">i</span><span class="op" id="3569749">]</span><span class="op" id="3569750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569755">w</span><span class="op" id="3569756">.</span><span class="ident" id="3569757">Write</span><span class="op" id="3569762">(</span><span class="ident" id="3569763">colonSpace</span><span class="op" id="3569773">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569778">w</span><span class="op" id="3569779">.</span><span class="ident" id="3569780">WriteString</span><span class="op" id="3569791">(</span><span class="ident" id="3569792">v</span><span class="op" id="3569793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3569798">w</span><span class="op" id="3569799">.</span><span class="ident" id="3569800">Write</span><span class="op" id="3569805">(</span><span class="ident" id="3569806">crlf</span><span class="op" id="3569810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3569814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3569817">}</span><br>
<span class="lineno"></span><span class="op" id="3569819">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3569822">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3569891">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3569914">//</span><br>
<span class="lineno"></span><span class="comment" id="3569917">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3569988">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3570058">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3570127">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3570193">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3570205">func</span>&nbsp;<span class="op" id="3570210">(</span><span class="ident" id="3570211">cw</span>&nbsp;<span class="op" id="3570214">*</span><span class="ident" id="3570215">chunkWriter</span><span class="op" id="3570226">)</span>&nbsp;<span class="ident" id="3570228">writeHeader</span><span class="op" id="3570239">(</span><span class="ident" id="3570240">p</span>&nbsp;<span class="op" id="3570242">[</span><span class="op" id="3570243">]</span><span class="builtintype" id="3570244">byte</span><span class="op" id="3570248">)</span>&nbsp;<span class="op" id="3570250">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570253">if</span>&nbsp;<span class="ident" id="3570256">cw</span><span class="op" id="3570258">.</span><span class="ident" id="3570259">wroteHeader</span>&nbsp;<span class="op" id="3570271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570275">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3570283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570286">cw</span><span class="op" id="3570288">.</span><span class="ident" id="3570289">wroteHeader</span>&nbsp;<span class="op" id="3570301">=</span>&nbsp;<span class="builtintype" id="3570303">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570310">w</span>&nbsp;<span class="op" id="3570312">:=</span>&nbsp;<span class="ident" id="3570315">cw</span><span class="op" id="3570317">.</span><span class="ident" id="3570318">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570323">keepAlivesEnabled</span>&nbsp;<span class="op" id="3570341">:=</span>&nbsp;<span class="ident" id="3570344">w</span><span class="op" id="3570345">.</span><span class="ident" id="3570346">conn</span><span class="op" id="3570350">.</span><span class="ident" id="3570351">server</span><span class="op" id="3570357">.</span><span class="ident" id="3570358">doKeepAlives</span><span class="op" id="3570370">(</span><span class="op" id="3570371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570374">isHEAD</span>&nbsp;<span class="op" id="3570381">:=</span>&nbsp;<span class="ident" id="3570384">w</span><span class="op" id="3570385">.</span><span class="ident" id="3570386">req</span><span class="op" id="3570389">.</span><span class="ident" id="3570390">Method</span>&nbsp;<span class="op" id="3570397">==</span>&nbsp;<span class="string" id="3570400">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3570409">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3570473">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3570535">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3570591">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3570653">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570681">header</span>&nbsp;<span class="op" id="3570688">:=</span>&nbsp;<span class="ident" id="3570691">cw</span><span class="op" id="3570693">.</span><span class="ident" id="3570694">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570702">owned</span>&nbsp;<span class="op" id="3570708">:=</span>&nbsp;<span class="ident" id="3570711">header</span>&nbsp;<span class="op" id="3570718">!=</span>&nbsp;<span class="builtintype" id="3570721">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570726">if</span>&nbsp;<span class="op" id="3570729">!</span><span class="ident" id="3570730">owned</span>&nbsp;<span class="op" id="3570736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570740">header</span>&nbsp;<span class="op" id="3570747">=</span>&nbsp;<span class="ident" id="3570749">w</span><span class="op" id="3570750">.</span><span class="ident" id="3570751">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3570766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570769">var</span>&nbsp;<span class="ident" id="3570773">excludeHeader</span>&nbsp;<span class="keyword" id="3570787">map</span><span class="op" id="3570790">[</span><span class="builtintype" id="3570791">string</span><span class="op" id="3570797">]</span><span class="builtintype" id="3570798">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570804">delHeader</span>&nbsp;<span class="op" id="3570814">:=</span>&nbsp;<span class="keyword" id="3570817">func</span><span class="op" id="3570821">(</span><span class="ident" id="3570822">key</span>&nbsp;<span class="builtintype" id="3570826">string</span><span class="op" id="3570832">)</span>&nbsp;<span class="op" id="3570834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570838">if</span>&nbsp;<span class="ident" id="3570841">owned</span>&nbsp;<span class="op" id="3570847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570852">header</span><span class="op" id="3570858">.</span><span class="ident" id="3570859">Del</span><span class="op" id="3570862">(</span><span class="ident" id="3570863">key</span><span class="op" id="3570866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570871">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3570880">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570884">if</span>&nbsp;<span class="ident" id="3570887">_</span><span class="op" id="3570888">,</span>&nbsp;<span class="ident" id="3570890">ok</span>&nbsp;<span class="op" id="3570893">:=</span>&nbsp;<span class="ident" id="3570896">header</span><span class="op" id="3570902">[</span><span class="ident" id="3570903">key</span><span class="op" id="3570906">]</span><span class="op" id="3570907">;</span>&nbsp;<span class="op" id="3570909">!</span><span class="ident" id="3570910">ok</span>&nbsp;<span class="op" id="3570913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570918">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3570927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3570931">if</span>&nbsp;<span class="ident" id="3570934">excludeHeader</span>&nbsp;<span class="op" id="3570948">==</span>&nbsp;<span class="builtintype" id="3570951">nil</span>&nbsp;<span class="op" id="3570955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3570960">excludeHeader</span>&nbsp;<span class="op" id="3570974">=</span>&nbsp;<span class="builtinfunc" id="3570976">make</span><span class="op" id="3570980">(</span><span class="keyword" id="3570981">map</span><span class="op" id="3570984">[</span><span class="builtintype" id="3570985">string</span><span class="op" id="3570991">]</span><span class="builtintype" id="3570992">bool</span><span class="op" id="3570996">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3571000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3571004">excludeHeader</span><span class="op" id="3571017">[</span><span class="ident" id="3571018">key</span><span class="op" id="3571021">]</span>&nbsp;<span class="op" id="3571023">=</span>&nbsp;<span class="builtintype" id="3571025">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3571031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3571034">var</span>&nbsp;<span class="ident" id="3571038">setHeader</span>&nbsp;<span class="ident" id="3571048">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571062">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571121">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571185">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571246">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571282">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571353">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571417">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571479">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571543">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571607">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571667">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3571729">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3571763">if</span>&nbsp;<span class="ident" id="3571766">w</span><span class="op" id="3571767">.</span><span class="ident" id="3571768">handlerDone</span>&nbsp;<span class="op" id="3571780">&amp;&amp;</span>&nbsp;<span class="ident" id="3571783">bodyAllowedForStatus</span><span class="op" id="3571803">(</span><span class="ident" id="3571804">w</span><span class="op" id="3571805">.</span><span class="ident" id="3571806">status</span><span class="op" id="3571812">)</span>&nbsp;<span class="op" id="3571814">&amp;&amp;</span>&nbsp;<span class="ident" id="3571817">header</span><span class="op" id="3571823">.</span><span class="ident" id="3571824">get</span><span class="op" id="3571827">(</span><span class="string" id="3571828">&#34;Content-Length&#34;</span><span class="op" id="3571844">)</span>&nbsp;<span class="op" id="3571846">==</span>&nbsp;<span class="string" id="3571849">&#34;&#34;</span>&nbsp;<span class="op" id="3571852">&amp;&amp;</span>&nbsp;<span class="op" id="3571855">(</span><span class="op" id="3571856">!</span><span class="ident" id="3571857">isHEAD</span>&nbsp;<span class="op" id="3571864">||</span>&nbsp;<span class="builtinfunc" id="3571867">len</span><span class="op" id="3571870">(</span><span class="ident" id="3571871">p</span><span class="op" id="3571872">)</span>&nbsp;<span class="op" id="3571874">&gt;</span>&nbsp;<span class="num" id="3571876">0</span><span class="op" id="3571877">)</span>&nbsp;<span class="op" id="3571879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3571883">w</span><span class="op" id="3571884">.</span><span class="ident" id="3571885">contentLength</span>&nbsp;<span class="op" id="3571899">=</span>&nbsp;<span class="builtintype" id="3571901">int64</span><span class="op" id="3571906">(</span><span class="builtinfunc" id="3571907">len</span><span class="op" id="3571910">(</span><span class="ident" id="3571911">p</span><span class="op" id="3571912">)</span><span class="op" id="3571913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3571917">setHeader</span><span class="op" id="3571926">.</span><span class="ident" id="3571927">contentLength</span>&nbsp;<span class="op" id="3571941">=</span>&nbsp;<span class="ident" id="3571943">strconv</span><span class="op" id="3571950">.</span><span class="ident" id="3571951">AppendInt</span><span class="op" id="3571960">(</span><span class="ident" id="3571961">cw</span><span class="op" id="3571963">.</span><span class="ident" id="3571964">res</span><span class="op" id="3571967">.</span><span class="ident" id="3571968">clenBuf</span><span class="op" id="3571975">[</span><span class="op" id="3571976">:</span><span class="num" id="3571977">0</span><span class="op" id="3571978">]</span><span class="op" id="3571979">,</span>&nbsp;<span class="builtintype" id="3571981">int64</span><span class="op" id="3571986">(</span><span class="builtinfunc" id="3571987">len</span><span class="op" id="3571990">(</span><span class="ident" id="3571991">p</span><span class="op" id="3571992">)</span><span class="op" id="3571993">)</span><span class="op" id="3571994">,</span>&nbsp;<span class="num" id="3571996">10</span><span class="op" id="3571998">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572005">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572071">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3572139">if</span>&nbsp;<span class="ident" id="3572142">w</span><span class="op" id="3572143">.</span><span class="ident" id="3572144">req</span><span class="op" id="3572147">.</span><span class="ident" id="3572148">wantsHttp10KeepAlive</span><span class="op" id="3572168">(</span><span class="op" id="3572169">)</span>&nbsp;<span class="op" id="3572171">&amp;&amp;</span>&nbsp;<span class="ident" id="3572174">keepAlivesEnabled</span>&nbsp;<span class="op" id="3572192">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572196">sentLength</span>&nbsp;<span class="op" id="3572207">:=</span>&nbsp;<span class="ident" id="3572210">header</span><span class="op" id="3572216">.</span><span class="ident" id="3572217">get</span><span class="op" id="3572220">(</span><span class="string" id="3572221">&#34;Content-Length&#34;</span><span class="op" id="3572237">)</span>&nbsp;<span class="op" id="3572239">!=</span>&nbsp;<span class="string" id="3572242">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3572247">if</span>&nbsp;<span class="ident" id="3572250">sentLength</span>&nbsp;<span class="op" id="3572261">&amp;&amp;</span>&nbsp;<span class="ident" id="3572264">header</span><span class="op" id="3572270">.</span><span class="ident" id="3572271">get</span><span class="op" id="3572274">(</span><span class="string" id="3572275">&#34;Connection&#34;</span><span class="op" id="3572287">)</span>&nbsp;<span class="op" id="3572289">==</span>&nbsp;<span class="string" id="3572292">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3572305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572310">w</span><span class="op" id="3572311">.</span><span class="ident" id="3572312">closeAfterReply</span>&nbsp;<span class="op" id="3572328">=</span>&nbsp;<span class="builtintype" id="3572330">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572341">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572345">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572405">hasCL</span>&nbsp;<span class="op" id="3572411">:=</span>&nbsp;<span class="ident" id="3572414">w</span><span class="op" id="3572415">.</span><span class="ident" id="3572416">contentLength</span>&nbsp;<span class="op" id="3572430">!=</span>&nbsp;<span class="op" id="3572433">-</span><span class="num" id="3572434">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3572438">if</span>&nbsp;<span class="ident" id="3572441">w</span><span class="op" id="3572442">.</span><span class="ident" id="3572443">req</span><span class="op" id="3572446">.</span><span class="ident" id="3572447">wantsHttp10KeepAlive</span><span class="op" id="3572467">(</span><span class="op" id="3572468">)</span>&nbsp;<span class="op" id="3572470">&amp;&amp;</span>&nbsp;<span class="op" id="3572473">(</span><span class="ident" id="3572474">isHEAD</span>&nbsp;<span class="op" id="3572481">||</span>&nbsp;<span class="ident" id="3572484">hasCL</span><span class="op" id="3572489">)</span>&nbsp;<span class="op" id="3572491">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572495">_</span><span class="op" id="3572496">,</span>&nbsp;<span class="ident" id="3572498">connectionHeaderSet</span>&nbsp;<span class="op" id="3572518">:=</span>&nbsp;<span class="ident" id="3572521">header</span><span class="op" id="3572527">[</span><span class="string" id="3572528">&#34;Connection&#34;</span><span class="op" id="3572540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3572544">if</span>&nbsp;<span class="op" id="3572547">!</span><span class="ident" id="3572548">connectionHeaderSet</span>&nbsp;<span class="op" id="3572568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572573">setHeader</span><span class="op" id="3572582">.</span><span class="ident" id="3572583">connection</span>&nbsp;<span class="op" id="3572594">=</span>&nbsp;<span class="string" id="3572596">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572614">}</span>&nbsp;<span class="keyword" id="3572616">else</span>&nbsp;<span class="keyword" id="3572621">if</span>&nbsp;<span class="op" id="3572624">!</span><span class="ident" id="3572625">w</span><span class="op" id="3572626">.</span><span class="ident" id="3572627">req</span><span class="op" id="3572630">.</span><span class="ident" id="3572631">ProtoAtLeast</span><span class="op" id="3572643">(</span><span class="num" id="3572644">1</span><span class="op" id="3572645">,</span>&nbsp;<span class="num" id="3572647">1</span><span class="op" id="3572648">)</span>&nbsp;<span class="op" id="3572650">||</span>&nbsp;<span class="ident" id="3572653">w</span><span class="op" id="3572654">.</span><span class="ident" id="3572655">req</span><span class="op" id="3572658">.</span><span class="ident" id="3572659">wantsClose</span><span class="op" id="3572669">(</span><span class="op" id="3572670">)</span>&nbsp;<span class="op" id="3572672">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572676">w</span><span class="op" id="3572677">.</span><span class="ident" id="3572678">closeAfterReply</span>&nbsp;<span class="op" id="3572694">=</span>&nbsp;<span class="builtintype" id="3572696">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3572706">if</span>&nbsp;<span class="ident" id="3572709">header</span><span class="op" id="3572715">.</span><span class="ident" id="3572716">get</span><span class="op" id="3572719">(</span><span class="string" id="3572720">&#34;Connection&#34;</span><span class="op" id="3572732">)</span>&nbsp;<span class="op" id="3572734">==</span>&nbsp;<span class="string" id="3572737">&#34;close&#34;</span>&nbsp;<span class="op" id="3572745">||</span>&nbsp;<span class="op" id="3572748">!</span><span class="ident" id="3572749">keepAlivesEnabled</span>&nbsp;<span class="op" id="3572767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3572771">w</span><span class="op" id="3572772">.</span><span class="ident" id="3572773">closeAfterReply</span>&nbsp;<span class="op" id="3572789">=</span>&nbsp;<span class="builtintype" id="3572791">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572801">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572861">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572922">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3572983">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573034">if</span>&nbsp;<span class="ident" id="3573037">w</span><span class="op" id="3573038">.</span><span class="ident" id="3573039">req</span><span class="op" id="3573042">.</span><span class="ident" id="3573043">ContentLength</span>&nbsp;<span class="op" id="3573057">!=</span>&nbsp;<span class="num" id="3573060">0</span>&nbsp;<span class="op" id="3573062">&amp;&amp;</span>&nbsp;<span class="op" id="3573065">!</span><span class="ident" id="3573066">w</span><span class="op" id="3573067">.</span><span class="ident" id="3573068">closeAfterReply</span>&nbsp;<span class="op" id="3573084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573088">ecr</span><span class="op" id="3573091">,</span>&nbsp;<span class="ident" id="3573093">isExpecter</span>&nbsp;<span class="op" id="3573104">:=</span>&nbsp;<span class="ident" id="3573107">w</span><span class="op" id="3573108">.</span><span class="ident" id="3573109">req</span><span class="op" id="3573112">.</span><span class="ident" id="3573113">Body</span><span class="op" id="3573117">.</span><span class="op" id="3573118">(</span><span class="op" id="3573119">*</span><span class="ident" id="3573120">expectContinueReader</span><span class="op" id="3573140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573144">if</span>&nbsp;<span class="op" id="3573147">!</span><span class="ident" id="3573148">isExpecter</span>&nbsp;<span class="op" id="3573159">||</span>&nbsp;<span class="ident" id="3573162">ecr</span><span class="op" id="3573165">.</span><span class="ident" id="3573166">resp</span><span class="op" id="3573170">.</span><span class="ident" id="3573171">wroteContinue</span>&nbsp;<span class="op" id="3573185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573190">n</span><span class="op" id="3573191">,</span>&nbsp;<span class="ident" id="3573193">_</span>&nbsp;<span class="op" id="3573195">:=</span>&nbsp;<span class="ident" id="3573198">io</span><span class="op" id="3573200">.</span><span class="ident" id="3573201">CopyN</span><span class="op" id="3573206">(</span><span class="ident" id="3573207">ioutil</span><span class="op" id="3573213">.</span><span class="ident" id="3573214">Discard</span><span class="op" id="3573221">,</span>&nbsp;<span class="ident" id="3573223">w</span><span class="op" id="3573224">.</span><span class="ident" id="3573225">req</span><span class="op" id="3573228">.</span><span class="ident" id="3573229">Body</span><span class="op" id="3573233">,</span>&nbsp;<span class="ident" id="3573235">maxPostHandlerReadBytes</span><span class="op" id="3573258">+</span><span class="num" id="3573259">1</span><span class="op" id="3573260">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573265">if</span>&nbsp;<span class="ident" id="3573268">n</span>&nbsp;<span class="op" id="3573270">&gt;=</span>&nbsp;<span class="ident" id="3573273">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3573297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573303">w</span><span class="op" id="3573304">.</span><span class="ident" id="3573305">requestTooLarge</span><span class="op" id="3573320">(</span><span class="op" id="3573321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573327">delHeader</span><span class="op" id="3573336">(</span><span class="string" id="3573337">&#34;Connection&#34;</span><span class="op" id="3573349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573355">setHeader</span><span class="op" id="3573364">.</span><span class="ident" id="3573365">connection</span>&nbsp;<span class="op" id="3573376">=</span>&nbsp;<span class="string" id="3573378">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573389">}</span>&nbsp;<span class="keyword" id="3573391">else</span>&nbsp;<span class="op" id="3573396">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573402">w</span><span class="op" id="3573403">.</span><span class="ident" id="3573404">req</span><span class="op" id="3573407">.</span><span class="ident" id="3573408">Body</span><span class="op" id="3573412">.</span><span class="ident" id="3573413">Close</span><span class="op" id="3573418">(</span><span class="op" id="3573419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573435">code</span>&nbsp;<span class="op" id="3573440">:=</span>&nbsp;<span class="ident" id="3573443">w</span><span class="op" id="3573444">.</span><span class="ident" id="3573445">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573453">if</span>&nbsp;<span class="ident" id="3573456">bodyAllowedForStatus</span><span class="op" id="3573476">(</span><span class="ident" id="3573477">code</span><span class="op" id="3573481">)</span>&nbsp;<span class="op" id="3573483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3573487">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573546">_</span><span class="op" id="3573547">,</span>&nbsp;<span class="ident" id="3573549">haveType</span>&nbsp;<span class="op" id="3573558">:=</span>&nbsp;<span class="ident" id="3573561">header</span><span class="op" id="3573567">[</span><span class="string" id="3573568">&#34;Content-Type&#34;</span><span class="op" id="3573582">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573586">if</span>&nbsp;<span class="op" id="3573589">!</span><span class="ident" id="3573590">haveType</span>&nbsp;<span class="op" id="3573599">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573604">setHeader</span><span class="op" id="3573613">.</span><span class="ident" id="3573614">contentType</span>&nbsp;<span class="op" id="3573626">=</span>&nbsp;<span class="ident" id="3573628">DetectContentType</span><span class="op" id="3573645">(</span><span class="ident" id="3573646">p</span><span class="op" id="3573647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573654">}</span>&nbsp;<span class="keyword" id="3573656">else</span>&nbsp;<span class="op" id="3573661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573665">for</span>&nbsp;<span class="ident" id="3573669">_</span><span class="op" id="3573670">,</span>&nbsp;<span class="ident" id="3573672">k</span>&nbsp;<span class="op" id="3573674">:=</span>&nbsp;<span class="keyword" id="3573677">range</span>&nbsp;<span class="ident" id="3573683">suppressedHeaders</span><span class="op" id="3573700">(</span><span class="ident" id="3573701">code</span><span class="op" id="3573705">)</span>&nbsp;<span class="op" id="3573707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573712">delHeader</span><span class="op" id="3573721">(</span><span class="ident" id="3573722">k</span><span class="op" id="3573723">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573734">if</span>&nbsp;<span class="ident" id="3573737">_</span><span class="op" id="3573738">,</span>&nbsp;<span class="ident" id="3573740">ok</span>&nbsp;<span class="op" id="3573743">:=</span>&nbsp;<span class="ident" id="3573746">header</span><span class="op" id="3573752">[</span><span class="string" id="3573753">&#34;Date&#34;</span><span class="op" id="3573759">]</span><span class="op" id="3573760">;</span>&nbsp;<span class="op" id="3573762">!</span><span class="ident" id="3573763">ok</span>&nbsp;<span class="op" id="3573766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573770">setHeader</span><span class="op" id="3573779">.</span><span class="ident" id="3573780">date</span>&nbsp;<span class="op" id="3573785">=</span>&nbsp;<span class="ident" id="3573787">appendTime</span><span class="op" id="3573797">(</span><span class="ident" id="3573798">cw</span><span class="op" id="3573800">.</span><span class="ident" id="3573801">res</span><span class="op" id="3573804">.</span><span class="ident" id="3573805">dateBuf</span><span class="op" id="3573812">[</span><span class="op" id="3573813">:</span><span class="num" id="3573814">0</span><span class="op" id="3573815">]</span><span class="op" id="3573816">,</span>&nbsp;<span class="ident" id="3573818">time</span><span class="op" id="3573822">.</span><span class="ident" id="3573823">Now</span><span class="op" id="3573826">(</span><span class="op" id="3573827">)</span><span class="op" id="3573828">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3573831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573835">te</span>&nbsp;<span class="op" id="3573838">:=</span>&nbsp;<span class="ident" id="3573841">header</span><span class="op" id="3573847">.</span><span class="ident" id="3573848">get</span><span class="op" id="3573851">(</span><span class="string" id="3573852">&#34;Transfer-Encoding&#34;</span><span class="op" id="3573871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3573874">hasTE</span>&nbsp;<span class="op" id="3573880">:=</span>&nbsp;<span class="ident" id="3573883">te</span>&nbsp;<span class="op" id="3573886">!=</span>&nbsp;<span class="string" id="3573889">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3573893">if</span>&nbsp;<span class="ident" id="3573896">hasCL</span>&nbsp;<span class="op" id="3573902">&amp;&amp;</span>&nbsp;<span class="ident" id="3573905">hasTE</span>&nbsp;<span class="op" id="3573911">&amp;&amp;</span>&nbsp;<span class="ident" id="3573914">te</span>&nbsp;<span class="op" id="3573917">!=</span>&nbsp;<span class="string" id="3573920">&#34;identity&#34;</span>&nbsp;<span class="op" id="3573931">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3573935">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574001">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574046">w</span><span class="op" id="3574047">.</span><span class="ident" id="3574048">conn</span><span class="op" id="3574052">.</span><span class="ident" id="3574053">server</span><span class="op" id="3574059">.</span><span class="ident" id="3574060">logf</span><span class="op" id="3574064">(</span><span class="string" id="3574065">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3574152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574157">te</span><span class="op" id="3574159">,</span>&nbsp;<span class="ident" id="3574161">w</span><span class="op" id="3574162">.</span><span class="ident" id="3574163">contentLength</span><span class="op" id="3574176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574180">delHeader</span><span class="op" id="3574189">(</span><span class="string" id="3574190">&#34;Content-Length&#34;</span><span class="op" id="3574206">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574210">hasCL</span>&nbsp;<span class="op" id="3574216">=</span>&nbsp;<span class="builtintype" id="3574218">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3574225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3574229">if</span>&nbsp;<span class="ident" id="3574232">w</span><span class="op" id="3574233">.</span><span class="ident" id="3574234">req</span><span class="op" id="3574237">.</span><span class="ident" id="3574238">Method</span>&nbsp;<span class="op" id="3574245">==</span>&nbsp;<span class="string" id="3574248">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3574255">||</span>&nbsp;<span class="op" id="3574258">!</span><span class="ident" id="3574259">bodyAllowedForStatus</span><span class="op" id="3574279">(</span><span class="ident" id="3574280">code</span><span class="op" id="3574284">)</span>&nbsp;<span class="op" id="3574286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574290">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3574305">}</span>&nbsp;<span class="keyword" id="3574307">else</span>&nbsp;<span class="keyword" id="3574312">if</span>&nbsp;<span class="ident" id="3574315">code</span>&nbsp;<span class="op" id="3574320">==</span>&nbsp;<span class="ident" id="3574323">StatusNoContent</span>&nbsp;<span class="op" id="3574339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574343">delHeader</span><span class="op" id="3574352">(</span><span class="string" id="3574353">&#34;Transfer-Encoding&#34;</span><span class="op" id="3574372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3574375">}</span>&nbsp;<span class="keyword" id="3574377">else</span>&nbsp;<span class="keyword" id="3574382">if</span>&nbsp;<span class="ident" id="3574385">hasCL</span>&nbsp;<span class="op" id="3574391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574395">delHeader</span><span class="op" id="3574404">(</span><span class="string" id="3574405">&#34;Transfer-Encoding&#34;</span><span class="op" id="3574424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3574427">}</span>&nbsp;<span class="keyword" id="3574429">else</span>&nbsp;<span class="keyword" id="3574434">if</span>&nbsp;<span class="ident" id="3574437">w</span><span class="op" id="3574438">.</span><span class="ident" id="3574439">req</span><span class="op" id="3574442">.</span><span class="ident" id="3574443">ProtoAtLeast</span><span class="op" id="3574455">(</span><span class="num" id="3574456">1</span><span class="op" id="3574457">,</span>&nbsp;<span class="num" id="3574459">1</span><span class="op" id="3574460">)</span>&nbsp;<span class="op" id="3574462">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574466">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574544">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574623">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574695">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574767">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3574783">if</span>&nbsp;<span class="ident" id="3574786">hasTE</span>&nbsp;<span class="op" id="3574792">&amp;&amp;</span>&nbsp;<span class="ident" id="3574795">te</span>&nbsp;<span class="op" id="3574798">==</span>&nbsp;<span class="string" id="3574801">&#34;identity&#34;</span>&nbsp;<span class="op" id="3574812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574817">cw</span><span class="op" id="3574819">.</span><span class="ident" id="3574820">chunking</span>&nbsp;<span class="op" id="3574829">=</span>&nbsp;<span class="builtintype" id="3574831">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574840">w</span><span class="op" id="3574841">.</span><span class="ident" id="3574842">closeAfterReply</span>&nbsp;<span class="op" id="3574858">=</span>&nbsp;<span class="builtintype" id="3574860">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3574867">}</span>&nbsp;<span class="keyword" id="3574869">else</span>&nbsp;<span class="op" id="3574874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574879">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3574936">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3574982">cw</span><span class="op" id="3574984">.</span><span class="ident" id="3574985">chunking</span>&nbsp;<span class="op" id="3574994">=</span>&nbsp;<span class="builtintype" id="3574996">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575004">setHeader</span><span class="op" id="3575013">.</span><span class="ident" id="3575014">transferEncoding</span>&nbsp;<span class="op" id="3575031">=</span>&nbsp;<span class="string" id="3575033">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575048">}</span>&nbsp;<span class="keyword" id="3575050">else</span>&nbsp;<span class="op" id="3575055">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575059">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575111">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575165">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575204">w</span><span class="op" id="3575205">.</span><span class="ident" id="3575206">closeAfterReply</span>&nbsp;<span class="op" id="3575222">=</span>&nbsp;<span class="builtintype" id="3575224">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575231">delHeader</span><span class="op" id="3575240">(</span><span class="string" id="3575241">&#34;Transfer-Encoding&#34;</span><span class="op" id="3575260">)</span>&nbsp;<span class="comment" id="3575262">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575290">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3575357">if</span>&nbsp;<span class="ident" id="3575360">cw</span><span class="op" id="3575362">.</span><span class="ident" id="3575363">chunking</span>&nbsp;<span class="op" id="3575372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575376">delHeader</span><span class="op" id="3575385">(</span><span class="string" id="3575386">&#34;Content-Length&#34;</span><span class="op" id="3575402">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3575408">if</span>&nbsp;<span class="op" id="3575411">!</span><span class="ident" id="3575412">w</span><span class="op" id="3575413">.</span><span class="ident" id="3575414">req</span><span class="op" id="3575417">.</span><span class="ident" id="3575418">ProtoAtLeast</span><span class="op" id="3575430">(</span><span class="num" id="3575431">1</span><span class="op" id="3575432">,</span>&nbsp;<span class="num" id="3575434">0</span><span class="op" id="3575435">)</span>&nbsp;<span class="op" id="3575437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3575441">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3575453">if</span>&nbsp;<span class="ident" id="3575456">w</span><span class="op" id="3575457">.</span><span class="ident" id="3575458">closeAfterReply</span>&nbsp;<span class="op" id="3575474">&amp;&amp;</span>&nbsp;<span class="op" id="3575477">(</span><span class="op" id="3575478">!</span><span class="ident" id="3575479">keepAlivesEnabled</span>&nbsp;<span class="op" id="3575497">||</span>&nbsp;<span class="op" id="3575500">!</span><span class="ident" id="3575501">hasToken</span><span class="op" id="3575509">(</span><span class="ident" id="3575510">cw</span><span class="op" id="3575512">.</span><span class="ident" id="3575513">header</span><span class="op" id="3575519">.</span><span class="ident" id="3575520">get</span><span class="op" id="3575523">(</span><span class="string" id="3575524">&#34;Connection&#34;</span><span class="op" id="3575536">)</span><span class="op" id="3575537">,</span>&nbsp;<span class="string" id="3575539">&#34;close&#34;</span><span class="op" id="3575546">)</span><span class="op" id="3575547">)</span>&nbsp;<span class="op" id="3575549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575553">delHeader</span><span class="op" id="3575562">(</span><span class="string" id="3575563">&#34;Connection&#34;</span><span class="op" id="3575575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3575579">if</span>&nbsp;<span class="ident" id="3575582">w</span><span class="op" id="3575583">.</span><span class="ident" id="3575584">req</span><span class="op" id="3575587">.</span><span class="ident" id="3575588">ProtoAtLeast</span><span class="op" id="3575600">(</span><span class="num" id="3575601">1</span><span class="op" id="3575602">,</span>&nbsp;<span class="num" id="3575604">1</span><span class="op" id="3575605">)</span>&nbsp;<span class="op" id="3575607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575612">setHeader</span><span class="op" id="3575621">.</span><span class="ident" id="3575622">connection</span>&nbsp;<span class="op" id="3575633">=</span>&nbsp;<span class="string" id="3575635">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575645">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575652">w</span><span class="op" id="3575653">.</span><span class="ident" id="3575654">conn</span><span class="op" id="3575658">.</span><span class="ident" id="3575659">buf</span><span class="op" id="3575662">.</span><span class="ident" id="3575663">WriteString</span><span class="op" id="3575674">(</span><span class="ident" id="3575675">statusLine</span><span class="op" id="3575685">(</span><span class="ident" id="3575686">w</span><span class="op" id="3575687">.</span><span class="ident" id="3575688">req</span><span class="op" id="3575691">,</span>&nbsp;<span class="ident" id="3575693">code</span><span class="op" id="3575697">)</span><span class="op" id="3575698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575701">cw</span><span class="op" id="3575703">.</span><span class="ident" id="3575704">header</span><span class="op" id="3575710">.</span><span class="ident" id="3575711">WriteSubset</span><span class="op" id="3575722">(</span><span class="ident" id="3575723">w</span><span class="op" id="3575724">.</span><span class="ident" id="3575725">conn</span><span class="op" id="3575729">.</span><span class="ident" id="3575730">buf</span><span class="op" id="3575733">,</span>&nbsp;<span class="ident" id="3575735">excludeHeader</span><span class="op" id="3575748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575751">setHeader</span><span class="op" id="3575760">.</span><span class="ident" id="3575761">Write</span><span class="op" id="3575766">(</span><span class="ident" id="3575767">w</span><span class="op" id="3575768">.</span><span class="ident" id="3575769">conn</span><span class="op" id="3575773">.</span><span class="ident" id="3575774">buf</span><span class="op" id="3575777">.</span><span class="ident" id="3575778">Writer</span><span class="op" id="3575784">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575787">w</span><span class="op" id="3575788">.</span><span class="ident" id="3575789">conn</span><span class="op" id="3575793">.</span><span class="ident" id="3575794">buf</span><span class="op" id="3575797">.</span><span class="ident" id="3575798">Write</span><span class="op" id="3575803">(</span><span class="ident" id="3575804">crlf</span><span class="op" id="3575808">)</span><br>
<span class="lineno"></span><span class="op" id="3575810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3575813">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3575882">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3575950">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3576019">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3576087">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3576125">var</span>&nbsp;<span class="op" id="3576129">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576132">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576144">sync</span><span class="op" id="3576148">.</span><span class="ident" id="3576149">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576158">statusLines</span>&nbsp;<span class="op" id="3576170">=</span>&nbsp;<span class="builtinfunc" id="3576172">make</span><span class="op" id="3576176">(</span><span class="keyword" id="3576177">map</span><span class="op" id="3576180">[</span><span class="builtintype" id="3576181">int</span><span class="op" id="3576184">]</span><span class="builtintype" id="3576185">string</span><span class="op" id="3576191">)</span><br>
<span class="lineno"></span><span class="op" id="3576193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3576196">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3576264">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3576315">func</span>&nbsp;<span class="ident" id="3576320">statusLine</span><span class="op" id="3576330">(</span><span class="ident" id="3576331">req</span>&nbsp;<span class="op" id="3576335">*</span><span class="ident" id="3576336">Request</span><span class="op" id="3576343">,</span>&nbsp;<span class="ident" id="3576345">code</span>&nbsp;<span class="builtintype" id="3576350">int</span><span class="op" id="3576353">)</span>&nbsp;<span class="builtintype" id="3576355">string</span>&nbsp;<span class="op" id="3576362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3576365">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576380">key</span>&nbsp;<span class="op" id="3576384">:=</span>&nbsp;<span class="ident" id="3576387">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576393">proto11</span>&nbsp;<span class="op" id="3576401">:=</span>&nbsp;<span class="ident" id="3576404">req</span><span class="op" id="3576407">.</span><span class="ident" id="3576408">ProtoAtLeast</span><span class="op" id="3576420">(</span><span class="num" id="3576421">1</span><span class="op" id="3576422">,</span>&nbsp;<span class="num" id="3576424">1</span><span class="op" id="3576425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576428">if</span>&nbsp;<span class="op" id="3576431">!</span><span class="ident" id="3576432">proto11</span>&nbsp;<span class="op" id="3576440">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576444">key</span>&nbsp;<span class="op" id="3576448">=</span>&nbsp;<span class="op" id="3576450">-</span><span class="ident" id="3576451">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576459">statusMu</span><span class="op" id="3576467">.</span><span class="ident" id="3576468">RLock</span><span class="op" id="3576473">(</span><span class="op" id="3576474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576477">line</span><span class="op" id="3576481">,</span>&nbsp;<span class="ident" id="3576483">ok</span>&nbsp;<span class="op" id="3576486">:=</span>&nbsp;<span class="ident" id="3576489">statusLines</span><span class="op" id="3576500">[</span><span class="ident" id="3576501">key</span><span class="op" id="3576504">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576507">statusMu</span><span class="op" id="3576515">.</span><span class="ident" id="3576516">RUnlock</span><span class="op" id="3576523">(</span><span class="op" id="3576524">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576527">if</span>&nbsp;<span class="ident" id="3576530">ok</span>&nbsp;<span class="op" id="3576533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576537">return</span>&nbsp;<span class="ident" id="3576544">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3576554">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576569">proto</span>&nbsp;<span class="op" id="3576575">:=</span>&nbsp;<span class="string" id="3576578">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576590">if</span>&nbsp;<span class="ident" id="3576593">proto11</span>&nbsp;<span class="op" id="3576601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576605">proto</span>&nbsp;<span class="op" id="3576611">=</span>&nbsp;<span class="string" id="3576613">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576628">codestring</span>&nbsp;<span class="op" id="3576639">:=</span>&nbsp;<span class="ident" id="3576642">strconv</span><span class="op" id="3576649">.</span><span class="ident" id="3576650">Itoa</span><span class="op" id="3576654">(</span><span class="ident" id="3576655">code</span><span class="op" id="3576659">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576662">text</span><span class="op" id="3576666">,</span>&nbsp;<span class="ident" id="3576668">ok</span>&nbsp;<span class="op" id="3576671">:=</span>&nbsp;<span class="ident" id="3576674">statusText</span><span class="op" id="3576684">[</span><span class="ident" id="3576685">code</span><span class="op" id="3576689">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576692">if</span>&nbsp;<span class="op" id="3576695">!</span><span class="ident" id="3576696">ok</span>&nbsp;<span class="op" id="3576699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576703">text</span>&nbsp;<span class="op" id="3576708">=</span>&nbsp;<span class="string" id="3576710">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3576725">+</span>&nbsp;<span class="ident" id="3576727">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576742">line</span>&nbsp;<span class="op" id="3576747">=</span>&nbsp;<span class="ident" id="3576749">proto</span>&nbsp;<span class="op" id="3576755">+</span>&nbsp;<span class="string" id="3576757">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3576761">+</span>&nbsp;<span class="ident" id="3576763">codestring</span>&nbsp;<span class="op" id="3576774">+</span>&nbsp;<span class="string" id="3576776">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3576780">+</span>&nbsp;<span class="ident" id="3576782">text</span>&nbsp;<span class="op" id="3576787">+</span>&nbsp;<span class="string" id="3576789">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576797">if</span>&nbsp;<span class="ident" id="3576800">ok</span>&nbsp;<span class="op" id="3576803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576807">statusMu</span><span class="op" id="3576815">.</span><span class="ident" id="3576816">Lock</span><span class="op" id="3576820">(</span><span class="op" id="3576821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576825">defer</span>&nbsp;<span class="ident" id="3576831">statusMu</span><span class="op" id="3576839">.</span><span class="ident" id="3576840">Unlock</span><span class="op" id="3576846">(</span><span class="op" id="3576847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576851">statusLines</span><span class="op" id="3576862">[</span><span class="ident" id="3576863">key</span><span class="op" id="3576866">]</span>&nbsp;<span class="op" id="3576868">=</span>&nbsp;<span class="ident" id="3576870">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576876">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576879">return</span>&nbsp;<span class="ident" id="3576886">line</span><br>
<span class="lineno"></span><span class="op" id="3576891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3576894">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3576968">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3577033">func</span>&nbsp;<span class="op" id="3577038">(</span><span class="ident" id="3577039">w</span>&nbsp;<span class="op" id="3577041">*</span><span class="ident" id="3577042">response</span><span class="op" id="3577050">)</span>&nbsp;<span class="ident" id="3577052">bodyAllowed</span><span class="op" id="3577063">(</span><span class="op" id="3577064">)</span>&nbsp;<span class="builtintype" id="3577066">bool</span>&nbsp;<span class="op" id="3577071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577074">if</span>&nbsp;<span class="op" id="3577077">!</span><span class="ident" id="3577078">w</span><span class="op" id="3577079">.</span><span class="ident" id="3577080">wroteHeader</span>&nbsp;<span class="op" id="3577092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3577096">panic</span><span class="op" id="3577101">(</span><span class="string" id="3577102">&#34;&#34;</span><span class="op" id="3577104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3577107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577110">return</span>&nbsp;<span class="ident" id="3577117">bodyAllowedForStatus</span><span class="op" id="3577137">(</span><span class="ident" id="3577138">w</span><span class="op" id="3577139">.</span><span class="ident" id="3577140">status</span><span class="op" id="3577146">)</span><br>
<span class="lineno">940</span><span class="op" id="3577148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3577151">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3577188">//</span><br>
<span class="lineno"></span><span class="comment" id="3577191">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3577258">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3577333">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3577377">//</span><br>
<span class="lineno"></span><span class="comment" id="3577380">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3577450">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3577518">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3577589">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3577615">//</span><br>
<span class="lineno"></span><span class="comment" id="3577618">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3577687">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3577724">//</span><br>
<span class="lineno"></span><span class="comment" id="3577727">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3577767">//</span><br>
<span class="lineno"></span><span class="comment" id="3577770">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3577810">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3577881">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3577956">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3578009">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3578078">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3578148">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3578215">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3578244">//</span><br>
<span class="lineno"></span><span class="comment" id="3578247">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3578311">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3578378">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3578446">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3578511">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3578581">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3578650">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3578721">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3578792">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3578814">func</span>&nbsp;<span class="op" id="3578819">(</span><span class="ident" id="3578820">w</span>&nbsp;<span class="op" id="3578822">*</span><span class="ident" id="3578823">response</span><span class="op" id="3578831">)</span>&nbsp;<span class="ident" id="3578833">Write</span><span class="op" id="3578838">(</span><span class="ident" id="3578839">data</span>&nbsp;<span class="op" id="3578844">[</span><span class="op" id="3578845">]</span><span class="builtintype" id="3578846">byte</span><span class="op" id="3578850">)</span>&nbsp;<span class="op" id="3578852">(</span><span class="ident" id="3578853">n</span>&nbsp;<span class="builtintype" id="3578855">int</span><span class="op" id="3578858">,</span>&nbsp;<span class="ident" id="3578860">err</span>&nbsp;<span class="builtintype" id="3578864">error</span><span class="op" id="3578869">)</span>&nbsp;<span class="op" id="3578871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578874">return</span>&nbsp;<span class="ident" id="3578881">w</span><span class="op" id="3578882">.</span><span class="ident" id="3578883">write</span><span class="op" id="3578888">(</span><span class="builtinfunc" id="3578889">len</span><span class="op" id="3578892">(</span><span class="ident" id="3578893">data</span><span class="op" id="3578897">)</span><span class="op" id="3578898">,</span>&nbsp;<span class="ident" id="3578900">data</span><span class="op" id="3578904">,</span>&nbsp;<span class="string" id="3578906">&#34;&#34;</span><span class="op" id="3578908">)</span><br>
<span class="lineno"></span><span class="op" id="3578910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3578913">func</span>&nbsp;<span class="op" id="3578918">(</span><span class="ident" id="3578919">w</span>&nbsp;<span class="op" id="3578921">*</span><span class="ident" id="3578922">response</span><span class="op" id="3578930">)</span>&nbsp;<span class="ident" id="3578932">WriteString</span><span class="op" id="3578943">(</span><span class="ident" id="3578944">data</span>&nbsp;<span class="builtintype" id="3578949">string</span><span class="op" id="3578955">)</span>&nbsp;<span class="op" id="3578957">(</span><span class="ident" id="3578958">n</span>&nbsp;<span class="builtintype" id="3578960">int</span><span class="op" id="3578963">,</span>&nbsp;<span class="ident" id="3578965">err</span>&nbsp;<span class="builtintype" id="3578969">error</span><span class="op" id="3578974">)</span>&nbsp;<span class="op" id="3578976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578979">return</span>&nbsp;<span class="ident" id="3578986">w</span><span class="op" id="3578987">.</span><span class="ident" id="3578988">write</span><span class="op" id="3578993">(</span><span class="builtinfunc" id="3578994">len</span><span class="op" id="3578997">(</span><span class="ident" id="3578998">data</span><span class="op" id="3579002">)</span><span class="op" id="3579003">,</span>&nbsp;<span class="builtintype" id="3579005">nil</span><span class="op" id="3579008">,</span>&nbsp;<span class="ident" id="3579010">data</span><span class="op" id="3579014">)</span><br>
<span class="lineno"></span><span class="op" id="3579016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3579019">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3579057">func</span>&nbsp;<span class="op" id="3579062">(</span><span class="ident" id="3579063">w</span>&nbsp;<span class="op" id="3579065">*</span><span class="ident" id="3579066">response</span><span class="op" id="3579074">)</span>&nbsp;<span class="ident" id="3579076">write</span><span class="op" id="3579081">(</span><span class="ident" id="3579082">lenData</span>&nbsp;<span class="builtintype" id="3579090">int</span><span class="op" id="3579093">,</span>&nbsp;<span class="ident" id="3579095">dataB</span>&nbsp;<span class="op" id="3579101">[</span><span class="op" id="3579102">]</span><span class="builtintype" id="3579103">byte</span><span class="op" id="3579107">,</span>&nbsp;<span class="ident" id="3579109">dataS</span>&nbsp;<span class="builtintype" id="3579115">string</span><span class="op" id="3579121">)</span>&nbsp;<span class="op" id="3579123">(</span><span class="ident" id="3579124">n</span>&nbsp;<span class="builtintype" id="3579126">int</span><span class="op" id="3579129">,</span>&nbsp;<span class="ident" id="3579131">err</span>&nbsp;<span class="builtintype" id="3579135">error</span><span class="op" id="3579140">)</span>&nbsp;<span class="op" id="3579142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579145">if</span>&nbsp;<span class="ident" id="3579148">w</span><span class="op" id="3579149">.</span><span class="ident" id="3579150">conn</span><span class="op" id="3579154">.</span><span class="ident" id="3579155">hijacked</span><span class="op" id="3579163">(</span><span class="op" id="3579164">)</span>&nbsp;<span class="op" id="3579166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579170">w</span><span class="op" id="3579171">.</span><span class="ident" id="3579172">conn</span><span class="op" id="3579176">.</span><span class="ident" id="3579177">server</span><span class="op" id="3579183">.</span><span class="ident" id="3579184">logf</span><span class="op" id="3579188">(</span><span class="string" id="3579189">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3579234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579238">return</span>&nbsp;<span class="num" id="3579245">0</span><span class="op" id="3579246">,</span>&nbsp;<span class="ident" id="3579248">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579261">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579264">if</span>&nbsp;<span class="op" id="3579267">!</span><span class="ident" id="3579268">w</span><span class="op" id="3579269">.</span><span class="ident" id="3579270">wroteHeader</span>&nbsp;<span class="op" id="3579282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579286">w</span><span class="op" id="3579287">.</span><span class="ident" id="3579288">WriteHeader</span><span class="op" id="3579299">(</span><span class="ident" id="3579300">StatusOK</span><span class="op" id="3579308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579314">if</span>&nbsp;<span class="ident" id="3579317">lenData</span>&nbsp;<span class="op" id="3579325">==</span>&nbsp;<span class="num" id="3579328">0</span>&nbsp;<span class="op" id="3579330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579334">return</span>&nbsp;<span class="num" id="3579341">0</span><span class="op" id="3579342">,</span>&nbsp;<span class="builtintype" id="3579344">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579352">if</span>&nbsp;<span class="op" id="3579355">!</span><span class="ident" id="3579356">w</span><span class="op" id="3579357">.</span><span class="ident" id="3579358">bodyAllowed</span><span class="op" id="3579369">(</span><span class="op" id="3579370">)</span>&nbsp;<span class="op" id="3579372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579376">return</span>&nbsp;<span class="num" id="3579383">0</span><span class="op" id="3579384">,</span>&nbsp;<span class="ident" id="3579386">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579409">w</span><span class="op" id="3579410">.</span><span class="ident" id="3579411">written</span>&nbsp;<span class="op" id="3579419">+=</span>&nbsp;<span class="builtintype" id="3579422">int64</span><span class="op" id="3579427">(</span><span class="ident" id="3579428">lenData</span><span class="op" id="3579435">)</span>&nbsp;<span class="comment" id="3579437">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579474">if</span>&nbsp;<span class="ident" id="3579477">w</span><span class="op" id="3579478">.</span><span class="ident" id="3579479">contentLength</span>&nbsp;<span class="op" id="3579493">!=</span>&nbsp;<span class="op" id="3579496">-</span><span class="num" id="3579497">1</span>&nbsp;<span class="op" id="3579499">&amp;&amp;</span>&nbsp;<span class="ident" id="3579502">w</span><span class="op" id="3579503">.</span><span class="ident" id="3579504">written</span>&nbsp;<span class="op" id="3579512">&gt;</span>&nbsp;<span class="ident" id="3579514">w</span><span class="op" id="3579515">.</span><span class="ident" id="3579516">contentLength</span>&nbsp;<span class="op" id="3579530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579534">return</span>&nbsp;<span class="num" id="3579541">0</span><span class="op" id="3579542">,</span>&nbsp;<span class="ident" id="3579544">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579565">if</span>&nbsp;<span class="ident" id="3579568">dataB</span>&nbsp;<span class="op" id="3579574">!=</span>&nbsp;<span class="builtintype" id="3579577">nil</span>&nbsp;<span class="op" id="3579581">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579585">return</span>&nbsp;<span class="ident" id="3579592">w</span><span class="op" id="3579593">.</span><span class="ident" id="3579594">w</span><span class="op" id="3579595">.</span><span class="ident" id="3579596">Write</span><span class="op" id="3579601">(</span><span class="ident" id="3579602">dataB</span><span class="op" id="3579607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579610">}</span>&nbsp;<span class="keyword" id="3579612">else</span>&nbsp;<span class="op" id="3579617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579621">return</span>&nbsp;<span class="ident" id="3579628">w</span><span class="op" id="3579629">.</span><span class="ident" id="3579630">w</span><span class="op" id="3579631">.</span><span class="ident" id="3579632">WriteString</span><span class="op" id="3579643">(</span><span class="ident" id="3579644">dataS</span><span class="op" id="3579649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579652">}</span><br>
<span class="lineno"></span><span class="op" id="3579654">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3579657">func</span>&nbsp;<span class="op" id="3579662">(</span><span class="ident" id="3579663">w</span>&nbsp;<span class="op" id="3579665">*</span><span class="ident" id="3579666">response</span><span class="op" id="3579674">)</span>&nbsp;<span class="ident" id="3579676">finishRequest</span><span class="op" id="3579689">(</span><span class="op" id="3579690">)</span>&nbsp;<span class="op" id="3579692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579695">w</span><span class="op" id="3579696">.</span><span class="ident" id="3579697">handlerDone</span>&nbsp;<span class="op" id="3579709">=</span>&nbsp;<span class="builtintype" id="3579711">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579718">if</span>&nbsp;<span class="op" id="3579721">!</span><span class="ident" id="3579722">w</span><span class="op" id="3579723">.</span><span class="ident" id="3579724">wroteHeader</span>&nbsp;<span class="op" id="3579736">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579740">w</span><span class="op" id="3579741">.</span><span class="ident" id="3579742">WriteHeader</span><span class="op" id="3579753">(</span><span class="ident" id="3579754">StatusOK</span><span class="op" id="3579762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579769">w</span><span class="op" id="3579770">.</span><span class="ident" id="3579771">w</span><span class="op" id="3579772">.</span><span class="ident" id="3579773">Flush</span><span class="op" id="3579778">(</span><span class="op" id="3579779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579782">putBufioWriter</span><span class="op" id="3579796">(</span><span class="ident" id="3579797">w</span><span class="op" id="3579798">.</span><span class="ident" id="3579799">w</span><span class="op" id="3579800">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579803">w</span><span class="op" id="3579804">.</span><span class="ident" id="3579805">cw</span><span class="op" id="3579807">.</span><span class="builtinfunc" id="3579808">close</span><span class="op" id="3579813">(</span><span class="op" id="3579814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579817">w</span><span class="op" id="3579818">.</span><span class="ident" id="3579819">conn</span><span class="op" id="3579823">.</span><span class="ident" id="3579824">buf</span><span class="op" id="3579827">.</span><span class="ident" id="3579828">Flush</span><span class="op" id="3579833">(</span><span class="op" id="3579834">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579838">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579901">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579943">w</span><span class="op" id="3579944">.</span><span class="ident" id="3579945">req</span><span class="op" id="3579948">.</span><span class="ident" id="3579949">Body</span><span class="op" id="3579953">.</span><span class="ident" id="3579954">Close</span><span class="op" id="3579959">(</span><span class="op" id="3579960">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579964">if</span>&nbsp;<span class="ident" id="3579967">w</span><span class="op" id="3579968">.</span><span class="ident" id="3579969">req</span><span class="op" id="3579972">.</span><span class="ident" id="3579973">MultipartForm</span>&nbsp;<span class="op" id="3579987">!=</span>&nbsp;<span class="builtintype" id="3579990">nil</span>&nbsp;<span class="op" id="3579994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579998">w</span><span class="op" id="3579999">.</span><span class="ident" id="3580000">req</span><span class="op" id="3580003">.</span><span class="ident" id="3580004">MultipartForm</span><span class="op" id="3580017">.</span><span class="ident" id="3580018">RemoveAll</span><span class="op" id="3580027">(</span><span class="op" id="3580028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580031">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580035">if</span>&nbsp;<span class="ident" id="3580038">w</span><span class="op" id="3580039">.</span><span class="ident" id="3580040">req</span><span class="op" id="3580043">.</span><span class="ident" id="3580044">Method</span>&nbsp;<span class="op" id="3580051">!=</span>&nbsp;<span class="string" id="3580054">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3580061">&amp;&amp;</span>&nbsp;<span class="ident" id="3580064">w</span><span class="op" id="3580065">.</span><span class="ident" id="3580066">contentLength</span>&nbsp;<span class="op" id="3580080">!=</span>&nbsp;<span class="op" id="3580083">-</span><span class="num" id="3580084">1</span>&nbsp;<span class="op" id="3580086">&amp;&amp;</span>&nbsp;<span class="ident" id="3580089">w</span><span class="op" id="3580090">.</span><span class="ident" id="3580091">bodyAllowed</span><span class="op" id="3580102">(</span><span class="op" id="3580103">)</span>&nbsp;<span class="op" id="3580105">&amp;&amp;</span>&nbsp;<span class="ident" id="3580108">w</span><span class="op" id="3580109">.</span><span class="ident" id="3580110">contentLength</span>&nbsp;<span class="op" id="3580124">!=</span>&nbsp;<span class="ident" id="3580127">w</span><span class="op" id="3580128">.</span><span class="ident" id="3580129">written</span>&nbsp;<span class="op" id="3580137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580141">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580195">w</span><span class="op" id="3580196">.</span><span class="ident" id="3580197">closeAfterReply</span>&nbsp;<span class="op" id="3580213">=</span>&nbsp;<span class="builtintype" id="3580215">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580221">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580225">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580287">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580338">if</span>&nbsp;<span class="ident" id="3580341">w</span><span class="op" id="3580342">.</span><span class="ident" id="3580343">conn</span><span class="op" id="3580347">.</span><span class="ident" id="3580348">werr</span>&nbsp;<span class="op" id="3580353">!=</span>&nbsp;<span class="builtintype" id="3580356">nil</span>&nbsp;<span class="op" id="3580360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580364">w</span><span class="op" id="3580365">.</span><span class="ident" id="3580366">closeAfterReply</span>&nbsp;<span class="op" id="3580382">=</span>&nbsp;<span class="builtintype" id="3580384">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580390">}</span><br>
<span class="lineno"></span><span class="op" id="3580392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3580395">func</span>&nbsp;<span class="op" id="3580400">(</span><span class="ident" id="3580401">w</span>&nbsp;<span class="op" id="3580403">*</span><span class="ident" id="3580404">response</span><span class="op" id="3580412">)</span>&nbsp;<span class="ident" id="3580414">Flush</span><span class="op" id="3580419">(</span><span class="op" id="3580420">)</span>&nbsp;<span class="op" id="3580422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580425">if</span>&nbsp;<span class="op" id="3580428">!</span><span class="ident" id="3580429">w</span><span class="op" id="3580430">.</span><span class="ident" id="3580431">wroteHeader</span>&nbsp;<span class="op" id="3580443">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580447">w</span><span class="op" id="3580448">.</span><span class="ident" id="3580449">WriteHeader</span><span class="op" id="3580460">(</span><span class="ident" id="3580461">StatusOK</span><span class="op" id="3580469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580475">w</span><span class="op" id="3580476">.</span><span class="ident" id="3580477">w</span><span class="op" id="3580478">.</span><span class="ident" id="3580479">Flush</span><span class="op" id="3580484">(</span><span class="op" id="3580485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580488">w</span><span class="op" id="3580489">.</span><span class="ident" id="3580490">cw</span><span class="op" id="3580492">.</span><span class="ident" id="3580493">flush</span><span class="op" id="3580498">(</span><span class="op" id="3580499">)</span><br>
<span class="lineno"></span><span class="op" id="3580501">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3580504">func</span>&nbsp;<span class="op" id="3580509">(</span><span class="ident" id="3580510">c</span>&nbsp;<span class="op" id="3580512">*</span><span class="ident" id="3580513">conn</span><span class="op" id="3580517">)</span>&nbsp;<span class="ident" id="3580519">finalFlush</span><span class="op" id="3580529">(</span><span class="op" id="3580530">)</span>&nbsp;<span class="op" id="3580532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580535">if</span>&nbsp;<span class="ident" id="3580538">c</span><span class="op" id="3580539">.</span><span class="ident" id="3580540">buf</span>&nbsp;<span class="op" id="3580544">!=</span>&nbsp;<span class="builtintype" id="3580547">nil</span>&nbsp;<span class="op" id="3580551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580555">c</span><span class="op" id="3580556">.</span><span class="ident" id="3580557">buf</span><span class="op" id="3580560">.</span><span class="ident" id="3580561">Flush</span><span class="op" id="3580566">(</span><span class="op" id="3580567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580572">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580642">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580679">putBufioReader</span><span class="op" id="3580693">(</span><span class="ident" id="3580694">c</span><span class="op" id="3580695">.</span><span class="ident" id="3580696">buf</span><span class="op" id="3580699">.</span><span class="ident" id="3580700">Reader</span><span class="op" id="3580706">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580711">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580781">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580818">putBufioWriter</span><span class="op" id="3580832">(</span><span class="ident" id="3580833">c</span><span class="op" id="3580834">.</span><span class="ident" id="3580835">buf</span><span class="op" id="3580838">.</span><span class="ident" id="3580839">Writer</span><span class="op" id="3580845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580850">c</span><span class="op" id="3580851">.</span><span class="ident" id="3580852">buf</span>&nbsp;<span class="op" id="3580856">=</span>&nbsp;<span class="builtintype" id="3580858">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580863">}</span><br>
<span class="lineno">1065</span><span class="op" id="3580865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3580868">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3580893">func</span>&nbsp;<span class="op" id="3580898">(</span><span class="ident" id="3580899">c</span>&nbsp;<span class="op" id="3580901">*</span><span class="ident" id="3580902">conn</span><span class="op" id="3580906">)</span>&nbsp;<span class="builtinfunc" id="3580908">close</span><span class="op" id="3580913">(</span><span class="op" id="3580914">)</span>&nbsp;<span class="op" id="3580916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580919">c</span><span class="op" id="3580920">.</span><span class="ident" id="3580921">finalFlush</span><span class="op" id="3580931">(</span><span class="op" id="3580932">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3580935">if</span>&nbsp;<span class="ident" id="3580938">c</span><span class="op" id="3580939">.</span><span class="ident" id="3580940">rwc</span>&nbsp;<span class="op" id="3580944">!=</span>&nbsp;<span class="builtintype" id="3580947">nil</span>&nbsp;<span class="op" id="3580951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580955">c</span><span class="op" id="3580956">.</span><span class="ident" id="3580957">rwc</span><span class="op" id="3580960">.</span><span class="ident" id="3580961">Close</span><span class="op" id="3580966">(</span><span class="op" id="3580967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3580971">c</span><span class="op" id="3580972">.</span><span class="ident" id="3580973">rwc</span>&nbsp;<span class="op" id="3580977">=</span>&nbsp;<span class="builtintype" id="3580979">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580984">}</span><br>
<span class="lineno"></span><span class="op" id="3580986">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3580989">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3581059">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3581127">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3581196">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3581267">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3581320">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3581385">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3581453">const</span>&nbsp;<span class="ident" id="3581459">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3581477">=</span>&nbsp;<span class="num" id="3581479">500</span>&nbsp;<span class="op" id="3581483">*</span>&nbsp;<span class="ident" id="3581485">time</span><span class="op" id="3581489">.</span><span class="ident" id="3581490">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3581503">type</span>&nbsp;<span class="ident" id="3581508">closeWriter</span>&nbsp;<span class="keyword" id="3581520">interface</span>&nbsp;<span class="op" id="3581530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581533">CloseWrite</span><span class="op" id="3581543">(</span><span class="op" id="3581544">)</span>&nbsp;<span class="builtintype" id="3581546">error</span><br>
<span class="lineno"></span><span class="op" id="3581552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3581555">var</span>&nbsp;<span class="ident" id="3581559">_</span>&nbsp;<span class="ident" id="3581561">closeWriter</span>&nbsp;<span class="op" id="3581573">=</span>&nbsp;<span class="op" id="3581575">(</span><span class="op" id="3581576">*</span><span class="ident" id="3581577">net</span><span class="op" id="3581580">.</span><span class="ident" id="3581581">TCPConn</span><span class="op" id="3581588">)</span><span class="op" id="3581589">(</span><span class="builtintype" id="3581590">nil</span><span class="op" id="3581593">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3581596">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3581666">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3581736">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3581798">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3581817">//</span><br>
<span class="lineno"></span><span class="comment" id="3581820">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3581856">func</span>&nbsp;<span class="op" id="3581861">(</span><span class="ident" id="3581862">c</span>&nbsp;<span class="op" id="3581864">*</span><span class="ident" id="3581865">conn</span><span class="op" id="3581869">)</span>&nbsp;<span class="ident" id="3581871">closeWriteAndWait</span><span class="op" id="3581888">(</span><span class="op" id="3581889">)</span>&nbsp;<span class="op" id="3581891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581894">c</span><span class="op" id="3581895">.</span><span class="ident" id="3581896">finalFlush</span><span class="op" id="3581906">(</span><span class="op" id="3581907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3581910">if</span>&nbsp;<span class="ident" id="3581913">tcp</span><span class="op" id="3581916">,</span>&nbsp;<span class="ident" id="3581918">ok</span>&nbsp;<span class="op" id="3581921">:=</span>&nbsp;<span class="ident" id="3581924">c</span><span class="op" id="3581925">.</span><span class="ident" id="3581926">rwc</span><span class="op" id="3581929">.</span><span class="op" id="3581930">(</span><span class="ident" id="3581931">closeWriter</span><span class="op" id="3581942">)</span><span class="op" id="3581943">;</span>&nbsp;<span class="ident" id="3581945">ok</span>&nbsp;<span class="op" id="3581948">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581952">tcp</span><span class="op" id="3581955">.</span><span class="ident" id="3581956">CloseWrite</span><span class="op" id="3581966">(</span><span class="op" id="3581967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3581970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581973">time</span><span class="op" id="3581977">.</span><span class="ident" id="3581978">Sleep</span><span class="op" id="3581983">(</span><span class="ident" id="3581984">rstAvoidanceDelay</span><span class="op" id="3582001">)</span><br>
<span class="lineno"></span><span class="op" id="3582003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3582006">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3582070">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3582139">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3582197">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3582217">func</span>&nbsp;<span class="ident" id="3582222">validNPN</span><span class="op" id="3582230">(</span><span class="ident" id="3582231">proto</span>&nbsp;<span class="builtintype" id="3582237">string</span><span class="op" id="3582243">)</span>&nbsp;<span class="builtintype" id="3582245">bool</span>&nbsp;<span class="op" id="3582250">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582253">switch</span>&nbsp;<span class="ident" id="3582260">proto</span>&nbsp;<span class="op" id="3582266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582269">case</span>&nbsp;<span class="string" id="3582274">&#34;&#34;</span><span class="op" id="3582276">,</span>&nbsp;<span class="string" id="3582278">&#34;http/1.1&#34;</span><span class="op" id="3582288">,</span>&nbsp;<span class="string" id="3582290">&#34;http/1.0&#34;</span><span class="op" id="3582300">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582304">return</span>&nbsp;<span class="builtintype" id="3582311">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582321">return</span>&nbsp;<span class="builtintype" id="3582328">true</span><br>
<span class="lineno">1115</span><span class="op" id="3582333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3582336">func</span>&nbsp;<span class="op" id="3582341">(</span><span class="ident" id="3582342">c</span>&nbsp;<span class="op" id="3582344">*</span><span class="ident" id="3582345">conn</span><span class="op" id="3582349">)</span>&nbsp;<span class="ident" id="3582351">setState</span><span class="op" id="3582359">(</span><span class="ident" id="3582360">nc</span>&nbsp;<span class="ident" id="3582363">net</span><span class="op" id="3582366">.</span><span class="ident" id="3582367">Conn</span><span class="op" id="3582371">,</span>&nbsp;<span class="ident" id="3582373">state</span>&nbsp;<span class="ident" id="3582379">ConnState</span><span class="op" id="3582388">)</span>&nbsp;<span class="op" id="3582390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582393">if</span>&nbsp;<span class="ident" id="3582396">hook</span>&nbsp;<span class="op" id="3582401">:=</span>&nbsp;<span class="ident" id="3582404">c</span><span class="op" id="3582405">.</span><span class="ident" id="3582406">server</span><span class="op" id="3582412">.</span><span class="ident" id="3582413">ConnState</span><span class="op" id="3582422">;</span>&nbsp;<span class="ident" id="3582424">hook</span>&nbsp;<span class="op" id="3582429">!=</span>&nbsp;<span class="builtintype" id="3582432">nil</span>&nbsp;<span class="op" id="3582436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582440">hook</span><span class="op" id="3582444">(</span><span class="ident" id="3582445">nc</span><span class="op" id="3582447">,</span>&nbsp;<span class="ident" id="3582449">state</span><span class="op" id="3582454">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582457">}</span><br>
<span class="lineno"></span><span class="op" id="3582459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3582462">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3582489">func</span>&nbsp;<span class="op" id="3582494">(</span><span class="ident" id="3582495">c</span>&nbsp;<span class="op" id="3582497">*</span><span class="ident" id="3582498">conn</span><span class="op" id="3582502">)</span>&nbsp;<span class="ident" id="3582504">serve</span><span class="op" id="3582509">(</span><span class="op" id="3582510">)</span>&nbsp;<span class="op" id="3582512">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582515">origConn</span>&nbsp;<span class="op" id="3582524">:=</span>&nbsp;<span class="ident" id="3582527">c</span><span class="op" id="3582528">.</span><span class="ident" id="3582529">rwc</span>&nbsp;<span class="comment" id="3582533">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582584">defer</span>&nbsp;<span class="keyword" id="3582590">func</span><span class="op" id="3582594">(</span><span class="op" id="3582595">)</span>&nbsp;<span class="op" id="3582597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582601">if</span>&nbsp;<span class="ident" id="3582604">err</span>&nbsp;<span class="op" id="3582608">:=</span>&nbsp;<span class="builtinfunc" id="3582611">recover</span><span class="op" id="3582618">(</span><span class="op" id="3582619">)</span><span class="op" id="3582620">;</span>&nbsp;<span class="ident" id="3582622">err</span>&nbsp;<span class="op" id="3582626">!=</span>&nbsp;<span class="builtintype" id="3582629">nil</span>&nbsp;<span class="op" id="3582633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582638">const</span>&nbsp;<span class="ident" id="3582644">size</span>&nbsp;<span class="op" id="3582649">=</span>&nbsp;<span class="num" id="3582651">64</span>&nbsp;<span class="op" id="3582654">&lt;&lt;</span>&nbsp;<span class="num" id="3582657">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582663">buf</span>&nbsp;<span class="op" id="3582667">:=</span>&nbsp;<span class="builtinfunc" id="3582670">make</span><span class="op" id="3582674">(</span><span class="op" id="3582675">[</span><span class="op" id="3582676">]</span><span class="builtintype" id="3582677">byte</span><span class="op" id="3582681">,</span>&nbsp;<span class="ident" id="3582683">size</span><span class="op" id="3582687">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582692">buf</span>&nbsp;<span class="op" id="3582696">=</span>&nbsp;<span class="ident" id="3582698">buf</span><span class="op" id="3582701">[</span><span class="op" id="3582702">:</span><span class="ident" id="3582703">runtime</span><span class="op" id="3582710">.</span><span class="ident" id="3582711">Stack</span><span class="op" id="3582716">(</span><span class="ident" id="3582717">buf</span><span class="op" id="3582720">,</span>&nbsp;<span class="builtintype" id="3582722">false</span><span class="op" id="3582727">)</span><span class="op" id="3582728">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582733">c</span><span class="op" id="3582734">.</span><span class="ident" id="3582735">server</span><span class="op" id="3582741">.</span><span class="ident" id="3582742">logf</span><span class="op" id="3582746">(</span><span class="string" id="3582747">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3582779">,</span>&nbsp;<span class="ident" id="3582781">c</span><span class="op" id="3582782">.</span><span class="ident" id="3582783">remoteAddr</span><span class="op" id="3582793">,</span>&nbsp;<span class="ident" id="3582795">err</span><span class="op" id="3582798">,</span>&nbsp;<span class="ident" id="3582800">buf</span><span class="op" id="3582803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582811">if</span>&nbsp;<span class="op" id="3582814">!</span><span class="ident" id="3582815">c</span><span class="op" id="3582816">.</span><span class="ident" id="3582817">hijacked</span><span class="op" id="3582825">(</span><span class="op" id="3582826">)</span>&nbsp;<span class="op" id="3582828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582833">c</span><span class="op" id="3582834">.</span><span class="builtinfunc" id="3582835">close</span><span class="op" id="3582840">(</span><span class="op" id="3582841">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582846">c</span><span class="op" id="3582847">.</span><span class="ident" id="3582848">setState</span><span class="op" id="3582856">(</span><span class="ident" id="3582857">origConn</span><span class="op" id="3582865">,</span>&nbsp;<span class="ident" id="3582867">StateClosed</span><span class="op" id="3582878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3582885">}</span><span class="op" id="3582886">(</span><span class="op" id="3582887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582891">if</span>&nbsp;<span class="ident" id="3582894">tlsConn</span><span class="op" id="3582901">,</span>&nbsp;<span class="ident" id="3582903">ok</span>&nbsp;<span class="op" id="3582906">:=</span>&nbsp;<span class="ident" id="3582909">c</span><span class="op" id="3582910">.</span><span class="ident" id="3582911">rwc</span><span class="op" id="3582914">.</span><span class="op" id="3582915">(</span><span class="op" id="3582916">*</span><span class="ident" id="3582917">tls</span><span class="op" id="3582920">.</span><span class="ident" id="3582921">Conn</span><span class="op" id="3582925">)</span><span class="op" id="3582926">;</span>&nbsp;<span class="ident" id="3582928">ok</span>&nbsp;<span class="op" id="3582931">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3582935">if</span>&nbsp;<span class="ident" id="3582938">d</span>&nbsp;<span class="op" id="3582940">:=</span>&nbsp;<span class="ident" id="3582943">c</span><span class="op" id="3582944">.</span><span class="ident" id="3582945">server</span><span class="op" id="3582951">.</span><span class="ident" id="3582952">ReadTimeout</span><span class="op" id="3582963">;</span>&nbsp;<span class="ident" id="3582965">d</span>&nbsp;<span class="op" id="3582967">!=</span>&nbsp;<span class="num" id="3582970">0</span>&nbsp;<span class="op" id="3582972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3582977">c</span><span class="op" id="3582978">.</span><span class="ident" id="3582979">rwc</span><span class="op" id="3582982">.</span><span class="ident" id="3582983">SetReadDeadline</span><span class="op" id="3582998">(</span><span class="ident" id="3582999">time</span><span class="op" id="3583003">.</span><span class="ident" id="3583004">Now</span><span class="op" id="3583007">(</span><span class="op" id="3583008">)</span><span class="op" id="3583009">.</span><span class="ident" id="3583010">Add</span><span class="op" id="3583013">(</span><span class="ident" id="3583014">d</span><span class="op" id="3583015">)</span><span class="op" id="3583016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583024">if</span>&nbsp;<span class="ident" id="3583027">d</span>&nbsp;<span class="op" id="3583029">:=</span>&nbsp;<span class="ident" id="3583032">c</span><span class="op" id="3583033">.</span><span class="ident" id="3583034">server</span><span class="op" id="3583040">.</span><span class="ident" id="3583041">WriteTimeout</span><span class="op" id="3583053">;</span>&nbsp;<span class="ident" id="3583055">d</span>&nbsp;<span class="op" id="3583057">!=</span>&nbsp;<span class="num" id="3583060">0</span>&nbsp;<span class="op" id="3583062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583067">c</span><span class="op" id="3583068">.</span><span class="ident" id="3583069">rwc</span><span class="op" id="3583072">.</span><span class="ident" id="3583073">SetWriteDeadline</span><span class="op" id="3583089">(</span><span class="ident" id="3583090">time</span><span class="op" id="3583094">.</span><span class="ident" id="3583095">Now</span><span class="op" id="3583098">(</span><span class="op" id="3583099">)</span><span class="op" id="3583100">.</span><span class="ident" id="3583101">Add</span><span class="op" id="3583104">(</span><span class="ident" id="3583105">d</span><span class="op" id="3583106">)</span><span class="op" id="3583107">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583115">if</span>&nbsp;<span class="ident" id="3583118">err</span>&nbsp;<span class="op" id="3583122">:=</span>&nbsp;<span class="ident" id="3583125">tlsConn</span><span class="op" id="3583132">.</span><span class="ident" id="3583133">Handshake</span><span class="op" id="3583142">(</span><span class="op" id="3583143">)</span><span class="op" id="3583144">;</span>&nbsp;<span class="ident" id="3583146">err</span>&nbsp;<span class="op" id="3583150">!=</span>&nbsp;<span class="builtintype" id="3583153">nil</span>&nbsp;<span class="op" id="3583157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583162">c</span><span class="op" id="3583163">.</span><span class="ident" id="3583164">server</span><span class="op" id="3583170">.</span><span class="ident" id="3583171">logf</span><span class="op" id="3583175">(</span><span class="string" id="3583176">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3583215">,</span>&nbsp;<span class="ident" id="3583217">c</span><span class="op" id="3583218">.</span><span class="ident" id="3583219">rwc</span><span class="op" id="3583222">.</span><span class="ident" id="3583223">RemoteAddr</span><span class="op" id="3583233">(</span><span class="op" id="3583234">)</span><span class="op" id="3583235">,</span>&nbsp;<span class="ident" id="3583237">err</span><span class="op" id="3583240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583245">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583254">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583258">c</span><span class="op" id="3583259">.</span><span class="ident" id="3583260">tlsState</span>&nbsp;<span class="op" id="3583269">=</span>&nbsp;<span class="builtinfunc" id="3583271">new</span><span class="op" id="3583274">(</span><span class="ident" id="3583275">tls</span><span class="op" id="3583278">.</span><span class="ident" id="3583279">ConnectionState</span><span class="op" id="3583294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583298">*</span><span class="ident" id="3583299">c</span><span class="op" id="3583300">.</span><span class="ident" id="3583301">tlsState</span>&nbsp;<span class="op" id="3583310">=</span>&nbsp;<span class="ident" id="3583312">tlsConn</span><span class="op" id="3583319">.</span><span class="ident" id="3583320">ConnectionState</span><span class="op" id="3583335">(</span><span class="op" id="3583336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583340">if</span>&nbsp;<span class="ident" id="3583343">proto</span>&nbsp;<span class="op" id="3583349">:=</span>&nbsp;<span class="ident" id="3583352">c</span><span class="op" id="3583353">.</span><span class="ident" id="3583354">tlsState</span><span class="op" id="3583362">.</span><span class="ident" id="3583363">NegotiatedProtocol</span><span class="op" id="3583381">;</span>&nbsp;<span class="ident" id="3583383">validNPN</span><span class="op" id="3583391">(</span><span class="ident" id="3583392">proto</span><span class="op" id="3583397">)</span>&nbsp;<span class="op" id="3583399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583404">if</span>&nbsp;<span class="ident" id="3583407">fn</span>&nbsp;<span class="op" id="3583410">:=</span>&nbsp;<span class="ident" id="3583413">c</span><span class="op" id="3583414">.</span><span class="ident" id="3583415">server</span><span class="op" id="3583421">.</span><span class="ident" id="3583422">TLSNextProto</span><span class="op" id="3583434">[</span><span class="ident" id="3583435">proto</span><span class="op" id="3583440">]</span><span class="op" id="3583441">;</span>&nbsp;<span class="ident" id="3583443">fn</span>&nbsp;<span class="op" id="3583446">!=</span>&nbsp;<span class="builtintype" id="3583449">nil</span>&nbsp;<span class="op" id="3583453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583459">h</span>&nbsp;<span class="op" id="3583461">:=</span>&nbsp;<span class="ident" id="3583464">initNPNRequest</span><span class="op" id="3583478">{</span><span class="ident" id="3583479">tlsConn</span><span class="op" id="3583486">,</span>&nbsp;<span class="ident" id="3583488">serverHandler</span><span class="op" id="3583501">{</span><span class="ident" id="3583502">c</span><span class="op" id="3583503">.</span><span class="ident" id="3583504">server</span><span class="op" id="3583510">}</span><span class="op" id="3583511">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583517">fn</span><span class="op" id="3583519">(</span><span class="ident" id="3583520">c</span><span class="op" id="3583521">.</span><span class="ident" id="3583522">server</span><span class="op" id="3583528">,</span>&nbsp;<span class="ident" id="3583530">tlsConn</span><span class="op" id="3583537">,</span>&nbsp;<span class="ident" id="3583539">h</span><span class="op" id="3583540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583550">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583562">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583566">for</span>&nbsp;<span class="op" id="3583570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583574">w</span><span class="op" id="3583575">,</span>&nbsp;<span class="ident" id="3583577">err</span>&nbsp;<span class="op" id="3583581">:=</span>&nbsp;<span class="ident" id="3583584">c</span><span class="op" id="3583585">.</span><span class="ident" id="3583586">readRequest</span><span class="op" id="3583597">(</span><span class="op" id="3583598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583602">if</span>&nbsp;<span class="ident" id="3583605">c</span><span class="op" id="3583606">.</span><span class="ident" id="3583607">lr</span><span class="op" id="3583609">.</span><span class="ident" id="3583610">N</span>&nbsp;<span class="op" id="3583612">!=</span>&nbsp;<span class="ident" id="3583615">c</span><span class="op" id="3583616">.</span><span class="ident" id="3583617">server</span><span class="op" id="3583623">.</span><span class="ident" id="3583624">initialLimitedReaderSize</span><span class="op" id="3583648">(</span><span class="op" id="3583649">)</span>&nbsp;<span class="op" id="3583651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583656">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583711">c</span><span class="op" id="3583712">.</span><span class="ident" id="3583713">setState</span><span class="op" id="3583721">(</span><span class="ident" id="3583722">c</span><span class="op" id="3583723">.</span><span class="ident" id="3583724">rwc</span><span class="op" id="3583727">,</span>&nbsp;<span class="ident" id="3583729">StateActive</span><span class="op" id="3583740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3583744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583748">if</span>&nbsp;<span class="ident" id="3583751">err</span>&nbsp;<span class="op" id="3583755">!=</span>&nbsp;<span class="builtintype" id="3583758">nil</span>&nbsp;<span class="op" id="3583762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3583767">if</span>&nbsp;<span class="ident" id="3583770">err</span>&nbsp;<span class="op" id="3583774">==</span>&nbsp;<span class="ident" id="3583777">errTooLarge</span>&nbsp;<span class="op" id="3583789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583795">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583838">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583872">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583913">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3583954">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3583991">io</span><span class="op" id="3583993">.</span><span class="ident" id="3583994">WriteString</span><span class="op" id="3584005">(</span><span class="ident" id="3584006">c</span><span class="op" id="3584007">.</span><span class="ident" id="3584008">rwc</span><span class="op" id="3584011">,</span>&nbsp;<span class="string" id="3584013">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3584060">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584066">c</span><span class="op" id="3584067">.</span><span class="ident" id="3584068">closeWriteAndWait</span><span class="op" id="3584085">(</span><span class="op" id="3584086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584092">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584101">}</span>&nbsp;<span class="keyword" id="3584103">else</span>&nbsp;<span class="keyword" id="3584108">if</span>&nbsp;<span class="ident" id="3584111">err</span>&nbsp;<span class="op" id="3584115">==</span>&nbsp;<span class="ident" id="3584118">io</span><span class="op" id="3584120">.</span><span class="ident" id="3584121">EOF</span>&nbsp;<span class="op" id="3584125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584131">break</span>&nbsp;<span class="comment" id="3584137">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584155">}</span>&nbsp;<span class="keyword" id="3584157">else</span>&nbsp;<span class="keyword" id="3584162">if</span>&nbsp;<span class="ident" id="3584165">neterr</span><span class="op" id="3584171">,</span>&nbsp;<span class="ident" id="3584173">ok</span>&nbsp;<span class="op" id="3584176">:=</span>&nbsp;<span class="ident" id="3584179">err</span><span class="op" id="3584182">.</span><span class="op" id="3584183">(</span><span class="ident" id="3584184">net</span><span class="op" id="3584187">.</span><span class="ident" id="3584188">Error</span><span class="op" id="3584193">)</span><span class="op" id="3584194">;</span>&nbsp;<span class="ident" id="3584196">ok</span>&nbsp;<span class="op" id="3584199">&amp;&amp;</span>&nbsp;<span class="ident" id="3584202">neterr</span><span class="op" id="3584208">.</span><span class="ident" id="3584209">Timeout</span><span class="op" id="3584216">(</span><span class="op" id="3584217">)</span>&nbsp;<span class="op" id="3584219">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584225">break</span>&nbsp;<span class="comment" id="3584231">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584254">io</span><span class="op" id="3584256">.</span><span class="ident" id="3584257">WriteString</span><span class="op" id="3584268">(</span><span class="ident" id="3584269">c</span><span class="op" id="3584270">.</span><span class="ident" id="3584271">rwc</span><span class="op" id="3584274">,</span>&nbsp;<span class="string" id="3584276">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3584310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584315">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584323">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584328">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584361">req</span>&nbsp;<span class="op" id="3584365">:=</span>&nbsp;<span class="ident" id="3584368">w</span><span class="op" id="3584369">.</span><span class="ident" id="3584370">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584376">if</span>&nbsp;<span class="ident" id="3584379">req</span><span class="op" id="3584382">.</span><span class="ident" id="3584383">expectsContinue</span><span class="op" id="3584398">(</span><span class="op" id="3584399">)</span>&nbsp;<span class="op" id="3584401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584406">if</span>&nbsp;<span class="ident" id="3584409">req</span><span class="op" id="3584412">.</span><span class="ident" id="3584413">ProtoAtLeast</span><span class="op" id="3584425">(</span><span class="num" id="3584426">1</span><span class="op" id="3584427">,</span>&nbsp;<span class="num" id="3584429">1</span><span class="op" id="3584430">)</span>&nbsp;<span class="op" id="3584432">&amp;&amp;</span>&nbsp;<span class="ident" id="3584435">req</span><span class="op" id="3584438">.</span><span class="ident" id="3584439">ContentLength</span>&nbsp;<span class="op" id="3584453">!=</span>&nbsp;<span class="num" id="3584456">0</span>&nbsp;<span class="op" id="3584458">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584464">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584532">req</span><span class="op" id="3584535">.</span><span class="ident" id="3584536">Body</span>&nbsp;<span class="op" id="3584541">=</span>&nbsp;<span class="op" id="3584543">&amp;</span><span class="ident" id="3584544">expectContinueReader</span><span class="op" id="3584564">{</span><span class="ident" id="3584565">readCloser</span><span class="op" id="3584575">:</span>&nbsp;<span class="ident" id="3584577">req</span><span class="op" id="3584580">.</span><span class="ident" id="3584581">Body</span><span class="op" id="3584585">,</span>&nbsp;<span class="ident" id="3584587">resp</span><span class="op" id="3584591">:</span>&nbsp;<span class="ident" id="3584593">w</span><span class="op" id="3584594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584604">req</span><span class="op" id="3584607">.</span><span class="ident" id="3584608">Header</span><span class="op" id="3584614">.</span><span class="ident" id="3584615">Del</span><span class="op" id="3584618">(</span><span class="string" id="3584619">&#34;Expect&#34;</span><span class="op" id="3584627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584631">}</span>&nbsp;<span class="keyword" id="3584633">else</span>&nbsp;<span class="keyword" id="3584638">if</span>&nbsp;<span class="ident" id="3584641">req</span><span class="op" id="3584644">.</span><span class="ident" id="3584645">Header</span><span class="op" id="3584651">.</span><span class="ident" id="3584652">get</span><span class="op" id="3584655">(</span><span class="string" id="3584656">&#34;Expect&#34;</span><span class="op" id="3584664">)</span>&nbsp;<span class="op" id="3584666">!=</span>&nbsp;<span class="string" id="3584669">&#34;&#34;</span>&nbsp;<span class="op" id="3584672">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584677">w</span><span class="op" id="3584678">.</span><span class="ident" id="3584679">sendExpectationFailed</span><span class="op" id="3584700">(</span><span class="op" id="3584701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3584706">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3584714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584719">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584783">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584853">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584913">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584989">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585053">serverHandler</span><span class="op" id="3585066">{</span><span class="ident" id="3585067">c</span><span class="op" id="3585068">.</span><span class="ident" id="3585069">server</span><span class="op" id="3585075">}</span><span class="op" id="3585076">.</span><span class="ident" id="3585077">ServeHTTP</span><span class="op" id="3585086">(</span><span class="ident" id="3585087">w</span><span class="op" id="3585088">,</span>&nbsp;<span class="ident" id="3585090">w</span><span class="op" id="3585091">.</span><span class="ident" id="3585092">req</span><span class="op" id="3585095">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585099">if</span>&nbsp;<span class="ident" id="3585102">c</span><span class="op" id="3585103">.</span><span class="ident" id="3585104">hijacked</span><span class="op" id="3585112">(</span><span class="op" id="3585113">)</span>&nbsp;<span class="op" id="3585115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585120">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585133">w</span><span class="op" id="3585134">.</span><span class="ident" id="3585135">finishRequest</span><span class="op" id="3585148">(</span><span class="op" id="3585149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585153">if</span>&nbsp;<span class="ident" id="3585156">w</span><span class="op" id="3585157">.</span><span class="ident" id="3585158">closeAfterReply</span>&nbsp;<span class="op" id="3585174">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585179">if</span>&nbsp;<span class="ident" id="3585182">w</span><span class="op" id="3585183">.</span><span class="ident" id="3585184">requestBodyLimitHit</span>&nbsp;<span class="op" id="3585204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585210">c</span><span class="op" id="3585211">.</span><span class="ident" id="3585212">closeWriteAndWait</span><span class="op" id="3585229">(</span><span class="op" id="3585230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3585240">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585248">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585252">c</span><span class="op" id="3585253">.</span><span class="ident" id="3585254">setState</span><span class="op" id="3585262">(</span><span class="ident" id="3585263">c</span><span class="op" id="3585264">.</span><span class="ident" id="3585265">rwc</span><span class="op" id="3585268">,</span>&nbsp;<span class="ident" id="3585270">StateIdle</span><span class="op" id="3585279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3585282">}</span><br>
<span class="lineno"></span><span class="op" id="3585284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3585287">func</span>&nbsp;<span class="op" id="3585292">(</span><span class="ident" id="3585293">w</span>&nbsp;<span class="op" id="3585295">*</span><span class="ident" id="3585296">response</span><span class="op" id="3585304">)</span>&nbsp;<span class="ident" id="3585306">sendExpectationFailed</span><span class="op" id="3585327">(</span><span class="op" id="3585328">)</span>&nbsp;<span class="op" id="3585330">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585333">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585383">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585436">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585486">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585536">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585576">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585620">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585624">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585678">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585728">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585775">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585823">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585876">w</span><span class="op" id="3585877">.</span><span class="ident" id="3585878">Header</span><span class="op" id="3585884">(</span><span class="op" id="3585885">)</span><span class="op" id="3585886">.</span><span class="ident" id="3585887">Set</span><span class="op" id="3585890">(</span><span class="string" id="3585891">&#34;Connection&#34;</span><span class="op" id="3585903">,</span>&nbsp;<span class="string" id="3585905">&#34;close&#34;</span><span class="op" id="3585912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585915">w</span><span class="op" id="3585916">.</span><span class="ident" id="3585917">WriteHeader</span><span class="op" id="3585928">(</span><span class="ident" id="3585929">StatusExpectationFailed</span><span class="op" id="3585952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585955">w</span><span class="op" id="3585956">.</span><span class="ident" id="3585957">finishRequest</span><span class="op" id="3585970">(</span><span class="op" id="3585971">)</span><br>
<span class="lineno">1235</span><span class="op" id="3585973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3585976">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3586063">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3586082">func</span>&nbsp;<span class="op" id="3586087">(</span><span class="ident" id="3586088">w</span>&nbsp;<span class="op" id="3586090">*</span><span class="ident" id="3586091">response</span><span class="op" id="3586099">)</span>&nbsp;<span class="ident" id="3586101">Hijack</span><span class="op" id="3586107">(</span><span class="op" id="3586108">)</span>&nbsp;<span class="op" id="3586110">(</span><span class="ident" id="3586111">rwc</span>&nbsp;<span class="ident" id="3586115">net</span><span class="op" id="3586118">.</span><span class="ident" id="3586119">Conn</span><span class="op" id="3586123">,</span>&nbsp;<span class="ident" id="3586125">buf</span>&nbsp;<span class="op" id="3586129">*</span><span class="ident" id="3586130">bufio</span><span class="op" id="3586135">.</span><span class="ident" id="3586136">ReadWriter</span><span class="op" id="3586146">,</span>&nbsp;<span class="ident" id="3586148">err</span>&nbsp;<span class="builtintype" id="3586152">error</span><span class="op" id="3586157">)</span>&nbsp;<span class="op" id="3586159">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586162">if</span>&nbsp;<span class="ident" id="3586165">w</span><span class="op" id="3586166">.</span><span class="ident" id="3586167">wroteHeader</span>&nbsp;<span class="op" id="3586179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586183">w</span><span class="op" id="3586184">.</span><span class="ident" id="3586185">cw</span><span class="op" id="3586187">.</span><span class="ident" id="3586188">flush</span><span class="op" id="3586193">(</span><span class="op" id="3586194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3586197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586200">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586271">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586318">rwc</span><span class="op" id="3586321">,</span>&nbsp;<span class="ident" id="3586323">buf</span><span class="op" id="3586326">,</span>&nbsp;<span class="ident" id="3586328">err</span>&nbsp;<span class="op" id="3586332">=</span>&nbsp;<span class="ident" id="3586334">w</span><span class="op" id="3586335">.</span><span class="ident" id="3586336">conn</span><span class="op" id="3586340">.</span><span class="ident" id="3586341">hijack</span><span class="op" id="3586347">(</span><span class="op" id="3586348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586351">if</span>&nbsp;<span class="ident" id="3586354">err</span>&nbsp;<span class="op" id="3586358">==</span>&nbsp;<span class="builtintype" id="3586361">nil</span>&nbsp;<span class="op" id="3586365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586369">putBufioWriter</span><span class="op" id="3586383">(</span><span class="ident" id="3586384">w</span><span class="op" id="3586385">.</span><span class="ident" id="3586386">w</span><span class="op" id="3586387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586391">w</span><span class="op" id="3586392">.</span><span class="ident" id="3586393">w</span>&nbsp;<span class="op" id="3586395">=</span>&nbsp;<span class="builtintype" id="3586397">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3586402">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586405">return</span>&nbsp;<span class="ident" id="3586412">rwc</span><span class="op" id="3586415">,</span>&nbsp;<span class="ident" id="3586417">buf</span><span class="op" id="3586420">,</span>&nbsp;<span class="ident" id="3586422">err</span><br>
<span class="lineno"></span><span class="op" id="3586426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3586429">func</span>&nbsp;<span class="op" id="3586434">(</span><span class="ident" id="3586435">w</span>&nbsp;<span class="op" id="3586437">*</span><span class="ident" id="3586438">response</span><span class="op" id="3586446">)</span>&nbsp;<span class="ident" id="3586448">CloseNotify</span><span class="op" id="3586459">(</span><span class="op" id="3586460">)</span>&nbsp;<span class="op" id="3586462">&lt;-</span><span class="keyword" id="3586464">chan</span>&nbsp;<span class="builtintype" id="3586469">bool</span>&nbsp;<span class="op" id="3586474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586477">return</span>&nbsp;<span class="ident" id="3586484">w</span><span class="op" id="3586485">.</span><span class="ident" id="3586486">conn</span><span class="op" id="3586490">.</span><span class="ident" id="3586491">closeNotify</span><span class="op" id="3586502">(</span><span class="op" id="3586503">)</span><br>
<span class="lineno">1255</span><span class="op" id="3586505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586508">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3586566">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3586626">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3586681">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3586713">type</span>&nbsp;<span class="ident" id="3586718">HandlerFunc</span>&nbsp;<span class="keyword" id="3586730">func</span><span class="op" id="3586734">(</span><span class="ident" id="3586735">ResponseWriter</span><span class="op" id="3586749">,</span>&nbsp;<span class="op" id="3586751">*</span><span class="ident" id="3586752">Request</span><span class="op" id="3586759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586762">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3586790">func</span>&nbsp;<span class="op" id="3586795">(</span><span class="ident" id="3586796">f</span>&nbsp;<span class="ident" id="3586798">HandlerFunc</span><span class="op" id="3586809">)</span>&nbsp;<span class="ident" id="3586811">ServeHTTP</span><span class="op" id="3586820">(</span><span class="ident" id="3586821">w</span>&nbsp;<span class="ident" id="3586823">ResponseWriter</span><span class="op" id="3586837">,</span>&nbsp;<span class="ident" id="3586839">r</span>&nbsp;<span class="op" id="3586841">*</span><span class="ident" id="3586842">Request</span><span class="op" id="3586849">)</span>&nbsp;<span class="op" id="3586851">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586854">f</span><span class="op" id="3586855">(</span><span class="ident" id="3586856">w</span><span class="op" id="3586857">,</span>&nbsp;<span class="ident" id="3586859">r</span><span class="op" id="3586860">)</span><br>
<span class="lineno"></span><span class="op" id="3586862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586865">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3586885">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3586965">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3587008">func</span>&nbsp;<span class="ident" id="3587013">Error</span><span class="op" id="3587018">(</span><span class="ident" id="3587019">w</span>&nbsp;<span class="ident" id="3587021">ResponseWriter</span><span class="op" id="3587035">,</span>&nbsp;<span class="builtintype" id="3587037">error</span>&nbsp;<span class="builtintype" id="3587043">string</span><span class="op" id="3587049">,</span>&nbsp;<span class="ident" id="3587051">code</span>&nbsp;<span class="builtintype" id="3587056">int</span><span class="op" id="3587059">)</span>&nbsp;<span class="op" id="3587061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587064">w</span><span class="op" id="3587065">.</span><span class="ident" id="3587066">Header</span><span class="op" id="3587072">(</span><span class="op" id="3587073">)</span><span class="op" id="3587074">.</span><span class="ident" id="3587075">Set</span><span class="op" id="3587078">(</span><span class="string" id="3587079">&#34;Content-Type&#34;</span><span class="op" id="3587093">,</span>&nbsp;<span class="string" id="3587095">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3587122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587125">w</span><span class="op" id="3587126">.</span><span class="ident" id="3587127">WriteHeader</span><span class="op" id="3587138">(</span><span class="ident" id="3587139">code</span><span class="op" id="3587143">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587146">fmt</span><span class="op" id="3587149">.</span><span class="ident" id="3587150">Fprintln</span><span class="op" id="3587158">(</span><span class="ident" id="3587159">w</span><span class="op" id="3587160">,</span>&nbsp;<span class="builtintype" id="3587162">error</span><span class="op" id="3587167">)</span><br>
<span class="lineno"></span><span class="op" id="3587169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3587172">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3587241">func</span>&nbsp;<span class="ident" id="3587246">NotFound</span><span class="op" id="3587254">(</span><span class="ident" id="3587255">w</span>&nbsp;<span class="ident" id="3587257">ResponseWriter</span><span class="op" id="3587271">,</span>&nbsp;<span class="ident" id="3587273">r</span>&nbsp;<span class="op" id="3587275">*</span><span class="ident" id="3587276">Request</span><span class="op" id="3587283">)</span>&nbsp;<span class="op" id="3587285">{</span>&nbsp;<span class="ident" id="3587287">Error</span><span class="op" id="3587292">(</span><span class="ident" id="3587293">w</span><span class="op" id="3587294">,</span>&nbsp;<span class="string" id="3587296">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3587316">,</span>&nbsp;<span class="ident" id="3587318">StatusNotFound</span><span class="op" id="3587332">)</span>&nbsp;<span class="op" id="3587334">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3587337">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3587389">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3587458">func</span>&nbsp;<span class="ident" id="3587463">NotFoundHandler</span><span class="op" id="3587478">(</span><span class="op" id="3587479">)</span>&nbsp;<span class="ident" id="3587481">Handler</span>&nbsp;<span class="op" id="3587489">{</span>&nbsp;<span class="keyword" id="3587491">return</span>&nbsp;<span class="ident" id="3587498">HandlerFunc</span><span class="op" id="3587509">(</span><span class="ident" id="3587510">NotFound</span><span class="op" id="3587518">)</span>&nbsp;<span class="op" id="3587520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3587523">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3587582">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3587642">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3587695">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3587751">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3587797">func</span>&nbsp;<span class="ident" id="3587802">StripPrefix</span><span class="op" id="3587813">(</span><span class="ident" id="3587814">prefix</span>&nbsp;<span class="builtintype" id="3587821">string</span><span class="op" id="3587827">,</span>&nbsp;<span class="ident" id="3587829">h</span>&nbsp;<span class="ident" id="3587831">Handler</span><span class="op" id="3587838">)</span>&nbsp;<span class="ident" id="3587840">Handler</span>&nbsp;<span class="op" id="3587848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587851">if</span>&nbsp;<span class="ident" id="3587854">prefix</span>&nbsp;<span class="op" id="3587861">==</span>&nbsp;<span class="string" id="3587864">&#34;&#34;</span>&nbsp;<span class="op" id="3587867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587871">return</span>&nbsp;<span class="ident" id="3587878">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587884">return</span>&nbsp;<span class="ident" id="3587891">HandlerFunc</span><span class="op" id="3587902">(</span><span class="keyword" id="3587903">func</span><span class="op" id="3587907">(</span><span class="ident" id="3587908">w</span>&nbsp;<span class="ident" id="3587910">ResponseWriter</span><span class="op" id="3587924">,</span>&nbsp;<span class="ident" id="3587926">r</span>&nbsp;<span class="op" id="3587928">*</span><span class="ident" id="3587929">Request</span><span class="op" id="3587936">)</span>&nbsp;<span class="op" id="3587938">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587942">if</span>&nbsp;<span class="ident" id="3587945">p</span>&nbsp;<span class="op" id="3587947">:=</span>&nbsp;<span class="ident" id="3587950">strings</span><span class="op" id="3587957">.</span><span class="ident" id="3587958">TrimPrefix</span><span class="op" id="3587968">(</span><span class="ident" id="3587969">r</span><span class="op" id="3587970">.</span><span class="ident" id="3587971">URL</span><span class="op" id="3587974">.</span><span class="ident" id="3587975">Path</span><span class="op" id="3587979">,</span>&nbsp;<span class="ident" id="3587981">prefix</span><span class="op" id="3587987">)</span><span class="op" id="3587988">;</span>&nbsp;<span class="builtinfunc" id="3587990">len</span><span class="op" id="3587993">(</span><span class="ident" id="3587994">p</span><span class="op" id="3587995">)</span>&nbsp;<span class="op" id="3587997">&lt;</span>&nbsp;<span class="builtinfunc" id="3587999">len</span><span class="op" id="3588002">(</span><span class="ident" id="3588003">r</span><span class="op" id="3588004">.</span><span class="ident" id="3588005">URL</span><span class="op" id="3588008">.</span><span class="ident" id="3588009">Path</span><span class="op" id="3588013">)</span>&nbsp;<span class="op" id="3588015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588020">r</span><span class="op" id="3588021">.</span><span class="ident" id="3588022">URL</span><span class="op" id="3588025">.</span><span class="ident" id="3588026">Path</span>&nbsp;<span class="op" id="3588031">=</span>&nbsp;<span class="ident" id="3588033">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588038">h</span><span class="op" id="3588039">.</span><span class="ident" id="3588040">ServeHTTP</span><span class="op" id="3588049">(</span><span class="ident" id="3588050">w</span><span class="op" id="3588051">,</span>&nbsp;<span class="ident" id="3588053">r</span><span class="op" id="3588054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588058">}</span>&nbsp;<span class="keyword" id="3588060">else</span>&nbsp;<span class="op" id="3588065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588070">NotFound</span><span class="op" id="3588078">(</span><span class="ident" id="3588079">w</span><span class="op" id="3588080">,</span>&nbsp;<span class="ident" id="3588082">r</span><span class="op" id="3588083">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588090">}</span><span class="op" id="3588091">)</span><br>
<span class="lineno"></span><span class="op" id="3588093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3588096">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3588155">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3588208">func</span>&nbsp;<span class="ident" id="3588213">Redirect</span><span class="op" id="3588221">(</span><span class="ident" id="3588222">w</span>&nbsp;<span class="ident" id="3588224">ResponseWriter</span><span class="op" id="3588238">,</span>&nbsp;<span class="ident" id="3588240">r</span>&nbsp;<span class="op" id="3588242">*</span><span class="ident" id="3588243">Request</span><span class="op" id="3588250">,</span>&nbsp;<span class="ident" id="3588252">urlStr</span>&nbsp;<span class="builtintype" id="3588259">string</span><span class="op" id="3588265">,</span>&nbsp;<span class="ident" id="3588267">code</span>&nbsp;<span class="builtintype" id="3588272">int</span><span class="op" id="3588275">)</span>&nbsp;<span class="op" id="3588277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588280">if</span>&nbsp;<span class="ident" id="3588283">u</span><span class="op" id="3588284">,</span>&nbsp;<span class="ident" id="3588286">err</span>&nbsp;<span class="op" id="3588290">:=</span>&nbsp;<span class="ident" id="3588293">url</span><span class="op" id="3588296">.</span><span class="ident" id="3588297">Parse</span><span class="op" id="3588302">(</span><span class="ident" id="3588303">urlStr</span><span class="op" id="3588309">)</span><span class="op" id="3588310">;</span>&nbsp;<span class="ident" id="3588312">err</span>&nbsp;<span class="op" id="3588316">==</span>&nbsp;<span class="builtintype" id="3588319">nil</span>&nbsp;<span class="op" id="3588323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588327">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588370">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588404">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588452">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588499">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588547">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588587">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588627">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588662">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588704">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588749">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588797">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588844">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588896">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588949">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588964">oldpath</span>&nbsp;<span class="op" id="3588972">:=</span>&nbsp;<span class="ident" id="3588975">r</span><span class="op" id="3588976">.</span><span class="ident" id="3588977">URL</span><span class="op" id="3588980">.</span><span class="ident" id="3588981">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588988">if</span>&nbsp;<span class="ident" id="3588991">oldpath</span>&nbsp;<span class="op" id="3588999">==</span>&nbsp;<span class="string" id="3589002">&#34;&#34;</span>&nbsp;<span class="op" id="3589005">{</span>&nbsp;<span class="comment" id="3589007">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589061">oldpath</span>&nbsp;<span class="op" id="3589069">=</span>&nbsp;<span class="string" id="3589071">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589081">if</span>&nbsp;<span class="ident" id="3589084">u</span><span class="op" id="3589085">.</span><span class="ident" id="3589086">Scheme</span>&nbsp;<span class="op" id="3589093">==</span>&nbsp;<span class="string" id="3589096">&#34;&#34;</span>&nbsp;<span class="op" id="3589099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589104">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589135">if</span>&nbsp;<span class="ident" id="3589138">urlStr</span>&nbsp;<span class="op" id="3589145">==</span>&nbsp;<span class="string" id="3589148">&#34;&#34;</span>&nbsp;<span class="op" id="3589151">||</span>&nbsp;<span class="ident" id="3589154">urlStr</span><span class="op" id="3589160">[</span><span class="num" id="3589161">0</span><span class="op" id="3589162">]</span>&nbsp;<span class="op" id="3589164">!=</span>&nbsp;<span class="string" id="3589167">&#39;/&#39;</span>&nbsp;<span class="op" id="3589171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589177">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589212">olddir</span><span class="op" id="3589218">,</span>&nbsp;<span class="ident" id="3589220">_</span>&nbsp;<span class="op" id="3589222">:=</span>&nbsp;<span class="ident" id="3589225">path</span><span class="op" id="3589229">.</span><span class="ident" id="3589230">Split</span><span class="op" id="3589235">(</span><span class="ident" id="3589236">oldpath</span><span class="op" id="3589243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589249">urlStr</span>&nbsp;<span class="op" id="3589256">=</span>&nbsp;<span class="ident" id="3589258">olddir</span>&nbsp;<span class="op" id="3589265">+</span>&nbsp;<span class="ident" id="3589267">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589277">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589283">var</span>&nbsp;<span class="ident" id="3589287">query</span>&nbsp;<span class="builtintype" id="3589293">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589303">if</span>&nbsp;<span class="ident" id="3589306">i</span>&nbsp;<span class="op" id="3589308">:=</span>&nbsp;<span class="ident" id="3589311">strings</span><span class="op" id="3589318">.</span><span class="ident" id="3589319">Index</span><span class="op" id="3589324">(</span><span class="ident" id="3589325">urlStr</span><span class="op" id="3589331">,</span>&nbsp;<span class="string" id="3589333">&#34;?&#34;</span><span class="op" id="3589336">)</span><span class="op" id="3589337">;</span>&nbsp;<span class="ident" id="3589339">i</span>&nbsp;<span class="op" id="3589341">!=</span>&nbsp;<span class="op" id="3589344">-</span><span class="num" id="3589345">1</span>&nbsp;<span class="op" id="3589347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589353">urlStr</span><span class="op" id="3589359">,</span>&nbsp;<span class="ident" id="3589361">query</span>&nbsp;<span class="op" id="3589367">=</span>&nbsp;<span class="ident" id="3589369">urlStr</span><span class="op" id="3589375">[</span><span class="op" id="3589376">:</span><span class="ident" id="3589377">i</span><span class="op" id="3589378">]</span><span class="op" id="3589379">,</span>&nbsp;<span class="ident" id="3589381">urlStr</span><span class="op" id="3589387">[</span><span class="ident" id="3589388">i</span><span class="op" id="3589389">:</span><span class="op" id="3589390">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589395">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589401">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589444">trailing</span>&nbsp;<span class="op" id="3589453">:=</span>&nbsp;<span class="ident" id="3589456">strings</span><span class="op" id="3589463">.</span><span class="ident" id="3589464">HasSuffix</span><span class="op" id="3589473">(</span><span class="ident" id="3589474">urlStr</span><span class="op" id="3589480">,</span>&nbsp;<span class="string" id="3589482">&#34;/&#34;</span><span class="op" id="3589485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589490">urlStr</span>&nbsp;<span class="op" id="3589497">=</span>&nbsp;<span class="ident" id="3589499">path</span><span class="op" id="3589503">.</span><span class="ident" id="3589504">Clean</span><span class="op" id="3589509">(</span><span class="ident" id="3589510">urlStr</span><span class="op" id="3589516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589521">if</span>&nbsp;<span class="ident" id="3589524">trailing</span>&nbsp;<span class="op" id="3589533">&amp;&amp;</span>&nbsp;<span class="op" id="3589536">!</span><span class="ident" id="3589537">strings</span><span class="op" id="3589544">.</span><span class="ident" id="3589545">HasSuffix</span><span class="op" id="3589554">(</span><span class="ident" id="3589555">urlStr</span><span class="op" id="3589561">,</span>&nbsp;<span class="string" id="3589563">&#34;/&#34;</span><span class="op" id="3589566">)</span>&nbsp;<span class="op" id="3589568">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589574">urlStr</span>&nbsp;<span class="op" id="3589581">+=</span>&nbsp;<span class="string" id="3589584">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589596">urlStr</span>&nbsp;<span class="op" id="3589603">+=</span>&nbsp;<span class="ident" id="3589606">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589617">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589621">w</span><span class="op" id="3589622">.</span><span class="ident" id="3589623">Header</span><span class="op" id="3589629">(</span><span class="op" id="3589630">)</span><span class="op" id="3589631">.</span><span class="ident" id="3589632">Set</span><span class="op" id="3589635">(</span><span class="string" id="3589636">&#34;Location&#34;</span><span class="op" id="3589646">,</span>&nbsp;<span class="ident" id="3589648">urlStr</span><span class="op" id="3589654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589657">w</span><span class="op" id="3589658">.</span><span class="ident" id="3589659">WriteHeader</span><span class="op" id="3589670">(</span><span class="ident" id="3589671">code</span><span class="op" id="3589675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589679">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589748">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589815">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589882">if</span>&nbsp;<span class="ident" id="3589885">r</span><span class="op" id="3589886">.</span><span class="ident" id="3589887">Method</span>&nbsp;<span class="op" id="3589894">==</span>&nbsp;<span class="string" id="3589897">&#34;GET&#34;</span>&nbsp;<span class="op" id="3589903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589907">note</span>&nbsp;<span class="op" id="3589912">:=</span>&nbsp;<span class="string" id="3589915">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3589928">+</span>&nbsp;<span class="ident" id="3589930">htmlEscape</span><span class="op" id="3589940">(</span><span class="ident" id="3589941">urlStr</span><span class="op" id="3589947">)</span>&nbsp;<span class="op" id="3589949">+</span>&nbsp;<span class="string" id="3589951">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3589957">+</span>&nbsp;<span class="ident" id="3589959">statusText</span><span class="op" id="3589969">[</span><span class="ident" id="3589970">code</span><span class="op" id="3589974">]</span>&nbsp;<span class="op" id="3589976">+</span>&nbsp;<span class="string" id="3589978">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589990">fmt</span><span class="op" id="3589993">.</span><span class="ident" id="3589994">Fprintln</span><span class="op" id="3590002">(</span><span class="ident" id="3590003">w</span><span class="op" id="3590004">,</span>&nbsp;<span class="ident" id="3590006">note</span><span class="op" id="3590010">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590013">}</span><br>
<span class="lineno"></span><span class="op" id="3590015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3590018">var</span>&nbsp;<span class="ident" id="3590022">htmlReplacer</span>&nbsp;<span class="op" id="3590035">=</span>&nbsp;<span class="ident" id="3590037">strings</span><span class="op" id="3590044">.</span><span class="ident" id="3590045">NewReplacer</span><span class="op" id="3590056">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3590059">&#34;&amp;&#34;</span><span class="op" id="3590062">,</span>&nbsp;<span class="string" id="3590064">&#34;&amp;amp;&#34;</span><span class="op" id="3590071">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3590074">&#34;&lt;&#34;</span><span class="op" id="3590077">,</span>&nbsp;<span class="string" id="3590079">&#34;&amp;lt;&#34;</span><span class="op" id="3590085">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3590088">&#34;&gt;&#34;</span><span class="op" id="3590091">,</span>&nbsp;<span class="string" id="3590093">&#34;&amp;gt;&#34;</span><span class="op" id="3590099">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590102">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3590140">`&#34;`</span><span class="op" id="3590143">,</span>&nbsp;<span class="string" id="3590145">&#34;&amp;#34;&#34;</span><span class="op" id="3590152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590155">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3590230">&#34;&#39;&#34;</span><span class="op" id="3590233">,</span>&nbsp;<span class="string" id="3590235">&#34;&amp;#39;&#34;</span><span class="op" id="3590242">,</span><br>
<span class="lineno"></span><span class="op" id="3590244">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3590247">func</span>&nbsp;<span class="ident" id="3590252">htmlEscape</span><span class="op" id="3590262">(</span><span class="ident" id="3590263">s</span>&nbsp;<span class="builtintype" id="3590265">string</span><span class="op" id="3590271">)</span>&nbsp;<span class="builtintype" id="3590273">string</span>&nbsp;<span class="op" id="3590280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590283">return</span>&nbsp;<span class="ident" id="3590290">htmlReplacer</span><span class="op" id="3590302">.</span><span class="ident" id="3590303">Replace</span><span class="op" id="3590310">(</span><span class="ident" id="3590311">s</span><span class="op" id="3590312">)</span><br>
<span class="lineno">1375</span><span class="op" id="3590314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590317">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3590344">type</span>&nbsp;<span class="ident" id="3590349">redirectHandler</span>&nbsp;<span class="keyword" id="3590365">struct</span>&nbsp;<span class="op" id="3590372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590375">url</span>&nbsp;&nbsp;<span class="builtintype" id="3590380">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590388">code</span>&nbsp;<span class="builtintype" id="3590393">int</span><br>
<span class="lineno"></span><span class="op" id="3590397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3590400">func</span>&nbsp;<span class="op" id="3590405">(</span><span class="ident" id="3590406">rh</span>&nbsp;<span class="op" id="3590409">*</span><span class="ident" id="3590410">redirectHandler</span><span class="op" id="3590425">)</span>&nbsp;<span class="ident" id="3590427">ServeHTTP</span><span class="op" id="3590436">(</span><span class="ident" id="3590437">w</span>&nbsp;<span class="ident" id="3590439">ResponseWriter</span><span class="op" id="3590453">,</span>&nbsp;<span class="ident" id="3590455">r</span>&nbsp;<span class="op" id="3590457">*</span><span class="ident" id="3590458">Request</span><span class="op" id="3590465">)</span>&nbsp;<span class="op" id="3590467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590470">Redirect</span><span class="op" id="3590478">(</span><span class="ident" id="3590479">w</span><span class="op" id="3590480">,</span>&nbsp;<span class="ident" id="3590482">r</span><span class="op" id="3590483">,</span>&nbsp;<span class="ident" id="3590485">rh</span><span class="op" id="3590487">.</span><span class="ident" id="3590488">url</span><span class="op" id="3590491">,</span>&nbsp;<span class="ident" id="3590493">rh</span><span class="op" id="3590495">.</span><span class="ident" id="3590496">code</span><span class="op" id="3590500">)</span><br>
<span class="lineno">1385</span><span class="op" id="3590502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590505">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3590565">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3590626">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3590642">func</span>&nbsp;<span class="ident" id="3590647">RedirectHandler</span><span class="op" id="3590662">(</span><span class="ident" id="3590663">url</span>&nbsp;<span class="builtintype" id="3590667">string</span><span class="op" id="3590673">,</span>&nbsp;<span class="ident" id="3590675">code</span>&nbsp;<span class="builtintype" id="3590680">int</span><span class="op" id="3590683">)</span>&nbsp;<span class="ident" id="3590685">Handler</span>&nbsp;<span class="op" id="3590693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590696">return</span>&nbsp;<span class="op" id="3590703">&amp;</span><span class="ident" id="3590704">redirectHandler</span><span class="op" id="3590719">{</span><span class="ident" id="3590720">url</span><span class="op" id="3590723">,</span>&nbsp;<span class="ident" id="3590725">code</span><span class="op" id="3590729">}</span><br>
<span class="lineno"></span><span class="op" id="3590731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590734">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3590778">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3590854">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3590909">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3590942">//</span><br>
<span class="lineno"></span><span class="comment" id="3590945">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3591004">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3591070">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3591132">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3591188">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3591245">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3591305">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3591364">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3591387">//</span><br>
<span class="lineno"></span><span class="comment" id="3591390">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3591461">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3591530">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3591578">//</span><br>
<span class="lineno"></span><span class="comment" id="3591581">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3591655">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3591727">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3591802">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3591873">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3591915">//</span><br>
<span class="lineno"></span><span class="comment" id="3591918">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3591982">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3592043">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3592077">type</span>&nbsp;<span class="ident" id="3592082">ServeMux</span>&nbsp;<span class="keyword" id="3592091">struct</span>&nbsp;<span class="op" id="3592098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592101">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592107">sync</span><span class="op" id="3592111">.</span><span class="ident" id="3592112">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592121">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592127">map</span><span class="op" id="3592130">[</span><span class="builtintype" id="3592131">string</span><span class="op" id="3592137">]</span><span class="ident" id="3592138">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592148">hosts</span>&nbsp;<span class="builtintype" id="3592154">bool</span>&nbsp;<span class="comment" id="3592159">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3592201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3592204">type</span>&nbsp;<span class="ident" id="3592209">muxEntry</span>&nbsp;<span class="keyword" id="3592218">struct</span>&nbsp;<span class="op" id="3592225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592228">explicit</span>&nbsp;<span class="builtintype" id="3592237">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592243">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592252">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592261">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3592270">string</span><br>
<span class="lineno"></span><span class="op" id="3592277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592280">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3592333">func</span>&nbsp;<span class="ident" id="3592338">NewServeMux</span><span class="op" id="3592349">(</span><span class="op" id="3592350">)</span>&nbsp;<span class="op" id="3592352">*</span><span class="ident" id="3592353">ServeMux</span>&nbsp;<span class="op" id="3592362">{</span>&nbsp;<span class="keyword" id="3592364">return</span>&nbsp;<span class="op" id="3592371">&amp;</span><span class="ident" id="3592372">ServeMux</span><span class="op" id="3592380">{</span><span class="ident" id="3592381">m</span><span class="op" id="3592382">:</span>&nbsp;<span class="builtinfunc" id="3592384">make</span><span class="op" id="3592388">(</span><span class="keyword" id="3592389">map</span><span class="op" id="3592392">[</span><span class="builtintype" id="3592393">string</span><span class="op" id="3592399">]</span><span class="ident" id="3592400">muxEntry</span><span class="op" id="3592408">)</span><span class="op" id="3592409">}</span>&nbsp;<span class="op" id="3592411">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3592414">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3592472">var</span>&nbsp;<span class="ident" id="3592476">DefaultServeMux</span>&nbsp;<span class="op" id="3592492">=</span>&nbsp;<span class="ident" id="3592494">NewServeMux</span><span class="op" id="3592505">(</span><span class="op" id="3592506">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592509">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3592537">func</span>&nbsp;<span class="ident" id="3592542">pathMatch</span><span class="op" id="3592551">(</span><span class="ident" id="3592552">pattern</span><span class="op" id="3592559">,</span>&nbsp;<span class="ident" id="3592561">path</span>&nbsp;<span class="builtintype" id="3592566">string</span><span class="op" id="3592572">)</span>&nbsp;<span class="builtintype" id="3592574">bool</span>&nbsp;<span class="op" id="3592579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592582">if</span>&nbsp;<span class="builtinfunc" id="3592585">len</span><span class="op" id="3592588">(</span><span class="ident" id="3592589">pattern</span><span class="op" id="3592596">)</span>&nbsp;<span class="op" id="3592598">==</span>&nbsp;<span class="num" id="3592601">0</span>&nbsp;<span class="op" id="3592603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592607">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592630">return</span>&nbsp;<span class="builtintype" id="3592637">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592644">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592647">n</span>&nbsp;<span class="op" id="3592649">:=</span>&nbsp;<span class="builtinfunc" id="3592652">len</span><span class="op" id="3592655">(</span><span class="ident" id="3592656">pattern</span><span class="op" id="3592663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592666">if</span>&nbsp;<span class="ident" id="3592669">pattern</span><span class="op" id="3592676">[</span><span class="ident" id="3592677">n</span><span class="op" id="3592678">-</span><span class="num" id="3592679">1</span><span class="op" id="3592680">]</span>&nbsp;<span class="op" id="3592682">!=</span>&nbsp;<span class="string" id="3592685">&#39;/&#39;</span>&nbsp;<span class="op" id="3592689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592693">return</span>&nbsp;<span class="ident" id="3592700">pattern</span>&nbsp;<span class="op" id="3592708">==</span>&nbsp;<span class="ident" id="3592711">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592720">return</span>&nbsp;<span class="builtinfunc" id="3592727">len</span><span class="op" id="3592730">(</span><span class="ident" id="3592731">path</span><span class="op" id="3592735">)</span>&nbsp;<span class="op" id="3592737">&gt;=</span>&nbsp;<span class="ident" id="3592740">n</span>&nbsp;<span class="op" id="3592742">&amp;&amp;</span>&nbsp;<span class="ident" id="3592745">path</span><span class="op" id="3592749">[</span><span class="num" id="3592750">0</span><span class="op" id="3592751">:</span><span class="ident" id="3592752">n</span><span class="op" id="3592753">]</span>&nbsp;<span class="op" id="3592755">==</span>&nbsp;<span class="ident" id="3592758">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3592766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592769">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3592836">func</span>&nbsp;<span class="ident" id="3592841">cleanPath</span><span class="op" id="3592850">(</span><span class="ident" id="3592851">p</span>&nbsp;<span class="builtintype" id="3592853">string</span><span class="op" id="3592859">)</span>&nbsp;<span class="builtintype" id="3592861">string</span>&nbsp;<span class="op" id="3592868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592871">if</span>&nbsp;<span class="ident" id="3592874">p</span>&nbsp;<span class="op" id="3592876">==</span>&nbsp;<span class="string" id="3592879">&#34;&#34;</span>&nbsp;<span class="op" id="3592882">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592886">return</span>&nbsp;<span class="string" id="3592893">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592901">if</span>&nbsp;<span class="ident" id="3592904">p</span><span class="op" id="3592905">[</span><span class="num" id="3592906">0</span><span class="op" id="3592907">]</span>&nbsp;<span class="op" id="3592909">!=</span>&nbsp;<span class="string" id="3592912">&#39;/&#39;</span>&nbsp;<span class="op" id="3592916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592920">p</span>&nbsp;<span class="op" id="3592922">=</span>&nbsp;<span class="string" id="3592924">&#34;/&#34;</span>&nbsp;<span class="op" id="3592928">+</span>&nbsp;<span class="ident" id="3592930">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592933">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592936">np</span>&nbsp;<span class="op" id="3592939">:=</span>&nbsp;<span class="ident" id="3592942">path</span><span class="op" id="3592946">.</span><span class="ident" id="3592947">Clean</span><span class="op" id="3592952">(</span><span class="ident" id="3592953">p</span><span class="op" id="3592954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3592957">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3593012">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593058">if</span>&nbsp;<span class="ident" id="3593061">p</span><span class="op" id="3593062">[</span><span class="builtinfunc" id="3593063">len</span><span class="op" id="3593066">(</span><span class="ident" id="3593067">p</span><span class="op" id="3593068">)</span><span class="op" id="3593069">-</span><span class="num" id="3593070">1</span><span class="op" id="3593071">]</span>&nbsp;<span class="op" id="3593073">==</span>&nbsp;<span class="string" id="3593076">&#39;/&#39;</span>&nbsp;<span class="op" id="3593080">&amp;&amp;</span>&nbsp;<span class="ident" id="3593083">np</span>&nbsp;<span class="op" id="3593086">!=</span>&nbsp;<span class="string" id="3593089">&#34;/&#34;</span>&nbsp;<span class="op" id="3593093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593097">np</span>&nbsp;<span class="op" id="3593100">+=</span>&nbsp;<span class="string" id="3593103">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593111">return</span>&nbsp;<span class="ident" id="3593118">np</span><br>
<span class="lineno"></span><span class="op" id="3593121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3593124">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3593179">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3593219">func</span>&nbsp;<span class="op" id="3593224">(</span><span class="ident" id="3593225">mux</span>&nbsp;<span class="op" id="3593229">*</span><span class="ident" id="3593230">ServeMux</span><span class="op" id="3593238">)</span>&nbsp;<span class="ident" id="3593240">match</span><span class="op" id="3593245">(</span><span class="ident" id="3593246">path</span>&nbsp;<span class="builtintype" id="3593251">string</span><span class="op" id="3593257">)</span>&nbsp;<span class="op" id="3593259">(</span><span class="ident" id="3593260">h</span>&nbsp;<span class="ident" id="3593262">Handler</span><span class="op" id="3593269">,</span>&nbsp;<span class="ident" id="3593271">pattern</span>&nbsp;<span class="builtintype" id="3593279">string</span><span class="op" id="3593285">)</span>&nbsp;<span class="op" id="3593287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593290">var</span>&nbsp;<span class="ident" id="3593294">n</span>&nbsp;<span class="op" id="3593296">=</span>&nbsp;<span class="num" id="3593298">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593301">for</span>&nbsp;<span class="ident" id="3593305">k</span><span class="op" id="3593306">,</span>&nbsp;<span class="ident" id="3593308">v</span>&nbsp;<span class="op" id="3593310">:=</span>&nbsp;<span class="keyword" id="3593313">range</span>&nbsp;<span class="ident" id="3593319">mux</span><span class="op" id="3593322">.</span><span class="ident" id="3593323">m</span>&nbsp;<span class="op" id="3593325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593329">if</span>&nbsp;<span class="op" id="3593332">!</span><span class="ident" id="3593333">pathMatch</span><span class="op" id="3593342">(</span><span class="ident" id="3593343">k</span><span class="op" id="3593344">,</span>&nbsp;<span class="ident" id="3593346">path</span><span class="op" id="3593350">)</span>&nbsp;<span class="op" id="3593352">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593357">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593372">if</span>&nbsp;<span class="ident" id="3593375">h</span>&nbsp;<span class="op" id="3593377">==</span>&nbsp;<span class="builtintype" id="3593380">nil</span>&nbsp;<span class="op" id="3593384">||</span>&nbsp;<span class="builtinfunc" id="3593387">len</span><span class="op" id="3593390">(</span><span class="ident" id="3593391">k</span><span class="op" id="3593392">)</span>&nbsp;<span class="op" id="3593394">&gt;</span>&nbsp;<span class="ident" id="3593396">n</span>&nbsp;<span class="op" id="3593398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593403">n</span>&nbsp;<span class="op" id="3593405">=</span>&nbsp;<span class="builtinfunc" id="3593407">len</span><span class="op" id="3593410">(</span><span class="ident" id="3593411">k</span><span class="op" id="3593412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593417">h</span>&nbsp;<span class="op" id="3593419">=</span>&nbsp;<span class="ident" id="3593421">v</span><span class="op" id="3593422">.</span><span class="ident" id="3593423">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593428">pattern</span>&nbsp;<span class="op" id="3593436">=</span>&nbsp;<span class="ident" id="3593438">v</span><span class="op" id="3593439">.</span><span class="ident" id="3593440">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593456">return</span><br>
<span class="lineno"></span><span class="op" id="3593463">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3593466">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3593527">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3593593">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3593661">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3593727">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3593753">//</span><br>
<span class="lineno"></span><span class="comment" id="3593756">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3593820">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3593882">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3593943">//</span><br>
<span class="lineno"></span><span class="comment" id="3593946">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3594012">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3594082">func</span>&nbsp;<span class="op" id="3594087">(</span><span class="ident" id="3594088">mux</span>&nbsp;<span class="op" id="3594092">*</span><span class="ident" id="3594093">ServeMux</span><span class="op" id="3594101">)</span>&nbsp;<span class="ident" id="3594103">Handler</span><span class="op" id="3594110">(</span><span class="ident" id="3594111">r</span>&nbsp;<span class="op" id="3594113">*</span><span class="ident" id="3594114">Request</span><span class="op" id="3594121">)</span>&nbsp;<span class="op" id="3594123">(</span><span class="ident" id="3594124">h</span>&nbsp;<span class="ident" id="3594126">Handler</span><span class="op" id="3594133">,</span>&nbsp;<span class="ident" id="3594135">pattern</span>&nbsp;<span class="builtintype" id="3594143">string</span><span class="op" id="3594149">)</span>&nbsp;<span class="op" id="3594151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594154">if</span>&nbsp;<span class="ident" id="3594157">r</span><span class="op" id="3594158">.</span><span class="ident" id="3594159">Method</span>&nbsp;<span class="op" id="3594166">!=</span>&nbsp;<span class="string" id="3594169">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3594179">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594183">if</span>&nbsp;<span class="ident" id="3594186">p</span>&nbsp;<span class="op" id="3594188">:=</span>&nbsp;<span class="ident" id="3594191">cleanPath</span><span class="op" id="3594200">(</span><span class="ident" id="3594201">r</span><span class="op" id="3594202">.</span><span class="ident" id="3594203">URL</span><span class="op" id="3594206">.</span><span class="ident" id="3594207">Path</span><span class="op" id="3594211">)</span><span class="op" id="3594212">;</span>&nbsp;<span class="ident" id="3594214">p</span>&nbsp;<span class="op" id="3594216">!=</span>&nbsp;<span class="ident" id="3594219">r</span><span class="op" id="3594220">.</span><span class="ident" id="3594221">URL</span><span class="op" id="3594224">.</span><span class="ident" id="3594225">Path</span>&nbsp;<span class="op" id="3594230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594235">_</span><span class="op" id="3594236">,</span>&nbsp;<span class="ident" id="3594238">pattern</span>&nbsp;<span class="op" id="3594246">=</span>&nbsp;<span class="ident" id="3594248">mux</span><span class="op" id="3594251">.</span><span class="ident" id="3594252">handler</span><span class="op" id="3594259">(</span><span class="ident" id="3594260">r</span><span class="op" id="3594261">.</span><span class="ident" id="3594262">Host</span><span class="op" id="3594266">,</span>&nbsp;<span class="ident" id="3594268">p</span><span class="op" id="3594269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594274">url</span>&nbsp;<span class="op" id="3594278">:=</span>&nbsp;<span class="op" id="3594281">*</span><span class="ident" id="3594282">r</span><span class="op" id="3594283">.</span><span class="ident" id="3594284">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594291">url</span><span class="op" id="3594294">.</span><span class="ident" id="3594295">Path</span>&nbsp;<span class="op" id="3594300">=</span>&nbsp;<span class="ident" id="3594302">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594307">return</span>&nbsp;<span class="ident" id="3594314">RedirectHandler</span><span class="op" id="3594329">(</span><span class="ident" id="3594330">url</span><span class="op" id="3594333">.</span><span class="ident" id="3594334">String</span><span class="op" id="3594340">(</span><span class="op" id="3594341">)</span><span class="op" id="3594342">,</span>&nbsp;<span class="ident" id="3594344">StatusMovedPermanently</span><span class="op" id="3594366">)</span><span class="op" id="3594367">,</span>&nbsp;<span class="ident" id="3594369">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594386">return</span>&nbsp;<span class="ident" id="3594393">mux</span><span class="op" id="3594396">.</span><span class="ident" id="3594397">handler</span><span class="op" id="3594404">(</span><span class="ident" id="3594405">r</span><span class="op" id="3594406">.</span><span class="ident" id="3594407">Host</span><span class="op" id="3594411">,</span>&nbsp;<span class="ident" id="3594413">r</span><span class="op" id="3594414">.</span><span class="ident" id="3594415">URL</span><span class="op" id="3594418">.</span><span class="ident" id="3594419">Path</span><span class="op" id="3594423">)</span><br>
<span class="lineno"></span><span class="op" id="3594425">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3594428">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3594478">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3594552">func</span>&nbsp;<span class="op" id="3594557">(</span><span class="ident" id="3594558">mux</span>&nbsp;<span class="op" id="3594562">*</span><span class="ident" id="3594563">ServeMux</span><span class="op" id="3594571">)</span>&nbsp;<span class="ident" id="3594573">handler</span><span class="op" id="3594580">(</span><span class="ident" id="3594581">host</span><span class="op" id="3594585">,</span>&nbsp;<span class="ident" id="3594587">path</span>&nbsp;<span class="builtintype" id="3594592">string</span><span class="op" id="3594598">)</span>&nbsp;<span class="op" id="3594600">(</span><span class="ident" id="3594601">h</span>&nbsp;<span class="ident" id="3594603">Handler</span><span class="op" id="3594610">,</span>&nbsp;<span class="ident" id="3594612">pattern</span>&nbsp;<span class="builtintype" id="3594620">string</span><span class="op" id="3594626">)</span>&nbsp;<span class="op" id="3594628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594631">mux</span><span class="op" id="3594634">.</span><span class="ident" id="3594635">mu</span><span class="op" id="3594637">.</span><span class="ident" id="3594638">RLock</span><span class="op" id="3594643">(</span><span class="op" id="3594644">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594647">defer</span>&nbsp;<span class="ident" id="3594653">mux</span><span class="op" id="3594656">.</span><span class="ident" id="3594657">mu</span><span class="op" id="3594659">.</span><span class="ident" id="3594660">RUnlock</span><span class="op" id="3594667">(</span><span class="op" id="3594668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3594672">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594733">if</span>&nbsp;<span class="ident" id="3594736">mux</span><span class="op" id="3594739">.</span><span class="ident" id="3594740">hosts</span>&nbsp;<span class="op" id="3594746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594750">h</span><span class="op" id="3594751">,</span>&nbsp;<span class="ident" id="3594753">pattern</span>&nbsp;<span class="op" id="3594761">=</span>&nbsp;<span class="ident" id="3594763">mux</span><span class="op" id="3594766">.</span><span class="ident" id="3594767">match</span><span class="op" id="3594772">(</span><span class="ident" id="3594773">host</span>&nbsp;<span class="op" id="3594778">+</span>&nbsp;<span class="ident" id="3594780">path</span><span class="op" id="3594784">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594790">if</span>&nbsp;<span class="ident" id="3594793">h</span>&nbsp;<span class="op" id="3594795">==</span>&nbsp;<span class="builtintype" id="3594798">nil</span>&nbsp;<span class="op" id="3594802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594806">h</span><span class="op" id="3594807">,</span>&nbsp;<span class="ident" id="3594809">pattern</span>&nbsp;<span class="op" id="3594817">=</span>&nbsp;<span class="ident" id="3594819">mux</span><span class="op" id="3594822">.</span><span class="ident" id="3594823">match</span><span class="op" id="3594828">(</span><span class="ident" id="3594829">path</span><span class="op" id="3594833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594839">if</span>&nbsp;<span class="ident" id="3594842">h</span>&nbsp;<span class="op" id="3594844">==</span>&nbsp;<span class="builtintype" id="3594847">nil</span>&nbsp;<span class="op" id="3594851">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594855">h</span><span class="op" id="3594856">,</span>&nbsp;<span class="ident" id="3594858">pattern</span>&nbsp;<span class="op" id="3594866">=</span>&nbsp;<span class="ident" id="3594868">NotFoundHandler</span><span class="op" id="3594883">(</span><span class="op" id="3594884">)</span><span class="op" id="3594885">,</span>&nbsp;<span class="string" id="3594887">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3594891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3594894">return</span><br>
<span class="lineno"></span><span class="op" id="3594901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3594904">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3594961">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3595010">func</span>&nbsp;<span class="op" id="3595015">(</span><span class="ident" id="3595016">mux</span>&nbsp;<span class="op" id="3595020">*</span><span class="ident" id="3595021">ServeMux</span><span class="op" id="3595029">)</span>&nbsp;<span class="ident" id="3595031">ServeHTTP</span><span class="op" id="3595040">(</span><span class="ident" id="3595041">w</span>&nbsp;<span class="ident" id="3595043">ResponseWriter</span><span class="op" id="3595057">,</span>&nbsp;<span class="ident" id="3595059">r</span>&nbsp;<span class="op" id="3595061">*</span><span class="ident" id="3595062">Request</span><span class="op" id="3595069">)</span>&nbsp;<span class="op" id="3595071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595074">if</span>&nbsp;<span class="ident" id="3595077">r</span><span class="op" id="3595078">.</span><span class="ident" id="3595079">RequestURI</span>&nbsp;<span class="op" id="3595090">==</span>&nbsp;<span class="string" id="3595093">&#34;*&#34;</span>&nbsp;<span class="op" id="3595097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595101">if</span>&nbsp;<span class="ident" id="3595104">r</span><span class="op" id="3595105">.</span><span class="ident" id="3595106">ProtoAtLeast</span><span class="op" id="3595118">(</span><span class="num" id="3595119">1</span><span class="op" id="3595120">,</span>&nbsp;<span class="num" id="3595122">1</span><span class="op" id="3595123">)</span>&nbsp;<span class="op" id="3595125">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595130">w</span><span class="op" id="3595131">.</span><span class="ident" id="3595132">Header</span><span class="op" id="3595138">(</span><span class="op" id="3595139">)</span><span class="op" id="3595140">.</span><span class="ident" id="3595141">Set</span><span class="op" id="3595144">(</span><span class="string" id="3595145">&#34;Connection&#34;</span><span class="op" id="3595157">,</span>&nbsp;<span class="string" id="3595159">&#34;close&#34;</span><span class="op" id="3595166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595174">w</span><span class="op" id="3595175">.</span><span class="ident" id="3595176">WriteHeader</span><span class="op" id="3595187">(</span><span class="ident" id="3595188">StatusBadRequest</span><span class="op" id="3595204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595208">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595216">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595219">h</span><span class="op" id="3595220">,</span>&nbsp;<span class="ident" id="3595222">_</span>&nbsp;<span class="op" id="3595224">:=</span>&nbsp;<span class="ident" id="3595227">mux</span><span class="op" id="3595230">.</span><span class="ident" id="3595231">Handler</span><span class="op" id="3595238">(</span><span class="ident" id="3595239">r</span><span class="op" id="3595240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595243">h</span><span class="op" id="3595244">.</span><span class="ident" id="3595245">ServeHTTP</span><span class="op" id="3595254">(</span><span class="ident" id="3595255">w</span><span class="op" id="3595256">,</span>&nbsp;<span class="ident" id="3595258">r</span><span class="op" id="3595259">)</span><br>
<span class="lineno"></span><span class="op" id="3595261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3595264">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3595319">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3595378">func</span>&nbsp;<span class="op" id="3595383">(</span><span class="ident" id="3595384">mux</span>&nbsp;<span class="op" id="3595388">*</span><span class="ident" id="3595389">ServeMux</span><span class="op" id="3595397">)</span>&nbsp;<span class="ident" id="3595399">Handle</span><span class="op" id="3595405">(</span><span class="ident" id="3595406">pattern</span>&nbsp;<span class="builtintype" id="3595414">string</span><span class="op" id="3595420">,</span>&nbsp;<span class="ident" id="3595422">handler</span>&nbsp;<span class="ident" id="3595430">Handler</span><span class="op" id="3595437">)</span>&nbsp;<span class="op" id="3595439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595442">mux</span><span class="op" id="3595445">.</span><span class="ident" id="3595446">mu</span><span class="op" id="3595448">.</span><span class="ident" id="3595449">Lock</span><span class="op" id="3595453">(</span><span class="op" id="3595454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595457">defer</span>&nbsp;<span class="ident" id="3595463">mux</span><span class="op" id="3595466">.</span><span class="ident" id="3595467">mu</span><span class="op" id="3595469">.</span><span class="ident" id="3595470">Unlock</span><span class="op" id="3595476">(</span><span class="op" id="3595477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595481">if</span>&nbsp;<span class="ident" id="3595484">pattern</span>&nbsp;<span class="op" id="3595492">==</span>&nbsp;<span class="string" id="3595495">&#34;&#34;</span>&nbsp;<span class="op" id="3595498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3595502">panic</span><span class="op" id="3595507">(</span><span class="string" id="3595508">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3595533">+</span>&nbsp;<span class="ident" id="3595535">pattern</span><span class="op" id="3595542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595548">if</span>&nbsp;<span class="ident" id="3595551">handler</span>&nbsp;<span class="op" id="3595559">==</span>&nbsp;<span class="builtintype" id="3595562">nil</span>&nbsp;<span class="op" id="3595566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3595570">panic</span><span class="op" id="3595575">(</span><span class="string" id="3595576">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3595595">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595601">if</span>&nbsp;<span class="ident" id="3595604">mux</span><span class="op" id="3595607">.</span><span class="ident" id="3595608">m</span><span class="op" id="3595609">[</span><span class="ident" id="3595610">pattern</span><span class="op" id="3595617">]</span><span class="op" id="3595618">.</span><span class="ident" id="3595619">explicit</span>&nbsp;<span class="op" id="3595628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3595632">panic</span><span class="op" id="3595637">(</span><span class="string" id="3595638">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3595674">+</span>&nbsp;<span class="ident" id="3595676">pattern</span><span class="op" id="3595683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595690">mux</span><span class="op" id="3595693">.</span><span class="ident" id="3595694">m</span><span class="op" id="3595695">[</span><span class="ident" id="3595696">pattern</span><span class="op" id="3595703">]</span>&nbsp;<span class="op" id="3595705">=</span>&nbsp;<span class="ident" id="3595707">muxEntry</span><span class="op" id="3595715">{</span><span class="ident" id="3595716">explicit</span><span class="op" id="3595724">:</span>&nbsp;<span class="builtintype" id="3595726">true</span><span class="op" id="3595730">,</span>&nbsp;<span class="ident" id="3595732">h</span><span class="op" id="3595733">:</span>&nbsp;<span class="ident" id="3595735">handler</span><span class="op" id="3595742">,</span>&nbsp;<span class="ident" id="3595744">pattern</span><span class="op" id="3595751">:</span>&nbsp;<span class="ident" id="3595753">pattern</span><span class="op" id="3595760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595764">if</span>&nbsp;<span class="ident" id="3595767">pattern</span><span class="op" id="3595774">[</span><span class="num" id="3595775">0</span><span class="op" id="3595776">]</span>&nbsp;<span class="op" id="3595778">!=</span>&nbsp;<span class="string" id="3595781">&#39;/&#39;</span>&nbsp;<span class="op" id="3595785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595789">mux</span><span class="op" id="3595792">.</span><span class="ident" id="3595793">hosts</span>&nbsp;<span class="op" id="3595799">=</span>&nbsp;<span class="builtintype" id="3595801">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595807">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3595811">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3595833">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3595908">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595962">n</span>&nbsp;<span class="op" id="3595964">:=</span>&nbsp;<span class="builtinfunc" id="3595967">len</span><span class="op" id="3595970">(</span><span class="ident" id="3595971">pattern</span><span class="op" id="3595978">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3595981">if</span>&nbsp;<span class="ident" id="3595984">n</span>&nbsp;<span class="op" id="3595986">&gt;</span>&nbsp;<span class="num" id="3595988">0</span>&nbsp;<span class="op" id="3595990">&amp;&amp;</span>&nbsp;<span class="ident" id="3595993">pattern</span><span class="op" id="3596000">[</span><span class="ident" id="3596001">n</span><span class="op" id="3596002">-</span><span class="num" id="3596003">1</span><span class="op" id="3596004">]</span>&nbsp;<span class="op" id="3596006">==</span>&nbsp;<span class="string" id="3596009">&#39;/&#39;</span>&nbsp;<span class="op" id="3596013">&amp;&amp;</span>&nbsp;<span class="op" id="3596016">!</span><span class="ident" id="3596017">mux</span><span class="op" id="3596020">.</span><span class="ident" id="3596021">m</span><span class="op" id="3596022">[</span><span class="ident" id="3596023">pattern</span><span class="op" id="3596030">[</span><span class="num" id="3596031">0</span><span class="op" id="3596032">:</span><span class="ident" id="3596033">n</span><span class="op" id="3596034">-</span><span class="num" id="3596035">1</span><span class="op" id="3596036">]</span><span class="op" id="3596037">]</span><span class="op" id="3596038">.</span><span class="ident" id="3596039">explicit</span>&nbsp;<span class="op" id="3596048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596052">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596117">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596141">path</span>&nbsp;<span class="op" id="3596146">:=</span>&nbsp;<span class="ident" id="3596149">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3596159">if</span>&nbsp;<span class="ident" id="3596162">pattern</span><span class="op" id="3596169">[</span><span class="num" id="3596170">0</span><span class="op" id="3596171">]</span>&nbsp;<span class="op" id="3596173">!=</span>&nbsp;<span class="string" id="3596176">&#39;/&#39;</span>&nbsp;<span class="op" id="3596180">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596185">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596244">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596277">path</span>&nbsp;<span class="op" id="3596282">=</span>&nbsp;<span class="ident" id="3596284">pattern</span><span class="op" id="3596291">[</span><span class="ident" id="3596292">strings</span><span class="op" id="3596299">.</span><span class="ident" id="3596300">Index</span><span class="op" id="3596305">(</span><span class="ident" id="3596306">pattern</span><span class="op" id="3596313">,</span>&nbsp;<span class="string" id="3596315">&#34;/&#34;</span><span class="op" id="3596318">)</span><span class="op" id="3596319">:</span><span class="op" id="3596320">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3596324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596328">mux</span><span class="op" id="3596331">.</span><span class="ident" id="3596332">m</span><span class="op" id="3596333">[</span><span class="ident" id="3596334">pattern</span><span class="op" id="3596341">[</span><span class="num" id="3596342">0</span><span class="op" id="3596343">:</span><span class="ident" id="3596344">n</span><span class="op" id="3596345">-</span><span class="num" id="3596346">1</span><span class="op" id="3596347">]</span><span class="op" id="3596348">]</span>&nbsp;<span class="op" id="3596350">=</span>&nbsp;<span class="ident" id="3596352">muxEntry</span><span class="op" id="3596360">{</span><span class="ident" id="3596361">h</span><span class="op" id="3596362">:</span>&nbsp;<span class="ident" id="3596364">RedirectHandler</span><span class="op" id="3596379">(</span><span class="ident" id="3596380">path</span><span class="op" id="3596384">,</span>&nbsp;<span class="ident" id="3596386">StatusMovedPermanently</span><span class="op" id="3596408">)</span><span class="op" id="3596409">,</span>&nbsp;<span class="ident" id="3596411">pattern</span><span class="op" id="3596418">:</span>&nbsp;<span class="ident" id="3596420">pattern</span><span class="op" id="3596427">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3596430">}</span><br>
<span class="lineno"></span><span class="op" id="3596432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3596435">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3596503">func</span>&nbsp;<span class="op" id="3596508">(</span><span class="ident" id="3596509">mux</span>&nbsp;<span class="op" id="3596513">*</span><span class="ident" id="3596514">ServeMux</span><span class="op" id="3596522">)</span>&nbsp;<span class="ident" id="3596524">HandleFunc</span><span class="op" id="3596534">(</span><span class="ident" id="3596535">pattern</span>&nbsp;<span class="builtintype" id="3596543">string</span><span class="op" id="3596549">,</span>&nbsp;<span class="ident" id="3596551">handler</span>&nbsp;<span class="keyword" id="3596559">func</span><span class="op" id="3596563">(</span><span class="ident" id="3596564">ResponseWriter</span><span class="op" id="3596578">,</span>&nbsp;<span class="op" id="3596580">*</span><span class="ident" id="3596581">Request</span><span class="op" id="3596588">)</span><span class="op" id="3596589">)</span>&nbsp;<span class="op" id="3596591">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596594">mux</span><span class="op" id="3596597">.</span><span class="ident" id="3596598">Handle</span><span class="op" id="3596604">(</span><span class="ident" id="3596605">pattern</span><span class="op" id="3596612">,</span>&nbsp;<span class="ident" id="3596614">HandlerFunc</span><span class="op" id="3596625">(</span><span class="ident" id="3596626">handler</span><span class="op" id="3596633">)</span><span class="op" id="3596634">)</span><br>
<span class="lineno"></span><span class="op" id="3596636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3596639">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3596693">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3596720">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3596789">func</span>&nbsp;<span class="ident" id="3596794">Handle</span><span class="op" id="3596800">(</span><span class="ident" id="3596801">pattern</span>&nbsp;<span class="builtintype" id="3596809">string</span><span class="op" id="3596815">,</span>&nbsp;<span class="ident" id="3596817">handler</span>&nbsp;<span class="ident" id="3596825">Handler</span><span class="op" id="3596832">)</span>&nbsp;<span class="op" id="3596834">{</span>&nbsp;<span class="ident" id="3596836">DefaultServeMux</span><span class="op" id="3596851">.</span><span class="ident" id="3596852">Handle</span><span class="op" id="3596858">(</span><span class="ident" id="3596859">pattern</span><span class="op" id="3596866">,</span>&nbsp;<span class="ident" id="3596868">handler</span><span class="op" id="3596875">)</span>&nbsp;<span class="op" id="3596877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3596880">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3596947">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3596974">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3597043">func</span>&nbsp;<span class="ident" id="3597048">HandleFunc</span><span class="op" id="3597058">(</span><span class="ident" id="3597059">pattern</span>&nbsp;<span class="builtintype" id="3597067">string</span><span class="op" id="3597073">,</span>&nbsp;<span class="ident" id="3597075">handler</span>&nbsp;<span class="keyword" id="3597083">func</span><span class="op" id="3597087">(</span><span class="ident" id="3597088">ResponseWriter</span><span class="op" id="3597102">,</span>&nbsp;<span class="op" id="3597104">*</span><span class="ident" id="3597105">Request</span><span class="op" id="3597112">)</span><span class="op" id="3597113">)</span>&nbsp;<span class="op" id="3597115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597118">DefaultServeMux</span><span class="op" id="3597133">.</span><span class="ident" id="3597134">HandleFunc</span><span class="op" id="3597144">(</span><span class="ident" id="3597145">pattern</span><span class="op" id="3597152">,</span>&nbsp;<span class="ident" id="3597154">handler</span><span class="op" id="3597161">)</span><br>
<span class="lineno"></span><span class="op" id="3597163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3597166">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3597228">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3597298">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3597355">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3597427">func</span>&nbsp;<span class="ident" id="3597432">Serve</span><span class="op" id="3597437">(</span><span class="ident" id="3597438">l</span>&nbsp;<span class="ident" id="3597440">net</span><span class="op" id="3597443">.</span><span class="ident" id="3597444">Listener</span><span class="op" id="3597452">,</span>&nbsp;<span class="ident" id="3597454">handler</span>&nbsp;<span class="ident" id="3597462">Handler</span><span class="op" id="3597469">)</span>&nbsp;<span class="builtintype" id="3597471">error</span>&nbsp;<span class="op" id="3597477">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597480">srv</span>&nbsp;<span class="op" id="3597484">:=</span>&nbsp;<span class="op" id="3597487">&amp;</span><span class="ident" id="3597488">Server</span><span class="op" id="3597494">{</span><span class="ident" id="3597495">Handler</span><span class="op" id="3597502">:</span>&nbsp;<span class="ident" id="3597504">handler</span><span class="op" id="3597511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3597514">return</span>&nbsp;<span class="ident" id="3597521">srv</span><span class="op" id="3597524">.</span><span class="ident" id="3597525">Serve</span><span class="op" id="3597530">(</span><span class="ident" id="3597531">l</span><span class="op" id="3597532">)</span><br>
<span class="lineno"></span><span class="op" id="3597534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3597537">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3597596">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3597651">type</span>&nbsp;<span class="ident" id="3597656">Server</span>&nbsp;<span class="keyword" id="3597663">struct</span>&nbsp;<span class="op" id="3597670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597673">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3597688">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597702">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597749">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597764">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597778">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597829">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597844">time</span><span class="op" id="3597848">.</span><span class="ident" id="3597849">Duration</span>&nbsp;<span class="comment" id="3597858">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597917">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3597932">time</span><span class="op" id="3597936">.</span><span class="ident" id="3597937">Duration</span>&nbsp;<span class="comment" id="3597946">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598007">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3598022">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598036">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598100">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3598115">*</span><span class="ident" id="3598116">tls</span><span class="op" id="3598119">.</span><span class="ident" id="3598120">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3598129">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598181">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598243">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598300">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598364">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598424">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598487">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598545">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598597">TLSNextProto</span>&nbsp;<span class="keyword" id="3598610">map</span><span class="op" id="3598613">[</span><span class="builtintype" id="3598614">string</span><span class="op" id="3598620">]</span><span class="keyword" id="3598621">func</span><span class="op" id="3598625">(</span><span class="op" id="3598626">*</span><span class="ident" id="3598627">Server</span><span class="op" id="3598633">,</span>&nbsp;<span class="op" id="3598635">*</span><span class="ident" id="3598636">tls</span><span class="op" id="3598639">.</span><span class="ident" id="3598640">Conn</span><span class="op" id="3598644">,</span>&nbsp;<span class="ident" id="3598646">Handler</span><span class="op" id="3598653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598657">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598719">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598778">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598835">ConnState</span>&nbsp;<span class="keyword" id="3598845">func</span><span class="op" id="3598849">(</span><span class="ident" id="3598850">net</span><span class="op" id="3598853">.</span><span class="ident" id="3598854">Conn</span><span class="op" id="3598858">,</span>&nbsp;<span class="ident" id="3598860">ConnState</span><span class="op" id="3598869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598873">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598936">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598991">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599051">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3599072">ErrorLog</span>&nbsp;<span class="op" id="3599081">*</span><span class="ident" id="3599082">log</span><span class="op" id="3599085">.</span><span class="ident" id="3599086">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3599095">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3599113">int32</span>&nbsp;<span class="comment" id="3599119">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3599143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3599146">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3599218">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3599270">type</span>&nbsp;<span class="ident" id="3599275">ConnState</span>&nbsp;<span class="builtintype" id="3599285">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3599290">const</span>&nbsp;<span class="op" id="3599296">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599299">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599360">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599418">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599473">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3599490">StateNew</span>&nbsp;<span class="ident" id="3599499">ConnState</span>&nbsp;<span class="op" id="3599509">=</span>&nbsp;<span class="ident" id="3599511">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599518">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599582">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599636">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599699">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599753">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599806">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3599867">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599881">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3599937">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600000">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600061">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600103">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600115">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600167">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600236">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600252">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600300">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600358">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600389">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3600401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3600404">var</span>&nbsp;<span class="ident" id="3600408">stateName</span>&nbsp;<span class="op" id="3600418">=</span>&nbsp;<span class="keyword" id="3600420">map</span><span class="op" id="3600423">[</span><span class="ident" id="3600424">ConnState</span><span class="op" id="3600433">]</span><span class="builtintype" id="3600434">string</span><span class="op" id="3600440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600443">StateNew</span><span class="op" id="3600451">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3600458">&#34;new&#34;</span><span class="op" id="3600463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600466">StateActive</span><span class="op" id="3600477">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3600481">&#34;active&#34;</span><span class="op" id="3600489">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600492">StateIdle</span><span class="op" id="3600501">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3600507">&#34;idle&#34;</span><span class="op" id="3600513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600516">StateHijacked</span><span class="op" id="3600529">:</span>&nbsp;<span class="string" id="3600531">&#34;hijacked&#34;</span><span class="op" id="3600541">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600544">StateClosed</span><span class="op" id="3600555">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3600559">&#34;closed&#34;</span><span class="op" id="3600567">,</span><br>
<span class="lineno"></span><span class="op" id="3600569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3600572">func</span>&nbsp;<span class="op" id="3600577">(</span><span class="ident" id="3600578">c</span>&nbsp;<span class="ident" id="3600580">ConnState</span><span class="op" id="3600589">)</span>&nbsp;<span class="ident" id="3600591">String</span><span class="op" id="3600597">(</span><span class="op" id="3600598">)</span>&nbsp;<span class="builtintype" id="3600600">string</span>&nbsp;<span class="op" id="3600607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600610">return</span>&nbsp;<span class="ident" id="3600617">stateName</span><span class="op" id="3600626">[</span><span class="ident" id="3600627">c</span><span class="op" id="3600628">]</span><br>
<span class="lineno"></span><span class="op" id="3600630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3600633">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3600694">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3600752">type</span>&nbsp;<span class="ident" id="3600757">serverHandler</span>&nbsp;<span class="keyword" id="3600771">struct</span>&nbsp;<span class="op" id="3600778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600781">srv</span>&nbsp;<span class="op" id="3600785">*</span><span class="ident" id="3600786">Server</span><br>
<span class="lineno"></span><span class="op" id="3600793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3600796">func</span>&nbsp;<span class="op" id="3600801">(</span><span class="ident" id="3600802">sh</span>&nbsp;<span class="ident" id="3600805">serverHandler</span><span class="op" id="3600818">)</span>&nbsp;<span class="ident" id="3600820">ServeHTTP</span><span class="op" id="3600829">(</span><span class="ident" id="3600830">rw</span>&nbsp;<span class="ident" id="3600833">ResponseWriter</span><span class="op" id="3600847">,</span>&nbsp;<span class="ident" id="3600849">req</span>&nbsp;<span class="op" id="3600853">*</span><span class="ident" id="3600854">Request</span><span class="op" id="3600861">)</span>&nbsp;<span class="op" id="3600863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600866">handler</span>&nbsp;<span class="op" id="3600874">:=</span>&nbsp;<span class="ident" id="3600877">sh</span><span class="op" id="3600879">.</span><span class="ident" id="3600880">srv</span><span class="op" id="3600883">.</span><span class="ident" id="3600884">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600893">if</span>&nbsp;<span class="ident" id="3600896">handler</span>&nbsp;<span class="op" id="3600904">==</span>&nbsp;<span class="builtintype" id="3600907">nil</span>&nbsp;<span class="op" id="3600911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600915">handler</span>&nbsp;<span class="op" id="3600923">=</span>&nbsp;<span class="ident" id="3600925">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600942">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600945">if</span>&nbsp;<span class="ident" id="3600948">req</span><span class="op" id="3600951">.</span><span class="ident" id="3600952">RequestURI</span>&nbsp;<span class="op" id="3600963">==</span>&nbsp;<span class="string" id="3600966">&#34;*&#34;</span>&nbsp;<span class="op" id="3600970">&amp;&amp;</span>&nbsp;<span class="ident" id="3600973">req</span><span class="op" id="3600976">.</span><span class="ident" id="3600977">Method</span>&nbsp;<span class="op" id="3600984">==</span>&nbsp;<span class="string" id="3600987">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3600997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601001">handler</span>&nbsp;<span class="op" id="3601009">=</span>&nbsp;<span class="ident" id="3601011">globalOptionsHandler</span><span class="op" id="3601031">{</span><span class="op" id="3601032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601038">handler</span><span class="op" id="3601045">.</span><span class="ident" id="3601046">ServeHTTP</span><span class="op" id="3601055">(</span><span class="ident" id="3601056">rw</span><span class="op" id="3601058">,</span>&nbsp;<span class="ident" id="3601060">req</span><span class="op" id="3601063">)</span><br>
<span class="lineno"></span><span class="op" id="3601065">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3601068">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3601139">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3601202">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3601241">func</span>&nbsp;<span class="op" id="3601246">(</span><span class="ident" id="3601247">srv</span>&nbsp;<span class="op" id="3601251">*</span><span class="ident" id="3601252">Server</span><span class="op" id="3601258">)</span>&nbsp;<span class="ident" id="3601260">ListenAndServe</span><span class="op" id="3601274">(</span><span class="op" id="3601275">)</span>&nbsp;<span class="builtintype" id="3601277">error</span>&nbsp;<span class="op" id="3601283">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601286">addr</span>&nbsp;<span class="op" id="3601291">:=</span>&nbsp;<span class="ident" id="3601294">srv</span><span class="op" id="3601297">.</span><span class="ident" id="3601298">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601304">if</span>&nbsp;<span class="ident" id="3601307">addr</span>&nbsp;<span class="op" id="3601312">==</span>&nbsp;<span class="string" id="3601315">&#34;&#34;</span>&nbsp;<span class="op" id="3601318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601322">addr</span>&nbsp;<span class="op" id="3601327">=</span>&nbsp;<span class="string" id="3601329">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601341">ln</span><span class="op" id="3601343">,</span>&nbsp;<span class="ident" id="3601345">err</span>&nbsp;<span class="op" id="3601349">:=</span>&nbsp;<span class="ident" id="3601352">net</span><span class="op" id="3601355">.</span><span class="ident" id="3601356">Listen</span><span class="op" id="3601362">(</span><span class="string" id="3601363">&#34;tcp&#34;</span><span class="op" id="3601368">,</span>&nbsp;<span class="ident" id="3601370">addr</span><span class="op" id="3601374">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601377">if</span>&nbsp;<span class="ident" id="3601380">err</span>&nbsp;<span class="op" id="3601384">!=</span>&nbsp;<span class="builtintype" id="3601387">nil</span>&nbsp;<span class="op" id="3601391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601395">return</span>&nbsp;<span class="ident" id="3601402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601410">return</span>&nbsp;<span class="ident" id="3601417">srv</span><span class="op" id="3601420">.</span><span class="ident" id="3601421">Serve</span><span class="op" id="3601426">(</span><span class="ident" id="3601427">tcpKeepAliveListener</span><span class="op" id="3601447">{</span><span class="ident" id="3601448">ln</span><span class="op" id="3601450">.</span><span class="op" id="3601451">(</span><span class="op" id="3601452">*</span><span class="ident" id="3601453">net</span><span class="op" id="3601456">.</span><span class="ident" id="3601457">TCPListener</span><span class="op" id="3601468">)</span><span class="op" id="3601469">}</span><span class="op" id="3601470">)</span><br>
<span class="lineno"></span><span class="op" id="3601472">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3601475">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3601543">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3601620">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3601663">func</span>&nbsp;<span class="op" id="3601668">(</span><span class="ident" id="3601669">srv</span>&nbsp;<span class="op" id="3601673">*</span><span class="ident" id="3601674">Server</span><span class="op" id="3601680">)</span>&nbsp;<span class="ident" id="3601682">Serve</span><span class="op" id="3601687">(</span><span class="ident" id="3601688">l</span>&nbsp;<span class="ident" id="3601690">net</span><span class="op" id="3601693">.</span><span class="ident" id="3601694">Listener</span><span class="op" id="3601702">)</span>&nbsp;<span class="builtintype" id="3601704">error</span>&nbsp;<span class="op" id="3601710">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601713">defer</span>&nbsp;<span class="ident" id="3601719">l</span><span class="op" id="3601720">.</span><span class="ident" id="3601721">Close</span><span class="op" id="3601726">(</span><span class="op" id="3601727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601730">var</span>&nbsp;<span class="ident" id="3601734">tempDelay</span>&nbsp;<span class="ident" id="3601744">time</span><span class="op" id="3601748">.</span><span class="ident" id="3601749">Duration</span>&nbsp;<span class="comment" id="3601758">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601798">for</span>&nbsp;<span class="op" id="3601802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601806">rw</span><span class="op" id="3601808">,</span>&nbsp;<span class="ident" id="3601810">e</span>&nbsp;<span class="op" id="3601812">:=</span>&nbsp;<span class="ident" id="3601815">l</span><span class="op" id="3601816">.</span><span class="ident" id="3601817">Accept</span><span class="op" id="3601823">(</span><span class="op" id="3601824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601828">if</span>&nbsp;<span class="ident" id="3601831">e</span>&nbsp;<span class="op" id="3601833">!=</span>&nbsp;<span class="builtintype" id="3601836">nil</span>&nbsp;<span class="op" id="3601840">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601845">if</span>&nbsp;<span class="ident" id="3601848">ne</span><span class="op" id="3601850">,</span>&nbsp;<span class="ident" id="3601852">ok</span>&nbsp;<span class="op" id="3601855">:=</span>&nbsp;<span class="ident" id="3601858">e</span><span class="op" id="3601859">.</span><span class="op" id="3601860">(</span><span class="ident" id="3601861">net</span><span class="op" id="3601864">.</span><span class="ident" id="3601865">Error</span><span class="op" id="3601870">)</span><span class="op" id="3601871">;</span>&nbsp;<span class="ident" id="3601873">ok</span>&nbsp;<span class="op" id="3601876">&amp;&amp;</span>&nbsp;<span class="ident" id="3601879">ne</span><span class="op" id="3601881">.</span><span class="ident" id="3601882">Temporary</span><span class="op" id="3601891">(</span><span class="op" id="3601892">)</span>&nbsp;<span class="op" id="3601894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601900">if</span>&nbsp;<span class="ident" id="3601903">tempDelay</span>&nbsp;<span class="op" id="3601913">==</span>&nbsp;<span class="num" id="3601916">0</span>&nbsp;<span class="op" id="3601918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601925">tempDelay</span>&nbsp;<span class="op" id="3601935">=</span>&nbsp;<span class="num" id="3601937">5</span>&nbsp;<span class="op" id="3601939">*</span>&nbsp;<span class="ident" id="3601941">time</span><span class="op" id="3601945">.</span><span class="ident" id="3601946">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601962">}</span>&nbsp;<span class="keyword" id="3601964">else</span>&nbsp;<span class="op" id="3601969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601976">tempDelay</span>&nbsp;<span class="op" id="3601986">*=</span>&nbsp;<span class="num" id="3601989">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602001">if</span>&nbsp;<span class="ident" id="3602004">max</span>&nbsp;<span class="op" id="3602008">:=</span>&nbsp;<span class="num" id="3602011">1</span>&nbsp;<span class="op" id="3602013">*</span>&nbsp;<span class="ident" id="3602015">time</span><span class="op" id="3602019">.</span><span class="ident" id="3602020">Second</span><span class="op" id="3602026">;</span>&nbsp;<span class="ident" id="3602028">tempDelay</span>&nbsp;<span class="op" id="3602038">&gt;</span>&nbsp;<span class="ident" id="3602040">max</span>&nbsp;<span class="op" id="3602044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602051">tempDelay</span>&nbsp;<span class="op" id="3602061">=</span>&nbsp;<span class="ident" id="3602063">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602077">srv</span><span class="op" id="3602080">.</span><span class="ident" id="3602081">logf</span><span class="op" id="3602085">(</span><span class="string" id="3602086">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3602126">,</span>&nbsp;<span class="ident" id="3602128">e</span><span class="op" id="3602129">,</span>&nbsp;<span class="ident" id="3602131">tempDelay</span><span class="op" id="3602140">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602146">time</span><span class="op" id="3602150">.</span><span class="ident" id="3602151">Sleep</span><span class="op" id="3602156">(</span><span class="ident" id="3602157">tempDelay</span><span class="op" id="3602166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602172">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602189">return</span>&nbsp;<span class="ident" id="3602196">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602200">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602204">tempDelay</span>&nbsp;<span class="op" id="3602214">=</span>&nbsp;<span class="num" id="3602216">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602220">c</span><span class="op" id="3602221">,</span>&nbsp;<span class="ident" id="3602223">err</span>&nbsp;<span class="op" id="3602227">:=</span>&nbsp;<span class="ident" id="3602230">srv</span><span class="op" id="3602233">.</span><span class="ident" id="3602234">newConn</span><span class="op" id="3602241">(</span><span class="ident" id="3602242">rw</span><span class="op" id="3602244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602248">if</span>&nbsp;<span class="ident" id="3602251">err</span>&nbsp;<span class="op" id="3602255">!=</span>&nbsp;<span class="builtintype" id="3602258">nil</span>&nbsp;<span class="op" id="3602262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602267">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602278">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602282">c</span><span class="op" id="3602283">.</span><span class="ident" id="3602284">setState</span><span class="op" id="3602292">(</span><span class="ident" id="3602293">c</span><span class="op" id="3602294">.</span><span class="ident" id="3602295">rwc</span><span class="op" id="3602298">,</span>&nbsp;<span class="ident" id="3602300">StateNew</span><span class="op" id="3602308">)</span>&nbsp;<span class="comment" id="3602310">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602339">go</span>&nbsp;<span class="ident" id="3602342">c</span><span class="op" id="3602343">.</span><span class="ident" id="3602344">serve</span><span class="op" id="3602349">(</span><span class="op" id="3602350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602353">}</span><br>
<span class="lineno"></span><span class="op" id="3602355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3602358">func</span>&nbsp;<span class="op" id="3602363">(</span><span class="ident" id="3602364">s</span>&nbsp;<span class="op" id="3602366">*</span><span class="ident" id="3602367">Server</span><span class="op" id="3602373">)</span>&nbsp;<span class="ident" id="3602375">doKeepAlives</span><span class="op" id="3602387">(</span><span class="op" id="3602388">)</span>&nbsp;<span class="builtintype" id="3602390">bool</span>&nbsp;<span class="op" id="3602395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602398">return</span>&nbsp;<span class="ident" id="3602405">atomic</span><span class="op" id="3602411">.</span><span class="ident" id="3602412">LoadInt32</span><span class="op" id="3602421">(</span><span class="op" id="3602422">&amp;</span><span class="ident" id="3602423">s</span><span class="op" id="3602424">.</span><span class="ident" id="3602425">disableKeepAlives</span><span class="op" id="3602442">)</span>&nbsp;<span class="op" id="3602444">==</span>&nbsp;<span class="num" id="3602447">0</span><br>
<span class="lineno"></span><span class="op" id="3602449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3602452">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3602523">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3602580">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3602646">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3602684">func</span>&nbsp;<span class="op" id="3602689">(</span><span class="ident" id="3602690">s</span>&nbsp;<span class="op" id="3602692">*</span><span class="ident" id="3602693">Server</span><span class="op" id="3602699">)</span>&nbsp;<span class="ident" id="3602701">SetKeepAlivesEnabled</span><span class="op" id="3602721">(</span><span class="ident" id="3602722">v</span>&nbsp;<span class="builtintype" id="3602724">bool</span><span class="op" id="3602728">)</span>&nbsp;<span class="op" id="3602730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602733">if</span>&nbsp;<span class="ident" id="3602736">v</span>&nbsp;<span class="op" id="3602738">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602742">atomic</span><span class="op" id="3602748">.</span><span class="ident" id="3602749">StoreInt32</span><span class="op" id="3602759">(</span><span class="op" id="3602760">&amp;</span><span class="ident" id="3602761">s</span><span class="op" id="3602762">.</span><span class="ident" id="3602763">disableKeepAlives</span><span class="op" id="3602780">,</span>&nbsp;<span class="num" id="3602782">0</span><span class="op" id="3602783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602786">}</span>&nbsp;<span class="keyword" id="3602788">else</span>&nbsp;<span class="op" id="3602793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602797">atomic</span><span class="op" id="3602803">.</span><span class="ident" id="3602804">StoreInt32</span><span class="op" id="3602814">(</span><span class="op" id="3602815">&amp;</span><span class="ident" id="3602816">s</span><span class="op" id="3602817">.</span><span class="ident" id="3602818">disableKeepAlives</span><span class="op" id="3602835">,</span>&nbsp;<span class="num" id="3602837">1</span><span class="op" id="3602838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602841">}</span><br>
<span class="lineno"></span><span class="op" id="3602843">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3602846">func</span>&nbsp;<span class="op" id="3602851">(</span><span class="ident" id="3602852">s</span>&nbsp;<span class="op" id="3602854">*</span><span class="ident" id="3602855">Server</span><span class="op" id="3602861">)</span>&nbsp;<span class="ident" id="3602863">logf</span><span class="op" id="3602867">(</span><span class="ident" id="3602868">format</span>&nbsp;<span class="builtintype" id="3602875">string</span><span class="op" id="3602881">,</span>&nbsp;<span class="ident" id="3602883">args</span>&nbsp;<span class="op" id="3602888">...</span><span class="keyword" id="3602891">interface</span><span class="op" id="3602900">{</span><span class="op" id="3602901">}</span><span class="op" id="3602902">)</span>&nbsp;<span class="op" id="3602904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602907">if</span>&nbsp;<span class="ident" id="3602910">s</span><span class="op" id="3602911">.</span><span class="ident" id="3602912">ErrorLog</span>&nbsp;<span class="op" id="3602921">!=</span>&nbsp;<span class="builtintype" id="3602924">nil</span>&nbsp;<span class="op" id="3602928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602932">s</span><span class="op" id="3602933">.</span><span class="ident" id="3602934">ErrorLog</span><span class="op" id="3602942">.</span><span class="ident" id="3602943">Printf</span><span class="op" id="3602949">(</span><span class="ident" id="3602950">format</span><span class="op" id="3602956">,</span>&nbsp;<span class="ident" id="3602958">args</span><span class="op" id="3602962">...</span><span class="op" id="3602965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602968">}</span>&nbsp;<span class="keyword" id="3602970">else</span>&nbsp;<span class="op" id="3602975">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602979">log</span><span class="op" id="3602982">.</span><span class="ident" id="3602983">Printf</span><span class="op" id="3602989">(</span><span class="ident" id="3602990">format</span><span class="op" id="3602996">,</span>&nbsp;<span class="ident" id="3602998">args</span><span class="op" id="3603002">...</span><span class="op" id="3603005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3603008">}</span><br>
<span class="lineno"></span><span class="op" id="3603010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3603013">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3603071">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3603127">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3603182">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3603228">//</span><br>
<span class="lineno"></span><span class="comment" id="3603231">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3603263">//</span><br>
<span class="lineno"></span><span class="comment" id="3603266">//&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3603282">//</span><br>
<span class="lineno"></span><span class="comment" id="3603285">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3603297">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3603306">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3603321">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3603331">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="3603336">//</span><br>
<span class="lineno"></span><span class="comment" id="3603339">//&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3603373">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3603437">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3603478">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3603483">//</span><br>
<span class="lineno"></span><span class="comment" id="3603486">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3603503">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3603546">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3603592">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3603612">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3603652">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">1805</span><span class="comment" id="3603658">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="keyword" id="3603663">func</span>&nbsp;<span class="ident" id="3603668">ListenAndServe</span><span class="op" id="3603682">(</span><span class="ident" id="3603683">addr</span>&nbsp;<span class="builtintype" id="3603688">string</span><span class="op" id="3603694">,</span>&nbsp;<span class="ident" id="3603696">handler</span>&nbsp;<span class="ident" id="3603704">Handler</span><span class="op" id="3603711">)</span>&nbsp;<span class="builtintype" id="3603713">error</span>&nbsp;<span class="op" id="3603719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603722">server</span>&nbsp;<span class="op" id="3603729">:=</span>&nbsp;<span class="op" id="3603732">&amp;</span><span class="ident" id="3603733">Server</span><span class="op" id="3603739">{</span><span class="ident" id="3603740">Addr</span><span class="op" id="3603744">:</span>&nbsp;<span class="ident" id="3603746">addr</span><span class="op" id="3603750">,</span>&nbsp;<span class="ident" id="3603752">Handler</span><span class="op" id="3603759">:</span>&nbsp;<span class="ident" id="3603761">handler</span><span class="op" id="3603768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3603771">return</span>&nbsp;<span class="ident" id="3603778">server</span><span class="op" id="3603784">.</span><span class="ident" id="3603785">ListenAndServe</span><span class="op" id="3603799">(</span><span class="op" id="3603800">)</span><br>
<span class="lineno"></span><span class="op" id="3603802">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3603805">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3603877">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3603956">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3604032">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3604114">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3604179">//</span><br>
<span class="lineno"></span><span class="comment" id="3604182">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3604214">//</span><br>
<span class="lineno"></span><span class="comment" id="3604217">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3604229">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3604239">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3604254">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="3604259">//</span><br>
<span class="lineno"></span><span class="comment" id="3604262">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3604322">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3604371">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3604423">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3604428">//</span><br>
<span class="lineno"></span><span class="comment" id="3604431">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3604448">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3604482">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3604557">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3604629">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3604649">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3604669">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3604675">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3604680">//</span><br>
<span class="lineno"></span><span class="comment" id="3604683">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3604763">func</span>&nbsp;<span class="ident" id="3604768">ListenAndServeTLS</span><span class="op" id="3604785">(</span><span class="ident" id="3604786">addr</span>&nbsp;<span class="builtintype" id="3604791">string</span><span class="op" id="3604797">,</span>&nbsp;<span class="ident" id="3604799">certFile</span>&nbsp;<span class="builtintype" id="3604808">string</span><span class="op" id="3604814">,</span>&nbsp;<span class="ident" id="3604816">keyFile</span>&nbsp;<span class="builtintype" id="3604824">string</span><span class="op" id="3604830">,</span>&nbsp;<span class="ident" id="3604832">handler</span>&nbsp;<span class="ident" id="3604840">Handler</span><span class="op" id="3604847">)</span>&nbsp;<span class="builtintype" id="3604849">error</span>&nbsp;<span class="op" id="3604855">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604858">server</span>&nbsp;<span class="op" id="3604865">:=</span>&nbsp;<span class="op" id="3604868">&amp;</span><span class="ident" id="3604869">Server</span><span class="op" id="3604875">{</span><span class="ident" id="3604876">Addr</span><span class="op" id="3604880">:</span>&nbsp;<span class="ident" id="3604882">addr</span><span class="op" id="3604886">,</span>&nbsp;<span class="ident" id="3604888">Handler</span><span class="op" id="3604895">:</span>&nbsp;<span class="ident" id="3604897">handler</span><span class="op" id="3604904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604907">return</span>&nbsp;<span class="ident" id="3604914">server</span><span class="op" id="3604920">.</span><span class="ident" id="3604921">ListenAndServeTLS</span><span class="op" id="3604938">(</span><span class="ident" id="3604939">certFile</span><span class="op" id="3604947">,</span>&nbsp;<span class="ident" id="3604949">keyFile</span><span class="op" id="3604956">)</span><br>
<span class="lineno"></span><span class="op" id="3604958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3604961">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3605030">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3605098">//</span><br>
<span class="lineno"></span><span class="comment" id="3605101">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3605168">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3605234">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3605301">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3605366">//</span><br>
<span class="lineno"></span><span class="comment" id="3605369">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3605412">func</span>&nbsp;<span class="op" id="3605417">(</span><span class="ident" id="3605418">srv</span>&nbsp;<span class="op" id="3605422">*</span><span class="ident" id="3605423">Server</span><span class="op" id="3605429">)</span>&nbsp;<span class="ident" id="3605431">ListenAndServeTLS</span><span class="op" id="3605448">(</span><span class="ident" id="3605449">certFile</span><span class="op" id="3605457">,</span>&nbsp;<span class="ident" id="3605459">keyFile</span>&nbsp;<span class="builtintype" id="3605467">string</span><span class="op" id="3605473">)</span>&nbsp;<span class="builtintype" id="3605475">error</span>&nbsp;<span class="op" id="3605481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605484">addr</span>&nbsp;<span class="op" id="3605489">:=</span>&nbsp;<span class="ident" id="3605492">srv</span><span class="op" id="3605495">.</span><span class="ident" id="3605496">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605502">if</span>&nbsp;<span class="ident" id="3605505">addr</span>&nbsp;<span class="op" id="3605510">==</span>&nbsp;<span class="string" id="3605513">&#34;&#34;</span>&nbsp;<span class="op" id="3605516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605520">addr</span>&nbsp;<span class="op" id="3605525">=</span>&nbsp;<span class="string" id="3605527">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605540">config</span>&nbsp;<span class="op" id="3605547">:=</span>&nbsp;<span class="op" id="3605550">&amp;</span><span class="ident" id="3605551">tls</span><span class="op" id="3605554">.</span><span class="ident" id="3605555">Config</span><span class="op" id="3605561">{</span><span class="op" id="3605562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605565">if</span>&nbsp;<span class="ident" id="3605568">srv</span><span class="op" id="3605571">.</span><span class="ident" id="3605572">TLSConfig</span>&nbsp;<span class="op" id="3605582">!=</span>&nbsp;<span class="builtintype" id="3605585">nil</span>&nbsp;<span class="op" id="3605589">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605593">*</span><span class="ident" id="3605594">config</span>&nbsp;<span class="op" id="3605601">=</span>&nbsp;<span class="op" id="3605603">*</span><span class="ident" id="3605604">srv</span><span class="op" id="3605607">.</span><span class="ident" id="3605608">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605622">if</span>&nbsp;<span class="ident" id="3605625">config</span><span class="op" id="3605631">.</span><span class="ident" id="3605632">NextProtos</span>&nbsp;<span class="op" id="3605643">==</span>&nbsp;<span class="builtintype" id="3605646">nil</span>&nbsp;<span class="op" id="3605650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605654">config</span><span class="op" id="3605660">.</span><span class="ident" id="3605661">NextProtos</span>&nbsp;<span class="op" id="3605672">=</span>&nbsp;<span class="op" id="3605674">[</span><span class="op" id="3605675">]</span><span class="builtintype" id="3605676">string</span><span class="op" id="3605682">{</span><span class="string" id="3605683">&#34;http/1.1&#34;</span><span class="op" id="3605693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605696">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605700">var</span>&nbsp;<span class="ident" id="3605704">err</span>&nbsp;<span class="builtintype" id="3605708">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605715">config</span><span class="op" id="3605721">.</span><span class="ident" id="3605722">Certificates</span>&nbsp;<span class="op" id="3605735">=</span>&nbsp;<span class="builtinfunc" id="3605737">make</span><span class="op" id="3605741">(</span><span class="op" id="3605742">[</span><span class="op" id="3605743">]</span><span class="ident" id="3605744">tls</span><span class="op" id="3605747">.</span><span class="ident" id="3605748">Certificate</span><span class="op" id="3605759">,</span>&nbsp;<span class="num" id="3605761">1</span><span class="op" id="3605762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605765">config</span><span class="op" id="3605771">.</span><span class="ident" id="3605772">Certificates</span><span class="op" id="3605784">[</span><span class="num" id="3605785">0</span><span class="op" id="3605786">]</span><span class="op" id="3605787">,</span>&nbsp;<span class="ident" id="3605789">err</span>&nbsp;<span class="op" id="3605793">=</span>&nbsp;<span class="ident" id="3605795">tls</span><span class="op" id="3605798">.</span><span class="ident" id="3605799">LoadX509KeyPair</span><span class="op" id="3605814">(</span><span class="ident" id="3605815">certFile</span><span class="op" id="3605823">,</span>&nbsp;<span class="ident" id="3605825">keyFile</span><span class="op" id="3605832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605835">if</span>&nbsp;<span class="ident" id="3605838">err</span>&nbsp;<span class="op" id="3605842">!=</span>&nbsp;<span class="builtintype" id="3605845">nil</span>&nbsp;<span class="op" id="3605849">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605853">return</span>&nbsp;<span class="ident" id="3605860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605869">ln</span><span class="op" id="3605871">,</span>&nbsp;<span class="ident" id="3605873">err</span>&nbsp;<span class="op" id="3605877">:=</span>&nbsp;<span class="ident" id="3605880">net</span><span class="op" id="3605883">.</span><span class="ident" id="3605884">Listen</span><span class="op" id="3605890">(</span><span class="string" id="3605891">&#34;tcp&#34;</span><span class="op" id="3605896">,</span>&nbsp;<span class="ident" id="3605898">addr</span><span class="op" id="3605902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605905">if</span>&nbsp;<span class="ident" id="3605908">err</span>&nbsp;<span class="op" id="3605912">!=</span>&nbsp;<span class="builtintype" id="3605915">nil</span>&nbsp;<span class="op" id="3605919">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605923">return</span>&nbsp;<span class="ident" id="3605930">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605939">tlsListener</span>&nbsp;<span class="op" id="3605951">:=</span>&nbsp;<span class="ident" id="3605954">tls</span><span class="op" id="3605957">.</span><span class="ident" id="3605958">NewListener</span><span class="op" id="3605969">(</span><span class="ident" id="3605970">tcpKeepAliveListener</span><span class="op" id="3605990">{</span><span class="ident" id="3605991">ln</span><span class="op" id="3605993">.</span><span class="op" id="3605994">(</span><span class="op" id="3605995">*</span><span class="ident" id="3605996">net</span><span class="op" id="3605999">.</span><span class="ident" id="3606000">TCPListener</span><span class="op" id="3606011">)</span><span class="op" id="3606012">}</span><span class="op" id="3606013">,</span>&nbsp;<span class="ident" id="3606015">config</span><span class="op" id="3606021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606024">return</span>&nbsp;<span class="ident" id="3606031">srv</span><span class="op" id="3606034">.</span><span class="ident" id="3606035">Serve</span><span class="op" id="3606040">(</span><span class="ident" id="3606041">tlsListener</span><span class="op" id="3606052">)</span><br>
<span class="lineno">1880</span><span class="op" id="3606054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3606057">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3606132">//</span><br>
<span class="lineno"></span><span class="comment" id="3606135">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3606205">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3606276">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3606346">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3606409">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3606480">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3606502">func</span>&nbsp;<span class="ident" id="3606507">TimeoutHandler</span><span class="op" id="3606521">(</span><span class="ident" id="3606522">h</span>&nbsp;<span class="ident" id="3606524">Handler</span><span class="op" id="3606531">,</span>&nbsp;<span class="ident" id="3606533">dt</span>&nbsp;<span class="ident" id="3606536">time</span><span class="op" id="3606540">.</span><span class="ident" id="3606541">Duration</span><span class="op" id="3606549">,</span>&nbsp;<span class="ident" id="3606551">msg</span>&nbsp;<span class="builtintype" id="3606555">string</span><span class="op" id="3606561">)</span>&nbsp;<span class="ident" id="3606563">Handler</span>&nbsp;<span class="op" id="3606571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606574">f</span>&nbsp;<span class="op" id="3606576">:=</span>&nbsp;<span class="keyword" id="3606579">func</span><span class="op" id="3606583">(</span><span class="op" id="3606584">)</span>&nbsp;<span class="op" id="3606586">&lt;-</span><span class="keyword" id="3606588">chan</span>&nbsp;<span class="ident" id="3606593">time</span><span class="op" id="3606597">.</span><span class="ident" id="3606598">Time</span>&nbsp;<span class="op" id="3606603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606607">return</span>&nbsp;<span class="ident" id="3606614">time</span><span class="op" id="3606618">.</span><span class="ident" id="3606619">After</span><span class="op" id="3606624">(</span><span class="ident" id="3606625">dt</span><span class="op" id="3606627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606633">return</span>&nbsp;<span class="op" id="3606640">&amp;</span><span class="ident" id="3606641">timeoutHandler</span><span class="op" id="3606655">{</span><span class="ident" id="3606656">h</span><span class="op" id="3606657">,</span>&nbsp;<span class="ident" id="3606659">f</span><span class="op" id="3606660">,</span>&nbsp;<span class="ident" id="3606662">msg</span><span class="op" id="3606665">}</span><br>
<span class="lineno">1895</span><span class="op" id="3606667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3606670">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3606733">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3606770">var</span>&nbsp;<span class="ident" id="3606774">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3606792">=</span>&nbsp;<span class="ident" id="3606794">errors</span><span class="op" id="3606800">.</span><span class="ident" id="3606801">New</span><span class="op" id="3606804">(</span><span class="string" id="3606805">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3606828">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3606831">type</span>&nbsp;<span class="ident" id="3606836">timeoutHandler</span>&nbsp;<span class="keyword" id="3606851">struct</span>&nbsp;<span class="op" id="3606858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606861">handler</span>&nbsp;<span class="ident" id="3606869">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606878">timeout</span>&nbsp;<span class="keyword" id="3606886">func</span><span class="op" id="3606890">(</span><span class="op" id="3606891">)</span>&nbsp;<span class="op" id="3606893">&lt;-</span><span class="keyword" id="3606895">chan</span>&nbsp;<span class="ident" id="3606900">time</span><span class="op" id="3606904">.</span><span class="ident" id="3606905">Time</span>&nbsp;<span class="comment" id="3606910">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606950">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3606958">string</span><br>
<span class="lineno">1905</span><span class="op" id="3606965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3606968">func</span>&nbsp;<span class="op" id="3606973">(</span><span class="ident" id="3606974">h</span>&nbsp;<span class="op" id="3606976">*</span><span class="ident" id="3606977">timeoutHandler</span><span class="op" id="3606991">)</span>&nbsp;<span class="ident" id="3606993">errorBody</span><span class="op" id="3607002">(</span><span class="op" id="3607003">)</span>&nbsp;<span class="builtintype" id="3607005">string</span>&nbsp;<span class="op" id="3607012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607015">if</span>&nbsp;<span class="ident" id="3607018">h</span><span class="op" id="3607019">.</span><span class="ident" id="3607020">body</span>&nbsp;<span class="op" id="3607025">!=</span>&nbsp;<span class="string" id="3607028">&#34;&#34;</span>&nbsp;<span class="op" id="3607031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607035">return</span>&nbsp;<span class="ident" id="3607042">h</span><span class="op" id="3607043">.</span><span class="ident" id="3607044">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607053">return</span>&nbsp;<span class="string" id="3607060">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3607140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3607143">func</span>&nbsp;<span class="op" id="3607148">(</span><span class="ident" id="3607149">h</span>&nbsp;<span class="op" id="3607151">*</span><span class="ident" id="3607152">timeoutHandler</span><span class="op" id="3607166">)</span>&nbsp;<span class="ident" id="3607168">ServeHTTP</span><span class="op" id="3607177">(</span><span class="ident" id="3607178">w</span>&nbsp;<span class="ident" id="3607180">ResponseWriter</span><span class="op" id="3607194">,</span>&nbsp;<span class="ident" id="3607196">r</span>&nbsp;<span class="op" id="3607198">*</span><span class="ident" id="3607199">Request</span><span class="op" id="3607206">)</span>&nbsp;<span class="op" id="3607208">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607211">done</span>&nbsp;<span class="op" id="3607216">:=</span>&nbsp;<span class="builtinfunc" id="3607219">make</span><span class="op" id="3607223">(</span><span class="keyword" id="3607224">chan</span>&nbsp;<span class="builtintype" id="3607229">bool</span><span class="op" id="3607233">,</span>&nbsp;<span class="num" id="3607235">1</span><span class="op" id="3607236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607239">tw</span>&nbsp;<span class="op" id="3607242">:=</span>&nbsp;<span class="op" id="3607245">&amp;</span><span class="ident" id="3607246">timeoutWriter</span><span class="op" id="3607259">{</span><span class="ident" id="3607260">w</span><span class="op" id="3607261">:</span>&nbsp;<span class="ident" id="3607263">w</span><span class="op" id="3607264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607267">go</span>&nbsp;<span class="keyword" id="3607270">func</span><span class="op" id="3607274">(</span><span class="op" id="3607275">)</span>&nbsp;<span class="op" id="3607277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607281">h</span><span class="op" id="3607282">.</span><span class="ident" id="3607283">handler</span><span class="op" id="3607290">.</span><span class="ident" id="3607291">ServeHTTP</span><span class="op" id="3607300">(</span><span class="ident" id="3607301">tw</span><span class="op" id="3607303">,</span>&nbsp;<span class="ident" id="3607305">r</span><span class="op" id="3607306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607310">done</span>&nbsp;<span class="op" id="3607315">&lt;-</span>&nbsp;<span class="builtintype" id="3607318">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607324">}</span><span class="op" id="3607325">(</span><span class="op" id="3607326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607329">select</span>&nbsp;<span class="op" id="3607336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607339">case</span>&nbsp;<span class="op" id="3607344">&lt;-</span><span class="ident" id="3607346">done</span><span class="op" id="3607350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607354">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607362">case</span>&nbsp;<span class="op" id="3607367">&lt;-</span><span class="ident" id="3607369">h</span><span class="op" id="3607370">.</span><span class="ident" id="3607371">timeout</span><span class="op" id="3607378">(</span><span class="op" id="3607379">)</span><span class="op" id="3607380">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607384">tw</span><span class="op" id="3607386">.</span><span class="ident" id="3607387">mu</span><span class="op" id="3607389">.</span><span class="ident" id="3607390">Lock</span><span class="op" id="3607394">(</span><span class="op" id="3607395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607399">defer</span>&nbsp;<span class="ident" id="3607405">tw</span><span class="op" id="3607407">.</span><span class="ident" id="3607408">mu</span><span class="op" id="3607410">.</span><span class="ident" id="3607411">Unlock</span><span class="op" id="3607417">(</span><span class="op" id="3607418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607422">if</span>&nbsp;<span class="op" id="3607425">!</span><span class="ident" id="3607426">tw</span><span class="op" id="3607428">.</span><span class="ident" id="3607429">wroteHeader</span>&nbsp;<span class="op" id="3607441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607446">tw</span><span class="op" id="3607448">.</span><span class="ident" id="3607449">w</span><span class="op" id="3607450">.</span><span class="ident" id="3607451">WriteHeader</span><span class="op" id="3607462">(</span><span class="ident" id="3607463">StatusServiceUnavailable</span><span class="op" id="3607487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607492">tw</span><span class="op" id="3607494">.</span><span class="ident" id="3607495">w</span><span class="op" id="3607496">.</span><span class="ident" id="3607497">Write</span><span class="op" id="3607502">(</span><span class="op" id="3607503">[</span><span class="op" id="3607504">]</span><span class="builtintype" id="3607505">byte</span><span class="op" id="3607509">(</span><span class="ident" id="3607510">h</span><span class="op" id="3607511">.</span><span class="ident" id="3607512">errorBody</span><span class="op" id="3607521">(</span><span class="op" id="3607522">)</span><span class="op" id="3607523">)</span><span class="op" id="3607524">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607532">tw</span><span class="op" id="3607534">.</span><span class="ident" id="3607535">timedOut</span>&nbsp;<span class="op" id="3607544">=</span>&nbsp;<span class="builtintype" id="3607546">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607552">}</span><br>
<span class="lineno"></span><span class="op" id="3607554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3607557">type</span>&nbsp;<span class="ident" id="3607562">timeoutWriter</span>&nbsp;<span class="keyword" id="3607576">struct</span>&nbsp;<span class="op" id="3607583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607586">w</span>&nbsp;<span class="ident" id="3607588">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607605">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607617">sync</span><span class="op" id="3607621">.</span><span class="ident" id="3607622">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607629">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3607641">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607647">wroteHeader</span>&nbsp;<span class="builtintype" id="3607659">bool</span><br>
<span class="lineno"></span><span class="op" id="3607664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3607667">func</span>&nbsp;<span class="op" id="3607672">(</span><span class="ident" id="3607673">tw</span>&nbsp;<span class="op" id="3607676">*</span><span class="ident" id="3607677">timeoutWriter</span><span class="op" id="3607690">)</span>&nbsp;<span class="ident" id="3607692">Header</span><span class="op" id="3607698">(</span><span class="op" id="3607699">)</span>&nbsp;<span class="ident" id="3607701">Header</span>&nbsp;<span class="op" id="3607708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607711">return</span>&nbsp;<span class="ident" id="3607718">tw</span><span class="op" id="3607720">.</span><span class="ident" id="3607721">w</span><span class="op" id="3607722">.</span><span class="ident" id="3607723">Header</span><span class="op" id="3607729">(</span><span class="op" id="3607730">)</span><br>
<span class="lineno">1945</span><span class="op" id="3607732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3607735">func</span>&nbsp;<span class="op" id="3607740">(</span><span class="ident" id="3607741">tw</span>&nbsp;<span class="op" id="3607744">*</span><span class="ident" id="3607745">timeoutWriter</span><span class="op" id="3607758">)</span>&nbsp;<span class="ident" id="3607760">Write</span><span class="op" id="3607765">(</span><span class="ident" id="3607766">p</span>&nbsp;<span class="op" id="3607768">[</span><span class="op" id="3607769">]</span><span class="builtintype" id="3607770">byte</span><span class="op" id="3607774">)</span>&nbsp;<span class="op" id="3607776">(</span><span class="builtintype" id="3607777">int</span><span class="op" id="3607780">,</span>&nbsp;<span class="builtintype" id="3607782">error</span><span class="op" id="3607787">)</span>&nbsp;<span class="op" id="3607789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607792">tw</span><span class="op" id="3607794">.</span><span class="ident" id="3607795">mu</span><span class="op" id="3607797">.</span><span class="ident" id="3607798">Lock</span><span class="op" id="3607802">(</span><span class="op" id="3607803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607806">defer</span>&nbsp;<span class="ident" id="3607812">tw</span><span class="op" id="3607814">.</span><span class="ident" id="3607815">mu</span><span class="op" id="3607817">.</span><span class="ident" id="3607818">Unlock</span><span class="op" id="3607824">(</span><span class="op" id="3607825">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607828">tw</span><span class="op" id="3607830">.</span><span class="ident" id="3607831">wroteHeader</span>&nbsp;<span class="op" id="3607843">=</span>&nbsp;<span class="builtintype" id="3607845">true</span>&nbsp;<span class="comment" id="3607850">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607874">if</span>&nbsp;<span class="ident" id="3607877">tw</span><span class="op" id="3607879">.</span><span class="ident" id="3607880">timedOut</span>&nbsp;<span class="op" id="3607889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607893">return</span>&nbsp;<span class="num" id="3607900">0</span><span class="op" id="3607901">,</span>&nbsp;<span class="ident" id="3607903">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607925">return</span>&nbsp;<span class="ident" id="3607932">tw</span><span class="op" id="3607934">.</span><span class="ident" id="3607935">w</span><span class="op" id="3607936">.</span><span class="ident" id="3607937">Write</span><span class="op" id="3607942">(</span><span class="ident" id="3607943">p</span><span class="op" id="3607944">)</span><br>
<span class="lineno">1955</span><span class="op" id="3607946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3607949">func</span>&nbsp;<span class="op" id="3607954">(</span><span class="ident" id="3607955">tw</span>&nbsp;<span class="op" id="3607958">*</span><span class="ident" id="3607959">timeoutWriter</span><span class="op" id="3607972">)</span>&nbsp;<span class="ident" id="3607974">WriteHeader</span><span class="op" id="3607985">(</span><span class="ident" id="3607986">code</span>&nbsp;<span class="builtintype" id="3607991">int</span><span class="op" id="3607994">)</span>&nbsp;<span class="op" id="3607996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607999">tw</span><span class="op" id="3608001">.</span><span class="ident" id="3608002">mu</span><span class="op" id="3608004">.</span><span class="ident" id="3608005">Lock</span><span class="op" id="3608009">(</span><span class="op" id="3608010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608013">defer</span>&nbsp;<span class="ident" id="3608019">tw</span><span class="op" id="3608021">.</span><span class="ident" id="3608022">mu</span><span class="op" id="3608024">.</span><span class="ident" id="3608025">Unlock</span><span class="op" id="3608031">(</span><span class="op" id="3608032">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608035">if</span>&nbsp;<span class="ident" id="3608038">tw</span><span class="op" id="3608040">.</span><span class="ident" id="3608041">timedOut</span>&nbsp;<span class="op" id="3608050">||</span>&nbsp;<span class="ident" id="3608053">tw</span><span class="op" id="3608055">.</span><span class="ident" id="3608056">wroteHeader</span>&nbsp;<span class="op" id="3608068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608072">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608083">tw</span><span class="op" id="3608085">.</span><span class="ident" id="3608086">wroteHeader</span>&nbsp;<span class="op" id="3608098">=</span>&nbsp;<span class="builtintype" id="3608100">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608106">tw</span><span class="op" id="3608108">.</span><span class="ident" id="3608109">w</span><span class="op" id="3608110">.</span><span class="ident" id="3608111">WriteHeader</span><span class="op" id="3608122">(</span><span class="ident" id="3608123">code</span><span class="op" id="3608127">)</span><br>
<span class="lineno">1965</span><span class="op" id="3608129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608132">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3608197">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3608266">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3608336">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3608348">type</span>&nbsp;<span class="ident" id="3608353">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3608374">struct</span>&nbsp;<span class="op" id="3608381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608384">*</span><span class="ident" id="3608385">net</span><span class="op" id="3608388">.</span><span class="ident" id="3608389">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3608401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3608404">func</span>&nbsp;<span class="op" id="3608409">(</span><span class="ident" id="3608410">ln</span>&nbsp;<span class="ident" id="3608413">tcpKeepAliveListener</span><span class="op" id="3608433">)</span>&nbsp;<span class="ident" id="3608435">Accept</span><span class="op" id="3608441">(</span><span class="op" id="3608442">)</span>&nbsp;<span class="op" id="3608444">(</span><span class="ident" id="3608445">c</span>&nbsp;<span class="ident" id="3608447">net</span><span class="op" id="3608450">.</span><span class="ident" id="3608451">Conn</span><span class="op" id="3608455">,</span>&nbsp;<span class="ident" id="3608457">err</span>&nbsp;<span class="builtintype" id="3608461">error</span><span class="op" id="3608466">)</span>&nbsp;<span class="op" id="3608468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608471">tc</span><span class="op" id="3608473">,</span>&nbsp;<span class="ident" id="3608475">err</span>&nbsp;<span class="op" id="3608479">:=</span>&nbsp;<span class="ident" id="3608482">ln</span><span class="op" id="3608484">.</span><span class="ident" id="3608485">AcceptTCP</span><span class="op" id="3608494">(</span><span class="op" id="3608495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608498">if</span>&nbsp;<span class="ident" id="3608501">err</span>&nbsp;<span class="op" id="3608505">!=</span>&nbsp;<span class="builtintype" id="3608508">nil</span>&nbsp;<span class="op" id="3608512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608516">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608524">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608527">tc</span><span class="op" id="3608529">.</span><span class="ident" id="3608530">SetKeepAlive</span><span class="op" id="3608542">(</span><span class="builtintype" id="3608543">true</span><span class="op" id="3608547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608550">tc</span><span class="op" id="3608552">.</span><span class="ident" id="3608553">SetKeepAlivePeriod</span><span class="op" id="3608571">(</span><span class="num" id="3608572">3</span>&nbsp;<span class="op" id="3608574">*</span>&nbsp;<span class="ident" id="3608576">time</span><span class="op" id="3608580">.</span><span class="ident" id="3608581">Minute</span><span class="op" id="3608587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608590">return</span>&nbsp;<span class="ident" id="3608597">tc</span><span class="op" id="3608599">,</span>&nbsp;<span class="builtintype" id="3608601">nil</span><br>
<span class="lineno"></span><span class="op" id="3608605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3608608">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3608666">type</span>&nbsp;<span class="ident" id="3608671">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3608692">struct</span><span class="op" id="3608698">{</span><span class="op" id="3608699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3608702">func</span>&nbsp;<span class="op" id="3608707">(</span><span class="ident" id="3608708">globalOptionsHandler</span><span class="op" id="3608728">)</span>&nbsp;<span class="ident" id="3608730">ServeHTTP</span><span class="op" id="3608739">(</span><span class="ident" id="3608740">w</span>&nbsp;<span class="ident" id="3608742">ResponseWriter</span><span class="op" id="3608756">,</span>&nbsp;<span class="ident" id="3608758">r</span>&nbsp;<span class="op" id="3608760">*</span><span class="ident" id="3608761">Request</span><span class="op" id="3608768">)</span>&nbsp;<span class="op" id="3608770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608773">w</span><span class="op" id="3608774">.</span><span class="ident" id="3608775">Header</span><span class="op" id="3608781">(</span><span class="op" id="3608782">)</span><span class="op" id="3608783">.</span><span class="ident" id="3608784">Set</span><span class="op" id="3608787">(</span><span class="string" id="3608788">&#34;Content-Length&#34;</span><span class="op" id="3608804">,</span>&nbsp;<span class="string" id="3608806">&#34;0&#34;</span><span class="op" id="3608809">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608812">if</span>&nbsp;<span class="ident" id="3608815">r</span><span class="op" id="3608816">.</span><span class="ident" id="3608817">ContentLength</span>&nbsp;<span class="op" id="3608831">!=</span>&nbsp;<span class="num" id="3608834">0</span>&nbsp;<span class="op" id="3608836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3608840">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3608897">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3608955">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609012">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609071">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609119">mb</span>&nbsp;<span class="op" id="3609122">:=</span>&nbsp;<span class="ident" id="3609125">MaxBytesReader</span><span class="op" id="3609139">(</span><span class="ident" id="3609140">w</span><span class="op" id="3609141">,</span>&nbsp;<span class="ident" id="3609143">r</span><span class="op" id="3609144">.</span><span class="ident" id="3609145">Body</span><span class="op" id="3609149">,</span>&nbsp;<span class="num" id="3609151">4</span><span class="op" id="3609152">&lt;&lt;</span><span class="num" id="3609154">10</span><span class="op" id="3609156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609160">io</span><span class="op" id="3609162">.</span><span class="ident" id="3609163">Copy</span><span class="op" id="3609167">(</span><span class="ident" id="3609168">ioutil</span><span class="op" id="3609174">.</span><span class="ident" id="3609175">Discard</span><span class="op" id="3609182">,</span>&nbsp;<span class="ident" id="3609184">mb</span><span class="op" id="3609186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609189">}</span><br>
<span class="lineno"></span><span class="op" id="3609191">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3609194">type</span>&nbsp;<span class="ident" id="3609199">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3609220">struct</span><span class="op" id="3609226">{</span><span class="op" id="3609227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3609230">func</span>&nbsp;<span class="op" id="3609235">(</span><span class="ident" id="3609236">eofReaderWithWriteTo</span><span class="op" id="3609256">)</span>&nbsp;<span class="ident" id="3609258">WriteTo</span><span class="op" id="3609265">(</span><span class="ident" id="3609266">io</span><span class="op" id="3609268">.</span><span class="ident" id="3609269">Writer</span><span class="op" id="3609275">)</span>&nbsp;<span class="op" id="3609277">(</span><span class="builtintype" id="3609278">int64</span><span class="op" id="3609283">,</span>&nbsp;<span class="builtintype" id="3609285">error</span><span class="op" id="3609290">)</span>&nbsp;<span class="op" id="3609292">{</span>&nbsp;<span class="keyword" id="3609294">return</span>&nbsp;<span class="num" id="3609301">0</span><span class="op" id="3609302">,</span>&nbsp;<span class="builtintype" id="3609304">nil</span>&nbsp;<span class="op" id="3609308">}</span><br>
<span class="lineno"></span><span class="keyword" id="3609310">func</span>&nbsp;<span class="op" id="3609315">(</span><span class="ident" id="3609316">eofReaderWithWriteTo</span><span class="op" id="3609336">)</span>&nbsp;<span class="ident" id="3609338">Read</span><span class="op" id="3609342">(</span><span class="op" id="3609343">[</span><span class="op" id="3609344">]</span><span class="builtintype" id="3609345">byte</span><span class="op" id="3609349">)</span>&nbsp;<span class="op" id="3609351">(</span><span class="builtintype" id="3609352">int</span><span class="op" id="3609355">,</span>&nbsp;<span class="builtintype" id="3609357">error</span><span class="op" id="3609362">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609372">{</span>&nbsp;<span class="keyword" id="3609374">return</span>&nbsp;<span class="num" id="3609381">0</span><span class="op" id="3609382">,</span>&nbsp;<span class="ident" id="3609384">io</span><span class="op" id="3609386">.</span><span class="ident" id="3609387">EOF</span>&nbsp;<span class="op" id="3609391">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3609394">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3609459">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3609518">var</span>&nbsp;<span class="ident" id="3609522">eofReader</span>&nbsp;<span class="op" id="3609532">=</span>&nbsp;<span class="op" id="3609534">&amp;</span><span class="keyword" id="3609535">struct</span>&nbsp;<span class="op" id="3609542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609545">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609567">io</span><span class="op" id="3609569">.</span><span class="ident" id="3609570">Closer</span><br>
<span class="lineno"></span><span class="op" id="3609577">}</span><span class="op" id="3609578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609581">eofReaderWithWriteTo</span><span class="op" id="3609601">{</span><span class="op" id="3609602">}</span><span class="op" id="3609603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609606">ioutil</span><span class="op" id="3609612">.</span><span class="ident" id="3609613">NopCloser</span><span class="op" id="3609622">(</span><span class="builtintype" id="3609623">nil</span><span class="op" id="3609626">)</span><span class="op" id="3609627">,</span><br>
<span class="lineno"></span><span class="op" id="3609629">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3609632">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3609700">var</span>&nbsp;<span class="ident" id="3609704">_</span>&nbsp;<span class="ident" id="3609706">io</span><span class="op" id="3609708">.</span><span class="ident" id="3609709">WriterTo</span>&nbsp;<span class="op" id="3609718">=</span>&nbsp;<span class="ident" id="3609720">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3609731">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3609793">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3609861">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3609906">type</span>&nbsp;<span class="ident" id="3609911">initNPNRequest</span>&nbsp;<span class="keyword" id="3609926">struct</span>&nbsp;<span class="op" id="3609933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609936">c</span>&nbsp;<span class="op" id="3609938">*</span><span class="ident" id="3609939">tls</span><span class="op" id="3609942">.</span><span class="ident" id="3609943">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609949">h</span>&nbsp;<span class="ident" id="3609951">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3609965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3609968">func</span>&nbsp;<span class="op" id="3609973">(</span><span class="ident" id="3609974">h</span>&nbsp;<span class="ident" id="3609976">initNPNRequest</span><span class="op" id="3609990">)</span>&nbsp;<span class="ident" id="3609992">ServeHTTP</span><span class="op" id="3610001">(</span><span class="ident" id="3610002">rw</span>&nbsp;<span class="ident" id="3610005">ResponseWriter</span><span class="op" id="3610019">,</span>&nbsp;<span class="ident" id="3610021">req</span>&nbsp;<span class="op" id="3610025">*</span><span class="ident" id="3610026">Request</span><span class="op" id="3610033">)</span>&nbsp;<span class="op" id="3610035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610038">if</span>&nbsp;<span class="ident" id="3610041">req</span><span class="op" id="3610044">.</span><span class="ident" id="3610045">TLS</span>&nbsp;<span class="op" id="3610049">==</span>&nbsp;<span class="builtintype" id="3610052">nil</span>&nbsp;<span class="op" id="3610056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610060">req</span><span class="op" id="3610063">.</span><span class="ident" id="3610064">TLS</span>&nbsp;<span class="op" id="3610068">=</span>&nbsp;<span class="op" id="3610070">&amp;</span><span class="ident" id="3610071">tls</span><span class="op" id="3610074">.</span><span class="ident" id="3610075">ConnectionState</span><span class="op" id="3610090">{</span><span class="op" id="3610091">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610095">*</span><span class="ident" id="3610096">req</span><span class="op" id="3610099">.</span><span class="ident" id="3610100">TLS</span>&nbsp;<span class="op" id="3610104">=</span>&nbsp;<span class="ident" id="3610106">h</span><span class="op" id="3610107">.</span><span class="ident" id="3610108">c</span><span class="op" id="3610109">.</span><span class="ident" id="3610110">ConnectionState</span><span class="op" id="3610125">(</span><span class="op" id="3610126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610132">if</span>&nbsp;<span class="ident" id="3610135">req</span><span class="op" id="3610138">.</span><span class="ident" id="3610139">Body</span>&nbsp;<span class="op" id="3610144">==</span>&nbsp;<span class="builtintype" id="3610147">nil</span>&nbsp;<span class="op" id="3610151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610155">req</span><span class="op" id="3610158">.</span><span class="ident" id="3610159">Body</span>&nbsp;<span class="op" id="3610164">=</span>&nbsp;<span class="ident" id="3610166">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610177">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610180">if</span>&nbsp;<span class="ident" id="3610183">req</span><span class="op" id="3610186">.</span><span class="ident" id="3610187">RemoteAddr</span>&nbsp;<span class="op" id="3610198">==</span>&nbsp;<span class="string" id="3610201">&#34;&#34;</span>&nbsp;<span class="op" id="3610204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610208">req</span><span class="op" id="3610211">.</span><span class="ident" id="3610212">RemoteAddr</span>&nbsp;<span class="op" id="3610223">=</span>&nbsp;<span class="ident" id="3610225">h</span><span class="op" id="3610226">.</span><span class="ident" id="3610227">c</span><span class="op" id="3610228">.</span><span class="ident" id="3610229">RemoteAddr</span><span class="op" id="3610239">(</span><span class="op" id="3610240">)</span><span class="op" id="3610241">.</span><span class="ident" id="3610242">String</span><span class="op" id="3610248">(</span><span class="op" id="3610249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610255">h</span><span class="op" id="3610256">.</span><span class="ident" id="3610257">h</span><span class="op" id="3610258">.</span><span class="ident" id="3610259">ServeHTTP</span><span class="op" id="3610268">(</span><span class="ident" id="3610269">rw</span><span class="op" id="3610271">,</span>&nbsp;<span class="ident" id="3610273">req</span><span class="op" id="3610276">)</span><br>
<span class="lineno"></span><span class="op" id="3610278">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3610281">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3610319">type</span>&nbsp;<span class="ident" id="3610324">loggingConn</span>&nbsp;<span class="keyword" id="3610336">struct</span>&nbsp;<span class="op" id="3610343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610346">name</span>&nbsp;<span class="builtintype" id="3610351">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610359">net</span><span class="op" id="3610362">.</span><span class="ident" id="3610363">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3610368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3610371">var</span>&nbsp;<span class="op" id="3610375">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610378">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3610391">sync</span><span class="op" id="3610395">.</span><span class="ident" id="3610396">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610403">uniqNameNext</span>&nbsp;<span class="op" id="3610416">=</span>&nbsp;<span class="builtinfunc" id="3610418">make</span><span class="op" id="3610422">(</span><span class="keyword" id="3610423">map</span><span class="op" id="3610426">[</span><span class="builtintype" id="3610427">string</span><span class="op" id="3610433">]</span><span class="builtintype" id="3610434">int</span><span class="op" id="3610437">)</span><br>
<span class="lineno">2050</span><span class="op" id="3610439">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3610442">func</span>&nbsp;<span class="ident" id="3610447">newLoggingConn</span><span class="op" id="3610461">(</span><span class="ident" id="3610462">baseName</span>&nbsp;<span class="builtintype" id="3610471">string</span><span class="op" id="3610477">,</span>&nbsp;<span class="ident" id="3610479">c</span>&nbsp;<span class="ident" id="3610481">net</span><span class="op" id="3610484">.</span><span class="ident" id="3610485">Conn</span><span class="op" id="3610489">)</span>&nbsp;<span class="ident" id="3610491">net</span><span class="op" id="3610494">.</span><span class="ident" id="3610495">Conn</span>&nbsp;<span class="op" id="3610500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610503">uniqNameMu</span><span class="op" id="3610513">.</span><span class="ident" id="3610514">Lock</span><span class="op" id="3610518">(</span><span class="op" id="3610519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610522">defer</span>&nbsp;<span class="ident" id="3610528">uniqNameMu</span><span class="op" id="3610538">.</span><span class="ident" id="3610539">Unlock</span><span class="op" id="3610545">(</span><span class="op" id="3610546">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610549">uniqNameNext</span><span class="op" id="3610561">[</span><span class="ident" id="3610562">baseName</span><span class="op" id="3610570">]</span><span class="op" id="3610571">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610575">return</span>&nbsp;<span class="op" id="3610582">&amp;</span><span class="ident" id="3610583">loggingConn</span><span class="op" id="3610594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610598">name</span><span class="op" id="3610602">:</span>&nbsp;<span class="ident" id="3610604">fmt</span><span class="op" id="3610607">.</span><span class="ident" id="3610608">Sprintf</span><span class="op" id="3610615">(</span><span class="string" id="3610616">&#34;%s-%d&#34;</span><span class="op" id="3610623">,</span>&nbsp;<span class="ident" id="3610625">baseName</span><span class="op" id="3610633">,</span>&nbsp;<span class="ident" id="3610635">uniqNameNext</span><span class="op" id="3610647">[</span><span class="ident" id="3610648">baseName</span><span class="op" id="3610656">]</span><span class="op" id="3610657">)</span><span class="op" id="3610658">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610662">Conn</span><span class="op" id="3610666">:</span>&nbsp;<span class="ident" id="3610668">c</span><span class="op" id="3610669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610672">}</span><br>
<span class="lineno">2060</span><span class="op" id="3610674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3610677">func</span>&nbsp;<span class="op" id="3610682">(</span><span class="ident" id="3610683">c</span>&nbsp;<span class="op" id="3610685">*</span><span class="ident" id="3610686">loggingConn</span><span class="op" id="3610697">)</span>&nbsp;<span class="ident" id="3610699">Write</span><span class="op" id="3610704">(</span><span class="ident" id="3610705">p</span>&nbsp;<span class="op" id="3610707">[</span><span class="op" id="3610708">]</span><span class="builtintype" id="3610709">byte</span><span class="op" id="3610713">)</span>&nbsp;<span class="op" id="3610715">(</span><span class="ident" id="3610716">n</span>&nbsp;<span class="builtintype" id="3610718">int</span><span class="op" id="3610721">,</span>&nbsp;<span class="ident" id="3610723">err</span>&nbsp;<span class="builtintype" id="3610727">error</span><span class="op" id="3610732">)</span>&nbsp;<span class="op" id="3610734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610737">log</span><span class="op" id="3610740">.</span><span class="ident" id="3610741">Printf</span><span class="op" id="3610747">(</span><span class="string" id="3610748">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3610769">,</span>&nbsp;<span class="ident" id="3610771">c</span><span class="op" id="3610772">.</span><span class="ident" id="3610773">name</span><span class="op" id="3610777">,</span>&nbsp;<span class="builtinfunc" id="3610779">len</span><span class="op" id="3610782">(</span><span class="ident" id="3610783">p</span><span class="op" id="3610784">)</span><span class="op" id="3610785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610788">n</span><span class="op" id="3610789">,</span>&nbsp;<span class="ident" id="3610791">err</span>&nbsp;<span class="op" id="3610795">=</span>&nbsp;<span class="ident" id="3610797">c</span><span class="op" id="3610798">.</span><span class="ident" id="3610799">Conn</span><span class="op" id="3610803">.</span><span class="ident" id="3610804">Write</span><span class="op" id="3610809">(</span><span class="ident" id="3610810">p</span><span class="op" id="3610811">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610814">log</span><span class="op" id="3610817">.</span><span class="ident" id="3610818">Printf</span><span class="op" id="3610824">(</span><span class="string" id="3610825">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3610848">,</span>&nbsp;<span class="ident" id="3610850">c</span><span class="op" id="3610851">.</span><span class="ident" id="3610852">name</span><span class="op" id="3610856">,</span>&nbsp;<span class="builtinfunc" id="3610858">len</span><span class="op" id="3610861">(</span><span class="ident" id="3610862">p</span><span class="op" id="3610863">)</span><span class="op" id="3610864">,</span>&nbsp;<span class="ident" id="3610866">n</span><span class="op" id="3610867">,</span>&nbsp;<span class="ident" id="3610869">err</span><span class="op" id="3610872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610875">return</span><br>
<span class="lineno"></span><span class="op" id="3610882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3610885">func</span>&nbsp;<span class="op" id="3610890">(</span><span class="ident" id="3610891">c</span>&nbsp;<span class="op" id="3610893">*</span><span class="ident" id="3610894">loggingConn</span><span class="op" id="3610905">)</span>&nbsp;<span class="ident" id="3610907">Read</span><span class="op" id="3610911">(</span><span class="ident" id="3610912">p</span>&nbsp;<span class="op" id="3610914">[</span><span class="op" id="3610915">]</span><span class="builtintype" id="3610916">byte</span><span class="op" id="3610920">)</span>&nbsp;<span class="op" id="3610922">(</span><span class="ident" id="3610923">n</span>&nbsp;<span class="builtintype" id="3610925">int</span><span class="op" id="3610928">,</span>&nbsp;<span class="ident" id="3610930">err</span>&nbsp;<span class="builtintype" id="3610934">error</span><span class="op" id="3610939">)</span>&nbsp;<span class="op" id="3610941">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610944">log</span><span class="op" id="3610947">.</span><span class="ident" id="3610948">Printf</span><span class="op" id="3610954">(</span><span class="string" id="3610955">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3610975">,</span>&nbsp;<span class="ident" id="3610977">c</span><span class="op" id="3610978">.</span><span class="ident" id="3610979">name</span><span class="op" id="3610983">,</span>&nbsp;<span class="builtinfunc" id="3610985">len</span><span class="op" id="3610988">(</span><span class="ident" id="3610989">p</span><span class="op" id="3610990">)</span><span class="op" id="3610991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610994">n</span><span class="op" id="3610995">,</span>&nbsp;<span class="ident" id="3610997">err</span>&nbsp;<span class="op" id="3611001">=</span>&nbsp;<span class="ident" id="3611003">c</span><span class="op" id="3611004">.</span><span class="ident" id="3611005">Conn</span><span class="op" id="3611009">.</span><span class="ident" id="3611010">Read</span><span class="op" id="3611014">(</span><span class="ident" id="3611015">p</span><span class="op" id="3611016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611019">log</span><span class="op" id="3611022">.</span><span class="ident" id="3611023">Printf</span><span class="op" id="3611029">(</span><span class="string" id="3611030">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3611052">,</span>&nbsp;<span class="ident" id="3611054">c</span><span class="op" id="3611055">.</span><span class="ident" id="3611056">name</span><span class="op" id="3611060">,</span>&nbsp;<span class="builtinfunc" id="3611062">len</span><span class="op" id="3611065">(</span><span class="ident" id="3611066">p</span><span class="op" id="3611067">)</span><span class="op" id="3611068">,</span>&nbsp;<span class="ident" id="3611070">n</span><span class="op" id="3611071">,</span>&nbsp;<span class="ident" id="3611073">err</span><span class="op" id="3611076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611079">return</span><br>
<span class="lineno"></span><span class="op" id="3611086">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3611089">func</span>&nbsp;<span class="op" id="3611094">(</span><span class="ident" id="3611095">c</span>&nbsp;<span class="op" id="3611097">*</span><span class="ident" id="3611098">loggingConn</span><span class="op" id="3611109">)</span>&nbsp;<span class="ident" id="3611111">Close</span><span class="op" id="3611116">(</span><span class="op" id="3611117">)</span>&nbsp;<span class="op" id="3611119">(</span><span class="ident" id="3611120">err</span>&nbsp;<span class="builtintype" id="3611124">error</span><span class="op" id="3611129">)</span>&nbsp;<span class="op" id="3611131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611134">log</span><span class="op" id="3611137">.</span><span class="ident" id="3611138">Printf</span><span class="op" id="3611144">(</span><span class="string" id="3611145">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3611163">,</span>&nbsp;<span class="ident" id="3611165">c</span><span class="op" id="3611166">.</span><span class="ident" id="3611167">name</span><span class="op" id="3611171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611174">err</span>&nbsp;<span class="op" id="3611178">=</span>&nbsp;<span class="ident" id="3611180">c</span><span class="op" id="3611181">.</span><span class="ident" id="3611182">Conn</span><span class="op" id="3611186">.</span><span class="ident" id="3611187">Close</span><span class="op" id="3611192">(</span><span class="op" id="3611193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611196">log</span><span class="op" id="3611199">.</span><span class="ident" id="3611200">Printf</span><span class="op" id="3611206">(</span><span class="string" id="3611207">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3611224">,</span>&nbsp;<span class="ident" id="3611226">c</span><span class="op" id="3611227">.</span><span class="ident" id="3611228">name</span><span class="op" id="3611232">,</span>&nbsp;<span class="ident" id="3611234">err</span><span class="op" id="3611237">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611240">return</span><br>
<span class="lineno"></span><span class="op" id="3611247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3611250">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3611330">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3611397">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3611456">type</span>&nbsp;<span class="ident" id="3611461">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3611482">struct</span>&nbsp;<span class="op" id="3611489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611492">c</span>&nbsp;<span class="op" id="3611494">*</span><span class="ident" id="3611495">conn</span><br>
<span class="lineno"></span><span class="op" id="3611500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3611503">func</span>&nbsp;<span class="op" id="3611508">(</span><span class="ident" id="3611509">w</span>&nbsp;<span class="ident" id="3611511">checkConnErrorWriter</span><span class="op" id="3611531">)</span>&nbsp;<span class="ident" id="3611533">Write</span><span class="op" id="3611538">(</span><span class="ident" id="3611539">p</span>&nbsp;<span class="op" id="3611541">[</span><span class="op" id="3611542">]</span><span class="builtintype" id="3611543">byte</span><span class="op" id="3611547">)</span>&nbsp;<span class="op" id="3611549">(</span><span class="ident" id="3611550">n</span>&nbsp;<span class="builtintype" id="3611552">int</span><span class="op" id="3611555">,</span>&nbsp;<span class="ident" id="3611557">err</span>&nbsp;<span class="builtintype" id="3611561">error</span><span class="op" id="3611566">)</span>&nbsp;<span class="op" id="3611568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611571">n</span><span class="op" id="3611572">,</span>&nbsp;<span class="ident" id="3611574">err</span>&nbsp;<span class="op" id="3611578">=</span>&nbsp;<span class="ident" id="3611580">w</span><span class="op" id="3611581">.</span><span class="ident" id="3611582">c</span><span class="op" id="3611583">.</span><span class="ident" id="3611584">w</span><span class="op" id="3611585">.</span><span class="ident" id="3611586">Write</span><span class="op" id="3611591">(</span><span class="ident" id="3611592">p</span><span class="op" id="3611593">)</span>&nbsp;<span class="comment" id="3611595">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611653">if</span>&nbsp;<span class="ident" id="3611656">err</span>&nbsp;<span class="op" id="3611660">!=</span>&nbsp;<span class="builtintype" id="3611663">nil</span>&nbsp;<span class="op" id="3611667">&amp;&amp;</span>&nbsp;<span class="ident" id="3611670">w</span><span class="op" id="3611671">.</span><span class="ident" id="3611672">c</span><span class="op" id="3611673">.</span><span class="ident" id="3611674">werr</span>&nbsp;<span class="op" id="3611679">==</span>&nbsp;<span class="builtintype" id="3611682">nil</span>&nbsp;<span class="op" id="3611686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611690">w</span><span class="op" id="3611691">.</span><span class="ident" id="3611692">c</span><span class="op" id="3611693">.</span><span class="ident" id="3611694">werr</span>&nbsp;<span class="op" id="3611699">=</span>&nbsp;<span class="ident" id="3611701">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611706">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611709">return</span><br>
<span class="lineno"></span><span class="op" id="3611716">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
