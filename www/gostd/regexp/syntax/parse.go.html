<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp/syntax</h2>
<ul>
<li><a href="/gostd/regexp/syntax/compile.go.html">compile.go</a></li>
<li><a href="/gostd/regexp/syntax/doc.go.html">doc.go</a></li>
<li><a href="/gostd/regexp/syntax/parse.go.html">parse.go</a></li>
<li><a href="/gostd/regexp/syntax/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/regexp/syntax/perl_groups.go.html">perl_groups.go</a></li>
<li><a href="/gostd/regexp/syntax/prog.go.html">prog.go</a></li>
<li><a href="/gostd/regexp/syntax/prog_test.go.html">prog_test.go</a></li>
<li><a href="/gostd/regexp/syntax/regexp.go.html">regexp.go</a></li>
<li><a href="/gostd/regexp/syntax/simplify.go.html">simplify.go</a></li>
<li><a href="/gostd/regexp/syntax/simplify_test.go.html">simplify_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3438028">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3438084">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3438138">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3438189">package</span>&nbsp;<span class="ident" id="3438197">syntax</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3438205">import</span>&nbsp;<span class="op" id="3438212">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3438215">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3438223">&#34;strings&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3438234">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3438245">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3438260">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3438263">//&nbsp;An&nbsp;Error&nbsp;describes&nbsp;a&nbsp;failure&nbsp;to&nbsp;parse&nbsp;a&nbsp;regular&nbsp;expression</span><br>
<span class="lineno">15</span><span class="comment" id="3438325">//&nbsp;and&nbsp;gives&nbsp;the&nbsp;offending&nbsp;expression.</span><br>
<span class="lineno"></span><span class="keyword" id="3438364">type</span>&nbsp;<span class="ident" id="3438369">Error</span>&nbsp;<span class="keyword" id="3438375">struct</span>&nbsp;<span class="op" id="3438382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438385">Code</span>&nbsp;<span class="ident" id="3438390">ErrorCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438401">Expr</span>&nbsp;<span class="builtintype" id="3438406">string</span><br>
<span class="lineno"></span><span class="op" id="3438413">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3438416">func</span>&nbsp;<span class="op" id="3438421">(</span><span class="ident" id="3438422">e</span>&nbsp;<span class="op" id="3438424">*</span><span class="ident" id="3438425">Error</span><span class="op" id="3438430">)</span>&nbsp;<span class="ident" id="3438432">Error</span><span class="op" id="3438437">(</span><span class="op" id="3438438">)</span>&nbsp;<span class="builtintype" id="3438440">string</span>&nbsp;<span class="op" id="3438447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438450">return</span>&nbsp;<span class="string" id="3438457">&#34;error&nbsp;parsing&nbsp;regexp:&nbsp;&#34;</span>&nbsp;<span class="op" id="3438482">+</span>&nbsp;<span class="ident" id="3438484">e</span><span class="op" id="3438485">.</span><span class="ident" id="3438486">Code</span><span class="op" id="3438490">.</span><span class="ident" id="3438491">String</span><span class="op" id="3438497">(</span><span class="op" id="3438498">)</span>&nbsp;<span class="op" id="3438500">+</span>&nbsp;<span class="string" id="3438502">&#34;:&nbsp;`&#34;</span>&nbsp;<span class="op" id="3438508">+</span>&nbsp;<span class="ident" id="3438510">e</span><span class="op" id="3438511">.</span><span class="ident" id="3438512">Expr</span>&nbsp;<span class="op" id="3438517">+</span>&nbsp;<span class="string" id="3438519">&#34;`&#34;</span><br>
<span class="lineno"></span><span class="op" id="3438523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3438526">//&nbsp;An&nbsp;ErrorCode&nbsp;describes&nbsp;a&nbsp;failure&nbsp;to&nbsp;parse&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span><span class="keyword" id="3438593">type</span>&nbsp;<span class="ident" id="3438598">ErrorCode</span>&nbsp;<span class="builtintype" id="3438608">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3438616">const</span>&nbsp;<span class="op" id="3438622">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438625">//&nbsp;Unexpected&nbsp;error</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438646">ErrInternalError</span>&nbsp;<span class="ident" id="3438663">ErrorCode</span>&nbsp;<span class="op" id="3438673">=</span>&nbsp;<span class="string" id="3438675">&#34;regexp/syntax:&nbsp;internal&nbsp;error&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438709">//&nbsp;Parse&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438726">ErrInvalidCharClass</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3438751">ErrorCode</span>&nbsp;<span class="op" id="3438761">=</span>&nbsp;<span class="string" id="3438763">&#34;invalid&nbsp;character&nbsp;class&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438790">ErrInvalidCharRange</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3438815">ErrorCode</span>&nbsp;<span class="op" id="3438825">=</span>&nbsp;<span class="string" id="3438827">&#34;invalid&nbsp;character&nbsp;class&nbsp;range&#34;</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438860">ErrInvalidEscape</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3438885">ErrorCode</span>&nbsp;<span class="op" id="3438895">=</span>&nbsp;<span class="string" id="3438897">&#34;invalid&nbsp;escape&nbsp;sequence&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438924">ErrInvalidNamedCapture</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3438949">ErrorCode</span>&nbsp;<span class="op" id="3438959">=</span>&nbsp;<span class="string" id="3438961">&#34;invalid&nbsp;named&nbsp;capture&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438986">ErrInvalidPerlOp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439011">ErrorCode</span>&nbsp;<span class="op" id="3439021">=</span>&nbsp;<span class="string" id="3439023">&#34;invalid&nbsp;or&nbsp;unsupported&nbsp;Perl&nbsp;syntax&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439061">ErrInvalidRepeatOp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439086">ErrorCode</span>&nbsp;<span class="op" id="3439096">=</span>&nbsp;<span class="string" id="3439098">&#34;invalid&nbsp;nested&nbsp;repetition&nbsp;operator&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439136">ErrInvalidRepeatSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439161">ErrorCode</span>&nbsp;<span class="op" id="3439171">=</span>&nbsp;<span class="string" id="3439173">&#34;invalid&nbsp;repeat&nbsp;count&#34;</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439197">ErrInvalidUTF8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439222">ErrorCode</span>&nbsp;<span class="op" id="3439232">=</span>&nbsp;<span class="string" id="3439234">&#34;invalid&nbsp;UTF-8&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439251">ErrMissingBracket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439276">ErrorCode</span>&nbsp;<span class="op" id="3439286">=</span>&nbsp;<span class="string" id="3439288">&#34;missing&nbsp;closing&nbsp;]&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439309">ErrMissingParen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439334">ErrorCode</span>&nbsp;<span class="op" id="3439344">=</span>&nbsp;<span class="string" id="3439346">&#34;missing&nbsp;closing&nbsp;)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439367">ErrMissingRepeatArgument</span>&nbsp;<span class="ident" id="3439392">ErrorCode</span>&nbsp;<span class="op" id="3439402">=</span>&nbsp;<span class="string" id="3439404">&#34;missing&nbsp;argument&nbsp;to&nbsp;repetition&nbsp;operator&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439447">ErrTrailingBackslash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439472">ErrorCode</span>&nbsp;<span class="op" id="3439482">=</span>&nbsp;<span class="string" id="3439484">&#34;trailing&nbsp;backslash&nbsp;at&nbsp;end&nbsp;of&nbsp;expression&#34;</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439527">ErrUnexpectedParen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439552">ErrorCode</span>&nbsp;<span class="op" id="3439562">=</span>&nbsp;<span class="string" id="3439564">&#34;unexpected&nbsp;)&#34;</span><br>
<span class="lineno"></span><span class="op" id="3439579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3439582">func</span>&nbsp;<span class="op" id="3439587">(</span><span class="ident" id="3439588">e</span>&nbsp;<span class="ident" id="3439590">ErrorCode</span><span class="op" id="3439599">)</span>&nbsp;<span class="ident" id="3439601">String</span><span class="op" id="3439607">(</span><span class="op" id="3439608">)</span>&nbsp;<span class="builtintype" id="3439610">string</span>&nbsp;<span class="op" id="3439617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439620">return</span>&nbsp;<span class="builtintype" id="3439627">string</span><span class="op" id="3439633">(</span><span class="ident" id="3439634">e</span><span class="op" id="3439635">)</span><br>
<span class="lineno">50</span><span class="op" id="3439637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3439640">//&nbsp;Flags&nbsp;control&nbsp;the&nbsp;behavior&nbsp;of&nbsp;the&nbsp;parser&nbsp;and&nbsp;record&nbsp;information&nbsp;about&nbsp;regexp&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="3439729">type</span>&nbsp;<span class="ident" id="3439734">Flags</span>&nbsp;<span class="builtintype" id="3439740">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="3439748">const</span>&nbsp;<span class="op" id="3439754">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439757">FoldCase</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3439771">Flags</span>&nbsp;<span class="op" id="3439777">=</span>&nbsp;<span class="num" id="3439779">1</span>&nbsp;<span class="op" id="3439781">&lt;&lt;</span>&nbsp;<span class="ident" id="3439784">iota</span>&nbsp;<span class="comment" id="3439789">//&nbsp;case-insensitive&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439816">Literal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3439848">//&nbsp;treat&nbsp;pattern&nbsp;as&nbsp;literal&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439884">ClassNL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3439916">//&nbsp;allow&nbsp;character&nbsp;classes&nbsp;like&nbsp;[^a-z]&nbsp;and&nbsp;[[:space:]]&nbsp;to&nbsp;match&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439989">DotNL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440021">//&nbsp;allow&nbsp;.&nbsp;to&nbsp;match&nbsp;newline</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440050">OneLine</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440082">//&nbsp;treat&nbsp;^&nbsp;and&nbsp;$&nbsp;as&nbsp;only&nbsp;matching&nbsp;at&nbsp;beginning&nbsp;and&nbsp;end&nbsp;of&nbsp;text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440146">NonGreedy</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440178">//&nbsp;make&nbsp;repetition&nbsp;operators&nbsp;default&nbsp;to&nbsp;non-greedy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440230">PerlX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440262">//&nbsp;allow&nbsp;Perl&nbsp;extensions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440288">UnicodeGroups</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440320">//&nbsp;allow&nbsp;\p{Han},&nbsp;\P{Han}&nbsp;for&nbsp;Unicode&nbsp;group&nbsp;and&nbsp;negation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440378">WasDollar</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440410">//&nbsp;regexp&nbsp;OpEndText&nbsp;was&nbsp;$,&nbsp;not&nbsp;\z</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440445">Simple</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440477">//&nbsp;regexp&nbsp;contains&nbsp;no&nbsp;counted&nbsp;repetition</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440520">MatchNL</span>&nbsp;<span class="op" id="3440528">=</span>&nbsp;<span class="ident" id="3440530">ClassNL</span>&nbsp;<span class="op" id="3440538">|</span>&nbsp;<span class="ident" id="3440540">DotNL</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440548">Perl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3440560">=</span>&nbsp;<span class="ident" id="3440562">ClassNL</span>&nbsp;<span class="op" id="3440570">|</span>&nbsp;<span class="ident" id="3440572">OneLine</span>&nbsp;<span class="op" id="3440580">|</span>&nbsp;<span class="ident" id="3440582">PerlX</span>&nbsp;<span class="op" id="3440588">|</span>&nbsp;<span class="ident" id="3440590">UnicodeGroups</span>&nbsp;<span class="comment" id="3440604">//&nbsp;as&nbsp;close&nbsp;to&nbsp;Perl&nbsp;as&nbsp;possible</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440637">POSIX</span>&nbsp;<span class="ident" id="3440643">Flags</span>&nbsp;<span class="op" id="3440649">=</span>&nbsp;<span class="num" id="3440651">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440693">//&nbsp;POSIX&nbsp;syntax</span><br>
<span class="lineno"></span><span class="op" id="3440709">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3440712">//&nbsp;Pseudo-ops&nbsp;for&nbsp;parsing&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="3440745">const</span>&nbsp;<span class="op" id="3440751">(</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440754">opLeftParen</span>&nbsp;<span class="op" id="3440766">=</span>&nbsp;<span class="ident" id="3440768">opPseudo</span>&nbsp;<span class="op" id="3440777">+</span>&nbsp;<span class="ident" id="3440779">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440785">opVerticalBar</span><br>
<span class="lineno"></span><span class="op" id="3440799">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3440802">type</span>&nbsp;<span class="ident" id="3440807">parser</span>&nbsp;<span class="keyword" id="3440814">struct</span>&nbsp;<span class="op" id="3440821">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440824">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3440836">Flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3440846">//&nbsp;parse&nbsp;mode&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440867">stack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3440879">[</span><span class="op" id="3440880">]</span><span class="op" id="3440881">*</span><span class="ident" id="3440882">Regexp</span>&nbsp;<span class="comment" id="3440889">//&nbsp;stack&nbsp;of&nbsp;parsed&nbsp;expressions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440921">free</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3440933">*</span><span class="ident" id="3440934">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440942">numCap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3440954">int</span>&nbsp;<span class="comment" id="3440958">//&nbsp;number&nbsp;of&nbsp;capturing&nbsp;groups&nbsp;seen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440994">wholeRegexp</span>&nbsp;<span class="builtintype" id="3441006">string</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441014">tmpClass</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3441026">[</span><span class="op" id="3441027">]</span><span class="builtintype" id="3441028">rune</span>&nbsp;<span class="comment" id="3441033">//&nbsp;temporary&nbsp;char&nbsp;class&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span><span class="op" id="3441068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3441071">func</span>&nbsp;<span class="op" id="3441076">(</span><span class="ident" id="3441077">p</span>&nbsp;<span class="op" id="3441079">*</span><span class="ident" id="3441080">parser</span><span class="op" id="3441086">)</span>&nbsp;<span class="ident" id="3441088">newRegexp</span><span class="op" id="3441097">(</span><span class="ident" id="3441098">op</span>&nbsp;<span class="ident" id="3441101">Op</span><span class="op" id="3441103">)</span>&nbsp;<span class="op" id="3441105">*</span><span class="ident" id="3441106">Regexp</span>&nbsp;<span class="op" id="3441113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441116">re</span>&nbsp;<span class="op" id="3441119">:=</span>&nbsp;<span class="ident" id="3441122">p</span><span class="op" id="3441123">.</span><span class="ident" id="3441124">free</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441130">if</span>&nbsp;<span class="ident" id="3441133">re</span>&nbsp;<span class="op" id="3441136">!=</span>&nbsp;<span class="ident" id="3441139">nil</span>&nbsp;<span class="op" id="3441143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441147">p</span><span class="op" id="3441148">.</span><span class="ident" id="3441149">free</span>&nbsp;<span class="op" id="3441154">=</span>&nbsp;<span class="ident" id="3441156">re</span><span class="op" id="3441158">.</span><span class="ident" id="3441159">Sub0</span><span class="op" id="3441163">[</span><span class="num" id="3441164">0</span><span class="op" id="3441165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441169">*</span><span class="ident" id="3441170">re</span>&nbsp;<span class="op" id="3441173">=</span>&nbsp;<span class="ident" id="3441175">Regexp</span><span class="op" id="3441181">{</span><span class="op" id="3441182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441185">}</span>&nbsp;<span class="keyword" id="3441187">else</span>&nbsp;<span class="op" id="3441192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441196">re</span>&nbsp;<span class="op" id="3441199">=</span>&nbsp;<span class="builtinfunc" id="3441201">new</span><span class="op" id="3441204">(</span><span class="ident" id="3441205">Regexp</span><span class="op" id="3441211">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441217">re</span><span class="op" id="3441219">.</span><span class="ident" id="3441220">Op</span>&nbsp;<span class="op" id="3441223">=</span>&nbsp;<span class="ident" id="3441225">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441229">return</span>&nbsp;<span class="ident" id="3441236">re</span><br>
<span class="lineno"></span><span class="op" id="3441239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3441242">func</span>&nbsp;<span class="op" id="3441247">(</span><span class="ident" id="3441248">p</span>&nbsp;<span class="op" id="3441250">*</span><span class="ident" id="3441251">parser</span><span class="op" id="3441257">)</span>&nbsp;<span class="ident" id="3441259">reuse</span><span class="op" id="3441264">(</span><span class="ident" id="3441265">re</span>&nbsp;<span class="op" id="3441268">*</span><span class="ident" id="3441269">Regexp</span><span class="op" id="3441275">)</span>&nbsp;<span class="op" id="3441277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441280">re</span><span class="op" id="3441282">.</span><span class="ident" id="3441283">Sub0</span><span class="op" id="3441287">[</span><span class="num" id="3441288">0</span><span class="op" id="3441289">]</span>&nbsp;<span class="op" id="3441291">=</span>&nbsp;<span class="ident" id="3441293">p</span><span class="op" id="3441294">.</span><span class="ident" id="3441295">free</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441301">p</span><span class="op" id="3441302">.</span><span class="ident" id="3441303">free</span>&nbsp;<span class="op" id="3441308">=</span>&nbsp;<span class="ident" id="3441310">re</span><br>
<span class="lineno"></span><span class="op" id="3441313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3441316">//&nbsp;Parse&nbsp;stack&nbsp;manipulation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3441346">//&nbsp;push&nbsp;pushes&nbsp;the&nbsp;regexp&nbsp;re&nbsp;onto&nbsp;the&nbsp;parse&nbsp;stack&nbsp;and&nbsp;returns&nbsp;the&nbsp;regexp.</span><br>
<span class="lineno"></span><span class="keyword" id="3441420">func</span>&nbsp;<span class="op" id="3441425">(</span><span class="ident" id="3441426">p</span>&nbsp;<span class="op" id="3441428">*</span><span class="ident" id="3441429">parser</span><span class="op" id="3441435">)</span>&nbsp;<span class="ident" id="3441437">push</span><span class="op" id="3441441">(</span><span class="ident" id="3441442">re</span>&nbsp;<span class="op" id="3441445">*</span><span class="ident" id="3441446">Regexp</span><span class="op" id="3441452">)</span>&nbsp;<span class="op" id="3441454">*</span><span class="ident" id="3441455">Regexp</span>&nbsp;<span class="op" id="3441462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441465">if</span>&nbsp;<span class="ident" id="3441468">re</span><span class="op" id="3441470">.</span><span class="ident" id="3441471">Op</span>&nbsp;<span class="op" id="3441474">==</span>&nbsp;<span class="ident" id="3441477">OpCharClass</span>&nbsp;<span class="op" id="3441489">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3441492">len</span><span class="op" id="3441495">(</span><span class="ident" id="3441496">re</span><span class="op" id="3441498">.</span><span class="ident" id="3441499">Rune</span><span class="op" id="3441503">)</span>&nbsp;<span class="op" id="3441505">==</span>&nbsp;<span class="num" id="3441508">2</span>&nbsp;<span class="op" id="3441510">&amp;&amp;</span>&nbsp;<span class="ident" id="3441513">re</span><span class="op" id="3441515">.</span><span class="ident" id="3441516">Rune</span><span class="op" id="3441520">[</span><span class="num" id="3441521">0</span><span class="op" id="3441522">]</span>&nbsp;<span class="op" id="3441524">==</span>&nbsp;<span class="ident" id="3441527">re</span><span class="op" id="3441529">.</span><span class="ident" id="3441530">Rune</span><span class="op" id="3441534">[</span><span class="num" id="3441535">1</span><span class="op" id="3441536">]</span>&nbsp;<span class="op" id="3441538">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441542">//&nbsp;Single&nbsp;rune.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441560">if</span>&nbsp;<span class="ident" id="3441563">p</span><span class="op" id="3441564">.</span><span class="ident" id="3441565">maybeConcat</span><span class="op" id="3441576">(</span><span class="ident" id="3441577">re</span><span class="op" id="3441579">.</span><span class="ident" id="3441580">Rune</span><span class="op" id="3441584">[</span><span class="num" id="3441585">0</span><span class="op" id="3441586">]</span><span class="op" id="3441587">,</span>&nbsp;<span class="ident" id="3441589">p</span><span class="op" id="3441590">.</span><span class="ident" id="3441591">flags</span><span class="op" id="3441596">&amp;^</span><span class="ident" id="3441598">FoldCase</span><span class="op" id="3441606">)</span>&nbsp;<span class="op" id="3441608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441613">return</span>&nbsp;<span class="ident" id="3441620">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441630">re</span><span class="op" id="3441632">.</span><span class="ident" id="3441633">Op</span>&nbsp;<span class="op" id="3441636">=</span>&nbsp;<span class="ident" id="3441638">OpLiteral</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441650">re</span><span class="op" id="3441652">.</span><span class="ident" id="3441653">Rune</span>&nbsp;<span class="op" id="3441658">=</span>&nbsp;<span class="ident" id="3441660">re</span><span class="op" id="3441662">.</span><span class="ident" id="3441663">Rune</span><span class="op" id="3441667">[</span><span class="op" id="3441668">:</span><span class="num" id="3441669">1</span><span class="op" id="3441670">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441674">re</span><span class="op" id="3441676">.</span><span class="ident" id="3441677">Flags</span>&nbsp;<span class="op" id="3441683">=</span>&nbsp;<span class="ident" id="3441685">p</span><span class="op" id="3441686">.</span><span class="ident" id="3441687">flags</span>&nbsp;<span class="op" id="3441693">&amp;^</span>&nbsp;<span class="ident" id="3441696">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441706">}</span>&nbsp;<span class="keyword" id="3441708">else</span>&nbsp;<span class="keyword" id="3441713">if</span>&nbsp;<span class="ident" id="3441716">re</span><span class="op" id="3441718">.</span><span class="ident" id="3441719">Op</span>&nbsp;<span class="op" id="3441722">==</span>&nbsp;<span class="ident" id="3441725">OpCharClass</span>&nbsp;<span class="op" id="3441737">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3441740">len</span><span class="op" id="3441743">(</span><span class="ident" id="3441744">re</span><span class="op" id="3441746">.</span><span class="ident" id="3441747">Rune</span><span class="op" id="3441751">)</span>&nbsp;<span class="op" id="3441753">==</span>&nbsp;<span class="num" id="3441756">4</span>&nbsp;<span class="op" id="3441758">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441763">re</span><span class="op" id="3441765">.</span><span class="ident" id="3441766">Rune</span><span class="op" id="3441770">[</span><span class="num" id="3441771">0</span><span class="op" id="3441772">]</span>&nbsp;<span class="op" id="3441774">==</span>&nbsp;<span class="ident" id="3441777">re</span><span class="op" id="3441779">.</span><span class="ident" id="3441780">Rune</span><span class="op" id="3441784">[</span><span class="num" id="3441785">1</span><span class="op" id="3441786">]</span>&nbsp;<span class="op" id="3441788">&amp;&amp;</span>&nbsp;<span class="ident" id="3441791">re</span><span class="op" id="3441793">.</span><span class="ident" id="3441794">Rune</span><span class="op" id="3441798">[</span><span class="num" id="3441799">2</span><span class="op" id="3441800">]</span>&nbsp;<span class="op" id="3441802">==</span>&nbsp;<span class="ident" id="3441805">re</span><span class="op" id="3441807">.</span><span class="ident" id="3441808">Rune</span><span class="op" id="3441812">[</span><span class="num" id="3441813">3</span><span class="op" id="3441814">]</span>&nbsp;<span class="op" id="3441816">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441821">unicode</span><span class="op" id="3441828">.</span><span class="ident" id="3441829">SimpleFold</span><span class="op" id="3441839">(</span><span class="ident" id="3441840">re</span><span class="op" id="3441842">.</span><span class="ident" id="3441843">Rune</span><span class="op" id="3441847">[</span><span class="num" id="3441848">0</span><span class="op" id="3441849">]</span><span class="op" id="3441850">)</span>&nbsp;<span class="op" id="3441852">==</span>&nbsp;<span class="ident" id="3441855">re</span><span class="op" id="3441857">.</span><span class="ident" id="3441858">Rune</span><span class="op" id="3441862">[</span><span class="num" id="3441863">2</span><span class="op" id="3441864">]</span>&nbsp;<span class="op" id="3441866">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441871">unicode</span><span class="op" id="3441878">.</span><span class="ident" id="3441879">SimpleFold</span><span class="op" id="3441889">(</span><span class="ident" id="3441890">re</span><span class="op" id="3441892">.</span><span class="ident" id="3441893">Rune</span><span class="op" id="3441897">[</span><span class="num" id="3441898">2</span><span class="op" id="3441899">]</span><span class="op" id="3441900">)</span>&nbsp;<span class="op" id="3441902">==</span>&nbsp;<span class="ident" id="3441905">re</span><span class="op" id="3441907">.</span><span class="ident" id="3441908">Rune</span><span class="op" id="3441912">[</span><span class="num" id="3441913">0</span><span class="op" id="3441914">]</span>&nbsp;<span class="op" id="3441916">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441921">re</span><span class="op" id="3441923">.</span><span class="ident" id="3441924">Op</span>&nbsp;<span class="op" id="3441927">==</span>&nbsp;<span class="ident" id="3441930">OpCharClass</span>&nbsp;<span class="op" id="3441942">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3441945">len</span><span class="op" id="3441948">(</span><span class="ident" id="3441949">re</span><span class="op" id="3441951">.</span><span class="ident" id="3441952">Rune</span><span class="op" id="3441956">)</span>&nbsp;<span class="op" id="3441958">==</span>&nbsp;<span class="num" id="3441961">2</span>&nbsp;<span class="op" id="3441963">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441969">re</span><span class="op" id="3441971">.</span><span class="ident" id="3441972">Rune</span><span class="op" id="3441976">[</span><span class="num" id="3441977">0</span><span class="op" id="3441978">]</span><span class="op" id="3441979">+</span><span class="num" id="3441980">1</span>&nbsp;<span class="op" id="3441982">==</span>&nbsp;<span class="ident" id="3441985">re</span><span class="op" id="3441987">.</span><span class="ident" id="3441988">Rune</span><span class="op" id="3441992">[</span><span class="num" id="3441993">1</span><span class="op" id="3441994">]</span>&nbsp;<span class="op" id="3441996">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442002">unicode</span><span class="op" id="3442009">.</span><span class="ident" id="3442010">SimpleFold</span><span class="op" id="3442020">(</span><span class="ident" id="3442021">re</span><span class="op" id="3442023">.</span><span class="ident" id="3442024">Rune</span><span class="op" id="3442028">[</span><span class="num" id="3442029">0</span><span class="op" id="3442030">]</span><span class="op" id="3442031">)</span>&nbsp;<span class="op" id="3442033">==</span>&nbsp;<span class="ident" id="3442036">re</span><span class="op" id="3442038">.</span><span class="ident" id="3442039">Rune</span><span class="op" id="3442043">[</span><span class="num" id="3442044">1</span><span class="op" id="3442045">]</span>&nbsp;<span class="op" id="3442047">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442053">unicode</span><span class="op" id="3442060">.</span><span class="ident" id="3442061">SimpleFold</span><span class="op" id="3442071">(</span><span class="ident" id="3442072">re</span><span class="op" id="3442074">.</span><span class="ident" id="3442075">Rune</span><span class="op" id="3442079">[</span><span class="num" id="3442080">1</span><span class="op" id="3442081">]</span><span class="op" id="3442082">)</span>&nbsp;<span class="op" id="3442084">==</span>&nbsp;<span class="ident" id="3442087">re</span><span class="op" id="3442089">.</span><span class="ident" id="3442090">Rune</span><span class="op" id="3442094">[</span><span class="num" id="3442095">0</span><span class="op" id="3442096">]</span>&nbsp;<span class="op" id="3442098">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442102">//&nbsp;Case-insensitive&nbsp;rune&nbsp;like&nbsp;[Aa]&nbsp;or&nbsp;[Δδ].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442150">if</span>&nbsp;<span class="ident" id="3442153">p</span><span class="op" id="3442154">.</span><span class="ident" id="3442155">maybeConcat</span><span class="op" id="3442166">(</span><span class="ident" id="3442167">re</span><span class="op" id="3442169">.</span><span class="ident" id="3442170">Rune</span><span class="op" id="3442174">[</span><span class="num" id="3442175">0</span><span class="op" id="3442176">]</span><span class="op" id="3442177">,</span>&nbsp;<span class="ident" id="3442179">p</span><span class="op" id="3442180">.</span><span class="ident" id="3442181">flags</span><span class="op" id="3442186">|</span><span class="ident" id="3442187">FoldCase</span><span class="op" id="3442195">)</span>&nbsp;<span class="op" id="3442197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442202">return</span>&nbsp;<span class="ident" id="3442209">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442220">//&nbsp;Rewrite&nbsp;as&nbsp;(case-insensitive)&nbsp;literal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442264">re</span><span class="op" id="3442266">.</span><span class="ident" id="3442267">Op</span>&nbsp;<span class="op" id="3442270">=</span>&nbsp;<span class="ident" id="3442272">OpLiteral</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442284">re</span><span class="op" id="3442286">.</span><span class="ident" id="3442287">Rune</span>&nbsp;<span class="op" id="3442292">=</span>&nbsp;<span class="ident" id="3442294">re</span><span class="op" id="3442296">.</span><span class="ident" id="3442297">Rune</span><span class="op" id="3442301">[</span><span class="op" id="3442302">:</span><span class="num" id="3442303">1</span><span class="op" id="3442304">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442308">re</span><span class="op" id="3442310">.</span><span class="ident" id="3442311">Flags</span>&nbsp;<span class="op" id="3442317">=</span>&nbsp;<span class="ident" id="3442319">p</span><span class="op" id="3442320">.</span><span class="ident" id="3442321">flags</span>&nbsp;<span class="op" id="3442327">|</span>&nbsp;<span class="ident" id="3442329">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442339">}</span>&nbsp;<span class="keyword" id="3442341">else</span>&nbsp;<span class="op" id="3442346">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442350">//&nbsp;Incremental&nbsp;concatenation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442382">p</span><span class="op" id="3442383">.</span><span class="ident" id="3442384">maybeConcat</span><span class="op" id="3442395">(</span><span class="op" id="3442396">-</span><span class="num" id="3442397">1</span><span class="op" id="3442398">,</span>&nbsp;<span class="num" id="3442400">0</span><span class="op" id="3442401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442408">p</span><span class="op" id="3442409">.</span><span class="ident" id="3442410">stack</span>&nbsp;<span class="op" id="3442416">=</span>&nbsp;<span class="builtinfunc" id="3442418">append</span><span class="op" id="3442424">(</span><span class="ident" id="3442425">p</span><span class="op" id="3442426">.</span><span class="ident" id="3442427">stack</span><span class="op" id="3442432">,</span>&nbsp;<span class="ident" id="3442434">re</span><span class="op" id="3442436">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442439">return</span>&nbsp;<span class="ident" id="3442446">re</span><br>
<span class="lineno"></span><span class="op" id="3442449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3442452">//&nbsp;maybeConcat&nbsp;implements&nbsp;incremental&nbsp;concatenation</span><br>
<span class="lineno"></span><span class="comment" id="3442504">//&nbsp;of&nbsp;literal&nbsp;runes&nbsp;into&nbsp;string&nbsp;nodes.&nbsp;&nbsp;The&nbsp;parser&nbsp;calls&nbsp;this</span><br>
<span class="lineno">145</span><span class="comment" id="3442566">//&nbsp;before&nbsp;each&nbsp;push,&nbsp;so&nbsp;only&nbsp;the&nbsp;top&nbsp;fragment&nbsp;of&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="3442625">//&nbsp;might&nbsp;need&nbsp;processing.&nbsp;&nbsp;Since&nbsp;this&nbsp;is&nbsp;called&nbsp;before&nbsp;a&nbsp;push,</span><br>
<span class="lineno"></span><span class="comment" id="3442688">//&nbsp;the&nbsp;topmost&nbsp;literal&nbsp;is&nbsp;no&nbsp;longer&nbsp;subject&nbsp;to&nbsp;operators&nbsp;like&nbsp;*</span><br>
<span class="lineno"></span><span class="comment" id="3442752">//&nbsp;(Otherwise&nbsp;ab*&nbsp;would&nbsp;turn&nbsp;into&nbsp;(ab)*.)</span><br>
<span class="lineno"></span><span class="comment" id="3442794">//&nbsp;If&nbsp;r&nbsp;&gt;=&nbsp;0&nbsp;and&nbsp;there&#39;s&nbsp;a&nbsp;node&nbsp;left&nbsp;over,&nbsp;maybeConcat&nbsp;uses&nbsp;it</span><br>
<span class="lineno">150</span><span class="comment" id="3442857">//&nbsp;to&nbsp;push&nbsp;r&nbsp;with&nbsp;the&nbsp;given&nbsp;flags.</span><br>
<span class="lineno"></span><span class="comment" id="3442892">//&nbsp;maybeConcat&nbsp;reports&nbsp;whether&nbsp;r&nbsp;was&nbsp;pushed.</span><br>
<span class="lineno"></span><span class="keyword" id="3442937">func</span>&nbsp;<span class="op" id="3442942">(</span><span class="ident" id="3442943">p</span>&nbsp;<span class="op" id="3442945">*</span><span class="ident" id="3442946">parser</span><span class="op" id="3442952">)</span>&nbsp;<span class="ident" id="3442954">maybeConcat</span><span class="op" id="3442965">(</span><span class="ident" id="3442966">r</span>&nbsp;<span class="builtintype" id="3442968">rune</span><span class="op" id="3442972">,</span>&nbsp;<span class="ident" id="3442974">flags</span>&nbsp;<span class="ident" id="3442980">Flags</span><span class="op" id="3442985">)</span>&nbsp;<span class="builtintype" id="3442987">bool</span>&nbsp;<span class="op" id="3442992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442995">n</span>&nbsp;<span class="op" id="3442997">:=</span>&nbsp;<span class="builtinfunc" id="3443000">len</span><span class="op" id="3443003">(</span><span class="ident" id="3443004">p</span><span class="op" id="3443005">.</span><span class="ident" id="3443006">stack</span><span class="op" id="3443011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443014">if</span>&nbsp;<span class="ident" id="3443017">n</span>&nbsp;<span class="op" id="3443019">&lt;</span>&nbsp;<span class="num" id="3443021">2</span>&nbsp;<span class="op" id="3443023">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443027">return</span>&nbsp;<span class="builtintype" id="3443034">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443045">re1</span>&nbsp;<span class="op" id="3443049">:=</span>&nbsp;<span class="ident" id="3443052">p</span><span class="op" id="3443053">.</span><span class="ident" id="3443054">stack</span><span class="op" id="3443059">[</span><span class="ident" id="3443060">n</span><span class="op" id="3443061">-</span><span class="num" id="3443062">1</span><span class="op" id="3443063">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443066">re2</span>&nbsp;<span class="op" id="3443070">:=</span>&nbsp;<span class="ident" id="3443073">p</span><span class="op" id="3443074">.</span><span class="ident" id="3443075">stack</span><span class="op" id="3443080">[</span><span class="ident" id="3443081">n</span><span class="op" id="3443082">-</span><span class="num" id="3443083">2</span><span class="op" id="3443084">]</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443087">if</span>&nbsp;<span class="ident" id="3443090">re1</span><span class="op" id="3443093">.</span><span class="ident" id="3443094">Op</span>&nbsp;<span class="op" id="3443097">!=</span>&nbsp;<span class="ident" id="3443100">OpLiteral</span>&nbsp;<span class="op" id="3443110">||</span>&nbsp;<span class="ident" id="3443113">re2</span><span class="op" id="3443116">.</span><span class="ident" id="3443117">Op</span>&nbsp;<span class="op" id="3443120">!=</span>&nbsp;<span class="ident" id="3443123">OpLiteral</span>&nbsp;<span class="op" id="3443133">||</span>&nbsp;<span class="ident" id="3443136">re1</span><span class="op" id="3443139">.</span><span class="ident" id="3443140">Flags</span><span class="op" id="3443145">&amp;</span><span class="ident" id="3443146">FoldCase</span>&nbsp;<span class="op" id="3443155">!=</span>&nbsp;<span class="ident" id="3443158">re2</span><span class="op" id="3443161">.</span><span class="ident" id="3443162">Flags</span><span class="op" id="3443167">&amp;</span><span class="ident" id="3443168">FoldCase</span>&nbsp;<span class="op" id="3443177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443181">return</span>&nbsp;<span class="builtintype" id="3443188">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443199">//&nbsp;Push&nbsp;re1&nbsp;into&nbsp;re2.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443222">re2</span><span class="op" id="3443225">.</span><span class="ident" id="3443226">Rune</span>&nbsp;<span class="op" id="3443231">=</span>&nbsp;<span class="builtinfunc" id="3443233">append</span><span class="op" id="3443239">(</span><span class="ident" id="3443240">re2</span><span class="op" id="3443243">.</span><span class="ident" id="3443244">Rune</span><span class="op" id="3443248">,</span>&nbsp;<span class="ident" id="3443250">re1</span><span class="op" id="3443253">.</span><span class="ident" id="3443254">Rune</span><span class="op" id="3443258">...</span><span class="op" id="3443261">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443265">//&nbsp;Reuse&nbsp;re1&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443292">if</span>&nbsp;<span class="ident" id="3443295">r</span>&nbsp;<span class="op" id="3443297">&gt;=</span>&nbsp;<span class="num" id="3443300">0</span>&nbsp;<span class="op" id="3443302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443306">re1</span><span class="op" id="3443309">.</span><span class="ident" id="3443310">Rune</span>&nbsp;<span class="op" id="3443315">=</span>&nbsp;<span class="ident" id="3443317">re1</span><span class="op" id="3443320">.</span><span class="ident" id="3443321">Rune0</span><span class="op" id="3443326">[</span><span class="op" id="3443327">:</span><span class="num" id="3443328">1</span><span class="op" id="3443329">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443333">re1</span><span class="op" id="3443336">.</span><span class="ident" id="3443337">Rune</span><span class="op" id="3443341">[</span><span class="num" id="3443342">0</span><span class="op" id="3443343">]</span>&nbsp;<span class="op" id="3443345">=</span>&nbsp;<span class="ident" id="3443347">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443351">re1</span><span class="op" id="3443354">.</span><span class="ident" id="3443355">Flags</span>&nbsp;<span class="op" id="3443361">=</span>&nbsp;<span class="ident" id="3443363">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443371">return</span>&nbsp;<span class="builtintype" id="3443378">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443388">p</span><span class="op" id="3443389">.</span><span class="ident" id="3443390">stack</span>&nbsp;<span class="op" id="3443396">=</span>&nbsp;<span class="ident" id="3443398">p</span><span class="op" id="3443399">.</span><span class="ident" id="3443400">stack</span><span class="op" id="3443405">[</span><span class="op" id="3443406">:</span><span class="ident" id="3443407">n</span><span class="op" id="3443408">-</span><span class="num" id="3443409">1</span><span class="op" id="3443410">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443413">p</span><span class="op" id="3443414">.</span><span class="ident" id="3443415">reuse</span><span class="op" id="3443420">(</span><span class="ident" id="3443421">re1</span><span class="op" id="3443424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443427">return</span>&nbsp;<span class="builtintype" id="3443434">false</span>&nbsp;<span class="comment" id="3443440">//&nbsp;did&nbsp;not&nbsp;push&nbsp;r</span><br>
<span class="lineno"></span><span class="op" id="3443458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3443461">//&nbsp;newLiteral&nbsp;returns&nbsp;a&nbsp;new&nbsp;OpLiteral&nbsp;Regexp&nbsp;with&nbsp;the&nbsp;given&nbsp;flags</span><br>
<span class="lineno"></span><span class="keyword" id="3443527">func</span>&nbsp;<span class="op" id="3443532">(</span><span class="ident" id="3443533">p</span>&nbsp;<span class="op" id="3443535">*</span><span class="ident" id="3443536">parser</span><span class="op" id="3443542">)</span>&nbsp;<span class="ident" id="3443544">newLiteral</span><span class="op" id="3443554">(</span><span class="ident" id="3443555">r</span>&nbsp;<span class="builtintype" id="3443557">rune</span><span class="op" id="3443561">,</span>&nbsp;<span class="ident" id="3443563">flags</span>&nbsp;<span class="ident" id="3443569">Flags</span><span class="op" id="3443574">)</span>&nbsp;<span class="op" id="3443576">*</span><span class="ident" id="3443577">Regexp</span>&nbsp;<span class="op" id="3443584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443587">re</span>&nbsp;<span class="op" id="3443590">:=</span>&nbsp;<span class="ident" id="3443593">p</span><span class="op" id="3443594">.</span><span class="ident" id="3443595">newRegexp</span><span class="op" id="3443604">(</span><span class="ident" id="3443605">OpLiteral</span><span class="op" id="3443614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443617">re</span><span class="op" id="3443619">.</span><span class="ident" id="3443620">Flags</span>&nbsp;<span class="op" id="3443626">=</span>&nbsp;<span class="ident" id="3443628">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443635">if</span>&nbsp;<span class="ident" id="3443638">flags</span><span class="op" id="3443643">&amp;</span><span class="ident" id="3443644">FoldCase</span>&nbsp;<span class="op" id="3443653">!=</span>&nbsp;<span class="num" id="3443656">0</span>&nbsp;<span class="op" id="3443658">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443662">r</span>&nbsp;<span class="op" id="3443664">=</span>&nbsp;<span class="ident" id="3443666">minFoldRune</span><span class="op" id="3443677">(</span><span class="ident" id="3443678">r</span><span class="op" id="3443679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443685">re</span><span class="op" id="3443687">.</span><span class="ident" id="3443688">Rune0</span><span class="op" id="3443693">[</span><span class="num" id="3443694">0</span><span class="op" id="3443695">]</span>&nbsp;<span class="op" id="3443697">=</span>&nbsp;<span class="ident" id="3443699">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443702">re</span><span class="op" id="3443704">.</span><span class="ident" id="3443705">Rune</span>&nbsp;<span class="op" id="3443710">=</span>&nbsp;<span class="ident" id="3443712">re</span><span class="op" id="3443714">.</span><span class="ident" id="3443715">Rune0</span><span class="op" id="3443720">[</span><span class="op" id="3443721">:</span><span class="num" id="3443722">1</span><span class="op" id="3443723">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443726">return</span>&nbsp;<span class="ident" id="3443733">re</span><br>
<span class="lineno">190</span><span class="op" id="3443736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3443739">//&nbsp;minFoldRune&nbsp;returns&nbsp;the&nbsp;minimum&nbsp;rune&nbsp;fold-equivalent&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3443801">func</span>&nbsp;<span class="ident" id="3443806">minFoldRune</span><span class="op" id="3443817">(</span><span class="ident" id="3443818">r</span>&nbsp;<span class="builtintype" id="3443820">rune</span><span class="op" id="3443824">)</span>&nbsp;<span class="builtintype" id="3443826">rune</span>&nbsp;<span class="op" id="3443831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443834">if</span>&nbsp;<span class="ident" id="3443837">r</span>&nbsp;<span class="op" id="3443839">&lt;</span>&nbsp;<span class="ident" id="3443841">minFold</span>&nbsp;<span class="op" id="3443849">||</span>&nbsp;<span class="ident" id="3443852">r</span>&nbsp;<span class="op" id="3443854">&gt;</span>&nbsp;<span class="ident" id="3443856">maxFold</span>&nbsp;<span class="op" id="3443864">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443868">return</span>&nbsp;<span class="ident" id="3443875">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443881">min</span>&nbsp;<span class="op" id="3443885">:=</span>&nbsp;<span class="ident" id="3443888">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443891">r0</span>&nbsp;<span class="op" id="3443894">:=</span>&nbsp;<span class="ident" id="3443897">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443900">for</span>&nbsp;<span class="ident" id="3443904">r</span>&nbsp;<span class="op" id="3443906">=</span>&nbsp;<span class="ident" id="3443908">unicode</span><span class="op" id="3443915">.</span><span class="ident" id="3443916">SimpleFold</span><span class="op" id="3443926">(</span><span class="ident" id="3443927">r</span><span class="op" id="3443928">)</span><span class="op" id="3443929">;</span>&nbsp;<span class="ident" id="3443931">r</span>&nbsp;<span class="op" id="3443933">!=</span>&nbsp;<span class="ident" id="3443936">r0</span><span class="op" id="3443938">;</span>&nbsp;<span class="ident" id="3443940">r</span>&nbsp;<span class="op" id="3443942">=</span>&nbsp;<span class="ident" id="3443944">unicode</span><span class="op" id="3443951">.</span><span class="ident" id="3443952">SimpleFold</span><span class="op" id="3443962">(</span><span class="ident" id="3443963">r</span><span class="op" id="3443964">)</span>&nbsp;<span class="op" id="3443966">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443970">if</span>&nbsp;<span class="ident" id="3443973">min</span>&nbsp;<span class="op" id="3443977">&gt;</span>&nbsp;<span class="ident" id="3443979">r</span>&nbsp;<span class="op" id="3443981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443986">min</span>&nbsp;<span class="op" id="3443990">=</span>&nbsp;<span class="ident" id="3443992">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444002">return</span>&nbsp;<span class="ident" id="3444009">min</span><br>
<span class="lineno">205</span><span class="op" id="3444013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3444016">//&nbsp;literal&nbsp;pushes&nbsp;a&nbsp;literal&nbsp;regexp&nbsp;for&nbsp;the&nbsp;rune&nbsp;r&nbsp;on&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="3444079">//&nbsp;and&nbsp;returns&nbsp;that&nbsp;regexp.</span><br>
<span class="lineno"></span><span class="keyword" id="3444107">func</span>&nbsp;<span class="op" id="3444112">(</span><span class="ident" id="3444113">p</span>&nbsp;<span class="op" id="3444115">*</span><span class="ident" id="3444116">parser</span><span class="op" id="3444122">)</span>&nbsp;<span class="ident" id="3444124">literal</span><span class="op" id="3444131">(</span><span class="ident" id="3444132">r</span>&nbsp;<span class="builtintype" id="3444134">rune</span><span class="op" id="3444138">)</span>&nbsp;<span class="op" id="3444140">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444143">p</span><span class="op" id="3444144">.</span><span class="ident" id="3444145">push</span><span class="op" id="3444149">(</span><span class="ident" id="3444150">p</span><span class="op" id="3444151">.</span><span class="ident" id="3444152">newLiteral</span><span class="op" id="3444162">(</span><span class="ident" id="3444163">r</span><span class="op" id="3444164">,</span>&nbsp;<span class="ident" id="3444166">p</span><span class="op" id="3444167">.</span><span class="ident" id="3444168">flags</span><span class="op" id="3444173">)</span><span class="op" id="3444174">)</span><br>
<span class="lineno"></span><span class="op" id="3444176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3444179">//&nbsp;op&nbsp;pushes&nbsp;a&nbsp;regexp&nbsp;with&nbsp;the&nbsp;given&nbsp;op&nbsp;onto&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="3444234">//&nbsp;and&nbsp;returns&nbsp;that&nbsp;regexp.</span><br>
<span class="lineno">215</span><span class="keyword" id="3444262">func</span>&nbsp;<span class="op" id="3444267">(</span><span class="ident" id="3444268">p</span>&nbsp;<span class="op" id="3444270">*</span><span class="ident" id="3444271">parser</span><span class="op" id="3444277">)</span>&nbsp;<span class="ident" id="3444279">op</span><span class="op" id="3444281">(</span><span class="ident" id="3444282">op</span>&nbsp;<span class="ident" id="3444285">Op</span><span class="op" id="3444287">)</span>&nbsp;<span class="op" id="3444289">*</span><span class="ident" id="3444290">Regexp</span>&nbsp;<span class="op" id="3444297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444300">re</span>&nbsp;<span class="op" id="3444303">:=</span>&nbsp;<span class="ident" id="3444306">p</span><span class="op" id="3444307">.</span><span class="ident" id="3444308">newRegexp</span><span class="op" id="3444317">(</span><span class="ident" id="3444318">op</span><span class="op" id="3444320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444323">re</span><span class="op" id="3444325">.</span><span class="ident" id="3444326">Flags</span>&nbsp;<span class="op" id="3444332">=</span>&nbsp;<span class="ident" id="3444334">p</span><span class="op" id="3444335">.</span><span class="ident" id="3444336">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444343">return</span>&nbsp;<span class="ident" id="3444350">p</span><span class="op" id="3444351">.</span><span class="ident" id="3444352">push</span><span class="op" id="3444356">(</span><span class="ident" id="3444357">re</span><span class="op" id="3444359">)</span><br>
<span class="lineno"></span><span class="op" id="3444361">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3444364">//&nbsp;repeat&nbsp;replaces&nbsp;the&nbsp;top&nbsp;stack&nbsp;element&nbsp;with&nbsp;itself&nbsp;repeated&nbsp;according&nbsp;to&nbsp;op,&nbsp;min,&nbsp;max.</span><br>
<span class="lineno"></span><span class="comment" id="3444453">//&nbsp;before&nbsp;is&nbsp;the&nbsp;regexp&nbsp;suffix&nbsp;starting&nbsp;at&nbsp;the&nbsp;repetition&nbsp;operator.</span><br>
<span class="lineno"></span><span class="comment" id="3444521">//&nbsp;after&nbsp;is&nbsp;the&nbsp;regexp&nbsp;suffix&nbsp;following&nbsp;after&nbsp;the&nbsp;repetition&nbsp;operator.</span><br>
<span class="lineno"></span><span class="comment" id="3444592">//&nbsp;repeat&nbsp;returns&nbsp;an&nbsp;updated&nbsp;&#39;after&#39;&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">225</span><span class="keyword" id="3444651">func</span>&nbsp;<span class="op" id="3444656">(</span><span class="ident" id="3444657">p</span>&nbsp;<span class="op" id="3444659">*</span><span class="ident" id="3444660">parser</span><span class="op" id="3444666">)</span>&nbsp;<span class="ident" id="3444668">repeat</span><span class="op" id="3444674">(</span><span class="ident" id="3444675">op</span>&nbsp;<span class="ident" id="3444678">Op</span><span class="op" id="3444680">,</span>&nbsp;<span class="ident" id="3444682">min</span><span class="op" id="3444685">,</span>&nbsp;<span class="ident" id="3444687">max</span>&nbsp;<span class="builtintype" id="3444691">int</span><span class="op" id="3444694">,</span>&nbsp;<span class="ident" id="3444696">before</span><span class="op" id="3444702">,</span>&nbsp;<span class="ident" id="3444704">after</span><span class="op" id="3444709">,</span>&nbsp;<span class="ident" id="3444711">lastRepeat</span>&nbsp;<span class="builtintype" id="3444722">string</span><span class="op" id="3444728">)</span>&nbsp;<span class="op" id="3444730">(</span><span class="builtintype" id="3444731">string</span><span class="op" id="3444737">,</span>&nbsp;<span class="builtintype" id="3444739">error</span><span class="op" id="3444744">)</span>&nbsp;<span class="op" id="3444746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444749">flags</span>&nbsp;<span class="op" id="3444755">:=</span>&nbsp;<span class="ident" id="3444758">p</span><span class="op" id="3444759">.</span><span class="ident" id="3444760">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444767">if</span>&nbsp;<span class="ident" id="3444770">p</span><span class="op" id="3444771">.</span><span class="ident" id="3444772">flags</span><span class="op" id="3444777">&amp;</span><span class="ident" id="3444778">PerlX</span>&nbsp;<span class="op" id="3444784">!=</span>&nbsp;<span class="num" id="3444787">0</span>&nbsp;<span class="op" id="3444789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444793">if</span>&nbsp;<span class="builtinfunc" id="3444796">len</span><span class="op" id="3444799">(</span><span class="ident" id="3444800">after</span><span class="op" id="3444805">)</span>&nbsp;<span class="op" id="3444807">&gt;</span>&nbsp;<span class="num" id="3444809">0</span>&nbsp;<span class="op" id="3444811">&amp;&amp;</span>&nbsp;<span class="ident" id="3444814">after</span><span class="op" id="3444819">[</span><span class="num" id="3444820">0</span><span class="op" id="3444821">]</span>&nbsp;<span class="op" id="3444823">==</span>&nbsp;<span class="string" id="3444826">&#39;?&#39;</span>&nbsp;<span class="op" id="3444830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444835">after</span>&nbsp;<span class="op" id="3444841">=</span>&nbsp;<span class="ident" id="3444843">after</span><span class="op" id="3444848">[</span><span class="num" id="3444849">1</span><span class="op" id="3444850">:</span><span class="op" id="3444851">]</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444856">flags</span>&nbsp;<span class="op" id="3444862">^=</span>&nbsp;<span class="ident" id="3444865">NonGreedy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444881">if</span>&nbsp;<span class="ident" id="3444884">lastRepeat</span>&nbsp;<span class="op" id="3444895">!=</span>&nbsp;<span class="string" id="3444898">&#34;&#34;</span>&nbsp;<span class="op" id="3444901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3444906">//&nbsp;In&nbsp;Perl&nbsp;it&nbsp;is&nbsp;not&nbsp;allowed&nbsp;to&nbsp;stack&nbsp;repetition&nbsp;operators:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3444969">//&nbsp;a**&nbsp;is&nbsp;a&nbsp;syntax&nbsp;error,&nbsp;not&nbsp;a&nbsp;doubled&nbsp;star,&nbsp;and&nbsp;a++&nbsp;means</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445032">//&nbsp;something&nbsp;else&nbsp;entirely,&nbsp;which&nbsp;we&nbsp;don&#39;t&nbsp;support!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445087">return</span>&nbsp;<span class="string" id="3445094">&#34;&#34;</span><span class="op" id="3445096">,</span>&nbsp;<span class="op" id="3445098">&amp;</span><span class="ident" id="3445099">Error</span><span class="op" id="3445104">{</span><span class="ident" id="3445105">ErrInvalidRepeatOp</span><span class="op" id="3445123">,</span>&nbsp;<span class="ident" id="3445125">lastRepeat</span><span class="op" id="3445135">[</span><span class="op" id="3445136">:</span><span class="builtinfunc" id="3445137">len</span><span class="op" id="3445140">(</span><span class="ident" id="3445141">lastRepeat</span><span class="op" id="3445151">)</span><span class="op" id="3445152">-</span><span class="builtinfunc" id="3445153">len</span><span class="op" id="3445156">(</span><span class="ident" id="3445157">after</span><span class="op" id="3445162">)</span><span class="op" id="3445163">]</span><span class="op" id="3445164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445174">n</span>&nbsp;<span class="op" id="3445176">:=</span>&nbsp;<span class="builtinfunc" id="3445179">len</span><span class="op" id="3445182">(</span><span class="ident" id="3445183">p</span><span class="op" id="3445184">.</span><span class="ident" id="3445185">stack</span><span class="op" id="3445190">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445193">if</span>&nbsp;<span class="ident" id="3445196">n</span>&nbsp;<span class="op" id="3445198">==</span>&nbsp;<span class="num" id="3445201">0</span>&nbsp;<span class="op" id="3445203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445207">return</span>&nbsp;<span class="string" id="3445214">&#34;&#34;</span><span class="op" id="3445216">,</span>&nbsp;<span class="op" id="3445218">&amp;</span><span class="ident" id="3445219">Error</span><span class="op" id="3445224">{</span><span class="ident" id="3445225">ErrMissingRepeatArgument</span><span class="op" id="3445249">,</span>&nbsp;<span class="ident" id="3445251">before</span><span class="op" id="3445257">[</span><span class="op" id="3445258">:</span><span class="builtinfunc" id="3445259">len</span><span class="op" id="3445262">(</span><span class="ident" id="3445263">before</span><span class="op" id="3445269">)</span><span class="op" id="3445270">-</span><span class="builtinfunc" id="3445271">len</span><span class="op" id="3445274">(</span><span class="ident" id="3445275">after</span><span class="op" id="3445280">)</span><span class="op" id="3445281">]</span><span class="op" id="3445282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445288">sub</span>&nbsp;<span class="op" id="3445292">:=</span>&nbsp;<span class="ident" id="3445295">p</span><span class="op" id="3445296">.</span><span class="ident" id="3445297">stack</span><span class="op" id="3445302">[</span><span class="ident" id="3445303">n</span><span class="op" id="3445304">-</span><span class="num" id="3445305">1</span><span class="op" id="3445306">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445309">if</span>&nbsp;<span class="ident" id="3445312">sub</span><span class="op" id="3445315">.</span><span class="ident" id="3445316">Op</span>&nbsp;<span class="op" id="3445319">&gt;=</span>&nbsp;<span class="ident" id="3445322">opPseudo</span>&nbsp;<span class="op" id="3445331">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445335">return</span>&nbsp;<span class="string" id="3445342">&#34;&#34;</span><span class="op" id="3445344">,</span>&nbsp;<span class="op" id="3445346">&amp;</span><span class="ident" id="3445347">Error</span><span class="op" id="3445352">{</span><span class="ident" id="3445353">ErrMissingRepeatArgument</span><span class="op" id="3445377">,</span>&nbsp;<span class="ident" id="3445379">before</span><span class="op" id="3445385">[</span><span class="op" id="3445386">:</span><span class="builtinfunc" id="3445387">len</span><span class="op" id="3445390">(</span><span class="ident" id="3445391">before</span><span class="op" id="3445397">)</span><span class="op" id="3445398">-</span><span class="builtinfunc" id="3445399">len</span><span class="op" id="3445402">(</span><span class="ident" id="3445403">after</span><span class="op" id="3445408">)</span><span class="op" id="3445409">]</span><span class="op" id="3445410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445417">re</span>&nbsp;<span class="op" id="3445420">:=</span>&nbsp;<span class="ident" id="3445423">p</span><span class="op" id="3445424">.</span><span class="ident" id="3445425">newRegexp</span><span class="op" id="3445434">(</span><span class="ident" id="3445435">op</span><span class="op" id="3445437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445440">re</span><span class="op" id="3445442">.</span><span class="ident" id="3445443">Min</span>&nbsp;<span class="op" id="3445447">=</span>&nbsp;<span class="ident" id="3445449">min</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445454">re</span><span class="op" id="3445456">.</span><span class="ident" id="3445457">Max</span>&nbsp;<span class="op" id="3445461">=</span>&nbsp;<span class="ident" id="3445463">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445468">re</span><span class="op" id="3445470">.</span><span class="ident" id="3445471">Flags</span>&nbsp;<span class="op" id="3445477">=</span>&nbsp;<span class="ident" id="3445479">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445486">re</span><span class="op" id="3445488">.</span><span class="ident" id="3445489">Sub</span>&nbsp;<span class="op" id="3445493">=</span>&nbsp;<span class="ident" id="3445495">re</span><span class="op" id="3445497">.</span><span class="ident" id="3445498">Sub0</span><span class="op" id="3445502">[</span><span class="op" id="3445503">:</span><span class="num" id="3445504">1</span><span class="op" id="3445505">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445508">re</span><span class="op" id="3445510">.</span><span class="ident" id="3445511">Sub</span><span class="op" id="3445514">[</span><span class="num" id="3445515">0</span><span class="op" id="3445516">]</span>&nbsp;<span class="op" id="3445518">=</span>&nbsp;<span class="ident" id="3445520">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445525">p</span><span class="op" id="3445526">.</span><span class="ident" id="3445527">stack</span><span class="op" id="3445532">[</span><span class="ident" id="3445533">n</span><span class="op" id="3445534">-</span><span class="num" id="3445535">1</span><span class="op" id="3445536">]</span>&nbsp;<span class="op" id="3445538">=</span>&nbsp;<span class="ident" id="3445540">re</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445545">if</span>&nbsp;<span class="ident" id="3445548">op</span>&nbsp;<span class="op" id="3445551">==</span>&nbsp;<span class="ident" id="3445554">OpRepeat</span>&nbsp;<span class="op" id="3445563">&amp;&amp;</span>&nbsp;<span class="op" id="3445566">(</span><span class="ident" id="3445567">min</span>&nbsp;<span class="op" id="3445571">&gt;=</span>&nbsp;<span class="num" id="3445574">2</span>&nbsp;<span class="op" id="3445576">||</span>&nbsp;<span class="ident" id="3445579">max</span>&nbsp;<span class="op" id="3445583">&gt;=</span>&nbsp;<span class="num" id="3445586">2</span><span class="op" id="3445587">)</span>&nbsp;<span class="op" id="3445589">&amp;&amp;</span>&nbsp;<span class="op" id="3445592">!</span><span class="ident" id="3445593">repeatIsValid</span><span class="op" id="3445606">(</span><span class="ident" id="3445607">re</span><span class="op" id="3445609">,</span>&nbsp;<span class="num" id="3445611">1000</span><span class="op" id="3445615">)</span>&nbsp;<span class="op" id="3445617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445621">return</span>&nbsp;<span class="string" id="3445628">&#34;&#34;</span><span class="op" id="3445630">,</span>&nbsp;<span class="op" id="3445632">&amp;</span><span class="ident" id="3445633">Error</span><span class="op" id="3445638">{</span><span class="ident" id="3445639">ErrInvalidRepeatSize</span><span class="op" id="3445659">,</span>&nbsp;<span class="ident" id="3445661">before</span><span class="op" id="3445667">[</span><span class="op" id="3445668">:</span><span class="builtinfunc" id="3445669">len</span><span class="op" id="3445672">(</span><span class="ident" id="3445673">before</span><span class="op" id="3445679">)</span><span class="op" id="3445680">-</span><span class="builtinfunc" id="3445681">len</span><span class="op" id="3445684">(</span><span class="ident" id="3445685">after</span><span class="op" id="3445690">)</span><span class="op" id="3445691">]</span><span class="op" id="3445692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445699">return</span>&nbsp;<span class="ident" id="3445706">after</span><span class="op" id="3445711">,</span>&nbsp;<span class="ident" id="3445713">nil</span><br>
<span class="lineno"></span><span class="op" id="3445717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3445720">//&nbsp;repeatIsValid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;repetition&nbsp;re&nbsp;is&nbsp;valid.</span><br>
<span class="lineno"></span><span class="comment" id="3445781">//&nbsp;Valid&nbsp;means&nbsp;that&nbsp;the&nbsp;combination&nbsp;of&nbsp;the&nbsp;top-level&nbsp;repetition</span><br>
<span class="lineno">265</span><span class="comment" id="3445845">//&nbsp;and&nbsp;any&nbsp;inner&nbsp;repetitions&nbsp;does&nbsp;not&nbsp;exceed&nbsp;n&nbsp;copies&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3445906">//&nbsp;innermost&nbsp;thing.</span><br>
<span class="lineno"></span><span class="comment" id="3445926">//&nbsp;This&nbsp;function&nbsp;rewalks&nbsp;the&nbsp;regexp&nbsp;tree&nbsp;and&nbsp;is&nbsp;called&nbsp;for&nbsp;every&nbsp;repetition,</span><br>
<span class="lineno"></span><span class="comment" id="3446003">//&nbsp;so&nbsp;we&nbsp;have&nbsp;to&nbsp;worry&nbsp;about&nbsp;inducing&nbsp;quadratic&nbsp;behavior&nbsp;in&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><span class="comment" id="3446075">//&nbsp;We&nbsp;avoid&nbsp;this&nbsp;by&nbsp;only&nbsp;calling&nbsp;repeatIsValid&nbsp;when&nbsp;min&nbsp;or&nbsp;max&nbsp;&gt;=&nbsp;2.</span><br>
<span class="lineno">270</span><span class="comment" id="3446144">//&nbsp;In&nbsp;that&nbsp;case&nbsp;the&nbsp;depth&nbsp;of&nbsp;any&nbsp;&gt;=&nbsp;2&nbsp;nesting&nbsp;can&nbsp;only&nbsp;get&nbsp;to&nbsp;9&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="3446216">//&nbsp;triggering&nbsp;a&nbsp;parse&nbsp;error,&nbsp;so&nbsp;each&nbsp;subtree&nbsp;can&nbsp;only&nbsp;be&nbsp;rewalked&nbsp;9&nbsp;times.</span><br>
<span class="lineno"></span><span class="keyword" id="3446291">func</span>&nbsp;<span class="ident" id="3446296">repeatIsValid</span><span class="op" id="3446309">(</span><span class="ident" id="3446310">re</span>&nbsp;<span class="op" id="3446313">*</span><span class="ident" id="3446314">Regexp</span><span class="op" id="3446320">,</span>&nbsp;<span class="ident" id="3446322">n</span>&nbsp;<span class="builtintype" id="3446324">int</span><span class="op" id="3446327">)</span>&nbsp;<span class="builtintype" id="3446329">bool</span>&nbsp;<span class="op" id="3446334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446337">if</span>&nbsp;<span class="ident" id="3446340">re</span><span class="op" id="3446342">.</span><span class="ident" id="3446343">Op</span>&nbsp;<span class="op" id="3446346">==</span>&nbsp;<span class="ident" id="3446349">OpRepeat</span>&nbsp;<span class="op" id="3446358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446362">m</span>&nbsp;<span class="op" id="3446364">:=</span>&nbsp;<span class="ident" id="3446367">re</span><span class="op" id="3446369">.</span><span class="ident" id="3446370">Max</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446376">if</span>&nbsp;<span class="ident" id="3446379">m</span>&nbsp;<span class="op" id="3446381">==</span>&nbsp;<span class="num" id="3446384">0</span>&nbsp;<span class="op" id="3446386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446391">return</span>&nbsp;<span class="builtintype" id="3446398">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446409">if</span>&nbsp;<span class="ident" id="3446412">m</span>&nbsp;<span class="op" id="3446414">&lt;</span>&nbsp;<span class="num" id="3446416">0</span>&nbsp;<span class="op" id="3446418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446423">m</span>&nbsp;<span class="op" id="3446425">=</span>&nbsp;<span class="ident" id="3446427">re</span><span class="op" id="3446429">.</span><span class="ident" id="3446430">Min</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446440">if</span>&nbsp;<span class="ident" id="3446443">m</span>&nbsp;<span class="op" id="3446445">&gt;</span>&nbsp;<span class="ident" id="3446447">n</span>&nbsp;<span class="op" id="3446449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446454">return</span>&nbsp;<span class="builtintype" id="3446461">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446473">if</span>&nbsp;<span class="ident" id="3446476">m</span>&nbsp;<span class="op" id="3446478">&gt;</span>&nbsp;<span class="num" id="3446480">0</span>&nbsp;<span class="op" id="3446482">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446487">n</span>&nbsp;<span class="op" id="3446489">/=</span>&nbsp;<span class="ident" id="3446492">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446502">for</span>&nbsp;<span class="ident" id="3446506">_</span><span class="op" id="3446507">,</span>&nbsp;<span class="ident" id="3446509">sub</span>&nbsp;<span class="op" id="3446513">:=</span>&nbsp;<span class="keyword" id="3446516">range</span>&nbsp;<span class="ident" id="3446522">re</span><span class="op" id="3446524">.</span><span class="ident" id="3446525">Sub</span>&nbsp;<span class="op" id="3446529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446533">if</span>&nbsp;<span class="op" id="3446536">!</span><span class="ident" id="3446537">repeatIsValid</span><span class="op" id="3446550">(</span><span class="ident" id="3446551">sub</span><span class="op" id="3446554">,</span>&nbsp;<span class="ident" id="3446556">n</span><span class="op" id="3446557">)</span>&nbsp;<span class="op" id="3446559">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446564">return</span>&nbsp;<span class="builtintype" id="3446571">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446585">return</span>&nbsp;<span class="builtintype" id="3446592">true</span><br>
<span class="lineno"></span><span class="op" id="3446597">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="3446600">//&nbsp;concat&nbsp;replaces&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;(above&nbsp;the&nbsp;topmost&nbsp;&#39;|&#39;&nbsp;or&nbsp;&#39;(&#39;)&nbsp;with&nbsp;its&nbsp;concatenation.</span><br>
<span class="lineno"></span><span class="keyword" id="3446695">func</span>&nbsp;<span class="op" id="3446700">(</span><span class="ident" id="3446701">p</span>&nbsp;<span class="op" id="3446703">*</span><span class="ident" id="3446704">parser</span><span class="op" id="3446710">)</span>&nbsp;<span class="ident" id="3446712">concat</span><span class="op" id="3446718">(</span><span class="op" id="3446719">)</span>&nbsp;<span class="op" id="3446721">*</span><span class="ident" id="3446722">Regexp</span>&nbsp;<span class="op" id="3446729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446732">p</span><span class="op" id="3446733">.</span><span class="ident" id="3446734">maybeConcat</span><span class="op" id="3446745">(</span><span class="op" id="3446746">-</span><span class="num" id="3446747">1</span><span class="op" id="3446748">,</span>&nbsp;<span class="num" id="3446750">0</span><span class="op" id="3446751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3446755">//&nbsp;Scan&nbsp;down&nbsp;to&nbsp;find&nbsp;pseudo-operator&nbsp;|&nbsp;or&nbsp;(.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446801">i</span>&nbsp;<span class="op" id="3446803">:=</span>&nbsp;<span class="builtinfunc" id="3446806">len</span><span class="op" id="3446809">(</span><span class="ident" id="3446810">p</span><span class="op" id="3446811">.</span><span class="ident" id="3446812">stack</span><span class="op" id="3446817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446820">for</span>&nbsp;<span class="ident" id="3446824">i</span>&nbsp;<span class="op" id="3446826">&gt;</span>&nbsp;<span class="num" id="3446828">0</span>&nbsp;<span class="op" id="3446830">&amp;&amp;</span>&nbsp;<span class="ident" id="3446833">p</span><span class="op" id="3446834">.</span><span class="ident" id="3446835">stack</span><span class="op" id="3446840">[</span><span class="ident" id="3446841">i</span><span class="op" id="3446842">-</span><span class="num" id="3446843">1</span><span class="op" id="3446844">]</span><span class="op" id="3446845">.</span><span class="ident" id="3446846">Op</span>&nbsp;<span class="op" id="3446849">&lt;</span>&nbsp;<span class="ident" id="3446851">opPseudo</span>&nbsp;<span class="op" id="3446860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446864">i</span><span class="op" id="3446865">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446869">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446872">subs</span>&nbsp;<span class="op" id="3446877">:=</span>&nbsp;<span class="ident" id="3446880">p</span><span class="op" id="3446881">.</span><span class="ident" id="3446882">stack</span><span class="op" id="3446887">[</span><span class="ident" id="3446888">i</span><span class="op" id="3446889">:</span><span class="op" id="3446890">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446893">p</span><span class="op" id="3446894">.</span><span class="ident" id="3446895">stack</span>&nbsp;<span class="op" id="3446901">=</span>&nbsp;<span class="ident" id="3446903">p</span><span class="op" id="3446904">.</span><span class="ident" id="3446905">stack</span><span class="op" id="3446910">[</span><span class="op" id="3446911">:</span><span class="ident" id="3446912">i</span><span class="op" id="3446913">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3446917">//&nbsp;Empty&nbsp;concatenation&nbsp;is&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446958">if</span>&nbsp;<span class="builtinfunc" id="3446961">len</span><span class="op" id="3446964">(</span><span class="ident" id="3446965">subs</span><span class="op" id="3446969">)</span>&nbsp;<span class="op" id="3446971">==</span>&nbsp;<span class="num" id="3446974">0</span>&nbsp;<span class="op" id="3446976">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446980">return</span>&nbsp;<span class="ident" id="3446987">p</span><span class="op" id="3446988">.</span><span class="ident" id="3446989">push</span><span class="op" id="3446993">(</span><span class="ident" id="3446994">p</span><span class="op" id="3446995">.</span><span class="ident" id="3446996">newRegexp</span><span class="op" id="3447005">(</span><span class="ident" id="3447006">OpEmptyMatch</span><span class="op" id="3447018">)</span><span class="op" id="3447019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447026">return</span>&nbsp;<span class="ident" id="3447033">p</span><span class="op" id="3447034">.</span><span class="ident" id="3447035">push</span><span class="op" id="3447039">(</span><span class="ident" id="3447040">p</span><span class="op" id="3447041">.</span><span class="ident" id="3447042">collapse</span><span class="op" id="3447050">(</span><span class="ident" id="3447051">subs</span><span class="op" id="3447055">,</span>&nbsp;<span class="ident" id="3447057">OpConcat</span><span class="op" id="3447065">)</span><span class="op" id="3447066">)</span><br>
<span class="lineno"></span><span class="op" id="3447068">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="comment" id="3447071">//&nbsp;alternate&nbsp;replaces&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;(above&nbsp;the&nbsp;topmost&nbsp;&#39;(&#39;)&nbsp;with&nbsp;its&nbsp;alternation.</span><br>
<span class="lineno"></span><span class="keyword" id="3447160">func</span>&nbsp;<span class="op" id="3447165">(</span><span class="ident" id="3447166">p</span>&nbsp;<span class="op" id="3447168">*</span><span class="ident" id="3447169">parser</span><span class="op" id="3447175">)</span>&nbsp;<span class="ident" id="3447177">alternate</span><span class="op" id="3447186">(</span><span class="op" id="3447187">)</span>&nbsp;<span class="op" id="3447189">*</span><span class="ident" id="3447190">Regexp</span>&nbsp;<span class="op" id="3447197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447200">//&nbsp;Scan&nbsp;down&nbsp;to&nbsp;find&nbsp;pseudo-operator&nbsp;(.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447241">//&nbsp;There&nbsp;are&nbsp;no&nbsp;|&nbsp;above&nbsp;(.</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447269">i</span>&nbsp;<span class="op" id="3447271">:=</span>&nbsp;<span class="builtinfunc" id="3447274">len</span><span class="op" id="3447277">(</span><span class="ident" id="3447278">p</span><span class="op" id="3447279">.</span><span class="ident" id="3447280">stack</span><span class="op" id="3447285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447288">for</span>&nbsp;<span class="ident" id="3447292">i</span>&nbsp;<span class="op" id="3447294">&gt;</span>&nbsp;<span class="num" id="3447296">0</span>&nbsp;<span class="op" id="3447298">&amp;&amp;</span>&nbsp;<span class="ident" id="3447301">p</span><span class="op" id="3447302">.</span><span class="ident" id="3447303">stack</span><span class="op" id="3447308">[</span><span class="ident" id="3447309">i</span><span class="op" id="3447310">-</span><span class="num" id="3447311">1</span><span class="op" id="3447312">]</span><span class="op" id="3447313">.</span><span class="ident" id="3447314">Op</span>&nbsp;<span class="op" id="3447317">&lt;</span>&nbsp;<span class="ident" id="3447319">opPseudo</span>&nbsp;<span class="op" id="3447328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447332">i</span><span class="op" id="3447333">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447340">subs</span>&nbsp;<span class="op" id="3447345">:=</span>&nbsp;<span class="ident" id="3447348">p</span><span class="op" id="3447349">.</span><span class="ident" id="3447350">stack</span><span class="op" id="3447355">[</span><span class="ident" id="3447356">i</span><span class="op" id="3447357">:</span><span class="op" id="3447358">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447361">p</span><span class="op" id="3447362">.</span><span class="ident" id="3447363">stack</span>&nbsp;<span class="op" id="3447369">=</span>&nbsp;<span class="ident" id="3447371">p</span><span class="op" id="3447372">.</span><span class="ident" id="3447373">stack</span><span class="op" id="3447378">[</span><span class="op" id="3447379">:</span><span class="ident" id="3447380">i</span><span class="op" id="3447381">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447385">//&nbsp;Make&nbsp;sure&nbsp;top&nbsp;class&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447419">//&nbsp;All&nbsp;the&nbsp;others&nbsp;already&nbsp;are&nbsp;(see&nbsp;swapVerticalBar).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447473">if</span>&nbsp;<span class="builtinfunc" id="3447476">len</span><span class="op" id="3447479">(</span><span class="ident" id="3447480">subs</span><span class="op" id="3447484">)</span>&nbsp;<span class="op" id="3447486">&gt;</span>&nbsp;<span class="num" id="3447488">0</span>&nbsp;<span class="op" id="3447490">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447494">cleanAlt</span><span class="op" id="3447502">(</span><span class="ident" id="3447503">subs</span><span class="op" id="3447507">[</span><span class="builtinfunc" id="3447508">len</span><span class="op" id="3447511">(</span><span class="ident" id="3447512">subs</span><span class="op" id="3447516">)</span><span class="op" id="3447517">-</span><span class="num" id="3447518">1</span><span class="op" id="3447519">]</span><span class="op" id="3447520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447527">//&nbsp;Empty&nbsp;alternate&nbsp;is&nbsp;special&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447563">//&nbsp;(shouldn&#39;t&nbsp;happen&nbsp;but&nbsp;easy&nbsp;to&nbsp;handle).</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447606">if</span>&nbsp;<span class="builtinfunc" id="3447609">len</span><span class="op" id="3447612">(</span><span class="ident" id="3447613">subs</span><span class="op" id="3447617">)</span>&nbsp;<span class="op" id="3447619">==</span>&nbsp;<span class="num" id="3447622">0</span>&nbsp;<span class="op" id="3447624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447628">return</span>&nbsp;<span class="ident" id="3447635">p</span><span class="op" id="3447636">.</span><span class="ident" id="3447637">push</span><span class="op" id="3447641">(</span><span class="ident" id="3447642">p</span><span class="op" id="3447643">.</span><span class="ident" id="3447644">newRegexp</span><span class="op" id="3447653">(</span><span class="ident" id="3447654">OpNoMatch</span><span class="op" id="3447663">)</span><span class="op" id="3447664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447671">return</span>&nbsp;<span class="ident" id="3447678">p</span><span class="op" id="3447679">.</span><span class="ident" id="3447680">push</span><span class="op" id="3447684">(</span><span class="ident" id="3447685">p</span><span class="op" id="3447686">.</span><span class="ident" id="3447687">collapse</span><span class="op" id="3447695">(</span><span class="ident" id="3447696">subs</span><span class="op" id="3447700">,</span>&nbsp;<span class="ident" id="3447702">OpAlternate</span><span class="op" id="3447713">)</span><span class="op" id="3447714">)</span><br>
<span class="lineno">340</span><span class="op" id="3447716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3447719">//&nbsp;cleanAlt&nbsp;cleans&nbsp;re&nbsp;for&nbsp;eventual&nbsp;inclusion&nbsp;in&nbsp;an&nbsp;alternation.</span><br>
<span class="lineno"></span><span class="keyword" id="3447783">func</span>&nbsp;<span class="ident" id="3447788">cleanAlt</span><span class="op" id="3447796">(</span><span class="ident" id="3447797">re</span>&nbsp;<span class="op" id="3447800">*</span><span class="ident" id="3447801">Regexp</span><span class="op" id="3447807">)</span>&nbsp;<span class="op" id="3447809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447812">switch</span>&nbsp;<span class="ident" id="3447819">re</span><span class="op" id="3447821">.</span><span class="ident" id="3447822">Op</span>&nbsp;<span class="op" id="3447825">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447828">case</span>&nbsp;<span class="ident" id="3447833">OpCharClass</span><span class="op" id="3447844">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447848">re</span><span class="op" id="3447850">.</span><span class="ident" id="3447851">Rune</span>&nbsp;<span class="op" id="3447856">=</span>&nbsp;<span class="ident" id="3447858">cleanClass</span><span class="op" id="3447868">(</span><span class="op" id="3447869">&amp;</span><span class="ident" id="3447870">re</span><span class="op" id="3447872">.</span><span class="ident" id="3447873">Rune</span><span class="op" id="3447877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447881">if</span>&nbsp;<span class="builtinfunc" id="3447884">len</span><span class="op" id="3447887">(</span><span class="ident" id="3447888">re</span><span class="op" id="3447890">.</span><span class="ident" id="3447891">Rune</span><span class="op" id="3447895">)</span>&nbsp;<span class="op" id="3447897">==</span>&nbsp;<span class="num" id="3447900">2</span>&nbsp;<span class="op" id="3447902">&amp;&amp;</span>&nbsp;<span class="ident" id="3447905">re</span><span class="op" id="3447907">.</span><span class="ident" id="3447908">Rune</span><span class="op" id="3447912">[</span><span class="num" id="3447913">0</span><span class="op" id="3447914">]</span>&nbsp;<span class="op" id="3447916">==</span>&nbsp;<span class="num" id="3447919">0</span>&nbsp;<span class="op" id="3447921">&amp;&amp;</span>&nbsp;<span class="ident" id="3447924">re</span><span class="op" id="3447926">.</span><span class="ident" id="3447927">Rune</span><span class="op" id="3447931">[</span><span class="num" id="3447932">1</span><span class="op" id="3447933">]</span>&nbsp;<span class="op" id="3447935">==</span>&nbsp;<span class="ident" id="3447938">unicode</span><span class="op" id="3447945">.</span><span class="ident" id="3447946">MaxRune</span>&nbsp;<span class="op" id="3447954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447959">re</span><span class="op" id="3447961">.</span><span class="ident" id="3447962">Rune</span>&nbsp;<span class="op" id="3447967">=</span>&nbsp;<span class="ident" id="3447969">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447976">re</span><span class="op" id="3447978">.</span><span class="ident" id="3447979">Op</span>&nbsp;<span class="op" id="3447982">=</span>&nbsp;<span class="ident" id="3447984">OpAnyChar</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447997">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448010">if</span>&nbsp;<span class="builtinfunc" id="3448013">len</span><span class="op" id="3448016">(</span><span class="ident" id="3448017">re</span><span class="op" id="3448019">.</span><span class="ident" id="3448020">Rune</span><span class="op" id="3448024">)</span>&nbsp;<span class="op" id="3448026">==</span>&nbsp;<span class="num" id="3448029">4</span>&nbsp;<span class="op" id="3448031">&amp;&amp;</span>&nbsp;<span class="ident" id="3448034">re</span><span class="op" id="3448036">.</span><span class="ident" id="3448037">Rune</span><span class="op" id="3448041">[</span><span class="num" id="3448042">0</span><span class="op" id="3448043">]</span>&nbsp;<span class="op" id="3448045">==</span>&nbsp;<span class="num" id="3448048">0</span>&nbsp;<span class="op" id="3448050">&amp;&amp;</span>&nbsp;<span class="ident" id="3448053">re</span><span class="op" id="3448055">.</span><span class="ident" id="3448056">Rune</span><span class="op" id="3448060">[</span><span class="num" id="3448061">1</span><span class="op" id="3448062">]</span>&nbsp;<span class="op" id="3448064">==</span>&nbsp;<span class="string" id="3448067">&#39;\n&#39;</span><span class="op" id="3448071">-</span><span class="num" id="3448072">1</span>&nbsp;<span class="op" id="3448074">&amp;&amp;</span>&nbsp;<span class="ident" id="3448077">re</span><span class="op" id="3448079">.</span><span class="ident" id="3448080">Rune</span><span class="op" id="3448084">[</span><span class="num" id="3448085">2</span><span class="op" id="3448086">]</span>&nbsp;<span class="op" id="3448088">==</span>&nbsp;<span class="string" id="3448091">&#39;\n&#39;</span><span class="op" id="3448095">+</span><span class="num" id="3448096">1</span>&nbsp;<span class="op" id="3448098">&amp;&amp;</span>&nbsp;<span class="ident" id="3448101">re</span><span class="op" id="3448103">.</span><span class="ident" id="3448104">Rune</span><span class="op" id="3448108">[</span><span class="num" id="3448109">3</span><span class="op" id="3448110">]</span>&nbsp;<span class="op" id="3448112">==</span>&nbsp;<span class="ident" id="3448115">unicode</span><span class="op" id="3448122">.</span><span class="ident" id="3448123">MaxRune</span>&nbsp;<span class="op" id="3448131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448136">re</span><span class="op" id="3448138">.</span><span class="ident" id="3448139">Rune</span>&nbsp;<span class="op" id="3448144">=</span>&nbsp;<span class="ident" id="3448146">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448153">re</span><span class="op" id="3448155">.</span><span class="ident" id="3448156">Op</span>&nbsp;<span class="op" id="3448159">=</span>&nbsp;<span class="ident" id="3448161">OpAnyCharNotNL</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448179">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448192">if</span>&nbsp;<span class="builtinfunc" id="3448195">cap</span><span class="op" id="3448198">(</span><span class="ident" id="3448199">re</span><span class="op" id="3448201">.</span><span class="ident" id="3448202">Rune</span><span class="op" id="3448206">)</span><span class="op" id="3448207">-</span><span class="builtinfunc" id="3448208">len</span><span class="op" id="3448211">(</span><span class="ident" id="3448212">re</span><span class="op" id="3448214">.</span><span class="ident" id="3448215">Rune</span><span class="op" id="3448219">)</span>&nbsp;<span class="op" id="3448221">&gt;</span>&nbsp;<span class="num" id="3448223">100</span>&nbsp;<span class="op" id="3448227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448232">//&nbsp;re.Rune&nbsp;will&nbsp;not&nbsp;grow&nbsp;any&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448270">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;or&nbsp;inline&nbsp;to&nbsp;reclaim&nbsp;storage.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448318">re</span><span class="op" id="3448320">.</span><span class="ident" id="3448321">Rune</span>&nbsp;<span class="op" id="3448326">=</span>&nbsp;<span class="builtinfunc" id="3448328">append</span><span class="op" id="3448334">(</span><span class="ident" id="3448335">re</span><span class="op" id="3448337">.</span><span class="ident" id="3448338">Rune0</span><span class="op" id="3448343">[</span><span class="op" id="3448344">:</span><span class="num" id="3448345">0</span><span class="op" id="3448346">]</span><span class="op" id="3448347">,</span>&nbsp;<span class="ident" id="3448349">re</span><span class="op" id="3448351">.</span><span class="ident" id="3448352">Rune</span><span class="op" id="3448356">...</span><span class="op" id="3448359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448366">}</span><br>
<span class="lineno"></span><span class="op" id="3448368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="3448371">//&nbsp;collapse&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;applying&nbsp;op&nbsp;to&nbsp;sub.</span><br>
<span class="lineno"></span><span class="comment" id="3448425">//&nbsp;If&nbsp;sub&nbsp;contains&nbsp;op&nbsp;nodes,&nbsp;they&nbsp;all&nbsp;get&nbsp;hoisted&nbsp;up</span><br>
<span class="lineno"></span><span class="comment" id="3448478">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;never&nbsp;a&nbsp;concat&nbsp;of&nbsp;a&nbsp;concat&nbsp;or&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3448531">//&nbsp;alternate&nbsp;of&nbsp;an&nbsp;alternate.</span><br>
<span class="lineno"></span><span class="keyword" id="3448561">func</span>&nbsp;<span class="op" id="3448566">(</span><span class="ident" id="3448567">p</span>&nbsp;<span class="op" id="3448569">*</span><span class="ident" id="3448570">parser</span><span class="op" id="3448576">)</span>&nbsp;<span class="ident" id="3448578">collapse</span><span class="op" id="3448586">(</span><span class="ident" id="3448587">subs</span>&nbsp;<span class="op" id="3448592">[</span><span class="op" id="3448593">]</span><span class="op" id="3448594">*</span><span class="ident" id="3448595">Regexp</span><span class="op" id="3448601">,</span>&nbsp;<span class="ident" id="3448603">op</span>&nbsp;<span class="ident" id="3448606">Op</span><span class="op" id="3448608">)</span>&nbsp;<span class="op" id="3448610">*</span><span class="ident" id="3448611">Regexp</span>&nbsp;<span class="op" id="3448618">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448621">if</span>&nbsp;<span class="builtinfunc" id="3448624">len</span><span class="op" id="3448627">(</span><span class="ident" id="3448628">subs</span><span class="op" id="3448632">)</span>&nbsp;<span class="op" id="3448634">==</span>&nbsp;<span class="num" id="3448637">1</span>&nbsp;<span class="op" id="3448639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448643">return</span>&nbsp;<span class="ident" id="3448650">subs</span><span class="op" id="3448654">[</span><span class="num" id="3448655">0</span><span class="op" id="3448656">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448662">re</span>&nbsp;<span class="op" id="3448665">:=</span>&nbsp;<span class="ident" id="3448668">p</span><span class="op" id="3448669">.</span><span class="ident" id="3448670">newRegexp</span><span class="op" id="3448679">(</span><span class="ident" id="3448680">op</span><span class="op" id="3448682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448685">re</span><span class="op" id="3448687">.</span><span class="ident" id="3448688">Sub</span>&nbsp;<span class="op" id="3448692">=</span>&nbsp;<span class="ident" id="3448694">re</span><span class="op" id="3448696">.</span><span class="ident" id="3448697">Sub0</span><span class="op" id="3448701">[</span><span class="op" id="3448702">:</span><span class="num" id="3448703">0</span><span class="op" id="3448704">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448707">for</span>&nbsp;<span class="ident" id="3448711">_</span><span class="op" id="3448712">,</span>&nbsp;<span class="ident" id="3448714">sub</span>&nbsp;<span class="op" id="3448718">:=</span>&nbsp;<span class="keyword" id="3448721">range</span>&nbsp;<span class="ident" id="3448727">subs</span>&nbsp;<span class="op" id="3448732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448736">if</span>&nbsp;<span class="ident" id="3448739">sub</span><span class="op" id="3448742">.</span><span class="ident" id="3448743">Op</span>&nbsp;<span class="op" id="3448746">==</span>&nbsp;<span class="ident" id="3448749">op</span>&nbsp;<span class="op" id="3448752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448757">re</span><span class="op" id="3448759">.</span><span class="ident" id="3448760">Sub</span>&nbsp;<span class="op" id="3448764">=</span>&nbsp;<span class="builtinfunc" id="3448766">append</span><span class="op" id="3448772">(</span><span class="ident" id="3448773">re</span><span class="op" id="3448775">.</span><span class="ident" id="3448776">Sub</span><span class="op" id="3448779">,</span>&nbsp;<span class="ident" id="3448781">sub</span><span class="op" id="3448784">.</span><span class="ident" id="3448785">Sub</span><span class="op" id="3448788">...</span><span class="op" id="3448791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448796">p</span><span class="op" id="3448797">.</span><span class="ident" id="3448798">reuse</span><span class="op" id="3448803">(</span><span class="ident" id="3448804">sub</span><span class="op" id="3448807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448811">}</span>&nbsp;<span class="keyword" id="3448813">else</span>&nbsp;<span class="op" id="3448818">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448823">re</span><span class="op" id="3448825">.</span><span class="ident" id="3448826">Sub</span>&nbsp;<span class="op" id="3448830">=</span>&nbsp;<span class="builtinfunc" id="3448832">append</span><span class="op" id="3448838">(</span><span class="ident" id="3448839">re</span><span class="op" id="3448841">.</span><span class="ident" id="3448842">Sub</span><span class="op" id="3448845">,</span>&nbsp;<span class="ident" id="3448847">sub</span><span class="op" id="3448850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448860">if</span>&nbsp;<span class="ident" id="3448863">op</span>&nbsp;<span class="op" id="3448866">==</span>&nbsp;<span class="ident" id="3448869">OpAlternate</span>&nbsp;<span class="op" id="3448881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448885">re</span><span class="op" id="3448887">.</span><span class="ident" id="3448888">Sub</span>&nbsp;<span class="op" id="3448892">=</span>&nbsp;<span class="ident" id="3448894">p</span><span class="op" id="3448895">.</span><span class="ident" id="3448896">factor</span><span class="op" id="3448902">(</span><span class="ident" id="3448903">re</span><span class="op" id="3448905">.</span><span class="ident" id="3448906">Sub</span><span class="op" id="3448909">,</span>&nbsp;<span class="ident" id="3448911">re</span><span class="op" id="3448913">.</span><span class="ident" id="3448914">Flags</span><span class="op" id="3448919">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448923">if</span>&nbsp;<span class="builtinfunc" id="3448926">len</span><span class="op" id="3448929">(</span><span class="ident" id="3448930">re</span><span class="op" id="3448932">.</span><span class="ident" id="3448933">Sub</span><span class="op" id="3448936">)</span>&nbsp;<span class="op" id="3448938">==</span>&nbsp;<span class="num" id="3448941">1</span>&nbsp;<span class="op" id="3448943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448948">old</span>&nbsp;<span class="op" id="3448952">:=</span>&nbsp;<span class="ident" id="3448955">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448961">re</span>&nbsp;<span class="op" id="3448964">=</span>&nbsp;<span class="ident" id="3448966">re</span><span class="op" id="3448968">.</span><span class="ident" id="3448969">Sub</span><span class="op" id="3448972">[</span><span class="num" id="3448973">0</span><span class="op" id="3448974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448979">p</span><span class="op" id="3448980">.</span><span class="ident" id="3448981">reuse</span><span class="op" id="3448986">(</span><span class="ident" id="3448987">old</span><span class="op" id="3448990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448994">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449000">return</span>&nbsp;<span class="ident" id="3449007">re</span><br>
<span class="lineno"></span><span class="op" id="3449010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3449013">//&nbsp;factor&nbsp;factors&nbsp;common&nbsp;prefixes&nbsp;from&nbsp;the&nbsp;alternation&nbsp;list&nbsp;sub.</span><br>
<span class="lineno">395</span><span class="comment" id="3449078">//&nbsp;It&nbsp;returns&nbsp;a&nbsp;replacement&nbsp;list&nbsp;that&nbsp;reuses&nbsp;the&nbsp;same&nbsp;storage&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3449144">//&nbsp;frees&nbsp;(passes&nbsp;to&nbsp;p.reuse)&nbsp;any&nbsp;removed&nbsp;*Regexps.</span><br>
<span class="lineno"></span><span class="comment" id="3449195">//</span><br>
<span class="lineno"></span><span class="comment" id="3449198">//&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="3449214">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ABC|ABD|AEF|BCX|BCY</span><br>
<span class="lineno">400</span><span class="comment" id="3449241">//&nbsp;simplifies&nbsp;by&nbsp;literal&nbsp;prefix&nbsp;extraction&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3449287">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A(B(C|D)|EF)|BC(X|Y)</span><br>
<span class="lineno"></span><span class="comment" id="3449315">//&nbsp;which&nbsp;simplifies&nbsp;by&nbsp;character&nbsp;class&nbsp;introduction&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3449370">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A(B[CD]|EF)|BC[XY]</span><br>
<span class="lineno"></span><span class="comment" id="3449396">//</span><br>
<span class="lineno">405</span><span class="keyword" id="3449399">func</span>&nbsp;<span class="op" id="3449404">(</span><span class="ident" id="3449405">p</span>&nbsp;<span class="op" id="3449407">*</span><span class="ident" id="3449408">parser</span><span class="op" id="3449414">)</span>&nbsp;<span class="ident" id="3449416">factor</span><span class="op" id="3449422">(</span><span class="ident" id="3449423">sub</span>&nbsp;<span class="op" id="3449427">[</span><span class="op" id="3449428">]</span><span class="op" id="3449429">*</span><span class="ident" id="3449430">Regexp</span><span class="op" id="3449436">,</span>&nbsp;<span class="ident" id="3449438">flags</span>&nbsp;<span class="ident" id="3449444">Flags</span><span class="op" id="3449449">)</span>&nbsp;<span class="op" id="3449451">[</span><span class="op" id="3449452">]</span><span class="op" id="3449453">*</span><span class="ident" id="3449454">Regexp</span>&nbsp;<span class="op" id="3449461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449464">if</span>&nbsp;<span class="builtinfunc" id="3449467">len</span><span class="op" id="3449470">(</span><span class="ident" id="3449471">sub</span><span class="op" id="3449474">)</span>&nbsp;<span class="op" id="3449476">&lt;</span>&nbsp;<span class="num" id="3449478">2</span>&nbsp;<span class="op" id="3449480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449484">return</span>&nbsp;<span class="ident" id="3449491">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3449496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449500">//&nbsp;Round&nbsp;1:&nbsp;Factor&nbsp;out&nbsp;common&nbsp;literal&nbsp;prefixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449549">var</span>&nbsp;<span class="ident" id="3449553">str</span>&nbsp;<span class="op" id="3449557">[</span><span class="op" id="3449558">]</span><span class="builtintype" id="3449559">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449565">var</span>&nbsp;<span class="ident" id="3449569">strflags</span>&nbsp;<span class="ident" id="3449578">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449585">start</span>&nbsp;<span class="op" id="3449591">:=</span>&nbsp;<span class="num" id="3449594">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449597">out</span>&nbsp;<span class="op" id="3449601">:=</span>&nbsp;<span class="ident" id="3449604">sub</span><span class="op" id="3449607">[</span><span class="op" id="3449608">:</span><span class="num" id="3449609">0</span><span class="op" id="3449610">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449613">for</span>&nbsp;<span class="ident" id="3449617">i</span>&nbsp;<span class="op" id="3449619">:=</span>&nbsp;<span class="num" id="3449622">0</span><span class="op" id="3449623">;</span>&nbsp;<span class="ident" id="3449625">i</span>&nbsp;<span class="op" id="3449627">&lt;=</span>&nbsp;<span class="builtinfunc" id="3449630">len</span><span class="op" id="3449633">(</span><span class="ident" id="3449634">sub</span><span class="op" id="3449637">)</span><span class="op" id="3449638">;</span>&nbsp;<span class="ident" id="3449640">i</span><span class="op" id="3449641">++</span>&nbsp;<span class="op" id="3449644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449648">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449712">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449779">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449813">//</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449818">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;all&nbsp;begin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449882">//&nbsp;with&nbsp;str&nbsp;as&nbsp;modified&nbsp;by&nbsp;strflags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449921">var</span>&nbsp;<span class="ident" id="3449925">istr</span>&nbsp;<span class="op" id="3449930">[</span><span class="op" id="3449931">]</span><span class="builtintype" id="3449932">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449939">var</span>&nbsp;<span class="ident" id="3449943">iflags</span>&nbsp;<span class="ident" id="3449950">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449958">if</span>&nbsp;<span class="ident" id="3449961">i</span>&nbsp;<span class="op" id="3449963">&lt;</span>&nbsp;<span class="builtinfunc" id="3449965">len</span><span class="op" id="3449968">(</span><span class="ident" id="3449969">sub</span><span class="op" id="3449972">)</span>&nbsp;<span class="op" id="3449974">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449979">istr</span><span class="op" id="3449983">,</span>&nbsp;<span class="ident" id="3449985">iflags</span>&nbsp;<span class="op" id="3449992">=</span>&nbsp;<span class="ident" id="3449994">p</span><span class="op" id="3449995">.</span><span class="ident" id="3449996">leadingString</span><span class="op" id="3450009">(</span><span class="ident" id="3450010">sub</span><span class="op" id="3450013">[</span><span class="ident" id="3450014">i</span><span class="op" id="3450015">]</span><span class="op" id="3450016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450021">if</span>&nbsp;<span class="ident" id="3450024">iflags</span>&nbsp;<span class="op" id="3450031">==</span>&nbsp;<span class="ident" id="3450034">strflags</span>&nbsp;<span class="op" id="3450043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450049">same</span>&nbsp;<span class="op" id="3450054">:=</span>&nbsp;<span class="num" id="3450057">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450063">for</span>&nbsp;<span class="ident" id="3450067">same</span>&nbsp;<span class="op" id="3450072">&lt;</span>&nbsp;<span class="builtinfunc" id="3450074">len</span><span class="op" id="3450077">(</span><span class="ident" id="3450078">str</span><span class="op" id="3450081">)</span>&nbsp;<span class="op" id="3450083">&amp;&amp;</span>&nbsp;<span class="ident" id="3450086">same</span>&nbsp;<span class="op" id="3450091">&lt;</span>&nbsp;<span class="builtinfunc" id="3450093">len</span><span class="op" id="3450096">(</span><span class="ident" id="3450097">istr</span><span class="op" id="3450101">)</span>&nbsp;<span class="op" id="3450103">&amp;&amp;</span>&nbsp;<span class="ident" id="3450106">str</span><span class="op" id="3450109">[</span><span class="ident" id="3450110">same</span><span class="op" id="3450114">]</span>&nbsp;<span class="op" id="3450116">==</span>&nbsp;<span class="ident" id="3450119">istr</span><span class="op" id="3450123">[</span><span class="ident" id="3450124">same</span><span class="op" id="3450128">]</span>&nbsp;<span class="op" id="3450130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450137">same</span><span class="op" id="3450141">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450154">if</span>&nbsp;<span class="ident" id="3450157">same</span>&nbsp;<span class="op" id="3450162">&gt;</span>&nbsp;<span class="num" id="3450164">0</span>&nbsp;<span class="op" id="3450166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450173">//&nbsp;Matches&nbsp;at&nbsp;least&nbsp;one&nbsp;rune&nbsp;in&nbsp;current&nbsp;range.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450225">//&nbsp;Keep&nbsp;going&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450252">str</span>&nbsp;<span class="op" id="3450256">=</span>&nbsp;<span class="ident" id="3450258">str</span><span class="op" id="3450261">[</span><span class="op" id="3450262">:</span><span class="ident" id="3450263">same</span><span class="op" id="3450267">]</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450274">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450301">//&nbsp;Found&nbsp;end&nbsp;of&nbsp;a&nbsp;run&nbsp;with&nbsp;common&nbsp;leading&nbsp;literal&nbsp;string:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450361">//&nbsp;sub[start:i]&nbsp;all&nbsp;begin&nbsp;with&nbsp;str[0:len(str)],&nbsp;but&nbsp;sub[i]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450422">//&nbsp;does&nbsp;not&nbsp;even&nbsp;begin&nbsp;with&nbsp;str[0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450460">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450465">//&nbsp;Factor&nbsp;out&nbsp;common&nbsp;string&nbsp;and&nbsp;append&nbsp;factored&nbsp;expression&nbsp;to&nbsp;out.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450534">if</span>&nbsp;<span class="ident" id="3450537">i</span>&nbsp;<span class="op" id="3450539">==</span>&nbsp;<span class="ident" id="3450542">start</span>&nbsp;<span class="op" id="3450548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450553">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450591">}</span>&nbsp;<span class="keyword" id="3450593">else</span>&nbsp;<span class="keyword" id="3450598">if</span>&nbsp;<span class="ident" id="3450601">i</span>&nbsp;<span class="op" id="3450603">==</span>&nbsp;<span class="ident" id="3450606">start</span><span class="op" id="3450611">+</span><span class="num" id="3450612">1</span>&nbsp;<span class="op" id="3450614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450619">//&nbsp;Just&nbsp;one:&nbsp;don&#39;t&nbsp;bother&nbsp;factoring.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450659">out</span>&nbsp;<span class="op" id="3450663">=</span>&nbsp;<span class="builtinfunc" id="3450665">append</span><span class="op" id="3450671">(</span><span class="ident" id="3450672">out</span><span class="op" id="3450675">,</span>&nbsp;<span class="ident" id="3450677">sub</span><span class="op" id="3450680">[</span><span class="ident" id="3450681">start</span><span class="op" id="3450686">]</span><span class="op" id="3450687">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450691">}</span>&nbsp;<span class="keyword" id="3450693">else</span>&nbsp;<span class="op" id="3450698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450703">//&nbsp;Construct&nbsp;factored&nbsp;form:&nbsp;prefix(suffix1|suffix2|...)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450762">prefix</span>&nbsp;<span class="op" id="3450769">:=</span>&nbsp;<span class="ident" id="3450772">p</span><span class="op" id="3450773">.</span><span class="ident" id="3450774">newRegexp</span><span class="op" id="3450783">(</span><span class="ident" id="3450784">OpLiteral</span><span class="op" id="3450793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450798">prefix</span><span class="op" id="3450804">.</span><span class="ident" id="3450805">Flags</span>&nbsp;<span class="op" id="3450811">=</span>&nbsp;<span class="ident" id="3450813">strflags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450825">prefix</span><span class="op" id="3450831">.</span><span class="ident" id="3450832">Rune</span>&nbsp;<span class="op" id="3450837">=</span>&nbsp;<span class="builtinfunc" id="3450839">append</span><span class="op" id="3450845">(</span><span class="ident" id="3450846">prefix</span><span class="op" id="3450852">.</span><span class="ident" id="3450853">Rune</span><span class="op" id="3450857">[</span><span class="op" id="3450858">:</span><span class="num" id="3450859">0</span><span class="op" id="3450860">]</span><span class="op" id="3450861">,</span>&nbsp;<span class="ident" id="3450863">str</span><span class="op" id="3450866">...</span><span class="op" id="3450869">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450875">for</span>&nbsp;<span class="ident" id="3450879">j</span>&nbsp;<span class="op" id="3450881">:=</span>&nbsp;<span class="ident" id="3450884">start</span><span class="op" id="3450889">;</span>&nbsp;<span class="ident" id="3450891">j</span>&nbsp;<span class="op" id="3450893">&lt;</span>&nbsp;<span class="ident" id="3450895">i</span><span class="op" id="3450896">;</span>&nbsp;<span class="ident" id="3450898">j</span><span class="op" id="3450899">++</span>&nbsp;<span class="op" id="3450902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450908">sub</span><span class="op" id="3450911">[</span><span class="ident" id="3450912">j</span><span class="op" id="3450913">]</span>&nbsp;<span class="op" id="3450915">=</span>&nbsp;<span class="ident" id="3450917">p</span><span class="op" id="3450918">.</span><span class="ident" id="3450919">removeLeadingString</span><span class="op" id="3450938">(</span><span class="ident" id="3450939">sub</span><span class="op" id="3450942">[</span><span class="ident" id="3450943">j</span><span class="op" id="3450944">]</span><span class="op" id="3450945">,</span>&nbsp;<span class="builtinfunc" id="3450947">len</span><span class="op" id="3450950">(</span><span class="ident" id="3450951">str</span><span class="op" id="3450954">)</span><span class="op" id="3450955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450965">suffix</span>&nbsp;<span class="op" id="3450972">:=</span>&nbsp;<span class="ident" id="3450975">p</span><span class="op" id="3450976">.</span><span class="ident" id="3450977">collapse</span><span class="op" id="3450985">(</span><span class="ident" id="3450986">sub</span><span class="op" id="3450989">[</span><span class="ident" id="3450990">start</span><span class="op" id="3450995">:</span><span class="ident" id="3450996">i</span><span class="op" id="3450997">]</span><span class="op" id="3450998">,</span>&nbsp;<span class="ident" id="3451000">OpAlternate</span><span class="op" id="3451011">)</span>&nbsp;<span class="comment" id="3451013">//&nbsp;recurse</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451028">re</span>&nbsp;<span class="op" id="3451031">:=</span>&nbsp;<span class="ident" id="3451034">p</span><span class="op" id="3451035">.</span><span class="ident" id="3451036">newRegexp</span><span class="op" id="3451045">(</span><span class="ident" id="3451046">OpConcat</span><span class="op" id="3451054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451059">re</span><span class="op" id="3451061">.</span><span class="ident" id="3451062">Sub</span>&nbsp;<span class="op" id="3451066">=</span>&nbsp;<span class="builtinfunc" id="3451068">append</span><span class="op" id="3451074">(</span><span class="ident" id="3451075">re</span><span class="op" id="3451077">.</span><span class="ident" id="3451078">Sub</span><span class="op" id="3451081">[</span><span class="op" id="3451082">:</span><span class="num" id="3451083">0</span><span class="op" id="3451084">]</span><span class="op" id="3451085">,</span>&nbsp;<span class="ident" id="3451087">prefix</span><span class="op" id="3451093">,</span>&nbsp;<span class="ident" id="3451095">suffix</span><span class="op" id="3451101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451106">out</span>&nbsp;<span class="op" id="3451110">=</span>&nbsp;<span class="builtinfunc" id="3451112">append</span><span class="op" id="3451118">(</span><span class="ident" id="3451119">out</span><span class="op" id="3451122">,</span>&nbsp;<span class="ident" id="3451124">re</span><span class="op" id="3451126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451130">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451135">//&nbsp;Prepare&nbsp;for&nbsp;next&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451168">start</span>&nbsp;<span class="op" id="3451174">=</span>&nbsp;<span class="ident" id="3451176">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451180">str</span>&nbsp;<span class="op" id="3451184">=</span>&nbsp;<span class="ident" id="3451186">istr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451193">strflags</span>&nbsp;<span class="op" id="3451202">=</span>&nbsp;<span class="ident" id="3451204">iflags</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451215">sub</span>&nbsp;<span class="op" id="3451219">=</span>&nbsp;<span class="ident" id="3451221">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451227">//&nbsp;Round&nbsp;2:&nbsp;Factor&nbsp;out&nbsp;common&nbsp;complex&nbsp;prefixes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451276">//&nbsp;just&nbsp;the&nbsp;first&nbsp;piece&nbsp;of&nbsp;each&nbsp;concatenation,</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451324">//&nbsp;whatever&nbsp;it&nbsp;is.&nbsp;&nbsp;This&nbsp;is&nbsp;good&nbsp;enough&nbsp;a&nbsp;lot&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451384">start</span>&nbsp;<span class="op" id="3451390">=</span>&nbsp;<span class="num" id="3451392">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451395">out</span>&nbsp;<span class="op" id="3451399">=</span>&nbsp;<span class="ident" id="3451401">sub</span><span class="op" id="3451404">[</span><span class="op" id="3451405">:</span><span class="num" id="3451406">0</span><span class="op" id="3451407">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451410">var</span>&nbsp;<span class="ident" id="3451414">first</span>&nbsp;<span class="op" id="3451420">*</span><span class="ident" id="3451421">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451429">for</span>&nbsp;<span class="ident" id="3451433">i</span>&nbsp;<span class="op" id="3451435">:=</span>&nbsp;<span class="num" id="3451438">0</span><span class="op" id="3451439">;</span>&nbsp;<span class="ident" id="3451441">i</span>&nbsp;<span class="op" id="3451443">&lt;=</span>&nbsp;<span class="builtinfunc" id="3451446">len</span><span class="op" id="3451449">(</span><span class="ident" id="3451450">sub</span><span class="op" id="3451453">)</span><span class="op" id="3451454">;</span>&nbsp;<span class="ident" id="3451456">i</span><span class="op" id="3451457">++</span>&nbsp;<span class="op" id="3451460">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451464">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451528">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451595">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451629">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451634">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;all&nbsp;begin&nbsp;with&nbsp;ifirst.</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451711">var</span>&nbsp;<span class="ident" id="3451715">ifirst</span>&nbsp;<span class="op" id="3451722">*</span><span class="ident" id="3451723">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451732">if</span>&nbsp;<span class="ident" id="3451735">i</span>&nbsp;<span class="op" id="3451737">&lt;</span>&nbsp;<span class="builtinfunc" id="3451739">len</span><span class="op" id="3451742">(</span><span class="ident" id="3451743">sub</span><span class="op" id="3451746">)</span>&nbsp;<span class="op" id="3451748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451753">ifirst</span>&nbsp;<span class="op" id="3451760">=</span>&nbsp;<span class="ident" id="3451762">p</span><span class="op" id="3451763">.</span><span class="ident" id="3451764">leadingRegexp</span><span class="op" id="3451777">(</span><span class="ident" id="3451778">sub</span><span class="op" id="3451781">[</span><span class="ident" id="3451782">i</span><span class="op" id="3451783">]</span><span class="op" id="3451784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451789">if</span>&nbsp;<span class="ident" id="3451792">first</span>&nbsp;<span class="op" id="3451798">!=</span>&nbsp;<span class="ident" id="3451801">nil</span>&nbsp;<span class="op" id="3451805">&amp;&amp;</span>&nbsp;<span class="ident" id="3451808">first</span><span class="op" id="3451813">.</span><span class="ident" id="3451814">Equal</span><span class="op" id="3451819">(</span><span class="ident" id="3451820">ifirst</span><span class="op" id="3451826">)</span>&nbsp;<span class="op" id="3451828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451834">continue</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451855">//&nbsp;Found&nbsp;end&nbsp;of&nbsp;a&nbsp;run&nbsp;with&nbsp;common&nbsp;leading&nbsp;regexp:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451907">//&nbsp;sub[start:i]&nbsp;all&nbsp;begin&nbsp;with&nbsp;first&nbsp;but&nbsp;sub[i]&nbsp;does&nbsp;not.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451967">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3451972">//&nbsp;Factor&nbsp;out&nbsp;common&nbsp;regexp&nbsp;and&nbsp;append&nbsp;factored&nbsp;expression&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452041">if</span>&nbsp;<span class="ident" id="3452044">i</span>&nbsp;<span class="op" id="3452046">==</span>&nbsp;<span class="ident" id="3452049">start</span>&nbsp;<span class="op" id="3452055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452060">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452098">}</span>&nbsp;<span class="keyword" id="3452100">else</span>&nbsp;<span class="keyword" id="3452105">if</span>&nbsp;<span class="ident" id="3452108">i</span>&nbsp;<span class="op" id="3452110">==</span>&nbsp;<span class="ident" id="3452113">start</span><span class="op" id="3452118">+</span><span class="num" id="3452119">1</span>&nbsp;<span class="op" id="3452121">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452126">//&nbsp;Just&nbsp;one:&nbsp;don&#39;t&nbsp;bother&nbsp;factoring.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452166">out</span>&nbsp;<span class="op" id="3452170">=</span>&nbsp;<span class="builtinfunc" id="3452172">append</span><span class="op" id="3452178">(</span><span class="ident" id="3452179">out</span><span class="op" id="3452182">,</span>&nbsp;<span class="ident" id="3452184">sub</span><span class="op" id="3452187">[</span><span class="ident" id="3452188">start</span><span class="op" id="3452193">]</span><span class="op" id="3452194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452198">}</span>&nbsp;<span class="keyword" id="3452200">else</span>&nbsp;<span class="op" id="3452205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452210">//&nbsp;Construct&nbsp;factored&nbsp;form:&nbsp;prefix(suffix1|suffix2|...)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452269">prefix</span>&nbsp;<span class="op" id="3452276">:=</span>&nbsp;<span class="ident" id="3452279">first</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452288">for</span>&nbsp;<span class="ident" id="3452292">j</span>&nbsp;<span class="op" id="3452294">:=</span>&nbsp;<span class="ident" id="3452297">start</span><span class="op" id="3452302">;</span>&nbsp;<span class="ident" id="3452304">j</span>&nbsp;<span class="op" id="3452306">&lt;</span>&nbsp;<span class="ident" id="3452308">i</span><span class="op" id="3452309">;</span>&nbsp;<span class="ident" id="3452311">j</span><span class="op" id="3452312">++</span>&nbsp;<span class="op" id="3452315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452321">reuse</span>&nbsp;<span class="op" id="3452327">:=</span>&nbsp;<span class="ident" id="3452330">j</span>&nbsp;<span class="op" id="3452332">!=</span>&nbsp;<span class="ident" id="3452335">start</span>&nbsp;<span class="comment" id="3452341">//&nbsp;prefix&nbsp;came&nbsp;from&nbsp;sub[start]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452376">sub</span><span class="op" id="3452379">[</span><span class="ident" id="3452380">j</span><span class="op" id="3452381">]</span>&nbsp;<span class="op" id="3452383">=</span>&nbsp;<span class="ident" id="3452385">p</span><span class="op" id="3452386">.</span><span class="ident" id="3452387">removeLeadingRegexp</span><span class="op" id="3452406">(</span><span class="ident" id="3452407">sub</span><span class="op" id="3452410">[</span><span class="ident" id="3452411">j</span><span class="op" id="3452412">]</span><span class="op" id="3452413">,</span>&nbsp;<span class="ident" id="3452415">reuse</span><span class="op" id="3452420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452430">suffix</span>&nbsp;<span class="op" id="3452437">:=</span>&nbsp;<span class="ident" id="3452440">p</span><span class="op" id="3452441">.</span><span class="ident" id="3452442">collapse</span><span class="op" id="3452450">(</span><span class="ident" id="3452451">sub</span><span class="op" id="3452454">[</span><span class="ident" id="3452455">start</span><span class="op" id="3452460">:</span><span class="ident" id="3452461">i</span><span class="op" id="3452462">]</span><span class="op" id="3452463">,</span>&nbsp;<span class="ident" id="3452465">OpAlternate</span><span class="op" id="3452476">)</span>&nbsp;<span class="comment" id="3452478">//&nbsp;recurse</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452493">re</span>&nbsp;<span class="op" id="3452496">:=</span>&nbsp;<span class="ident" id="3452499">p</span><span class="op" id="3452500">.</span><span class="ident" id="3452501">newRegexp</span><span class="op" id="3452510">(</span><span class="ident" id="3452511">OpConcat</span><span class="op" id="3452519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452524">re</span><span class="op" id="3452526">.</span><span class="ident" id="3452527">Sub</span>&nbsp;<span class="op" id="3452531">=</span>&nbsp;<span class="builtinfunc" id="3452533">append</span><span class="op" id="3452539">(</span><span class="ident" id="3452540">re</span><span class="op" id="3452542">.</span><span class="ident" id="3452543">Sub</span><span class="op" id="3452546">[</span><span class="op" id="3452547">:</span><span class="num" id="3452548">0</span><span class="op" id="3452549">]</span><span class="op" id="3452550">,</span>&nbsp;<span class="ident" id="3452552">prefix</span><span class="op" id="3452558">,</span>&nbsp;<span class="ident" id="3452560">suffix</span><span class="op" id="3452566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452571">out</span>&nbsp;<span class="op" id="3452575">=</span>&nbsp;<span class="builtinfunc" id="3452577">append</span><span class="op" id="3452583">(</span><span class="ident" id="3452584">out</span><span class="op" id="3452587">,</span>&nbsp;<span class="ident" id="3452589">re</span><span class="op" id="3452591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452595">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452600">//&nbsp;Prepare&nbsp;for&nbsp;next&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452633">start</span>&nbsp;<span class="op" id="3452639">=</span>&nbsp;<span class="ident" id="3452641">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452645">first</span>&nbsp;<span class="op" id="3452651">=</span>&nbsp;<span class="ident" id="3452653">ifirst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452661">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452664">sub</span>&nbsp;<span class="op" id="3452668">=</span>&nbsp;<span class="ident" id="3452670">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452676">//&nbsp;Round&nbsp;3:&nbsp;Collapse&nbsp;runs&nbsp;of&nbsp;single&nbsp;literals&nbsp;into&nbsp;character&nbsp;classes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452746">start</span>&nbsp;<span class="op" id="3452752">=</span>&nbsp;<span class="num" id="3452754">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452757">out</span>&nbsp;<span class="op" id="3452761">=</span>&nbsp;<span class="ident" id="3452763">sub</span><span class="op" id="3452766">[</span><span class="op" id="3452767">:</span><span class="num" id="3452768">0</span><span class="op" id="3452769">]</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452772">for</span>&nbsp;<span class="ident" id="3452776">i</span>&nbsp;<span class="op" id="3452778">:=</span>&nbsp;<span class="num" id="3452781">0</span><span class="op" id="3452782">;</span>&nbsp;<span class="ident" id="3452784">i</span>&nbsp;<span class="op" id="3452786">&lt;=</span>&nbsp;<span class="builtinfunc" id="3452789">len</span><span class="op" id="3452792">(</span><span class="ident" id="3452793">sub</span><span class="op" id="3452796">)</span><span class="op" id="3452797">;</span>&nbsp;<span class="ident" id="3452799">i</span><span class="op" id="3452800">++</span>&nbsp;<span class="op" id="3452803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452807">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452871">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452938">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452972">//</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3452977">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;are&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453042">//&nbsp;literal&nbsp;runes&nbsp;or&nbsp;character&nbsp;classes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453083">if</span>&nbsp;<span class="ident" id="3453086">i</span>&nbsp;<span class="op" id="3453088">&lt;</span>&nbsp;<span class="builtinfunc" id="3453090">len</span><span class="op" id="3453093">(</span><span class="ident" id="3453094">sub</span><span class="op" id="3453097">)</span>&nbsp;<span class="op" id="3453099">&amp;&amp;</span>&nbsp;<span class="ident" id="3453102">isCharClass</span><span class="op" id="3453113">(</span><span class="ident" id="3453114">sub</span><span class="op" id="3453117">[</span><span class="ident" id="3453118">i</span><span class="op" id="3453119">]</span><span class="op" id="3453120">)</span>&nbsp;<span class="op" id="3453122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453127">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453138">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453143">//&nbsp;sub[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;char&nbsp;or&nbsp;char&nbsp;class;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453184">//&nbsp;emit&nbsp;char&nbsp;class&nbsp;for&nbsp;sub[start:i]...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453225">if</span>&nbsp;<span class="ident" id="3453228">i</span>&nbsp;<span class="op" id="3453230">==</span>&nbsp;<span class="ident" id="3453233">start</span>&nbsp;<span class="op" id="3453239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453244">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453282">}</span>&nbsp;<span class="keyword" id="3453284">else</span>&nbsp;<span class="keyword" id="3453289">if</span>&nbsp;<span class="ident" id="3453292">i</span>&nbsp;<span class="op" id="3453294">==</span>&nbsp;<span class="ident" id="3453297">start</span><span class="op" id="3453302">+</span><span class="num" id="3453303">1</span>&nbsp;<span class="op" id="3453305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453310">out</span>&nbsp;<span class="op" id="3453314">=</span>&nbsp;<span class="builtinfunc" id="3453316">append</span><span class="op" id="3453322">(</span><span class="ident" id="3453323">out</span><span class="op" id="3453326">,</span>&nbsp;<span class="ident" id="3453328">sub</span><span class="op" id="3453331">[</span><span class="ident" id="3453332">start</span><span class="op" id="3453337">]</span><span class="op" id="3453338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453342">}</span>&nbsp;<span class="keyword" id="3453344">else</span>&nbsp;<span class="op" id="3453349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453354">//&nbsp;Make&nbsp;new&nbsp;char&nbsp;class.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453381">//&nbsp;Start&nbsp;with&nbsp;most&nbsp;complex&nbsp;regexp&nbsp;in&nbsp;sub[start].</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453433">max</span>&nbsp;<span class="op" id="3453437">:=</span>&nbsp;<span class="ident" id="3453440">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453449">for</span>&nbsp;<span class="ident" id="3453453">j</span>&nbsp;<span class="op" id="3453455">:=</span>&nbsp;<span class="ident" id="3453458">start</span>&nbsp;<span class="op" id="3453464">+</span>&nbsp;<span class="num" id="3453466">1</span><span class="op" id="3453467">;</span>&nbsp;<span class="ident" id="3453469">j</span>&nbsp;<span class="op" id="3453471">&lt;</span>&nbsp;<span class="ident" id="3453473">i</span><span class="op" id="3453474">;</span>&nbsp;<span class="ident" id="3453476">j</span><span class="op" id="3453477">++</span>&nbsp;<span class="op" id="3453480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453486">if</span>&nbsp;<span class="ident" id="3453489">sub</span><span class="op" id="3453492">[</span><span class="ident" id="3453493">max</span><span class="op" id="3453496">]</span><span class="op" id="3453497">.</span><span class="ident" id="3453498">Op</span>&nbsp;<span class="op" id="3453501">&lt;</span>&nbsp;<span class="ident" id="3453503">sub</span><span class="op" id="3453506">[</span><span class="ident" id="3453507">j</span><span class="op" id="3453508">]</span><span class="op" id="3453509">.</span><span class="ident" id="3453510">Op</span>&nbsp;<span class="op" id="3453513">||</span>&nbsp;<span class="ident" id="3453516">sub</span><span class="op" id="3453519">[</span><span class="ident" id="3453520">max</span><span class="op" id="3453523">]</span><span class="op" id="3453524">.</span><span class="ident" id="3453525">Op</span>&nbsp;<span class="op" id="3453528">==</span>&nbsp;<span class="ident" id="3453531">sub</span><span class="op" id="3453534">[</span><span class="ident" id="3453535">j</span><span class="op" id="3453536">]</span><span class="op" id="3453537">.</span><span class="ident" id="3453538">Op</span>&nbsp;<span class="op" id="3453541">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3453544">len</span><span class="op" id="3453547">(</span><span class="ident" id="3453548">sub</span><span class="op" id="3453551">[</span><span class="ident" id="3453552">max</span><span class="op" id="3453555">]</span><span class="op" id="3453556">.</span><span class="ident" id="3453557">Rune</span><span class="op" id="3453561">)</span>&nbsp;<span class="op" id="3453563">&lt;</span>&nbsp;<span class="builtinfunc" id="3453565">len</span><span class="op" id="3453568">(</span><span class="ident" id="3453569">sub</span><span class="op" id="3453572">[</span><span class="ident" id="3453573">j</span><span class="op" id="3453574">]</span><span class="op" id="3453575">.</span><span class="ident" id="3453576">Rune</span><span class="op" id="3453580">)</span>&nbsp;<span class="op" id="3453582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453589">max</span>&nbsp;<span class="op" id="3453593">=</span>&nbsp;<span class="ident" id="3453595">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453601">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453611">sub</span><span class="op" id="3453614">[</span><span class="ident" id="3453615">start</span><span class="op" id="3453620">]</span><span class="op" id="3453621">,</span>&nbsp;<span class="ident" id="3453623">sub</span><span class="op" id="3453626">[</span><span class="ident" id="3453627">max</span><span class="op" id="3453630">]</span>&nbsp;<span class="op" id="3453632">=</span>&nbsp;<span class="ident" id="3453634">sub</span><span class="op" id="3453637">[</span><span class="ident" id="3453638">max</span><span class="op" id="3453641">]</span><span class="op" id="3453642">,</span>&nbsp;<span class="ident" id="3453644">sub</span><span class="op" id="3453647">[</span><span class="ident" id="3453648">start</span><span class="op" id="3453653">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453659">for</span>&nbsp;<span class="ident" id="3453663">j</span>&nbsp;<span class="op" id="3453665">:=</span>&nbsp;<span class="ident" id="3453668">start</span>&nbsp;<span class="op" id="3453674">+</span>&nbsp;<span class="num" id="3453676">1</span><span class="op" id="3453677">;</span>&nbsp;<span class="ident" id="3453679">j</span>&nbsp;<span class="op" id="3453681">&lt;</span>&nbsp;<span class="ident" id="3453683">i</span><span class="op" id="3453684">;</span>&nbsp;<span class="ident" id="3453686">j</span><span class="op" id="3453687">++</span>&nbsp;<span class="op" id="3453690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453696">mergeCharClass</span><span class="op" id="3453710">(</span><span class="ident" id="3453711">sub</span><span class="op" id="3453714">[</span><span class="ident" id="3453715">start</span><span class="op" id="3453720">]</span><span class="op" id="3453721">,</span>&nbsp;<span class="ident" id="3453723">sub</span><span class="op" id="3453726">[</span><span class="ident" id="3453727">j</span><span class="op" id="3453728">]</span><span class="op" id="3453729">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453735">p</span><span class="op" id="3453736">.</span><span class="ident" id="3453737">reuse</span><span class="op" id="3453742">(</span><span class="ident" id="3453743">sub</span><span class="op" id="3453746">[</span><span class="ident" id="3453747">j</span><span class="op" id="3453748">]</span><span class="op" id="3453749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453759">cleanAlt</span><span class="op" id="3453767">(</span><span class="ident" id="3453768">sub</span><span class="op" id="3453771">[</span><span class="ident" id="3453772">start</span><span class="op" id="3453777">]</span><span class="op" id="3453778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453783">out</span>&nbsp;<span class="op" id="3453787">=</span>&nbsp;<span class="builtinfunc" id="3453789">append</span><span class="op" id="3453795">(</span><span class="ident" id="3453796">out</span><span class="op" id="3453799">,</span>&nbsp;<span class="ident" id="3453801">sub</span><span class="op" id="3453804">[</span><span class="ident" id="3453805">start</span><span class="op" id="3453810">]</span><span class="op" id="3453811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453815">}</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453820">//&nbsp;...&nbsp;and&nbsp;then&nbsp;emit&nbsp;sub[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453851">if</span>&nbsp;<span class="ident" id="3453854">i</span>&nbsp;<span class="op" id="3453856">&lt;</span>&nbsp;<span class="builtinfunc" id="3453858">len</span><span class="op" id="3453861">(</span><span class="ident" id="3453862">sub</span><span class="op" id="3453865">)</span>&nbsp;<span class="op" id="3453867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453872">out</span>&nbsp;<span class="op" id="3453876">=</span>&nbsp;<span class="builtinfunc" id="3453878">append</span><span class="op" id="3453884">(</span><span class="ident" id="3453885">out</span><span class="op" id="3453888">,</span>&nbsp;<span class="ident" id="3453890">sub</span><span class="op" id="3453893">[</span><span class="ident" id="3453894">i</span><span class="op" id="3453895">]</span><span class="op" id="3453896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453900">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453904">start</span>&nbsp;<span class="op" id="3453910">=</span>&nbsp;<span class="ident" id="3453912">i</span>&nbsp;<span class="op" id="3453914">+</span>&nbsp;<span class="num" id="3453916">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453922">sub</span>&nbsp;<span class="op" id="3453926">=</span>&nbsp;<span class="ident" id="3453928">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3453934">//&nbsp;Round&nbsp;4:&nbsp;Collapse&nbsp;runs&nbsp;of&nbsp;empty&nbsp;matches&nbsp;into&nbsp;a&nbsp;single&nbsp;empty&nbsp;match.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454005">start</span>&nbsp;<span class="op" id="3454011">=</span>&nbsp;<span class="num" id="3454013">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454016">out</span>&nbsp;<span class="op" id="3454020">=</span>&nbsp;<span class="ident" id="3454022">sub</span><span class="op" id="3454025">[</span><span class="op" id="3454026">:</span><span class="num" id="3454027">0</span><span class="op" id="3454028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454031">for</span>&nbsp;<span class="ident" id="3454035">i</span>&nbsp;<span class="op" id="3454037">:=</span>&nbsp;<span class="keyword" id="3454040">range</span>&nbsp;<span class="ident" id="3454046">sub</span>&nbsp;<span class="op" id="3454050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454054">if</span>&nbsp;<span class="ident" id="3454057">i</span><span class="op" id="3454058">+</span><span class="num" id="3454059">1</span>&nbsp;<span class="op" id="3454061">&lt;</span>&nbsp;<span class="builtinfunc" id="3454063">len</span><span class="op" id="3454066">(</span><span class="ident" id="3454067">sub</span><span class="op" id="3454070">)</span>&nbsp;<span class="op" id="3454072">&amp;&amp;</span>&nbsp;<span class="ident" id="3454075">sub</span><span class="op" id="3454078">[</span><span class="ident" id="3454079">i</span><span class="op" id="3454080">]</span><span class="op" id="3454081">.</span><span class="ident" id="3454082">Op</span>&nbsp;<span class="op" id="3454085">==</span>&nbsp;<span class="ident" id="3454088">OpEmptyMatch</span>&nbsp;<span class="op" id="3454101">&amp;&amp;</span>&nbsp;<span class="ident" id="3454104">sub</span><span class="op" id="3454107">[</span><span class="ident" id="3454108">i</span><span class="op" id="3454109">+</span><span class="num" id="3454110">1</span><span class="op" id="3454111">]</span><span class="op" id="3454112">.</span><span class="ident" id="3454113">Op</span>&nbsp;<span class="op" id="3454116">==</span>&nbsp;<span class="ident" id="3454119">OpEmptyMatch</span>&nbsp;<span class="op" id="3454132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454137">continue</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454152">out</span>&nbsp;<span class="op" id="3454156">=</span>&nbsp;<span class="builtinfunc" id="3454158">append</span><span class="op" id="3454164">(</span><span class="ident" id="3454165">out</span><span class="op" id="3454168">,</span>&nbsp;<span class="ident" id="3454170">sub</span><span class="op" id="3454173">[</span><span class="ident" id="3454174">i</span><span class="op" id="3454175">]</span><span class="op" id="3454176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454182">sub</span>&nbsp;<span class="op" id="3454186">=</span>&nbsp;<span class="ident" id="3454188">out</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454194">return</span>&nbsp;<span class="ident" id="3454201">sub</span><br>
<span class="lineno"></span><span class="op" id="3454205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3454208">//&nbsp;leadingString&nbsp;returns&nbsp;the&nbsp;leading&nbsp;literal&nbsp;string&nbsp;that&nbsp;re&nbsp;begins&nbsp;with.</span><br>
<span class="lineno"></span><span class="comment" id="3454281">//&nbsp;The&nbsp;string&nbsp;refers&nbsp;to&nbsp;storage&nbsp;in&nbsp;re&nbsp;or&nbsp;its&nbsp;children.</span><br>
<span class="lineno">585</span><span class="keyword" id="3454336">func</span>&nbsp;<span class="op" id="3454341">(</span><span class="ident" id="3454342">p</span>&nbsp;<span class="op" id="3454344">*</span><span class="ident" id="3454345">parser</span><span class="op" id="3454351">)</span>&nbsp;<span class="ident" id="3454353">leadingString</span><span class="op" id="3454366">(</span><span class="ident" id="3454367">re</span>&nbsp;<span class="op" id="3454370">*</span><span class="ident" id="3454371">Regexp</span><span class="op" id="3454377">)</span>&nbsp;<span class="op" id="3454379">(</span><span class="op" id="3454380">[</span><span class="op" id="3454381">]</span><span class="builtintype" id="3454382">rune</span><span class="op" id="3454386">,</span>&nbsp;<span class="ident" id="3454388">Flags</span><span class="op" id="3454393">)</span>&nbsp;<span class="op" id="3454395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454398">if</span>&nbsp;<span class="ident" id="3454401">re</span><span class="op" id="3454403">.</span><span class="ident" id="3454404">Op</span>&nbsp;<span class="op" id="3454407">==</span>&nbsp;<span class="ident" id="3454410">OpConcat</span>&nbsp;<span class="op" id="3454419">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3454422">len</span><span class="op" id="3454425">(</span><span class="ident" id="3454426">re</span><span class="op" id="3454428">.</span><span class="ident" id="3454429">Sub</span><span class="op" id="3454432">)</span>&nbsp;<span class="op" id="3454434">&gt;</span>&nbsp;<span class="num" id="3454436">0</span>&nbsp;<span class="op" id="3454438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454442">re</span>&nbsp;<span class="op" id="3454445">=</span>&nbsp;<span class="ident" id="3454447">re</span><span class="op" id="3454449">.</span><span class="ident" id="3454450">Sub</span><span class="op" id="3454453">[</span><span class="num" id="3454454">0</span><span class="op" id="3454455">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454461">if</span>&nbsp;<span class="ident" id="3454464">re</span><span class="op" id="3454466">.</span><span class="ident" id="3454467">Op</span>&nbsp;<span class="op" id="3454470">!=</span>&nbsp;<span class="ident" id="3454473">OpLiteral</span>&nbsp;<span class="op" id="3454483">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454487">return</span>&nbsp;<span class="ident" id="3454494">nil</span><span class="op" id="3454497">,</span>&nbsp;<span class="num" id="3454499">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454505">return</span>&nbsp;<span class="ident" id="3454512">re</span><span class="op" id="3454514">.</span><span class="ident" id="3454515">Rune</span><span class="op" id="3454519">,</span>&nbsp;<span class="ident" id="3454521">re</span><span class="op" id="3454523">.</span><span class="ident" id="3454524">Flags</span>&nbsp;<span class="op" id="3454530">&amp;</span>&nbsp;<span class="ident" id="3454532">FoldCase</span><br>
<span class="lineno"></span><span class="op" id="3454541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="comment" id="3454544">//&nbsp;removeLeadingString&nbsp;removes&nbsp;the&nbsp;first&nbsp;n&nbsp;leading&nbsp;runes</span><br>
<span class="lineno"></span><span class="comment" id="3454601">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;re.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;replacement&nbsp;for&nbsp;re.</span><br>
<span class="lineno"></span><span class="keyword" id="3454666">func</span>&nbsp;<span class="op" id="3454671">(</span><span class="ident" id="3454672">p</span>&nbsp;<span class="op" id="3454674">*</span><span class="ident" id="3454675">parser</span><span class="op" id="3454681">)</span>&nbsp;<span class="ident" id="3454683">removeLeadingString</span><span class="op" id="3454702">(</span><span class="ident" id="3454703">re</span>&nbsp;<span class="op" id="3454706">*</span><span class="ident" id="3454707">Regexp</span><span class="op" id="3454713">,</span>&nbsp;<span class="ident" id="3454715">n</span>&nbsp;<span class="builtintype" id="3454717">int</span><span class="op" id="3454720">)</span>&nbsp;<span class="op" id="3454722">*</span><span class="ident" id="3454723">Regexp</span>&nbsp;<span class="op" id="3454730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454733">if</span>&nbsp;<span class="ident" id="3454736">re</span><span class="op" id="3454738">.</span><span class="ident" id="3454739">Op</span>&nbsp;<span class="op" id="3454742">==</span>&nbsp;<span class="ident" id="3454745">OpConcat</span>&nbsp;<span class="op" id="3454754">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3454757">len</span><span class="op" id="3454760">(</span><span class="ident" id="3454761">re</span><span class="op" id="3454763">.</span><span class="ident" id="3454764">Sub</span><span class="op" id="3454767">)</span>&nbsp;<span class="op" id="3454769">&gt;</span>&nbsp;<span class="num" id="3454771">0</span>&nbsp;<span class="op" id="3454773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454777">//&nbsp;Removing&nbsp;a&nbsp;leading&nbsp;string&nbsp;in&nbsp;a&nbsp;concatenation</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454827">//&nbsp;might&nbsp;simplify&nbsp;the&nbsp;concatenation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454866">sub</span>&nbsp;<span class="op" id="3454870">:=</span>&nbsp;<span class="ident" id="3454873">re</span><span class="op" id="3454875">.</span><span class="ident" id="3454876">Sub</span><span class="op" id="3454879">[</span><span class="num" id="3454880">0</span><span class="op" id="3454881">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454885">sub</span>&nbsp;<span class="op" id="3454889">=</span>&nbsp;<span class="ident" id="3454891">p</span><span class="op" id="3454892">.</span><span class="ident" id="3454893">removeLeadingString</span><span class="op" id="3454912">(</span><span class="ident" id="3454913">sub</span><span class="op" id="3454916">,</span>&nbsp;<span class="ident" id="3454918">n</span><span class="op" id="3454919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454923">re</span><span class="op" id="3454925">.</span><span class="ident" id="3454926">Sub</span><span class="op" id="3454929">[</span><span class="num" id="3454930">0</span><span class="op" id="3454931">]</span>&nbsp;<span class="op" id="3454933">=</span>&nbsp;<span class="ident" id="3454935">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454941">if</span>&nbsp;<span class="ident" id="3454944">sub</span><span class="op" id="3454947">.</span><span class="ident" id="3454948">Op</span>&nbsp;<span class="op" id="3454951">==</span>&nbsp;<span class="ident" id="3454954">OpEmptyMatch</span>&nbsp;<span class="op" id="3454967">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454972">p</span><span class="op" id="3454973">.</span><span class="ident" id="3454974">reuse</span><span class="op" id="3454979">(</span><span class="ident" id="3454980">sub</span><span class="op" id="3454983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454988">switch</span>&nbsp;<span class="builtinfunc" id="3454995">len</span><span class="op" id="3454998">(</span><span class="ident" id="3454999">re</span><span class="op" id="3455001">.</span><span class="ident" id="3455002">Sub</span><span class="op" id="3455005">)</span>&nbsp;<span class="op" id="3455007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455012">case</span>&nbsp;<span class="num" id="3455017">0</span><span class="op" id="3455018">,</span>&nbsp;<span class="num" id="3455020">1</span><span class="op" id="3455021">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455027">//&nbsp;Impossible&nbsp;but&nbsp;handle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455057">re</span><span class="op" id="3455059">.</span><span class="ident" id="3455060">Op</span>&nbsp;<span class="op" id="3455063">=</span>&nbsp;<span class="ident" id="3455065">OpEmptyMatch</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455082">re</span><span class="op" id="3455084">.</span><span class="ident" id="3455085">Sub</span>&nbsp;<span class="op" id="3455089">=</span>&nbsp;<span class="ident" id="3455091">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455098">case</span>&nbsp;<span class="num" id="3455103">2</span><span class="op" id="3455104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455110">old</span>&nbsp;<span class="op" id="3455114">:=</span>&nbsp;<span class="ident" id="3455117">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455124">re</span>&nbsp;<span class="op" id="3455127">=</span>&nbsp;<span class="ident" id="3455129">re</span><span class="op" id="3455131">.</span><span class="ident" id="3455132">Sub</span><span class="op" id="3455135">[</span><span class="num" id="3455136">1</span><span class="op" id="3455137">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455143">p</span><span class="op" id="3455144">.</span><span class="ident" id="3455145">reuse</span><span class="op" id="3455150">(</span><span class="ident" id="3455151">old</span><span class="op" id="3455154">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455159">default</span><span class="op" id="3455166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3455172">copy</span><span class="op" id="3455176">(</span><span class="ident" id="3455177">re</span><span class="op" id="3455179">.</span><span class="ident" id="3455180">Sub</span><span class="op" id="3455183">,</span>&nbsp;<span class="ident" id="3455185">re</span><span class="op" id="3455187">.</span><span class="ident" id="3455188">Sub</span><span class="op" id="3455191">[</span><span class="num" id="3455192">1</span><span class="op" id="3455193">:</span><span class="op" id="3455194">]</span><span class="op" id="3455195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455201">re</span><span class="op" id="3455203">.</span><span class="ident" id="3455204">Sub</span>&nbsp;<span class="op" id="3455208">=</span>&nbsp;<span class="ident" id="3455210">re</span><span class="op" id="3455212">.</span><span class="ident" id="3455213">Sub</span><span class="op" id="3455216">[</span><span class="op" id="3455217">:</span><span class="builtinfunc" id="3455218">len</span><span class="op" id="3455221">(</span><span class="ident" id="3455222">re</span><span class="op" id="3455224">.</span><span class="ident" id="3455225">Sub</span><span class="op" id="3455228">)</span><span class="op" id="3455229">-</span><span class="num" id="3455230">1</span><span class="op" id="3455231">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455240">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455244">return</span>&nbsp;<span class="ident" id="3455251">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455259">if</span>&nbsp;<span class="ident" id="3455262">re</span><span class="op" id="3455264">.</span><span class="ident" id="3455265">Op</span>&nbsp;<span class="op" id="3455268">==</span>&nbsp;<span class="ident" id="3455271">OpLiteral</span>&nbsp;<span class="op" id="3455281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455285">re</span><span class="op" id="3455287">.</span><span class="ident" id="3455288">Rune</span>&nbsp;<span class="op" id="3455293">=</span>&nbsp;<span class="ident" id="3455295">re</span><span class="op" id="3455297">.</span><span class="ident" id="3455298">Rune</span><span class="op" id="3455302">[</span><span class="op" id="3455303">:</span><span class="builtinfunc" id="3455304">copy</span><span class="op" id="3455308">(</span><span class="ident" id="3455309">re</span><span class="op" id="3455311">.</span><span class="ident" id="3455312">Rune</span><span class="op" id="3455316">,</span>&nbsp;<span class="ident" id="3455318">re</span><span class="op" id="3455320">.</span><span class="ident" id="3455321">Rune</span><span class="op" id="3455325">[</span><span class="ident" id="3455326">n</span><span class="op" id="3455327">:</span><span class="op" id="3455328">]</span><span class="op" id="3455329">)</span><span class="op" id="3455330">]</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455334">if</span>&nbsp;<span class="builtinfunc" id="3455337">len</span><span class="op" id="3455340">(</span><span class="ident" id="3455341">re</span><span class="op" id="3455343">.</span><span class="ident" id="3455344">Rune</span><span class="op" id="3455348">)</span>&nbsp;<span class="op" id="3455350">==</span>&nbsp;<span class="num" id="3455353">0</span>&nbsp;<span class="op" id="3455355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455360">re</span><span class="op" id="3455362">.</span><span class="ident" id="3455363">Op</span>&nbsp;<span class="op" id="3455366">=</span>&nbsp;<span class="ident" id="3455368">OpEmptyMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455389">return</span>&nbsp;<span class="ident" id="3455396">re</span><br>
<span class="lineno">630</span><span class="op" id="3455399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3455402">//&nbsp;leadingRegexp&nbsp;returns&nbsp;the&nbsp;leading&nbsp;regexp&nbsp;that&nbsp;re&nbsp;begins&nbsp;with.</span><br>
<span class="lineno"></span><span class="comment" id="3455467">//&nbsp;The&nbsp;regexp&nbsp;refers&nbsp;to&nbsp;storage&nbsp;in&nbsp;re&nbsp;or&nbsp;its&nbsp;children.</span><br>
<span class="lineno"></span><span class="keyword" id="3455522">func</span>&nbsp;<span class="op" id="3455527">(</span><span class="ident" id="3455528">p</span>&nbsp;<span class="op" id="3455530">*</span><span class="ident" id="3455531">parser</span><span class="op" id="3455537">)</span>&nbsp;<span class="ident" id="3455539">leadingRegexp</span><span class="op" id="3455552">(</span><span class="ident" id="3455553">re</span>&nbsp;<span class="op" id="3455556">*</span><span class="ident" id="3455557">Regexp</span><span class="op" id="3455563">)</span>&nbsp;<span class="op" id="3455565">*</span><span class="ident" id="3455566">Regexp</span>&nbsp;<span class="op" id="3455573">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455576">if</span>&nbsp;<span class="ident" id="3455579">re</span><span class="op" id="3455581">.</span><span class="ident" id="3455582">Op</span>&nbsp;<span class="op" id="3455585">==</span>&nbsp;<span class="ident" id="3455588">OpEmptyMatch</span>&nbsp;<span class="op" id="3455601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455605">return</span>&nbsp;<span class="ident" id="3455612">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455620">if</span>&nbsp;<span class="ident" id="3455623">re</span><span class="op" id="3455625">.</span><span class="ident" id="3455626">Op</span>&nbsp;<span class="op" id="3455629">==</span>&nbsp;<span class="ident" id="3455632">OpConcat</span>&nbsp;<span class="op" id="3455641">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3455644">len</span><span class="op" id="3455647">(</span><span class="ident" id="3455648">re</span><span class="op" id="3455650">.</span><span class="ident" id="3455651">Sub</span><span class="op" id="3455654">)</span>&nbsp;<span class="op" id="3455656">&gt;</span>&nbsp;<span class="num" id="3455658">0</span>&nbsp;<span class="op" id="3455660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455664">sub</span>&nbsp;<span class="op" id="3455668">:=</span>&nbsp;<span class="ident" id="3455671">re</span><span class="op" id="3455673">.</span><span class="ident" id="3455674">Sub</span><span class="op" id="3455677">[</span><span class="num" id="3455678">0</span><span class="op" id="3455679">]</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455683">if</span>&nbsp;<span class="ident" id="3455686">sub</span><span class="op" id="3455689">.</span><span class="ident" id="3455690">Op</span>&nbsp;<span class="op" id="3455693">==</span>&nbsp;<span class="ident" id="3455696">OpEmptyMatch</span>&nbsp;<span class="op" id="3455709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455714">return</span>&nbsp;<span class="ident" id="3455721">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455731">return</span>&nbsp;<span class="ident" id="3455738">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455743">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455746">return</span>&nbsp;<span class="ident" id="3455753">re</span><br>
<span class="lineno"></span><span class="op" id="3455756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3455759">//&nbsp;removeLeadingRegexp&nbsp;removes&nbsp;the&nbsp;leading&nbsp;regexp&nbsp;in&nbsp;re.</span><br>
<span class="lineno"></span><span class="comment" id="3455816">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;replacement&nbsp;for&nbsp;re.</span><br>
<span class="lineno">650</span><span class="comment" id="3455854">//&nbsp;If&nbsp;reuse&nbsp;is&nbsp;true,&nbsp;it&nbsp;passes&nbsp;the&nbsp;removed&nbsp;regexp&nbsp;(if&nbsp;no&nbsp;longer&nbsp;needed)&nbsp;to&nbsp;p.reuse.</span><br>
<span class="lineno"></span><span class="keyword" id="3455938">func</span>&nbsp;<span class="op" id="3455943">(</span><span class="ident" id="3455944">p</span>&nbsp;<span class="op" id="3455946">*</span><span class="ident" id="3455947">parser</span><span class="op" id="3455953">)</span>&nbsp;<span class="ident" id="3455955">removeLeadingRegexp</span><span class="op" id="3455974">(</span><span class="ident" id="3455975">re</span>&nbsp;<span class="op" id="3455978">*</span><span class="ident" id="3455979">Regexp</span><span class="op" id="3455985">,</span>&nbsp;<span class="ident" id="3455987">reuse</span>&nbsp;<span class="builtintype" id="3455993">bool</span><span class="op" id="3455997">)</span>&nbsp;<span class="op" id="3455999">*</span><span class="ident" id="3456000">Regexp</span>&nbsp;<span class="op" id="3456007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456010">if</span>&nbsp;<span class="ident" id="3456013">re</span><span class="op" id="3456015">.</span><span class="ident" id="3456016">Op</span>&nbsp;<span class="op" id="3456019">==</span>&nbsp;<span class="ident" id="3456022">OpConcat</span>&nbsp;<span class="op" id="3456031">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3456034">len</span><span class="op" id="3456037">(</span><span class="ident" id="3456038">re</span><span class="op" id="3456040">.</span><span class="ident" id="3456041">Sub</span><span class="op" id="3456044">)</span>&nbsp;<span class="op" id="3456046">&gt;</span>&nbsp;<span class="num" id="3456048">0</span>&nbsp;<span class="op" id="3456050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456054">if</span>&nbsp;<span class="ident" id="3456057">reuse</span>&nbsp;<span class="op" id="3456063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456068">p</span><span class="op" id="3456069">.</span><span class="ident" id="3456070">reuse</span><span class="op" id="3456075">(</span><span class="ident" id="3456076">re</span><span class="op" id="3456078">.</span><span class="ident" id="3456079">Sub</span><span class="op" id="3456082">[</span><span class="num" id="3456083">0</span><span class="op" id="3456084">]</span><span class="op" id="3456085">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456093">re</span><span class="op" id="3456095">.</span><span class="ident" id="3456096">Sub</span>&nbsp;<span class="op" id="3456100">=</span>&nbsp;<span class="ident" id="3456102">re</span><span class="op" id="3456104">.</span><span class="ident" id="3456105">Sub</span><span class="op" id="3456108">[</span><span class="op" id="3456109">:</span><span class="builtinfunc" id="3456110">copy</span><span class="op" id="3456114">(</span><span class="ident" id="3456115">re</span><span class="op" id="3456117">.</span><span class="ident" id="3456118">Sub</span><span class="op" id="3456121">,</span>&nbsp;<span class="ident" id="3456123">re</span><span class="op" id="3456125">.</span><span class="ident" id="3456126">Sub</span><span class="op" id="3456129">[</span><span class="num" id="3456130">1</span><span class="op" id="3456131">:</span><span class="op" id="3456132">]</span><span class="op" id="3456133">)</span><span class="op" id="3456134">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456138">switch</span>&nbsp;<span class="builtinfunc" id="3456145">len</span><span class="op" id="3456148">(</span><span class="ident" id="3456149">re</span><span class="op" id="3456151">.</span><span class="ident" id="3456152">Sub</span><span class="op" id="3456155">)</span>&nbsp;<span class="op" id="3456157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456161">case</span>&nbsp;<span class="num" id="3456166">0</span><span class="op" id="3456167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456172">re</span><span class="op" id="3456174">.</span><span class="ident" id="3456175">Op</span>&nbsp;<span class="op" id="3456178">=</span>&nbsp;<span class="ident" id="3456180">OpEmptyMatch</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456196">re</span><span class="op" id="3456198">.</span><span class="ident" id="3456199">Sub</span>&nbsp;<span class="op" id="3456203">=</span>&nbsp;<span class="ident" id="3456205">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456211">case</span>&nbsp;<span class="num" id="3456216">1</span><span class="op" id="3456217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456222">old</span>&nbsp;<span class="op" id="3456226">:=</span>&nbsp;<span class="ident" id="3456229">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456235">re</span>&nbsp;<span class="op" id="3456238">=</span>&nbsp;<span class="ident" id="3456240">re</span><span class="op" id="3456242">.</span><span class="ident" id="3456243">Sub</span><span class="op" id="3456246">[</span><span class="num" id="3456247">0</span><span class="op" id="3456248">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456253">p</span><span class="op" id="3456254">.</span><span class="ident" id="3456255">reuse</span><span class="op" id="3456260">(</span><span class="ident" id="3456261">old</span><span class="op" id="3456264">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456272">return</span>&nbsp;<span class="ident" id="3456279">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456286">if</span>&nbsp;<span class="ident" id="3456289">reuse</span>&nbsp;<span class="op" id="3456295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456299">p</span><span class="op" id="3456300">.</span><span class="ident" id="3456301">reuse</span><span class="op" id="3456306">(</span><span class="ident" id="3456307">re</span><span class="op" id="3456309">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456315">return</span>&nbsp;<span class="ident" id="3456322">p</span><span class="op" id="3456323">.</span><span class="ident" id="3456324">newRegexp</span><span class="op" id="3456333">(</span><span class="ident" id="3456334">OpEmptyMatch</span><span class="op" id="3456346">)</span><br>
<span class="lineno"></span><span class="op" id="3456348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3456351">func</span>&nbsp;<span class="ident" id="3456356">literalRegexp</span><span class="op" id="3456369">(</span><span class="ident" id="3456370">s</span>&nbsp;<span class="builtintype" id="3456372">string</span><span class="op" id="3456378">,</span>&nbsp;<span class="ident" id="3456380">flags</span>&nbsp;<span class="ident" id="3456386">Flags</span><span class="op" id="3456391">)</span>&nbsp;<span class="op" id="3456393">*</span><span class="ident" id="3456394">Regexp</span>&nbsp;<span class="op" id="3456401">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456404">re</span>&nbsp;<span class="op" id="3456407">:=</span>&nbsp;<span class="op" id="3456410">&amp;</span><span class="ident" id="3456411">Regexp</span><span class="op" id="3456417">{</span><span class="ident" id="3456418">Op</span><span class="op" id="3456420">:</span>&nbsp;<span class="ident" id="3456422">OpLiteral</span><span class="op" id="3456431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456434">re</span><span class="op" id="3456436">.</span><span class="ident" id="3456437">Flags</span>&nbsp;<span class="op" id="3456443">=</span>&nbsp;<span class="ident" id="3456445">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456452">re</span><span class="op" id="3456454">.</span><span class="ident" id="3456455">Rune</span>&nbsp;<span class="op" id="3456460">=</span>&nbsp;<span class="ident" id="3456462">re</span><span class="op" id="3456464">.</span><span class="ident" id="3456465">Rune0</span><span class="op" id="3456470">[</span><span class="op" id="3456471">:</span><span class="num" id="3456472">0</span><span class="op" id="3456473">]</span>&nbsp;<span class="comment" id="3456475">//&nbsp;use&nbsp;local&nbsp;storage&nbsp;for&nbsp;small&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456515">for</span>&nbsp;<span class="ident" id="3456519">_</span><span class="op" id="3456520">,</span>&nbsp;<span class="ident" id="3456522">c</span>&nbsp;<span class="op" id="3456524">:=</span>&nbsp;<span class="keyword" id="3456527">range</span>&nbsp;<span class="ident" id="3456533">s</span>&nbsp;<span class="op" id="3456535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456539">if</span>&nbsp;<span class="builtinfunc" id="3456542">len</span><span class="op" id="3456545">(</span><span class="ident" id="3456546">re</span><span class="op" id="3456548">.</span><span class="ident" id="3456549">Rune</span><span class="op" id="3456553">)</span>&nbsp;<span class="op" id="3456555">&gt;=</span>&nbsp;<span class="builtinfunc" id="3456558">cap</span><span class="op" id="3456561">(</span><span class="ident" id="3456562">re</span><span class="op" id="3456564">.</span><span class="ident" id="3456565">Rune</span><span class="op" id="3456569">)</span>&nbsp;<span class="op" id="3456571">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456576">//&nbsp;string&nbsp;is&nbsp;too&nbsp;long&nbsp;to&nbsp;fit&nbsp;in&nbsp;Rune0.&nbsp;&nbsp;let&nbsp;Go&nbsp;handle&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456636">re</span><span class="op" id="3456638">.</span><span class="ident" id="3456639">Rune</span>&nbsp;<span class="op" id="3456644">=</span>&nbsp;<span class="op" id="3456646">[</span><span class="op" id="3456647">]</span><span class="builtintype" id="3456648">rune</span><span class="op" id="3456652">(</span><span class="ident" id="3456653">s</span><span class="op" id="3456654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456659">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456671">re</span><span class="op" id="3456673">.</span><span class="ident" id="3456674">Rune</span>&nbsp;<span class="op" id="3456679">=</span>&nbsp;<span class="builtinfunc" id="3456681">append</span><span class="op" id="3456687">(</span><span class="ident" id="3456688">re</span><span class="op" id="3456690">.</span><span class="ident" id="3456691">Rune</span><span class="op" id="3456695">,</span>&nbsp;<span class="ident" id="3456697">c</span><span class="op" id="3456698">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456704">return</span>&nbsp;<span class="ident" id="3456711">re</span><br>
<span class="lineno"></span><span class="op" id="3456714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3456717">//&nbsp;Parsing.</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="comment" id="3456730">//&nbsp;Parse&nbsp;parses&nbsp;a&nbsp;regular&nbsp;expression&nbsp;string&nbsp;s,&nbsp;controlled&nbsp;by&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="3456805">//&nbsp;Flags,&nbsp;and&nbsp;returns&nbsp;a&nbsp;regular&nbsp;expression&nbsp;parse&nbsp;tree.&nbsp;The&nbsp;syntax&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3456874">//&nbsp;described&nbsp;in&nbsp;the&nbsp;top-level&nbsp;comment.</span><br>
<span class="lineno"></span><span class="keyword" id="3456913">func</span>&nbsp;<span class="ident" id="3456918">Parse</span><span class="op" id="3456923">(</span><span class="ident" id="3456924">s</span>&nbsp;<span class="builtintype" id="3456926">string</span><span class="op" id="3456932">,</span>&nbsp;<span class="ident" id="3456934">flags</span>&nbsp;<span class="ident" id="3456940">Flags</span><span class="op" id="3456945">)</span>&nbsp;<span class="op" id="3456947">(</span><span class="op" id="3456948">*</span><span class="ident" id="3456949">Regexp</span><span class="op" id="3456955">,</span>&nbsp;<span class="builtintype" id="3456957">error</span><span class="op" id="3456962">)</span>&nbsp;<span class="op" id="3456964">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456967">if</span>&nbsp;<span class="ident" id="3456970">flags</span><span class="op" id="3456975">&amp;</span><span class="ident" id="3456976">Literal</span>&nbsp;<span class="op" id="3456984">!=</span>&nbsp;<span class="num" id="3456987">0</span>&nbsp;<span class="op" id="3456989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456993">//&nbsp;Trivial&nbsp;parser&nbsp;for&nbsp;literal&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457033">if</span>&nbsp;<span class="ident" id="3457036">err</span>&nbsp;<span class="op" id="3457040">:=</span>&nbsp;<span class="ident" id="3457043">checkUTF8</span><span class="op" id="3457052">(</span><span class="ident" id="3457053">s</span><span class="op" id="3457054">)</span><span class="op" id="3457055">;</span>&nbsp;<span class="ident" id="3457057">err</span>&nbsp;<span class="op" id="3457061">!=</span>&nbsp;<span class="ident" id="3457064">nil</span>&nbsp;<span class="op" id="3457068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457073">return</span>&nbsp;<span class="ident" id="3457080">nil</span><span class="op" id="3457083">,</span>&nbsp;<span class="ident" id="3457085">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457091">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457095">return</span>&nbsp;<span class="ident" id="3457102">literalRegexp</span><span class="op" id="3457115">(</span><span class="ident" id="3457116">s</span><span class="op" id="3457117">,</span>&nbsp;<span class="ident" id="3457119">flags</span><span class="op" id="3457124">)</span><span class="op" id="3457125">,</span>&nbsp;<span class="ident" id="3457127">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457136">//&nbsp;Otherwise,&nbsp;must&nbsp;do&nbsp;real&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457170">var</span>&nbsp;<span class="op" id="3457174">(</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457178">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457189">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457198">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3457209">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457217">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3457228">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457235">op</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457246">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457251">lastRepeat</span>&nbsp;<span class="builtintype" id="3457262">string</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457273">p</span><span class="op" id="3457274">.</span><span class="ident" id="3457275">flags</span>&nbsp;<span class="op" id="3457281">=</span>&nbsp;<span class="ident" id="3457283">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457290">p</span><span class="op" id="3457291">.</span><span class="ident" id="3457292">wholeRegexp</span>&nbsp;<span class="op" id="3457304">=</span>&nbsp;<span class="ident" id="3457306">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457309">t</span>&nbsp;<span class="op" id="3457311">:=</span>&nbsp;<span class="ident" id="3457314">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457317">for</span>&nbsp;<span class="ident" id="3457321">t</span>&nbsp;<span class="op" id="3457323">!=</span>&nbsp;<span class="string" id="3457326">&#34;&#34;</span>&nbsp;<span class="op" id="3457329">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457333">repeat</span>&nbsp;<span class="op" id="3457340">:=</span>&nbsp;<span class="string" id="3457343">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457347">BigSwitch</span><span class="op" id="3457356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457360">switch</span>&nbsp;<span class="ident" id="3457367">t</span><span class="op" id="3457368">[</span><span class="num" id="3457369">0</span><span class="op" id="3457370">]</span>&nbsp;<span class="op" id="3457372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457376">default</span><span class="op" id="3457383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457388">if</span>&nbsp;<span class="ident" id="3457391">c</span><span class="op" id="3457392">,</span>&nbsp;<span class="ident" id="3457394">t</span><span class="op" id="3457395">,</span>&nbsp;<span class="ident" id="3457397">err</span>&nbsp;<span class="op" id="3457401">=</span>&nbsp;<span class="ident" id="3457403">nextRune</span><span class="op" id="3457411">(</span><span class="ident" id="3457412">t</span><span class="op" id="3457413">)</span><span class="op" id="3457414">;</span>&nbsp;<span class="ident" id="3457416">err</span>&nbsp;<span class="op" id="3457420">!=</span>&nbsp;<span class="ident" id="3457423">nil</span>&nbsp;<span class="op" id="3457427">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457433">return</span>&nbsp;<span class="ident" id="3457440">nil</span><span class="op" id="3457443">,</span>&nbsp;<span class="ident" id="3457445">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457457">p</span><span class="op" id="3457458">.</span><span class="ident" id="3457459">literal</span><span class="op" id="3457466">(</span><span class="ident" id="3457467">c</span><span class="op" id="3457468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457473">case</span>&nbsp;<span class="string" id="3457478">&#39;(&#39;</span><span class="op" id="3457481">:</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457486">if</span>&nbsp;<span class="ident" id="3457489">p</span><span class="op" id="3457490">.</span><span class="ident" id="3457491">flags</span><span class="op" id="3457496">&amp;</span><span class="ident" id="3457497">PerlX</span>&nbsp;<span class="op" id="3457503">!=</span>&nbsp;<span class="num" id="3457506">0</span>&nbsp;<span class="op" id="3457508">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3457511">len</span><span class="op" id="3457514">(</span><span class="ident" id="3457515">t</span><span class="op" id="3457516">)</span>&nbsp;<span class="op" id="3457518">&gt;=</span>&nbsp;<span class="num" id="3457521">2</span>&nbsp;<span class="op" id="3457523">&amp;&amp;</span>&nbsp;<span class="ident" id="3457526">t</span><span class="op" id="3457527">[</span><span class="num" id="3457528">1</span><span class="op" id="3457529">]</span>&nbsp;<span class="op" id="3457531">==</span>&nbsp;<span class="string" id="3457534">&#39;?&#39;</span>&nbsp;<span class="op" id="3457538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457544">//&nbsp;Flag&nbsp;changes&nbsp;and&nbsp;non-capturing&nbsp;groups.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457590">if</span>&nbsp;<span class="ident" id="3457593">t</span><span class="op" id="3457594">,</span>&nbsp;<span class="ident" id="3457596">err</span>&nbsp;<span class="op" id="3457600">=</span>&nbsp;<span class="ident" id="3457602">p</span><span class="op" id="3457603">.</span><span class="ident" id="3457604">parsePerlFlags</span><span class="op" id="3457618">(</span><span class="ident" id="3457619">t</span><span class="op" id="3457620">)</span><span class="op" id="3457621">;</span>&nbsp;<span class="ident" id="3457623">err</span>&nbsp;<span class="op" id="3457627">!=</span>&nbsp;<span class="ident" id="3457630">nil</span>&nbsp;<span class="op" id="3457634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457641">return</span>&nbsp;<span class="ident" id="3457648">nil</span><span class="op" id="3457651">,</span>&nbsp;<span class="ident" id="3457653">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457661">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457667">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457681">p</span><span class="op" id="3457682">.</span><span class="ident" id="3457683">numCap</span><span class="op" id="3457689">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457695">p</span><span class="op" id="3457696">.</span><span class="ident" id="3457697">op</span><span class="op" id="3457699">(</span><span class="ident" id="3457700">opLeftParen</span><span class="op" id="3457711">)</span><span class="op" id="3457712">.</span><span class="ident" id="3457713">Cap</span>&nbsp;<span class="op" id="3457717">=</span>&nbsp;<span class="ident" id="3457719">p</span><span class="op" id="3457720">.</span><span class="ident" id="3457721">numCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457731">t</span>&nbsp;<span class="op" id="3457733">=</span>&nbsp;<span class="ident" id="3457735">t</span><span class="op" id="3457736">[</span><span class="num" id="3457737">1</span><span class="op" id="3457738">:</span><span class="op" id="3457739">]</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457743">case</span>&nbsp;<span class="string" id="3457748">&#39;|&#39;</span><span class="op" id="3457751">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457756">if</span>&nbsp;<span class="ident" id="3457759">err</span>&nbsp;<span class="op" id="3457763">=</span>&nbsp;<span class="ident" id="3457765">p</span><span class="op" id="3457766">.</span><span class="ident" id="3457767">parseVerticalBar</span><span class="op" id="3457783">(</span><span class="op" id="3457784">)</span><span class="op" id="3457785">;</span>&nbsp;<span class="ident" id="3457787">err</span>&nbsp;<span class="op" id="3457791">!=</span>&nbsp;<span class="ident" id="3457794">nil</span>&nbsp;<span class="op" id="3457798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457804">return</span>&nbsp;<span class="ident" id="3457811">nil</span><span class="op" id="3457814">,</span>&nbsp;<span class="ident" id="3457816">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457828">t</span>&nbsp;<span class="op" id="3457830">=</span>&nbsp;<span class="ident" id="3457832">t</span><span class="op" id="3457833">[</span><span class="num" id="3457834">1</span><span class="op" id="3457835">:</span><span class="op" id="3457836">]</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457840">case</span>&nbsp;<span class="string" id="3457845">&#39;)&#39;</span><span class="op" id="3457848">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457853">if</span>&nbsp;<span class="ident" id="3457856">err</span>&nbsp;<span class="op" id="3457860">=</span>&nbsp;<span class="ident" id="3457862">p</span><span class="op" id="3457863">.</span><span class="ident" id="3457864">parseRightParen</span><span class="op" id="3457879">(</span><span class="op" id="3457880">)</span><span class="op" id="3457881">;</span>&nbsp;<span class="ident" id="3457883">err</span>&nbsp;<span class="op" id="3457887">!=</span>&nbsp;<span class="ident" id="3457890">nil</span>&nbsp;<span class="op" id="3457894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457900">return</span>&nbsp;<span class="ident" id="3457907">nil</span><span class="op" id="3457910">,</span>&nbsp;<span class="ident" id="3457912">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457924">t</span>&nbsp;<span class="op" id="3457926">=</span>&nbsp;<span class="ident" id="3457928">t</span><span class="op" id="3457929">[</span><span class="num" id="3457930">1</span><span class="op" id="3457931">:</span><span class="op" id="3457932">]</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457936">case</span>&nbsp;<span class="string" id="3457941">&#39;^&#39;</span><span class="op" id="3457944">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457949">if</span>&nbsp;<span class="ident" id="3457952">p</span><span class="op" id="3457953">.</span><span class="ident" id="3457954">flags</span><span class="op" id="3457959">&amp;</span><span class="ident" id="3457960">OneLine</span>&nbsp;<span class="op" id="3457968">!=</span>&nbsp;<span class="num" id="3457971">0</span>&nbsp;<span class="op" id="3457973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457979">p</span><span class="op" id="3457980">.</span><span class="ident" id="3457981">op</span><span class="op" id="3457983">(</span><span class="ident" id="3457984">OpBeginText</span><span class="op" id="3457995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458000">}</span>&nbsp;<span class="keyword" id="3458002">else</span>&nbsp;<span class="op" id="3458007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458013">p</span><span class="op" id="3458014">.</span><span class="ident" id="3458015">op</span><span class="op" id="3458017">(</span><span class="ident" id="3458018">OpBeginLine</span><span class="op" id="3458029">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458039">t</span>&nbsp;<span class="op" id="3458041">=</span>&nbsp;<span class="ident" id="3458043">t</span><span class="op" id="3458044">[</span><span class="num" id="3458045">1</span><span class="op" id="3458046">:</span><span class="op" id="3458047">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458051">case</span>&nbsp;<span class="string" id="3458056">&#39;$&#39;</span><span class="op" id="3458059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458064">if</span>&nbsp;<span class="ident" id="3458067">p</span><span class="op" id="3458068">.</span><span class="ident" id="3458069">flags</span><span class="op" id="3458074">&amp;</span><span class="ident" id="3458075">OneLine</span>&nbsp;<span class="op" id="3458083">!=</span>&nbsp;<span class="num" id="3458086">0</span>&nbsp;<span class="op" id="3458088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458094">p</span><span class="op" id="3458095">.</span><span class="ident" id="3458096">op</span><span class="op" id="3458098">(</span><span class="ident" id="3458099">OpEndText</span><span class="op" id="3458108">)</span><span class="op" id="3458109">.</span><span class="ident" id="3458110">Flags</span>&nbsp;<span class="op" id="3458116">|=</span>&nbsp;<span class="ident" id="3458119">WasDollar</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458132">}</span>&nbsp;<span class="keyword" id="3458134">else</span>&nbsp;<span class="op" id="3458139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458145">p</span><span class="op" id="3458146">.</span><span class="ident" id="3458147">op</span><span class="op" id="3458149">(</span><span class="ident" id="3458150">OpEndLine</span><span class="op" id="3458159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458169">t</span>&nbsp;<span class="op" id="3458171">=</span>&nbsp;<span class="ident" id="3458173">t</span><span class="op" id="3458174">[</span><span class="num" id="3458175">1</span><span class="op" id="3458176">:</span><span class="op" id="3458177">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458181">case</span>&nbsp;<span class="string" id="3458186">&#39;.&#39;</span><span class="op" id="3458189">:</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458194">if</span>&nbsp;<span class="ident" id="3458197">p</span><span class="op" id="3458198">.</span><span class="ident" id="3458199">flags</span><span class="op" id="3458204">&amp;</span><span class="ident" id="3458205">DotNL</span>&nbsp;<span class="op" id="3458211">!=</span>&nbsp;<span class="num" id="3458214">0</span>&nbsp;<span class="op" id="3458216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458222">p</span><span class="op" id="3458223">.</span><span class="ident" id="3458224">op</span><span class="op" id="3458226">(</span><span class="ident" id="3458227">OpAnyChar</span><span class="op" id="3458236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458241">}</span>&nbsp;<span class="keyword" id="3458243">else</span>&nbsp;<span class="op" id="3458248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458254">p</span><span class="op" id="3458255">.</span><span class="ident" id="3458256">op</span><span class="op" id="3458258">(</span><span class="ident" id="3458259">OpAnyCharNotNL</span><span class="op" id="3458273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458278">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458283">t</span>&nbsp;<span class="op" id="3458285">=</span>&nbsp;<span class="ident" id="3458287">t</span><span class="op" id="3458288">[</span><span class="num" id="3458289">1</span><span class="op" id="3458290">:</span><span class="op" id="3458291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458295">case</span>&nbsp;<span class="string" id="3458300">&#39;[&#39;</span><span class="op" id="3458303">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458308">if</span>&nbsp;<span class="ident" id="3458311">t</span><span class="op" id="3458312">,</span>&nbsp;<span class="ident" id="3458314">err</span>&nbsp;<span class="op" id="3458318">=</span>&nbsp;<span class="ident" id="3458320">p</span><span class="op" id="3458321">.</span><span class="ident" id="3458322">parseClass</span><span class="op" id="3458332">(</span><span class="ident" id="3458333">t</span><span class="op" id="3458334">)</span><span class="op" id="3458335">;</span>&nbsp;<span class="ident" id="3458337">err</span>&nbsp;<span class="op" id="3458341">!=</span>&nbsp;<span class="ident" id="3458344">nil</span>&nbsp;<span class="op" id="3458348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458354">return</span>&nbsp;<span class="ident" id="3458361">nil</span><span class="op" id="3458364">,</span>&nbsp;<span class="ident" id="3458366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458373">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458377">case</span>&nbsp;<span class="string" id="3458382">&#39;*&#39;</span><span class="op" id="3458385">,</span>&nbsp;<span class="string" id="3458387">&#39;+&#39;</span><span class="op" id="3458390">,</span>&nbsp;<span class="string" id="3458392">&#39;?&#39;</span><span class="op" id="3458395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458400">before</span>&nbsp;<span class="op" id="3458407">:=</span>&nbsp;<span class="ident" id="3458410">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458415">switch</span>&nbsp;<span class="ident" id="3458422">t</span><span class="op" id="3458423">[</span><span class="num" id="3458424">0</span><span class="op" id="3458425">]</span>&nbsp;<span class="op" id="3458427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458432">case</span>&nbsp;<span class="string" id="3458437">&#39;*&#39;</span><span class="op" id="3458440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458446">op</span>&nbsp;<span class="op" id="3458449">=</span>&nbsp;<span class="ident" id="3458451">OpStar</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458461">case</span>&nbsp;<span class="string" id="3458466">&#39;+&#39;</span><span class="op" id="3458469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458475">op</span>&nbsp;<span class="op" id="3458478">=</span>&nbsp;<span class="ident" id="3458480">OpPlus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458490">case</span>&nbsp;<span class="string" id="3458495">&#39;?&#39;</span><span class="op" id="3458498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458504">op</span>&nbsp;<span class="op" id="3458507">=</span>&nbsp;<span class="ident" id="3458509">OpQuest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458520">}</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458525">after</span>&nbsp;<span class="op" id="3458531">:=</span>&nbsp;<span class="ident" id="3458534">t</span><span class="op" id="3458535">[</span><span class="num" id="3458536">1</span><span class="op" id="3458537">:</span><span class="op" id="3458538">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458543">if</span>&nbsp;<span class="ident" id="3458546">after</span><span class="op" id="3458551">,</span>&nbsp;<span class="ident" id="3458553">err</span>&nbsp;<span class="op" id="3458557">=</span>&nbsp;<span class="ident" id="3458559">p</span><span class="op" id="3458560">.</span><span class="ident" id="3458561">repeat</span><span class="op" id="3458567">(</span><span class="ident" id="3458568">op</span><span class="op" id="3458570">,</span>&nbsp;<span class="num" id="3458572">0</span><span class="op" id="3458573">,</span>&nbsp;<span class="num" id="3458575">0</span><span class="op" id="3458576">,</span>&nbsp;<span class="ident" id="3458578">before</span><span class="op" id="3458584">,</span>&nbsp;<span class="ident" id="3458586">after</span><span class="op" id="3458591">,</span>&nbsp;<span class="ident" id="3458593">lastRepeat</span><span class="op" id="3458603">)</span><span class="op" id="3458604">;</span>&nbsp;<span class="ident" id="3458606">err</span>&nbsp;<span class="op" id="3458610">!=</span>&nbsp;<span class="ident" id="3458613">nil</span>&nbsp;<span class="op" id="3458617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458623">return</span>&nbsp;<span class="ident" id="3458630">nil</span><span class="op" id="3458633">,</span>&nbsp;<span class="ident" id="3458635">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458647">repeat</span>&nbsp;<span class="op" id="3458654">=</span>&nbsp;<span class="ident" id="3458656">before</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458666">t</span>&nbsp;<span class="op" id="3458668">=</span>&nbsp;<span class="ident" id="3458670">after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458678">case</span>&nbsp;<span class="string" id="3458683">&#39;{&#39;</span><span class="op" id="3458686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458691">op</span>&nbsp;<span class="op" id="3458694">=</span>&nbsp;<span class="ident" id="3458696">OpRepeat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458708">before</span>&nbsp;<span class="op" id="3458715">:=</span>&nbsp;<span class="ident" id="3458718">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458723">min</span><span class="op" id="3458726">,</span>&nbsp;<span class="ident" id="3458728">max</span><span class="op" id="3458731">,</span>&nbsp;<span class="ident" id="3458733">after</span><span class="op" id="3458738">,</span>&nbsp;<span class="ident" id="3458740">ok</span>&nbsp;<span class="op" id="3458743">:=</span>&nbsp;<span class="ident" id="3458746">p</span><span class="op" id="3458747">.</span><span class="ident" id="3458748">parseRepeat</span><span class="op" id="3458759">(</span><span class="ident" id="3458760">t</span><span class="op" id="3458761">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458766">if</span>&nbsp;<span class="op" id="3458769">!</span><span class="ident" id="3458770">ok</span>&nbsp;<span class="op" id="3458773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458779">//&nbsp;If&nbsp;the&nbsp;repeat&nbsp;cannot&nbsp;be&nbsp;parsed,&nbsp;{&nbsp;is&nbsp;a&nbsp;literal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458834">p</span><span class="op" id="3458835">.</span><span class="ident" id="3458836">literal</span><span class="op" id="3458843">(</span><span class="string" id="3458844">&#39;{&#39;</span><span class="op" id="3458847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458853">t</span>&nbsp;<span class="op" id="3458855">=</span>&nbsp;<span class="ident" id="3458857">t</span><span class="op" id="3458858">[</span><span class="num" id="3458859">1</span><span class="op" id="3458860">:</span><span class="op" id="3458861">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458867">break</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458881">if</span>&nbsp;<span class="ident" id="3458884">min</span>&nbsp;<span class="op" id="3458888">&lt;</span>&nbsp;<span class="num" id="3458890">0</span>&nbsp;<span class="op" id="3458892">||</span>&nbsp;<span class="ident" id="3458895">min</span>&nbsp;<span class="op" id="3458899">&gt;</span>&nbsp;<span class="num" id="3458901">1000</span>&nbsp;<span class="op" id="3458906">||</span>&nbsp;<span class="ident" id="3458909">max</span>&nbsp;<span class="op" id="3458913">&gt;</span>&nbsp;<span class="num" id="3458915">1000</span>&nbsp;<span class="op" id="3458920">||</span>&nbsp;<span class="ident" id="3458923">max</span>&nbsp;<span class="op" id="3458927">&gt;=</span>&nbsp;<span class="num" id="3458930">0</span>&nbsp;<span class="op" id="3458932">&amp;&amp;</span>&nbsp;<span class="ident" id="3458935">min</span>&nbsp;<span class="op" id="3458939">&gt;</span>&nbsp;<span class="ident" id="3458941">max</span>&nbsp;<span class="op" id="3458945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458951">//&nbsp;Numbers&nbsp;were&nbsp;too&nbsp;big,&nbsp;or&nbsp;max&nbsp;is&nbsp;present&nbsp;and&nbsp;min&nbsp;&gt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459013">return</span>&nbsp;<span class="ident" id="3459020">nil</span><span class="op" id="3459023">,</span>&nbsp;<span class="op" id="3459025">&amp;</span><span class="ident" id="3459026">Error</span><span class="op" id="3459031">{</span><span class="ident" id="3459032">ErrInvalidRepeatSize</span><span class="op" id="3459052">,</span>&nbsp;<span class="ident" id="3459054">before</span><span class="op" id="3459060">[</span><span class="op" id="3459061">:</span><span class="builtinfunc" id="3459062">len</span><span class="op" id="3459065">(</span><span class="ident" id="3459066">before</span><span class="op" id="3459072">)</span><span class="op" id="3459073">-</span><span class="builtinfunc" id="3459074">len</span><span class="op" id="3459077">(</span><span class="ident" id="3459078">after</span><span class="op" id="3459083">)</span><span class="op" id="3459084">]</span><span class="op" id="3459085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459090">}</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459095">if</span>&nbsp;<span class="ident" id="3459098">after</span><span class="op" id="3459103">,</span>&nbsp;<span class="ident" id="3459105">err</span>&nbsp;<span class="op" id="3459109">=</span>&nbsp;<span class="ident" id="3459111">p</span><span class="op" id="3459112">.</span><span class="ident" id="3459113">repeat</span><span class="op" id="3459119">(</span><span class="ident" id="3459120">op</span><span class="op" id="3459122">,</span>&nbsp;<span class="ident" id="3459124">min</span><span class="op" id="3459127">,</span>&nbsp;<span class="ident" id="3459129">max</span><span class="op" id="3459132">,</span>&nbsp;<span class="ident" id="3459134">before</span><span class="op" id="3459140">,</span>&nbsp;<span class="ident" id="3459142">after</span><span class="op" id="3459147">,</span>&nbsp;<span class="ident" id="3459149">lastRepeat</span><span class="op" id="3459159">)</span><span class="op" id="3459160">;</span>&nbsp;<span class="ident" id="3459162">err</span>&nbsp;<span class="op" id="3459166">!=</span>&nbsp;<span class="ident" id="3459169">nil</span>&nbsp;<span class="op" id="3459173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459179">return</span>&nbsp;<span class="ident" id="3459186">nil</span><span class="op" id="3459189">,</span>&nbsp;<span class="ident" id="3459191">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459203">repeat</span>&nbsp;<span class="op" id="3459210">=</span>&nbsp;<span class="ident" id="3459212">before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459222">t</span>&nbsp;<span class="op" id="3459224">=</span>&nbsp;<span class="ident" id="3459226">after</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459234">case</span>&nbsp;<span class="string" id="3459239">&#39;\\&#39;</span><span class="op" id="3459243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459248">if</span>&nbsp;<span class="ident" id="3459251">p</span><span class="op" id="3459252">.</span><span class="ident" id="3459253">flags</span><span class="op" id="3459258">&amp;</span><span class="ident" id="3459259">PerlX</span>&nbsp;<span class="op" id="3459265">!=</span>&nbsp;<span class="num" id="3459268">0</span>&nbsp;<span class="op" id="3459270">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3459273">len</span><span class="op" id="3459276">(</span><span class="ident" id="3459277">t</span><span class="op" id="3459278">)</span>&nbsp;<span class="op" id="3459280">&gt;=</span>&nbsp;<span class="num" id="3459283">2</span>&nbsp;<span class="op" id="3459285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459291">switch</span>&nbsp;<span class="ident" id="3459298">t</span><span class="op" id="3459299">[</span><span class="num" id="3459300">1</span><span class="op" id="3459301">]</span>&nbsp;<span class="op" id="3459303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459309">case</span>&nbsp;<span class="string" id="3459314">&#39;A&#39;</span><span class="op" id="3459317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459324">p</span><span class="op" id="3459325">.</span><span class="ident" id="3459326">op</span><span class="op" id="3459328">(</span><span class="ident" id="3459329">OpBeginText</span><span class="op" id="3459340">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459347">t</span>&nbsp;<span class="op" id="3459349">=</span>&nbsp;<span class="ident" id="3459351">t</span><span class="op" id="3459352">[</span><span class="num" id="3459353">2</span><span class="op" id="3459354">:</span><span class="op" id="3459355">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459362">break</span>&nbsp;<span class="ident" id="3459368">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459382">case</span>&nbsp;<span class="string" id="3459387">&#39;b&#39;</span><span class="op" id="3459390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459397">p</span><span class="op" id="3459398">.</span><span class="ident" id="3459399">op</span><span class="op" id="3459401">(</span><span class="ident" id="3459402">OpWordBoundary</span><span class="op" id="3459416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459423">t</span>&nbsp;<span class="op" id="3459425">=</span>&nbsp;<span class="ident" id="3459427">t</span><span class="op" id="3459428">[</span><span class="num" id="3459429">2</span><span class="op" id="3459430">:</span><span class="op" id="3459431">]</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459438">break</span>&nbsp;<span class="ident" id="3459444">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459458">case</span>&nbsp;<span class="string" id="3459463">&#39;B&#39;</span><span class="op" id="3459466">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459473">p</span><span class="op" id="3459474">.</span><span class="ident" id="3459475">op</span><span class="op" id="3459477">(</span><span class="ident" id="3459478">OpNoWordBoundary</span><span class="op" id="3459494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459501">t</span>&nbsp;<span class="op" id="3459503">=</span>&nbsp;<span class="ident" id="3459505">t</span><span class="op" id="3459506">[</span><span class="num" id="3459507">2</span><span class="op" id="3459508">:</span><span class="op" id="3459509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459516">break</span>&nbsp;<span class="ident" id="3459522">BigSwitch</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459536">case</span>&nbsp;<span class="string" id="3459541">&#39;C&#39;</span><span class="op" id="3459544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3459551">//&nbsp;any&nbsp;byte;&nbsp;not&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459583">return</span>&nbsp;<span class="ident" id="3459590">nil</span><span class="op" id="3459593">,</span>&nbsp;<span class="op" id="3459595">&amp;</span><span class="ident" id="3459596">Error</span><span class="op" id="3459601">{</span><span class="ident" id="3459602">ErrInvalidEscape</span><span class="op" id="3459618">,</span>&nbsp;<span class="ident" id="3459620">t</span><span class="op" id="3459621">[</span><span class="op" id="3459622">:</span><span class="num" id="3459623">2</span><span class="op" id="3459624">]</span><span class="op" id="3459625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459631">case</span>&nbsp;<span class="string" id="3459636">&#39;Q&#39;</span><span class="op" id="3459639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3459646">//&nbsp;\Q&nbsp;...&nbsp;\E:&nbsp;the&nbsp;...&nbsp;is&nbsp;always&nbsp;literals</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459692">var</span>&nbsp;<span class="ident" id="3459696">lit</span>&nbsp;<span class="builtintype" id="3459700">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459712">if</span>&nbsp;<span class="ident" id="3459715">i</span>&nbsp;<span class="op" id="3459717">:=</span>&nbsp;<span class="ident" id="3459720">strings</span><span class="op" id="3459727">.</span><span class="ident" id="3459728">Index</span><span class="op" id="3459733">(</span><span class="ident" id="3459734">t</span><span class="op" id="3459735">,</span>&nbsp;<span class="string" id="3459737">`\E`</span><span class="op" id="3459741">)</span><span class="op" id="3459742">;</span>&nbsp;<span class="ident" id="3459744">i</span>&nbsp;<span class="op" id="3459746">&lt;</span>&nbsp;<span class="num" id="3459748">0</span>&nbsp;<span class="op" id="3459750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459758">lit</span>&nbsp;<span class="op" id="3459762">=</span>&nbsp;<span class="ident" id="3459764">t</span><span class="op" id="3459765">[</span><span class="num" id="3459766">2</span><span class="op" id="3459767">:</span><span class="op" id="3459768">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459776">t</span>&nbsp;<span class="op" id="3459778">=</span>&nbsp;<span class="string" id="3459780">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459788">}</span>&nbsp;<span class="keyword" id="3459790">else</span>&nbsp;<span class="op" id="3459795">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459803">lit</span>&nbsp;<span class="op" id="3459807">=</span>&nbsp;<span class="ident" id="3459809">t</span><span class="op" id="3459810">[</span><span class="num" id="3459811">2</span><span class="op" id="3459812">:</span><span class="ident" id="3459813">i</span><span class="op" id="3459814">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459822">t</span>&nbsp;<span class="op" id="3459824">=</span>&nbsp;<span class="ident" id="3459826">t</span><span class="op" id="3459827">[</span><span class="ident" id="3459828">i</span><span class="op" id="3459829">+</span><span class="num" id="3459830">2</span><span class="op" id="3459831">:</span><span class="op" id="3459832">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459846">p</span><span class="op" id="3459847">.</span><span class="ident" id="3459848">push</span><span class="op" id="3459852">(</span><span class="ident" id="3459853">literalRegexp</span><span class="op" id="3459866">(</span><span class="ident" id="3459867">lit</span><span class="op" id="3459870">,</span>&nbsp;<span class="ident" id="3459872">p</span><span class="op" id="3459873">.</span><span class="ident" id="3459874">flags</span><span class="op" id="3459879">)</span><span class="op" id="3459880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459887">break</span>&nbsp;<span class="ident" id="3459893">BigSwitch</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459907">case</span>&nbsp;<span class="string" id="3459912">&#39;z&#39;</span><span class="op" id="3459915">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459922">p</span><span class="op" id="3459923">.</span><span class="ident" id="3459924">op</span><span class="op" id="3459926">(</span><span class="ident" id="3459927">OpEndText</span><span class="op" id="3459936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459943">t</span>&nbsp;<span class="op" id="3459945">=</span>&nbsp;<span class="ident" id="3459947">t</span><span class="op" id="3459948">[</span><span class="num" id="3459949">2</span><span class="op" id="3459950">:</span><span class="op" id="3459951">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459958">break</span>&nbsp;<span class="ident" id="3459964">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459978">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459989">re</span>&nbsp;<span class="op" id="3459992">:=</span>&nbsp;<span class="ident" id="3459995">p</span><span class="op" id="3459996">.</span><span class="ident" id="3459997">newRegexp</span><span class="op" id="3460006">(</span><span class="ident" id="3460007">OpCharClass</span><span class="op" id="3460018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460023">re</span><span class="op" id="3460025">.</span><span class="ident" id="3460026">Flags</span>&nbsp;<span class="op" id="3460032">=</span>&nbsp;<span class="ident" id="3460034">p</span><span class="op" id="3460035">.</span><span class="ident" id="3460036">flags</span><br>
<span class="lineno"></span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3460046">//&nbsp;Look&nbsp;for&nbsp;Unicode&nbsp;character&nbsp;group&nbsp;like&nbsp;\p{Han}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460098">if</span>&nbsp;<span class="builtinfunc" id="3460101">len</span><span class="op" id="3460104">(</span><span class="ident" id="3460105">t</span><span class="op" id="3460106">)</span>&nbsp;<span class="op" id="3460108">&gt;=</span>&nbsp;<span class="num" id="3460111">2</span>&nbsp;<span class="op" id="3460113">&amp;&amp;</span>&nbsp;<span class="op" id="3460116">(</span><span class="ident" id="3460117">t</span><span class="op" id="3460118">[</span><span class="num" id="3460119">1</span><span class="op" id="3460120">]</span>&nbsp;<span class="op" id="3460122">==</span>&nbsp;<span class="string" id="3460125">&#39;p&#39;</span>&nbsp;<span class="op" id="3460129">||</span>&nbsp;<span class="ident" id="3460132">t</span><span class="op" id="3460133">[</span><span class="num" id="3460134">1</span><span class="op" id="3460135">]</span>&nbsp;<span class="op" id="3460137">==</span>&nbsp;<span class="string" id="3460140">&#39;P&#39;</span><span class="op" id="3460143">)</span>&nbsp;<span class="op" id="3460145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460151">r</span><span class="op" id="3460152">,</span>&nbsp;<span class="ident" id="3460154">rest</span><span class="op" id="3460158">,</span>&nbsp;<span class="ident" id="3460160">err</span>&nbsp;<span class="op" id="3460164">:=</span>&nbsp;<span class="ident" id="3460167">p</span><span class="op" id="3460168">.</span><span class="ident" id="3460169">parseUnicodeClass</span><span class="op" id="3460186">(</span><span class="ident" id="3460187">t</span><span class="op" id="3460188">,</span>&nbsp;<span class="ident" id="3460190">re</span><span class="op" id="3460192">.</span><span class="ident" id="3460193">Rune0</span><span class="op" id="3460198">[</span><span class="op" id="3460199">:</span><span class="num" id="3460200">0</span><span class="op" id="3460201">]</span><span class="op" id="3460202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460208">if</span>&nbsp;<span class="ident" id="3460211">err</span>&nbsp;<span class="op" id="3460215">!=</span>&nbsp;<span class="ident" id="3460218">nil</span>&nbsp;<span class="op" id="3460222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460229">return</span>&nbsp;<span class="ident" id="3460236">nil</span><span class="op" id="3460239">,</span>&nbsp;<span class="ident" id="3460241">err</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460255">if</span>&nbsp;<span class="ident" id="3460258">r</span>&nbsp;<span class="op" id="3460260">!=</span>&nbsp;<span class="ident" id="3460263">nil</span>&nbsp;<span class="op" id="3460267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460274">re</span><span class="op" id="3460276">.</span><span class="ident" id="3460277">Rune</span>&nbsp;<span class="op" id="3460282">=</span>&nbsp;<span class="ident" id="3460284">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460291">t</span>&nbsp;<span class="op" id="3460293">=</span>&nbsp;<span class="ident" id="3460295">rest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460305">p</span><span class="op" id="3460306">.</span><span class="ident" id="3460307">push</span><span class="op" id="3460311">(</span><span class="ident" id="3460312">re</span><span class="op" id="3460314">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460321">break</span>&nbsp;<span class="ident" id="3460327">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3460352">//&nbsp;Perl&nbsp;character&nbsp;class&nbsp;escape.</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460387">if</span>&nbsp;<span class="ident" id="3460390">r</span><span class="op" id="3460391">,</span>&nbsp;<span class="ident" id="3460393">rest</span>&nbsp;<span class="op" id="3460398">:=</span>&nbsp;<span class="ident" id="3460401">p</span><span class="op" id="3460402">.</span><span class="ident" id="3460403">parsePerlClassEscape</span><span class="op" id="3460423">(</span><span class="ident" id="3460424">t</span><span class="op" id="3460425">,</span>&nbsp;<span class="ident" id="3460427">re</span><span class="op" id="3460429">.</span><span class="ident" id="3460430">Rune0</span><span class="op" id="3460435">[</span><span class="op" id="3460436">:</span><span class="num" id="3460437">0</span><span class="op" id="3460438">]</span><span class="op" id="3460439">)</span><span class="op" id="3460440">;</span>&nbsp;<span class="ident" id="3460442">r</span>&nbsp;<span class="op" id="3460444">!=</span>&nbsp;<span class="ident" id="3460447">nil</span>&nbsp;<span class="op" id="3460451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460457">re</span><span class="op" id="3460459">.</span><span class="ident" id="3460460">Rune</span>&nbsp;<span class="op" id="3460465">=</span>&nbsp;<span class="ident" id="3460467">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460473">t</span>&nbsp;<span class="op" id="3460475">=</span>&nbsp;<span class="ident" id="3460477">rest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460486">p</span><span class="op" id="3460487">.</span><span class="ident" id="3460488">push</span><span class="op" id="3460492">(</span><span class="ident" id="3460493">re</span><span class="op" id="3460495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460501">break</span>&nbsp;<span class="ident" id="3460507">BigSwitch</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460525">p</span><span class="op" id="3460526">.</span><span class="ident" id="3460527">reuse</span><span class="op" id="3460532">(</span><span class="ident" id="3460533">re</span><span class="op" id="3460535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3460541">//&nbsp;Ordinary&nbsp;single-character&nbsp;escape.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460581">if</span>&nbsp;<span class="ident" id="3460584">c</span><span class="op" id="3460585">,</span>&nbsp;<span class="ident" id="3460587">t</span><span class="op" id="3460588">,</span>&nbsp;<span class="ident" id="3460590">err</span>&nbsp;<span class="op" id="3460594">=</span>&nbsp;<span class="ident" id="3460596">p</span><span class="op" id="3460597">.</span><span class="ident" id="3460598">parseEscape</span><span class="op" id="3460609">(</span><span class="ident" id="3460610">t</span><span class="op" id="3460611">)</span><span class="op" id="3460612">;</span>&nbsp;<span class="ident" id="3460614">err</span>&nbsp;<span class="op" id="3460618">!=</span>&nbsp;<span class="ident" id="3460621">nil</span>&nbsp;<span class="op" id="3460625">{</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460631">return</span>&nbsp;<span class="ident" id="3460638">nil</span><span class="op" id="3460641">,</span>&nbsp;<span class="ident" id="3460643">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460655">p</span><span class="op" id="3460656">.</span><span class="ident" id="3460657">literal</span><span class="op" id="3460664">(</span><span class="ident" id="3460665">c</span><span class="op" id="3460666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460674">lastRepeat</span>&nbsp;<span class="op" id="3460685">=</span>&nbsp;<span class="ident" id="3460687">repeat</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460699">p</span><span class="op" id="3460700">.</span><span class="ident" id="3460701">concat</span><span class="op" id="3460707">(</span><span class="op" id="3460708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460711">if</span>&nbsp;<span class="ident" id="3460714">p</span><span class="op" id="3460715">.</span><span class="ident" id="3460716">swapVerticalBar</span><span class="op" id="3460731">(</span><span class="op" id="3460732">)</span>&nbsp;<span class="op" id="3460734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3460738">//&nbsp;pop&nbsp;vertical&nbsp;bar</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460760">p</span><span class="op" id="3460761">.</span><span class="ident" id="3460762">stack</span>&nbsp;<span class="op" id="3460768">=</span>&nbsp;<span class="ident" id="3460770">p</span><span class="op" id="3460771">.</span><span class="ident" id="3460772">stack</span><span class="op" id="3460777">[</span><span class="op" id="3460778">:</span><span class="builtinfunc" id="3460779">len</span><span class="op" id="3460782">(</span><span class="ident" id="3460783">p</span><span class="op" id="3460784">.</span><span class="ident" id="3460785">stack</span><span class="op" id="3460790">)</span><span class="op" id="3460791">-</span><span class="num" id="3460792">1</span><span class="op" id="3460793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460799">p</span><span class="op" id="3460800">.</span><span class="ident" id="3460801">alternate</span><span class="op" id="3460810">(</span><span class="op" id="3460811">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460815">n</span>&nbsp;<span class="op" id="3460817">:=</span>&nbsp;<span class="builtinfunc" id="3460820">len</span><span class="op" id="3460823">(</span><span class="ident" id="3460824">p</span><span class="op" id="3460825">.</span><span class="ident" id="3460826">stack</span><span class="op" id="3460831">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460834">if</span>&nbsp;<span class="ident" id="3460837">n</span>&nbsp;<span class="op" id="3460839">!=</span>&nbsp;<span class="num" id="3460842">1</span>&nbsp;<span class="op" id="3460844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460848">return</span>&nbsp;<span class="ident" id="3460855">nil</span><span class="op" id="3460858">,</span>&nbsp;<span class="op" id="3460860">&amp;</span><span class="ident" id="3460861">Error</span><span class="op" id="3460866">{</span><span class="ident" id="3460867">ErrMissingParen</span><span class="op" id="3460882">,</span>&nbsp;<span class="ident" id="3460884">s</span><span class="op" id="3460885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460891">return</span>&nbsp;<span class="ident" id="3460898">p</span><span class="op" id="3460899">.</span><span class="ident" id="3460900">stack</span><span class="op" id="3460905">[</span><span class="num" id="3460906">0</span><span class="op" id="3460907">]</span><span class="op" id="3460908">,</span>&nbsp;<span class="ident" id="3460910">nil</span><br>
<span class="lineno"></span><span class="op" id="3460914">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span><span class="comment" id="3460917">//&nbsp;parseRepeat&nbsp;parses&nbsp;{min}&nbsp;(max=min)&nbsp;or&nbsp;{min,}&nbsp;(max=-1)&nbsp;or&nbsp;{min,max}.</span><br>
<span class="lineno"></span><span class="comment" id="3460988">//&nbsp;If&nbsp;s&nbsp;is&nbsp;not&nbsp;of&nbsp;that&nbsp;form,&nbsp;it&nbsp;returns&nbsp;ok&nbsp;==&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="3461041">//&nbsp;If&nbsp;s&nbsp;has&nbsp;the&nbsp;right&nbsp;form&nbsp;but&nbsp;the&nbsp;values&nbsp;are&nbsp;too&nbsp;big,&nbsp;it&nbsp;returns&nbsp;min&nbsp;==&nbsp;-1,&nbsp;ok&nbsp;==&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="3461130">func</span>&nbsp;<span class="op" id="3461135">(</span><span class="ident" id="3461136">p</span>&nbsp;<span class="op" id="3461138">*</span><span class="ident" id="3461139">parser</span><span class="op" id="3461145">)</span>&nbsp;<span class="ident" id="3461147">parseRepeat</span><span class="op" id="3461158">(</span><span class="ident" id="3461159">s</span>&nbsp;<span class="builtintype" id="3461161">string</span><span class="op" id="3461167">)</span>&nbsp;<span class="op" id="3461169">(</span><span class="ident" id="3461170">min</span><span class="op" id="3461173">,</span>&nbsp;<span class="ident" id="3461175">max</span>&nbsp;<span class="builtintype" id="3461179">int</span><span class="op" id="3461182">,</span>&nbsp;<span class="ident" id="3461184">rest</span>&nbsp;<span class="builtintype" id="3461189">string</span><span class="op" id="3461195">,</span>&nbsp;<span class="ident" id="3461197">ok</span>&nbsp;<span class="builtintype" id="3461200">bool</span><span class="op" id="3461204">)</span>&nbsp;<span class="op" id="3461206">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461209">if</span>&nbsp;<span class="ident" id="3461212">s</span>&nbsp;<span class="op" id="3461214">==</span>&nbsp;<span class="string" id="3461217">&#34;&#34;</span>&nbsp;<span class="op" id="3461220">||</span>&nbsp;<span class="ident" id="3461223">s</span><span class="op" id="3461224">[</span><span class="num" id="3461225">0</span><span class="op" id="3461226">]</span>&nbsp;<span class="op" id="3461228">!=</span>&nbsp;<span class="string" id="3461231">&#39;{&#39;</span>&nbsp;<span class="op" id="3461235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461239">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461250">s</span>&nbsp;<span class="op" id="3461252">=</span>&nbsp;<span class="ident" id="3461254">s</span><span class="op" id="3461255">[</span><span class="num" id="3461256">1</span><span class="op" id="3461257">:</span><span class="op" id="3461258">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461261">var</span>&nbsp;<span class="ident" id="3461265">ok1</span>&nbsp;<span class="builtintype" id="3461269">bool</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461275">if</span>&nbsp;<span class="ident" id="3461278">min</span><span class="op" id="3461281">,</span>&nbsp;<span class="ident" id="3461283">s</span><span class="op" id="3461284">,</span>&nbsp;<span class="ident" id="3461286">ok1</span>&nbsp;<span class="op" id="3461290">=</span>&nbsp;<span class="ident" id="3461292">p</span><span class="op" id="3461293">.</span><span class="ident" id="3461294">parseInt</span><span class="op" id="3461302">(</span><span class="ident" id="3461303">s</span><span class="op" id="3461304">)</span><span class="op" id="3461305">;</span>&nbsp;<span class="op" id="3461307">!</span><span class="ident" id="3461308">ok1</span>&nbsp;<span class="op" id="3461312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461316">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461327">if</span>&nbsp;<span class="ident" id="3461330">s</span>&nbsp;<span class="op" id="3461332">==</span>&nbsp;<span class="string" id="3461335">&#34;&#34;</span>&nbsp;<span class="op" id="3461338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461342">return</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461353">if</span>&nbsp;<span class="ident" id="3461356">s</span><span class="op" id="3461357">[</span><span class="num" id="3461358">0</span><span class="op" id="3461359">]</span>&nbsp;<span class="op" id="3461361">!=</span>&nbsp;<span class="string" id="3461364">&#39;,&#39;</span>&nbsp;<span class="op" id="3461368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461372">max</span>&nbsp;<span class="op" id="3461376">=</span>&nbsp;<span class="ident" id="3461378">min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461383">}</span>&nbsp;<span class="keyword" id="3461385">else</span>&nbsp;<span class="op" id="3461390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461394">s</span>&nbsp;<span class="op" id="3461396">=</span>&nbsp;<span class="ident" id="3461398">s</span><span class="op" id="3461399">[</span><span class="num" id="3461400">1</span><span class="op" id="3461401">:</span><span class="op" id="3461402">]</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461406">if</span>&nbsp;<span class="ident" id="3461409">s</span>&nbsp;<span class="op" id="3461411">==</span>&nbsp;<span class="string" id="3461414">&#34;&#34;</span>&nbsp;<span class="op" id="3461417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461422">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461435">if</span>&nbsp;<span class="ident" id="3461438">s</span><span class="op" id="3461439">[</span><span class="num" id="3461440">0</span><span class="op" id="3461441">]</span>&nbsp;<span class="op" id="3461443">==</span>&nbsp;<span class="string" id="3461446">&#39;}&#39;</span>&nbsp;<span class="op" id="3461450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461455">max</span>&nbsp;<span class="op" id="3461459">=</span>&nbsp;<span class="op" id="3461461">-</span><span class="num" id="3461462">1</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461466">}</span>&nbsp;<span class="keyword" id="3461468">else</span>&nbsp;<span class="keyword" id="3461473">if</span>&nbsp;<span class="ident" id="3461476">max</span><span class="op" id="3461479">,</span>&nbsp;<span class="ident" id="3461481">s</span><span class="op" id="3461482">,</span>&nbsp;<span class="ident" id="3461484">ok1</span>&nbsp;<span class="op" id="3461488">=</span>&nbsp;<span class="ident" id="3461490">p</span><span class="op" id="3461491">.</span><span class="ident" id="3461492">parseInt</span><span class="op" id="3461500">(</span><span class="ident" id="3461501">s</span><span class="op" id="3461502">)</span><span class="op" id="3461503">;</span>&nbsp;<span class="op" id="3461505">!</span><span class="ident" id="3461506">ok1</span>&nbsp;<span class="op" id="3461510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461515">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461524">}</span>&nbsp;<span class="keyword" id="3461526">else</span>&nbsp;<span class="keyword" id="3461531">if</span>&nbsp;<span class="ident" id="3461534">max</span>&nbsp;<span class="op" id="3461538">&lt;</span>&nbsp;<span class="num" id="3461540">0</span>&nbsp;<span class="op" id="3461542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3461547">//&nbsp;parseInt&nbsp;found&nbsp;too&nbsp;big&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461585">min</span>&nbsp;<span class="op" id="3461589">=</span>&nbsp;<span class="op" id="3461591">-</span><span class="num" id="3461592">1</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461602">if</span>&nbsp;<span class="ident" id="3461605">s</span>&nbsp;<span class="op" id="3461607">==</span>&nbsp;<span class="string" id="3461610">&#34;&#34;</span>&nbsp;<span class="op" id="3461613">||</span>&nbsp;<span class="ident" id="3461616">s</span><span class="op" id="3461617">[</span><span class="num" id="3461618">0</span><span class="op" id="3461619">]</span>&nbsp;<span class="op" id="3461621">!=</span>&nbsp;<span class="string" id="3461624">&#39;}&#39;</span>&nbsp;<span class="op" id="3461628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461632">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461640">}</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461643">rest</span>&nbsp;<span class="op" id="3461648">=</span>&nbsp;<span class="ident" id="3461650">s</span><span class="op" id="3461651">[</span><span class="num" id="3461652">1</span><span class="op" id="3461653">:</span><span class="op" id="3461654">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461657">ok</span>&nbsp;<span class="op" id="3461660">=</span>&nbsp;<span class="builtintype" id="3461662">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461668">return</span><br>
<span class="lineno"></span><span class="op" id="3461675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">930</span><span class="comment" id="3461678">//&nbsp;parsePerlFlags&nbsp;parses&nbsp;a&nbsp;Perl&nbsp;flag&nbsp;setting&nbsp;or&nbsp;non-capturing&nbsp;group&nbsp;or&nbsp;both,</span><br>
<span class="lineno"></span><span class="comment" id="3461755">//&nbsp;like&nbsp;(?i)&nbsp;or&nbsp;(?:&nbsp;or&nbsp;(?i:.&nbsp;&nbsp;It&nbsp;removes&nbsp;the&nbsp;prefix&nbsp;from&nbsp;s&nbsp;and&nbsp;updates&nbsp;the&nbsp;parse&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3461843">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;ensured&nbsp;that&nbsp;s&nbsp;begins&nbsp;with&nbsp;&#34;(?&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3461900">func</span>&nbsp;<span class="op" id="3461905">(</span><span class="ident" id="3461906">p</span>&nbsp;<span class="op" id="3461908">*</span><span class="ident" id="3461909">parser</span><span class="op" id="3461915">)</span>&nbsp;<span class="ident" id="3461917">parsePerlFlags</span><span class="op" id="3461931">(</span><span class="ident" id="3461932">s</span>&nbsp;<span class="builtintype" id="3461934">string</span><span class="op" id="3461940">)</span>&nbsp;<span class="op" id="3461942">(</span><span class="ident" id="3461943">rest</span>&nbsp;<span class="builtintype" id="3461948">string</span><span class="op" id="3461954">,</span>&nbsp;<span class="ident" id="3461956">err</span>&nbsp;<span class="builtintype" id="3461960">error</span><span class="op" id="3461965">)</span>&nbsp;<span class="op" id="3461967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461970">t</span>&nbsp;<span class="op" id="3461972">:=</span>&nbsp;<span class="ident" id="3461975">s</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3461979">//&nbsp;Check&nbsp;for&nbsp;named&nbsp;captures,&nbsp;first&nbsp;introduced&nbsp;in&nbsp;Python&#39;s&nbsp;regexp&nbsp;library.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462054">//&nbsp;As&nbsp;usual,&nbsp;there&nbsp;are&nbsp;three&nbsp;slightly&nbsp;different&nbsp;syntaxes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462113">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462117">//&nbsp;&nbsp;&nbsp;(?P&lt;name&gt;expr)&nbsp;&nbsp;&nbsp;the&nbsp;original,&nbsp;introduced&nbsp;by&nbsp;Python</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462175">//&nbsp;&nbsp;&nbsp;(?&lt;name&gt;expr)&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;.NET&nbsp;alteration,&nbsp;adopted&nbsp;by&nbsp;Perl&nbsp;5.10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462240">//&nbsp;&nbsp;&nbsp;(?&#39;name&#39;expr)&nbsp;&nbsp;&nbsp;&nbsp;another&nbsp;.NET&nbsp;alteration,&nbsp;adopted&nbsp;by&nbsp;Perl&nbsp;5.10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462309">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462313">//&nbsp;Perl&nbsp;5.10&nbsp;gave&nbsp;in&nbsp;and&nbsp;implemented&nbsp;the&nbsp;Python&nbsp;version&nbsp;too,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462375">//&nbsp;but&nbsp;they&nbsp;claim&nbsp;that&nbsp;the&nbsp;last&nbsp;two&nbsp;are&nbsp;the&nbsp;preferred&nbsp;forms.</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462437">//&nbsp;PCRE&nbsp;and&nbsp;languages&nbsp;based&nbsp;on&nbsp;it&nbsp;(specifically,&nbsp;PHP&nbsp;and&nbsp;Ruby)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462501">//&nbsp;support&nbsp;all&nbsp;three&nbsp;as&nbsp;well.&nbsp;&nbsp;EcmaScript&nbsp;4&nbsp;uses&nbsp;only&nbsp;the&nbsp;Python&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462573">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462577">//&nbsp;In&nbsp;both&nbsp;the&nbsp;open&nbsp;source&nbsp;world&nbsp;(via&nbsp;Code&nbsp;Search)&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462637">//&nbsp;Google&nbsp;source&nbsp;tree,&nbsp;(?P&lt;expr&gt;name)&nbsp;is&nbsp;the&nbsp;dominant&nbsp;form,</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462698">//&nbsp;so&nbsp;that&#39;s&nbsp;the&nbsp;one&nbsp;we&nbsp;implement.&nbsp;&nbsp;One&nbsp;is&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462750">if</span>&nbsp;<span class="builtinfunc" id="3462753">len</span><span class="op" id="3462756">(</span><span class="ident" id="3462757">t</span><span class="op" id="3462758">)</span>&nbsp;<span class="op" id="3462760">&gt;</span>&nbsp;<span class="num" id="3462762">4</span>&nbsp;<span class="op" id="3462764">&amp;&amp;</span>&nbsp;<span class="ident" id="3462767">t</span><span class="op" id="3462768">[</span><span class="num" id="3462769">2</span><span class="op" id="3462770">]</span>&nbsp;<span class="op" id="3462772">==</span>&nbsp;<span class="string" id="3462775">&#39;P&#39;</span>&nbsp;<span class="op" id="3462779">&amp;&amp;</span>&nbsp;<span class="ident" id="3462782">t</span><span class="op" id="3462783">[</span><span class="num" id="3462784">3</span><span class="op" id="3462785">]</span>&nbsp;<span class="op" id="3462787">==</span>&nbsp;<span class="string" id="3462790">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3462794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3462798">//&nbsp;Pull&nbsp;out&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3462818">end</span>&nbsp;<span class="op" id="3462822">:=</span>&nbsp;<span class="ident" id="3462825">strings</span><span class="op" id="3462832">.</span><span class="ident" id="3462833">IndexRune</span><span class="op" id="3462842">(</span><span class="ident" id="3462843">t</span><span class="op" id="3462844">,</span>&nbsp;<span class="string" id="3462846">&#39;&gt;&#39;</span><span class="op" id="3462849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462853">if</span>&nbsp;<span class="ident" id="3462856">end</span>&nbsp;<span class="op" id="3462860">&lt;</span>&nbsp;<span class="num" id="3462862">0</span>&nbsp;<span class="op" id="3462864">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462869">if</span>&nbsp;<span class="ident" id="3462872">err</span>&nbsp;<span class="op" id="3462876">=</span>&nbsp;<span class="ident" id="3462878">checkUTF8</span><span class="op" id="3462887">(</span><span class="ident" id="3462888">t</span><span class="op" id="3462889">)</span><span class="op" id="3462890">;</span>&nbsp;<span class="ident" id="3462892">err</span>&nbsp;<span class="op" id="3462896">!=</span>&nbsp;<span class="ident" id="3462899">nil</span>&nbsp;<span class="op" id="3462903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462909">return</span>&nbsp;<span class="string" id="3462916">&#34;&#34;</span><span class="op" id="3462918">,</span>&nbsp;<span class="ident" id="3462920">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3462927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462932">return</span>&nbsp;<span class="string" id="3462939">&#34;&#34;</span><span class="op" id="3462941">,</span>&nbsp;<span class="op" id="3462943">&amp;</span><span class="ident" id="3462944">Error</span><span class="op" id="3462949">{</span><span class="ident" id="3462950">ErrInvalidNamedCapture</span><span class="op" id="3462972">,</span>&nbsp;<span class="ident" id="3462974">s</span><span class="op" id="3462975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3462979">}</span><br>
<span class="lineno">960</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3462984">capture</span>&nbsp;<span class="op" id="3462992">:=</span>&nbsp;<span class="ident" id="3462995">t</span><span class="op" id="3462996">[</span><span class="op" id="3462997">:</span><span class="ident" id="3462998">end</span><span class="op" id="3463001">+</span><span class="num" id="3463002">1</span><span class="op" id="3463003">]</span>&nbsp;<span class="comment" id="3463005">//&nbsp;&#34;(?P&lt;name&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463022">name</span>&nbsp;<span class="op" id="3463027">:=</span>&nbsp;<span class="ident" id="3463030">t</span><span class="op" id="3463031">[</span><span class="num" id="3463032">4</span><span class="op" id="3463033">:</span><span class="ident" id="3463034">end</span><span class="op" id="3463037">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3463043">//&nbsp;&#34;name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463055">if</span>&nbsp;<span class="ident" id="3463058">err</span>&nbsp;<span class="op" id="3463062">=</span>&nbsp;<span class="ident" id="3463064">checkUTF8</span><span class="op" id="3463073">(</span><span class="ident" id="3463074">name</span><span class="op" id="3463078">)</span><span class="op" id="3463079">;</span>&nbsp;<span class="ident" id="3463081">err</span>&nbsp;<span class="op" id="3463085">!=</span>&nbsp;<span class="ident" id="3463088">nil</span>&nbsp;<span class="op" id="3463092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463097">return</span>&nbsp;<span class="string" id="3463104">&#34;&#34;</span><span class="op" id="3463106">,</span>&nbsp;<span class="ident" id="3463108">err</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463118">if</span>&nbsp;<span class="op" id="3463121">!</span><span class="ident" id="3463122">isValidCaptureName</span><span class="op" id="3463140">(</span><span class="ident" id="3463141">name</span><span class="op" id="3463145">)</span>&nbsp;<span class="op" id="3463147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463152">return</span>&nbsp;<span class="string" id="3463159">&#34;&#34;</span><span class="op" id="3463161">,</span>&nbsp;<span class="op" id="3463163">&amp;</span><span class="ident" id="3463164">Error</span><span class="op" id="3463169">{</span><span class="ident" id="3463170">ErrInvalidNamedCapture</span><span class="op" id="3463192">,</span>&nbsp;<span class="ident" id="3463194">capture</span><span class="op" id="3463201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463210">//&nbsp;Like&nbsp;ordinary&nbsp;capture,&nbsp;but&nbsp;named.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463249">p</span><span class="op" id="3463250">.</span><span class="ident" id="3463251">numCap</span><span class="op" id="3463257">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463262">re</span>&nbsp;<span class="op" id="3463265">:=</span>&nbsp;<span class="ident" id="3463268">p</span><span class="op" id="3463269">.</span><span class="ident" id="3463270">op</span><span class="op" id="3463272">(</span><span class="ident" id="3463273">opLeftParen</span><span class="op" id="3463284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463288">re</span><span class="op" id="3463290">.</span><span class="ident" id="3463291">Cap</span>&nbsp;<span class="op" id="3463295">=</span>&nbsp;<span class="ident" id="3463297">p</span><span class="op" id="3463298">.</span><span class="ident" id="3463299">numCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463308">re</span><span class="op" id="3463310">.</span><span class="ident" id="3463311">Name</span>&nbsp;<span class="op" id="3463316">=</span>&nbsp;<span class="ident" id="3463318">name</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463325">return</span>&nbsp;<span class="ident" id="3463332">t</span><span class="op" id="3463333">[</span><span class="ident" id="3463334">end</span><span class="op" id="3463337">+</span><span class="num" id="3463338">1</span><span class="op" id="3463339">:</span><span class="op" id="3463340">]</span><span class="op" id="3463341">,</span>&nbsp;<span class="ident" id="3463343">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463352">//&nbsp;Non-capturing&nbsp;group.&nbsp;&nbsp;Might&nbsp;also&nbsp;twiddle&nbsp;Perl&nbsp;flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463409">var</span>&nbsp;<span class="ident" id="3463413">c</span>&nbsp;<span class="builtintype" id="3463415">rune</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463421">t</span>&nbsp;<span class="op" id="3463423">=</span>&nbsp;<span class="ident" id="3463425">t</span><span class="op" id="3463426">[</span><span class="num" id="3463427">2</span><span class="op" id="3463428">:</span><span class="op" id="3463429">]</span>&nbsp;<span class="comment" id="3463431">//&nbsp;skip&nbsp;(?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463443">flags</span>&nbsp;<span class="op" id="3463449">:=</span>&nbsp;<span class="ident" id="3463452">p</span><span class="op" id="3463453">.</span><span class="ident" id="3463454">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463461">sign</span>&nbsp;<span class="op" id="3463466">:=</span>&nbsp;<span class="op" id="3463469">+</span><span class="num" id="3463470">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463473">sawFlag</span>&nbsp;<span class="op" id="3463481">:=</span>&nbsp;<span class="builtintype" id="3463484">false</span><br>
<span class="lineno"></span><span class="ident" id="3463490">Loop</span><span class="op" id="3463494">:</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463497">for</span>&nbsp;<span class="ident" id="3463501">t</span>&nbsp;<span class="op" id="3463503">!=</span>&nbsp;<span class="string" id="3463506">&#34;&#34;</span>&nbsp;<span class="op" id="3463509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463513">if</span>&nbsp;<span class="ident" id="3463516">c</span><span class="op" id="3463517">,</span>&nbsp;<span class="ident" id="3463519">t</span><span class="op" id="3463520">,</span>&nbsp;<span class="ident" id="3463522">err</span>&nbsp;<span class="op" id="3463526">=</span>&nbsp;<span class="ident" id="3463528">nextRune</span><span class="op" id="3463536">(</span><span class="ident" id="3463537">t</span><span class="op" id="3463538">)</span><span class="op" id="3463539">;</span>&nbsp;<span class="ident" id="3463541">err</span>&nbsp;<span class="op" id="3463545">!=</span>&nbsp;<span class="ident" id="3463548">nil</span>&nbsp;<span class="op" id="3463552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463557">return</span>&nbsp;<span class="string" id="3463564">&#34;&#34;</span><span class="op" id="3463566">,</span>&nbsp;<span class="ident" id="3463568">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463578">switch</span>&nbsp;<span class="ident" id="3463585">c</span>&nbsp;<span class="op" id="3463587">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463591">default</span><span class="op" id="3463598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463603">break</span>&nbsp;<span class="ident" id="3463609">Loop</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463617">//&nbsp;Flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463629">case</span>&nbsp;<span class="string" id="3463634">&#39;i&#39;</span><span class="op" id="3463637">:</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463642">flags</span>&nbsp;<span class="op" id="3463648">|=</span>&nbsp;<span class="ident" id="3463651">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463663">sawFlag</span>&nbsp;<span class="op" id="3463671">=</span>&nbsp;<span class="builtintype" id="3463673">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463680">case</span>&nbsp;<span class="string" id="3463685">&#39;m&#39;</span><span class="op" id="3463688">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463693">flags</span>&nbsp;<span class="op" id="3463699">&amp;^=</span>&nbsp;<span class="ident" id="3463703">OneLine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463714">sawFlag</span>&nbsp;<span class="op" id="3463722">=</span>&nbsp;<span class="builtintype" id="3463724">true</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463731">case</span>&nbsp;<span class="string" id="3463736">&#39;s&#39;</span><span class="op" id="3463739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463744">flags</span>&nbsp;<span class="op" id="3463750">|=</span>&nbsp;<span class="ident" id="3463753">DotNL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463762">sawFlag</span>&nbsp;<span class="op" id="3463770">=</span>&nbsp;<span class="builtintype" id="3463772">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463779">case</span>&nbsp;<span class="string" id="3463784">&#39;U&#39;</span><span class="op" id="3463787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463792">flags</span>&nbsp;<span class="op" id="3463798">|=</span>&nbsp;<span class="ident" id="3463801">NonGreedy</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463814">sawFlag</span>&nbsp;<span class="op" id="3463822">=</span>&nbsp;<span class="builtintype" id="3463824">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463832">//&nbsp;Switch&nbsp;to&nbsp;negation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463857">case</span>&nbsp;<span class="string" id="3463862">&#39;-&#39;</span><span class="op" id="3463865">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463870">if</span>&nbsp;<span class="ident" id="3463873">sign</span>&nbsp;<span class="op" id="3463878">&lt;</span>&nbsp;<span class="num" id="3463880">0</span>&nbsp;<span class="op" id="3463882">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463888">break</span>&nbsp;<span class="ident" id="3463894">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463907">sign</span>&nbsp;<span class="op" id="3463912">=</span>&nbsp;<span class="op" id="3463914">-</span><span class="num" id="3463915">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463920">//&nbsp;Invert&nbsp;flags&nbsp;so&nbsp;that&nbsp;|&nbsp;above&nbsp;turn&nbsp;into&nbsp;&amp;^&nbsp;and&nbsp;vice&nbsp;versa.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463984">//&nbsp;We&#39;ll&nbsp;invert&nbsp;flags&nbsp;again&nbsp;before&nbsp;using&nbsp;it&nbsp;below.</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464038">flags</span>&nbsp;<span class="op" id="3464044">=</span>&nbsp;<span class="op" id="3464046">^</span><span class="ident" id="3464047">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464056">sawFlag</span>&nbsp;<span class="op" id="3464064">=</span>&nbsp;<span class="builtintype" id="3464066">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464075">//&nbsp;End&nbsp;of&nbsp;flags,&nbsp;starting&nbsp;group&nbsp;or&nbsp;not.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464117">case</span>&nbsp;<span class="string" id="3464122">&#39;:&#39;</span><span class="op" id="3464125">,</span>&nbsp;<span class="string" id="3464127">&#39;)&#39;</span><span class="op" id="3464130">:</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464135">if</span>&nbsp;<span class="ident" id="3464138">sign</span>&nbsp;<span class="op" id="3464143">&lt;</span>&nbsp;<span class="num" id="3464145">0</span>&nbsp;<span class="op" id="3464147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464153">if</span>&nbsp;<span class="op" id="3464156">!</span><span class="ident" id="3464157">sawFlag</span>&nbsp;<span class="op" id="3464165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464172">break</span>&nbsp;<span class="ident" id="3464178">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464193">flags</span>&nbsp;<span class="op" id="3464199">=</span>&nbsp;<span class="op" id="3464201">^</span><span class="ident" id="3464202">flags</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464216">if</span>&nbsp;<span class="ident" id="3464219">c</span>&nbsp;<span class="op" id="3464221">==</span>&nbsp;<span class="string" id="3464224">&#39;:&#39;</span>&nbsp;<span class="op" id="3464228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464234">//&nbsp;Open&nbsp;new&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464256">p</span><span class="op" id="3464257">.</span><span class="ident" id="3464258">op</span><span class="op" id="3464260">(</span><span class="ident" id="3464261">opLeftParen</span><span class="op" id="3464272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464277">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464282">p</span><span class="op" id="3464283">.</span><span class="ident" id="3464284">flags</span>&nbsp;<span class="op" id="3464290">=</span>&nbsp;<span class="ident" id="3464292">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464301">return</span>&nbsp;<span class="ident" id="3464308">t</span><span class="op" id="3464309">,</span>&nbsp;<span class="ident" id="3464311">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464324">return</span>&nbsp;<span class="string" id="3464331">&#34;&#34;</span><span class="op" id="3464333">,</span>&nbsp;<span class="op" id="3464335">&amp;</span><span class="ident" id="3464336">Error</span><span class="op" id="3464341">{</span><span class="ident" id="3464342">ErrInvalidPerlOp</span><span class="op" id="3464358">,</span>&nbsp;<span class="ident" id="3464360">s</span><span class="op" id="3464361">[</span><span class="op" id="3464362">:</span><span class="builtinfunc" id="3464363">len</span><span class="op" id="3464366">(</span><span class="ident" id="3464367">s</span><span class="op" id="3464368">)</span><span class="op" id="3464369">-</span><span class="builtinfunc" id="3464370">len</span><span class="op" id="3464373">(</span><span class="ident" id="3464374">t</span><span class="op" id="3464375">)</span><span class="op" id="3464376">]</span><span class="op" id="3464377">}</span><br>
<span class="lineno"></span><span class="op" id="3464379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3464382">//&nbsp;isValidCaptureName&nbsp;reports&nbsp;whether&nbsp;name</span><br>
<span class="lineno"></span><span class="comment" id="3464425">//&nbsp;is&nbsp;a&nbsp;valid&nbsp;capture&nbsp;name:&nbsp;[A-Za-z0-9_]+.</span><br>
<span class="lineno">1040</span><span class="comment" id="3464468">//&nbsp;PCRE&nbsp;limits&nbsp;names&nbsp;to&nbsp;32&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="3464502">//&nbsp;Python&nbsp;rejects&nbsp;names&nbsp;starting&nbsp;with&nbsp;digits.</span><br>
<span class="lineno"></span><span class="comment" id="3464548">//&nbsp;We&nbsp;don&#39;t&nbsp;enforce&nbsp;either&nbsp;of&nbsp;those.</span><br>
<span class="lineno"></span><span class="keyword" id="3464585">func</span>&nbsp;<span class="ident" id="3464590">isValidCaptureName</span><span class="op" id="3464608">(</span><span class="ident" id="3464609">name</span>&nbsp;<span class="builtintype" id="3464614">string</span><span class="op" id="3464620">)</span>&nbsp;<span class="builtintype" id="3464622">bool</span>&nbsp;<span class="op" id="3464627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464630">if</span>&nbsp;<span class="ident" id="3464633">name</span>&nbsp;<span class="op" id="3464638">==</span>&nbsp;<span class="string" id="3464641">&#34;&#34;</span>&nbsp;<span class="op" id="3464644">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464648">return</span>&nbsp;<span class="builtintype" id="3464655">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464665">for</span>&nbsp;<span class="ident" id="3464669">_</span><span class="op" id="3464670">,</span>&nbsp;<span class="ident" id="3464672">c</span>&nbsp;<span class="op" id="3464674">:=</span>&nbsp;<span class="keyword" id="3464677">range</span>&nbsp;<span class="ident" id="3464683">name</span>&nbsp;<span class="op" id="3464688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464692">if</span>&nbsp;<span class="ident" id="3464695">c</span>&nbsp;<span class="op" id="3464697">!=</span>&nbsp;<span class="string" id="3464700">&#39;_&#39;</span>&nbsp;<span class="op" id="3464704">&amp;&amp;</span>&nbsp;<span class="op" id="3464707">!</span><span class="ident" id="3464708">isalnum</span><span class="op" id="3464715">(</span><span class="ident" id="3464716">c</span><span class="op" id="3464717">)</span>&nbsp;<span class="op" id="3464719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464724">return</span>&nbsp;<span class="builtintype" id="3464731">false</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464745">return</span>&nbsp;<span class="builtintype" id="3464752">true</span><br>
<span class="lineno"></span><span class="op" id="3464757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span><span class="comment" id="3464760">//&nbsp;parseInt&nbsp;parses&nbsp;a&nbsp;decimal&nbsp;integer.</span><br>
<span class="lineno"></span><span class="keyword" id="3464798">func</span>&nbsp;<span class="op" id="3464803">(</span><span class="ident" id="3464804">p</span>&nbsp;<span class="op" id="3464806">*</span><span class="ident" id="3464807">parser</span><span class="op" id="3464813">)</span>&nbsp;<span class="ident" id="3464815">parseInt</span><span class="op" id="3464823">(</span><span class="ident" id="3464824">s</span>&nbsp;<span class="builtintype" id="3464826">string</span><span class="op" id="3464832">)</span>&nbsp;<span class="op" id="3464834">(</span><span class="ident" id="3464835">n</span>&nbsp;<span class="builtintype" id="3464837">int</span><span class="op" id="3464840">,</span>&nbsp;<span class="ident" id="3464842">rest</span>&nbsp;<span class="builtintype" id="3464847">string</span><span class="op" id="3464853">,</span>&nbsp;<span class="ident" id="3464855">ok</span>&nbsp;<span class="builtintype" id="3464858">bool</span><span class="op" id="3464862">)</span>&nbsp;<span class="op" id="3464864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464867">if</span>&nbsp;<span class="ident" id="3464870">s</span>&nbsp;<span class="op" id="3464872">==</span>&nbsp;<span class="string" id="3464875">&#34;&#34;</span>&nbsp;<span class="op" id="3464878">||</span>&nbsp;<span class="ident" id="3464881">s</span><span class="op" id="3464882">[</span><span class="num" id="3464883">0</span><span class="op" id="3464884">]</span>&nbsp;<span class="op" id="3464886">&lt;</span>&nbsp;<span class="string" id="3464888">&#39;0&#39;</span>&nbsp;<span class="op" id="3464892">||</span>&nbsp;<span class="string" id="3464895">&#39;9&#39;</span>&nbsp;<span class="op" id="3464899">&lt;</span>&nbsp;<span class="ident" id="3464901">s</span><span class="op" id="3464902">[</span><span class="num" id="3464903">0</span><span class="op" id="3464904">]</span>&nbsp;<span class="op" id="3464906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464910">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464918">}</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464921">//&nbsp;Disallow&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464949">if</span>&nbsp;<span class="builtinfunc" id="3464952">len</span><span class="op" id="3464955">(</span><span class="ident" id="3464956">s</span><span class="op" id="3464957">)</span>&nbsp;<span class="op" id="3464959">&gt;=</span>&nbsp;<span class="num" id="3464962">2</span>&nbsp;<span class="op" id="3464964">&amp;&amp;</span>&nbsp;<span class="ident" id="3464967">s</span><span class="op" id="3464968">[</span><span class="num" id="3464969">0</span><span class="op" id="3464970">]</span>&nbsp;<span class="op" id="3464972">==</span>&nbsp;<span class="string" id="3464975">&#39;0&#39;</span>&nbsp;<span class="op" id="3464979">&amp;&amp;</span>&nbsp;<span class="string" id="3464982">&#39;0&#39;</span>&nbsp;<span class="op" id="3464986">&lt;=</span>&nbsp;<span class="ident" id="3464989">s</span><span class="op" id="3464990">[</span><span class="num" id="3464991">1</span><span class="op" id="3464992">]</span>&nbsp;<span class="op" id="3464994">&amp;&amp;</span>&nbsp;<span class="ident" id="3464997">s</span><span class="op" id="3464998">[</span><span class="num" id="3464999">1</span><span class="op" id="3465000">]</span>&nbsp;<span class="op" id="3465002">&lt;=</span>&nbsp;<span class="string" id="3465005">&#39;9&#39;</span>&nbsp;<span class="op" id="3465009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465013">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465024">t</span>&nbsp;<span class="op" id="3465026">:=</span>&nbsp;<span class="ident" id="3465029">s</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465032">for</span>&nbsp;<span class="ident" id="3465036">s</span>&nbsp;<span class="op" id="3465038">!=</span>&nbsp;<span class="string" id="3465041">&#34;&#34;</span>&nbsp;<span class="op" id="3465044">&amp;&amp;</span>&nbsp;<span class="string" id="3465047">&#39;0&#39;</span>&nbsp;<span class="op" id="3465051">&lt;=</span>&nbsp;<span class="ident" id="3465054">s</span><span class="op" id="3465055">[</span><span class="num" id="3465056">0</span><span class="op" id="3465057">]</span>&nbsp;<span class="op" id="3465059">&amp;&amp;</span>&nbsp;<span class="ident" id="3465062">s</span><span class="op" id="3465063">[</span><span class="num" id="3465064">0</span><span class="op" id="3465065">]</span>&nbsp;<span class="op" id="3465067">&lt;=</span>&nbsp;<span class="string" id="3465070">&#39;9&#39;</span>&nbsp;<span class="op" id="3465074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465078">s</span>&nbsp;<span class="op" id="3465080">=</span>&nbsp;<span class="ident" id="3465082">s</span><span class="op" id="3465083">[</span><span class="num" id="3465084">1</span><span class="op" id="3465085">:</span><span class="op" id="3465086">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465092">rest</span>&nbsp;<span class="op" id="3465097">=</span>&nbsp;<span class="ident" id="3465099">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465102">ok</span>&nbsp;<span class="op" id="3465105">=</span>&nbsp;<span class="builtintype" id="3465107">true</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3465113">//&nbsp;Have&nbsp;digits,&nbsp;compute&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465145">t</span>&nbsp;<span class="op" id="3465147">=</span>&nbsp;<span class="ident" id="3465149">t</span><span class="op" id="3465150">[</span><span class="op" id="3465151">:</span><span class="builtinfunc" id="3465152">len</span><span class="op" id="3465155">(</span><span class="ident" id="3465156">t</span><span class="op" id="3465157">)</span><span class="op" id="3465158">-</span><span class="builtinfunc" id="3465159">len</span><span class="op" id="3465162">(</span><span class="ident" id="3465163">s</span><span class="op" id="3465164">)</span><span class="op" id="3465165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465168">for</span>&nbsp;<span class="ident" id="3465172">i</span>&nbsp;<span class="op" id="3465174">:=</span>&nbsp;<span class="num" id="3465177">0</span><span class="op" id="3465178">;</span>&nbsp;<span class="ident" id="3465180">i</span>&nbsp;<span class="op" id="3465182">&lt;</span>&nbsp;<span class="builtinfunc" id="3465184">len</span><span class="op" id="3465187">(</span><span class="ident" id="3465188">t</span><span class="op" id="3465189">)</span><span class="op" id="3465190">;</span>&nbsp;<span class="ident" id="3465192">i</span><span class="op" id="3465193">++</span>&nbsp;<span class="op" id="3465196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3465200">//&nbsp;Avoid&nbsp;overflow.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465221">if</span>&nbsp;<span class="ident" id="3465224">n</span>&nbsp;<span class="op" id="3465226">&gt;=</span>&nbsp;<span class="num" id="3465229">1e8</span>&nbsp;<span class="op" id="3465233">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465238">n</span>&nbsp;<span class="op" id="3465240">=</span>&nbsp;<span class="op" id="3465242">-</span><span class="num" id="3465243">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465248">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465260">n</span>&nbsp;<span class="op" id="3465262">=</span>&nbsp;<span class="ident" id="3465264">n</span><span class="op" id="3465265">*</span><span class="num" id="3465266">10</span>&nbsp;<span class="op" id="3465269">+</span>&nbsp;<span class="builtintype" id="3465271">int</span><span class="op" id="3465274">(</span><span class="ident" id="3465275">t</span><span class="op" id="3465276">[</span><span class="ident" id="3465277">i</span><span class="op" id="3465278">]</span><span class="op" id="3465279">)</span>&nbsp;<span class="op" id="3465281">-</span>&nbsp;<span class="string" id="3465283">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465288">}</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465291">return</span><br>
<span class="lineno"></span><span class="op" id="3465298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3465301">//&nbsp;can&nbsp;this&nbsp;be&nbsp;represented&nbsp;as&nbsp;a&nbsp;character&nbsp;class?</span><br>
<span class="lineno"></span><span class="comment" id="3465350">//&nbsp;single-rune&nbsp;literal&nbsp;string,&nbsp;char&nbsp;class,&nbsp;.,&nbsp;and&nbsp;.|\n.</span><br>
<span class="lineno">1085</span><span class="keyword" id="3465406">func</span>&nbsp;<span class="ident" id="3465411">isCharClass</span><span class="op" id="3465422">(</span><span class="ident" id="3465423">re</span>&nbsp;<span class="op" id="3465426">*</span><span class="ident" id="3465427">Regexp</span><span class="op" id="3465433">)</span>&nbsp;<span class="builtintype" id="3465435">bool</span>&nbsp;<span class="op" id="3465440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465443">return</span>&nbsp;<span class="ident" id="3465450">re</span><span class="op" id="3465452">.</span><span class="ident" id="3465453">Op</span>&nbsp;<span class="op" id="3465456">==</span>&nbsp;<span class="ident" id="3465459">OpLiteral</span>&nbsp;<span class="op" id="3465469">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3465472">len</span><span class="op" id="3465475">(</span><span class="ident" id="3465476">re</span><span class="op" id="3465478">.</span><span class="ident" id="3465479">Rune</span><span class="op" id="3465483">)</span>&nbsp;<span class="op" id="3465485">==</span>&nbsp;<span class="num" id="3465488">1</span>&nbsp;<span class="op" id="3465490">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465495">re</span><span class="op" id="3465497">.</span><span class="ident" id="3465498">Op</span>&nbsp;<span class="op" id="3465501">==</span>&nbsp;<span class="ident" id="3465504">OpCharClass</span>&nbsp;<span class="op" id="3465516">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465521">re</span><span class="op" id="3465523">.</span><span class="ident" id="3465524">Op</span>&nbsp;<span class="op" id="3465527">==</span>&nbsp;<span class="ident" id="3465530">OpAnyCharNotNL</span>&nbsp;<span class="op" id="3465545">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465550">re</span><span class="op" id="3465552">.</span><span class="ident" id="3465553">Op</span>&nbsp;<span class="op" id="3465556">==</span>&nbsp;<span class="ident" id="3465559">OpAnyChar</span><br>
<span class="lineno">1090</span><span class="op" id="3465569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3465572">//&nbsp;does&nbsp;re&nbsp;match&nbsp;r?</span><br>
<span class="lineno"></span><span class="keyword" id="3465592">func</span>&nbsp;<span class="ident" id="3465597">matchRune</span><span class="op" id="3465606">(</span><span class="ident" id="3465607">re</span>&nbsp;<span class="op" id="3465610">*</span><span class="ident" id="3465611">Regexp</span><span class="op" id="3465617">,</span>&nbsp;<span class="ident" id="3465619">r</span>&nbsp;<span class="builtintype" id="3465621">rune</span><span class="op" id="3465625">)</span>&nbsp;<span class="builtintype" id="3465627">bool</span>&nbsp;<span class="op" id="3465632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465635">switch</span>&nbsp;<span class="ident" id="3465642">re</span><span class="op" id="3465644">.</span><span class="ident" id="3465645">Op</span>&nbsp;<span class="op" id="3465648">{</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465651">case</span>&nbsp;<span class="ident" id="3465656">OpLiteral</span><span class="op" id="3465665">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465669">return</span>&nbsp;<span class="builtinfunc" id="3465676">len</span><span class="op" id="3465679">(</span><span class="ident" id="3465680">re</span><span class="op" id="3465682">.</span><span class="ident" id="3465683">Rune</span><span class="op" id="3465687">)</span>&nbsp;<span class="op" id="3465689">==</span>&nbsp;<span class="num" id="3465692">1</span>&nbsp;<span class="op" id="3465694">&amp;&amp;</span>&nbsp;<span class="ident" id="3465697">re</span><span class="op" id="3465699">.</span><span class="ident" id="3465700">Rune</span><span class="op" id="3465704">[</span><span class="num" id="3465705">0</span><span class="op" id="3465706">]</span>&nbsp;<span class="op" id="3465708">==</span>&nbsp;<span class="ident" id="3465711">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465714">case</span>&nbsp;<span class="ident" id="3465719">OpCharClass</span><span class="op" id="3465730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465734">for</span>&nbsp;<span class="ident" id="3465738">i</span>&nbsp;<span class="op" id="3465740">:=</span>&nbsp;<span class="num" id="3465743">0</span><span class="op" id="3465744">;</span>&nbsp;<span class="ident" id="3465746">i</span>&nbsp;<span class="op" id="3465748">&lt;</span>&nbsp;<span class="builtinfunc" id="3465750">len</span><span class="op" id="3465753">(</span><span class="ident" id="3465754">re</span><span class="op" id="3465756">.</span><span class="ident" id="3465757">Rune</span><span class="op" id="3465761">)</span><span class="op" id="3465762">;</span>&nbsp;<span class="ident" id="3465764">i</span>&nbsp;<span class="op" id="3465766">+=</span>&nbsp;<span class="num" id="3465769">2</span>&nbsp;<span class="op" id="3465771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465776">if</span>&nbsp;<span class="ident" id="3465779">re</span><span class="op" id="3465781">.</span><span class="ident" id="3465782">Rune</span><span class="op" id="3465786">[</span><span class="ident" id="3465787">i</span><span class="op" id="3465788">]</span>&nbsp;<span class="op" id="3465790">&lt;=</span>&nbsp;<span class="ident" id="3465793">r</span>&nbsp;<span class="op" id="3465795">&amp;&amp;</span>&nbsp;<span class="ident" id="3465798">r</span>&nbsp;<span class="op" id="3465800">&lt;=</span>&nbsp;<span class="ident" id="3465803">re</span><span class="op" id="3465805">.</span><span class="ident" id="3465806">Rune</span><span class="op" id="3465810">[</span><span class="ident" id="3465811">i</span><span class="op" id="3465812">+</span><span class="num" id="3465813">1</span><span class="op" id="3465814">]</span>&nbsp;<span class="op" id="3465816">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465822">return</span>&nbsp;<span class="builtintype" id="3465829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465845">return</span>&nbsp;<span class="builtintype" id="3465852">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465859">case</span>&nbsp;<span class="ident" id="3465864">OpAnyCharNotNL</span><span class="op" id="3465878">:</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465882">return</span>&nbsp;<span class="ident" id="3465889">r</span>&nbsp;<span class="op" id="3465891">!=</span>&nbsp;<span class="string" id="3465894">&#39;\n&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465900">case</span>&nbsp;<span class="ident" id="3465905">OpAnyChar</span><span class="op" id="3465914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465918">return</span>&nbsp;<span class="builtintype" id="3465925">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465934">return</span>&nbsp;<span class="builtintype" id="3465941">false</span><br>
<span class="lineno">1110</span><span class="op" id="3465947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3465950">//&nbsp;parseVerticalBar&nbsp;handles&nbsp;a&nbsp;|&nbsp;in&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="keyword" id="3465996">func</span>&nbsp;<span class="op" id="3466001">(</span><span class="ident" id="3466002">p</span>&nbsp;<span class="op" id="3466004">*</span><span class="ident" id="3466005">parser</span><span class="op" id="3466011">)</span>&nbsp;<span class="ident" id="3466013">parseVerticalBar</span><span class="op" id="3466029">(</span><span class="op" id="3466030">)</span>&nbsp;<span class="builtintype" id="3466032">error</span>&nbsp;<span class="op" id="3466038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466041">p</span><span class="op" id="3466042">.</span><span class="ident" id="3466043">concat</span><span class="op" id="3466049">(</span><span class="op" id="3466050">)</span><br>
<span class="lineno">1115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466054">//&nbsp;The&nbsp;concatenation&nbsp;we&nbsp;just&nbsp;parsed&nbsp;is&nbsp;on&nbsp;top&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466115">//&nbsp;If&nbsp;it&nbsp;sits&nbsp;above&nbsp;an&nbsp;opVerticalBar,&nbsp;swap&nbsp;it&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466168">//&nbsp;(things&nbsp;below&nbsp;an&nbsp;opVerticalBar&nbsp;become&nbsp;an&nbsp;alternation).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466227">//&nbsp;Otherwise,&nbsp;push&nbsp;a&nbsp;new&nbsp;vertical&nbsp;bar.</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466267">if</span>&nbsp;<span class="op" id="3466270">!</span><span class="ident" id="3466271">p</span><span class="op" id="3466272">.</span><span class="ident" id="3466273">swapVerticalBar</span><span class="op" id="3466288">(</span><span class="op" id="3466289">)</span>&nbsp;<span class="op" id="3466291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466295">p</span><span class="op" id="3466296">.</span><span class="ident" id="3466297">op</span><span class="op" id="3466299">(</span><span class="ident" id="3466300">opVerticalBar</span><span class="op" id="3466313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466320">return</span>&nbsp;<span class="ident" id="3466327">nil</span><br>
<span class="lineno">1125</span><span class="op" id="3466331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3466334">//&nbsp;mergeCharClass&nbsp;makes&nbsp;dst&nbsp;=&nbsp;dst|src.</span><br>
<span class="lineno"></span><span class="comment" id="3466373">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;ensure&nbsp;that&nbsp;dst.Op&nbsp;&gt;=&nbsp;src.Op,</span><br>
<span class="lineno"></span><span class="comment" id="3466422">//&nbsp;to&nbsp;reduce&nbsp;the&nbsp;amount&nbsp;of&nbsp;copying.</span><br>
<span class="lineno">1130</span><span class="keyword" id="3466458">func</span>&nbsp;<span class="ident" id="3466463">mergeCharClass</span><span class="op" id="3466477">(</span><span class="ident" id="3466478">dst</span><span class="op" id="3466481">,</span>&nbsp;<span class="ident" id="3466483">src</span>&nbsp;<span class="op" id="3466487">*</span><span class="ident" id="3466488">Regexp</span><span class="op" id="3466494">)</span>&nbsp;<span class="op" id="3466496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466499">switch</span>&nbsp;<span class="ident" id="3466506">dst</span><span class="op" id="3466509">.</span><span class="ident" id="3466510">Op</span>&nbsp;<span class="op" id="3466513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466516">case</span>&nbsp;<span class="ident" id="3466521">OpAnyChar</span><span class="op" id="3466530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466534">//&nbsp;src&nbsp;doesn&#39;t&nbsp;add&nbsp;anything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466564">case</span>&nbsp;<span class="ident" id="3466569">OpAnyCharNotNL</span><span class="op" id="3466583">:</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466587">//&nbsp;src&nbsp;might&nbsp;add&nbsp;\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466609">if</span>&nbsp;<span class="ident" id="3466612">matchRune</span><span class="op" id="3466621">(</span><span class="ident" id="3466622">src</span><span class="op" id="3466625">,</span>&nbsp;<span class="string" id="3466627">&#39;\n&#39;</span><span class="op" id="3466631">)</span>&nbsp;<span class="op" id="3466633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466638">dst</span><span class="op" id="3466641">.</span><span class="ident" id="3466642">Op</span>&nbsp;<span class="op" id="3466645">=</span>&nbsp;<span class="ident" id="3466647">OpAnyChar</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466662">case</span>&nbsp;<span class="ident" id="3466667">OpCharClass</span><span class="op" id="3466678">:</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466682">//&nbsp;src&nbsp;is&nbsp;simpler,&nbsp;so&nbsp;either&nbsp;literal&nbsp;or&nbsp;char&nbsp;class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466735">if</span>&nbsp;<span class="ident" id="3466738">src</span><span class="op" id="3466741">.</span><span class="ident" id="3466742">Op</span>&nbsp;<span class="op" id="3466745">==</span>&nbsp;<span class="ident" id="3466748">OpLiteral</span>&nbsp;<span class="op" id="3466758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466763">dst</span><span class="op" id="3466766">.</span><span class="ident" id="3466767">Rune</span>&nbsp;<span class="op" id="3466772">=</span>&nbsp;<span class="ident" id="3466774">appendLiteral</span><span class="op" id="3466787">(</span><span class="ident" id="3466788">dst</span><span class="op" id="3466791">.</span><span class="ident" id="3466792">Rune</span><span class="op" id="3466796">,</span>&nbsp;<span class="ident" id="3466798">src</span><span class="op" id="3466801">.</span><span class="ident" id="3466802">Rune</span><span class="op" id="3466806">[</span><span class="num" id="3466807">0</span><span class="op" id="3466808">]</span><span class="op" id="3466809">,</span>&nbsp;<span class="ident" id="3466811">src</span><span class="op" id="3466814">.</span><span class="ident" id="3466815">Flags</span><span class="op" id="3466820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466824">}</span>&nbsp;<span class="keyword" id="3466826">else</span>&nbsp;<span class="op" id="3466831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466836">dst</span><span class="op" id="3466839">.</span><span class="ident" id="3466840">Rune</span>&nbsp;<span class="op" id="3466845">=</span>&nbsp;<span class="ident" id="3466847">appendClass</span><span class="op" id="3466858">(</span><span class="ident" id="3466859">dst</span><span class="op" id="3466862">.</span><span class="ident" id="3466863">Rune</span><span class="op" id="3466867">,</span>&nbsp;<span class="ident" id="3466869">src</span><span class="op" id="3466872">.</span><span class="ident" id="3466873">Rune</span><span class="op" id="3466877">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466884">case</span>&nbsp;<span class="ident" id="3466889">OpLiteral</span><span class="op" id="3466898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3466902">//&nbsp;both&nbsp;literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466920">if</span>&nbsp;<span class="ident" id="3466923">src</span><span class="op" id="3466926">.</span><span class="ident" id="3466927">Rune</span><span class="op" id="3466931">[</span><span class="num" id="3466932">0</span><span class="op" id="3466933">]</span>&nbsp;<span class="op" id="3466935">==</span>&nbsp;<span class="ident" id="3466938">dst</span><span class="op" id="3466941">.</span><span class="ident" id="3466942">Rune</span><span class="op" id="3466946">[</span><span class="num" id="3466947">0</span><span class="op" id="3466948">]</span>&nbsp;<span class="op" id="3466950">&amp;&amp;</span>&nbsp;<span class="ident" id="3466953">src</span><span class="op" id="3466956">.</span><span class="ident" id="3466957">Flags</span>&nbsp;<span class="op" id="3466963">==</span>&nbsp;<span class="ident" id="3466966">dst</span><span class="op" id="3466969">.</span><span class="ident" id="3466970">Flags</span>&nbsp;<span class="op" id="3466976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466981">break</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466993">dst</span><span class="op" id="3466996">.</span><span class="ident" id="3466997">Op</span>&nbsp;<span class="op" id="3467000">=</span>&nbsp;<span class="ident" id="3467002">OpCharClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467016">dst</span><span class="op" id="3467019">.</span><span class="ident" id="3467020">Rune</span>&nbsp;<span class="op" id="3467025">=</span>&nbsp;<span class="ident" id="3467027">appendLiteral</span><span class="op" id="3467040">(</span><span class="ident" id="3467041">dst</span><span class="op" id="3467044">.</span><span class="ident" id="3467045">Rune</span><span class="op" id="3467049">[</span><span class="op" id="3467050">:</span><span class="num" id="3467051">0</span><span class="op" id="3467052">]</span><span class="op" id="3467053">,</span>&nbsp;<span class="ident" id="3467055">dst</span><span class="op" id="3467058">.</span><span class="ident" id="3467059">Rune</span><span class="op" id="3467063">[</span><span class="num" id="3467064">0</span><span class="op" id="3467065">]</span><span class="op" id="3467066">,</span>&nbsp;<span class="ident" id="3467068">dst</span><span class="op" id="3467071">.</span><span class="ident" id="3467072">Flags</span><span class="op" id="3467077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467081">dst</span><span class="op" id="3467084">.</span><span class="ident" id="3467085">Rune</span>&nbsp;<span class="op" id="3467090">=</span>&nbsp;<span class="ident" id="3467092">appendLiteral</span><span class="op" id="3467105">(</span><span class="ident" id="3467106">dst</span><span class="op" id="3467109">.</span><span class="ident" id="3467110">Rune</span><span class="op" id="3467114">,</span>&nbsp;<span class="ident" id="3467116">src</span><span class="op" id="3467119">.</span><span class="ident" id="3467120">Rune</span><span class="op" id="3467124">[</span><span class="num" id="3467125">0</span><span class="op" id="3467126">]</span><span class="op" id="3467127">,</span>&nbsp;<span class="ident" id="3467129">src</span><span class="op" id="3467132">.</span><span class="ident" id="3467133">Flags</span><span class="op" id="3467138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467141">}</span><br>
<span class="lineno">1155</span><span class="op" id="3467143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3467146">//&nbsp;If&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;is&nbsp;an&nbsp;element&nbsp;followed&nbsp;by&nbsp;an&nbsp;opVerticalBar</span><br>
<span class="lineno"></span><span class="comment" id="3467216">//&nbsp;swapVerticalBar&nbsp;swaps&nbsp;the&nbsp;two&nbsp;and&nbsp;returns&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="3467267">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">1160</span><span class="keyword" id="3467298">func</span>&nbsp;<span class="op" id="3467303">(</span><span class="ident" id="3467304">p</span>&nbsp;<span class="op" id="3467306">*</span><span class="ident" id="3467307">parser</span><span class="op" id="3467313">)</span>&nbsp;<span class="ident" id="3467315">swapVerticalBar</span><span class="op" id="3467330">(</span><span class="op" id="3467331">)</span>&nbsp;<span class="builtintype" id="3467333">bool</span>&nbsp;<span class="op" id="3467338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467341">//&nbsp;If&nbsp;above&nbsp;and&nbsp;below&nbsp;vertical&nbsp;bar&nbsp;are&nbsp;literal&nbsp;or&nbsp;char&nbsp;class,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467404">//&nbsp;can&nbsp;merge&nbsp;into&nbsp;a&nbsp;single&nbsp;char&nbsp;class.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467444">n</span>&nbsp;<span class="op" id="3467446">:=</span>&nbsp;<span class="builtinfunc" id="3467449">len</span><span class="op" id="3467452">(</span><span class="ident" id="3467453">p</span><span class="op" id="3467454">.</span><span class="ident" id="3467455">stack</span><span class="op" id="3467460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467463">if</span>&nbsp;<span class="ident" id="3467466">n</span>&nbsp;<span class="op" id="3467468">&gt;=</span>&nbsp;<span class="num" id="3467471">3</span>&nbsp;<span class="op" id="3467473">&amp;&amp;</span>&nbsp;<span class="ident" id="3467476">p</span><span class="op" id="3467477">.</span><span class="ident" id="3467478">stack</span><span class="op" id="3467483">[</span><span class="ident" id="3467484">n</span><span class="op" id="3467485">-</span><span class="num" id="3467486">2</span><span class="op" id="3467487">]</span><span class="op" id="3467488">.</span><span class="ident" id="3467489">Op</span>&nbsp;<span class="op" id="3467492">==</span>&nbsp;<span class="ident" id="3467495">opVerticalBar</span>&nbsp;<span class="op" id="3467509">&amp;&amp;</span>&nbsp;<span class="ident" id="3467512">isCharClass</span><span class="op" id="3467523">(</span><span class="ident" id="3467524">p</span><span class="op" id="3467525">.</span><span class="ident" id="3467526">stack</span><span class="op" id="3467531">[</span><span class="ident" id="3467532">n</span><span class="op" id="3467533">-</span><span class="num" id="3467534">1</span><span class="op" id="3467535">]</span><span class="op" id="3467536">)</span>&nbsp;<span class="op" id="3467538">&amp;&amp;</span>&nbsp;<span class="ident" id="3467541">isCharClass</span><span class="op" id="3467552">(</span><span class="ident" id="3467553">p</span><span class="op" id="3467554">.</span><span class="ident" id="3467555">stack</span><span class="op" id="3467560">[</span><span class="ident" id="3467561">n</span><span class="op" id="3467562">-</span><span class="num" id="3467563">3</span><span class="op" id="3467564">]</span><span class="op" id="3467565">)</span>&nbsp;<span class="op" id="3467567">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467571">re1</span>&nbsp;<span class="op" id="3467575">:=</span>&nbsp;<span class="ident" id="3467578">p</span><span class="op" id="3467579">.</span><span class="ident" id="3467580">stack</span><span class="op" id="3467585">[</span><span class="ident" id="3467586">n</span><span class="op" id="3467587">-</span><span class="num" id="3467588">1</span><span class="op" id="3467589">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467593">re3</span>&nbsp;<span class="op" id="3467597">:=</span>&nbsp;<span class="ident" id="3467600">p</span><span class="op" id="3467601">.</span><span class="ident" id="3467602">stack</span><span class="op" id="3467607">[</span><span class="ident" id="3467608">n</span><span class="op" id="3467609">-</span><span class="num" id="3467610">3</span><span class="op" id="3467611">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467615">//&nbsp;Make&nbsp;re3&nbsp;the&nbsp;more&nbsp;complex&nbsp;of&nbsp;the&nbsp;two.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467658">if</span>&nbsp;<span class="ident" id="3467661">re1</span><span class="op" id="3467664">.</span><span class="ident" id="3467665">Op</span>&nbsp;<span class="op" id="3467668">&gt;</span>&nbsp;<span class="ident" id="3467670">re3</span><span class="op" id="3467673">.</span><span class="ident" id="3467674">Op</span>&nbsp;<span class="op" id="3467677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467682">re1</span><span class="op" id="3467685">,</span>&nbsp;<span class="ident" id="3467687">re3</span>&nbsp;<span class="op" id="3467691">=</span>&nbsp;<span class="ident" id="3467693">re3</span><span class="op" id="3467696">,</span>&nbsp;<span class="ident" id="3467698">re1</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467705">p</span><span class="op" id="3467706">.</span><span class="ident" id="3467707">stack</span><span class="op" id="3467712">[</span><span class="ident" id="3467713">n</span><span class="op" id="3467714">-</span><span class="num" id="3467715">3</span><span class="op" id="3467716">]</span>&nbsp;<span class="op" id="3467718">=</span>&nbsp;<span class="ident" id="3467720">re3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467730">mergeCharClass</span><span class="op" id="3467744">(</span><span class="ident" id="3467745">re3</span><span class="op" id="3467748">,</span>&nbsp;<span class="ident" id="3467750">re1</span><span class="op" id="3467753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467757">p</span><span class="op" id="3467758">.</span><span class="ident" id="3467759">reuse</span><span class="op" id="3467764">(</span><span class="ident" id="3467765">re1</span><span class="op" id="3467768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467772">p</span><span class="op" id="3467773">.</span><span class="ident" id="3467774">stack</span>&nbsp;<span class="op" id="3467780">=</span>&nbsp;<span class="ident" id="3467782">p</span><span class="op" id="3467783">.</span><span class="ident" id="3467784">stack</span><span class="op" id="3467789">[</span><span class="op" id="3467790">:</span><span class="ident" id="3467791">n</span><span class="op" id="3467792">-</span><span class="num" id="3467793">1</span><span class="op" id="3467794">]</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467798">return</span>&nbsp;<span class="builtintype" id="3467805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467815">if</span>&nbsp;<span class="ident" id="3467818">n</span>&nbsp;<span class="op" id="3467820">&gt;=</span>&nbsp;<span class="num" id="3467823">2</span>&nbsp;<span class="op" id="3467825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467829">re1</span>&nbsp;<span class="op" id="3467833">:=</span>&nbsp;<span class="ident" id="3467836">p</span><span class="op" id="3467837">.</span><span class="ident" id="3467838">stack</span><span class="op" id="3467843">[</span><span class="ident" id="3467844">n</span><span class="op" id="3467845">-</span><span class="num" id="3467846">1</span><span class="op" id="3467847">]</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467851">re2</span>&nbsp;<span class="op" id="3467855">:=</span>&nbsp;<span class="ident" id="3467858">p</span><span class="op" id="3467859">.</span><span class="ident" id="3467860">stack</span><span class="op" id="3467865">[</span><span class="ident" id="3467866">n</span><span class="op" id="3467867">-</span><span class="num" id="3467868">2</span><span class="op" id="3467869">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467873">if</span>&nbsp;<span class="ident" id="3467876">re2</span><span class="op" id="3467879">.</span><span class="ident" id="3467880">Op</span>&nbsp;<span class="op" id="3467883">==</span>&nbsp;<span class="ident" id="3467886">opVerticalBar</span>&nbsp;<span class="op" id="3467900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467905">if</span>&nbsp;<span class="ident" id="3467908">n</span>&nbsp;<span class="op" id="3467910">&gt;=</span>&nbsp;<span class="num" id="3467913">3</span>&nbsp;<span class="op" id="3467915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467921">//&nbsp;Now&nbsp;out&nbsp;of&nbsp;reach.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467946">//&nbsp;Clean&nbsp;opportunistically.</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467978">cleanAlt</span><span class="op" id="3467986">(</span><span class="ident" id="3467987">p</span><span class="op" id="3467988">.</span><span class="ident" id="3467989">stack</span><span class="op" id="3467994">[</span><span class="ident" id="3467995">n</span><span class="op" id="3467996">-</span><span class="num" id="3467997">3</span><span class="op" id="3467998">]</span><span class="op" id="3467999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468009">p</span><span class="op" id="3468010">.</span><span class="ident" id="3468011">stack</span><span class="op" id="3468016">[</span><span class="ident" id="3468017">n</span><span class="op" id="3468018">-</span><span class="num" id="3468019">2</span><span class="op" id="3468020">]</span>&nbsp;<span class="op" id="3468022">=</span>&nbsp;<span class="ident" id="3468024">re1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468031">p</span><span class="op" id="3468032">.</span><span class="ident" id="3468033">stack</span><span class="op" id="3468038">[</span><span class="ident" id="3468039">n</span><span class="op" id="3468040">-</span><span class="num" id="3468041">1</span><span class="op" id="3468042">]</span>&nbsp;<span class="op" id="3468044">=</span>&nbsp;<span class="ident" id="3468046">re2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468053">return</span>&nbsp;<span class="builtintype" id="3468060">true</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468073">return</span>&nbsp;<span class="builtintype" id="3468080">false</span><br>
<span class="lineno"></span><span class="op" id="3468086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span><span class="comment" id="3468089">//&nbsp;parseRightParen&nbsp;handles&nbsp;a&nbsp;)&nbsp;in&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="keyword" id="3468134">func</span>&nbsp;<span class="op" id="3468139">(</span><span class="ident" id="3468140">p</span>&nbsp;<span class="op" id="3468142">*</span><span class="ident" id="3468143">parser</span><span class="op" id="3468149">)</span>&nbsp;<span class="ident" id="3468151">parseRightParen</span><span class="op" id="3468166">(</span><span class="op" id="3468167">)</span>&nbsp;<span class="builtintype" id="3468169">error</span>&nbsp;<span class="op" id="3468175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468178">p</span><span class="op" id="3468179">.</span><span class="ident" id="3468180">concat</span><span class="op" id="3468186">(</span><span class="op" id="3468187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468190">if</span>&nbsp;<span class="ident" id="3468193">p</span><span class="op" id="3468194">.</span><span class="ident" id="3468195">swapVerticalBar</span><span class="op" id="3468210">(</span><span class="op" id="3468211">)</span>&nbsp;<span class="op" id="3468213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468217">//&nbsp;pop&nbsp;vertical&nbsp;bar</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468239">p</span><span class="op" id="3468240">.</span><span class="ident" id="3468241">stack</span>&nbsp;<span class="op" id="3468247">=</span>&nbsp;<span class="ident" id="3468249">p</span><span class="op" id="3468250">.</span><span class="ident" id="3468251">stack</span><span class="op" id="3468256">[</span><span class="op" id="3468257">:</span><span class="builtinfunc" id="3468258">len</span><span class="op" id="3468261">(</span><span class="ident" id="3468262">p</span><span class="op" id="3468263">.</span><span class="ident" id="3468264">stack</span><span class="op" id="3468269">)</span><span class="op" id="3468270">-</span><span class="num" id="3468271">1</span><span class="op" id="3468272">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468278">p</span><span class="op" id="3468279">.</span><span class="ident" id="3468280">alternate</span><span class="op" id="3468289">(</span><span class="op" id="3468290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468294">n</span>&nbsp;<span class="op" id="3468296">:=</span>&nbsp;<span class="builtinfunc" id="3468299">len</span><span class="op" id="3468302">(</span><span class="ident" id="3468303">p</span><span class="op" id="3468304">.</span><span class="ident" id="3468305">stack</span><span class="op" id="3468310">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468313">if</span>&nbsp;<span class="ident" id="3468316">n</span>&nbsp;<span class="op" id="3468318">&lt;</span>&nbsp;<span class="num" id="3468320">2</span>&nbsp;<span class="op" id="3468322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468326">return</span>&nbsp;<span class="op" id="3468333">&amp;</span><span class="ident" id="3468334">Error</span><span class="op" id="3468339">{</span><span class="ident" id="3468340">ErrUnexpectedParen</span><span class="op" id="3468358">,</span>&nbsp;<span class="ident" id="3468360">p</span><span class="op" id="3468361">.</span><span class="ident" id="3468362">wholeRegexp</span><span class="op" id="3468373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468379">re1</span>&nbsp;<span class="op" id="3468383">:=</span>&nbsp;<span class="ident" id="3468386">p</span><span class="op" id="3468387">.</span><span class="ident" id="3468388">stack</span><span class="op" id="3468393">[</span><span class="ident" id="3468394">n</span><span class="op" id="3468395">-</span><span class="num" id="3468396">1</span><span class="op" id="3468397">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468400">re2</span>&nbsp;<span class="op" id="3468404">:=</span>&nbsp;<span class="ident" id="3468407">p</span><span class="op" id="3468408">.</span><span class="ident" id="3468409">stack</span><span class="op" id="3468414">[</span><span class="ident" id="3468415">n</span><span class="op" id="3468416">-</span><span class="num" id="3468417">2</span><span class="op" id="3468418">]</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468421">p</span><span class="op" id="3468422">.</span><span class="ident" id="3468423">stack</span>&nbsp;<span class="op" id="3468429">=</span>&nbsp;<span class="ident" id="3468431">p</span><span class="op" id="3468432">.</span><span class="ident" id="3468433">stack</span><span class="op" id="3468438">[</span><span class="op" id="3468439">:</span><span class="ident" id="3468440">n</span><span class="op" id="3468441">-</span><span class="num" id="3468442">2</span><span class="op" id="3468443">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468446">if</span>&nbsp;<span class="ident" id="3468449">re2</span><span class="op" id="3468452">.</span><span class="ident" id="3468453">Op</span>&nbsp;<span class="op" id="3468456">!=</span>&nbsp;<span class="ident" id="3468459">opLeftParen</span>&nbsp;<span class="op" id="3468471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468475">return</span>&nbsp;<span class="op" id="3468482">&amp;</span><span class="ident" id="3468483">Error</span><span class="op" id="3468488">{</span><span class="ident" id="3468489">ErrUnexpectedParen</span><span class="op" id="3468507">,</span>&nbsp;<span class="ident" id="3468509">p</span><span class="op" id="3468510">.</span><span class="ident" id="3468511">wholeRegexp</span><span class="op" id="3468522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468528">//&nbsp;Restore&nbsp;flags&nbsp;at&nbsp;time&nbsp;of&nbsp;paren.</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468564">p</span><span class="op" id="3468565">.</span><span class="ident" id="3468566">flags</span>&nbsp;<span class="op" id="3468572">=</span>&nbsp;<span class="ident" id="3468574">re2</span><span class="op" id="3468577">.</span><span class="ident" id="3468578">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468585">if</span>&nbsp;<span class="ident" id="3468588">re2</span><span class="op" id="3468591">.</span><span class="ident" id="3468592">Cap</span>&nbsp;<span class="op" id="3468596">==</span>&nbsp;<span class="num" id="3468599">0</span>&nbsp;<span class="op" id="3468601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468605">//&nbsp;Just&nbsp;for&nbsp;grouping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468629">p</span><span class="op" id="3468630">.</span><span class="ident" id="3468631">push</span><span class="op" id="3468635">(</span><span class="ident" id="3468636">re1</span><span class="op" id="3468639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468642">}</span>&nbsp;<span class="keyword" id="3468644">else</span>&nbsp;<span class="op" id="3468649">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468653">re2</span><span class="op" id="3468656">.</span><span class="ident" id="3468657">Op</span>&nbsp;<span class="op" id="3468660">=</span>&nbsp;<span class="ident" id="3468662">OpCapture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468674">re2</span><span class="op" id="3468677">.</span><span class="ident" id="3468678">Sub</span>&nbsp;<span class="op" id="3468682">=</span>&nbsp;<span class="ident" id="3468684">re2</span><span class="op" id="3468687">.</span><span class="ident" id="3468688">Sub0</span><span class="op" id="3468692">[</span><span class="op" id="3468693">:</span><span class="num" id="3468694">1</span><span class="op" id="3468695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468699">re2</span><span class="op" id="3468702">.</span><span class="ident" id="3468703">Sub</span><span class="op" id="3468706">[</span><span class="num" id="3468707">0</span><span class="op" id="3468708">]</span>&nbsp;<span class="op" id="3468710">=</span>&nbsp;<span class="ident" id="3468712">re1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468718">p</span><span class="op" id="3468719">.</span><span class="ident" id="3468720">push</span><span class="op" id="3468724">(</span><span class="ident" id="3468725">re2</span><span class="op" id="3468728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468731">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468734">return</span>&nbsp;<span class="ident" id="3468741">nil</span><br>
<span class="lineno"></span><span class="op" id="3468745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3468748">//&nbsp;parseEscape&nbsp;parses&nbsp;an&nbsp;escape&nbsp;sequence&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno"></span><span class="comment" id="3468811">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;rune.</span><br>
<span class="lineno">1230</span><span class="keyword" id="3468836">func</span>&nbsp;<span class="op" id="3468841">(</span><span class="ident" id="3468842">p</span>&nbsp;<span class="op" id="3468844">*</span><span class="ident" id="3468845">parser</span><span class="op" id="3468851">)</span>&nbsp;<span class="ident" id="3468853">parseEscape</span><span class="op" id="3468864">(</span><span class="ident" id="3468865">s</span>&nbsp;<span class="builtintype" id="3468867">string</span><span class="op" id="3468873">)</span>&nbsp;<span class="op" id="3468875">(</span><span class="ident" id="3468876">r</span>&nbsp;<span class="builtintype" id="3468878">rune</span><span class="op" id="3468882">,</span>&nbsp;<span class="ident" id="3468884">rest</span>&nbsp;<span class="builtintype" id="3468889">string</span><span class="op" id="3468895">,</span>&nbsp;<span class="ident" id="3468897">err</span>&nbsp;<span class="builtintype" id="3468901">error</span><span class="op" id="3468906">)</span>&nbsp;<span class="op" id="3468908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468911">t</span>&nbsp;<span class="op" id="3468913">:=</span>&nbsp;<span class="ident" id="3468916">s</span><span class="op" id="3468917">[</span><span class="num" id="3468918">1</span><span class="op" id="3468919">:</span><span class="op" id="3468920">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468923">if</span>&nbsp;<span class="ident" id="3468926">t</span>&nbsp;<span class="op" id="3468928">==</span>&nbsp;<span class="string" id="3468931">&#34;&#34;</span>&nbsp;<span class="op" id="3468934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468938">return</span>&nbsp;<span class="num" id="3468945">0</span><span class="op" id="3468946">,</span>&nbsp;<span class="string" id="3468948">&#34;&#34;</span><span class="op" id="3468950">,</span>&nbsp;<span class="op" id="3468952">&amp;</span><span class="ident" id="3468953">Error</span><span class="op" id="3468958">{</span><span class="ident" id="3468959">ErrTrailingBackslash</span><span class="op" id="3468979">,</span>&nbsp;<span class="string" id="3468981">&#34;&#34;</span><span class="op" id="3468983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468986">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468989">c</span><span class="op" id="3468990">,</span>&nbsp;<span class="ident" id="3468992">t</span><span class="op" id="3468993">,</span>&nbsp;<span class="ident" id="3468995">err</span>&nbsp;<span class="op" id="3468999">:=</span>&nbsp;<span class="ident" id="3469002">nextRune</span><span class="op" id="3469010">(</span><span class="ident" id="3469011">t</span><span class="op" id="3469012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469015">if</span>&nbsp;<span class="ident" id="3469018">err</span>&nbsp;<span class="op" id="3469022">!=</span>&nbsp;<span class="ident" id="3469025">nil</span>&nbsp;<span class="op" id="3469029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469033">return</span>&nbsp;<span class="num" id="3469040">0</span><span class="op" id="3469041">,</span>&nbsp;<span class="string" id="3469043">&#34;&#34;</span><span class="op" id="3469045">,</span>&nbsp;<span class="ident" id="3469047">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1240</span><span class="ident" id="3469055">Switch</span><span class="op" id="3469061">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469064">switch</span>&nbsp;<span class="ident" id="3469071">c</span>&nbsp;<span class="op" id="3469073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469076">default</span><span class="op" id="3469083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469087">if</span>&nbsp;<span class="ident" id="3469090">c</span>&nbsp;<span class="op" id="3469092">&lt;</span>&nbsp;<span class="ident" id="3469094">utf8</span><span class="op" id="3469098">.</span><span class="ident" id="3469099">RuneSelf</span>&nbsp;<span class="op" id="3469108">&amp;&amp;</span>&nbsp;<span class="op" id="3469111">!</span><span class="ident" id="3469112">isalnum</span><span class="op" id="3469119">(</span><span class="ident" id="3469120">c</span><span class="op" id="3469121">)</span>&nbsp;<span class="op" id="3469123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469128">//&nbsp;Escaped&nbsp;non-word&nbsp;characters&nbsp;are&nbsp;always&nbsp;themselves.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469185">//&nbsp;PCRE&nbsp;is&nbsp;not&nbsp;quite&nbsp;so&nbsp;rigorous:&nbsp;it&nbsp;accepts&nbsp;things&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469245">//&nbsp;\q,&nbsp;but&nbsp;we&nbsp;don&#39;t.&nbsp;&nbsp;We&nbsp;once&nbsp;rejected&nbsp;\_,&nbsp;but&nbsp;too&nbsp;many</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469304">//&nbsp;programs&nbsp;and&nbsp;people&nbsp;insist&nbsp;on&nbsp;using&nbsp;it,&nbsp;so&nbsp;allow&nbsp;\_.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469363">return</span>&nbsp;<span class="ident" id="3469370">c</span><span class="op" id="3469371">,</span>&nbsp;<span class="ident" id="3469373">t</span><span class="op" id="3469374">,</span>&nbsp;<span class="ident" id="3469376">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469382">}</span><br>
<span class="lineno">1250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469386">//&nbsp;Octal&nbsp;escapes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469405">case</span>&nbsp;<span class="string" id="3469410">&#39;1&#39;</span><span class="op" id="3469413">,</span>&nbsp;<span class="string" id="3469415">&#39;2&#39;</span><span class="op" id="3469418">,</span>&nbsp;<span class="string" id="3469420">&#39;3&#39;</span><span class="op" id="3469423">,</span>&nbsp;<span class="string" id="3469425">&#39;4&#39;</span><span class="op" id="3469428">,</span>&nbsp;<span class="string" id="3469430">&#39;5&#39;</span><span class="op" id="3469433">,</span>&nbsp;<span class="string" id="3469435">&#39;6&#39;</span><span class="op" id="3469438">,</span>&nbsp;<span class="string" id="3469440">&#39;7&#39;</span><span class="op" id="3469443">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469447">//&nbsp;Single&nbsp;non-zero&nbsp;digit&nbsp;is&nbsp;a&nbsp;backreference;&nbsp;not&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469508">if</span>&nbsp;<span class="ident" id="3469511">t</span>&nbsp;<span class="op" id="3469513">==</span>&nbsp;<span class="string" id="3469516">&#34;&#34;</span>&nbsp;<span class="op" id="3469519">||</span>&nbsp;<span class="ident" id="3469522">t</span><span class="op" id="3469523">[</span><span class="num" id="3469524">0</span><span class="op" id="3469525">]</span>&nbsp;<span class="op" id="3469527">&lt;</span>&nbsp;<span class="string" id="3469529">&#39;0&#39;</span>&nbsp;<span class="op" id="3469533">||</span>&nbsp;<span class="ident" id="3469536">t</span><span class="op" id="3469537">[</span><span class="num" id="3469538">0</span><span class="op" id="3469539">]</span>&nbsp;<span class="op" id="3469541">&gt;</span>&nbsp;<span class="string" id="3469543">&#39;7&#39;</span>&nbsp;<span class="op" id="3469547">{</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469552">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469564">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469577">case</span>&nbsp;<span class="string" id="3469582">&#39;0&#39;</span><span class="op" id="3469585">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469589">//&nbsp;Consume&nbsp;up&nbsp;to&nbsp;three&nbsp;octal&nbsp;digits;&nbsp;already&nbsp;have&nbsp;one.</span><br>
<span class="lineno">1260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469646">r</span>&nbsp;<span class="op" id="3469648">=</span>&nbsp;<span class="ident" id="3469650">c</span>&nbsp;<span class="op" id="3469652">-</span>&nbsp;<span class="string" id="3469654">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469660">for</span>&nbsp;<span class="ident" id="3469664">i</span>&nbsp;<span class="op" id="3469666">:=</span>&nbsp;<span class="num" id="3469669">1</span><span class="op" id="3469670">;</span>&nbsp;<span class="ident" id="3469672">i</span>&nbsp;<span class="op" id="3469674">&lt;</span>&nbsp;<span class="num" id="3469676">3</span><span class="op" id="3469677">;</span>&nbsp;<span class="ident" id="3469679">i</span><span class="op" id="3469680">++</span>&nbsp;<span class="op" id="3469683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469688">if</span>&nbsp;<span class="ident" id="3469691">t</span>&nbsp;<span class="op" id="3469693">==</span>&nbsp;<span class="string" id="3469696">&#34;&#34;</span>&nbsp;<span class="op" id="3469699">||</span>&nbsp;<span class="ident" id="3469702">t</span><span class="op" id="3469703">[</span><span class="num" id="3469704">0</span><span class="op" id="3469705">]</span>&nbsp;<span class="op" id="3469707">&lt;</span>&nbsp;<span class="string" id="3469709">&#39;0&#39;</span>&nbsp;<span class="op" id="3469713">||</span>&nbsp;<span class="ident" id="3469716">t</span><span class="op" id="3469717">[</span><span class="num" id="3469718">0</span><span class="op" id="3469719">]</span>&nbsp;<span class="op" id="3469721">&gt;</span>&nbsp;<span class="string" id="3469723">&#39;7&#39;</span>&nbsp;<span class="op" id="3469727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469733">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469742">}</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469747">r</span>&nbsp;<span class="op" id="3469749">=</span>&nbsp;<span class="ident" id="3469751">r</span><span class="op" id="3469752">*</span><span class="num" id="3469753">8</span>&nbsp;<span class="op" id="3469755">+</span>&nbsp;<span class="builtintype" id="3469757">rune</span><span class="op" id="3469761">(</span><span class="ident" id="3469762">t</span><span class="op" id="3469763">[</span><span class="num" id="3469764">0</span><span class="op" id="3469765">]</span><span class="op" id="3469766">)</span>&nbsp;<span class="op" id="3469768">-</span>&nbsp;<span class="string" id="3469770">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469777">t</span>&nbsp;<span class="op" id="3469779">=</span>&nbsp;<span class="ident" id="3469781">t</span><span class="op" id="3469782">[</span><span class="num" id="3469783">1</span><span class="op" id="3469784">:</span><span class="op" id="3469785">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469793">return</span>&nbsp;<span class="ident" id="3469800">r</span><span class="op" id="3469801">,</span>&nbsp;<span class="ident" id="3469803">t</span><span class="op" id="3469804">,</span>&nbsp;<span class="ident" id="3469806">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469812">//&nbsp;Hexadecimal&nbsp;escapes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469837">case</span>&nbsp;<span class="string" id="3469842">&#39;x&#39;</span><span class="op" id="3469845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469849">if</span>&nbsp;<span class="ident" id="3469852">t</span>&nbsp;<span class="op" id="3469854">==</span>&nbsp;<span class="string" id="3469857">&#34;&#34;</span>&nbsp;<span class="op" id="3469860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469865">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469873">}</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469877">if</span>&nbsp;<span class="ident" id="3469880">c</span><span class="op" id="3469881">,</span>&nbsp;<span class="ident" id="3469883">t</span><span class="op" id="3469884">,</span>&nbsp;<span class="ident" id="3469886">err</span>&nbsp;<span class="op" id="3469890">=</span>&nbsp;<span class="ident" id="3469892">nextRune</span><span class="op" id="3469900">(</span><span class="ident" id="3469901">t</span><span class="op" id="3469902">)</span><span class="op" id="3469903">;</span>&nbsp;<span class="ident" id="3469905">err</span>&nbsp;<span class="op" id="3469909">!=</span>&nbsp;<span class="ident" id="3469912">nil</span>&nbsp;<span class="op" id="3469916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469921">return</span>&nbsp;<span class="num" id="3469928">0</span><span class="op" id="3469929">,</span>&nbsp;<span class="string" id="3469931">&#34;&#34;</span><span class="op" id="3469933">,</span>&nbsp;<span class="ident" id="3469935">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469945">if</span>&nbsp;<span class="ident" id="3469948">c</span>&nbsp;<span class="op" id="3469950">==</span>&nbsp;<span class="string" id="3469953">&#39;{&#39;</span>&nbsp;<span class="op" id="3469957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469962">//&nbsp;Any&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;braces.</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470000">//&nbsp;Perl&nbsp;accepts&nbsp;any&nbsp;text&nbsp;at&nbsp;all;&nbsp;it&nbsp;ignores&nbsp;all&nbsp;text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470056">//&nbsp;after&nbsp;the&nbsp;first&nbsp;non-hex&nbsp;digit.&nbsp;&nbsp;We&nbsp;require&nbsp;only&nbsp;hex&nbsp;digits,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470122">//&nbsp;and&nbsp;at&nbsp;least&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470146">nhex</span>&nbsp;<span class="op" id="3470151">:=</span>&nbsp;<span class="num" id="3470154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470159">r</span>&nbsp;<span class="op" id="3470161">=</span>&nbsp;<span class="num" id="3470163">0</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470168">for</span>&nbsp;<span class="op" id="3470172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470178">if</span>&nbsp;<span class="ident" id="3470181">t</span>&nbsp;<span class="op" id="3470183">==</span>&nbsp;<span class="string" id="3470186">&#34;&#34;</span>&nbsp;<span class="op" id="3470189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470196">break</span>&nbsp;<span class="ident" id="3470202">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470219">if</span>&nbsp;<span class="ident" id="3470222">c</span><span class="op" id="3470223">,</span>&nbsp;<span class="ident" id="3470225">t</span><span class="op" id="3470226">,</span>&nbsp;<span class="ident" id="3470228">err</span>&nbsp;<span class="op" id="3470232">=</span>&nbsp;<span class="ident" id="3470234">nextRune</span><span class="op" id="3470242">(</span><span class="ident" id="3470243">t</span><span class="op" id="3470244">)</span><span class="op" id="3470245">;</span>&nbsp;<span class="ident" id="3470247">err</span>&nbsp;<span class="op" id="3470251">!=</span>&nbsp;<span class="ident" id="3470254">nil</span>&nbsp;<span class="op" id="3470258">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470265">return</span>&nbsp;<span class="num" id="3470272">0</span><span class="op" id="3470273">,</span>&nbsp;<span class="string" id="3470275">&#34;&#34;</span><span class="op" id="3470277">,</span>&nbsp;<span class="ident" id="3470279">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470293">if</span>&nbsp;<span class="ident" id="3470296">c</span>&nbsp;<span class="op" id="3470298">==</span>&nbsp;<span class="string" id="3470301">&#39;}&#39;</span>&nbsp;<span class="op" id="3470305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470312">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470322">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470328">v</span>&nbsp;<span class="op" id="3470330">:=</span>&nbsp;<span class="ident" id="3470333">unhex</span><span class="op" id="3470338">(</span><span class="ident" id="3470339">c</span><span class="op" id="3470340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470346">if</span>&nbsp;<span class="ident" id="3470349">v</span>&nbsp;<span class="op" id="3470351">&lt;</span>&nbsp;<span class="num" id="3470353">0</span>&nbsp;<span class="op" id="3470355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470362">break</span>&nbsp;<span class="ident" id="3470368">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470385">r</span>&nbsp;<span class="op" id="3470387">=</span>&nbsp;<span class="ident" id="3470389">r</span><span class="op" id="3470390">*</span><span class="num" id="3470391">16</span>&nbsp;<span class="op" id="3470394">+</span>&nbsp;<span class="ident" id="3470396">v</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470402">if</span>&nbsp;<span class="ident" id="3470405">r</span>&nbsp;<span class="op" id="3470407">&gt;</span>&nbsp;<span class="ident" id="3470409">unicode</span><span class="op" id="3470416">.</span><span class="ident" id="3470417">MaxRune</span>&nbsp;<span class="op" id="3470425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470432">break</span>&nbsp;<span class="ident" id="3470438">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470455">nhex</span><span class="op" id="3470459">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470465">}</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470470">if</span>&nbsp;<span class="ident" id="3470473">nhex</span>&nbsp;<span class="op" id="3470478">==</span>&nbsp;<span class="num" id="3470481">0</span>&nbsp;<span class="op" id="3470483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470489">break</span>&nbsp;<span class="ident" id="3470495">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470510">return</span>&nbsp;<span class="ident" id="3470517">r</span><span class="op" id="3470518">,</span>&nbsp;<span class="ident" id="3470520">t</span><span class="op" id="3470521">,</span>&nbsp;<span class="ident" id="3470523">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470529">}</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470534">//&nbsp;Easy&nbsp;case:&nbsp;two&nbsp;hex&nbsp;digits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470566">x</span>&nbsp;<span class="op" id="3470568">:=</span>&nbsp;<span class="ident" id="3470571">unhex</span><span class="op" id="3470576">(</span><span class="ident" id="3470577">c</span><span class="op" id="3470578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470582">if</span>&nbsp;<span class="ident" id="3470585">c</span><span class="op" id="3470586">,</span>&nbsp;<span class="ident" id="3470588">t</span><span class="op" id="3470589">,</span>&nbsp;<span class="ident" id="3470591">err</span>&nbsp;<span class="op" id="3470595">=</span>&nbsp;<span class="ident" id="3470597">nextRune</span><span class="op" id="3470605">(</span><span class="ident" id="3470606">t</span><span class="op" id="3470607">)</span><span class="op" id="3470608">;</span>&nbsp;<span class="ident" id="3470610">err</span>&nbsp;<span class="op" id="3470614">!=</span>&nbsp;<span class="ident" id="3470617">nil</span>&nbsp;<span class="op" id="3470621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470626">return</span>&nbsp;<span class="num" id="3470633">0</span><span class="op" id="3470634">,</span>&nbsp;<span class="string" id="3470636">&#34;&#34;</span><span class="op" id="3470638">,</span>&nbsp;<span class="ident" id="3470640">err</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470650">y</span>&nbsp;<span class="op" id="3470652">:=</span>&nbsp;<span class="ident" id="3470655">unhex</span><span class="op" id="3470660">(</span><span class="ident" id="3470661">c</span><span class="op" id="3470662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470666">if</span>&nbsp;<span class="ident" id="3470669">x</span>&nbsp;<span class="op" id="3470671">&lt;</span>&nbsp;<span class="num" id="3470673">0</span>&nbsp;<span class="op" id="3470675">||</span>&nbsp;<span class="ident" id="3470678">y</span>&nbsp;<span class="op" id="3470680">&lt;</span>&nbsp;<span class="num" id="3470682">0</span>&nbsp;<span class="op" id="3470684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470689">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470697">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470701">return</span>&nbsp;<span class="ident" id="3470708">x</span><span class="op" id="3470709">*</span><span class="num" id="3470710">16</span>&nbsp;<span class="op" id="3470713">+</span>&nbsp;<span class="ident" id="3470715">y</span><span class="op" id="3470716">,</span>&nbsp;<span class="ident" id="3470718">t</span><span class="op" id="3470719">,</span>&nbsp;<span class="ident" id="3470721">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470727">//&nbsp;C&nbsp;escapes.&nbsp;&nbsp;There&nbsp;is&nbsp;no&nbsp;case&nbsp;&#39;b&#39;,&nbsp;to&nbsp;avoid&nbsp;misparsing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470785">//&nbsp;the&nbsp;Perl&nbsp;word-boundary&nbsp;\b&nbsp;as&nbsp;the&nbsp;C&nbsp;backspace&nbsp;\b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470837">//&nbsp;when&nbsp;in&nbsp;POSIX&nbsp;mode.&nbsp;&nbsp;In&nbsp;Perl,&nbsp;/\b/&nbsp;means&nbsp;word-boundary</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470896">//&nbsp;but&nbsp;/[\b]/&nbsp;means&nbsp;backspace.&nbsp;&nbsp;We&nbsp;don&#39;t&nbsp;support&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470952">//&nbsp;If&nbsp;you&nbsp;want&nbsp;a&nbsp;backspace,&nbsp;embed&nbsp;a&nbsp;literal&nbsp;backspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3471007">//&nbsp;character&nbsp;or&nbsp;use&nbsp;\x08.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471034">case</span>&nbsp;<span class="string" id="3471039">&#39;a&#39;</span><span class="op" id="3471042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471046">return</span>&nbsp;<span class="string" id="3471053">&#39;\a&#39;</span><span class="op" id="3471057">,</span>&nbsp;<span class="ident" id="3471059">t</span><span class="op" id="3471060">,</span>&nbsp;<span class="ident" id="3471062">err</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471067">case</span>&nbsp;<span class="string" id="3471072">&#39;f&#39;</span><span class="op" id="3471075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471079">return</span>&nbsp;<span class="string" id="3471086">&#39;\f&#39;</span><span class="op" id="3471090">,</span>&nbsp;<span class="ident" id="3471092">t</span><span class="op" id="3471093">,</span>&nbsp;<span class="ident" id="3471095">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471100">case</span>&nbsp;<span class="string" id="3471105">&#39;n&#39;</span><span class="op" id="3471108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471112">return</span>&nbsp;<span class="string" id="3471119">&#39;\n&#39;</span><span class="op" id="3471123">,</span>&nbsp;<span class="ident" id="3471125">t</span><span class="op" id="3471126">,</span>&nbsp;<span class="ident" id="3471128">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471133">case</span>&nbsp;<span class="string" id="3471138">&#39;r&#39;</span><span class="op" id="3471141">:</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471145">return</span>&nbsp;<span class="string" id="3471152">&#39;\r&#39;</span><span class="op" id="3471156">,</span>&nbsp;<span class="ident" id="3471158">t</span><span class="op" id="3471159">,</span>&nbsp;<span class="ident" id="3471161">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471166">case</span>&nbsp;<span class="string" id="3471171">&#39;t&#39;</span><span class="op" id="3471174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471178">return</span>&nbsp;<span class="string" id="3471185">&#39;\t&#39;</span><span class="op" id="3471189">,</span>&nbsp;<span class="ident" id="3471191">t</span><span class="op" id="3471192">,</span>&nbsp;<span class="ident" id="3471194">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471199">case</span>&nbsp;<span class="string" id="3471204">&#39;v&#39;</span><span class="op" id="3471207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471211">return</span>&nbsp;<span class="string" id="3471218">&#39;\v&#39;</span><span class="op" id="3471222">,</span>&nbsp;<span class="ident" id="3471224">t</span><span class="op" id="3471225">,</span>&nbsp;<span class="ident" id="3471227">err</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471235">return</span>&nbsp;<span class="num" id="3471242">0</span><span class="op" id="3471243">,</span>&nbsp;<span class="string" id="3471245">&#34;&#34;</span><span class="op" id="3471247">,</span>&nbsp;<span class="op" id="3471249">&amp;</span><span class="ident" id="3471250">Error</span><span class="op" id="3471255">{</span><span class="ident" id="3471256">ErrInvalidEscape</span><span class="op" id="3471272">,</span>&nbsp;<span class="ident" id="3471274">s</span><span class="op" id="3471275">[</span><span class="op" id="3471276">:</span><span class="builtinfunc" id="3471277">len</span><span class="op" id="3471280">(</span><span class="ident" id="3471281">s</span><span class="op" id="3471282">)</span><span class="op" id="3471283">-</span><span class="builtinfunc" id="3471284">len</span><span class="op" id="3471287">(</span><span class="ident" id="3471288">t</span><span class="op" id="3471289">)</span><span class="op" id="3471290">]</span><span class="op" id="3471291">}</span><br>
<span class="lineno"></span><span class="op" id="3471293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3471296">//&nbsp;parseClassChar&nbsp;parses&nbsp;a&nbsp;character&nbsp;class&nbsp;character&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno">1345</span><span class="comment" id="3471371">//&nbsp;and&nbsp;returns&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3471390">func</span>&nbsp;<span class="op" id="3471395">(</span><span class="ident" id="3471396">p</span>&nbsp;<span class="op" id="3471398">*</span><span class="ident" id="3471399">parser</span><span class="op" id="3471405">)</span>&nbsp;<span class="ident" id="3471407">parseClassChar</span><span class="op" id="3471421">(</span><span class="ident" id="3471422">s</span><span class="op" id="3471423">,</span>&nbsp;<span class="ident" id="3471425">wholeClass</span>&nbsp;<span class="builtintype" id="3471436">string</span><span class="op" id="3471442">)</span>&nbsp;<span class="op" id="3471444">(</span><span class="ident" id="3471445">r</span>&nbsp;<span class="builtintype" id="3471447">rune</span><span class="op" id="3471451">,</span>&nbsp;<span class="ident" id="3471453">rest</span>&nbsp;<span class="builtintype" id="3471458">string</span><span class="op" id="3471464">,</span>&nbsp;<span class="ident" id="3471466">err</span>&nbsp;<span class="builtintype" id="3471470">error</span><span class="op" id="3471475">)</span>&nbsp;<span class="op" id="3471477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471480">if</span>&nbsp;<span class="ident" id="3471483">s</span>&nbsp;<span class="op" id="3471485">==</span>&nbsp;<span class="string" id="3471488">&#34;&#34;</span>&nbsp;<span class="op" id="3471491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471495">return</span>&nbsp;<span class="num" id="3471502">0</span><span class="op" id="3471503">,</span>&nbsp;<span class="string" id="3471505">&#34;&#34;</span><span class="op" id="3471507">,</span>&nbsp;<span class="op" id="3471509">&amp;</span><span class="ident" id="3471510">Error</span><span class="op" id="3471515">{</span><span class="ident" id="3471516">Code</span><span class="op" id="3471520">:</span>&nbsp;<span class="ident" id="3471522">ErrMissingBracket</span><span class="op" id="3471539">,</span>&nbsp;<span class="ident" id="3471541">Expr</span><span class="op" id="3471545">:</span>&nbsp;<span class="ident" id="3471547">wholeClass</span><span class="op" id="3471557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471560">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3471564">//&nbsp;Allow&nbsp;regular&nbsp;escape&nbsp;sequences&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3471611">//&nbsp;many&nbsp;need&nbsp;not&nbsp;be&nbsp;escaped&nbsp;in&nbsp;this&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471657">if</span>&nbsp;<span class="ident" id="3471660">s</span><span class="op" id="3471661">[</span><span class="num" id="3471662">0</span><span class="op" id="3471663">]</span>&nbsp;<span class="op" id="3471665">==</span>&nbsp;<span class="string" id="3471668">&#39;\\&#39;</span>&nbsp;<span class="op" id="3471673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471677">return</span>&nbsp;<span class="ident" id="3471684">p</span><span class="op" id="3471685">.</span><span class="ident" id="3471686">parseEscape</span><span class="op" id="3471697">(</span><span class="ident" id="3471698">s</span><span class="op" id="3471699">)</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471706">return</span>&nbsp;<span class="ident" id="3471713">nextRune</span><span class="op" id="3471721">(</span><span class="ident" id="3471722">s</span><span class="op" id="3471723">)</span><br>
<span class="lineno"></span><span class="op" id="3471725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1360</span><span class="keyword" id="3471728">type</span>&nbsp;<span class="ident" id="3471733">charGroup</span>&nbsp;<span class="keyword" id="3471743">struct</span>&nbsp;<span class="op" id="3471750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471753">sign</span>&nbsp;&nbsp;<span class="builtintype" id="3471759">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471764">class</span>&nbsp;<span class="op" id="3471770">[</span><span class="op" id="3471771">]</span><span class="builtintype" id="3471772">rune</span><br>
<span class="lineno"></span><span class="op" id="3471777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1365</span><span class="comment" id="3471780">//&nbsp;parsePerlClassEscape&nbsp;parses&nbsp;a&nbsp;leading&nbsp;Perl&nbsp;character&nbsp;class&nbsp;escape&nbsp;like&nbsp;\d</span><br>
<span class="lineno"></span><span class="comment" id="3471857">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="3471936">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3472000">func</span>&nbsp;<span class="op" id="3472005">(</span><span class="ident" id="3472006">p</span>&nbsp;<span class="op" id="3472008">*</span><span class="ident" id="3472009">parser</span><span class="op" id="3472015">)</span>&nbsp;<span class="ident" id="3472017">parsePerlClassEscape</span><span class="op" id="3472037">(</span><span class="ident" id="3472038">s</span>&nbsp;<span class="builtintype" id="3472040">string</span><span class="op" id="3472046">,</span>&nbsp;<span class="ident" id="3472048">r</span>&nbsp;<span class="op" id="3472050">[</span><span class="op" id="3472051">]</span><span class="builtintype" id="3472052">rune</span><span class="op" id="3472056">)</span>&nbsp;<span class="op" id="3472058">(</span><span class="ident" id="3472059">out</span>&nbsp;<span class="op" id="3472063">[</span><span class="op" id="3472064">]</span><span class="builtintype" id="3472065">rune</span><span class="op" id="3472069">,</span>&nbsp;<span class="ident" id="3472071">rest</span>&nbsp;<span class="builtintype" id="3472076">string</span><span class="op" id="3472082">)</span>&nbsp;<span class="op" id="3472084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472087">if</span>&nbsp;<span class="ident" id="3472090">p</span><span class="op" id="3472091">.</span><span class="ident" id="3472092">flags</span><span class="op" id="3472097">&amp;</span><span class="ident" id="3472098">PerlX</span>&nbsp;<span class="op" id="3472104">==</span>&nbsp;<span class="num" id="3472107">0</span>&nbsp;<span class="op" id="3472109">||</span>&nbsp;<span class="builtinfunc" id="3472112">len</span><span class="op" id="3472115">(</span><span class="ident" id="3472116">s</span><span class="op" id="3472117">)</span>&nbsp;<span class="op" id="3472119">&lt;</span>&nbsp;<span class="num" id="3472121">2</span>&nbsp;<span class="op" id="3472123">||</span>&nbsp;<span class="ident" id="3472126">s</span><span class="op" id="3472127">[</span><span class="num" id="3472128">0</span><span class="op" id="3472129">]</span>&nbsp;<span class="op" id="3472131">!=</span>&nbsp;<span class="string" id="3472134">&#39;\\&#39;</span>&nbsp;<span class="op" id="3472139">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472143">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472154">g</span>&nbsp;<span class="op" id="3472156">:=</span>&nbsp;<span class="ident" id="3472159">perlGroup</span><span class="op" id="3472168">[</span><span class="ident" id="3472169">s</span><span class="op" id="3472170">[</span><span class="num" id="3472171">0</span><span class="op" id="3472172">:</span><span class="num" id="3472173">2</span><span class="op" id="3472174">]</span><span class="op" id="3472175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472178">if</span>&nbsp;<span class="ident" id="3472181">g</span><span class="op" id="3472182">.</span><span class="ident" id="3472183">sign</span>&nbsp;<span class="op" id="3472188">==</span>&nbsp;<span class="num" id="3472191">0</span>&nbsp;<span class="op" id="3472193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472197">return</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472208">return</span>&nbsp;<span class="ident" id="3472215">p</span><span class="op" id="3472216">.</span><span class="ident" id="3472217">appendGroup</span><span class="op" id="3472228">(</span><span class="ident" id="3472229">r</span><span class="op" id="3472230">,</span>&nbsp;<span class="ident" id="3472232">g</span><span class="op" id="3472233">)</span><span class="op" id="3472234">,</span>&nbsp;<span class="ident" id="3472236">s</span><span class="op" id="3472237">[</span><span class="num" id="3472238">2</span><span class="op" id="3472239">:</span><span class="op" id="3472240">]</span><br>
<span class="lineno"></span><span class="op" id="3472242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3472245">//&nbsp;parseNamedClass&nbsp;parses&nbsp;a&nbsp;leading&nbsp;POSIX&nbsp;named&nbsp;character&nbsp;class&nbsp;like&nbsp;[:alnum:]</span><br>
<span class="lineno">1380</span><span class="comment" id="3472324">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="3472403">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3472467">func</span>&nbsp;<span class="op" id="3472472">(</span><span class="ident" id="3472473">p</span>&nbsp;<span class="op" id="3472475">*</span><span class="ident" id="3472476">parser</span><span class="op" id="3472482">)</span>&nbsp;<span class="ident" id="3472484">parseNamedClass</span><span class="op" id="3472499">(</span><span class="ident" id="3472500">s</span>&nbsp;<span class="builtintype" id="3472502">string</span><span class="op" id="3472508">,</span>&nbsp;<span class="ident" id="3472510">r</span>&nbsp;<span class="op" id="3472512">[</span><span class="op" id="3472513">]</span><span class="builtintype" id="3472514">rune</span><span class="op" id="3472518">)</span>&nbsp;<span class="op" id="3472520">(</span><span class="ident" id="3472521">out</span>&nbsp;<span class="op" id="3472525">[</span><span class="op" id="3472526">]</span><span class="builtintype" id="3472527">rune</span><span class="op" id="3472531">,</span>&nbsp;<span class="ident" id="3472533">rest</span>&nbsp;<span class="builtintype" id="3472538">string</span><span class="op" id="3472544">,</span>&nbsp;<span class="ident" id="3472546">err</span>&nbsp;<span class="builtintype" id="3472550">error</span><span class="op" id="3472555">)</span>&nbsp;<span class="op" id="3472557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472560">if</span>&nbsp;<span class="builtinfunc" id="3472563">len</span><span class="op" id="3472566">(</span><span class="ident" id="3472567">s</span><span class="op" id="3472568">)</span>&nbsp;<span class="op" id="3472570">&lt;</span>&nbsp;<span class="num" id="3472572">2</span>&nbsp;<span class="op" id="3472574">||</span>&nbsp;<span class="ident" id="3472577">s</span><span class="op" id="3472578">[</span><span class="num" id="3472579">0</span><span class="op" id="3472580">]</span>&nbsp;<span class="op" id="3472582">!=</span>&nbsp;<span class="string" id="3472585">&#39;[&#39;</span>&nbsp;<span class="op" id="3472589">||</span>&nbsp;<span class="ident" id="3472592">s</span><span class="op" id="3472593">[</span><span class="num" id="3472594">1</span><span class="op" id="3472595">]</span>&nbsp;<span class="op" id="3472597">!=</span>&nbsp;<span class="string" id="3472600">&#39;:&#39;</span>&nbsp;<span class="op" id="3472604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472608">return</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472620">i</span>&nbsp;<span class="op" id="3472622">:=</span>&nbsp;<span class="ident" id="3472625">strings</span><span class="op" id="3472632">.</span><span class="ident" id="3472633">Index</span><span class="op" id="3472638">(</span><span class="ident" id="3472639">s</span><span class="op" id="3472640">[</span><span class="num" id="3472641">2</span><span class="op" id="3472642">:</span><span class="op" id="3472643">]</span><span class="op" id="3472644">,</span>&nbsp;<span class="string" id="3472646">&#34;:]&#34;</span><span class="op" id="3472650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472653">if</span>&nbsp;<span class="ident" id="3472656">i</span>&nbsp;<span class="op" id="3472658">&lt;</span>&nbsp;<span class="num" id="3472660">0</span>&nbsp;<span class="op" id="3472662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472666">return</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472677">i</span>&nbsp;<span class="op" id="3472679">+=</span>&nbsp;<span class="num" id="3472682">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472685">name</span><span class="op" id="3472689">,</span>&nbsp;<span class="ident" id="3472691">s</span>&nbsp;<span class="op" id="3472693">:=</span>&nbsp;<span class="ident" id="3472696">s</span><span class="op" id="3472697">[</span><span class="num" id="3472698">0</span><span class="op" id="3472699">:</span><span class="ident" id="3472700">i</span><span class="op" id="3472701">+</span><span class="num" id="3472702">2</span><span class="op" id="3472703">]</span><span class="op" id="3472704">,</span>&nbsp;<span class="ident" id="3472706">s</span><span class="op" id="3472707">[</span><span class="ident" id="3472708">i</span><span class="op" id="3472709">+</span><span class="num" id="3472710">2</span><span class="op" id="3472711">:</span><span class="op" id="3472712">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472715">g</span>&nbsp;<span class="op" id="3472717">:=</span>&nbsp;<span class="ident" id="3472720">posixGroup</span><span class="op" id="3472730">[</span><span class="ident" id="3472731">name</span><span class="op" id="3472735">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472738">if</span>&nbsp;<span class="ident" id="3472741">g</span><span class="op" id="3472742">.</span><span class="ident" id="3472743">sign</span>&nbsp;<span class="op" id="3472748">==</span>&nbsp;<span class="num" id="3472751">0</span>&nbsp;<span class="op" id="3472753">{</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472757">return</span>&nbsp;<span class="ident" id="3472764">nil</span><span class="op" id="3472767">,</span>&nbsp;<span class="string" id="3472769">&#34;&#34;</span><span class="op" id="3472771">,</span>&nbsp;<span class="op" id="3472773">&amp;</span><span class="ident" id="3472774">Error</span><span class="op" id="3472779">{</span><span class="ident" id="3472780">ErrInvalidCharRange</span><span class="op" id="3472799">,</span>&nbsp;<span class="ident" id="3472801">name</span><span class="op" id="3472805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472811">return</span>&nbsp;<span class="ident" id="3472818">p</span><span class="op" id="3472819">.</span><span class="ident" id="3472820">appendGroup</span><span class="op" id="3472831">(</span><span class="ident" id="3472832">r</span><span class="op" id="3472833">,</span>&nbsp;<span class="ident" id="3472835">g</span><span class="op" id="3472836">)</span><span class="op" id="3472837">,</span>&nbsp;<span class="ident" id="3472839">s</span><span class="op" id="3472840">,</span>&nbsp;<span class="ident" id="3472842">nil</span><br>
<span class="lineno"></span><span class="op" id="3472846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1400</span><span class="keyword" id="3472849">func</span>&nbsp;<span class="op" id="3472854">(</span><span class="ident" id="3472855">p</span>&nbsp;<span class="op" id="3472857">*</span><span class="ident" id="3472858">parser</span><span class="op" id="3472864">)</span>&nbsp;<span class="ident" id="3472866">appendGroup</span><span class="op" id="3472877">(</span><span class="ident" id="3472878">r</span>&nbsp;<span class="op" id="3472880">[</span><span class="op" id="3472881">]</span><span class="builtintype" id="3472882">rune</span><span class="op" id="3472886">,</span>&nbsp;<span class="ident" id="3472888">g</span>&nbsp;<span class="ident" id="3472890">charGroup</span><span class="op" id="3472899">)</span>&nbsp;<span class="op" id="3472901">[</span><span class="op" id="3472902">]</span><span class="builtintype" id="3472903">rune</span>&nbsp;<span class="op" id="3472908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472911">if</span>&nbsp;<span class="ident" id="3472914">p</span><span class="op" id="3472915">.</span><span class="ident" id="3472916">flags</span><span class="op" id="3472921">&amp;</span><span class="ident" id="3472922">FoldCase</span>&nbsp;<span class="op" id="3472931">==</span>&nbsp;<span class="num" id="3472934">0</span>&nbsp;<span class="op" id="3472936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472940">if</span>&nbsp;<span class="ident" id="3472943">g</span><span class="op" id="3472944">.</span><span class="ident" id="3472945">sign</span>&nbsp;<span class="op" id="3472950">&lt;</span>&nbsp;<span class="num" id="3472952">0</span>&nbsp;<span class="op" id="3472954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472959">r</span>&nbsp;<span class="op" id="3472961">=</span>&nbsp;<span class="ident" id="3472963">appendNegatedClass</span><span class="op" id="3472981">(</span><span class="ident" id="3472982">r</span><span class="op" id="3472983">,</span>&nbsp;<span class="ident" id="3472985">g</span><span class="op" id="3472986">.</span><span class="ident" id="3472987">class</span><span class="op" id="3472992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472996">}</span>&nbsp;<span class="keyword" id="3472998">else</span>&nbsp;<span class="op" id="3473003">{</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473008">r</span>&nbsp;<span class="op" id="3473010">=</span>&nbsp;<span class="ident" id="3473012">appendClass</span><span class="op" id="3473023">(</span><span class="ident" id="3473024">r</span><span class="op" id="3473025">,</span>&nbsp;<span class="ident" id="3473027">g</span><span class="op" id="3473028">.</span><span class="ident" id="3473029">class</span><span class="op" id="3473034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473041">}</span>&nbsp;<span class="keyword" id="3473043">else</span>&nbsp;<span class="op" id="3473048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473052">tmp</span>&nbsp;<span class="op" id="3473056">:=</span>&nbsp;<span class="ident" id="3473059">p</span><span class="op" id="3473060">.</span><span class="ident" id="3473061">tmpClass</span><span class="op" id="3473069">[</span><span class="op" id="3473070">:</span><span class="num" id="3473071">0</span><span class="op" id="3473072">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473076">tmp</span>&nbsp;<span class="op" id="3473080">=</span>&nbsp;<span class="ident" id="3473082">appendFoldedClass</span><span class="op" id="3473099">(</span><span class="ident" id="3473100">tmp</span><span class="op" id="3473103">,</span>&nbsp;<span class="ident" id="3473105">g</span><span class="op" id="3473106">.</span><span class="ident" id="3473107">class</span><span class="op" id="3473112">)</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473116">p</span><span class="op" id="3473117">.</span><span class="ident" id="3473118">tmpClass</span>&nbsp;<span class="op" id="3473127">=</span>&nbsp;<span class="ident" id="3473129">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473135">tmp</span>&nbsp;<span class="op" id="3473139">=</span>&nbsp;<span class="ident" id="3473141">cleanClass</span><span class="op" id="3473151">(</span><span class="op" id="3473152">&amp;</span><span class="ident" id="3473153">p</span><span class="op" id="3473154">.</span><span class="ident" id="3473155">tmpClass</span><span class="op" id="3473163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473167">if</span>&nbsp;<span class="ident" id="3473170">g</span><span class="op" id="3473171">.</span><span class="ident" id="3473172">sign</span>&nbsp;<span class="op" id="3473177">&lt;</span>&nbsp;<span class="num" id="3473179">0</span>&nbsp;<span class="op" id="3473181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473186">r</span>&nbsp;<span class="op" id="3473188">=</span>&nbsp;<span class="ident" id="3473190">appendNegatedClass</span><span class="op" id="3473208">(</span><span class="ident" id="3473209">r</span><span class="op" id="3473210">,</span>&nbsp;<span class="ident" id="3473212">tmp</span><span class="op" id="3473215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473219">}</span>&nbsp;<span class="keyword" id="3473221">else</span>&nbsp;<span class="op" id="3473226">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473231">r</span>&nbsp;<span class="op" id="3473233">=</span>&nbsp;<span class="ident" id="3473235">appendClass</span><span class="op" id="3473246">(</span><span class="ident" id="3473247">r</span><span class="op" id="3473248">,</span>&nbsp;<span class="ident" id="3473250">tmp</span><span class="op" id="3473253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473263">return</span>&nbsp;<span class="ident" id="3473270">r</span><br>
<span class="lineno"></span><span class="op" id="3473272">}</span><br>
<span class="lineno">1420</span><br>
<span class="lineno"></span><span class="keyword" id="3473275">var</span>&nbsp;<span class="ident" id="3473279">anyTable</span>&nbsp;<span class="op" id="3473288">=</span>&nbsp;<span class="op" id="3473290">&amp;</span><span class="ident" id="3473291">unicode</span><span class="op" id="3473298">.</span><span class="ident" id="3473299">RangeTable</span><span class="op" id="3473309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473312">R16</span><span class="op" id="3473315">:</span>&nbsp;<span class="op" id="3473317">[</span><span class="op" id="3473318">]</span><span class="ident" id="3473319">unicode</span><span class="op" id="3473326">.</span><span class="ident" id="3473327">Range16</span><span class="op" id="3473334">{</span><span class="op" id="3473335">{</span><span class="ident" id="3473336">Lo</span><span class="op" id="3473338">:</span>&nbsp;<span class="num" id="3473340">0</span><span class="op" id="3473341">,</span>&nbsp;<span class="ident" id="3473343">Hi</span><span class="op" id="3473345">:</span>&nbsp;<span class="num" id="3473347">1</span><span class="op" id="3473348">&lt;&lt;</span><span class="num" id="3473350">16</span>&nbsp;<span class="op" id="3473353">-</span>&nbsp;<span class="num" id="3473355">1</span><span class="op" id="3473356">,</span>&nbsp;<span class="ident" id="3473358">Stride</span><span class="op" id="3473364">:</span>&nbsp;<span class="num" id="3473366">1</span><span class="op" id="3473367">}</span><span class="op" id="3473368">}</span><span class="op" id="3473369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473372">R32</span><span class="op" id="3473375">:</span>&nbsp;<span class="op" id="3473377">[</span><span class="op" id="3473378">]</span><span class="ident" id="3473379">unicode</span><span class="op" id="3473386">.</span><span class="ident" id="3473387">Range32</span><span class="op" id="3473394">{</span><span class="op" id="3473395">{</span><span class="ident" id="3473396">Lo</span><span class="op" id="3473398">:</span>&nbsp;<span class="num" id="3473400">1</span>&nbsp;<span class="op" id="3473402">&lt;&lt;</span>&nbsp;<span class="num" id="3473405">16</span><span class="op" id="3473407">,</span>&nbsp;<span class="ident" id="3473409">Hi</span><span class="op" id="3473411">:</span>&nbsp;<span class="ident" id="3473413">unicode</span><span class="op" id="3473420">.</span><span class="ident" id="3473421">MaxRune</span><span class="op" id="3473428">,</span>&nbsp;<span class="ident" id="3473430">Stride</span><span class="op" id="3473436">:</span>&nbsp;<span class="num" id="3473438">1</span><span class="op" id="3473439">}</span><span class="op" id="3473440">}</span><span class="op" id="3473441">,</span><br>
<span class="lineno"></span><span class="op" id="3473443">}</span><br>
<span class="lineno">1425</span><br>
<span class="lineno"></span><span class="comment" id="3473446">//&nbsp;unicodeTable&nbsp;returns&nbsp;the&nbsp;unicode.RangeTable&nbsp;identified&nbsp;by&nbsp;name</span><br>
<span class="lineno"></span><span class="comment" id="3473512">//&nbsp;and&nbsp;the&nbsp;table&nbsp;of&nbsp;additional&nbsp;fold-equivalent&nbsp;code&nbsp;points.</span><br>
<span class="lineno"></span><span class="keyword" id="3473572">func</span>&nbsp;<span class="ident" id="3473577">unicodeTable</span><span class="op" id="3473589">(</span><span class="ident" id="3473590">name</span>&nbsp;<span class="builtintype" id="3473595">string</span><span class="op" id="3473601">)</span>&nbsp;<span class="op" id="3473603">(</span><span class="op" id="3473604">*</span><span class="ident" id="3473605">unicode</span><span class="op" id="3473612">.</span><span class="ident" id="3473613">RangeTable</span><span class="op" id="3473623">,</span>&nbsp;<span class="op" id="3473625">*</span><span class="ident" id="3473626">unicode</span><span class="op" id="3473633">.</span><span class="ident" id="3473634">RangeTable</span><span class="op" id="3473644">)</span>&nbsp;<span class="op" id="3473646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473649">//&nbsp;Special&nbsp;case:&nbsp;&#34;Any&#34;&nbsp;means&nbsp;any.</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473684">if</span>&nbsp;<span class="ident" id="3473687">name</span>&nbsp;<span class="op" id="3473692">==</span>&nbsp;<span class="string" id="3473695">&#34;Any&#34;</span>&nbsp;<span class="op" id="3473701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473705">return</span>&nbsp;<span class="ident" id="3473712">anyTable</span><span class="op" id="3473720">,</span>&nbsp;<span class="ident" id="3473722">anyTable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473735">if</span>&nbsp;<span class="ident" id="3473738">t</span>&nbsp;<span class="op" id="3473740">:=</span>&nbsp;<span class="ident" id="3473743">unicode</span><span class="op" id="3473750">.</span><span class="ident" id="3473751">Categories</span><span class="op" id="3473761">[</span><span class="ident" id="3473762">name</span><span class="op" id="3473766">]</span><span class="op" id="3473767">;</span>&nbsp;<span class="ident" id="3473769">t</span>&nbsp;<span class="op" id="3473771">!=</span>&nbsp;<span class="ident" id="3473774">nil</span>&nbsp;<span class="op" id="3473778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473782">return</span>&nbsp;<span class="ident" id="3473789">t</span><span class="op" id="3473790">,</span>&nbsp;<span class="ident" id="3473792">unicode</span><span class="op" id="3473799">.</span><span class="ident" id="3473800">FoldCategory</span><span class="op" id="3473812">[</span><span class="ident" id="3473813">name</span><span class="op" id="3473817">]</span><br>
<span class="lineno">1435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473823">if</span>&nbsp;<span class="ident" id="3473826">t</span>&nbsp;<span class="op" id="3473828">:=</span>&nbsp;<span class="ident" id="3473831">unicode</span><span class="op" id="3473838">.</span><span class="ident" id="3473839">Scripts</span><span class="op" id="3473846">[</span><span class="ident" id="3473847">name</span><span class="op" id="3473851">]</span><span class="op" id="3473852">;</span>&nbsp;<span class="ident" id="3473854">t</span>&nbsp;<span class="op" id="3473856">!=</span>&nbsp;<span class="ident" id="3473859">nil</span>&nbsp;<span class="op" id="3473863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473867">return</span>&nbsp;<span class="ident" id="3473874">t</span><span class="op" id="3473875">,</span>&nbsp;<span class="ident" id="3473877">unicode</span><span class="op" id="3473884">.</span><span class="ident" id="3473885">FoldScript</span><span class="op" id="3473895">[</span><span class="ident" id="3473896">name</span><span class="op" id="3473900">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473906">return</span>&nbsp;<span class="ident" id="3473913">nil</span><span class="op" id="3473916">,</span>&nbsp;<span class="ident" id="3473918">nil</span><br>
<span class="lineno">1440</span><span class="op" id="3473922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3473925">//&nbsp;parseUnicodeClass&nbsp;parses&nbsp;a&nbsp;leading&nbsp;Unicode&nbsp;character&nbsp;class&nbsp;like&nbsp;\p{Han}</span><br>
<span class="lineno"></span><span class="comment" id="3474000">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="3474079">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno">1445</span><span class="keyword" id="3474143">func</span>&nbsp;<span class="op" id="3474148">(</span><span class="ident" id="3474149">p</span>&nbsp;<span class="op" id="3474151">*</span><span class="ident" id="3474152">parser</span><span class="op" id="3474158">)</span>&nbsp;<span class="ident" id="3474160">parseUnicodeClass</span><span class="op" id="3474177">(</span><span class="ident" id="3474178">s</span>&nbsp;<span class="builtintype" id="3474180">string</span><span class="op" id="3474186">,</span>&nbsp;<span class="ident" id="3474188">r</span>&nbsp;<span class="op" id="3474190">[</span><span class="op" id="3474191">]</span><span class="builtintype" id="3474192">rune</span><span class="op" id="3474196">)</span>&nbsp;<span class="op" id="3474198">(</span><span class="ident" id="3474199">out</span>&nbsp;<span class="op" id="3474203">[</span><span class="op" id="3474204">]</span><span class="builtintype" id="3474205">rune</span><span class="op" id="3474209">,</span>&nbsp;<span class="ident" id="3474211">rest</span>&nbsp;<span class="builtintype" id="3474216">string</span><span class="op" id="3474222">,</span>&nbsp;<span class="ident" id="3474224">err</span>&nbsp;<span class="builtintype" id="3474228">error</span><span class="op" id="3474233">)</span>&nbsp;<span class="op" id="3474235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474238">if</span>&nbsp;<span class="ident" id="3474241">p</span><span class="op" id="3474242">.</span><span class="ident" id="3474243">flags</span><span class="op" id="3474248">&amp;</span><span class="ident" id="3474249">UnicodeGroups</span>&nbsp;<span class="op" id="3474263">==</span>&nbsp;<span class="num" id="3474266">0</span>&nbsp;<span class="op" id="3474268">||</span>&nbsp;<span class="builtinfunc" id="3474271">len</span><span class="op" id="3474274">(</span><span class="ident" id="3474275">s</span><span class="op" id="3474276">)</span>&nbsp;<span class="op" id="3474278">&lt;</span>&nbsp;<span class="num" id="3474280">2</span>&nbsp;<span class="op" id="3474282">||</span>&nbsp;<span class="ident" id="3474285">s</span><span class="op" id="3474286">[</span><span class="num" id="3474287">0</span><span class="op" id="3474288">]</span>&nbsp;<span class="op" id="3474290">!=</span>&nbsp;<span class="string" id="3474293">&#39;\\&#39;</span>&nbsp;<span class="op" id="3474298">||</span>&nbsp;<span class="ident" id="3474301">s</span><span class="op" id="3474302">[</span><span class="num" id="3474303">1</span><span class="op" id="3474304">]</span>&nbsp;<span class="op" id="3474306">!=</span>&nbsp;<span class="string" id="3474309">&#39;p&#39;</span>&nbsp;<span class="op" id="3474313">&amp;&amp;</span>&nbsp;<span class="ident" id="3474316">s</span><span class="op" id="3474317">[</span><span class="num" id="3474318">1</span><span class="op" id="3474319">]</span>&nbsp;<span class="op" id="3474321">!=</span>&nbsp;<span class="string" id="3474324">&#39;P&#39;</span>&nbsp;<span class="op" id="3474328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474332">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474344">//&nbsp;Committed&nbsp;to&nbsp;parse&nbsp;or&nbsp;return&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474384">sign</span>&nbsp;<span class="op" id="3474389">:=</span>&nbsp;<span class="op" id="3474392">+</span><span class="num" id="3474393">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474396">if</span>&nbsp;<span class="ident" id="3474399">s</span><span class="op" id="3474400">[</span><span class="num" id="3474401">1</span><span class="op" id="3474402">]</span>&nbsp;<span class="op" id="3474404">==</span>&nbsp;<span class="string" id="3474407">&#39;P&#39;</span>&nbsp;<span class="op" id="3474411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474415">sign</span>&nbsp;<span class="op" id="3474420">=</span>&nbsp;<span class="op" id="3474422">-</span><span class="num" id="3474423">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474426">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474429">t</span>&nbsp;<span class="op" id="3474431">:=</span>&nbsp;<span class="ident" id="3474434">s</span><span class="op" id="3474435">[</span><span class="num" id="3474436">2</span><span class="op" id="3474437">:</span><span class="op" id="3474438">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474441">c</span><span class="op" id="3474442">,</span>&nbsp;<span class="ident" id="3474444">t</span><span class="op" id="3474445">,</span>&nbsp;<span class="ident" id="3474447">err</span>&nbsp;<span class="op" id="3474451">:=</span>&nbsp;<span class="ident" id="3474454">nextRune</span><span class="op" id="3474462">(</span><span class="ident" id="3474463">t</span><span class="op" id="3474464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474467">if</span>&nbsp;<span class="ident" id="3474470">err</span>&nbsp;<span class="op" id="3474474">!=</span>&nbsp;<span class="ident" id="3474477">nil</span>&nbsp;<span class="op" id="3474481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474485">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474493">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474496">var</span>&nbsp;<span class="ident" id="3474500">seq</span><span class="op" id="3474503">,</span>&nbsp;<span class="ident" id="3474505">name</span>&nbsp;<span class="builtintype" id="3474510">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474518">if</span>&nbsp;<span class="ident" id="3474521">c</span>&nbsp;<span class="op" id="3474523">!=</span>&nbsp;<span class="string" id="3474526">&#39;{&#39;</span>&nbsp;<span class="op" id="3474530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474534">//&nbsp;Single-letter&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474559">seq</span>&nbsp;<span class="op" id="3474563">=</span>&nbsp;<span class="ident" id="3474565">s</span><span class="op" id="3474566">[</span><span class="op" id="3474567">:</span><span class="builtinfunc" id="3474568">len</span><span class="op" id="3474571">(</span><span class="ident" id="3474572">s</span><span class="op" id="3474573">)</span><span class="op" id="3474574">-</span><span class="builtinfunc" id="3474575">len</span><span class="op" id="3474578">(</span><span class="ident" id="3474579">t</span><span class="op" id="3474580">)</span><span class="op" id="3474581">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474585">name</span>&nbsp;<span class="op" id="3474590">=</span>&nbsp;<span class="ident" id="3474592">seq</span><span class="op" id="3474595">[</span><span class="num" id="3474596">2</span><span class="op" id="3474597">:</span><span class="op" id="3474598">]</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474601">}</span>&nbsp;<span class="keyword" id="3474603">else</span>&nbsp;<span class="op" id="3474608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474612">//&nbsp;Name&nbsp;is&nbsp;in&nbsp;braces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474636">end</span>&nbsp;<span class="op" id="3474640">:=</span>&nbsp;<span class="ident" id="3474643">strings</span><span class="op" id="3474650">.</span><span class="ident" id="3474651">IndexRune</span><span class="op" id="3474660">(</span><span class="ident" id="3474661">s</span><span class="op" id="3474662">,</span>&nbsp;<span class="string" id="3474664">&#39;}&#39;</span><span class="op" id="3474667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474671">if</span>&nbsp;<span class="ident" id="3474674">end</span>&nbsp;<span class="op" id="3474678">&lt;</span>&nbsp;<span class="num" id="3474680">0</span>&nbsp;<span class="op" id="3474682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474687">if</span>&nbsp;<span class="ident" id="3474690">err</span>&nbsp;<span class="op" id="3474694">=</span>&nbsp;<span class="ident" id="3474696">checkUTF8</span><span class="op" id="3474705">(</span><span class="ident" id="3474706">s</span><span class="op" id="3474707">)</span><span class="op" id="3474708">;</span>&nbsp;<span class="ident" id="3474710">err</span>&nbsp;<span class="op" id="3474714">!=</span>&nbsp;<span class="ident" id="3474717">nil</span>&nbsp;<span class="op" id="3474721">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474742">return</span>&nbsp;<span class="ident" id="3474749">nil</span><span class="op" id="3474752">,</span>&nbsp;<span class="string" id="3474754">&#34;&#34;</span><span class="op" id="3474756">,</span>&nbsp;<span class="op" id="3474758">&amp;</span><span class="ident" id="3474759">Error</span><span class="op" id="3474764">{</span><span class="ident" id="3474765">ErrInvalidCharRange</span><span class="op" id="3474784">,</span>&nbsp;<span class="ident" id="3474786">s</span><span class="op" id="3474787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474795">seq</span><span class="op" id="3474798">,</span>&nbsp;<span class="ident" id="3474800">t</span>&nbsp;<span class="op" id="3474802">=</span>&nbsp;<span class="ident" id="3474804">s</span><span class="op" id="3474805">[</span><span class="op" id="3474806">:</span><span class="ident" id="3474807">end</span><span class="op" id="3474810">+</span><span class="num" id="3474811">1</span><span class="op" id="3474812">]</span><span class="op" id="3474813">,</span>&nbsp;<span class="ident" id="3474815">s</span><span class="op" id="3474816">[</span><span class="ident" id="3474817">end</span><span class="op" id="3474820">+</span><span class="num" id="3474821">1</span><span class="op" id="3474822">:</span><span class="op" id="3474823">]</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474827">name</span>&nbsp;<span class="op" id="3474832">=</span>&nbsp;<span class="ident" id="3474834">s</span><span class="op" id="3474835">[</span><span class="num" id="3474836">3</span><span class="op" id="3474837">:</span><span class="ident" id="3474838">end</span><span class="op" id="3474841">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474845">if</span>&nbsp;<span class="ident" id="3474848">err</span>&nbsp;<span class="op" id="3474852">=</span>&nbsp;<span class="ident" id="3474854">checkUTF8</span><span class="op" id="3474863">(</span><span class="ident" id="3474864">name</span><span class="op" id="3474868">)</span><span class="op" id="3474869">;</span>&nbsp;<span class="ident" id="3474871">err</span>&nbsp;<span class="op" id="3474875">!=</span>&nbsp;<span class="ident" id="3474878">nil</span>&nbsp;<span class="op" id="3474882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474887">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474899">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474903">//&nbsp;Group&nbsp;can&nbsp;have&nbsp;leading&nbsp;negation&nbsp;too.&nbsp;&nbsp;\p{^Han}&nbsp;==&nbsp;\P{Han},&nbsp;\P{^Han}&nbsp;==&nbsp;\p{Han}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474987">if</span>&nbsp;<span class="ident" id="3474990">name</span>&nbsp;<span class="op" id="3474995">!=</span>&nbsp;<span class="string" id="3474998">&#34;&#34;</span>&nbsp;<span class="op" id="3475001">&amp;&amp;</span>&nbsp;<span class="ident" id="3475004">name</span><span class="op" id="3475008">[</span><span class="num" id="3475009">0</span><span class="op" id="3475010">]</span>&nbsp;<span class="op" id="3475012">==</span>&nbsp;<span class="string" id="3475015">&#39;^&#39;</span>&nbsp;<span class="op" id="3475019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475023">sign</span>&nbsp;<span class="op" id="3475028">=</span>&nbsp;<span class="op" id="3475030">-</span><span class="ident" id="3475031">sign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475038">name</span>&nbsp;<span class="op" id="3475043">=</span>&nbsp;<span class="ident" id="3475045">name</span><span class="op" id="3475049">[</span><span class="num" id="3475050">1</span><span class="op" id="3475051">:</span><span class="op" id="3475052">]</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475059">tab</span><span class="op" id="3475062">,</span>&nbsp;<span class="ident" id="3475064">fold</span>&nbsp;<span class="op" id="3475069">:=</span>&nbsp;<span class="ident" id="3475072">unicodeTable</span><span class="op" id="3475084">(</span><span class="ident" id="3475085">name</span><span class="op" id="3475089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475092">if</span>&nbsp;<span class="ident" id="3475095">tab</span>&nbsp;<span class="op" id="3475099">==</span>&nbsp;<span class="ident" id="3475102">nil</span>&nbsp;<span class="op" id="3475106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475110">return</span>&nbsp;<span class="ident" id="3475117">nil</span><span class="op" id="3475120">,</span>&nbsp;<span class="string" id="3475122">&#34;&#34;</span><span class="op" id="3475124">,</span>&nbsp;<span class="op" id="3475126">&amp;</span><span class="ident" id="3475127">Error</span><span class="op" id="3475132">{</span><span class="ident" id="3475133">ErrInvalidCharRange</span><span class="op" id="3475152">,</span>&nbsp;<span class="ident" id="3475154">seq</span><span class="op" id="3475157">}</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475164">if</span>&nbsp;<span class="ident" id="3475167">p</span><span class="op" id="3475168">.</span><span class="ident" id="3475169">flags</span><span class="op" id="3475174">&amp;</span><span class="ident" id="3475175">FoldCase</span>&nbsp;<span class="op" id="3475184">==</span>&nbsp;<span class="num" id="3475187">0</span>&nbsp;<span class="op" id="3475189">||</span>&nbsp;<span class="ident" id="3475192">fold</span>&nbsp;<span class="op" id="3475197">==</span>&nbsp;<span class="ident" id="3475200">nil</span>&nbsp;<span class="op" id="3475204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475208">if</span>&nbsp;<span class="ident" id="3475211">sign</span>&nbsp;<span class="op" id="3475216">&gt;</span>&nbsp;<span class="num" id="3475218">0</span>&nbsp;<span class="op" id="3475220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475225">r</span>&nbsp;<span class="op" id="3475227">=</span>&nbsp;<span class="ident" id="3475229">appendTable</span><span class="op" id="3475240">(</span><span class="ident" id="3475241">r</span><span class="op" id="3475242">,</span>&nbsp;<span class="ident" id="3475244">tab</span><span class="op" id="3475247">)</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475251">}</span>&nbsp;<span class="keyword" id="3475253">else</span>&nbsp;<span class="op" id="3475258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475263">r</span>&nbsp;<span class="op" id="3475265">=</span>&nbsp;<span class="ident" id="3475267">appendNegatedTable</span><span class="op" id="3475285">(</span><span class="ident" id="3475286">r</span><span class="op" id="3475287">,</span>&nbsp;<span class="ident" id="3475289">tab</span><span class="op" id="3475292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475299">}</span>&nbsp;<span class="keyword" id="3475301">else</span>&nbsp;<span class="op" id="3475306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475310">//&nbsp;Merge&nbsp;and&nbsp;clean&nbsp;tab&nbsp;and&nbsp;fold&nbsp;in&nbsp;a&nbsp;temporary&nbsp;buffer.</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475367">//&nbsp;This&nbsp;is&nbsp;necessary&nbsp;for&nbsp;the&nbsp;negative&nbsp;case&nbsp;and&nbsp;just&nbsp;tidy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475426">//&nbsp;for&nbsp;the&nbsp;positive&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475454">tmp</span>&nbsp;<span class="op" id="3475458">:=</span>&nbsp;<span class="ident" id="3475461">p</span><span class="op" id="3475462">.</span><span class="ident" id="3475463">tmpClass</span><span class="op" id="3475471">[</span><span class="op" id="3475472">:</span><span class="num" id="3475473">0</span><span class="op" id="3475474">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475478">tmp</span>&nbsp;<span class="op" id="3475482">=</span>&nbsp;<span class="ident" id="3475484">appendTable</span><span class="op" id="3475495">(</span><span class="ident" id="3475496">tmp</span><span class="op" id="3475499">,</span>&nbsp;<span class="ident" id="3475501">tab</span><span class="op" id="3475504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475508">tmp</span>&nbsp;<span class="op" id="3475512">=</span>&nbsp;<span class="ident" id="3475514">appendTable</span><span class="op" id="3475525">(</span><span class="ident" id="3475526">tmp</span><span class="op" id="3475529">,</span>&nbsp;<span class="ident" id="3475531">fold</span><span class="op" id="3475535">)</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475539">p</span><span class="op" id="3475540">.</span><span class="ident" id="3475541">tmpClass</span>&nbsp;<span class="op" id="3475550">=</span>&nbsp;<span class="ident" id="3475552">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475558">tmp</span>&nbsp;<span class="op" id="3475562">=</span>&nbsp;<span class="ident" id="3475564">cleanClass</span><span class="op" id="3475574">(</span><span class="op" id="3475575">&amp;</span><span class="ident" id="3475576">p</span><span class="op" id="3475577">.</span><span class="ident" id="3475578">tmpClass</span><span class="op" id="3475586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475590">if</span>&nbsp;<span class="ident" id="3475593">sign</span>&nbsp;<span class="op" id="3475598">&gt;</span>&nbsp;<span class="num" id="3475600">0</span>&nbsp;<span class="op" id="3475602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475607">r</span>&nbsp;<span class="op" id="3475609">=</span>&nbsp;<span class="ident" id="3475611">appendClass</span><span class="op" id="3475622">(</span><span class="ident" id="3475623">r</span><span class="op" id="3475624">,</span>&nbsp;<span class="ident" id="3475626">tmp</span><span class="op" id="3475629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475633">}</span>&nbsp;<span class="keyword" id="3475635">else</span>&nbsp;<span class="op" id="3475640">{</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475645">r</span>&nbsp;<span class="op" id="3475647">=</span>&nbsp;<span class="ident" id="3475649">appendNegatedClass</span><span class="op" id="3475667">(</span><span class="ident" id="3475668">r</span><span class="op" id="3475669">,</span>&nbsp;<span class="ident" id="3475671">tmp</span><span class="op" id="3475674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475684">return</span>&nbsp;<span class="ident" id="3475691">r</span><span class="op" id="3475692">,</span>&nbsp;<span class="ident" id="3475694">t</span><span class="op" id="3475695">,</span>&nbsp;<span class="ident" id="3475697">nil</span><br>
<span class="lineno"></span><span class="op" id="3475701">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="3475704">//&nbsp;parseClass&nbsp;parses&nbsp;a&nbsp;character&nbsp;class&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno"></span><span class="comment" id="3475765">//&nbsp;and&nbsp;pushes&nbsp;it&nbsp;onto&nbsp;the&nbsp;parse&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="3475804">func</span>&nbsp;<span class="op" id="3475809">(</span><span class="ident" id="3475810">p</span>&nbsp;<span class="op" id="3475812">*</span><span class="ident" id="3475813">parser</span><span class="op" id="3475819">)</span>&nbsp;<span class="ident" id="3475821">parseClass</span><span class="op" id="3475831">(</span><span class="ident" id="3475832">s</span>&nbsp;<span class="builtintype" id="3475834">string</span><span class="op" id="3475840">)</span>&nbsp;<span class="op" id="3475842">(</span><span class="ident" id="3475843">rest</span>&nbsp;<span class="builtintype" id="3475848">string</span><span class="op" id="3475854">,</span>&nbsp;<span class="ident" id="3475856">err</span>&nbsp;<span class="builtintype" id="3475860">error</span><span class="op" id="3475865">)</span>&nbsp;<span class="op" id="3475867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475870">t</span>&nbsp;<span class="op" id="3475872">:=</span>&nbsp;<span class="ident" id="3475875">s</span><span class="op" id="3475876">[</span><span class="num" id="3475877">1</span><span class="op" id="3475878">:</span><span class="op" id="3475879">]</span>&nbsp;<span class="comment" id="3475881">//&nbsp;chop&nbsp;[</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475892">re</span>&nbsp;<span class="op" id="3475895">:=</span>&nbsp;<span class="ident" id="3475898">p</span><span class="op" id="3475899">.</span><span class="ident" id="3475900">newRegexp</span><span class="op" id="3475909">(</span><span class="ident" id="3475910">OpCharClass</span><span class="op" id="3475921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475924">re</span><span class="op" id="3475926">.</span><span class="ident" id="3475927">Flags</span>&nbsp;<span class="op" id="3475933">=</span>&nbsp;<span class="ident" id="3475935">p</span><span class="op" id="3475936">.</span><span class="ident" id="3475937">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475944">re</span><span class="op" id="3475946">.</span><span class="ident" id="3475947">Rune</span>&nbsp;<span class="op" id="3475952">=</span>&nbsp;<span class="ident" id="3475954">re</span><span class="op" id="3475956">.</span><span class="ident" id="3475957">Rune0</span><span class="op" id="3475962">[</span><span class="op" id="3475963">:</span><span class="num" id="3475964">0</span><span class="op" id="3475965">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475969">sign</span>&nbsp;<span class="op" id="3475974">:=</span>&nbsp;<span class="op" id="3475977">+</span><span class="num" id="3475978">1</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475981">if</span>&nbsp;<span class="ident" id="3475984">t</span>&nbsp;<span class="op" id="3475986">!=</span>&nbsp;<span class="string" id="3475989">&#34;&#34;</span>&nbsp;<span class="op" id="3475992">&amp;&amp;</span>&nbsp;<span class="ident" id="3475995">t</span><span class="op" id="3475996">[</span><span class="num" id="3475997">0</span><span class="op" id="3475998">]</span>&nbsp;<span class="op" id="3476000">==</span>&nbsp;<span class="string" id="3476003">&#39;^&#39;</span>&nbsp;<span class="op" id="3476007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476011">sign</span>&nbsp;<span class="op" id="3476016">=</span>&nbsp;<span class="op" id="3476018">-</span><span class="num" id="3476019">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476023">t</span>&nbsp;<span class="op" id="3476025">=</span>&nbsp;<span class="ident" id="3476027">t</span><span class="op" id="3476028">[</span><span class="num" id="3476029">1</span><span class="op" id="3476030">:</span><span class="op" id="3476031">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476036">//&nbsp;If&nbsp;character&nbsp;class&nbsp;does&nbsp;not&nbsp;match&nbsp;\n,&nbsp;add&nbsp;it&nbsp;here,</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476092">//&nbsp;so&nbsp;that&nbsp;negation&nbsp;later&nbsp;will&nbsp;do&nbsp;the&nbsp;right&nbsp;thing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476145">if</span>&nbsp;<span class="ident" id="3476148">p</span><span class="op" id="3476149">.</span><span class="ident" id="3476150">flags</span><span class="op" id="3476155">&amp;</span><span class="ident" id="3476156">ClassNL</span>&nbsp;<span class="op" id="3476164">==</span>&nbsp;<span class="num" id="3476167">0</span>&nbsp;<span class="op" id="3476169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476174">re</span><span class="op" id="3476176">.</span><span class="ident" id="3476177">Rune</span>&nbsp;<span class="op" id="3476182">=</span>&nbsp;<span class="builtinfunc" id="3476184">append</span><span class="op" id="3476190">(</span><span class="ident" id="3476191">re</span><span class="op" id="3476193">.</span><span class="ident" id="3476194">Rune</span><span class="op" id="3476198">,</span>&nbsp;<span class="string" id="3476200">&#39;\n&#39;</span><span class="op" id="3476204">,</span>&nbsp;<span class="string" id="3476206">&#39;\n&#39;</span><span class="op" id="3476210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476217">}</span><br>
<span class="lineno">1535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476221">class</span>&nbsp;<span class="op" id="3476227">:=</span>&nbsp;<span class="ident" id="3476230">re</span><span class="op" id="3476232">.</span><span class="ident" id="3476233">Rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476239">first</span>&nbsp;<span class="op" id="3476245">:=</span>&nbsp;<span class="builtintype" id="3476248">true</span>&nbsp;<span class="comment" id="3476253">//&nbsp;]&nbsp;and&nbsp;-&nbsp;are&nbsp;okay&nbsp;as&nbsp;first&nbsp;char&nbsp;in&nbsp;class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476297">for</span>&nbsp;<span class="ident" id="3476301">t</span>&nbsp;<span class="op" id="3476303">==</span>&nbsp;<span class="string" id="3476306">&#34;&#34;</span>&nbsp;<span class="op" id="3476309">||</span>&nbsp;<span class="ident" id="3476312">t</span><span class="op" id="3476313">[</span><span class="num" id="3476314">0</span><span class="op" id="3476315">]</span>&nbsp;<span class="op" id="3476317">!=</span>&nbsp;<span class="string" id="3476320">&#39;]&#39;</span>&nbsp;<span class="op" id="3476324">||</span>&nbsp;<span class="ident" id="3476327">first</span>&nbsp;<span class="op" id="3476333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476337">//&nbsp;POSIX:&nbsp;-&nbsp;is&nbsp;only&nbsp;okay&nbsp;unescaped&nbsp;as&nbsp;first&nbsp;or&nbsp;last&nbsp;in&nbsp;class.</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476401">//&nbsp;Perl:&nbsp;-&nbsp;is&nbsp;okay&nbsp;anywhere.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476432">if</span>&nbsp;<span class="ident" id="3476435">t</span>&nbsp;<span class="op" id="3476437">!=</span>&nbsp;<span class="string" id="3476440">&#34;&#34;</span>&nbsp;<span class="op" id="3476443">&amp;&amp;</span>&nbsp;<span class="ident" id="3476446">t</span><span class="op" id="3476447">[</span><span class="num" id="3476448">0</span><span class="op" id="3476449">]</span>&nbsp;<span class="op" id="3476451">==</span>&nbsp;<span class="string" id="3476454">&#39;-&#39;</span>&nbsp;<span class="op" id="3476458">&amp;&amp;</span>&nbsp;<span class="ident" id="3476461">p</span><span class="op" id="3476462">.</span><span class="ident" id="3476463">flags</span><span class="op" id="3476468">&amp;</span><span class="ident" id="3476469">PerlX</span>&nbsp;<span class="op" id="3476475">==</span>&nbsp;<span class="num" id="3476478">0</span>&nbsp;<span class="op" id="3476480">&amp;&amp;</span>&nbsp;<span class="op" id="3476483">!</span><span class="ident" id="3476484">first</span>&nbsp;<span class="op" id="3476490">&amp;&amp;</span>&nbsp;<span class="op" id="3476493">(</span><span class="builtinfunc" id="3476494">len</span><span class="op" id="3476497">(</span><span class="ident" id="3476498">t</span><span class="op" id="3476499">)</span>&nbsp;<span class="op" id="3476501">==</span>&nbsp;<span class="num" id="3476504">1</span>&nbsp;<span class="op" id="3476506">||</span>&nbsp;<span class="ident" id="3476509">t</span><span class="op" id="3476510">[</span><span class="num" id="3476511">1</span><span class="op" id="3476512">]</span>&nbsp;<span class="op" id="3476514">!=</span>&nbsp;<span class="string" id="3476517">&#39;]&#39;</span><span class="op" id="3476520">)</span>&nbsp;<span class="op" id="3476522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476527">_</span><span class="op" id="3476528">,</span>&nbsp;<span class="ident" id="3476530">size</span>&nbsp;<span class="op" id="3476535">:=</span>&nbsp;<span class="ident" id="3476538">utf8</span><span class="op" id="3476542">.</span><span class="ident" id="3476543">DecodeRuneInString</span><span class="op" id="3476561">(</span><span class="ident" id="3476562">t</span><span class="op" id="3476563">[</span><span class="num" id="3476564">1</span><span class="op" id="3476565">:</span><span class="op" id="3476566">]</span><span class="op" id="3476567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476572">return</span>&nbsp;<span class="string" id="3476579">&#34;&#34;</span><span class="op" id="3476581">,</span>&nbsp;<span class="op" id="3476583">&amp;</span><span class="ident" id="3476584">Error</span><span class="op" id="3476589">{</span><span class="ident" id="3476590">Code</span><span class="op" id="3476594">:</span>&nbsp;<span class="ident" id="3476596">ErrInvalidCharRange</span><span class="op" id="3476615">,</span>&nbsp;<span class="ident" id="3476617">Expr</span><span class="op" id="3476621">:</span>&nbsp;<span class="ident" id="3476623">t</span><span class="op" id="3476624">[</span><span class="op" id="3476625">:</span><span class="num" id="3476626">1</span><span class="op" id="3476627">+</span><span class="ident" id="3476628">size</span><span class="op" id="3476632">]</span><span class="op" id="3476633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476637">}</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476641">first</span>&nbsp;<span class="op" id="3476647">=</span>&nbsp;<span class="builtintype" id="3476649">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476658">//&nbsp;Look&nbsp;for&nbsp;POSIX&nbsp;[:alnum:]&nbsp;etc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476693">if</span>&nbsp;<span class="builtinfunc" id="3476696">len</span><span class="op" id="3476699">(</span><span class="ident" id="3476700">t</span><span class="op" id="3476701">)</span>&nbsp;<span class="op" id="3476703">&gt;</span>&nbsp;<span class="num" id="3476705">2</span>&nbsp;<span class="op" id="3476707">&amp;&amp;</span>&nbsp;<span class="ident" id="3476710">t</span><span class="op" id="3476711">[</span><span class="num" id="3476712">0</span><span class="op" id="3476713">]</span>&nbsp;<span class="op" id="3476715">==</span>&nbsp;<span class="string" id="3476718">&#39;[&#39;</span>&nbsp;<span class="op" id="3476722">&amp;&amp;</span>&nbsp;<span class="ident" id="3476725">t</span><span class="op" id="3476726">[</span><span class="num" id="3476727">1</span><span class="op" id="3476728">]</span>&nbsp;<span class="op" id="3476730">==</span>&nbsp;<span class="string" id="3476733">&#39;:&#39;</span>&nbsp;<span class="op" id="3476737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476742">nclass</span><span class="op" id="3476748">,</span>&nbsp;<span class="ident" id="3476750">nt</span><span class="op" id="3476752">,</span>&nbsp;<span class="ident" id="3476754">err</span>&nbsp;<span class="op" id="3476758">:=</span>&nbsp;<span class="ident" id="3476761">p</span><span class="op" id="3476762">.</span><span class="ident" id="3476763">parseNamedClass</span><span class="op" id="3476778">(</span><span class="ident" id="3476779">t</span><span class="op" id="3476780">,</span>&nbsp;<span class="ident" id="3476782">class</span><span class="op" id="3476787">)</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476792">if</span>&nbsp;<span class="ident" id="3476795">err</span>&nbsp;<span class="op" id="3476799">!=</span>&nbsp;<span class="ident" id="3476802">nil</span>&nbsp;<span class="op" id="3476806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476812">return</span>&nbsp;<span class="string" id="3476819">&#34;&#34;</span><span class="op" id="3476821">,</span>&nbsp;<span class="ident" id="3476823">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476835">if</span>&nbsp;<span class="ident" id="3476838">nclass</span>&nbsp;<span class="op" id="3476845">!=</span>&nbsp;<span class="ident" id="3476848">nil</span>&nbsp;<span class="op" id="3476852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476858">class</span><span class="op" id="3476863">,</span>&nbsp;<span class="ident" id="3476865">t</span>&nbsp;<span class="op" id="3476867">=</span>&nbsp;<span class="ident" id="3476869">nclass</span><span class="op" id="3476875">,</span>&nbsp;<span class="ident" id="3476877">nt</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476884">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476905">//&nbsp;Look&nbsp;for&nbsp;Unicode&nbsp;character&nbsp;group&nbsp;like&nbsp;\p{Han}.</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476957">nclass</span><span class="op" id="3476963">,</span>&nbsp;<span class="ident" id="3476965">nt</span><span class="op" id="3476967">,</span>&nbsp;<span class="ident" id="3476969">err</span>&nbsp;<span class="op" id="3476973">:=</span>&nbsp;<span class="ident" id="3476976">p</span><span class="op" id="3476977">.</span><span class="ident" id="3476978">parseUnicodeClass</span><span class="op" id="3476995">(</span><span class="ident" id="3476996">t</span><span class="op" id="3476997">,</span>&nbsp;<span class="ident" id="3476999">class</span><span class="op" id="3477004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477008">if</span>&nbsp;<span class="ident" id="3477011">err</span>&nbsp;<span class="op" id="3477015">!=</span>&nbsp;<span class="ident" id="3477018">nil</span>&nbsp;<span class="op" id="3477022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477027">return</span>&nbsp;<span class="string" id="3477034">&#34;&#34;</span><span class="op" id="3477036">,</span>&nbsp;<span class="ident" id="3477038">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477048">if</span>&nbsp;<span class="ident" id="3477051">nclass</span>&nbsp;<span class="op" id="3477058">!=</span>&nbsp;<span class="ident" id="3477061">nil</span>&nbsp;<span class="op" id="3477065">{</span><br>
<span class="lineno">1565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477070">class</span><span class="op" id="3477075">,</span>&nbsp;<span class="ident" id="3477077">t</span>&nbsp;<span class="op" id="3477079">=</span>&nbsp;<span class="ident" id="3477081">nclass</span><span class="op" id="3477087">,</span>&nbsp;<span class="ident" id="3477089">nt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477095">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477111">//&nbsp;Look&nbsp;for&nbsp;Perl&nbsp;character&nbsp;class&nbsp;symbols&nbsp;(extension).</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477167">if</span>&nbsp;<span class="ident" id="3477170">nclass</span><span class="op" id="3477176">,</span>&nbsp;<span class="ident" id="3477178">nt</span>&nbsp;<span class="op" id="3477181">:=</span>&nbsp;<span class="ident" id="3477184">p</span><span class="op" id="3477185">.</span><span class="ident" id="3477186">parsePerlClassEscape</span><span class="op" id="3477206">(</span><span class="ident" id="3477207">t</span><span class="op" id="3477208">,</span>&nbsp;<span class="ident" id="3477210">class</span><span class="op" id="3477215">)</span><span class="op" id="3477216">;</span>&nbsp;<span class="ident" id="3477218">nclass</span>&nbsp;<span class="op" id="3477225">!=</span>&nbsp;<span class="ident" id="3477228">nil</span>&nbsp;<span class="op" id="3477232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477237">class</span><span class="op" id="3477242">,</span>&nbsp;<span class="ident" id="3477244">t</span>&nbsp;<span class="op" id="3477246">=</span>&nbsp;<span class="ident" id="3477248">nclass</span><span class="op" id="3477254">,</span>&nbsp;<span class="ident" id="3477256">nt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477262">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477278">//&nbsp;Single&nbsp;character&nbsp;or&nbsp;simple&nbsp;range.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477317">rng</span>&nbsp;<span class="op" id="3477321">:=</span>&nbsp;<span class="ident" id="3477324">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477328">var</span>&nbsp;<span class="ident" id="3477332">lo</span><span class="op" id="3477334">,</span>&nbsp;<span class="ident" id="3477336">hi</span>&nbsp;<span class="builtintype" id="3477339">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477346">if</span>&nbsp;<span class="ident" id="3477349">lo</span><span class="op" id="3477351">,</span>&nbsp;<span class="ident" id="3477353">t</span><span class="op" id="3477354">,</span>&nbsp;<span class="ident" id="3477356">err</span>&nbsp;<span class="op" id="3477360">=</span>&nbsp;<span class="ident" id="3477362">p</span><span class="op" id="3477363">.</span><span class="ident" id="3477364">parseClassChar</span><span class="op" id="3477378">(</span><span class="ident" id="3477379">t</span><span class="op" id="3477380">,</span>&nbsp;<span class="ident" id="3477382">s</span><span class="op" id="3477383">)</span><span class="op" id="3477384">;</span>&nbsp;<span class="ident" id="3477386">err</span>&nbsp;<span class="op" id="3477390">!=</span>&nbsp;<span class="ident" id="3477393">nil</span>&nbsp;<span class="op" id="3477397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477402">return</span>&nbsp;<span class="string" id="3477409">&#34;&#34;</span><span class="op" id="3477411">,</span>&nbsp;<span class="ident" id="3477413">err</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477423">hi</span>&nbsp;<span class="op" id="3477426">=</span>&nbsp;<span class="ident" id="3477428">lo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477433">//&nbsp;[a-]&nbsp;means&nbsp;(a|-)&nbsp;so&nbsp;check&nbsp;for&nbsp;final&nbsp;].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477477">if</span>&nbsp;<span class="builtinfunc" id="3477480">len</span><span class="op" id="3477483">(</span><span class="ident" id="3477484">t</span><span class="op" id="3477485">)</span>&nbsp;<span class="op" id="3477487">&gt;=</span>&nbsp;<span class="num" id="3477490">2</span>&nbsp;<span class="op" id="3477492">&amp;&amp;</span>&nbsp;<span class="ident" id="3477495">t</span><span class="op" id="3477496">[</span><span class="num" id="3477497">0</span><span class="op" id="3477498">]</span>&nbsp;<span class="op" id="3477500">==</span>&nbsp;<span class="string" id="3477503">&#39;-&#39;</span>&nbsp;<span class="op" id="3477507">&amp;&amp;</span>&nbsp;<span class="ident" id="3477510">t</span><span class="op" id="3477511">[</span><span class="num" id="3477512">1</span><span class="op" id="3477513">]</span>&nbsp;<span class="op" id="3477515">!=</span>&nbsp;<span class="string" id="3477518">&#39;]&#39;</span>&nbsp;<span class="op" id="3477522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477527">t</span>&nbsp;<span class="op" id="3477529">=</span>&nbsp;<span class="ident" id="3477531">t</span><span class="op" id="3477532">[</span><span class="num" id="3477533">1</span><span class="op" id="3477534">:</span><span class="op" id="3477535">]</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477540">if</span>&nbsp;<span class="ident" id="3477543">hi</span><span class="op" id="3477545">,</span>&nbsp;<span class="ident" id="3477547">t</span><span class="op" id="3477548">,</span>&nbsp;<span class="ident" id="3477550">err</span>&nbsp;<span class="op" id="3477554">=</span>&nbsp;<span class="ident" id="3477556">p</span><span class="op" id="3477557">.</span><span class="ident" id="3477558">parseClassChar</span><span class="op" id="3477572">(</span><span class="ident" id="3477573">t</span><span class="op" id="3477574">,</span>&nbsp;<span class="ident" id="3477576">s</span><span class="op" id="3477577">)</span><span class="op" id="3477578">;</span>&nbsp;<span class="ident" id="3477580">err</span>&nbsp;<span class="op" id="3477584">!=</span>&nbsp;<span class="ident" id="3477587">nil</span>&nbsp;<span class="op" id="3477591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477597">return</span>&nbsp;<span class="string" id="3477604">&#34;&#34;</span><span class="op" id="3477606">,</span>&nbsp;<span class="ident" id="3477608">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477620">if</span>&nbsp;<span class="ident" id="3477623">hi</span>&nbsp;<span class="op" id="3477626">&lt;</span>&nbsp;<span class="ident" id="3477628">lo</span>&nbsp;<span class="op" id="3477631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477637">rng</span>&nbsp;<span class="op" id="3477641">=</span>&nbsp;<span class="ident" id="3477643">rng</span><span class="op" id="3477646">[</span><span class="op" id="3477647">:</span><span class="builtinfunc" id="3477648">len</span><span class="op" id="3477651">(</span><span class="ident" id="3477652">rng</span><span class="op" id="3477655">)</span><span class="op" id="3477656">-</span><span class="builtinfunc" id="3477657">len</span><span class="op" id="3477660">(</span><span class="ident" id="3477661">t</span><span class="op" id="3477662">)</span><span class="op" id="3477663">]</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477669">return</span>&nbsp;<span class="string" id="3477676">&#34;&#34;</span><span class="op" id="3477678">,</span>&nbsp;<span class="op" id="3477680">&amp;</span><span class="ident" id="3477681">Error</span><span class="op" id="3477686">{</span><span class="ident" id="3477687">Code</span><span class="op" id="3477691">:</span>&nbsp;<span class="ident" id="3477693">ErrInvalidCharRange</span><span class="op" id="3477712">,</span>&nbsp;<span class="ident" id="3477714">Expr</span><span class="op" id="3477718">:</span>&nbsp;<span class="ident" id="3477720">rng</span><span class="op" id="3477723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477736">if</span>&nbsp;<span class="ident" id="3477739">p</span><span class="op" id="3477740">.</span><span class="ident" id="3477741">flags</span><span class="op" id="3477746">&amp;</span><span class="ident" id="3477747">FoldCase</span>&nbsp;<span class="op" id="3477756">==</span>&nbsp;<span class="num" id="3477759">0</span>&nbsp;<span class="op" id="3477761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477766">class</span>&nbsp;<span class="op" id="3477772">=</span>&nbsp;<span class="ident" id="3477774">appendRange</span><span class="op" id="3477785">(</span><span class="ident" id="3477786">class</span><span class="op" id="3477791">,</span>&nbsp;<span class="ident" id="3477793">lo</span><span class="op" id="3477795">,</span>&nbsp;<span class="ident" id="3477797">hi</span><span class="op" id="3477799">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477803">}</span>&nbsp;<span class="keyword" id="3477805">else</span>&nbsp;<span class="op" id="3477810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477815">class</span>&nbsp;<span class="op" id="3477821">=</span>&nbsp;<span class="ident" id="3477823">appendFoldedRange</span><span class="op" id="3477840">(</span><span class="ident" id="3477841">class</span><span class="op" id="3477846">,</span>&nbsp;<span class="ident" id="3477848">lo</span><span class="op" id="3477850">,</span>&nbsp;<span class="ident" id="3477852">hi</span><span class="op" id="3477854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477864">t</span>&nbsp;<span class="op" id="3477866">=</span>&nbsp;<span class="ident" id="3477868">t</span><span class="op" id="3477869">[</span><span class="num" id="3477870">1</span><span class="op" id="3477871">:</span><span class="op" id="3477872">]</span>&nbsp;<span class="comment" id="3477874">//&nbsp;chop&nbsp;]</span><br>
<span class="lineno">1600</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477886">//&nbsp;Use&nbsp;&amp;re.Rune&nbsp;instead&nbsp;of&nbsp;&amp;class&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477942">re</span><span class="op" id="3477944">.</span><span class="ident" id="3477945">Rune</span>&nbsp;<span class="op" id="3477950">=</span>&nbsp;<span class="ident" id="3477952">class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477959">class</span>&nbsp;<span class="op" id="3477965">=</span>&nbsp;<span class="ident" id="3477967">cleanClass</span><span class="op" id="3477977">(</span><span class="op" id="3477978">&amp;</span><span class="ident" id="3477979">re</span><span class="op" id="3477981">.</span><span class="ident" id="3477982">Rune</span><span class="op" id="3477986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477989">if</span>&nbsp;<span class="ident" id="3477992">sign</span>&nbsp;<span class="op" id="3477997">&lt;</span>&nbsp;<span class="num" id="3477999">0</span>&nbsp;<span class="op" id="3478001">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478005">class</span>&nbsp;<span class="op" id="3478011">=</span>&nbsp;<span class="ident" id="3478013">negateClass</span><span class="op" id="3478024">(</span><span class="ident" id="3478025">class</span><span class="op" id="3478030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478036">re</span><span class="op" id="3478038">.</span><span class="ident" id="3478039">Rune</span>&nbsp;<span class="op" id="3478044">=</span>&nbsp;<span class="ident" id="3478046">class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478053">p</span><span class="op" id="3478054">.</span><span class="ident" id="3478055">push</span><span class="op" id="3478059">(</span><span class="ident" id="3478060">re</span><span class="op" id="3478062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478065">return</span>&nbsp;<span class="ident" id="3478072">t</span><span class="op" id="3478073">,</span>&nbsp;<span class="ident" id="3478075">nil</span><br>
<span class="lineno">1610</span><span class="op" id="3478079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3478082">//&nbsp;cleanClass&nbsp;sorts&nbsp;the&nbsp;ranges&nbsp;(pairs&nbsp;of&nbsp;elements&nbsp;of&nbsp;r),</span><br>
<span class="lineno"></span><span class="comment" id="3478139">//&nbsp;merges&nbsp;them,&nbsp;and&nbsp;eliminates&nbsp;duplicates.</span><br>
<span class="lineno"></span><span class="keyword" id="3478182">func</span>&nbsp;<span class="ident" id="3478187">cleanClass</span><span class="op" id="3478197">(</span><span class="ident" id="3478198">rp</span>&nbsp;<span class="op" id="3478201">*</span><span class="op" id="3478202">[</span><span class="op" id="3478203">]</span><span class="builtintype" id="3478204">rune</span><span class="op" id="3478208">)</span>&nbsp;<span class="op" id="3478210">[</span><span class="op" id="3478211">]</span><span class="builtintype" id="3478212">rune</span>&nbsp;<span class="op" id="3478217">{</span><br>
<span class="lineno">1615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478221">//&nbsp;Sort&nbsp;by&nbsp;lo&nbsp;increasing,&nbsp;hi&nbsp;decreasing&nbsp;to&nbsp;break&nbsp;ties.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478277">sort</span><span class="op" id="3478281">.</span><span class="ident" id="3478282">Sort</span><span class="op" id="3478286">(</span><span class="ident" id="3478287">ranges</span><span class="op" id="3478293">{</span><span class="ident" id="3478294">rp</span><span class="op" id="3478296">}</span><span class="op" id="3478297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478301">r</span>&nbsp;<span class="op" id="3478303">:=</span>&nbsp;<span class="op" id="3478306">*</span><span class="ident" id="3478307">rp</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478311">if</span>&nbsp;<span class="builtinfunc" id="3478314">len</span><span class="op" id="3478317">(</span><span class="ident" id="3478318">r</span><span class="op" id="3478319">)</span>&nbsp;<span class="op" id="3478321">&lt;</span>&nbsp;<span class="num" id="3478323">2</span>&nbsp;<span class="op" id="3478325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478329">return</span>&nbsp;<span class="ident" id="3478336">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478343">//&nbsp;Merge&nbsp;abutting,&nbsp;overlapping.</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478376">w</span>&nbsp;<span class="op" id="3478378">:=</span>&nbsp;<span class="num" id="3478381">2</span>&nbsp;<span class="comment" id="3478383">//&nbsp;write&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478399">for</span>&nbsp;<span class="ident" id="3478403">i</span>&nbsp;<span class="op" id="3478405">:=</span>&nbsp;<span class="num" id="3478408">2</span><span class="op" id="3478409">;</span>&nbsp;<span class="ident" id="3478411">i</span>&nbsp;<span class="op" id="3478413">&lt;</span>&nbsp;<span class="builtinfunc" id="3478415">len</span><span class="op" id="3478418">(</span><span class="ident" id="3478419">r</span><span class="op" id="3478420">)</span><span class="op" id="3478421">;</span>&nbsp;<span class="ident" id="3478423">i</span>&nbsp;<span class="op" id="3478425">+=</span>&nbsp;<span class="num" id="3478428">2</span>&nbsp;<span class="op" id="3478430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478434">lo</span><span class="op" id="3478436">,</span>&nbsp;<span class="ident" id="3478438">hi</span>&nbsp;<span class="op" id="3478441">:=</span>&nbsp;<span class="ident" id="3478444">r</span><span class="op" id="3478445">[</span><span class="ident" id="3478446">i</span><span class="op" id="3478447">]</span><span class="op" id="3478448">,</span>&nbsp;<span class="ident" id="3478450">r</span><span class="op" id="3478451">[</span><span class="ident" id="3478452">i</span><span class="op" id="3478453">+</span><span class="num" id="3478454">1</span><span class="op" id="3478455">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478459">if</span>&nbsp;<span class="ident" id="3478462">lo</span>&nbsp;<span class="op" id="3478465">&lt;=</span>&nbsp;<span class="ident" id="3478468">r</span><span class="op" id="3478469">[</span><span class="ident" id="3478470">w</span><span class="op" id="3478471">-</span><span class="num" id="3478472">1</span><span class="op" id="3478473">]</span><span class="op" id="3478474">+</span><span class="num" id="3478475">1</span>&nbsp;<span class="op" id="3478477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478482">//&nbsp;merge&nbsp;with&nbsp;previous&nbsp;range</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478514">if</span>&nbsp;<span class="ident" id="3478517">hi</span>&nbsp;<span class="op" id="3478520">&gt;</span>&nbsp;<span class="ident" id="3478522">r</span><span class="op" id="3478523">[</span><span class="ident" id="3478524">w</span><span class="op" id="3478525">-</span><span class="num" id="3478526">1</span><span class="op" id="3478527">]</span>&nbsp;<span class="op" id="3478529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478535">r</span><span class="op" id="3478536">[</span><span class="ident" id="3478537">w</span><span class="op" id="3478538">-</span><span class="num" id="3478539">1</span><span class="op" id="3478540">]</span>&nbsp;<span class="op" id="3478542">=</span>&nbsp;<span class="ident" id="3478544">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478555">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478566">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478570">//&nbsp;new&nbsp;disjoint&nbsp;range</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478594">r</span><span class="op" id="3478595">[</span><span class="ident" id="3478596">w</span><span class="op" id="3478597">]</span>&nbsp;<span class="op" id="3478599">=</span>&nbsp;<span class="ident" id="3478601">lo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478606">r</span><span class="op" id="3478607">[</span><span class="ident" id="3478608">w</span><span class="op" id="3478609">+</span><span class="num" id="3478610">1</span><span class="op" id="3478611">]</span>&nbsp;<span class="op" id="3478613">=</span>&nbsp;<span class="ident" id="3478615">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478620">w</span>&nbsp;<span class="op" id="3478622">+=</span>&nbsp;<span class="num" id="3478625">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478628">}</span><br>
<span class="lineno">1640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478632">return</span>&nbsp;<span class="ident" id="3478639">r</span><span class="op" id="3478640">[</span><span class="op" id="3478641">:</span><span class="ident" id="3478642">w</span><span class="op" id="3478643">]</span><br>
<span class="lineno"></span><span class="op" id="3478645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3478648">//&nbsp;appendLiteral&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;literal&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno">1645</span><span class="keyword" id="3478727">func</span>&nbsp;<span class="ident" id="3478732">appendLiteral</span><span class="op" id="3478745">(</span><span class="ident" id="3478746">r</span>&nbsp;<span class="op" id="3478748">[</span><span class="op" id="3478749">]</span><span class="builtintype" id="3478750">rune</span><span class="op" id="3478754">,</span>&nbsp;<span class="ident" id="3478756">x</span>&nbsp;<span class="builtintype" id="3478758">rune</span><span class="op" id="3478762">,</span>&nbsp;<span class="ident" id="3478764">flags</span>&nbsp;<span class="ident" id="3478770">Flags</span><span class="op" id="3478775">)</span>&nbsp;<span class="op" id="3478777">[</span><span class="op" id="3478778">]</span><span class="builtintype" id="3478779">rune</span>&nbsp;<span class="op" id="3478784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478787">if</span>&nbsp;<span class="ident" id="3478790">flags</span><span class="op" id="3478795">&amp;</span><span class="ident" id="3478796">FoldCase</span>&nbsp;<span class="op" id="3478805">!=</span>&nbsp;<span class="num" id="3478808">0</span>&nbsp;<span class="op" id="3478810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478814">return</span>&nbsp;<span class="ident" id="3478821">appendFoldedRange</span><span class="op" id="3478838">(</span><span class="ident" id="3478839">r</span><span class="op" id="3478840">,</span>&nbsp;<span class="ident" id="3478842">x</span><span class="op" id="3478843">,</span>&nbsp;<span class="ident" id="3478845">x</span><span class="op" id="3478846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478852">return</span>&nbsp;<span class="ident" id="3478859">appendRange</span><span class="op" id="3478870">(</span><span class="ident" id="3478871">r</span><span class="op" id="3478872">,</span>&nbsp;<span class="ident" id="3478874">x</span><span class="op" id="3478875">,</span>&nbsp;<span class="ident" id="3478877">x</span><span class="op" id="3478878">)</span><br>
<span class="lineno">1650</span><span class="op" id="3478880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3478883">//&nbsp;appendRange&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;range&nbsp;lo-hi&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3478962">func</span>&nbsp;<span class="ident" id="3478967">appendRange</span><span class="op" id="3478978">(</span><span class="ident" id="3478979">r</span>&nbsp;<span class="op" id="3478981">[</span><span class="op" id="3478982">]</span><span class="builtintype" id="3478983">rune</span><span class="op" id="3478987">,</span>&nbsp;<span class="ident" id="3478989">lo</span><span class="op" id="3478991">,</span>&nbsp;<span class="ident" id="3478993">hi</span>&nbsp;<span class="builtintype" id="3478996">rune</span><span class="op" id="3479000">)</span>&nbsp;<span class="op" id="3479002">[</span><span class="op" id="3479003">]</span><span class="builtintype" id="3479004">rune</span>&nbsp;<span class="op" id="3479009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479012">//&nbsp;Expand&nbsp;last&nbsp;range&nbsp;or&nbsp;next&nbsp;to&nbsp;last&nbsp;range&nbsp;if&nbsp;it&nbsp;overlaps&nbsp;or&nbsp;abuts.</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479081">//&nbsp;Checking&nbsp;two&nbsp;ranges&nbsp;helps&nbsp;when&nbsp;appending&nbsp;case-folded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479138">//&nbsp;alphabets,&nbsp;so&nbsp;that&nbsp;one&nbsp;range&nbsp;can&nbsp;be&nbsp;expanding&nbsp;A-Z&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479200">//&nbsp;other&nbsp;expanding&nbsp;a-z.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479225">n</span>&nbsp;<span class="op" id="3479227">:=</span>&nbsp;<span class="builtinfunc" id="3479230">len</span><span class="op" id="3479233">(</span><span class="ident" id="3479234">r</span><span class="op" id="3479235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479238">for</span>&nbsp;<span class="ident" id="3479242">i</span>&nbsp;<span class="op" id="3479244">:=</span>&nbsp;<span class="num" id="3479247">2</span><span class="op" id="3479248">;</span>&nbsp;<span class="ident" id="3479250">i</span>&nbsp;<span class="op" id="3479252">&lt;=</span>&nbsp;<span class="num" id="3479255">4</span><span class="op" id="3479256">;</span>&nbsp;<span class="ident" id="3479258">i</span>&nbsp;<span class="op" id="3479260">+=</span>&nbsp;<span class="num" id="3479263">2</span>&nbsp;<span class="op" id="3479265">{</span>&nbsp;<span class="comment" id="3479267">//&nbsp;twice,&nbsp;using&nbsp;i=2,&nbsp;i=4</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479294">if</span>&nbsp;<span class="ident" id="3479297">n</span>&nbsp;<span class="op" id="3479299">&gt;=</span>&nbsp;<span class="ident" id="3479302">i</span>&nbsp;<span class="op" id="3479304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479309">rlo</span><span class="op" id="3479312">,</span>&nbsp;<span class="ident" id="3479314">rhi</span>&nbsp;<span class="op" id="3479318">:=</span>&nbsp;<span class="ident" id="3479321">r</span><span class="op" id="3479322">[</span><span class="ident" id="3479323">n</span><span class="op" id="3479324">-</span><span class="ident" id="3479325">i</span><span class="op" id="3479326">]</span><span class="op" id="3479327">,</span>&nbsp;<span class="ident" id="3479329">r</span><span class="op" id="3479330">[</span><span class="ident" id="3479331">n</span><span class="op" id="3479332">-</span><span class="ident" id="3479333">i</span><span class="op" id="3479334">+</span><span class="num" id="3479335">1</span><span class="op" id="3479336">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479341">if</span>&nbsp;<span class="ident" id="3479344">lo</span>&nbsp;<span class="op" id="3479347">&lt;=</span>&nbsp;<span class="ident" id="3479350">rhi</span><span class="op" id="3479353">+</span><span class="num" id="3479354">1</span>&nbsp;<span class="op" id="3479356">&amp;&amp;</span>&nbsp;<span class="ident" id="3479359">rlo</span>&nbsp;<span class="op" id="3479363">&lt;=</span>&nbsp;<span class="ident" id="3479366">hi</span><span class="op" id="3479368">+</span><span class="num" id="3479369">1</span>&nbsp;<span class="op" id="3479371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479377">if</span>&nbsp;<span class="ident" id="3479380">lo</span>&nbsp;<span class="op" id="3479383">&lt;</span>&nbsp;<span class="ident" id="3479385">rlo</span>&nbsp;<span class="op" id="3479389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479396">r</span><span class="op" id="3479397">[</span><span class="ident" id="3479398">n</span><span class="op" id="3479399">-</span><span class="ident" id="3479400">i</span><span class="op" id="3479401">]</span>&nbsp;<span class="op" id="3479403">=</span>&nbsp;<span class="ident" id="3479405">lo</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479418">if</span>&nbsp;<span class="ident" id="3479421">hi</span>&nbsp;<span class="op" id="3479424">&gt;</span>&nbsp;<span class="ident" id="3479426">rhi</span>&nbsp;<span class="op" id="3479430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479437">r</span><span class="op" id="3479438">[</span><span class="ident" id="3479439">n</span><span class="op" id="3479440">-</span><span class="ident" id="3479441">i</span><span class="op" id="3479442">+</span><span class="num" id="3479443">1</span><span class="op" id="3479444">]</span>&nbsp;<span class="op" id="3479446">=</span>&nbsp;<span class="ident" id="3479448">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479461">return</span>&nbsp;<span class="ident" id="3479468">r</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479484">return</span>&nbsp;<span class="builtinfunc" id="3479491">append</span><span class="op" id="3479497">(</span><span class="ident" id="3479498">r</span><span class="op" id="3479499">,</span>&nbsp;<span class="ident" id="3479501">lo</span><span class="op" id="3479503">,</span>&nbsp;<span class="ident" id="3479505">hi</span><span class="op" id="3479507">)</span><br>
<span class="lineno">1675</span><span class="op" id="3479509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3479512">const</span>&nbsp;<span class="op" id="3479518">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479521">//&nbsp;minimum&nbsp;and&nbsp;maximum&nbsp;runes&nbsp;involved&nbsp;in&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479572">//&nbsp;checked&nbsp;during&nbsp;test.</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479597">minFold</span>&nbsp;<span class="op" id="3479605">=</span>&nbsp;<span class="num" id="3479607">0x0041</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479615">maxFold</span>&nbsp;<span class="op" id="3479623">=</span>&nbsp;<span class="num" id="3479625">0x118df</span><br>
<span class="lineno"></span><span class="op" id="3479633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3479636">//&nbsp;appendFoldedRange&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;range&nbsp;lo-hi</span><br>
<span class="lineno">1685</span><span class="comment" id="3479705">//&nbsp;and&nbsp;its&nbsp;case&nbsp;folding-equivalent&nbsp;runes&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3479762">func</span>&nbsp;<span class="ident" id="3479767">appendFoldedRange</span><span class="op" id="3479784">(</span><span class="ident" id="3479785">r</span>&nbsp;<span class="op" id="3479787">[</span><span class="op" id="3479788">]</span><span class="builtintype" id="3479789">rune</span><span class="op" id="3479793">,</span>&nbsp;<span class="ident" id="3479795">lo</span><span class="op" id="3479797">,</span>&nbsp;<span class="ident" id="3479799">hi</span>&nbsp;<span class="builtintype" id="3479802">rune</span><span class="op" id="3479806">)</span>&nbsp;<span class="op" id="3479808">[</span><span class="op" id="3479809">]</span><span class="builtintype" id="3479810">rune</span>&nbsp;<span class="op" id="3479815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479818">//&nbsp;Optimizations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479837">if</span>&nbsp;<span class="ident" id="3479840">lo</span>&nbsp;<span class="op" id="3479843">&lt;=</span>&nbsp;<span class="ident" id="3479846">minFold</span>&nbsp;<span class="op" id="3479854">&amp;&amp;</span>&nbsp;<span class="ident" id="3479857">hi</span>&nbsp;<span class="op" id="3479860">&gt;=</span>&nbsp;<span class="ident" id="3479863">maxFold</span>&nbsp;<span class="op" id="3479871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479875">//&nbsp;Range&nbsp;is&nbsp;full:&nbsp;folding&nbsp;can&#39;t&nbsp;add&nbsp;more.</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479919">return</span>&nbsp;<span class="ident" id="3479926">appendRange</span><span class="op" id="3479937">(</span><span class="ident" id="3479938">r</span><span class="op" id="3479939">,</span>&nbsp;<span class="ident" id="3479941">lo</span><span class="op" id="3479943">,</span>&nbsp;<span class="ident" id="3479945">hi</span><span class="op" id="3479947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479953">if</span>&nbsp;<span class="ident" id="3479956">hi</span>&nbsp;<span class="op" id="3479959">&lt;</span>&nbsp;<span class="ident" id="3479961">minFold</span>&nbsp;<span class="op" id="3479969">||</span>&nbsp;<span class="ident" id="3479972">lo</span>&nbsp;<span class="op" id="3479975">&gt;</span>&nbsp;<span class="ident" id="3479977">maxFold</span>&nbsp;<span class="op" id="3479985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479989">//&nbsp;Range&nbsp;is&nbsp;outside&nbsp;folding&nbsp;possibilities.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480034">return</span>&nbsp;<span class="ident" id="3480041">appendRange</span><span class="op" id="3480052">(</span><span class="ident" id="3480053">r</span><span class="op" id="3480054">,</span>&nbsp;<span class="ident" id="3480056">lo</span><span class="op" id="3480058">,</span>&nbsp;<span class="ident" id="3480060">hi</span><span class="op" id="3480062">)</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480068">if</span>&nbsp;<span class="ident" id="3480071">lo</span>&nbsp;<span class="op" id="3480074">&lt;</span>&nbsp;<span class="ident" id="3480076">minFold</span>&nbsp;<span class="op" id="3480084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480088">//&nbsp;[lo,&nbsp;minFold-1]&nbsp;needs&nbsp;no&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480127">r</span>&nbsp;<span class="op" id="3480129">=</span>&nbsp;<span class="ident" id="3480131">appendRange</span><span class="op" id="3480142">(</span><span class="ident" id="3480143">r</span><span class="op" id="3480144">,</span>&nbsp;<span class="ident" id="3480146">lo</span><span class="op" id="3480148">,</span>&nbsp;<span class="ident" id="3480150">minFold</span><span class="op" id="3480157">-</span><span class="num" id="3480158">1</span><span class="op" id="3480159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480163">lo</span>&nbsp;<span class="op" id="3480166">=</span>&nbsp;<span class="ident" id="3480168">minFold</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480180">if</span>&nbsp;<span class="ident" id="3480183">hi</span>&nbsp;<span class="op" id="3480186">&gt;</span>&nbsp;<span class="ident" id="3480188">maxFold</span>&nbsp;<span class="op" id="3480196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480200">//&nbsp;[maxFold+1,&nbsp;hi]&nbsp;needs&nbsp;no&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480239">r</span>&nbsp;<span class="op" id="3480241">=</span>&nbsp;<span class="ident" id="3480243">appendRange</span><span class="op" id="3480254">(</span><span class="ident" id="3480255">r</span><span class="op" id="3480256">,</span>&nbsp;<span class="ident" id="3480258">maxFold</span><span class="op" id="3480265">+</span><span class="num" id="3480266">1</span><span class="op" id="3480267">,</span>&nbsp;<span class="ident" id="3480269">hi</span><span class="op" id="3480271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480275">hi</span>&nbsp;<span class="op" id="3480278">=</span>&nbsp;<span class="ident" id="3480280">maxFold</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480293">//&nbsp;Brute&nbsp;force.&nbsp;&nbsp;Depend&nbsp;on&nbsp;appendRange&nbsp;to&nbsp;coalesce&nbsp;ranges&nbsp;on&nbsp;the&nbsp;fly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480364">for</span>&nbsp;<span class="ident" id="3480368">c</span>&nbsp;<span class="op" id="3480370">:=</span>&nbsp;<span class="ident" id="3480373">lo</span><span class="op" id="3480375">;</span>&nbsp;<span class="ident" id="3480377">c</span>&nbsp;<span class="op" id="3480379">&lt;=</span>&nbsp;<span class="ident" id="3480382">hi</span><span class="op" id="3480384">;</span>&nbsp;<span class="ident" id="3480386">c</span><span class="op" id="3480387">++</span>&nbsp;<span class="op" id="3480390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480394">r</span>&nbsp;<span class="op" id="3480396">=</span>&nbsp;<span class="ident" id="3480398">appendRange</span><span class="op" id="3480409">(</span><span class="ident" id="3480410">r</span><span class="op" id="3480411">,</span>&nbsp;<span class="ident" id="3480413">c</span><span class="op" id="3480414">,</span>&nbsp;<span class="ident" id="3480416">c</span><span class="op" id="3480417">)</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480421">f</span>&nbsp;<span class="op" id="3480423">:=</span>&nbsp;<span class="ident" id="3480426">unicode</span><span class="op" id="3480433">.</span><span class="ident" id="3480434">SimpleFold</span><span class="op" id="3480444">(</span><span class="ident" id="3480445">c</span><span class="op" id="3480446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480450">for</span>&nbsp;<span class="ident" id="3480454">f</span>&nbsp;<span class="op" id="3480456">!=</span>&nbsp;<span class="ident" id="3480459">c</span>&nbsp;<span class="op" id="3480461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480466">r</span>&nbsp;<span class="op" id="3480468">=</span>&nbsp;<span class="ident" id="3480470">appendRange</span><span class="op" id="3480481">(</span><span class="ident" id="3480482">r</span><span class="op" id="3480483">,</span>&nbsp;<span class="ident" id="3480485">f</span><span class="op" id="3480486">,</span>&nbsp;<span class="ident" id="3480488">f</span><span class="op" id="3480489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480494">f</span>&nbsp;<span class="op" id="3480496">=</span>&nbsp;<span class="ident" id="3480498">unicode</span><span class="op" id="3480505">.</span><span class="ident" id="3480506">SimpleFold</span><span class="op" id="3480516">(</span><span class="ident" id="3480517">f</span><span class="op" id="3480518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480522">}</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480528">return</span>&nbsp;<span class="ident" id="3480535">r</span><br>
<span class="lineno"></span><span class="op" id="3480537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3480540">//&nbsp;appendClass&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno">1720</span><span class="comment" id="3480615">//&nbsp;It&nbsp;assume&nbsp;x&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="3480640">func</span>&nbsp;<span class="ident" id="3480645">appendClass</span><span class="op" id="3480656">(</span><span class="ident" id="3480657">r</span>&nbsp;<span class="op" id="3480659">[</span><span class="op" id="3480660">]</span><span class="builtintype" id="3480661">rune</span><span class="op" id="3480665">,</span>&nbsp;<span class="ident" id="3480667">x</span>&nbsp;<span class="op" id="3480669">[</span><span class="op" id="3480670">]</span><span class="builtintype" id="3480671">rune</span><span class="op" id="3480675">)</span>&nbsp;<span class="op" id="3480677">[</span><span class="op" id="3480678">]</span><span class="builtintype" id="3480679">rune</span>&nbsp;<span class="op" id="3480684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480687">for</span>&nbsp;<span class="ident" id="3480691">i</span>&nbsp;<span class="op" id="3480693">:=</span>&nbsp;<span class="num" id="3480696">0</span><span class="op" id="3480697">;</span>&nbsp;<span class="ident" id="3480699">i</span>&nbsp;<span class="op" id="3480701">&lt;</span>&nbsp;<span class="builtinfunc" id="3480703">len</span><span class="op" id="3480706">(</span><span class="ident" id="3480707">x</span><span class="op" id="3480708">)</span><span class="op" id="3480709">;</span>&nbsp;<span class="ident" id="3480711">i</span>&nbsp;<span class="op" id="3480713">+=</span>&nbsp;<span class="num" id="3480716">2</span>&nbsp;<span class="op" id="3480718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480722">r</span>&nbsp;<span class="op" id="3480724">=</span>&nbsp;<span class="ident" id="3480726">appendRange</span><span class="op" id="3480737">(</span><span class="ident" id="3480738">r</span><span class="op" id="3480739">,</span>&nbsp;<span class="ident" id="3480741">x</span><span class="op" id="3480742">[</span><span class="ident" id="3480743">i</span><span class="op" id="3480744">]</span><span class="op" id="3480745">,</span>&nbsp;<span class="ident" id="3480747">x</span><span class="op" id="3480748">[</span><span class="ident" id="3480749">i</span><span class="op" id="3480750">+</span><span class="num" id="3480751">1</span><span class="op" id="3480752">]</span><span class="op" id="3480753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480756">}</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480759">return</span>&nbsp;<span class="ident" id="3480766">r</span><br>
<span class="lineno"></span><span class="op" id="3480768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3480771">//&nbsp;appendFolded&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;case&nbsp;folding&nbsp;of&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3480867">func</span>&nbsp;<span class="ident" id="3480872">appendFoldedClass</span><span class="op" id="3480889">(</span><span class="ident" id="3480890">r</span>&nbsp;<span class="op" id="3480892">[</span><span class="op" id="3480893">]</span><span class="builtintype" id="3480894">rune</span><span class="op" id="3480898">,</span>&nbsp;<span class="ident" id="3480900">x</span>&nbsp;<span class="op" id="3480902">[</span><span class="op" id="3480903">]</span><span class="builtintype" id="3480904">rune</span><span class="op" id="3480908">)</span>&nbsp;<span class="op" id="3480910">[</span><span class="op" id="3480911">]</span><span class="builtintype" id="3480912">rune</span>&nbsp;<span class="op" id="3480917">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480920">for</span>&nbsp;<span class="ident" id="3480924">i</span>&nbsp;<span class="op" id="3480926">:=</span>&nbsp;<span class="num" id="3480929">0</span><span class="op" id="3480930">;</span>&nbsp;<span class="ident" id="3480932">i</span>&nbsp;<span class="op" id="3480934">&lt;</span>&nbsp;<span class="builtinfunc" id="3480936">len</span><span class="op" id="3480939">(</span><span class="ident" id="3480940">x</span><span class="op" id="3480941">)</span><span class="op" id="3480942">;</span>&nbsp;<span class="ident" id="3480944">i</span>&nbsp;<span class="op" id="3480946">+=</span>&nbsp;<span class="num" id="3480949">2</span>&nbsp;<span class="op" id="3480951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480955">r</span>&nbsp;<span class="op" id="3480957">=</span>&nbsp;<span class="ident" id="3480959">appendFoldedRange</span><span class="op" id="3480976">(</span><span class="ident" id="3480977">r</span><span class="op" id="3480978">,</span>&nbsp;<span class="ident" id="3480980">x</span><span class="op" id="3480981">[</span><span class="ident" id="3480982">i</span><span class="op" id="3480983">]</span><span class="op" id="3480984">,</span>&nbsp;<span class="ident" id="3480986">x</span><span class="op" id="3480987">[</span><span class="ident" id="3480988">i</span><span class="op" id="3480989">+</span><span class="num" id="3480990">1</span><span class="op" id="3480991">]</span><span class="op" id="3480992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480998">return</span>&nbsp;<span class="ident" id="3481005">r</span><br>
<span class="lineno"></span><span class="op" id="3481007">}</span><br>
<span class="lineno">1735</span><br>
<span class="lineno"></span><span class="comment" id="3481010">//&nbsp;appendNegatedClass&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;negation&nbsp;of&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="3481108">//&nbsp;It&nbsp;assumes&nbsp;x&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="3481134">func</span>&nbsp;<span class="ident" id="3481139">appendNegatedClass</span><span class="op" id="3481157">(</span><span class="ident" id="3481158">r</span>&nbsp;<span class="op" id="3481160">[</span><span class="op" id="3481161">]</span><span class="builtintype" id="3481162">rune</span><span class="op" id="3481166">,</span>&nbsp;<span class="ident" id="3481168">x</span>&nbsp;<span class="op" id="3481170">[</span><span class="op" id="3481171">]</span><span class="builtintype" id="3481172">rune</span><span class="op" id="3481176">)</span>&nbsp;<span class="op" id="3481178">[</span><span class="op" id="3481179">]</span><span class="builtintype" id="3481180">rune</span>&nbsp;<span class="op" id="3481185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481188">nextLo</span>&nbsp;<span class="op" id="3481195">:=</span>&nbsp;<span class="string" id="3481198">&#39;\u0000&#39;</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481208">for</span>&nbsp;<span class="ident" id="3481212">i</span>&nbsp;<span class="op" id="3481214">:=</span>&nbsp;<span class="num" id="3481217">0</span><span class="op" id="3481218">;</span>&nbsp;<span class="ident" id="3481220">i</span>&nbsp;<span class="op" id="3481222">&lt;</span>&nbsp;<span class="builtinfunc" id="3481224">len</span><span class="op" id="3481227">(</span><span class="ident" id="3481228">x</span><span class="op" id="3481229">)</span><span class="op" id="3481230">;</span>&nbsp;<span class="ident" id="3481232">i</span>&nbsp;<span class="op" id="3481234">+=</span>&nbsp;<span class="num" id="3481237">2</span>&nbsp;<span class="op" id="3481239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481243">lo</span><span class="op" id="3481245">,</span>&nbsp;<span class="ident" id="3481247">hi</span>&nbsp;<span class="op" id="3481250">:=</span>&nbsp;<span class="ident" id="3481253">x</span><span class="op" id="3481254">[</span><span class="ident" id="3481255">i</span><span class="op" id="3481256">]</span><span class="op" id="3481257">,</span>&nbsp;<span class="ident" id="3481259">x</span><span class="op" id="3481260">[</span><span class="ident" id="3481261">i</span><span class="op" id="3481262">+</span><span class="num" id="3481263">1</span><span class="op" id="3481264">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481268">if</span>&nbsp;<span class="ident" id="3481271">nextLo</span>&nbsp;<span class="op" id="3481278">&lt;=</span>&nbsp;<span class="ident" id="3481281">lo</span><span class="op" id="3481283">-</span><span class="num" id="3481284">1</span>&nbsp;<span class="op" id="3481286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481291">r</span>&nbsp;<span class="op" id="3481293">=</span>&nbsp;<span class="ident" id="3481295">appendRange</span><span class="op" id="3481306">(</span><span class="ident" id="3481307">r</span><span class="op" id="3481308">,</span>&nbsp;<span class="ident" id="3481310">nextLo</span><span class="op" id="3481316">,</span>&nbsp;<span class="ident" id="3481318">lo</span><span class="op" id="3481320">-</span><span class="num" id="3481321">1</span><span class="op" id="3481322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481326">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481330">nextLo</span>&nbsp;<span class="op" id="3481337">=</span>&nbsp;<span class="ident" id="3481339">hi</span>&nbsp;<span class="op" id="3481342">+</span>&nbsp;<span class="num" id="3481344">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481350">if</span>&nbsp;<span class="ident" id="3481353">nextLo</span>&nbsp;<span class="op" id="3481360">&lt;=</span>&nbsp;<span class="ident" id="3481363">unicode</span><span class="op" id="3481370">.</span><span class="ident" id="3481371">MaxRune</span>&nbsp;<span class="op" id="3481379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481383">r</span>&nbsp;<span class="op" id="3481385">=</span>&nbsp;<span class="ident" id="3481387">appendRange</span><span class="op" id="3481398">(</span><span class="ident" id="3481399">r</span><span class="op" id="3481400">,</span>&nbsp;<span class="ident" id="3481402">nextLo</span><span class="op" id="3481408">,</span>&nbsp;<span class="ident" id="3481410">unicode</span><span class="op" id="3481417">.</span><span class="ident" id="3481418">MaxRune</span><span class="op" id="3481425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481428">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481431">return</span>&nbsp;<span class="ident" id="3481438">r</span><br>
<span class="lineno"></span><span class="op" id="3481440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3481443">//&nbsp;appendTable&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3481508">func</span>&nbsp;<span class="ident" id="3481513">appendTable</span><span class="op" id="3481524">(</span><span class="ident" id="3481525">r</span>&nbsp;<span class="op" id="3481527">[</span><span class="op" id="3481528">]</span><span class="builtintype" id="3481529">rune</span><span class="op" id="3481533">,</span>&nbsp;<span class="ident" id="3481535">x</span>&nbsp;<span class="op" id="3481537">*</span><span class="ident" id="3481538">unicode</span><span class="op" id="3481545">.</span><span class="ident" id="3481546">RangeTable</span><span class="op" id="3481556">)</span>&nbsp;<span class="op" id="3481558">[</span><span class="op" id="3481559">]</span><span class="builtintype" id="3481560">rune</span>&nbsp;<span class="op" id="3481565">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481568">for</span>&nbsp;<span class="ident" id="3481572">_</span><span class="op" id="3481573">,</span>&nbsp;<span class="ident" id="3481575">xr</span>&nbsp;<span class="op" id="3481578">:=</span>&nbsp;<span class="keyword" id="3481581">range</span>&nbsp;<span class="ident" id="3481587">x</span><span class="op" id="3481588">.</span><span class="ident" id="3481589">R16</span>&nbsp;<span class="op" id="3481593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481597">lo</span><span class="op" id="3481599">,</span>&nbsp;<span class="ident" id="3481601">hi</span><span class="op" id="3481603">,</span>&nbsp;<span class="ident" id="3481605">stride</span>&nbsp;<span class="op" id="3481612">:=</span>&nbsp;<span class="builtintype" id="3481615">rune</span><span class="op" id="3481619">(</span><span class="ident" id="3481620">xr</span><span class="op" id="3481622">.</span><span class="ident" id="3481623">Lo</span><span class="op" id="3481625">)</span><span class="op" id="3481626">,</span>&nbsp;<span class="builtintype" id="3481628">rune</span><span class="op" id="3481632">(</span><span class="ident" id="3481633">xr</span><span class="op" id="3481635">.</span><span class="ident" id="3481636">Hi</span><span class="op" id="3481638">)</span><span class="op" id="3481639">,</span>&nbsp;<span class="builtintype" id="3481641">rune</span><span class="op" id="3481645">(</span><span class="ident" id="3481646">xr</span><span class="op" id="3481648">.</span><span class="ident" id="3481649">Stride</span><span class="op" id="3481655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481659">if</span>&nbsp;<span class="ident" id="3481662">stride</span>&nbsp;<span class="op" id="3481669">==</span>&nbsp;<span class="num" id="3481672">1</span>&nbsp;<span class="op" id="3481674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481679">r</span>&nbsp;<span class="op" id="3481681">=</span>&nbsp;<span class="ident" id="3481683">appendRange</span><span class="op" id="3481694">(</span><span class="ident" id="3481695">r</span><span class="op" id="3481696">,</span>&nbsp;<span class="ident" id="3481698">lo</span><span class="op" id="3481700">,</span>&nbsp;<span class="ident" id="3481702">hi</span><span class="op" id="3481704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481709">continue</span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481724">for</span>&nbsp;<span class="ident" id="3481728">c</span>&nbsp;<span class="op" id="3481730">:=</span>&nbsp;<span class="ident" id="3481733">lo</span><span class="op" id="3481735">;</span>&nbsp;<span class="ident" id="3481737">c</span>&nbsp;<span class="op" id="3481739">&lt;=</span>&nbsp;<span class="ident" id="3481742">hi</span><span class="op" id="3481744">;</span>&nbsp;<span class="ident" id="3481746">c</span>&nbsp;<span class="op" id="3481748">+=</span>&nbsp;<span class="ident" id="3481751">stride</span>&nbsp;<span class="op" id="3481758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481763">r</span>&nbsp;<span class="op" id="3481765">=</span>&nbsp;<span class="ident" id="3481767">appendRange</span><span class="op" id="3481778">(</span><span class="ident" id="3481779">r</span><span class="op" id="3481780">,</span>&nbsp;<span class="ident" id="3481782">c</span><span class="op" id="3481783">,</span>&nbsp;<span class="ident" id="3481785">c</span><span class="op" id="3481786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481793">}</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481796">for</span>&nbsp;<span class="ident" id="3481800">_</span><span class="op" id="3481801">,</span>&nbsp;<span class="ident" id="3481803">xr</span>&nbsp;<span class="op" id="3481806">:=</span>&nbsp;<span class="keyword" id="3481809">range</span>&nbsp;<span class="ident" id="3481815">x</span><span class="op" id="3481816">.</span><span class="ident" id="3481817">R32</span>&nbsp;<span class="op" id="3481821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481825">lo</span><span class="op" id="3481827">,</span>&nbsp;<span class="ident" id="3481829">hi</span><span class="op" id="3481831">,</span>&nbsp;<span class="ident" id="3481833">stride</span>&nbsp;<span class="op" id="3481840">:=</span>&nbsp;<span class="builtintype" id="3481843">rune</span><span class="op" id="3481847">(</span><span class="ident" id="3481848">xr</span><span class="op" id="3481850">.</span><span class="ident" id="3481851">Lo</span><span class="op" id="3481853">)</span><span class="op" id="3481854">,</span>&nbsp;<span class="builtintype" id="3481856">rune</span><span class="op" id="3481860">(</span><span class="ident" id="3481861">xr</span><span class="op" id="3481863">.</span><span class="ident" id="3481864">Hi</span><span class="op" id="3481866">)</span><span class="op" id="3481867">,</span>&nbsp;<span class="builtintype" id="3481869">rune</span><span class="op" id="3481873">(</span><span class="ident" id="3481874">xr</span><span class="op" id="3481876">.</span><span class="ident" id="3481877">Stride</span><span class="op" id="3481883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481887">if</span>&nbsp;<span class="ident" id="3481890">stride</span>&nbsp;<span class="op" id="3481897">==</span>&nbsp;<span class="num" id="3481900">1</span>&nbsp;<span class="op" id="3481902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481907">r</span>&nbsp;<span class="op" id="3481909">=</span>&nbsp;<span class="ident" id="3481911">appendRange</span><span class="op" id="3481922">(</span><span class="ident" id="3481923">r</span><span class="op" id="3481924">,</span>&nbsp;<span class="ident" id="3481926">lo</span><span class="op" id="3481928">,</span>&nbsp;<span class="ident" id="3481930">hi</span><span class="op" id="3481932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481937">continue</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481952">for</span>&nbsp;<span class="ident" id="3481956">c</span>&nbsp;<span class="op" id="3481958">:=</span>&nbsp;<span class="ident" id="3481961">lo</span><span class="op" id="3481963">;</span>&nbsp;<span class="ident" id="3481965">c</span>&nbsp;<span class="op" id="3481967">&lt;=</span>&nbsp;<span class="ident" id="3481970">hi</span><span class="op" id="3481972">;</span>&nbsp;<span class="ident" id="3481974">c</span>&nbsp;<span class="op" id="3481976">+=</span>&nbsp;<span class="ident" id="3481979">stride</span>&nbsp;<span class="op" id="3481986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481991">r</span>&nbsp;<span class="op" id="3481993">=</span>&nbsp;<span class="ident" id="3481995">appendRange</span><span class="op" id="3482006">(</span><span class="ident" id="3482007">r</span><span class="op" id="3482008">,</span>&nbsp;<span class="ident" id="3482010">c</span><span class="op" id="3482011">,</span>&nbsp;<span class="ident" id="3482013">c</span><span class="op" id="3482014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482021">}</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482024">return</span>&nbsp;<span class="ident" id="3482031">r</span><br>
<span class="lineno"></span><span class="op" id="3482033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3482036">//&nbsp;appendNegatedTable&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;negation&nbsp;of&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="3482124">func</span>&nbsp;<span class="ident" id="3482129">appendNegatedTable</span><span class="op" id="3482147">(</span><span class="ident" id="3482148">r</span>&nbsp;<span class="op" id="3482150">[</span><span class="op" id="3482151">]</span><span class="builtintype" id="3482152">rune</span><span class="op" id="3482156">,</span>&nbsp;<span class="ident" id="3482158">x</span>&nbsp;<span class="op" id="3482160">*</span><span class="ident" id="3482161">unicode</span><span class="op" id="3482168">.</span><span class="ident" id="3482169">RangeTable</span><span class="op" id="3482179">)</span>&nbsp;<span class="op" id="3482181">[</span><span class="op" id="3482182">]</span><span class="builtintype" id="3482183">rune</span>&nbsp;<span class="op" id="3482188">{</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482191">nextLo</span>&nbsp;<span class="op" id="3482198">:=</span>&nbsp;<span class="string" id="3482201">&#39;\u0000&#39;</span>&nbsp;<span class="comment" id="3482210">//&nbsp;lo&nbsp;end&nbsp;of&nbsp;next&nbsp;class&nbsp;to&nbsp;add</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482242">for</span>&nbsp;<span class="ident" id="3482246">_</span><span class="op" id="3482247">,</span>&nbsp;<span class="ident" id="3482249">xr</span>&nbsp;<span class="op" id="3482252">:=</span>&nbsp;<span class="keyword" id="3482255">range</span>&nbsp;<span class="ident" id="3482261">x</span><span class="op" id="3482262">.</span><span class="ident" id="3482263">R16</span>&nbsp;<span class="op" id="3482267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482271">lo</span><span class="op" id="3482273">,</span>&nbsp;<span class="ident" id="3482275">hi</span><span class="op" id="3482277">,</span>&nbsp;<span class="ident" id="3482279">stride</span>&nbsp;<span class="op" id="3482286">:=</span>&nbsp;<span class="builtintype" id="3482289">rune</span><span class="op" id="3482293">(</span><span class="ident" id="3482294">xr</span><span class="op" id="3482296">.</span><span class="ident" id="3482297">Lo</span><span class="op" id="3482299">)</span><span class="op" id="3482300">,</span>&nbsp;<span class="builtintype" id="3482302">rune</span><span class="op" id="3482306">(</span><span class="ident" id="3482307">xr</span><span class="op" id="3482309">.</span><span class="ident" id="3482310">Hi</span><span class="op" id="3482312">)</span><span class="op" id="3482313">,</span>&nbsp;<span class="builtintype" id="3482315">rune</span><span class="op" id="3482319">(</span><span class="ident" id="3482320">xr</span><span class="op" id="3482322">.</span><span class="ident" id="3482323">Stride</span><span class="op" id="3482329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482333">if</span>&nbsp;<span class="ident" id="3482336">stride</span>&nbsp;<span class="op" id="3482343">==</span>&nbsp;<span class="num" id="3482346">1</span>&nbsp;<span class="op" id="3482348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482353">if</span>&nbsp;<span class="ident" id="3482356">nextLo</span>&nbsp;<span class="op" id="3482363">&lt;=</span>&nbsp;<span class="ident" id="3482366">lo</span><span class="op" id="3482368">-</span><span class="num" id="3482369">1</span>&nbsp;<span class="op" id="3482371">{</span><br>
<span class="lineno">1785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482377">r</span>&nbsp;<span class="op" id="3482379">=</span>&nbsp;<span class="ident" id="3482381">appendRange</span><span class="op" id="3482392">(</span><span class="ident" id="3482393">r</span><span class="op" id="3482394">,</span>&nbsp;<span class="ident" id="3482396">nextLo</span><span class="op" id="3482402">,</span>&nbsp;<span class="ident" id="3482404">lo</span><span class="op" id="3482406">-</span><span class="num" id="3482407">1</span><span class="op" id="3482408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482418">nextLo</span>&nbsp;<span class="op" id="3482425">=</span>&nbsp;<span class="ident" id="3482427">hi</span>&nbsp;<span class="op" id="3482430">+</span>&nbsp;<span class="num" id="3482432">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482437">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482448">}</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482452">for</span>&nbsp;<span class="ident" id="3482456">c</span>&nbsp;<span class="op" id="3482458">:=</span>&nbsp;<span class="ident" id="3482461">lo</span><span class="op" id="3482463">;</span>&nbsp;<span class="ident" id="3482465">c</span>&nbsp;<span class="op" id="3482467">&lt;=</span>&nbsp;<span class="ident" id="3482470">hi</span><span class="op" id="3482472">;</span>&nbsp;<span class="ident" id="3482474">c</span>&nbsp;<span class="op" id="3482476">+=</span>&nbsp;<span class="ident" id="3482479">stride</span>&nbsp;<span class="op" id="3482486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482491">if</span>&nbsp;<span class="ident" id="3482494">nextLo</span>&nbsp;<span class="op" id="3482501">&lt;=</span>&nbsp;<span class="ident" id="3482504">c</span><span class="op" id="3482505">-</span><span class="num" id="3482506">1</span>&nbsp;<span class="op" id="3482508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482514">r</span>&nbsp;<span class="op" id="3482516">=</span>&nbsp;<span class="ident" id="3482518">appendRange</span><span class="op" id="3482529">(</span><span class="ident" id="3482530">r</span><span class="op" id="3482531">,</span>&nbsp;<span class="ident" id="3482533">nextLo</span><span class="op" id="3482539">,</span>&nbsp;<span class="ident" id="3482541">c</span><span class="op" id="3482542">-</span><span class="num" id="3482543">1</span><span class="op" id="3482544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482554">nextLo</span>&nbsp;<span class="op" id="3482561">=</span>&nbsp;<span class="ident" id="3482563">c</span>&nbsp;<span class="op" id="3482565">+</span>&nbsp;<span class="num" id="3482567">1</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482577">for</span>&nbsp;<span class="ident" id="3482581">_</span><span class="op" id="3482582">,</span>&nbsp;<span class="ident" id="3482584">xr</span>&nbsp;<span class="op" id="3482587">:=</span>&nbsp;<span class="keyword" id="3482590">range</span>&nbsp;<span class="ident" id="3482596">x</span><span class="op" id="3482597">.</span><span class="ident" id="3482598">R32</span>&nbsp;<span class="op" id="3482602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482606">lo</span><span class="op" id="3482608">,</span>&nbsp;<span class="ident" id="3482610">hi</span><span class="op" id="3482612">,</span>&nbsp;<span class="ident" id="3482614">stride</span>&nbsp;<span class="op" id="3482621">:=</span>&nbsp;<span class="builtintype" id="3482624">rune</span><span class="op" id="3482628">(</span><span class="ident" id="3482629">xr</span><span class="op" id="3482631">.</span><span class="ident" id="3482632">Lo</span><span class="op" id="3482634">)</span><span class="op" id="3482635">,</span>&nbsp;<span class="builtintype" id="3482637">rune</span><span class="op" id="3482641">(</span><span class="ident" id="3482642">xr</span><span class="op" id="3482644">.</span><span class="ident" id="3482645">Hi</span><span class="op" id="3482647">)</span><span class="op" id="3482648">,</span>&nbsp;<span class="builtintype" id="3482650">rune</span><span class="op" id="3482654">(</span><span class="ident" id="3482655">xr</span><span class="op" id="3482657">.</span><span class="ident" id="3482658">Stride</span><span class="op" id="3482664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482668">if</span>&nbsp;<span class="ident" id="3482671">stride</span>&nbsp;<span class="op" id="3482678">==</span>&nbsp;<span class="num" id="3482681">1</span>&nbsp;<span class="op" id="3482683">{</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482688">if</span>&nbsp;<span class="ident" id="3482691">nextLo</span>&nbsp;<span class="op" id="3482698">&lt;=</span>&nbsp;<span class="ident" id="3482701">lo</span><span class="op" id="3482703">-</span><span class="num" id="3482704">1</span>&nbsp;<span class="op" id="3482706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482712">r</span>&nbsp;<span class="op" id="3482714">=</span>&nbsp;<span class="ident" id="3482716">appendRange</span><span class="op" id="3482727">(</span><span class="ident" id="3482728">r</span><span class="op" id="3482729">,</span>&nbsp;<span class="ident" id="3482731">nextLo</span><span class="op" id="3482737">,</span>&nbsp;<span class="ident" id="3482739">lo</span><span class="op" id="3482741">-</span><span class="num" id="3482742">1</span><span class="op" id="3482743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482753">nextLo</span>&nbsp;<span class="op" id="3482760">=</span>&nbsp;<span class="ident" id="3482762">hi</span>&nbsp;<span class="op" id="3482765">+</span>&nbsp;<span class="num" id="3482767">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482772">continue</span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482787">for</span>&nbsp;<span class="ident" id="3482791">c</span>&nbsp;<span class="op" id="3482793">:=</span>&nbsp;<span class="ident" id="3482796">lo</span><span class="op" id="3482798">;</span>&nbsp;<span class="ident" id="3482800">c</span>&nbsp;<span class="op" id="3482802">&lt;=</span>&nbsp;<span class="ident" id="3482805">hi</span><span class="op" id="3482807">;</span>&nbsp;<span class="ident" id="3482809">c</span>&nbsp;<span class="op" id="3482811">+=</span>&nbsp;<span class="ident" id="3482814">stride</span>&nbsp;<span class="op" id="3482821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482826">if</span>&nbsp;<span class="ident" id="3482829">nextLo</span>&nbsp;<span class="op" id="3482836">&lt;=</span>&nbsp;<span class="ident" id="3482839">c</span><span class="op" id="3482840">-</span><span class="num" id="3482841">1</span>&nbsp;<span class="op" id="3482843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482849">r</span>&nbsp;<span class="op" id="3482851">=</span>&nbsp;<span class="ident" id="3482853">appendRange</span><span class="op" id="3482864">(</span><span class="ident" id="3482865">r</span><span class="op" id="3482866">,</span>&nbsp;<span class="ident" id="3482868">nextLo</span><span class="op" id="3482874">,</span>&nbsp;<span class="ident" id="3482876">c</span><span class="op" id="3482877">-</span><span class="num" id="3482878">1</span><span class="op" id="3482879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482884">}</span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482889">nextLo</span>&nbsp;<span class="op" id="3482896">=</span>&nbsp;<span class="ident" id="3482898">c</span>&nbsp;<span class="op" id="3482900">+</span>&nbsp;<span class="num" id="3482902">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482912">if</span>&nbsp;<span class="ident" id="3482915">nextLo</span>&nbsp;<span class="op" id="3482922">&lt;=</span>&nbsp;<span class="ident" id="3482925">unicode</span><span class="op" id="3482932">.</span><span class="ident" id="3482933">MaxRune</span>&nbsp;<span class="op" id="3482941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482945">r</span>&nbsp;<span class="op" id="3482947">=</span>&nbsp;<span class="ident" id="3482949">appendRange</span><span class="op" id="3482960">(</span><span class="ident" id="3482961">r</span><span class="op" id="3482962">,</span>&nbsp;<span class="ident" id="3482964">nextLo</span><span class="op" id="3482970">,</span>&nbsp;<span class="ident" id="3482972">unicode</span><span class="op" id="3482979">.</span><span class="ident" id="3482980">MaxRune</span><span class="op" id="3482987">)</span><br>
<span class="lineno">1815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482993">return</span>&nbsp;<span class="ident" id="3483000">r</span><br>
<span class="lineno"></span><span class="op" id="3483002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3483005">//&nbsp;negateClass&nbsp;overwrites&nbsp;r&nbsp;and&nbsp;returns&nbsp;r&#39;s&nbsp;negation.</span><br>
<span class="lineno">1820</span><span class="comment" id="3483059">//&nbsp;It&nbsp;assumes&nbsp;the&nbsp;class&nbsp;r&nbsp;is&nbsp;already&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="3483103">func</span>&nbsp;<span class="ident" id="3483108">negateClass</span><span class="op" id="3483119">(</span><span class="ident" id="3483120">r</span>&nbsp;<span class="op" id="3483122">[</span><span class="op" id="3483123">]</span><span class="builtintype" id="3483124">rune</span><span class="op" id="3483128">)</span>&nbsp;<span class="op" id="3483130">[</span><span class="op" id="3483131">]</span><span class="builtintype" id="3483132">rune</span>&nbsp;<span class="op" id="3483137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483140">nextLo</span>&nbsp;<span class="op" id="3483147">:=</span>&nbsp;<span class="string" id="3483150">&#39;\u0000&#39;</span>&nbsp;<span class="comment" id="3483159">//&nbsp;lo&nbsp;end&nbsp;of&nbsp;next&nbsp;class&nbsp;to&nbsp;add</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483191">w</span>&nbsp;<span class="op" id="3483193">:=</span>&nbsp;<span class="num" id="3483196">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3483210">//&nbsp;write&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483226">for</span>&nbsp;<span class="ident" id="3483230">i</span>&nbsp;<span class="op" id="3483232">:=</span>&nbsp;<span class="num" id="3483235">0</span><span class="op" id="3483236">;</span>&nbsp;<span class="ident" id="3483238">i</span>&nbsp;<span class="op" id="3483240">&lt;</span>&nbsp;<span class="builtinfunc" id="3483242">len</span><span class="op" id="3483245">(</span><span class="ident" id="3483246">r</span><span class="op" id="3483247">)</span><span class="op" id="3483248">;</span>&nbsp;<span class="ident" id="3483250">i</span>&nbsp;<span class="op" id="3483252">+=</span>&nbsp;<span class="num" id="3483255">2</span>&nbsp;<span class="op" id="3483257">{</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483261">lo</span><span class="op" id="3483263">,</span>&nbsp;<span class="ident" id="3483265">hi</span>&nbsp;<span class="op" id="3483268">:=</span>&nbsp;<span class="ident" id="3483271">r</span><span class="op" id="3483272">[</span><span class="ident" id="3483273">i</span><span class="op" id="3483274">]</span><span class="op" id="3483275">,</span>&nbsp;<span class="ident" id="3483277">r</span><span class="op" id="3483278">[</span><span class="ident" id="3483279">i</span><span class="op" id="3483280">+</span><span class="num" id="3483281">1</span><span class="op" id="3483282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483286">if</span>&nbsp;<span class="ident" id="3483289">nextLo</span>&nbsp;<span class="op" id="3483296">&lt;=</span>&nbsp;<span class="ident" id="3483299">lo</span><span class="op" id="3483301">-</span><span class="num" id="3483302">1</span>&nbsp;<span class="op" id="3483304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483309">r</span><span class="op" id="3483310">[</span><span class="ident" id="3483311">w</span><span class="op" id="3483312">]</span>&nbsp;<span class="op" id="3483314">=</span>&nbsp;<span class="ident" id="3483316">nextLo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483326">r</span><span class="op" id="3483327">[</span><span class="ident" id="3483328">w</span><span class="op" id="3483329">+</span><span class="num" id="3483330">1</span><span class="op" id="3483331">]</span>&nbsp;<span class="op" id="3483333">=</span>&nbsp;<span class="ident" id="3483335">lo</span>&nbsp;<span class="op" id="3483338">-</span>&nbsp;<span class="num" id="3483340">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483345">w</span>&nbsp;<span class="op" id="3483347">+=</span>&nbsp;<span class="num" id="3483350">2</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483358">nextLo</span>&nbsp;<span class="op" id="3483365">=</span>&nbsp;<span class="ident" id="3483367">hi</span>&nbsp;<span class="op" id="3483370">+</span>&nbsp;<span class="num" id="3483372">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483378">r</span>&nbsp;<span class="op" id="3483380">=</span>&nbsp;<span class="ident" id="3483382">r</span><span class="op" id="3483383">[</span><span class="op" id="3483384">:</span><span class="ident" id="3483385">w</span><span class="op" id="3483386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483389">if</span>&nbsp;<span class="ident" id="3483392">nextLo</span>&nbsp;<span class="op" id="3483399">&lt;=</span>&nbsp;<span class="ident" id="3483402">unicode</span><span class="op" id="3483409">.</span><span class="ident" id="3483410">MaxRune</span>&nbsp;<span class="op" id="3483418">{</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483422">//&nbsp;It&#39;s&nbsp;possible&nbsp;for&nbsp;the&nbsp;negation&nbsp;to&nbsp;have&nbsp;one&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483475">//&nbsp;range&nbsp;-&nbsp;this&nbsp;one&nbsp;-&nbsp;than&nbsp;the&nbsp;original&nbsp;class,&nbsp;so&nbsp;use&nbsp;append.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483539">r</span>&nbsp;<span class="op" id="3483541">=</span>&nbsp;<span class="builtinfunc" id="3483543">append</span><span class="op" id="3483549">(</span><span class="ident" id="3483550">r</span><span class="op" id="3483551">,</span>&nbsp;<span class="ident" id="3483553">nextLo</span><span class="op" id="3483559">,</span>&nbsp;<span class="ident" id="3483561">unicode</span><span class="op" id="3483568">.</span><span class="ident" id="3483569">MaxRune</span><span class="op" id="3483576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483582">return</span>&nbsp;<span class="ident" id="3483589">r</span><br>
<span class="lineno">1840</span><span class="op" id="3483591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3483594">//&nbsp;ranges&nbsp;implements&nbsp;sort.Interface&nbsp;on&nbsp;a&nbsp;[]rune.</span><br>
<span class="lineno"></span><span class="comment" id="3483643">//&nbsp;The&nbsp;choice&nbsp;of&nbsp;receiver&nbsp;type&nbsp;definition&nbsp;is&nbsp;strange</span><br>
<span class="lineno"></span><span class="comment" id="3483696">//&nbsp;but&nbsp;avoids&nbsp;an&nbsp;allocation&nbsp;since&nbsp;we&nbsp;already&nbsp;have</span><br>
<span class="lineno">1845</span><span class="comment" id="3483746">//&nbsp;a&nbsp;*[]rune.</span><br>
<span class="lineno"></span><span class="keyword" id="3483760">type</span>&nbsp;<span class="ident" id="3483765">ranges</span>&nbsp;<span class="keyword" id="3483772">struct</span>&nbsp;<span class="op" id="3483779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483782">p</span>&nbsp;<span class="op" id="3483784">*</span><span class="op" id="3483785">[</span><span class="op" id="3483786">]</span><span class="builtintype" id="3483787">rune</span><br>
<span class="lineno"></span><span class="op" id="3483792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span><span class="keyword" id="3483795">func</span>&nbsp;<span class="op" id="3483800">(</span><span class="ident" id="3483801">ra</span>&nbsp;<span class="ident" id="3483804">ranges</span><span class="op" id="3483810">)</span>&nbsp;<span class="ident" id="3483812">Less</span><span class="op" id="3483816">(</span><span class="ident" id="3483817">i</span><span class="op" id="3483818">,</span>&nbsp;<span class="ident" id="3483820">j</span>&nbsp;<span class="builtintype" id="3483822">int</span><span class="op" id="3483825">)</span>&nbsp;<span class="builtintype" id="3483827">bool</span>&nbsp;<span class="op" id="3483832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483835">p</span>&nbsp;<span class="op" id="3483837">:=</span>&nbsp;<span class="op" id="3483840">*</span><span class="ident" id="3483841">ra</span><span class="op" id="3483843">.</span><span class="ident" id="3483844">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483847">i</span>&nbsp;<span class="op" id="3483849">*=</span>&nbsp;<span class="num" id="3483852">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483855">j</span>&nbsp;<span class="op" id="3483857">*=</span>&nbsp;<span class="num" id="3483860">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483863">return</span>&nbsp;<span class="ident" id="3483870">p</span><span class="op" id="3483871">[</span><span class="ident" id="3483872">i</span><span class="op" id="3483873">]</span>&nbsp;<span class="op" id="3483875">&lt;</span>&nbsp;<span class="ident" id="3483877">p</span><span class="op" id="3483878">[</span><span class="ident" id="3483879">j</span><span class="op" id="3483880">]</span>&nbsp;<span class="op" id="3483882">||</span>&nbsp;<span class="ident" id="3483885">p</span><span class="op" id="3483886">[</span><span class="ident" id="3483887">i</span><span class="op" id="3483888">]</span>&nbsp;<span class="op" id="3483890">==</span>&nbsp;<span class="ident" id="3483893">p</span><span class="op" id="3483894">[</span><span class="ident" id="3483895">j</span><span class="op" id="3483896">]</span>&nbsp;<span class="op" id="3483898">&amp;&amp;</span>&nbsp;<span class="ident" id="3483901">p</span><span class="op" id="3483902">[</span><span class="ident" id="3483903">i</span><span class="op" id="3483904">+</span><span class="num" id="3483905">1</span><span class="op" id="3483906">]</span>&nbsp;<span class="op" id="3483908">&gt;</span>&nbsp;<span class="ident" id="3483910">p</span><span class="op" id="3483911">[</span><span class="ident" id="3483912">j</span><span class="op" id="3483913">+</span><span class="num" id="3483914">1</span><span class="op" id="3483915">]</span><br>
<span class="lineno">1855</span><span class="op" id="3483917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3483920">func</span>&nbsp;<span class="op" id="3483925">(</span><span class="ident" id="3483926">ra</span>&nbsp;<span class="ident" id="3483929">ranges</span><span class="op" id="3483935">)</span>&nbsp;<span class="ident" id="3483937">Len</span><span class="op" id="3483940">(</span><span class="op" id="3483941">)</span>&nbsp;<span class="builtintype" id="3483943">int</span>&nbsp;<span class="op" id="3483947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483950">return</span>&nbsp;<span class="builtinfunc" id="3483957">len</span><span class="op" id="3483960">(</span><span class="op" id="3483961">*</span><span class="ident" id="3483962">ra</span><span class="op" id="3483964">.</span><span class="ident" id="3483965">p</span><span class="op" id="3483966">)</span>&nbsp;<span class="op" id="3483968">/</span>&nbsp;<span class="num" id="3483970">2</span><br>
<span class="lineno"></span><span class="op" id="3483972">}</span><br>
<span class="lineno">1860</span><br>
<span class="lineno"></span><span class="keyword" id="3483975">func</span>&nbsp;<span class="op" id="3483980">(</span><span class="ident" id="3483981">ra</span>&nbsp;<span class="ident" id="3483984">ranges</span><span class="op" id="3483990">)</span>&nbsp;<span class="ident" id="3483992">Swap</span><span class="op" id="3483996">(</span><span class="ident" id="3483997">i</span><span class="op" id="3483998">,</span>&nbsp;<span class="ident" id="3484000">j</span>&nbsp;<span class="builtintype" id="3484002">int</span><span class="op" id="3484005">)</span>&nbsp;<span class="op" id="3484007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484010">p</span>&nbsp;<span class="op" id="3484012">:=</span>&nbsp;<span class="op" id="3484015">*</span><span class="ident" id="3484016">ra</span><span class="op" id="3484018">.</span><span class="ident" id="3484019">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484022">i</span>&nbsp;<span class="op" id="3484024">*=</span>&nbsp;<span class="num" id="3484027">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484030">j</span>&nbsp;<span class="op" id="3484032">*=</span>&nbsp;<span class="num" id="3484035">2</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484038">p</span><span class="op" id="3484039">[</span><span class="ident" id="3484040">i</span><span class="op" id="3484041">]</span><span class="op" id="3484042">,</span>&nbsp;<span class="ident" id="3484044">p</span><span class="op" id="3484045">[</span><span class="ident" id="3484046">i</span><span class="op" id="3484047">+</span><span class="num" id="3484048">1</span><span class="op" id="3484049">]</span><span class="op" id="3484050">,</span>&nbsp;<span class="ident" id="3484052">p</span><span class="op" id="3484053">[</span><span class="ident" id="3484054">j</span><span class="op" id="3484055">]</span><span class="op" id="3484056">,</span>&nbsp;<span class="ident" id="3484058">p</span><span class="op" id="3484059">[</span><span class="ident" id="3484060">j</span><span class="op" id="3484061">+</span><span class="num" id="3484062">1</span><span class="op" id="3484063">]</span>&nbsp;<span class="op" id="3484065">=</span>&nbsp;<span class="ident" id="3484067">p</span><span class="op" id="3484068">[</span><span class="ident" id="3484069">j</span><span class="op" id="3484070">]</span><span class="op" id="3484071">,</span>&nbsp;<span class="ident" id="3484073">p</span><span class="op" id="3484074">[</span><span class="ident" id="3484075">j</span><span class="op" id="3484076">+</span><span class="num" id="3484077">1</span><span class="op" id="3484078">]</span><span class="op" id="3484079">,</span>&nbsp;<span class="ident" id="3484081">p</span><span class="op" id="3484082">[</span><span class="ident" id="3484083">i</span><span class="op" id="3484084">]</span><span class="op" id="3484085">,</span>&nbsp;<span class="ident" id="3484087">p</span><span class="op" id="3484088">[</span><span class="ident" id="3484089">i</span><span class="op" id="3484090">+</span><span class="num" id="3484091">1</span><span class="op" id="3484092">]</span><br>
<span class="lineno"></span><span class="op" id="3484094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3484097">func</span>&nbsp;<span class="ident" id="3484102">checkUTF8</span><span class="op" id="3484111">(</span><span class="ident" id="3484112">s</span>&nbsp;<span class="builtintype" id="3484114">string</span><span class="op" id="3484120">)</span>&nbsp;<span class="builtintype" id="3484122">error</span>&nbsp;<span class="op" id="3484128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484131">for</span>&nbsp;<span class="ident" id="3484135">s</span>&nbsp;<span class="op" id="3484137">!=</span>&nbsp;<span class="string" id="3484140">&#34;&#34;</span>&nbsp;<span class="op" id="3484143">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3484147">rune</span><span class="op" id="3484151">,</span>&nbsp;<span class="ident" id="3484153">size</span>&nbsp;<span class="op" id="3484158">:=</span>&nbsp;<span class="ident" id="3484161">utf8</span><span class="op" id="3484165">.</span><span class="ident" id="3484166">DecodeRuneInString</span><span class="op" id="3484184">(</span><span class="ident" id="3484185">s</span><span class="op" id="3484186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484190">if</span>&nbsp;<span class="builtintype" id="3484193">rune</span>&nbsp;<span class="op" id="3484198">==</span>&nbsp;<span class="ident" id="3484201">utf8</span><span class="op" id="3484205">.</span><span class="ident" id="3484206">RuneError</span>&nbsp;<span class="op" id="3484216">&amp;&amp;</span>&nbsp;<span class="ident" id="3484219">size</span>&nbsp;<span class="op" id="3484224">==</span>&nbsp;<span class="num" id="3484227">1</span>&nbsp;<span class="op" id="3484229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484234">return</span>&nbsp;<span class="op" id="3484241">&amp;</span><span class="ident" id="3484242">Error</span><span class="op" id="3484247">{</span><span class="ident" id="3484248">Code</span><span class="op" id="3484252">:</span>&nbsp;<span class="ident" id="3484254">ErrInvalidUTF8</span><span class="op" id="3484268">,</span>&nbsp;<span class="ident" id="3484270">Expr</span><span class="op" id="3484274">:</span>&nbsp;<span class="ident" id="3484276">s</span><span class="op" id="3484277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484285">s</span>&nbsp;<span class="op" id="3484287">=</span>&nbsp;<span class="ident" id="3484289">s</span><span class="op" id="3484290">[</span><span class="ident" id="3484291">size</span><span class="op" id="3484295">:</span><span class="op" id="3484296">]</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484302">return</span>&nbsp;<span class="ident" id="3484309">nil</span><br>
<span class="lineno"></span><span class="op" id="3484313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3484316">func</span>&nbsp;<span class="ident" id="3484321">nextRune</span><span class="op" id="3484329">(</span><span class="ident" id="3484330">s</span>&nbsp;<span class="builtintype" id="3484332">string</span><span class="op" id="3484338">)</span>&nbsp;<span class="op" id="3484340">(</span><span class="ident" id="3484341">c</span>&nbsp;<span class="builtintype" id="3484343">rune</span><span class="op" id="3484347">,</span>&nbsp;<span class="ident" id="3484349">t</span>&nbsp;<span class="builtintype" id="3484351">string</span><span class="op" id="3484357">,</span>&nbsp;<span class="ident" id="3484359">err</span>&nbsp;<span class="builtintype" id="3484363">error</span><span class="op" id="3484368">)</span>&nbsp;<span class="op" id="3484370">{</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484373">c</span><span class="op" id="3484374">,</span>&nbsp;<span class="ident" id="3484376">size</span>&nbsp;<span class="op" id="3484381">:=</span>&nbsp;<span class="ident" id="3484384">utf8</span><span class="op" id="3484388">.</span><span class="ident" id="3484389">DecodeRuneInString</span><span class="op" id="3484407">(</span><span class="ident" id="3484408">s</span><span class="op" id="3484409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484412">if</span>&nbsp;<span class="ident" id="3484415">c</span>&nbsp;<span class="op" id="3484417">==</span>&nbsp;<span class="ident" id="3484420">utf8</span><span class="op" id="3484424">.</span><span class="ident" id="3484425">RuneError</span>&nbsp;<span class="op" id="3484435">&amp;&amp;</span>&nbsp;<span class="ident" id="3484438">size</span>&nbsp;<span class="op" id="3484443">==</span>&nbsp;<span class="num" id="3484446">1</span>&nbsp;<span class="op" id="3484448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484452">return</span>&nbsp;<span class="num" id="3484459">0</span><span class="op" id="3484460">,</span>&nbsp;<span class="string" id="3484462">&#34;&#34;</span><span class="op" id="3484464">,</span>&nbsp;<span class="op" id="3484466">&amp;</span><span class="ident" id="3484467">Error</span><span class="op" id="3484472">{</span><span class="ident" id="3484473">Code</span><span class="op" id="3484477">:</span>&nbsp;<span class="ident" id="3484479">ErrInvalidUTF8</span><span class="op" id="3484493">,</span>&nbsp;<span class="ident" id="3484495">Expr</span><span class="op" id="3484499">:</span>&nbsp;<span class="ident" id="3484501">s</span><span class="op" id="3484502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484508">return</span>&nbsp;<span class="ident" id="3484515">c</span><span class="op" id="3484516">,</span>&nbsp;<span class="ident" id="3484518">s</span><span class="op" id="3484519">[</span><span class="ident" id="3484520">size</span><span class="op" id="3484524">:</span><span class="op" id="3484525">]</span><span class="op" id="3484526">,</span>&nbsp;<span class="ident" id="3484528">nil</span><br>
<span class="lineno">1885</span><span class="op" id="3484532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3484535">func</span>&nbsp;<span class="ident" id="3484540">isalnum</span><span class="op" id="3484547">(</span><span class="ident" id="3484548">c</span>&nbsp;<span class="builtintype" id="3484550">rune</span><span class="op" id="3484554">)</span>&nbsp;<span class="builtintype" id="3484556">bool</span>&nbsp;<span class="op" id="3484561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484564">return</span>&nbsp;<span class="string" id="3484571">&#39;0&#39;</span>&nbsp;<span class="op" id="3484575">&lt;=</span>&nbsp;<span class="ident" id="3484578">c</span>&nbsp;<span class="op" id="3484580">&amp;&amp;</span>&nbsp;<span class="ident" id="3484583">c</span>&nbsp;<span class="op" id="3484585">&lt;=</span>&nbsp;<span class="string" id="3484588">&#39;9&#39;</span>&nbsp;<span class="op" id="3484592">||</span>&nbsp;<span class="string" id="3484595">&#39;A&#39;</span>&nbsp;<span class="op" id="3484599">&lt;=</span>&nbsp;<span class="ident" id="3484602">c</span>&nbsp;<span class="op" id="3484604">&amp;&amp;</span>&nbsp;<span class="ident" id="3484607">c</span>&nbsp;<span class="op" id="3484609">&lt;=</span>&nbsp;<span class="string" id="3484612">&#39;Z&#39;</span>&nbsp;<span class="op" id="3484616">||</span>&nbsp;<span class="string" id="3484619">&#39;a&#39;</span>&nbsp;<span class="op" id="3484623">&lt;=</span>&nbsp;<span class="ident" id="3484626">c</span>&nbsp;<span class="op" id="3484628">&amp;&amp;</span>&nbsp;<span class="ident" id="3484631">c</span>&nbsp;<span class="op" id="3484633">&lt;=</span>&nbsp;<span class="string" id="3484636">&#39;z&#39;</span><br>
<span class="lineno"></span><span class="op" id="3484640">}</span><br>
<span class="lineno">1890</span><br>
<span class="lineno"></span><span class="keyword" id="3484643">func</span>&nbsp;<span class="ident" id="3484648">unhex</span><span class="op" id="3484653">(</span><span class="ident" id="3484654">c</span>&nbsp;<span class="builtintype" id="3484656">rune</span><span class="op" id="3484660">)</span>&nbsp;<span class="builtintype" id="3484662">rune</span>&nbsp;<span class="op" id="3484667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484670">if</span>&nbsp;<span class="string" id="3484673">&#39;0&#39;</span>&nbsp;<span class="op" id="3484677">&lt;=</span>&nbsp;<span class="ident" id="3484680">c</span>&nbsp;<span class="op" id="3484682">&amp;&amp;</span>&nbsp;<span class="ident" id="3484685">c</span>&nbsp;<span class="op" id="3484687">&lt;=</span>&nbsp;<span class="string" id="3484690">&#39;9&#39;</span>&nbsp;<span class="op" id="3484694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484698">return</span>&nbsp;<span class="ident" id="3484705">c</span>&nbsp;<span class="op" id="3484707">-</span>&nbsp;<span class="string" id="3484709">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484714">}</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484717">if</span>&nbsp;<span class="string" id="3484720">&#39;a&#39;</span>&nbsp;<span class="op" id="3484724">&lt;=</span>&nbsp;<span class="ident" id="3484727">c</span>&nbsp;<span class="op" id="3484729">&amp;&amp;</span>&nbsp;<span class="ident" id="3484732">c</span>&nbsp;<span class="op" id="3484734">&lt;=</span>&nbsp;<span class="string" id="3484737">&#39;f&#39;</span>&nbsp;<span class="op" id="3484741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484745">return</span>&nbsp;<span class="ident" id="3484752">c</span>&nbsp;<span class="op" id="3484754">-</span>&nbsp;<span class="string" id="3484756">&#39;a&#39;</span>&nbsp;<span class="op" id="3484760">+</span>&nbsp;<span class="num" id="3484762">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484769">if</span>&nbsp;<span class="string" id="3484772">&#39;A&#39;</span>&nbsp;<span class="op" id="3484776">&lt;=</span>&nbsp;<span class="ident" id="3484779">c</span>&nbsp;<span class="op" id="3484781">&amp;&amp;</span>&nbsp;<span class="ident" id="3484784">c</span>&nbsp;<span class="op" id="3484786">&lt;=</span>&nbsp;<span class="string" id="3484789">&#39;F&#39;</span>&nbsp;<span class="op" id="3484793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484797">return</span>&nbsp;<span class="ident" id="3484804">c</span>&nbsp;<span class="op" id="3484806">-</span>&nbsp;<span class="string" id="3484808">&#39;A&#39;</span>&nbsp;<span class="op" id="3484812">+</span>&nbsp;<span class="num" id="3484814">10</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484821">return</span>&nbsp;<span class="op" id="3484828">-</span><span class="num" id="3484829">1</span><br>
<span class="lineno"></span><span class="op" id="3484831">}</span>
</div>
</body>
</html>
