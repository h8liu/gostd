<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5978206">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5978261">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5978315">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5978366">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5978426">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5978439">package</span>&nbsp;<span class="ident" id="5978447">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5978452">import</span>&nbsp;<span class="op" id="5978459">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978462">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978471">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978485">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978495">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978502">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978508">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978521">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978528">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978540">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978551">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978557">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5978568">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5978578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5978581">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5978647">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5978709">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5978750">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5978810">func</span>&nbsp;<span class="ident" id="5978815">Request</span><span class="op" id="5978822">(</span><span class="op" id="5978823">)</span>&nbsp;<span class="op" id="5978825">(</span><span class="op" id="5978826">*</span><span class="ident" id="5978827">http</span><span class="op" id="5978831">.</span><span class="ident" id="5978832">Request</span><span class="op" id="5978839">,</span>&nbsp;<span class="builtintype" id="5978841">error</span><span class="op" id="5978846">)</span>&nbsp;<span class="op" id="5978848">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978851">r</span><span class="op" id="5978852">,</span>&nbsp;<span class="ident" id="5978854">err</span>&nbsp;<span class="op" id="5978858">:=</span>&nbsp;<span class="ident" id="5978861">RequestFromMap</span><span class="op" id="5978875">(</span><span class="ident" id="5978876">envMap</span><span class="op" id="5978882">(</span><span class="ident" id="5978883">os</span><span class="op" id="5978885">.</span><span class="ident" id="5978886">Environ</span><span class="op" id="5978893">(</span><span class="op" id="5978894">)</span><span class="op" id="5978895">)</span><span class="op" id="5978896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978899">if</span>&nbsp;<span class="ident" id="5978902">err</span>&nbsp;<span class="op" id="5978906">!=</span>&nbsp;<span class="ident" id="5978909">nil</span>&nbsp;<span class="op" id="5978913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978917">return</span>&nbsp;<span class="ident" id="5978924">nil</span><span class="op" id="5978927">,</span>&nbsp;<span class="ident" id="5978929">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978937">if</span>&nbsp;<span class="ident" id="5978940">r</span><span class="op" id="5978941">.</span><span class="ident" id="5978942">ContentLength</span>&nbsp;<span class="op" id="5978956">&gt;</span>&nbsp;<span class="num" id="5978958">0</span>&nbsp;<span class="op" id="5978960">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978964">r</span><span class="op" id="5978965">.</span><span class="ident" id="5978966">Body</span>&nbsp;<span class="op" id="5978971">=</span>&nbsp;<span class="ident" id="5978973">ioutil</span><span class="op" id="5978979">.</span><span class="ident" id="5978980">NopCloser</span><span class="op" id="5978989">(</span><span class="ident" id="5978990">io</span><span class="op" id="5978992">.</span><span class="ident" id="5978993">LimitReader</span><span class="op" id="5979004">(</span><span class="ident" id="5979005">os</span><span class="op" id="5979007">.</span><span class="ident" id="5979008">Stdin</span><span class="op" id="5979013">,</span>&nbsp;<span class="ident" id="5979015">r</span><span class="op" id="5979016">.</span><span class="ident" id="5979017">ContentLength</span><span class="op" id="5979030">)</span><span class="op" id="5979031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979037">return</span>&nbsp;<span class="ident" id="5979044">r</span><span class="op" id="5979045">,</span>&nbsp;<span class="ident" id="5979047">nil</span><br>
<span class="lineno"></span><span class="op" id="5979051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5979054">func</span>&nbsp;<span class="ident" id="5979059">envMap</span><span class="op" id="5979065">(</span><span class="ident" id="5979066">env</span>&nbsp;<span class="op" id="5979070">[</span><span class="op" id="5979071">]</span><span class="builtintype" id="5979072">string</span><span class="op" id="5979078">)</span>&nbsp;<span class="keyword" id="5979080">map</span><span class="op" id="5979083">[</span><span class="builtintype" id="5979084">string</span><span class="op" id="5979090">]</span><span class="builtintype" id="5979091">string</span>&nbsp;<span class="op" id="5979098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979101">m</span>&nbsp;<span class="op" id="5979103">:=</span>&nbsp;<span class="builtinfunc" id="5979106">make</span><span class="op" id="5979110">(</span><span class="keyword" id="5979111">map</span><span class="op" id="5979114">[</span><span class="builtintype" id="5979115">string</span><span class="op" id="5979121">]</span><span class="builtintype" id="5979122">string</span><span class="op" id="5979128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979131">for</span>&nbsp;<span class="ident" id="5979135">_</span><span class="op" id="5979136">,</span>&nbsp;<span class="ident" id="5979138">kv</span>&nbsp;<span class="op" id="5979141">:=</span>&nbsp;<span class="keyword" id="5979144">range</span>&nbsp;<span class="ident" id="5979150">env</span>&nbsp;<span class="op" id="5979154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979158">if</span>&nbsp;<span class="ident" id="5979161">idx</span>&nbsp;<span class="op" id="5979165">:=</span>&nbsp;<span class="ident" id="5979168">strings</span><span class="op" id="5979175">.</span><span class="ident" id="5979176">Index</span><span class="op" id="5979181">(</span><span class="ident" id="5979182">kv</span><span class="op" id="5979184">,</span>&nbsp;<span class="string" id="5979186">&#34;=&#34;</span><span class="op" id="5979189">)</span><span class="op" id="5979190">;</span>&nbsp;<span class="ident" id="5979192">idx</span>&nbsp;<span class="op" id="5979196">!=</span>&nbsp;<span class="op" id="5979199">-</span><span class="num" id="5979200">1</span>&nbsp;<span class="op" id="5979202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979207">m</span><span class="op" id="5979208">[</span><span class="ident" id="5979209">kv</span><span class="op" id="5979211">[</span><span class="op" id="5979212">:</span><span class="ident" id="5979213">idx</span><span class="op" id="5979216">]</span><span class="op" id="5979217">]</span>&nbsp;<span class="op" id="5979219">=</span>&nbsp;<span class="ident" id="5979221">kv</span><span class="op" id="5979223">[</span><span class="ident" id="5979224">idx</span><span class="op" id="5979227">+</span><span class="num" id="5979228">1</span><span class="op" id="5979229">:</span><span class="op" id="5979230">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979240">return</span>&nbsp;<span class="ident" id="5979247">m</span><br>
<span class="lineno"></span><span class="op" id="5979249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5979252">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5979314">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5979369">func</span>&nbsp;<span class="ident" id="5979374">RequestFromMap</span><span class="op" id="5979388">(</span><span class="ident" id="5979389">params</span>&nbsp;<span class="keyword" id="5979396">map</span><span class="op" id="5979399">[</span><span class="builtintype" id="5979400">string</span><span class="op" id="5979406">]</span><span class="builtintype" id="5979407">string</span><span class="op" id="5979413">)</span>&nbsp;<span class="op" id="5979415">(</span><span class="op" id="5979416">*</span><span class="ident" id="5979417">http</span><span class="op" id="5979421">.</span><span class="ident" id="5979422">Request</span><span class="op" id="5979429">,</span>&nbsp;<span class="builtintype" id="5979431">error</span><span class="op" id="5979436">)</span>&nbsp;<span class="op" id="5979438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979441">r</span>&nbsp;<span class="op" id="5979443">:=</span>&nbsp;<span class="builtinfunc" id="5979446">new</span><span class="op" id="5979449">(</span><span class="ident" id="5979450">http</span><span class="op" id="5979454">.</span><span class="ident" id="5979455">Request</span><span class="op" id="5979462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979465">r</span><span class="op" id="5979466">.</span><span class="ident" id="5979467">Method</span>&nbsp;<span class="op" id="5979474">=</span>&nbsp;<span class="ident" id="5979476">params</span><span class="op" id="5979482">[</span><span class="string" id="5979483">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5979499">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979502">if</span>&nbsp;<span class="ident" id="5979505">r</span><span class="op" id="5979506">.</span><span class="ident" id="5979507">Method</span>&nbsp;<span class="op" id="5979514">==</span>&nbsp;<span class="string" id="5979517">&#34;&#34;</span>&nbsp;<span class="op" id="5979520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979524">return</span>&nbsp;<span class="ident" id="5979531">nil</span><span class="op" id="5979534">,</span>&nbsp;<span class="ident" id="5979536">errors</span><span class="op" id="5979542">.</span><span class="ident" id="5979543">New</span><span class="op" id="5979546">(</span><span class="string" id="5979547">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5979586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979593">r</span><span class="op" id="5979594">.</span><span class="ident" id="5979595">Proto</span>&nbsp;<span class="op" id="5979601">=</span>&nbsp;<span class="ident" id="5979603">params</span><span class="op" id="5979609">[</span><span class="string" id="5979610">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5979627">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979630">var</span>&nbsp;<span class="ident" id="5979634">ok</span>&nbsp;<span class="builtintype" id="5979637">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979643">r</span><span class="op" id="5979644">.</span><span class="ident" id="5979645">ProtoMajor</span><span class="op" id="5979655">,</span>&nbsp;<span class="ident" id="5979657">r</span><span class="op" id="5979658">.</span><span class="ident" id="5979659">ProtoMinor</span><span class="op" id="5979669">,</span>&nbsp;<span class="ident" id="5979671">ok</span>&nbsp;<span class="op" id="5979674">=</span>&nbsp;<span class="ident" id="5979676">http</span><span class="op" id="5979680">.</span><span class="ident" id="5979681">ParseHTTPVersion</span><span class="op" id="5979697">(</span><span class="ident" id="5979698">r</span><span class="op" id="5979699">.</span><span class="ident" id="5979700">Proto</span><span class="op" id="5979705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979708">if</span>&nbsp;<span class="op" id="5979711">!</span><span class="ident" id="5979712">ok</span>&nbsp;<span class="op" id="5979715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979719">return</span>&nbsp;<span class="ident" id="5979726">nil</span><span class="op" id="5979729">,</span>&nbsp;<span class="ident" id="5979731">errors</span><span class="op" id="5979737">.</span><span class="ident" id="5979738">New</span><span class="op" id="5979741">(</span><span class="string" id="5979742">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5979780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979783">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979787">r</span><span class="op" id="5979788">.</span><span class="ident" id="5979789">Close</span>&nbsp;<span class="op" id="5979795">=</span>&nbsp;<span class="builtintype" id="5979797">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979803">r</span><span class="op" id="5979804">.</span><span class="ident" id="5979805">Trailer</span>&nbsp;<span class="op" id="5979813">=</span>&nbsp;<span class="ident" id="5979815">http</span><span class="op" id="5979819">.</span><span class="ident" id="5979820">Header</span><span class="op" id="5979826">{</span><span class="op" id="5979827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979830">r</span><span class="op" id="5979831">.</span><span class="ident" id="5979832">Header</span>&nbsp;<span class="op" id="5979839">=</span>&nbsp;<span class="ident" id="5979841">http</span><span class="op" id="5979845">.</span><span class="ident" id="5979846">Header</span><span class="op" id="5979852">{</span><span class="op" id="5979853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979857">r</span><span class="op" id="5979858">.</span><span class="ident" id="5979859">Host</span>&nbsp;<span class="op" id="5979864">=</span>&nbsp;<span class="ident" id="5979866">params</span><span class="op" id="5979872">[</span><span class="string" id="5979873">&#34;HTTP_HOST&#34;</span><span class="op" id="5979884">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979888">if</span>&nbsp;<span class="ident" id="5979891">lenstr</span>&nbsp;<span class="op" id="5979898">:=</span>&nbsp;<span class="ident" id="5979901">params</span><span class="op" id="5979907">[</span><span class="string" id="5979908">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5979924">]</span><span class="op" id="5979925">;</span>&nbsp;<span class="ident" id="5979927">lenstr</span>&nbsp;<span class="op" id="5979934">!=</span>&nbsp;<span class="string" id="5979937">&#34;&#34;</span>&nbsp;<span class="op" id="5979940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979944">clen</span><span class="op" id="5979948">,</span>&nbsp;<span class="ident" id="5979950">err</span>&nbsp;<span class="op" id="5979954">:=</span>&nbsp;<span class="ident" id="5979957">strconv</span><span class="op" id="5979964">.</span><span class="ident" id="5979965">ParseInt</span><span class="op" id="5979973">(</span><span class="ident" id="5979974">lenstr</span><span class="op" id="5979980">,</span>&nbsp;<span class="num" id="5979982">10</span><span class="op" id="5979984">,</span>&nbsp;<span class="num" id="5979986">64</span><span class="op" id="5979988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979992">if</span>&nbsp;<span class="ident" id="5979995">err</span>&nbsp;<span class="op" id="5979999">!=</span>&nbsp;<span class="ident" id="5980002">nil</span>&nbsp;<span class="op" id="5980006">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980011">return</span>&nbsp;<span class="ident" id="5980018">nil</span><span class="op" id="5980021">,</span>&nbsp;<span class="ident" id="5980023">errors</span><span class="op" id="5980029">.</span><span class="ident" id="5980030">New</span><span class="op" id="5980033">(</span><span class="string" id="5980034">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5980077">+</span>&nbsp;<span class="ident" id="5980079">lenstr</span><span class="op" id="5980085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980093">r</span><span class="op" id="5980094">.</span><span class="ident" id="5980095">ContentLength</span>&nbsp;<span class="op" id="5980109">=</span>&nbsp;<span class="ident" id="5980111">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980121">if</span>&nbsp;<span class="ident" id="5980124">ct</span>&nbsp;<span class="op" id="5980127">:=</span>&nbsp;<span class="ident" id="5980130">params</span><span class="op" id="5980136">[</span><span class="string" id="5980137">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5980151">]</span><span class="op" id="5980152">;</span>&nbsp;<span class="ident" id="5980154">ct</span>&nbsp;<span class="op" id="5980157">!=</span>&nbsp;<span class="string" id="5980160">&#34;&#34;</span>&nbsp;<span class="op" id="5980163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980167">r</span><span class="op" id="5980168">.</span><span class="ident" id="5980169">Header</span><span class="op" id="5980175">.</span><span class="ident" id="5980176">Set</span><span class="op" id="5980179">(</span><span class="string" id="5980180">&#34;Content-Type&#34;</span><span class="op" id="5980194">,</span>&nbsp;<span class="ident" id="5980196">ct</span><span class="op" id="5980198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980205">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980260">for</span>&nbsp;<span class="ident" id="5980264">k</span><span class="op" id="5980265">,</span>&nbsp;<span class="ident" id="5980267">v</span>&nbsp;<span class="op" id="5980269">:=</span>&nbsp;<span class="keyword" id="5980272">range</span>&nbsp;<span class="ident" id="5980278">params</span>&nbsp;<span class="op" id="5980285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980289">if</span>&nbsp;<span class="op" id="5980292">!</span><span class="ident" id="5980293">strings</span><span class="op" id="5980300">.</span><span class="ident" id="5980301">HasPrefix</span><span class="op" id="5980310">(</span><span class="ident" id="5980311">k</span><span class="op" id="5980312">,</span>&nbsp;<span class="string" id="5980314">&#34;HTTP_&#34;</span><span class="op" id="5980321">)</span>&nbsp;<span class="op" id="5980323">||</span>&nbsp;<span class="ident" id="5980326">k</span>&nbsp;<span class="op" id="5980328">==</span>&nbsp;<span class="string" id="5980331">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5980343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980348">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980363">r</span><span class="op" id="5980364">.</span><span class="ident" id="5980365">Header</span><span class="op" id="5980371">.</span><span class="ident" id="5980372">Add</span><span class="op" id="5980375">(</span><span class="ident" id="5980376">strings</span><span class="op" id="5980383">.</span><span class="ident" id="5980384">Replace</span><span class="op" id="5980391">(</span><span class="ident" id="5980392">k</span><span class="op" id="5980393">[</span><span class="num" id="5980394">5</span><span class="op" id="5980395">:</span><span class="op" id="5980396">]</span><span class="op" id="5980397">,</span>&nbsp;<span class="string" id="5980399">&#34;_&#34;</span><span class="op" id="5980402">,</span>&nbsp;<span class="string" id="5980404">&#34;-&#34;</span><span class="op" id="5980407">,</span>&nbsp;<span class="op" id="5980409">-</span><span class="num" id="5980410">1</span><span class="op" id="5980411">)</span><span class="op" id="5980412">,</span>&nbsp;<span class="ident" id="5980414">v</span><span class="op" id="5980415">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980422">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980480">uriStr</span>&nbsp;<span class="op" id="5980487">:=</span>&nbsp;<span class="ident" id="5980490">params</span><span class="op" id="5980496">[</span><span class="string" id="5980497">&#34;REQUEST_URI&#34;</span><span class="op" id="5980510">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980513">if</span>&nbsp;<span class="ident" id="5980516">uriStr</span>&nbsp;<span class="op" id="5980523">==</span>&nbsp;<span class="string" id="5980526">&#34;&#34;</span>&nbsp;<span class="op" id="5980529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980533">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980591">uriStr</span>&nbsp;<span class="op" id="5980598">=</span>&nbsp;<span class="ident" id="5980600">params</span><span class="op" id="5980606">[</span><span class="string" id="5980607">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5980620">]</span>&nbsp;<span class="op" id="5980622">+</span>&nbsp;<span class="ident" id="5980624">params</span><span class="op" id="5980630">[</span><span class="string" id="5980631">&#34;PATH_INFO&#34;</span><span class="op" id="5980642">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980646">s</span>&nbsp;<span class="op" id="5980648">:=</span>&nbsp;<span class="ident" id="5980651">params</span><span class="op" id="5980657">[</span><span class="string" id="5980658">&#34;QUERY_STRING&#34;</span><span class="op" id="5980672">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980676">if</span>&nbsp;<span class="ident" id="5980679">s</span>&nbsp;<span class="op" id="5980681">!=</span>&nbsp;<span class="string" id="5980684">&#34;&#34;</span>&nbsp;<span class="op" id="5980687">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980692">uriStr</span>&nbsp;<span class="op" id="5980699">+=</span>&nbsp;<span class="string" id="5980702">&#34;?&#34;</span>&nbsp;<span class="op" id="5980706">+</span>&nbsp;<span class="ident" id="5980708">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980719">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980772">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980839">if</span>&nbsp;<span class="ident" id="5980842">s</span>&nbsp;<span class="op" id="5980844">:=</span>&nbsp;<span class="ident" id="5980847">params</span><span class="op" id="5980853">[</span><span class="string" id="5980854">&#34;HTTPS&#34;</span><span class="op" id="5980861">]</span><span class="op" id="5980862">;</span>&nbsp;<span class="ident" id="5980864">s</span>&nbsp;<span class="op" id="5980866">==</span>&nbsp;<span class="string" id="5980869">&#34;on&#34;</span>&nbsp;<span class="op" id="5980874">||</span>&nbsp;<span class="ident" id="5980877">s</span>&nbsp;<span class="op" id="5980879">==</span>&nbsp;<span class="string" id="5980882">&#34;ON&#34;</span>&nbsp;<span class="op" id="5980887">||</span>&nbsp;<span class="ident" id="5980890">s</span>&nbsp;<span class="op" id="5980892">==</span>&nbsp;<span class="string" id="5980895">&#34;1&#34;</span>&nbsp;<span class="op" id="5980899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980903">r</span><span class="op" id="5980904">.</span><span class="ident" id="5980905">TLS</span>&nbsp;<span class="op" id="5980909">=</span>&nbsp;<span class="op" id="5980911">&amp;</span><span class="ident" id="5980912">tls</span><span class="op" id="5980915">.</span><span class="ident" id="5980916">ConnectionState</span><span class="op" id="5980931">{</span><span class="ident" id="5980932">HandshakeComplete</span><span class="op" id="5980949">:</span>&nbsp;<span class="builtintype" id="5980951">true</span><span class="op" id="5980955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980962">if</span>&nbsp;<span class="ident" id="5980965">r</span><span class="op" id="5980966">.</span><span class="ident" id="5980967">Host</span>&nbsp;<span class="op" id="5980972">!=</span>&nbsp;<span class="string" id="5980975">&#34;&#34;</span>&nbsp;<span class="op" id="5980978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980982">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981047">rawurl</span>&nbsp;<span class="op" id="5981054">:=</span>&nbsp;<span class="ident" id="5981057">r</span><span class="op" id="5981058">.</span><span class="ident" id="5981059">Host</span>&nbsp;<span class="op" id="5981064">+</span>&nbsp;<span class="ident" id="5981066">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981075">if</span>&nbsp;<span class="ident" id="5981078">r</span><span class="op" id="5981079">.</span><span class="ident" id="5981080">TLS</span>&nbsp;<span class="op" id="5981084">==</span>&nbsp;<span class="ident" id="5981087">nil</span>&nbsp;<span class="op" id="5981091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981096">rawurl</span>&nbsp;<span class="op" id="5981103">=</span>&nbsp;<span class="string" id="5981105">&#34;http://&#34;</span>&nbsp;<span class="op" id="5981115">+</span>&nbsp;<span class="ident" id="5981117">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981126">}</span>&nbsp;<span class="keyword" id="5981128">else</span>&nbsp;<span class="op" id="5981133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981138">rawurl</span>&nbsp;<span class="op" id="5981145">=</span>&nbsp;<span class="string" id="5981147">&#34;https://&#34;</span>&nbsp;<span class="op" id="5981158">+</span>&nbsp;<span class="ident" id="5981160">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981173">url</span><span class="op" id="5981176">,</span>&nbsp;<span class="ident" id="5981178">err</span>&nbsp;<span class="op" id="5981182">:=</span>&nbsp;<span class="ident" id="5981185">url</span><span class="op" id="5981188">.</span><span class="ident" id="5981189">Parse</span><span class="op" id="5981194">(</span><span class="ident" id="5981195">rawurl</span><span class="op" id="5981201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981205">if</span>&nbsp;<span class="ident" id="5981208">err</span>&nbsp;<span class="op" id="5981212">!=</span>&nbsp;<span class="ident" id="5981215">nil</span>&nbsp;<span class="op" id="5981219">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981224">return</span>&nbsp;<span class="ident" id="5981231">nil</span><span class="op" id="5981234">,</span>&nbsp;<span class="ident" id="5981236">errors</span><span class="op" id="5981242">.</span><span class="ident" id="5981243">New</span><span class="op" id="5981246">(</span><span class="string" id="5981247">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5981304">+</span>&nbsp;<span class="ident" id="5981306">rawurl</span><span class="op" id="5981312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981320">r</span><span class="op" id="5981321">.</span><span class="ident" id="5981322">URL</span>&nbsp;<span class="op" id="5981326">=</span>&nbsp;<span class="ident" id="5981328">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981336">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981397">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981417">if</span>&nbsp;<span class="ident" id="5981420">r</span><span class="op" id="5981421">.</span><span class="ident" id="5981422">URL</span>&nbsp;<span class="op" id="5981426">==</span>&nbsp;<span class="ident" id="5981429">nil</span>&nbsp;<span class="op" id="5981433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981437">url</span><span class="op" id="5981440">,</span>&nbsp;<span class="ident" id="5981442">err</span>&nbsp;<span class="op" id="5981446">:=</span>&nbsp;<span class="ident" id="5981449">url</span><span class="op" id="5981452">.</span><span class="ident" id="5981453">Parse</span><span class="op" id="5981458">(</span><span class="ident" id="5981459">uriStr</span><span class="op" id="5981465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981469">if</span>&nbsp;<span class="ident" id="5981472">err</span>&nbsp;<span class="op" id="5981476">!=</span>&nbsp;<span class="ident" id="5981479">nil</span>&nbsp;<span class="op" id="5981483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981488">return</span>&nbsp;<span class="ident" id="5981495">nil</span><span class="op" id="5981498">,</span>&nbsp;<span class="ident" id="5981500">errors</span><span class="op" id="5981506">.</span><span class="ident" id="5981507">New</span><span class="op" id="5981510">(</span><span class="string" id="5981511">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5981559">+</span>&nbsp;<span class="ident" id="5981561">uriStr</span><span class="op" id="5981567">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981575">r</span><span class="op" id="5981576">.</span><span class="ident" id="5981577">URL</span>&nbsp;<span class="op" id="5981581">=</span>&nbsp;<span class="ident" id="5981583">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981592">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981654">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981718">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981739">r</span><span class="op" id="5981740">.</span><span class="ident" id="5981741">RemoteAddr</span>&nbsp;<span class="op" id="5981752">=</span>&nbsp;<span class="ident" id="5981754">net</span><span class="op" id="5981757">.</span><span class="ident" id="5981758">JoinHostPort</span><span class="op" id="5981770">(</span><span class="ident" id="5981771">params</span><span class="op" id="5981777">[</span><span class="string" id="5981778">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5981791">]</span><span class="op" id="5981792">,</span>&nbsp;<span class="string" id="5981794">&#34;0&#34;</span><span class="op" id="5981797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981801">return</span>&nbsp;<span class="ident" id="5981808">r</span><span class="op" id="5981809">,</span>&nbsp;<span class="ident" id="5981811">nil</span><br>
<span class="lineno">140</span><span class="op" id="5981815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5981818">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5981885">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5981943">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5982007">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5982032">func</span>&nbsp;<span class="ident" id="5982037">Serve</span><span class="op" id="5982042">(</span><span class="ident" id="5982043">handler</span>&nbsp;<span class="ident" id="5982051">http</span><span class="op" id="5982055">.</span><span class="ident" id="5982056">Handler</span><span class="op" id="5982063">)</span>&nbsp;<span class="builtintype" id="5982065">error</span>&nbsp;<span class="op" id="5982071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982074">req</span><span class="op" id="5982077">,</span>&nbsp;<span class="ident" id="5982079">err</span>&nbsp;<span class="op" id="5982083">:=</span>&nbsp;<span class="ident" id="5982086">Request</span><span class="op" id="5982093">(</span><span class="op" id="5982094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982097">if</span>&nbsp;<span class="ident" id="5982100">err</span>&nbsp;<span class="op" id="5982104">!=</span>&nbsp;<span class="ident" id="5982107">nil</span>&nbsp;<span class="op" id="5982111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982115">return</span>&nbsp;<span class="ident" id="5982122">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982130">if</span>&nbsp;<span class="ident" id="5982133">handler</span>&nbsp;<span class="op" id="5982141">==</span>&nbsp;<span class="ident" id="5982144">nil</span>&nbsp;<span class="op" id="5982148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982152">handler</span>&nbsp;<span class="op" id="5982160">=</span>&nbsp;<span class="ident" id="5982162">http</span><span class="op" id="5982166">.</span><span class="ident" id="5982167">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982187">rw</span>&nbsp;<span class="op" id="5982190">:=</span>&nbsp;<span class="op" id="5982193">&amp;</span><span class="ident" id="5982194">response</span><span class="op" id="5982202">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982206">req</span><span class="op" id="5982209">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5982214">req</span><span class="op" id="5982217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982221">header</span><span class="op" id="5982227">:</span>&nbsp;<span class="builtinfunc" id="5982229">make</span><span class="op" id="5982233">(</span><span class="ident" id="5982234">http</span><span class="op" id="5982238">.</span><span class="ident" id="5982239">Header</span><span class="op" id="5982245">)</span><span class="op" id="5982246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982250">bufw</span><span class="op" id="5982254">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5982258">bufio</span><span class="op" id="5982263">.</span><span class="ident" id="5982264">NewWriter</span><span class="op" id="5982273">(</span><span class="ident" id="5982274">os</span><span class="op" id="5982276">.</span><span class="ident" id="5982277">Stdout</span><span class="op" id="5982283">)</span><span class="op" id="5982284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982290">handler</span><span class="op" id="5982297">.</span><span class="ident" id="5982298">ServeHTTP</span><span class="op" id="5982307">(</span><span class="ident" id="5982308">rw</span><span class="op" id="5982310">,</span>&nbsp;<span class="ident" id="5982312">req</span><span class="op" id="5982315">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982318">rw</span><span class="op" id="5982320">.</span><span class="ident" id="5982321">Write</span><span class="op" id="5982326">(</span><span class="ident" id="5982327">nil</span><span class="op" id="5982330">)</span>&nbsp;<span class="comment" id="5982332">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982365">if</span>&nbsp;<span class="ident" id="5982368">err</span>&nbsp;<span class="op" id="5982372">=</span>&nbsp;<span class="ident" id="5982374">rw</span><span class="op" id="5982376">.</span><span class="ident" id="5982377">bufw</span><span class="op" id="5982381">.</span><span class="ident" id="5982382">Flush</span><span class="op" id="5982387">(</span><span class="op" id="5982388">)</span><span class="op" id="5982389">;</span>&nbsp;<span class="ident" id="5982391">err</span>&nbsp;<span class="op" id="5982395">!=</span>&nbsp;<span class="ident" id="5982398">nil</span>&nbsp;<span class="op" id="5982402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982406">return</span>&nbsp;<span class="ident" id="5982413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982421">return</span>&nbsp;<span class="ident" id="5982428">nil</span><br>
<span class="lineno">165</span><span class="op" id="5982432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5982435">type</span>&nbsp;<span class="ident" id="5982440">response</span>&nbsp;<span class="keyword" id="5982449">struct</span>&nbsp;<span class="op" id="5982456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982459">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5982470">*</span><span class="ident" id="5982471">http</span><span class="op" id="5982475">.</span><span class="ident" id="5982476">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982485">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5982496">http</span><span class="op" id="5982500">.</span><span class="ident" id="5982501">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982509">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5982520">*</span><span class="ident" id="5982521">bufio</span><span class="op" id="5982526">.</span><span class="ident" id="5982527">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982535">headerSent</span>&nbsp;<span class="builtintype" id="5982546">bool</span><br>
<span class="lineno"></span><span class="op" id="5982551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5982554">func</span>&nbsp;<span class="op" id="5982559">(</span><span class="ident" id="5982560">r</span>&nbsp;<span class="op" id="5982562">*</span><span class="ident" id="5982563">response</span><span class="op" id="5982571">)</span>&nbsp;<span class="ident" id="5982573">Flush</span><span class="op" id="5982578">(</span><span class="op" id="5982579">)</span>&nbsp;<span class="op" id="5982581">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982584">r</span><span class="op" id="5982585">.</span><span class="ident" id="5982586">bufw</span><span class="op" id="5982590">.</span><span class="ident" id="5982591">Flush</span><span class="op" id="5982596">(</span><span class="op" id="5982597">)</span><br>
<span class="lineno"></span><span class="op" id="5982599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5982602">func</span>&nbsp;<span class="op" id="5982607">(</span><span class="ident" id="5982608">r</span>&nbsp;<span class="op" id="5982610">*</span><span class="ident" id="5982611">response</span><span class="op" id="5982619">)</span>&nbsp;<span class="ident" id="5982621">Header</span><span class="op" id="5982627">(</span><span class="op" id="5982628">)</span>&nbsp;<span class="ident" id="5982630">http</span><span class="op" id="5982634">.</span><span class="ident" id="5982635">Header</span>&nbsp;<span class="op" id="5982642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982645">return</span>&nbsp;<span class="ident" id="5982652">r</span><span class="op" id="5982653">.</span><span class="ident" id="5982654">header</span><br>
<span class="lineno">180</span><span class="op" id="5982661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5982664">func</span>&nbsp;<span class="op" id="5982669">(</span><span class="ident" id="5982670">r</span>&nbsp;<span class="op" id="5982672">*</span><span class="ident" id="5982673">response</span><span class="op" id="5982681">)</span>&nbsp;<span class="ident" id="5982683">Write</span><span class="op" id="5982688">(</span><span class="ident" id="5982689">p</span>&nbsp;<span class="op" id="5982691">[</span><span class="op" id="5982692">]</span><span class="builtintype" id="5982693">byte</span><span class="op" id="5982697">)</span>&nbsp;<span class="op" id="5982699">(</span><span class="ident" id="5982700">n</span>&nbsp;<span class="builtintype" id="5982702">int</span><span class="op" id="5982705">,</span>&nbsp;<span class="ident" id="5982707">err</span>&nbsp;<span class="builtintype" id="5982711">error</span><span class="op" id="5982716">)</span>&nbsp;<span class="op" id="5982718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982721">if</span>&nbsp;<span class="op" id="5982724">!</span><span class="ident" id="5982725">r</span><span class="op" id="5982726">.</span><span class="ident" id="5982727">headerSent</span>&nbsp;<span class="op" id="5982738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982742">r</span><span class="op" id="5982743">.</span><span class="ident" id="5982744">WriteHeader</span><span class="op" id="5982755">(</span><span class="ident" id="5982756">http</span><span class="op" id="5982760">.</span><span class="ident" id="5982761">StatusOK</span><span class="op" id="5982769">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982775">return</span>&nbsp;<span class="ident" id="5982782">r</span><span class="op" id="5982783">.</span><span class="ident" id="5982784">bufw</span><span class="op" id="5982788">.</span><span class="ident" id="5982789">Write</span><span class="op" id="5982794">(</span><span class="ident" id="5982795">p</span><span class="op" id="5982796">)</span><br>
<span class="lineno"></span><span class="op" id="5982798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5982801">func</span>&nbsp;<span class="op" id="5982806">(</span><span class="ident" id="5982807">r</span>&nbsp;<span class="op" id="5982809">*</span><span class="ident" id="5982810">response</span><span class="op" id="5982818">)</span>&nbsp;<span class="ident" id="5982820">WriteHeader</span><span class="op" id="5982831">(</span><span class="ident" id="5982832">code</span>&nbsp;<span class="builtintype" id="5982837">int</span><span class="op" id="5982840">)</span>&nbsp;<span class="op" id="5982842">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982845">if</span>&nbsp;<span class="ident" id="5982848">r</span><span class="op" id="5982849">.</span><span class="ident" id="5982850">headerSent</span>&nbsp;<span class="op" id="5982861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5982865">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982931">fmt</span><span class="op" id="5982934">.</span><span class="ident" id="5982935">Fprintf</span><span class="op" id="5982942">(</span><span class="ident" id="5982943">os</span><span class="op" id="5982945">.</span><span class="ident" id="5982946">Stderr</span><span class="op" id="5982952">,</span>&nbsp;<span class="string" id="5982954">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5983009">,</span>&nbsp;<span class="ident" id="5983011">r</span><span class="op" id="5983012">.</span><span class="ident" id="5983013">req</span><span class="op" id="5983016">.</span><span class="ident" id="5983017">URL</span><span class="op" id="5983020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983024">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983032">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983035">r</span><span class="op" id="5983036">.</span><span class="ident" id="5983037">headerSent</span>&nbsp;<span class="op" id="5983048">=</span>&nbsp;<span class="builtintype" id="5983050">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983056">fmt</span><span class="op" id="5983059">.</span><span class="ident" id="5983060">Fprintf</span><span class="op" id="5983067">(</span><span class="ident" id="5983068">r</span><span class="op" id="5983069">.</span><span class="ident" id="5983070">bufw</span><span class="op" id="5983074">,</span>&nbsp;<span class="string" id="5983076">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5983095">,</span>&nbsp;<span class="ident" id="5983097">code</span><span class="op" id="5983101">,</span>&nbsp;<span class="ident" id="5983103">http</span><span class="op" id="5983107">.</span><span class="ident" id="5983108">StatusText</span><span class="op" id="5983118">(</span><span class="ident" id="5983119">code</span><span class="op" id="5983123">)</span><span class="op" id="5983124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5983128">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983159">if</span>&nbsp;<span class="ident" id="5983162">_</span><span class="op" id="5983163">,</span>&nbsp;<span class="ident" id="5983165">hasType</span>&nbsp;<span class="op" id="5983173">:=</span>&nbsp;<span class="ident" id="5983176">r</span><span class="op" id="5983177">.</span><span class="ident" id="5983178">header</span><span class="op" id="5983184">[</span><span class="string" id="5983185">&#34;Content-Type&#34;</span><span class="op" id="5983199">]</span><span class="op" id="5983200">;</span>&nbsp;<span class="op" id="5983202">!</span><span class="ident" id="5983203">hasType</span>&nbsp;<span class="op" id="5983211">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983215">r</span><span class="op" id="5983216">.</span><span class="ident" id="5983217">header</span><span class="op" id="5983223">.</span><span class="ident" id="5983224">Add</span><span class="op" id="5983227">(</span><span class="string" id="5983228">&#34;Content-Type&#34;</span><span class="op" id="5983242">,</span>&nbsp;<span class="string" id="5983244">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5983270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983277">r</span><span class="op" id="5983278">.</span><span class="ident" id="5983279">header</span><span class="op" id="5983285">.</span><span class="ident" id="5983286">Write</span><span class="op" id="5983291">(</span><span class="ident" id="5983292">r</span><span class="op" id="5983293">.</span><span class="ident" id="5983294">bufw</span><span class="op" id="5983298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983301">r</span><span class="op" id="5983302">.</span><span class="ident" id="5983303">bufw</span><span class="op" id="5983307">.</span><span class="ident" id="5983308">WriteString</span><span class="op" id="5983319">(</span><span class="string" id="5983320">&#34;\r\n&#34;</span><span class="op" id="5983326">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983329">r</span><span class="op" id="5983330">.</span><span class="ident" id="5983331">bufw</span><span class="op" id="5983335">.</span><span class="ident" id="5983336">Flush</span><span class="op" id="5983341">(</span><span class="op" id="5983342">)</span><br>
<span class="lineno"></span><span class="op" id="5983344">}</span>
</div>
</body>
</html>
