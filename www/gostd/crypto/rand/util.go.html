<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html" class="current">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4318265">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4318321">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4318375">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4318426">package</span>&nbsp;<span class="ident" id="4318434">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4318440">import</span>&nbsp;<span class="op" id="4318447">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4318450">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4318460">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4318466">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4318477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4318480">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="4318555">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="4318632">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="4318711">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4318790">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="4318814">var</span>&nbsp;<span class="ident" id="4318818">smallPrimes</span>&nbsp;<span class="op" id="4318830">=</span>&nbsp;<span class="op" id="4318832">[</span><span class="op" id="4318833">]</span><span class="builtintype" id="4318834">uint8</span><span class="op" id="4318839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4318842">3</span><span class="op" id="4318843">,</span>&nbsp;<span class="num" id="4318845">5</span><span class="op" id="4318846">,</span>&nbsp;<span class="num" id="4318848">7</span><span class="op" id="4318849">,</span>&nbsp;<span class="num" id="4318851">11</span><span class="op" id="4318853">,</span>&nbsp;<span class="num" id="4318855">13</span><span class="op" id="4318857">,</span>&nbsp;<span class="num" id="4318859">17</span><span class="op" id="4318861">,</span>&nbsp;<span class="num" id="4318863">19</span><span class="op" id="4318865">,</span>&nbsp;<span class="num" id="4318867">23</span><span class="op" id="4318869">,</span>&nbsp;<span class="num" id="4318871">29</span><span class="op" id="4318873">,</span>&nbsp;<span class="num" id="4318875">31</span><span class="op" id="4318877">,</span>&nbsp;<span class="num" id="4318879">37</span><span class="op" id="4318881">,</span>&nbsp;<span class="num" id="4318883">41</span><span class="op" id="4318885">,</span>&nbsp;<span class="num" id="4318887">43</span><span class="op" id="4318889">,</span>&nbsp;<span class="num" id="4318891">47</span><span class="op" id="4318893">,</span>&nbsp;<span class="num" id="4318895">53</span><span class="op" id="4318897">,</span><br>
<span class="lineno">20</span><span class="op" id="4318899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4318902">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="4318982">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4319060">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="4319130">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="4319145">var</span>&nbsp;<span class="ident" id="4319149">smallPrimesProduct</span>&nbsp;<span class="op" id="4319168">=</span>&nbsp;<span class="builtinfunc" id="4319170">new</span><span class="op" id="4319173">(</span><span class="ident" id="4319174">big</span><span class="op" id="4319177">.</span><span class="ident" id="4319178">Int</span><span class="op" id="4319181">)</span><span class="op" id="4319182">.</span><span class="ident" id="4319183">SetUint64</span><span class="op" id="4319192">(</span><span class="num" id="4319193">16294579238595022365</span><span class="op" id="4319213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4319216">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="4319286">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="4319312">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="4319391">func</span>&nbsp;<span class="ident" id="4319396">Prime</span><span class="op" id="4319401">(</span><span class="ident" id="4319402">rand</span>&nbsp;<span class="ident" id="4319407">io</span><span class="op" id="4319409">.</span><span class="ident" id="4319410">Reader</span><span class="op" id="4319416">,</span>&nbsp;<span class="ident" id="4319418">bits</span>&nbsp;<span class="builtintype" id="4319423">int</span><span class="op" id="4319426">)</span>&nbsp;<span class="op" id="4319428">(</span><span class="ident" id="4319429">p</span>&nbsp;<span class="op" id="4319431">*</span><span class="ident" id="4319432">big</span><span class="op" id="4319435">.</span><span class="ident" id="4319436">Int</span><span class="op" id="4319439">,</span>&nbsp;<span class="ident" id="4319441">err</span>&nbsp;<span class="builtintype" id="4319445">error</span><span class="op" id="4319450">)</span>&nbsp;<span class="op" id="4319452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4319455">if</span>&nbsp;<span class="ident" id="4319458">bits</span>&nbsp;<span class="op" id="4319463">&lt;</span>&nbsp;<span class="num" id="4319465">2</span>&nbsp;<span class="op" id="4319467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319471">err</span>&nbsp;<span class="op" id="4319475">=</span>&nbsp;<span class="ident" id="4319477">errors</span><span class="op" id="4319483">.</span><span class="ident" id="4319484">New</span><span class="op" id="4319487">(</span><span class="string" id="4319488">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="4319536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4319540">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4319548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319552">b</span>&nbsp;<span class="op" id="4319554">:=</span>&nbsp;<span class="builtintype" id="4319557">uint</span><span class="op" id="4319561">(</span><span class="ident" id="4319562">bits</span>&nbsp;<span class="op" id="4319567">%</span>&nbsp;<span class="num" id="4319569">8</span><span class="op" id="4319570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4319573">if</span>&nbsp;<span class="ident" id="4319576">b</span>&nbsp;<span class="op" id="4319578">==</span>&nbsp;<span class="num" id="4319581">0</span>&nbsp;<span class="op" id="4319583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319587">b</span>&nbsp;<span class="op" id="4319589">=</span>&nbsp;<span class="num" id="4319591">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4319594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319598">bytes</span>&nbsp;<span class="op" id="4319604">:=</span>&nbsp;<span class="builtinfunc" id="4319607">make</span><span class="op" id="4319611">(</span><span class="op" id="4319612">[</span><span class="op" id="4319613">]</span><span class="builtintype" id="4319614">byte</span><span class="op" id="4319618">,</span>&nbsp;<span class="op" id="4319620">(</span><span class="ident" id="4319621">bits</span><span class="op" id="4319625">+</span><span class="num" id="4319626">7</span><span class="op" id="4319627">)</span><span class="op" id="4319628">/</span><span class="num" id="4319629">8</span><span class="op" id="4319630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319633">p</span>&nbsp;<span class="op" id="4319635">=</span>&nbsp;<span class="builtinfunc" id="4319637">new</span><span class="op" id="4319640">(</span><span class="ident" id="4319641">big</span><span class="op" id="4319644">.</span><span class="ident" id="4319645">Int</span><span class="op" id="4319648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319652">bigMod</span>&nbsp;<span class="op" id="4319659">:=</span>&nbsp;<span class="builtinfunc" id="4319662">new</span><span class="op" id="4319665">(</span><span class="ident" id="4319666">big</span><span class="op" id="4319669">.</span><span class="ident" id="4319670">Int</span><span class="op" id="4319673">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4319677">for</span>&nbsp;<span class="op" id="4319681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319685">_</span><span class="op" id="4319686">,</span>&nbsp;<span class="ident" id="4319688">err</span>&nbsp;<span class="op" id="4319692">=</span>&nbsp;<span class="ident" id="4319694">io</span><span class="op" id="4319696">.</span><span class="ident" id="4319697">ReadFull</span><span class="op" id="4319705">(</span><span class="ident" id="4319706">rand</span><span class="op" id="4319710">,</span>&nbsp;<span class="ident" id="4319712">bytes</span><span class="op" id="4319717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4319721">if</span>&nbsp;<span class="ident" id="4319724">err</span>&nbsp;<span class="op" id="4319728">!=</span>&nbsp;<span class="ident" id="4319731">nil</span>&nbsp;<span class="op" id="4319735">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4319740">return</span>&nbsp;<span class="ident" id="4319747">nil</span><span class="op" id="4319750">,</span>&nbsp;<span class="ident" id="4319752">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4319758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319763">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4319844">bytes</span><span class="op" id="4319849">[</span><span class="num" id="4319850">0</span><span class="op" id="4319851">]</span>&nbsp;<span class="op" id="4319853">&amp;=</span>&nbsp;<span class="builtintype" id="4319856">uint8</span><span class="op" id="4319861">(</span><span class="builtintype" id="4319862">int</span><span class="op" id="4319865">(</span><span class="num" id="4319866">1</span><span class="op" id="4319867">&lt;&lt;</span><span class="ident" id="4319869">b</span><span class="op" id="4319870">)</span>&nbsp;<span class="op" id="4319872">-</span>&nbsp;<span class="num" id="4319874">1</span><span class="op" id="4319875">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319879">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319958">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320019">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320085">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320127">if</span>&nbsp;<span class="ident" id="4320130">b</span>&nbsp;<span class="op" id="4320132">&gt;=</span>&nbsp;<span class="num" id="4320135">2</span>&nbsp;<span class="op" id="4320137">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320142">bytes</span><span class="op" id="4320147">[</span><span class="num" id="4320148">0</span><span class="op" id="4320149">]</span>&nbsp;<span class="op" id="4320151">|=</span>&nbsp;<span class="num" id="4320154">3</span>&nbsp;<span class="op" id="4320156">&lt;&lt;</span>&nbsp;<span class="op" id="4320159">(</span><span class="ident" id="4320160">b</span>&nbsp;<span class="op" id="4320162">-</span>&nbsp;<span class="num" id="4320164">2</span><span class="op" id="4320165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320169">}</span>&nbsp;<span class="keyword" id="4320171">else</span>&nbsp;<span class="op" id="4320176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320181">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320224">bytes</span><span class="op" id="4320229">[</span><span class="num" id="4320230">0</span><span class="op" id="4320231">]</span>&nbsp;<span class="op" id="4320233">|=</span>&nbsp;<span class="num" id="4320236">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320241">if</span>&nbsp;<span class="builtinfunc" id="4320244">len</span><span class="op" id="4320247">(</span><span class="ident" id="4320248">bytes</span><span class="op" id="4320253">)</span>&nbsp;<span class="op" id="4320255">&gt;</span>&nbsp;<span class="num" id="4320257">1</span>&nbsp;<span class="op" id="4320259">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320265">bytes</span><span class="op" id="4320270">[</span><span class="num" id="4320271">1</span><span class="op" id="4320272">]</span>&nbsp;<span class="op" id="4320274">|=</span>&nbsp;<span class="num" id="4320277">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320293">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320372">bytes</span><span class="op" id="4320377">[</span><span class="builtinfunc" id="4320378">len</span><span class="op" id="4320381">(</span><span class="ident" id="4320382">bytes</span><span class="op" id="4320387">)</span><span class="op" id="4320388">-</span><span class="num" id="4320389">1</span><span class="op" id="4320390">]</span>&nbsp;<span class="op" id="4320392">|=</span>&nbsp;<span class="num" id="4320395">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320400">p</span><span class="op" id="4320401">.</span><span class="ident" id="4320402">SetBytes</span><span class="op" id="4320410">(</span><span class="ident" id="4320411">bytes</span><span class="op" id="4320416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320421">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320487">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320553">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320619">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320683">bigMod</span><span class="op" id="4320689">.</span><span class="ident" id="4320690">Mod</span><span class="op" id="4320693">(</span><span class="ident" id="4320694">p</span><span class="op" id="4320695">,</span>&nbsp;<span class="ident" id="4320697">smallPrimesProduct</span><span class="op" id="4320715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320719">mod</span>&nbsp;<span class="op" id="4320723">:=</span>&nbsp;<span class="ident" id="4320726">bigMod</span><span class="op" id="4320732">.</span><span class="ident" id="4320733">Uint64</span><span class="op" id="4320739">(</span><span class="op" id="4320740">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320744">NextDelta</span><span class="op" id="4320753">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320757">for</span>&nbsp;<span class="ident" id="4320761">delta</span>&nbsp;<span class="op" id="4320767">:=</span>&nbsp;<span class="ident" id="4320770">uint64</span><span class="op" id="4320776">(</span><span class="num" id="4320777">0</span><span class="op" id="4320778">)</span><span class="op" id="4320779">;</span>&nbsp;<span class="ident" id="4320781">delta</span>&nbsp;<span class="op" id="4320787">&lt;</span>&nbsp;<span class="num" id="4320789">1</span><span class="op" id="4320790">&lt;&lt;</span><span class="num" id="4320792">20</span><span class="op" id="4320794">;</span>&nbsp;<span class="ident" id="4320796">delta</span>&nbsp;<span class="op" id="4320802">+=</span>&nbsp;<span class="num" id="4320805">2</span>&nbsp;<span class="op" id="4320807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320812">m</span>&nbsp;<span class="op" id="4320814">:=</span>&nbsp;<span class="ident" id="4320817">mod</span>&nbsp;<span class="op" id="4320821">+</span>&nbsp;<span class="ident" id="4320823">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320832">for</span>&nbsp;<span class="ident" id="4320836">_</span><span class="op" id="4320837">,</span>&nbsp;<span class="ident" id="4320839">prime</span>&nbsp;<span class="op" id="4320845">:=</span>&nbsp;<span class="keyword" id="4320848">range</span>&nbsp;<span class="ident" id="4320854">smallPrimes</span>&nbsp;<span class="op" id="4320866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320872">if</span>&nbsp;<span class="ident" id="4320875">m</span><span class="op" id="4320876">%</span><span class="ident" id="4320877">uint64</span><span class="op" id="4320883">(</span><span class="ident" id="4320884">prime</span><span class="op" id="4320889">)</span>&nbsp;<span class="op" id="4320891">==</span>&nbsp;<span class="num" id="4320894">0</span>&nbsp;<span class="op" id="4320896">&amp;&amp;</span>&nbsp;<span class="op" id="4320899">(</span><span class="ident" id="4320900">bits</span>&nbsp;<span class="op" id="4320905">&gt;</span>&nbsp;<span class="num" id="4320907">6</span>&nbsp;<span class="op" id="4320909">||</span>&nbsp;<span class="ident" id="4320912">m</span>&nbsp;<span class="op" id="4320914">!=</span>&nbsp;<span class="ident" id="4320917">uint64</span><span class="op" id="4320923">(</span><span class="ident" id="4320924">prime</span><span class="op" id="4320929">)</span><span class="op" id="4320930">)</span>&nbsp;<span class="op" id="4320932">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320939">continue</span>&nbsp;<span class="ident" id="4320948">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4320967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320973">if</span>&nbsp;<span class="ident" id="4320976">delta</span>&nbsp;<span class="op" id="4320982">&gt;</span>&nbsp;<span class="num" id="4320984">0</span>&nbsp;<span class="op" id="4320986">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320992">bigMod</span><span class="op" id="4320998">.</span><span class="ident" id="4320999">SetUint64</span><span class="op" id="4321008">(</span><span class="ident" id="4321009">delta</span><span class="op" id="4321014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321020">p</span><span class="op" id="4321021">.</span><span class="ident" id="4321022">Add</span><span class="op" id="4321025">(</span><span class="ident" id="4321026">p</span><span class="op" id="4321027">,</span>&nbsp;<span class="ident" id="4321029">bigMod</span><span class="op" id="4321035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321045">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321053">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321058">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321124">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321185">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321196">if</span>&nbsp;<span class="ident" id="4321199">p</span><span class="op" id="4321200">.</span><span class="ident" id="4321201">ProbablyPrime</span><span class="op" id="4321214">(</span><span class="num" id="4321215">20</span><span class="op" id="4321217">)</span>&nbsp;<span class="op" id="4321219">&amp;&amp;</span>&nbsp;<span class="ident" id="4321222">p</span><span class="op" id="4321223">.</span><span class="ident" id="4321224">BitLen</span><span class="op" id="4321230">(</span><span class="op" id="4321231">)</span>&nbsp;<span class="op" id="4321233">==</span>&nbsp;<span class="ident" id="4321236">bits</span>&nbsp;<span class="op" id="4321241">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321246">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321258">}</span><br>
<span class="lineno"></span><span class="op" id="4321260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4321263">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4321337">func</span>&nbsp;<span class="ident" id="4321342">Int</span><span class="op" id="4321345">(</span><span class="ident" id="4321346">rand</span>&nbsp;<span class="ident" id="4321351">io</span><span class="op" id="4321353">.</span><span class="ident" id="4321354">Reader</span><span class="op" id="4321360">,</span>&nbsp;<span class="ident" id="4321362">max</span>&nbsp;<span class="op" id="4321366">*</span><span class="ident" id="4321367">big</span><span class="op" id="4321370">.</span><span class="ident" id="4321371">Int</span><span class="op" id="4321374">)</span>&nbsp;<span class="op" id="4321376">(</span><span class="ident" id="4321377">n</span>&nbsp;<span class="op" id="4321379">*</span><span class="ident" id="4321380">big</span><span class="op" id="4321383">.</span><span class="ident" id="4321384">Int</span><span class="op" id="4321387">,</span>&nbsp;<span class="ident" id="4321389">err</span>&nbsp;<span class="builtintype" id="4321393">error</span><span class="op" id="4321398">)</span>&nbsp;<span class="op" id="4321400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321403">if</span>&nbsp;<span class="ident" id="4321406">max</span><span class="op" id="4321409">.</span><span class="ident" id="4321410">Sign</span><span class="op" id="4321414">(</span><span class="op" id="4321415">)</span>&nbsp;<span class="op" id="4321417">&lt;=</span>&nbsp;<span class="num" id="4321420">0</span>&nbsp;<span class="op" id="4321422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4321426">panic</span><span class="op" id="4321431">(</span><span class="string" id="4321432">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="4321470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321473">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321476">k</span>&nbsp;<span class="op" id="4321478">:=</span>&nbsp;<span class="op" id="4321481">(</span><span class="ident" id="4321482">max</span><span class="op" id="4321485">.</span><span class="ident" id="4321486">BitLen</span><span class="op" id="4321492">(</span><span class="op" id="4321493">)</span>&nbsp;<span class="op" id="4321495">+</span>&nbsp;<span class="num" id="4321497">7</span><span class="op" id="4321498">)</span>&nbsp;<span class="op" id="4321500">/</span>&nbsp;<span class="num" id="4321502">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321506">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321571">b</span>&nbsp;<span class="op" id="4321573">:=</span>&nbsp;<span class="builtintype" id="4321576">uint</span><span class="op" id="4321580">(</span><span class="ident" id="4321581">max</span><span class="op" id="4321584">.</span><span class="ident" id="4321585">BitLen</span><span class="op" id="4321591">(</span><span class="op" id="4321592">)</span>&nbsp;<span class="op" id="4321594">%</span>&nbsp;<span class="num" id="4321596">8</span><span class="op" id="4321597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321600">if</span>&nbsp;<span class="ident" id="4321603">b</span>&nbsp;<span class="op" id="4321605">==</span>&nbsp;<span class="num" id="4321608">0</span>&nbsp;<span class="op" id="4321610">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321614">b</span>&nbsp;<span class="op" id="4321616">=</span>&nbsp;<span class="num" id="4321618">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321625">bytes</span>&nbsp;<span class="op" id="4321631">:=</span>&nbsp;<span class="builtinfunc" id="4321634">make</span><span class="op" id="4321638">(</span><span class="op" id="4321639">[</span><span class="op" id="4321640">]</span><span class="builtintype" id="4321641">byte</span><span class="op" id="4321645">,</span>&nbsp;<span class="ident" id="4321647">k</span><span class="op" id="4321648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321651">n</span>&nbsp;<span class="op" id="4321653">=</span>&nbsp;<span class="builtinfunc" id="4321655">new</span><span class="op" id="4321658">(</span><span class="ident" id="4321659">big</span><span class="op" id="4321662">.</span><span class="ident" id="4321663">Int</span><span class="op" id="4321666">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321670">for</span>&nbsp;<span class="op" id="4321674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321678">_</span><span class="op" id="4321679">,</span>&nbsp;<span class="ident" id="4321681">err</span>&nbsp;<span class="op" id="4321685">=</span>&nbsp;<span class="ident" id="4321687">io</span><span class="op" id="4321689">.</span><span class="ident" id="4321690">ReadFull</span><span class="op" id="4321698">(</span><span class="ident" id="4321699">rand</span><span class="op" id="4321703">,</span>&nbsp;<span class="ident" id="4321705">bytes</span><span class="op" id="4321710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321714">if</span>&nbsp;<span class="ident" id="4321717">err</span>&nbsp;<span class="op" id="4321721">!=</span>&nbsp;<span class="ident" id="4321724">nil</span>&nbsp;<span class="op" id="4321728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321733">return</span>&nbsp;<span class="ident" id="4321740">nil</span><span class="op" id="4321743">,</span>&nbsp;<span class="ident" id="4321745">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321756">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321818">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321852">bytes</span><span class="op" id="4321857">[</span><span class="num" id="4321858">0</span><span class="op" id="4321859">]</span>&nbsp;<span class="op" id="4321861">&amp;=</span>&nbsp;<span class="builtintype" id="4321864">uint8</span><span class="op" id="4321869">(</span><span class="builtintype" id="4321870">int</span><span class="op" id="4321873">(</span><span class="num" id="4321874">1</span><span class="op" id="4321875">&lt;&lt;</span><span class="ident" id="4321877">b</span><span class="op" id="4321878">)</span>&nbsp;<span class="op" id="4321880">-</span>&nbsp;<span class="num" id="4321882">1</span><span class="op" id="4321883">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321888">n</span><span class="op" id="4321889">.</span><span class="ident" id="4321890">SetBytes</span><span class="op" id="4321898">(</span><span class="ident" id="4321899">bytes</span><span class="op" id="4321904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321908">if</span>&nbsp;<span class="ident" id="4321911">n</span><span class="op" id="4321912">.</span><span class="ident" id="4321913">Cmp</span><span class="op" id="4321916">(</span><span class="ident" id="4321917">max</span><span class="op" id="4321920">)</span>&nbsp;<span class="op" id="4321922">&lt;</span>&nbsp;<span class="num" id="4321924">0</span>&nbsp;<span class="op" id="4321926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321931">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321940">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321943">}</span><br>
<span class="lineno"></span><span class="op" id="4321945">}</span>
</div>
</body>
</html>
