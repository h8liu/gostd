<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html" class="current">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1661727">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1661782">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1661836">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1661887">package</span>&nbsp;<span class="ident" id="1661895">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1661904">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1661962">import</span>&nbsp;<span class="string" id="1661969">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1661979">const</span>&nbsp;<span class="op" id="1661985">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1661988">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1661998">=</span>&nbsp;<span class="num" id="1662000">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662003">hchanSize</span>&nbsp;<span class="op" id="1662013">=</span>&nbsp;<span class="ident" id="1662015">unsafe</span><span class="op" id="1662021">.</span><span class="ident" id="1662022">Sizeof</span><span class="op" id="1662028">(</span><span class="ident" id="1662029">hchan</span><span class="op" id="1662034">{</span><span class="op" id="1662035">}</span><span class="op" id="1662036">)</span>&nbsp;<span class="op" id="1662038">+</span>&nbsp;<span class="builtintype" id="1662040">uintptr</span><span class="op" id="1662047">(</span><span class="op" id="1662048">-</span><span class="builtintype" id="1662049">int</span><span class="op" id="1662052">(</span><span class="ident" id="1662053">unsafe</span><span class="op" id="1662059">.</span><span class="ident" id="1662060">Sizeof</span><span class="op" id="1662066">(</span><span class="ident" id="1662067">hchan</span><span class="op" id="1662072">{</span><span class="op" id="1662073">}</span><span class="op" id="1662074">)</span><span class="op" id="1662075">)</span><span class="op" id="1662076">&amp;</span><span class="op" id="1662077">(</span><span class="ident" id="1662078">maxAlign</span><span class="op" id="1662086">-</span><span class="num" id="1662087">1</span><span class="op" id="1662088">)</span><span class="op" id="1662089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662092">debugChan</span>&nbsp;<span class="op" id="1662102">=</span>&nbsp;<span class="builtintype" id="1662104">false</span><br>
<span class="lineno">15</span><span class="op" id="1662110">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1662113">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1662175">func</span>&nbsp;<span class="ident" id="1662180">makechan</span><span class="op" id="1662188">(</span><span class="ident" id="1662189">t</span>&nbsp;<span class="op" id="1662191">*</span><span class="ident" id="1662192">chantype</span><span class="op" id="1662200">,</span>&nbsp;<span class="ident" id="1662202">size</span>&nbsp;<span class="ident" id="1662207">int64</span><span class="op" id="1662212">)</span>&nbsp;<span class="op" id="1662214">*</span><span class="ident" id="1662215">hchan</span>&nbsp;<span class="op" id="1662221">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662224">elem</span>&nbsp;<span class="op" id="1662229">:=</span>&nbsp;<span class="ident" id="1662232">t</span><span class="op" id="1662233">.</span><span class="ident" id="1662234">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662241">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662279">if</span>&nbsp;<span class="ident" id="1662282">elem</span><span class="op" id="1662286">.</span><span class="ident" id="1662287">size</span>&nbsp;<span class="op" id="1662292">&gt;=</span>&nbsp;<span class="num" id="1662295">1</span><span class="op" id="1662296">&lt;&lt;</span><span class="num" id="1662298">16</span>&nbsp;<span class="op" id="1662301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662305">gothrow</span><span class="op" id="1662312">(</span><span class="string" id="1662313">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1662353">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662359">if</span>&nbsp;<span class="ident" id="1662362">hchanSize</span><span class="op" id="1662371">%</span><span class="ident" id="1662372">maxAlign</span>&nbsp;<span class="op" id="1662381">!=</span>&nbsp;<span class="num" id="1662384">0</span>&nbsp;<span class="op" id="1662386">||</span>&nbsp;<span class="ident" id="1662389">elem</span><span class="op" id="1662393">.</span><span class="ident" id="1662394">align</span>&nbsp;<span class="op" id="1662400">&gt;</span>&nbsp;<span class="ident" id="1662402">maxAlign</span>&nbsp;<span class="op" id="1662411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1662415">gothrow</span><span class="op" id="1662422">(</span><span class="string" id="1662423">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1662448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662454">if</span>&nbsp;<span class="ident" id="1662457">size</span>&nbsp;<span class="op" id="1662462">&lt;</span>&nbsp;<span class="num" id="1662464">0</span>&nbsp;<span class="op" id="1662466">||</span>&nbsp;<span class="ident" id="1662469">int64</span><span class="op" id="1662474">(</span><span class="builtintype" id="1662475">uintptr</span><span class="op" id="1662482">(</span><span class="ident" id="1662483">size</span><span class="op" id="1662487">)</span><span class="op" id="1662488">)</span>&nbsp;<span class="op" id="1662490">!=</span>&nbsp;<span class="ident" id="1662493">size</span>&nbsp;<span class="op" id="1662498">||</span>&nbsp;<span class="op" id="1662501">(</span><span class="ident" id="1662502">elem</span><span class="op" id="1662506">.</span><span class="ident" id="1662507">size</span>&nbsp;<span class="op" id="1662512">&gt;</span>&nbsp;<span class="num" id="1662514">0</span>&nbsp;<span class="op" id="1662516">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1662519">uintptr</span><span class="op" id="1662526">(</span><span class="ident" id="1662527">size</span><span class="op" id="1662531">)</span>&nbsp;<span class="op" id="1662533">&gt;</span>&nbsp;<span class="op" id="1662535">(</span><span class="ident" id="1662536">maxmem</span><span class="op" id="1662542">-</span><span class="ident" id="1662543">hchanSize</span><span class="op" id="1662552">)</span><span class="op" id="1662553">/</span><span class="builtintype" id="1662554">uintptr</span><span class="op" id="1662561">(</span><span class="ident" id="1662562">elem</span><span class="op" id="1662566">.</span><span class="ident" id="1662567">size</span><span class="op" id="1662571">)</span><span class="op" id="1662572">)</span>&nbsp;<span class="op" id="1662574">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1662578">panic</span><span class="op" id="1662583">(</span><span class="string" id="1662584">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1662613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1662616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662620">var</span>&nbsp;<span class="ident" id="1662624">c</span>&nbsp;<span class="op" id="1662626">*</span><span class="ident" id="1662627">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1662634">if</span>&nbsp;<span class="ident" id="1662637">elem</span><span class="op" id="1662641">.</span><span class="ident" id="1662642">kind</span><span class="op" id="1662646">&amp;</span><span class="ident" id="1662647">kindNoPointers</span>&nbsp;<span class="op" id="1662662">!=</span>&nbsp;<span class="num" id="1662665">0</span>&nbsp;<span class="op" id="1662667">||</span>&nbsp;<span class="ident" id="1662670">size</span>&nbsp;<span class="op" id="1662675">==</span>&nbsp;<span class="num" id="1662678">0</span>&nbsp;<span class="op" id="1662680">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662684">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662718">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662788">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662854">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1662935">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663010">c</span>&nbsp;<span class="op" id="1663012">=</span>&nbsp;<span class="op" id="1663014">(</span><span class="op" id="1663015">*</span><span class="ident" id="1663016">hchan</span><span class="op" id="1663021">)</span><span class="op" id="1663022">(</span><span class="ident" id="1663023">mallocgc</span><span class="op" id="1663031">(</span><span class="ident" id="1663032">hchanSize</span><span class="op" id="1663041">+</span><span class="builtintype" id="1663042">uintptr</span><span class="op" id="1663049">(</span><span class="ident" id="1663050">size</span><span class="op" id="1663054">)</span><span class="op" id="1663055">*</span><span class="builtintype" id="1663056">uintptr</span><span class="op" id="1663063">(</span><span class="ident" id="1663064">elem</span><span class="op" id="1663068">.</span><span class="ident" id="1663069">size</span><span class="op" id="1663073">)</span><span class="op" id="1663074">,</span>&nbsp;<span class="ident" id="1663076">nil</span><span class="op" id="1663079">,</span>&nbsp;<span class="ident" id="1663081">flagNoScan</span><span class="op" id="1663091">)</span><span class="op" id="1663092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663096">if</span>&nbsp;<span class="ident" id="1663099">size</span>&nbsp;<span class="op" id="1663104">&gt;</span>&nbsp;<span class="num" id="1663106">0</span>&nbsp;<span class="op" id="1663108">&amp;&amp;</span>&nbsp;<span class="ident" id="1663111">elem</span><span class="op" id="1663115">.</span><span class="ident" id="1663116">size</span>&nbsp;<span class="op" id="1663121">!=</span>&nbsp;<span class="num" id="1663124">0</span>&nbsp;<span class="op" id="1663126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663131">c</span><span class="op" id="1663132">.</span><span class="ident" id="1663133">buf</span>&nbsp;<span class="op" id="1663137">=</span>&nbsp;<span class="op" id="1663139">(</span><span class="op" id="1663140">*</span><span class="builtintype" id="1663141">uint8</span><span class="op" id="1663146">)</span><span class="op" id="1663147">(</span><span class="ident" id="1663148">add</span><span class="op" id="1663151">(</span><span class="ident" id="1663152">unsafe</span><span class="op" id="1663158">.</span><span class="ident" id="1663159">Pointer</span><span class="op" id="1663166">(</span><span class="ident" id="1663167">c</span><span class="op" id="1663168">)</span><span class="op" id="1663169">,</span>&nbsp;<span class="ident" id="1663171">hchanSize</span><span class="op" id="1663180">)</span><span class="op" id="1663181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663185">}</span>&nbsp;<span class="keyword" id="1663187">else</span>&nbsp;<span class="op" id="1663192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663197">c</span><span class="op" id="1663198">.</span><span class="ident" id="1663199">buf</span>&nbsp;<span class="op" id="1663203">=</span>&nbsp;<span class="op" id="1663205">(</span><span class="op" id="1663206">*</span><span class="builtintype" id="1663207">uint8</span><span class="op" id="1663212">)</span><span class="op" id="1663213">(</span><span class="ident" id="1663214">unsafe</span><span class="op" id="1663220">.</span><span class="ident" id="1663221">Pointer</span><span class="op" id="1663228">(</span><span class="ident" id="1663229">c</span><span class="op" id="1663230">)</span><span class="op" id="1663231">)</span>&nbsp;<span class="comment" id="1663233">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663294">}</span>&nbsp;<span class="keyword" id="1663296">else</span>&nbsp;<span class="op" id="1663301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663305">c</span>&nbsp;<span class="op" id="1663307">=</span>&nbsp;<span class="builtinfunc" id="1663309">new</span><span class="op" id="1663312">(</span><span class="ident" id="1663313">hchan</span><span class="op" id="1663318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663322">c</span><span class="op" id="1663323">.</span><span class="ident" id="1663324">buf</span>&nbsp;<span class="op" id="1663328">=</span>&nbsp;<span class="op" id="1663330">(</span><span class="op" id="1663331">*</span><span class="builtintype" id="1663332">uint8</span><span class="op" id="1663337">)</span><span class="op" id="1663338">(</span><span class="ident" id="1663339">newarray</span><span class="op" id="1663347">(</span><span class="ident" id="1663348">elem</span><span class="op" id="1663352">,</span>&nbsp;<span class="builtintype" id="1663354">uintptr</span><span class="op" id="1663361">(</span><span class="ident" id="1663362">size</span><span class="op" id="1663366">)</span><span class="op" id="1663367">)</span><span class="op" id="1663368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663371">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663374">c</span><span class="op" id="1663375">.</span><span class="ident" id="1663376">elemsize</span>&nbsp;<span class="op" id="1663385">=</span>&nbsp;<span class="builtintype" id="1663387">uint16</span><span class="op" id="1663393">(</span><span class="ident" id="1663394">elem</span><span class="op" id="1663398">.</span><span class="ident" id="1663399">size</span><span class="op" id="1663403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663406">c</span><span class="op" id="1663407">.</span><span class="ident" id="1663408">elemtype</span>&nbsp;<span class="op" id="1663417">=</span>&nbsp;<span class="ident" id="1663419">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663425">c</span><span class="op" id="1663426">.</span><span class="ident" id="1663427">dataqsiz</span>&nbsp;<span class="op" id="1663436">=</span>&nbsp;<span class="builtintype" id="1663438">uint</span><span class="op" id="1663442">(</span><span class="ident" id="1663443">size</span><span class="op" id="1663447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663451">if</span>&nbsp;<span class="ident" id="1663454">debugChan</span>&nbsp;<span class="op" id="1663464">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1663468">print</span><span class="op" id="1663473">(</span><span class="string" id="1663474">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1663491">,</span>&nbsp;<span class="ident" id="1663493">c</span><span class="op" id="1663494">,</span>&nbsp;<span class="string" id="1663496">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1663509">,</span>&nbsp;<span class="ident" id="1663511">elem</span><span class="op" id="1663515">.</span><span class="ident" id="1663516">size</span><span class="op" id="1663520">,</span>&nbsp;<span class="string" id="1663522">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1663534">,</span>&nbsp;<span class="ident" id="1663536">elem</span><span class="op" id="1663540">.</span><span class="ident" id="1663541">alg</span><span class="op" id="1663544">,</span>&nbsp;<span class="string" id="1663546">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1663559">,</span>&nbsp;<span class="ident" id="1663561">size</span><span class="op" id="1663565">,</span>&nbsp;<span class="string" id="1663567">&#34;\n&#34;</span><span class="op" id="1663571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1663574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663577">return</span>&nbsp;<span class="ident" id="1663584">c</span><br>
<span class="lineno"></span><span class="op" id="1663586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1663589">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1663649">func</span>&nbsp;<span class="ident" id="1663654">chanbuf</span><span class="op" id="1663661">(</span><span class="ident" id="1663662">c</span>&nbsp;<span class="op" id="1663664">*</span><span class="ident" id="1663665">hchan</span><span class="op" id="1663670">,</span>&nbsp;<span class="ident" id="1663672">i</span>&nbsp;<span class="builtintype" id="1663674">uint</span><span class="op" id="1663678">)</span>&nbsp;<span class="ident" id="1663680">unsafe</span><span class="op" id="1663686">.</span><span class="ident" id="1663687">Pointer</span>&nbsp;<span class="op" id="1663695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1663698">return</span>&nbsp;<span class="ident" id="1663705">add</span><span class="op" id="1663708">(</span><span class="ident" id="1663709">unsafe</span><span class="op" id="1663715">.</span><span class="ident" id="1663716">Pointer</span><span class="op" id="1663723">(</span><span class="ident" id="1663724">c</span><span class="op" id="1663725">.</span><span class="ident" id="1663726">buf</span><span class="op" id="1663729">)</span><span class="op" id="1663730">,</span>&nbsp;<span class="builtintype" id="1663732">uintptr</span><span class="op" id="1663739">(</span><span class="ident" id="1663740">i</span><span class="op" id="1663741">)</span><span class="op" id="1663742">*</span><span class="builtintype" id="1663743">uintptr</span><span class="op" id="1663750">(</span><span class="ident" id="1663751">c</span><span class="op" id="1663752">.</span><span class="ident" id="1663753">elemsize</span><span class="op" id="1663761">)</span><span class="op" id="1663762">)</span><br>
<span class="lineno"></span><span class="op" id="1663764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1663767">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1663812">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1663825">func</span>&nbsp;<span class="ident" id="1663830">chansend1</span><span class="op" id="1663839">(</span><span class="ident" id="1663840">t</span>&nbsp;<span class="op" id="1663842">*</span><span class="ident" id="1663843">chantype</span><span class="op" id="1663851">,</span>&nbsp;<span class="ident" id="1663853">c</span>&nbsp;<span class="op" id="1663855">*</span><span class="ident" id="1663856">hchan</span><span class="op" id="1663861">,</span>&nbsp;<span class="ident" id="1663863">elem</span>&nbsp;<span class="ident" id="1663868">unsafe</span><span class="op" id="1663874">.</span><span class="ident" id="1663875">Pointer</span><span class="op" id="1663882">)</span>&nbsp;<span class="op" id="1663884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1663887">chansend</span><span class="op" id="1663895">(</span><span class="ident" id="1663896">t</span><span class="op" id="1663897">,</span>&nbsp;<span class="ident" id="1663899">c</span><span class="op" id="1663900">,</span>&nbsp;<span class="ident" id="1663902">elem</span><span class="op" id="1663906">,</span>&nbsp;<span class="builtintype" id="1663908">true</span><span class="op" id="1663912">,</span>&nbsp;<span class="ident" id="1663914">getcallerpc</span><span class="op" id="1663925">(</span><span class="ident" id="1663926">unsafe</span><span class="op" id="1663932">.</span><span class="ident" id="1663933">Pointer</span><span class="op" id="1663940">(</span><span class="op" id="1663941">&amp;</span><span class="ident" id="1663942">t</span><span class="op" id="1663943">)</span><span class="op" id="1663944">)</span><span class="op" id="1663945">)</span><br>
<span class="lineno"></span><span class="op" id="1663947">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1663950">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1664284">func</span>&nbsp;<span class="ident" id="1664289">chansend</span><span class="op" id="1664297">(</span><span class="ident" id="1664298">t</span>&nbsp;<span class="op" id="1664300">*</span><span class="ident" id="1664301">chantype</span><span class="op" id="1664309">,</span>&nbsp;<span class="ident" id="1664311">c</span>&nbsp;<span class="op" id="1664313">*</span><span class="ident" id="1664314">hchan</span><span class="op" id="1664319">,</span>&nbsp;<span class="ident" id="1664321">ep</span>&nbsp;<span class="ident" id="1664324">unsafe</span><span class="op" id="1664330">.</span><span class="ident" id="1664331">Pointer</span><span class="op" id="1664338">,</span>&nbsp;<span class="ident" id="1664340">block</span>&nbsp;<span class="builtintype" id="1664346">bool</span><span class="op" id="1664350">,</span>&nbsp;<span class="ident" id="1664352">callerpc</span>&nbsp;<span class="builtintype" id="1664361">uintptr</span><span class="op" id="1664368">)</span>&nbsp;<span class="builtintype" id="1664370">bool</span>&nbsp;<span class="op" id="1664375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1664378">if</span>&nbsp;<span class="ident" id="1664381">raceenabled</span>&nbsp;<span class="op" id="1664393">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1664397">raceReadObjectPC</span><span class="op" id="1664413">(</span><span class="ident" id="1664414">t</span><span class="op" id="1664415">.</span><span class="ident" id="1664416">elem</span><span class="op" id="1664420">,</span>&nbsp;<span class="ident" id="1664422">ep</span><span class="op" id="1664424">,</span>&nbsp;<span class="ident" id="1664426">callerpc</span><span class="op" id="1664434">,</span>&nbsp;<span class="ident" id="1664436">funcPC</span><span class="op" id="1664442">(</span><span class="ident" id="1664443">chansend</span><span class="op" id="1664451">)</span><span class="op" id="1664452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1664455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1664459">if</span>&nbsp;<span class="ident" id="1664462">c</span>&nbsp;<span class="op" id="1664464">==</span>&nbsp;<span class="ident" id="1664467">nil</span>&nbsp;<span class="op" id="1664471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1664475">if</span>&nbsp;<span class="op" id="1664478">!</span><span class="ident" id="1664479">block</span>&nbsp;<span class="op" id="1664485">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1664490">return</span>&nbsp;<span class="builtintype" id="1664497">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1664505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1664509">gopark</span><span class="op" id="1664515">(</span><span class="ident" id="1664516">nil</span><span class="op" id="1664519">,</span>&nbsp;<span class="ident" id="1664521">nil</span><span class="op" id="1664524">,</span>&nbsp;<span class="string" id="1664526">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1664548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1664552">gothrow</span><span class="op" id="1664559">(</span><span class="string" id="1664560">&#34;unreachable&#34;</span><span class="op" id="1664573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1664576">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1664580">if</span>&nbsp;<span class="ident" id="1664583">debugChan</span>&nbsp;<span class="op" id="1664593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1664597">print</span><span class="op" id="1664602">(</span><span class="string" id="1664603">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1664620">,</span>&nbsp;<span class="ident" id="1664622">c</span><span class="op" id="1664623">,</span>&nbsp;<span class="string" id="1664625">&#34;\n&#34;</span><span class="op" id="1664629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1664632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1664636">if</span>&nbsp;<span class="ident" id="1664639">raceenabled</span>&nbsp;<span class="op" id="1664651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1664655">racereadpc</span><span class="op" id="1664665">(</span><span class="ident" id="1664666">unsafe</span><span class="op" id="1664672">.</span><span class="ident" id="1664673">Pointer</span><span class="op" id="1664680">(</span><span class="ident" id="1664681">c</span><span class="op" id="1664682">)</span><span class="op" id="1664683">,</span>&nbsp;<span class="ident" id="1664685">callerpc</span><span class="op" id="1664693">,</span>&nbsp;<span class="ident" id="1664695">funcPC</span><span class="op" id="1664701">(</span><span class="ident" id="1664702">chansend</span><span class="op" id="1664710">)</span><span class="op" id="1664711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1664714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1664718">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1664801">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1664805">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1664888">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1664970">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665058">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665133">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665222">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665303">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665390">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665435">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665439">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665525">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1665609">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1665665">if</span>&nbsp;<span class="op" id="1665668">!</span><span class="ident" id="1665669">block</span>&nbsp;<span class="op" id="1665675">&amp;&amp;</span>&nbsp;<span class="ident" id="1665678">c</span><span class="op" id="1665679">.</span><span class="ident" id="1665680">closed</span>&nbsp;<span class="op" id="1665687">==</span>&nbsp;<span class="num" id="1665690">0</span>&nbsp;<span class="op" id="1665692">&amp;&amp;</span>&nbsp;<span class="op" id="1665695">(</span><span class="op" id="1665696">(</span><span class="ident" id="1665697">c</span><span class="op" id="1665698">.</span><span class="ident" id="1665699">dataqsiz</span>&nbsp;<span class="op" id="1665708">==</span>&nbsp;<span class="num" id="1665711">0</span>&nbsp;<span class="op" id="1665713">&amp;&amp;</span>&nbsp;<span class="ident" id="1665716">c</span><span class="op" id="1665717">.</span><span class="ident" id="1665718">recvq</span><span class="op" id="1665723">.</span><span class="ident" id="1665724">first</span>&nbsp;<span class="op" id="1665730">==</span>&nbsp;<span class="ident" id="1665733">nil</span><span class="op" id="1665736">)</span>&nbsp;<span class="op" id="1665738">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1665743">(</span><span class="ident" id="1665744">c</span><span class="op" id="1665745">.</span><span class="ident" id="1665746">dataqsiz</span>&nbsp;<span class="op" id="1665755">&gt;</span>&nbsp;<span class="num" id="1665757">0</span>&nbsp;<span class="op" id="1665759">&amp;&amp;</span>&nbsp;<span class="ident" id="1665762">c</span><span class="op" id="1665763">.</span><span class="ident" id="1665764">qcount</span>&nbsp;<span class="op" id="1665771">==</span>&nbsp;<span class="ident" id="1665774">c</span><span class="op" id="1665775">.</span><span class="ident" id="1665776">dataqsiz</span><span class="op" id="1665784">)</span><span class="op" id="1665785">)</span>&nbsp;<span class="op" id="1665787">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1665791">return</span>&nbsp;<span class="builtintype" id="1665798">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1665805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1665809">var</span>&nbsp;<span class="ident" id="1665813">t0</span>&nbsp;<span class="ident" id="1665816">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1665823">if</span>&nbsp;<span class="ident" id="1665826">blockprofilerate</span>&nbsp;<span class="op" id="1665843">&gt;</span>&nbsp;<span class="num" id="1665845">0</span>&nbsp;<span class="op" id="1665847">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1665851">t0</span>&nbsp;<span class="op" id="1665854">=</span>&nbsp;<span class="ident" id="1665856">cputicks</span><span class="op" id="1665864">(</span><span class="op" id="1665865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1665868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1665872">lock</span><span class="op" id="1665876">(</span><span class="op" id="1665877">&amp;</span><span class="ident" id="1665878">c</span><span class="op" id="1665879">.</span><span class="ident" id="1665880">lock</span><span class="op" id="1665884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1665887">if</span>&nbsp;<span class="ident" id="1665890">c</span><span class="op" id="1665891">.</span><span class="ident" id="1665892">closed</span>&nbsp;<span class="op" id="1665899">!=</span>&nbsp;<span class="num" id="1665902">0</span>&nbsp;<span class="op" id="1665904">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1665908">unlock</span><span class="op" id="1665914">(</span><span class="op" id="1665915">&amp;</span><span class="ident" id="1665916">c</span><span class="op" id="1665917">.</span><span class="ident" id="1665918">lock</span><span class="op" id="1665922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1665926">panic</span><span class="op" id="1665931">(</span><span class="string" id="1665932">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1665956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1665959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1665963">if</span>&nbsp;<span class="ident" id="1665966">c</span><span class="op" id="1665967">.</span><span class="ident" id="1665968">dataqsiz</span>&nbsp;<span class="op" id="1665977">==</span>&nbsp;<span class="num" id="1665980">0</span>&nbsp;<span class="op" id="1665982">{</span>&nbsp;<span class="comment" id="1665984">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666009">sg</span>&nbsp;<span class="op" id="1666012">:=</span>&nbsp;<span class="ident" id="1666015">c</span><span class="op" id="1666016">.</span><span class="ident" id="1666017">recvq</span><span class="op" id="1666022">.</span><span class="ident" id="1666023">dequeue</span><span class="op" id="1666030">(</span><span class="op" id="1666031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666035">if</span>&nbsp;<span class="ident" id="1666038">sg</span>&nbsp;<span class="op" id="1666041">!=</span>&nbsp;<span class="ident" id="1666044">nil</span>&nbsp;<span class="op" id="1666048">{</span>&nbsp;<span class="comment" id="1666050">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666081">if</span>&nbsp;<span class="ident" id="1666084">raceenabled</span>&nbsp;<span class="op" id="1666096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666102">racesync</span><span class="op" id="1666110">(</span><span class="ident" id="1666111">c</span><span class="op" id="1666112">,</span>&nbsp;<span class="ident" id="1666114">sg</span><span class="op" id="1666116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666121">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666126">unlock</span><span class="op" id="1666132">(</span><span class="op" id="1666133">&amp;</span><span class="ident" id="1666134">c</span><span class="op" id="1666135">.</span><span class="ident" id="1666136">lock</span><span class="op" id="1666140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666146">recvg</span>&nbsp;<span class="op" id="1666152">:=</span>&nbsp;<span class="ident" id="1666155">sg</span><span class="op" id="1666157">.</span><span class="ident" id="1666158">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666163">if</span>&nbsp;<span class="ident" id="1666166">sg</span><span class="op" id="1666168">.</span><span class="ident" id="1666169">elem</span>&nbsp;<span class="op" id="1666174">!=</span>&nbsp;<span class="ident" id="1666177">nil</span>&nbsp;<span class="op" id="1666181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666187">memmove</span><span class="op" id="1666194">(</span><span class="ident" id="1666195">unsafe</span><span class="op" id="1666201">.</span><span class="ident" id="1666202">Pointer</span><span class="op" id="1666209">(</span><span class="ident" id="1666210">sg</span><span class="op" id="1666212">.</span><span class="ident" id="1666213">elem</span><span class="op" id="1666217">)</span><span class="op" id="1666218">,</span>&nbsp;<span class="ident" id="1666220">ep</span><span class="op" id="1666222">,</span>&nbsp;<span class="builtintype" id="1666224">uintptr</span><span class="op" id="1666231">(</span><span class="ident" id="1666232">c</span><span class="op" id="1666233">.</span><span class="ident" id="1666234">elemsize</span><span class="op" id="1666242">)</span><span class="op" id="1666243">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666249">sg</span><span class="op" id="1666251">.</span><span class="ident" id="1666252">elem</span>&nbsp;<span class="op" id="1666257">=</span>&nbsp;<span class="ident" id="1666259">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666271">recvg</span><span class="op" id="1666276">.</span><span class="ident" id="1666277">param</span>&nbsp;<span class="op" id="1666283">=</span>&nbsp;<span class="ident" id="1666285">unsafe</span><span class="op" id="1666291">.</span><span class="ident" id="1666292">Pointer</span><span class="op" id="1666299">(</span><span class="ident" id="1666300">sg</span><span class="op" id="1666302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666307">if</span>&nbsp;<span class="ident" id="1666310">sg</span><span class="op" id="1666312">.</span><span class="ident" id="1666313">releasetime</span>&nbsp;<span class="op" id="1666325">!=</span>&nbsp;<span class="num" id="1666328">0</span>&nbsp;<span class="op" id="1666330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666336">sg</span><span class="op" id="1666338">.</span><span class="ident" id="1666339">releasetime</span>&nbsp;<span class="op" id="1666351">=</span>&nbsp;<span class="ident" id="1666353">cputicks</span><span class="op" id="1666361">(</span><span class="op" id="1666362">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666372">goready</span><span class="op" id="1666379">(</span><span class="ident" id="1666380">recvg</span><span class="op" id="1666385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666390">return</span>&nbsp;<span class="builtintype" id="1666397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666409">if</span>&nbsp;<span class="op" id="1666412">!</span><span class="ident" id="1666413">block</span>&nbsp;<span class="op" id="1666419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666424">unlock</span><span class="op" id="1666430">(</span><span class="op" id="1666431">&amp;</span><span class="ident" id="1666432">c</span><span class="op" id="1666433">.</span><span class="ident" id="1666434">lock</span><span class="op" id="1666438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666443">return</span>&nbsp;<span class="builtintype" id="1666450">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1666463">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666514">gp</span>&nbsp;<span class="op" id="1666517">:=</span>&nbsp;<span class="ident" id="1666520">getg</span><span class="op" id="1666524">(</span><span class="op" id="1666525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666529">mysg</span>&nbsp;<span class="op" id="1666534">:=</span>&nbsp;<span class="ident" id="1666537">acquireSudog</span><span class="op" id="1666549">(</span><span class="op" id="1666550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666554">mysg</span><span class="op" id="1666558">.</span><span class="ident" id="1666559">releasetime</span>&nbsp;<span class="op" id="1666571">=</span>&nbsp;<span class="num" id="1666573">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666577">if</span>&nbsp;<span class="ident" id="1666580">t0</span>&nbsp;<span class="op" id="1666583">!=</span>&nbsp;<span class="num" id="1666586">0</span>&nbsp;<span class="op" id="1666588">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666593">mysg</span><span class="op" id="1666597">.</span><span class="ident" id="1666598">releasetime</span>&nbsp;<span class="op" id="1666610">=</span>&nbsp;<span class="op" id="1666612">-</span><span class="num" id="1666613">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666621">mysg</span><span class="op" id="1666625">.</span><span class="ident" id="1666626">elem</span>&nbsp;<span class="op" id="1666631">=</span>&nbsp;<span class="ident" id="1666633">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666638">mysg</span><span class="op" id="1666642">.</span><span class="ident" id="1666643">waitlink</span>&nbsp;<span class="op" id="1666652">=</span>&nbsp;<span class="ident" id="1666654">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666660">gp</span><span class="op" id="1666662">.</span><span class="ident" id="1666663">waiting</span>&nbsp;<span class="op" id="1666671">=</span>&nbsp;<span class="ident" id="1666673">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666680">mysg</span><span class="op" id="1666684">.</span><span class="ident" id="1666685">g</span>&nbsp;<span class="op" id="1666687">=</span>&nbsp;<span class="ident" id="1666689">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666694">mysg</span><span class="op" id="1666698">.</span><span class="ident" id="1666699">selectdone</span>&nbsp;<span class="op" id="1666710">=</span>&nbsp;<span class="ident" id="1666712">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666718">gp</span><span class="op" id="1666720">.</span><span class="ident" id="1666721">param</span>&nbsp;<span class="op" id="1666727">=</span>&nbsp;<span class="ident" id="1666729">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666735">c</span><span class="op" id="1666736">.</span><span class="ident" id="1666737">sendq</span><span class="op" id="1666742">.</span><span class="ident" id="1666743">enqueue</span><span class="op" id="1666750">(</span><span class="ident" id="1666751">mysg</span><span class="op" id="1666755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666759">goparkunlock</span><span class="op" id="1666771">(</span><span class="op" id="1666772">&amp;</span><span class="ident" id="1666773">c</span><span class="op" id="1666774">.</span><span class="ident" id="1666775">lock</span><span class="op" id="1666779">,</span>&nbsp;<span class="string" id="1666781">&#34;chan&nbsp;send&#34;</span><span class="op" id="1666792">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1666797">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666822">if</span>&nbsp;<span class="ident" id="1666825">mysg</span>&nbsp;<span class="op" id="1666830">!=</span>&nbsp;<span class="ident" id="1666833">gp</span><span class="op" id="1666835">.</span><span class="ident" id="1666836">waiting</span>&nbsp;<span class="op" id="1666844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666849">gothrow</span><span class="op" id="1666856">(</span><span class="string" id="1666857">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1666887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666891">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666895">gp</span><span class="op" id="1666897">.</span><span class="ident" id="1666898">waiting</span>&nbsp;<span class="op" id="1666906">=</span>&nbsp;<span class="ident" id="1666908">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666914">if</span>&nbsp;<span class="ident" id="1666917">gp</span><span class="op" id="1666919">.</span><span class="ident" id="1666920">param</span>&nbsp;<span class="op" id="1666926">==</span>&nbsp;<span class="ident" id="1666929">nil</span>&nbsp;<span class="op" id="1666933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666938">if</span>&nbsp;<span class="ident" id="1666941">c</span><span class="op" id="1666942">.</span><span class="ident" id="1666943">closed</span>&nbsp;<span class="op" id="1666950">==</span>&nbsp;<span class="num" id="1666953">0</span>&nbsp;<span class="op" id="1666955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666961">gothrow</span><span class="op" id="1666968">(</span><span class="string" id="1666969">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1666996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667001">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1667006">panic</span><span class="op" id="1667011">(</span><span class="string" id="1667012">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1667036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667044">gp</span><span class="op" id="1667046">.</span><span class="ident" id="1667047">param</span>&nbsp;<span class="op" id="1667053">=</span>&nbsp;<span class="ident" id="1667055">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667061">if</span>&nbsp;<span class="ident" id="1667064">mysg</span><span class="op" id="1667068">.</span><span class="ident" id="1667069">releasetime</span>&nbsp;<span class="op" id="1667081">&gt;</span>&nbsp;<span class="num" id="1667083">0</span>&nbsp;<span class="op" id="1667085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667090">blockevent</span><span class="op" id="1667100">(</span><span class="ident" id="1667101">int64</span><span class="op" id="1667106">(</span><span class="ident" id="1667107">mysg</span><span class="op" id="1667111">.</span><span class="ident" id="1667112">releasetime</span><span class="op" id="1667123">)</span><span class="op" id="1667124">-</span><span class="ident" id="1667125">t0</span><span class="op" id="1667127">,</span>&nbsp;<span class="num" id="1667129">2</span><span class="op" id="1667130">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667138">releaseSudog</span><span class="op" id="1667150">(</span><span class="ident" id="1667151">mysg</span><span class="op" id="1667155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667159">return</span>&nbsp;<span class="builtintype" id="1667166">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667176">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667201">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667243">var</span>&nbsp;<span class="ident" id="1667247">t1</span>&nbsp;<span class="ident" id="1667250">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667257">for</span>&nbsp;<span class="ident" id="1667261">c</span><span class="op" id="1667262">.</span><span class="ident" id="1667263">qcount</span>&nbsp;<span class="op" id="1667270">&gt;=</span>&nbsp;<span class="ident" id="1667273">c</span><span class="op" id="1667274">.</span><span class="ident" id="1667275">dataqsiz</span>&nbsp;<span class="op" id="1667284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667288">if</span>&nbsp;<span class="op" id="1667291">!</span><span class="ident" id="1667292">block</span>&nbsp;<span class="op" id="1667298">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667303">unlock</span><span class="op" id="1667309">(</span><span class="op" id="1667310">&amp;</span><span class="ident" id="1667311">c</span><span class="op" id="1667312">.</span><span class="ident" id="1667313">lock</span><span class="op" id="1667317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667322">return</span>&nbsp;<span class="builtintype" id="1667329">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667341">gp</span>&nbsp;<span class="op" id="1667344">:=</span>&nbsp;<span class="ident" id="1667347">getg</span><span class="op" id="1667351">(</span><span class="op" id="1667352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667356">mysg</span>&nbsp;<span class="op" id="1667361">:=</span>&nbsp;<span class="ident" id="1667364">acquireSudog</span><span class="op" id="1667376">(</span><span class="op" id="1667377">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667381">mysg</span><span class="op" id="1667385">.</span><span class="ident" id="1667386">releasetime</span>&nbsp;<span class="op" id="1667398">=</span>&nbsp;<span class="num" id="1667400">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667404">if</span>&nbsp;<span class="ident" id="1667407">t0</span>&nbsp;<span class="op" id="1667410">!=</span>&nbsp;<span class="num" id="1667413">0</span>&nbsp;<span class="op" id="1667415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667420">mysg</span><span class="op" id="1667424">.</span><span class="ident" id="1667425">releasetime</span>&nbsp;<span class="op" id="1667437">=</span>&nbsp;<span class="op" id="1667439">-</span><span class="num" id="1667440">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667448">mysg</span><span class="op" id="1667452">.</span><span class="ident" id="1667453">g</span>&nbsp;<span class="op" id="1667455">=</span>&nbsp;<span class="ident" id="1667457">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667462">mysg</span><span class="op" id="1667466">.</span><span class="ident" id="1667467">elem</span>&nbsp;<span class="op" id="1667472">=</span>&nbsp;<span class="ident" id="1667474">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667480">mysg</span><span class="op" id="1667484">.</span><span class="ident" id="1667485">selectdone</span>&nbsp;<span class="op" id="1667496">=</span>&nbsp;<span class="ident" id="1667498">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667504">c</span><span class="op" id="1667505">.</span><span class="ident" id="1667506">sendq</span><span class="op" id="1667511">.</span><span class="ident" id="1667512">enqueue</span><span class="op" id="1667519">(</span><span class="ident" id="1667520">mysg</span><span class="op" id="1667524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667528">goparkunlock</span><span class="op" id="1667540">(</span><span class="op" id="1667541">&amp;</span><span class="ident" id="1667542">c</span><span class="op" id="1667543">.</span><span class="ident" id="1667544">lock</span><span class="op" id="1667548">,</span>&nbsp;<span class="string" id="1667550">&#34;chan&nbsp;send&#34;</span><span class="op" id="1667561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667566">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667602">if</span>&nbsp;<span class="ident" id="1667605">mysg</span><span class="op" id="1667609">.</span><span class="ident" id="1667610">releasetime</span>&nbsp;<span class="op" id="1667622">&gt;</span>&nbsp;<span class="num" id="1667624">0</span>&nbsp;<span class="op" id="1667626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667631">t1</span>&nbsp;<span class="op" id="1667634">=</span>&nbsp;<span class="ident" id="1667636">mysg</span><span class="op" id="1667640">.</span><span class="ident" id="1667641">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667659">releaseSudog</span><span class="op" id="1667671">(</span><span class="ident" id="1667672">mysg</span><span class="op" id="1667676">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667680">lock</span><span class="op" id="1667684">(</span><span class="op" id="1667685">&amp;</span><span class="ident" id="1667686">c</span><span class="op" id="1667687">.</span><span class="ident" id="1667688">lock</span><span class="op" id="1667692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667696">if</span>&nbsp;<span class="ident" id="1667699">c</span><span class="op" id="1667700">.</span><span class="ident" id="1667701">closed</span>&nbsp;<span class="op" id="1667708">!=</span>&nbsp;<span class="num" id="1667711">0</span>&nbsp;<span class="op" id="1667713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667718">unlock</span><span class="op" id="1667724">(</span><span class="op" id="1667725">&amp;</span><span class="ident" id="1667726">c</span><span class="op" id="1667727">.</span><span class="ident" id="1667728">lock</span><span class="op" id="1667732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1667737">panic</span><span class="op" id="1667742">(</span><span class="string" id="1667743">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1667767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667771">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667778">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667821">if</span>&nbsp;<span class="ident" id="1667824">raceenabled</span>&nbsp;<span class="op" id="1667836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667840">raceacquire</span><span class="op" id="1667851">(</span><span class="ident" id="1667852">chanbuf</span><span class="op" id="1667859">(</span><span class="ident" id="1667860">c</span><span class="op" id="1667861">,</span>&nbsp;<span class="ident" id="1667863">c</span><span class="op" id="1667864">.</span><span class="ident" id="1667865">sendx</span><span class="op" id="1667870">)</span><span class="op" id="1667871">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667875">racerelease</span><span class="op" id="1667886">(</span><span class="ident" id="1667887">chanbuf</span><span class="op" id="1667894">(</span><span class="ident" id="1667895">c</span><span class="op" id="1667896">,</span>&nbsp;<span class="ident" id="1667898">c</span><span class="op" id="1667899">.</span><span class="ident" id="1667900">sendx</span><span class="op" id="1667905">)</span><span class="op" id="1667906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667912">memmove</span><span class="op" id="1667919">(</span><span class="ident" id="1667920">chanbuf</span><span class="op" id="1667927">(</span><span class="ident" id="1667928">c</span><span class="op" id="1667929">,</span>&nbsp;<span class="ident" id="1667931">c</span><span class="op" id="1667932">.</span><span class="ident" id="1667933">sendx</span><span class="op" id="1667938">)</span><span class="op" id="1667939">,</span>&nbsp;<span class="ident" id="1667941">ep</span><span class="op" id="1667943">,</span>&nbsp;<span class="builtintype" id="1667945">uintptr</span><span class="op" id="1667952">(</span><span class="ident" id="1667953">c</span><span class="op" id="1667954">.</span><span class="ident" id="1667955">elemsize</span><span class="op" id="1667963">)</span><span class="op" id="1667964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667967">c</span><span class="op" id="1667968">.</span><span class="ident" id="1667969">sendx</span><span class="op" id="1667974">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667978">if</span>&nbsp;<span class="ident" id="1667981">c</span><span class="op" id="1667982">.</span><span class="ident" id="1667983">sendx</span>&nbsp;<span class="op" id="1667989">==</span>&nbsp;<span class="ident" id="1667992">c</span><span class="op" id="1667993">.</span><span class="ident" id="1667994">dataqsiz</span>&nbsp;<span class="op" id="1668003">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668007">c</span><span class="op" id="1668008">.</span><span class="ident" id="1668009">sendx</span>&nbsp;<span class="op" id="1668015">=</span>&nbsp;<span class="num" id="1668017">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668023">c</span><span class="op" id="1668024">.</span><span class="ident" id="1668025">qcount</span><span class="op" id="1668031">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1668036">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668067">sg</span>&nbsp;<span class="op" id="1668070">:=</span>&nbsp;<span class="ident" id="1668073">c</span><span class="op" id="1668074">.</span><span class="ident" id="1668075">recvq</span><span class="op" id="1668080">.</span><span class="ident" id="1668081">dequeue</span><span class="op" id="1668088">(</span><span class="op" id="1668089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668092">if</span>&nbsp;<span class="ident" id="1668095">sg</span>&nbsp;<span class="op" id="1668098">!=</span>&nbsp;<span class="ident" id="1668101">nil</span>&nbsp;<span class="op" id="1668105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668109">recvg</span>&nbsp;<span class="op" id="1668115">:=</span>&nbsp;<span class="ident" id="1668118">sg</span><span class="op" id="1668120">.</span><span class="ident" id="1668121">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668125">unlock</span><span class="op" id="1668131">(</span><span class="op" id="1668132">&amp;</span><span class="ident" id="1668133">c</span><span class="op" id="1668134">.</span><span class="ident" id="1668135">lock</span><span class="op" id="1668139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668143">if</span>&nbsp;<span class="ident" id="1668146">sg</span><span class="op" id="1668148">.</span><span class="ident" id="1668149">releasetime</span>&nbsp;<span class="op" id="1668161">!=</span>&nbsp;<span class="num" id="1668164">0</span>&nbsp;<span class="op" id="1668166">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668171">sg</span><span class="op" id="1668173">.</span><span class="ident" id="1668174">releasetime</span>&nbsp;<span class="op" id="1668186">=</span>&nbsp;<span class="ident" id="1668188">cputicks</span><span class="op" id="1668196">(</span><span class="op" id="1668197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668205">goready</span><span class="op" id="1668212">(</span><span class="ident" id="1668213">recvg</span><span class="op" id="1668218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668221">}</span>&nbsp;<span class="keyword" id="1668223">else</span>&nbsp;<span class="op" id="1668228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668232">unlock</span><span class="op" id="1668238">(</span><span class="op" id="1668239">&amp;</span><span class="ident" id="1668240">c</span><span class="op" id="1668241">.</span><span class="ident" id="1668242">lock</span><span class="op" id="1668246">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668252">if</span>&nbsp;<span class="ident" id="1668255">t1</span>&nbsp;<span class="op" id="1668258">&gt;</span>&nbsp;<span class="num" id="1668260">0</span>&nbsp;<span class="op" id="1668262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668266">blockevent</span><span class="op" id="1668276">(</span><span class="ident" id="1668277">t1</span><span class="op" id="1668279">-</span><span class="ident" id="1668280">t0</span><span class="op" id="1668282">,</span>&nbsp;<span class="num" id="1668284">2</span><span class="op" id="1668285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668291">return</span>&nbsp;<span class="builtintype" id="1668298">true</span><br>
<span class="lineno">255</span><span class="op" id="1668303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1668306">func</span>&nbsp;<span class="ident" id="1668311">closechan</span><span class="op" id="1668320">(</span><span class="ident" id="1668321">c</span>&nbsp;<span class="op" id="1668323">*</span><span class="ident" id="1668324">hchan</span><span class="op" id="1668329">)</span>&nbsp;<span class="op" id="1668331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668334">if</span>&nbsp;<span class="ident" id="1668337">c</span>&nbsp;<span class="op" id="1668339">==</span>&nbsp;<span class="ident" id="1668342">nil</span>&nbsp;<span class="op" id="1668346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1668350">panic</span><span class="op" id="1668355">(</span><span class="string" id="1668356">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1668378">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668385">lock</span><span class="op" id="1668389">(</span><span class="op" id="1668390">&amp;</span><span class="ident" id="1668391">c</span><span class="op" id="1668392">.</span><span class="ident" id="1668393">lock</span><span class="op" id="1668397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668400">if</span>&nbsp;<span class="ident" id="1668403">c</span><span class="op" id="1668404">.</span><span class="ident" id="1668405">closed</span>&nbsp;<span class="op" id="1668412">!=</span>&nbsp;<span class="num" id="1668415">0</span>&nbsp;<span class="op" id="1668417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668421">unlock</span><span class="op" id="1668427">(</span><span class="op" id="1668428">&amp;</span><span class="ident" id="1668429">c</span><span class="op" id="1668430">.</span><span class="ident" id="1668431">lock</span><span class="op" id="1668435">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1668439">panic</span><span class="op" id="1668444">(</span><span class="string" id="1668445">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1668470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668477">if</span>&nbsp;<span class="ident" id="1668480">raceenabled</span>&nbsp;<span class="op" id="1668492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668496">callerpc</span>&nbsp;<span class="op" id="1668505">:=</span>&nbsp;<span class="ident" id="1668508">getcallerpc</span><span class="op" id="1668519">(</span><span class="ident" id="1668520">unsafe</span><span class="op" id="1668526">.</span><span class="ident" id="1668527">Pointer</span><span class="op" id="1668534">(</span><span class="op" id="1668535">&amp;</span><span class="ident" id="1668536">c</span><span class="op" id="1668537">)</span><span class="op" id="1668538">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668542">racewritepc</span><span class="op" id="1668553">(</span><span class="ident" id="1668554">unsafe</span><span class="op" id="1668560">.</span><span class="ident" id="1668561">Pointer</span><span class="op" id="1668568">(</span><span class="ident" id="1668569">c</span><span class="op" id="1668570">)</span><span class="op" id="1668571">,</span>&nbsp;<span class="ident" id="1668573">callerpc</span><span class="op" id="1668581">,</span>&nbsp;<span class="ident" id="1668583">funcPC</span><span class="op" id="1668589">(</span><span class="ident" id="1668590">closechan</span><span class="op" id="1668599">)</span><span class="op" id="1668600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668604">racerelease</span><span class="op" id="1668615">(</span><span class="ident" id="1668616">unsafe</span><span class="op" id="1668622">.</span><span class="ident" id="1668623">Pointer</span><span class="op" id="1668630">(</span><span class="ident" id="1668631">c</span><span class="op" id="1668632">)</span><span class="op" id="1668633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668640">c</span><span class="op" id="1668641">.</span><span class="ident" id="1668642">closed</span>&nbsp;<span class="op" id="1668649">=</span>&nbsp;<span class="num" id="1668651">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1668655">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668679">for</span>&nbsp;<span class="op" id="1668683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668687">sg</span>&nbsp;<span class="op" id="1668690">:=</span>&nbsp;<span class="ident" id="1668693">c</span><span class="op" id="1668694">.</span><span class="ident" id="1668695">recvq</span><span class="op" id="1668700">.</span><span class="ident" id="1668701">dequeue</span><span class="op" id="1668708">(</span><span class="op" id="1668709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668713">if</span>&nbsp;<span class="ident" id="1668716">sg</span>&nbsp;<span class="op" id="1668719">==</span>&nbsp;<span class="ident" id="1668722">nil</span>&nbsp;<span class="op" id="1668726">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668731">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668743">gp</span>&nbsp;<span class="op" id="1668746">:=</span>&nbsp;<span class="ident" id="1668749">sg</span><span class="op" id="1668751">.</span><span class="ident" id="1668752">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668756">sg</span><span class="op" id="1668758">.</span><span class="ident" id="1668759">elem</span>&nbsp;<span class="op" id="1668764">=</span>&nbsp;<span class="ident" id="1668766">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668772">gp</span><span class="op" id="1668774">.</span><span class="ident" id="1668775">param</span>&nbsp;<span class="op" id="1668781">=</span>&nbsp;<span class="ident" id="1668783">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668789">if</span>&nbsp;<span class="ident" id="1668792">sg</span><span class="op" id="1668794">.</span><span class="ident" id="1668795">releasetime</span>&nbsp;<span class="op" id="1668807">!=</span>&nbsp;<span class="num" id="1668810">0</span>&nbsp;<span class="op" id="1668812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668817">sg</span><span class="op" id="1668819">.</span><span class="ident" id="1668820">releasetime</span>&nbsp;<span class="op" id="1668832">=</span>&nbsp;<span class="ident" id="1668834">cputicks</span><span class="op" id="1668842">(</span><span class="op" id="1668843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668851">goready</span><span class="op" id="1668858">(</span><span class="ident" id="1668859">gp</span><span class="op" id="1668861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668864">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1668868">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668892">for</span>&nbsp;<span class="op" id="1668896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668900">sg</span>&nbsp;<span class="op" id="1668903">:=</span>&nbsp;<span class="ident" id="1668906">c</span><span class="op" id="1668907">.</span><span class="ident" id="1668908">sendq</span><span class="op" id="1668913">.</span><span class="ident" id="1668914">dequeue</span><span class="op" id="1668921">(</span><span class="op" id="1668922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668926">if</span>&nbsp;<span class="ident" id="1668929">sg</span>&nbsp;<span class="op" id="1668932">==</span>&nbsp;<span class="ident" id="1668935">nil</span>&nbsp;<span class="op" id="1668939">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668944">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668956">gp</span>&nbsp;<span class="op" id="1668959">:=</span>&nbsp;<span class="ident" id="1668962">sg</span><span class="op" id="1668964">.</span><span class="ident" id="1668965">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668969">sg</span><span class="op" id="1668971">.</span><span class="ident" id="1668972">elem</span>&nbsp;<span class="op" id="1668977">=</span>&nbsp;<span class="ident" id="1668979">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668985">gp</span><span class="op" id="1668987">.</span><span class="ident" id="1668988">param</span>&nbsp;<span class="op" id="1668994">=</span>&nbsp;<span class="ident" id="1668996">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1669002">if</span>&nbsp;<span class="ident" id="1669005">sg</span><span class="op" id="1669007">.</span><span class="ident" id="1669008">releasetime</span>&nbsp;<span class="op" id="1669020">!=</span>&nbsp;<span class="num" id="1669023">0</span>&nbsp;<span class="op" id="1669025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669030">sg</span><span class="op" id="1669032">.</span><span class="ident" id="1669033">releasetime</span>&nbsp;<span class="op" id="1669045">=</span>&nbsp;<span class="ident" id="1669047">cputicks</span><span class="op" id="1669055">(</span><span class="op" id="1669056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1669060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669064">goready</span><span class="op" id="1669071">(</span><span class="ident" id="1669072">gp</span><span class="op" id="1669074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1669077">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669080">unlock</span><span class="op" id="1669086">(</span><span class="op" id="1669087">&amp;</span><span class="ident" id="1669088">c</span><span class="op" id="1669089">.</span><span class="ident" id="1669090">lock</span><span class="op" id="1669094">)</span><br>
<span class="lineno"></span><span class="op" id="1669096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1669099">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1669143">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1669156">func</span>&nbsp;<span class="ident" id="1669161">chanrecv1</span><span class="op" id="1669170">(</span><span class="ident" id="1669171">t</span>&nbsp;<span class="op" id="1669173">*</span><span class="ident" id="1669174">chantype</span><span class="op" id="1669182">,</span>&nbsp;<span class="ident" id="1669184">c</span>&nbsp;<span class="op" id="1669186">*</span><span class="ident" id="1669187">hchan</span><span class="op" id="1669192">,</span>&nbsp;<span class="ident" id="1669194">elem</span>&nbsp;<span class="ident" id="1669199">unsafe</span><span class="op" id="1669205">.</span><span class="ident" id="1669206">Pointer</span><span class="op" id="1669213">)</span>&nbsp;<span class="op" id="1669215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669218">chanrecv</span><span class="op" id="1669226">(</span><span class="ident" id="1669227">t</span><span class="op" id="1669228">,</span>&nbsp;<span class="ident" id="1669230">c</span><span class="op" id="1669231">,</span>&nbsp;<span class="ident" id="1669233">elem</span><span class="op" id="1669237">,</span>&nbsp;<span class="builtintype" id="1669239">true</span><span class="op" id="1669243">)</span><br>
<span class="lineno"></span><span class="op" id="1669245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1669248">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1669261">func</span>&nbsp;<span class="ident" id="1669266">chanrecv2</span><span class="op" id="1669275">(</span><span class="ident" id="1669276">t</span>&nbsp;<span class="op" id="1669278">*</span><span class="ident" id="1669279">chantype</span><span class="op" id="1669287">,</span>&nbsp;<span class="ident" id="1669289">c</span>&nbsp;<span class="op" id="1669291">*</span><span class="ident" id="1669292">hchan</span><span class="op" id="1669297">,</span>&nbsp;<span class="ident" id="1669299">elem</span>&nbsp;<span class="ident" id="1669304">unsafe</span><span class="op" id="1669310">.</span><span class="ident" id="1669311">Pointer</span><span class="op" id="1669318">)</span>&nbsp;<span class="op" id="1669320">(</span><span class="ident" id="1669321">received</span>&nbsp;<span class="builtintype" id="1669330">bool</span><span class="op" id="1669334">)</span>&nbsp;<span class="op" id="1669336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669339">_</span><span class="op" id="1669340">,</span>&nbsp;<span class="ident" id="1669342">received</span>&nbsp;<span class="op" id="1669351">=</span>&nbsp;<span class="ident" id="1669353">chanrecv</span><span class="op" id="1669361">(</span><span class="ident" id="1669362">t</span><span class="op" id="1669363">,</span>&nbsp;<span class="ident" id="1669365">c</span><span class="op" id="1669366">,</span>&nbsp;<span class="ident" id="1669368">elem</span><span class="op" id="1669372">,</span>&nbsp;<span class="builtintype" id="1669374">true</span><span class="op" id="1669378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1669381">return</span><br>
<span class="lineno"></span><span class="op" id="1669388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1669391">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1669461">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1669519">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1669595">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1669662">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1669731">func</span>&nbsp;<span class="ident" id="1669736">chanrecv</span><span class="op" id="1669744">(</span><span class="ident" id="1669745">t</span>&nbsp;<span class="op" id="1669747">*</span><span class="ident" id="1669748">chantype</span><span class="op" id="1669756">,</span>&nbsp;<span class="ident" id="1669758">c</span>&nbsp;<span class="op" id="1669760">*</span><span class="ident" id="1669761">hchan</span><span class="op" id="1669766">,</span>&nbsp;<span class="ident" id="1669768">ep</span>&nbsp;<span class="ident" id="1669771">unsafe</span><span class="op" id="1669777">.</span><span class="ident" id="1669778">Pointer</span><span class="op" id="1669785">,</span>&nbsp;<span class="ident" id="1669787">block</span>&nbsp;<span class="builtintype" id="1669793">bool</span><span class="op" id="1669797">)</span>&nbsp;<span class="op" id="1669799">(</span><span class="ident" id="1669800">selected</span><span class="op" id="1669808">,</span>&nbsp;<span class="ident" id="1669810">received</span>&nbsp;<span class="builtintype" id="1669819">bool</span><span class="op" id="1669823">)</span>&nbsp;<span class="op" id="1669825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1669828">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1669900">if</span>&nbsp;<span class="ident" id="1669903">debugChan</span>&nbsp;<span class="op" id="1669913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1669917">print</span><span class="op" id="1669922">(</span><span class="string" id="1669923">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1669940">,</span>&nbsp;<span class="ident" id="1669942">c</span><span class="op" id="1669943">,</span>&nbsp;<span class="string" id="1669945">&#34;\n&#34;</span><span class="op" id="1669949">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1669952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1669956">if</span>&nbsp;<span class="ident" id="1669959">c</span>&nbsp;<span class="op" id="1669961">==</span>&nbsp;<span class="ident" id="1669964">nil</span>&nbsp;<span class="op" id="1669968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1669972">if</span>&nbsp;<span class="op" id="1669975">!</span><span class="ident" id="1669976">block</span>&nbsp;<span class="op" id="1669982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1669987">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1669996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1670000">gopark</span><span class="op" id="1670006">(</span><span class="ident" id="1670007">nil</span><span class="op" id="1670010">,</span>&nbsp;<span class="ident" id="1670012">nil</span><span class="op" id="1670015">,</span>&nbsp;<span class="string" id="1670017">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1670042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1670046">gothrow</span><span class="op" id="1670053">(</span><span class="string" id="1670054">&#34;unreachable&#34;</span><span class="op" id="1670067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1670070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670074">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670157">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670161">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670246">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670328">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670388">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670467">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670545">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670623">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670671">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670675">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1670759">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1670808">if</span>&nbsp;<span class="op" id="1670811">!</span><span class="ident" id="1670812">block</span>&nbsp;<span class="op" id="1670818">&amp;&amp;</span>&nbsp;<span class="op" id="1670821">(</span><span class="ident" id="1670822">c</span><span class="op" id="1670823">.</span><span class="ident" id="1670824">dataqsiz</span>&nbsp;<span class="op" id="1670833">==</span>&nbsp;<span class="num" id="1670836">0</span>&nbsp;<span class="op" id="1670838">&amp;&amp;</span>&nbsp;<span class="ident" id="1670841">c</span><span class="op" id="1670842">.</span><span class="ident" id="1670843">sendq</span><span class="op" id="1670848">.</span><span class="ident" id="1670849">first</span>&nbsp;<span class="op" id="1670855">==</span>&nbsp;<span class="ident" id="1670858">nil</span>&nbsp;<span class="op" id="1670862">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1670867">c</span><span class="op" id="1670868">.</span><span class="ident" id="1670869">dataqsiz</span>&nbsp;<span class="op" id="1670878">&gt;</span>&nbsp;<span class="num" id="1670880">0</span>&nbsp;<span class="op" id="1670882">&amp;&amp;</span>&nbsp;<span class="ident" id="1670885">atomicloaduint</span><span class="op" id="1670899">(</span><span class="op" id="1670900">&amp;</span><span class="ident" id="1670901">c</span><span class="op" id="1670902">.</span><span class="ident" id="1670903">qcount</span><span class="op" id="1670909">)</span>&nbsp;<span class="op" id="1670911">==</span>&nbsp;<span class="num" id="1670914">0</span><span class="op" id="1670915">)</span>&nbsp;<span class="op" id="1670917">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1670922">atomicload</span><span class="op" id="1670932">(</span><span class="op" id="1670933">&amp;</span><span class="ident" id="1670934">c</span><span class="op" id="1670935">.</span><span class="ident" id="1670936">closed</span><span class="op" id="1670942">)</span>&nbsp;<span class="op" id="1670944">==</span>&nbsp;<span class="num" id="1670947">0</span>&nbsp;<span class="op" id="1670949">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1670953">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1670961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1670965">var</span>&nbsp;<span class="ident" id="1670969">t0</span>&nbsp;<span class="ident" id="1670972">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1670979">if</span>&nbsp;<span class="ident" id="1670982">blockprofilerate</span>&nbsp;<span class="op" id="1670999">&gt;</span>&nbsp;<span class="num" id="1671001">0</span>&nbsp;<span class="op" id="1671003">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671007">t0</span>&nbsp;<span class="op" id="1671010">=</span>&nbsp;<span class="ident" id="1671012">cputicks</span><span class="op" id="1671020">(</span><span class="op" id="1671021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671028">lock</span><span class="op" id="1671032">(</span><span class="op" id="1671033">&amp;</span><span class="ident" id="1671034">c</span><span class="op" id="1671035">.</span><span class="ident" id="1671036">lock</span><span class="op" id="1671040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671043">if</span>&nbsp;<span class="ident" id="1671046">c</span><span class="op" id="1671047">.</span><span class="ident" id="1671048">dataqsiz</span>&nbsp;<span class="op" id="1671057">==</span>&nbsp;<span class="num" id="1671060">0</span>&nbsp;<span class="op" id="1671062">{</span>&nbsp;<span class="comment" id="1671064">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671089">if</span>&nbsp;<span class="ident" id="1671092">c</span><span class="op" id="1671093">.</span><span class="ident" id="1671094">closed</span>&nbsp;<span class="op" id="1671101">!=</span>&nbsp;<span class="num" id="1671104">0</span>&nbsp;<span class="op" id="1671106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671111">return</span>&nbsp;<span class="ident" id="1671118">recvclosed</span><span class="op" id="1671128">(</span><span class="ident" id="1671129">c</span><span class="op" id="1671130">,</span>&nbsp;<span class="ident" id="1671132">ep</span><span class="op" id="1671134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671143">sg</span>&nbsp;<span class="op" id="1671146">:=</span>&nbsp;<span class="ident" id="1671149">c</span><span class="op" id="1671150">.</span><span class="ident" id="1671151">sendq</span><span class="op" id="1671156">.</span><span class="ident" id="1671157">dequeue</span><span class="op" id="1671164">(</span><span class="op" id="1671165">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671169">if</span>&nbsp;<span class="ident" id="1671172">sg</span>&nbsp;<span class="op" id="1671175">!=</span>&nbsp;<span class="ident" id="1671178">nil</span>&nbsp;<span class="op" id="1671182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671187">if</span>&nbsp;<span class="ident" id="1671190">raceenabled</span>&nbsp;<span class="op" id="1671202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671208">racesync</span><span class="op" id="1671216">(</span><span class="ident" id="1671217">c</span><span class="op" id="1671218">,</span>&nbsp;<span class="ident" id="1671220">sg</span><span class="op" id="1671222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671232">unlock</span><span class="op" id="1671238">(</span><span class="op" id="1671239">&amp;</span><span class="ident" id="1671240">c</span><span class="op" id="1671241">.</span><span class="ident" id="1671242">lock</span><span class="op" id="1671246">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671252">if</span>&nbsp;<span class="ident" id="1671255">ep</span>&nbsp;<span class="op" id="1671258">!=</span>&nbsp;<span class="ident" id="1671261">nil</span>&nbsp;<span class="op" id="1671265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671271">memmove</span><span class="op" id="1671278">(</span><span class="ident" id="1671279">ep</span><span class="op" id="1671281">,</span>&nbsp;<span class="ident" id="1671283">sg</span><span class="op" id="1671285">.</span><span class="ident" id="1671286">elem</span><span class="op" id="1671290">,</span>&nbsp;<span class="builtintype" id="1671292">uintptr</span><span class="op" id="1671299">(</span><span class="ident" id="1671300">c</span><span class="op" id="1671301">.</span><span class="ident" id="1671302">elemsize</span><span class="op" id="1671310">)</span><span class="op" id="1671311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671321">sg</span><span class="op" id="1671323">.</span><span class="ident" id="1671324">elem</span>&nbsp;<span class="op" id="1671329">=</span>&nbsp;<span class="ident" id="1671331">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671338">gp</span>&nbsp;<span class="op" id="1671341">:=</span>&nbsp;<span class="ident" id="1671344">sg</span><span class="op" id="1671346">.</span><span class="ident" id="1671347">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671352">gp</span><span class="op" id="1671354">.</span><span class="ident" id="1671355">param</span>&nbsp;<span class="op" id="1671361">=</span>&nbsp;<span class="ident" id="1671363">unsafe</span><span class="op" id="1671369">.</span><span class="ident" id="1671370">Pointer</span><span class="op" id="1671377">(</span><span class="ident" id="1671378">sg</span><span class="op" id="1671380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671385">if</span>&nbsp;<span class="ident" id="1671388">sg</span><span class="op" id="1671390">.</span><span class="ident" id="1671391">releasetime</span>&nbsp;<span class="op" id="1671403">!=</span>&nbsp;<span class="num" id="1671406">0</span>&nbsp;<span class="op" id="1671408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671414">sg</span><span class="op" id="1671416">.</span><span class="ident" id="1671417">releasetime</span>&nbsp;<span class="op" id="1671429">=</span>&nbsp;<span class="ident" id="1671431">cputicks</span><span class="op" id="1671439">(</span><span class="op" id="1671440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671445">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671450">goready</span><span class="op" id="1671457">(</span><span class="ident" id="1671458">gp</span><span class="op" id="1671460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671465">selected</span>&nbsp;<span class="op" id="1671474">=</span>&nbsp;<span class="builtintype" id="1671476">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671484">received</span>&nbsp;<span class="op" id="1671493">=</span>&nbsp;<span class="builtintype" id="1671495">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671503">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671512">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671517">if</span>&nbsp;<span class="op" id="1671520">!</span><span class="ident" id="1671521">block</span>&nbsp;<span class="op" id="1671527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671532">unlock</span><span class="op" id="1671538">(</span><span class="op" id="1671539">&amp;</span><span class="ident" id="1671540">c</span><span class="op" id="1671541">.</span><span class="ident" id="1671542">lock</span><span class="op" id="1671546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671551">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671560">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1671565">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671614">gp</span>&nbsp;<span class="op" id="1671617">:=</span>&nbsp;<span class="ident" id="1671620">getg</span><span class="op" id="1671624">(</span><span class="op" id="1671625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671629">mysg</span>&nbsp;<span class="op" id="1671634">:=</span>&nbsp;<span class="ident" id="1671637">acquireSudog</span><span class="op" id="1671649">(</span><span class="op" id="1671650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671654">mysg</span><span class="op" id="1671658">.</span><span class="ident" id="1671659">releasetime</span>&nbsp;<span class="op" id="1671671">=</span>&nbsp;<span class="num" id="1671673">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671677">if</span>&nbsp;<span class="ident" id="1671680">t0</span>&nbsp;<span class="op" id="1671683">!=</span>&nbsp;<span class="num" id="1671686">0</span>&nbsp;<span class="op" id="1671688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671693">mysg</span><span class="op" id="1671697">.</span><span class="ident" id="1671698">releasetime</span>&nbsp;<span class="op" id="1671710">=</span>&nbsp;<span class="op" id="1671712">-</span><span class="num" id="1671713">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671721">mysg</span><span class="op" id="1671725">.</span><span class="ident" id="1671726">elem</span>&nbsp;<span class="op" id="1671731">=</span>&nbsp;<span class="ident" id="1671733">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671738">mysg</span><span class="op" id="1671742">.</span><span class="ident" id="1671743">waitlink</span>&nbsp;<span class="op" id="1671752">=</span>&nbsp;<span class="ident" id="1671754">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671760">gp</span><span class="op" id="1671762">.</span><span class="ident" id="1671763">waiting</span>&nbsp;<span class="op" id="1671771">=</span>&nbsp;<span class="ident" id="1671773">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671780">mysg</span><span class="op" id="1671784">.</span><span class="ident" id="1671785">g</span>&nbsp;<span class="op" id="1671787">=</span>&nbsp;<span class="ident" id="1671789">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671794">mysg</span><span class="op" id="1671798">.</span><span class="ident" id="1671799">selectdone</span>&nbsp;<span class="op" id="1671810">=</span>&nbsp;<span class="ident" id="1671812">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671818">gp</span><span class="op" id="1671820">.</span><span class="ident" id="1671821">param</span>&nbsp;<span class="op" id="1671827">=</span>&nbsp;<span class="ident" id="1671829">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671835">c</span><span class="op" id="1671836">.</span><span class="ident" id="1671837">recvq</span><span class="op" id="1671842">.</span><span class="ident" id="1671843">enqueue</span><span class="op" id="1671850">(</span><span class="ident" id="1671851">mysg</span><span class="op" id="1671855">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671859">goparkunlock</span><span class="op" id="1671871">(</span><span class="op" id="1671872">&amp;</span><span class="ident" id="1671873">c</span><span class="op" id="1671874">.</span><span class="ident" id="1671875">lock</span><span class="op" id="1671879">,</span>&nbsp;<span class="string" id="1671881">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1671895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1671900">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1671924">if</span>&nbsp;<span class="ident" id="1671927">mysg</span>&nbsp;<span class="op" id="1671932">!=</span>&nbsp;<span class="ident" id="1671935">gp</span><span class="op" id="1671937">.</span><span class="ident" id="1671938">waiting</span>&nbsp;<span class="op" id="1671946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671951">gothrow</span><span class="op" id="1671958">(</span><span class="string" id="1671959">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1671989">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1671993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1671997">gp</span><span class="op" id="1671999">.</span><span class="ident" id="1672000">waiting</span>&nbsp;<span class="op" id="1672008">=</span>&nbsp;<span class="ident" id="1672010">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672016">if</span>&nbsp;<span class="ident" id="1672019">mysg</span><span class="op" id="1672023">.</span><span class="ident" id="1672024">releasetime</span>&nbsp;<span class="op" id="1672036">&gt;</span>&nbsp;<span class="num" id="1672038">0</span>&nbsp;<span class="op" id="1672040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672045">blockevent</span><span class="op" id="1672055">(</span><span class="ident" id="1672056">mysg</span><span class="op" id="1672060">.</span><span class="ident" id="1672061">releasetime</span><span class="op" id="1672072">-</span><span class="ident" id="1672073">t0</span><span class="op" id="1672075">,</span>&nbsp;<span class="num" id="1672077">2</span><span class="op" id="1672078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672082">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672086">haveData</span>&nbsp;<span class="op" id="1672095">:=</span>&nbsp;<span class="ident" id="1672098">gp</span><span class="op" id="1672100">.</span><span class="ident" id="1672101">param</span>&nbsp;<span class="op" id="1672107">!=</span>&nbsp;<span class="ident" id="1672110">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672116">gp</span><span class="op" id="1672118">.</span><span class="ident" id="1672119">param</span>&nbsp;<span class="op" id="1672125">=</span>&nbsp;<span class="ident" id="1672127">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672133">releaseSudog</span><span class="op" id="1672145">(</span><span class="ident" id="1672146">mysg</span><span class="op" id="1672150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672155">if</span>&nbsp;<span class="ident" id="1672158">haveData</span>&nbsp;<span class="op" id="1672167">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1672172">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672230">selected</span>&nbsp;<span class="op" id="1672239">=</span>&nbsp;<span class="builtintype" id="1672241">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672249">received</span>&nbsp;<span class="op" id="1672258">=</span>&nbsp;<span class="builtintype" id="1672260">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672268">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672277">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672282">lock</span><span class="op" id="1672286">(</span><span class="op" id="1672287">&amp;</span><span class="ident" id="1672288">c</span><span class="op" id="1672289">.</span><span class="ident" id="1672290">lock</span><span class="op" id="1672294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672298">if</span>&nbsp;<span class="ident" id="1672301">c</span><span class="op" id="1672302">.</span><span class="ident" id="1672303">closed</span>&nbsp;<span class="op" id="1672310">==</span>&nbsp;<span class="num" id="1672313">0</span>&nbsp;<span class="op" id="1672315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672320">gothrow</span><span class="op" id="1672327">(</span><span class="string" id="1672328">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1672355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672359">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672363">return</span>&nbsp;<span class="ident" id="1672370">recvclosed</span><span class="op" id="1672380">(</span><span class="ident" id="1672381">c</span><span class="op" id="1672382">,</span>&nbsp;<span class="ident" id="1672384">ep</span><span class="op" id="1672386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1672393">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1672418">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672451">var</span>&nbsp;<span class="ident" id="1672455">t1</span>&nbsp;<span class="ident" id="1672458">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672465">for</span>&nbsp;<span class="ident" id="1672469">c</span><span class="op" id="1672470">.</span><span class="ident" id="1672471">qcount</span>&nbsp;<span class="op" id="1672478">&lt;=</span>&nbsp;<span class="num" id="1672481">0</span>&nbsp;<span class="op" id="1672483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672487">if</span>&nbsp;<span class="ident" id="1672490">c</span><span class="op" id="1672491">.</span><span class="ident" id="1672492">closed</span>&nbsp;<span class="op" id="1672499">!=</span>&nbsp;<span class="num" id="1672502">0</span>&nbsp;<span class="op" id="1672504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672509">selected</span><span class="op" id="1672517">,</span>&nbsp;<span class="ident" id="1672519">received</span>&nbsp;<span class="op" id="1672528">=</span>&nbsp;<span class="ident" id="1672530">recvclosed</span><span class="op" id="1672540">(</span><span class="ident" id="1672541">c</span><span class="op" id="1672542">,</span>&nbsp;<span class="ident" id="1672544">ep</span><span class="op" id="1672546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672551">if</span>&nbsp;<span class="ident" id="1672554">t1</span>&nbsp;<span class="op" id="1672557">&gt;</span>&nbsp;<span class="num" id="1672559">0</span>&nbsp;<span class="op" id="1672561">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672567">blockevent</span><span class="op" id="1672577">(</span><span class="ident" id="1672578">t1</span><span class="op" id="1672580">-</span><span class="ident" id="1672581">t0</span><span class="op" id="1672583">,</span>&nbsp;<span class="num" id="1672585">2</span><span class="op" id="1672586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672596">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672610">if</span>&nbsp;<span class="op" id="1672613">!</span><span class="ident" id="1672614">block</span>&nbsp;<span class="op" id="1672620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672625">unlock</span><span class="op" id="1672631">(</span><span class="op" id="1672632">&amp;</span><span class="ident" id="1672633">c</span><span class="op" id="1672634">.</span><span class="ident" id="1672635">lock</span><span class="op" id="1672639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672644">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1672658">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672699">gp</span>&nbsp;<span class="op" id="1672702">:=</span>&nbsp;<span class="ident" id="1672705">getg</span><span class="op" id="1672709">(</span><span class="op" id="1672710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672714">mysg</span>&nbsp;<span class="op" id="1672719">:=</span>&nbsp;<span class="ident" id="1672722">acquireSudog</span><span class="op" id="1672734">(</span><span class="op" id="1672735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672739">mysg</span><span class="op" id="1672743">.</span><span class="ident" id="1672744">releasetime</span>&nbsp;<span class="op" id="1672756">=</span>&nbsp;<span class="num" id="1672758">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672762">if</span>&nbsp;<span class="ident" id="1672765">t0</span>&nbsp;<span class="op" id="1672768">!=</span>&nbsp;<span class="num" id="1672771">0</span>&nbsp;<span class="op" id="1672773">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672778">mysg</span><span class="op" id="1672782">.</span><span class="ident" id="1672783">releasetime</span>&nbsp;<span class="op" id="1672795">=</span>&nbsp;<span class="op" id="1672797">-</span><span class="num" id="1672798">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1672802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672806">mysg</span><span class="op" id="1672810">.</span><span class="ident" id="1672811">elem</span>&nbsp;<span class="op" id="1672816">=</span>&nbsp;<span class="ident" id="1672818">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672824">mysg</span><span class="op" id="1672828">.</span><span class="ident" id="1672829">g</span>&nbsp;<span class="op" id="1672831">=</span>&nbsp;<span class="ident" id="1672833">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672838">mysg</span><span class="op" id="1672842">.</span><span class="ident" id="1672843">selectdone</span>&nbsp;<span class="op" id="1672854">=</span>&nbsp;<span class="ident" id="1672856">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672863">c</span><span class="op" id="1672864">.</span><span class="ident" id="1672865">recvq</span><span class="op" id="1672870">.</span><span class="ident" id="1672871">enqueue</span><span class="op" id="1672878">(</span><span class="ident" id="1672879">mysg</span><span class="op" id="1672883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672887">goparkunlock</span><span class="op" id="1672899">(</span><span class="op" id="1672900">&amp;</span><span class="ident" id="1672901">c</span><span class="op" id="1672902">.</span><span class="ident" id="1672903">lock</span><span class="op" id="1672907">,</span>&nbsp;<span class="string" id="1672909">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1672923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1672928">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1672964">if</span>&nbsp;<span class="ident" id="1672967">mysg</span><span class="op" id="1672971">.</span><span class="ident" id="1672972">releasetime</span>&nbsp;<span class="op" id="1672984">&gt;</span>&nbsp;<span class="num" id="1672986">0</span>&nbsp;<span class="op" id="1672988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1672993">t1</span>&nbsp;<span class="op" id="1672996">=</span>&nbsp;<span class="ident" id="1672998">mysg</span><span class="op" id="1673002">.</span><span class="ident" id="1673003">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673021">releaseSudog</span><span class="op" id="1673033">(</span><span class="ident" id="1673034">mysg</span><span class="op" id="1673038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673042">lock</span><span class="op" id="1673046">(</span><span class="op" id="1673047">&amp;</span><span class="ident" id="1673048">c</span><span class="op" id="1673049">.</span><span class="ident" id="1673050">lock</span><span class="op" id="1673054">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673061">if</span>&nbsp;<span class="ident" id="1673064">raceenabled</span>&nbsp;<span class="op" id="1673076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673080">raceacquire</span><span class="op" id="1673091">(</span><span class="ident" id="1673092">chanbuf</span><span class="op" id="1673099">(</span><span class="ident" id="1673100">c</span><span class="op" id="1673101">,</span>&nbsp;<span class="ident" id="1673103">c</span><span class="op" id="1673104">.</span><span class="ident" id="1673105">recvx</span><span class="op" id="1673110">)</span><span class="op" id="1673111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673115">racerelease</span><span class="op" id="1673126">(</span><span class="ident" id="1673127">chanbuf</span><span class="op" id="1673134">(</span><span class="ident" id="1673135">c</span><span class="op" id="1673136">,</span>&nbsp;<span class="ident" id="1673138">c</span><span class="op" id="1673139">.</span><span class="ident" id="1673140">recvx</span><span class="op" id="1673145">)</span><span class="op" id="1673146">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673152">if</span>&nbsp;<span class="ident" id="1673155">ep</span>&nbsp;<span class="op" id="1673158">!=</span>&nbsp;<span class="ident" id="1673161">nil</span>&nbsp;<span class="op" id="1673165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673169">memmove</span><span class="op" id="1673176">(</span><span class="ident" id="1673177">ep</span><span class="op" id="1673179">,</span>&nbsp;<span class="ident" id="1673181">chanbuf</span><span class="op" id="1673188">(</span><span class="ident" id="1673189">c</span><span class="op" id="1673190">,</span>&nbsp;<span class="ident" id="1673192">c</span><span class="op" id="1673193">.</span><span class="ident" id="1673194">recvx</span><span class="op" id="1673199">)</span><span class="op" id="1673200">,</span>&nbsp;<span class="builtintype" id="1673202">uintptr</span><span class="op" id="1673209">(</span><span class="ident" id="1673210">c</span><span class="op" id="1673211">.</span><span class="ident" id="1673212">elemsize</span><span class="op" id="1673220">)</span><span class="op" id="1673221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673227">memclr</span><span class="op" id="1673233">(</span><span class="ident" id="1673234">chanbuf</span><span class="op" id="1673241">(</span><span class="ident" id="1673242">c</span><span class="op" id="1673243">,</span>&nbsp;<span class="ident" id="1673245">c</span><span class="op" id="1673246">.</span><span class="ident" id="1673247">recvx</span><span class="op" id="1673252">)</span><span class="op" id="1673253">,</span>&nbsp;<span class="builtintype" id="1673255">uintptr</span><span class="op" id="1673262">(</span><span class="ident" id="1673263">c</span><span class="op" id="1673264">.</span><span class="ident" id="1673265">elemsize</span><span class="op" id="1673273">)</span><span class="op" id="1673274">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673278">c</span><span class="op" id="1673279">.</span><span class="ident" id="1673280">recvx</span><span class="op" id="1673285">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673289">if</span>&nbsp;<span class="ident" id="1673292">c</span><span class="op" id="1673293">.</span><span class="ident" id="1673294">recvx</span>&nbsp;<span class="op" id="1673300">==</span>&nbsp;<span class="ident" id="1673303">c</span><span class="op" id="1673304">.</span><span class="ident" id="1673305">dataqsiz</span>&nbsp;<span class="op" id="1673314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673318">c</span><span class="op" id="1673319">.</span><span class="ident" id="1673320">recvx</span>&nbsp;<span class="op" id="1673326">=</span>&nbsp;<span class="num" id="1673328">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673331">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673334">c</span><span class="op" id="1673335">.</span><span class="ident" id="1673336">qcount</span><span class="op" id="1673342">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1673347">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673389">sg</span>&nbsp;<span class="op" id="1673392">:=</span>&nbsp;<span class="ident" id="1673395">c</span><span class="op" id="1673396">.</span><span class="ident" id="1673397">sendq</span><span class="op" id="1673402">.</span><span class="ident" id="1673403">dequeue</span><span class="op" id="1673410">(</span><span class="op" id="1673411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673414">if</span>&nbsp;<span class="ident" id="1673417">sg</span>&nbsp;<span class="op" id="1673420">!=</span>&nbsp;<span class="ident" id="1673423">nil</span>&nbsp;<span class="op" id="1673427">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673431">gp</span>&nbsp;<span class="op" id="1673434">:=</span>&nbsp;<span class="ident" id="1673437">sg</span><span class="op" id="1673439">.</span><span class="ident" id="1673440">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673444">unlock</span><span class="op" id="1673450">(</span><span class="op" id="1673451">&amp;</span><span class="ident" id="1673452">c</span><span class="op" id="1673453">.</span><span class="ident" id="1673454">lock</span><span class="op" id="1673458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673462">if</span>&nbsp;<span class="ident" id="1673465">sg</span><span class="op" id="1673467">.</span><span class="ident" id="1673468">releasetime</span>&nbsp;<span class="op" id="1673480">!=</span>&nbsp;<span class="num" id="1673483">0</span>&nbsp;<span class="op" id="1673485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673490">sg</span><span class="op" id="1673492">.</span><span class="ident" id="1673493">releasetime</span>&nbsp;<span class="op" id="1673505">=</span>&nbsp;<span class="ident" id="1673507">cputicks</span><span class="op" id="1673515">(</span><span class="op" id="1673516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673520">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673524">goready</span><span class="op" id="1673531">(</span><span class="ident" id="1673532">gp</span><span class="op" id="1673534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673537">}</span>&nbsp;<span class="keyword" id="1673539">else</span>&nbsp;<span class="op" id="1673544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673548">unlock</span><span class="op" id="1673554">(</span><span class="op" id="1673555">&amp;</span><span class="ident" id="1673556">c</span><span class="op" id="1673557">.</span><span class="ident" id="1673558">lock</span><span class="op" id="1673562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673569">if</span>&nbsp;<span class="ident" id="1673572">t1</span>&nbsp;<span class="op" id="1673575">&gt;</span>&nbsp;<span class="num" id="1673577">0</span>&nbsp;<span class="op" id="1673579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673583">blockevent</span><span class="op" id="1673593">(</span><span class="ident" id="1673594">t1</span><span class="op" id="1673596">-</span><span class="ident" id="1673597">t0</span><span class="op" id="1673599">,</span>&nbsp;<span class="num" id="1673601">2</span><span class="op" id="1673602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673608">selected</span>&nbsp;<span class="op" id="1673617">=</span>&nbsp;<span class="builtintype" id="1673619">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673625">received</span>&nbsp;<span class="op" id="1673634">=</span>&nbsp;<span class="builtintype" id="1673636">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673642">return</span><br>
<span class="lineno"></span><span class="op" id="1673649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1673652">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1673718">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1673768">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1673830">func</span>&nbsp;<span class="ident" id="1673835">recvclosed</span><span class="op" id="1673845">(</span><span class="ident" id="1673846">c</span>&nbsp;<span class="op" id="1673848">*</span><span class="ident" id="1673849">hchan</span><span class="op" id="1673854">,</span>&nbsp;<span class="ident" id="1673856">ep</span>&nbsp;<span class="ident" id="1673859">unsafe</span><span class="op" id="1673865">.</span><span class="ident" id="1673866">Pointer</span><span class="op" id="1673873">)</span>&nbsp;<span class="op" id="1673875">(</span><span class="ident" id="1673876">selected</span><span class="op" id="1673884">,</span>&nbsp;<span class="ident" id="1673886">recevied</span>&nbsp;<span class="builtintype" id="1673895">bool</span><span class="op" id="1673899">)</span>&nbsp;<span class="op" id="1673901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673904">if</span>&nbsp;<span class="ident" id="1673907">raceenabled</span>&nbsp;<span class="op" id="1673919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673923">raceacquire</span><span class="op" id="1673934">(</span><span class="ident" id="1673935">unsafe</span><span class="op" id="1673941">.</span><span class="ident" id="1673942">Pointer</span><span class="op" id="1673949">(</span><span class="ident" id="1673950">c</span><span class="op" id="1673951">)</span><span class="op" id="1673952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1673955">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673958">unlock</span><span class="op" id="1673964">(</span><span class="op" id="1673965">&amp;</span><span class="ident" id="1673966">c</span><span class="op" id="1673967">.</span><span class="ident" id="1673968">lock</span><span class="op" id="1673972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1673975">if</span>&nbsp;<span class="ident" id="1673978">ep</span>&nbsp;<span class="op" id="1673981">!=</span>&nbsp;<span class="ident" id="1673984">nil</span>&nbsp;<span class="op" id="1673988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673992">memclr</span><span class="op" id="1673998">(</span><span class="ident" id="1673999">ep</span><span class="op" id="1674001">,</span>&nbsp;<span class="builtintype" id="1674003">uintptr</span><span class="op" id="1674010">(</span><span class="ident" id="1674011">c</span><span class="op" id="1674012">.</span><span class="ident" id="1674013">elemsize</span><span class="op" id="1674021">)</span><span class="op" id="1674022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674028">return</span>&nbsp;<span class="builtintype" id="1674035">true</span><span class="op" id="1674039">,</span>&nbsp;<span class="builtintype" id="1674041">false</span><br>
<span class="lineno">525</span><span class="op" id="1674047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1674050">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1674073">//</span><br>
<span class="lineno"></span><span class="comment" id="1674076">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1674088">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1674104">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1674116">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1674128">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1674140">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1674145">//</span><br>
<span class="lineno"></span><span class="comment" id="1674148">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1674154">//</span><br>
<span class="lineno"></span><span class="comment" id="1674157">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674184">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1674196">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674208">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1674220">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1674225">//</span><br>
<span class="lineno"></span><span class="keyword" id="1674228">func</span>&nbsp;<span class="ident" id="1674233">selectnbsend</span><span class="op" id="1674245">(</span><span class="ident" id="1674246">t</span>&nbsp;<span class="op" id="1674248">*</span><span class="ident" id="1674249">chantype</span><span class="op" id="1674257">,</span>&nbsp;<span class="ident" id="1674259">c</span>&nbsp;<span class="op" id="1674261">*</span><span class="ident" id="1674262">hchan</span><span class="op" id="1674267">,</span>&nbsp;<span class="ident" id="1674269">elem</span>&nbsp;<span class="ident" id="1674274">unsafe</span><span class="op" id="1674280">.</span><span class="ident" id="1674281">Pointer</span><span class="op" id="1674288">)</span>&nbsp;<span class="op" id="1674290">(</span><span class="ident" id="1674291">selected</span>&nbsp;<span class="builtintype" id="1674300">bool</span><span class="op" id="1674304">)</span>&nbsp;<span class="op" id="1674306">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674309">return</span>&nbsp;<span class="ident" id="1674316">chansend</span><span class="op" id="1674324">(</span><span class="ident" id="1674325">t</span><span class="op" id="1674326">,</span>&nbsp;<span class="ident" id="1674328">c</span><span class="op" id="1674329">,</span>&nbsp;<span class="ident" id="1674331">elem</span><span class="op" id="1674335">,</span>&nbsp;<span class="builtintype" id="1674337">false</span><span class="op" id="1674342">,</span>&nbsp;<span class="ident" id="1674344">getcallerpc</span><span class="op" id="1674355">(</span><span class="ident" id="1674356">unsafe</span><span class="op" id="1674362">.</span><span class="ident" id="1674363">Pointer</span><span class="op" id="1674370">(</span><span class="op" id="1674371">&amp;</span><span class="ident" id="1674372">t</span><span class="op" id="1674373">)</span><span class="op" id="1674374">)</span><span class="op" id="1674375">)</span><br>
<span class="lineno"></span><span class="op" id="1674377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1674380">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1674403">//</span><br>
<span class="lineno">550</span><span class="comment" id="1674406">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674418">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1674435">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1674447">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1674459">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1674471">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1674476">//</span><br>
<span class="lineno"></span><span class="comment" id="1674479">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1674485">//</span><br>
<span class="lineno"></span><span class="comment" id="1674488">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1674516">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1674528">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674540">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1674552">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1674557">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1674560">func</span>&nbsp;<span class="ident" id="1674565">selectnbrecv</span><span class="op" id="1674577">(</span><span class="ident" id="1674578">t</span>&nbsp;<span class="op" id="1674580">*</span><span class="ident" id="1674581">chantype</span><span class="op" id="1674589">,</span>&nbsp;<span class="ident" id="1674591">elem</span>&nbsp;<span class="ident" id="1674596">unsafe</span><span class="op" id="1674602">.</span><span class="ident" id="1674603">Pointer</span><span class="op" id="1674610">,</span>&nbsp;<span class="ident" id="1674612">c</span>&nbsp;<span class="op" id="1674614">*</span><span class="ident" id="1674615">hchan</span><span class="op" id="1674620">)</span>&nbsp;<span class="op" id="1674622">(</span><span class="ident" id="1674623">selected</span>&nbsp;<span class="builtintype" id="1674632">bool</span><span class="op" id="1674636">)</span>&nbsp;<span class="op" id="1674638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674641">selected</span><span class="op" id="1674649">,</span>&nbsp;<span class="ident" id="1674651">_</span>&nbsp;<span class="op" id="1674653">=</span>&nbsp;<span class="ident" id="1674655">chanrecv</span><span class="op" id="1674663">(</span><span class="ident" id="1674664">t</span><span class="op" id="1674665">,</span>&nbsp;<span class="ident" id="1674667">c</span><span class="op" id="1674668">,</span>&nbsp;<span class="ident" id="1674670">elem</span><span class="op" id="1674674">,</span>&nbsp;<span class="builtintype" id="1674676">false</span><span class="op" id="1674681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674684">return</span><br>
<span class="lineno"></span><span class="op" id="1674691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1674694">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1674717">//</span><br>
<span class="lineno"></span><span class="comment" id="1674720">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674732">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1674753">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1674765">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1674777">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1674789">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1674794">//</span><br>
<span class="lineno"></span><span class="comment" id="1674797">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1674803">//</span><br>
<span class="lineno"></span><span class="comment" id="1674806">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674852">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1674864">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1674876">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1674888">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1674893">//</span><br>
<span class="lineno"></span><span class="keyword" id="1674896">func</span>&nbsp;<span class="ident" id="1674901">selectnbrecv2</span><span class="op" id="1674914">(</span><span class="ident" id="1674915">t</span>&nbsp;<span class="op" id="1674917">*</span><span class="ident" id="1674918">chantype</span><span class="op" id="1674926">,</span>&nbsp;<span class="ident" id="1674928">elem</span>&nbsp;<span class="ident" id="1674933">unsafe</span><span class="op" id="1674939">.</span><span class="ident" id="1674940">Pointer</span><span class="op" id="1674947">,</span>&nbsp;<span class="ident" id="1674949">received</span>&nbsp;<span class="op" id="1674958">*</span><span class="builtintype" id="1674959">bool</span><span class="op" id="1674963">,</span>&nbsp;<span class="ident" id="1674965">c</span>&nbsp;<span class="op" id="1674967">*</span><span class="ident" id="1674968">hchan</span><span class="op" id="1674973">)</span>&nbsp;<span class="op" id="1674975">(</span><span class="ident" id="1674976">selected</span>&nbsp;<span class="builtintype" id="1674985">bool</span><span class="op" id="1674989">)</span>&nbsp;<span class="op" id="1674991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1674994">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675072">selected</span><span class="op" id="1675080">,</span>&nbsp;<span class="op" id="1675082">*</span><span class="ident" id="1675083">received</span>&nbsp;<span class="op" id="1675092">=</span>&nbsp;<span class="ident" id="1675094">chanrecv</span><span class="op" id="1675102">(</span><span class="ident" id="1675103">t</span><span class="op" id="1675104">,</span>&nbsp;<span class="ident" id="1675106">c</span><span class="op" id="1675107">,</span>&nbsp;<span class="ident" id="1675109">elem</span><span class="op" id="1675113">,</span>&nbsp;<span class="builtintype" id="1675115">false</span><span class="op" id="1675120">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675123">return</span><br>
<span class="lineno"></span><span class="op" id="1675130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1675133">func</span>&nbsp;<span class="ident" id="1675138">reflect_chansend</span><span class="op" id="1675154">(</span><span class="ident" id="1675155">t</span>&nbsp;<span class="op" id="1675157">*</span><span class="ident" id="1675158">chantype</span><span class="op" id="1675166">,</span>&nbsp;<span class="ident" id="1675168">c</span>&nbsp;<span class="op" id="1675170">*</span><span class="ident" id="1675171">hchan</span><span class="op" id="1675176">,</span>&nbsp;<span class="ident" id="1675178">elem</span>&nbsp;<span class="ident" id="1675183">unsafe</span><span class="op" id="1675189">.</span><span class="ident" id="1675190">Pointer</span><span class="op" id="1675197">,</span>&nbsp;<span class="ident" id="1675199">nb</span>&nbsp;<span class="builtintype" id="1675202">bool</span><span class="op" id="1675206">)</span>&nbsp;<span class="op" id="1675208">(</span><span class="ident" id="1675209">selected</span>&nbsp;<span class="builtintype" id="1675218">bool</span><span class="op" id="1675222">)</span>&nbsp;<span class="op" id="1675224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675227">return</span>&nbsp;<span class="ident" id="1675234">chansend</span><span class="op" id="1675242">(</span><span class="ident" id="1675243">t</span><span class="op" id="1675244">,</span>&nbsp;<span class="ident" id="1675246">c</span><span class="op" id="1675247">,</span>&nbsp;<span class="ident" id="1675249">elem</span><span class="op" id="1675253">,</span>&nbsp;<span class="op" id="1675255">!</span><span class="ident" id="1675256">nb</span><span class="op" id="1675258">,</span>&nbsp;<span class="ident" id="1675260">getcallerpc</span><span class="op" id="1675271">(</span><span class="ident" id="1675272">unsafe</span><span class="op" id="1675278">.</span><span class="ident" id="1675279">Pointer</span><span class="op" id="1675286">(</span><span class="op" id="1675287">&amp;</span><span class="ident" id="1675288">t</span><span class="op" id="1675289">)</span><span class="op" id="1675290">)</span><span class="op" id="1675291">)</span><br>
<span class="lineno">595</span><span class="op" id="1675293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1675296">func</span>&nbsp;<span class="ident" id="1675301">reflect_chanrecv</span><span class="op" id="1675317">(</span><span class="ident" id="1675318">t</span>&nbsp;<span class="op" id="1675320">*</span><span class="ident" id="1675321">chantype</span><span class="op" id="1675329">,</span>&nbsp;<span class="ident" id="1675331">c</span>&nbsp;<span class="op" id="1675333">*</span><span class="ident" id="1675334">hchan</span><span class="op" id="1675339">,</span>&nbsp;<span class="ident" id="1675341">nb</span>&nbsp;<span class="builtintype" id="1675344">bool</span><span class="op" id="1675348">,</span>&nbsp;<span class="ident" id="1675350">elem</span>&nbsp;<span class="ident" id="1675355">unsafe</span><span class="op" id="1675361">.</span><span class="ident" id="1675362">Pointer</span><span class="op" id="1675369">)</span>&nbsp;<span class="op" id="1675371">(</span><span class="ident" id="1675372">selected</span>&nbsp;<span class="builtintype" id="1675381">bool</span><span class="op" id="1675385">,</span>&nbsp;<span class="ident" id="1675387">received</span>&nbsp;<span class="builtintype" id="1675396">bool</span><span class="op" id="1675400">)</span>&nbsp;<span class="op" id="1675402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675405">return</span>&nbsp;<span class="ident" id="1675412">chanrecv</span><span class="op" id="1675420">(</span><span class="ident" id="1675421">t</span><span class="op" id="1675422">,</span>&nbsp;<span class="ident" id="1675424">c</span><span class="op" id="1675425">,</span>&nbsp;<span class="ident" id="1675427">elem</span><span class="op" id="1675431">,</span>&nbsp;<span class="op" id="1675433">!</span><span class="ident" id="1675434">nb</span><span class="op" id="1675436">)</span><br>
<span class="lineno"></span><span class="op" id="1675438">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1675441">func</span>&nbsp;<span class="ident" id="1675446">reflect_chanlen</span><span class="op" id="1675461">(</span><span class="ident" id="1675462">c</span>&nbsp;<span class="op" id="1675464">*</span><span class="ident" id="1675465">hchan</span><span class="op" id="1675470">)</span>&nbsp;<span class="builtintype" id="1675472">int</span>&nbsp;<span class="op" id="1675476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675479">if</span>&nbsp;<span class="ident" id="1675482">c</span>&nbsp;<span class="op" id="1675484">==</span>&nbsp;<span class="ident" id="1675487">nil</span>&nbsp;<span class="op" id="1675491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675495">return</span>&nbsp;<span class="num" id="1675502">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675505">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675508">return</span>&nbsp;<span class="builtintype" id="1675515">int</span><span class="op" id="1675518">(</span><span class="ident" id="1675519">c</span><span class="op" id="1675520">.</span><span class="ident" id="1675521">qcount</span><span class="op" id="1675527">)</span><br>
<span class="lineno"></span><span class="op" id="1675529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1675532">func</span>&nbsp;<span class="ident" id="1675537">reflect_chancap</span><span class="op" id="1675552">(</span><span class="ident" id="1675553">c</span>&nbsp;<span class="op" id="1675555">*</span><span class="ident" id="1675556">hchan</span><span class="op" id="1675561">)</span>&nbsp;<span class="builtintype" id="1675563">int</span>&nbsp;<span class="op" id="1675567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675570">if</span>&nbsp;<span class="ident" id="1675573">c</span>&nbsp;<span class="op" id="1675575">==</span>&nbsp;<span class="ident" id="1675578">nil</span>&nbsp;<span class="op" id="1675582">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675586">return</span>&nbsp;<span class="num" id="1675593">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675599">return</span>&nbsp;<span class="builtintype" id="1675606">int</span><span class="op" id="1675609">(</span><span class="ident" id="1675610">c</span><span class="op" id="1675611">.</span><span class="ident" id="1675612">dataqsiz</span><span class="op" id="1675620">)</span><br>
<span class="lineno"></span><span class="op" id="1675622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1675625">func</span>&nbsp;<span class="op" id="1675630">(</span><span class="ident" id="1675631">q</span>&nbsp;<span class="op" id="1675633">*</span><span class="ident" id="1675634">waitq</span><span class="op" id="1675639">)</span>&nbsp;<span class="ident" id="1675641">enqueue</span><span class="op" id="1675648">(</span><span class="ident" id="1675649">sgp</span>&nbsp;<span class="op" id="1675653">*</span><span class="ident" id="1675654">sudog</span><span class="op" id="1675659">)</span>&nbsp;<span class="op" id="1675661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675664">sgp</span><span class="op" id="1675667">.</span><span class="ident" id="1675668">next</span>&nbsp;<span class="op" id="1675673">=</span>&nbsp;<span class="ident" id="1675675">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675680">if</span>&nbsp;<span class="ident" id="1675683">q</span><span class="op" id="1675684">.</span><span class="ident" id="1675685">first</span>&nbsp;<span class="op" id="1675691">==</span>&nbsp;<span class="ident" id="1675694">nil</span>&nbsp;<span class="op" id="1675698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675702">q</span><span class="op" id="1675703">.</span><span class="ident" id="1675704">first</span>&nbsp;<span class="op" id="1675710">=</span>&nbsp;<span class="ident" id="1675712">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675718">q</span><span class="op" id="1675719">.</span><span class="ident" id="1675720">last</span>&nbsp;<span class="op" id="1675725">=</span>&nbsp;<span class="ident" id="1675727">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675733">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675744">q</span><span class="op" id="1675745">.</span><span class="ident" id="1675746">last</span><span class="op" id="1675750">.</span><span class="ident" id="1675751">next</span>&nbsp;<span class="op" id="1675756">=</span>&nbsp;<span class="ident" id="1675758">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675763">q</span><span class="op" id="1675764">.</span><span class="ident" id="1675765">last</span>&nbsp;<span class="op" id="1675770">=</span>&nbsp;<span class="ident" id="1675772">sgp</span><br>
<span class="lineno"></span><span class="op" id="1675776">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1675779">func</span>&nbsp;<span class="op" id="1675784">(</span><span class="ident" id="1675785">q</span>&nbsp;<span class="op" id="1675787">*</span><span class="ident" id="1675788">waitq</span><span class="op" id="1675793">)</span>&nbsp;<span class="ident" id="1675795">dequeue</span><span class="op" id="1675802">(</span><span class="op" id="1675803">)</span>&nbsp;<span class="op" id="1675805">*</span><span class="ident" id="1675806">sudog</span>&nbsp;<span class="op" id="1675812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675815">for</span>&nbsp;<span class="op" id="1675819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675823">sgp</span>&nbsp;<span class="op" id="1675827">:=</span>&nbsp;<span class="ident" id="1675830">q</span><span class="op" id="1675831">.</span><span class="ident" id="1675832">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675840">if</span>&nbsp;<span class="ident" id="1675843">sgp</span>&nbsp;<span class="op" id="1675847">==</span>&nbsp;<span class="ident" id="1675850">nil</span>&nbsp;<span class="op" id="1675854">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675859">return</span>&nbsp;<span class="ident" id="1675866">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675876">q</span><span class="op" id="1675877">.</span><span class="ident" id="1675878">first</span>&nbsp;<span class="op" id="1675884">=</span>&nbsp;<span class="ident" id="1675886">sgp</span><span class="op" id="1675889">.</span><span class="ident" id="1675890">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675897">sgp</span><span class="op" id="1675900">.</span><span class="ident" id="1675901">next</span>&nbsp;<span class="op" id="1675906">=</span>&nbsp;<span class="ident" id="1675908">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675914">if</span>&nbsp;<span class="ident" id="1675917">q</span><span class="op" id="1675918">.</span><span class="ident" id="1675919">last</span>&nbsp;<span class="op" id="1675924">==</span>&nbsp;<span class="ident" id="1675927">sgp</span>&nbsp;<span class="op" id="1675931">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675936">q</span><span class="op" id="1675937">.</span><span class="ident" id="1675938">last</span>&nbsp;<span class="op" id="1675943">=</span>&nbsp;<span class="ident" id="1675945">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675956">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676028">if</span>&nbsp;<span class="ident" id="1676031">sgp</span><span class="op" id="1676034">.</span><span class="ident" id="1676035">selectdone</span>&nbsp;<span class="op" id="1676046">!=</span>&nbsp;<span class="ident" id="1676049">nil</span>&nbsp;<span class="op" id="1676053">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1676058">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676090">if</span>&nbsp;<span class="op" id="1676093">*</span><span class="ident" id="1676094">sgp</span><span class="op" id="1676097">.</span><span class="ident" id="1676098">selectdone</span>&nbsp;<span class="op" id="1676109">!=</span>&nbsp;<span class="num" id="1676112">0</span>&nbsp;<span class="op" id="1676114">||</span>&nbsp;<span class="op" id="1676117">!</span><span class="ident" id="1676118">cas</span><span class="op" id="1676121">(</span><span class="ident" id="1676122">sgp</span><span class="op" id="1676125">.</span><span class="ident" id="1676126">selectdone</span><span class="op" id="1676136">,</span>&nbsp;<span class="num" id="1676138">0</span><span class="op" id="1676139">,</span>&nbsp;<span class="num" id="1676141">1</span><span class="op" id="1676142">)</span>&nbsp;<span class="op" id="1676144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676150">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676166">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676171">return</span>&nbsp;<span class="ident" id="1676178">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676183">}</span><br>
<span class="lineno"></span><span class="op" id="1676185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1676188">func</span>&nbsp;<span class="ident" id="1676193">racesync</span><span class="op" id="1676201">(</span><span class="ident" id="1676202">c</span>&nbsp;<span class="op" id="1676204">*</span><span class="ident" id="1676205">hchan</span><span class="op" id="1676210">,</span>&nbsp;<span class="ident" id="1676212">sg</span>&nbsp;<span class="op" id="1676215">*</span><span class="ident" id="1676216">sudog</span><span class="op" id="1676221">)</span>&nbsp;<span class="op" id="1676223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676226">racerelease</span><span class="op" id="1676237">(</span><span class="ident" id="1676238">chanbuf</span><span class="op" id="1676245">(</span><span class="ident" id="1676246">c</span><span class="op" id="1676247">,</span>&nbsp;<span class="num" id="1676249">0</span><span class="op" id="1676250">)</span><span class="op" id="1676251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676254">raceacquireg</span><span class="op" id="1676266">(</span><span class="ident" id="1676267">sg</span><span class="op" id="1676269">.</span><span class="ident" id="1676270">g</span><span class="op" id="1676271">,</span>&nbsp;<span class="ident" id="1676273">chanbuf</span><span class="op" id="1676280">(</span><span class="ident" id="1676281">c</span><span class="op" id="1676282">,</span>&nbsp;<span class="num" id="1676284">0</span><span class="op" id="1676285">)</span><span class="op" id="1676286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676289">racereleaseg</span><span class="op" id="1676301">(</span><span class="ident" id="1676302">sg</span><span class="op" id="1676304">.</span><span class="ident" id="1676305">g</span><span class="op" id="1676306">,</span>&nbsp;<span class="ident" id="1676308">chanbuf</span><span class="op" id="1676315">(</span><span class="ident" id="1676316">c</span><span class="op" id="1676317">,</span>&nbsp;<span class="num" id="1676319">0</span><span class="op" id="1676320">)</span><span class="op" id="1676321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676324">raceacquire</span><span class="op" id="1676335">(</span><span class="ident" id="1676336">chanbuf</span><span class="op" id="1676343">(</span><span class="ident" id="1676344">c</span><span class="op" id="1676345">,</span>&nbsp;<span class="num" id="1676347">0</span><span class="op" id="1676348">)</span><span class="op" id="1676349">)</span><br>
<span class="lineno">655</span><span class="op" id="1676351">}</span>
</div>
</body>
</html>
