<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html" class="current">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1452371">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1452426">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1452480">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1452531">package</span>&nbsp;<span class="ident" id="1452539">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1452545">import</span>&nbsp;<span class="op" id="1452552">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1452555">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1452570">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1452579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1452582">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1452638">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1452696">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1452719">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1452764">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1452811">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1452833">type</span>&nbsp;<span class="ident" id="1452838">RWMutex</span>&nbsp;<span class="keyword" id="1452846">struct</span>&nbsp;<span class="op" id="1452853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452856">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452868">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1452875">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452913">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1452925">uint32</span>&nbsp;<span class="comment" id="1452932">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452989">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1453001">uint32</span>&nbsp;<span class="comment" id="1453008">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453065">readerCount</span>&nbsp;<span class="builtintype" id="1453077">int32</span>&nbsp;&nbsp;<span class="comment" id="1453084">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453114">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1453126">int32</span>&nbsp;&nbsp;<span class="comment" id="1453133">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1453164">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1453167">const</span>&nbsp;<span class="ident" id="1453173">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1453191">=</span>&nbsp;<span class="num" id="1453193">1</span>&nbsp;<span class="op" id="1453195">&lt;&lt;</span>&nbsp;<span class="num" id="1453198">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1453202">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1453233">func</span>&nbsp;<span class="op" id="1453238">(</span><span class="ident" id="1453239">rw</span>&nbsp;<span class="op" id="1453242">*</span><span class="ident" id="1453243">RWMutex</span><span class="op" id="1453250">)</span>&nbsp;<span class="ident" id="1453252">RLock</span><span class="op" id="1453257">(</span><span class="op" id="1453258">)</span>&nbsp;<span class="op" id="1453260">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453263">if</span>&nbsp;<span class="ident" id="1453266">raceenabled</span>&nbsp;<span class="op" id="1453278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453282">_</span>&nbsp;<span class="op" id="1453284">=</span>&nbsp;<span class="ident" id="1453286">rw</span><span class="op" id="1453288">.</span><span class="ident" id="1453289">w</span><span class="op" id="1453290">.</span><span class="ident" id="1453291">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453299">raceDisable</span><span class="op" id="1453310">(</span><span class="op" id="1453311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453317">if</span>&nbsp;<span class="ident" id="1453320">atomic</span><span class="op" id="1453326">.</span><span class="ident" id="1453327">AddInt32</span><span class="op" id="1453335">(</span><span class="op" id="1453336">&amp;</span><span class="ident" id="1453337">rw</span><span class="op" id="1453339">.</span><span class="ident" id="1453340">readerCount</span><span class="op" id="1453351">,</span>&nbsp;<span class="num" id="1453353">1</span><span class="op" id="1453354">)</span>&nbsp;<span class="op" id="1453356">&lt;</span>&nbsp;<span class="num" id="1453358">0</span>&nbsp;<span class="op" id="1453360">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453364">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453403">runtime_Semacquire</span><span class="op" id="1453421">(</span><span class="op" id="1453422">&amp;</span><span class="ident" id="1453423">rw</span><span class="op" id="1453425">.</span><span class="ident" id="1453426">readerSem</span><span class="op" id="1453435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453441">if</span>&nbsp;<span class="ident" id="1453444">raceenabled</span>&nbsp;<span class="op" id="1453456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453460">raceEnable</span><span class="op" id="1453470">(</span><span class="op" id="1453471">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453475">raceAcquire</span><span class="op" id="1453486">(</span><span class="ident" id="1453487">unsafe</span><span class="op" id="1453493">.</span><span class="ident" id="1453494">Pointer</span><span class="op" id="1453501">(</span><span class="op" id="1453502">&amp;</span><span class="ident" id="1453503">rw</span><span class="op" id="1453505">.</span><span class="ident" id="1453506">readerSem</span><span class="op" id="1453515">)</span><span class="op" id="1453516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453519">}</span><br>
<span class="lineno"></span><span class="op" id="1453521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1453524">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1453563">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1453613">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1453671">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1453695">func</span>&nbsp;<span class="op" id="1453700">(</span><span class="ident" id="1453701">rw</span>&nbsp;<span class="op" id="1453704">*</span><span class="ident" id="1453705">RWMutex</span><span class="op" id="1453712">)</span>&nbsp;<span class="ident" id="1453714">RUnlock</span><span class="op" id="1453721">(</span><span class="op" id="1453722">)</span>&nbsp;<span class="op" id="1453724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453727">if</span>&nbsp;<span class="ident" id="1453730">raceenabled</span>&nbsp;<span class="op" id="1453742">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453746">_</span>&nbsp;<span class="op" id="1453748">=</span>&nbsp;<span class="ident" id="1453750">rw</span><span class="op" id="1453752">.</span><span class="ident" id="1453753">w</span><span class="op" id="1453754">.</span><span class="ident" id="1453755">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453763">raceReleaseMerge</span><span class="op" id="1453779">(</span><span class="ident" id="1453780">unsafe</span><span class="op" id="1453786">.</span><span class="ident" id="1453787">Pointer</span><span class="op" id="1453794">(</span><span class="op" id="1453795">&amp;</span><span class="ident" id="1453796">rw</span><span class="op" id="1453798">.</span><span class="ident" id="1453799">writerSem</span><span class="op" id="1453808">)</span><span class="op" id="1453809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453813">raceDisable</span><span class="op" id="1453824">(</span><span class="op" id="1453825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453831">if</span>&nbsp;<span class="ident" id="1453834">r</span>&nbsp;<span class="op" id="1453836">:=</span>&nbsp;<span class="ident" id="1453839">atomic</span><span class="op" id="1453845">.</span><span class="ident" id="1453846">AddInt32</span><span class="op" id="1453854">(</span><span class="op" id="1453855">&amp;</span><span class="ident" id="1453856">rw</span><span class="op" id="1453858">.</span><span class="ident" id="1453859">readerCount</span><span class="op" id="1453870">,</span>&nbsp;<span class="op" id="1453872">-</span><span class="num" id="1453873">1</span><span class="op" id="1453874">)</span><span class="op" id="1453875">;</span>&nbsp;<span class="ident" id="1453877">r</span>&nbsp;<span class="op" id="1453879">&lt;</span>&nbsp;<span class="num" id="1453881">0</span>&nbsp;<span class="op" id="1453883">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453887">if</span>&nbsp;<span class="ident" id="1453890">r</span><span class="op" id="1453891">+</span><span class="num" id="1453892">1</span>&nbsp;<span class="op" id="1453894">==</span>&nbsp;<span class="num" id="1453897">0</span>&nbsp;<span class="op" id="1453899">||</span>&nbsp;<span class="ident" id="1453902">r</span><span class="op" id="1453903">+</span><span class="num" id="1453904">1</span>&nbsp;<span class="op" id="1453906">==</span>&nbsp;<span class="op" id="1453909">-</span><span class="ident" id="1453910">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1453928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453933">raceEnable</span><span class="op" id="1453943">(</span><span class="op" id="1453944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1453949">panic</span><span class="op" id="1453954">(</span><span class="string" id="1453955">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1453990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453998">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454024">if</span>&nbsp;<span class="ident" id="1454027">atomic</span><span class="op" id="1454033">.</span><span class="ident" id="1454034">AddInt32</span><span class="op" id="1454042">(</span><span class="op" id="1454043">&amp;</span><span class="ident" id="1454044">rw</span><span class="op" id="1454046">.</span><span class="ident" id="1454047">readerWait</span><span class="op" id="1454057">,</span>&nbsp;<span class="op" id="1454059">-</span><span class="num" id="1454060">1</span><span class="op" id="1454061">)</span>&nbsp;<span class="op" id="1454063">==</span>&nbsp;<span class="num" id="1454066">0</span>&nbsp;<span class="op" id="1454068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454073">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454116">runtime_Semrelease</span><span class="op" id="1454134">(</span><span class="op" id="1454135">&amp;</span><span class="ident" id="1454136">rw</span><span class="op" id="1454138">.</span><span class="ident" id="1454139">writerSem</span><span class="op" id="1454148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454155">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454158">if</span>&nbsp;<span class="ident" id="1454161">raceenabled</span>&nbsp;<span class="op" id="1454173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454177">raceEnable</span><span class="op" id="1454187">(</span><span class="op" id="1454188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454191">}</span><br>
<span class="lineno"></span><span class="op" id="1454193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1454196">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1454226">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1454283">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1454327">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1454384">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1454443">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1454456">func</span>&nbsp;<span class="op" id="1454461">(</span><span class="ident" id="1454462">rw</span>&nbsp;<span class="op" id="1454465">*</span><span class="ident" id="1454466">RWMutex</span><span class="op" id="1454473">)</span>&nbsp;<span class="ident" id="1454475">Lock</span><span class="op" id="1454479">(</span><span class="op" id="1454480">)</span>&nbsp;<span class="op" id="1454482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454485">if</span>&nbsp;<span class="ident" id="1454488">raceenabled</span>&nbsp;<span class="op" id="1454500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454504">_</span>&nbsp;<span class="op" id="1454506">=</span>&nbsp;<span class="ident" id="1454508">rw</span><span class="op" id="1454510">.</span><span class="ident" id="1454511">w</span><span class="op" id="1454512">.</span><span class="ident" id="1454513">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454521">raceDisable</span><span class="op" id="1454532">(</span><span class="op" id="1454533">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454539">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454590">rw</span><span class="op" id="1454592">.</span><span class="ident" id="1454593">w</span><span class="op" id="1454594">.</span><span class="ident" id="1454595">Lock</span><span class="op" id="1454599">(</span><span class="op" id="1454600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454603">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454654">r</span>&nbsp;<span class="op" id="1454656">:=</span>&nbsp;<span class="ident" id="1454659">atomic</span><span class="op" id="1454665">.</span><span class="ident" id="1454666">AddInt32</span><span class="op" id="1454674">(</span><span class="op" id="1454675">&amp;</span><span class="ident" id="1454676">rw</span><span class="op" id="1454678">.</span><span class="ident" id="1454679">readerCount</span><span class="op" id="1454690">,</span>&nbsp;<span class="op" id="1454692">-</span><span class="ident" id="1454693">rwmutexMaxReaders</span><span class="op" id="1454710">)</span>&nbsp;<span class="op" id="1454712">+</span>&nbsp;<span class="ident" id="1454714">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454733">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454762">if</span>&nbsp;<span class="ident" id="1454765">r</span>&nbsp;<span class="op" id="1454767">!=</span>&nbsp;<span class="num" id="1454770">0</span>&nbsp;<span class="op" id="1454772">&amp;&amp;</span>&nbsp;<span class="ident" id="1454775">atomic</span><span class="op" id="1454781">.</span><span class="ident" id="1454782">AddInt32</span><span class="op" id="1454790">(</span><span class="op" id="1454791">&amp;</span><span class="ident" id="1454792">rw</span><span class="op" id="1454794">.</span><span class="ident" id="1454795">readerWait</span><span class="op" id="1454805">,</span>&nbsp;<span class="ident" id="1454807">r</span><span class="op" id="1454808">)</span>&nbsp;<span class="op" id="1454810">!=</span>&nbsp;<span class="num" id="1454813">0</span>&nbsp;<span class="op" id="1454815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454819">runtime_Semacquire</span><span class="op" id="1454837">(</span><span class="op" id="1454838">&amp;</span><span class="ident" id="1454839">rw</span><span class="op" id="1454841">.</span><span class="ident" id="1454842">writerSem</span><span class="op" id="1454851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454857">if</span>&nbsp;<span class="ident" id="1454860">raceenabled</span>&nbsp;<span class="op" id="1454872">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454876">raceEnable</span><span class="op" id="1454886">(</span><span class="op" id="1454887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454891">raceAcquire</span><span class="op" id="1454902">(</span><span class="ident" id="1454903">unsafe</span><span class="op" id="1454909">.</span><span class="ident" id="1454910">Pointer</span><span class="op" id="1454917">(</span><span class="op" id="1454918">&amp;</span><span class="ident" id="1454919">rw</span><span class="op" id="1454921">.</span><span class="ident" id="1454922">readerSem</span><span class="op" id="1454931">)</span><span class="op" id="1454932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454936">raceAcquire</span><span class="op" id="1454947">(</span><span class="ident" id="1454948">unsafe</span><span class="op" id="1454954">.</span><span class="ident" id="1454955">Pointer</span><span class="op" id="1454962">(</span><span class="op" id="1454963">&amp;</span><span class="ident" id="1454964">rw</span><span class="op" id="1454966">.</span><span class="ident" id="1454967">writerSem</span><span class="op" id="1454976">)</span><span class="op" id="1454977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454980">}</span><br>
<span class="lineno"></span><span class="op" id="1454982">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1454985">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1455052">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1455098">//</span><br>
<span class="lineno"></span><span class="comment" id="1455101">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1455174">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1455240">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1455297">func</span>&nbsp;<span class="op" id="1455302">(</span><span class="ident" id="1455303">rw</span>&nbsp;<span class="op" id="1455306">*</span><span class="ident" id="1455307">RWMutex</span><span class="op" id="1455314">)</span>&nbsp;<span class="ident" id="1455316">Unlock</span><span class="op" id="1455322">(</span><span class="op" id="1455323">)</span>&nbsp;<span class="op" id="1455325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455328">if</span>&nbsp;<span class="ident" id="1455331">raceenabled</span>&nbsp;<span class="op" id="1455343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455347">_</span>&nbsp;<span class="op" id="1455349">=</span>&nbsp;<span class="ident" id="1455351">rw</span><span class="op" id="1455353">.</span><span class="ident" id="1455354">w</span><span class="op" id="1455355">.</span><span class="ident" id="1455356">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455364">raceRelease</span><span class="op" id="1455375">(</span><span class="ident" id="1455376">unsafe</span><span class="op" id="1455382">.</span><span class="ident" id="1455383">Pointer</span><span class="op" id="1455390">(</span><span class="op" id="1455391">&amp;</span><span class="ident" id="1455392">rw</span><span class="op" id="1455394">.</span><span class="ident" id="1455395">readerSem</span><span class="op" id="1455404">)</span><span class="op" id="1455405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455409">raceRelease</span><span class="op" id="1455420">(</span><span class="ident" id="1455421">unsafe</span><span class="op" id="1455427">.</span><span class="ident" id="1455428">Pointer</span><span class="op" id="1455435">(</span><span class="op" id="1455436">&amp;</span><span class="ident" id="1455437">rw</span><span class="op" id="1455439">.</span><span class="ident" id="1455440">writerSem</span><span class="op" id="1455449">)</span><span class="op" id="1455450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455454">raceDisable</span><span class="op" id="1455465">(</span><span class="op" id="1455466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1455473">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455524">r</span>&nbsp;<span class="op" id="1455526">:=</span>&nbsp;<span class="ident" id="1455529">atomic</span><span class="op" id="1455535">.</span><span class="ident" id="1455536">AddInt32</span><span class="op" id="1455544">(</span><span class="op" id="1455545">&amp;</span><span class="ident" id="1455546">rw</span><span class="op" id="1455548">.</span><span class="ident" id="1455549">readerCount</span><span class="op" id="1455560">,</span>&nbsp;<span class="ident" id="1455562">rwmutexMaxReaders</span><span class="op" id="1455579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455582">if</span>&nbsp;<span class="ident" id="1455585">r</span>&nbsp;<span class="op" id="1455587">&gt;=</span>&nbsp;<span class="ident" id="1455590">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1455608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455612">raceEnable</span><span class="op" id="1455622">(</span><span class="op" id="1455623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1455627">panic</span><span class="op" id="1455632">(</span><span class="string" id="1455633">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1455667">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1455673">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455710">for</span>&nbsp;<span class="ident" id="1455714">i</span>&nbsp;<span class="op" id="1455716">:=</span>&nbsp;<span class="num" id="1455719">0</span><span class="op" id="1455720">;</span>&nbsp;<span class="ident" id="1455722">i</span>&nbsp;<span class="op" id="1455724">&lt;</span>&nbsp;<span class="builtintype" id="1455726">int</span><span class="op" id="1455729">(</span><span class="ident" id="1455730">r</span><span class="op" id="1455731">)</span><span class="op" id="1455732">;</span>&nbsp;<span class="ident" id="1455734">i</span><span class="op" id="1455735">++</span>&nbsp;<span class="op" id="1455738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455742">runtime_Semrelease</span><span class="op" id="1455760">(</span><span class="op" id="1455761">&amp;</span><span class="ident" id="1455762">rw</span><span class="op" id="1455764">.</span><span class="ident" id="1455765">readerSem</span><span class="op" id="1455774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455777">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1455780">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455816">rw</span><span class="op" id="1455818">.</span><span class="ident" id="1455819">w</span><span class="op" id="1455820">.</span><span class="ident" id="1455821">Unlock</span><span class="op" id="1455827">(</span><span class="op" id="1455828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455831">if</span>&nbsp;<span class="ident" id="1455834">raceenabled</span>&nbsp;<span class="op" id="1455846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455850">raceEnable</span><span class="op" id="1455860">(</span><span class="op" id="1455861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455864">}</span><br>
<span class="lineno">125</span><span class="op" id="1455866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455869">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1455923">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1455990">func</span>&nbsp;<span class="op" id="1455995">(</span><span class="ident" id="1455996">rw</span>&nbsp;<span class="op" id="1455999">*</span><span class="ident" id="1456000">RWMutex</span><span class="op" id="1456007">)</span>&nbsp;<span class="ident" id="1456009">RLocker</span><span class="op" id="1456016">(</span><span class="op" id="1456017">)</span>&nbsp;<span class="ident" id="1456019">Locker</span>&nbsp;<span class="op" id="1456026">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456029">return</span>&nbsp;<span class="op" id="1456036">(</span><span class="op" id="1456037">*</span><span class="ident" id="1456038">rlocker</span><span class="op" id="1456045">)</span><span class="op" id="1456046">(</span><span class="ident" id="1456047">rw</span><span class="op" id="1456049">)</span><br>
<span class="lineno"></span><span class="op" id="1456051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1456054">type</span>&nbsp;<span class="ident" id="1456059">rlocker</span>&nbsp;<span class="ident" id="1456067">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1456076">func</span>&nbsp;<span class="op" id="1456081">(</span><span class="ident" id="1456082">r</span>&nbsp;<span class="op" id="1456084">*</span><span class="ident" id="1456085">rlocker</span><span class="op" id="1456092">)</span>&nbsp;<span class="ident" id="1456094">Lock</span><span class="op" id="1456098">(</span><span class="op" id="1456099">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1456103">{</span>&nbsp;<span class="op" id="1456105">(</span><span class="op" id="1456106">*</span><span class="ident" id="1456107">RWMutex</span><span class="op" id="1456114">)</span><span class="op" id="1456115">(</span><span class="ident" id="1456116">r</span><span class="op" id="1456117">)</span><span class="op" id="1456118">.</span><span class="ident" id="1456119">RLock</span><span class="op" id="1456124">(</span><span class="op" id="1456125">)</span>&nbsp;<span class="op" id="1456127">}</span><br>
<span class="lineno"></span><span class="keyword" id="1456129">func</span>&nbsp;<span class="op" id="1456134">(</span><span class="ident" id="1456135">r</span>&nbsp;<span class="op" id="1456137">*</span><span class="ident" id="1456138">rlocker</span><span class="op" id="1456145">)</span>&nbsp;<span class="ident" id="1456147">Unlock</span><span class="op" id="1456153">(</span><span class="op" id="1456154">)</span>&nbsp;<span class="op" id="1456156">{</span>&nbsp;<span class="op" id="1456158">(</span><span class="op" id="1456159">*</span><span class="ident" id="1456160">RWMutex</span><span class="op" id="1456167">)</span><span class="op" id="1456168">(</span><span class="ident" id="1456169">r</span><span class="op" id="1456170">)</span><span class="op" id="1456171">.</span><span class="ident" id="1456172">RUnlock</span><span class="op" id="1456179">(</span><span class="op" id="1456180">)</span>&nbsp;<span class="op" id="1456182">}</span>
</div>
</body>
</html>
