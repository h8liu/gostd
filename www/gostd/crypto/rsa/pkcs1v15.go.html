<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html" class="current">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4149766">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4149821">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4149875">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4149926">package</span>&nbsp;<span class="ident" id="4149934">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4149939">import</span>&nbsp;<span class="op" id="4149946">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4149949">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4149959">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4149976">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4149986">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4149992">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4150003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4150006">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4150084">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4150180">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4150267">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4150346">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4150394">func</span>&nbsp;<span class="ident" id="4150399">EncryptPKCS1v15</span><span class="op" id="4150414">(</span><span class="ident" id="4150415">rand</span>&nbsp;<span class="ident" id="4150420">io</span><span class="op" id="4150422">.</span><span class="ident" id="4150423">Reader</span><span class="op" id="4150429">,</span>&nbsp;<span class="ident" id="4150431">pub</span>&nbsp;<span class="op" id="4150435">*</span><span class="ident" id="4150436">PublicKey</span><span class="op" id="4150445">,</span>&nbsp;<span class="ident" id="4150447">msg</span>&nbsp;<span class="op" id="4150451">[</span><span class="op" id="4150452">]</span><span class="builtintype" id="4150453">byte</span><span class="op" id="4150457">)</span>&nbsp;<span class="op" id="4150459">(</span><span class="ident" id="4150460">out</span>&nbsp;<span class="op" id="4150464">[</span><span class="op" id="4150465">]</span><span class="builtintype" id="4150466">byte</span><span class="op" id="4150470">,</span>&nbsp;<span class="ident" id="4150472">err</span>&nbsp;<span class="builtintype" id="4150476">error</span><span class="op" id="4150481">)</span>&nbsp;<span class="op" id="4150483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150486">if</span>&nbsp;<span class="ident" id="4150489">err</span>&nbsp;<span class="op" id="4150493">:=</span>&nbsp;<span class="ident" id="4150496">checkPub</span><span class="op" id="4150504">(</span><span class="ident" id="4150505">pub</span><span class="op" id="4150508">)</span><span class="op" id="4150509">;</span>&nbsp;<span class="ident" id="4150511">err</span>&nbsp;<span class="op" id="4150515">!=</span>&nbsp;<span class="ident" id="4150518">nil</span>&nbsp;<span class="op" id="4150522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150526">return</span>&nbsp;<span class="ident" id="4150533">nil</span><span class="op" id="4150536">,</span>&nbsp;<span class="ident" id="4150538">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150543">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150546">k</span>&nbsp;<span class="op" id="4150548">:=</span>&nbsp;<span class="op" id="4150551">(</span><span class="ident" id="4150552">pub</span><span class="op" id="4150555">.</span><span class="ident" id="4150556">N</span><span class="op" id="4150557">.</span><span class="ident" id="4150558">BitLen</span><span class="op" id="4150564">(</span><span class="op" id="4150565">)</span>&nbsp;<span class="op" id="4150567">+</span>&nbsp;<span class="num" id="4150569">7</span><span class="op" id="4150570">)</span>&nbsp;<span class="op" id="4150572">/</span>&nbsp;<span class="num" id="4150574">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150577">if</span>&nbsp;<span class="builtinfunc" id="4150580">len</span><span class="op" id="4150583">(</span><span class="ident" id="4150584">msg</span><span class="op" id="4150587">)</span>&nbsp;<span class="op" id="4150589">&gt;</span>&nbsp;<span class="ident" id="4150591">k</span><span class="op" id="4150592">-</span><span class="num" id="4150593">11</span>&nbsp;<span class="op" id="4150596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150600">err</span>&nbsp;<span class="op" id="4150604">=</span>&nbsp;<span class="ident" id="4150606">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150626">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150634">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4150638">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150679">em</span>&nbsp;<span class="op" id="4150682">:=</span>&nbsp;<span class="builtinfunc" id="4150685">make</span><span class="op" id="4150689">(</span><span class="op" id="4150690">[</span><span class="op" id="4150691">]</span><span class="builtintype" id="4150692">byte</span><span class="op" id="4150696">,</span>&nbsp;<span class="ident" id="4150698">k</span><span class="op" id="4150699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150702">em</span><span class="op" id="4150704">[</span><span class="num" id="4150705">1</span><span class="op" id="4150706">]</span>&nbsp;<span class="op" id="4150708">=</span>&nbsp;<span class="num" id="4150710">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150713">ps</span><span class="op" id="4150715">,</span>&nbsp;<span class="ident" id="4150717">mm</span>&nbsp;<span class="op" id="4150720">:=</span>&nbsp;<span class="ident" id="4150723">em</span><span class="op" id="4150725">[</span><span class="num" id="4150726">2</span><span class="op" id="4150727">:</span><span class="builtinfunc" id="4150728">len</span><span class="op" id="4150731">(</span><span class="ident" id="4150732">em</span><span class="op" id="4150734">)</span><span class="op" id="4150735">-</span><span class="builtinfunc" id="4150736">len</span><span class="op" id="4150739">(</span><span class="ident" id="4150740">msg</span><span class="op" id="4150743">)</span><span class="op" id="4150744">-</span><span class="num" id="4150745">1</span><span class="op" id="4150746">]</span><span class="op" id="4150747">,</span>&nbsp;<span class="ident" id="4150749">em</span><span class="op" id="4150751">[</span><span class="builtinfunc" id="4150752">len</span><span class="op" id="4150755">(</span><span class="ident" id="4150756">em</span><span class="op" id="4150758">)</span><span class="op" id="4150759">-</span><span class="builtinfunc" id="4150760">len</span><span class="op" id="4150763">(</span><span class="ident" id="4150764">msg</span><span class="op" id="4150767">)</span><span class="op" id="4150768">:</span><span class="op" id="4150769">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150772">err</span>&nbsp;<span class="op" id="4150776">=</span>&nbsp;<span class="ident" id="4150778">nonZeroRandomBytes</span><span class="op" id="4150796">(</span><span class="ident" id="4150797">ps</span><span class="op" id="4150799">,</span>&nbsp;<span class="ident" id="4150801">rand</span><span class="op" id="4150805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150808">if</span>&nbsp;<span class="ident" id="4150811">err</span>&nbsp;<span class="op" id="4150815">!=</span>&nbsp;<span class="ident" id="4150818">nil</span>&nbsp;<span class="op" id="4150822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150826">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150837">em</span><span class="op" id="4150839">[</span><span class="builtinfunc" id="4150840">len</span><span class="op" id="4150843">(</span><span class="ident" id="4150844">em</span><span class="op" id="4150846">)</span><span class="op" id="4150847">-</span><span class="builtinfunc" id="4150848">len</span><span class="op" id="4150851">(</span><span class="ident" id="4150852">msg</span><span class="op" id="4150855">)</span><span class="op" id="4150856">-</span><span class="num" id="4150857">1</span><span class="op" id="4150858">]</span>&nbsp;<span class="op" id="4150860">=</span>&nbsp;<span class="num" id="4150862">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4150865">copy</span><span class="op" id="4150869">(</span><span class="ident" id="4150870">mm</span><span class="op" id="4150872">,</span>&nbsp;<span class="ident" id="4150874">msg</span><span class="op" id="4150877">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150881">m</span>&nbsp;<span class="op" id="4150883">:=</span>&nbsp;<span class="builtinfunc" id="4150886">new</span><span class="op" id="4150889">(</span><span class="ident" id="4150890">big</span><span class="op" id="4150893">.</span><span class="ident" id="4150894">Int</span><span class="op" id="4150897">)</span><span class="op" id="4150898">.</span><span class="ident" id="4150899">SetBytes</span><span class="op" id="4150907">(</span><span class="ident" id="4150908">em</span><span class="op" id="4150910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150913">c</span>&nbsp;<span class="op" id="4150915">:=</span>&nbsp;<span class="ident" id="4150918">encrypt</span><span class="op" id="4150925">(</span><span class="builtinfunc" id="4150926">new</span><span class="op" id="4150929">(</span><span class="ident" id="4150930">big</span><span class="op" id="4150933">.</span><span class="ident" id="4150934">Int</span><span class="op" id="4150937">)</span><span class="op" id="4150938">,</span>&nbsp;<span class="ident" id="4150940">pub</span><span class="op" id="4150943">,</span>&nbsp;<span class="ident" id="4150945">m</span><span class="op" id="4150946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150950">copyWithLeftPad</span><span class="op" id="4150965">(</span><span class="ident" id="4150966">em</span><span class="op" id="4150968">,</span>&nbsp;<span class="ident" id="4150970">c</span><span class="op" id="4150971">.</span><span class="ident" id="4150972">Bytes</span><span class="op" id="4150977">(</span><span class="op" id="4150978">)</span><span class="op" id="4150979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150982">out</span>&nbsp;<span class="op" id="4150986">=</span>&nbsp;<span class="ident" id="4150988">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150992">return</span><br>
<span class="lineno"></span><span class="op" id="4150999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4151002">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4151093">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4151171">func</span>&nbsp;<span class="ident" id="4151176">DecryptPKCS1v15</span><span class="op" id="4151191">(</span><span class="ident" id="4151192">rand</span>&nbsp;<span class="ident" id="4151197">io</span><span class="op" id="4151199">.</span><span class="ident" id="4151200">Reader</span><span class="op" id="4151206">,</span>&nbsp;<span class="ident" id="4151208">priv</span>&nbsp;<span class="op" id="4151213">*</span><span class="ident" id="4151214">PrivateKey</span><span class="op" id="4151224">,</span>&nbsp;<span class="ident" id="4151226">ciphertext</span>&nbsp;<span class="op" id="4151237">[</span><span class="op" id="4151238">]</span><span class="builtintype" id="4151239">byte</span><span class="op" id="4151243">)</span>&nbsp;<span class="op" id="4151245">(</span><span class="ident" id="4151246">out</span>&nbsp;<span class="op" id="4151250">[</span><span class="op" id="4151251">]</span><span class="builtintype" id="4151252">byte</span><span class="op" id="4151256">,</span>&nbsp;<span class="ident" id="4151258">err</span>&nbsp;<span class="builtintype" id="4151262">error</span><span class="op" id="4151267">)</span>&nbsp;<span class="op" id="4151269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151272">if</span>&nbsp;<span class="ident" id="4151275">err</span>&nbsp;<span class="op" id="4151279">:=</span>&nbsp;<span class="ident" id="4151282">checkPub</span><span class="op" id="4151290">(</span><span class="op" id="4151291">&amp;</span><span class="ident" id="4151292">priv</span><span class="op" id="4151296">.</span><span class="ident" id="4151297">PublicKey</span><span class="op" id="4151306">)</span><span class="op" id="4151307">;</span>&nbsp;<span class="ident" id="4151309">err</span>&nbsp;<span class="op" id="4151313">!=</span>&nbsp;<span class="ident" id="4151316">nil</span>&nbsp;<span class="op" id="4151320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151324">return</span>&nbsp;<span class="ident" id="4151331">nil</span><span class="op" id="4151334">,</span>&nbsp;<span class="ident" id="4151336">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151344">valid</span><span class="op" id="4151349">,</span>&nbsp;<span class="ident" id="4151351">out</span><span class="op" id="4151354">,</span>&nbsp;<span class="ident" id="4151356">index</span><span class="op" id="4151361">,</span>&nbsp;<span class="ident" id="4151363">err</span>&nbsp;<span class="op" id="4151367">:=</span>&nbsp;<span class="ident" id="4151370">decryptPKCS1v15</span><span class="op" id="4151385">(</span><span class="ident" id="4151386">rand</span><span class="op" id="4151390">,</span>&nbsp;<span class="ident" id="4151392">priv</span><span class="op" id="4151396">,</span>&nbsp;<span class="ident" id="4151398">ciphertext</span><span class="op" id="4151408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151411">if</span>&nbsp;<span class="ident" id="4151414">err</span>&nbsp;<span class="op" id="4151418">!=</span>&nbsp;<span class="ident" id="4151421">nil</span>&nbsp;<span class="op" id="4151425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151429">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151437">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151440">if</span>&nbsp;<span class="ident" id="4151443">valid</span>&nbsp;<span class="op" id="4151449">==</span>&nbsp;<span class="num" id="4151452">0</span>&nbsp;<span class="op" id="4151454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151458">return</span>&nbsp;<span class="ident" id="4151465">nil</span><span class="op" id="4151468">,</span>&nbsp;<span class="ident" id="4151470">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151488">out</span>&nbsp;<span class="op" id="4151492">=</span>&nbsp;<span class="ident" id="4151494">out</span><span class="op" id="4151497">[</span><span class="ident" id="4151498">index</span><span class="op" id="4151503">:</span><span class="op" id="4151504">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151507">return</span><br>
<span class="lineno">65</span><span class="op" id="4151514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4151517">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4151620">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4151698">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4151769">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4151842">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4151922">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4152001">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4152074">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4152152">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4152231">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4152255">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4152325">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4152405">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4152422">func</span>&nbsp;<span class="ident" id="4152427">DecryptPKCS1v15SessionKey</span><span class="op" id="4152452">(</span><span class="ident" id="4152453">rand</span>&nbsp;<span class="ident" id="4152458">io</span><span class="op" id="4152460">.</span><span class="ident" id="4152461">Reader</span><span class="op" id="4152467">,</span>&nbsp;<span class="ident" id="4152469">priv</span>&nbsp;<span class="op" id="4152474">*</span><span class="ident" id="4152475">PrivateKey</span><span class="op" id="4152485">,</span>&nbsp;<span class="ident" id="4152487">ciphertext</span>&nbsp;<span class="op" id="4152498">[</span><span class="op" id="4152499">]</span><span class="builtintype" id="4152500">byte</span><span class="op" id="4152504">,</span>&nbsp;<span class="ident" id="4152506">key</span>&nbsp;<span class="op" id="4152510">[</span><span class="op" id="4152511">]</span><span class="builtintype" id="4152512">byte</span><span class="op" id="4152516">)</span>&nbsp;<span class="op" id="4152518">(</span><span class="ident" id="4152519">err</span>&nbsp;<span class="builtintype" id="4152523">error</span><span class="op" id="4152528">)</span>&nbsp;<span class="op" id="4152530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152533">if</span>&nbsp;<span class="ident" id="4152536">err</span>&nbsp;<span class="op" id="4152540">:=</span>&nbsp;<span class="ident" id="4152543">checkPub</span><span class="op" id="4152551">(</span><span class="op" id="4152552">&amp;</span><span class="ident" id="4152553">priv</span><span class="op" id="4152557">.</span><span class="ident" id="4152558">PublicKey</span><span class="op" id="4152567">)</span><span class="op" id="4152568">;</span>&nbsp;<span class="ident" id="4152570">err</span>&nbsp;<span class="op" id="4152574">!=</span>&nbsp;<span class="ident" id="4152577">nil</span>&nbsp;<span class="op" id="4152581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152585">return</span>&nbsp;<span class="ident" id="4152592">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4152597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152600">k</span>&nbsp;<span class="op" id="4152602">:=</span>&nbsp;<span class="op" id="4152605">(</span><span class="ident" id="4152606">priv</span><span class="op" id="4152610">.</span><span class="ident" id="4152611">N</span><span class="op" id="4152612">.</span><span class="ident" id="4152613">BitLen</span><span class="op" id="4152619">(</span><span class="op" id="4152620">)</span>&nbsp;<span class="op" id="4152622">+</span>&nbsp;<span class="num" id="4152624">7</span><span class="op" id="4152625">)</span>&nbsp;<span class="op" id="4152627">/</span>&nbsp;<span class="num" id="4152629">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152632">if</span>&nbsp;<span class="ident" id="4152635">k</span><span class="op" id="4152636">-</span><span class="op" id="4152637">(</span><span class="builtinfunc" id="4152638">len</span><span class="op" id="4152641">(</span><span class="ident" id="4152642">key</span><span class="op" id="4152645">)</span><span class="op" id="4152646">+</span><span class="num" id="4152647">3</span><span class="op" id="4152648">+</span><span class="num" id="4152649">8</span><span class="op" id="4152650">)</span>&nbsp;<span class="op" id="4152652">&lt;</span>&nbsp;<span class="num" id="4152654">0</span>&nbsp;<span class="op" id="4152656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152660">return</span>&nbsp;<span class="ident" id="4152667">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4152682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152686">valid</span><span class="op" id="4152691">,</span>&nbsp;<span class="ident" id="4152693">em</span><span class="op" id="4152695">,</span>&nbsp;<span class="ident" id="4152697">index</span><span class="op" id="4152702">,</span>&nbsp;<span class="ident" id="4152704">err</span>&nbsp;<span class="op" id="4152708">:=</span>&nbsp;<span class="ident" id="4152711">decryptPKCS1v15</span><span class="op" id="4152726">(</span><span class="ident" id="4152727">rand</span><span class="op" id="4152731">,</span>&nbsp;<span class="ident" id="4152733">priv</span><span class="op" id="4152737">,</span>&nbsp;<span class="ident" id="4152739">ciphertext</span><span class="op" id="4152749">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152752">if</span>&nbsp;<span class="ident" id="4152755">err</span>&nbsp;<span class="op" id="4152759">!=</span>&nbsp;<span class="ident" id="4152762">nil</span>&nbsp;<span class="op" id="4152766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4152778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152782">if</span>&nbsp;<span class="builtinfunc" id="4152785">len</span><span class="op" id="4152788">(</span><span class="ident" id="4152789">em</span><span class="op" id="4152791">)</span>&nbsp;<span class="op" id="4152793">!=</span>&nbsp;<span class="ident" id="4152796">k</span>&nbsp;<span class="op" id="4152798">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152802">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152864">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152893">return</span>&nbsp;<span class="ident" id="4152900">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4152915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152919">valid</span>&nbsp;<span class="op" id="4152925">&amp;=</span>&nbsp;<span class="ident" id="4152928">subtle</span><span class="op" id="4152934">.</span><span class="ident" id="4152935">ConstantTimeEq</span><span class="op" id="4152949">(</span><span class="builtintype" id="4152950">int32</span><span class="op" id="4152955">(</span><span class="builtinfunc" id="4152956">len</span><span class="op" id="4152959">(</span><span class="ident" id="4152960">em</span><span class="op" id="4152962">)</span><span class="op" id="4152963">-</span><span class="ident" id="4152964">index</span><span class="op" id="4152969">)</span><span class="op" id="4152970">,</span>&nbsp;<span class="builtintype" id="4152972">int32</span><span class="op" id="4152977">(</span><span class="builtinfunc" id="4152978">len</span><span class="op" id="4152981">(</span><span class="ident" id="4152982">key</span><span class="op" id="4152985">)</span><span class="op" id="4152986">)</span><span class="op" id="4152987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152990">subtle</span><span class="op" id="4152996">.</span><span class="ident" id="4152997">ConstantTimeCopy</span><span class="op" id="4153013">(</span><span class="ident" id="4153014">valid</span><span class="op" id="4153019">,</span>&nbsp;<span class="ident" id="4153021">key</span><span class="op" id="4153024">,</span>&nbsp;<span class="ident" id="4153026">em</span><span class="op" id="4153028">[</span><span class="builtinfunc" id="4153029">len</span><span class="op" id="4153032">(</span><span class="ident" id="4153033">em</span><span class="op" id="4153035">)</span><span class="op" id="4153036">-</span><span class="builtinfunc" id="4153037">len</span><span class="op" id="4153040">(</span><span class="ident" id="4153041">key</span><span class="op" id="4153044">)</span><span class="op" id="4153045">:</span><span class="op" id="4153046">]</span><span class="op" id="4153047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153050">return</span><br>
<span class="lineno"></span><span class="op" id="4153057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4153060">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4153138">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4153217">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4153289">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4153368">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4153446">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4153516">func</span>&nbsp;<span class="ident" id="4153521">decryptPKCS1v15</span><span class="op" id="4153536">(</span><span class="ident" id="4153537">rand</span>&nbsp;<span class="ident" id="4153542">io</span><span class="op" id="4153544">.</span><span class="ident" id="4153545">Reader</span><span class="op" id="4153551">,</span>&nbsp;<span class="ident" id="4153553">priv</span>&nbsp;<span class="op" id="4153558">*</span><span class="ident" id="4153559">PrivateKey</span><span class="op" id="4153569">,</span>&nbsp;<span class="ident" id="4153571">ciphertext</span>&nbsp;<span class="op" id="4153582">[</span><span class="op" id="4153583">]</span><span class="builtintype" id="4153584">byte</span><span class="op" id="4153588">)</span>&nbsp;<span class="op" id="4153590">(</span><span class="ident" id="4153591">valid</span>&nbsp;<span class="builtintype" id="4153597">int</span><span class="op" id="4153600">,</span>&nbsp;<span class="ident" id="4153602">em</span>&nbsp;<span class="op" id="4153605">[</span><span class="op" id="4153606">]</span><span class="builtintype" id="4153607">byte</span><span class="op" id="4153611">,</span>&nbsp;<span class="ident" id="4153613">index</span>&nbsp;<span class="builtintype" id="4153619">int</span><span class="op" id="4153622">,</span>&nbsp;<span class="ident" id="4153624">err</span>&nbsp;<span class="builtintype" id="4153628">error</span><span class="op" id="4153633">)</span>&nbsp;<span class="op" id="4153635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153638">k</span>&nbsp;<span class="op" id="4153640">:=</span>&nbsp;<span class="op" id="4153643">(</span><span class="ident" id="4153644">priv</span><span class="op" id="4153648">.</span><span class="ident" id="4153649">N</span><span class="op" id="4153650">.</span><span class="ident" id="4153651">BitLen</span><span class="op" id="4153657">(</span><span class="op" id="4153658">)</span>&nbsp;<span class="op" id="4153660">+</span>&nbsp;<span class="num" id="4153662">7</span><span class="op" id="4153663">)</span>&nbsp;<span class="op" id="4153665">/</span>&nbsp;<span class="num" id="4153667">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153670">if</span>&nbsp;<span class="ident" id="4153673">k</span>&nbsp;<span class="op" id="4153675">&lt;</span>&nbsp;<span class="num" id="4153677">11</span>&nbsp;<span class="op" id="4153680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153684">err</span>&nbsp;<span class="op" id="4153688">=</span>&nbsp;<span class="ident" id="4153690">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153706">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153718">c</span>&nbsp;<span class="op" id="4153720">:=</span>&nbsp;<span class="builtinfunc" id="4153723">new</span><span class="op" id="4153726">(</span><span class="ident" id="4153727">big</span><span class="op" id="4153730">.</span><span class="ident" id="4153731">Int</span><span class="op" id="4153734">)</span><span class="op" id="4153735">.</span><span class="ident" id="4153736">SetBytes</span><span class="op" id="4153744">(</span><span class="ident" id="4153745">ciphertext</span><span class="op" id="4153755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153758">m</span><span class="op" id="4153759">,</span>&nbsp;<span class="ident" id="4153761">err</span>&nbsp;<span class="op" id="4153765">:=</span>&nbsp;<span class="ident" id="4153768">decrypt</span><span class="op" id="4153775">(</span><span class="ident" id="4153776">rand</span><span class="op" id="4153780">,</span>&nbsp;<span class="ident" id="4153782">priv</span><span class="op" id="4153786">,</span>&nbsp;<span class="ident" id="4153788">c</span><span class="op" id="4153789">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153792">if</span>&nbsp;<span class="ident" id="4153795">err</span>&nbsp;<span class="op" id="4153799">!=</span>&nbsp;<span class="ident" id="4153802">nil</span>&nbsp;<span class="op" id="4153806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153822">em</span>&nbsp;<span class="op" id="4153825">=</span>&nbsp;<span class="ident" id="4153827">leftPad</span><span class="op" id="4153834">(</span><span class="ident" id="4153835">m</span><span class="op" id="4153836">.</span><span class="ident" id="4153837">Bytes</span><span class="op" id="4153842">(</span><span class="op" id="4153843">)</span><span class="op" id="4153844">,</span>&nbsp;<span class="ident" id="4153846">k</span><span class="op" id="4153847">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153850">firstByteIsZero</span>&nbsp;<span class="op" id="4153866">:=</span>&nbsp;<span class="ident" id="4153869">subtle</span><span class="op" id="4153875">.</span><span class="ident" id="4153876">ConstantTimeByteEq</span><span class="op" id="4153894">(</span><span class="ident" id="4153895">em</span><span class="op" id="4153897">[</span><span class="num" id="4153898">0</span><span class="op" id="4153899">]</span><span class="op" id="4153900">,</span>&nbsp;<span class="num" id="4153902">0</span><span class="op" id="4153903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153906">secondByteIsTwo</span>&nbsp;<span class="op" id="4153922">:=</span>&nbsp;<span class="ident" id="4153925">subtle</span><span class="op" id="4153931">.</span><span class="ident" id="4153932">ConstantTimeByteEq</span><span class="op" id="4153950">(</span><span class="ident" id="4153951">em</span><span class="op" id="4153953">[</span><span class="num" id="4153954">1</span><span class="op" id="4153955">]</span><span class="op" id="4153956">,</span>&nbsp;<span class="num" id="4153958">2</span><span class="op" id="4153959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153963">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154034">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154088">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154152">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154200">lookingForIndex</span>&nbsp;<span class="op" id="4154216">:=</span>&nbsp;<span class="num" id="4154219">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154223">for</span>&nbsp;<span class="ident" id="4154227">i</span>&nbsp;<span class="op" id="4154229">:=</span>&nbsp;<span class="num" id="4154232">2</span><span class="op" id="4154233">;</span>&nbsp;<span class="ident" id="4154235">i</span>&nbsp;<span class="op" id="4154237">&lt;</span>&nbsp;<span class="builtinfunc" id="4154239">len</span><span class="op" id="4154242">(</span><span class="ident" id="4154243">em</span><span class="op" id="4154245">)</span><span class="op" id="4154246">;</span>&nbsp;<span class="ident" id="4154248">i</span><span class="op" id="4154249">++</span>&nbsp;<span class="op" id="4154252">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154256">equals0</span>&nbsp;<span class="op" id="4154264">:=</span>&nbsp;<span class="ident" id="4154267">subtle</span><span class="op" id="4154273">.</span><span class="ident" id="4154274">ConstantTimeByteEq</span><span class="op" id="4154292">(</span><span class="ident" id="4154293">em</span><span class="op" id="4154295">[</span><span class="ident" id="4154296">i</span><span class="op" id="4154297">]</span><span class="op" id="4154298">,</span>&nbsp;<span class="num" id="4154300">0</span><span class="op" id="4154301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154305">index</span>&nbsp;<span class="op" id="4154311">=</span>&nbsp;<span class="ident" id="4154313">subtle</span><span class="op" id="4154319">.</span><span class="ident" id="4154320">ConstantTimeSelect</span><span class="op" id="4154338">(</span><span class="ident" id="4154339">lookingForIndex</span><span class="op" id="4154354">&amp;</span><span class="ident" id="4154355">equals0</span><span class="op" id="4154362">,</span>&nbsp;<span class="ident" id="4154364">i</span><span class="op" id="4154365">,</span>&nbsp;<span class="ident" id="4154367">index</span><span class="op" id="4154372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154376">lookingForIndex</span>&nbsp;<span class="op" id="4154392">=</span>&nbsp;<span class="ident" id="4154394">subtle</span><span class="op" id="4154400">.</span><span class="ident" id="4154401">ConstantTimeSelect</span><span class="op" id="4154419">(</span><span class="ident" id="4154420">equals0</span><span class="op" id="4154427">,</span>&nbsp;<span class="num" id="4154429">0</span><span class="op" id="4154430">,</span>&nbsp;<span class="ident" id="4154432">lookingForIndex</span><span class="op" id="4154447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154454">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154522">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154541">validPS</span>&nbsp;<span class="op" id="4154549">:=</span>&nbsp;<span class="ident" id="4154552">subtle</span><span class="op" id="4154558">.</span><span class="ident" id="4154559">ConstantTimeLessOrEq</span><span class="op" id="4154579">(</span><span class="num" id="4154580">2</span><span class="op" id="4154581">+</span><span class="num" id="4154582">8</span><span class="op" id="4154583">,</span>&nbsp;<span class="ident" id="4154585">index</span><span class="op" id="4154590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154594">valid</span>&nbsp;<span class="op" id="4154600">=</span>&nbsp;<span class="ident" id="4154602">firstByteIsZero</span>&nbsp;<span class="op" id="4154618">&amp;</span>&nbsp;<span class="ident" id="4154620">secondByteIsTwo</span>&nbsp;<span class="op" id="4154636">&amp;</span>&nbsp;<span class="op" id="4154638">(</span><span class="op" id="4154639">^</span><span class="ident" id="4154640">lookingForIndex</span>&nbsp;<span class="op" id="4154656">&amp;</span>&nbsp;<span class="num" id="4154658">1</span><span class="op" id="4154659">)</span>&nbsp;<span class="op" id="4154661">&amp;</span>&nbsp;<span class="ident" id="4154663">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154672">index</span>&nbsp;<span class="op" id="4154678">=</span>&nbsp;<span class="ident" id="4154680">subtle</span><span class="op" id="4154686">.</span><span class="ident" id="4154687">ConstantTimeSelect</span><span class="op" id="4154705">(</span><span class="ident" id="4154706">valid</span><span class="op" id="4154711">,</span>&nbsp;<span class="ident" id="4154713">index</span><span class="op" id="4154718">+</span><span class="num" id="4154719">1</span><span class="op" id="4154720">,</span>&nbsp;<span class="num" id="4154722">0</span><span class="op" id="4154723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154726">return</span>&nbsp;<span class="ident" id="4154733">valid</span><span class="op" id="4154738">,</span>&nbsp;<span class="ident" id="4154740">em</span><span class="op" id="4154742">,</span>&nbsp;<span class="ident" id="4154744">index</span><span class="op" id="4154749">,</span>&nbsp;<span class="ident" id="4154751">nil</span><br>
<span class="lineno"></span><span class="op" id="4154755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4154758">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4154831">func</span>&nbsp;<span class="ident" id="4154836">nonZeroRandomBytes</span><span class="op" id="4154854">(</span><span class="ident" id="4154855">s</span>&nbsp;<span class="op" id="4154857">[</span><span class="op" id="4154858">]</span><span class="builtintype" id="4154859">byte</span><span class="op" id="4154863">,</span>&nbsp;<span class="ident" id="4154865">rand</span>&nbsp;<span class="ident" id="4154870">io</span><span class="op" id="4154872">.</span><span class="ident" id="4154873">Reader</span><span class="op" id="4154879">)</span>&nbsp;<span class="op" id="4154881">(</span><span class="ident" id="4154882">err</span>&nbsp;<span class="builtintype" id="4154886">error</span><span class="op" id="4154891">)</span>&nbsp;<span class="op" id="4154893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154896">_</span><span class="op" id="4154897">,</span>&nbsp;<span class="ident" id="4154899">err</span>&nbsp;<span class="op" id="4154903">=</span>&nbsp;<span class="ident" id="4154905">io</span><span class="op" id="4154907">.</span><span class="ident" id="4154908">ReadFull</span><span class="op" id="4154916">(</span><span class="ident" id="4154917">rand</span><span class="op" id="4154921">,</span>&nbsp;<span class="ident" id="4154923">s</span><span class="op" id="4154924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154927">if</span>&nbsp;<span class="ident" id="4154930">err</span>&nbsp;<span class="op" id="4154934">!=</span>&nbsp;<span class="ident" id="4154937">nil</span>&nbsp;<span class="op" id="4154941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154945">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154953">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154957">for</span>&nbsp;<span class="ident" id="4154961">i</span>&nbsp;<span class="op" id="4154963">:=</span>&nbsp;<span class="num" id="4154966">0</span><span class="op" id="4154967">;</span>&nbsp;<span class="ident" id="4154969">i</span>&nbsp;<span class="op" id="4154971">&lt;</span>&nbsp;<span class="builtinfunc" id="4154973">len</span><span class="op" id="4154976">(</span><span class="ident" id="4154977">s</span><span class="op" id="4154978">)</span><span class="op" id="4154979">;</span>&nbsp;<span class="ident" id="4154981">i</span><span class="op" id="4154982">++</span>&nbsp;<span class="op" id="4154985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154989">for</span>&nbsp;<span class="ident" id="4154993">s</span><span class="op" id="4154994">[</span><span class="ident" id="4154995">i</span><span class="op" id="4154996">]</span>&nbsp;<span class="op" id="4154998">==</span>&nbsp;<span class="num" id="4155001">0</span>&nbsp;<span class="op" id="4155003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155008">_</span><span class="op" id="4155009">,</span>&nbsp;<span class="ident" id="4155011">err</span>&nbsp;<span class="op" id="4155015">=</span>&nbsp;<span class="ident" id="4155017">io</span><span class="op" id="4155019">.</span><span class="ident" id="4155020">ReadFull</span><span class="op" id="4155028">(</span><span class="ident" id="4155029">rand</span><span class="op" id="4155033">,</span>&nbsp;<span class="ident" id="4155035">s</span><span class="op" id="4155036">[</span><span class="ident" id="4155037">i</span><span class="op" id="4155038">:</span><span class="ident" id="4155039">i</span><span class="op" id="4155040">+</span><span class="num" id="4155041">1</span><span class="op" id="4155042">]</span><span class="op" id="4155043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4155048">if</span>&nbsp;<span class="ident" id="4155051">err</span>&nbsp;<span class="op" id="4155055">!=</span>&nbsp;<span class="ident" id="4155058">nil</span>&nbsp;<span class="op" id="4155062">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4155068">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155083">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155138">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155168">s</span><span class="op" id="4155169">[</span><span class="ident" id="4155170">i</span><span class="op" id="4155171">]</span>&nbsp;<span class="op" id="4155173">^=</span>&nbsp;<span class="num" id="4155176">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4155190">return</span><br>
<span class="lineno"></span><span class="op" id="4155197">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4155200">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4155234">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4155265">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4155309">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4155336">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4155343">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4155413">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4155491">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4155521">var</span>&nbsp;<span class="ident" id="4155525">hashPrefixes</span>&nbsp;<span class="op" id="4155538">=</span>&nbsp;<span class="keyword" id="4155540">map</span><span class="op" id="4155543">[</span><span class="ident" id="4155544">crypto</span><span class="op" id="4155550">.</span><span class="ident" id="4155551">Hash</span><span class="op" id="4155555">]</span><span class="op" id="4155556">[</span><span class="op" id="4155557">]</span><span class="builtintype" id="4155558">byte</span><span class="op" id="4155562">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155565">crypto</span><span class="op" id="4155571">.</span><span class="ident" id="4155572">MD5</span><span class="op" id="4155575">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155583">{</span><span class="num" id="4155584">0x30</span><span class="op" id="4155588">,</span>&nbsp;<span class="num" id="4155590">0x20</span><span class="op" id="4155594">,</span>&nbsp;<span class="num" id="4155596">0x30</span><span class="op" id="4155600">,</span>&nbsp;<span class="num" id="4155602">0x0c</span><span class="op" id="4155606">,</span>&nbsp;<span class="num" id="4155608">0x06</span><span class="op" id="4155612">,</span>&nbsp;<span class="num" id="4155614">0x08</span><span class="op" id="4155618">,</span>&nbsp;<span class="num" id="4155620">0x2a</span><span class="op" id="4155624">,</span>&nbsp;<span class="num" id="4155626">0x86</span><span class="op" id="4155630">,</span>&nbsp;<span class="num" id="4155632">0x48</span><span class="op" id="4155636">,</span>&nbsp;<span class="num" id="4155638">0x86</span><span class="op" id="4155642">,</span>&nbsp;<span class="num" id="4155644">0xf7</span><span class="op" id="4155648">,</span>&nbsp;<span class="num" id="4155650">0x0d</span><span class="op" id="4155654">,</span>&nbsp;<span class="num" id="4155656">0x02</span><span class="op" id="4155660">,</span>&nbsp;<span class="num" id="4155662">0x05</span><span class="op" id="4155666">,</span>&nbsp;<span class="num" id="4155668">0x05</span><span class="op" id="4155672">,</span>&nbsp;<span class="num" id="4155674">0x00</span><span class="op" id="4155678">,</span>&nbsp;<span class="num" id="4155680">0x04</span><span class="op" id="4155684">,</span>&nbsp;<span class="num" id="4155686">0x10</span><span class="op" id="4155690">}</span><span class="op" id="4155691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155694">crypto</span><span class="op" id="4155700">.</span><span class="ident" id="4155701">SHA1</span><span class="op" id="4155705">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155712">{</span><span class="num" id="4155713">0x30</span><span class="op" id="4155717">,</span>&nbsp;<span class="num" id="4155719">0x21</span><span class="op" id="4155723">,</span>&nbsp;<span class="num" id="4155725">0x30</span><span class="op" id="4155729">,</span>&nbsp;<span class="num" id="4155731">0x09</span><span class="op" id="4155735">,</span>&nbsp;<span class="num" id="4155737">0x06</span><span class="op" id="4155741">,</span>&nbsp;<span class="num" id="4155743">0x05</span><span class="op" id="4155747">,</span>&nbsp;<span class="num" id="4155749">0x2b</span><span class="op" id="4155753">,</span>&nbsp;<span class="num" id="4155755">0x0e</span><span class="op" id="4155759">,</span>&nbsp;<span class="num" id="4155761">0x03</span><span class="op" id="4155765">,</span>&nbsp;<span class="num" id="4155767">0x02</span><span class="op" id="4155771">,</span>&nbsp;<span class="num" id="4155773">0x1a</span><span class="op" id="4155777">,</span>&nbsp;<span class="num" id="4155779">0x05</span><span class="op" id="4155783">,</span>&nbsp;<span class="num" id="4155785">0x00</span><span class="op" id="4155789">,</span>&nbsp;<span class="num" id="4155791">0x04</span><span class="op" id="4155795">,</span>&nbsp;<span class="num" id="4155797">0x14</span><span class="op" id="4155801">}</span><span class="op" id="4155802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155805">crypto</span><span class="op" id="4155811">.</span><span class="ident" id="4155812">SHA224</span><span class="op" id="4155818">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155823">{</span><span class="num" id="4155824">0x30</span><span class="op" id="4155828">,</span>&nbsp;<span class="num" id="4155830">0x2d</span><span class="op" id="4155834">,</span>&nbsp;<span class="num" id="4155836">0x30</span><span class="op" id="4155840">,</span>&nbsp;<span class="num" id="4155842">0x0d</span><span class="op" id="4155846">,</span>&nbsp;<span class="num" id="4155848">0x06</span><span class="op" id="4155852">,</span>&nbsp;<span class="num" id="4155854">0x09</span><span class="op" id="4155858">,</span>&nbsp;<span class="num" id="4155860">0x60</span><span class="op" id="4155864">,</span>&nbsp;<span class="num" id="4155866">0x86</span><span class="op" id="4155870">,</span>&nbsp;<span class="num" id="4155872">0x48</span><span class="op" id="4155876">,</span>&nbsp;<span class="num" id="4155878">0x01</span><span class="op" id="4155882">,</span>&nbsp;<span class="num" id="4155884">0x65</span><span class="op" id="4155888">,</span>&nbsp;<span class="num" id="4155890">0x03</span><span class="op" id="4155894">,</span>&nbsp;<span class="num" id="4155896">0x04</span><span class="op" id="4155900">,</span>&nbsp;<span class="num" id="4155902">0x02</span><span class="op" id="4155906">,</span>&nbsp;<span class="num" id="4155908">0x04</span><span class="op" id="4155912">,</span>&nbsp;<span class="num" id="4155914">0x05</span><span class="op" id="4155918">,</span>&nbsp;<span class="num" id="4155920">0x00</span><span class="op" id="4155924">,</span>&nbsp;<span class="num" id="4155926">0x04</span><span class="op" id="4155930">,</span>&nbsp;<span class="num" id="4155932">0x1c</span><span class="op" id="4155936">}</span><span class="op" id="4155937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155940">crypto</span><span class="op" id="4155946">.</span><span class="ident" id="4155947">SHA256</span><span class="op" id="4155953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155958">{</span><span class="num" id="4155959">0x30</span><span class="op" id="4155963">,</span>&nbsp;<span class="num" id="4155965">0x31</span><span class="op" id="4155969">,</span>&nbsp;<span class="num" id="4155971">0x30</span><span class="op" id="4155975">,</span>&nbsp;<span class="num" id="4155977">0x0d</span><span class="op" id="4155981">,</span>&nbsp;<span class="num" id="4155983">0x06</span><span class="op" id="4155987">,</span>&nbsp;<span class="num" id="4155989">0x09</span><span class="op" id="4155993">,</span>&nbsp;<span class="num" id="4155995">0x60</span><span class="op" id="4155999">,</span>&nbsp;<span class="num" id="4156001">0x86</span><span class="op" id="4156005">,</span>&nbsp;<span class="num" id="4156007">0x48</span><span class="op" id="4156011">,</span>&nbsp;<span class="num" id="4156013">0x01</span><span class="op" id="4156017">,</span>&nbsp;<span class="num" id="4156019">0x65</span><span class="op" id="4156023">,</span>&nbsp;<span class="num" id="4156025">0x03</span><span class="op" id="4156029">,</span>&nbsp;<span class="num" id="4156031">0x04</span><span class="op" id="4156035">,</span>&nbsp;<span class="num" id="4156037">0x02</span><span class="op" id="4156041">,</span>&nbsp;<span class="num" id="4156043">0x01</span><span class="op" id="4156047">,</span>&nbsp;<span class="num" id="4156049">0x05</span><span class="op" id="4156053">,</span>&nbsp;<span class="num" id="4156055">0x00</span><span class="op" id="4156059">,</span>&nbsp;<span class="num" id="4156061">0x04</span><span class="op" id="4156065">,</span>&nbsp;<span class="num" id="4156067">0x20</span><span class="op" id="4156071">}</span><span class="op" id="4156072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156075">crypto</span><span class="op" id="4156081">.</span><span class="ident" id="4156082">SHA384</span><span class="op" id="4156088">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156093">{</span><span class="num" id="4156094">0x30</span><span class="op" id="4156098">,</span>&nbsp;<span class="num" id="4156100">0x41</span><span class="op" id="4156104">,</span>&nbsp;<span class="num" id="4156106">0x30</span><span class="op" id="4156110">,</span>&nbsp;<span class="num" id="4156112">0x0d</span><span class="op" id="4156116">,</span>&nbsp;<span class="num" id="4156118">0x06</span><span class="op" id="4156122">,</span>&nbsp;<span class="num" id="4156124">0x09</span><span class="op" id="4156128">,</span>&nbsp;<span class="num" id="4156130">0x60</span><span class="op" id="4156134">,</span>&nbsp;<span class="num" id="4156136">0x86</span><span class="op" id="4156140">,</span>&nbsp;<span class="num" id="4156142">0x48</span><span class="op" id="4156146">,</span>&nbsp;<span class="num" id="4156148">0x01</span><span class="op" id="4156152">,</span>&nbsp;<span class="num" id="4156154">0x65</span><span class="op" id="4156158">,</span>&nbsp;<span class="num" id="4156160">0x03</span><span class="op" id="4156164">,</span>&nbsp;<span class="num" id="4156166">0x04</span><span class="op" id="4156170">,</span>&nbsp;<span class="num" id="4156172">0x02</span><span class="op" id="4156176">,</span>&nbsp;<span class="num" id="4156178">0x02</span><span class="op" id="4156182">,</span>&nbsp;<span class="num" id="4156184">0x05</span><span class="op" id="4156188">,</span>&nbsp;<span class="num" id="4156190">0x00</span><span class="op" id="4156194">,</span>&nbsp;<span class="num" id="4156196">0x04</span><span class="op" id="4156200">,</span>&nbsp;<span class="num" id="4156202">0x30</span><span class="op" id="4156206">}</span><span class="op" id="4156207">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156210">crypto</span><span class="op" id="4156216">.</span><span class="ident" id="4156217">SHA512</span><span class="op" id="4156223">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156228">{</span><span class="num" id="4156229">0x30</span><span class="op" id="4156233">,</span>&nbsp;<span class="num" id="4156235">0x51</span><span class="op" id="4156239">,</span>&nbsp;<span class="num" id="4156241">0x30</span><span class="op" id="4156245">,</span>&nbsp;<span class="num" id="4156247">0x0d</span><span class="op" id="4156251">,</span>&nbsp;<span class="num" id="4156253">0x06</span><span class="op" id="4156257">,</span>&nbsp;<span class="num" id="4156259">0x09</span><span class="op" id="4156263">,</span>&nbsp;<span class="num" id="4156265">0x60</span><span class="op" id="4156269">,</span>&nbsp;<span class="num" id="4156271">0x86</span><span class="op" id="4156275">,</span>&nbsp;<span class="num" id="4156277">0x48</span><span class="op" id="4156281">,</span>&nbsp;<span class="num" id="4156283">0x01</span><span class="op" id="4156287">,</span>&nbsp;<span class="num" id="4156289">0x65</span><span class="op" id="4156293">,</span>&nbsp;<span class="num" id="4156295">0x03</span><span class="op" id="4156299">,</span>&nbsp;<span class="num" id="4156301">0x04</span><span class="op" id="4156305">,</span>&nbsp;<span class="num" id="4156307">0x02</span><span class="op" id="4156311">,</span>&nbsp;<span class="num" id="4156313">0x03</span><span class="op" id="4156317">,</span>&nbsp;<span class="num" id="4156319">0x05</span><span class="op" id="4156323">,</span>&nbsp;<span class="num" id="4156325">0x00</span><span class="op" id="4156329">,</span>&nbsp;<span class="num" id="4156331">0x04</span><span class="op" id="4156335">,</span>&nbsp;<span class="num" id="4156337">0x40</span><span class="op" id="4156341">}</span><span class="op" id="4156342">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156345">crypto</span><span class="op" id="4156351">.</span><span class="ident" id="4156352">MD5SHA1</span><span class="op" id="4156359">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4156363">{</span><span class="op" id="4156364">}</span><span class="op" id="4156365">,</span>&nbsp;<span class="comment" id="4156367">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156424">crypto</span><span class="op" id="4156430">.</span><span class="ident" id="4156431">RIPEMD160</span><span class="op" id="4156440">:</span>&nbsp;<span class="op" id="4156442">{</span><span class="num" id="4156443">0x30</span><span class="op" id="4156447">,</span>&nbsp;<span class="num" id="4156449">0x20</span><span class="op" id="4156453">,</span>&nbsp;<span class="num" id="4156455">0x30</span><span class="op" id="4156459">,</span>&nbsp;<span class="num" id="4156461">0x08</span><span class="op" id="4156465">,</span>&nbsp;<span class="num" id="4156467">0x06</span><span class="op" id="4156471">,</span>&nbsp;<span class="num" id="4156473">0x06</span><span class="op" id="4156477">,</span>&nbsp;<span class="num" id="4156479">0x28</span><span class="op" id="4156483">,</span>&nbsp;<span class="num" id="4156485">0xcf</span><span class="op" id="4156489">,</span>&nbsp;<span class="num" id="4156491">0x06</span><span class="op" id="4156495">,</span>&nbsp;<span class="num" id="4156497">0x03</span><span class="op" id="4156501">,</span>&nbsp;<span class="num" id="4156503">0x00</span><span class="op" id="4156507">,</span>&nbsp;<span class="num" id="4156509">0x31</span><span class="op" id="4156513">,</span>&nbsp;<span class="num" id="4156515">0x04</span><span class="op" id="4156519">,</span>&nbsp;<span class="num" id="4156521">0x14</span><span class="op" id="4156525">}</span><span class="op" id="4156526">,</span><br>
<span class="lineno"></span><span class="op" id="4156528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4156531">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4156633">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4156711">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4156790">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4156832">func</span>&nbsp;<span class="ident" id="4156837">SignPKCS1v15</span><span class="op" id="4156849">(</span><span class="ident" id="4156850">rand</span>&nbsp;<span class="ident" id="4156855">io</span><span class="op" id="4156857">.</span><span class="ident" id="4156858">Reader</span><span class="op" id="4156864">,</span>&nbsp;<span class="ident" id="4156866">priv</span>&nbsp;<span class="op" id="4156871">*</span><span class="ident" id="4156872">PrivateKey</span><span class="op" id="4156882">,</span>&nbsp;<span class="ident" id="4156884">hash</span>&nbsp;<span class="ident" id="4156889">crypto</span><span class="op" id="4156895">.</span><span class="ident" id="4156896">Hash</span><span class="op" id="4156900">,</span>&nbsp;<span class="ident" id="4156902">hashed</span>&nbsp;<span class="op" id="4156909">[</span><span class="op" id="4156910">]</span><span class="builtintype" id="4156911">byte</span><span class="op" id="4156915">)</span>&nbsp;<span class="op" id="4156917">(</span><span class="ident" id="4156918">s</span>&nbsp;<span class="op" id="4156920">[</span><span class="op" id="4156921">]</span><span class="builtintype" id="4156922">byte</span><span class="op" id="4156926">,</span>&nbsp;<span class="ident" id="4156928">err</span>&nbsp;<span class="builtintype" id="4156932">error</span><span class="op" id="4156937">)</span>&nbsp;<span class="op" id="4156939">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156942">hashLen</span><span class="op" id="4156949">,</span>&nbsp;<span class="ident" id="4156951">prefix</span><span class="op" id="4156957">,</span>&nbsp;<span class="ident" id="4156959">err</span>&nbsp;<span class="op" id="4156963">:=</span>&nbsp;<span class="ident" id="4156966">pkcs1v15HashInfo</span><span class="op" id="4156982">(</span><span class="ident" id="4156983">hash</span><span class="op" id="4156987">,</span>&nbsp;<span class="builtinfunc" id="4156989">len</span><span class="op" id="4156992">(</span><span class="ident" id="4156993">hashed</span><span class="op" id="4156999">)</span><span class="op" id="4157000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157003">if</span>&nbsp;<span class="ident" id="4157006">err</span>&nbsp;<span class="op" id="4157010">!=</span>&nbsp;<span class="ident" id="4157013">nil</span>&nbsp;<span class="op" id="4157017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157021">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157033">tLen</span>&nbsp;<span class="op" id="4157038">:=</span>&nbsp;<span class="builtinfunc" id="4157041">len</span><span class="op" id="4157044">(</span><span class="ident" id="4157045">prefix</span><span class="op" id="4157051">)</span>&nbsp;<span class="op" id="4157053">+</span>&nbsp;<span class="ident" id="4157055">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157064">k</span>&nbsp;<span class="op" id="4157066">:=</span>&nbsp;<span class="op" id="4157069">(</span><span class="ident" id="4157070">priv</span><span class="op" id="4157074">.</span><span class="ident" id="4157075">N</span><span class="op" id="4157076">.</span><span class="ident" id="4157077">BitLen</span><span class="op" id="4157083">(</span><span class="op" id="4157084">)</span>&nbsp;<span class="op" id="4157086">+</span>&nbsp;<span class="num" id="4157088">7</span><span class="op" id="4157089">)</span>&nbsp;<span class="op" id="4157091">/</span>&nbsp;<span class="num" id="4157093">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157096">if</span>&nbsp;<span class="ident" id="4157099">k</span>&nbsp;<span class="op" id="4157101">&lt;</span>&nbsp;<span class="ident" id="4157103">tLen</span><span class="op" id="4157107">+</span><span class="num" id="4157108">11</span>&nbsp;<span class="op" id="4157111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157115">return</span>&nbsp;<span class="ident" id="4157122">nil</span><span class="op" id="4157125">,</span>&nbsp;<span class="ident" id="4157127">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157146">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4157150">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157191">em</span>&nbsp;<span class="op" id="4157194">:=</span>&nbsp;<span class="builtinfunc" id="4157197">make</span><span class="op" id="4157201">(</span><span class="op" id="4157202">[</span><span class="op" id="4157203">]</span><span class="builtintype" id="4157204">byte</span><span class="op" id="4157208">,</span>&nbsp;<span class="ident" id="4157210">k</span><span class="op" id="4157211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157214">em</span><span class="op" id="4157216">[</span><span class="num" id="4157217">1</span><span class="op" id="4157218">]</span>&nbsp;<span class="op" id="4157220">=</span>&nbsp;<span class="num" id="4157222">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157225">for</span>&nbsp;<span class="ident" id="4157229">i</span>&nbsp;<span class="op" id="4157231">:=</span>&nbsp;<span class="num" id="4157234">2</span><span class="op" id="4157235">;</span>&nbsp;<span class="ident" id="4157237">i</span>&nbsp;<span class="op" id="4157239">&lt;</span>&nbsp;<span class="ident" id="4157241">k</span><span class="op" id="4157242">-</span><span class="ident" id="4157243">tLen</span><span class="op" id="4157247">-</span><span class="num" id="4157248">1</span><span class="op" id="4157249">;</span>&nbsp;<span class="ident" id="4157251">i</span><span class="op" id="4157252">++</span>&nbsp;<span class="op" id="4157255">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157259">em</span><span class="op" id="4157261">[</span><span class="ident" id="4157262">i</span><span class="op" id="4157263">]</span>&nbsp;<span class="op" id="4157265">=</span>&nbsp;<span class="num" id="4157267">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4157276">copy</span><span class="op" id="4157280">(</span><span class="ident" id="4157281">em</span><span class="op" id="4157283">[</span><span class="ident" id="4157284">k</span><span class="op" id="4157285">-</span><span class="ident" id="4157286">tLen</span><span class="op" id="4157290">:</span><span class="ident" id="4157291">k</span><span class="op" id="4157292">-</span><span class="ident" id="4157293">hashLen</span><span class="op" id="4157300">]</span><span class="op" id="4157301">,</span>&nbsp;<span class="ident" id="4157303">prefix</span><span class="op" id="4157309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4157312">copy</span><span class="op" id="4157316">(</span><span class="ident" id="4157317">em</span><span class="op" id="4157319">[</span><span class="ident" id="4157320">k</span><span class="op" id="4157321">-</span><span class="ident" id="4157322">hashLen</span><span class="op" id="4157329">:</span><span class="ident" id="4157330">k</span><span class="op" id="4157331">]</span><span class="op" id="4157332">,</span>&nbsp;<span class="ident" id="4157334">hashed</span><span class="op" id="4157340">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157344">m</span>&nbsp;<span class="op" id="4157346">:=</span>&nbsp;<span class="builtinfunc" id="4157349">new</span><span class="op" id="4157352">(</span><span class="ident" id="4157353">big</span><span class="op" id="4157356">.</span><span class="ident" id="4157357">Int</span><span class="op" id="4157360">)</span><span class="op" id="4157361">.</span><span class="ident" id="4157362">SetBytes</span><span class="op" id="4157370">(</span><span class="ident" id="4157371">em</span><span class="op" id="4157373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157376">c</span><span class="op" id="4157377">,</span>&nbsp;<span class="ident" id="4157379">err</span>&nbsp;<span class="op" id="4157383">:=</span>&nbsp;<span class="ident" id="4157386">decrypt</span><span class="op" id="4157393">(</span><span class="ident" id="4157394">rand</span><span class="op" id="4157398">,</span>&nbsp;<span class="ident" id="4157400">priv</span><span class="op" id="4157404">,</span>&nbsp;<span class="ident" id="4157406">m</span><span class="op" id="4157407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157410">if</span>&nbsp;<span class="ident" id="4157413">err</span>&nbsp;<span class="op" id="4157417">!=</span>&nbsp;<span class="ident" id="4157420">nil</span>&nbsp;<span class="op" id="4157424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157428">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157436">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157440">copyWithLeftPad</span><span class="op" id="4157455">(</span><span class="ident" id="4157456">em</span><span class="op" id="4157458">,</span>&nbsp;<span class="ident" id="4157460">c</span><span class="op" id="4157461">.</span><span class="ident" id="4157462">Bytes</span><span class="op" id="4157467">(</span><span class="op" id="4157468">)</span><span class="op" id="4157469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157472">s</span>&nbsp;<span class="op" id="4157474">=</span>&nbsp;<span class="ident" id="4157476">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157480">return</span><br>
<span class="lineno"></span><span class="op" id="4157487">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4157490">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4157547">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4157621">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4157693">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4157770">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4157818">func</span>&nbsp;<span class="ident" id="4157823">VerifyPKCS1v15</span><span class="op" id="4157837">(</span><span class="ident" id="4157838">pub</span>&nbsp;<span class="op" id="4157842">*</span><span class="ident" id="4157843">PublicKey</span><span class="op" id="4157852">,</span>&nbsp;<span class="ident" id="4157854">hash</span>&nbsp;<span class="ident" id="4157859">crypto</span><span class="op" id="4157865">.</span><span class="ident" id="4157866">Hash</span><span class="op" id="4157870">,</span>&nbsp;<span class="ident" id="4157872">hashed</span>&nbsp;<span class="op" id="4157879">[</span><span class="op" id="4157880">]</span><span class="builtintype" id="4157881">byte</span><span class="op" id="4157885">,</span>&nbsp;<span class="ident" id="4157887">sig</span>&nbsp;<span class="op" id="4157891">[</span><span class="op" id="4157892">]</span><span class="builtintype" id="4157893">byte</span><span class="op" id="4157897">)</span>&nbsp;<span class="op" id="4157899">(</span><span class="ident" id="4157900">err</span>&nbsp;<span class="builtintype" id="4157904">error</span><span class="op" id="4157909">)</span>&nbsp;<span class="op" id="4157911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157914">hashLen</span><span class="op" id="4157921">,</span>&nbsp;<span class="ident" id="4157923">prefix</span><span class="op" id="4157929">,</span>&nbsp;<span class="ident" id="4157931">err</span>&nbsp;<span class="op" id="4157935">:=</span>&nbsp;<span class="ident" id="4157938">pkcs1v15HashInfo</span><span class="op" id="4157954">(</span><span class="ident" id="4157955">hash</span><span class="op" id="4157959">,</span>&nbsp;<span class="builtinfunc" id="4157961">len</span><span class="op" id="4157964">(</span><span class="ident" id="4157965">hashed</span><span class="op" id="4157971">)</span><span class="op" id="4157972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157975">if</span>&nbsp;<span class="ident" id="4157978">err</span>&nbsp;<span class="op" id="4157982">!=</span>&nbsp;<span class="ident" id="4157985">nil</span>&nbsp;<span class="op" id="4157989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157993">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4158001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158005">tLen</span>&nbsp;<span class="op" id="4158010">:=</span>&nbsp;<span class="builtinfunc" id="4158013">len</span><span class="op" id="4158016">(</span><span class="ident" id="4158017">prefix</span><span class="op" id="4158023">)</span>&nbsp;<span class="op" id="4158025">+</span>&nbsp;<span class="ident" id="4158027">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158036">k</span>&nbsp;<span class="op" id="4158038">:=</span>&nbsp;<span class="op" id="4158041">(</span><span class="ident" id="4158042">pub</span><span class="op" id="4158045">.</span><span class="ident" id="4158046">N</span><span class="op" id="4158047">.</span><span class="ident" id="4158048">BitLen</span><span class="op" id="4158054">(</span><span class="op" id="4158055">)</span>&nbsp;<span class="op" id="4158057">+</span>&nbsp;<span class="num" id="4158059">7</span><span class="op" id="4158060">)</span>&nbsp;<span class="op" id="4158062">/</span>&nbsp;<span class="num" id="4158064">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158067">if</span>&nbsp;<span class="ident" id="4158070">k</span>&nbsp;<span class="op" id="4158072">&lt;</span>&nbsp;<span class="ident" id="4158074">tLen</span><span class="op" id="4158078">+</span><span class="num" id="4158079">11</span>&nbsp;<span class="op" id="4158082">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158086">err</span>&nbsp;<span class="op" id="4158090">=</span>&nbsp;<span class="ident" id="4158092">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4158118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158122">c</span>&nbsp;<span class="op" id="4158124">:=</span>&nbsp;<span class="builtinfunc" id="4158127">new</span><span class="op" id="4158130">(</span><span class="ident" id="4158131">big</span><span class="op" id="4158134">.</span><span class="ident" id="4158135">Int</span><span class="op" id="4158138">)</span><span class="op" id="4158139">.</span><span class="ident" id="4158140">SetBytes</span><span class="op" id="4158148">(</span><span class="ident" id="4158149">sig</span><span class="op" id="4158152">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158155">m</span>&nbsp;<span class="op" id="4158157">:=</span>&nbsp;<span class="ident" id="4158160">encrypt</span><span class="op" id="4158167">(</span><span class="builtinfunc" id="4158168">new</span><span class="op" id="4158171">(</span><span class="ident" id="4158172">big</span><span class="op" id="4158175">.</span><span class="ident" id="4158176">Int</span><span class="op" id="4158179">)</span><span class="op" id="4158180">,</span>&nbsp;<span class="ident" id="4158182">pub</span><span class="op" id="4158185">,</span>&nbsp;<span class="ident" id="4158187">c</span><span class="op" id="4158188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158191">em</span>&nbsp;<span class="op" id="4158194">:=</span>&nbsp;<span class="ident" id="4158197">leftPad</span><span class="op" id="4158204">(</span><span class="ident" id="4158205">m</span><span class="op" id="4158206">.</span><span class="ident" id="4158207">Bytes</span><span class="op" id="4158212">(</span><span class="op" id="4158213">)</span><span class="op" id="4158214">,</span>&nbsp;<span class="ident" id="4158216">k</span><span class="op" id="4158217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4158220">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158262">ok</span>&nbsp;<span class="op" id="4158265">:=</span>&nbsp;<span class="ident" id="4158268">subtle</span><span class="op" id="4158274">.</span><span class="ident" id="4158275">ConstantTimeByteEq</span><span class="op" id="4158293">(</span><span class="ident" id="4158294">em</span><span class="op" id="4158296">[</span><span class="num" id="4158297">0</span><span class="op" id="4158298">]</span><span class="op" id="4158299">,</span>&nbsp;<span class="num" id="4158301">0</span><span class="op" id="4158302">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158305">ok</span>&nbsp;<span class="op" id="4158308">&amp;=</span>&nbsp;<span class="ident" id="4158311">subtle</span><span class="op" id="4158317">.</span><span class="ident" id="4158318">ConstantTimeByteEq</span><span class="op" id="4158336">(</span><span class="ident" id="4158337">em</span><span class="op" id="4158339">[</span><span class="num" id="4158340">1</span><span class="op" id="4158341">]</span><span class="op" id="4158342">,</span>&nbsp;<span class="num" id="4158344">1</span><span class="op" id="4158345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158348">ok</span>&nbsp;<span class="op" id="4158351">&amp;=</span>&nbsp;<span class="ident" id="4158354">subtle</span><span class="op" id="4158360">.</span><span class="ident" id="4158361">ConstantTimeCompare</span><span class="op" id="4158380">(</span><span class="ident" id="4158381">em</span><span class="op" id="4158383">[</span><span class="ident" id="4158384">k</span><span class="op" id="4158385">-</span><span class="ident" id="4158386">hashLen</span><span class="op" id="4158393">:</span><span class="ident" id="4158394">k</span><span class="op" id="4158395">]</span><span class="op" id="4158396">,</span>&nbsp;<span class="ident" id="4158398">hashed</span><span class="op" id="4158404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158407">ok</span>&nbsp;<span class="op" id="4158410">&amp;=</span>&nbsp;<span class="ident" id="4158413">subtle</span><span class="op" id="4158419">.</span><span class="ident" id="4158420">ConstantTimeCompare</span><span class="op" id="4158439">(</span><span class="ident" id="4158440">em</span><span class="op" id="4158442">[</span><span class="ident" id="4158443">k</span><span class="op" id="4158444">-</span><span class="ident" id="4158445">tLen</span><span class="op" id="4158449">:</span><span class="ident" id="4158450">k</span><span class="op" id="4158451">-</span><span class="ident" id="4158452">hashLen</span><span class="op" id="4158459">]</span><span class="op" id="4158460">,</span>&nbsp;<span class="ident" id="4158462">prefix</span><span class="op" id="4158468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158471">ok</span>&nbsp;<span class="op" id="4158474">&amp;=</span>&nbsp;<span class="ident" id="4158477">subtle</span><span class="op" id="4158483">.</span><span class="ident" id="4158484">ConstantTimeByteEq</span><span class="op" id="4158502">(</span><span class="ident" id="4158503">em</span><span class="op" id="4158505">[</span><span class="ident" id="4158506">k</span><span class="op" id="4158507">-</span><span class="ident" id="4158508">tLen</span><span class="op" id="4158512">-</span><span class="num" id="4158513">1</span><span class="op" id="4158514">]</span><span class="op" id="4158515">,</span>&nbsp;<span class="num" id="4158517">0</span><span class="op" id="4158518">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158522">for</span>&nbsp;<span class="ident" id="4158526">i</span>&nbsp;<span class="op" id="4158528">:=</span>&nbsp;<span class="num" id="4158531">2</span><span class="op" id="4158532">;</span>&nbsp;<span class="ident" id="4158534">i</span>&nbsp;<span class="op" id="4158536">&lt;</span>&nbsp;<span class="ident" id="4158538">k</span><span class="op" id="4158539">-</span><span class="ident" id="4158540">tLen</span><span class="op" id="4158544">-</span><span class="num" id="4158545">1</span><span class="op" id="4158546">;</span>&nbsp;<span class="ident" id="4158548">i</span><span class="op" id="4158549">++</span>&nbsp;<span class="op" id="4158552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158556">ok</span>&nbsp;<span class="op" id="4158559">&amp;=</span>&nbsp;<span class="ident" id="4158562">subtle</span><span class="op" id="4158568">.</span><span class="ident" id="4158569">ConstantTimeByteEq</span><span class="op" id="4158587">(</span><span class="ident" id="4158588">em</span><span class="op" id="4158590">[</span><span class="ident" id="4158591">i</span><span class="op" id="4158592">]</span><span class="op" id="4158593">,</span>&nbsp;<span class="num" id="4158595">0xff</span><span class="op" id="4158599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4158602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158606">if</span>&nbsp;<span class="ident" id="4158609">ok</span>&nbsp;<span class="op" id="4158612">!=</span>&nbsp;<span class="num" id="4158615">1</span>&nbsp;<span class="op" id="4158617">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158621">return</span>&nbsp;<span class="ident" id="4158628">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4158645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158649">return</span>&nbsp;<span class="ident" id="4158656">nil</span><br>
<span class="lineno"></span><span class="op" id="4158660">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4158663">func</span>&nbsp;<span class="ident" id="4158668">pkcs1v15HashInfo</span><span class="op" id="4158684">(</span><span class="ident" id="4158685">hash</span>&nbsp;<span class="ident" id="4158690">crypto</span><span class="op" id="4158696">.</span><span class="ident" id="4158697">Hash</span><span class="op" id="4158701">,</span>&nbsp;<span class="ident" id="4158703">inLen</span>&nbsp;<span class="builtintype" id="4158709">int</span><span class="op" id="4158712">)</span>&nbsp;<span class="op" id="4158714">(</span><span class="ident" id="4158715">hashLen</span>&nbsp;<span class="builtintype" id="4158723">int</span><span class="op" id="4158726">,</span>&nbsp;<span class="ident" id="4158728">prefix</span>&nbsp;<span class="op" id="4158735">[</span><span class="op" id="4158736">]</span><span class="builtintype" id="4158737">byte</span><span class="op" id="4158741">,</span>&nbsp;<span class="ident" id="4158743">err</span>&nbsp;<span class="builtintype" id="4158747">error</span><span class="op" id="4158752">)</span>&nbsp;<span class="op" id="4158754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4158757">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4158827">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158848">if</span>&nbsp;<span class="ident" id="4158851">hash</span>&nbsp;<span class="op" id="4158856">==</span>&nbsp;<span class="num" id="4158859">0</span>&nbsp;<span class="op" id="4158861">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158865">return</span>&nbsp;<span class="ident" id="4158872">inLen</span><span class="op" id="4158877">,</span>&nbsp;<span class="ident" id="4158879">nil</span><span class="op" id="4158882">,</span>&nbsp;<span class="ident" id="4158884">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4158889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4158893">hashLen</span>&nbsp;<span class="op" id="4158901">=</span>&nbsp;<span class="ident" id="4158903">hash</span><span class="op" id="4158907">.</span><span class="ident" id="4158908">Size</span><span class="op" id="4158912">(</span><span class="op" id="4158913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158916">if</span>&nbsp;<span class="ident" id="4158919">inLen</span>&nbsp;<span class="op" id="4158925">!=</span>&nbsp;<span class="ident" id="4158928">hashLen</span>&nbsp;<span class="op" id="4158936">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4158940">return</span>&nbsp;<span class="num" id="4158947">0</span><span class="op" id="4158948">,</span>&nbsp;<span class="ident" id="4158950">nil</span><span class="op" id="4158953">,</span>&nbsp;<span class="ident" id="4158955">errors</span><span class="op" id="4158961">.</span><span class="ident" id="4158962">New</span><span class="op" id="4158965">(</span><span class="string" id="4158966">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4159008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4159011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4159014">prefix</span><span class="op" id="4159020">,</span>&nbsp;<span class="ident" id="4159022">ok</span>&nbsp;<span class="op" id="4159025">:=</span>&nbsp;<span class="ident" id="4159028">hashPrefixes</span><span class="op" id="4159040">[</span><span class="ident" id="4159041">hash</span><span class="op" id="4159045">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159048">if</span>&nbsp;<span class="op" id="4159051">!</span><span class="ident" id="4159052">ok</span>&nbsp;<span class="op" id="4159055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159059">return</span>&nbsp;<span class="num" id="4159066">0</span><span class="op" id="4159067">,</span>&nbsp;<span class="ident" id="4159069">nil</span><span class="op" id="4159072">,</span>&nbsp;<span class="ident" id="4159074">errors</span><span class="op" id="4159080">.</span><span class="ident" id="4159081">New</span><span class="op" id="4159084">(</span><span class="string" id="4159085">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4159124">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4159127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159130">return</span><br>
<span class="lineno"></span><span class="op" id="4159137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4159140">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4159217">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4159228">func</span>&nbsp;<span class="ident" id="4159233">copyWithLeftPad</span><span class="op" id="4159248">(</span><span class="ident" id="4159249">dest</span><span class="op" id="4159253">,</span>&nbsp;<span class="ident" id="4159255">src</span>&nbsp;<span class="op" id="4159259">[</span><span class="op" id="4159260">]</span><span class="builtintype" id="4159261">byte</span><span class="op" id="4159265">)</span>&nbsp;<span class="op" id="4159267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4159270">numPaddingBytes</span>&nbsp;<span class="op" id="4159286">:=</span>&nbsp;<span class="builtinfunc" id="4159289">len</span><span class="op" id="4159292">(</span><span class="ident" id="4159293">dest</span><span class="op" id="4159297">)</span>&nbsp;<span class="op" id="4159299">-</span>&nbsp;<span class="builtinfunc" id="4159301">len</span><span class="op" id="4159304">(</span><span class="ident" id="4159305">src</span><span class="op" id="4159308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159311">for</span>&nbsp;<span class="ident" id="4159315">i</span>&nbsp;<span class="op" id="4159317">:=</span>&nbsp;<span class="num" id="4159320">0</span><span class="op" id="4159321">;</span>&nbsp;<span class="ident" id="4159323">i</span>&nbsp;<span class="op" id="4159325">&lt;</span>&nbsp;<span class="ident" id="4159327">numPaddingBytes</span><span class="op" id="4159342">;</span>&nbsp;<span class="ident" id="4159344">i</span><span class="op" id="4159345">++</span>&nbsp;<span class="op" id="4159348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4159352">dest</span><span class="op" id="4159356">[</span><span class="ident" id="4159357">i</span><span class="op" id="4159358">]</span>&nbsp;<span class="op" id="4159360">=</span>&nbsp;<span class="num" id="4159362">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4159365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4159368">copy</span><span class="op" id="4159372">(</span><span class="ident" id="4159373">dest</span><span class="op" id="4159377">[</span><span class="ident" id="4159378">numPaddingBytes</span><span class="op" id="4159393">:</span><span class="op" id="4159394">]</span><span class="op" id="4159395">,</span>&nbsp;<span class="ident" id="4159397">src</span><span class="op" id="4159400">)</span><br>
<span class="lineno"></span><span class="op" id="4159402">}</span>
</div>
</body>
</html>
