<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3532012">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3532067">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3532121">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3532172">package</span>&nbsp;<span class="ident" id="3532180">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3532191">import</span>&nbsp;<span class="op" id="3532198">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532201">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532210">&#34;crypto/rand&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532225">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532235">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532242">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532248">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3532265">&#34;strings&#34;</span><br>
<span class="lineno">15</span><span class="op" id="3532275">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532278">//&nbsp;A&nbsp;Writer&nbsp;generates&nbsp;multipart&nbsp;messages.</span><br>
<span class="lineno"></span><span class="keyword" id="3532320">type</span>&nbsp;<span class="ident" id="3532325">Writer</span>&nbsp;<span class="keyword" id="3532332">struct</span>&nbsp;<span class="op" id="3532339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532342">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532351">io</span><span class="op" id="3532353">.</span><span class="ident" id="3532354">Writer</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532362">boundary</span>&nbsp;<span class="builtintype" id="3532371">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532379">lastpart</span>&nbsp;<span class="op" id="3532388">*</span><span class="ident" id="3532389">part</span><br>
<span class="lineno"></span><span class="op" id="3532394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532397">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Writer&nbsp;with&nbsp;a&nbsp;random&nbsp;boundary,</span><br>
<span class="lineno">25</span><span class="comment" id="3532465">//&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="3532482">func</span>&nbsp;<span class="ident" id="3532487">NewWriter</span><span class="op" id="3532496">(</span><span class="ident" id="3532497">w</span>&nbsp;<span class="ident" id="3532499">io</span><span class="op" id="3532501">.</span><span class="ident" id="3532502">Writer</span><span class="op" id="3532508">)</span>&nbsp;<span class="op" id="3532510">*</span><span class="ident" id="3532511">Writer</span>&nbsp;<span class="op" id="3532518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532521">return</span>&nbsp;<span class="op" id="3532528">&amp;</span><span class="ident" id="3532529">Writer</span><span class="op" id="3532535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532539">w</span><span class="op" id="3532540">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532549">w</span><span class="op" id="3532550">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532554">boundary</span><span class="op" id="3532562">:</span>&nbsp;<span class="ident" id="3532564">randomBoundary</span><span class="op" id="3532578">(</span><span class="op" id="3532579">)</span><span class="op" id="3532580">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532583">}</span><br>
<span class="lineno"></span><span class="op" id="3532585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532588">//&nbsp;Boundary&nbsp;returns&nbsp;the&nbsp;Writer&#39;s&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="keyword" id="3532631">func</span>&nbsp;<span class="op" id="3532636">(</span><span class="ident" id="3532637">w</span>&nbsp;<span class="op" id="3532639">*</span><span class="ident" id="3532640">Writer</span><span class="op" id="3532646">)</span>&nbsp;<span class="ident" id="3532648">Boundary</span><span class="op" id="3532656">(</span><span class="op" id="3532657">)</span>&nbsp;<span class="builtintype" id="3532659">string</span>&nbsp;<span class="op" id="3532666">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532669">return</span>&nbsp;<span class="ident" id="3532676">w</span><span class="op" id="3532677">.</span><span class="ident" id="3532678">boundary</span><br>
<span class="lineno"></span><span class="op" id="3532687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532690">//&nbsp;SetBoundary&nbsp;overrides&nbsp;the&nbsp;Writer&#39;s&nbsp;default&nbsp;randomly-generated</span><br>
<span class="lineno"></span><span class="comment" id="3532755">//&nbsp;boundary&nbsp;separator&nbsp;with&nbsp;an&nbsp;explicit&nbsp;value.</span><br>
<span class="lineno">40</span><span class="comment" id="3532801">//</span><br>
<span class="lineno"></span><span class="comment" id="3532804">//&nbsp;SetBoundary&nbsp;must&nbsp;be&nbsp;called&nbsp;before&nbsp;any&nbsp;parts&nbsp;are&nbsp;created,&nbsp;may&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3532873">//&nbsp;contain&nbsp;certain&nbsp;ASCII&nbsp;characters,&nbsp;and&nbsp;must&nbsp;be&nbsp;1-69&nbsp;bytes&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="3532939">func</span>&nbsp;<span class="op" id="3532944">(</span><span class="ident" id="3532945">w</span>&nbsp;<span class="op" id="3532947">*</span><span class="ident" id="3532948">Writer</span><span class="op" id="3532954">)</span>&nbsp;<span class="ident" id="3532956">SetBoundary</span><span class="op" id="3532967">(</span><span class="ident" id="3532968">boundary</span>&nbsp;<span class="builtintype" id="3532977">string</span><span class="op" id="3532983">)</span>&nbsp;<span class="builtintype" id="3532985">error</span>&nbsp;<span class="op" id="3532991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532994">if</span>&nbsp;<span class="ident" id="3532997">w</span><span class="op" id="3532998">.</span><span class="ident" id="3532999">lastpart</span>&nbsp;<span class="op" id="3533008">!=</span>&nbsp;<span class="ident" id="3533011">nil</span>&nbsp;<span class="op" id="3533015">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533019">return</span>&nbsp;<span class="ident" id="3533026">errors</span><span class="op" id="3533032">.</span><span class="ident" id="3533033">New</span><span class="op" id="3533036">(</span><span class="string" id="3533037">&#34;mime:&nbsp;SetBoundary&nbsp;called&nbsp;after&nbsp;write&#34;</span><span class="op" id="3533075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533081">//&nbsp;rfc2046#section-5.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533107">if</span>&nbsp;<span class="builtinfunc" id="3533110">len</span><span class="op" id="3533113">(</span><span class="ident" id="3533114">boundary</span><span class="op" id="3533122">)</span>&nbsp;<span class="op" id="3533124">&lt;</span>&nbsp;<span class="num" id="3533126">1</span>&nbsp;<span class="op" id="3533128">||</span>&nbsp;<span class="builtinfunc" id="3533131">len</span><span class="op" id="3533134">(</span><span class="ident" id="3533135">boundary</span><span class="op" id="3533143">)</span>&nbsp;<span class="op" id="3533145">&gt;</span>&nbsp;<span class="num" id="3533147">69</span>&nbsp;<span class="op" id="3533150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533154">return</span>&nbsp;<span class="ident" id="3533161">errors</span><span class="op" id="3533167">.</span><span class="ident" id="3533168">New</span><span class="op" id="3533171">(</span><span class="string" id="3533172">&#34;mime:&nbsp;invalid&nbsp;boundary&nbsp;length&#34;</span><span class="op" id="3533203">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533209">for</span>&nbsp;<span class="ident" id="3533213">_</span><span class="op" id="3533214">,</span>&nbsp;<span class="ident" id="3533216">b</span>&nbsp;<span class="op" id="3533218">:=</span>&nbsp;<span class="keyword" id="3533221">range</span>&nbsp;<span class="ident" id="3533227">boundary</span>&nbsp;<span class="op" id="3533236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533240">if</span>&nbsp;<span class="string" id="3533243">&#39;A&#39;</span>&nbsp;<span class="op" id="3533247">&lt;=</span>&nbsp;<span class="ident" id="3533250">b</span>&nbsp;<span class="op" id="3533252">&amp;&amp;</span>&nbsp;<span class="ident" id="3533255">b</span>&nbsp;<span class="op" id="3533257">&lt;=</span>&nbsp;<span class="string" id="3533260">&#39;Z&#39;</span>&nbsp;<span class="op" id="3533264">||</span>&nbsp;<span class="string" id="3533267">&#39;a&#39;</span>&nbsp;<span class="op" id="3533271">&lt;=</span>&nbsp;<span class="ident" id="3533274">b</span>&nbsp;<span class="op" id="3533276">&amp;&amp;</span>&nbsp;<span class="ident" id="3533279">b</span>&nbsp;<span class="op" id="3533281">&lt;=</span>&nbsp;<span class="string" id="3533284">&#39;z&#39;</span>&nbsp;<span class="op" id="3533288">||</span>&nbsp;<span class="string" id="3533291">&#39;0&#39;</span>&nbsp;<span class="op" id="3533295">&lt;=</span>&nbsp;<span class="ident" id="3533298">b</span>&nbsp;<span class="op" id="3533300">&amp;&amp;</span>&nbsp;<span class="ident" id="3533303">b</span>&nbsp;<span class="op" id="3533305">&lt;=</span>&nbsp;<span class="string" id="3533308">&#39;9&#39;</span>&nbsp;<span class="op" id="3533312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533317">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533328">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533332">switch</span>&nbsp;<span class="ident" id="3533339">b</span>&nbsp;<span class="op" id="3533341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533345">case</span>&nbsp;<span class="string" id="3533350">&#39;\&#39;&#39;</span><span class="op" id="3533354">,</span>&nbsp;<span class="string" id="3533356">&#39;(&#39;</span><span class="op" id="3533359">,</span>&nbsp;<span class="string" id="3533361">&#39;)&#39;</span><span class="op" id="3533364">,</span>&nbsp;<span class="string" id="3533366">&#39;+&#39;</span><span class="op" id="3533369">,</span>&nbsp;<span class="string" id="3533371">&#39;_&#39;</span><span class="op" id="3533374">,</span>&nbsp;<span class="string" id="3533376">&#39;,&#39;</span><span class="op" id="3533379">,</span>&nbsp;<span class="string" id="3533381">&#39;-&#39;</span><span class="op" id="3533384">,</span>&nbsp;<span class="string" id="3533386">&#39;.&#39;</span><span class="op" id="3533389">,</span>&nbsp;<span class="string" id="3533391">&#39;/&#39;</span><span class="op" id="3533394">,</span>&nbsp;<span class="string" id="3533396">&#39;:&#39;</span><span class="op" id="3533399">,</span>&nbsp;<span class="string" id="3533401">&#39;=&#39;</span><span class="op" id="3533404">,</span>&nbsp;<span class="string" id="3533406">&#39;?&#39;</span><span class="op" id="3533409">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533414">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533429">return</span>&nbsp;<span class="ident" id="3533436">errors</span><span class="op" id="3533442">.</span><span class="ident" id="3533443">New</span><span class="op" id="3533446">(</span><span class="string" id="3533447">&#34;mime:&nbsp;invalid&nbsp;boundary&nbsp;character&#34;</span><span class="op" id="3533481">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533487">w</span><span class="op" id="3533488">.</span><span class="ident" id="3533489">boundary</span>&nbsp;<span class="op" id="3533498">=</span>&nbsp;<span class="ident" id="3533500">boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533510">return</span>&nbsp;<span class="ident" id="3533517">nil</span><br>
<span class="lineno"></span><span class="op" id="3533521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3533524">//&nbsp;FormDataContentType&nbsp;returns&nbsp;the&nbsp;Content-Type&nbsp;for&nbsp;an&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="3533584">//&nbsp;multipart/form-data&nbsp;with&nbsp;this&nbsp;Writer&#39;s&nbsp;Boundary.</span><br>
<span class="lineno"></span><span class="keyword" id="3533636">func</span>&nbsp;<span class="op" id="3533641">(</span><span class="ident" id="3533642">w</span>&nbsp;<span class="op" id="3533644">*</span><span class="ident" id="3533645">Writer</span><span class="op" id="3533651">)</span>&nbsp;<span class="ident" id="3533653">FormDataContentType</span><span class="op" id="3533672">(</span><span class="op" id="3533673">)</span>&nbsp;<span class="builtintype" id="3533675">string</span>&nbsp;<span class="op" id="3533682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533685">return</span>&nbsp;<span class="string" id="3533692">&#34;multipart/form-data;&nbsp;boundary=&#34;</span>&nbsp;<span class="op" id="3533725">+</span>&nbsp;<span class="ident" id="3533727">w</span><span class="op" id="3533728">.</span><span class="ident" id="3533729">boundary</span><br>
<span class="lineno"></span><span class="op" id="3533738">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3533741">func</span>&nbsp;<span class="ident" id="3533746">randomBoundary</span><span class="op" id="3533760">(</span><span class="op" id="3533761">)</span>&nbsp;<span class="builtintype" id="3533763">string</span>&nbsp;<span class="op" id="3533770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533773">var</span>&nbsp;<span class="ident" id="3533777">buf</span>&nbsp;<span class="op" id="3533781">[</span><span class="num" id="3533782">30</span><span class="op" id="3533784">]</span><span class="builtintype" id="3533785">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533791">_</span><span class="op" id="3533792">,</span>&nbsp;<span class="ident" id="3533794">err</span>&nbsp;<span class="op" id="3533798">:=</span>&nbsp;<span class="ident" id="3533801">io</span><span class="op" id="3533803">.</span><span class="ident" id="3533804">ReadFull</span><span class="op" id="3533812">(</span><span class="ident" id="3533813">rand</span><span class="op" id="3533817">.</span><span class="ident" id="3533818">Reader</span><span class="op" id="3533824">,</span>&nbsp;<span class="ident" id="3533826">buf</span><span class="op" id="3533829">[</span><span class="op" id="3533830">:</span><span class="op" id="3533831">]</span><span class="op" id="3533832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533835">if</span>&nbsp;<span class="ident" id="3533838">err</span>&nbsp;<span class="op" id="3533842">!=</span>&nbsp;<span class="ident" id="3533845">nil</span>&nbsp;<span class="op" id="3533849">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3533853">panic</span><span class="op" id="3533858">(</span><span class="ident" id="3533859">err</span><span class="op" id="3533862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533868">return</span>&nbsp;<span class="ident" id="3533875">fmt</span><span class="op" id="3533878">.</span><span class="ident" id="3533879">Sprintf</span><span class="op" id="3533886">(</span><span class="string" id="3533887">&#34;%x&#34;</span><span class="op" id="3533891">,</span>&nbsp;<span class="ident" id="3533893">buf</span><span class="op" id="3533896">[</span><span class="op" id="3533897">:</span><span class="op" id="3533898">]</span><span class="op" id="3533899">)</span><br>
<span class="lineno"></span><span class="op" id="3533901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3533904">//&nbsp;CreatePart&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;section&nbsp;with&nbsp;the&nbsp;provided</span><br>
<span class="lineno"></span><span class="comment" id="3533968">//&nbsp;header.&nbsp;The&nbsp;body&nbsp;of&nbsp;the&nbsp;part&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;the&nbsp;returned</span><br>
<span class="lineno"></span><span class="comment" id="3534034">//&nbsp;Writer.&nbsp;After&nbsp;calling&nbsp;CreatePart,&nbsp;any&nbsp;previous&nbsp;part&nbsp;may&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="3534103">//&nbsp;be&nbsp;written&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3534121">func</span>&nbsp;<span class="op" id="3534126">(</span><span class="ident" id="3534127">w</span>&nbsp;<span class="op" id="3534129">*</span><span class="ident" id="3534130">Writer</span><span class="op" id="3534136">)</span>&nbsp;<span class="ident" id="3534138">CreatePart</span><span class="op" id="3534148">(</span><span class="ident" id="3534149">header</span>&nbsp;<span class="ident" id="3534156">textproto</span><span class="op" id="3534165">.</span><span class="ident" id="3534166">MIMEHeader</span><span class="op" id="3534176">)</span>&nbsp;<span class="op" id="3534178">(</span><span class="ident" id="3534179">io</span><span class="op" id="3534181">.</span><span class="ident" id="3534182">Writer</span><span class="op" id="3534188">,</span>&nbsp;<span class="builtintype" id="3534190">error</span><span class="op" id="3534195">)</span>&nbsp;<span class="op" id="3534197">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534200">if</span>&nbsp;<span class="ident" id="3534203">w</span><span class="op" id="3534204">.</span><span class="ident" id="3534205">lastpart</span>&nbsp;<span class="op" id="3534214">!=</span>&nbsp;<span class="ident" id="3534217">nil</span>&nbsp;<span class="op" id="3534221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534225">if</span>&nbsp;<span class="ident" id="3534228">err</span>&nbsp;<span class="op" id="3534232">:=</span>&nbsp;<span class="ident" id="3534235">w</span><span class="op" id="3534236">.</span><span class="ident" id="3534237">lastpart</span><span class="op" id="3534245">.</span><span class="builtinfunc" id="3534246">close</span><span class="op" id="3534251">(</span><span class="op" id="3534252">)</span><span class="op" id="3534253">;</span>&nbsp;<span class="ident" id="3534255">err</span>&nbsp;<span class="op" id="3534259">!=</span>&nbsp;<span class="ident" id="3534262">nil</span>&nbsp;<span class="op" id="3534266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534271">return</span>&nbsp;<span class="ident" id="3534278">nil</span><span class="op" id="3534281">,</span>&nbsp;<span class="ident" id="3534283">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534292">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534295">var</span>&nbsp;<span class="ident" id="3534299">b</span>&nbsp;<span class="ident" id="3534301">bytes</span><span class="op" id="3534306">.</span><span class="ident" id="3534307">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534315">if</span>&nbsp;<span class="ident" id="3534318">w</span><span class="op" id="3534319">.</span><span class="ident" id="3534320">lastpart</span>&nbsp;<span class="op" id="3534329">!=</span>&nbsp;<span class="ident" id="3534332">nil</span>&nbsp;<span class="op" id="3534336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534340">fmt</span><span class="op" id="3534343">.</span><span class="ident" id="3534344">Fprintf</span><span class="op" id="3534351">(</span><span class="op" id="3534352">&amp;</span><span class="ident" id="3534353">b</span><span class="op" id="3534354">,</span>&nbsp;<span class="string" id="3534356">&#34;\r\n--%s\r\n&#34;</span><span class="op" id="3534370">,</span>&nbsp;<span class="ident" id="3534372">w</span><span class="op" id="3534373">.</span><span class="ident" id="3534374">boundary</span><span class="op" id="3534382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534385">}</span>&nbsp;<span class="keyword" id="3534387">else</span>&nbsp;<span class="op" id="3534392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534396">fmt</span><span class="op" id="3534399">.</span><span class="ident" id="3534400">Fprintf</span><span class="op" id="3534407">(</span><span class="op" id="3534408">&amp;</span><span class="ident" id="3534409">b</span><span class="op" id="3534410">,</span>&nbsp;<span class="string" id="3534412">&#34;--%s\r\n&#34;</span><span class="op" id="3534422">,</span>&nbsp;<span class="ident" id="3534424">w</span><span class="op" id="3534425">.</span><span class="ident" id="3534426">boundary</span><span class="op" id="3534434">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3534440">//&nbsp;TODO(bradfitz):&nbsp;move&nbsp;this&nbsp;to&nbsp;textproto.MimeHeader.Write(w),&nbsp;have&nbsp;it&nbsp;sort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3534517">//&nbsp;and&nbsp;clean,&nbsp;like&nbsp;http.Header.Write(w)&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534564">for</span>&nbsp;<span class="ident" id="3534568">k</span><span class="op" id="3534569">,</span>&nbsp;<span class="ident" id="3534571">vv</span>&nbsp;<span class="op" id="3534574">:=</span>&nbsp;<span class="keyword" id="3534577">range</span>&nbsp;<span class="ident" id="3534583">header</span>&nbsp;<span class="op" id="3534590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534594">for</span>&nbsp;<span class="ident" id="3534598">_</span><span class="op" id="3534599">,</span>&nbsp;<span class="ident" id="3534601">v</span>&nbsp;<span class="op" id="3534603">:=</span>&nbsp;<span class="keyword" id="3534606">range</span>&nbsp;<span class="ident" id="3534612">vv</span>&nbsp;<span class="op" id="3534615">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534620">fmt</span><span class="op" id="3534623">.</span><span class="ident" id="3534624">Fprintf</span><span class="op" id="3534631">(</span><span class="op" id="3534632">&amp;</span><span class="ident" id="3534633">b</span><span class="op" id="3534634">,</span>&nbsp;<span class="string" id="3534636">&#34;%s:&nbsp;%s\r\n&#34;</span><span class="op" id="3534648">,</span>&nbsp;<span class="ident" id="3534650">k</span><span class="op" id="3534651">,</span>&nbsp;<span class="ident" id="3534653">v</span><span class="op" id="3534654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534664">fmt</span><span class="op" id="3534667">.</span><span class="ident" id="3534668">Fprintf</span><span class="op" id="3534675">(</span><span class="op" id="3534676">&amp;</span><span class="ident" id="3534677">b</span><span class="op" id="3534678">,</span>&nbsp;<span class="string" id="3534680">&#34;\r\n&#34;</span><span class="op" id="3534686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534689">_</span><span class="op" id="3534690">,</span>&nbsp;<span class="ident" id="3534692">err</span>&nbsp;<span class="op" id="3534696">:=</span>&nbsp;<span class="ident" id="3534699">io</span><span class="op" id="3534701">.</span><span class="ident" id="3534702">Copy</span><span class="op" id="3534706">(</span><span class="ident" id="3534707">w</span><span class="op" id="3534708">.</span><span class="ident" id="3534709">w</span><span class="op" id="3534710">,</span>&nbsp;<span class="op" id="3534712">&amp;</span><span class="ident" id="3534713">b</span><span class="op" id="3534714">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534717">if</span>&nbsp;<span class="ident" id="3534720">err</span>&nbsp;<span class="op" id="3534724">!=</span>&nbsp;<span class="ident" id="3534727">nil</span>&nbsp;<span class="op" id="3534731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534735">return</span>&nbsp;<span class="ident" id="3534742">nil</span><span class="op" id="3534745">,</span>&nbsp;<span class="ident" id="3534747">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534755">p</span>&nbsp;<span class="op" id="3534757">:=</span>&nbsp;<span class="op" id="3534760">&amp;</span><span class="ident" id="3534761">part</span><span class="op" id="3534765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534769">mw</span><span class="op" id="3534771">:</span>&nbsp;<span class="ident" id="3534773">w</span><span class="op" id="3534774">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534780">w</span><span class="op" id="3534781">.</span><span class="ident" id="3534782">lastpart</span>&nbsp;<span class="op" id="3534791">=</span>&nbsp;<span class="ident" id="3534793">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534796">return</span>&nbsp;<span class="ident" id="3534803">p</span><span class="op" id="3534804">,</span>&nbsp;<span class="ident" id="3534806">nil</span><br>
<span class="lineno"></span><span class="op" id="3534810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="3534813">var</span>&nbsp;<span class="ident" id="3534817">quoteEscaper</span>&nbsp;<span class="op" id="3534830">=</span>&nbsp;<span class="ident" id="3534832">strings</span><span class="op" id="3534839">.</span><span class="ident" id="3534840">NewReplacer</span><span class="op" id="3534851">(</span><span class="string" id="3534852">&#34;\\&#34;</span><span class="op" id="3534856">,</span>&nbsp;<span class="string" id="3534858">&#34;\\\\&#34;</span><span class="op" id="3534864">,</span>&nbsp;<span class="string" id="3534866">`&#34;`</span><span class="op" id="3534869">,</span>&nbsp;<span class="string" id="3534871">&#34;\\\&#34;&#34;</span><span class="op" id="3534877">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3534880">func</span>&nbsp;<span class="ident" id="3534885">escapeQuotes</span><span class="op" id="3534897">(</span><span class="ident" id="3534898">s</span>&nbsp;<span class="builtintype" id="3534900">string</span><span class="op" id="3534906">)</span>&nbsp;<span class="builtintype" id="3534908">string</span>&nbsp;<span class="op" id="3534915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534918">return</span>&nbsp;<span class="ident" id="3534925">quoteEscaper</span><span class="op" id="3534937">.</span><span class="ident" id="3534938">Replace</span><span class="op" id="3534945">(</span><span class="ident" id="3534946">s</span><span class="op" id="3534947">)</span><br>
<span class="lineno"></span><span class="op" id="3534949">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3534952">//&nbsp;CreateFormFile&nbsp;is&nbsp;a&nbsp;convenience&nbsp;wrapper&nbsp;around&nbsp;CreatePart.&nbsp;It&nbsp;creates</span><br>
<span class="lineno"></span><span class="comment" id="3535025">//&nbsp;a&nbsp;new&nbsp;form-data&nbsp;header&nbsp;with&nbsp;the&nbsp;provided&nbsp;field&nbsp;name&nbsp;and&nbsp;file&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3535095">func</span>&nbsp;<span class="op" id="3535100">(</span><span class="ident" id="3535101">w</span>&nbsp;<span class="op" id="3535103">*</span><span class="ident" id="3535104">Writer</span><span class="op" id="3535110">)</span>&nbsp;<span class="ident" id="3535112">CreateFormFile</span><span class="op" id="3535126">(</span><span class="ident" id="3535127">fieldname</span><span class="op" id="3535136">,</span>&nbsp;<span class="ident" id="3535138">filename</span>&nbsp;<span class="builtintype" id="3535147">string</span><span class="op" id="3535153">)</span>&nbsp;<span class="op" id="3535155">(</span><span class="ident" id="3535156">io</span><span class="op" id="3535158">.</span><span class="ident" id="3535159">Writer</span><span class="op" id="3535165">,</span>&nbsp;<span class="builtintype" id="3535167">error</span><span class="op" id="3535172">)</span>&nbsp;<span class="op" id="3535174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535177">h</span>&nbsp;<span class="op" id="3535179">:=</span>&nbsp;<span class="builtinfunc" id="3535182">make</span><span class="op" id="3535186">(</span><span class="ident" id="3535187">textproto</span><span class="op" id="3535196">.</span><span class="ident" id="3535197">MIMEHeader</span><span class="op" id="3535207">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535210">h</span><span class="op" id="3535211">.</span><span class="ident" id="3535212">Set</span><span class="op" id="3535215">(</span><span class="string" id="3535216">&#34;Content-Disposition&#34;</span><span class="op" id="3535237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535241">fmt</span><span class="op" id="3535244">.</span><span class="ident" id="3535245">Sprintf</span><span class="op" id="3535252">(</span><span class="string" id="3535253">`form-data;&nbsp;name=&#34;%s&#34;;&nbsp;filename=&#34;%s&#34;`</span><span class="op" id="3535290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535295">escapeQuotes</span><span class="op" id="3535307">(</span><span class="ident" id="3535308">fieldname</span><span class="op" id="3535317">)</span><span class="op" id="3535318">,</span>&nbsp;<span class="ident" id="3535320">escapeQuotes</span><span class="op" id="3535332">(</span><span class="ident" id="3535333">filename</span><span class="op" id="3535341">)</span><span class="op" id="3535342">)</span><span class="op" id="3535343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535346">h</span><span class="op" id="3535347">.</span><span class="ident" id="3535348">Set</span><span class="op" id="3535351">(</span><span class="string" id="3535352">&#34;Content-Type&#34;</span><span class="op" id="3535366">,</span>&nbsp;<span class="string" id="3535368">&#34;application/octet-stream&#34;</span><span class="op" id="3535394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535397">return</span>&nbsp;<span class="ident" id="3535404">w</span><span class="op" id="3535405">.</span><span class="ident" id="3535406">CreatePart</span><span class="op" id="3535416">(</span><span class="ident" id="3535417">h</span><span class="op" id="3535418">)</span><br>
<span class="lineno">130</span><span class="op" id="3535420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3535423">//&nbsp;CreateFormField&nbsp;calls&nbsp;CreatePart&nbsp;with&nbsp;a&nbsp;header&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3535483">//&nbsp;given&nbsp;field&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3535504">func</span>&nbsp;<span class="op" id="3535509">(</span><span class="ident" id="3535510">w</span>&nbsp;<span class="op" id="3535512">*</span><span class="ident" id="3535513">Writer</span><span class="op" id="3535519">)</span>&nbsp;<span class="ident" id="3535521">CreateFormField</span><span class="op" id="3535536">(</span><span class="ident" id="3535537">fieldname</span>&nbsp;<span class="builtintype" id="3535547">string</span><span class="op" id="3535553">)</span>&nbsp;<span class="op" id="3535555">(</span><span class="ident" id="3535556">io</span><span class="op" id="3535558">.</span><span class="ident" id="3535559">Writer</span><span class="op" id="3535565">,</span>&nbsp;<span class="builtintype" id="3535567">error</span><span class="op" id="3535572">)</span>&nbsp;<span class="op" id="3535574">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535577">h</span>&nbsp;<span class="op" id="3535579">:=</span>&nbsp;<span class="builtinfunc" id="3535582">make</span><span class="op" id="3535586">(</span><span class="ident" id="3535587">textproto</span><span class="op" id="3535596">.</span><span class="ident" id="3535597">MIMEHeader</span><span class="op" id="3535607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535610">h</span><span class="op" id="3535611">.</span><span class="ident" id="3535612">Set</span><span class="op" id="3535615">(</span><span class="string" id="3535616">&#34;Content-Disposition&#34;</span><span class="op" id="3535637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535641">fmt</span><span class="op" id="3535644">.</span><span class="ident" id="3535645">Sprintf</span><span class="op" id="3535652">(</span><span class="string" id="3535653">`form-data;&nbsp;name=&#34;%s&#34;`</span><span class="op" id="3535675">,</span>&nbsp;<span class="ident" id="3535677">escapeQuotes</span><span class="op" id="3535689">(</span><span class="ident" id="3535690">fieldname</span><span class="op" id="3535699">)</span><span class="op" id="3535700">)</span><span class="op" id="3535701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535704">return</span>&nbsp;<span class="ident" id="3535711">w</span><span class="op" id="3535712">.</span><span class="ident" id="3535713">CreatePart</span><span class="op" id="3535723">(</span><span class="ident" id="3535724">h</span><span class="op" id="3535725">)</span><br>
<span class="lineno"></span><span class="op" id="3535727">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="3535730">//&nbsp;WriteField&nbsp;calls&nbsp;CreateFormField&nbsp;and&nbsp;then&nbsp;writes&nbsp;the&nbsp;given&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3535799">func</span>&nbsp;<span class="op" id="3535804">(</span><span class="ident" id="3535805">w</span>&nbsp;<span class="op" id="3535807">*</span><span class="ident" id="3535808">Writer</span><span class="op" id="3535814">)</span>&nbsp;<span class="ident" id="3535816">WriteField</span><span class="op" id="3535826">(</span><span class="ident" id="3535827">fieldname</span><span class="op" id="3535836">,</span>&nbsp;<span class="ident" id="3535838">value</span>&nbsp;<span class="builtintype" id="3535844">string</span><span class="op" id="3535850">)</span>&nbsp;<span class="builtintype" id="3535852">error</span>&nbsp;<span class="op" id="3535858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535861">p</span><span class="op" id="3535862">,</span>&nbsp;<span class="ident" id="3535864">err</span>&nbsp;<span class="op" id="3535868">:=</span>&nbsp;<span class="ident" id="3535871">w</span><span class="op" id="3535872">.</span><span class="ident" id="3535873">CreateFormField</span><span class="op" id="3535888">(</span><span class="ident" id="3535889">fieldname</span><span class="op" id="3535898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535901">if</span>&nbsp;<span class="ident" id="3535904">err</span>&nbsp;<span class="op" id="3535908">!=</span>&nbsp;<span class="ident" id="3535911">nil</span>&nbsp;<span class="op" id="3535915">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535919">return</span>&nbsp;<span class="ident" id="3535926">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535934">_</span><span class="op" id="3535935">,</span>&nbsp;<span class="ident" id="3535937">err</span>&nbsp;<span class="op" id="3535941">=</span>&nbsp;<span class="ident" id="3535943">p</span><span class="op" id="3535944">.</span><span class="ident" id="3535945">Write</span><span class="op" id="3535950">(</span><span class="op" id="3535951">[</span><span class="op" id="3535952">]</span><span class="builtintype" id="3535953">byte</span><span class="op" id="3535957">(</span><span class="ident" id="3535958">value</span><span class="op" id="3535963">)</span><span class="op" id="3535964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535967">return</span>&nbsp;<span class="ident" id="3535974">err</span><br>
<span class="lineno"></span><span class="op" id="3535978">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="3535981">//&nbsp;Close&nbsp;finishes&nbsp;the&nbsp;multipart&nbsp;message&nbsp;and&nbsp;writes&nbsp;the&nbsp;trailing</span><br>
<span class="lineno"></span><span class="comment" id="3536045">//&nbsp;boundary&nbsp;end&nbsp;line&nbsp;to&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="3536081">func</span>&nbsp;<span class="op" id="3536086">(</span><span class="ident" id="3536087">w</span>&nbsp;<span class="op" id="3536089">*</span><span class="ident" id="3536090">Writer</span><span class="op" id="3536096">)</span>&nbsp;<span class="ident" id="3536098">Close</span><span class="op" id="3536103">(</span><span class="op" id="3536104">)</span>&nbsp;<span class="builtintype" id="3536106">error</span>&nbsp;<span class="op" id="3536112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536115">if</span>&nbsp;<span class="ident" id="3536118">w</span><span class="op" id="3536119">.</span><span class="ident" id="3536120">lastpart</span>&nbsp;<span class="op" id="3536129">!=</span>&nbsp;<span class="ident" id="3536132">nil</span>&nbsp;<span class="op" id="3536136">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536140">if</span>&nbsp;<span class="ident" id="3536143">err</span>&nbsp;<span class="op" id="3536147">:=</span>&nbsp;<span class="ident" id="3536150">w</span><span class="op" id="3536151">.</span><span class="ident" id="3536152">lastpart</span><span class="op" id="3536160">.</span><span class="builtinfunc" id="3536161">close</span><span class="op" id="3536166">(</span><span class="op" id="3536167">)</span><span class="op" id="3536168">;</span>&nbsp;<span class="ident" id="3536170">err</span>&nbsp;<span class="op" id="3536174">!=</span>&nbsp;<span class="ident" id="3536177">nil</span>&nbsp;<span class="op" id="3536181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536186">return</span>&nbsp;<span class="ident" id="3536193">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536203">w</span><span class="op" id="3536204">.</span><span class="ident" id="3536205">lastpart</span>&nbsp;<span class="op" id="3536214">=</span>&nbsp;<span class="ident" id="3536216">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536221">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536224">_</span><span class="op" id="3536225">,</span>&nbsp;<span class="ident" id="3536227">err</span>&nbsp;<span class="op" id="3536231">:=</span>&nbsp;<span class="ident" id="3536234">fmt</span><span class="op" id="3536237">.</span><span class="ident" id="3536238">Fprintf</span><span class="op" id="3536245">(</span><span class="ident" id="3536246">w</span><span class="op" id="3536247">.</span><span class="ident" id="3536248">w</span><span class="op" id="3536249">,</span>&nbsp;<span class="string" id="3536251">&#34;\r\n--%s--\r\n&#34;</span><span class="op" id="3536267">,</span>&nbsp;<span class="ident" id="3536269">w</span><span class="op" id="3536270">.</span><span class="ident" id="3536271">boundary</span><span class="op" id="3536279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536282">return</span>&nbsp;<span class="ident" id="3536289">err</span><br>
<span class="lineno"></span><span class="op" id="3536293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3536296">type</span>&nbsp;<span class="ident" id="3536301">part</span>&nbsp;<span class="keyword" id="3536306">struct</span>&nbsp;<span class="op" id="3536313">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536316">mw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3536323">*</span><span class="ident" id="3536324">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536332">closed</span>&nbsp;<span class="builtintype" id="3536339">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536345">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3536352">error</span>&nbsp;<span class="comment" id="3536358">//&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;writing</span><br>
<span class="lineno"></span><span class="op" id="3536394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="3536397">func</span>&nbsp;<span class="op" id="3536402">(</span><span class="ident" id="3536403">p</span>&nbsp;<span class="op" id="3536405">*</span><span class="ident" id="3536406">part</span><span class="op" id="3536410">)</span>&nbsp;<span class="builtinfunc" id="3536412">close</span><span class="op" id="3536417">(</span><span class="op" id="3536418">)</span>&nbsp;<span class="builtintype" id="3536420">error</span>&nbsp;<span class="op" id="3536426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536429">p</span><span class="op" id="3536430">.</span><span class="ident" id="3536431">closed</span>&nbsp;<span class="op" id="3536438">=</span>&nbsp;<span class="builtintype" id="3536440">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536446">return</span>&nbsp;<span class="ident" id="3536453">p</span><span class="op" id="3536454">.</span><span class="ident" id="3536455">we</span><br>
<span class="lineno"></span><span class="op" id="3536458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="3536461">func</span>&nbsp;<span class="op" id="3536466">(</span><span class="ident" id="3536467">p</span>&nbsp;<span class="op" id="3536469">*</span><span class="ident" id="3536470">part</span><span class="op" id="3536474">)</span>&nbsp;<span class="ident" id="3536476">Write</span><span class="op" id="3536481">(</span><span class="ident" id="3536482">d</span>&nbsp;<span class="op" id="3536484">[</span><span class="op" id="3536485">]</span><span class="builtintype" id="3536486">byte</span><span class="op" id="3536490">)</span>&nbsp;<span class="op" id="3536492">(</span><span class="ident" id="3536493">n</span>&nbsp;<span class="builtintype" id="3536495">int</span><span class="op" id="3536498">,</span>&nbsp;<span class="ident" id="3536500">err</span>&nbsp;<span class="builtintype" id="3536504">error</span><span class="op" id="3536509">)</span>&nbsp;<span class="op" id="3536511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536514">if</span>&nbsp;<span class="ident" id="3536517">p</span><span class="op" id="3536518">.</span><span class="ident" id="3536519">closed</span>&nbsp;<span class="op" id="3536526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536530">return</span>&nbsp;<span class="num" id="3536537">0</span><span class="op" id="3536538">,</span>&nbsp;<span class="ident" id="3536540">errors</span><span class="op" id="3536546">.</span><span class="ident" id="3536547">New</span><span class="op" id="3536550">(</span><span class="string" id="3536551">&#34;multipart:&nbsp;can&#39;t&nbsp;write&nbsp;to&nbsp;finished&nbsp;part&#34;</span><span class="op" id="3536592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536598">n</span><span class="op" id="3536599">,</span>&nbsp;<span class="ident" id="3536601">err</span>&nbsp;<span class="op" id="3536605">=</span>&nbsp;<span class="ident" id="3536607">p</span><span class="op" id="3536608">.</span><span class="ident" id="3536609">mw</span><span class="op" id="3536611">.</span><span class="ident" id="3536612">w</span><span class="op" id="3536613">.</span><span class="ident" id="3536614">Write</span><span class="op" id="3536619">(</span><span class="ident" id="3536620">d</span><span class="op" id="3536621">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536624">if</span>&nbsp;<span class="ident" id="3536627">err</span>&nbsp;<span class="op" id="3536631">!=</span>&nbsp;<span class="ident" id="3536634">nil</span>&nbsp;<span class="op" id="3536638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536642">p</span><span class="op" id="3536643">.</span><span class="ident" id="3536644">we</span>&nbsp;<span class="op" id="3536647">=</span>&nbsp;<span class="ident" id="3536649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536657">return</span><br>
<span class="lineno"></span><span class="op" id="3536664">}</span>
</div>
</body>
</html>
