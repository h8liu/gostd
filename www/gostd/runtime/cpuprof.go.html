<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1841030">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1841086">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1841140">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1841191">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1841209">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1841260">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1841307">//</span><br>
<span class="lineno"></span><span class="comment" id="1841310">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1841376">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1841447">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1841516">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1841555">//</span><br>
<span class="lineno"></span><span class="comment" id="1841558">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1841632">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1841704">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1841773">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1841845">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1841912">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1841988">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1842060">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1842134">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1842212">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1842290">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1842370">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1842441">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1842519">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1842592">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1842614">//</span><br>
<span class="lineno">30</span><span class="comment" id="1842617">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1842689">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1842770">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1842847">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1842917">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1842990">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1843066">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1843140">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1843221">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1843305">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1843387">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1843426">//</span><br>
<span class="lineno"></span><span class="comment" id="1843429">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1843490">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1843568">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1843634">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1843707">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1843781">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1843854">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1843930">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1843995">package</span>&nbsp;<span class="ident" id="1844003">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1844012">import</span>&nbsp;<span class="string" id="1844019">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1844029">const</span>&nbsp;<span class="op" id="1844035">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844038">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1844054">=</span>&nbsp;<span class="num" id="1844056">1</span>&nbsp;<span class="op" id="1844058">&lt;&lt;</span>&nbsp;<span class="num" id="1844061">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844065">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1844081">=</span>&nbsp;<span class="num" id="1844083">1</span>&nbsp;<span class="op" id="1844085">&lt;&lt;</span>&nbsp;<span class="num" id="1844088">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844092">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1844108">=</span>&nbsp;<span class="num" id="1844110">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844113">maxCPUProfStack</span>&nbsp;<span class="op" id="1844129">=</span>&nbsp;<span class="num" id="1844131">64</span><br>
<span class="lineno">60</span><span class="op" id="1844134">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1844137">type</span>&nbsp;<span class="ident" id="1844142">cpuprofEntry</span>&nbsp;<span class="keyword" id="1844155">struct</span>&nbsp;<span class="op" id="1844162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844165">count</span>&nbsp;<span class="builtintype" id="1844171">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844180">depth</span>&nbsp;<span class="builtintype" id="1844186">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844195">stack</span>&nbsp;<span class="op" id="1844201">[</span><span class="ident" id="1844202">maxCPUProfStack</span><span class="op" id="1844217">]</span><span class="builtintype" id="1844218">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1844226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1844229">type</span>&nbsp;<span class="ident" id="1844234">cpuProfile</span>&nbsp;<span class="keyword" id="1844245">struct</span>&nbsp;<span class="op" id="1844252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844255">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1844262">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1844270">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844290">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1844297">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1844305">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844330">count</span>&nbsp;&nbsp;<span class="builtintype" id="1844337">uintptr</span>&nbsp;<span class="comment" id="1844345">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844360">evicts</span>&nbsp;<span class="builtintype" id="1844367">uintptr</span>&nbsp;<span class="comment" id="1844375">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844394">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1844401">uintptr</span>&nbsp;<span class="comment" id="1844409">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844448">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844480">hash</span>&nbsp;<span class="op" id="1844485">[</span><span class="ident" id="1844486">numBuckets</span><span class="op" id="1844496">]</span><span class="keyword" id="1844497">struct</span>&nbsp;<span class="op" id="1844504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844508">entry</span>&nbsp;<span class="op" id="1844514">[</span><span class="ident" id="1844515">assoc</span><span class="op" id="1844520">]</span><span class="ident" id="1844521">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1844535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844539">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844576">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844626">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844676">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1844684">[</span><span class="num" id="1844685">2</span><span class="op" id="1844686">]</span><span class="op" id="1844687">[</span><span class="ident" id="1844688">logSize</span>&nbsp;<span class="op" id="1844696">/</span>&nbsp;<span class="num" id="1844698">2</span><span class="op" id="1844699">]</span><span class="builtintype" id="1844700">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844709">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1844717">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844726">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1844734">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844741">handoff</span>&nbsp;<span class="builtintype" id="1844749">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844758">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844776">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1844827">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844867">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1844876">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844884">wholding</span>&nbsp;<span class="builtintype" id="1844893">bool</span>&nbsp;<span class="comment" id="1844898">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844939">flushing</span>&nbsp;<span class="builtintype" id="1844948">bool</span>&nbsp;<span class="comment" id="1844953">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1844995">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1845004">bool</span>&nbsp;<span class="comment" id="1845009">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1845057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1845060">var</span>&nbsp;<span class="op" id="1845064">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845067">cpuprofLock</span>&nbsp;<span class="ident" id="1845079">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845086">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1845098">*</span><span class="ident" id="1845099">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845112">eod</span>&nbsp;<span class="op" id="1845116">=</span>&nbsp;<span class="op" id="1845118">[</span><span class="num" id="1845119">3</span><span class="op" id="1845120">]</span><span class="builtintype" id="1845121">uintptr</span><span class="op" id="1845128">{</span><span class="num" id="1845129">0</span><span class="op" id="1845130">,</span>&nbsp;<span class="num" id="1845132">1</span><span class="op" id="1845133">,</span>&nbsp;<span class="num" id="1845135">0</span><span class="op" id="1845136">}</span><br>
<span class="lineno"></span><span class="op" id="1845138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1845141">func</span>&nbsp;<span class="ident" id="1845146">setcpuprofilerate_m</span><span class="op" id="1845165">(</span><span class="op" id="1845166">)</span>&nbsp;<span class="comment" id="1845168">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1845179">func</span>&nbsp;<span class="ident" id="1845184">setcpuprofilerate</span><span class="op" id="1845201">(</span><span class="ident" id="1845202">hz</span>&nbsp;<span class="builtintype" id="1845205">int32</span><span class="op" id="1845210">)</span>&nbsp;<span class="op" id="1845212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845215">g</span>&nbsp;<span class="op" id="1845217">:=</span>&nbsp;<span class="ident" id="1845220">getg</span><span class="op" id="1845224">(</span><span class="op" id="1845225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845228">g</span><span class="op" id="1845229">.</span><span class="ident" id="1845230">m</span><span class="op" id="1845231">.</span><span class="ident" id="1845232">scalararg</span><span class="op" id="1845241">[</span><span class="num" id="1845242">0</span><span class="op" id="1845243">]</span>&nbsp;<span class="op" id="1845245">=</span>&nbsp;<span class="builtintype" id="1845247">uintptr</span><span class="op" id="1845254">(</span><span class="ident" id="1845255">hz</span><span class="op" id="1845257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845260">onM</span><span class="op" id="1845263">(</span><span class="ident" id="1845264">setcpuprofilerate_m</span><span class="op" id="1845283">)</span><br>
<span class="lineno">110</span><span class="op" id="1845285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1845288">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1845344">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1845402">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1845441">func</span>&nbsp;<span class="ident" id="1845446">lostProfileData</span><span class="op" id="1845461">(</span><span class="op" id="1845462">)</span>&nbsp;<span class="op" id="1845464">{</span><span class="op" id="1845465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1845468">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1845543">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1845597">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1845680">//</span><br>
<span class="lineno"></span><span class="comment" id="1845683">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1845739">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1845805">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1845836">func</span>&nbsp;<span class="ident" id="1845841">SetCPUProfileRate</span><span class="op" id="1845858">(</span><span class="ident" id="1845859">hz</span>&nbsp;<span class="builtintype" id="1845862">int</span><span class="op" id="1845865">)</span>&nbsp;<span class="op" id="1845867">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1845870">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1845908">if</span>&nbsp;<span class="ident" id="1845911">hz</span>&nbsp;<span class="op" id="1845914">&lt;</span>&nbsp;<span class="num" id="1845916">0</span>&nbsp;<span class="op" id="1845918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845922">hz</span>&nbsp;<span class="op" id="1845925">=</span>&nbsp;<span class="num" id="1845927">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1845930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1845933">if</span>&nbsp;<span class="ident" id="1845936">hz</span>&nbsp;<span class="op" id="1845939">&gt;</span>&nbsp;<span class="num" id="1845941">1000000</span>&nbsp;<span class="op" id="1845949">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845953">hz</span>&nbsp;<span class="op" id="1845956">=</span>&nbsp;<span class="num" id="1845958">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1845967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1845971">lock</span><span class="op" id="1845975">(</span><span class="op" id="1845976">&amp;</span><span class="ident" id="1845977">cpuprofLock</span><span class="op" id="1845988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1845991">if</span>&nbsp;<span class="ident" id="1845994">hz</span>&nbsp;<span class="op" id="1845997">&gt;</span>&nbsp;<span class="num" id="1845999">0</span>&nbsp;<span class="op" id="1846001">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1846005">if</span>&nbsp;<span class="ident" id="1846008">cpuprof</span>&nbsp;<span class="op" id="1846016">==</span>&nbsp;<span class="ident" id="1846019">nil</span>&nbsp;<span class="op" id="1846023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846028">cpuprof</span>&nbsp;<span class="op" id="1846036">=</span>&nbsp;<span class="op" id="1846038">(</span><span class="op" id="1846039">*</span><span class="ident" id="1846040">cpuProfile</span><span class="op" id="1846050">)</span><span class="op" id="1846051">(</span><span class="ident" id="1846052">sysAlloc</span><span class="op" id="1846060">(</span><span class="ident" id="1846061">unsafe</span><span class="op" id="1846067">.</span><span class="ident" id="1846068">Sizeof</span><span class="op" id="1846074">(</span><span class="ident" id="1846075">cpuProfile</span><span class="op" id="1846085">{</span><span class="op" id="1846086">}</span><span class="op" id="1846087">)</span><span class="op" id="1846088">,</span>&nbsp;<span class="op" id="1846090">&amp;</span><span class="ident" id="1846091">memstats</span><span class="op" id="1846099">.</span><span class="ident" id="1846100">other_sys</span><span class="op" id="1846109">)</span><span class="op" id="1846110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1846115">if</span>&nbsp;<span class="ident" id="1846118">cpuprof</span>&nbsp;<span class="op" id="1846126">==</span>&nbsp;<span class="ident" id="1846129">nil</span>&nbsp;<span class="op" id="1846133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1846139">print</span><span class="op" id="1846144">(</span><span class="string" id="1846145">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1846194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846200">unlock</span><span class="op" id="1846206">(</span><span class="op" id="1846207">&amp;</span><span class="ident" id="1846208">cpuprofLock</span><span class="op" id="1846219">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1846225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1846235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1846239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1846243">if</span>&nbsp;<span class="ident" id="1846246">cpuprof</span><span class="op" id="1846253">.</span><span class="ident" id="1846254">on</span>&nbsp;<span class="op" id="1846257">||</span>&nbsp;<span class="ident" id="1846260">cpuprof</span><span class="op" id="1846267">.</span><span class="ident" id="1846268">handoff</span>&nbsp;<span class="op" id="1846276">!=</span>&nbsp;<span class="num" id="1846279">0</span>&nbsp;<span class="op" id="1846281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1846286">print</span><span class="op" id="1846291">(</span><span class="string" id="1846292">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1846369">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846374">unlock</span><span class="op" id="1846380">(</span><span class="op" id="1846381">&amp;</span><span class="ident" id="1846382">cpuprofLock</span><span class="op" id="1846393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1846398">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1846407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846412">cpuprof</span><span class="op" id="1846419">.</span><span class="ident" id="1846420">on</span>&nbsp;<span class="op" id="1846423">=</span>&nbsp;<span class="builtintype" id="1846425">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1846432">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1846465">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846555">p</span>&nbsp;<span class="op" id="1846557">:=</span>&nbsp;<span class="op" id="1846560">&amp;</span><span class="ident" id="1846561">cpuprof</span><span class="op" id="1846568">.</span><span class="ident" id="1846569">log</span><span class="op" id="1846572">[</span><span class="num" id="1846573">0</span><span class="op" id="1846574">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846578">p</span><span class="op" id="1846579">[</span><span class="num" id="1846580">0</span><span class="op" id="1846581">]</span>&nbsp;<span class="op" id="1846583">=</span>&nbsp;<span class="num" id="1846585">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1846603">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846625">p</span><span class="op" id="1846626">[</span><span class="num" id="1846627">1</span><span class="op" id="1846628">]</span>&nbsp;<span class="op" id="1846630">=</span>&nbsp;<span class="num" id="1846632">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1846650">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846672">p</span><span class="op" id="1846673">[</span><span class="num" id="1846674">2</span><span class="op" id="1846675">]</span>&nbsp;<span class="op" id="1846677">=</span>&nbsp;<span class="num" id="1846679">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1846697">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846717">p</span><span class="op" id="1846718">[</span><span class="num" id="1846719">3</span><span class="op" id="1846720">]</span>&nbsp;<span class="op" id="1846722">=</span>&nbsp;<span class="builtintype" id="1846724">uintptr</span><span class="op" id="1846731">(</span><span class="num" id="1846732">1e6</span>&nbsp;<span class="op" id="1846736">/</span>&nbsp;<span class="ident" id="1846738">hz</span><span class="op" id="1846740">)</span>&nbsp;<span class="comment" id="1846742">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846769">p</span><span class="op" id="1846770">[</span><span class="num" id="1846771">4</span><span class="op" id="1846772">]</span>&nbsp;<span class="op" id="1846774">=</span>&nbsp;<span class="num" id="1846776">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846780">cpuprof</span><span class="op" id="1846787">.</span><span class="ident" id="1846788">nlog</span>&nbsp;<span class="op" id="1846793">=</span>&nbsp;<span class="num" id="1846795">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846799">cpuprof</span><span class="op" id="1846806">.</span><span class="ident" id="1846807">toggle</span>&nbsp;<span class="op" id="1846814">=</span>&nbsp;<span class="num" id="1846816">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846820">cpuprof</span><span class="op" id="1846827">.</span><span class="ident" id="1846828">wholding</span>&nbsp;<span class="op" id="1846837">=</span>&nbsp;<span class="builtintype" id="1846839">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846847">cpuprof</span><span class="op" id="1846854">.</span><span class="ident" id="1846855">wtoggle</span>&nbsp;<span class="op" id="1846863">=</span>&nbsp;<span class="num" id="1846865">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846869">cpuprof</span><span class="op" id="1846876">.</span><span class="ident" id="1846877">flushing</span>&nbsp;<span class="op" id="1846886">=</span>&nbsp;<span class="builtintype" id="1846888">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846896">cpuprof</span><span class="op" id="1846903">.</span><span class="ident" id="1846904">eodSent</span>&nbsp;<span class="op" id="1846912">=</span>&nbsp;<span class="builtintype" id="1846914">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846922">noteclear</span><span class="op" id="1846931">(</span><span class="op" id="1846932">&amp;</span><span class="ident" id="1846933">cpuprof</span><span class="op" id="1846940">.</span><span class="ident" id="1846941">wait</span><span class="op" id="1846945">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1846950">setcpuprofilerate</span><span class="op" id="1846967">(</span><span class="builtintype" id="1846968">int32</span><span class="op" id="1846973">(</span><span class="ident" id="1846974">hz</span><span class="op" id="1846976">)</span><span class="op" id="1846977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1846980">}</span>&nbsp;<span class="keyword" id="1846982">else</span>&nbsp;<span class="keyword" id="1846987">if</span>&nbsp;<span class="ident" id="1846990">cpuprof</span>&nbsp;<span class="op" id="1846998">!=</span>&nbsp;<span class="ident" id="1847001">nil</span>&nbsp;<span class="op" id="1847005">&amp;&amp;</span>&nbsp;<span class="ident" id="1847008">cpuprof</span><span class="op" id="1847015">.</span><span class="ident" id="1847016">on</span>&nbsp;<span class="op" id="1847019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847023">setcpuprofilerate</span><span class="op" id="1847040">(</span><span class="num" id="1847041">0</span><span class="op" id="1847042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847046">cpuprof</span><span class="op" id="1847053">.</span><span class="ident" id="1847054">on</span>&nbsp;<span class="op" id="1847057">=</span>&nbsp;<span class="builtintype" id="1847059">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1847068">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1847141">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1847200">for</span>&nbsp;<span class="op" id="1847204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847209">n</span>&nbsp;<span class="op" id="1847211">:=</span>&nbsp;<span class="ident" id="1847214">cpuprof</span><span class="op" id="1847221">.</span><span class="ident" id="1847222">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1847233">if</span>&nbsp;<span class="ident" id="1847236">n</span><span class="op" id="1847237">&amp;</span><span class="num" id="1847238">0x80000000</span>&nbsp;<span class="op" id="1847249">!=</span>&nbsp;<span class="num" id="1847252">0</span>&nbsp;<span class="op" id="1847254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1847260">print</span><span class="op" id="1847265">(</span><span class="string" id="1847266">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1847303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1847308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1847313">if</span>&nbsp;<span class="ident" id="1847316">cas</span><span class="op" id="1847319">(</span><span class="op" id="1847320">&amp;</span><span class="ident" id="1847321">cpuprof</span><span class="op" id="1847328">.</span><span class="ident" id="1847329">handoff</span><span class="op" id="1847336">,</span>&nbsp;<span class="ident" id="1847338">n</span><span class="op" id="1847339">,</span>&nbsp;<span class="ident" id="1847341">n</span><span class="op" id="1847342">|</span><span class="num" id="1847343">0x80000000</span><span class="op" id="1847353">)</span>&nbsp;<span class="op" id="1847355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1847361">if</span>&nbsp;<span class="ident" id="1847364">n</span>&nbsp;<span class="op" id="1847366">==</span>&nbsp;<span class="num" id="1847369">0</span>&nbsp;<span class="op" id="1847371">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1847378">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847448">notewakeup</span><span class="op" id="1847458">(</span><span class="op" id="1847459">&amp;</span><span class="ident" id="1847460">cpuprof</span><span class="op" id="1847467">.</span><span class="ident" id="1847468">wait</span><span class="op" id="1847472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1847478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1847484">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1847493">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1847497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1847500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847503">unlock</span><span class="op" id="1847509">(</span><span class="op" id="1847510">&amp;</span><span class="ident" id="1847511">cpuprofLock</span><span class="op" id="1847522">)</span><br>
<span class="lineno"></span><span class="op" id="1847524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1847527">func</span>&nbsp;<span class="ident" id="1847532">cpuproftick</span><span class="op" id="1847543">(</span><span class="ident" id="1847544">pc</span>&nbsp;<span class="op" id="1847547">*</span><span class="builtintype" id="1847548">uintptr</span><span class="op" id="1847555">,</span>&nbsp;<span class="ident" id="1847557">n</span>&nbsp;<span class="builtintype" id="1847559">int32</span><span class="op" id="1847564">)</span>&nbsp;<span class="op" id="1847566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1847569">if</span>&nbsp;<span class="ident" id="1847572">n</span>&nbsp;<span class="op" id="1847574">&gt;</span>&nbsp;<span class="ident" id="1847576">maxCPUProfStack</span>&nbsp;<span class="op" id="1847592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847596">n</span>&nbsp;<span class="op" id="1847598">=</span>&nbsp;<span class="ident" id="1847600">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1847617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847620">s</span>&nbsp;<span class="op" id="1847622">:=</span>&nbsp;<span class="op" id="1847625">(</span><span class="op" id="1847626">*</span><span class="op" id="1847627">[</span><span class="ident" id="1847628">maxCPUProfStack</span><span class="op" id="1847643">]</span><span class="builtintype" id="1847644">uintptr</span><span class="op" id="1847651">)</span><span class="op" id="1847652">(</span><span class="ident" id="1847653">unsafe</span><span class="op" id="1847659">.</span><span class="ident" id="1847660">Pointer</span><span class="op" id="1847667">(</span><span class="ident" id="1847668">pc</span><span class="op" id="1847670">)</span><span class="op" id="1847671">)</span><span class="op" id="1847672">[</span><span class="op" id="1847673">:</span><span class="ident" id="1847674">n</span><span class="op" id="1847675">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1847678">cpuprof</span><span class="op" id="1847685">.</span><span class="ident" id="1847686">add</span><span class="op" id="1847689">(</span><span class="ident" id="1847690">s</span><span class="op" id="1847691">)</span><br>
<span class="lineno"></span><span class="op" id="1847693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1847696">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1847740">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1847808">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1847869">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1847939">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1847982">func</span>&nbsp;<span class="op" id="1847987">(</span><span class="ident" id="1847988">p</span>&nbsp;<span class="op" id="1847990">*</span><span class="ident" id="1847991">cpuProfile</span><span class="op" id="1848001">)</span>&nbsp;<span class="ident" id="1848003">add</span><span class="op" id="1848006">(</span><span class="ident" id="1848007">pc</span>&nbsp;<span class="op" id="1848010">[</span><span class="op" id="1848011">]</span><span class="builtintype" id="1848012">uintptr</span><span class="op" id="1848019">)</span>&nbsp;<span class="op" id="1848021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1848024">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848042">h</span>&nbsp;<span class="op" id="1848044">:=</span>&nbsp;<span class="builtintype" id="1848047">uintptr</span><span class="op" id="1848054">(</span><span class="num" id="1848055">0</span><span class="op" id="1848056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848059">for</span>&nbsp;<span class="ident" id="1848063">_</span><span class="op" id="1848064">,</span>&nbsp;<span class="ident" id="1848066">x</span>&nbsp;<span class="op" id="1848068">:=</span>&nbsp;<span class="keyword" id="1848071">range</span>&nbsp;<span class="ident" id="1848077">pc</span>&nbsp;<span class="op" id="1848080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848084">h</span>&nbsp;<span class="op" id="1848086">=</span>&nbsp;<span class="ident" id="1848088">h</span><span class="op" id="1848089">&lt;&lt;</span><span class="num" id="1848091">8</span>&nbsp;<span class="op" id="1848093">|</span>&nbsp;<span class="op" id="1848095">(</span><span class="ident" id="1848096">h</span>&nbsp;<span class="op" id="1848098">&gt;&gt;</span>&nbsp;<span class="op" id="1848101">(</span><span class="num" id="1848102">8</span>&nbsp;<span class="op" id="1848104">*</span>&nbsp;<span class="op" id="1848106">(</span><span class="ident" id="1848107">unsafe</span><span class="op" id="1848113">.</span><span class="ident" id="1848114">Sizeof</span><span class="op" id="1848120">(</span><span class="ident" id="1848121">h</span><span class="op" id="1848122">)</span>&nbsp;<span class="op" id="1848124">-</span>&nbsp;<span class="num" id="1848126">1</span><span class="op" id="1848127">)</span><span class="op" id="1848128">)</span><span class="op" id="1848129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848133">h</span>&nbsp;<span class="op" id="1848135">+=</span>&nbsp;<span class="ident" id="1848138">x</span><span class="op" id="1848139">*</span><span class="num" id="1848140">31</span>&nbsp;<span class="op" id="1848143">+</span>&nbsp;<span class="ident" id="1848145">x</span><span class="op" id="1848146">*</span><span class="num" id="1848147">7</span>&nbsp;<span class="op" id="1848149">+</span>&nbsp;<span class="ident" id="1848151">x</span><span class="op" id="1848152">*</span><span class="num" id="1848153">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848156">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848159">p</span><span class="op" id="1848160">.</span><span class="ident" id="1848161">count</span><span class="op" id="1848166">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1848171">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848223">b</span>&nbsp;<span class="op" id="1848225">:=</span>&nbsp;<span class="op" id="1848228">&amp;</span><span class="ident" id="1848229">p</span><span class="op" id="1848230">.</span><span class="ident" id="1848231">hash</span><span class="op" id="1848235">[</span><span class="ident" id="1848236">h</span><span class="op" id="1848237">%</span><span class="ident" id="1848238">numBuckets</span><span class="op" id="1848248">]</span><br>
<span class="lineno"></span><span class="ident" id="1848250">Assoc</span><span class="op" id="1848255">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848258">for</span>&nbsp;<span class="ident" id="1848262">i</span>&nbsp;<span class="op" id="1848264">:=</span>&nbsp;<span class="keyword" id="1848267">range</span>&nbsp;<span class="ident" id="1848273">b</span><span class="op" id="1848274">.</span><span class="ident" id="1848275">entry</span>&nbsp;<span class="op" id="1848281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848285">e</span>&nbsp;<span class="op" id="1848287">:=</span>&nbsp;<span class="op" id="1848290">&amp;</span><span class="ident" id="1848291">b</span><span class="op" id="1848292">.</span><span class="ident" id="1848293">entry</span><span class="op" id="1848298">[</span><span class="ident" id="1848299">i</span><span class="op" id="1848300">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848304">if</span>&nbsp;<span class="ident" id="1848307">e</span><span class="op" id="1848308">.</span><span class="ident" id="1848309">depth</span>&nbsp;<span class="op" id="1848315">!=</span>&nbsp;<span class="builtintype" id="1848318">uintptr</span><span class="op" id="1848325">(</span><span class="builtinfunc" id="1848326">len</span><span class="op" id="1848329">(</span><span class="ident" id="1848330">pc</span><span class="op" id="1848332">)</span><span class="op" id="1848333">)</span>&nbsp;<span class="op" id="1848335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848340">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848351">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848355">for</span>&nbsp;<span class="ident" id="1848359">j</span>&nbsp;<span class="op" id="1848361">:=</span>&nbsp;<span class="keyword" id="1848364">range</span>&nbsp;<span class="ident" id="1848370">pc</span>&nbsp;<span class="op" id="1848373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848378">if</span>&nbsp;<span class="ident" id="1848381">e</span><span class="op" id="1848382">.</span><span class="ident" id="1848383">stack</span><span class="op" id="1848388">[</span><span class="ident" id="1848389">j</span><span class="op" id="1848390">]</span>&nbsp;<span class="op" id="1848392">!=</span>&nbsp;<span class="ident" id="1848395">pc</span><span class="op" id="1848397">[</span><span class="ident" id="1848398">j</span><span class="op" id="1848399">]</span>&nbsp;<span class="op" id="1848401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848407">continue</span>&nbsp;<span class="ident" id="1848416">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848429">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848433">e</span><span class="op" id="1848434">.</span><span class="ident" id="1848435">count</span><span class="op" id="1848440">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848445">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1848457">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848494">var</span>&nbsp;<span class="ident" id="1848498">e</span>&nbsp;<span class="op" id="1848500">*</span><span class="ident" id="1848501">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848515">for</span>&nbsp;<span class="ident" id="1848519">i</span>&nbsp;<span class="op" id="1848521">:=</span>&nbsp;<span class="keyword" id="1848524">range</span>&nbsp;<span class="ident" id="1848530">b</span><span class="op" id="1848531">.</span><span class="ident" id="1848532">entry</span>&nbsp;<span class="op" id="1848538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848542">if</span>&nbsp;<span class="ident" id="1848545">e</span>&nbsp;<span class="op" id="1848547">==</span>&nbsp;<span class="ident" id="1848550">nil</span>&nbsp;<span class="op" id="1848554">||</span>&nbsp;<span class="ident" id="1848557">b</span><span class="op" id="1848558">.</span><span class="ident" id="1848559">entry</span><span class="op" id="1848564">[</span><span class="ident" id="1848565">i</span><span class="op" id="1848566">]</span><span class="op" id="1848567">.</span><span class="ident" id="1848568">count</span>&nbsp;<span class="op" id="1848574">&lt;</span>&nbsp;<span class="ident" id="1848576">e</span><span class="op" id="1848577">.</span><span class="ident" id="1848578">count</span>&nbsp;<span class="op" id="1848584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848589">e</span>&nbsp;<span class="op" id="1848591">=</span>&nbsp;<span class="op" id="1848593">&amp;</span><span class="ident" id="1848594">b</span><span class="op" id="1848595">.</span><span class="ident" id="1848596">entry</span><span class="op" id="1848601">[</span><span class="ident" id="1848602">i</span><span class="op" id="1848603">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848607">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848613">if</span>&nbsp;<span class="ident" id="1848616">e</span><span class="op" id="1848617">.</span><span class="ident" id="1848618">count</span>&nbsp;<span class="op" id="1848624">&gt;</span>&nbsp;<span class="num" id="1848626">0</span>&nbsp;<span class="op" id="1848628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848632">if</span>&nbsp;<span class="op" id="1848635">!</span><span class="ident" id="1848636">p</span><span class="op" id="1848637">.</span><span class="ident" id="1848638">evict</span><span class="op" id="1848643">(</span><span class="ident" id="1848644">e</span><span class="op" id="1848645">)</span>&nbsp;<span class="op" id="1848647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1848652">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848701">p</span><span class="op" id="1848702">.</span><span class="ident" id="1848703">lost</span><span class="op" id="1848707">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1848713">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848726">p</span><span class="op" id="1848727">.</span><span class="ident" id="1848728">evicts</span><span class="op" id="1848734">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1848738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1848742">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848777">e</span><span class="op" id="1848778">.</span><span class="ident" id="1848779">depth</span>&nbsp;<span class="op" id="1848785">=</span>&nbsp;<span class="builtintype" id="1848787">uintptr</span><span class="op" id="1848794">(</span><span class="builtinfunc" id="1848795">len</span><span class="op" id="1848798">(</span><span class="ident" id="1848799">pc</span><span class="op" id="1848801">)</span><span class="op" id="1848802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1848805">e</span><span class="op" id="1848806">.</span><span class="ident" id="1848807">count</span>&nbsp;<span class="op" id="1848813">=</span>&nbsp;<span class="num" id="1848815">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1848818">copy</span><span class="op" id="1848822">(</span><span class="ident" id="1848823">e</span><span class="op" id="1848824">.</span><span class="ident" id="1848825">stack</span><span class="op" id="1848830">[</span><span class="op" id="1848831">:</span><span class="op" id="1848832">]</span><span class="op" id="1848833">,</span>&nbsp;<span class="ident" id="1848835">pc</span><span class="op" id="1848837">)</span><br>
<span class="lineno"></span><span class="op" id="1848839">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1848842">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1848903">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1848964">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1849027">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1849086">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1849144">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1849185">func</span>&nbsp;<span class="op" id="1849190">(</span><span class="ident" id="1849191">p</span>&nbsp;<span class="op" id="1849193">*</span><span class="ident" id="1849194">cpuProfile</span><span class="op" id="1849204">)</span>&nbsp;<span class="ident" id="1849206">evict</span><span class="op" id="1849211">(</span><span class="ident" id="1849212">e</span>&nbsp;<span class="op" id="1849214">*</span><span class="ident" id="1849215">cpuprofEntry</span><span class="op" id="1849227">)</span>&nbsp;<span class="builtintype" id="1849229">bool</span>&nbsp;<span class="op" id="1849234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849237">d</span>&nbsp;<span class="op" id="1849239">:=</span>&nbsp;<span class="ident" id="1849242">e</span><span class="op" id="1849243">.</span><span class="ident" id="1849244">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849251">nslot</span>&nbsp;<span class="op" id="1849257">:=</span>&nbsp;<span class="ident" id="1849260">d</span>&nbsp;<span class="op" id="1849262">+</span>&nbsp;<span class="num" id="1849264">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849267">log</span>&nbsp;<span class="op" id="1849271">:=</span>&nbsp;<span class="op" id="1849274">&amp;</span><span class="ident" id="1849275">p</span><span class="op" id="1849276">.</span><span class="ident" id="1849277">log</span><span class="op" id="1849280">[</span><span class="ident" id="1849281">p</span><span class="op" id="1849282">.</span><span class="ident" id="1849283">toggle</span><span class="op" id="1849289">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849292">if</span>&nbsp;<span class="ident" id="1849295">p</span><span class="op" id="1849296">.</span><span class="ident" id="1849297">nlog</span><span class="op" id="1849301">+</span><span class="ident" id="1849302">nslot</span>&nbsp;<span class="op" id="1849308">&gt;</span>&nbsp;<span class="builtintype" id="1849310">uintptr</span><span class="op" id="1849317">(</span><span class="builtinfunc" id="1849318">len</span><span class="op" id="1849321">(</span><span class="ident" id="1849322">p</span><span class="op" id="1849323">.</span><span class="ident" id="1849324">log</span><span class="op" id="1849327">[</span><span class="num" id="1849328">0</span><span class="op" id="1849329">]</span><span class="op" id="1849330">)</span><span class="op" id="1849331">)</span>&nbsp;<span class="op" id="1849333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849337">if</span>&nbsp;<span class="op" id="1849340">!</span><span class="ident" id="1849341">p</span><span class="op" id="1849342">.</span><span class="ident" id="1849343">flushlog</span><span class="op" id="1849351">(</span><span class="op" id="1849352">)</span>&nbsp;<span class="op" id="1849354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849359">return</span>&nbsp;<span class="builtintype" id="1849366">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1849374">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849378">log</span>&nbsp;<span class="op" id="1849382">=</span>&nbsp;<span class="op" id="1849384">&amp;</span><span class="ident" id="1849385">p</span><span class="op" id="1849386">.</span><span class="ident" id="1849387">log</span><span class="op" id="1849390">[</span><span class="ident" id="1849391">p</span><span class="op" id="1849392">.</span><span class="ident" id="1849393">toggle</span><span class="op" id="1849399">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1849402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849406">q</span>&nbsp;<span class="op" id="1849408">:=</span>&nbsp;<span class="ident" id="1849411">p</span><span class="op" id="1849412">.</span><span class="ident" id="1849413">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849419">log</span><span class="op" id="1849422">[</span><span class="ident" id="1849423">q</span><span class="op" id="1849424">]</span>&nbsp;<span class="op" id="1849426">=</span>&nbsp;<span class="ident" id="1849428">e</span><span class="op" id="1849429">.</span><span class="ident" id="1849430">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849437">q</span><span class="op" id="1849438">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849442">log</span><span class="op" id="1849445">[</span><span class="ident" id="1849446">q</span><span class="op" id="1849447">]</span>&nbsp;<span class="op" id="1849449">=</span>&nbsp;<span class="ident" id="1849451">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849454">q</span><span class="op" id="1849455">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1849459">copy</span><span class="op" id="1849463">(</span><span class="ident" id="1849464">log</span><span class="op" id="1849467">[</span><span class="ident" id="1849468">q</span><span class="op" id="1849469">:</span><span class="op" id="1849470">]</span><span class="op" id="1849471">,</span>&nbsp;<span class="ident" id="1849473">e</span><span class="op" id="1849474">.</span><span class="ident" id="1849475">stack</span><span class="op" id="1849480">[</span><span class="op" id="1849481">:</span><span class="ident" id="1849482">d</span><span class="op" id="1849483">]</span><span class="op" id="1849484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849487">q</span>&nbsp;<span class="op" id="1849489">+=</span>&nbsp;<span class="ident" id="1849492">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849495">p</span><span class="op" id="1849496">.</span><span class="ident" id="1849497">nlog</span>&nbsp;<span class="op" id="1849502">=</span>&nbsp;<span class="ident" id="1849504">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849507">e</span><span class="op" id="1849508">.</span><span class="ident" id="1849509">count</span>&nbsp;<span class="op" id="1849515">=</span>&nbsp;<span class="num" id="1849517">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849520">return</span>&nbsp;<span class="builtintype" id="1849527">true</span><br>
<span class="lineno"></span><span class="op" id="1849532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1849535">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1849607">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1849690">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1849762">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1849841">func</span>&nbsp;<span class="op" id="1849846">(</span><span class="ident" id="1849847">p</span>&nbsp;<span class="op" id="1849849">*</span><span class="ident" id="1849850">cpuProfile</span><span class="op" id="1849860">)</span>&nbsp;<span class="ident" id="1849862">flushlog</span><span class="op" id="1849870">(</span><span class="op" id="1849871">)</span>&nbsp;<span class="builtintype" id="1849873">bool</span>&nbsp;<span class="op" id="1849878">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849881">if</span>&nbsp;<span class="op" id="1849884">!</span><span class="ident" id="1849885">cas</span><span class="op" id="1849888">(</span><span class="op" id="1849889">&amp;</span><span class="ident" id="1849890">p</span><span class="op" id="1849891">.</span><span class="ident" id="1849892">handoff</span><span class="op" id="1849899">,</span>&nbsp;<span class="num" id="1849901">0</span><span class="op" id="1849902">,</span>&nbsp;<span class="builtintype" id="1849904">uint32</span><span class="op" id="1849910">(</span><span class="ident" id="1849911">p</span><span class="op" id="1849912">.</span><span class="ident" id="1849913">nlog</span><span class="op" id="1849917">)</span><span class="op" id="1849918">)</span>&nbsp;<span class="op" id="1849920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1849924">return</span>&nbsp;<span class="builtintype" id="1849931">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1849938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849941">notewakeup</span><span class="op" id="1849951">(</span><span class="op" id="1849952">&amp;</span><span class="ident" id="1849953">p</span><span class="op" id="1849954">.</span><span class="ident" id="1849955">wait</span><span class="op" id="1849959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849963">p</span><span class="op" id="1849964">.</span><span class="ident" id="1849965">toggle</span>&nbsp;<span class="op" id="1849972">=</span>&nbsp;<span class="num" id="1849974">1</span>&nbsp;<span class="op" id="1849976">-</span>&nbsp;<span class="ident" id="1849978">p</span><span class="op" id="1849979">.</span><span class="ident" id="1849980">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1849988">log</span>&nbsp;<span class="op" id="1849992">:=</span>&nbsp;<span class="op" id="1849995">&amp;</span><span class="ident" id="1849996">p</span><span class="op" id="1849997">.</span><span class="ident" id="1849998">log</span><span class="op" id="1850001">[</span><span class="ident" id="1850002">p</span><span class="op" id="1850003">.</span><span class="ident" id="1850004">toggle</span><span class="op" id="1850010">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850013">q</span>&nbsp;<span class="op" id="1850015">:=</span>&nbsp;<span class="builtintype" id="1850018">uintptr</span><span class="op" id="1850025">(</span><span class="num" id="1850026">0</span><span class="op" id="1850027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850030">if</span>&nbsp;<span class="ident" id="1850033">p</span><span class="op" id="1850034">.</span><span class="ident" id="1850035">lost</span>&nbsp;<span class="op" id="1850040">&gt;</span>&nbsp;<span class="num" id="1850042">0</span>&nbsp;<span class="op" id="1850044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850048">lostPC</span>&nbsp;<span class="op" id="1850055">:=</span>&nbsp;<span class="ident" id="1850058">funcPC</span><span class="op" id="1850064">(</span><span class="ident" id="1850065">lostProfileData</span><span class="op" id="1850080">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850084">log</span><span class="op" id="1850087">[</span><span class="num" id="1850088">0</span><span class="op" id="1850089">]</span>&nbsp;<span class="op" id="1850091">=</span>&nbsp;<span class="ident" id="1850093">p</span><span class="op" id="1850094">.</span><span class="ident" id="1850095">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850102">log</span><span class="op" id="1850105">[</span><span class="num" id="1850106">1</span><span class="op" id="1850107">]</span>&nbsp;<span class="op" id="1850109">=</span>&nbsp;<span class="num" id="1850111">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850115">log</span><span class="op" id="1850118">[</span><span class="num" id="1850119">2</span><span class="op" id="1850120">]</span>&nbsp;<span class="op" id="1850122">=</span>&nbsp;<span class="ident" id="1850124">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850133">q</span>&nbsp;<span class="op" id="1850135">=</span>&nbsp;<span class="num" id="1850137">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850141">p</span><span class="op" id="1850142">.</span><span class="ident" id="1850143">lost</span>&nbsp;<span class="op" id="1850148">=</span>&nbsp;<span class="num" id="1850150">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850156">p</span><span class="op" id="1850157">.</span><span class="ident" id="1850158">nlog</span>&nbsp;<span class="op" id="1850163">=</span>&nbsp;<span class="ident" id="1850165">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850168">return</span>&nbsp;<span class="builtintype" id="1850175">true</span><br>
<span class="lineno"></span><span class="op" id="1850180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1850183">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1850256">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1850329">func</span>&nbsp;<span class="op" id="1850334">(</span><span class="ident" id="1850335">p</span>&nbsp;<span class="op" id="1850337">*</span><span class="ident" id="1850338">cpuProfile</span><span class="op" id="1850348">)</span>&nbsp;<span class="ident" id="1850350">getprofile</span><span class="op" id="1850360">(</span><span class="op" id="1850361">)</span>&nbsp;<span class="op" id="1850363">[</span><span class="op" id="1850364">]</span><span class="builtintype" id="1850365">byte</span>&nbsp;<span class="op" id="1850370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850373">if</span>&nbsp;<span class="ident" id="1850376">p</span>&nbsp;<span class="op" id="1850378">==</span>&nbsp;<span class="ident" id="1850381">nil</span>&nbsp;<span class="op" id="1850385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850389">return</span>&nbsp;<span class="ident" id="1850396">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850405">if</span>&nbsp;<span class="ident" id="1850408">p</span><span class="op" id="1850409">.</span><span class="ident" id="1850410">wholding</span>&nbsp;<span class="op" id="1850419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850423">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850474">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850536">for</span>&nbsp;<span class="op" id="1850540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850545">n</span>&nbsp;<span class="op" id="1850547">:=</span>&nbsp;<span class="ident" id="1850550">p</span><span class="op" id="1850551">.</span><span class="ident" id="1850552">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850563">if</span>&nbsp;<span class="ident" id="1850566">n</span>&nbsp;<span class="op" id="1850568">==</span>&nbsp;<span class="num" id="1850571">0</span>&nbsp;<span class="op" id="1850573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1850579">print</span><span class="op" id="1850584">(</span><span class="string" id="1850585">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1850636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850642">return</span>&nbsp;<span class="ident" id="1850649">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850661">if</span>&nbsp;<span class="ident" id="1850664">n</span><span class="op" id="1850665">&amp;</span><span class="num" id="1850666">0x80000000</span>&nbsp;<span class="op" id="1850677">!=</span>&nbsp;<span class="num" id="1850680">0</span>&nbsp;<span class="op" id="1850682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850688">p</span><span class="op" id="1850689">.</span><span class="ident" id="1850690">wtoggle</span>&nbsp;<span class="op" id="1850698">=</span>&nbsp;<span class="num" id="1850700">1</span>&nbsp;<span class="op" id="1850702">-</span>&nbsp;<span class="ident" id="1850704">p</span><span class="op" id="1850705">.</span><span class="ident" id="1850706">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850718">p</span><span class="op" id="1850719">.</span><span class="ident" id="1850720">wholding</span>&nbsp;<span class="op" id="1850729">=</span>&nbsp;<span class="builtintype" id="1850731">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850741">p</span><span class="op" id="1850742">.</span><span class="ident" id="1850743">flushing</span>&nbsp;<span class="op" id="1850752">=</span>&nbsp;<span class="builtintype" id="1850754">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850763">goto</span>&nbsp;<span class="ident" id="1850768">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850782">if</span>&nbsp;<span class="ident" id="1850785">cas</span><span class="op" id="1850788">(</span><span class="op" id="1850789">&amp;</span><span class="ident" id="1850790">p</span><span class="op" id="1850791">.</span><span class="ident" id="1850792">handoff</span><span class="op" id="1850799">,</span>&nbsp;<span class="ident" id="1850801">n</span><span class="op" id="1850802">,</span>&nbsp;<span class="num" id="1850804">0</span><span class="op" id="1850805">)</span>&nbsp;<span class="op" id="1850807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850813">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850822">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850830">p</span><span class="op" id="1850831">.</span><span class="ident" id="1850832">wtoggle</span>&nbsp;<span class="op" id="1850840">=</span>&nbsp;<span class="num" id="1850842">1</span>&nbsp;<span class="op" id="1850844">-</span>&nbsp;<span class="ident" id="1850846">p</span><span class="op" id="1850847">.</span><span class="ident" id="1850848">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850858">p</span><span class="op" id="1850859">.</span><span class="ident" id="1850860">wholding</span>&nbsp;<span class="op" id="1850869">=</span>&nbsp;<span class="builtintype" id="1850871">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850882">if</span>&nbsp;<span class="ident" id="1850885">p</span><span class="op" id="1850886">.</span><span class="ident" id="1850887">flushing</span>&nbsp;<span class="op" id="1850896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850900">goto</span>&nbsp;<span class="ident" id="1850905">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850916">if</span>&nbsp;<span class="op" id="1850919">!</span><span class="ident" id="1850920">p</span><span class="op" id="1850921">.</span><span class="ident" id="1850922">on</span>&nbsp;<span class="op" id="1850925">&amp;&amp;</span>&nbsp;<span class="ident" id="1850928">p</span><span class="op" id="1850929">.</span><span class="ident" id="1850930">handoff</span>&nbsp;<span class="op" id="1850938">==</span>&nbsp;<span class="num" id="1850941">0</span>&nbsp;<span class="op" id="1850943">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1850947">return</span>&nbsp;<span class="ident" id="1850954">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1850959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1850963">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1850985">notetsleepg</span><span class="op" id="1850996">(</span><span class="op" id="1850997">&amp;</span><span class="ident" id="1850998">p</span><span class="op" id="1850999">.</span><span class="ident" id="1851000">wait</span><span class="op" id="1851004">,</span>&nbsp;<span class="op" id="1851006">-</span><span class="num" id="1851007">1</span><span class="op" id="1851008">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851011">noteclear</span><span class="op" id="1851020">(</span><span class="op" id="1851021">&amp;</span><span class="ident" id="1851022">p</span><span class="op" id="1851023">.</span><span class="ident" id="1851024">wait</span><span class="op" id="1851028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851032">switch</span>&nbsp;<span class="ident" id="1851039">n</span>&nbsp;<span class="op" id="1851041">:=</span>&nbsp;<span class="ident" id="1851044">p</span><span class="op" id="1851045">.</span><span class="ident" id="1851046">handoff</span><span class="op" id="1851053">;</span>&nbsp;<span class="op" id="1851055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851058">case</span>&nbsp;<span class="ident" id="1851063">n</span>&nbsp;<span class="op" id="1851065">==</span>&nbsp;<span class="num" id="1851068">0</span><span class="op" id="1851069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1851073">print</span><span class="op" id="1851078">(</span><span class="string" id="1851079">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1851127">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851131">return</span>&nbsp;<span class="ident" id="1851138">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851143">case</span>&nbsp;<span class="ident" id="1851148">n</span>&nbsp;<span class="op" id="1851150">==</span>&nbsp;<span class="num" id="1851153">0x80000000</span><span class="op" id="1851163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851167">p</span><span class="op" id="1851168">.</span><span class="ident" id="1851169">flushing</span>&nbsp;<span class="op" id="1851178">=</span>&nbsp;<span class="builtintype" id="1851180">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851187">goto</span>&nbsp;<span class="ident" id="1851192">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851199">default</span><span class="op" id="1851206">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851210">n</span>&nbsp;<span class="op" id="1851212">&amp;^=</span>&nbsp;<span class="num" id="1851216">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851230">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851261">p</span><span class="op" id="1851262">.</span><span class="ident" id="1851263">wholding</span>&nbsp;<span class="op" id="1851272">=</span>&nbsp;<span class="builtintype" id="1851274">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851282">return</span>&nbsp;<span class="ident" id="1851289">uintptrBytes</span><span class="op" id="1851301">(</span><span class="ident" id="1851302">p</span><span class="op" id="1851303">.</span><span class="ident" id="1851304">log</span><span class="op" id="1851307">[</span><span class="ident" id="1851308">p</span><span class="op" id="1851309">.</span><span class="ident" id="1851310">wtoggle</span><span class="op" id="1851317">]</span><span class="op" id="1851318">[</span><span class="op" id="1851319">:</span><span class="ident" id="1851320">n</span><span class="op" id="1851321">]</span><span class="op" id="1851322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851329">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851348">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851400">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851465">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1851517">Flush</span><span class="op" id="1851522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851525">for</span>&nbsp;<span class="ident" id="1851529">i</span>&nbsp;<span class="op" id="1851531">:=</span>&nbsp;<span class="keyword" id="1851534">range</span>&nbsp;<span class="ident" id="1851540">p</span><span class="op" id="1851541">.</span><span class="ident" id="1851542">hash</span>&nbsp;<span class="op" id="1851547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851551">b</span>&nbsp;<span class="op" id="1851553">:=</span>&nbsp;<span class="op" id="1851556">&amp;</span><span class="ident" id="1851557">p</span><span class="op" id="1851558">.</span><span class="ident" id="1851559">hash</span><span class="op" id="1851563">[</span><span class="ident" id="1851564">i</span><span class="op" id="1851565">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851569">for</span>&nbsp;<span class="ident" id="1851573">j</span>&nbsp;<span class="op" id="1851575">:=</span>&nbsp;<span class="keyword" id="1851578">range</span>&nbsp;<span class="ident" id="1851584">b</span><span class="op" id="1851585">.</span><span class="ident" id="1851586">entry</span>&nbsp;<span class="op" id="1851592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851597">e</span>&nbsp;<span class="op" id="1851599">:=</span>&nbsp;<span class="op" id="1851602">&amp;</span><span class="ident" id="1851603">b</span><span class="op" id="1851604">.</span><span class="ident" id="1851605">entry</span><span class="op" id="1851610">[</span><span class="ident" id="1851611">j</span><span class="op" id="1851612">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851617">if</span>&nbsp;<span class="ident" id="1851620">e</span><span class="op" id="1851621">.</span><span class="ident" id="1851622">count</span>&nbsp;<span class="op" id="1851628">&gt;</span>&nbsp;<span class="num" id="1851630">0</span>&nbsp;<span class="op" id="1851632">&amp;&amp;</span>&nbsp;<span class="op" id="1851635">!</span><span class="ident" id="1851636">p</span><span class="op" id="1851637">.</span><span class="ident" id="1851638">evict</span><span class="op" id="1851643">(</span><span class="ident" id="1851644">e</span><span class="op" id="1851645">)</span>&nbsp;<span class="op" id="1851647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851653">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851718">break</span>&nbsp;<span class="ident" id="1851724">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851744">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851773">if</span>&nbsp;<span class="ident" id="1851776">p</span><span class="op" id="1851777">.</span><span class="ident" id="1851778">nlog</span>&nbsp;<span class="op" id="1851783">&gt;</span>&nbsp;<span class="num" id="1851785">0</span>&nbsp;<span class="op" id="1851787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851791">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851843">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851891">n</span>&nbsp;<span class="op" id="1851893">:=</span>&nbsp;<span class="ident" id="1851896">p</span><span class="op" id="1851897">.</span><span class="ident" id="1851898">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1851905">p</span><span class="op" id="1851906">.</span><span class="ident" id="1851907">nlog</span>&nbsp;<span class="op" id="1851912">=</span>&nbsp;<span class="num" id="1851914">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1851918">return</span>&nbsp;<span class="ident" id="1851925">uintptrBytes</span><span class="op" id="1851937">(</span><span class="ident" id="1851938">p</span><span class="op" id="1851939">.</span><span class="ident" id="1851940">log</span><span class="op" id="1851943">[</span><span class="ident" id="1851944">p</span><span class="op" id="1851945">.</span><span class="ident" id="1851946">toggle</span><span class="op" id="1851952">]</span><span class="op" id="1851953">[</span><span class="op" id="1851954">:</span><span class="ident" id="1851955">n</span><span class="op" id="1851956">]</span><span class="op" id="1851957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1851960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1851964">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852027">if</span>&nbsp;<span class="op" id="1852030">!</span><span class="ident" id="1852031">p</span><span class="op" id="1852032">.</span><span class="ident" id="1852033">eodSent</span>&nbsp;<span class="op" id="1852041">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1852045">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1852111">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852176">p</span><span class="op" id="1852177">.</span><span class="ident" id="1852178">eodSent</span>&nbsp;<span class="op" id="1852186">=</span>&nbsp;<span class="builtintype" id="1852188">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852195">return</span>&nbsp;<span class="ident" id="1852202">uintptrBytes</span><span class="op" id="1852214">(</span><span class="ident" id="1852215">eod</span><span class="op" id="1852218">[</span><span class="op" id="1852219">:</span><span class="op" id="1852220">]</span><span class="op" id="1852221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1852224">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1852228">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852272">p</span><span class="op" id="1852273">.</span><span class="ident" id="1852274">flushing</span>&nbsp;<span class="op" id="1852283">=</span>&nbsp;<span class="builtintype" id="1852285">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852292">if</span>&nbsp;<span class="op" id="1852295">!</span><span class="ident" id="1852296">cas</span><span class="op" id="1852299">(</span><span class="op" id="1852300">&amp;</span><span class="ident" id="1852301">p</span><span class="op" id="1852302">.</span><span class="ident" id="1852303">handoff</span><span class="op" id="1852310">,</span>&nbsp;<span class="ident" id="1852312">p</span><span class="op" id="1852313">.</span><span class="ident" id="1852314">handoff</span><span class="op" id="1852321">,</span>&nbsp;<span class="num" id="1852323">0</span><span class="op" id="1852324">)</span>&nbsp;<span class="op" id="1852326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1852330">print</span><span class="op" id="1852335">(</span><span class="string" id="1852336">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1852384">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1852387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852390">return</span>&nbsp;<span class="ident" id="1852397">nil</span><br>
<span class="lineno"></span><span class="op" id="1852401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1852404">func</span>&nbsp;<span class="ident" id="1852409">uintptrBytes</span><span class="op" id="1852421">(</span><span class="ident" id="1852422">p</span>&nbsp;<span class="op" id="1852424">[</span><span class="op" id="1852425">]</span><span class="builtintype" id="1852426">uintptr</span><span class="op" id="1852433">)</span>&nbsp;<span class="op" id="1852435">(</span><span class="ident" id="1852436">ret</span>&nbsp;<span class="op" id="1852440">[</span><span class="op" id="1852441">]</span><span class="builtintype" id="1852442">byte</span><span class="op" id="1852446">)</span>&nbsp;<span class="op" id="1852448">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852451">pp</span>&nbsp;<span class="op" id="1852454">:=</span>&nbsp;<span class="op" id="1852457">(</span><span class="op" id="1852458">*</span><span class="ident" id="1852459">sliceStruct</span><span class="op" id="1852470">)</span><span class="op" id="1852471">(</span><span class="ident" id="1852472">unsafe</span><span class="op" id="1852478">.</span><span class="ident" id="1852479">Pointer</span><span class="op" id="1852486">(</span><span class="op" id="1852487">&amp;</span><span class="ident" id="1852488">p</span><span class="op" id="1852489">)</span><span class="op" id="1852490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852493">rp</span>&nbsp;<span class="op" id="1852496">:=</span>&nbsp;<span class="op" id="1852499">(</span><span class="op" id="1852500">*</span><span class="ident" id="1852501">sliceStruct</span><span class="op" id="1852512">)</span><span class="op" id="1852513">(</span><span class="ident" id="1852514">unsafe</span><span class="op" id="1852520">.</span><span class="ident" id="1852521">Pointer</span><span class="op" id="1852528">(</span><span class="op" id="1852529">&amp;</span><span class="ident" id="1852530">ret</span><span class="op" id="1852533">)</span><span class="op" id="1852534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852538">rp</span><span class="op" id="1852540">.</span><span class="ident" id="1852541">array</span>&nbsp;<span class="op" id="1852547">=</span>&nbsp;<span class="ident" id="1852549">pp</span><span class="op" id="1852551">.</span><span class="ident" id="1852552">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852559">rp</span><span class="op" id="1852561">.</span><span class="builtinfunc" id="1852562">len</span>&nbsp;<span class="op" id="1852566">=</span>&nbsp;<span class="ident" id="1852568">pp</span><span class="op" id="1852570">.</span><span class="builtinfunc" id="1852571">len</span>&nbsp;<span class="op" id="1852575">*</span>&nbsp;<span class="builtintype" id="1852577">int</span><span class="op" id="1852580">(</span><span class="ident" id="1852581">unsafe</span><span class="op" id="1852587">.</span><span class="ident" id="1852588">Sizeof</span><span class="op" id="1852594">(</span><span class="ident" id="1852595">p</span><span class="op" id="1852596">[</span><span class="num" id="1852597">0</span><span class="op" id="1852598">]</span><span class="op" id="1852599">)</span><span class="op" id="1852600">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1852603">rp</span><span class="op" id="1852605">.</span><span class="builtinfunc" id="1852606">cap</span>&nbsp;<span class="op" id="1852610">=</span>&nbsp;<span class="ident" id="1852612">rp</span><span class="op" id="1852614">.</span><span class="builtinfunc" id="1852615">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1852621">return</span><br>
<span class="lineno"></span><span class="op" id="1852628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1852631">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1852710">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1852795">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1852874">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1852949">//</span><br>
<span class="lineno">420</span><span class="comment" id="1852952">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1853008">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1853074">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1853098">func</span>&nbsp;<span class="ident" id="1853103">CPUProfile</span><span class="op" id="1853113">(</span><span class="op" id="1853114">)</span>&nbsp;<span class="op" id="1853116">[</span><span class="op" id="1853117">]</span><span class="builtintype" id="1853118">byte</span>&nbsp;<span class="op" id="1853123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1853126">return</span>&nbsp;<span class="ident" id="1853133">cpuprof</span><span class="op" id="1853140">.</span><span class="ident" id="1853141">getprofile</span><span class="op" id="1853151">(</span><span class="op" id="1853152">)</span><br>
<span class="lineno">425</span><span class="op" id="1853154">}</span>
</div>
</body>
</html>
