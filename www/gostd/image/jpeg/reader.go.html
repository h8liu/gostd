<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html" class="current">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5796664">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5796719">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5796773">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5796824">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="5796885">//</span><br>
<span class="lineno"></span><span class="comment" id="5796888">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="5796967">package</span>&nbsp;<span class="ident" id="5796975">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5796981">import</span>&nbsp;<span class="op" id="5796988">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5796991">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5797000">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5797015">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5797020">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5797023">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5797100">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5797157">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="5797218">type</span>&nbsp;<span class="ident" id="5797223">FormatError</span>&nbsp;<span class="builtintype" id="5797235">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5797243">func</span>&nbsp;<span class="op" id="5797248">(</span><span class="ident" id="5797249">e</span>&nbsp;<span class="ident" id="5797251">FormatError</span><span class="op" id="5797262">)</span>&nbsp;<span class="ident" id="5797264">Error</span><span class="op" id="5797269">(</span><span class="op" id="5797270">)</span>&nbsp;<span class="builtintype" id="5797272">string</span>&nbsp;<span class="op" id="5797279">{</span>&nbsp;<span class="keyword" id="5797281">return</span>&nbsp;<span class="string" id="5797288">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="5797312">+</span>&nbsp;<span class="builtintype" id="5797314">string</span><span class="op" id="5797320">(</span><span class="ident" id="5797321">e</span><span class="op" id="5797322">)</span>&nbsp;<span class="op" id="5797324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5797327">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="5797418">type</span>&nbsp;<span class="ident" id="5797423">UnsupportedError</span>&nbsp;<span class="builtintype" id="5797440">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5797448">func</span>&nbsp;<span class="op" id="5797453">(</span><span class="ident" id="5797454">e</span>&nbsp;<span class="ident" id="5797456">UnsupportedError</span><span class="op" id="5797472">)</span>&nbsp;<span class="ident" id="5797474">Error</span><span class="op" id="5797479">(</span><span class="op" id="5797480">)</span>&nbsp;<span class="builtintype" id="5797482">string</span>&nbsp;<span class="op" id="5797489">{</span>&nbsp;<span class="keyword" id="5797491">return</span>&nbsp;<span class="string" id="5797498">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="5797527">+</span>&nbsp;<span class="builtintype" id="5797529">string</span><span class="op" id="5797535">(</span><span class="ident" id="5797536">e</span><span class="op" id="5797537">)</span>&nbsp;<span class="op" id="5797539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5797542">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="5797598">type</span>&nbsp;<span class="ident" id="5797603">component</span>&nbsp;<span class="keyword" id="5797613">struct</span>&nbsp;<span class="op" id="5797620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797623">h</span>&nbsp;&nbsp;<span class="builtintype" id="5797626">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5797632">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797664">v</span>&nbsp;&nbsp;<span class="builtintype" id="5797667">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5797673">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797703">c</span>&nbsp;&nbsp;<span class="builtintype" id="5797706">uint8</span>&nbsp;<span class="comment" id="5797712">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797738">tq</span>&nbsp;<span class="builtintype" id="5797741">uint8</span>&nbsp;<span class="comment" id="5797747">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="5797791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5797794">const</span>&nbsp;<span class="op" id="5797800">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797803">dcTable</span>&nbsp;<span class="op" id="5797811">=</span>&nbsp;<span class="num" id="5797813">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797816">acTable</span>&nbsp;<span class="op" id="5797824">=</span>&nbsp;<span class="num" id="5797826">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797829">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5797837">=</span>&nbsp;<span class="num" id="5797839">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797842">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5797850">=</span>&nbsp;<span class="num" id="5797852">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797855">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5797863">=</span>&nbsp;<span class="num" id="5797865">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5797869">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797920">nGrayComponent</span>&nbsp;<span class="op" id="5797935">=</span>&nbsp;<span class="num" id="5797937">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5797940">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797992">nColorComponent</span>&nbsp;<span class="op" id="5798008">=</span>&nbsp;<span class="num" id="5798010">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798014">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798096">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798172">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798209">maxH</span>&nbsp;<span class="op" id="5798214">=</span>&nbsp;<span class="num" id="5798216">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798219">maxV</span>&nbsp;<span class="op" id="5798224">=</span>&nbsp;<span class="num" id="5798226">2</span><br>
<span class="lineno"></span><span class="op" id="5798228">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5798231">const</span>&nbsp;<span class="op" id="5798237">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798240">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798252">=</span>&nbsp;<span class="num" id="5798254">0xd8</span>&nbsp;<span class="comment" id="5798259">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798279">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798291">=</span>&nbsp;<span class="num" id="5798293">0xd9</span>&nbsp;<span class="comment" id="5798298">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798316">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="5798328">=</span>&nbsp;<span class="num" id="5798330">0xc0</span>&nbsp;<span class="comment" id="5798335">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798366">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="5798378">=</span>&nbsp;<span class="num" id="5798380">0xc2</span>&nbsp;<span class="comment" id="5798385">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798419">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798431">=</span>&nbsp;<span class="num" id="5798433">0xc4</span>&nbsp;<span class="comment" id="5798438">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798464">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798476">=</span>&nbsp;<span class="num" id="5798478">0xdb</span>&nbsp;<span class="comment" id="5798483">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798514">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798526">=</span>&nbsp;<span class="num" id="5798528">0xda</span>&nbsp;<span class="comment" id="5798533">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798552">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798564">=</span>&nbsp;<span class="num" id="5798566">0xdd</span>&nbsp;<span class="comment" id="5798571">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798600">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="5798612">=</span>&nbsp;<span class="num" id="5798614">0xd0</span>&nbsp;<span class="comment" id="5798619">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798636">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="5798648">=</span>&nbsp;<span class="num" id="5798650">0xd7</span>&nbsp;<span class="comment" id="5798655">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798672">app0Marker</span>&nbsp;&nbsp;<span class="op" id="5798684">=</span>&nbsp;<span class="num" id="5798686">0xe0</span>&nbsp;<span class="comment" id="5798691">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798721">app15Marker</span>&nbsp;<span class="op" id="5798733">=</span>&nbsp;<span class="num" id="5798735">0xef</span>&nbsp;<span class="comment" id="5798740">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798771">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5798783">=</span>&nbsp;<span class="num" id="5798785">0xfe</span>&nbsp;<span class="comment" id="5798790">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="5798802">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5798805">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="5798883">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="5798961">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="5799041">var</span>&nbsp;<span class="ident" id="5799045">unzig</span>&nbsp;<span class="op" id="5799051">=</span>&nbsp;<span class="op" id="5799053">[</span><span class="ident" id="5799054">blockSize</span><span class="op" id="5799063">]</span><span class="builtintype" id="5799064">int</span><span class="op" id="5799067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799070">0</span><span class="op" id="5799071">,</span>&nbsp;<span class="num" id="5799073">1</span><span class="op" id="5799074">,</span>&nbsp;<span class="num" id="5799076">8</span><span class="op" id="5799077">,</span>&nbsp;<span class="num" id="5799079">16</span><span class="op" id="5799081">,</span>&nbsp;<span class="num" id="5799083">9</span><span class="op" id="5799084">,</span>&nbsp;<span class="num" id="5799086">2</span><span class="op" id="5799087">,</span>&nbsp;<span class="num" id="5799089">3</span><span class="op" id="5799090">,</span>&nbsp;<span class="num" id="5799092">10</span><span class="op" id="5799094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799097">17</span><span class="op" id="5799099">,</span>&nbsp;<span class="num" id="5799101">24</span><span class="op" id="5799103">,</span>&nbsp;<span class="num" id="5799105">32</span><span class="op" id="5799107">,</span>&nbsp;<span class="num" id="5799109">25</span><span class="op" id="5799111">,</span>&nbsp;<span class="num" id="5799113">18</span><span class="op" id="5799115">,</span>&nbsp;<span class="num" id="5799117">11</span><span class="op" id="5799119">,</span>&nbsp;<span class="num" id="5799121">4</span><span class="op" id="5799122">,</span>&nbsp;<span class="num" id="5799124">5</span><span class="op" id="5799125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799128">12</span><span class="op" id="5799130">,</span>&nbsp;<span class="num" id="5799132">19</span><span class="op" id="5799134">,</span>&nbsp;<span class="num" id="5799136">26</span><span class="op" id="5799138">,</span>&nbsp;<span class="num" id="5799140">33</span><span class="op" id="5799142">,</span>&nbsp;<span class="num" id="5799144">40</span><span class="op" id="5799146">,</span>&nbsp;<span class="num" id="5799148">48</span><span class="op" id="5799150">,</span>&nbsp;<span class="num" id="5799152">41</span><span class="op" id="5799154">,</span>&nbsp;<span class="num" id="5799156">34</span><span class="op" id="5799158">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799161">27</span><span class="op" id="5799163">,</span>&nbsp;<span class="num" id="5799165">20</span><span class="op" id="5799167">,</span>&nbsp;<span class="num" id="5799169">13</span><span class="op" id="5799171">,</span>&nbsp;<span class="num" id="5799173">6</span><span class="op" id="5799174">,</span>&nbsp;<span class="num" id="5799176">7</span><span class="op" id="5799177">,</span>&nbsp;<span class="num" id="5799179">14</span><span class="op" id="5799181">,</span>&nbsp;<span class="num" id="5799183">21</span><span class="op" id="5799185">,</span>&nbsp;<span class="num" id="5799187">28</span><span class="op" id="5799189">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799192">35</span><span class="op" id="5799194">,</span>&nbsp;<span class="num" id="5799196">42</span><span class="op" id="5799198">,</span>&nbsp;<span class="num" id="5799200">49</span><span class="op" id="5799202">,</span>&nbsp;<span class="num" id="5799204">56</span><span class="op" id="5799206">,</span>&nbsp;<span class="num" id="5799208">57</span><span class="op" id="5799210">,</span>&nbsp;<span class="num" id="5799212">50</span><span class="op" id="5799214">,</span>&nbsp;<span class="num" id="5799216">43</span><span class="op" id="5799218">,</span>&nbsp;<span class="num" id="5799220">36</span><span class="op" id="5799222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799225">29</span><span class="op" id="5799227">,</span>&nbsp;<span class="num" id="5799229">22</span><span class="op" id="5799231">,</span>&nbsp;<span class="num" id="5799233">15</span><span class="op" id="5799235">,</span>&nbsp;<span class="num" id="5799237">23</span><span class="op" id="5799239">,</span>&nbsp;<span class="num" id="5799241">30</span><span class="op" id="5799243">,</span>&nbsp;<span class="num" id="5799245">37</span><span class="op" id="5799247">,</span>&nbsp;<span class="num" id="5799249">44</span><span class="op" id="5799251">,</span>&nbsp;<span class="num" id="5799253">51</span><span class="op" id="5799255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799258">58</span><span class="op" id="5799260">,</span>&nbsp;<span class="num" id="5799262">59</span><span class="op" id="5799264">,</span>&nbsp;<span class="num" id="5799266">52</span><span class="op" id="5799268">,</span>&nbsp;<span class="num" id="5799270">45</span><span class="op" id="5799272">,</span>&nbsp;<span class="num" id="5799274">38</span><span class="op" id="5799276">,</span>&nbsp;<span class="num" id="5799278">31</span><span class="op" id="5799280">,</span>&nbsp;<span class="num" id="5799282">39</span><span class="op" id="5799284">,</span>&nbsp;<span class="num" id="5799286">46</span><span class="op" id="5799288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5799291">53</span><span class="op" id="5799293">,</span>&nbsp;<span class="num" id="5799295">60</span><span class="op" id="5799297">,</span>&nbsp;<span class="num" id="5799299">61</span><span class="op" id="5799301">,</span>&nbsp;<span class="num" id="5799303">54</span><span class="op" id="5799305">,</span>&nbsp;<span class="num" id="5799307">47</span><span class="op" id="5799309">,</span>&nbsp;<span class="num" id="5799311">55</span><span class="op" id="5799313">,</span>&nbsp;<span class="num" id="5799315">62</span><span class="op" id="5799317">,</span>&nbsp;<span class="num" id="5799319">63</span><span class="op" id="5799321">,</span><br>
<span class="lineno"></span><span class="op" id="5799323">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5799326">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="5799351">type</span>&nbsp;<span class="ident" id="5799356">Reader</span>&nbsp;<span class="keyword" id="5799363">interface</span>&nbsp;<span class="op" id="5799373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799376">io</span><span class="op" id="5799378">.</span><span class="ident" id="5799379">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799391">io</span><span class="op" id="5799393">.</span><span class="ident" id="5799394">Reader</span><br>
<span class="lineno">90</span><span class="op" id="5799401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5799404">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="5799482">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5799562">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="5799576">type</span>&nbsp;<span class="ident" id="5799581">bits</span>&nbsp;<span class="keyword" id="5799586">struct</span>&nbsp;<span class="op" id="5799593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799596">a</span>&nbsp;<span class="builtintype" id="5799598">uint32</span>&nbsp;<span class="comment" id="5799605">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799622">m</span>&nbsp;<span class="builtintype" id="5799624">uint32</span>&nbsp;<span class="comment" id="5799631">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799684">n</span>&nbsp;<span class="builtintype" id="5799686">int32</span>&nbsp;&nbsp;<span class="comment" id="5799693">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="5799728">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="5799731">type</span>&nbsp;<span class="ident" id="5799736">decoder</span>&nbsp;<span class="keyword" id="5799744">struct</span>&nbsp;<span class="op" id="5799751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799754">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5799759">io</span><span class="op" id="5799761">.</span><span class="ident" id="5799762">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799770">bits</span>&nbsp;<span class="ident" id="5799775">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799781">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799851">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799920">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799971">bytes</span>&nbsp;<span class="keyword" id="5799977">struct</span>&nbsp;<span class="op" id="5799984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799988">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800050">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800106">buf</span>&nbsp;&nbsp;<span class="op" id="5800111">[</span><span class="num" id="5800112">4096</span><span class="op" id="5800116">]</span><span class="builtintype" id="5800117">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800124">i</span><span class="op" id="5800125">,</span>&nbsp;<span class="ident" id="5800127">j</span>&nbsp;<span class="builtintype" id="5800129">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800135">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800194">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800234">nUnreadable</span>&nbsp;<span class="builtintype" id="5800246">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800254">width</span><span class="op" id="5800259">,</span>&nbsp;<span class="ident" id="5800261">height</span>&nbsp;<span class="builtintype" id="5800268">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800273">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800287">*</span><span class="ident" id="5800288">image</span><span class="op" id="5800293">.</span><span class="ident" id="5800294">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800300">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800314">*</span><span class="ident" id="5800315">image</span><span class="op" id="5800320">.</span><span class="ident" id="5800321">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800328">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5800342">int</span>&nbsp;<span class="comment" id="5800346">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800368">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5800382">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800387">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5800401">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800407">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5800421">uint16</span>&nbsp;<span class="comment" id="5800428">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800479">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800493">[</span><span class="ident" id="5800494">nColorComponent</span><span class="op" id="5800509">]</span><span class="ident" id="5800510">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800521">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800535">[</span><span class="ident" id="5800536">nColorComponent</span><span class="op" id="5800551">]</span><span class="op" id="5800552">[</span><span class="op" id="5800553">]</span><span class="ident" id="5800554">block</span>&nbsp;<span class="comment" id="5800560">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800608">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800622">[</span><span class="ident" id="5800623">maxTc</span>&nbsp;<span class="op" id="5800629">+</span>&nbsp;<span class="num" id="5800631">1</span><span class="op" id="5800632">]</span><span class="op" id="5800633">[</span><span class="ident" id="5800634">maxTh</span>&nbsp;<span class="op" id="5800640">+</span>&nbsp;<span class="num" id="5800642">1</span><span class="op" id="5800643">]</span><span class="ident" id="5800644">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800653">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800667">[</span><span class="ident" id="5800668">maxTq</span>&nbsp;<span class="op" id="5800674">+</span>&nbsp;<span class="num" id="5800676">1</span><span class="op" id="5800677">]</span><span class="ident" id="5800678">block</span>&nbsp;<span class="comment" id="5800684">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800727">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5800741">[</span><span class="ident" id="5800742">blockSize</span>&nbsp;<span class="op" id="5800752">+</span>&nbsp;<span class="num" id="5800754">1</span><span class="op" id="5800755">]</span><span class="builtintype" id="5800756">byte</span><br>
<span class="lineno"></span><span class="op" id="5800761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5800764">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="5800838">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5800906">func</span>&nbsp;<span class="op" id="5800911">(</span><span class="ident" id="5800912">d</span>&nbsp;<span class="op" id="5800914">*</span><span class="ident" id="5800915">decoder</span><span class="op" id="5800922">)</span>&nbsp;<span class="ident" id="5800924">fill</span><span class="op" id="5800928">(</span><span class="op" id="5800929">)</span>&nbsp;<span class="builtintype" id="5800931">error</span>&nbsp;<span class="op" id="5800937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800940">if</span>&nbsp;<span class="ident" id="5800943">d</span><span class="op" id="5800944">.</span><span class="ident" id="5800945">bytes</span><span class="op" id="5800950">.</span><span class="ident" id="5800951">i</span>&nbsp;<span class="op" id="5800953">!=</span>&nbsp;<span class="ident" id="5800956">d</span><span class="op" id="5800957">.</span><span class="ident" id="5800958">bytes</span><span class="op" id="5800963">.</span><span class="ident" id="5800964">j</span>&nbsp;<span class="op" id="5800966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5800970">panic</span><span class="op" id="5800975">(</span><span class="string" id="5800976">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="5801019">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801025">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801095">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801130">if</span>&nbsp;<span class="ident" id="5801133">d</span><span class="op" id="5801134">.</span><span class="ident" id="5801135">bytes</span><span class="op" id="5801140">.</span><span class="ident" id="5801141">j</span>&nbsp;<span class="op" id="5801143">&gt;</span>&nbsp;<span class="num" id="5801145">2</span>&nbsp;<span class="op" id="5801147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801151">d</span><span class="op" id="5801152">.</span><span class="ident" id="5801153">bytes</span><span class="op" id="5801158">.</span><span class="ident" id="5801159">buf</span><span class="op" id="5801162">[</span><span class="num" id="5801163">0</span><span class="op" id="5801164">]</span>&nbsp;<span class="op" id="5801166">=</span>&nbsp;<span class="ident" id="5801168">d</span><span class="op" id="5801169">.</span><span class="ident" id="5801170">bytes</span><span class="op" id="5801175">.</span><span class="ident" id="5801176">buf</span><span class="op" id="5801179">[</span><span class="ident" id="5801180">d</span><span class="op" id="5801181">.</span><span class="ident" id="5801182">bytes</span><span class="op" id="5801187">.</span><span class="ident" id="5801188">j</span><span class="op" id="5801189">-</span><span class="num" id="5801190">2</span><span class="op" id="5801191">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801195">d</span><span class="op" id="5801196">.</span><span class="ident" id="5801197">bytes</span><span class="op" id="5801202">.</span><span class="ident" id="5801203">buf</span><span class="op" id="5801206">[</span><span class="num" id="5801207">1</span><span class="op" id="5801208">]</span>&nbsp;<span class="op" id="5801210">=</span>&nbsp;<span class="ident" id="5801212">d</span><span class="op" id="5801213">.</span><span class="ident" id="5801214">bytes</span><span class="op" id="5801219">.</span><span class="ident" id="5801220">buf</span><span class="op" id="5801223">[</span><span class="ident" id="5801224">d</span><span class="op" id="5801225">.</span><span class="ident" id="5801226">bytes</span><span class="op" id="5801231">.</span><span class="ident" id="5801232">j</span><span class="op" id="5801233">-</span><span class="num" id="5801234">1</span><span class="op" id="5801235">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801239">d</span><span class="op" id="5801240">.</span><span class="ident" id="5801241">bytes</span><span class="op" id="5801246">.</span><span class="ident" id="5801247">i</span><span class="op" id="5801248">,</span>&nbsp;<span class="ident" id="5801250">d</span><span class="op" id="5801251">.</span><span class="ident" id="5801252">bytes</span><span class="op" id="5801257">.</span><span class="ident" id="5801258">j</span>&nbsp;<span class="op" id="5801260">=</span>&nbsp;<span class="num" id="5801262">2</span><span class="op" id="5801263">,</span>&nbsp;<span class="num" id="5801265">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801271">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801307">n</span><span class="op" id="5801308">,</span>&nbsp;<span class="ident" id="5801310">err</span>&nbsp;<span class="op" id="5801314">:=</span>&nbsp;<span class="ident" id="5801317">d</span><span class="op" id="5801318">.</span><span class="ident" id="5801319">r</span><span class="op" id="5801320">.</span><span class="ident" id="5801321">Read</span><span class="op" id="5801325">(</span><span class="ident" id="5801326">d</span><span class="op" id="5801327">.</span><span class="ident" id="5801328">bytes</span><span class="op" id="5801333">.</span><span class="ident" id="5801334">buf</span><span class="op" id="5801337">[</span><span class="ident" id="5801338">d</span><span class="op" id="5801339">.</span><span class="ident" id="5801340">bytes</span><span class="op" id="5801345">.</span><span class="ident" id="5801346">j</span><span class="op" id="5801347">:</span><span class="op" id="5801348">]</span><span class="op" id="5801349">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801352">d</span><span class="op" id="5801353">.</span><span class="ident" id="5801354">bytes</span><span class="op" id="5801359">.</span><span class="ident" id="5801360">j</span>&nbsp;<span class="op" id="5801362">+=</span>&nbsp;<span class="ident" id="5801365">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801368">if</span>&nbsp;<span class="ident" id="5801371">n</span>&nbsp;<span class="op" id="5801373">&gt;</span>&nbsp;<span class="num" id="5801375">0</span>&nbsp;<span class="op" id="5801377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801381">err</span>&nbsp;<span class="op" id="5801385">=</span>&nbsp;<span class="ident" id="5801387">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801395">return</span>&nbsp;<span class="ident" id="5801402">err</span><br>
<span class="lineno">150</span><span class="op" id="5801406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5801409">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="5801483">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="5801563">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="5801642">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="5801720">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="5801788">func</span>&nbsp;<span class="op" id="5801793">(</span><span class="ident" id="5801794">d</span>&nbsp;<span class="op" id="5801796">*</span><span class="ident" id="5801797">decoder</span><span class="op" id="5801804">)</span>&nbsp;<span class="ident" id="5801806">unreadByteStuffedByte</span><span class="op" id="5801827">(</span><span class="op" id="5801828">)</span>&nbsp;<span class="op" id="5801830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801833">if</span>&nbsp;<span class="ident" id="5801836">d</span><span class="op" id="5801837">.</span><span class="ident" id="5801838">bytes</span><span class="op" id="5801843">.</span><span class="ident" id="5801844">nUnreadable</span>&nbsp;<span class="op" id="5801856">==</span>&nbsp;<span class="num" id="5801859">0</span>&nbsp;<span class="op" id="5801861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5801865">panic</span><span class="op" id="5801870">(</span><span class="string" id="5801871">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="5801925">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801931">d</span><span class="op" id="5801932">.</span><span class="ident" id="5801933">bytes</span><span class="op" id="5801938">.</span><span class="ident" id="5801939">i</span>&nbsp;<span class="op" id="5801941">-=</span>&nbsp;<span class="ident" id="5801944">d</span><span class="op" id="5801945">.</span><span class="ident" id="5801946">bytes</span><span class="op" id="5801951">.</span><span class="ident" id="5801952">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801965">d</span><span class="op" id="5801966">.</span><span class="ident" id="5801967">bytes</span><span class="op" id="5801972">.</span><span class="ident" id="5801973">nUnreadable</span>&nbsp;<span class="op" id="5801985">=</span>&nbsp;<span class="num" id="5801987">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801990">if</span>&nbsp;<span class="ident" id="5801993">d</span><span class="op" id="5801994">.</span><span class="ident" id="5801995">bits</span><span class="op" id="5801999">.</span><span class="ident" id="5802000">n</span>&nbsp;<span class="op" id="5802002">&gt;=</span>&nbsp;<span class="num" id="5802005">8</span>&nbsp;<span class="op" id="5802007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802011">d</span><span class="op" id="5802012">.</span><span class="ident" id="5802013">bits</span><span class="op" id="5802017">.</span><span class="ident" id="5802018">a</span>&nbsp;<span class="op" id="5802020">&gt;&gt;=</span>&nbsp;<span class="num" id="5802024">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802028">d</span><span class="op" id="5802029">.</span><span class="ident" id="5802030">bits</span><span class="op" id="5802034">.</span><span class="ident" id="5802035">n</span>&nbsp;<span class="op" id="5802037">-=</span>&nbsp;<span class="num" id="5802040">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802044">d</span><span class="op" id="5802045">.</span><span class="ident" id="5802046">bits</span><span class="op" id="5802050">.</span><span class="ident" id="5802051">m</span>&nbsp;<span class="op" id="5802053">&gt;&gt;=</span>&nbsp;<span class="num" id="5802057">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802060">}</span><br>
<span class="lineno"></span><span class="op" id="5802062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="5802065">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="5802142">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5802175">func</span>&nbsp;<span class="op" id="5802180">(</span><span class="ident" id="5802181">d</span>&nbsp;<span class="op" id="5802183">*</span><span class="ident" id="5802184">decoder</span><span class="op" id="5802191">)</span>&nbsp;<span class="ident" id="5802193">readByte</span><span class="op" id="5802201">(</span><span class="op" id="5802202">)</span>&nbsp;<span class="op" id="5802204">(</span><span class="ident" id="5802205">x</span>&nbsp;<span class="builtintype" id="5802207">byte</span><span class="op" id="5802211">,</span>&nbsp;<span class="ident" id="5802213">err</span>&nbsp;<span class="builtintype" id="5802217">error</span><span class="op" id="5802222">)</span>&nbsp;<span class="op" id="5802224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802227">for</span>&nbsp;<span class="ident" id="5802231">d</span><span class="op" id="5802232">.</span><span class="ident" id="5802233">bytes</span><span class="op" id="5802238">.</span><span class="ident" id="5802239">i</span>&nbsp;<span class="op" id="5802241">==</span>&nbsp;<span class="ident" id="5802244">d</span><span class="op" id="5802245">.</span><span class="ident" id="5802246">bytes</span><span class="op" id="5802251">.</span><span class="ident" id="5802252">j</span>&nbsp;<span class="op" id="5802254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802258">if</span>&nbsp;<span class="ident" id="5802261">err</span>&nbsp;<span class="op" id="5802265">=</span>&nbsp;<span class="ident" id="5802267">d</span><span class="op" id="5802268">.</span><span class="ident" id="5802269">fill</span><span class="op" id="5802273">(</span><span class="op" id="5802274">)</span><span class="op" id="5802275">;</span>&nbsp;<span class="ident" id="5802277">err</span>&nbsp;<span class="op" id="5802281">!=</span>&nbsp;<span class="ident" id="5802284">nil</span>&nbsp;<span class="op" id="5802288">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802293">return</span>&nbsp;<span class="num" id="5802300">0</span><span class="op" id="5802301">,</span>&nbsp;<span class="ident" id="5802303">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802315">x</span>&nbsp;<span class="op" id="5802317">=</span>&nbsp;<span class="ident" id="5802319">d</span><span class="op" id="5802320">.</span><span class="ident" id="5802321">bytes</span><span class="op" id="5802326">.</span><span class="ident" id="5802327">buf</span><span class="op" id="5802330">[</span><span class="ident" id="5802331">d</span><span class="op" id="5802332">.</span><span class="ident" id="5802333">bytes</span><span class="op" id="5802338">.</span><span class="ident" id="5802339">i</span><span class="op" id="5802340">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802343">d</span><span class="op" id="5802344">.</span><span class="ident" id="5802345">bytes</span><span class="op" id="5802350">.</span><span class="ident" id="5802351">i</span><span class="op" id="5802352">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802356">d</span><span class="op" id="5802357">.</span><span class="ident" id="5802358">bytes</span><span class="op" id="5802363">.</span><span class="ident" id="5802364">nUnreadable</span>&nbsp;<span class="op" id="5802376">=</span>&nbsp;<span class="num" id="5802378">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802381">return</span>&nbsp;<span class="ident" id="5802388">x</span><span class="op" id="5802389">,</span>&nbsp;<span class="ident" id="5802391">nil</span><br>
<span class="lineno"></span><span class="op" id="5802395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5802398">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="5802475">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="5802550">var</span>&nbsp;<span class="ident" id="5802554">errMissingFF00</span>&nbsp;<span class="op" id="5802569">=</span>&nbsp;<span class="ident" id="5802571">FormatError</span><span class="op" id="5802582">(</span><span class="string" id="5802583">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="5802608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5802611">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5802689">func</span>&nbsp;<span class="op" id="5802694">(</span><span class="ident" id="5802695">d</span>&nbsp;<span class="op" id="5802697">*</span><span class="ident" id="5802698">decoder</span><span class="op" id="5802705">)</span>&nbsp;<span class="ident" id="5802707">readByteStuffedByte</span><span class="op" id="5802726">(</span><span class="op" id="5802727">)</span>&nbsp;<span class="op" id="5802729">(</span><span class="ident" id="5802730">x</span>&nbsp;<span class="builtintype" id="5802732">byte</span><span class="op" id="5802736">,</span>&nbsp;<span class="ident" id="5802738">err</span>&nbsp;<span class="builtintype" id="5802742">error</span><span class="op" id="5802747">)</span>&nbsp;<span class="op" id="5802749">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802752">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802819">if</span>&nbsp;<span class="ident" id="5802822">d</span><span class="op" id="5802823">.</span><span class="ident" id="5802824">bytes</span><span class="op" id="5802829">.</span><span class="ident" id="5802830">i</span><span class="op" id="5802831">+</span><span class="num" id="5802832">2</span>&nbsp;<span class="op" id="5802834">&lt;=</span>&nbsp;<span class="ident" id="5802837">d</span><span class="op" id="5802838">.</span><span class="ident" id="5802839">bytes</span><span class="op" id="5802844">.</span><span class="ident" id="5802845">j</span>&nbsp;<span class="op" id="5802847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802851">x</span>&nbsp;<span class="op" id="5802853">=</span>&nbsp;<span class="ident" id="5802855">d</span><span class="op" id="5802856">.</span><span class="ident" id="5802857">bytes</span><span class="op" id="5802862">.</span><span class="ident" id="5802863">buf</span><span class="op" id="5802866">[</span><span class="ident" id="5802867">d</span><span class="op" id="5802868">.</span><span class="ident" id="5802869">bytes</span><span class="op" id="5802874">.</span><span class="ident" id="5802875">i</span><span class="op" id="5802876">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802880">d</span><span class="op" id="5802881">.</span><span class="ident" id="5802882">bytes</span><span class="op" id="5802887">.</span><span class="ident" id="5802888">i</span><span class="op" id="5802889">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802894">d</span><span class="op" id="5802895">.</span><span class="ident" id="5802896">bytes</span><span class="op" id="5802901">.</span><span class="ident" id="5802902">nUnreadable</span>&nbsp;<span class="op" id="5802914">=</span>&nbsp;<span class="num" id="5802916">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802920">if</span>&nbsp;<span class="ident" id="5802923">x</span>&nbsp;<span class="op" id="5802925">!=</span>&nbsp;<span class="num" id="5802928">0xff</span>&nbsp;<span class="op" id="5802933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802938">return</span>&nbsp;<span class="ident" id="5802945">x</span><span class="op" id="5802946">,</span>&nbsp;<span class="ident" id="5802948">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802958">if</span>&nbsp;<span class="ident" id="5802961">d</span><span class="op" id="5802962">.</span><span class="ident" id="5802963">bytes</span><span class="op" id="5802968">.</span><span class="ident" id="5802969">buf</span><span class="op" id="5802972">[</span><span class="ident" id="5802973">d</span><span class="op" id="5802974">.</span><span class="ident" id="5802975">bytes</span><span class="op" id="5802980">.</span><span class="ident" id="5802981">i</span><span class="op" id="5802982">]</span>&nbsp;<span class="op" id="5802984">!=</span>&nbsp;<span class="num" id="5802987">0x00</span>&nbsp;<span class="op" id="5802992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802997">return</span>&nbsp;<span class="num" id="5803004">0</span><span class="op" id="5803005">,</span>&nbsp;<span class="ident" id="5803007">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803028">d</span><span class="op" id="5803029">.</span><span class="ident" id="5803030">bytes</span><span class="op" id="5803035">.</span><span class="ident" id="5803036">i</span><span class="op" id="5803037">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803042">d</span><span class="op" id="5803043">.</span><span class="ident" id="5803044">bytes</span><span class="op" id="5803049">.</span><span class="ident" id="5803050">nUnreadable</span>&nbsp;<span class="op" id="5803062">=</span>&nbsp;<span class="num" id="5803064">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803068">return</span>&nbsp;<span class="num" id="5803075">0xff</span><span class="op" id="5803079">,</span>&nbsp;<span class="ident" id="5803081">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803086">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803090">x</span><span class="op" id="5803091">,</span>&nbsp;<span class="ident" id="5803093">err</span>&nbsp;<span class="op" id="5803097">=</span>&nbsp;<span class="ident" id="5803099">d</span><span class="op" id="5803100">.</span><span class="ident" id="5803101">readByte</span><span class="op" id="5803109">(</span><span class="op" id="5803110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803113">if</span>&nbsp;<span class="ident" id="5803116">err</span>&nbsp;<span class="op" id="5803120">!=</span>&nbsp;<span class="ident" id="5803123">nil</span>&nbsp;<span class="op" id="5803127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803131">return</span>&nbsp;<span class="num" id="5803138">0</span><span class="op" id="5803139">,</span>&nbsp;<span class="ident" id="5803141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803146">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803149">if</span>&nbsp;<span class="ident" id="5803152">x</span>&nbsp;<span class="op" id="5803154">!=</span>&nbsp;<span class="num" id="5803157">0xff</span>&nbsp;<span class="op" id="5803162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803166">d</span><span class="op" id="5803167">.</span><span class="ident" id="5803168">bytes</span><span class="op" id="5803173">.</span><span class="ident" id="5803174">nUnreadable</span>&nbsp;<span class="op" id="5803186">=</span>&nbsp;<span class="num" id="5803188">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803192">return</span>&nbsp;<span class="ident" id="5803199">x</span><span class="op" id="5803200">,</span>&nbsp;<span class="ident" id="5803202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803211">x</span><span class="op" id="5803212">,</span>&nbsp;<span class="ident" id="5803214">err</span>&nbsp;<span class="op" id="5803218">=</span>&nbsp;<span class="ident" id="5803220">d</span><span class="op" id="5803221">.</span><span class="ident" id="5803222">readByte</span><span class="op" id="5803230">(</span><span class="op" id="5803231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803234">if</span>&nbsp;<span class="ident" id="5803237">err</span>&nbsp;<span class="op" id="5803241">!=</span>&nbsp;<span class="ident" id="5803244">nil</span>&nbsp;<span class="op" id="5803248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803252">d</span><span class="op" id="5803253">.</span><span class="ident" id="5803254">bytes</span><span class="op" id="5803259">.</span><span class="ident" id="5803260">nUnreadable</span>&nbsp;<span class="op" id="5803272">=</span>&nbsp;<span class="num" id="5803274">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803278">return</span>&nbsp;<span class="num" id="5803285">0</span><span class="op" id="5803286">,</span>&nbsp;<span class="ident" id="5803288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803293">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803296">d</span><span class="op" id="5803297">.</span><span class="ident" id="5803298">bytes</span><span class="op" id="5803303">.</span><span class="ident" id="5803304">nUnreadable</span>&nbsp;<span class="op" id="5803316">=</span>&nbsp;<span class="num" id="5803318">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803321">if</span>&nbsp;<span class="ident" id="5803324">x</span>&nbsp;<span class="op" id="5803326">!=</span>&nbsp;<span class="num" id="5803329">0x00</span>&nbsp;<span class="op" id="5803334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803338">return</span>&nbsp;<span class="num" id="5803345">0</span><span class="op" id="5803346">,</span>&nbsp;<span class="ident" id="5803348">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803367">return</span>&nbsp;<span class="num" id="5803374">0xff</span><span class="op" id="5803378">,</span>&nbsp;<span class="ident" id="5803380">nil</span><br>
<span class="lineno">225</span><span class="op" id="5803384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5803387">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5803462">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5803475">func</span>&nbsp;<span class="op" id="5803480">(</span><span class="ident" id="5803481">d</span>&nbsp;<span class="op" id="5803483">*</span><span class="ident" id="5803484">decoder</span><span class="op" id="5803491">)</span>&nbsp;<span class="ident" id="5803493">readFull</span><span class="op" id="5803501">(</span><span class="ident" id="5803502">p</span>&nbsp;<span class="op" id="5803504">[</span><span class="op" id="5803505">]</span><span class="builtintype" id="5803506">byte</span><span class="op" id="5803510">)</span>&nbsp;<span class="builtintype" id="5803512">error</span>&nbsp;<span class="op" id="5803518">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803521">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803560">if</span>&nbsp;<span class="ident" id="5803563">d</span><span class="op" id="5803564">.</span><span class="ident" id="5803565">bytes</span><span class="op" id="5803570">.</span><span class="ident" id="5803571">nUnreadable</span>&nbsp;<span class="op" id="5803583">!=</span>&nbsp;<span class="num" id="5803586">0</span>&nbsp;<span class="op" id="5803588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803592">if</span>&nbsp;<span class="ident" id="5803595">d</span><span class="op" id="5803596">.</span><span class="ident" id="5803597">bits</span><span class="op" id="5803601">.</span><span class="ident" id="5803602">n</span>&nbsp;<span class="op" id="5803604">&gt;=</span>&nbsp;<span class="num" id="5803607">8</span>&nbsp;<span class="op" id="5803609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803614">d</span><span class="op" id="5803615">.</span><span class="ident" id="5803616">unreadByteStuffedByte</span><span class="op" id="5803637">(</span><span class="op" id="5803638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803642">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803646">d</span><span class="op" id="5803647">.</span><span class="ident" id="5803648">bytes</span><span class="op" id="5803653">.</span><span class="ident" id="5803654">nUnreadable</span>&nbsp;<span class="op" id="5803666">=</span>&nbsp;<span class="num" id="5803668">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803675">for</span>&nbsp;<span class="op" id="5803679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803683">n</span>&nbsp;<span class="op" id="5803685">:=</span>&nbsp;<span class="builtinfunc" id="5803688">copy</span><span class="op" id="5803692">(</span><span class="ident" id="5803693">p</span><span class="op" id="5803694">,</span>&nbsp;<span class="ident" id="5803696">d</span><span class="op" id="5803697">.</span><span class="ident" id="5803698">bytes</span><span class="op" id="5803703">.</span><span class="ident" id="5803704">buf</span><span class="op" id="5803707">[</span><span class="ident" id="5803708">d</span><span class="op" id="5803709">.</span><span class="ident" id="5803710">bytes</span><span class="op" id="5803715">.</span><span class="ident" id="5803716">i</span><span class="op" id="5803717">:</span><span class="ident" id="5803718">d</span><span class="op" id="5803719">.</span><span class="ident" id="5803720">bytes</span><span class="op" id="5803725">.</span><span class="ident" id="5803726">j</span><span class="op" id="5803727">]</span><span class="op" id="5803728">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803732">p</span>&nbsp;<span class="op" id="5803734">=</span>&nbsp;<span class="ident" id="5803736">p</span><span class="op" id="5803737">[</span><span class="ident" id="5803738">n</span><span class="op" id="5803739">:</span><span class="op" id="5803740">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803744">d</span><span class="op" id="5803745">.</span><span class="ident" id="5803746">bytes</span><span class="op" id="5803751">.</span><span class="ident" id="5803752">i</span>&nbsp;<span class="op" id="5803754">+=</span>&nbsp;<span class="ident" id="5803757">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803761">if</span>&nbsp;<span class="builtinfunc" id="5803764">len</span><span class="op" id="5803767">(</span><span class="ident" id="5803768">p</span><span class="op" id="5803769">)</span>&nbsp;<span class="op" id="5803771">==</span>&nbsp;<span class="num" id="5803774">0</span>&nbsp;<span class="op" id="5803776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803781">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803789">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803793">if</span>&nbsp;<span class="ident" id="5803796">err</span>&nbsp;<span class="op" id="5803800">:=</span>&nbsp;<span class="ident" id="5803803">d</span><span class="op" id="5803804">.</span><span class="ident" id="5803805">fill</span><span class="op" id="5803809">(</span><span class="op" id="5803810">)</span><span class="op" id="5803811">;</span>&nbsp;<span class="ident" id="5803813">err</span>&nbsp;<span class="op" id="5803817">!=</span>&nbsp;<span class="ident" id="5803820">nil</span>&nbsp;<span class="op" id="5803824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803829">if</span>&nbsp;<span class="ident" id="5803832">err</span>&nbsp;<span class="op" id="5803836">==</span>&nbsp;<span class="ident" id="5803839">io</span><span class="op" id="5803841">.</span><span class="ident" id="5803842">EOF</span>&nbsp;<span class="op" id="5803846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803852">err</span>&nbsp;<span class="op" id="5803856">=</span>&nbsp;<span class="ident" id="5803858">io</span><span class="op" id="5803860">.</span><span class="ident" id="5803861">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803886">return</span>&nbsp;<span class="ident" id="5803893">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803905">return</span>&nbsp;<span class="ident" id="5803912">nil</span><br>
<span class="lineno"></span><span class="op" id="5803916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5803919">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5803955">func</span>&nbsp;<span class="op" id="5803960">(</span><span class="ident" id="5803961">d</span>&nbsp;<span class="op" id="5803963">*</span><span class="ident" id="5803964">decoder</span><span class="op" id="5803971">)</span>&nbsp;<span class="ident" id="5803973">ignore</span><span class="op" id="5803979">(</span><span class="ident" id="5803980">n</span>&nbsp;<span class="builtintype" id="5803982">int</span><span class="op" id="5803985">)</span>&nbsp;<span class="builtintype" id="5803987">error</span>&nbsp;<span class="op" id="5803993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803996">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804035">if</span>&nbsp;<span class="ident" id="5804038">d</span><span class="op" id="5804039">.</span><span class="ident" id="5804040">bytes</span><span class="op" id="5804045">.</span><span class="ident" id="5804046">nUnreadable</span>&nbsp;<span class="op" id="5804058">!=</span>&nbsp;<span class="num" id="5804061">0</span>&nbsp;<span class="op" id="5804063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804067">if</span>&nbsp;<span class="ident" id="5804070">d</span><span class="op" id="5804071">.</span><span class="ident" id="5804072">bits</span><span class="op" id="5804076">.</span><span class="ident" id="5804077">n</span>&nbsp;<span class="op" id="5804079">&gt;=</span>&nbsp;<span class="num" id="5804082">8</span>&nbsp;<span class="op" id="5804084">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804089">d</span><span class="op" id="5804090">.</span><span class="ident" id="5804091">unreadByteStuffedByte</span><span class="op" id="5804112">(</span><span class="op" id="5804113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804121">d</span><span class="op" id="5804122">.</span><span class="ident" id="5804123">bytes</span><span class="op" id="5804128">.</span><span class="ident" id="5804129">nUnreadable</span>&nbsp;<span class="op" id="5804141">=</span>&nbsp;<span class="num" id="5804143">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804150">for</span>&nbsp;<span class="op" id="5804154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804158">m</span>&nbsp;<span class="op" id="5804160">:=</span>&nbsp;<span class="ident" id="5804163">d</span><span class="op" id="5804164">.</span><span class="ident" id="5804165">bytes</span><span class="op" id="5804170">.</span><span class="ident" id="5804171">j</span>&nbsp;<span class="op" id="5804173">-</span>&nbsp;<span class="ident" id="5804175">d</span><span class="op" id="5804176">.</span><span class="ident" id="5804177">bytes</span><span class="op" id="5804182">.</span><span class="ident" id="5804183">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804187">if</span>&nbsp;<span class="ident" id="5804190">m</span>&nbsp;<span class="op" id="5804192">&gt;</span>&nbsp;<span class="ident" id="5804194">n</span>&nbsp;<span class="op" id="5804196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804201">m</span>&nbsp;<span class="op" id="5804203">=</span>&nbsp;<span class="ident" id="5804205">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804209">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804213">d</span><span class="op" id="5804214">.</span><span class="ident" id="5804215">bytes</span><span class="op" id="5804220">.</span><span class="ident" id="5804221">i</span>&nbsp;<span class="op" id="5804223">+=</span>&nbsp;<span class="ident" id="5804226">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804230">n</span>&nbsp;<span class="op" id="5804232">-=</span>&nbsp;<span class="ident" id="5804235">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804239">if</span>&nbsp;<span class="ident" id="5804242">n</span>&nbsp;<span class="op" id="5804244">==</span>&nbsp;<span class="num" id="5804247">0</span>&nbsp;<span class="op" id="5804249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804254">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804262">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804266">if</span>&nbsp;<span class="ident" id="5804269">err</span>&nbsp;<span class="op" id="5804273">:=</span>&nbsp;<span class="ident" id="5804276">d</span><span class="op" id="5804277">.</span><span class="ident" id="5804278">fill</span><span class="op" id="5804282">(</span><span class="op" id="5804283">)</span><span class="op" id="5804284">;</span>&nbsp;<span class="ident" id="5804286">err</span>&nbsp;<span class="op" id="5804290">!=</span>&nbsp;<span class="ident" id="5804293">nil</span>&nbsp;<span class="op" id="5804297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804302">if</span>&nbsp;<span class="ident" id="5804305">err</span>&nbsp;<span class="op" id="5804309">==</span>&nbsp;<span class="ident" id="5804312">io</span><span class="op" id="5804314">.</span><span class="ident" id="5804315">EOF</span>&nbsp;<span class="op" id="5804319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804325">err</span>&nbsp;<span class="op" id="5804329">=</span>&nbsp;<span class="ident" id="5804331">io</span><span class="op" id="5804333">.</span><span class="ident" id="5804334">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804359">return</span>&nbsp;<span class="ident" id="5804366">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804378">return</span>&nbsp;<span class="ident" id="5804385">nil</span><br>
<span class="lineno"></span><span class="op" id="5804389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5804392">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5804423">func</span>&nbsp;<span class="op" id="5804428">(</span><span class="ident" id="5804429">d</span>&nbsp;<span class="op" id="5804431">*</span><span class="ident" id="5804432">decoder</span><span class="op" id="5804439">)</span>&nbsp;<span class="ident" id="5804441">processSOF</span><span class="op" id="5804451">(</span><span class="ident" id="5804452">n</span>&nbsp;<span class="builtintype" id="5804454">int</span><span class="op" id="5804457">)</span>&nbsp;<span class="builtintype" id="5804459">error</span>&nbsp;<span class="op" id="5804465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804468">switch</span>&nbsp;<span class="ident" id="5804475">n</span>&nbsp;<span class="op" id="5804477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804480">case</span>&nbsp;<span class="num" id="5804485">6</span>&nbsp;<span class="op" id="5804487">+</span>&nbsp;<span class="num" id="5804489">3</span><span class="op" id="5804490">*</span><span class="ident" id="5804491">nGrayComponent</span><span class="op" id="5804505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804509">d</span><span class="op" id="5804510">.</span><span class="ident" id="5804511">nComp</span>&nbsp;<span class="op" id="5804517">=</span>&nbsp;<span class="ident" id="5804519">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804535">case</span>&nbsp;<span class="num" id="5804540">6</span>&nbsp;<span class="op" id="5804542">+</span>&nbsp;<span class="num" id="5804544">3</span><span class="op" id="5804545">*</span><span class="ident" id="5804546">nColorComponent</span><span class="op" id="5804561">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804565">d</span><span class="op" id="5804566">.</span><span class="ident" id="5804567">nComp</span>&nbsp;<span class="op" id="5804573">=</span>&nbsp;<span class="ident" id="5804575">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804592">default</span><span class="op" id="5804599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804603">return</span>&nbsp;<span class="ident" id="5804610">UnsupportedError</span><span class="op" id="5804626">(</span><span class="string" id="5804627">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5804649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804652">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804655">if</span>&nbsp;<span class="ident" id="5804658">err</span>&nbsp;<span class="op" id="5804662">:=</span>&nbsp;<span class="ident" id="5804665">d</span><span class="op" id="5804666">.</span><span class="ident" id="5804667">readFull</span><span class="op" id="5804675">(</span><span class="ident" id="5804676">d</span><span class="op" id="5804677">.</span><span class="ident" id="5804678">tmp</span><span class="op" id="5804681">[</span><span class="op" id="5804682">:</span><span class="ident" id="5804683">n</span><span class="op" id="5804684">]</span><span class="op" id="5804685">)</span><span class="op" id="5804686">;</span>&nbsp;<span class="ident" id="5804688">err</span>&nbsp;<span class="op" id="5804692">!=</span>&nbsp;<span class="ident" id="5804695">nil</span>&nbsp;<span class="op" id="5804699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804703">return</span>&nbsp;<span class="ident" id="5804710">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804718">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804755">if</span>&nbsp;<span class="ident" id="5804758">d</span><span class="op" id="5804759">.</span><span class="ident" id="5804760">tmp</span><span class="op" id="5804763">[</span><span class="num" id="5804764">0</span><span class="op" id="5804765">]</span>&nbsp;<span class="op" id="5804767">!=</span>&nbsp;<span class="num" id="5804770">8</span>&nbsp;<span class="op" id="5804772">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804776">return</span>&nbsp;<span class="ident" id="5804783">UnsupportedError</span><span class="op" id="5804799">(</span><span class="string" id="5804800">&#34;precision&#34;</span><span class="op" id="5804811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804817">d</span><span class="op" id="5804818">.</span><span class="ident" id="5804819">height</span>&nbsp;<span class="op" id="5804826">=</span>&nbsp;<span class="builtintype" id="5804828">int</span><span class="op" id="5804831">(</span><span class="ident" id="5804832">d</span><span class="op" id="5804833">.</span><span class="ident" id="5804834">tmp</span><span class="op" id="5804837">[</span><span class="num" id="5804838">1</span><span class="op" id="5804839">]</span><span class="op" id="5804840">)</span><span class="op" id="5804841">&lt;&lt;</span><span class="num" id="5804843">8</span>&nbsp;<span class="op" id="5804845">+</span>&nbsp;<span class="builtintype" id="5804847">int</span><span class="op" id="5804850">(</span><span class="ident" id="5804851">d</span><span class="op" id="5804852">.</span><span class="ident" id="5804853">tmp</span><span class="op" id="5804856">[</span><span class="num" id="5804857">2</span><span class="op" id="5804858">]</span><span class="op" id="5804859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804862">d</span><span class="op" id="5804863">.</span><span class="ident" id="5804864">width</span>&nbsp;<span class="op" id="5804870">=</span>&nbsp;<span class="builtintype" id="5804872">int</span><span class="op" id="5804875">(</span><span class="ident" id="5804876">d</span><span class="op" id="5804877">.</span><span class="ident" id="5804878">tmp</span><span class="op" id="5804881">[</span><span class="num" id="5804882">3</span><span class="op" id="5804883">]</span><span class="op" id="5804884">)</span><span class="op" id="5804885">&lt;&lt;</span><span class="num" id="5804887">8</span>&nbsp;<span class="op" id="5804889">+</span>&nbsp;<span class="builtintype" id="5804891">int</span><span class="op" id="5804894">(</span><span class="ident" id="5804895">d</span><span class="op" id="5804896">.</span><span class="ident" id="5804897">tmp</span><span class="op" id="5804900">[</span><span class="num" id="5804901">4</span><span class="op" id="5804902">]</span><span class="op" id="5804903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804906">if</span>&nbsp;<span class="builtintype" id="5804909">int</span><span class="op" id="5804912">(</span><span class="ident" id="5804913">d</span><span class="op" id="5804914">.</span><span class="ident" id="5804915">tmp</span><span class="op" id="5804918">[</span><span class="num" id="5804919">5</span><span class="op" id="5804920">]</span><span class="op" id="5804921">)</span>&nbsp;<span class="op" id="5804923">!=</span>&nbsp;<span class="ident" id="5804926">d</span><span class="op" id="5804927">.</span><span class="ident" id="5804928">nComp</span>&nbsp;<span class="op" id="5804934">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804938">return</span>&nbsp;<span class="ident" id="5804945">UnsupportedError</span><span class="op" id="5804961">(</span><span class="string" id="5804962">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="5805004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805010">for</span>&nbsp;<span class="ident" id="5805014">i</span>&nbsp;<span class="op" id="5805016">:=</span>&nbsp;<span class="num" id="5805019">0</span><span class="op" id="5805020">;</span>&nbsp;<span class="ident" id="5805022">i</span>&nbsp;<span class="op" id="5805024">&lt;</span>&nbsp;<span class="ident" id="5805026">d</span><span class="op" id="5805027">.</span><span class="ident" id="5805028">nComp</span><span class="op" id="5805033">;</span>&nbsp;<span class="ident" id="5805035">i</span><span class="op" id="5805036">++</span>&nbsp;<span class="op" id="5805039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805043">d</span><span class="op" id="5805044">.</span><span class="ident" id="5805045">comp</span><span class="op" id="5805049">[</span><span class="ident" id="5805050">i</span><span class="op" id="5805051">]</span><span class="op" id="5805052">.</span><span class="ident" id="5805053">c</span>&nbsp;<span class="op" id="5805055">=</span>&nbsp;<span class="ident" id="5805057">d</span><span class="op" id="5805058">.</span><span class="ident" id="5805059">tmp</span><span class="op" id="5805062">[</span><span class="num" id="5805063">6</span><span class="op" id="5805064">+</span><span class="num" id="5805065">3</span><span class="op" id="5805066">*</span><span class="ident" id="5805067">i</span><span class="op" id="5805068">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805072">d</span><span class="op" id="5805073">.</span><span class="ident" id="5805074">comp</span><span class="op" id="5805078">[</span><span class="ident" id="5805079">i</span><span class="op" id="5805080">]</span><span class="op" id="5805081">.</span><span class="ident" id="5805082">tq</span>&nbsp;<span class="op" id="5805085">=</span>&nbsp;<span class="ident" id="5805087">d</span><span class="op" id="5805088">.</span><span class="ident" id="5805089">tmp</span><span class="op" id="5805092">[</span><span class="num" id="5805093">8</span><span class="op" id="5805094">+</span><span class="num" id="5805095">3</span><span class="op" id="5805096">*</span><span class="ident" id="5805097">i</span><span class="op" id="5805098">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805102">if</span>&nbsp;<span class="ident" id="5805105">d</span><span class="op" id="5805106">.</span><span class="ident" id="5805107">nComp</span>&nbsp;<span class="op" id="5805113">==</span>&nbsp;<span class="ident" id="5805116">nGrayComponent</span>&nbsp;<span class="op" id="5805131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805136">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805210">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805283">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805359">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805436">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805512">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805589">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805665">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805741">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805818">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805891">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805922">d</span><span class="op" id="5805923">.</span><span class="ident" id="5805924">comp</span><span class="op" id="5805928">[</span><span class="ident" id="5805929">i</span><span class="op" id="5805930">]</span><span class="op" id="5805931">.</span><span class="ident" id="5805932">h</span>&nbsp;<span class="op" id="5805934">=</span>&nbsp;<span class="num" id="5805936">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805941">d</span><span class="op" id="5805942">.</span><span class="ident" id="5805943">comp</span><span class="op" id="5805947">[</span><span class="ident" id="5805948">i</span><span class="op" id="5805949">]</span><span class="op" id="5805950">.</span><span class="ident" id="5805951">v</span>&nbsp;<span class="op" id="5805953">=</span>&nbsp;<span class="num" id="5805955">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805960">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805975">hv</span>&nbsp;<span class="op" id="5805978">:=</span>&nbsp;<span class="ident" id="5805981">d</span><span class="op" id="5805982">.</span><span class="ident" id="5805983">tmp</span><span class="op" id="5805986">[</span><span class="num" id="5805987">7</span><span class="op" id="5805988">+</span><span class="num" id="5805989">3</span><span class="op" id="5805990">*</span><span class="ident" id="5805991">i</span><span class="op" id="5805992">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805996">d</span><span class="op" id="5805997">.</span><span class="ident" id="5805998">comp</span><span class="op" id="5806002">[</span><span class="ident" id="5806003">i</span><span class="op" id="5806004">]</span><span class="op" id="5806005">.</span><span class="ident" id="5806006">h</span>&nbsp;<span class="op" id="5806008">=</span>&nbsp;<span class="builtintype" id="5806010">int</span><span class="op" id="5806013">(</span><span class="ident" id="5806014">hv</span>&nbsp;<span class="op" id="5806017">&gt;&gt;</span>&nbsp;<span class="num" id="5806020">4</span><span class="op" id="5806021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806025">d</span><span class="op" id="5806026">.</span><span class="ident" id="5806027">comp</span><span class="op" id="5806031">[</span><span class="ident" id="5806032">i</span><span class="op" id="5806033">]</span><span class="op" id="5806034">.</span><span class="ident" id="5806035">v</span>&nbsp;<span class="op" id="5806037">=</span>&nbsp;<span class="builtintype" id="5806039">int</span><span class="op" id="5806042">(</span><span class="ident" id="5806043">hv</span>&nbsp;<span class="op" id="5806046">&amp;</span>&nbsp;<span class="num" id="5806048">0x0f</span><span class="op" id="5806052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806056">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806131">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806203">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806278">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806335">if</span>&nbsp;<span class="ident" id="5806338">i</span>&nbsp;<span class="op" id="5806340">==</span>&nbsp;<span class="num" id="5806343">0</span>&nbsp;<span class="op" id="5806345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806350">if</span>&nbsp;<span class="ident" id="5806353">hv</span>&nbsp;<span class="op" id="5806356">!=</span>&nbsp;<span class="num" id="5806359">0x11</span>&nbsp;<span class="op" id="5806364">&amp;&amp;</span>&nbsp;<span class="ident" id="5806367">hv</span>&nbsp;<span class="op" id="5806370">!=</span>&nbsp;<span class="num" id="5806373">0x21</span>&nbsp;<span class="op" id="5806378">&amp;&amp;</span>&nbsp;<span class="ident" id="5806381">hv</span>&nbsp;<span class="op" id="5806384">!=</span>&nbsp;<span class="num" id="5806387">0x22</span>&nbsp;<span class="op" id="5806392">&amp;&amp;</span>&nbsp;<span class="ident" id="5806395">hv</span>&nbsp;<span class="op" id="5806398">!=</span>&nbsp;<span class="num" id="5806401">0x12</span>&nbsp;<span class="op" id="5806406">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806412">return</span>&nbsp;<span class="ident" id="5806419">UnsupportedError</span><span class="op" id="5806435">(</span><span class="string" id="5806436">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5806466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806475">}</span>&nbsp;<span class="keyword" id="5806477">else</span>&nbsp;<span class="keyword" id="5806482">if</span>&nbsp;<span class="ident" id="5806485">hv</span>&nbsp;<span class="op" id="5806488">!=</span>&nbsp;<span class="num" id="5806491">0x11</span>&nbsp;<span class="op" id="5806496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806501">return</span>&nbsp;<span class="ident" id="5806508">UnsupportedError</span><span class="op" id="5806524">(</span><span class="string" id="5806525">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5806555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806559">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806565">return</span>&nbsp;<span class="ident" id="5806572">nil</span><br>
<span class="lineno"></span><span class="op" id="5806576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5806579">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="5806612">func</span>&nbsp;<span class="op" id="5806617">(</span><span class="ident" id="5806618">d</span>&nbsp;<span class="op" id="5806620">*</span><span class="ident" id="5806621">decoder</span><span class="op" id="5806628">)</span>&nbsp;<span class="ident" id="5806630">processDQT</span><span class="op" id="5806640">(</span><span class="ident" id="5806641">n</span>&nbsp;<span class="builtintype" id="5806643">int</span><span class="op" id="5806646">)</span>&nbsp;<span class="builtintype" id="5806648">error</span>&nbsp;<span class="op" id="5806654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806657">const</span>&nbsp;<span class="ident" id="5806663">qtLength</span>&nbsp;<span class="op" id="5806672">=</span>&nbsp;<span class="num" id="5806674">1</span>&nbsp;<span class="op" id="5806676">+</span>&nbsp;<span class="ident" id="5806678">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806689">for</span>&nbsp;<span class="op" id="5806693">;</span>&nbsp;<span class="ident" id="5806695">n</span>&nbsp;<span class="op" id="5806697">&gt;=</span>&nbsp;<span class="ident" id="5806700">qtLength</span><span class="op" id="5806708">;</span>&nbsp;<span class="ident" id="5806710">n</span>&nbsp;<span class="op" id="5806712">-=</span>&nbsp;<span class="ident" id="5806715">qtLength</span>&nbsp;<span class="op" id="5806724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806728">if</span>&nbsp;<span class="ident" id="5806731">err</span>&nbsp;<span class="op" id="5806735">:=</span>&nbsp;<span class="ident" id="5806738">d</span><span class="op" id="5806739">.</span><span class="ident" id="5806740">readFull</span><span class="op" id="5806748">(</span><span class="ident" id="5806749">d</span><span class="op" id="5806750">.</span><span class="ident" id="5806751">tmp</span><span class="op" id="5806754">[</span><span class="op" id="5806755">:</span><span class="ident" id="5806756">qtLength</span><span class="op" id="5806764">]</span><span class="op" id="5806765">)</span><span class="op" id="5806766">;</span>&nbsp;<span class="ident" id="5806768">err</span>&nbsp;<span class="op" id="5806772">!=</span>&nbsp;<span class="ident" id="5806775">nil</span>&nbsp;<span class="op" id="5806779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806784">return</span>&nbsp;<span class="ident" id="5806791">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806801">pq</span>&nbsp;<span class="op" id="5806804">:=</span>&nbsp;<span class="ident" id="5806807">d</span><span class="op" id="5806808">.</span><span class="ident" id="5806809">tmp</span><span class="op" id="5806812">[</span><span class="num" id="5806813">0</span><span class="op" id="5806814">]</span>&nbsp;<span class="op" id="5806816">&gt;&gt;</span>&nbsp;<span class="num" id="5806819">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806823">if</span>&nbsp;<span class="ident" id="5806826">pq</span>&nbsp;<span class="op" id="5806829">!=</span>&nbsp;<span class="num" id="5806832">0</span>&nbsp;<span class="op" id="5806834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806839">return</span>&nbsp;<span class="ident" id="5806846">UnsupportedError</span><span class="op" id="5806862">(</span><span class="string" id="5806863">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="5806877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806881">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806885">tq</span>&nbsp;<span class="op" id="5806888">:=</span>&nbsp;<span class="ident" id="5806891">d</span><span class="op" id="5806892">.</span><span class="ident" id="5806893">tmp</span><span class="op" id="5806896">[</span><span class="num" id="5806897">0</span><span class="op" id="5806898">]</span>&nbsp;<span class="op" id="5806900">&amp;</span>&nbsp;<span class="num" id="5806902">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806909">if</span>&nbsp;<span class="ident" id="5806912">tq</span>&nbsp;<span class="op" id="5806915">&gt;</span>&nbsp;<span class="ident" id="5806917">maxTq</span>&nbsp;<span class="op" id="5806923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806928">return</span>&nbsp;<span class="ident" id="5806935">FormatError</span><span class="op" id="5806946">(</span><span class="string" id="5806947">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="5806961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806969">for</span>&nbsp;<span class="ident" id="5806973">i</span>&nbsp;<span class="op" id="5806975">:=</span>&nbsp;<span class="keyword" id="5806978">range</span>&nbsp;<span class="ident" id="5806984">d</span><span class="op" id="5806985">.</span><span class="ident" id="5806986">quant</span><span class="op" id="5806991">[</span><span class="ident" id="5806992">tq</span><span class="op" id="5806994">]</span>&nbsp;<span class="op" id="5806996">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807001">d</span><span class="op" id="5807002">.</span><span class="ident" id="5807003">quant</span><span class="op" id="5807008">[</span><span class="ident" id="5807009">tq</span><span class="op" id="5807011">]</span><span class="op" id="5807012">[</span><span class="ident" id="5807013">i</span><span class="op" id="5807014">]</span>&nbsp;<span class="op" id="5807016">=</span>&nbsp;<span class="builtintype" id="5807018">int32</span><span class="op" id="5807023">(</span><span class="ident" id="5807024">d</span><span class="op" id="5807025">.</span><span class="ident" id="5807026">tmp</span><span class="op" id="5807029">[</span><span class="ident" id="5807030">i</span><span class="op" id="5807031">+</span><span class="num" id="5807032">1</span><span class="op" id="5807033">]</span><span class="op" id="5807034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807044">if</span>&nbsp;<span class="ident" id="5807047">n</span>&nbsp;<span class="op" id="5807049">!=</span>&nbsp;<span class="num" id="5807052">0</span>&nbsp;<span class="op" id="5807054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807058">return</span>&nbsp;<span class="ident" id="5807065">FormatError</span><span class="op" id="5807076">(</span><span class="string" id="5807077">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5807099">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807105">return</span>&nbsp;<span class="ident" id="5807112">nil</span><br>
<span class="lineno"></span><span class="op" id="5807116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5807119">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="5807152">func</span>&nbsp;<span class="op" id="5807157">(</span><span class="ident" id="5807158">d</span>&nbsp;<span class="op" id="5807160">*</span><span class="ident" id="5807161">decoder</span><span class="op" id="5807168">)</span>&nbsp;<span class="ident" id="5807170">processDRI</span><span class="op" id="5807180">(</span><span class="ident" id="5807181">n</span>&nbsp;<span class="builtintype" id="5807183">int</span><span class="op" id="5807186">)</span>&nbsp;<span class="builtintype" id="5807188">error</span>&nbsp;<span class="op" id="5807194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807197">if</span>&nbsp;<span class="ident" id="5807200">n</span>&nbsp;<span class="op" id="5807202">!=</span>&nbsp;<span class="num" id="5807205">2</span>&nbsp;<span class="op" id="5807207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807211">return</span>&nbsp;<span class="ident" id="5807218">FormatError</span><span class="op" id="5807229">(</span><span class="string" id="5807230">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5807252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807258">if</span>&nbsp;<span class="ident" id="5807261">err</span>&nbsp;<span class="op" id="5807265">:=</span>&nbsp;<span class="ident" id="5807268">d</span><span class="op" id="5807269">.</span><span class="ident" id="5807270">readFull</span><span class="op" id="5807278">(</span><span class="ident" id="5807279">d</span><span class="op" id="5807280">.</span><span class="ident" id="5807281">tmp</span><span class="op" id="5807284">[</span><span class="op" id="5807285">:</span><span class="num" id="5807286">2</span><span class="op" id="5807287">]</span><span class="op" id="5807288">)</span><span class="op" id="5807289">;</span>&nbsp;<span class="ident" id="5807291">err</span>&nbsp;<span class="op" id="5807295">!=</span>&nbsp;<span class="ident" id="5807298">nil</span>&nbsp;<span class="op" id="5807302">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807306">return</span>&nbsp;<span class="ident" id="5807313">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807321">d</span><span class="op" id="5807322">.</span><span class="ident" id="5807323">ri</span>&nbsp;<span class="op" id="5807326">=</span>&nbsp;<span class="builtintype" id="5807328">int</span><span class="op" id="5807331">(</span><span class="ident" id="5807332">d</span><span class="op" id="5807333">.</span><span class="ident" id="5807334">tmp</span><span class="op" id="5807337">[</span><span class="num" id="5807338">0</span><span class="op" id="5807339">]</span><span class="op" id="5807340">)</span><span class="op" id="5807341">&lt;&lt;</span><span class="num" id="5807343">8</span>&nbsp;<span class="op" id="5807345">+</span>&nbsp;<span class="builtintype" id="5807347">int</span><span class="op" id="5807350">(</span><span class="ident" id="5807351">d</span><span class="op" id="5807352">.</span><span class="ident" id="5807353">tmp</span><span class="op" id="5807356">[</span><span class="num" id="5807357">1</span><span class="op" id="5807358">]</span><span class="op" id="5807359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807362">return</span>&nbsp;<span class="ident" id="5807369">nil</span><br>
<span class="lineno"></span><span class="op" id="5807373">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5807376">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5807446">func</span>&nbsp;<span class="op" id="5807451">(</span><span class="ident" id="5807452">d</span>&nbsp;<span class="op" id="5807454">*</span><span class="ident" id="5807455">decoder</span><span class="op" id="5807462">)</span>&nbsp;<span class="ident" id="5807464">decode</span><span class="op" id="5807470">(</span><span class="ident" id="5807471">r</span>&nbsp;<span class="ident" id="5807473">io</span><span class="op" id="5807475">.</span><span class="ident" id="5807476">Reader</span><span class="op" id="5807482">,</span>&nbsp;<span class="ident" id="5807484">configOnly</span>&nbsp;<span class="builtintype" id="5807495">bool</span><span class="op" id="5807499">)</span>&nbsp;<span class="op" id="5807501">(</span><span class="ident" id="5807502">image</span><span class="op" id="5807507">.</span><span class="ident" id="5807508">Image</span><span class="op" id="5807513">,</span>&nbsp;<span class="builtintype" id="5807515">error</span><span class="op" id="5807520">)</span>&nbsp;<span class="op" id="5807522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807525">d</span><span class="op" id="5807526">.</span><span class="ident" id="5807527">r</span>&nbsp;<span class="op" id="5807529">=</span>&nbsp;<span class="ident" id="5807531">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807535">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807576">if</span>&nbsp;<span class="ident" id="5807579">err</span>&nbsp;<span class="op" id="5807583">:=</span>&nbsp;<span class="ident" id="5807586">d</span><span class="op" id="5807587">.</span><span class="ident" id="5807588">readFull</span><span class="op" id="5807596">(</span><span class="ident" id="5807597">d</span><span class="op" id="5807598">.</span><span class="ident" id="5807599">tmp</span><span class="op" id="5807602">[</span><span class="op" id="5807603">:</span><span class="num" id="5807604">2</span><span class="op" id="5807605">]</span><span class="op" id="5807606">)</span><span class="op" id="5807607">;</span>&nbsp;<span class="ident" id="5807609">err</span>&nbsp;<span class="op" id="5807613">!=</span>&nbsp;<span class="ident" id="5807616">nil</span>&nbsp;<span class="op" id="5807620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807624">return</span>&nbsp;<span class="ident" id="5807631">nil</span><span class="op" id="5807634">,</span>&nbsp;<span class="ident" id="5807636">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807644">if</span>&nbsp;<span class="ident" id="5807647">d</span><span class="op" id="5807648">.</span><span class="ident" id="5807649">tmp</span><span class="op" id="5807652">[</span><span class="num" id="5807653">0</span><span class="op" id="5807654">]</span>&nbsp;<span class="op" id="5807656">!=</span>&nbsp;<span class="num" id="5807659">0xff</span>&nbsp;<span class="op" id="5807664">||</span>&nbsp;<span class="ident" id="5807667">d</span><span class="op" id="5807668">.</span><span class="ident" id="5807669">tmp</span><span class="op" id="5807672">[</span><span class="num" id="5807673">1</span><span class="op" id="5807674">]</span>&nbsp;<span class="op" id="5807676">!=</span>&nbsp;<span class="ident" id="5807679">soiMarker</span>&nbsp;<span class="op" id="5807689">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807693">return</span>&nbsp;<span class="ident" id="5807700">nil</span><span class="op" id="5807703">,</span>&nbsp;<span class="ident" id="5807705">FormatError</span><span class="op" id="5807716">(</span><span class="string" id="5807717">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="5807737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807744">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807810">for</span>&nbsp;<span class="op" id="5807814">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807818">err</span>&nbsp;<span class="op" id="5807822">:=</span>&nbsp;<span class="ident" id="5807825">d</span><span class="op" id="5807826">.</span><span class="ident" id="5807827">readFull</span><span class="op" id="5807835">(</span><span class="ident" id="5807836">d</span><span class="op" id="5807837">.</span><span class="ident" id="5807838">tmp</span><span class="op" id="5807841">[</span><span class="op" id="5807842">:</span><span class="num" id="5807843">2</span><span class="op" id="5807844">]</span><span class="op" id="5807845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807849">if</span>&nbsp;<span class="ident" id="5807852">err</span>&nbsp;<span class="op" id="5807856">!=</span>&nbsp;<span class="ident" id="5807859">nil</span>&nbsp;<span class="op" id="5807863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807868">return</span>&nbsp;<span class="ident" id="5807875">nil</span><span class="op" id="5807878">,</span>&nbsp;<span class="ident" id="5807880">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807890">for</span>&nbsp;<span class="ident" id="5807894">d</span><span class="op" id="5807895">.</span><span class="ident" id="5807896">tmp</span><span class="op" id="5807899">[</span><span class="num" id="5807900">0</span><span class="op" id="5807901">]</span>&nbsp;<span class="op" id="5807903">!=</span>&nbsp;<span class="num" id="5807906">0xff</span>&nbsp;<span class="op" id="5807911">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807916">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807985">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808051">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808120">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808187">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808257">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808323">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808392">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808464">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808531">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808603">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808627">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808633">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808704">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808731">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808737">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808804">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808858">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808864">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808934">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809001">d</span><span class="op" id="5809002">.</span><span class="ident" id="5809003">tmp</span><span class="op" id="5809006">[</span><span class="num" id="5809007">0</span><span class="op" id="5809008">]</span>&nbsp;<span class="op" id="5809010">=</span>&nbsp;<span class="ident" id="5809012">d</span><span class="op" id="5809013">.</span><span class="ident" id="5809014">tmp</span><span class="op" id="5809017">[</span><span class="num" id="5809018">1</span><span class="op" id="5809019">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809024">d</span><span class="op" id="5809025">.</span><span class="ident" id="5809026">tmp</span><span class="op" id="5809029">[</span><span class="num" id="5809030">1</span><span class="op" id="5809031">]</span><span class="op" id="5809032">,</span>&nbsp;<span class="ident" id="5809034">err</span>&nbsp;<span class="op" id="5809038">=</span>&nbsp;<span class="ident" id="5809040">d</span><span class="op" id="5809041">.</span><span class="ident" id="5809042">readByte</span><span class="op" id="5809050">(</span><span class="op" id="5809051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809056">if</span>&nbsp;<span class="ident" id="5809059">err</span>&nbsp;<span class="op" id="5809063">!=</span>&nbsp;<span class="ident" id="5809066">nil</span>&nbsp;<span class="op" id="5809070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809076">return</span>&nbsp;<span class="ident" id="5809083">nil</span><span class="op" id="5809086">,</span>&nbsp;<span class="ident" id="5809088">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809095">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809103">marker</span>&nbsp;<span class="op" id="5809110">:=</span>&nbsp;<span class="ident" id="5809113">d</span><span class="op" id="5809114">.</span><span class="ident" id="5809115">tmp</span><span class="op" id="5809118">[</span><span class="num" id="5809119">1</span><span class="op" id="5809120">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809124">if</span>&nbsp;<span class="ident" id="5809127">marker</span>&nbsp;<span class="op" id="5809134">==</span>&nbsp;<span class="num" id="5809137">0</span>&nbsp;<span class="op" id="5809139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809144">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809187">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809202">for</span>&nbsp;<span class="ident" id="5809206">marker</span>&nbsp;<span class="op" id="5809213">==</span>&nbsp;<span class="num" id="5809216">0xff</span>&nbsp;<span class="op" id="5809221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809226">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809300">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809366">marker</span><span class="op" id="5809372">,</span>&nbsp;<span class="ident" id="5809374">err</span>&nbsp;<span class="op" id="5809378">=</span>&nbsp;<span class="ident" id="5809380">d</span><span class="op" id="5809381">.</span><span class="ident" id="5809382">readByte</span><span class="op" id="5809390">(</span><span class="op" id="5809391">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809396">if</span>&nbsp;<span class="ident" id="5809399">err</span>&nbsp;<span class="op" id="5809403">!=</span>&nbsp;<span class="ident" id="5809406">nil</span>&nbsp;<span class="op" id="5809410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809416">return</span>&nbsp;<span class="ident" id="5809423">nil</span><span class="op" id="5809426">,</span>&nbsp;<span class="ident" id="5809428">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809443">if</span>&nbsp;<span class="ident" id="5809446">marker</span>&nbsp;<span class="op" id="5809453">==</span>&nbsp;<span class="ident" id="5809456">eoiMarker</span>&nbsp;<span class="op" id="5809466">{</span>&nbsp;<span class="comment" id="5809468">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809488">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809500">if</span>&nbsp;<span class="ident" id="5809503">rst0Marker</span>&nbsp;<span class="op" id="5809514">&lt;=</span>&nbsp;<span class="ident" id="5809517">marker</span>&nbsp;<span class="op" id="5809524">&amp;&amp;</span>&nbsp;<span class="ident" id="5809527">marker</span>&nbsp;<span class="op" id="5809534">&lt;=</span>&nbsp;<span class="ident" id="5809537">rst7Marker</span>&nbsp;<span class="op" id="5809548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809553">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809637">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809714">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809793">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809878">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809964">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810040">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810056">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810139">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810214">if</span>&nbsp;<span class="ident" id="5810217">err</span>&nbsp;<span class="op" id="5810221">=</span>&nbsp;<span class="ident" id="5810223">d</span><span class="op" id="5810224">.</span><span class="ident" id="5810225">readFull</span><span class="op" id="5810233">(</span><span class="ident" id="5810234">d</span><span class="op" id="5810235">.</span><span class="ident" id="5810236">tmp</span><span class="op" id="5810239">[</span><span class="op" id="5810240">:</span><span class="num" id="5810241">2</span><span class="op" id="5810242">]</span><span class="op" id="5810243">)</span><span class="op" id="5810244">;</span>&nbsp;<span class="ident" id="5810246">err</span>&nbsp;<span class="op" id="5810250">!=</span>&nbsp;<span class="ident" id="5810253">nil</span>&nbsp;<span class="op" id="5810257">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810262">return</span>&nbsp;<span class="ident" id="5810269">nil</span><span class="op" id="5810272">,</span>&nbsp;<span class="ident" id="5810274">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810284">n</span>&nbsp;<span class="op" id="5810286">:=</span>&nbsp;<span class="builtintype" id="5810289">int</span><span class="op" id="5810292">(</span><span class="ident" id="5810293">d</span><span class="op" id="5810294">.</span><span class="ident" id="5810295">tmp</span><span class="op" id="5810298">[</span><span class="num" id="5810299">0</span><span class="op" id="5810300">]</span><span class="op" id="5810301">)</span><span class="op" id="5810302">&lt;&lt;</span><span class="num" id="5810304">8</span>&nbsp;<span class="op" id="5810306">+</span>&nbsp;<span class="builtintype" id="5810308">int</span><span class="op" id="5810311">(</span><span class="ident" id="5810312">d</span><span class="op" id="5810313">.</span><span class="ident" id="5810314">tmp</span><span class="op" id="5810317">[</span><span class="num" id="5810318">1</span><span class="op" id="5810319">]</span><span class="op" id="5810320">)</span>&nbsp;<span class="op" id="5810322">-</span>&nbsp;<span class="num" id="5810324">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810328">if</span>&nbsp;<span class="ident" id="5810331">n</span>&nbsp;<span class="op" id="5810333">&lt;</span>&nbsp;<span class="num" id="5810335">0</span>&nbsp;<span class="op" id="5810337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810342">return</span>&nbsp;<span class="ident" id="5810349">nil</span><span class="op" id="5810352">,</span>&nbsp;<span class="ident" id="5810354">FormatError</span><span class="op" id="5810365">(</span><span class="string" id="5810366">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="5810388">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810397">switch</span>&nbsp;<span class="op" id="5810404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810408">case</span>&nbsp;<span class="ident" id="5810413">marker</span>&nbsp;<span class="op" id="5810420">==</span>&nbsp;<span class="ident" id="5810423">sof0Marker</span>&nbsp;<span class="op" id="5810434">||</span>&nbsp;<span class="ident" id="5810437">marker</span>&nbsp;<span class="op" id="5810444">==</span>&nbsp;<span class="ident" id="5810447">sof2Marker</span><span class="op" id="5810457">:</span>&nbsp;<span class="comment" id="5810459">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810481">d</span><span class="op" id="5810482">.</span><span class="ident" id="5810483">progressive</span>&nbsp;<span class="op" id="5810495">=</span>&nbsp;<span class="ident" id="5810497">marker</span>&nbsp;<span class="op" id="5810504">==</span>&nbsp;<span class="ident" id="5810507">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810521">err</span>&nbsp;<span class="op" id="5810525">=</span>&nbsp;<span class="ident" id="5810527">d</span><span class="op" id="5810528">.</span><span class="ident" id="5810529">processSOF</span><span class="op" id="5810539">(</span><span class="ident" id="5810540">n</span><span class="op" id="5810541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810546">if</span>&nbsp;<span class="ident" id="5810549">configOnly</span>&nbsp;<span class="op" id="5810560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810566">return</span>&nbsp;<span class="ident" id="5810573">nil</span><span class="op" id="5810576">,</span>&nbsp;<span class="ident" id="5810578">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810589">case</span>&nbsp;<span class="ident" id="5810594">marker</span>&nbsp;<span class="op" id="5810601">==</span>&nbsp;<span class="ident" id="5810604">dhtMarker</span><span class="op" id="5810613">:</span>&nbsp;<span class="comment" id="5810615">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810643">err</span>&nbsp;<span class="op" id="5810647">=</span>&nbsp;<span class="ident" id="5810649">d</span><span class="op" id="5810650">.</span><span class="ident" id="5810651">processDHT</span><span class="op" id="5810661">(</span><span class="ident" id="5810662">n</span><span class="op" id="5810663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810667">case</span>&nbsp;<span class="ident" id="5810672">marker</span>&nbsp;<span class="op" id="5810679">==</span>&nbsp;<span class="ident" id="5810682">dqtMarker</span><span class="op" id="5810691">:</span>&nbsp;<span class="comment" id="5810693">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810726">err</span>&nbsp;<span class="op" id="5810730">=</span>&nbsp;<span class="ident" id="5810732">d</span><span class="op" id="5810733">.</span><span class="ident" id="5810734">processDQT</span><span class="op" id="5810744">(</span><span class="ident" id="5810745">n</span><span class="op" id="5810746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810750">case</span>&nbsp;<span class="ident" id="5810755">marker</span>&nbsp;<span class="op" id="5810762">==</span>&nbsp;<span class="ident" id="5810765">sosMarker</span><span class="op" id="5810774">:</span>&nbsp;<span class="comment" id="5810776">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810797">err</span>&nbsp;<span class="op" id="5810801">=</span>&nbsp;<span class="ident" id="5810803">d</span><span class="op" id="5810804">.</span><span class="ident" id="5810805">processSOS</span><span class="op" id="5810815">(</span><span class="ident" id="5810816">n</span><span class="op" id="5810817">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810821">case</span>&nbsp;<span class="ident" id="5810826">marker</span>&nbsp;<span class="op" id="5810833">==</span>&nbsp;<span class="ident" id="5810836">driMarker</span><span class="op" id="5810845">:</span>&nbsp;<span class="comment" id="5810847">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810878">err</span>&nbsp;<span class="op" id="5810882">=</span>&nbsp;<span class="ident" id="5810884">d</span><span class="op" id="5810885">.</span><span class="ident" id="5810886">processDRI</span><span class="op" id="5810896">(</span><span class="ident" id="5810897">n</span><span class="op" id="5810898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810902">case</span>&nbsp;<span class="ident" id="5810907">app0Marker</span>&nbsp;<span class="op" id="5810918">&lt;=</span>&nbsp;<span class="ident" id="5810921">marker</span>&nbsp;<span class="op" id="5810928">&amp;&amp;</span>&nbsp;<span class="ident" id="5810931">marker</span>&nbsp;<span class="op" id="5810938">&lt;=</span>&nbsp;<span class="ident" id="5810941">app15Marker</span>&nbsp;<span class="op" id="5810953">||</span>&nbsp;<span class="ident" id="5810956">marker</span>&nbsp;<span class="op" id="5810963">==</span>&nbsp;<span class="ident" id="5810966">comMarker</span><span class="op" id="5810975">:</span>&nbsp;<span class="comment" id="5810977">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811017">err</span>&nbsp;<span class="op" id="5811021">=</span>&nbsp;<span class="ident" id="5811023">d</span><span class="op" id="5811024">.</span><span class="ident" id="5811025">ignore</span><span class="op" id="5811031">(</span><span class="ident" id="5811032">n</span><span class="op" id="5811033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811037">default</span><span class="op" id="5811044">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811049">err</span>&nbsp;<span class="op" id="5811053">=</span>&nbsp;<span class="ident" id="5811055">UnsupportedError</span><span class="op" id="5811071">(</span><span class="string" id="5811072">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="5811088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811096">if</span>&nbsp;<span class="ident" id="5811099">err</span>&nbsp;<span class="op" id="5811103">!=</span>&nbsp;<span class="ident" id="5811106">nil</span>&nbsp;<span class="op" id="5811110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811115">return</span>&nbsp;<span class="ident" id="5811122">nil</span><span class="op" id="5811125">,</span>&nbsp;<span class="ident" id="5811127">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811133">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811139">if</span>&nbsp;<span class="ident" id="5811142">d</span><span class="op" id="5811143">.</span><span class="ident" id="5811144">img1</span>&nbsp;<span class="op" id="5811149">!=</span>&nbsp;<span class="ident" id="5811152">nil</span>&nbsp;<span class="op" id="5811156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811160">return</span>&nbsp;<span class="ident" id="5811167">d</span><span class="op" id="5811168">.</span><span class="ident" id="5811169">img1</span><span class="op" id="5811173">,</span>&nbsp;<span class="ident" id="5811175">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811183">if</span>&nbsp;<span class="ident" id="5811186">d</span><span class="op" id="5811187">.</span><span class="ident" id="5811188">img3</span>&nbsp;<span class="op" id="5811193">!=</span>&nbsp;<span class="ident" id="5811196">nil</span>&nbsp;<span class="op" id="5811200">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811204">return</span>&nbsp;<span class="ident" id="5811211">d</span><span class="op" id="5811212">.</span><span class="ident" id="5811213">img3</span><span class="op" id="5811217">,</span>&nbsp;<span class="ident" id="5811219">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811227">return</span>&nbsp;<span class="ident" id="5811234">nil</span><span class="op" id="5811237">,</span>&nbsp;<span class="ident" id="5811239">FormatError</span><span class="op" id="5811250">(</span><span class="string" id="5811251">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="5811271">)</span><br>
<span class="lineno"></span><span class="op" id="5811273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5811276">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5811346">func</span>&nbsp;<span class="ident" id="5811351">Decode</span><span class="op" id="5811357">(</span><span class="ident" id="5811358">r</span>&nbsp;<span class="ident" id="5811360">io</span><span class="op" id="5811362">.</span><span class="ident" id="5811363">Reader</span><span class="op" id="5811369">)</span>&nbsp;<span class="op" id="5811371">(</span><span class="ident" id="5811372">image</span><span class="op" id="5811377">.</span><span class="ident" id="5811378">Image</span><span class="op" id="5811383">,</span>&nbsp;<span class="builtintype" id="5811385">error</span><span class="op" id="5811390">)</span>&nbsp;<span class="op" id="5811392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811395">var</span>&nbsp;<span class="ident" id="5811399">d</span>&nbsp;<span class="ident" id="5811401">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811410">return</span>&nbsp;<span class="ident" id="5811417">d</span><span class="op" id="5811418">.</span><span class="ident" id="5811419">decode</span><span class="op" id="5811425">(</span><span class="ident" id="5811426">r</span><span class="op" id="5811427">,</span>&nbsp;<span class="builtintype" id="5811429">false</span><span class="op" id="5811434">)</span><br>
<span class="lineno"></span><span class="op" id="5811436">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="5811439">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5811518">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5811548">func</span>&nbsp;<span class="ident" id="5811553">DecodeConfig</span><span class="op" id="5811565">(</span><span class="ident" id="5811566">r</span>&nbsp;<span class="ident" id="5811568">io</span><span class="op" id="5811570">.</span><span class="ident" id="5811571">Reader</span><span class="op" id="5811577">)</span>&nbsp;<span class="op" id="5811579">(</span><span class="ident" id="5811580">image</span><span class="op" id="5811585">.</span><span class="ident" id="5811586">Config</span><span class="op" id="5811592">,</span>&nbsp;<span class="builtintype" id="5811594">error</span><span class="op" id="5811599">)</span>&nbsp;<span class="op" id="5811601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811604">var</span>&nbsp;<span class="ident" id="5811608">d</span>&nbsp;<span class="ident" id="5811610">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811619">if</span>&nbsp;<span class="ident" id="5811622">_</span><span class="op" id="5811623">,</span>&nbsp;<span class="ident" id="5811625">err</span>&nbsp;<span class="op" id="5811629">:=</span>&nbsp;<span class="ident" id="5811632">d</span><span class="op" id="5811633">.</span><span class="ident" id="5811634">decode</span><span class="op" id="5811640">(</span><span class="ident" id="5811641">r</span><span class="op" id="5811642">,</span>&nbsp;<span class="builtintype" id="5811644">true</span><span class="op" id="5811648">)</span><span class="op" id="5811649">;</span>&nbsp;<span class="ident" id="5811651">err</span>&nbsp;<span class="op" id="5811655">!=</span>&nbsp;<span class="ident" id="5811658">nil</span>&nbsp;<span class="op" id="5811662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811666">return</span>&nbsp;<span class="ident" id="5811673">image</span><span class="op" id="5811678">.</span><span class="ident" id="5811679">Config</span><span class="op" id="5811685">{</span><span class="op" id="5811686">}</span><span class="op" id="5811687">,</span>&nbsp;<span class="ident" id="5811689">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811697">switch</span>&nbsp;<span class="ident" id="5811704">d</span><span class="op" id="5811705">.</span><span class="ident" id="5811706">nComp</span>&nbsp;<span class="op" id="5811712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811715">case</span>&nbsp;<span class="ident" id="5811720">nGrayComponent</span><span class="op" id="5811734">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811738">return</span>&nbsp;<span class="ident" id="5811745">image</span><span class="op" id="5811750">.</span><span class="ident" id="5811751">Config</span><span class="op" id="5811757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811762">ColorModel</span><span class="op" id="5811772">:</span>&nbsp;<span class="ident" id="5811774">color</span><span class="op" id="5811779">.</span><span class="ident" id="5811780">GrayModel</span><span class="op" id="5811789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811794">Width</span><span class="op" id="5811799">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811806">d</span><span class="op" id="5811807">.</span><span class="ident" id="5811808">width</span><span class="op" id="5811813">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811818">Height</span><span class="op" id="5811824">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811830">d</span><span class="op" id="5811831">.</span><span class="ident" id="5811832">height</span><span class="op" id="5811838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811842">}</span><span class="op" id="5811843">,</span>&nbsp;<span class="ident" id="5811845">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811850">case</span>&nbsp;<span class="ident" id="5811855">nColorComponent</span><span class="op" id="5811870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811874">return</span>&nbsp;<span class="ident" id="5811881">image</span><span class="op" id="5811886">.</span><span class="ident" id="5811887">Config</span><span class="op" id="5811893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811898">ColorModel</span><span class="op" id="5811908">:</span>&nbsp;<span class="ident" id="5811910">color</span><span class="op" id="5811915">.</span><span class="ident" id="5811916">YCbCrModel</span><span class="op" id="5811926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811931">Width</span><span class="op" id="5811936">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811943">d</span><span class="op" id="5811944">.</span><span class="ident" id="5811945">width</span><span class="op" id="5811950">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811955">Height</span><span class="op" id="5811961">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811967">d</span><span class="op" id="5811968">.</span><span class="ident" id="5811969">height</span><span class="op" id="5811975">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811979">}</span><span class="op" id="5811980">,</span>&nbsp;<span class="ident" id="5811982">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811990">return</span>&nbsp;<span class="ident" id="5811997">image</span><span class="op" id="5812002">.</span><span class="ident" id="5812003">Config</span><span class="op" id="5812009">{</span><span class="op" id="5812010">}</span><span class="op" id="5812011">,</span>&nbsp;<span class="ident" id="5812013">FormatError</span><span class="op" id="5812024">(</span><span class="string" id="5812025">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="5812045">)</span><br>
<span class="lineno"></span><span class="op" id="5812047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="5812050">func</span>&nbsp;<span class="ident" id="5812055">init</span><span class="op" id="5812059">(</span><span class="op" id="5812060">)</span>&nbsp;<span class="op" id="5812062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812065">image</span><span class="op" id="5812070">.</span><span class="ident" id="5812071">RegisterFormat</span><span class="op" id="5812085">(</span><span class="string" id="5812086">&#34;jpeg&#34;</span><span class="op" id="5812092">,</span>&nbsp;<span class="string" id="5812094">&#34;\xff\xd8&#34;</span><span class="op" id="5812104">,</span>&nbsp;<span class="ident" id="5812106">Decode</span><span class="op" id="5812112">,</span>&nbsp;<span class="ident" id="5812114">DecodeConfig</span><span class="op" id="5812126">)</span><br>
<span class="lineno"></span><span class="op" id="5812128">}</span>
</div>
</body>
</html>
