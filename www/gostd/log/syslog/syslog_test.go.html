<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7956554">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7956609">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7956663">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7956714">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7956747">package</span>&nbsp;<span class="ident" id="7956755">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7956763">import</span>&nbsp;<span class="op" id="7956770">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956773">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956782">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956789">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956795">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956808">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956815">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956822">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956828">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956836">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7956847">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7956854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7956857">func</span>&nbsp;<span class="ident" id="7956862">runPktSyslog</span><span class="op" id="7956874">(</span><span class="ident" id="7956875">c</span>&nbsp;<span class="ident" id="7956877">net</span><span class="op" id="7956880">.</span><span class="ident" id="7956881">PacketConn</span><span class="op" id="7956891">,</span>&nbsp;<span class="ident" id="7956893">done</span>&nbsp;<span class="keyword" id="7956898">chan</span><span class="op" id="7956902">&lt;-</span>&nbsp;<span class="builtintype" id="7956905">string</span><span class="op" id="7956911">)</span>&nbsp;<span class="op" id="7956913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7956916">var</span>&nbsp;<span class="ident" id="7956920">buf</span>&nbsp;<span class="op" id="7956924">[</span><span class="num" id="7956925">4096</span><span class="op" id="7956929">]</span><span class="builtintype" id="7956930">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7956936">var</span>&nbsp;<span class="ident" id="7956940">rcvd</span>&nbsp;<span class="builtintype" id="7956945">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7956953">ct</span>&nbsp;<span class="op" id="7956956">:=</span>&nbsp;<span class="num" id="7956959">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7956962">for</span>&nbsp;<span class="op" id="7956966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7956970">var</span>&nbsp;<span class="ident" id="7956974">n</span>&nbsp;<span class="builtintype" id="7956976">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7956982">var</span>&nbsp;<span class="ident" id="7956986">err</span>&nbsp;<span class="builtintype" id="7956990">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7956999">c</span><span class="op" id="7957000">.</span><span class="ident" id="7957001">SetReadDeadline</span><span class="op" id="7957016">(</span><span class="ident" id="7957017">time</span><span class="op" id="7957021">.</span><span class="ident" id="7957022">Now</span><span class="op" id="7957025">(</span><span class="op" id="7957026">)</span><span class="op" id="7957027">.</span><span class="ident" id="7957028">Add</span><span class="op" id="7957031">(</span><span class="num" id="7957032">100</span>&nbsp;<span class="op" id="7957036">*</span>&nbsp;<span class="ident" id="7957038">time</span><span class="op" id="7957042">.</span><span class="ident" id="7957043">Millisecond</span><span class="op" id="7957054">)</span><span class="op" id="7957055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957059">n</span><span class="op" id="7957060">,</span>&nbsp;<span class="ident" id="7957062">_</span><span class="op" id="7957063">,</span>&nbsp;<span class="ident" id="7957065">err</span>&nbsp;<span class="op" id="7957069">=</span>&nbsp;<span class="ident" id="7957071">c</span><span class="op" id="7957072">.</span><span class="ident" id="7957073">ReadFrom</span><span class="op" id="7957081">(</span><span class="ident" id="7957082">buf</span><span class="op" id="7957085">[</span><span class="op" id="7957086">:</span><span class="op" id="7957087">]</span><span class="op" id="7957088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957092">rcvd</span>&nbsp;<span class="op" id="7957097">+=</span>&nbsp;<span class="builtintype" id="7957100">string</span><span class="op" id="7957106">(</span><span class="ident" id="7957107">buf</span><span class="op" id="7957110">[</span><span class="op" id="7957111">:</span><span class="ident" id="7957112">n</span><span class="op" id="7957113">]</span><span class="op" id="7957114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957118">if</span>&nbsp;<span class="ident" id="7957121">err</span>&nbsp;<span class="op" id="7957125">!=</span>&nbsp;<span class="ident" id="7957128">nil</span>&nbsp;<span class="op" id="7957132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957137">if</span>&nbsp;<span class="ident" id="7957140">oe</span><span class="op" id="7957142">,</span>&nbsp;<span class="ident" id="7957144">ok</span>&nbsp;<span class="op" id="7957147">:=</span>&nbsp;<span class="ident" id="7957150">err</span><span class="op" id="7957153">.</span><span class="op" id="7957154">(</span><span class="op" id="7957155">*</span><span class="ident" id="7957156">net</span><span class="op" id="7957159">.</span><span class="ident" id="7957160">OpError</span><span class="op" id="7957167">)</span><span class="op" id="7957168">;</span>&nbsp;<span class="ident" id="7957170">ok</span>&nbsp;<span class="op" id="7957173">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957179">if</span>&nbsp;<span class="ident" id="7957182">ct</span>&nbsp;<span class="op" id="7957185">&lt;</span>&nbsp;<span class="num" id="7957187">3</span>&nbsp;<span class="op" id="7957189">&amp;&amp;</span>&nbsp;<span class="ident" id="7957192">oe</span><span class="op" id="7957194">.</span><span class="ident" id="7957195">Temporary</span><span class="op" id="7957204">(</span><span class="op" id="7957205">)</span>&nbsp;<span class="op" id="7957207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957214">ct</span><span class="op" id="7957216">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957224">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957242">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957247">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957261">c</span><span class="op" id="7957262">.</span><span class="ident" id="7957263">Close</span><span class="op" id="7957268">(</span><span class="op" id="7957269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957272">done</span>&nbsp;<span class="op" id="7957277">&lt;-</span>&nbsp;<span class="ident" id="7957280">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7957285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7957288">var</span>&nbsp;<span class="ident" id="7957292">crashy</span>&nbsp;<span class="op" id="7957299">=</span>&nbsp;<span class="builtintype" id="7957301">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7957308">func</span>&nbsp;<span class="ident" id="7957313">runStreamSyslog</span><span class="op" id="7957328">(</span><span class="ident" id="7957329">l</span>&nbsp;<span class="ident" id="7957331">net</span><span class="op" id="7957334">.</span><span class="ident" id="7957335">Listener</span><span class="op" id="7957343">,</span>&nbsp;<span class="ident" id="7957345">done</span>&nbsp;<span class="keyword" id="7957350">chan</span><span class="op" id="7957354">&lt;-</span>&nbsp;<span class="builtintype" id="7957357">string</span><span class="op" id="7957363">,</span>&nbsp;<span class="ident" id="7957365">wg</span>&nbsp;<span class="op" id="7957368">*</span><span class="ident" id="7957369">sync</span><span class="op" id="7957373">.</span><span class="ident" id="7957374">WaitGroup</span><span class="op" id="7957383">)</span>&nbsp;<span class="op" id="7957385">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957388">for</span>&nbsp;<span class="op" id="7957392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957396">var</span>&nbsp;<span class="ident" id="7957400">c</span>&nbsp;<span class="ident" id="7957402">net</span><span class="op" id="7957405">.</span><span class="ident" id="7957406">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957413">var</span>&nbsp;<span class="ident" id="7957417">err</span>&nbsp;<span class="builtintype" id="7957421">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957429">if</span>&nbsp;<span class="ident" id="7957432">c</span><span class="op" id="7957433">,</span>&nbsp;<span class="ident" id="7957435">err</span>&nbsp;<span class="op" id="7957439">=</span>&nbsp;<span class="ident" id="7957441">l</span><span class="op" id="7957442">.</span><span class="ident" id="7957443">Accept</span><span class="op" id="7957449">(</span><span class="op" id="7957450">)</span><span class="op" id="7957451">;</span>&nbsp;<span class="ident" id="7957453">err</span>&nbsp;<span class="op" id="7957457">!=</span>&nbsp;<span class="ident" id="7957460">nil</span>&nbsp;<span class="op" id="7957464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957469">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957482">wg</span><span class="op" id="7957484">.</span><span class="ident" id="7957485">Add</span><span class="op" id="7957488">(</span><span class="num" id="7957489">1</span><span class="op" id="7957490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957494">go</span>&nbsp;<span class="keyword" id="7957497">func</span><span class="op" id="7957501">(</span><span class="ident" id="7957502">c</span>&nbsp;<span class="ident" id="7957504">net</span><span class="op" id="7957507">.</span><span class="ident" id="7957508">Conn</span><span class="op" id="7957512">)</span>&nbsp;<span class="op" id="7957514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957519">defer</span>&nbsp;<span class="ident" id="7957525">wg</span><span class="op" id="7957527">.</span><span class="ident" id="7957528">Done</span><span class="op" id="7957532">(</span><span class="op" id="7957533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957538">c</span><span class="op" id="7957539">.</span><span class="ident" id="7957540">SetReadDeadline</span><span class="op" id="7957555">(</span><span class="ident" id="7957556">time</span><span class="op" id="7957560">.</span><span class="ident" id="7957561">Now</span><span class="op" id="7957564">(</span><span class="op" id="7957565">)</span><span class="op" id="7957566">.</span><span class="ident" id="7957567">Add</span><span class="op" id="7957570">(</span><span class="num" id="7957571">5</span>&nbsp;<span class="op" id="7957573">*</span>&nbsp;<span class="ident" id="7957575">time</span><span class="op" id="7957579">.</span><span class="ident" id="7957580">Second</span><span class="op" id="7957586">)</span><span class="op" id="7957587">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957592">b</span>&nbsp;<span class="op" id="7957594">:=</span>&nbsp;<span class="ident" id="7957597">bufio</span><span class="op" id="7957602">.</span><span class="ident" id="7957603">NewReader</span><span class="op" id="7957612">(</span><span class="ident" id="7957613">c</span><span class="op" id="7957614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957619">for</span>&nbsp;<span class="ident" id="7957623">ct</span>&nbsp;<span class="op" id="7957626">:=</span>&nbsp;<span class="num" id="7957629">1</span><span class="op" id="7957630">;</span>&nbsp;<span class="op" id="7957632">!</span><span class="ident" id="7957633">crashy</span>&nbsp;<span class="op" id="7957640">||</span>&nbsp;<span class="ident" id="7957643">ct</span><span class="op" id="7957645">&amp;</span><span class="num" id="7957646">7</span>&nbsp;<span class="op" id="7957648">!=</span>&nbsp;<span class="num" id="7957651">0</span><span class="op" id="7957652">;</span>&nbsp;<span class="ident" id="7957654">ct</span><span class="op" id="7957656">++</span>&nbsp;<span class="op" id="7957659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957665">s</span><span class="op" id="7957666">,</span>&nbsp;<span class="ident" id="7957668">err</span>&nbsp;<span class="op" id="7957672">:=</span>&nbsp;<span class="ident" id="7957675">b</span><span class="op" id="7957676">.</span><span class="ident" id="7957677">ReadString</span><span class="op" id="7957687">(</span><span class="string" id="7957688">&#39;\n&#39;</span><span class="op" id="7957692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957698">if</span>&nbsp;<span class="ident" id="7957701">err</span>&nbsp;<span class="op" id="7957705">!=</span>&nbsp;<span class="ident" id="7957708">nil</span>&nbsp;<span class="op" id="7957712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957719">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957735">done</span>&nbsp;<span class="op" id="7957740">&lt;-</span>&nbsp;<span class="ident" id="7957743">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957753">c</span><span class="op" id="7957754">.</span><span class="ident" id="7957755">Close</span><span class="op" id="7957760">(</span><span class="op" id="7957761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957765">}</span><span class="op" id="7957766">(</span><span class="ident" id="7957767">c</span><span class="op" id="7957768">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957771">}</span><br>
<span class="lineno"></span><span class="op" id="7957773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7957776">func</span>&nbsp;<span class="ident" id="7957781">startServer</span><span class="op" id="7957792">(</span><span class="ident" id="7957793">n</span><span class="op" id="7957794">,</span>&nbsp;<span class="ident" id="7957796">la</span>&nbsp;<span class="builtintype" id="7957799">string</span><span class="op" id="7957805">,</span>&nbsp;<span class="ident" id="7957807">done</span>&nbsp;<span class="keyword" id="7957812">chan</span><span class="op" id="7957816">&lt;-</span>&nbsp;<span class="builtintype" id="7957819">string</span><span class="op" id="7957825">)</span>&nbsp;<span class="op" id="7957827">(</span><span class="ident" id="7957828">addr</span>&nbsp;<span class="builtintype" id="7957833">string</span><span class="op" id="7957839">,</span>&nbsp;<span class="ident" id="7957841">sock</span>&nbsp;<span class="ident" id="7957846">io</span><span class="op" id="7957848">.</span><span class="ident" id="7957849">Closer</span><span class="op" id="7957855">,</span>&nbsp;<span class="ident" id="7957857">wg</span>&nbsp;<span class="op" id="7957860">*</span><span class="ident" id="7957861">sync</span><span class="op" id="7957865">.</span><span class="ident" id="7957866">WaitGroup</span><span class="op" id="7957875">)</span>&nbsp;<span class="op" id="7957877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957880">if</span>&nbsp;<span class="ident" id="7957883">n</span>&nbsp;<span class="op" id="7957885">==</span>&nbsp;<span class="string" id="7957888">&#34;udp&#34;</span>&nbsp;<span class="op" id="7957894">||</span>&nbsp;<span class="ident" id="7957897">n</span>&nbsp;<span class="op" id="7957899">==</span>&nbsp;<span class="string" id="7957902">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7957908">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7957912">la</span>&nbsp;<span class="op" id="7957915">=</span>&nbsp;<span class="string" id="7957917">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7957932">}</span>&nbsp;<span class="keyword" id="7957934">else</span>&nbsp;<span class="op" id="7957939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7957943">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7957999">if</span>&nbsp;<span class="ident" id="7958002">la</span>&nbsp;<span class="op" id="7958005">==</span>&nbsp;<span class="string" id="7958008">&#34;&#34;</span>&nbsp;<span class="op" id="7958011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7958016">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958071">f</span><span class="op" id="7958072">,</span>&nbsp;<span class="ident" id="7958074">err</span>&nbsp;<span class="op" id="7958078">:=</span>&nbsp;<span class="ident" id="7958081">ioutil</span><span class="op" id="7958087">.</span><span class="ident" id="7958088">TempFile</span><span class="op" id="7958096">(</span><span class="string" id="7958097">&#34;&#34;</span><span class="op" id="7958099">,</span>&nbsp;<span class="string" id="7958101">&#34;syslogtest&#34;</span><span class="op" id="7958113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958118">if</span>&nbsp;<span class="ident" id="7958121">err</span>&nbsp;<span class="op" id="7958125">!=</span>&nbsp;<span class="ident" id="7958128">nil</span>&nbsp;<span class="op" id="7958132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958138">log</span><span class="op" id="7958141">.</span><span class="ident" id="7958142">Fatal</span><span class="op" id="7958147">(</span><span class="string" id="7958148">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7958160">,</span>&nbsp;<span class="ident" id="7958162">err</span><span class="op" id="7958165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958175">f</span><span class="op" id="7958176">.</span><span class="ident" id="7958177">Close</span><span class="op" id="7958182">(</span><span class="op" id="7958183">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958188">la</span>&nbsp;<span class="op" id="7958191">=</span>&nbsp;<span class="ident" id="7958193">f</span><span class="op" id="7958194">.</span><span class="ident" id="7958195">Name</span><span class="op" id="7958199">(</span><span class="op" id="7958200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958208">os</span><span class="op" id="7958210">.</span><span class="ident" id="7958211">Remove</span><span class="op" id="7958217">(</span><span class="ident" id="7958218">la</span><span class="op" id="7958220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958227">wg</span>&nbsp;<span class="op" id="7958230">=</span>&nbsp;<span class="builtinfunc" id="7958232">new</span><span class="op" id="7958235">(</span><span class="ident" id="7958236">sync</span><span class="op" id="7958240">.</span><span class="ident" id="7958241">WaitGroup</span><span class="op" id="7958250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958253">if</span>&nbsp;<span class="ident" id="7958256">n</span>&nbsp;<span class="op" id="7958258">==</span>&nbsp;<span class="string" id="7958261">&#34;udp&#34;</span>&nbsp;<span class="op" id="7958267">||</span>&nbsp;<span class="ident" id="7958270">n</span>&nbsp;<span class="op" id="7958272">==</span>&nbsp;<span class="string" id="7958275">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7958286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958290">l</span><span class="op" id="7958291">,</span>&nbsp;<span class="ident" id="7958293">e</span>&nbsp;<span class="op" id="7958295">:=</span>&nbsp;<span class="ident" id="7958298">net</span><span class="op" id="7958301">.</span><span class="ident" id="7958302">ListenPacket</span><span class="op" id="7958314">(</span><span class="ident" id="7958315">n</span><span class="op" id="7958316">,</span>&nbsp;<span class="ident" id="7958318">la</span><span class="op" id="7958320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958324">if</span>&nbsp;<span class="ident" id="7958327">e</span>&nbsp;<span class="op" id="7958329">!=</span>&nbsp;<span class="ident" id="7958332">nil</span>&nbsp;<span class="op" id="7958336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958341">log</span><span class="op" id="7958344">.</span><span class="ident" id="7958345">Fatalf</span><span class="op" id="7958351">(</span><span class="string" id="7958352">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7958376">,</span>&nbsp;<span class="ident" id="7958378">e</span><span class="op" id="7958379">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958387">addr</span>&nbsp;<span class="op" id="7958392">=</span>&nbsp;<span class="ident" id="7958394">l</span><span class="op" id="7958395">.</span><span class="ident" id="7958396">LocalAddr</span><span class="op" id="7958405">(</span><span class="op" id="7958406">)</span><span class="op" id="7958407">.</span><span class="ident" id="7958408">String</span><span class="op" id="7958414">(</span><span class="op" id="7958415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958419">sock</span>&nbsp;<span class="op" id="7958424">=</span>&nbsp;<span class="ident" id="7958426">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958430">wg</span><span class="op" id="7958432">.</span><span class="ident" id="7958433">Add</span><span class="op" id="7958436">(</span><span class="num" id="7958437">1</span><span class="op" id="7958438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958442">go</span>&nbsp;<span class="keyword" id="7958445">func</span><span class="op" id="7958449">(</span><span class="op" id="7958450">)</span>&nbsp;<span class="op" id="7958452">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958457">defer</span>&nbsp;<span class="ident" id="7958463">wg</span><span class="op" id="7958465">.</span><span class="ident" id="7958466">Done</span><span class="op" id="7958470">(</span><span class="op" id="7958471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958476">runPktSyslog</span><span class="op" id="7958488">(</span><span class="ident" id="7958489">l</span><span class="op" id="7958490">,</span>&nbsp;<span class="ident" id="7958492">done</span><span class="op" id="7958496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958500">}</span><span class="op" id="7958501">(</span><span class="op" id="7958502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958505">}</span>&nbsp;<span class="keyword" id="7958507">else</span>&nbsp;<span class="op" id="7958512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958516">l</span><span class="op" id="7958517">,</span>&nbsp;<span class="ident" id="7958519">e</span>&nbsp;<span class="op" id="7958521">:=</span>&nbsp;<span class="ident" id="7958524">net</span><span class="op" id="7958527">.</span><span class="ident" id="7958528">Listen</span><span class="op" id="7958534">(</span><span class="ident" id="7958535">n</span><span class="op" id="7958536">,</span>&nbsp;<span class="ident" id="7958538">la</span><span class="op" id="7958540">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958544">if</span>&nbsp;<span class="ident" id="7958547">e</span>&nbsp;<span class="op" id="7958549">!=</span>&nbsp;<span class="ident" id="7958552">nil</span>&nbsp;<span class="op" id="7958556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958561">log</span><span class="op" id="7958564">.</span><span class="ident" id="7958565">Fatalf</span><span class="op" id="7958571">(</span><span class="string" id="7958572">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7958596">,</span>&nbsp;<span class="ident" id="7958598">e</span><span class="op" id="7958599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958607">addr</span>&nbsp;<span class="op" id="7958612">=</span>&nbsp;<span class="ident" id="7958614">l</span><span class="op" id="7958615">.</span><span class="ident" id="7958616">Addr</span><span class="op" id="7958620">(</span><span class="op" id="7958621">)</span><span class="op" id="7958622">.</span><span class="ident" id="7958623">String</span><span class="op" id="7958629">(</span><span class="op" id="7958630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958634">sock</span>&nbsp;<span class="op" id="7958639">=</span>&nbsp;<span class="ident" id="7958641">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958645">wg</span><span class="op" id="7958647">.</span><span class="ident" id="7958648">Add</span><span class="op" id="7958651">(</span><span class="num" id="7958652">1</span><span class="op" id="7958653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958657">go</span>&nbsp;<span class="keyword" id="7958660">func</span><span class="op" id="7958664">(</span><span class="op" id="7958665">)</span>&nbsp;<span class="op" id="7958667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958672">defer</span>&nbsp;<span class="ident" id="7958678">wg</span><span class="op" id="7958680">.</span><span class="ident" id="7958681">Done</span><span class="op" id="7958685">(</span><span class="op" id="7958686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958691">runStreamSyslog</span><span class="op" id="7958706">(</span><span class="ident" id="7958707">l</span><span class="op" id="7958708">,</span>&nbsp;<span class="ident" id="7958710">done</span><span class="op" id="7958714">,</span>&nbsp;<span class="ident" id="7958716">wg</span><span class="op" id="7958718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958722">}</span><span class="op" id="7958723">(</span><span class="op" id="7958724">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7958727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958730">return</span><br>
<span class="lineno"></span><span class="op" id="7958737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7958740">func</span>&nbsp;<span class="ident" id="7958745">TestWithSimulated</span><span class="op" id="7958762">(</span><span class="ident" id="7958763">t</span>&nbsp;<span class="op" id="7958765">*</span><span class="ident" id="7958766">testing</span><span class="op" id="7958773">.</span><span class="ident" id="7958774">T</span><span class="op" id="7958775">)</span>&nbsp;<span class="op" id="7958777">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958780">msg</span>&nbsp;<span class="op" id="7958784">:=</span>&nbsp;<span class="string" id="7958787">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958799">transport</span>&nbsp;<span class="op" id="7958809">:=</span>&nbsp;<span class="op" id="7958812">[</span><span class="op" id="7958813">]</span><span class="builtintype" id="7958814">string</span><span class="op" id="7958820">{</span><span class="string" id="7958821">&#34;unix&#34;</span><span class="op" id="7958827">,</span>&nbsp;<span class="string" id="7958829">&#34;unixgram&#34;</span><span class="op" id="7958839">,</span>&nbsp;<span class="string" id="7958841">&#34;udp&#34;</span><span class="op" id="7958846">,</span>&nbsp;<span class="string" id="7958848">&#34;tcp&#34;</span><span class="op" id="7958853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958857">for</span>&nbsp;<span class="ident" id="7958861">_</span><span class="op" id="7958862">,</span>&nbsp;<span class="ident" id="7958864">tr</span>&nbsp;<span class="op" id="7958867">:=</span>&nbsp;<span class="keyword" id="7958870">range</span>&nbsp;<span class="ident" id="7958876">transport</span>&nbsp;<span class="op" id="7958886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958890">done</span>&nbsp;<span class="op" id="7958895">:=</span>&nbsp;<span class="builtinfunc" id="7958898">make</span><span class="op" id="7958902">(</span><span class="keyword" id="7958903">chan</span>&nbsp;<span class="builtintype" id="7958908">string</span><span class="op" id="7958914">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7958918">addr</span><span class="op" id="7958922">,</span>&nbsp;<span class="ident" id="7958924">sock</span><span class="op" id="7958928">,</span>&nbsp;<span class="ident" id="7958930">srvWG</span>&nbsp;<span class="op" id="7958936">:=</span>&nbsp;<span class="ident" id="7958939">startServer</span><span class="op" id="7958950">(</span><span class="ident" id="7958951">tr</span><span class="op" id="7958953">,</span>&nbsp;<span class="string" id="7958955">&#34;&#34;</span><span class="op" id="7958957">,</span>&nbsp;<span class="ident" id="7958959">done</span><span class="op" id="7958963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958967">defer</span>&nbsp;<span class="ident" id="7958973">srvWG</span><span class="op" id="7958978">.</span><span class="ident" id="7958979">Wait</span><span class="op" id="7958983">(</span><span class="op" id="7958984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7958988">defer</span>&nbsp;<span class="ident" id="7958994">sock</span><span class="op" id="7958998">.</span><span class="ident" id="7958999">Close</span><span class="op" id="7959004">(</span><span class="op" id="7959005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959009">if</span>&nbsp;<span class="ident" id="7959012">tr</span>&nbsp;<span class="op" id="7959015">==</span>&nbsp;<span class="string" id="7959018">&#34;unix&#34;</span>&nbsp;<span class="op" id="7959025">||</span>&nbsp;<span class="ident" id="7959028">tr</span>&nbsp;<span class="op" id="7959031">==</span>&nbsp;<span class="string" id="7959034">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7959045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959050">defer</span>&nbsp;<span class="ident" id="7959056">os</span><span class="op" id="7959058">.</span><span class="ident" id="7959059">Remove</span><span class="op" id="7959065">(</span><span class="ident" id="7959066">addr</span><span class="op" id="7959070">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959078">s</span><span class="op" id="7959079">,</span>&nbsp;<span class="ident" id="7959081">err</span>&nbsp;<span class="op" id="7959085">:=</span>&nbsp;<span class="ident" id="7959088">Dial</span><span class="op" id="7959092">(</span><span class="ident" id="7959093">tr</span><span class="op" id="7959095">,</span>&nbsp;<span class="ident" id="7959097">addr</span><span class="op" id="7959101">,</span>&nbsp;<span class="ident" id="7959103">LOG_INFO</span><span class="op" id="7959111">|</span><span class="ident" id="7959112">LOG_USER</span><span class="op" id="7959120">,</span>&nbsp;<span class="string" id="7959122">&#34;syslog_test&#34;</span><span class="op" id="7959135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959139">if</span>&nbsp;<span class="ident" id="7959142">err</span>&nbsp;<span class="op" id="7959146">!=</span>&nbsp;<span class="ident" id="7959149">nil</span>&nbsp;<span class="op" id="7959153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959158">t</span><span class="op" id="7959159">.</span><span class="ident" id="7959160">Fatalf</span><span class="op" id="7959166">(</span><span class="string" id="7959167">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7959186">,</span>&nbsp;<span class="ident" id="7959188">err</span><span class="op" id="7959191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959195">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959199">err</span>&nbsp;<span class="op" id="7959203">=</span>&nbsp;<span class="ident" id="7959205">s</span><span class="op" id="7959206">.</span><span class="ident" id="7959207">Info</span><span class="op" id="7959211">(</span><span class="ident" id="7959212">msg</span><span class="op" id="7959215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959219">if</span>&nbsp;<span class="ident" id="7959222">err</span>&nbsp;<span class="op" id="7959226">!=</span>&nbsp;<span class="ident" id="7959229">nil</span>&nbsp;<span class="op" id="7959233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959238">t</span><span class="op" id="7959239">.</span><span class="ident" id="7959240">Fatalf</span><span class="op" id="7959246">(</span><span class="string" id="7959247">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7959263">,</span>&nbsp;<span class="ident" id="7959265">err</span><span class="op" id="7959268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959276">check</span><span class="op" id="7959281">(</span><span class="ident" id="7959282">t</span><span class="op" id="7959283">,</span>&nbsp;<span class="ident" id="7959285">msg</span><span class="op" id="7959288">,</span>&nbsp;<span class="op" id="7959290">&lt;-</span><span class="ident" id="7959292">done</span><span class="op" id="7959296">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959300">s</span><span class="op" id="7959301">.</span><span class="ident" id="7959302">Close</span><span class="op" id="7959307">(</span><span class="op" id="7959308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959311">}</span><br>
<span class="lineno"></span><span class="op" id="7959313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7959316">func</span>&nbsp;<span class="ident" id="7959321">TestFlap</span><span class="op" id="7959329">(</span><span class="ident" id="7959330">t</span>&nbsp;<span class="op" id="7959332">*</span><span class="ident" id="7959333">testing</span><span class="op" id="7959340">.</span><span class="ident" id="7959341">T</span><span class="op" id="7959342">)</span>&nbsp;<span class="op" id="7959344">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959347">net</span>&nbsp;<span class="op" id="7959351">:=</span>&nbsp;<span class="string" id="7959354">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959362">done</span>&nbsp;<span class="op" id="7959367">:=</span>&nbsp;<span class="builtinfunc" id="7959370">make</span><span class="op" id="7959374">(</span><span class="keyword" id="7959375">chan</span>&nbsp;<span class="builtintype" id="7959380">string</span><span class="op" id="7959386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959389">addr</span><span class="op" id="7959393">,</span>&nbsp;<span class="ident" id="7959395">sock</span><span class="op" id="7959399">,</span>&nbsp;<span class="ident" id="7959401">srvWG</span>&nbsp;<span class="op" id="7959407">:=</span>&nbsp;<span class="ident" id="7959410">startServer</span><span class="op" id="7959421">(</span><span class="ident" id="7959422">net</span><span class="op" id="7959425">,</span>&nbsp;<span class="string" id="7959427">&#34;&#34;</span><span class="op" id="7959429">,</span>&nbsp;<span class="ident" id="7959431">done</span><span class="op" id="7959435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959438">defer</span>&nbsp;<span class="ident" id="7959444">srvWG</span><span class="op" id="7959449">.</span><span class="ident" id="7959450">Wait</span><span class="op" id="7959454">(</span><span class="op" id="7959455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959458">defer</span>&nbsp;<span class="ident" id="7959464">os</span><span class="op" id="7959466">.</span><span class="ident" id="7959467">Remove</span><span class="op" id="7959473">(</span><span class="ident" id="7959474">addr</span><span class="op" id="7959478">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959481">defer</span>&nbsp;<span class="ident" id="7959487">sock</span><span class="op" id="7959491">.</span><span class="ident" id="7959492">Close</span><span class="op" id="7959497">(</span><span class="op" id="7959498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959502">s</span><span class="op" id="7959503">,</span>&nbsp;<span class="ident" id="7959505">err</span>&nbsp;<span class="op" id="7959509">:=</span>&nbsp;<span class="ident" id="7959512">Dial</span><span class="op" id="7959516">(</span><span class="ident" id="7959517">net</span><span class="op" id="7959520">,</span>&nbsp;<span class="ident" id="7959522">addr</span><span class="op" id="7959526">,</span>&nbsp;<span class="ident" id="7959528">LOG_INFO</span><span class="op" id="7959536">|</span><span class="ident" id="7959537">LOG_USER</span><span class="op" id="7959545">,</span>&nbsp;<span class="string" id="7959547">&#34;syslog_test&#34;</span><span class="op" id="7959560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959563">if</span>&nbsp;<span class="ident" id="7959566">err</span>&nbsp;<span class="op" id="7959570">!=</span>&nbsp;<span class="ident" id="7959573">nil</span>&nbsp;<span class="op" id="7959577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959581">t</span><span class="op" id="7959582">.</span><span class="ident" id="7959583">Fatalf</span><span class="op" id="7959589">(</span><span class="string" id="7959590">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7959609">,</span>&nbsp;<span class="ident" id="7959611">err</span><span class="op" id="7959614">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959620">msg</span>&nbsp;<span class="op" id="7959624">:=</span>&nbsp;<span class="string" id="7959627">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959636">err</span>&nbsp;<span class="op" id="7959640">=</span>&nbsp;<span class="ident" id="7959642">s</span><span class="op" id="7959643">.</span><span class="ident" id="7959644">Info</span><span class="op" id="7959648">(</span><span class="ident" id="7959649">msg</span><span class="op" id="7959652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959655">if</span>&nbsp;<span class="ident" id="7959658">err</span>&nbsp;<span class="op" id="7959662">!=</span>&nbsp;<span class="ident" id="7959665">nil</span>&nbsp;<span class="op" id="7959669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959673">t</span><span class="op" id="7959674">.</span><span class="ident" id="7959675">Fatalf</span><span class="op" id="7959681">(</span><span class="string" id="7959682">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7959698">,</span>&nbsp;<span class="ident" id="7959700">err</span><span class="op" id="7959703">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959709">check</span><span class="op" id="7959714">(</span><span class="ident" id="7959715">t</span><span class="op" id="7959716">,</span>&nbsp;<span class="ident" id="7959718">msg</span><span class="op" id="7959721">,</span>&nbsp;<span class="op" id="7959723">&lt;-</span><span class="ident" id="7959725">done</span><span class="op" id="7959729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7959733">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959756">_</span><span class="op" id="7959757">,</span>&nbsp;<span class="ident" id="7959759">sock2</span><span class="op" id="7959764">,</span>&nbsp;<span class="ident" id="7959766">srvWG2</span>&nbsp;<span class="op" id="7959773">:=</span>&nbsp;<span class="ident" id="7959776">startServer</span><span class="op" id="7959787">(</span><span class="ident" id="7959788">net</span><span class="op" id="7959791">,</span>&nbsp;<span class="ident" id="7959793">addr</span><span class="op" id="7959797">,</span>&nbsp;<span class="ident" id="7959799">done</span><span class="op" id="7959803">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959806">defer</span>&nbsp;<span class="ident" id="7959812">srvWG2</span><span class="op" id="7959818">.</span><span class="ident" id="7959819">Wait</span><span class="op" id="7959823">(</span><span class="op" id="7959824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959827">defer</span>&nbsp;<span class="ident" id="7959833">sock2</span><span class="op" id="7959838">.</span><span class="ident" id="7959839">Close</span><span class="op" id="7959844">(</span><span class="op" id="7959845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7959849">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959876">msg</span>&nbsp;<span class="op" id="7959880">=</span>&nbsp;<span class="string" id="7959882">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959891">err</span>&nbsp;<span class="op" id="7959895">=</span>&nbsp;<span class="ident" id="7959897">s</span><span class="op" id="7959898">.</span><span class="ident" id="7959899">Info</span><span class="op" id="7959903">(</span><span class="ident" id="7959904">msg</span><span class="op" id="7959907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7959910">if</span>&nbsp;<span class="ident" id="7959913">err</span>&nbsp;<span class="op" id="7959917">!=</span>&nbsp;<span class="ident" id="7959920">nil</span>&nbsp;<span class="op" id="7959924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959928">t</span><span class="op" id="7959929">.</span><span class="ident" id="7959930">Fatalf</span><span class="op" id="7959936">(</span><span class="string" id="7959937">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7959953">,</span>&nbsp;<span class="ident" id="7959955">err</span><span class="op" id="7959958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7959961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959964">check</span><span class="op" id="7959969">(</span><span class="ident" id="7959970">t</span><span class="op" id="7959971">,</span>&nbsp;<span class="ident" id="7959973">msg</span><span class="op" id="7959976">,</span>&nbsp;<span class="op" id="7959978">&lt;-</span><span class="ident" id="7959980">done</span><span class="op" id="7959984">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7959988">s</span><span class="op" id="7959989">.</span><span class="ident" id="7959990">Close</span><span class="op" id="7959995">(</span><span class="op" id="7959996">)</span><br>
<span class="lineno"></span><span class="op" id="7959998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7960001">func</span>&nbsp;<span class="ident" id="7960006">TestNew</span><span class="op" id="7960013">(</span><span class="ident" id="7960014">t</span>&nbsp;<span class="op" id="7960016">*</span><span class="ident" id="7960017">testing</span><span class="op" id="7960024">.</span><span class="ident" id="7960025">T</span><span class="op" id="7960026">)</span>&nbsp;<span class="op" id="7960028">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960031">if</span>&nbsp;<span class="ident" id="7960034">LOG_LOCAL7</span>&nbsp;<span class="op" id="7960045">!=</span>&nbsp;<span class="num" id="7960048">23</span><span class="op" id="7960050">&lt;&lt;</span><span class="num" id="7960052">3</span>&nbsp;<span class="op" id="7960054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960058">t</span><span class="op" id="7960059">.</span><span class="ident" id="7960060">Fatalf</span><span class="op" id="7960066">(</span><span class="string" id="7960067">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7960095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960101">if</span>&nbsp;<span class="ident" id="7960104">testing</span><span class="op" id="7960111">.</span><span class="ident" id="7960112">Short</span><span class="op" id="7960117">(</span><span class="op" id="7960118">)</span>&nbsp;<span class="op" id="7960120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7960124">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960187">t</span><span class="op" id="7960188">.</span><span class="ident" id="7960189">Skip</span><span class="op" id="7960193">(</span><span class="string" id="7960194">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7960230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960237">s</span><span class="op" id="7960238">,</span>&nbsp;<span class="ident" id="7960240">err</span>&nbsp;<span class="op" id="7960244">:=</span>&nbsp;<span class="ident" id="7960247">New</span><span class="op" id="7960250">(</span><span class="ident" id="7960251">LOG_INFO</span><span class="op" id="7960259">|</span><span class="ident" id="7960260">LOG_USER</span><span class="op" id="7960268">,</span>&nbsp;<span class="string" id="7960270">&#34;the_tag&#34;</span><span class="op" id="7960279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960282">if</span>&nbsp;<span class="ident" id="7960285">err</span>&nbsp;<span class="op" id="7960289">!=</span>&nbsp;<span class="ident" id="7960292">nil</span>&nbsp;<span class="op" id="7960296">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960300">t</span><span class="op" id="7960301">.</span><span class="ident" id="7960302">Fatalf</span><span class="op" id="7960308">(</span><span class="string" id="7960309">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7960327">,</span>&nbsp;<span class="ident" id="7960329">err</span><span class="op" id="7960332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7960338">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960367">s</span><span class="op" id="7960368">.</span><span class="ident" id="7960369">Close</span><span class="op" id="7960374">(</span><span class="op" id="7960375">)</span><br>
<span class="lineno"></span><span class="op" id="7960377">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7960380">func</span>&nbsp;<span class="ident" id="7960385">TestNewLogger</span><span class="op" id="7960398">(</span><span class="ident" id="7960399">t</span>&nbsp;<span class="op" id="7960401">*</span><span class="ident" id="7960402">testing</span><span class="op" id="7960409">.</span><span class="ident" id="7960410">T</span><span class="op" id="7960411">)</span>&nbsp;<span class="op" id="7960413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960416">if</span>&nbsp;<span class="ident" id="7960419">testing</span><span class="op" id="7960426">.</span><span class="ident" id="7960427">Short</span><span class="op" id="7960432">(</span><span class="op" id="7960433">)</span>&nbsp;<span class="op" id="7960435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960439">t</span><span class="op" id="7960440">.</span><span class="ident" id="7960441">Skip</span><span class="op" id="7960445">(</span><span class="string" id="7960446">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7960482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960485">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960488">f</span><span class="op" id="7960489">,</span>&nbsp;<span class="ident" id="7960491">err</span>&nbsp;<span class="op" id="7960495">:=</span>&nbsp;<span class="ident" id="7960498">NewLogger</span><span class="op" id="7960507">(</span><span class="ident" id="7960508">LOG_USER</span><span class="op" id="7960516">|</span><span class="ident" id="7960517">LOG_INFO</span><span class="op" id="7960525">,</span>&nbsp;<span class="num" id="7960527">0</span><span class="op" id="7960528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960531">if</span>&nbsp;<span class="ident" id="7960534">f</span>&nbsp;<span class="op" id="7960536">==</span>&nbsp;<span class="ident" id="7960539">nil</span>&nbsp;<span class="op" id="7960543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960547">t</span><span class="op" id="7960548">.</span><span class="ident" id="7960549">Error</span><span class="op" id="7960554">(</span><span class="ident" id="7960555">err</span><span class="op" id="7960558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960561">}</span><br>
<span class="lineno"></span><span class="op" id="7960563">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7960566">func</span>&nbsp;<span class="ident" id="7960571">TestDial</span><span class="op" id="7960579">(</span><span class="ident" id="7960580">t</span>&nbsp;<span class="op" id="7960582">*</span><span class="ident" id="7960583">testing</span><span class="op" id="7960590">.</span><span class="ident" id="7960591">T</span><span class="op" id="7960592">)</span>&nbsp;<span class="op" id="7960594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960597">if</span>&nbsp;<span class="ident" id="7960600">testing</span><span class="op" id="7960607">.</span><span class="ident" id="7960608">Short</span><span class="op" id="7960613">(</span><span class="op" id="7960614">)</span>&nbsp;<span class="op" id="7960616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960620">t</span><span class="op" id="7960621">.</span><span class="ident" id="7960622">Skip</span><span class="op" id="7960626">(</span><span class="string" id="7960627">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7960663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960666">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960669">f</span><span class="op" id="7960670">,</span>&nbsp;<span class="ident" id="7960672">err</span>&nbsp;<span class="op" id="7960676">:=</span>&nbsp;<span class="ident" id="7960679">Dial</span><span class="op" id="7960683">(</span><span class="string" id="7960684">&#34;&#34;</span><span class="op" id="7960686">,</span>&nbsp;<span class="string" id="7960688">&#34;&#34;</span><span class="op" id="7960690">,</span>&nbsp;<span class="op" id="7960692">(</span><span class="ident" id="7960693">LOG_LOCAL7</span><span class="op" id="7960703">|</span><span class="ident" id="7960704">LOG_DEBUG</span><span class="op" id="7960713">)</span><span class="op" id="7960714">+</span><span class="num" id="7960715">1</span><span class="op" id="7960716">,</span>&nbsp;<span class="string" id="7960718">&#34;syslog_test&#34;</span><span class="op" id="7960731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960734">if</span>&nbsp;<span class="ident" id="7960737">f</span>&nbsp;<span class="op" id="7960739">!=</span>&nbsp;<span class="ident" id="7960742">nil</span>&nbsp;<span class="op" id="7960746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960750">t</span><span class="op" id="7960751">.</span><span class="ident" id="7960752">Fatalf</span><span class="op" id="7960758">(</span><span class="string" id="7960759">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7960793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960799">f</span><span class="op" id="7960800">,</span>&nbsp;<span class="ident" id="7960802">err</span>&nbsp;<span class="op" id="7960806">=</span>&nbsp;<span class="ident" id="7960808">Dial</span><span class="op" id="7960812">(</span><span class="string" id="7960813">&#34;&#34;</span><span class="op" id="7960815">,</span>&nbsp;<span class="string" id="7960817">&#34;&#34;</span><span class="op" id="7960819">,</span>&nbsp;<span class="op" id="7960821">-</span><span class="num" id="7960822">1</span><span class="op" id="7960823">,</span>&nbsp;<span class="string" id="7960825">&#34;syslog_test&#34;</span><span class="op" id="7960838">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960841">if</span>&nbsp;<span class="ident" id="7960844">f</span>&nbsp;<span class="op" id="7960846">!=</span>&nbsp;<span class="ident" id="7960849">nil</span>&nbsp;<span class="op" id="7960853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960857">t</span><span class="op" id="7960858">.</span><span class="ident" id="7960859">Fatalf</span><span class="op" id="7960865">(</span><span class="string" id="7960866">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7960900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7960903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960906">l</span><span class="op" id="7960907">,</span>&nbsp;<span class="ident" id="7960909">err</span>&nbsp;<span class="op" id="7960913">:=</span>&nbsp;<span class="ident" id="7960916">Dial</span><span class="op" id="7960920">(</span><span class="string" id="7960921">&#34;&#34;</span><span class="op" id="7960923">,</span>&nbsp;<span class="string" id="7960925">&#34;&#34;</span><span class="op" id="7960927">,</span>&nbsp;<span class="ident" id="7960929">LOG_USER</span><span class="op" id="7960937">|</span><span class="ident" id="7960938">LOG_ERR</span><span class="op" id="7960945">,</span>&nbsp;<span class="string" id="7960947">&#34;syslog_test&#34;</span><span class="op" id="7960960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7960963">if</span>&nbsp;<span class="ident" id="7960966">err</span>&nbsp;<span class="op" id="7960970">!=</span>&nbsp;<span class="ident" id="7960973">nil</span>&nbsp;<span class="op" id="7960977">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7960981">t</span><span class="op" id="7960982">.</span><span class="ident" id="7960983">Fatalf</span><span class="op" id="7960989">(</span><span class="string" id="7960990">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7961009">,</span>&nbsp;<span class="ident" id="7961011">err</span><span class="op" id="7961014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961020">l</span><span class="op" id="7961021">.</span><span class="ident" id="7961022">Close</span><span class="op" id="7961027">(</span><span class="op" id="7961028">)</span><br>
<span class="lineno"></span><span class="op" id="7961030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7961033">func</span>&nbsp;<span class="ident" id="7961038">check</span><span class="op" id="7961043">(</span><span class="ident" id="7961044">t</span>&nbsp;<span class="op" id="7961046">*</span><span class="ident" id="7961047">testing</span><span class="op" id="7961054">.</span><span class="ident" id="7961055">T</span><span class="op" id="7961056">,</span>&nbsp;<span class="ident" id="7961058">in</span><span class="op" id="7961060">,</span>&nbsp;<span class="ident" id="7961062">out</span>&nbsp;<span class="builtintype" id="7961066">string</span><span class="op" id="7961072">)</span>&nbsp;<span class="op" id="7961074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961077">tmpl</span>&nbsp;<span class="op" id="7961082">:=</span>&nbsp;<span class="ident" id="7961085">fmt</span><span class="op" id="7961088">.</span><span class="ident" id="7961089">Sprintf</span><span class="op" id="7961096">(</span><span class="string" id="7961097">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7961133">,</span>&nbsp;<span class="ident" id="7961135">LOG_USER</span><span class="op" id="7961143">+</span><span class="ident" id="7961144">LOG_INFO</span><span class="op" id="7961152">,</span>&nbsp;<span class="ident" id="7961154">in</span><span class="op" id="7961156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7961159">if</span>&nbsp;<span class="ident" id="7961162">hostname</span><span class="op" id="7961170">,</span>&nbsp;<span class="ident" id="7961172">err</span>&nbsp;<span class="op" id="7961176">:=</span>&nbsp;<span class="ident" id="7961179">os</span><span class="op" id="7961181">.</span><span class="ident" id="7961182">Hostname</span><span class="op" id="7961190">(</span><span class="op" id="7961191">)</span><span class="op" id="7961192">;</span>&nbsp;<span class="ident" id="7961194">err</span>&nbsp;<span class="op" id="7961198">!=</span>&nbsp;<span class="ident" id="7961201">nil</span>&nbsp;<span class="op" id="7961205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961209">t</span><span class="op" id="7961210">.</span><span class="ident" id="7961211">Error</span><span class="op" id="7961216">(</span><span class="string" id="7961217">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7961244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961247">}</span>&nbsp;<span class="keyword" id="7961249">else</span>&nbsp;<span class="op" id="7961254">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7961258">var</span>&nbsp;<span class="ident" id="7961262">parsedHostname</span><span class="op" id="7961276">,</span>&nbsp;<span class="ident" id="7961278">timestamp</span>&nbsp;<span class="builtintype" id="7961288">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7961297">var</span>&nbsp;<span class="ident" id="7961301">pid</span>&nbsp;<span class="builtintype" id="7961305">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7961311">if</span>&nbsp;<span class="ident" id="7961314">n</span><span class="op" id="7961315">,</span>&nbsp;<span class="ident" id="7961317">err</span>&nbsp;<span class="op" id="7961321">:=</span>&nbsp;<span class="ident" id="7961324">fmt</span><span class="op" id="7961327">.</span><span class="ident" id="7961328">Sscanf</span><span class="op" id="7961334">(</span><span class="ident" id="7961335">out</span><span class="op" id="7961338">,</span>&nbsp;<span class="ident" id="7961340">tmpl</span><span class="op" id="7961344">,</span>&nbsp;<span class="op" id="7961346">&amp;</span><span class="ident" id="7961347">timestamp</span><span class="op" id="7961356">,</span>&nbsp;<span class="op" id="7961358">&amp;</span><span class="ident" id="7961359">parsedHostname</span><span class="op" id="7961373">,</span>&nbsp;<span class="op" id="7961375">&amp;</span><span class="ident" id="7961376">pid</span><span class="op" id="7961379">)</span><span class="op" id="7961380">;</span>&nbsp;<span class="ident" id="7961382">n</span>&nbsp;<span class="op" id="7961384">!=</span>&nbsp;<span class="num" id="7961387">3</span>&nbsp;<span class="op" id="7961389">||</span>&nbsp;<span class="ident" id="7961392">err</span>&nbsp;<span class="op" id="7961396">!=</span>&nbsp;<span class="ident" id="7961399">nil</span>&nbsp;<span class="op" id="7961403">||</span>&nbsp;<span class="ident" id="7961406">hostname</span>&nbsp;<span class="op" id="7961415">!=</span>&nbsp;<span class="ident" id="7961418">parsedHostname</span>&nbsp;<span class="op" id="7961433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961438">t</span><span class="op" id="7961439">.</span><span class="ident" id="7961440">Errorf</span><span class="op" id="7961446">(</span><span class="string" id="7961447">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7961491">,</span>&nbsp;<span class="ident" id="7961493">out</span><span class="op" id="7961496">,</span>&nbsp;<span class="ident" id="7961498">tmpl</span><span class="op" id="7961502">,</span>&nbsp;<span class="ident" id="7961504">n</span><span class="op" id="7961505">,</span>&nbsp;<span class="ident" id="7961507">err</span><span class="op" id="7961510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961514">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961517">}</span><br>
<span class="lineno"></span><span class="op" id="7961519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7961522">func</span>&nbsp;<span class="ident" id="7961527">TestWrite</span><span class="op" id="7961536">(</span><span class="ident" id="7961537">t</span>&nbsp;<span class="op" id="7961539">*</span><span class="ident" id="7961540">testing</span><span class="op" id="7961547">.</span><span class="ident" id="7961548">T</span><span class="op" id="7961549">)</span>&nbsp;<span class="op" id="7961551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961554">tests</span>&nbsp;<span class="op" id="7961560">:=</span>&nbsp;<span class="op" id="7961563">[</span><span class="op" id="7961564">]</span><span class="keyword" id="7961565">struct</span>&nbsp;<span class="op" id="7961572">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961576">pri</span>&nbsp;<span class="ident" id="7961580">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961591">pre</span>&nbsp;<span class="builtintype" id="7961595">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961604">msg</span>&nbsp;<span class="builtintype" id="7961608">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961617">exp</span>&nbsp;<span class="builtintype" id="7961621">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961629">}</span><span class="op" id="7961630">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961634">{</span><span class="ident" id="7961635">LOG_USER</span>&nbsp;<span class="op" id="7961644">|</span>&nbsp;<span class="ident" id="7961646">LOG_ERR</span><span class="op" id="7961653">,</span>&nbsp;<span class="string" id="7961655">&#34;syslog_test&#34;</span><span class="op" id="7961668">,</span>&nbsp;<span class="string" id="7961670">&#34;&#34;</span><span class="op" id="7961672">,</span>&nbsp;<span class="string" id="7961674">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7961701">}</span><span class="op" id="7961702">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961706">{</span><span class="ident" id="7961707">LOG_USER</span>&nbsp;<span class="op" id="7961716">|</span>&nbsp;<span class="ident" id="7961718">LOG_ERR</span><span class="op" id="7961725">,</span>&nbsp;<span class="string" id="7961727">&#34;syslog_test&#34;</span><span class="op" id="7961740">,</span>&nbsp;<span class="string" id="7961742">&#34;write&nbsp;test&#34;</span><span class="op" id="7961754">,</span>&nbsp;<span class="string" id="7961756">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7961793">}</span><span class="op" id="7961794">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7961798">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961851">{</span><span class="ident" id="7961852">LOG_USER</span>&nbsp;<span class="op" id="7961861">|</span>&nbsp;<span class="ident" id="7961863">LOG_ERR</span><span class="op" id="7961870">,</span>&nbsp;<span class="string" id="7961872">&#34;syslog_test&#34;</span><span class="op" id="7961885">,</span>&nbsp;<span class="string" id="7961887">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7961903">,</span>&nbsp;<span class="string" id="7961905">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7961944">}</span><span class="op" id="7961945">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7961948">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7961952">if</span>&nbsp;<span class="ident" id="7961955">hostname</span><span class="op" id="7961963">,</span>&nbsp;<span class="ident" id="7961965">err</span>&nbsp;<span class="op" id="7961969">:=</span>&nbsp;<span class="ident" id="7961972">os</span><span class="op" id="7961974">.</span><span class="ident" id="7961975">Hostname</span><span class="op" id="7961983">(</span><span class="op" id="7961984">)</span><span class="op" id="7961985">;</span>&nbsp;<span class="ident" id="7961987">err</span>&nbsp;<span class="op" id="7961991">!=</span>&nbsp;<span class="ident" id="7961994">nil</span>&nbsp;<span class="op" id="7961998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962002">t</span><span class="op" id="7962003">.</span><span class="ident" id="7962004">Fatalf</span><span class="op" id="7962010">(</span><span class="string" id="7962011">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7962038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962041">}</span>&nbsp;<span class="keyword" id="7962043">else</span>&nbsp;<span class="op" id="7962048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962052">for</span>&nbsp;<span class="ident" id="7962056">_</span><span class="op" id="7962057">,</span>&nbsp;<span class="ident" id="7962059">test</span>&nbsp;<span class="op" id="7962064">:=</span>&nbsp;<span class="keyword" id="7962067">range</span>&nbsp;<span class="ident" id="7962073">tests</span>&nbsp;<span class="op" id="7962079">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962084">done</span>&nbsp;<span class="op" id="7962089">:=</span>&nbsp;<span class="builtinfunc" id="7962092">make</span><span class="op" id="7962096">(</span><span class="keyword" id="7962097">chan</span>&nbsp;<span class="builtintype" id="7962102">string</span><span class="op" id="7962108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962113">addr</span><span class="op" id="7962117">,</span>&nbsp;<span class="ident" id="7962119">sock</span><span class="op" id="7962123">,</span>&nbsp;<span class="ident" id="7962125">srvWG</span>&nbsp;<span class="op" id="7962131">:=</span>&nbsp;<span class="ident" id="7962134">startServer</span><span class="op" id="7962145">(</span><span class="string" id="7962146">&#34;udp&#34;</span><span class="op" id="7962151">,</span>&nbsp;<span class="string" id="7962153">&#34;&#34;</span><span class="op" id="7962155">,</span>&nbsp;<span class="ident" id="7962157">done</span><span class="op" id="7962161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962166">defer</span>&nbsp;<span class="ident" id="7962172">srvWG</span><span class="op" id="7962177">.</span><span class="ident" id="7962178">Wait</span><span class="op" id="7962182">(</span><span class="op" id="7962183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962188">defer</span>&nbsp;<span class="ident" id="7962194">sock</span><span class="op" id="7962198">.</span><span class="ident" id="7962199">Close</span><span class="op" id="7962204">(</span><span class="op" id="7962205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962210">l</span><span class="op" id="7962211">,</span>&nbsp;<span class="ident" id="7962213">err</span>&nbsp;<span class="op" id="7962217">:=</span>&nbsp;<span class="ident" id="7962220">Dial</span><span class="op" id="7962224">(</span><span class="string" id="7962225">&#34;udp&#34;</span><span class="op" id="7962230">,</span>&nbsp;<span class="ident" id="7962232">addr</span><span class="op" id="7962236">,</span>&nbsp;<span class="ident" id="7962238">test</span><span class="op" id="7962242">.</span><span class="ident" id="7962243">pri</span><span class="op" id="7962246">,</span>&nbsp;<span class="ident" id="7962248">test</span><span class="op" id="7962252">.</span><span class="ident" id="7962253">pre</span><span class="op" id="7962256">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962261">if</span>&nbsp;<span class="ident" id="7962264">err</span>&nbsp;<span class="op" id="7962268">!=</span>&nbsp;<span class="ident" id="7962271">nil</span>&nbsp;<span class="op" id="7962275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962281">t</span><span class="op" id="7962282">.</span><span class="ident" id="7962283">Fatalf</span><span class="op" id="7962289">(</span><span class="string" id="7962290">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7962316">,</span>&nbsp;<span class="ident" id="7962318">err</span><span class="op" id="7962321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962331">defer</span>&nbsp;<span class="ident" id="7962337">l</span><span class="op" id="7962338">.</span><span class="ident" id="7962339">Close</span><span class="op" id="7962344">(</span><span class="op" id="7962345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962350">_</span><span class="op" id="7962351">,</span>&nbsp;<span class="ident" id="7962353">err</span>&nbsp;<span class="op" id="7962357">=</span>&nbsp;<span class="ident" id="7962359">io</span><span class="op" id="7962361">.</span><span class="ident" id="7962362">WriteString</span><span class="op" id="7962373">(</span><span class="ident" id="7962374">l</span><span class="op" id="7962375">,</span>&nbsp;<span class="ident" id="7962377">test</span><span class="op" id="7962381">.</span><span class="ident" id="7962382">msg</span><span class="op" id="7962385">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962390">if</span>&nbsp;<span class="ident" id="7962393">err</span>&nbsp;<span class="op" id="7962397">!=</span>&nbsp;<span class="ident" id="7962400">nil</span>&nbsp;<span class="op" id="7962404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962410">t</span><span class="op" id="7962411">.</span><span class="ident" id="7962412">Fatalf</span><span class="op" id="7962418">(</span><span class="string" id="7962419">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7962445">,</span>&nbsp;<span class="ident" id="7962447">err</span><span class="op" id="7962450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962460">rcvd</span>&nbsp;<span class="op" id="7962465">:=</span>&nbsp;<span class="op" id="7962468">&lt;-</span><span class="ident" id="7962470">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962478">test</span><span class="op" id="7962482">.</span><span class="ident" id="7962483">exp</span>&nbsp;<span class="op" id="7962487">=</span>&nbsp;<span class="ident" id="7962489">fmt</span><span class="op" id="7962492">.</span><span class="ident" id="7962493">Sprintf</span><span class="op" id="7962500">(</span><span class="string" id="7962501">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7962507">,</span>&nbsp;<span class="ident" id="7962509">test</span><span class="op" id="7962513">.</span><span class="ident" id="7962514">pri</span><span class="op" id="7962517">)</span>&nbsp;<span class="op" id="7962519">+</span>&nbsp;<span class="ident" id="7962521">test</span><span class="op" id="7962525">.</span><span class="ident" id="7962526">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962533">var</span>&nbsp;<span class="ident" id="7962537">parsedHostname</span><span class="op" id="7962551">,</span>&nbsp;<span class="ident" id="7962553">timestamp</span>&nbsp;<span class="builtintype" id="7962563">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962573">var</span>&nbsp;<span class="ident" id="7962577">pid</span>&nbsp;<span class="builtintype" id="7962581">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962588">if</span>&nbsp;<span class="ident" id="7962591">n</span><span class="op" id="7962592">,</span>&nbsp;<span class="ident" id="7962594">err</span>&nbsp;<span class="op" id="7962598">:=</span>&nbsp;<span class="ident" id="7962601">fmt</span><span class="op" id="7962604">.</span><span class="ident" id="7962605">Sscanf</span><span class="op" id="7962611">(</span><span class="ident" id="7962612">rcvd</span><span class="op" id="7962616">,</span>&nbsp;<span class="ident" id="7962618">test</span><span class="op" id="7962622">.</span><span class="ident" id="7962623">exp</span><span class="op" id="7962626">,</span>&nbsp;<span class="op" id="7962628">&amp;</span><span class="ident" id="7962629">timestamp</span><span class="op" id="7962638">,</span>&nbsp;<span class="op" id="7962640">&amp;</span><span class="ident" id="7962641">parsedHostname</span><span class="op" id="7962655">,</span>&nbsp;<span class="op" id="7962657">&amp;</span><span class="ident" id="7962658">pid</span><span class="op" id="7962661">)</span><span class="op" id="7962662">;</span>&nbsp;<span class="ident" id="7962664">n</span>&nbsp;<span class="op" id="7962666">!=</span>&nbsp;<span class="num" id="7962669">3</span>&nbsp;<span class="op" id="7962671">||</span>&nbsp;<span class="ident" id="7962674">err</span>&nbsp;<span class="op" id="7962678">!=</span>&nbsp;<span class="ident" id="7962681">nil</span>&nbsp;<span class="op" id="7962685">||</span>&nbsp;<span class="ident" id="7962688">hostname</span>&nbsp;<span class="op" id="7962697">!=</span>&nbsp;<span class="ident" id="7962700">parsedHostname</span>&nbsp;<span class="op" id="7962715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962721">t</span><span class="op" id="7962722">.</span><span class="ident" id="7962723">Errorf</span><span class="op" id="7962729">(</span><span class="string" id="7962730">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7962774">,</span>&nbsp;<span class="ident" id="7962776">rcvd</span><span class="op" id="7962780">,</span>&nbsp;<span class="ident" id="7962782">test</span><span class="op" id="7962786">.</span><span class="ident" id="7962787">exp</span><span class="op" id="7962790">,</span>&nbsp;<span class="ident" id="7962792">n</span><span class="op" id="7962793">,</span>&nbsp;<span class="ident" id="7962795">err</span><span class="op" id="7962798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962803">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962810">}</span><br>
<span class="lineno"></span><span class="op" id="7962812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7962815">func</span>&nbsp;<span class="ident" id="7962820">TestConcurrentWrite</span><span class="op" id="7962839">(</span><span class="ident" id="7962840">t</span>&nbsp;<span class="op" id="7962842">*</span><span class="ident" id="7962843">testing</span><span class="op" id="7962850">.</span><span class="ident" id="7962851">T</span><span class="op" id="7962852">)</span>&nbsp;<span class="op" id="7962854">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962857">addr</span><span class="op" id="7962861">,</span>&nbsp;<span class="ident" id="7962863">sock</span><span class="op" id="7962867">,</span>&nbsp;<span class="ident" id="7962869">srvWG</span>&nbsp;<span class="op" id="7962875">:=</span>&nbsp;<span class="ident" id="7962878">startServer</span><span class="op" id="7962889">(</span><span class="string" id="7962890">&#34;udp&#34;</span><span class="op" id="7962895">,</span>&nbsp;<span class="string" id="7962897">&#34;&#34;</span><span class="op" id="7962899">,</span>&nbsp;<span class="builtinfunc" id="7962901">make</span><span class="op" id="7962905">(</span><span class="keyword" id="7962906">chan</span>&nbsp;<span class="builtintype" id="7962911">string</span><span class="op" id="7962917">,</span>&nbsp;<span class="num" id="7962919">1</span><span class="op" id="7962920">)</span><span class="op" id="7962921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962924">defer</span>&nbsp;<span class="ident" id="7962930">srvWG</span><span class="op" id="7962935">.</span><span class="ident" id="7962936">Wait</span><span class="op" id="7962940">(</span><span class="op" id="7962941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962944">defer</span>&nbsp;<span class="ident" id="7962950">sock</span><span class="op" id="7962954">.</span><span class="ident" id="7962955">Close</span><span class="op" id="7962960">(</span><span class="op" id="7962961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962964">w</span><span class="op" id="7962965">,</span>&nbsp;<span class="ident" id="7962967">err</span>&nbsp;<span class="op" id="7962971">:=</span>&nbsp;<span class="ident" id="7962974">Dial</span><span class="op" id="7962978">(</span><span class="string" id="7962979">&#34;udp&#34;</span><span class="op" id="7962984">,</span>&nbsp;<span class="ident" id="7962986">addr</span><span class="op" id="7962990">,</span>&nbsp;<span class="ident" id="7962992">LOG_USER</span><span class="op" id="7963000">|</span><span class="ident" id="7963001">LOG_ERR</span><span class="op" id="7963008">,</span>&nbsp;<span class="string" id="7963010">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7963027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963030">if</span>&nbsp;<span class="ident" id="7963033">err</span>&nbsp;<span class="op" id="7963037">!=</span>&nbsp;<span class="ident" id="7963040">nil</span>&nbsp;<span class="op" id="7963044">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963048">t</span><span class="op" id="7963049">.</span><span class="ident" id="7963050">Fatalf</span><span class="op" id="7963056">(</span><span class="string" id="7963057">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7963083">,</span>&nbsp;<span class="ident" id="7963085">err</span><span class="op" id="7963088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963094">var</span>&nbsp;<span class="ident" id="7963098">wg</span>&nbsp;<span class="ident" id="7963101">sync</span><span class="op" id="7963105">.</span><span class="ident" id="7963106">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963117">for</span>&nbsp;<span class="ident" id="7963121">i</span>&nbsp;<span class="op" id="7963123">:=</span>&nbsp;<span class="num" id="7963126">0</span><span class="op" id="7963127">;</span>&nbsp;<span class="ident" id="7963129">i</span>&nbsp;<span class="op" id="7963131">&lt;</span>&nbsp;<span class="num" id="7963133">10</span><span class="op" id="7963135">;</span>&nbsp;<span class="ident" id="7963137">i</span><span class="op" id="7963138">++</span>&nbsp;<span class="op" id="7963141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963145">wg</span><span class="op" id="7963147">.</span><span class="ident" id="7963148">Add</span><span class="op" id="7963151">(</span><span class="num" id="7963152">1</span><span class="op" id="7963153">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963157">go</span>&nbsp;<span class="keyword" id="7963160">func</span><span class="op" id="7963164">(</span><span class="op" id="7963165">)</span>&nbsp;<span class="op" id="7963167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963172">defer</span>&nbsp;<span class="ident" id="7963178">wg</span><span class="op" id="7963180">.</span><span class="ident" id="7963181">Done</span><span class="op" id="7963185">(</span><span class="op" id="7963186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963191">err</span>&nbsp;<span class="op" id="7963195">:=</span>&nbsp;<span class="ident" id="7963198">w</span><span class="op" id="7963199">.</span><span class="ident" id="7963200">Info</span><span class="op" id="7963204">(</span><span class="string" id="7963205">&#34;test&#34;</span><span class="op" id="7963211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963216">if</span>&nbsp;<span class="ident" id="7963219">err</span>&nbsp;<span class="op" id="7963223">!=</span>&nbsp;<span class="ident" id="7963226">nil</span>&nbsp;<span class="op" id="7963230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963236">t</span><span class="op" id="7963237">.</span><span class="ident" id="7963238">Errorf</span><span class="op" id="7963244">(</span><span class="string" id="7963245">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7963264">,</span>&nbsp;<span class="ident" id="7963266">err</span><span class="op" id="7963269">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963275">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963289">}</span><span class="op" id="7963290">(</span><span class="op" id="7963291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963297">wg</span><span class="op" id="7963299">.</span><span class="ident" id="7963300">Wait</span><span class="op" id="7963304">(</span><span class="op" id="7963305">)</span><br>
<span class="lineno">300</span><span class="op" id="7963307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7963310">func</span>&nbsp;<span class="ident" id="7963315">TestConcurrentReconnect</span><span class="op" id="7963338">(</span><span class="ident" id="7963339">t</span>&nbsp;<span class="op" id="7963341">*</span><span class="ident" id="7963342">testing</span><span class="op" id="7963349">.</span><span class="ident" id="7963350">T</span><span class="op" id="7963351">)</span>&nbsp;<span class="op" id="7963353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963356">crashy</span>&nbsp;<span class="op" id="7963363">=</span>&nbsp;<span class="builtintype" id="7963365">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963371">defer</span>&nbsp;<span class="keyword" id="7963377">func</span><span class="op" id="7963381">(</span><span class="op" id="7963382">)</span>&nbsp;<span class="op" id="7963384">{</span>&nbsp;<span class="ident" id="7963386">crashy</span>&nbsp;<span class="op" id="7963393">=</span>&nbsp;<span class="builtintype" id="7963395">false</span>&nbsp;<span class="op" id="7963401">}</span><span class="op" id="7963402">(</span><span class="op" id="7963403">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963407">const</span>&nbsp;<span class="ident" id="7963413">N</span>&nbsp;<span class="op" id="7963415">=</span>&nbsp;<span class="num" id="7963417">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963421">const</span>&nbsp;<span class="ident" id="7963427">M</span>&nbsp;<span class="op" id="7963429">=</span>&nbsp;<span class="num" id="7963431">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963436">net</span>&nbsp;<span class="op" id="7963440">:=</span>&nbsp;<span class="string" id="7963443">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963451">done</span>&nbsp;<span class="op" id="7963456">:=</span>&nbsp;<span class="builtinfunc" id="7963459">make</span><span class="op" id="7963463">(</span><span class="keyword" id="7963464">chan</span>&nbsp;<span class="builtintype" id="7963469">string</span><span class="op" id="7963475">,</span>&nbsp;<span class="ident" id="7963477">N</span><span class="op" id="7963478">*</span><span class="ident" id="7963479">M</span><span class="op" id="7963480">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963483">addr</span><span class="op" id="7963487">,</span>&nbsp;<span class="ident" id="7963489">sock</span><span class="op" id="7963493">,</span>&nbsp;<span class="ident" id="7963495">srvWG</span>&nbsp;<span class="op" id="7963501">:=</span>&nbsp;<span class="ident" id="7963504">startServer</span><span class="op" id="7963515">(</span><span class="ident" id="7963516">net</span><span class="op" id="7963519">,</span>&nbsp;<span class="string" id="7963521">&#34;&#34;</span><span class="op" id="7963523">,</span>&nbsp;<span class="ident" id="7963525">done</span><span class="op" id="7963529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963532">defer</span>&nbsp;<span class="ident" id="7963538">os</span><span class="op" id="7963540">.</span><span class="ident" id="7963541">Remove</span><span class="op" id="7963547">(</span><span class="ident" id="7963548">addr</span><span class="op" id="7963552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7963556">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963592">count</span>&nbsp;<span class="op" id="7963598">:=</span>&nbsp;<span class="builtinfunc" id="7963601">make</span><span class="op" id="7963605">(</span><span class="keyword" id="7963606">chan</span>&nbsp;<span class="builtintype" id="7963611">int</span><span class="op" id="7963614">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963617">go</span>&nbsp;<span class="keyword" id="7963620">func</span><span class="op" id="7963624">(</span><span class="op" id="7963625">)</span>&nbsp;<span class="op" id="7963627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963631">ct</span>&nbsp;<span class="op" id="7963634">:=</span>&nbsp;<span class="num" id="7963637">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963641">for</span>&nbsp;<span class="keyword" id="7963645">range</span>&nbsp;<span class="ident" id="7963651">done</span>&nbsp;<span class="op" id="7963656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963661">ct</span><span class="op" id="7963663">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7963669">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7963717">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7963766">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963805">if</span>&nbsp;<span class="ident" id="7963808">ct</span>&nbsp;<span class="op" id="7963811">&gt;</span>&nbsp;<span class="ident" id="7963813">N</span><span class="op" id="7963814">*</span><span class="ident" id="7963815">M</span><span class="op" id="7963816">/</span><span class="num" id="7963817">2</span>&nbsp;<span class="op" id="7963819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963825">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963834">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963842">count</span>&nbsp;<span class="op" id="7963848">&lt;-</span>&nbsp;<span class="ident" id="7963851">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963855">}</span><span class="op" id="7963856">(</span><span class="op" id="7963857">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963861">var</span>&nbsp;<span class="ident" id="7963865">wg</span>&nbsp;<span class="ident" id="7963868">sync</span><span class="op" id="7963872">.</span><span class="ident" id="7963873">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963884">wg</span><span class="op" id="7963886">.</span><span class="ident" id="7963887">Add</span><span class="op" id="7963890">(</span><span class="ident" id="7963891">N</span><span class="op" id="7963892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963895">for</span>&nbsp;<span class="ident" id="7963899">i</span>&nbsp;<span class="op" id="7963901">:=</span>&nbsp;<span class="num" id="7963904">0</span><span class="op" id="7963905">;</span>&nbsp;<span class="ident" id="7963907">i</span>&nbsp;<span class="op" id="7963909">&lt;</span>&nbsp;<span class="ident" id="7963911">N</span><span class="op" id="7963912">;</span>&nbsp;<span class="ident" id="7963914">i</span><span class="op" id="7963915">++</span>&nbsp;<span class="op" id="7963918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963922">go</span>&nbsp;<span class="keyword" id="7963925">func</span><span class="op" id="7963929">(</span><span class="op" id="7963930">)</span>&nbsp;<span class="op" id="7963932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963937">defer</span>&nbsp;<span class="ident" id="7963943">wg</span><span class="op" id="7963945">.</span><span class="ident" id="7963946">Done</span><span class="op" id="7963950">(</span><span class="op" id="7963951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963956">w</span><span class="op" id="7963957">,</span>&nbsp;<span class="ident" id="7963959">err</span>&nbsp;<span class="op" id="7963963">:=</span>&nbsp;<span class="ident" id="7963966">Dial</span><span class="op" id="7963970">(</span><span class="ident" id="7963971">net</span><span class="op" id="7963974">,</span>&nbsp;<span class="ident" id="7963976">addr</span><span class="op" id="7963980">,</span>&nbsp;<span class="ident" id="7963982">LOG_USER</span><span class="op" id="7963990">|</span><span class="ident" id="7963991">LOG_ERR</span><span class="op" id="7963998">,</span>&nbsp;<span class="string" id="7964000">&#34;tag&#34;</span><span class="op" id="7964005">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964010">if</span>&nbsp;<span class="ident" id="7964013">err</span>&nbsp;<span class="op" id="7964017">!=</span>&nbsp;<span class="ident" id="7964020">nil</span>&nbsp;<span class="op" id="7964024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964030">t</span><span class="op" id="7964031">.</span><span class="ident" id="7964032">Fatalf</span><span class="op" id="7964038">(</span><span class="string" id="7964039">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7964065">,</span>&nbsp;<span class="ident" id="7964067">err</span><span class="op" id="7964070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964080">defer</span>&nbsp;<span class="ident" id="7964086">w</span><span class="op" id="7964087">.</span><span class="ident" id="7964088">Close</span><span class="op" id="7964093">(</span><span class="op" id="7964094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964099">for</span>&nbsp;<span class="ident" id="7964103">i</span>&nbsp;<span class="op" id="7964105">:=</span>&nbsp;<span class="num" id="7964108">0</span><span class="op" id="7964109">;</span>&nbsp;<span class="ident" id="7964111">i</span>&nbsp;<span class="op" id="7964113">&lt;</span>&nbsp;<span class="ident" id="7964115">M</span><span class="op" id="7964116">;</span>&nbsp;<span class="ident" id="7964118">i</span><span class="op" id="7964119">++</span>&nbsp;<span class="op" id="7964122">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964128">err</span>&nbsp;<span class="op" id="7964132">:=</span>&nbsp;<span class="ident" id="7964135">w</span><span class="op" id="7964136">.</span><span class="ident" id="7964137">Info</span><span class="op" id="7964141">(</span><span class="string" id="7964142">&#34;test&#34;</span><span class="op" id="7964148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964154">if</span>&nbsp;<span class="ident" id="7964157">err</span>&nbsp;<span class="op" id="7964161">!=</span>&nbsp;<span class="ident" id="7964164">nil</span>&nbsp;<span class="op" id="7964168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964175">t</span><span class="op" id="7964176">.</span><span class="ident" id="7964177">Errorf</span><span class="op" id="7964183">(</span><span class="string" id="7964184">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7964203">,</span>&nbsp;<span class="ident" id="7964205">err</span><span class="op" id="7964208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964215">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964226">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964235">}</span><span class="op" id="7964236">(</span><span class="op" id="7964237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964243">wg</span><span class="op" id="7964245">.</span><span class="ident" id="7964246">Wait</span><span class="op" id="7964250">(</span><span class="op" id="7964251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964254">sock</span><span class="op" id="7964258">.</span><span class="ident" id="7964259">Close</span><span class="op" id="7964264">(</span><span class="op" id="7964265">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964268">srvWG</span><span class="op" id="7964273">.</span><span class="ident" id="7964274">Wait</span><span class="op" id="7964278">(</span><span class="op" id="7964279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7964282">close</span><span class="op" id="7964287">(</span><span class="ident" id="7964288">done</span><span class="op" id="7964292">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964296">select</span>&nbsp;<span class="op" id="7964303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964306">case</span>&nbsp;<span class="op" id="7964311">&lt;-</span><span class="ident" id="7964313">count</span><span class="op" id="7964318">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964321">case</span>&nbsp;<span class="op" id="7964326">&lt;-</span><span class="ident" id="7964328">time</span><span class="op" id="7964332">.</span><span class="ident" id="7964333">After</span><span class="op" id="7964338">(</span><span class="num" id="7964339">100</span>&nbsp;<span class="op" id="7964343">*</span>&nbsp;<span class="ident" id="7964345">time</span><span class="op" id="7964349">.</span><span class="ident" id="7964350">Millisecond</span><span class="op" id="7964361">)</span><span class="op" id="7964362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964366">t</span><span class="op" id="7964367">.</span><span class="ident" id="7964368">Error</span><span class="op" id="7964373">(</span><span class="string" id="7964374">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7964407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964410">}</span><br>
<span class="lineno"></span><span class="op" id="7964412">}</span>
</div>
</body>
</html>
