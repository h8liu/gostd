<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html" class="current">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1188817">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1188872">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1188926">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1188977">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1189042">package</span>&nbsp;<span class="ident" id="1189050">syscall_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1189064">import</span>&nbsp;<span class="op" id="1189071">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189074">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189082">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189089">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189102">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189109">&#34;os&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189115">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189126">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189143">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189154">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189165">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1189176">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1189183">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1189186">//&nbsp;Tests&nbsp;that&nbsp;below&nbsp;functions,&nbsp;structures&nbsp;and&nbsp;constants&nbsp;are&nbsp;consistent</span><br>
<span class="lineno"></span><span class="comment" id="1189257">//&nbsp;on&nbsp;all&nbsp;Unix-like&nbsp;systems.</span><br>
<span class="lineno">25</span><span class="keyword" id="1189286">func</span>&nbsp;<span class="ident" id="1189291">_</span><span class="op" id="1189292">(</span><span class="op" id="1189293">)</span>&nbsp;<span class="op" id="1189295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1189298">//&nbsp;program&nbsp;scheduling&nbsp;priority&nbsp;functions&nbsp;and&nbsp;constants</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1189354">var</span>&nbsp;<span class="op" id="1189358">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189362">_</span>&nbsp;<span class="keyword" id="1189364">func</span><span class="op" id="1189368">(</span><span class="builtintype" id="1189369">int</span><span class="op" id="1189372">,</span>&nbsp;<span class="builtintype" id="1189374">int</span><span class="op" id="1189377">,</span>&nbsp;<span class="builtintype" id="1189379">int</span><span class="op" id="1189382">)</span>&nbsp;<span class="builtintype" id="1189384">error</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1189392">=</span>&nbsp;<span class="ident" id="1189394">syscall</span><span class="op" id="1189401">.</span><span class="ident" id="1189402">Setpriority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189416">_</span>&nbsp;<span class="keyword" id="1189418">func</span><span class="op" id="1189422">(</span><span class="builtintype" id="1189423">int</span><span class="op" id="1189426">,</span>&nbsp;<span class="builtintype" id="1189428">int</span><span class="op" id="1189431">)</span>&nbsp;<span class="op" id="1189433">(</span><span class="builtintype" id="1189434">int</span><span class="op" id="1189437">,</span>&nbsp;<span class="builtintype" id="1189439">error</span><span class="op" id="1189444">)</span>&nbsp;<span class="op" id="1189446">=</span>&nbsp;<span class="ident" id="1189448">syscall</span><span class="op" id="1189455">.</span><span class="ident" id="1189456">Getpriority</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1189469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1189472">const</span>&nbsp;<span class="op" id="1189478">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189482">_</span>&nbsp;<span class="builtintype" id="1189484">int</span>&nbsp;<span class="op" id="1189488">=</span>&nbsp;<span class="ident" id="1189490">syscall</span><span class="op" id="1189497">.</span><span class="ident" id="1189498">PRIO_USER</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189510">_</span>&nbsp;<span class="builtintype" id="1189512">int</span>&nbsp;<span class="op" id="1189516">=</span>&nbsp;<span class="ident" id="1189518">syscall</span><span class="op" id="1189525">.</span><span class="ident" id="1189526">PRIO_PROCESS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189541">_</span>&nbsp;<span class="builtintype" id="1189543">int</span>&nbsp;<span class="op" id="1189547">=</span>&nbsp;<span class="ident" id="1189549">syscall</span><span class="op" id="1189556">.</span><span class="ident" id="1189557">PRIO_PGRP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1189568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1189572">//&nbsp;termios&nbsp;constants</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1189594">const</span>&nbsp;<span class="op" id="1189600">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189604">_</span>&nbsp;<span class="builtintype" id="1189606">int</span>&nbsp;<span class="op" id="1189610">=</span>&nbsp;<span class="ident" id="1189612">syscall</span><span class="op" id="1189619">.</span><span class="ident" id="1189620">TCIFLUSH</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189631">_</span>&nbsp;<span class="builtintype" id="1189633">int</span>&nbsp;<span class="op" id="1189637">=</span>&nbsp;<span class="ident" id="1189639">syscall</span><span class="op" id="1189646">.</span><span class="ident" id="1189647">TCIOFLUSH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189659">_</span>&nbsp;<span class="builtintype" id="1189661">int</span>&nbsp;<span class="op" id="1189665">=</span>&nbsp;<span class="ident" id="1189667">syscall</span><span class="op" id="1189674">.</span><span class="ident" id="1189675">TCOFLUSH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1189685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1189689">//&nbsp;fcntl&nbsp;file&nbsp;locking&nbsp;structure&nbsp;and&nbsp;constants</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1189736">var</span>&nbsp;<span class="op" id="1189740">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189744">_</span>&nbsp;<span class="op" id="1189746">=</span>&nbsp;<span class="ident" id="1189748">syscall</span><span class="op" id="1189755">.</span><span class="ident" id="1189756">Flock_t</span><span class="op" id="1189763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189768">Type</span><span class="op" id="1189772">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1189776">int16</span><span class="op" id="1189781">(</span><span class="num" id="1189782">0</span><span class="op" id="1189783">)</span><span class="op" id="1189784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189789">Whence</span><span class="op" id="1189795">:</span>&nbsp;<span class="builtintype" id="1189797">int16</span><span class="op" id="1189802">(</span><span class="num" id="1189803">0</span><span class="op" id="1189804">)</span><span class="op" id="1189805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189810">Start</span><span class="op" id="1189815">:</span>&nbsp;&nbsp;<span class="ident" id="1189818">int64</span><span class="op" id="1189823">(</span><span class="num" id="1189824">0</span><span class="op" id="1189825">)</span><span class="op" id="1189826">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189831">Len</span><span class="op" id="1189834">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189839">int64</span><span class="op" id="1189844">(</span><span class="num" id="1189845">0</span><span class="op" id="1189846">)</span><span class="op" id="1189847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189852">Pid</span><span class="op" id="1189855">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1189860">int32</span><span class="op" id="1189865">(</span><span class="num" id="1189866">0</span><span class="op" id="1189867">)</span><span class="op" id="1189868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1189872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1189875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1189878">const</span>&nbsp;<span class="op" id="1189884">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189888">_</span>&nbsp;<span class="op" id="1189890">=</span>&nbsp;<span class="ident" id="1189892">syscall</span><span class="op" id="1189899">.</span><span class="ident" id="1189900">F_GETLK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189910">_</span>&nbsp;<span class="op" id="1189912">=</span>&nbsp;<span class="ident" id="1189914">syscall</span><span class="op" id="1189921">.</span><span class="ident" id="1189922">F_SETLK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1189932">_</span>&nbsp;<span class="op" id="1189934">=</span>&nbsp;<span class="ident" id="1189936">syscall</span><span class="op" id="1189943">.</span><span class="ident" id="1189944">F_SETLKW</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1189954">)</span><br>
<span class="lineno"></span><span class="op" id="1189956">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="1189959">//&nbsp;TestFcntlFlock&nbsp;tests&nbsp;whether&nbsp;the&nbsp;file&nbsp;locking&nbsp;structure&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="1190026">//&nbsp;the&nbsp;calling&nbsp;convention&nbsp;of&nbsp;each&nbsp;kernel.</span><br>
<span class="lineno"></span><span class="keyword" id="1190068">func</span>&nbsp;<span class="ident" id="1190073">TestFcntlFlock</span><span class="op" id="1190087">(</span><span class="ident" id="1190088">t</span>&nbsp;<span class="op" id="1190090">*</span><span class="ident" id="1190091">testing</span><span class="op" id="1190098">.</span><span class="ident" id="1190099">T</span><span class="op" id="1190100">)</span>&nbsp;<span class="op" id="1190102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190105">name</span>&nbsp;<span class="op" id="1190110">:=</span>&nbsp;<span class="ident" id="1190113">filepath</span><span class="op" id="1190121">.</span><span class="ident" id="1190122">Join</span><span class="op" id="1190126">(</span><span class="ident" id="1190127">os</span><span class="op" id="1190129">.</span><span class="ident" id="1190130">TempDir</span><span class="op" id="1190137">(</span><span class="op" id="1190138">)</span><span class="op" id="1190139">,</span>&nbsp;<span class="string" id="1190141">&#34;TestFcntlFlock&#34;</span><span class="op" id="1190157">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190160">fd</span><span class="op" id="1190162">,</span>&nbsp;<span class="ident" id="1190164">err</span>&nbsp;<span class="op" id="1190168">:=</span>&nbsp;<span class="ident" id="1190171">syscall</span><span class="op" id="1190178">.</span><span class="ident" id="1190179">Open</span><span class="op" id="1190183">(</span><span class="ident" id="1190184">name</span><span class="op" id="1190188">,</span>&nbsp;<span class="ident" id="1190190">syscall</span><span class="op" id="1190197">.</span><span class="ident" id="1190198">O_CREAT</span><span class="op" id="1190205">|</span><span class="ident" id="1190206">syscall</span><span class="op" id="1190213">.</span><span class="ident" id="1190214">O_RDWR</span><span class="op" id="1190220">|</span><span class="ident" id="1190221">syscall</span><span class="op" id="1190228">.</span><span class="ident" id="1190229">O_CLOEXEC</span><span class="op" id="1190238">,</span>&nbsp;<span class="num" id="1190240">0</span><span class="op" id="1190241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1190244">if</span>&nbsp;<span class="ident" id="1190247">err</span>&nbsp;<span class="op" id="1190251">!=</span>&nbsp;<span class="ident" id="1190254">nil</span>&nbsp;<span class="op" id="1190258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190262">t</span><span class="op" id="1190263">.</span><span class="ident" id="1190264">Fatalf</span><span class="op" id="1190270">(</span><span class="string" id="1190271">&#34;Open&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="1190288">,</span>&nbsp;<span class="ident" id="1190290">err</span><span class="op" id="1190293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1190296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1190299">defer</span>&nbsp;<span class="ident" id="1190305">syscall</span><span class="op" id="1190312">.</span><span class="ident" id="1190313">Unlink</span><span class="op" id="1190319">(</span><span class="ident" id="1190320">name</span><span class="op" id="1190324">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1190327">defer</span>&nbsp;<span class="ident" id="1190333">syscall</span><span class="op" id="1190340">.</span><span class="ident" id="1190341">Close</span><span class="op" id="1190346">(</span><span class="ident" id="1190347">fd</span><span class="op" id="1190349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190352">flock</span>&nbsp;<span class="op" id="1190358">:=</span>&nbsp;<span class="ident" id="1190361">syscall</span><span class="op" id="1190368">.</span><span class="ident" id="1190369">Flock_t</span><span class="op" id="1190376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190380">Type</span><span class="op" id="1190384">:</span>&nbsp;&nbsp;<span class="ident" id="1190387">syscall</span><span class="op" id="1190394">.</span><span class="ident" id="1190395">F_RDLCK</span><span class="op" id="1190402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190406">Start</span><span class="op" id="1190411">:</span>&nbsp;<span class="num" id="1190413">0</span><span class="op" id="1190414">,</span>&nbsp;<span class="ident" id="1190416">Len</span><span class="op" id="1190419">:</span>&nbsp;<span class="num" id="1190421">0</span><span class="op" id="1190422">,</span>&nbsp;<span class="ident" id="1190424">Whence</span><span class="op" id="1190430">:</span>&nbsp;<span class="num" id="1190432">1</span><span class="op" id="1190433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1190436">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1190439">if</span>&nbsp;<span class="ident" id="1190442">err</span>&nbsp;<span class="op" id="1190446">:=</span>&nbsp;<span class="ident" id="1190449">syscall</span><span class="op" id="1190456">.</span><span class="ident" id="1190457">FcntlFlock</span><span class="op" id="1190467">(</span><span class="builtintype" id="1190468">uintptr</span><span class="op" id="1190475">(</span><span class="ident" id="1190476">fd</span><span class="op" id="1190478">)</span><span class="op" id="1190479">,</span>&nbsp;<span class="ident" id="1190481">syscall</span><span class="op" id="1190488">.</span><span class="ident" id="1190489">F_GETLK</span><span class="op" id="1190496">,</span>&nbsp;<span class="op" id="1190498">&amp;</span><span class="ident" id="1190499">flock</span><span class="op" id="1190504">)</span><span class="op" id="1190505">;</span>&nbsp;<span class="ident" id="1190507">err</span>&nbsp;<span class="op" id="1190511">!=</span>&nbsp;<span class="ident" id="1190514">nil</span>&nbsp;<span class="op" id="1190518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1190522">t</span><span class="op" id="1190523">.</span><span class="ident" id="1190524">Fatalf</span><span class="op" id="1190530">(</span><span class="string" id="1190531">&#34;FcntlFlock&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="1190554">,</span>&nbsp;<span class="ident" id="1190556">err</span><span class="op" id="1190559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1190562">}</span><br>
<span class="lineno"></span><span class="op" id="1190564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="1190567">//&nbsp;TestPassFD&nbsp;tests&nbsp;passing&nbsp;a&nbsp;file&nbsp;descriptor&nbsp;over&nbsp;a&nbsp;Unix&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="1190633">//</span><br>
<span class="lineno"></span><span class="comment" id="1190636">//&nbsp;This&nbsp;test&nbsp;involved&nbsp;both&nbsp;a&nbsp;parent&nbsp;and&nbsp;child&nbsp;process.&nbsp;The&nbsp;parent</span><br>
<span class="lineno"></span><span class="comment" id="1190702">//&nbsp;process&nbsp;is&nbsp;invoked&nbsp;as&nbsp;a&nbsp;normal&nbsp;test,&nbsp;with&nbsp;&#34;go&nbsp;test&#34;,&nbsp;which&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1190769">//&nbsp;runs&nbsp;the&nbsp;child&nbsp;process&nbsp;by&nbsp;running&nbsp;the&nbsp;current&nbsp;test&nbsp;binary&nbsp;with&nbsp;args</span><br>
<span class="lineno">85</span><span class="comment" id="1190840">//&nbsp;&#34;-test.run=^TestPassFD$&#34;&nbsp;and&nbsp;an&nbsp;environment&nbsp;variable&nbsp;used&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span><span class="comment" id="1190911">//&nbsp;that&nbsp;the&nbsp;test&nbsp;should&nbsp;become&nbsp;the&nbsp;child&nbsp;process&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="1190969">func</span>&nbsp;<span class="ident" id="1190974">TestPassFD</span><span class="op" id="1190984">(</span><span class="ident" id="1190985">t</span>&nbsp;<span class="op" id="1190987">*</span><span class="ident" id="1190988">testing</span><span class="op" id="1190995">.</span><span class="ident" id="1190996">T</span><span class="op" id="1190997">)</span>&nbsp;<span class="op" id="1190999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191002">switch</span>&nbsp;<span class="ident" id="1191009">runtime</span><span class="op" id="1191016">.</span><span class="ident" id="1191017">GOOS</span>&nbsp;<span class="op" id="1191022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191025">case</span>&nbsp;<span class="string" id="1191030">&#34;dragonfly&#34;</span><span class="op" id="1191041">:</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1191045">//&nbsp;TODO(jsing):&nbsp;Figure&nbsp;out&nbsp;why&nbsp;sendmsg&nbsp;is&nbsp;returning&nbsp;EINVAL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191107">t</span><span class="op" id="1191108">.</span><span class="ident" id="1191109">Skip</span><span class="op" id="1191113">(</span><span class="string" id="1191114">&#34;skipping&nbsp;test&nbsp;on&nbsp;dragonfly&#34;</span><span class="op" id="1191142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191145">case</span>&nbsp;<span class="string" id="1191150">&#34;solaris&#34;</span><span class="op" id="1191159">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1191163">//&nbsp;TODO(aram):&nbsp;Figure&nbsp;out&nbsp;why&nbsp;ReadMsgUnix&nbsp;is&nbsp;returning&nbsp;empty&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191235">t</span><span class="op" id="1191236">.</span><span class="ident" id="1191237">Skip</span><span class="op" id="1191241">(</span><span class="string" id="1191242">&#34;skipping&nbsp;test&nbsp;on&nbsp;solaris,&nbsp;see&nbsp;issue&nbsp;7402&#34;</span><span class="op" id="1191284">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1191287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191290">if</span>&nbsp;<span class="ident" id="1191293">os</span><span class="op" id="1191295">.</span><span class="ident" id="1191296">Getenv</span><span class="op" id="1191302">(</span><span class="string" id="1191303">&#34;GO_WANT_HELPER_PROCESS&#34;</span><span class="op" id="1191327">)</span>&nbsp;<span class="op" id="1191329">==</span>&nbsp;<span class="string" id="1191332">&#34;1&#34;</span>&nbsp;<span class="op" id="1191336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191340">passFDChild</span><span class="op" id="1191351">(</span><span class="op" id="1191352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191356">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1191364">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191368">tempDir</span><span class="op" id="1191375">,</span>&nbsp;<span class="ident" id="1191377">err</span>&nbsp;<span class="op" id="1191381">:=</span>&nbsp;<span class="ident" id="1191384">ioutil</span><span class="op" id="1191390">.</span><span class="ident" id="1191391">TempDir</span><span class="op" id="1191398">(</span><span class="string" id="1191399">&#34;&#34;</span><span class="op" id="1191401">,</span>&nbsp;<span class="string" id="1191403">&#34;TestPassFD&#34;</span><span class="op" id="1191415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191418">if</span>&nbsp;<span class="ident" id="1191421">err</span>&nbsp;<span class="op" id="1191425">!=</span>&nbsp;<span class="ident" id="1191428">nil</span>&nbsp;<span class="op" id="1191432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191436">t</span><span class="op" id="1191437">.</span><span class="ident" id="1191438">Fatal</span><span class="op" id="1191443">(</span><span class="ident" id="1191444">err</span><span class="op" id="1191447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1191450">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191453">defer</span>&nbsp;<span class="ident" id="1191459">os</span><span class="op" id="1191461">.</span><span class="ident" id="1191462">RemoveAll</span><span class="op" id="1191471">(</span><span class="ident" id="1191472">tempDir</span><span class="op" id="1191479">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191483">fds</span><span class="op" id="1191486">,</span>&nbsp;<span class="ident" id="1191488">err</span>&nbsp;<span class="op" id="1191492">:=</span>&nbsp;<span class="ident" id="1191495">syscall</span><span class="op" id="1191502">.</span><span class="ident" id="1191503">Socketpair</span><span class="op" id="1191513">(</span><span class="ident" id="1191514">syscall</span><span class="op" id="1191521">.</span><span class="ident" id="1191522">AF_LOCAL</span><span class="op" id="1191530">,</span>&nbsp;<span class="ident" id="1191532">syscall</span><span class="op" id="1191539">.</span><span class="ident" id="1191540">SOCK_STREAM</span><span class="op" id="1191551">,</span>&nbsp;<span class="num" id="1191553">0</span><span class="op" id="1191554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191557">if</span>&nbsp;<span class="ident" id="1191560">err</span>&nbsp;<span class="op" id="1191564">!=</span>&nbsp;<span class="ident" id="1191567">nil</span>&nbsp;<span class="op" id="1191571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191575">t</span><span class="op" id="1191576">.</span><span class="ident" id="1191577">Fatalf</span><span class="op" id="1191583">(</span><span class="string" id="1191584">&#34;Socketpair:&nbsp;%v&#34;</span><span class="op" id="1191600">,</span>&nbsp;<span class="ident" id="1191602">err</span><span class="op" id="1191605">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1191608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191611">defer</span>&nbsp;<span class="ident" id="1191617">syscall</span><span class="op" id="1191624">.</span><span class="ident" id="1191625">Close</span><span class="op" id="1191630">(</span><span class="ident" id="1191631">fds</span><span class="op" id="1191634">[</span><span class="num" id="1191635">0</span><span class="op" id="1191636">]</span><span class="op" id="1191637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191640">defer</span>&nbsp;<span class="ident" id="1191646">syscall</span><span class="op" id="1191653">.</span><span class="ident" id="1191654">Close</span><span class="op" id="1191659">(</span><span class="ident" id="1191660">fds</span><span class="op" id="1191663">[</span><span class="num" id="1191664">1</span><span class="op" id="1191665">]</span><span class="op" id="1191666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191669">writeFile</span>&nbsp;<span class="op" id="1191679">:=</span>&nbsp;<span class="ident" id="1191682">os</span><span class="op" id="1191684">.</span><span class="ident" id="1191685">NewFile</span><span class="op" id="1191692">(</span><span class="builtintype" id="1191693">uintptr</span><span class="op" id="1191700">(</span><span class="ident" id="1191701">fds</span><span class="op" id="1191704">[</span><span class="num" id="1191705">0</span><span class="op" id="1191706">]</span><span class="op" id="1191707">)</span><span class="op" id="1191708">,</span>&nbsp;<span class="string" id="1191710">&#34;child-writes&#34;</span><span class="op" id="1191724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191727">readFile</span>&nbsp;<span class="op" id="1191736">:=</span>&nbsp;<span class="ident" id="1191739">os</span><span class="op" id="1191741">.</span><span class="ident" id="1191742">NewFile</span><span class="op" id="1191749">(</span><span class="builtintype" id="1191750">uintptr</span><span class="op" id="1191757">(</span><span class="ident" id="1191758">fds</span><span class="op" id="1191761">[</span><span class="num" id="1191762">1</span><span class="op" id="1191763">]</span><span class="op" id="1191764">)</span><span class="op" id="1191765">,</span>&nbsp;<span class="string" id="1191767">&#34;parent-reads&#34;</span><span class="op" id="1191781">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191784">defer</span>&nbsp;<span class="ident" id="1191790">writeFile</span><span class="op" id="1191799">.</span><span class="ident" id="1191800">Close</span><span class="op" id="1191805">(</span><span class="op" id="1191806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1191809">defer</span>&nbsp;<span class="ident" id="1191815">readFile</span><span class="op" id="1191823">.</span><span class="ident" id="1191824">Close</span><span class="op" id="1191829">(</span><span class="op" id="1191830">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191834">cmd</span>&nbsp;<span class="op" id="1191838">:=</span>&nbsp;<span class="ident" id="1191841">exec</span><span class="op" id="1191845">.</span><span class="ident" id="1191846">Command</span><span class="op" id="1191853">(</span><span class="ident" id="1191854">os</span><span class="op" id="1191856">.</span><span class="ident" id="1191857">Args</span><span class="op" id="1191861">[</span><span class="num" id="1191862">0</span><span class="op" id="1191863">]</span><span class="op" id="1191864">,</span>&nbsp;<span class="string" id="1191866">&#34;-test.run=^TestPassFD$&#34;</span><span class="op" id="1191890">,</span>&nbsp;<span class="string" id="1191892">&#34;--&#34;</span><span class="op" id="1191896">,</span>&nbsp;<span class="ident" id="1191898">tempDir</span><span class="op" id="1191905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191908">cmd</span><span class="op" id="1191911">.</span><span class="ident" id="1191912">Env</span>&nbsp;<span class="op" id="1191916">=</span>&nbsp;<span class="op" id="1191918">[</span><span class="op" id="1191919">]</span><span class="builtintype" id="1191920">string</span><span class="op" id="1191926">{</span><span class="string" id="1191927">&#34;GO_WANT_HELPER_PROCESS=1&#34;</span><span class="op" id="1191953">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191956">cmd</span><span class="op" id="1191959">.</span><span class="ident" id="1191960">ExtraFiles</span>&nbsp;<span class="op" id="1191971">=</span>&nbsp;<span class="op" id="1191973">[</span><span class="op" id="1191974">]</span><span class="op" id="1191975">*</span><span class="ident" id="1191976">os</span><span class="op" id="1191978">.</span><span class="ident" id="1191979">File</span><span class="op" id="1191983">{</span><span class="ident" id="1191984">writeFile</span><span class="op" id="1191993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1191997">out</span><span class="op" id="1192000">,</span>&nbsp;<span class="ident" id="1192002">err</span>&nbsp;<span class="op" id="1192006">:=</span>&nbsp;<span class="ident" id="1192009">cmd</span><span class="op" id="1192012">.</span><span class="ident" id="1192013">CombinedOutput</span><span class="op" id="1192027">(</span><span class="op" id="1192028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192031">if</span>&nbsp;<span class="builtinfunc" id="1192034">len</span><span class="op" id="1192037">(</span><span class="ident" id="1192038">out</span><span class="op" id="1192041">)</span>&nbsp;<span class="op" id="1192043">&gt;</span>&nbsp;<span class="num" id="1192045">0</span>&nbsp;<span class="op" id="1192047">||</span>&nbsp;<span class="ident" id="1192050">err</span>&nbsp;<span class="op" id="1192054">!=</span>&nbsp;<span class="ident" id="1192057">nil</span>&nbsp;<span class="op" id="1192061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192065">t</span><span class="op" id="1192066">.</span><span class="ident" id="1192067">Fatalf</span><span class="op" id="1192073">(</span><span class="string" id="1192074">&#34;child&nbsp;process:&nbsp;%q,&nbsp;%v&#34;</span><span class="op" id="1192097">,</span>&nbsp;<span class="ident" id="1192099">out</span><span class="op" id="1192102">,</span>&nbsp;<span class="ident" id="1192104">err</span><span class="op" id="1192107">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192114">c</span><span class="op" id="1192115">,</span>&nbsp;<span class="ident" id="1192117">err</span>&nbsp;<span class="op" id="1192121">:=</span>&nbsp;<span class="ident" id="1192124">net</span><span class="op" id="1192127">.</span><span class="ident" id="1192128">FileConn</span><span class="op" id="1192136">(</span><span class="ident" id="1192137">readFile</span><span class="op" id="1192145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192148">if</span>&nbsp;<span class="ident" id="1192151">err</span>&nbsp;<span class="op" id="1192155">!=</span>&nbsp;<span class="ident" id="1192158">nil</span>&nbsp;<span class="op" id="1192162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192166">t</span><span class="op" id="1192167">.</span><span class="ident" id="1192168">Fatalf</span><span class="op" id="1192174">(</span><span class="string" id="1192175">&#34;FileConn:&nbsp;%v&#34;</span><span class="op" id="1192189">,</span>&nbsp;<span class="ident" id="1192191">err</span><span class="op" id="1192194">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192200">defer</span>&nbsp;<span class="ident" id="1192206">c</span><span class="op" id="1192207">.</span><span class="ident" id="1192208">Close</span><span class="op" id="1192213">(</span><span class="op" id="1192214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192218">uc</span><span class="op" id="1192220">,</span>&nbsp;<span class="ident" id="1192222">ok</span>&nbsp;<span class="op" id="1192225">:=</span>&nbsp;<span class="ident" id="1192228">c</span><span class="op" id="1192229">.</span><span class="op" id="1192230">(</span><span class="op" id="1192231">*</span><span class="ident" id="1192232">net</span><span class="op" id="1192235">.</span><span class="ident" id="1192236">UnixConn</span><span class="op" id="1192244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192247">if</span>&nbsp;<span class="op" id="1192250">!</span><span class="ident" id="1192251">ok</span>&nbsp;<span class="op" id="1192254">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192258">t</span><span class="op" id="1192259">.</span><span class="ident" id="1192260">Fatalf</span><span class="op" id="1192266">(</span><span class="string" id="1192267">&#34;unexpected&nbsp;FileConn&nbsp;type;&nbsp;expected&nbsp;UnixConn,&nbsp;got&nbsp;%T&#34;</span><span class="op" id="1192320">,</span>&nbsp;<span class="ident" id="1192322">c</span><span class="op" id="1192323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192330">buf</span>&nbsp;<span class="op" id="1192334">:=</span>&nbsp;<span class="builtinfunc" id="1192337">make</span><span class="op" id="1192341">(</span><span class="op" id="1192342">[</span><span class="op" id="1192343">]</span><span class="builtintype" id="1192344">byte</span><span class="op" id="1192348">,</span>&nbsp;<span class="num" id="1192350">32</span><span class="op" id="1192352">)</span>&nbsp;<span class="comment" id="1192354">//&nbsp;expect&nbsp;1&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192372">oob</span>&nbsp;<span class="op" id="1192376">:=</span>&nbsp;<span class="builtinfunc" id="1192379">make</span><span class="op" id="1192383">(</span><span class="op" id="1192384">[</span><span class="op" id="1192385">]</span><span class="builtintype" id="1192386">byte</span><span class="op" id="1192390">,</span>&nbsp;<span class="num" id="1192392">32</span><span class="op" id="1192394">)</span>&nbsp;<span class="comment" id="1192396">//&nbsp;expect&nbsp;24&nbsp;bytes</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192416">closeUnix</span>&nbsp;<span class="op" id="1192426">:=</span>&nbsp;<span class="ident" id="1192429">time</span><span class="op" id="1192433">.</span><span class="ident" id="1192434">AfterFunc</span><span class="op" id="1192443">(</span><span class="num" id="1192444">5</span><span class="op" id="1192445">*</span><span class="ident" id="1192446">time</span><span class="op" id="1192450">.</span><span class="ident" id="1192451">Second</span><span class="op" id="1192457">,</span>&nbsp;<span class="keyword" id="1192459">func</span><span class="op" id="1192463">(</span><span class="op" id="1192464">)</span>&nbsp;<span class="op" id="1192466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192470">t</span><span class="op" id="1192471">.</span><span class="ident" id="1192472">Logf</span><span class="op" id="1192476">(</span><span class="string" id="1192477">&#34;timeout&nbsp;reading&nbsp;from&nbsp;unix&nbsp;socket&#34;</span><span class="op" id="1192511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192515">uc</span><span class="op" id="1192517">.</span><span class="ident" id="1192518">Close</span><span class="op" id="1192523">(</span><span class="op" id="1192524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192527">}</span><span class="op" id="1192528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192531">_</span><span class="op" id="1192532">,</span>&nbsp;<span class="ident" id="1192534">oobn</span><span class="op" id="1192538">,</span>&nbsp;<span class="ident" id="1192540">_</span><span class="op" id="1192541">,</span>&nbsp;<span class="ident" id="1192543">_</span><span class="op" id="1192544">,</span>&nbsp;<span class="ident" id="1192546">err</span>&nbsp;<span class="op" id="1192550">:=</span>&nbsp;<span class="ident" id="1192553">uc</span><span class="op" id="1192555">.</span><span class="ident" id="1192556">ReadMsgUnix</span><span class="op" id="1192567">(</span><span class="ident" id="1192568">buf</span><span class="op" id="1192571">,</span>&nbsp;<span class="ident" id="1192573">oob</span><span class="op" id="1192576">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192579">closeUnix</span><span class="op" id="1192588">.</span><span class="ident" id="1192589">Stop</span><span class="op" id="1192593">(</span><span class="op" id="1192594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192598">scms</span><span class="op" id="1192602">,</span>&nbsp;<span class="ident" id="1192604">err</span>&nbsp;<span class="op" id="1192608">:=</span>&nbsp;<span class="ident" id="1192611">syscall</span><span class="op" id="1192618">.</span><span class="ident" id="1192619">ParseSocketControlMessage</span><span class="op" id="1192644">(</span><span class="ident" id="1192645">oob</span><span class="op" id="1192648">[</span><span class="op" id="1192649">:</span><span class="ident" id="1192650">oobn</span><span class="op" id="1192654">]</span><span class="op" id="1192655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192658">if</span>&nbsp;<span class="ident" id="1192661">err</span>&nbsp;<span class="op" id="1192665">!=</span>&nbsp;<span class="ident" id="1192668">nil</span>&nbsp;<span class="op" id="1192672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192676">t</span><span class="op" id="1192677">.</span><span class="ident" id="1192678">Fatalf</span><span class="op" id="1192684">(</span><span class="string" id="1192685">&#34;ParseSocketControlMessage:&nbsp;%v&#34;</span><span class="op" id="1192716">,</span>&nbsp;<span class="ident" id="1192718">err</span><span class="op" id="1192721">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192727">if</span>&nbsp;<span class="builtinfunc" id="1192730">len</span><span class="op" id="1192733">(</span><span class="ident" id="1192734">scms</span><span class="op" id="1192738">)</span>&nbsp;<span class="op" id="1192740">!=</span>&nbsp;<span class="num" id="1192743">1</span>&nbsp;<span class="op" id="1192745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192749">t</span><span class="op" id="1192750">.</span><span class="ident" id="1192751">Fatalf</span><span class="op" id="1192757">(</span><span class="string" id="1192758">&#34;expected&nbsp;1&nbsp;SocketControlMessage;&nbsp;got&nbsp;scms&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="1192807">,</span>&nbsp;<span class="ident" id="1192809">scms</span><span class="op" id="1192813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192819">scm</span>&nbsp;<span class="op" id="1192823">:=</span>&nbsp;<span class="ident" id="1192826">scms</span><span class="op" id="1192830">[</span><span class="num" id="1192831">0</span><span class="op" id="1192832">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192835">gotFds</span><span class="op" id="1192841">,</span>&nbsp;<span class="ident" id="1192843">err</span>&nbsp;<span class="op" id="1192847">:=</span>&nbsp;<span class="ident" id="1192850">syscall</span><span class="op" id="1192857">.</span><span class="ident" id="1192858">ParseUnixRights</span><span class="op" id="1192873">(</span><span class="op" id="1192874">&amp;</span><span class="ident" id="1192875">scm</span><span class="op" id="1192878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192881">if</span>&nbsp;<span class="ident" id="1192884">err</span>&nbsp;<span class="op" id="1192888">!=</span>&nbsp;<span class="ident" id="1192891">nil</span>&nbsp;<span class="op" id="1192895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192899">t</span><span class="op" id="1192900">.</span><span class="ident" id="1192901">Fatalf</span><span class="op" id="1192907">(</span><span class="string" id="1192908">&#34;syscall.ParseUnixRights:&nbsp;%v&#34;</span><span class="op" id="1192937">,</span>&nbsp;<span class="ident" id="1192939">err</span><span class="op" id="1192942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1192945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1192948">if</span>&nbsp;<span class="builtinfunc" id="1192951">len</span><span class="op" id="1192954">(</span><span class="ident" id="1192955">gotFds</span><span class="op" id="1192961">)</span>&nbsp;<span class="op" id="1192963">!=</span>&nbsp;<span class="num" id="1192966">1</span>&nbsp;<span class="op" id="1192968">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1192972">t</span><span class="op" id="1192973">.</span><span class="ident" id="1192974">Fatalf</span><span class="op" id="1192980">(</span><span class="string" id="1192981">&#34;wanted&nbsp;1&nbsp;fd;&nbsp;got&nbsp;%#v&#34;</span><span class="op" id="1193003">,</span>&nbsp;<span class="ident" id="1193005">gotFds</span><span class="op" id="1193011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1193014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193018">f</span>&nbsp;<span class="op" id="1193020">:=</span>&nbsp;<span class="ident" id="1193023">os</span><span class="op" id="1193025">.</span><span class="ident" id="1193026">NewFile</span><span class="op" id="1193033">(</span><span class="builtintype" id="1193034">uintptr</span><span class="op" id="1193041">(</span><span class="ident" id="1193042">gotFds</span><span class="op" id="1193048">[</span><span class="num" id="1193049">0</span><span class="op" id="1193050">]</span><span class="op" id="1193051">)</span><span class="op" id="1193052">,</span>&nbsp;<span class="string" id="1193054">&#34;fd-from-child&#34;</span><span class="op" id="1193069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193072">defer</span>&nbsp;<span class="ident" id="1193078">f</span><span class="op" id="1193079">.</span><span class="ident" id="1193080">Close</span><span class="op" id="1193085">(</span><span class="op" id="1193086">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193090">got</span><span class="op" id="1193093">,</span>&nbsp;<span class="ident" id="1193095">err</span>&nbsp;<span class="op" id="1193099">:=</span>&nbsp;<span class="ident" id="1193102">ioutil</span><span class="op" id="1193108">.</span><span class="ident" id="1193109">ReadAll</span><span class="op" id="1193116">(</span><span class="ident" id="1193117">f</span><span class="op" id="1193118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193121">want</span>&nbsp;<span class="op" id="1193126">:=</span>&nbsp;<span class="string" id="1193129">&#34;Hello&nbsp;from&nbsp;child&nbsp;process!\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193160">if</span>&nbsp;<span class="builtintype" id="1193163">string</span><span class="op" id="1193169">(</span><span class="ident" id="1193170">got</span><span class="op" id="1193173">)</span>&nbsp;<span class="op" id="1193175">!=</span>&nbsp;<span class="ident" id="1193178">want</span>&nbsp;<span class="op" id="1193183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193187">t</span><span class="op" id="1193188">.</span><span class="ident" id="1193189">Errorf</span><span class="op" id="1193195">(</span><span class="string" id="1193196">&#34;child&nbsp;process&nbsp;ReadAll:&nbsp;%q,&nbsp;%v;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="1193236">,</span>&nbsp;<span class="ident" id="1193238">got</span><span class="op" id="1193241">,</span>&nbsp;<span class="ident" id="1193243">err</span><span class="op" id="1193246">,</span>&nbsp;<span class="ident" id="1193248">want</span><span class="op" id="1193252">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1193255">}</span><br>
<span class="lineno"></span><span class="op" id="1193257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1193260">//&nbsp;passFDChild&nbsp;is&nbsp;the&nbsp;child&nbsp;process&nbsp;used&nbsp;by&nbsp;TestPassFD.</span><br>
<span class="lineno"></span><span class="keyword" id="1193316">func</span>&nbsp;<span class="ident" id="1193321">passFDChild</span><span class="op" id="1193332">(</span><span class="op" id="1193333">)</span>&nbsp;<span class="op" id="1193335">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193338">defer</span>&nbsp;<span class="ident" id="1193344">os</span><span class="op" id="1193346">.</span><span class="ident" id="1193347">Exit</span><span class="op" id="1193351">(</span><span class="num" id="1193352">0</span><span class="op" id="1193353">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1193357">//&nbsp;Look&nbsp;for&nbsp;our&nbsp;fd.&nbsp;It&nbsp;should&nbsp;be&nbsp;fd&nbsp;3,&nbsp;but&nbsp;we&nbsp;work&nbsp;around&nbsp;an&nbsp;fd&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1193427">//&nbsp;bug&nbsp;here&nbsp;(http://golang.org/issue/2603)&nbsp;to&nbsp;let&nbsp;it&nbsp;be&nbsp;elsewhere.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193495">var</span>&nbsp;<span class="ident" id="1193499">uc</span>&nbsp;<span class="op" id="1193502">*</span><span class="ident" id="1193503">net</span><span class="op" id="1193506">.</span><span class="ident" id="1193507">UnixConn</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193517">for</span>&nbsp;<span class="ident" id="1193521">fd</span>&nbsp;<span class="op" id="1193524">:=</span>&nbsp;<span class="builtintype" id="1193527">uintptr</span><span class="op" id="1193534">(</span><span class="num" id="1193535">3</span><span class="op" id="1193536">)</span><span class="op" id="1193537">;</span>&nbsp;<span class="ident" id="1193539">fd</span>&nbsp;<span class="op" id="1193542">&lt;=</span>&nbsp;<span class="num" id="1193545">10</span><span class="op" id="1193547">;</span>&nbsp;<span class="ident" id="1193549">fd</span><span class="op" id="1193551">++</span>&nbsp;<span class="op" id="1193554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193558">f</span>&nbsp;<span class="op" id="1193560">:=</span>&nbsp;<span class="ident" id="1193563">os</span><span class="op" id="1193565">.</span><span class="ident" id="1193566">NewFile</span><span class="op" id="1193573">(</span><span class="ident" id="1193574">fd</span><span class="op" id="1193576">,</span>&nbsp;<span class="string" id="1193578">&#34;unix-conn&#34;</span><span class="op" id="1193589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193593">var</span>&nbsp;<span class="ident" id="1193597">ok</span>&nbsp;<span class="builtintype" id="1193600">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193607">netc</span><span class="op" id="1193611">,</span>&nbsp;<span class="ident" id="1193613">_</span>&nbsp;<span class="op" id="1193615">:=</span>&nbsp;<span class="ident" id="1193618">net</span><span class="op" id="1193621">.</span><span class="ident" id="1193622">FileConn</span><span class="op" id="1193630">(</span><span class="ident" id="1193631">f</span><span class="op" id="1193632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193636">uc</span><span class="op" id="1193638">,</span>&nbsp;<span class="ident" id="1193640">ok</span>&nbsp;<span class="op" id="1193643">=</span>&nbsp;<span class="ident" id="1193645">netc</span><span class="op" id="1193649">.</span><span class="op" id="1193650">(</span><span class="op" id="1193651">*</span><span class="ident" id="1193652">net</span><span class="op" id="1193655">.</span><span class="ident" id="1193656">UnixConn</span><span class="op" id="1193664">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193668">if</span>&nbsp;<span class="ident" id="1193671">ok</span>&nbsp;<span class="op" id="1193674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193679">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1193687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1193690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193693">if</span>&nbsp;<span class="ident" id="1193696">uc</span>&nbsp;<span class="op" id="1193699">==</span>&nbsp;<span class="ident" id="1193702">nil</span>&nbsp;<span class="op" id="1193706">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193710">fmt</span><span class="op" id="1193713">.</span><span class="ident" id="1193714">Println</span><span class="op" id="1193721">(</span><span class="string" id="1193722">&#34;failed&nbsp;to&nbsp;find&nbsp;unix&nbsp;fd&#34;</span><span class="op" id="1193746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193750">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1193758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1193762">//&nbsp;Make&nbsp;a&nbsp;file&nbsp;f&nbsp;to&nbsp;send&nbsp;to&nbsp;our&nbsp;parent&nbsp;process&nbsp;on&nbsp;uc.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1193817">//&nbsp;We&nbsp;make&nbsp;it&nbsp;in&nbsp;tempDir,&nbsp;which&nbsp;our&nbsp;parent&nbsp;will&nbsp;clean&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193876">flag</span><span class="op" id="1193880">.</span><span class="ident" id="1193881">Parse</span><span class="op" id="1193886">(</span><span class="op" id="1193887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193890">tempDir</span>&nbsp;<span class="op" id="1193898">:=</span>&nbsp;<span class="ident" id="1193901">flag</span><span class="op" id="1193905">.</span><span class="ident" id="1193906">Arg</span><span class="op" id="1193909">(</span><span class="num" id="1193910">0</span><span class="op" id="1193911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193914">f</span><span class="op" id="1193915">,</span>&nbsp;<span class="ident" id="1193917">err</span>&nbsp;<span class="op" id="1193921">:=</span>&nbsp;<span class="ident" id="1193924">ioutil</span><span class="op" id="1193930">.</span><span class="ident" id="1193931">TempFile</span><span class="op" id="1193939">(</span><span class="ident" id="1193940">tempDir</span><span class="op" id="1193947">,</span>&nbsp;<span class="string" id="1193949">&#34;&#34;</span><span class="op" id="1193951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1193954">if</span>&nbsp;<span class="ident" id="1193957">err</span>&nbsp;<span class="op" id="1193961">!=</span>&nbsp;<span class="ident" id="1193964">nil</span>&nbsp;<span class="op" id="1193968">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1193972">fmt</span><span class="op" id="1193975">.</span><span class="ident" id="1193976">Printf</span><span class="op" id="1193982">(</span><span class="string" id="1193983">&#34;TempFile:&nbsp;%v&#34;</span><span class="op" id="1193997">,</span>&nbsp;<span class="ident" id="1193999">err</span><span class="op" id="1194002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194006">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194018">f</span><span class="op" id="1194019">.</span><span class="ident" id="1194020">Write</span><span class="op" id="1194025">(</span><span class="op" id="1194026">[</span><span class="op" id="1194027">]</span><span class="builtintype" id="1194028">byte</span><span class="op" id="1194032">(</span><span class="string" id="1194033">&#34;Hello&nbsp;from&nbsp;child&nbsp;process!\n&#34;</span><span class="op" id="1194062">)</span><span class="op" id="1194063">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194066">f</span><span class="op" id="1194067">.</span><span class="ident" id="1194068">Seek</span><span class="op" id="1194072">(</span><span class="num" id="1194073">0</span><span class="op" id="1194074">,</span>&nbsp;<span class="num" id="1194076">0</span><span class="op" id="1194077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194081">rights</span>&nbsp;<span class="op" id="1194088">:=</span>&nbsp;<span class="ident" id="1194091">syscall</span><span class="op" id="1194098">.</span><span class="ident" id="1194099">UnixRights</span><span class="op" id="1194109">(</span><span class="builtintype" id="1194110">int</span><span class="op" id="1194113">(</span><span class="ident" id="1194114">f</span><span class="op" id="1194115">.</span><span class="ident" id="1194116">Fd</span><span class="op" id="1194118">(</span><span class="op" id="1194119">)</span><span class="op" id="1194120">)</span><span class="op" id="1194121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194124">dummyByte</span>&nbsp;<span class="op" id="1194134">:=</span>&nbsp;<span class="op" id="1194137">[</span><span class="op" id="1194138">]</span><span class="builtintype" id="1194139">byte</span><span class="op" id="1194143">(</span><span class="string" id="1194144">&#34;x&#34;</span><span class="op" id="1194147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194150">n</span><span class="op" id="1194151">,</span>&nbsp;<span class="ident" id="1194153">oobn</span><span class="op" id="1194157">,</span>&nbsp;<span class="ident" id="1194159">err</span>&nbsp;<span class="op" id="1194163">:=</span>&nbsp;<span class="ident" id="1194166">uc</span><span class="op" id="1194168">.</span><span class="ident" id="1194169">WriteMsgUnix</span><span class="op" id="1194181">(</span><span class="ident" id="1194182">dummyByte</span><span class="op" id="1194191">,</span>&nbsp;<span class="ident" id="1194193">rights</span><span class="op" id="1194199">,</span>&nbsp;<span class="ident" id="1194201">nil</span><span class="op" id="1194204">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194207">if</span>&nbsp;<span class="ident" id="1194210">err</span>&nbsp;<span class="op" id="1194214">!=</span>&nbsp;<span class="ident" id="1194217">nil</span>&nbsp;<span class="op" id="1194221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194225">fmt</span><span class="op" id="1194228">.</span><span class="ident" id="1194229">Printf</span><span class="op" id="1194235">(</span><span class="string" id="1194236">&#34;WriteMsgUnix:&nbsp;%v&#34;</span><span class="op" id="1194254">,</span>&nbsp;<span class="ident" id="1194256">err</span><span class="op" id="1194259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194263">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194274">if</span>&nbsp;<span class="ident" id="1194277">n</span>&nbsp;<span class="op" id="1194279">!=</span>&nbsp;<span class="num" id="1194282">1</span>&nbsp;<span class="op" id="1194284">||</span>&nbsp;<span class="ident" id="1194287">oobn</span>&nbsp;<span class="op" id="1194292">!=</span>&nbsp;<span class="builtinfunc" id="1194295">len</span><span class="op" id="1194298">(</span><span class="ident" id="1194299">rights</span><span class="op" id="1194305">)</span>&nbsp;<span class="op" id="1194307">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194311">fmt</span><span class="op" id="1194314">.</span><span class="ident" id="1194315">Printf</span><span class="op" id="1194321">(</span><span class="string" id="1194322">&#34;WriteMsgUnix&nbsp;=&nbsp;%d,&nbsp;%d;&nbsp;want&nbsp;1,&nbsp;%d&#34;</span><span class="op" id="1194357">,</span>&nbsp;<span class="ident" id="1194359">n</span><span class="op" id="1194360">,</span>&nbsp;<span class="ident" id="1194362">oobn</span><span class="op" id="1194366">,</span>&nbsp;<span class="builtinfunc" id="1194368">len</span><span class="op" id="1194371">(</span><span class="ident" id="1194372">rights</span><span class="op" id="1194378">)</span><span class="op" id="1194379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194383">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194391">}</span><br>
<span class="lineno"></span><span class="op" id="1194393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment" id="1194396">//&nbsp;TestUnixRightsRoundtrip&nbsp;tests&nbsp;that&nbsp;UnixRights,&nbsp;ParseSocketControlMessage,</span><br>
<span class="lineno"></span><span class="comment" id="1194473">//&nbsp;and&nbsp;ParseUnixRights&nbsp;are&nbsp;able&nbsp;to&nbsp;successfully&nbsp;round-trip&nbsp;lists&nbsp;of&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="1194559">func</span>&nbsp;<span class="ident" id="1194564">TestUnixRightsRoundtrip</span><span class="op" id="1194587">(</span><span class="ident" id="1194588">t</span>&nbsp;<span class="op" id="1194590">*</span><span class="ident" id="1194591">testing</span><span class="op" id="1194598">.</span><span class="ident" id="1194599">T</span><span class="op" id="1194600">)</span>&nbsp;<span class="op" id="1194602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194605">testCases</span>&nbsp;<span class="op" id="1194615">:=</span>&nbsp;<span class="op" id="1194618">[</span><span class="op" id="1194619">...</span><span class="op" id="1194622">]</span><span class="op" id="1194623">[</span><span class="op" id="1194624">]</span><span class="op" id="1194625">[</span><span class="op" id="1194626">]</span><span class="builtintype" id="1194627">int</span><span class="op" id="1194630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194634">{</span><span class="op" id="1194635">{</span><span class="num" id="1194636">42</span><span class="op" id="1194638">}</span><span class="op" id="1194639">}</span><span class="op" id="1194640">,</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194644">{</span><span class="op" id="1194645">{</span><span class="num" id="1194646">1</span><span class="op" id="1194647">,</span>&nbsp;<span class="num" id="1194649">2</span><span class="op" id="1194650">}</span><span class="op" id="1194651">}</span><span class="op" id="1194652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194656">{</span><span class="op" id="1194657">{</span><span class="num" id="1194658">3</span><span class="op" id="1194659">,</span>&nbsp;<span class="num" id="1194661">4</span><span class="op" id="1194662">,</span>&nbsp;<span class="num" id="1194664">5</span><span class="op" id="1194665">}</span><span class="op" id="1194666">}</span><span class="op" id="1194667">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194671">{</span><span class="op" id="1194672">{</span><span class="op" id="1194673">}</span><span class="op" id="1194674">}</span><span class="op" id="1194675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194679">{</span><span class="op" id="1194680">{</span><span class="num" id="1194681">1</span><span class="op" id="1194682">,</span>&nbsp;<span class="num" id="1194684">2</span><span class="op" id="1194685">}</span><span class="op" id="1194686">,</span>&nbsp;<span class="op" id="1194688">{</span><span class="num" id="1194689">3</span><span class="op" id="1194690">,</span>&nbsp;<span class="num" id="1194692">4</span><span class="op" id="1194693">,</span>&nbsp;<span class="num" id="1194695">5</span><span class="op" id="1194696">}</span><span class="op" id="1194697">,</span>&nbsp;<span class="op" id="1194699">{</span><span class="op" id="1194700">}</span><span class="op" id="1194701">,</span>&nbsp;<span class="op" id="1194703">{</span><span class="num" id="1194704">7</span><span class="op" id="1194705">}</span><span class="op" id="1194706">}</span><span class="op" id="1194707">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194710">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194713">for</span>&nbsp;<span class="ident" id="1194717">_</span><span class="op" id="1194718">,</span>&nbsp;<span class="ident" id="1194720">testCase</span>&nbsp;<span class="op" id="1194729">:=</span>&nbsp;<span class="keyword" id="1194732">range</span>&nbsp;<span class="ident" id="1194738">testCases</span>&nbsp;<span class="op" id="1194748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194752">b</span>&nbsp;<span class="op" id="1194754">:=</span>&nbsp;<span class="op" id="1194757">[</span><span class="op" id="1194758">]</span><span class="builtintype" id="1194759">byte</span><span class="op" id="1194763">{</span><span class="op" id="1194764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194768">var</span>&nbsp;<span class="ident" id="1194772">n</span>&nbsp;<span class="builtintype" id="1194774">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1194780">for</span>&nbsp;<span class="ident" id="1194784">_</span><span class="op" id="1194785">,</span>&nbsp;<span class="ident" id="1194787">fds</span>&nbsp;<span class="op" id="1194791">:=</span>&nbsp;<span class="keyword" id="1194794">range</span>&nbsp;<span class="ident" id="1194800">testCase</span>&nbsp;<span class="op" id="1194809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1194814">//&nbsp;Last&nbsp;assignment&nbsp;to&nbsp;n&nbsp;wins</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194846">n</span>&nbsp;<span class="op" id="1194848">=</span>&nbsp;<span class="builtinfunc" id="1194850">len</span><span class="op" id="1194853">(</span><span class="ident" id="1194854">b</span><span class="op" id="1194855">)</span>&nbsp;<span class="op" id="1194857">+</span>&nbsp;<span class="ident" id="1194859">syscall</span><span class="op" id="1194866">.</span><span class="ident" id="1194867">CmsgLen</span><span class="op" id="1194874">(</span><span class="num" id="1194875">4</span><span class="op" id="1194876">*</span><span class="builtinfunc" id="1194877">len</span><span class="op" id="1194880">(</span><span class="ident" id="1194881">fds</span><span class="op" id="1194884">)</span><span class="op" id="1194885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194890">b</span>&nbsp;<span class="op" id="1194892">=</span>&nbsp;<span class="builtinfunc" id="1194894">append</span><span class="op" id="1194900">(</span><span class="ident" id="1194901">b</span><span class="op" id="1194902">,</span>&nbsp;<span class="ident" id="1194904">syscall</span><span class="op" id="1194911">.</span><span class="ident" id="1194912">UnixRights</span><span class="op" id="1194922">(</span><span class="ident" id="1194923">fds</span><span class="op" id="1194926">...</span><span class="op" id="1194929">)</span><span class="op" id="1194930">...</span><span class="op" id="1194933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1194937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1194941">//&nbsp;Truncate&nbsp;b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194957">b</span>&nbsp;<span class="op" id="1194959">=</span>&nbsp;<span class="ident" id="1194961">b</span><span class="op" id="1194962">[</span><span class="op" id="1194963">:</span><span class="ident" id="1194964">n</span><span class="op" id="1194965">]</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1194970">scms</span><span class="op" id="1194974">,</span>&nbsp;<span class="ident" id="1194976">err</span>&nbsp;<span class="op" id="1194980">:=</span>&nbsp;<span class="ident" id="1194983">syscall</span><span class="op" id="1194990">.</span><span class="ident" id="1194991">ParseSocketControlMessage</span><span class="op" id="1195016">(</span><span class="ident" id="1195017">b</span><span class="op" id="1195018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195022">if</span>&nbsp;<span class="ident" id="1195025">err</span>&nbsp;<span class="op" id="1195029">!=</span>&nbsp;<span class="ident" id="1195032">nil</span>&nbsp;<span class="op" id="1195036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195041">t</span><span class="op" id="1195042">.</span><span class="ident" id="1195043">Fatalf</span><span class="op" id="1195049">(</span><span class="string" id="1195050">&#34;ParseSocketControlMessage:&nbsp;%v&#34;</span><span class="op" id="1195081">,</span>&nbsp;<span class="ident" id="1195083">err</span><span class="op" id="1195086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195090">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195094">if</span>&nbsp;<span class="builtinfunc" id="1195097">len</span><span class="op" id="1195100">(</span><span class="ident" id="1195101">scms</span><span class="op" id="1195105">)</span>&nbsp;<span class="op" id="1195107">!=</span>&nbsp;<span class="builtinfunc" id="1195110">len</span><span class="op" id="1195113">(</span><span class="ident" id="1195114">testCase</span><span class="op" id="1195122">)</span>&nbsp;<span class="op" id="1195124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195129">t</span><span class="op" id="1195130">.</span><span class="ident" id="1195131">Fatalf</span><span class="op" id="1195137">(</span><span class="string" id="1195138">&#34;expected&nbsp;%v&nbsp;SocketControlMessage;&nbsp;got&nbsp;scms&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="1195188">,</span>&nbsp;<span class="builtinfunc" id="1195190">len</span><span class="op" id="1195193">(</span><span class="ident" id="1195194">testCase</span><span class="op" id="1195202">)</span><span class="op" id="1195203">,</span>&nbsp;<span class="ident" id="1195205">scms</span><span class="op" id="1195209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195217">for</span>&nbsp;<span class="ident" id="1195221">i</span><span class="op" id="1195222">,</span>&nbsp;<span class="ident" id="1195224">scm</span>&nbsp;<span class="op" id="1195228">:=</span>&nbsp;<span class="keyword" id="1195231">range</span>&nbsp;<span class="ident" id="1195237">scms</span>&nbsp;<span class="op" id="1195242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195247">gotFds</span><span class="op" id="1195253">,</span>&nbsp;<span class="ident" id="1195255">err</span>&nbsp;<span class="op" id="1195259">:=</span>&nbsp;<span class="ident" id="1195262">syscall</span><span class="op" id="1195269">.</span><span class="ident" id="1195270">ParseUnixRights</span><span class="op" id="1195285">(</span><span class="op" id="1195286">&amp;</span><span class="ident" id="1195287">scm</span><span class="op" id="1195290">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195295">if</span>&nbsp;<span class="ident" id="1195298">err</span>&nbsp;<span class="op" id="1195302">!=</span>&nbsp;<span class="ident" id="1195305">nil</span>&nbsp;<span class="op" id="1195309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195315">t</span><span class="op" id="1195316">.</span><span class="ident" id="1195317">Fatalf</span><span class="op" id="1195323">(</span><span class="string" id="1195324">&#34;ParseUnixRights:&nbsp;%v&#34;</span><span class="op" id="1195345">,</span>&nbsp;<span class="ident" id="1195347">err</span><span class="op" id="1195350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195360">wantFds</span>&nbsp;<span class="op" id="1195368">:=</span>&nbsp;<span class="ident" id="1195371">testCase</span><span class="op" id="1195379">[</span><span class="ident" id="1195380">i</span><span class="op" id="1195381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195386">if</span>&nbsp;<span class="builtinfunc" id="1195389">len</span><span class="op" id="1195392">(</span><span class="ident" id="1195393">gotFds</span><span class="op" id="1195399">)</span>&nbsp;<span class="op" id="1195401">!=</span>&nbsp;<span class="builtinfunc" id="1195404">len</span><span class="op" id="1195407">(</span><span class="ident" id="1195408">wantFds</span><span class="op" id="1195415">)</span>&nbsp;<span class="op" id="1195417">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195423">t</span><span class="op" id="1195424">.</span><span class="ident" id="1195425">Fatalf</span><span class="op" id="1195431">(</span><span class="string" id="1195432">&#34;expected&nbsp;%v&nbsp;fds,&nbsp;got&nbsp;%#v&#34;</span><span class="op" id="1195458">,</span>&nbsp;<span class="builtinfunc" id="1195460">len</span><span class="op" id="1195463">(</span><span class="ident" id="1195464">wantFds</span><span class="op" id="1195471">)</span><span class="op" id="1195472">,</span>&nbsp;<span class="ident" id="1195474">gotFds</span><span class="op" id="1195480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195490">for</span>&nbsp;<span class="ident" id="1195494">j</span><span class="op" id="1195495">,</span>&nbsp;<span class="ident" id="1195497">fd</span>&nbsp;<span class="op" id="1195500">:=</span>&nbsp;<span class="keyword" id="1195503">range</span>&nbsp;<span class="ident" id="1195509">gotFds</span>&nbsp;<span class="op" id="1195516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195522">if</span>&nbsp;<span class="ident" id="1195525">fd</span>&nbsp;<span class="op" id="1195528">!=</span>&nbsp;<span class="ident" id="1195531">wantFds</span><span class="op" id="1195538">[</span><span class="ident" id="1195539">j</span><span class="op" id="1195540">]</span>&nbsp;<span class="op" id="1195542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195549">t</span><span class="op" id="1195550">.</span><span class="ident" id="1195551">Fatalf</span><span class="op" id="1195557">(</span><span class="string" id="1195558">&#34;expected&nbsp;fd&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="1195582">,</span>&nbsp;<span class="ident" id="1195584">wantFds</span><span class="op" id="1195591">[</span><span class="ident" id="1195592">j</span><span class="op" id="1195593">]</span><span class="op" id="1195594">,</span>&nbsp;<span class="ident" id="1195596">fd</span><span class="op" id="1195598">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195616">}</span><br>
<span class="lineno"></span><span class="op" id="1195618">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1195621">func</span>&nbsp;<span class="ident" id="1195626">TestRlimit</span><span class="op" id="1195636">(</span><span class="ident" id="1195637">t</span>&nbsp;<span class="op" id="1195639">*</span><span class="ident" id="1195640">testing</span><span class="op" id="1195647">.</span><span class="ident" id="1195648">T</span><span class="op" id="1195649">)</span>&nbsp;<span class="op" id="1195651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195654">var</span>&nbsp;<span class="ident" id="1195658">rlimit</span><span class="op" id="1195664">,</span>&nbsp;<span class="ident" id="1195666">zero</span>&nbsp;<span class="ident" id="1195671">syscall</span><span class="op" id="1195678">.</span><span class="ident" id="1195679">Rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195687">err</span>&nbsp;<span class="op" id="1195691">:=</span>&nbsp;<span class="ident" id="1195694">syscall</span><span class="op" id="1195701">.</span><span class="ident" id="1195702">Getrlimit</span><span class="op" id="1195711">(</span><span class="ident" id="1195712">syscall</span><span class="op" id="1195719">.</span><span class="ident" id="1195720">RLIMIT_NOFILE</span><span class="op" id="1195733">,</span>&nbsp;<span class="op" id="1195735">&amp;</span><span class="ident" id="1195736">rlimit</span><span class="op" id="1195742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195745">if</span>&nbsp;<span class="ident" id="1195748">err</span>&nbsp;<span class="op" id="1195752">!=</span>&nbsp;<span class="ident" id="1195755">nil</span>&nbsp;<span class="op" id="1195759">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195763">t</span><span class="op" id="1195764">.</span><span class="ident" id="1195765">Fatalf</span><span class="op" id="1195771">(</span><span class="string" id="1195772">&#34;Getrlimit:&nbsp;save&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="1195800">,</span>&nbsp;<span class="ident" id="1195802">err</span><span class="op" id="1195805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195811">if</span>&nbsp;<span class="ident" id="1195814">zero</span>&nbsp;<span class="op" id="1195819">==</span>&nbsp;<span class="ident" id="1195822">rlimit</span>&nbsp;<span class="op" id="1195829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195833">t</span><span class="op" id="1195834">.</span><span class="ident" id="1195835">Fatalf</span><span class="op" id="1195841">(</span><span class="string" id="1195842">&#34;Getrlimit:&nbsp;save&nbsp;failed:&nbsp;got&nbsp;zero&nbsp;value&nbsp;%#v&#34;</span><span class="op" id="1195886">,</span>&nbsp;<span class="ident" id="1195888">rlimit</span><span class="op" id="1195894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1195897">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195900">set</span>&nbsp;<span class="op" id="1195904">:=</span>&nbsp;<span class="ident" id="1195907">rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195915">set</span><span class="op" id="1195918">.</span><span class="ident" id="1195919">Cur</span>&nbsp;<span class="op" id="1195923">=</span>&nbsp;<span class="ident" id="1195925">set</span><span class="op" id="1195928">.</span><span class="ident" id="1195929">Max</span>&nbsp;<span class="op" id="1195933">-</span>&nbsp;<span class="num" id="1195935">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1195938">err</span>&nbsp;<span class="op" id="1195942">=</span>&nbsp;<span class="ident" id="1195944">syscall</span><span class="op" id="1195951">.</span><span class="ident" id="1195952">Setrlimit</span><span class="op" id="1195961">(</span><span class="ident" id="1195962">syscall</span><span class="op" id="1195969">.</span><span class="ident" id="1195970">RLIMIT_NOFILE</span><span class="op" id="1195983">,</span>&nbsp;<span class="op" id="1195985">&amp;</span><span class="ident" id="1195986">set</span><span class="op" id="1195989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1195992">if</span>&nbsp;<span class="ident" id="1195995">err</span>&nbsp;<span class="op" id="1195999">!=</span>&nbsp;<span class="ident" id="1196002">nil</span>&nbsp;<span class="op" id="1196006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196010">t</span><span class="op" id="1196011">.</span><span class="ident" id="1196012">Fatalf</span><span class="op" id="1196018">(</span><span class="string" id="1196019">&#34;Setrlimit:&nbsp;set&nbsp;failed:&nbsp;%#v&nbsp;%v&#34;</span><span class="op" id="1196050">,</span>&nbsp;<span class="ident" id="1196052">set</span><span class="op" id="1196055">,</span>&nbsp;<span class="ident" id="1196057">err</span><span class="op" id="1196060">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196066">var</span>&nbsp;<span class="ident" id="1196070">get</span>&nbsp;<span class="ident" id="1196074">syscall</span><span class="op" id="1196081">.</span><span class="ident" id="1196082">Rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196090">err</span>&nbsp;<span class="op" id="1196094">=</span>&nbsp;<span class="ident" id="1196096">syscall</span><span class="op" id="1196103">.</span><span class="ident" id="1196104">Getrlimit</span><span class="op" id="1196113">(</span><span class="ident" id="1196114">syscall</span><span class="op" id="1196121">.</span><span class="ident" id="1196122">RLIMIT_NOFILE</span><span class="op" id="1196135">,</span>&nbsp;<span class="op" id="1196137">&amp;</span><span class="ident" id="1196138">get</span><span class="op" id="1196141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196144">if</span>&nbsp;<span class="ident" id="1196147">err</span>&nbsp;<span class="op" id="1196151">!=</span>&nbsp;<span class="ident" id="1196154">nil</span>&nbsp;<span class="op" id="1196158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196162">t</span><span class="op" id="1196163">.</span><span class="ident" id="1196164">Fatalf</span><span class="op" id="1196170">(</span><span class="string" id="1196171">&#34;Getrlimit:&nbsp;get&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="1196198">,</span>&nbsp;<span class="ident" id="1196200">err</span><span class="op" id="1196203">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196209">set</span>&nbsp;<span class="op" id="1196213">=</span>&nbsp;<span class="ident" id="1196215">rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196223">set</span><span class="op" id="1196226">.</span><span class="ident" id="1196227">Cur</span>&nbsp;<span class="op" id="1196231">=</span>&nbsp;<span class="ident" id="1196233">set</span><span class="op" id="1196236">.</span><span class="ident" id="1196237">Max</span>&nbsp;<span class="op" id="1196241">-</span>&nbsp;<span class="num" id="1196243">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196246">if</span>&nbsp;<span class="ident" id="1196249">set</span>&nbsp;<span class="op" id="1196253">!=</span>&nbsp;<span class="ident" id="1196256">get</span>&nbsp;<span class="op" id="1196260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1196264">//&nbsp;Seems&nbsp;like&nbsp;Darwin&nbsp;requires&nbsp;some&nbsp;privilege&nbsp;to</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1196314">//&nbsp;increase&nbsp;the&nbsp;soft&nbsp;limit&nbsp;of&nbsp;rlimit&nbsp;sandbox,&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1196369">//&nbsp;Setrlimit&nbsp;never&nbsp;reports&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196408">switch</span>&nbsp;<span class="ident" id="1196415">runtime</span><span class="op" id="1196422">.</span><span class="ident" id="1196423">GOOS</span>&nbsp;<span class="op" id="1196428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196432">case</span>&nbsp;<span class="string" id="1196437">&#34;darwin&#34;</span><span class="op" id="1196445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196449">default</span><span class="op" id="1196456">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196461">t</span><span class="op" id="1196462">.</span><span class="ident" id="1196463">Fatalf</span><span class="op" id="1196469">(</span><span class="string" id="1196470">&#34;Rlimit:&nbsp;change&nbsp;failed:&nbsp;wanted&nbsp;%#v&nbsp;got&nbsp;%#v&#34;</span><span class="op" id="1196513">,</span>&nbsp;<span class="ident" id="1196515">set</span><span class="op" id="1196518">,</span>&nbsp;<span class="ident" id="1196520">get</span><span class="op" id="1196523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196533">err</span>&nbsp;<span class="op" id="1196537">=</span>&nbsp;<span class="ident" id="1196539">syscall</span><span class="op" id="1196546">.</span><span class="ident" id="1196547">Setrlimit</span><span class="op" id="1196556">(</span><span class="ident" id="1196557">syscall</span><span class="op" id="1196564">.</span><span class="ident" id="1196565">RLIMIT_NOFILE</span><span class="op" id="1196578">,</span>&nbsp;<span class="op" id="1196580">&amp;</span><span class="ident" id="1196581">rlimit</span><span class="op" id="1196587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196590">if</span>&nbsp;<span class="ident" id="1196593">err</span>&nbsp;<span class="op" id="1196597">!=</span>&nbsp;<span class="ident" id="1196600">nil</span>&nbsp;<span class="op" id="1196604">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196608">t</span><span class="op" id="1196609">.</span><span class="ident" id="1196610">Fatalf</span><span class="op" id="1196616">(</span><span class="string" id="1196617">&#34;Setrlimit:&nbsp;restore&nbsp;failed:&nbsp;%#v&nbsp;%v&#34;</span><span class="op" id="1196652">,</span>&nbsp;<span class="ident" id="1196654">rlimit</span><span class="op" id="1196660">,</span>&nbsp;<span class="ident" id="1196662">err</span><span class="op" id="1196665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196668">}</span><br>
<span class="lineno"></span><span class="op" id="1196670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1196673">func</span>&nbsp;<span class="ident" id="1196678">TestSeekFailure</span><span class="op" id="1196693">(</span><span class="ident" id="1196694">t</span>&nbsp;<span class="op" id="1196696">*</span><span class="ident" id="1196697">testing</span><span class="op" id="1196704">.</span><span class="ident" id="1196705">T</span><span class="op" id="1196706">)</span>&nbsp;<span class="op" id="1196708">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196711">_</span><span class="op" id="1196712">,</span>&nbsp;<span class="ident" id="1196714">err</span>&nbsp;<span class="op" id="1196718">:=</span>&nbsp;<span class="ident" id="1196721">syscall</span><span class="op" id="1196728">.</span><span class="ident" id="1196729">Seek</span><span class="op" id="1196733">(</span><span class="op" id="1196734">-</span><span class="num" id="1196735">1</span><span class="op" id="1196736">,</span>&nbsp;<span class="num" id="1196738">0</span><span class="op" id="1196739">,</span>&nbsp;<span class="num" id="1196741">0</span><span class="op" id="1196742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196745">if</span>&nbsp;<span class="ident" id="1196748">err</span>&nbsp;<span class="op" id="1196752">==</span>&nbsp;<span class="ident" id="1196755">nil</span>&nbsp;<span class="op" id="1196759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196763">t</span><span class="op" id="1196764">.</span><span class="ident" id="1196765">Fatalf</span><span class="op" id="1196771">(</span><span class="string" id="1196772">&#34;Seek(-1,&nbsp;0,&nbsp;0)&nbsp;did&nbsp;not&nbsp;fail&#34;</span><span class="op" id="1196801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196807">str</span>&nbsp;<span class="op" id="1196811">:=</span>&nbsp;<span class="ident" id="1196814">err</span><span class="op" id="1196817">.</span><span class="ident" id="1196818">Error</span><span class="op" id="1196823">(</span><span class="op" id="1196824">)</span>&nbsp;<span class="comment" id="1196826">//&nbsp;used&nbsp;to&nbsp;crash&nbsp;on&nbsp;Linux</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196853">t</span><span class="op" id="1196854">.</span><span class="ident" id="1196855">Logf</span><span class="op" id="1196859">(</span><span class="string" id="1196860">&#34;Seek:&nbsp;%v&#34;</span><span class="op" id="1196870">,</span>&nbsp;<span class="ident" id="1196872">str</span><span class="op" id="1196875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1196878">if</span>&nbsp;<span class="ident" id="1196881">str</span>&nbsp;<span class="op" id="1196885">==</span>&nbsp;<span class="string" id="1196888">&#34;&#34;</span>&nbsp;<span class="op" id="1196891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1196895">t</span><span class="op" id="1196896">.</span><span class="ident" id="1196897">Fatalf</span><span class="op" id="1196903">(</span><span class="string" id="1196904">&#34;Seek(-1,&nbsp;0,&nbsp;0)&nbsp;return&nbsp;error&nbsp;with&nbsp;empty&nbsp;message&#34;</span><span class="op" id="1196952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1196955">}</span><br>
<span class="lineno"></span><span class="op" id="1196957">}</span>
</div>
</body>
</html>
