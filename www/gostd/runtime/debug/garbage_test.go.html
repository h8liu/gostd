<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html" class="current">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8509071">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8509127">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8509181">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8509232">package</span>&nbsp;<span class="ident" id="8509240">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8509247">import</span>&nbsp;<span class="op" id="8509254">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8509257">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8509268">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8509279">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8509286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8509289">func</span>&nbsp;<span class="ident" id="8509294">TestReadGCStats</span><span class="op" id="8509309">(</span><span class="ident" id="8509310">t</span>&nbsp;<span class="op" id="8509312">*</span><span class="ident" id="8509313">testing</span><span class="op" id="8509320">.</span><span class="ident" id="8509321">T</span><span class="op" id="8509322">)</span>&nbsp;<span class="op" id="8509324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8509327">defer</span>&nbsp;<span class="ident" id="8509333">SetGCPercent</span><span class="op" id="8509345">(</span><span class="ident" id="8509346">SetGCPercent</span><span class="op" id="8509358">(</span><span class="op" id="8509359">-</span><span class="num" id="8509360">1</span><span class="op" id="8509361">)</span><span class="op" id="8509362">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8509366">var</span>&nbsp;<span class="ident" id="8509370">stats</span>&nbsp;<span class="ident" id="8509376">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8509385">var</span>&nbsp;<span class="ident" id="8509389">mstats</span>&nbsp;<span class="ident" id="8509396">runtime</span><span class="op" id="8509403">.</span><span class="ident" id="8509404">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8509414">var</span>&nbsp;<span class="ident" id="8509418">min</span><span class="op" id="8509421">,</span>&nbsp;<span class="ident" id="8509423">max</span>&nbsp;<span class="ident" id="8509427">time</span><span class="op" id="8509431">.</span><span class="ident" id="8509432">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8509443">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8509499">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509567">stats</span><span class="op" id="8509572">.</span><span class="ident" id="8509573">PauseQuantiles</span>&nbsp;<span class="op" id="8509588">=</span>&nbsp;<span class="builtinfunc" id="8509590">make</span><span class="op" id="8509594">(</span><span class="op" id="8509595">[</span><span class="op" id="8509596">]</span><span class="ident" id="8509597">time</span><span class="op" id="8509601">.</span><span class="ident" id="8509602">Duration</span><span class="op" id="8509610">,</span>&nbsp;<span class="num" id="8509612">10</span><span class="op" id="8509614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509617">ReadGCStats</span><span class="op" id="8509628">(</span><span class="op" id="8509629">&amp;</span><span class="ident" id="8509630">stats</span><span class="op" id="8509635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509638">runtime</span><span class="op" id="8509645">.</span><span class="ident" id="8509646">GC</span><span class="op" id="8509648">(</span><span class="op" id="8509649">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8509653">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509719">ReadGCStats</span><span class="op" id="8509730">(</span><span class="op" id="8509731">&amp;</span><span class="ident" id="8509732">stats</span><span class="op" id="8509737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509740">runtime</span><span class="op" id="8509747">.</span><span class="ident" id="8509748">ReadMemStats</span><span class="op" id="8509760">(</span><span class="op" id="8509761">&amp;</span><span class="ident" id="8509762">mstats</span><span class="op" id="8509768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8509772">if</span>&nbsp;<span class="ident" id="8509775">stats</span><span class="op" id="8509780">.</span><span class="ident" id="8509781">NumGC</span>&nbsp;<span class="op" id="8509787">!=</span>&nbsp;<span class="ident" id="8509790">int64</span><span class="op" id="8509795">(</span><span class="ident" id="8509796">mstats</span><span class="op" id="8509802">.</span><span class="ident" id="8509803">NumGC</span><span class="op" id="8509808">)</span>&nbsp;<span class="op" id="8509810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509814">t</span><span class="op" id="8509815">.</span><span class="ident" id="8509816">Errorf</span><span class="op" id="8509822">(</span><span class="string" id="8509823">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8509864">,</span>&nbsp;<span class="ident" id="8509866">stats</span><span class="op" id="8509871">.</span><span class="ident" id="8509872">NumGC</span><span class="op" id="8509877">,</span>&nbsp;<span class="ident" id="8509879">mstats</span><span class="op" id="8509885">.</span><span class="ident" id="8509886">NumGC</span><span class="op" id="8509891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8509894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8509897">if</span>&nbsp;<span class="ident" id="8509900">stats</span><span class="op" id="8509905">.</span><span class="ident" id="8509906">PauseTotal</span>&nbsp;<span class="op" id="8509917">!=</span>&nbsp;<span class="ident" id="8509920">time</span><span class="op" id="8509924">.</span><span class="ident" id="8509925">Duration</span><span class="op" id="8509933">(</span><span class="ident" id="8509934">mstats</span><span class="op" id="8509940">.</span><span class="ident" id="8509941">PauseTotalNs</span><span class="op" id="8509953">)</span>&nbsp;<span class="op" id="8509955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8509959">t</span><span class="op" id="8509960">.</span><span class="ident" id="8509961">Errorf</span><span class="op" id="8509967">(</span><span class="string" id="8509968">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8510021">,</span>&nbsp;<span class="ident" id="8510023">stats</span><span class="op" id="8510028">.</span><span class="ident" id="8510029">PauseTotal</span><span class="op" id="8510039">,</span>&nbsp;<span class="ident" id="8510041">mstats</span><span class="op" id="8510047">.</span><span class="ident" id="8510048">PauseTotalNs</span><span class="op" id="8510060">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510066">if</span>&nbsp;<span class="ident" id="8510069">stats</span><span class="op" id="8510074">.</span><span class="ident" id="8510075">LastGC</span><span class="op" id="8510081">.</span><span class="ident" id="8510082">UnixNano</span><span class="op" id="8510090">(</span><span class="op" id="8510091">)</span>&nbsp;<span class="op" id="8510093">!=</span>&nbsp;<span class="ident" id="8510096">int64</span><span class="op" id="8510101">(</span><span class="ident" id="8510102">mstats</span><span class="op" id="8510108">.</span><span class="ident" id="8510109">LastGC</span><span class="op" id="8510115">)</span>&nbsp;<span class="op" id="8510117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510121">t</span><span class="op" id="8510122">.</span><span class="ident" id="8510123">Errorf</span><span class="op" id="8510129">(</span><span class="string" id="8510130">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8510182">,</span>&nbsp;<span class="ident" id="8510184">stats</span><span class="op" id="8510189">.</span><span class="ident" id="8510190">LastGC</span><span class="op" id="8510196">.</span><span class="ident" id="8510197">UnixNano</span><span class="op" id="8510205">(</span><span class="op" id="8510206">)</span><span class="op" id="8510207">,</span>&nbsp;<span class="ident" id="8510209">mstats</span><span class="op" id="8510215">.</span><span class="ident" id="8510216">LastGC</span><span class="op" id="8510222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510228">n</span>&nbsp;<span class="op" id="8510230">:=</span>&nbsp;<span class="builtintype" id="8510233">int</span><span class="op" id="8510236">(</span><span class="ident" id="8510237">mstats</span><span class="op" id="8510243">.</span><span class="ident" id="8510244">NumGC</span><span class="op" id="8510249">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510252">if</span>&nbsp;<span class="ident" id="8510255">n</span>&nbsp;<span class="op" id="8510257">&gt;</span>&nbsp;<span class="builtinfunc" id="8510259">len</span><span class="op" id="8510262">(</span><span class="ident" id="8510263">mstats</span><span class="op" id="8510269">.</span><span class="ident" id="8510270">PauseNs</span><span class="op" id="8510277">)</span>&nbsp;<span class="op" id="8510279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510283">n</span>&nbsp;<span class="op" id="8510285">=</span>&nbsp;<span class="builtinfunc" id="8510287">len</span><span class="op" id="8510290">(</span><span class="ident" id="8510291">mstats</span><span class="op" id="8510297">.</span><span class="ident" id="8510298">PauseNs</span><span class="op" id="8510305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510311">if</span>&nbsp;<span class="builtinfunc" id="8510314">len</span><span class="op" id="8510317">(</span><span class="ident" id="8510318">stats</span><span class="op" id="8510323">.</span><span class="ident" id="8510324">Pause</span><span class="op" id="8510329">)</span>&nbsp;<span class="op" id="8510331">!=</span>&nbsp;<span class="ident" id="8510334">n</span>&nbsp;<span class="op" id="8510336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510340">t</span><span class="op" id="8510341">.</span><span class="ident" id="8510342">Errorf</span><span class="op" id="8510348">(</span><span class="string" id="8510349">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8510381">,</span>&nbsp;<span class="builtinfunc" id="8510383">len</span><span class="op" id="8510386">(</span><span class="ident" id="8510387">stats</span><span class="op" id="8510392">.</span><span class="ident" id="8510393">Pause</span><span class="op" id="8510398">)</span><span class="op" id="8510399">,</span>&nbsp;<span class="ident" id="8510401">n</span><span class="op" id="8510402">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510405">}</span>&nbsp;<span class="keyword" id="8510407">else</span>&nbsp;<span class="op" id="8510412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510416">off</span>&nbsp;<span class="op" id="8510420">:=</span>&nbsp;<span class="op" id="8510423">(</span><span class="builtintype" id="8510424">int</span><span class="op" id="8510427">(</span><span class="ident" id="8510428">mstats</span><span class="op" id="8510434">.</span><span class="ident" id="8510435">NumGC</span><span class="op" id="8510440">)</span>&nbsp;<span class="op" id="8510442">+</span>&nbsp;<span class="builtinfunc" id="8510444">len</span><span class="op" id="8510447">(</span><span class="ident" id="8510448">mstats</span><span class="op" id="8510454">.</span><span class="ident" id="8510455">PauseNs</span><span class="op" id="8510462">)</span>&nbsp;<span class="op" id="8510464">-</span>&nbsp;<span class="num" id="8510466">1</span><span class="op" id="8510467">)</span>&nbsp;<span class="op" id="8510469">%</span>&nbsp;<span class="builtinfunc" id="8510471">len</span><span class="op" id="8510474">(</span><span class="ident" id="8510475">mstats</span><span class="op" id="8510481">.</span><span class="ident" id="8510482">PauseNs</span><span class="op" id="8510489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510493">for</span>&nbsp;<span class="ident" id="8510497">i</span>&nbsp;<span class="op" id="8510499">:=</span>&nbsp;<span class="num" id="8510502">0</span><span class="op" id="8510503">;</span>&nbsp;<span class="ident" id="8510505">i</span>&nbsp;<span class="op" id="8510507">&lt;</span>&nbsp;<span class="ident" id="8510509">n</span><span class="op" id="8510510">;</span>&nbsp;<span class="ident" id="8510512">i</span><span class="op" id="8510513">++</span>&nbsp;<span class="op" id="8510516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510521">dt</span>&nbsp;<span class="op" id="8510524">:=</span>&nbsp;<span class="ident" id="8510527">stats</span><span class="op" id="8510532">.</span><span class="ident" id="8510533">Pause</span><span class="op" id="8510538">[</span><span class="ident" id="8510539">i</span><span class="op" id="8510540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510545">if</span>&nbsp;<span class="ident" id="8510548">dt</span>&nbsp;<span class="op" id="8510551">!=</span>&nbsp;<span class="ident" id="8510554">time</span><span class="op" id="8510558">.</span><span class="ident" id="8510559">Duration</span><span class="op" id="8510567">(</span><span class="ident" id="8510568">mstats</span><span class="op" id="8510574">.</span><span class="ident" id="8510575">PauseNs</span><span class="op" id="8510582">[</span><span class="ident" id="8510583">off</span><span class="op" id="8510586">]</span><span class="op" id="8510587">)</span>&nbsp;<span class="op" id="8510589">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510595">t</span><span class="op" id="8510596">.</span><span class="ident" id="8510597">Errorf</span><span class="op" id="8510603">(</span><span class="string" id="8510604">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8510635">,</span>&nbsp;<span class="ident" id="8510637">i</span><span class="op" id="8510638">,</span>&nbsp;<span class="ident" id="8510640">dt</span><span class="op" id="8510642">,</span>&nbsp;<span class="ident" id="8510644">mstats</span><span class="op" id="8510650">.</span><span class="ident" id="8510651">PauseNs</span><span class="op" id="8510658">[</span><span class="ident" id="8510659">off</span><span class="op" id="8510662">]</span><span class="op" id="8510663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510673">if</span>&nbsp;<span class="ident" id="8510676">max</span>&nbsp;<span class="op" id="8510680">&lt;</span>&nbsp;<span class="ident" id="8510682">dt</span>&nbsp;<span class="op" id="8510685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510691">max</span>&nbsp;<span class="op" id="8510695">=</span>&nbsp;<span class="ident" id="8510697">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510703">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510708">if</span>&nbsp;<span class="ident" id="8510711">min</span>&nbsp;<span class="op" id="8510715">&gt;</span>&nbsp;<span class="ident" id="8510717">dt</span>&nbsp;<span class="op" id="8510720">||</span>&nbsp;<span class="ident" id="8510723">i</span>&nbsp;<span class="op" id="8510725">==</span>&nbsp;<span class="num" id="8510728">0</span>&nbsp;<span class="op" id="8510730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510736">min</span>&nbsp;<span class="op" id="8510740">=</span>&nbsp;<span class="ident" id="8510742">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510753">off</span>&nbsp;<span class="op" id="8510757">=</span>&nbsp;<span class="op" id="8510759">(</span><span class="ident" id="8510760">off</span>&nbsp;<span class="op" id="8510764">+</span>&nbsp;<span class="builtinfunc" id="8510766">len</span><span class="op" id="8510769">(</span><span class="ident" id="8510770">mstats</span><span class="op" id="8510776">.</span><span class="ident" id="8510777">PauseNs</span><span class="op" id="8510784">)</span>&nbsp;<span class="op" id="8510786">-</span>&nbsp;<span class="num" id="8510788">1</span><span class="op" id="8510789">)</span>&nbsp;<span class="op" id="8510791">%</span>&nbsp;<span class="builtinfunc" id="8510793">len</span><span class="op" id="8510796">(</span><span class="ident" id="8510797">mstats</span><span class="op" id="8510803">.</span><span class="ident" id="8510804">PauseNs</span><span class="op" id="8510811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510815">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510822">q</span>&nbsp;<span class="op" id="8510824">:=</span>&nbsp;<span class="ident" id="8510827">stats</span><span class="op" id="8510832">.</span><span class="ident" id="8510833">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510849">nq</span>&nbsp;<span class="op" id="8510852">:=</span>&nbsp;<span class="builtinfunc" id="8510855">len</span><span class="op" id="8510858">(</span><span class="ident" id="8510859">q</span><span class="op" id="8510860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510863">if</span>&nbsp;<span class="ident" id="8510866">q</span><span class="op" id="8510867">[</span><span class="num" id="8510868">0</span><span class="op" id="8510869">]</span>&nbsp;<span class="op" id="8510871">!=</span>&nbsp;<span class="ident" id="8510874">min</span>&nbsp;<span class="op" id="8510878">||</span>&nbsp;<span class="ident" id="8510881">q</span><span class="op" id="8510882">[</span><span class="ident" id="8510883">nq</span><span class="op" id="8510885">-</span><span class="num" id="8510886">1</span><span class="op" id="8510887">]</span>&nbsp;<span class="op" id="8510889">!=</span>&nbsp;<span class="ident" id="8510892">max</span>&nbsp;<span class="op" id="8510896">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8510900">t</span><span class="op" id="8510901">.</span><span class="ident" id="8510902">Errorf</span><span class="op" id="8510908">(</span><span class="string" id="8510909">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="8510967">,</span>&nbsp;<span class="ident" id="8510969">q</span><span class="op" id="8510970">[</span><span class="num" id="8510971">0</span><span class="op" id="8510972">]</span><span class="op" id="8510973">,</span>&nbsp;<span class="ident" id="8510975">q</span><span class="op" id="8510976">[</span><span class="ident" id="8510977">nq</span><span class="op" id="8510979">-</span><span class="num" id="8510980">1</span><span class="op" id="8510981">]</span><span class="op" id="8510982">,</span>&nbsp;<span class="ident" id="8510984">min</span><span class="op" id="8510987">,</span>&nbsp;<span class="ident" id="8510989">max</span><span class="op" id="8510992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8510995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8510999">for</span>&nbsp;<span class="ident" id="8511003">i</span>&nbsp;<span class="op" id="8511005">:=</span>&nbsp;<span class="num" id="8511008">0</span><span class="op" id="8511009">;</span>&nbsp;<span class="ident" id="8511011">i</span>&nbsp;<span class="op" id="8511013">&lt;</span>&nbsp;<span class="ident" id="8511015">nq</span><span class="op" id="8511017">-</span><span class="num" id="8511018">1</span><span class="op" id="8511019">;</span>&nbsp;<span class="ident" id="8511021">i</span><span class="op" id="8511022">++</span>&nbsp;<span class="op" id="8511025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511029">if</span>&nbsp;<span class="ident" id="8511032">q</span><span class="op" id="8511033">[</span><span class="ident" id="8511034">i</span><span class="op" id="8511035">]</span>&nbsp;<span class="op" id="8511037">&gt;</span>&nbsp;<span class="ident" id="8511039">q</span><span class="op" id="8511040">[</span><span class="ident" id="8511041">i</span><span class="op" id="8511042">+</span><span class="num" id="8511043">1</span><span class="op" id="8511044">]</span>&nbsp;<span class="op" id="8511046">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511051">t</span><span class="op" id="8511052">.</span><span class="ident" id="8511053">Errorf</span><span class="op" id="8511059">(</span><span class="string" id="8511060">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="8511119">,</span>&nbsp;<span class="ident" id="8511121">i</span><span class="op" id="8511122">,</span>&nbsp;<span class="ident" id="8511124">q</span><span class="op" id="8511125">[</span><span class="ident" id="8511126">i</span><span class="op" id="8511127">]</span><span class="op" id="8511128">,</span>&nbsp;<span class="ident" id="8511130">i</span><span class="op" id="8511131">+</span><span class="num" id="8511132">1</span><span class="op" id="8511133">,</span>&nbsp;<span class="ident" id="8511135">q</span><span class="op" id="8511136">[</span><span class="ident" id="8511137">i</span><span class="op" id="8511138">+</span><span class="num" id="8511139">1</span><span class="op" id="8511140">]</span><span class="op" id="8511141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8511145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8511148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8511152">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511192">if</span>&nbsp;<span class="builtinfunc" id="8511195">len</span><span class="op" id="8511198">(</span><span class="ident" id="8511199">stats</span><span class="op" id="8511204">.</span><span class="ident" id="8511205">PauseEnd</span><span class="op" id="8511213">)</span>&nbsp;<span class="op" id="8511215">!=</span>&nbsp;<span class="ident" id="8511218">n</span>&nbsp;<span class="op" id="8511220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511224">t</span><span class="op" id="8511225">.</span><span class="ident" id="8511226">Fatalf</span><span class="op" id="8511232">(</span><span class="string" id="8511233">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8511268">,</span>&nbsp;<span class="builtinfunc" id="8511270">len</span><span class="op" id="8511273">(</span><span class="ident" id="8511274">stats</span><span class="op" id="8511279">.</span><span class="ident" id="8511280">PauseEnd</span><span class="op" id="8511288">)</span><span class="op" id="8511289">,</span>&nbsp;<span class="ident" id="8511291">n</span><span class="op" id="8511292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8511295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511298">off</span>&nbsp;<span class="op" id="8511302">:=</span>&nbsp;<span class="op" id="8511305">(</span><span class="builtintype" id="8511306">int</span><span class="op" id="8511309">(</span><span class="ident" id="8511310">mstats</span><span class="op" id="8511316">.</span><span class="ident" id="8511317">NumGC</span><span class="op" id="8511322">)</span>&nbsp;<span class="op" id="8511324">+</span>&nbsp;<span class="builtinfunc" id="8511326">len</span><span class="op" id="8511329">(</span><span class="ident" id="8511330">mstats</span><span class="op" id="8511336">.</span><span class="ident" id="8511337">PauseEnd</span><span class="op" id="8511345">)</span>&nbsp;<span class="op" id="8511347">-</span>&nbsp;<span class="num" id="8511349">1</span><span class="op" id="8511350">)</span>&nbsp;<span class="op" id="8511352">%</span>&nbsp;<span class="builtinfunc" id="8511354">len</span><span class="op" id="8511357">(</span><span class="ident" id="8511358">mstats</span><span class="op" id="8511364">.</span><span class="ident" id="8511365">PauseEnd</span><span class="op" id="8511373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511376">for</span>&nbsp;<span class="ident" id="8511380">i</span>&nbsp;<span class="op" id="8511382">:=</span>&nbsp;<span class="num" id="8511385">0</span><span class="op" id="8511386">;</span>&nbsp;<span class="ident" id="8511388">i</span>&nbsp;<span class="op" id="8511390">&lt;</span>&nbsp;<span class="ident" id="8511392">n</span><span class="op" id="8511393">;</span>&nbsp;<span class="ident" id="8511395">i</span><span class="op" id="8511396">++</span>&nbsp;<span class="op" id="8511399">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511403">dt</span>&nbsp;<span class="op" id="8511406">:=</span>&nbsp;<span class="ident" id="8511409">stats</span><span class="op" id="8511414">.</span><span class="ident" id="8511415">PauseEnd</span><span class="op" id="8511423">[</span><span class="ident" id="8511424">i</span><span class="op" id="8511425">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511429">if</span>&nbsp;<span class="ident" id="8511432">dt</span><span class="op" id="8511434">.</span><span class="ident" id="8511435">UnixNano</span><span class="op" id="8511443">(</span><span class="op" id="8511444">)</span>&nbsp;<span class="op" id="8511446">!=</span>&nbsp;<span class="ident" id="8511449">int64</span><span class="op" id="8511454">(</span><span class="ident" id="8511455">mstats</span><span class="op" id="8511461">.</span><span class="ident" id="8511462">PauseEnd</span><span class="op" id="8511470">[</span><span class="ident" id="8511471">off</span><span class="op" id="8511474">]</span><span class="op" id="8511475">)</span>&nbsp;<span class="op" id="8511477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511482">t</span><span class="op" id="8511483">.</span><span class="ident" id="8511484">Errorf</span><span class="op" id="8511490">(</span><span class="string" id="8511491">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8511525">,</span>&nbsp;<span class="ident" id="8511527">i</span><span class="op" id="8511528">,</span>&nbsp;<span class="ident" id="8511530">dt</span><span class="op" id="8511532">,</span>&nbsp;<span class="ident" id="8511534">mstats</span><span class="op" id="8511540">.</span><span class="ident" id="8511541">PauseEnd</span><span class="op" id="8511549">[</span><span class="ident" id="8511550">off</span><span class="op" id="8511553">]</span><span class="op" id="8511554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8511558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511562">off</span>&nbsp;<span class="op" id="8511566">=</span>&nbsp;<span class="op" id="8511568">(</span><span class="ident" id="8511569">off</span>&nbsp;<span class="op" id="8511573">+</span>&nbsp;<span class="builtinfunc" id="8511575">len</span><span class="op" id="8511578">(</span><span class="ident" id="8511579">mstats</span><span class="op" id="8511585">.</span><span class="ident" id="8511586">PauseEnd</span><span class="op" id="8511594">)</span>&nbsp;<span class="op" id="8511596">-</span>&nbsp;<span class="num" id="8511598">1</span><span class="op" id="8511599">)</span>&nbsp;<span class="op" id="8511601">%</span>&nbsp;<span class="builtinfunc" id="8511603">len</span><span class="op" id="8511606">(</span><span class="ident" id="8511607">mstats</span><span class="op" id="8511613">.</span><span class="ident" id="8511614">PauseEnd</span><span class="op" id="8511622">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8511625">}</span><br>
<span class="lineno"></span><span class="op" id="8511627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8511630">var</span>&nbsp;<span class="ident" id="8511634">big</span>&nbsp;<span class="op" id="8511638">=</span>&nbsp;<span class="builtinfunc" id="8511640">make</span><span class="op" id="8511644">(</span><span class="op" id="8511645">[</span><span class="op" id="8511646">]</span><span class="builtintype" id="8511647">byte</span><span class="op" id="8511651">,</span>&nbsp;<span class="num" id="8511653">1</span><span class="op" id="8511654">&lt;&lt;</span><span class="num" id="8511656">20</span><span class="op" id="8511658">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="8511661">func</span>&nbsp;<span class="ident" id="8511666">TestFreeOSMemory</span><span class="op" id="8511682">(</span><span class="ident" id="8511683">t</span>&nbsp;<span class="op" id="8511685">*</span><span class="ident" id="8511686">testing</span><span class="op" id="8511693">.</span><span class="ident" id="8511694">T</span><span class="op" id="8511695">)</span>&nbsp;<span class="op" id="8511697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511700">var</span>&nbsp;<span class="ident" id="8511704">ms1</span><span class="op" id="8511707">,</span>&nbsp;<span class="ident" id="8511709">ms2</span>&nbsp;<span class="ident" id="8511713">runtime</span><span class="op" id="8511720">.</span><span class="ident" id="8511721">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511732">if</span>&nbsp;<span class="ident" id="8511735">big</span>&nbsp;<span class="op" id="8511739">==</span>&nbsp;<span class="builtintype" id="8511742">nil</span>&nbsp;<span class="op" id="8511746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511750">t</span><span class="op" id="8511751">.</span><span class="ident" id="8511752">Skip</span><span class="op" id="8511756">(</span><span class="string" id="8511757">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="8511803">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8511806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511809">big</span>&nbsp;<span class="op" id="8511813">=</span>&nbsp;<span class="builtintype" id="8511815">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511820">runtime</span><span class="op" id="8511827">.</span><span class="ident" id="8511828">GC</span><span class="op" id="8511830">(</span><span class="op" id="8511831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511834">runtime</span><span class="op" id="8511841">.</span><span class="ident" id="8511842">ReadMemStats</span><span class="op" id="8511854">(</span><span class="op" id="8511855">&amp;</span><span class="ident" id="8511856">ms1</span><span class="op" id="8511859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511862">FreeOSMemory</span><span class="op" id="8511874">(</span><span class="op" id="8511875">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511878">runtime</span><span class="op" id="8511885">.</span><span class="ident" id="8511886">ReadMemStats</span><span class="op" id="8511898">(</span><span class="op" id="8511899">&amp;</span><span class="ident" id="8511900">ms2</span><span class="op" id="8511903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8511906">if</span>&nbsp;<span class="ident" id="8511909">ms1</span><span class="op" id="8511912">.</span><span class="ident" id="8511913">HeapReleased</span>&nbsp;<span class="op" id="8511926">&gt;=</span>&nbsp;<span class="ident" id="8511929">ms2</span><span class="op" id="8511932">.</span><span class="ident" id="8511933">HeapReleased</span>&nbsp;<span class="op" id="8511946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8511950">t</span><span class="op" id="8511951">.</span><span class="ident" id="8511952">Errorf</span><span class="op" id="8511958">(</span><span class="string" id="8511959">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="8512013">,</span>&nbsp;<span class="ident" id="8512015">ms1</span><span class="op" id="8512018">.</span><span class="ident" id="8512019">HeapReleased</span><span class="op" id="8512031">,</span>&nbsp;<span class="ident" id="8512033">ms2</span><span class="op" id="8512036">.</span><span class="ident" id="8512037">HeapReleased</span><span class="op" id="8512049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8512052">}</span><br>
<span class="lineno"></span><span class="op" id="8512054">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="8512057">func</span>&nbsp;<span class="ident" id="8512062">TestSetGCPercent</span><span class="op" id="8512078">(</span><span class="ident" id="8512079">t</span>&nbsp;<span class="op" id="8512081">*</span><span class="ident" id="8512082">testing</span><span class="op" id="8512089">.</span><span class="ident" id="8512090">T</span><span class="op" id="8512091">)</span>&nbsp;<span class="op" id="8512093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8512096">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8512160">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8512224">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8512253">old</span>&nbsp;<span class="op" id="8512257">:=</span>&nbsp;<span class="ident" id="8512260">SetGCPercent</span><span class="op" id="8512272">(</span><span class="num" id="8512273">123</span><span class="op" id="8512276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8512279">new</span>&nbsp;<span class="op" id="8512283">:=</span>&nbsp;<span class="ident" id="8512286">SetGCPercent</span><span class="op" id="8512298">(</span><span class="ident" id="8512299">old</span><span class="op" id="8512302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8512305">if</span>&nbsp;<span class="builtinfunc" id="8512308">new</span>&nbsp;<span class="op" id="8512312">!=</span>&nbsp;<span class="num" id="8512315">123</span>&nbsp;<span class="op" id="8512319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8512323">t</span><span class="op" id="8512324">.</span><span class="ident" id="8512325">Errorf</span><span class="op" id="8512331">(</span><span class="string" id="8512332">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="8512383">,</span>&nbsp;<span class="builtinfunc" id="8512385">new</span><span class="op" id="8512388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8512391">}</span><br>
<span class="lineno">115</span><span class="op" id="8512393">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
