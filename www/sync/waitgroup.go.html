<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1689390">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1689445">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1689499">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1689550">package</span>&nbsp;<span class="ident" id="1689558">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1689564">import</span>&nbsp;<span class="op" id="1689571">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1689574">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1689589">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1689598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1689601">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1689664">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1689717">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1689773">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1689830">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1689895">type</span>&nbsp;<span class="ident" id="1689900">WaitGroup</span>&nbsp;<span class="keyword" id="1689910">struct</span>&nbsp;<span class="op" id="1689917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689920">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1689928"><a href="/sync/mutex.go.html#1673941">Mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689935">counter</span>&nbsp;<span class="builtintype" id="1689943">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689950">waiters</span>&nbsp;<span class="builtintype" id="1689958">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689965">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1689973">*</span><span class="builtintype" id="1689974">uint32</span><br>
<span class="lineno"></span><span class="op" id="1689981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1689984">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1690049">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1690102">//</span><br>
<span class="lineno"></span><span class="comment" id="1690105">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1690119">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1690134">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1690206">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1690287">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1690353">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1690404">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1690419">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1690494">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1690562">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1690639">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1690684">//</span><br>
<span class="lineno">40</span><span class="comment" id="1690687">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1690764">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1690839">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1690918">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1690934">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1691011">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1691070">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1691100">func</span>&nbsp;<span class="op" id="1691105">(</span><span class="ident" id="1691106">wg</span>&nbsp;<span class="op" id="1691109">*</span><span class="ident" id="1691110"><a href="/sync/waitgroup.go.html#1689900">WaitGroup</a></span><span class="op" id="1691119">)</span>&nbsp;<span class="ident" id="1691121">Add</span><span class="op" id="1691124">(</span><span class="ident" id="1691125">delta</span>&nbsp;<span class="builtintype" id="1691131">int</span><span class="op" id="1691134">)</span>&nbsp;<span class="op" id="1691136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691139">if</span>&nbsp;<span class="ident" id="1691142"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1691154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691158">_</span>&nbsp;<span class="op" id="1691160">=</span>&nbsp;<span class="ident" id="1691162"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691164">.</span><span class="ident" id="1691165">m</span><span class="op" id="1691166">.</span><span class="ident" id="1691167">state</span>&nbsp;<span class="comment" id="1691173">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691202">if</span>&nbsp;<span class="ident" id="1691205"><a href="/sync/waitgroup.go.html#1691125">delta</a></span>&nbsp;<span class="op" id="1691211">&lt;</span>&nbsp;<span class="num" id="1691213">0</span>&nbsp;<span class="op" id="1691215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691220">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691260"><a href="/sync/race0.go.html#1684138">raceReleaseMerge</a></span><span class="op" id="1691276">(</span><span class="ident" id="1691277"><a href="/sync/waitgroup.go.html#1689589">unsafe</a></span><span class="op" id="1691283">.</span><span class="ident" id="1691284">Pointer</span><span class="op" id="1691291">(</span><span class="ident" id="1691292"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691294">)</span><span class="op" id="1691295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691303"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1691314">(</span><span class="op" id="1691315">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691319">defer</span>&nbsp;<span class="ident" id="1691325"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1691335">(</span><span class="op" id="1691336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691342">v</span>&nbsp;<span class="op" id="1691344">:=</span>&nbsp;<span class="ident" id="1691347"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1691353">.</span><span class="ident" id="1691354">AddInt32</span><span class="op" id="1691362">(</span><span class="op" id="1691363">&amp;</span><span class="ident" id="1691364"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691366">.</span><span class="ident" id="1691367">counter</span><span class="op" id="1691374">,</span>&nbsp;<span class="builtintype" id="1691376">int32</span><span class="op" id="1691381">(</span><span class="ident" id="1691382"><a href="/sync/waitgroup.go.html#1691125">delta</a></span><span class="op" id="1691387">)</span><span class="op" id="1691388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691391">if</span>&nbsp;<span class="ident" id="1691394"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1691406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691410">if</span>&nbsp;<span class="ident" id="1691413"><a href="/sync/waitgroup.go.html#1691125">delta</a></span>&nbsp;<span class="op" id="1691419">&gt;</span>&nbsp;<span class="num" id="1691421">0</span>&nbsp;<span class="op" id="1691423">&amp;&amp;</span>&nbsp;<span class="ident" id="1691426"><a href="/sync/waitgroup.go.html#1691342">v</a></span>&nbsp;<span class="op" id="1691428">==</span>&nbsp;<span class="builtintype" id="1691431">int32</span><span class="op" id="1691436">(</span><span class="ident" id="1691437"><a href="/sync/waitgroup.go.html#1691125">delta</a></span><span class="op" id="1691442">)</span>&nbsp;<span class="op" id="1691444">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691449">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691507">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691564">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691620"><a href="/sync/race0.go.html#1684233">raceRead</a></span><span class="op" id="1691628">(</span><span class="ident" id="1691629"><a href="/sync/waitgroup.go.html#1689589">unsafe</a></span><span class="op" id="1691635">.</span><span class="ident" id="1691636">Pointer</span><span class="op" id="1691643">(</span><span class="op" id="1691644">&amp;</span><span class="ident" id="1691645"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691647">.</span><span class="ident" id="1691648">sema</span><span class="op" id="1691652">)</span><span class="op" id="1691653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691657">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691663">if</span>&nbsp;<span class="ident" id="1691666"><a href="/sync/waitgroup.go.html#1691342">v</a></span>&nbsp;<span class="op" id="1691668">&lt;</span>&nbsp;<span class="num" id="1691670">0</span>&nbsp;<span class="op" id="1691672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1691676">panic</span><span class="op" id="1691681">(</span><span class="string" id="1691682">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1691716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691722">if</span>&nbsp;<span class="ident" id="1691725"><a href="/sync/waitgroup.go.html#1691342">v</a></span>&nbsp;<span class="op" id="1691727">&gt;</span>&nbsp;<span class="num" id="1691729">0</span>&nbsp;<span class="op" id="1691731">||</span>&nbsp;<span class="ident" id="1691734"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1691740">.</span><span class="ident" id="1691741">LoadInt32</span><span class="op" id="1691750">(</span><span class="op" id="1691751">&amp;</span><span class="ident" id="1691752"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691754">.</span><span class="ident" id="1691755">waiters</span><span class="op" id="1691762">)</span>&nbsp;<span class="op" id="1691764">==</span>&nbsp;<span class="num" id="1691767">0</span>&nbsp;<span class="op" id="1691769">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691773">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691784"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691786">.</span><span class="ident" id="1691787">m</span><span class="op" id="1691788">.</span><span class="ident" id="1691789">Lock</span><span class="op" id="1691793">(</span><span class="op" id="1691794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691797">if</span>&nbsp;<span class="ident" id="1691800"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1691806">.</span><span class="ident" id="1691807">LoadInt32</span><span class="op" id="1691816">(</span><span class="op" id="1691817">&amp;</span><span class="ident" id="1691818"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691820">.</span><span class="ident" id="1691821">counter</span><span class="op" id="1691828">)</span>&nbsp;<span class="op" id="1691830">==</span>&nbsp;<span class="num" id="1691833">0</span>&nbsp;<span class="op" id="1691835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691839">for</span>&nbsp;<span class="ident" id="1691843">i</span>&nbsp;<span class="op" id="1691845">:=</span>&nbsp;<span class="builtintype" id="1691848">int32</span><span class="op" id="1691853">(</span><span class="num" id="1691854">0</span><span class="op" id="1691855">)</span><span class="op" id="1691856">;</span>&nbsp;<span class="ident" id="1691858"><a href="/sync/waitgroup.go.html#1691843">i</a></span>&nbsp;<span class="op" id="1691860">&lt;</span>&nbsp;<span class="ident" id="1691862"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691864">.</span><span class="ident" id="1691865">waiters</span><span class="op" id="1691872">;</span>&nbsp;<span class="ident" id="1691874"><a href="/sync/waitgroup.go.html#1691843">i</a></span><span class="op" id="1691875">++</span>&nbsp;<span class="op" id="1691878">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691883"><a href="/sync/runtime.go.html#1684992">runtime_Semrelease</a></span><span class="op" id="1691901">(</span><span class="ident" id="1691902"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691904">.</span><span class="ident" id="1691905">sema</span><span class="op" id="1691909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691917"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691919">.</span><span class="ident" id="1691920">waiters</span>&nbsp;<span class="op" id="1691928">=</span>&nbsp;<span class="num" id="1691930">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691934"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691936">.</span><span class="ident" id="1691937">sema</span>&nbsp;<span class="op" id="1691942">=</span>&nbsp;<span class="ident" id="1691944">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691949">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691952"><a href="/sync/waitgroup.go.html#1691106">wg</a></span><span class="op" id="1691954">.</span><span class="ident" id="1691955">m</span><span class="op" id="1691956">.</span><span class="ident" id="1691957">Unlock</span><span class="op" id="1691963">(</span><span class="op" id="1691964">)</span><br>
<span class="lineno"></span><span class="op" id="1691966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1691969">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1692011">func</span>&nbsp;<span class="op" id="1692016">(</span><span class="ident" id="1692017">wg</span>&nbsp;<span class="op" id="1692020">*</span><span class="ident" id="1692021"><a href="/sync/waitgroup.go.html#1689900">WaitGroup</a></span><span class="op" id="1692030">)</span>&nbsp;<span class="ident" id="1692032">Done</span><span class="op" id="1692036">(</span><span class="op" id="1692037">)</span>&nbsp;<span class="op" id="1692039">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692042"><a href="/sync/waitgroup.go.html#1692017">wg</a></span><span class="op" id="1692044">.</span><span class="ident" id="1692045">Add</span><span class="op" id="1692048">(</span><span class="op" id="1692049">-</span><span class="num" id="1692050">1</span><span class="op" id="1692051">)</span><br>
<span class="lineno"></span><span class="op" id="1692053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1692056">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1692108">func</span>&nbsp;<span class="op" id="1692113">(</span><span class="ident" id="1692114">wg</span>&nbsp;<span class="op" id="1692117">*</span><span class="ident" id="1692118"><a href="/sync/waitgroup.go.html#1689900">WaitGroup</a></span><span class="op" id="1692127">)</span>&nbsp;<span class="ident" id="1692129">Wait</span><span class="op" id="1692133">(</span><span class="op" id="1692134">)</span>&nbsp;<span class="op" id="1692136">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692139">if</span>&nbsp;<span class="ident" id="1692142"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1692154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692158">_</span>&nbsp;<span class="op" id="1692160">=</span>&nbsp;<span class="ident" id="1692162"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692164">.</span><span class="ident" id="1692165">m</span><span class="op" id="1692166">.</span><span class="ident" id="1692167">state</span>&nbsp;<span class="comment" id="1692173">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692202"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1692213">(</span><span class="op" id="1692214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692220">if</span>&nbsp;<span class="ident" id="1692223"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1692229">.</span><span class="ident" id="1692230">LoadInt32</span><span class="op" id="1692239">(</span><span class="op" id="1692240">&amp;</span><span class="ident" id="1692241"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692243">.</span><span class="ident" id="1692244">counter</span><span class="op" id="1692251">)</span>&nbsp;<span class="op" id="1692253">==</span>&nbsp;<span class="num" id="1692256">0</span>&nbsp;<span class="op" id="1692258">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692262">if</span>&nbsp;<span class="ident" id="1692265"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1692277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692282"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1692292">(</span><span class="op" id="1692293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692298"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1692309">(</span><span class="ident" id="1692310"><a href="/sync/waitgroup.go.html#1689589">unsafe</a></span><span class="op" id="1692316">.</span><span class="ident" id="1692317">Pointer</span><span class="op" id="1692324">(</span><span class="ident" id="1692325"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692327">)</span><span class="op" id="1692328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692336">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692347"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692349">.</span><span class="ident" id="1692350">m</span><span class="op" id="1692351">.</span><span class="ident" id="1692352">Lock</span><span class="op" id="1692356">(</span><span class="op" id="1692357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692360">w</span>&nbsp;<span class="op" id="1692362">:=</span>&nbsp;<span class="ident" id="1692365"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1692371">.</span><span class="ident" id="1692372">AddInt32</span><span class="op" id="1692380">(</span><span class="op" id="1692381">&amp;</span><span class="ident" id="1692382"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692384">.</span><span class="ident" id="1692385">waiters</span><span class="op" id="1692392">,</span>&nbsp;<span class="num" id="1692394">1</span><span class="op" id="1692395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692398">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692459">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692519">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692589">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692618">if</span>&nbsp;<span class="ident" id="1692621"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1692627">.</span><span class="ident" id="1692628">LoadInt32</span><span class="op" id="1692637">(</span><span class="op" id="1692638">&amp;</span><span class="ident" id="1692639"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692641">.</span><span class="ident" id="1692642">counter</span><span class="op" id="1692649">)</span>&nbsp;<span class="op" id="1692651">==</span>&nbsp;<span class="num" id="1692654">0</span>&nbsp;<span class="op" id="1692656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692660"><a href="/sync/waitgroup.go.html#1689574">atomic</a></span><span class="op" id="1692666">.</span><span class="ident" id="1692667">AddInt32</span><span class="op" id="1692675">(</span><span class="op" id="1692676">&amp;</span><span class="ident" id="1692677"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692679">.</span><span class="ident" id="1692680">waiters</span><span class="op" id="1692687">,</span>&nbsp;<span class="op" id="1692689">-</span><span class="num" id="1692690">1</span><span class="op" id="1692691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692695">if</span>&nbsp;<span class="ident" id="1692698"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1692710">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692715"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1692725">(</span><span class="op" id="1692726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692731"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1692742">(</span><span class="ident" id="1692743"><a href="/sync/waitgroup.go.html#1689589">unsafe</a></span><span class="op" id="1692749">.</span><span class="ident" id="1692750">Pointer</span><span class="op" id="1692757">(</span><span class="ident" id="1692758"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692760">)</span><span class="op" id="1692761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692766"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1692777">(</span><span class="op" id="1692778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692786"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1692788">.</span><span class="ident" id="1692789">m</span><span class="op" id="1692790">.</span><span class="ident" id="1692791">Unlock</span><span class="op" id="1692797">(</span><span class="op" id="1692798">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692802">if</span>&nbsp;<span class="ident" id="1692805"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1692817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692822"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1692832">(</span><span class="op" id="1692833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692849">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692852">if</span>&nbsp;<span class="ident" id="1692855"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1692867">&amp;&amp;</span>&nbsp;<span class="ident" id="1692870"><a href="/sync/waitgroup.go.html#1692360">w</a></span>&nbsp;<span class="op" id="1692872">==</span>&nbsp;<span class="num" id="1692875">1</span>&nbsp;<span class="op" id="1692877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692881">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692932">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693000">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693067">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693126"><a href="/sync/race0.go.html#1684273">raceWrite</a></span><span class="op" id="1693135">(</span><span class="ident" id="1693136"><a href="/sync/waitgroup.go.html#1689589">unsafe</a></span><span class="op" id="1693142">.</span><span class="ident" id="1693143">Pointer</span><span class="op" id="1693150">(</span><span class="op" id="1693151">&amp;</span><span class="ident" id="1693152"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1693154">.</span><span class="ident" id="1693155">sema</span><span class="op" id="1693159">)</span><span class="op" id="1693160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693166">if</span>&nbsp;<span class="ident" id="1693169"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1693171">.</span><span class="ident" id="1693172">sema</span>&nbsp;<span class="op" id="1693177">==</span>&nbsp;<span class="ident" id="1693180">nil</span>&nbsp;<span class="op" id="1693184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693188"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1693190">.</span><span class="ident" id="1693191">sema</span>&nbsp;<span class="op" id="1693196">=</span>&nbsp;<span class="builtinfunc" id="1693198">new</span><span class="op" id="1693201">(</span><span class="builtintype" id="1693202">uint32</span><span class="op" id="1693208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693211">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693214">s</span>&nbsp;<span class="op" id="1693216">:=</span>&nbsp;<span class="ident" id="1693219"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1693221">.</span><span class="ident" id="1693222">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693228"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1693230">.</span><span class="ident" id="1693231">m</span><span class="op" id="1693232">.</span><span class="ident" id="1693233">Unlock</span><span class="op" id="1693239">(</span><span class="op" id="1693240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693243"><a href="/sync/runtime.go.html#1684726">runtime_Semacquire</a></span><span class="op" id="1693261">(</span><span class="ident" id="1693262"><a href="/sync/waitgroup.go.html#1693214">s</a></span><span class="op" id="1693263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693266">if</span>&nbsp;<span class="ident" id="1693269"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1693281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693285"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1693295">(</span><span class="op" id="1693296">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693300"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1693311">(</span><span class="ident" id="1693312"><a href="/sync/waitgroup.go.html#1689589">unsafe</a></span><span class="op" id="1693318">.</span><span class="ident" id="1693319">Pointer</span><span class="op" id="1693326">(</span><span class="ident" id="1693327"><a href="/sync/waitgroup.go.html#1692114">wg</a></span><span class="op" id="1693329">)</span><span class="op" id="1693330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693333">}</span><br>
<span class="lineno"></span><span class="op" id="1693335">}</span>
</div>
</body>
</html>
