<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html" class="current">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3958533">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3958588">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3958642">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3958693">package</span>&nbsp;<span class="ident" id="3958701">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3958706">import</span>&nbsp;<span class="op" id="3958713">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958716">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958726">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958742">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958756">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958773">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958788">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958805">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958815">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3958822">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3958827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3958830">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3958906">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3958958">type</span>&nbsp;<span class="ident" id="3958963">serverHandshakeState</span>&nbsp;<span class="keyword" id="3958984">struct</span>&nbsp;<span class="op" id="3958991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3958994">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959010">*</span><span class="ident" id="3959011">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959017">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959033">*</span><span class="ident" id="3959034">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959050">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959066">*</span><span class="ident" id="3959067">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959083">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959099">*</span><span class="ident" id="3959100">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959113">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3959129">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959135">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3959151">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959157">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959173">*</span><span class="ident" id="3959174">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959188">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959204">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959218">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959234">[</span><span class="op" id="3959235">]</span><span class="builtintype" id="3959236">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959242">certsFromClient</span>&nbsp;<span class="op" id="3959258">[</span><span class="op" id="3959259">]</span><span class="op" id="3959260">[</span><span class="op" id="3959261">]</span><span class="builtintype" id="3959262">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959268">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959284">*</span><span class="ident" id="3959285">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3959297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3959300">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3959357">func</span>&nbsp;<span class="op" id="3959362">(</span><span class="ident" id="3959363">c</span>&nbsp;<span class="op" id="3959365">*</span><span class="ident" id="3959366">Conn</span><span class="op" id="3959370">)</span>&nbsp;<span class="ident" id="3959372">serverHandshake</span><span class="op" id="3959387">(</span><span class="op" id="3959388">)</span>&nbsp;<span class="builtintype" id="3959390">error</span>&nbsp;<span class="op" id="3959396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959399">config</span>&nbsp;<span class="op" id="3959406">:=</span>&nbsp;<span class="ident" id="3959409">c</span><span class="op" id="3959410">.</span><span class="ident" id="3959411">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3959420">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3959491">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959521">config</span><span class="op" id="3959527">.</span><span class="ident" id="3959528">serverInitOnce</span><span class="op" id="3959542">.</span><span class="ident" id="3959543">Do</span><span class="op" id="3959545">(</span><span class="ident" id="3959546">config</span><span class="op" id="3959552">.</span><span class="ident" id="3959553">serverInit</span><span class="op" id="3959563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959567">hs</span>&nbsp;<span class="op" id="3959570">:=</span>&nbsp;<span class="ident" id="3959573">serverHandshakeState</span><span class="op" id="3959593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959597">c</span><span class="op" id="3959598">:</span>&nbsp;<span class="ident" id="3959600">c</span><span class="op" id="3959601">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3959607">isResume</span><span class="op" id="3959615">,</span>&nbsp;<span class="ident" id="3959617">err</span>&nbsp;<span class="op" id="3959621">:=</span>&nbsp;<span class="ident" id="3959624">hs</span><span class="op" id="3959626">.</span><span class="ident" id="3959627">readClientHello</span><span class="op" id="3959642">(</span><span class="op" id="3959643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959646">if</span>&nbsp;<span class="ident" id="3959649">err</span>&nbsp;<span class="op" id="3959653">!=</span>&nbsp;<span class="ident" id="3959656">nil</span>&nbsp;<span class="op" id="3959660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959664">return</span>&nbsp;<span class="ident" id="3959671">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959676">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3959680">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959772">if</span>&nbsp;<span class="ident" id="3959775">isResume</span>&nbsp;<span class="op" id="3959784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3959788">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959873">if</span>&nbsp;<span class="ident" id="3959876">err</span>&nbsp;<span class="op" id="3959880">:=</span>&nbsp;<span class="ident" id="3959883">hs</span><span class="op" id="3959885">.</span><span class="ident" id="3959886">doResumeHandshake</span><span class="op" id="3959903">(</span><span class="op" id="3959904">)</span><span class="op" id="3959905">;</span>&nbsp;<span class="ident" id="3959907">err</span>&nbsp;<span class="op" id="3959911">!=</span>&nbsp;<span class="ident" id="3959914">nil</span>&nbsp;<span class="op" id="3959918">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959923">return</span>&nbsp;<span class="ident" id="3959930">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959940">if</span>&nbsp;<span class="ident" id="3959943">err</span>&nbsp;<span class="op" id="3959947">:=</span>&nbsp;<span class="ident" id="3959950">hs</span><span class="op" id="3959952">.</span><span class="ident" id="3959953">establishKeys</span><span class="op" id="3959966">(</span><span class="op" id="3959967">)</span><span class="op" id="3959968">;</span>&nbsp;<span class="ident" id="3959970">err</span>&nbsp;<span class="op" id="3959974">!=</span>&nbsp;<span class="ident" id="3959977">nil</span>&nbsp;<span class="op" id="3959981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3959986">return</span>&nbsp;<span class="ident" id="3959993">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3959999">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960003">if</span>&nbsp;<span class="ident" id="3960006">err</span>&nbsp;<span class="op" id="3960010">:=</span>&nbsp;<span class="ident" id="3960013">hs</span><span class="op" id="3960015">.</span><span class="ident" id="3960016">sendFinished</span><span class="op" id="3960028">(</span><span class="ident" id="3960029">c</span><span class="op" id="3960030">.</span><span class="ident" id="3960031">firstFinished</span><span class="op" id="3960044">[</span><span class="op" id="3960045">:</span><span class="op" id="3960046">]</span><span class="op" id="3960047">)</span><span class="op" id="3960048">;</span>&nbsp;<span class="ident" id="3960050">err</span>&nbsp;<span class="op" id="3960054">!=</span>&nbsp;<span class="ident" id="3960057">nil</span>&nbsp;<span class="op" id="3960061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960066">return</span>&nbsp;<span class="ident" id="3960073">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960083">if</span>&nbsp;<span class="ident" id="3960086">err</span>&nbsp;<span class="op" id="3960090">:=</span>&nbsp;<span class="ident" id="3960093">hs</span><span class="op" id="3960095">.</span><span class="ident" id="3960096">readFinished</span><span class="op" id="3960108">(</span><span class="ident" id="3960109">nil</span><span class="op" id="3960112">)</span><span class="op" id="3960113">;</span>&nbsp;<span class="ident" id="3960115">err</span>&nbsp;<span class="op" id="3960119">!=</span>&nbsp;<span class="ident" id="3960122">nil</span>&nbsp;<span class="op" id="3960126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960131">return</span>&nbsp;<span class="ident" id="3960138">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3960148">c</span><span class="op" id="3960149">.</span><span class="ident" id="3960150">didResume</span>&nbsp;<span class="op" id="3960160">=</span>&nbsp;<span class="builtintype" id="3960162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960168">}</span>&nbsp;<span class="keyword" id="3960170">else</span>&nbsp;<span class="op" id="3960175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3960179">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3960241">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960279">if</span>&nbsp;<span class="ident" id="3960282">err</span>&nbsp;<span class="op" id="3960286">:=</span>&nbsp;<span class="ident" id="3960289">hs</span><span class="op" id="3960291">.</span><span class="ident" id="3960292">doFullHandshake</span><span class="op" id="3960307">(</span><span class="op" id="3960308">)</span><span class="op" id="3960309">;</span>&nbsp;<span class="ident" id="3960311">err</span>&nbsp;<span class="op" id="3960315">!=</span>&nbsp;<span class="ident" id="3960318">nil</span>&nbsp;<span class="op" id="3960322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960327">return</span>&nbsp;<span class="ident" id="3960334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960344">if</span>&nbsp;<span class="ident" id="3960347">err</span>&nbsp;<span class="op" id="3960351">:=</span>&nbsp;<span class="ident" id="3960354">hs</span><span class="op" id="3960356">.</span><span class="ident" id="3960357">establishKeys</span><span class="op" id="3960370">(</span><span class="op" id="3960371">)</span><span class="op" id="3960372">;</span>&nbsp;<span class="ident" id="3960374">err</span>&nbsp;<span class="op" id="3960378">!=</span>&nbsp;<span class="ident" id="3960381">nil</span>&nbsp;<span class="op" id="3960385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960390">return</span>&nbsp;<span class="ident" id="3960397">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960407">if</span>&nbsp;<span class="ident" id="3960410">err</span>&nbsp;<span class="op" id="3960414">:=</span>&nbsp;<span class="ident" id="3960417">hs</span><span class="op" id="3960419">.</span><span class="ident" id="3960420">readFinished</span><span class="op" id="3960432">(</span><span class="ident" id="3960433">c</span><span class="op" id="3960434">.</span><span class="ident" id="3960435">firstFinished</span><span class="op" id="3960448">[</span><span class="op" id="3960449">:</span><span class="op" id="3960450">]</span><span class="op" id="3960451">)</span><span class="op" id="3960452">;</span>&nbsp;<span class="ident" id="3960454">err</span>&nbsp;<span class="op" id="3960458">!=</span>&nbsp;<span class="ident" id="3960461">nil</span>&nbsp;<span class="op" id="3960465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960470">return</span>&nbsp;<span class="ident" id="3960477">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960487">if</span>&nbsp;<span class="ident" id="3960490">err</span>&nbsp;<span class="op" id="3960494">:=</span>&nbsp;<span class="ident" id="3960497">hs</span><span class="op" id="3960499">.</span><span class="ident" id="3960500">sendSessionTicket</span><span class="op" id="3960517">(</span><span class="op" id="3960518">)</span><span class="op" id="3960519">;</span>&nbsp;<span class="ident" id="3960521">err</span>&nbsp;<span class="op" id="3960525">!=</span>&nbsp;<span class="ident" id="3960528">nil</span>&nbsp;<span class="op" id="3960532">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960537">return</span>&nbsp;<span class="ident" id="3960544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960554">if</span>&nbsp;<span class="ident" id="3960557">err</span>&nbsp;<span class="op" id="3960561">:=</span>&nbsp;<span class="ident" id="3960564">hs</span><span class="op" id="3960566">.</span><span class="ident" id="3960567">sendFinished</span><span class="op" id="3960579">(</span><span class="ident" id="3960580">nil</span><span class="op" id="3960583">)</span><span class="op" id="3960584">;</span>&nbsp;<span class="ident" id="3960586">err</span>&nbsp;<span class="op" id="3960590">!=</span>&nbsp;<span class="ident" id="3960593">nil</span>&nbsp;<span class="op" id="3960597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960602">return</span>&nbsp;<span class="ident" id="3960609">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960615">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3960621">c</span><span class="op" id="3960622">.</span><span class="ident" id="3960623">handshakeComplete</span>&nbsp;<span class="op" id="3960641">=</span>&nbsp;<span class="builtintype" id="3960643">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960650">return</span>&nbsp;<span class="ident" id="3960657">nil</span><br>
<span class="lineno"></span><span class="op" id="3960661">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3960664">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3960739">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3960786">func</span>&nbsp;<span class="op" id="3960791">(</span><span class="ident" id="3960792">hs</span>&nbsp;<span class="op" id="3960795">*</span><span class="ident" id="3960796">serverHandshakeState</span><span class="op" id="3960816">)</span>&nbsp;<span class="ident" id="3960818">readClientHello</span><span class="op" id="3960833">(</span><span class="op" id="3960834">)</span>&nbsp;<span class="op" id="3960836">(</span><span class="ident" id="3960837">isResume</span>&nbsp;<span class="builtintype" id="3960846">bool</span><span class="op" id="3960850">,</span>&nbsp;<span class="ident" id="3960852">err</span>&nbsp;<span class="builtintype" id="3960856">error</span><span class="op" id="3960861">)</span>&nbsp;<span class="op" id="3960863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3960866">config</span>&nbsp;<span class="op" id="3960873">:=</span>&nbsp;<span class="ident" id="3960876">hs</span><span class="op" id="3960878">.</span><span class="ident" id="3960879">c</span><span class="op" id="3960880">.</span><span class="ident" id="3960881">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3960889">c</span>&nbsp;<span class="op" id="3960891">:=</span>&nbsp;<span class="ident" id="3960894">hs</span><span class="op" id="3960896">.</span><span class="ident" id="3960897">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3960901">msg</span><span class="op" id="3960904">,</span>&nbsp;<span class="ident" id="3960906">err</span>&nbsp;<span class="op" id="3960910">:=</span>&nbsp;<span class="ident" id="3960913">c</span><span class="op" id="3960914">.</span><span class="ident" id="3960915">readHandshake</span><span class="op" id="3960928">(</span><span class="op" id="3960929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960932">if</span>&nbsp;<span class="ident" id="3960935">err</span>&nbsp;<span class="op" id="3960939">!=</span>&nbsp;<span class="ident" id="3960942">nil</span>&nbsp;<span class="op" id="3960946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960950">return</span>&nbsp;<span class="builtintype" id="3960957">false</span><span class="op" id="3960962">,</span>&nbsp;<span class="ident" id="3960964">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3960969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3960972">var</span>&nbsp;<span class="ident" id="3960976">ok</span>&nbsp;<span class="builtintype" id="3960979">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3960985">hs</span><span class="op" id="3960987">.</span><span class="ident" id="3960988">clientHello</span><span class="op" id="3960999">,</span>&nbsp;<span class="ident" id="3961001">ok</span>&nbsp;<span class="op" id="3961004">=</span>&nbsp;<span class="ident" id="3961006">msg</span><span class="op" id="3961009">.</span><span class="op" id="3961010">(</span><span class="op" id="3961011">*</span><span class="ident" id="3961012">clientHelloMsg</span><span class="op" id="3961026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961029">if</span>&nbsp;<span class="op" id="3961032">!</span><span class="ident" id="3961033">ok</span>&nbsp;<span class="op" id="3961036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961040">c</span><span class="op" id="3961041">.</span><span class="ident" id="3961042">sendAlert</span><span class="op" id="3961051">(</span><span class="ident" id="3961052">alertUnexpectedMessage</span><span class="op" id="3961074">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961078">return</span>&nbsp;<span class="builtintype" id="3961085">false</span><span class="op" id="3961090">,</span>&nbsp;<span class="ident" id="3961092">unexpectedMessageError</span><span class="op" id="3961114">(</span><span class="ident" id="3961115">hs</span><span class="op" id="3961117">.</span><span class="ident" id="3961118">clientHello</span><span class="op" id="3961129">,</span>&nbsp;<span class="ident" id="3961131">msg</span><span class="op" id="3961134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961140">c</span><span class="op" id="3961141">.</span><span class="ident" id="3961142">vers</span><span class="op" id="3961146">,</span>&nbsp;<span class="ident" id="3961148">ok</span>&nbsp;<span class="op" id="3961151">=</span>&nbsp;<span class="ident" id="3961153">config</span><span class="op" id="3961159">.</span><span class="ident" id="3961160">mutualVersion</span><span class="op" id="3961173">(</span><span class="ident" id="3961174">hs</span><span class="op" id="3961176">.</span><span class="ident" id="3961177">clientHello</span><span class="op" id="3961188">.</span><span class="ident" id="3961189">vers</span><span class="op" id="3961193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961196">if</span>&nbsp;<span class="op" id="3961199">!</span><span class="ident" id="3961200">ok</span>&nbsp;<span class="op" id="3961203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961207">c</span><span class="op" id="3961208">.</span><span class="ident" id="3961209">sendAlert</span><span class="op" id="3961218">(</span><span class="ident" id="3961219">alertProtocolVersion</span><span class="op" id="3961239">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961243">return</span>&nbsp;<span class="builtintype" id="3961250">false</span><span class="op" id="3961255">,</span>&nbsp;<span class="ident" id="3961257">fmt</span><span class="op" id="3961260">.</span><span class="ident" id="3961261">Errorf</span><span class="op" id="3961267">(</span><span class="string" id="3961268">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3961336">,</span>&nbsp;<span class="ident" id="3961338">hs</span><span class="op" id="3961340">.</span><span class="ident" id="3961341">clientHello</span><span class="op" id="3961352">.</span><span class="ident" id="3961353">vers</span><span class="op" id="3961357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961363">c</span><span class="op" id="3961364">.</span><span class="ident" id="3961365">haveVers</span>&nbsp;<span class="op" id="3961374">=</span>&nbsp;<span class="builtintype" id="3961376">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961383">hs</span><span class="op" id="3961385">.</span><span class="ident" id="3961386">finishedHash</span>&nbsp;<span class="op" id="3961399">=</span>&nbsp;<span class="ident" id="3961401">newFinishedHash</span><span class="op" id="3961416">(</span><span class="ident" id="3961417">c</span><span class="op" id="3961418">.</span><span class="ident" id="3961419">vers</span><span class="op" id="3961423">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961426">hs</span><span class="op" id="3961428">.</span><span class="ident" id="3961429">finishedHash</span><span class="op" id="3961441">.</span><span class="ident" id="3961442">Write</span><span class="op" id="3961447">(</span><span class="ident" id="3961448">hs</span><span class="op" id="3961450">.</span><span class="ident" id="3961451">clientHello</span><span class="op" id="3961462">.</span><span class="ident" id="3961463">marshal</span><span class="op" id="3961470">(</span><span class="op" id="3961471">)</span><span class="op" id="3961472">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961476">hs</span><span class="op" id="3961478">.</span><span class="ident" id="3961479">hello</span>&nbsp;<span class="op" id="3961485">=</span>&nbsp;<span class="builtinfunc" id="3961487">new</span><span class="op" id="3961490">(</span><span class="ident" id="3961491">serverHelloMsg</span><span class="op" id="3961505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961509">supportedCurve</span>&nbsp;<span class="op" id="3961524">:=</span>&nbsp;<span class="builtintype" id="3961527">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961534">preferredCurves</span>&nbsp;<span class="op" id="3961550">:=</span>&nbsp;<span class="ident" id="3961553">config</span><span class="op" id="3961559">.</span><span class="ident" id="3961560">curvePreferences</span><span class="op" id="3961576">(</span><span class="op" id="3961577">)</span><br>
<span class="lineno"></span><span class="ident" id="3961579">Curves</span><span class="op" id="3961585">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961588">for</span>&nbsp;<span class="ident" id="3961592">_</span><span class="op" id="3961593">,</span>&nbsp;<span class="ident" id="3961595">curve</span>&nbsp;<span class="op" id="3961601">:=</span>&nbsp;<span class="keyword" id="3961604">range</span>&nbsp;<span class="ident" id="3961610">hs</span><span class="op" id="3961612">.</span><span class="ident" id="3961613">clientHello</span><span class="op" id="3961624">.</span><span class="ident" id="3961625">supportedCurves</span>&nbsp;<span class="op" id="3961641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961645">for</span>&nbsp;<span class="ident" id="3961649">_</span><span class="op" id="3961650">,</span>&nbsp;<span class="ident" id="3961652">supported</span>&nbsp;<span class="op" id="3961662">:=</span>&nbsp;<span class="keyword" id="3961665">range</span>&nbsp;<span class="ident" id="3961671">preferredCurves</span>&nbsp;<span class="op" id="3961687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961692">if</span>&nbsp;<span class="ident" id="3961695">supported</span>&nbsp;<span class="op" id="3961705">==</span>&nbsp;<span class="ident" id="3961708">curve</span>&nbsp;<span class="op" id="3961714">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961720">supportedCurve</span>&nbsp;<span class="op" id="3961735">=</span>&nbsp;<span class="builtintype" id="3961737">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961746">break</span>&nbsp;<span class="ident" id="3961752">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961769">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961773">supportedPointFormat</span>&nbsp;<span class="op" id="3961794">:=</span>&nbsp;<span class="builtintype" id="3961797">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961804">for</span>&nbsp;<span class="ident" id="3961808">_</span><span class="op" id="3961809">,</span>&nbsp;<span class="ident" id="3961811">pointFormat</span>&nbsp;<span class="op" id="3961823">:=</span>&nbsp;<span class="keyword" id="3961826">range</span>&nbsp;<span class="ident" id="3961832">hs</span><span class="op" id="3961834">.</span><span class="ident" id="3961835">clientHello</span><span class="op" id="3961846">.</span><span class="ident" id="3961847">supportedPoints</span>&nbsp;<span class="op" id="3961863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961867">if</span>&nbsp;<span class="ident" id="3961870">pointFormat</span>&nbsp;<span class="op" id="3961882">==</span>&nbsp;<span class="ident" id="3961885">pointFormatUncompressed</span>&nbsp;<span class="op" id="3961909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961914">supportedPointFormat</span>&nbsp;<span class="op" id="3961935">=</span>&nbsp;<span class="builtintype" id="3961937">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3961945">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3961956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3961959">hs</span><span class="op" id="3961961">.</span><span class="ident" id="3961962">ellipticOk</span>&nbsp;<span class="op" id="3961973">=</span>&nbsp;<span class="ident" id="3961975">supportedCurve</span>&nbsp;<span class="op" id="3961990">&amp;&amp;</span>&nbsp;<span class="ident" id="3961993">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962016">foundCompression</span>&nbsp;<span class="op" id="3962033">:=</span>&nbsp;<span class="builtintype" id="3962036">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3962043">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962118">for</span>&nbsp;<span class="ident" id="3962122">_</span><span class="op" id="3962123">,</span>&nbsp;<span class="ident" id="3962125">compression</span>&nbsp;<span class="op" id="3962137">:=</span>&nbsp;<span class="keyword" id="3962140">range</span>&nbsp;<span class="ident" id="3962146">hs</span><span class="op" id="3962148">.</span><span class="ident" id="3962149">clientHello</span><span class="op" id="3962160">.</span><span class="ident" id="3962161">compressionMethods</span>&nbsp;<span class="op" id="3962180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962184">if</span>&nbsp;<span class="ident" id="3962187">compression</span>&nbsp;<span class="op" id="3962199">==</span>&nbsp;<span class="ident" id="3962202">compressionNone</span>&nbsp;<span class="op" id="3962218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962223">foundCompression</span>&nbsp;<span class="op" id="3962240">=</span>&nbsp;<span class="builtintype" id="3962242">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962250">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3962258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3962261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962265">if</span>&nbsp;<span class="op" id="3962268">!</span><span class="ident" id="3962269">foundCompression</span>&nbsp;<span class="op" id="3962286">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962290">c</span><span class="op" id="3962291">.</span><span class="ident" id="3962292">sendAlert</span><span class="op" id="3962301">(</span><span class="ident" id="3962302">alertHandshakeFailure</span><span class="op" id="3962323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962327">return</span>&nbsp;<span class="builtintype" id="3962334">false</span><span class="op" id="3962339">,</span>&nbsp;<span class="ident" id="3962341">errors</span><span class="op" id="3962347">.</span><span class="ident" id="3962348">New</span><span class="op" id="3962351">(</span><span class="string" id="3962352">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3962407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3962410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962414">hs</span><span class="op" id="3962416">.</span><span class="ident" id="3962417">hello</span><span class="op" id="3962422">.</span><span class="ident" id="3962423">vers</span>&nbsp;<span class="op" id="3962428">=</span>&nbsp;<span class="ident" id="3962430">c</span><span class="op" id="3962431">.</span><span class="ident" id="3962432">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962438">hs</span><span class="op" id="3962440">.</span><span class="ident" id="3962441">hello</span><span class="op" id="3962446">.</span><span class="ident" id="3962447">random</span>&nbsp;<span class="op" id="3962454">=</span>&nbsp;<span class="builtinfunc" id="3962456">make</span><span class="op" id="3962460">(</span><span class="op" id="3962461">[</span><span class="op" id="3962462">]</span><span class="builtintype" id="3962463">byte</span><span class="op" id="3962467">,</span>&nbsp;<span class="num" id="3962469">32</span><span class="op" id="3962471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962474">_</span><span class="op" id="3962475">,</span>&nbsp;<span class="ident" id="3962477">err</span>&nbsp;<span class="op" id="3962481">=</span>&nbsp;<span class="ident" id="3962483">io</span><span class="op" id="3962485">.</span><span class="ident" id="3962486">ReadFull</span><span class="op" id="3962494">(</span><span class="ident" id="3962495">config</span><span class="op" id="3962501">.</span><span class="ident" id="3962502">rand</span><span class="op" id="3962506">(</span><span class="op" id="3962507">)</span><span class="op" id="3962508">,</span>&nbsp;<span class="ident" id="3962510">hs</span><span class="op" id="3962512">.</span><span class="ident" id="3962513">hello</span><span class="op" id="3962518">.</span><span class="ident" id="3962519">random</span><span class="op" id="3962525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962528">if</span>&nbsp;<span class="ident" id="3962531">err</span>&nbsp;<span class="op" id="3962535">!=</span>&nbsp;<span class="ident" id="3962538">nil</span>&nbsp;<span class="op" id="3962542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962546">c</span><span class="op" id="3962547">.</span><span class="ident" id="3962548">sendAlert</span><span class="op" id="3962557">(</span><span class="ident" id="3962558">alertInternalError</span><span class="op" id="3962576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962580">return</span>&nbsp;<span class="builtintype" id="3962587">false</span><span class="op" id="3962592">,</span>&nbsp;<span class="ident" id="3962594">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3962599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962602">hs</span><span class="op" id="3962604">.</span><span class="ident" id="3962605">hello</span><span class="op" id="3962610">.</span><span class="ident" id="3962611">secureRenegotiation</span>&nbsp;<span class="op" id="3962631">=</span>&nbsp;<span class="ident" id="3962633">hs</span><span class="op" id="3962635">.</span><span class="ident" id="3962636">clientHello</span><span class="op" id="3962647">.</span><span class="ident" id="3962648">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962669">hs</span><span class="op" id="3962671">.</span><span class="ident" id="3962672">hello</span><span class="op" id="3962677">.</span><span class="ident" id="3962678">compressionMethod</span>&nbsp;<span class="op" id="3962696">=</span>&nbsp;<span class="ident" id="3962698">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962715">if</span>&nbsp;<span class="builtinfunc" id="3962718">len</span><span class="op" id="3962721">(</span><span class="ident" id="3962722">hs</span><span class="op" id="3962724">.</span><span class="ident" id="3962725">clientHello</span><span class="op" id="3962736">.</span><span class="ident" id="3962737">serverName</span><span class="op" id="3962747">)</span>&nbsp;<span class="op" id="3962749">&gt;</span>&nbsp;<span class="num" id="3962751">0</span>&nbsp;<span class="op" id="3962753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962757">c</span><span class="op" id="3962758">.</span><span class="ident" id="3962759">serverName</span>&nbsp;<span class="op" id="3962770">=</span>&nbsp;<span class="ident" id="3962772">hs</span><span class="op" id="3962774">.</span><span class="ident" id="3962775">clientHello</span><span class="op" id="3962786">.</span><span class="ident" id="3962787">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3962799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962803">if</span>&nbsp;<span class="builtinfunc" id="3962806">len</span><span class="op" id="3962809">(</span><span class="ident" id="3962810">hs</span><span class="op" id="3962812">.</span><span class="ident" id="3962813">clientHello</span><span class="op" id="3962824">.</span><span class="ident" id="3962825">alpnProtocols</span><span class="op" id="3962838">)</span>&nbsp;<span class="op" id="3962840">&gt;</span>&nbsp;<span class="num" id="3962842">0</span>&nbsp;<span class="op" id="3962844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962848">if</span>&nbsp;<span class="ident" id="3962851">selectedProto</span><span class="op" id="3962864">,</span>&nbsp;<span class="ident" id="3962866">fallback</span>&nbsp;<span class="op" id="3962875">:=</span>&nbsp;<span class="ident" id="3962878">mutualProtocol</span><span class="op" id="3962892">(</span><span class="ident" id="3962893">hs</span><span class="op" id="3962895">.</span><span class="ident" id="3962896">clientHello</span><span class="op" id="3962907">.</span><span class="ident" id="3962908">alpnProtocols</span><span class="op" id="3962921">,</span>&nbsp;<span class="ident" id="3962923">c</span><span class="op" id="3962924">.</span><span class="ident" id="3962925">config</span><span class="op" id="3962931">.</span><span class="ident" id="3962932">NextProtos</span><span class="op" id="3962942">)</span><span class="op" id="3962943">;</span>&nbsp;<span class="op" id="3962945">!</span><span class="ident" id="3962946">fallback</span>&nbsp;<span class="op" id="3962955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962960">hs</span><span class="op" id="3962962">.</span><span class="ident" id="3962963">hello</span><span class="op" id="3962968">.</span><span class="ident" id="3962969">alpnProtocol</span>&nbsp;<span class="op" id="3962982">=</span>&nbsp;<span class="ident" id="3962984">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963001">c</span><span class="op" id="3963002">.</span><span class="ident" id="3963003">clientProtocol</span>&nbsp;<span class="op" id="3963018">=</span>&nbsp;<span class="ident" id="3963020">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963039">}</span>&nbsp;<span class="keyword" id="3963041">else</span>&nbsp;<span class="op" id="3963046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3963050">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3963122">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3963181">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3963218">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3963275">if</span>&nbsp;<span class="ident" id="3963278">hs</span><span class="op" id="3963280">.</span><span class="ident" id="3963281">clientHello</span><span class="op" id="3963292">.</span><span class="ident" id="3963293">nextProtoNeg</span>&nbsp;<span class="op" id="3963306">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3963309">len</span><span class="op" id="3963312">(</span><span class="ident" id="3963313">config</span><span class="op" id="3963319">.</span><span class="ident" id="3963320">NextProtos</span><span class="op" id="3963330">)</span>&nbsp;<span class="op" id="3963332">&gt;</span>&nbsp;<span class="num" id="3963334">0</span>&nbsp;<span class="op" id="3963336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963341">hs</span><span class="op" id="3963343">.</span><span class="ident" id="3963344">hello</span><span class="op" id="3963349">.</span><span class="ident" id="3963350">nextProtoNeg</span>&nbsp;<span class="op" id="3963363">=</span>&nbsp;<span class="builtintype" id="3963365">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963373">hs</span><span class="op" id="3963375">.</span><span class="ident" id="3963376">hello</span><span class="op" id="3963381">.</span><span class="ident" id="3963382">nextProtos</span>&nbsp;<span class="op" id="3963393">=</span>&nbsp;<span class="ident" id="3963395">config</span><span class="op" id="3963401">.</span><span class="ident" id="3963402">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3963422">if</span>&nbsp;<span class="builtinfunc" id="3963425">len</span><span class="op" id="3963428">(</span><span class="ident" id="3963429">config</span><span class="op" id="3963435">.</span><span class="ident" id="3963436">Certificates</span><span class="op" id="3963448">)</span>&nbsp;<span class="op" id="3963450">==</span>&nbsp;<span class="num" id="3963453">0</span>&nbsp;<span class="op" id="3963455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963459">c</span><span class="op" id="3963460">.</span><span class="ident" id="3963461">sendAlert</span><span class="op" id="3963470">(</span><span class="ident" id="3963471">alertInternalError</span><span class="op" id="3963489">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3963493">return</span>&nbsp;<span class="builtintype" id="3963500">false</span><span class="op" id="3963505">,</span>&nbsp;<span class="ident" id="3963507">errors</span><span class="op" id="3963513">.</span><span class="ident" id="3963514">New</span><span class="op" id="3963517">(</span><span class="string" id="3963518">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3963551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963557">hs</span><span class="op" id="3963559">.</span><span class="ident" id="3963560">cert</span>&nbsp;<span class="op" id="3963565">=</span>&nbsp;<span class="op" id="3963567">&amp;</span><span class="ident" id="3963568">config</span><span class="op" id="3963574">.</span><span class="ident" id="3963575">Certificates</span><span class="op" id="3963587">[</span><span class="num" id="3963588">0</span><span class="op" id="3963589">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3963592">if</span>&nbsp;<span class="builtinfunc" id="3963595">len</span><span class="op" id="3963598">(</span><span class="ident" id="3963599">hs</span><span class="op" id="3963601">.</span><span class="ident" id="3963602">clientHello</span><span class="op" id="3963613">.</span><span class="ident" id="3963614">serverName</span><span class="op" id="3963624">)</span>&nbsp;<span class="op" id="3963626">&gt;</span>&nbsp;<span class="num" id="3963628">0</span>&nbsp;<span class="op" id="3963630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963634">chi</span>&nbsp;<span class="op" id="3963638">:=</span>&nbsp;<span class="op" id="3963641">&amp;</span><span class="ident" id="3963642">ClientHelloInfo</span><span class="op" id="3963657">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963662">CipherSuites</span><span class="op" id="3963674">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963679">hs</span><span class="op" id="3963681">.</span><span class="ident" id="3963682">clientHello</span><span class="op" id="3963693">.</span><span class="ident" id="3963694">cipherSuites</span><span class="op" id="3963706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963711">ServerName</span><span class="op" id="3963721">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963728">hs</span><span class="op" id="3963730">.</span><span class="ident" id="3963731">clientHello</span><span class="op" id="3963742">.</span><span class="ident" id="3963743">serverName</span><span class="op" id="3963753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963758">SupportedCurves</span><span class="op" id="3963773">:</span>&nbsp;<span class="ident" id="3963775">hs</span><span class="op" id="3963777">.</span><span class="ident" id="3963778">clientHello</span><span class="op" id="3963789">.</span><span class="ident" id="3963790">supportedCurves</span><span class="op" id="3963805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963810">SupportedPoints</span><span class="op" id="3963825">:</span>&nbsp;<span class="ident" id="3963827">hs</span><span class="op" id="3963829">.</span><span class="ident" id="3963830">clientHello</span><span class="op" id="3963841">.</span><span class="ident" id="3963842">supportedPoints</span><span class="op" id="3963857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963861">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3963865">if</span>&nbsp;<span class="ident" id="3963868">hs</span><span class="op" id="3963870">.</span><span class="ident" id="3963871">cert</span><span class="op" id="3963875">,</span>&nbsp;<span class="ident" id="3963877">err</span>&nbsp;<span class="op" id="3963881">=</span>&nbsp;<span class="ident" id="3963883">config</span><span class="op" id="3963889">.</span><span class="ident" id="3963890">getCertificate</span><span class="op" id="3963904">(</span><span class="ident" id="3963905">chi</span><span class="op" id="3963908">)</span><span class="op" id="3963909">;</span>&nbsp;<span class="ident" id="3963911">err</span>&nbsp;<span class="op" id="3963915">!=</span>&nbsp;<span class="ident" id="3963918">nil</span>&nbsp;<span class="op" id="3963922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963927">c</span><span class="op" id="3963928">.</span><span class="ident" id="3963929">sendAlert</span><span class="op" id="3963938">(</span><span class="ident" id="3963939">alertInternalError</span><span class="op" id="3963957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3963962">return</span>&nbsp;<span class="builtintype" id="3963969">false</span><span class="op" id="3963974">,</span>&nbsp;<span class="ident" id="3963976">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3963985">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3963989">_</span><span class="op" id="3963990">,</span>&nbsp;<span class="ident" id="3963992">hs</span><span class="op" id="3963994">.</span><span class="ident" id="3963995">ecdsaOk</span>&nbsp;<span class="op" id="3964003">=</span>&nbsp;<span class="ident" id="3964005">hs</span><span class="op" id="3964007">.</span><span class="ident" id="3964008">cert</span><span class="op" id="3964012">.</span><span class="ident" id="3964013">PrivateKey</span><span class="op" id="3964023">.</span><span class="op" id="3964024">(</span><span class="op" id="3964025">*</span><span class="ident" id="3964026">ecdsa</span><span class="op" id="3964031">.</span><span class="ident" id="3964032">PrivateKey</span><span class="op" id="3964042">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964046">if</span>&nbsp;<span class="ident" id="3964049">hs</span><span class="op" id="3964051">.</span><span class="ident" id="3964052">checkForResumption</span><span class="op" id="3964070">(</span><span class="op" id="3964071">)</span>&nbsp;<span class="op" id="3964073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964077">return</span>&nbsp;<span class="builtintype" id="3964084">true</span><span class="op" id="3964088">,</span>&nbsp;<span class="ident" id="3964090">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3964095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964099">var</span>&nbsp;<span class="ident" id="3964103">preferenceList</span><span class="op" id="3964117">,</span>&nbsp;<span class="ident" id="3964119">supportedList</span>&nbsp;<span class="op" id="3964133">[</span><span class="op" id="3964134">]</span><span class="builtintype" id="3964135">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964143">if</span>&nbsp;<span class="ident" id="3964146">c</span><span class="op" id="3964147">.</span><span class="ident" id="3964148">config</span><span class="op" id="3964154">.</span><span class="ident" id="3964155">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3964180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3964184">preferenceList</span>&nbsp;<span class="op" id="3964199">=</span>&nbsp;<span class="ident" id="3964201">c</span><span class="op" id="3964202">.</span><span class="ident" id="3964203">config</span><span class="op" id="3964209">.</span><span class="ident" id="3964210">cipherSuites</span><span class="op" id="3964222">(</span><span class="op" id="3964223">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3964227">supportedList</span>&nbsp;<span class="op" id="3964241">=</span>&nbsp;<span class="ident" id="3964243">hs</span><span class="op" id="3964245">.</span><span class="ident" id="3964246">clientHello</span><span class="op" id="3964257">.</span><span class="ident" id="3964258">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3964272">}</span>&nbsp;<span class="keyword" id="3964274">else</span>&nbsp;<span class="op" id="3964279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3964283">preferenceList</span>&nbsp;<span class="op" id="3964298">=</span>&nbsp;<span class="ident" id="3964300">hs</span><span class="op" id="3964302">.</span><span class="ident" id="3964303">clientHello</span><span class="op" id="3964314">.</span><span class="ident" id="3964315">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3964330">supportedList</span>&nbsp;<span class="op" id="3964344">=</span>&nbsp;<span class="ident" id="3964346">c</span><span class="op" id="3964347">.</span><span class="ident" id="3964348">config</span><span class="op" id="3964354">.</span><span class="ident" id="3964355">cipherSuites</span><span class="op" id="3964367">(</span><span class="op" id="3964368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3964371">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964375">for</span>&nbsp;<span class="ident" id="3964379">_</span><span class="op" id="3964380">,</span>&nbsp;<span class="ident" id="3964382">id</span>&nbsp;<span class="op" id="3964385">:=</span>&nbsp;<span class="keyword" id="3964388">range</span>&nbsp;<span class="ident" id="3964394">preferenceList</span>&nbsp;<span class="op" id="3964409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964413">if</span>&nbsp;<span class="ident" id="3964416">hs</span><span class="op" id="3964418">.</span><span class="ident" id="3964419">suite</span>&nbsp;<span class="op" id="3964425">=</span>&nbsp;<span class="ident" id="3964427">c</span><span class="op" id="3964428">.</span><span class="ident" id="3964429">tryCipherSuite</span><span class="op" id="3964443">(</span><span class="ident" id="3964444">id</span><span class="op" id="3964446">,</span>&nbsp;<span class="ident" id="3964448">supportedList</span><span class="op" id="3964461">,</span>&nbsp;<span class="ident" id="3964463">c</span><span class="op" id="3964464">.</span><span class="ident" id="3964465">vers</span><span class="op" id="3964469">,</span>&nbsp;<span class="ident" id="3964471">hs</span><span class="op" id="3964473">.</span><span class="ident" id="3964474">ellipticOk</span><span class="op" id="3964484">,</span>&nbsp;<span class="ident" id="3964486">hs</span><span class="op" id="3964488">.</span><span class="ident" id="3964489">ecdsaOk</span><span class="op" id="3964496">)</span><span class="op" id="3964497">;</span>&nbsp;<span class="ident" id="3964499">hs</span><span class="op" id="3964501">.</span><span class="ident" id="3964502">suite</span>&nbsp;<span class="op" id="3964508">!=</span>&nbsp;<span class="ident" id="3964511">nil</span>&nbsp;<span class="op" id="3964515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964520">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3964528">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3964531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964535">if</span>&nbsp;<span class="ident" id="3964538">hs</span><span class="op" id="3964540">.</span><span class="ident" id="3964541">suite</span>&nbsp;<span class="op" id="3964547">==</span>&nbsp;<span class="ident" id="3964550">nil</span>&nbsp;<span class="op" id="3964554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3964558">c</span><span class="op" id="3964559">.</span><span class="ident" id="3964560">sendAlert</span><span class="op" id="3964569">(</span><span class="ident" id="3964570">alertHandshakeFailure</span><span class="op" id="3964591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964595">return</span>&nbsp;<span class="builtintype" id="3964602">false</span><span class="op" id="3964607">,</span>&nbsp;<span class="ident" id="3964609">errors</span><span class="op" id="3964615">.</span><span class="ident" id="3964616">New</span><span class="op" id="3964619">(</span><span class="string" id="3964620">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3964678">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3964681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3964685">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964755">for</span>&nbsp;<span class="ident" id="3964759">_</span><span class="op" id="3964760">,</span>&nbsp;<span class="ident" id="3964762">id</span>&nbsp;<span class="op" id="3964765">:=</span>&nbsp;<span class="keyword" id="3964768">range</span>&nbsp;<span class="ident" id="3964774">hs</span><span class="op" id="3964776">.</span><span class="ident" id="3964777">clientHello</span><span class="op" id="3964788">.</span><span class="ident" id="3964789">cipherSuites</span>&nbsp;<span class="op" id="3964802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964806">if</span>&nbsp;<span class="ident" id="3964809">id</span>&nbsp;<span class="op" id="3964812">==</span>&nbsp;<span class="ident" id="3964815">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="3964833">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3964838">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964887">if</span>&nbsp;<span class="ident" id="3964890">hs</span><span class="op" id="3964892">.</span><span class="ident" id="3964893">clientHello</span><span class="op" id="3964904">.</span><span class="ident" id="3964905">vers</span>&nbsp;<span class="op" id="3964910">&lt;</span>&nbsp;<span class="ident" id="3964912">c</span><span class="op" id="3964913">.</span><span class="ident" id="3964914">config</span><span class="op" id="3964920">.</span><span class="ident" id="3964921">MaxVersion</span>&nbsp;<span class="op" id="3964932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3964938">c</span><span class="op" id="3964939">.</span><span class="ident" id="3964940">sendAlert</span><span class="op" id="3964949">(</span><span class="ident" id="3964950">alertInappropriateFallback</span><span class="op" id="3964976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3964982">return</span>&nbsp;<span class="builtintype" id="3964989">false</span><span class="op" id="3964994">,</span>&nbsp;<span class="ident" id="3964996">errors</span><span class="op" id="3965002">.</span><span class="ident" id="3965003">New</span><span class="op" id="3965006">(</span><span class="string" id="3965007">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3965057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965062">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965067">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965082">return</span>&nbsp;<span class="builtintype" id="3965089">false</span><span class="op" id="3965094">,</span>&nbsp;<span class="ident" id="3965096">nil</span><br>
<span class="lineno">240</span><span class="op" id="3965100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3965103">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3965190">func</span>&nbsp;<span class="op" id="3965195">(</span><span class="ident" id="3965196">hs</span>&nbsp;<span class="op" id="3965199">*</span><span class="ident" id="3965200">serverHandshakeState</span><span class="op" id="3965220">)</span>&nbsp;<span class="ident" id="3965222">checkForResumption</span><span class="op" id="3965240">(</span><span class="op" id="3965241">)</span>&nbsp;<span class="builtintype" id="3965243">bool</span>&nbsp;<span class="op" id="3965248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3965251">c</span>&nbsp;<span class="op" id="3965253">:=</span>&nbsp;<span class="ident" id="3965256">hs</span><span class="op" id="3965258">.</span><span class="ident" id="3965259">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965263">if</span>&nbsp;<span class="ident" id="3965266">c</span><span class="op" id="3965267">.</span><span class="ident" id="3965268">config</span><span class="op" id="3965274">.</span><span class="ident" id="3965275">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3965298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965302">return</span>&nbsp;<span class="builtintype" id="3965309">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965320">var</span>&nbsp;<span class="ident" id="3965324">ok</span>&nbsp;<span class="builtintype" id="3965327">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965333">if</span>&nbsp;<span class="ident" id="3965336">hs</span><span class="op" id="3965338">.</span><span class="ident" id="3965339">sessionState</span><span class="op" id="3965351">,</span>&nbsp;<span class="ident" id="3965353">ok</span>&nbsp;<span class="op" id="3965356">=</span>&nbsp;<span class="ident" id="3965358">c</span><span class="op" id="3965359">.</span><span class="ident" id="3965360">decryptTicket</span><span class="op" id="3965373">(</span><span class="ident" id="3965374">hs</span><span class="op" id="3965376">.</span><span class="ident" id="3965377">clientHello</span><span class="op" id="3965388">.</span><span class="ident" id="3965389">sessionTicket</span><span class="op" id="3965402">)</span><span class="op" id="3965403">;</span>&nbsp;<span class="op" id="3965405">!</span><span class="ident" id="3965406">ok</span>&nbsp;<span class="op" id="3965409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965413">return</span>&nbsp;<span class="builtintype" id="3965420">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965431">if</span>&nbsp;<span class="ident" id="3965434">hs</span><span class="op" id="3965436">.</span><span class="ident" id="3965437">sessionState</span><span class="op" id="3965449">.</span><span class="ident" id="3965450">vers</span>&nbsp;<span class="op" id="3965455">&gt;</span>&nbsp;<span class="ident" id="3965457">hs</span><span class="op" id="3965459">.</span><span class="ident" id="3965460">clientHello</span><span class="op" id="3965471">.</span><span class="ident" id="3965472">vers</span>&nbsp;<span class="op" id="3965477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965481">return</span>&nbsp;<span class="builtintype" id="3965488">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965498">if</span>&nbsp;<span class="ident" id="3965501">vers</span><span class="op" id="3965505">,</span>&nbsp;<span class="ident" id="3965507">ok</span>&nbsp;<span class="op" id="3965510">:=</span>&nbsp;<span class="ident" id="3965513">c</span><span class="op" id="3965514">.</span><span class="ident" id="3965515">config</span><span class="op" id="3965521">.</span><span class="ident" id="3965522">mutualVersion</span><span class="op" id="3965535">(</span><span class="ident" id="3965536">hs</span><span class="op" id="3965538">.</span><span class="ident" id="3965539">sessionState</span><span class="op" id="3965551">.</span><span class="ident" id="3965552">vers</span><span class="op" id="3965556">)</span><span class="op" id="3965557">;</span>&nbsp;<span class="op" id="3965559">!</span><span class="ident" id="3965560">ok</span>&nbsp;<span class="op" id="3965563">||</span>&nbsp;<span class="ident" id="3965566">vers</span>&nbsp;<span class="op" id="3965571">!=</span>&nbsp;<span class="ident" id="3965574">hs</span><span class="op" id="3965576">.</span><span class="ident" id="3965577">sessionState</span><span class="op" id="3965589">.</span><span class="ident" id="3965590">vers</span>&nbsp;<span class="op" id="3965595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965599">return</span>&nbsp;<span class="builtintype" id="3965606">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3965617">cipherSuiteOk</span>&nbsp;<span class="op" id="3965631">:=</span>&nbsp;<span class="builtintype" id="3965634">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3965641">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965717">for</span>&nbsp;<span class="ident" id="3965721">_</span><span class="op" id="3965722">,</span>&nbsp;<span class="ident" id="3965724">id</span>&nbsp;<span class="op" id="3965727">:=</span>&nbsp;<span class="keyword" id="3965730">range</span>&nbsp;<span class="ident" id="3965736">hs</span><span class="op" id="3965738">.</span><span class="ident" id="3965739">clientHello</span><span class="op" id="3965750">.</span><span class="ident" id="3965751">cipherSuites</span>&nbsp;<span class="op" id="3965764">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965768">if</span>&nbsp;<span class="ident" id="3965771">id</span>&nbsp;<span class="op" id="3965774">==</span>&nbsp;<span class="ident" id="3965777">hs</span><span class="op" id="3965779">.</span><span class="ident" id="3965780">sessionState</span><span class="op" id="3965792">.</span><span class="ident" id="3965793">cipherSuite</span>&nbsp;<span class="op" id="3965805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3965810">cipherSuiteOk</span>&nbsp;<span class="op" id="3965824">=</span>&nbsp;<span class="builtintype" id="3965826">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965834">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965845">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965848">if</span>&nbsp;<span class="op" id="3965851">!</span><span class="ident" id="3965852">cipherSuiteOk</span>&nbsp;<span class="op" id="3965866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3965870">return</span>&nbsp;<span class="builtintype" id="3965877">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3965884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3965888">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3965953">hs</span><span class="op" id="3965955">.</span><span class="ident" id="3965956">suite</span>&nbsp;<span class="op" id="3965962">=</span>&nbsp;<span class="ident" id="3965964">c</span><span class="op" id="3965965">.</span><span class="ident" id="3965966">tryCipherSuite</span><span class="op" id="3965980">(</span><span class="ident" id="3965981">hs</span><span class="op" id="3965983">.</span><span class="ident" id="3965984">sessionState</span><span class="op" id="3965996">.</span><span class="ident" id="3965997">cipherSuite</span><span class="op" id="3966008">,</span>&nbsp;<span class="ident" id="3966010">c</span><span class="op" id="3966011">.</span><span class="ident" id="3966012">config</span><span class="op" id="3966018">.</span><span class="ident" id="3966019">cipherSuites</span><span class="op" id="3966031">(</span><span class="op" id="3966032">)</span><span class="op" id="3966033">,</span>&nbsp;<span class="ident" id="3966035">hs</span><span class="op" id="3966037">.</span><span class="ident" id="3966038">sessionState</span><span class="op" id="3966050">.</span><span class="ident" id="3966051">vers</span><span class="op" id="3966055">,</span>&nbsp;<span class="ident" id="3966057">hs</span><span class="op" id="3966059">.</span><span class="ident" id="3966060">ellipticOk</span><span class="op" id="3966070">,</span>&nbsp;<span class="ident" id="3966072">hs</span><span class="op" id="3966074">.</span><span class="ident" id="3966075">ecdsaOk</span><span class="op" id="3966082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966085">if</span>&nbsp;<span class="ident" id="3966088">hs</span><span class="op" id="3966090">.</span><span class="ident" id="3966091">suite</span>&nbsp;<span class="op" id="3966097">==</span>&nbsp;<span class="ident" id="3966100">nil</span>&nbsp;<span class="op" id="3966104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966108">return</span>&nbsp;<span class="builtintype" id="3966115">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3966122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966126">sessionHasClientCerts</span>&nbsp;<span class="op" id="3966148">:=</span>&nbsp;<span class="builtinfunc" id="3966151">len</span><span class="op" id="3966154">(</span><span class="ident" id="3966155">hs</span><span class="op" id="3966157">.</span><span class="ident" id="3966158">sessionState</span><span class="op" id="3966170">.</span><span class="ident" id="3966171">certificates</span><span class="op" id="3966183">)</span>&nbsp;<span class="op" id="3966185">!=</span>&nbsp;<span class="num" id="3966188">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966191">needClientCerts</span>&nbsp;<span class="op" id="3966207">:=</span>&nbsp;<span class="ident" id="3966210">c</span><span class="op" id="3966211">.</span><span class="ident" id="3966212">config</span><span class="op" id="3966218">.</span><span class="ident" id="3966219">ClientAuth</span>&nbsp;<span class="op" id="3966230">==</span>&nbsp;<span class="ident" id="3966233">RequireAnyClientCert</span>&nbsp;<span class="op" id="3966254">||</span>&nbsp;<span class="ident" id="3966257">c</span><span class="op" id="3966258">.</span><span class="ident" id="3966259">config</span><span class="op" id="3966265">.</span><span class="ident" id="3966266">ClientAuth</span>&nbsp;<span class="op" id="3966277">==</span>&nbsp;<span class="ident" id="3966280">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966308">if</span>&nbsp;<span class="ident" id="3966311">needClientCerts</span>&nbsp;<span class="op" id="3966327">&amp;&amp;</span>&nbsp;<span class="op" id="3966330">!</span><span class="ident" id="3966331">sessionHasClientCerts</span>&nbsp;<span class="op" id="3966353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966357">return</span>&nbsp;<span class="builtintype" id="3966364">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3966371">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966374">if</span>&nbsp;<span class="ident" id="3966377">sessionHasClientCerts</span>&nbsp;<span class="op" id="3966399">&amp;&amp;</span>&nbsp;<span class="ident" id="3966402">c</span><span class="op" id="3966403">.</span><span class="ident" id="3966404">config</span><span class="op" id="3966410">.</span><span class="ident" id="3966411">ClientAuth</span>&nbsp;<span class="op" id="3966422">==</span>&nbsp;<span class="ident" id="3966425">NoClientCert</span>&nbsp;<span class="op" id="3966438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966442">return</span>&nbsp;<span class="builtintype" id="3966449">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3966456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966460">return</span>&nbsp;<span class="builtintype" id="3966467">true</span><br>
<span class="lineno">290</span><span class="op" id="3966472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3966475">func</span>&nbsp;<span class="op" id="3966480">(</span><span class="ident" id="3966481">hs</span>&nbsp;<span class="op" id="3966484">*</span><span class="ident" id="3966485">serverHandshakeState</span><span class="op" id="3966505">)</span>&nbsp;<span class="ident" id="3966507">doResumeHandshake</span><span class="op" id="3966524">(</span><span class="op" id="3966525">)</span>&nbsp;<span class="builtintype" id="3966527">error</span>&nbsp;<span class="op" id="3966533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966536">c</span>&nbsp;<span class="op" id="3966538">:=</span>&nbsp;<span class="ident" id="3966541">hs</span><span class="op" id="3966543">.</span><span class="ident" id="3966544">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966548">hs</span><span class="op" id="3966550">.</span><span class="ident" id="3966551">hello</span><span class="op" id="3966556">.</span><span class="ident" id="3966557">cipherSuite</span>&nbsp;<span class="op" id="3966569">=</span>&nbsp;<span class="ident" id="3966571">hs</span><span class="op" id="3966573">.</span><span class="ident" id="3966574">suite</span><span class="op" id="3966579">.</span><span class="ident" id="3966580">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3966584">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3966654">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966689">hs</span><span class="op" id="3966691">.</span><span class="ident" id="3966692">hello</span><span class="op" id="3966697">.</span><span class="ident" id="3966698">sessionId</span>&nbsp;<span class="op" id="3966708">=</span>&nbsp;<span class="ident" id="3966710">hs</span><span class="op" id="3966712">.</span><span class="ident" id="3966713">clientHello</span><span class="op" id="3966724">.</span><span class="ident" id="3966725">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966736">hs</span><span class="op" id="3966738">.</span><span class="ident" id="3966739">finishedHash</span><span class="op" id="3966751">.</span><span class="ident" id="3966752">Write</span><span class="op" id="3966757">(</span><span class="ident" id="3966758">hs</span><span class="op" id="3966760">.</span><span class="ident" id="3966761">hello</span><span class="op" id="3966766">.</span><span class="ident" id="3966767">marshal</span><span class="op" id="3966774">(</span><span class="op" id="3966775">)</span><span class="op" id="3966776">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966779">c</span><span class="op" id="3966780">.</span><span class="ident" id="3966781">writeRecord</span><span class="op" id="3966792">(</span><span class="ident" id="3966793">recordTypeHandshake</span><span class="op" id="3966812">,</span>&nbsp;<span class="ident" id="3966814">hs</span><span class="op" id="3966816">.</span><span class="ident" id="3966817">hello</span><span class="op" id="3966822">.</span><span class="ident" id="3966823">marshal</span><span class="op" id="3966830">(</span><span class="op" id="3966831">)</span><span class="op" id="3966832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966836">if</span>&nbsp;<span class="builtinfunc" id="3966839">len</span><span class="op" id="3966842">(</span><span class="ident" id="3966843">hs</span><span class="op" id="3966845">.</span><span class="ident" id="3966846">sessionState</span><span class="op" id="3966858">.</span><span class="ident" id="3966859">certificates</span><span class="op" id="3966871">)</span>&nbsp;<span class="op" id="3966873">&gt;</span>&nbsp;<span class="num" id="3966875">0</span>&nbsp;<span class="op" id="3966877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966881">if</span>&nbsp;<span class="ident" id="3966884">_</span><span class="op" id="3966885">,</span>&nbsp;<span class="ident" id="3966887">err</span>&nbsp;<span class="op" id="3966891">:=</span>&nbsp;<span class="ident" id="3966894">hs</span><span class="op" id="3966896">.</span><span class="ident" id="3966897">processCertsFromClient</span><span class="op" id="3966919">(</span><span class="ident" id="3966920">hs</span><span class="op" id="3966922">.</span><span class="ident" id="3966923">sessionState</span><span class="op" id="3966935">.</span><span class="ident" id="3966936">certificates</span><span class="op" id="3966948">)</span><span class="op" id="3966949">;</span>&nbsp;<span class="ident" id="3966951">err</span>&nbsp;<span class="op" id="3966955">!=</span>&nbsp;<span class="ident" id="3966958">nil</span>&nbsp;<span class="op" id="3966962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3966967">return</span>&nbsp;<span class="ident" id="3966974">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3966980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3966983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3966987">hs</span><span class="op" id="3966989">.</span><span class="ident" id="3966990">masterSecret</span>&nbsp;<span class="op" id="3967003">=</span>&nbsp;<span class="ident" id="3967005">hs</span><span class="op" id="3967007">.</span><span class="ident" id="3967008">sessionState</span><span class="op" id="3967020">.</span><span class="ident" id="3967021">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3967036">return</span>&nbsp;<span class="ident" id="3967043">nil</span><br>
<span class="lineno"></span><span class="op" id="3967047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3967050">func</span>&nbsp;<span class="op" id="3967055">(</span><span class="ident" id="3967056">hs</span>&nbsp;<span class="op" id="3967059">*</span><span class="ident" id="3967060">serverHandshakeState</span><span class="op" id="3967080">)</span>&nbsp;<span class="ident" id="3967082">doFullHandshake</span><span class="op" id="3967097">(</span><span class="op" id="3967098">)</span>&nbsp;<span class="builtintype" id="3967100">error</span>&nbsp;<span class="op" id="3967106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967109">config</span>&nbsp;<span class="op" id="3967116">:=</span>&nbsp;<span class="ident" id="3967119">hs</span><span class="op" id="3967121">.</span><span class="ident" id="3967122">c</span><span class="op" id="3967123">.</span><span class="ident" id="3967124">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967132">c</span>&nbsp;<span class="op" id="3967134">:=</span>&nbsp;<span class="ident" id="3967137">hs</span><span class="op" id="3967139">.</span><span class="ident" id="3967140">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3967144">if</span>&nbsp;<span class="ident" id="3967147">hs</span><span class="op" id="3967149">.</span><span class="ident" id="3967150">clientHello</span><span class="op" id="3967161">.</span><span class="ident" id="3967162">ocspStapling</span>&nbsp;<span class="op" id="3967175">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3967178">len</span><span class="op" id="3967181">(</span><span class="ident" id="3967182">hs</span><span class="op" id="3967184">.</span><span class="ident" id="3967185">cert</span><span class="op" id="3967189">.</span><span class="ident" id="3967190">OCSPStaple</span><span class="op" id="3967200">)</span>&nbsp;<span class="op" id="3967202">&gt;</span>&nbsp;<span class="num" id="3967204">0</span>&nbsp;<span class="op" id="3967206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967210">hs</span><span class="op" id="3967212">.</span><span class="ident" id="3967213">hello</span><span class="op" id="3967218">.</span><span class="ident" id="3967219">ocspStapling</span>&nbsp;<span class="op" id="3967232">=</span>&nbsp;<span class="builtintype" id="3967234">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3967240">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967244">hs</span><span class="op" id="3967246">.</span><span class="ident" id="3967247">hello</span><span class="op" id="3967252">.</span><span class="ident" id="3967253">ticketSupported</span>&nbsp;<span class="op" id="3967269">=</span>&nbsp;<span class="ident" id="3967271">hs</span><span class="op" id="3967273">.</span><span class="ident" id="3967274">clientHello</span><span class="op" id="3967285">.</span><span class="ident" id="3967286">ticketSupported</span>&nbsp;<span class="op" id="3967302">&amp;&amp;</span>&nbsp;<span class="op" id="3967305">!</span><span class="ident" id="3967306">config</span><span class="op" id="3967312">.</span><span class="ident" id="3967313">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967337">hs</span><span class="op" id="3967339">.</span><span class="ident" id="3967340">hello</span><span class="op" id="3967345">.</span><span class="ident" id="3967346">cipherSuite</span>&nbsp;<span class="op" id="3967358">=</span>&nbsp;<span class="ident" id="3967360">hs</span><span class="op" id="3967362">.</span><span class="ident" id="3967363">suite</span><span class="op" id="3967368">.</span><span class="ident" id="3967369">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967373">hs</span><span class="op" id="3967375">.</span><span class="ident" id="3967376">finishedHash</span><span class="op" id="3967388">.</span><span class="ident" id="3967389">Write</span><span class="op" id="3967394">(</span><span class="ident" id="3967395">hs</span><span class="op" id="3967397">.</span><span class="ident" id="3967398">hello</span><span class="op" id="3967403">.</span><span class="ident" id="3967404">marshal</span><span class="op" id="3967411">(</span><span class="op" id="3967412">)</span><span class="op" id="3967413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967416">c</span><span class="op" id="3967417">.</span><span class="ident" id="3967418">writeRecord</span><span class="op" id="3967429">(</span><span class="ident" id="3967430">recordTypeHandshake</span><span class="op" id="3967449">,</span>&nbsp;<span class="ident" id="3967451">hs</span><span class="op" id="3967453">.</span><span class="ident" id="3967454">hello</span><span class="op" id="3967459">.</span><span class="ident" id="3967460">marshal</span><span class="op" id="3967467">(</span><span class="op" id="3967468">)</span><span class="op" id="3967469">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967473">certMsg</span>&nbsp;<span class="op" id="3967481">:=</span>&nbsp;<span class="builtinfunc" id="3967484">new</span><span class="op" id="3967487">(</span><span class="ident" id="3967488">certificateMsg</span><span class="op" id="3967502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967505">certMsg</span><span class="op" id="3967512">.</span><span class="ident" id="3967513">certificates</span>&nbsp;<span class="op" id="3967526">=</span>&nbsp;<span class="ident" id="3967528">hs</span><span class="op" id="3967530">.</span><span class="ident" id="3967531">cert</span><span class="op" id="3967535">.</span><span class="ident" id="3967536">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967549">hs</span><span class="op" id="3967551">.</span><span class="ident" id="3967552">finishedHash</span><span class="op" id="3967564">.</span><span class="ident" id="3967565">Write</span><span class="op" id="3967570">(</span><span class="ident" id="3967571">certMsg</span><span class="op" id="3967578">.</span><span class="ident" id="3967579">marshal</span><span class="op" id="3967586">(</span><span class="op" id="3967587">)</span><span class="op" id="3967588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967591">c</span><span class="op" id="3967592">.</span><span class="ident" id="3967593">writeRecord</span><span class="op" id="3967604">(</span><span class="ident" id="3967605">recordTypeHandshake</span><span class="op" id="3967624">,</span>&nbsp;<span class="ident" id="3967626">certMsg</span><span class="op" id="3967633">.</span><span class="ident" id="3967634">marshal</span><span class="op" id="3967641">(</span><span class="op" id="3967642">)</span><span class="op" id="3967643">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3967647">if</span>&nbsp;<span class="ident" id="3967650">hs</span><span class="op" id="3967652">.</span><span class="ident" id="3967653">hello</span><span class="op" id="3967658">.</span><span class="ident" id="3967659">ocspStapling</span>&nbsp;<span class="op" id="3967672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967676">certStatus</span>&nbsp;<span class="op" id="3967687">:=</span>&nbsp;<span class="builtinfunc" id="3967690">new</span><span class="op" id="3967693">(</span><span class="ident" id="3967694">certificateStatusMsg</span><span class="op" id="3967714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967718">certStatus</span><span class="op" id="3967728">.</span><span class="ident" id="3967729">statusType</span>&nbsp;<span class="op" id="3967740">=</span>&nbsp;<span class="ident" id="3967742">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967759">certStatus</span><span class="op" id="3967769">.</span><span class="ident" id="3967770">response</span>&nbsp;<span class="op" id="3967779">=</span>&nbsp;<span class="ident" id="3967781">hs</span><span class="op" id="3967783">.</span><span class="ident" id="3967784">cert</span><span class="op" id="3967788">.</span><span class="ident" id="3967789">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967802">hs</span><span class="op" id="3967804">.</span><span class="ident" id="3967805">finishedHash</span><span class="op" id="3967817">.</span><span class="ident" id="3967818">Write</span><span class="op" id="3967823">(</span><span class="ident" id="3967824">certStatus</span><span class="op" id="3967834">.</span><span class="ident" id="3967835">marshal</span><span class="op" id="3967842">(</span><span class="op" id="3967843">)</span><span class="op" id="3967844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967848">c</span><span class="op" id="3967849">.</span><span class="ident" id="3967850">writeRecord</span><span class="op" id="3967861">(</span><span class="ident" id="3967862">recordTypeHandshake</span><span class="op" id="3967881">,</span>&nbsp;<span class="ident" id="3967883">certStatus</span><span class="op" id="3967893">.</span><span class="ident" id="3967894">marshal</span><span class="op" id="3967901">(</span><span class="op" id="3967902">)</span><span class="op" id="3967903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3967906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967910">keyAgreement</span>&nbsp;<span class="op" id="3967923">:=</span>&nbsp;<span class="ident" id="3967926">hs</span><span class="op" id="3967928">.</span><span class="ident" id="3967929">suite</span><span class="op" id="3967934">.</span><span class="ident" id="3967935">ka</span><span class="op" id="3967937">(</span><span class="ident" id="3967938">c</span><span class="op" id="3967939">.</span><span class="ident" id="3967940">vers</span><span class="op" id="3967944">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3967947">skx</span><span class="op" id="3967950">,</span>&nbsp;<span class="ident" id="3967952">err</span>&nbsp;<span class="op" id="3967956">:=</span>&nbsp;<span class="ident" id="3967959">keyAgreement</span><span class="op" id="3967971">.</span><span class="ident" id="3967972">generateServerKeyExchange</span><span class="op" id="3967997">(</span><span class="ident" id="3967998">config</span><span class="op" id="3968004">,</span>&nbsp;<span class="ident" id="3968006">hs</span><span class="op" id="3968008">.</span><span class="ident" id="3968009">cert</span><span class="op" id="3968013">,</span>&nbsp;<span class="ident" id="3968015">hs</span><span class="op" id="3968017">.</span><span class="ident" id="3968018">clientHello</span><span class="op" id="3968029">,</span>&nbsp;<span class="ident" id="3968031">hs</span><span class="op" id="3968033">.</span><span class="ident" id="3968034">hello</span><span class="op" id="3968039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968042">if</span>&nbsp;<span class="ident" id="3968045">err</span>&nbsp;<span class="op" id="3968049">!=</span>&nbsp;<span class="ident" id="3968052">nil</span>&nbsp;<span class="op" id="3968056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968060">c</span><span class="op" id="3968061">.</span><span class="ident" id="3968062">sendAlert</span><span class="op" id="3968071">(</span><span class="ident" id="3968072">alertHandshakeFailure</span><span class="op" id="3968093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968097">return</span>&nbsp;<span class="ident" id="3968104">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3968109">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968112">if</span>&nbsp;<span class="ident" id="3968115">skx</span>&nbsp;<span class="op" id="3968119">!=</span>&nbsp;<span class="ident" id="3968122">nil</span>&nbsp;<span class="op" id="3968126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968130">hs</span><span class="op" id="3968132">.</span><span class="ident" id="3968133">finishedHash</span><span class="op" id="3968145">.</span><span class="ident" id="3968146">Write</span><span class="op" id="3968151">(</span><span class="ident" id="3968152">skx</span><span class="op" id="3968155">.</span><span class="ident" id="3968156">marshal</span><span class="op" id="3968163">(</span><span class="op" id="3968164">)</span><span class="op" id="3968165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968169">c</span><span class="op" id="3968170">.</span><span class="ident" id="3968171">writeRecord</span><span class="op" id="3968182">(</span><span class="ident" id="3968183">recordTypeHandshake</span><span class="op" id="3968202">,</span>&nbsp;<span class="ident" id="3968204">skx</span><span class="op" id="3968207">.</span><span class="ident" id="3968208">marshal</span><span class="op" id="3968215">(</span><span class="op" id="3968216">)</span><span class="op" id="3968217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3968220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968224">if</span>&nbsp;<span class="ident" id="3968227">config</span><span class="op" id="3968233">.</span><span class="ident" id="3968234">ClientAuth</span>&nbsp;<span class="op" id="3968245">&gt;=</span>&nbsp;<span class="ident" id="3968248">RequestClientCert</span>&nbsp;<span class="op" id="3968266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3968270">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968304">certReq</span>&nbsp;<span class="op" id="3968312">:=</span>&nbsp;<span class="builtinfunc" id="3968315">new</span><span class="op" id="3968318">(</span><span class="ident" id="3968319">certificateRequestMsg</span><span class="op" id="3968340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968344">certReq</span><span class="op" id="3968351">.</span><span class="ident" id="3968352">certificateTypes</span>&nbsp;<span class="op" id="3968369">=</span>&nbsp;<span class="op" id="3968371">[</span><span class="op" id="3968372">]</span><span class="builtintype" id="3968373">byte</span><span class="op" id="3968377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3968382">byte</span><span class="op" id="3968386">(</span><span class="ident" id="3968387">certTypeRSASign</span><span class="op" id="3968402">)</span><span class="op" id="3968403">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3968408">byte</span><span class="op" id="3968412">(</span><span class="ident" id="3968413">certTypeECDSASign</span><span class="op" id="3968430">)</span><span class="op" id="3968431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3968435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968439">if</span>&nbsp;<span class="ident" id="3968442">c</span><span class="op" id="3968443">.</span><span class="ident" id="3968444">vers</span>&nbsp;<span class="op" id="3968449">&gt;=</span>&nbsp;<span class="ident" id="3968452">VersionTLS12</span>&nbsp;<span class="op" id="3968465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968470">certReq</span><span class="op" id="3968477">.</span><span class="ident" id="3968478">hasSignatureAndHash</span>&nbsp;<span class="op" id="3968498">=</span>&nbsp;<span class="builtintype" id="3968500">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968508">certReq</span><span class="op" id="3968515">.</span><span class="ident" id="3968516">signatureAndHashes</span>&nbsp;<span class="op" id="3968535">=</span>&nbsp;<span class="ident" id="3968537">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3968578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3968583">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3968639">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3968700">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3968757">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3968815">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968862">if</span>&nbsp;<span class="ident" id="3968865">config</span><span class="op" id="3968871">.</span><span class="ident" id="3968872">ClientCAs</span>&nbsp;<span class="op" id="3968882">!=</span>&nbsp;<span class="ident" id="3968885">nil</span>&nbsp;<span class="op" id="3968889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968894">certReq</span><span class="op" id="3968901">.</span><span class="ident" id="3968902">certificateAuthorities</span>&nbsp;<span class="op" id="3968925">=</span>&nbsp;<span class="ident" id="3968927">config</span><span class="op" id="3968933">.</span><span class="ident" id="3968934">ClientCAs</span><span class="op" id="3968943">.</span><span class="ident" id="3968944">Subjects</span><span class="op" id="3968952">(</span><span class="op" id="3968953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3968957">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968961">hs</span><span class="op" id="3968963">.</span><span class="ident" id="3968964">finishedHash</span><span class="op" id="3968976">.</span><span class="ident" id="3968977">Write</span><span class="op" id="3968982">(</span><span class="ident" id="3968983">certReq</span><span class="op" id="3968990">.</span><span class="ident" id="3968991">marshal</span><span class="op" id="3968998">(</span><span class="op" id="3968999">)</span><span class="op" id="3969000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969004">c</span><span class="op" id="3969005">.</span><span class="ident" id="3969006">writeRecord</span><span class="op" id="3969017">(</span><span class="ident" id="3969018">recordTypeHandshake</span><span class="op" id="3969037">,</span>&nbsp;<span class="ident" id="3969039">certReq</span><span class="op" id="3969046">.</span><span class="ident" id="3969047">marshal</span><span class="op" id="3969054">(</span><span class="op" id="3969055">)</span><span class="op" id="3969056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3969059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969063">helloDone</span>&nbsp;<span class="op" id="3969073">:=</span>&nbsp;<span class="builtinfunc" id="3969076">new</span><span class="op" id="3969079">(</span><span class="ident" id="3969080">serverHelloDoneMsg</span><span class="op" id="3969098">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969101">hs</span><span class="op" id="3969103">.</span><span class="ident" id="3969104">finishedHash</span><span class="op" id="3969116">.</span><span class="ident" id="3969117">Write</span><span class="op" id="3969122">(</span><span class="ident" id="3969123">helloDone</span><span class="op" id="3969132">.</span><span class="ident" id="3969133">marshal</span><span class="op" id="3969140">(</span><span class="op" id="3969141">)</span><span class="op" id="3969142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969145">c</span><span class="op" id="3969146">.</span><span class="ident" id="3969147">writeRecord</span><span class="op" id="3969158">(</span><span class="ident" id="3969159">recordTypeHandshake</span><span class="op" id="3969178">,</span>&nbsp;<span class="ident" id="3969180">helloDone</span><span class="op" id="3969189">.</span><span class="ident" id="3969190">marshal</span><span class="op" id="3969197">(</span><span class="op" id="3969198">)</span><span class="op" id="3969199">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969203">var</span>&nbsp;<span class="ident" id="3969207">pub</span>&nbsp;<span class="ident" id="3969211">crypto</span><span class="op" id="3969217">.</span><span class="ident" id="3969218">PublicKey</span>&nbsp;<span class="comment" id="3969228">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969268">msg</span><span class="op" id="3969271">,</span>&nbsp;<span class="ident" id="3969273">err</span>&nbsp;<span class="op" id="3969277">:=</span>&nbsp;<span class="ident" id="3969280">c</span><span class="op" id="3969281">.</span><span class="ident" id="3969282">readHandshake</span><span class="op" id="3969295">(</span><span class="op" id="3969296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969299">if</span>&nbsp;<span class="ident" id="3969302">err</span>&nbsp;<span class="op" id="3969306">!=</span>&nbsp;<span class="ident" id="3969309">nil</span>&nbsp;<span class="op" id="3969313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969317">return</span>&nbsp;<span class="ident" id="3969324">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3969329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969333">var</span>&nbsp;<span class="ident" id="3969337">ok</span>&nbsp;<span class="builtintype" id="3969340">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3969346">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3969416">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969461">if</span>&nbsp;<span class="ident" id="3969464">config</span><span class="op" id="3969470">.</span><span class="ident" id="3969471">ClientAuth</span>&nbsp;<span class="op" id="3969482">&gt;=</span>&nbsp;<span class="ident" id="3969485">RequestClientCert</span>&nbsp;<span class="op" id="3969503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969507">if</span>&nbsp;<span class="ident" id="3969510">certMsg</span><span class="op" id="3969517">,</span>&nbsp;<span class="ident" id="3969519">ok</span>&nbsp;<span class="op" id="3969522">=</span>&nbsp;<span class="ident" id="3969524">msg</span><span class="op" id="3969527">.</span><span class="op" id="3969528">(</span><span class="op" id="3969529">*</span><span class="ident" id="3969530">certificateMsg</span><span class="op" id="3969544">)</span><span class="op" id="3969545">;</span>&nbsp;<span class="op" id="3969547">!</span><span class="ident" id="3969548">ok</span>&nbsp;<span class="op" id="3969551">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969556">c</span><span class="op" id="3969557">.</span><span class="ident" id="3969558">sendAlert</span><span class="op" id="3969567">(</span><span class="ident" id="3969568">alertUnexpectedMessage</span><span class="op" id="3969590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969595">return</span>&nbsp;<span class="ident" id="3969602">unexpectedMessageError</span><span class="op" id="3969624">(</span><span class="ident" id="3969625">certMsg</span><span class="op" id="3969632">,</span>&nbsp;<span class="ident" id="3969634">msg</span><span class="op" id="3969637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3969641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969645">hs</span><span class="op" id="3969647">.</span><span class="ident" id="3969648">finishedHash</span><span class="op" id="3969660">.</span><span class="ident" id="3969661">Write</span><span class="op" id="3969666">(</span><span class="ident" id="3969667">certMsg</span><span class="op" id="3969674">.</span><span class="ident" id="3969675">marshal</span><span class="op" id="3969682">(</span><span class="op" id="3969683">)</span><span class="op" id="3969684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969689">if</span>&nbsp;<span class="builtinfunc" id="3969692">len</span><span class="op" id="3969695">(</span><span class="ident" id="3969696">certMsg</span><span class="op" id="3969703">.</span><span class="ident" id="3969704">certificates</span><span class="op" id="3969716">)</span>&nbsp;<span class="op" id="3969718">==</span>&nbsp;<span class="num" id="3969721">0</span>&nbsp;<span class="op" id="3969723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3969728">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969780">switch</span>&nbsp;<span class="ident" id="3969787">config</span><span class="op" id="3969793">.</span><span class="ident" id="3969794">ClientAuth</span>&nbsp;<span class="op" id="3969805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969810">case</span>&nbsp;<span class="ident" id="3969815">RequireAnyClientCert</span><span class="op" id="3969835">,</span>&nbsp;<span class="ident" id="3969837">RequireAndVerifyClientCert</span><span class="op" id="3969863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969869">c</span><span class="op" id="3969870">.</span><span class="ident" id="3969871">sendAlert</span><span class="op" id="3969880">(</span><span class="ident" id="3969881">alertBadCertificate</span><span class="op" id="3969900">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3969906">return</span>&nbsp;<span class="ident" id="3969913">errors</span><span class="op" id="3969919">.</span><span class="ident" id="3969920">New</span><span class="op" id="3969923">(</span><span class="string" id="3969924">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3969966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3969971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3969975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3969980">pub</span><span class="op" id="3969983">,</span>&nbsp;<span class="ident" id="3969985">err</span>&nbsp;<span class="op" id="3969989">=</span>&nbsp;<span class="ident" id="3969991">hs</span><span class="op" id="3969993">.</span><span class="ident" id="3969994">processCertsFromClient</span><span class="op" id="3970016">(</span><span class="ident" id="3970017">certMsg</span><span class="op" id="3970024">.</span><span class="ident" id="3970025">certificates</span><span class="op" id="3970037">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970041">if</span>&nbsp;<span class="ident" id="3970044">err</span>&nbsp;<span class="op" id="3970048">!=</span>&nbsp;<span class="ident" id="3970051">nil</span>&nbsp;<span class="op" id="3970055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970060">return</span>&nbsp;<span class="ident" id="3970067">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3970073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970078">msg</span><span class="op" id="3970081">,</span>&nbsp;<span class="ident" id="3970083">err</span>&nbsp;<span class="op" id="3970087">=</span>&nbsp;<span class="ident" id="3970089">c</span><span class="op" id="3970090">.</span><span class="ident" id="3970091">readHandshake</span><span class="op" id="3970104">(</span><span class="op" id="3970105">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970109">if</span>&nbsp;<span class="ident" id="3970112">err</span>&nbsp;<span class="op" id="3970116">!=</span>&nbsp;<span class="ident" id="3970119">nil</span>&nbsp;<span class="op" id="3970123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970128">return</span>&nbsp;<span class="ident" id="3970135">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3970141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3970144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970148">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970176">ckx</span><span class="op" id="3970179">,</span>&nbsp;<span class="ident" id="3970181">ok</span>&nbsp;<span class="op" id="3970184">:=</span>&nbsp;<span class="ident" id="3970187">msg</span><span class="op" id="3970190">.</span><span class="op" id="3970191">(</span><span class="op" id="3970192">*</span><span class="ident" id="3970193">clientKeyExchangeMsg</span><span class="op" id="3970213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970216">if</span>&nbsp;<span class="op" id="3970219">!</span><span class="ident" id="3970220">ok</span>&nbsp;<span class="op" id="3970223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970227">c</span><span class="op" id="3970228">.</span><span class="ident" id="3970229">sendAlert</span><span class="op" id="3970238">(</span><span class="ident" id="3970239">alertUnexpectedMessage</span><span class="op" id="3970261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970265">return</span>&nbsp;<span class="ident" id="3970272">unexpectedMessageError</span><span class="op" id="3970294">(</span><span class="ident" id="3970295">ckx</span><span class="op" id="3970298">,</span>&nbsp;<span class="ident" id="3970300">msg</span><span class="op" id="3970303">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3970306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970309">hs</span><span class="op" id="3970311">.</span><span class="ident" id="3970312">finishedHash</span><span class="op" id="3970324">.</span><span class="ident" id="3970325">Write</span><span class="op" id="3970330">(</span><span class="ident" id="3970331">ckx</span><span class="op" id="3970334">.</span><span class="ident" id="3970335">marshal</span><span class="op" id="3970342">(</span><span class="op" id="3970343">)</span><span class="op" id="3970344">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970348">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970429">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970502">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970571">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970651">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3970731">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970785">if</span>&nbsp;<span class="builtinfunc" id="3970788">len</span><span class="op" id="3970791">(</span><span class="ident" id="3970792">c</span><span class="op" id="3970793">.</span><span class="ident" id="3970794">peerCertificates</span><span class="op" id="3970810">)</span>&nbsp;<span class="op" id="3970812">&gt;</span>&nbsp;<span class="num" id="3970814">0</span>&nbsp;<span class="op" id="3970816">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970820">msg</span><span class="op" id="3970823">,</span>&nbsp;<span class="ident" id="3970825">err</span>&nbsp;<span class="op" id="3970829">=</span>&nbsp;<span class="ident" id="3970831">c</span><span class="op" id="3970832">.</span><span class="ident" id="3970833">readHandshake</span><span class="op" id="3970846">(</span><span class="op" id="3970847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970851">if</span>&nbsp;<span class="ident" id="3970854">err</span>&nbsp;<span class="op" id="3970858">!=</span>&nbsp;<span class="ident" id="3970861">nil</span>&nbsp;<span class="op" id="3970865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970870">return</span>&nbsp;<span class="ident" id="3970877">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3970883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970887">certVerify</span><span class="op" id="3970897">,</span>&nbsp;<span class="ident" id="3970899">ok</span>&nbsp;<span class="op" id="3970902">:=</span>&nbsp;<span class="ident" id="3970905">msg</span><span class="op" id="3970908">.</span><span class="op" id="3970909">(</span><span class="op" id="3970910">*</span><span class="ident" id="3970911">certificateVerifyMsg</span><span class="op" id="3970931">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970935">if</span>&nbsp;<span class="op" id="3970938">!</span><span class="ident" id="3970939">ok</span>&nbsp;<span class="op" id="3970942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3970947">c</span><span class="op" id="3970948">.</span><span class="ident" id="3970949">sendAlert</span><span class="op" id="3970958">(</span><span class="ident" id="3970959">alertUnexpectedMessage</span><span class="op" id="3970981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3970986">return</span>&nbsp;<span class="ident" id="3970993">unexpectedMessageError</span><span class="op" id="3971015">(</span><span class="ident" id="3971016">certVerify</span><span class="op" id="3971026">,</span>&nbsp;<span class="ident" id="3971028">msg</span><span class="op" id="3971031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971040">switch</span>&nbsp;<span class="ident" id="3971047">key</span>&nbsp;<span class="op" id="3971051">:=</span>&nbsp;<span class="ident" id="3971054">pub</span><span class="op" id="3971057">.</span><span class="op" id="3971058">(</span><span class="keyword" id="3971059">type</span><span class="op" id="3971063">)</span>&nbsp;<span class="op" id="3971065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971069">case</span>&nbsp;<span class="op" id="3971074">*</span><span class="ident" id="3971075">ecdsa</span><span class="op" id="3971080">.</span><span class="ident" id="3971081">PublicKey</span><span class="op" id="3971090">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971095">ecdsaSig</span>&nbsp;<span class="op" id="3971104">:=</span>&nbsp;<span class="builtinfunc" id="3971107">new</span><span class="op" id="3971110">(</span><span class="ident" id="3971111">ecdsaSignature</span><span class="op" id="3971125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971130">if</span>&nbsp;<span class="ident" id="3971133">_</span><span class="op" id="3971134">,</span>&nbsp;<span class="ident" id="3971136">err</span>&nbsp;<span class="op" id="3971140">=</span>&nbsp;<span class="ident" id="3971142">asn1</span><span class="op" id="3971146">.</span><span class="ident" id="3971147">Unmarshal</span><span class="op" id="3971156">(</span><span class="ident" id="3971157">certVerify</span><span class="op" id="3971167">.</span><span class="ident" id="3971168">signature</span><span class="op" id="3971177">,</span>&nbsp;<span class="ident" id="3971179">ecdsaSig</span><span class="op" id="3971187">)</span><span class="op" id="3971188">;</span>&nbsp;<span class="ident" id="3971190">err</span>&nbsp;<span class="op" id="3971194">!=</span>&nbsp;<span class="ident" id="3971197">nil</span>&nbsp;<span class="op" id="3971201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971207">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971221">if</span>&nbsp;<span class="ident" id="3971224">ecdsaSig</span><span class="op" id="3971232">.</span><span class="ident" id="3971233">R</span><span class="op" id="3971234">.</span><span class="ident" id="3971235">Sign</span><span class="op" id="3971239">(</span><span class="op" id="3971240">)</span>&nbsp;<span class="op" id="3971242">&lt;=</span>&nbsp;<span class="num" id="3971245">0</span>&nbsp;<span class="op" id="3971247">||</span>&nbsp;<span class="ident" id="3971250">ecdsaSig</span><span class="op" id="3971258">.</span><span class="ident" id="3971259">S</span><span class="op" id="3971260">.</span><span class="ident" id="3971261">Sign</span><span class="op" id="3971265">(</span><span class="op" id="3971266">)</span>&nbsp;<span class="op" id="3971268">&lt;=</span>&nbsp;<span class="num" id="3971271">0</span>&nbsp;<span class="op" id="3971273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971279">err</span>&nbsp;<span class="op" id="3971283">=</span>&nbsp;<span class="ident" id="3971285">errors</span><span class="op" id="3971291">.</span><span class="ident" id="3971292">New</span><span class="op" id="3971295">(</span><span class="string" id="3971296">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3971347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971353">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971362">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971367">digest</span><span class="op" id="3971373">,</span>&nbsp;<span class="ident" id="3971375">_</span><span class="op" id="3971376">,</span>&nbsp;<span class="ident" id="3971378">_</span>&nbsp;<span class="op" id="3971380">:=</span>&nbsp;<span class="ident" id="3971383">hs</span><span class="op" id="3971385">.</span><span class="ident" id="3971386">finishedHash</span><span class="op" id="3971398">.</span><span class="ident" id="3971399">hashForClientCertificate</span><span class="op" id="3971423">(</span><span class="ident" id="3971424">signatureECDSA</span><span class="op" id="3971438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971443">if</span>&nbsp;<span class="op" id="3971446">!</span><span class="ident" id="3971447">ecdsa</span><span class="op" id="3971452">.</span><span class="ident" id="3971453">Verify</span><span class="op" id="3971459">(</span><span class="ident" id="3971460">key</span><span class="op" id="3971463">,</span>&nbsp;<span class="ident" id="3971465">digest</span><span class="op" id="3971471">,</span>&nbsp;<span class="ident" id="3971473">ecdsaSig</span><span class="op" id="3971481">.</span><span class="ident" id="3971482">R</span><span class="op" id="3971483">,</span>&nbsp;<span class="ident" id="3971485">ecdsaSig</span><span class="op" id="3971493">.</span><span class="ident" id="3971494">S</span><span class="op" id="3971495">)</span>&nbsp;<span class="op" id="3971497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971503">err</span>&nbsp;<span class="op" id="3971507">=</span>&nbsp;<span class="ident" id="3971509">errors</span><span class="op" id="3971515">.</span><span class="ident" id="3971516">New</span><span class="op" id="3971519">(</span><span class="string" id="3971520">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3971548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971554">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971563">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971567">case</span>&nbsp;<span class="op" id="3971572">*</span><span class="ident" id="3971573">rsa</span><span class="op" id="3971576">.</span><span class="ident" id="3971577">PublicKey</span><span class="op" id="3971586">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971591">digest</span><span class="op" id="3971597">,</span>&nbsp;<span class="ident" id="3971599">hashFunc</span><span class="op" id="3971607">,</span>&nbsp;<span class="ident" id="3971609">_</span>&nbsp;<span class="op" id="3971611">:=</span>&nbsp;<span class="ident" id="3971614">hs</span><span class="op" id="3971616">.</span><span class="ident" id="3971617">finishedHash</span><span class="op" id="3971629">.</span><span class="ident" id="3971630">hashForClientCertificate</span><span class="op" id="3971654">(</span><span class="ident" id="3971655">signatureRSA</span><span class="op" id="3971667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971672">err</span>&nbsp;<span class="op" id="3971676">=</span>&nbsp;<span class="ident" id="3971678">rsa</span><span class="op" id="3971681">.</span><span class="ident" id="3971682">VerifyPKCS1v15</span><span class="op" id="3971696">(</span><span class="ident" id="3971697">key</span><span class="op" id="3971700">,</span>&nbsp;<span class="ident" id="3971702">hashFunc</span><span class="op" id="3971710">,</span>&nbsp;<span class="ident" id="3971712">digest</span><span class="op" id="3971718">,</span>&nbsp;<span class="ident" id="3971720">certVerify</span><span class="op" id="3971730">.</span><span class="ident" id="3971731">signature</span><span class="op" id="3971740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971748">if</span>&nbsp;<span class="ident" id="3971751">err</span>&nbsp;<span class="op" id="3971755">!=</span>&nbsp;<span class="ident" id="3971758">nil</span>&nbsp;<span class="op" id="3971762">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971767">c</span><span class="op" id="3971768">.</span><span class="ident" id="3971769">sendAlert</span><span class="op" id="3971778">(</span><span class="ident" id="3971779">alertBadCertificate</span><span class="op" id="3971798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3971803">return</span>&nbsp;<span class="ident" id="3971810">errors</span><span class="op" id="3971816">.</span><span class="ident" id="3971817">New</span><span class="op" id="3971820">(</span><span class="string" id="3971821">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3971875">+</span>&nbsp;<span class="ident" id="3971877">err</span><span class="op" id="3971880">.</span><span class="ident" id="3971881">Error</span><span class="op" id="3971886">(</span><span class="op" id="3971887">)</span><span class="op" id="3971888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971897">hs</span><span class="op" id="3971899">.</span><span class="ident" id="3971900">finishedHash</span><span class="op" id="3971912">.</span><span class="ident" id="3971913">Write</span><span class="op" id="3971918">(</span><span class="ident" id="3971919">certVerify</span><span class="op" id="3971929">.</span><span class="ident" id="3971930">marshal</span><span class="op" id="3971937">(</span><span class="op" id="3971938">)</span><span class="op" id="3971939">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3971942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3971946">preMasterSecret</span><span class="op" id="3971961">,</span>&nbsp;<span class="ident" id="3971963">err</span>&nbsp;<span class="op" id="3971967">:=</span>&nbsp;<span class="ident" id="3971970">keyAgreement</span><span class="op" id="3971982">.</span><span class="ident" id="3971983">processClientKeyExchange</span><span class="op" id="3972007">(</span><span class="ident" id="3972008">config</span><span class="op" id="3972014">,</span>&nbsp;<span class="ident" id="3972016">hs</span><span class="op" id="3972018">.</span><span class="ident" id="3972019">cert</span><span class="op" id="3972023">,</span>&nbsp;<span class="ident" id="3972025">ckx</span><span class="op" id="3972028">,</span>&nbsp;<span class="ident" id="3972030">c</span><span class="op" id="3972031">.</span><span class="ident" id="3972032">vers</span><span class="op" id="3972036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3972039">if</span>&nbsp;<span class="ident" id="3972042">err</span>&nbsp;<span class="op" id="3972046">!=</span>&nbsp;<span class="ident" id="3972049">nil</span>&nbsp;<span class="op" id="3972053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972057">c</span><span class="op" id="3972058">.</span><span class="ident" id="3972059">sendAlert</span><span class="op" id="3972068">(</span><span class="ident" id="3972069">alertHandshakeFailure</span><span class="op" id="3972090">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3972094">return</span>&nbsp;<span class="ident" id="3972101">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3972106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972109">hs</span><span class="op" id="3972111">.</span><span class="ident" id="3972112">masterSecret</span>&nbsp;<span class="op" id="3972125">=</span>&nbsp;<span class="ident" id="3972127">masterFromPreMasterSecret</span><span class="op" id="3972152">(</span><span class="ident" id="3972153">c</span><span class="op" id="3972154">.</span><span class="ident" id="3972155">vers</span><span class="op" id="3972159">,</span>&nbsp;<span class="ident" id="3972161">preMasterSecret</span><span class="op" id="3972176">,</span>&nbsp;<span class="ident" id="3972178">hs</span><span class="op" id="3972180">.</span><span class="ident" id="3972181">clientHello</span><span class="op" id="3972192">.</span><span class="ident" id="3972193">random</span><span class="op" id="3972199">,</span>&nbsp;<span class="ident" id="3972201">hs</span><span class="op" id="3972203">.</span><span class="ident" id="3972204">hello</span><span class="op" id="3972209">.</span><span class="ident" id="3972210">random</span><span class="op" id="3972216">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3972220">return</span>&nbsp;<span class="ident" id="3972227">nil</span><br>
<span class="lineno">475</span><span class="op" id="3972231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3972234">func</span>&nbsp;<span class="op" id="3972239">(</span><span class="ident" id="3972240">hs</span>&nbsp;<span class="op" id="3972243">*</span><span class="ident" id="3972244">serverHandshakeState</span><span class="op" id="3972264">)</span>&nbsp;<span class="ident" id="3972266">establishKeys</span><span class="op" id="3972279">(</span><span class="op" id="3972280">)</span>&nbsp;<span class="builtintype" id="3972282">error</span>&nbsp;<span class="op" id="3972288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972291">c</span>&nbsp;<span class="op" id="3972293">:=</span>&nbsp;<span class="ident" id="3972296">hs</span><span class="op" id="3972298">.</span><span class="ident" id="3972299">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972303">clientMAC</span><span class="op" id="3972312">,</span>&nbsp;<span class="ident" id="3972314">serverMAC</span><span class="op" id="3972323">,</span>&nbsp;<span class="ident" id="3972325">clientKey</span><span class="op" id="3972334">,</span>&nbsp;<span class="ident" id="3972336">serverKey</span><span class="op" id="3972345">,</span>&nbsp;<span class="ident" id="3972347">clientIV</span><span class="op" id="3972355">,</span>&nbsp;<span class="ident" id="3972357">serverIV</span>&nbsp;<span class="op" id="3972366">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972371">keysFromMasterSecret</span><span class="op" id="3972391">(</span><span class="ident" id="3972392">c</span><span class="op" id="3972393">.</span><span class="ident" id="3972394">vers</span><span class="op" id="3972398">,</span>&nbsp;<span class="ident" id="3972400">hs</span><span class="op" id="3972402">.</span><span class="ident" id="3972403">masterSecret</span><span class="op" id="3972415">,</span>&nbsp;<span class="ident" id="3972417">hs</span><span class="op" id="3972419">.</span><span class="ident" id="3972420">clientHello</span><span class="op" id="3972431">.</span><span class="ident" id="3972432">random</span><span class="op" id="3972438">,</span>&nbsp;<span class="ident" id="3972440">hs</span><span class="op" id="3972442">.</span><span class="ident" id="3972443">hello</span><span class="op" id="3972448">.</span><span class="ident" id="3972449">random</span><span class="op" id="3972455">,</span>&nbsp;<span class="ident" id="3972457">hs</span><span class="op" id="3972459">.</span><span class="ident" id="3972460">suite</span><span class="op" id="3972465">.</span><span class="ident" id="3972466">macLen</span><span class="op" id="3972472">,</span>&nbsp;<span class="ident" id="3972474">hs</span><span class="op" id="3972476">.</span><span class="ident" id="3972477">suite</span><span class="op" id="3972482">.</span><span class="ident" id="3972483">keyLen</span><span class="op" id="3972489">,</span>&nbsp;<span class="ident" id="3972491">hs</span><span class="op" id="3972493">.</span><span class="ident" id="3972494">suite</span><span class="op" id="3972499">.</span><span class="ident" id="3972500">ivLen</span><span class="op" id="3972505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3972509">var</span>&nbsp;<span class="ident" id="3972513">clientCipher</span><span class="op" id="3972525">,</span>&nbsp;<span class="ident" id="3972527">serverCipher</span>&nbsp;<span class="keyword" id="3972540">interface</span><span class="op" id="3972549">{</span><span class="op" id="3972550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3972553">var</span>&nbsp;<span class="ident" id="3972557">clientHash</span><span class="op" id="3972567">,</span>&nbsp;<span class="ident" id="3972569">serverHash</span>&nbsp;<span class="ident" id="3972580">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3972594">if</span>&nbsp;<span class="ident" id="3972597">hs</span><span class="op" id="3972599">.</span><span class="ident" id="3972600">suite</span><span class="op" id="3972605">.</span><span class="ident" id="3972606">aead</span>&nbsp;<span class="op" id="3972611">==</span>&nbsp;<span class="ident" id="3972614">nil</span>&nbsp;<span class="op" id="3972618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972622">clientCipher</span>&nbsp;<span class="op" id="3972635">=</span>&nbsp;<span class="ident" id="3972637">hs</span><span class="op" id="3972639">.</span><span class="ident" id="3972640">suite</span><span class="op" id="3972645">.</span><span class="ident" id="3972646">cipher</span><span class="op" id="3972652">(</span><span class="ident" id="3972653">clientKey</span><span class="op" id="3972662">,</span>&nbsp;<span class="ident" id="3972664">clientIV</span><span class="op" id="3972672">,</span>&nbsp;<span class="builtintype" id="3972674">true</span>&nbsp;<span class="comment" id="3972679">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3972696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972700">clientHash</span>&nbsp;<span class="op" id="3972711">=</span>&nbsp;<span class="ident" id="3972713">hs</span><span class="op" id="3972715">.</span><span class="ident" id="3972716">suite</span><span class="op" id="3972721">.</span><span class="ident" id="3972722">mac</span><span class="op" id="3972725">(</span><span class="ident" id="3972726">c</span><span class="op" id="3972727">.</span><span class="ident" id="3972728">vers</span><span class="op" id="3972732">,</span>&nbsp;<span class="ident" id="3972734">clientMAC</span><span class="op" id="3972743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972747">serverCipher</span>&nbsp;<span class="op" id="3972760">=</span>&nbsp;<span class="ident" id="3972762">hs</span><span class="op" id="3972764">.</span><span class="ident" id="3972765">suite</span><span class="op" id="3972770">.</span><span class="ident" id="3972771">cipher</span><span class="op" id="3972777">(</span><span class="ident" id="3972778">serverKey</span><span class="op" id="3972787">,</span>&nbsp;<span class="ident" id="3972789">serverIV</span><span class="op" id="3972797">,</span>&nbsp;<span class="builtintype" id="3972799">false</span>&nbsp;<span class="comment" id="3972805">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3972826">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972830">serverHash</span>&nbsp;<span class="op" id="3972841">=</span>&nbsp;<span class="ident" id="3972843">hs</span><span class="op" id="3972845">.</span><span class="ident" id="3972846">suite</span><span class="op" id="3972851">.</span><span class="ident" id="3972852">mac</span><span class="op" id="3972855">(</span><span class="ident" id="3972856">c</span><span class="op" id="3972857">.</span><span class="ident" id="3972858">vers</span><span class="op" id="3972862">,</span>&nbsp;<span class="ident" id="3972864">serverMAC</span><span class="op" id="3972873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3972876">}</span>&nbsp;<span class="keyword" id="3972878">else</span>&nbsp;<span class="op" id="3972883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972887">clientCipher</span>&nbsp;<span class="op" id="3972900">=</span>&nbsp;<span class="ident" id="3972902">hs</span><span class="op" id="3972904">.</span><span class="ident" id="3972905">suite</span><span class="op" id="3972910">.</span><span class="ident" id="3972911">aead</span><span class="op" id="3972915">(</span><span class="ident" id="3972916">clientKey</span><span class="op" id="3972925">,</span>&nbsp;<span class="ident" id="3972927">clientIV</span><span class="op" id="3972935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972939">serverCipher</span>&nbsp;<span class="op" id="3972952">=</span>&nbsp;<span class="ident" id="3972954">hs</span><span class="op" id="3972956">.</span><span class="ident" id="3972957">suite</span><span class="op" id="3972962">.</span><span class="ident" id="3972963">aead</span><span class="op" id="3972967">(</span><span class="ident" id="3972968">serverKey</span><span class="op" id="3972977">,</span>&nbsp;<span class="ident" id="3972979">serverIV</span><span class="op" id="3972987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3972990">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3972994">c</span><span class="op" id="3972995">.</span><span class="ident" id="3972996">in</span><span class="op" id="3972998">.</span><span class="ident" id="3972999">prepareCipherSpec</span><span class="op" id="3973016">(</span><span class="ident" id="3973017">c</span><span class="op" id="3973018">.</span><span class="ident" id="3973019">vers</span><span class="op" id="3973023">,</span>&nbsp;<span class="ident" id="3973025">clientCipher</span><span class="op" id="3973037">,</span>&nbsp;<span class="ident" id="3973039">clientHash</span><span class="op" id="3973049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973052">c</span><span class="op" id="3973053">.</span><span class="ident" id="3973054">out</span><span class="op" id="3973057">.</span><span class="ident" id="3973058">prepareCipherSpec</span><span class="op" id="3973075">(</span><span class="ident" id="3973076">c</span><span class="op" id="3973077">.</span><span class="ident" id="3973078">vers</span><span class="op" id="3973082">,</span>&nbsp;<span class="ident" id="3973084">serverCipher</span><span class="op" id="3973096">,</span>&nbsp;<span class="ident" id="3973098">serverHash</span><span class="op" id="3973108">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973112">return</span>&nbsp;<span class="ident" id="3973119">nil</span><br>
<span class="lineno">500</span><span class="op" id="3973123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3973126">func</span>&nbsp;<span class="op" id="3973131">(</span><span class="ident" id="3973132">hs</span>&nbsp;<span class="op" id="3973135">*</span><span class="ident" id="3973136">serverHandshakeState</span><span class="op" id="3973156">)</span>&nbsp;<span class="ident" id="3973158">readFinished</span><span class="op" id="3973170">(</span><span class="ident" id="3973171">out</span>&nbsp;<span class="op" id="3973175">[</span><span class="op" id="3973176">]</span><span class="builtintype" id="3973177">byte</span><span class="op" id="3973181">)</span>&nbsp;<span class="builtintype" id="3973183">error</span>&nbsp;<span class="op" id="3973189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973192">c</span>&nbsp;<span class="op" id="3973194">:=</span>&nbsp;<span class="ident" id="3973197">hs</span><span class="op" id="3973199">.</span><span class="ident" id="3973200">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973204">c</span><span class="op" id="3973205">.</span><span class="ident" id="3973206">readRecord</span><span class="op" id="3973216">(</span><span class="ident" id="3973217">recordTypeChangeCipherSpec</span><span class="op" id="3973243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973246">if</span>&nbsp;<span class="ident" id="3973249">err</span>&nbsp;<span class="op" id="3973253">:=</span>&nbsp;<span class="ident" id="3973256">c</span><span class="op" id="3973257">.</span><span class="ident" id="3973258">in</span><span class="op" id="3973260">.</span><span class="builtintype" id="3973261">error</span><span class="op" id="3973266">(</span><span class="op" id="3973267">)</span><span class="op" id="3973268">;</span>&nbsp;<span class="ident" id="3973270">err</span>&nbsp;<span class="op" id="3973274">!=</span>&nbsp;<span class="ident" id="3973277">nil</span>&nbsp;<span class="op" id="3973281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973285">return</span>&nbsp;<span class="ident" id="3973292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3973297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973301">if</span>&nbsp;<span class="ident" id="3973304">hs</span><span class="op" id="3973306">.</span><span class="ident" id="3973307">hello</span><span class="op" id="3973312">.</span><span class="ident" id="3973313">nextProtoNeg</span>&nbsp;<span class="op" id="3973326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973330">msg</span><span class="op" id="3973333">,</span>&nbsp;<span class="ident" id="3973335">err</span>&nbsp;<span class="op" id="3973339">:=</span>&nbsp;<span class="ident" id="3973342">c</span><span class="op" id="3973343">.</span><span class="ident" id="3973344">readHandshake</span><span class="op" id="3973357">(</span><span class="op" id="3973358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973362">if</span>&nbsp;<span class="ident" id="3973365">err</span>&nbsp;<span class="op" id="3973369">!=</span>&nbsp;<span class="ident" id="3973372">nil</span>&nbsp;<span class="op" id="3973376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973381">return</span>&nbsp;<span class="ident" id="3973388">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3973394">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973398">nextProto</span><span class="op" id="3973407">,</span>&nbsp;<span class="ident" id="3973409">ok</span>&nbsp;<span class="op" id="3973412">:=</span>&nbsp;<span class="ident" id="3973415">msg</span><span class="op" id="3973418">.</span><span class="op" id="3973419">(</span><span class="op" id="3973420">*</span><span class="ident" id="3973421">nextProtoMsg</span><span class="op" id="3973433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973437">if</span>&nbsp;<span class="op" id="3973440">!</span><span class="ident" id="3973441">ok</span>&nbsp;<span class="op" id="3973444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973449">c</span><span class="op" id="3973450">.</span><span class="ident" id="3973451">sendAlert</span><span class="op" id="3973460">(</span><span class="ident" id="3973461">alertUnexpectedMessage</span><span class="op" id="3973483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973488">return</span>&nbsp;<span class="ident" id="3973495">unexpectedMessageError</span><span class="op" id="3973517">(</span><span class="ident" id="3973518">nextProto</span><span class="op" id="3973527">,</span>&nbsp;<span class="ident" id="3973529">msg</span><span class="op" id="3973532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3973536">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973540">hs</span><span class="op" id="3973542">.</span><span class="ident" id="3973543">finishedHash</span><span class="op" id="3973555">.</span><span class="ident" id="3973556">Write</span><span class="op" id="3973561">(</span><span class="ident" id="3973562">nextProto</span><span class="op" id="3973571">.</span><span class="ident" id="3973572">marshal</span><span class="op" id="3973579">(</span><span class="op" id="3973580">)</span><span class="op" id="3973581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973585">c</span><span class="op" id="3973586">.</span><span class="ident" id="3973587">clientProtocol</span>&nbsp;<span class="op" id="3973602">=</span>&nbsp;<span class="ident" id="3973604">nextProto</span><span class="op" id="3973613">.</span><span class="ident" id="3973614">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3973621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973625">msg</span><span class="op" id="3973628">,</span>&nbsp;<span class="ident" id="3973630">err</span>&nbsp;<span class="op" id="3973634">:=</span>&nbsp;<span class="ident" id="3973637">c</span><span class="op" id="3973638">.</span><span class="ident" id="3973639">readHandshake</span><span class="op" id="3973652">(</span><span class="op" id="3973653">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973656">if</span>&nbsp;<span class="ident" id="3973659">err</span>&nbsp;<span class="op" id="3973663">!=</span>&nbsp;<span class="ident" id="3973666">nil</span>&nbsp;<span class="op" id="3973670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973674">return</span>&nbsp;<span class="ident" id="3973681">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3973686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973689">clientFinished</span><span class="op" id="3973703">,</span>&nbsp;<span class="ident" id="3973705">ok</span>&nbsp;<span class="op" id="3973708">:=</span>&nbsp;<span class="ident" id="3973711">msg</span><span class="op" id="3973714">.</span><span class="op" id="3973715">(</span><span class="op" id="3973716">*</span><span class="ident" id="3973717">finishedMsg</span><span class="op" id="3973728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973731">if</span>&nbsp;<span class="op" id="3973734">!</span><span class="ident" id="3973735">ok</span>&nbsp;<span class="op" id="3973738">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973742">c</span><span class="op" id="3973743">.</span><span class="ident" id="3973744">sendAlert</span><span class="op" id="3973753">(</span><span class="ident" id="3973754">alertUnexpectedMessage</span><span class="op" id="3973776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973780">return</span>&nbsp;<span class="ident" id="3973787">unexpectedMessageError</span><span class="op" id="3973809">(</span><span class="ident" id="3973810">clientFinished</span><span class="op" id="3973824">,</span>&nbsp;<span class="ident" id="3973826">msg</span><span class="op" id="3973829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3973832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973836">verify</span>&nbsp;<span class="op" id="3973843">:=</span>&nbsp;<span class="ident" id="3973846">hs</span><span class="op" id="3973848">.</span><span class="ident" id="3973849">finishedHash</span><span class="op" id="3973861">.</span><span class="ident" id="3973862">clientSum</span><span class="op" id="3973871">(</span><span class="ident" id="3973872">hs</span><span class="op" id="3973874">.</span><span class="ident" id="3973875">masterSecret</span><span class="op" id="3973887">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3973890">if</span>&nbsp;<span class="builtinfunc" id="3973893">len</span><span class="op" id="3973896">(</span><span class="ident" id="3973897">verify</span><span class="op" id="3973903">)</span>&nbsp;<span class="op" id="3973905">!=</span>&nbsp;<span class="builtinfunc" id="3973908">len</span><span class="op" id="3973911">(</span><span class="ident" id="3973912">clientFinished</span><span class="op" id="3973926">.</span><span class="ident" id="3973927">verifyData</span><span class="op" id="3973937">)</span>&nbsp;<span class="op" id="3973939">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973944">subtle</span><span class="op" id="3973950">.</span><span class="ident" id="3973951">ConstantTimeCompare</span><span class="op" id="3973970">(</span><span class="ident" id="3973971">verify</span><span class="op" id="3973977">,</span>&nbsp;<span class="ident" id="3973979">clientFinished</span><span class="op" id="3973993">.</span><span class="ident" id="3973994">verifyData</span><span class="op" id="3974004">)</span>&nbsp;<span class="op" id="3974006">!=</span>&nbsp;<span class="num" id="3974009">1</span>&nbsp;<span class="op" id="3974011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974015">c</span><span class="op" id="3974016">.</span><span class="ident" id="3974017">sendAlert</span><span class="op" id="3974026">(</span><span class="ident" id="3974027">alertHandshakeFailure</span><span class="op" id="3974048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974052">return</span>&nbsp;<span class="ident" id="3974059">errors</span><span class="op" id="3974065">.</span><span class="ident" id="3974066">New</span><span class="op" id="3974069">(</span><span class="string" id="3974070">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3974115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3974118">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974122">hs</span><span class="op" id="3974124">.</span><span class="ident" id="3974125">finishedHash</span><span class="op" id="3974137">.</span><span class="ident" id="3974138">Write</span><span class="op" id="3974143">(</span><span class="ident" id="3974144">clientFinished</span><span class="op" id="3974158">.</span><span class="ident" id="3974159">marshal</span><span class="op" id="3974166">(</span><span class="op" id="3974167">)</span><span class="op" id="3974168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3974171">copy</span><span class="op" id="3974175">(</span><span class="ident" id="3974176">out</span><span class="op" id="3974179">,</span>&nbsp;<span class="ident" id="3974181">verify</span><span class="op" id="3974187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974190">return</span>&nbsp;<span class="ident" id="3974197">nil</span><br>
<span class="lineno"></span><span class="op" id="3974201">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3974204">func</span>&nbsp;<span class="op" id="3974209">(</span><span class="ident" id="3974210">hs</span>&nbsp;<span class="op" id="3974213">*</span><span class="ident" id="3974214">serverHandshakeState</span><span class="op" id="3974234">)</span>&nbsp;<span class="ident" id="3974236">sendSessionTicket</span><span class="op" id="3974253">(</span><span class="op" id="3974254">)</span>&nbsp;<span class="builtintype" id="3974256">error</span>&nbsp;<span class="op" id="3974262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974265">if</span>&nbsp;<span class="op" id="3974268">!</span><span class="ident" id="3974269">hs</span><span class="op" id="3974271">.</span><span class="ident" id="3974272">hello</span><span class="op" id="3974277">.</span><span class="ident" id="3974278">ticketSupported</span>&nbsp;<span class="op" id="3974294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974298">return</span>&nbsp;<span class="ident" id="3974305">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3974310">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974314">c</span>&nbsp;<span class="op" id="3974316">:=</span>&nbsp;<span class="ident" id="3974319">hs</span><span class="op" id="3974321">.</span><span class="ident" id="3974322">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974325">m</span>&nbsp;<span class="op" id="3974327">:=</span>&nbsp;<span class="builtinfunc" id="3974330">new</span><span class="op" id="3974333">(</span><span class="ident" id="3974334">newSessionTicketMsg</span><span class="op" id="3974353">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974357">var</span>&nbsp;<span class="ident" id="3974361">err</span>&nbsp;<span class="builtintype" id="3974365">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974372">state</span>&nbsp;<span class="op" id="3974378">:=</span>&nbsp;<span class="ident" id="3974381">sessionState</span><span class="op" id="3974393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974397">vers</span><span class="op" id="3974401">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974411">c</span><span class="op" id="3974412">.</span><span class="ident" id="3974413">vers</span><span class="op" id="3974417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974421">cipherSuite</span><span class="op" id="3974432">:</span>&nbsp;&nbsp;<span class="ident" id="3974435">hs</span><span class="op" id="3974437">.</span><span class="ident" id="3974438">suite</span><span class="op" id="3974443">.</span><span class="ident" id="3974444">id</span><span class="op" id="3974446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974450">masterSecret</span><span class="op" id="3974462">:</span>&nbsp;<span class="ident" id="3974464">hs</span><span class="op" id="3974466">.</span><span class="ident" id="3974467">masterSecret</span><span class="op" id="3974479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974483">certificates</span><span class="op" id="3974495">:</span>&nbsp;<span class="ident" id="3974497">hs</span><span class="op" id="3974499">.</span><span class="ident" id="3974500">certsFromClient</span><span class="op" id="3974515">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3974518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974521">m</span><span class="op" id="3974522">.</span><span class="ident" id="3974523">ticket</span><span class="op" id="3974529">,</span>&nbsp;<span class="ident" id="3974531">err</span>&nbsp;<span class="op" id="3974535">=</span>&nbsp;<span class="ident" id="3974537">c</span><span class="op" id="3974538">.</span><span class="ident" id="3974539">encryptTicket</span><span class="op" id="3974552">(</span><span class="op" id="3974553">&amp;</span><span class="ident" id="3974554">state</span><span class="op" id="3974559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974562">if</span>&nbsp;<span class="ident" id="3974565">err</span>&nbsp;<span class="op" id="3974569">!=</span>&nbsp;<span class="ident" id="3974572">nil</span>&nbsp;<span class="op" id="3974576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974580">return</span>&nbsp;<span class="ident" id="3974587">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3974592">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974596">hs</span><span class="op" id="3974598">.</span><span class="ident" id="3974599">finishedHash</span><span class="op" id="3974611">.</span><span class="ident" id="3974612">Write</span><span class="op" id="3974617">(</span><span class="ident" id="3974618">m</span><span class="op" id="3974619">.</span><span class="ident" id="3974620">marshal</span><span class="op" id="3974627">(</span><span class="op" id="3974628">)</span><span class="op" id="3974629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974632">c</span><span class="op" id="3974633">.</span><span class="ident" id="3974634">writeRecord</span><span class="op" id="3974645">(</span><span class="ident" id="3974646">recordTypeHandshake</span><span class="op" id="3974665">,</span>&nbsp;<span class="ident" id="3974667">m</span><span class="op" id="3974668">.</span><span class="ident" id="3974669">marshal</span><span class="op" id="3974676">(</span><span class="op" id="3974677">)</span><span class="op" id="3974678">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3974682">return</span>&nbsp;<span class="ident" id="3974689">nil</span><br>
<span class="lineno">570</span><span class="op" id="3974693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3974696">func</span>&nbsp;<span class="op" id="3974701">(</span><span class="ident" id="3974702">hs</span>&nbsp;<span class="op" id="3974705">*</span><span class="ident" id="3974706">serverHandshakeState</span><span class="op" id="3974726">)</span>&nbsp;<span class="ident" id="3974728">sendFinished</span><span class="op" id="3974740">(</span><span class="ident" id="3974741">out</span>&nbsp;<span class="op" id="3974745">[</span><span class="op" id="3974746">]</span><span class="builtintype" id="3974747">byte</span><span class="op" id="3974751">)</span>&nbsp;<span class="builtintype" id="3974753">error</span>&nbsp;<span class="op" id="3974759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974762">c</span>&nbsp;<span class="op" id="3974764">:=</span>&nbsp;<span class="ident" id="3974767">hs</span><span class="op" id="3974769">.</span><span class="ident" id="3974770">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974774">c</span><span class="op" id="3974775">.</span><span class="ident" id="3974776">writeRecord</span><span class="op" id="3974787">(</span><span class="ident" id="3974788">recordTypeChangeCipherSpec</span><span class="op" id="3974814">,</span>&nbsp;<span class="op" id="3974816">[</span><span class="op" id="3974817">]</span><span class="builtintype" id="3974818">byte</span><span class="op" id="3974822">{</span><span class="num" id="3974823">1</span><span class="op" id="3974824">}</span><span class="op" id="3974825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974829">finished</span>&nbsp;<span class="op" id="3974838">:=</span>&nbsp;<span class="builtinfunc" id="3974841">new</span><span class="op" id="3974844">(</span><span class="ident" id="3974845">finishedMsg</span><span class="op" id="3974856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974859">finished</span><span class="op" id="3974867">.</span><span class="ident" id="3974868">verifyData</span>&nbsp;<span class="op" id="3974879">=</span>&nbsp;<span class="ident" id="3974881">hs</span><span class="op" id="3974883">.</span><span class="ident" id="3974884">finishedHash</span><span class="op" id="3974896">.</span><span class="ident" id="3974897">serverSum</span><span class="op" id="3974906">(</span><span class="ident" id="3974907">hs</span><span class="op" id="3974909">.</span><span class="ident" id="3974910">masterSecret</span><span class="op" id="3974922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974925">hs</span><span class="op" id="3974927">.</span><span class="ident" id="3974928">finishedHash</span><span class="op" id="3974940">.</span><span class="ident" id="3974941">Write</span><span class="op" id="3974946">(</span><span class="ident" id="3974947">finished</span><span class="op" id="3974955">.</span><span class="ident" id="3974956">marshal</span><span class="op" id="3974963">(</span><span class="op" id="3974964">)</span><span class="op" id="3974965">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3974968">c</span><span class="op" id="3974969">.</span><span class="ident" id="3974970">writeRecord</span><span class="op" id="3974981">(</span><span class="ident" id="3974982">recordTypeHandshake</span><span class="op" id="3975001">,</span>&nbsp;<span class="ident" id="3975003">finished</span><span class="op" id="3975011">.</span><span class="ident" id="3975012">marshal</span><span class="op" id="3975019">(</span><span class="op" id="3975020">)</span><span class="op" id="3975021">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975025">c</span><span class="op" id="3975026">.</span><span class="ident" id="3975027">cipherSuite</span>&nbsp;<span class="op" id="3975039">=</span>&nbsp;<span class="ident" id="3975041">hs</span><span class="op" id="3975043">.</span><span class="ident" id="3975044">suite</span><span class="op" id="3975049">.</span><span class="ident" id="3975050">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3975054">copy</span><span class="op" id="3975058">(</span><span class="ident" id="3975059">out</span><span class="op" id="3975062">,</span>&nbsp;<span class="ident" id="3975064">finished</span><span class="op" id="3975072">.</span><span class="ident" id="3975073">verifyData</span><span class="op" id="3975083">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3975087">return</span>&nbsp;<span class="ident" id="3975094">nil</span><br>
<span class="lineno"></span><span class="op" id="3975098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3975101">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3975178">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3975255">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3975298">func</span>&nbsp;<span class="op" id="3975303">(</span><span class="ident" id="3975304">hs</span>&nbsp;<span class="op" id="3975307">*</span><span class="ident" id="3975308">serverHandshakeState</span><span class="op" id="3975328">)</span>&nbsp;<span class="ident" id="3975330">processCertsFromClient</span><span class="op" id="3975352">(</span><span class="ident" id="3975353">certificates</span>&nbsp;<span class="op" id="3975366">[</span><span class="op" id="3975367">]</span><span class="op" id="3975368">[</span><span class="op" id="3975369">]</span><span class="builtintype" id="3975370">byte</span><span class="op" id="3975374">)</span>&nbsp;<span class="op" id="3975376">(</span><span class="ident" id="3975377">crypto</span><span class="op" id="3975383">.</span><span class="ident" id="3975384">PublicKey</span><span class="op" id="3975393">,</span>&nbsp;<span class="builtintype" id="3975395">error</span><span class="op" id="3975400">)</span>&nbsp;<span class="op" id="3975402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975405">c</span>&nbsp;<span class="op" id="3975407">:=</span>&nbsp;<span class="ident" id="3975410">hs</span><span class="op" id="3975412">.</span><span class="ident" id="3975413">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975417">hs</span><span class="op" id="3975419">.</span><span class="ident" id="3975420">certsFromClient</span>&nbsp;<span class="op" id="3975436">=</span>&nbsp;<span class="ident" id="3975438">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975452">certs</span>&nbsp;<span class="op" id="3975458">:=</span>&nbsp;<span class="builtinfunc" id="3975461">make</span><span class="op" id="3975465">(</span><span class="op" id="3975466">[</span><span class="op" id="3975467">]</span><span class="op" id="3975468">*</span><span class="ident" id="3975469">x509</span><span class="op" id="3975473">.</span><span class="ident" id="3975474">Certificate</span><span class="op" id="3975485">,</span>&nbsp;<span class="builtinfunc" id="3975487">len</span><span class="op" id="3975490">(</span><span class="ident" id="3975491">certificates</span><span class="op" id="3975503">)</span><span class="op" id="3975504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3975507">var</span>&nbsp;<span class="ident" id="3975511">err</span>&nbsp;<span class="builtintype" id="3975515">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3975522">for</span>&nbsp;<span class="ident" id="3975526">i</span><span class="op" id="3975527">,</span>&nbsp;<span class="ident" id="3975529">asn1Data</span>&nbsp;<span class="op" id="3975538">:=</span>&nbsp;<span class="keyword" id="3975541">range</span>&nbsp;<span class="ident" id="3975547">certificates</span>&nbsp;<span class="op" id="3975560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3975564">if</span>&nbsp;<span class="ident" id="3975567">certs</span><span class="op" id="3975572">[</span><span class="ident" id="3975573">i</span><span class="op" id="3975574">]</span><span class="op" id="3975575">,</span>&nbsp;<span class="ident" id="3975577">err</span>&nbsp;<span class="op" id="3975581">=</span>&nbsp;<span class="ident" id="3975583">x509</span><span class="op" id="3975587">.</span><span class="ident" id="3975588">ParseCertificate</span><span class="op" id="3975604">(</span><span class="ident" id="3975605">asn1Data</span><span class="op" id="3975613">)</span><span class="op" id="3975614">;</span>&nbsp;<span class="ident" id="3975616">err</span>&nbsp;<span class="op" id="3975620">!=</span>&nbsp;<span class="ident" id="3975623">nil</span>&nbsp;<span class="op" id="3975627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975632">c</span><span class="op" id="3975633">.</span><span class="ident" id="3975634">sendAlert</span><span class="op" id="3975643">(</span><span class="ident" id="3975644">alertBadCertificate</span><span class="op" id="3975663">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3975668">return</span>&nbsp;<span class="ident" id="3975675">nil</span><span class="op" id="3975678">,</span>&nbsp;<span class="ident" id="3975680">errors</span><span class="op" id="3975686">.</span><span class="ident" id="3975687">New</span><span class="op" id="3975690">(</span><span class="string" id="3975691">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3975735">+</span>&nbsp;<span class="ident" id="3975737">err</span><span class="op" id="3975740">.</span><span class="ident" id="3975741">Error</span><span class="op" id="3975746">(</span><span class="op" id="3975747">)</span><span class="op" id="3975748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3975752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3975755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3975759">if</span>&nbsp;<span class="ident" id="3975762">c</span><span class="op" id="3975763">.</span><span class="ident" id="3975764">config</span><span class="op" id="3975770">.</span><span class="ident" id="3975771">ClientAuth</span>&nbsp;<span class="op" id="3975782">&gt;=</span>&nbsp;<span class="ident" id="3975785">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="3975809">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3975812">len</span><span class="op" id="3975815">(</span><span class="ident" id="3975816">certs</span><span class="op" id="3975821">)</span>&nbsp;<span class="op" id="3975823">&gt;</span>&nbsp;<span class="num" id="3975825">0</span>&nbsp;<span class="op" id="3975827">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975831">opts</span>&nbsp;<span class="op" id="3975836">:=</span>&nbsp;<span class="ident" id="3975839">x509</span><span class="op" id="3975843">.</span><span class="ident" id="3975844">VerifyOptions</span><span class="op" id="3975857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975862">Roots</span><span class="op" id="3975867">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975877">c</span><span class="op" id="3975878">.</span><span class="ident" id="3975879">config</span><span class="op" id="3975885">.</span><span class="ident" id="3975886">ClientCAs</span><span class="op" id="3975895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975900">CurrentTime</span><span class="op" id="3975911">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3975915">c</span><span class="op" id="3975916">.</span><span class="ident" id="3975917">config</span><span class="op" id="3975923">.</span><span class="ident" id="3975924">time</span><span class="op" id="3975928">(</span><span class="op" id="3975929">)</span><span class="op" id="3975930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975935">Intermediates</span><span class="op" id="3975948">:</span>&nbsp;<span class="ident" id="3975950">x509</span><span class="op" id="3975954">.</span><span class="ident" id="3975955">NewCertPool</span><span class="op" id="3975966">(</span><span class="op" id="3975967">)</span><span class="op" id="3975968">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3975973">KeyUsages</span><span class="op" id="3975982">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3975988">[</span><span class="op" id="3975989">]</span><span class="ident" id="3975990">x509</span><span class="op" id="3975994">.</span><span class="ident" id="3975995">ExtKeyUsage</span><span class="op" id="3976006">{</span><span class="ident" id="3976007">x509</span><span class="op" id="3976011">.</span><span class="ident" id="3976012">ExtKeyUsageClientAuth</span><span class="op" id="3976033">}</span><span class="op" id="3976034">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976043">for</span>&nbsp;<span class="ident" id="3976047">_</span><span class="op" id="3976048">,</span>&nbsp;<span class="ident" id="3976050">cert</span>&nbsp;<span class="op" id="3976055">:=</span>&nbsp;<span class="keyword" id="3976058">range</span>&nbsp;<span class="ident" id="3976064">certs</span><span class="op" id="3976069">[</span><span class="num" id="3976070">1</span><span class="op" id="3976071">:</span><span class="op" id="3976072">]</span>&nbsp;<span class="op" id="3976074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976079">opts</span><span class="op" id="3976083">.</span><span class="ident" id="3976084">Intermediates</span><span class="op" id="3976097">.</span><span class="ident" id="3976098">AddCert</span><span class="op" id="3976105">(</span><span class="ident" id="3976106">cert</span><span class="op" id="3976110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976114">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976119">chains</span><span class="op" id="3976125">,</span>&nbsp;<span class="ident" id="3976127">err</span>&nbsp;<span class="op" id="3976131">:=</span>&nbsp;<span class="ident" id="3976134">certs</span><span class="op" id="3976139">[</span><span class="num" id="3976140">0</span><span class="op" id="3976141">]</span><span class="op" id="3976142">.</span><span class="ident" id="3976143">Verify</span><span class="op" id="3976149">(</span><span class="ident" id="3976150">opts</span><span class="op" id="3976154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976158">if</span>&nbsp;<span class="ident" id="3976161">err</span>&nbsp;<span class="op" id="3976165">!=</span>&nbsp;<span class="ident" id="3976168">nil</span>&nbsp;<span class="op" id="3976172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976177">c</span><span class="op" id="3976178">.</span><span class="ident" id="3976179">sendAlert</span><span class="op" id="3976188">(</span><span class="ident" id="3976189">alertBadCertificate</span><span class="op" id="3976208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976213">return</span>&nbsp;<span class="ident" id="3976220">nil</span><span class="op" id="3976223">,</span>&nbsp;<span class="ident" id="3976225">errors</span><span class="op" id="3976231">.</span><span class="ident" id="3976232">New</span><span class="op" id="3976235">(</span><span class="string" id="3976236">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3976283">+</span>&nbsp;<span class="ident" id="3976285">err</span><span class="op" id="3976288">.</span><span class="ident" id="3976289">Error</span><span class="op" id="3976294">(</span><span class="op" id="3976295">)</span><span class="op" id="3976296">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976305">ok</span>&nbsp;<span class="op" id="3976308">:=</span>&nbsp;<span class="builtintype" id="3976311">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976319">for</span>&nbsp;<span class="ident" id="3976323">_</span><span class="op" id="3976324">,</span>&nbsp;<span class="ident" id="3976326">ku</span>&nbsp;<span class="op" id="3976329">:=</span>&nbsp;<span class="keyword" id="3976332">range</span>&nbsp;<span class="ident" id="3976338">certs</span><span class="op" id="3976343">[</span><span class="num" id="3976344">0</span><span class="op" id="3976345">]</span><span class="op" id="3976346">.</span><span class="ident" id="3976347">ExtKeyUsage</span>&nbsp;<span class="op" id="3976359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976364">if</span>&nbsp;<span class="ident" id="3976367">ku</span>&nbsp;<span class="op" id="3976370">==</span>&nbsp;<span class="ident" id="3976373">x509</span><span class="op" id="3976377">.</span><span class="ident" id="3976378">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3976400">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976406">ok</span>&nbsp;<span class="op" id="3976409">=</span>&nbsp;<span class="builtintype" id="3976411">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976420">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976437">if</span>&nbsp;<span class="op" id="3976440">!</span><span class="ident" id="3976441">ok</span>&nbsp;<span class="op" id="3976444">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976449">c</span><span class="op" id="3976450">.</span><span class="ident" id="3976451">sendAlert</span><span class="op" id="3976460">(</span><span class="ident" id="3976461">alertHandshakeFailure</span><span class="op" id="3976482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976487">return</span>&nbsp;<span class="ident" id="3976494">nil</span><span class="op" id="3976497">,</span>&nbsp;<span class="ident" id="3976499">errors</span><span class="op" id="3976505">.</span><span class="ident" id="3976506">New</span><span class="op" id="3976509">(</span><span class="string" id="3976510">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3976613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976622">c</span><span class="op" id="3976623">.</span><span class="ident" id="3976624">verifiedChains</span>&nbsp;<span class="op" id="3976639">=</span>&nbsp;<span class="ident" id="3976641">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976653">if</span>&nbsp;<span class="builtinfunc" id="3976656">len</span><span class="op" id="3976659">(</span><span class="ident" id="3976660">certs</span><span class="op" id="3976665">)</span>&nbsp;<span class="op" id="3976667">&gt;</span>&nbsp;<span class="num" id="3976669">0</span>&nbsp;<span class="op" id="3976671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976675">var</span>&nbsp;<span class="ident" id="3976679">pub</span>&nbsp;<span class="ident" id="3976683">crypto</span><span class="op" id="3976689">.</span><span class="ident" id="3976690">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976702">switch</span>&nbsp;<span class="ident" id="3976709">key</span>&nbsp;<span class="op" id="3976713">:=</span>&nbsp;<span class="ident" id="3976716">certs</span><span class="op" id="3976721">[</span><span class="num" id="3976722">0</span><span class="op" id="3976723">]</span><span class="op" id="3976724">.</span><span class="ident" id="3976725">PublicKey</span><span class="op" id="3976734">.</span><span class="op" id="3976735">(</span><span class="keyword" id="3976736">type</span><span class="op" id="3976740">)</span>&nbsp;<span class="op" id="3976742">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976746">case</span>&nbsp;<span class="op" id="3976751">*</span><span class="ident" id="3976752">ecdsa</span><span class="op" id="3976757">.</span><span class="ident" id="3976758">PublicKey</span><span class="op" id="3976767">,</span>&nbsp;<span class="op" id="3976769">*</span><span class="ident" id="3976770">rsa</span><span class="op" id="3976773">.</span><span class="ident" id="3976774">PublicKey</span><span class="op" id="3976783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976788">pub</span>&nbsp;<span class="op" id="3976792">=</span>&nbsp;<span class="ident" id="3976794">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976800">default</span><span class="op" id="3976807">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976812">c</span><span class="op" id="3976813">.</span><span class="ident" id="3976814">sendAlert</span><span class="op" id="3976823">(</span><span class="ident" id="3976824">alertUnsupportedCertificate</span><span class="op" id="3976851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3976856">return</span>&nbsp;<span class="ident" id="3976863">nil</span><span class="op" id="3976866">,</span>&nbsp;<span class="ident" id="3976868">fmt</span><span class="op" id="3976871">.</span><span class="ident" id="3976872">Errorf</span><span class="op" id="3976878">(</span><span class="string" id="3976879">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3976952">,</span>&nbsp;<span class="ident" id="3976954">certs</span><span class="op" id="3976959">[</span><span class="num" id="3976960">0</span><span class="op" id="3976961">]</span><span class="op" id="3976962">.</span><span class="ident" id="3976963">PublicKey</span><span class="op" id="3976972">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3976976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976980">c</span><span class="op" id="3976981">.</span><span class="ident" id="3976982">peerCertificates</span>&nbsp;<span class="op" id="3976999">=</span>&nbsp;<span class="ident" id="3977001">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977009">return</span>&nbsp;<span class="ident" id="3977016">pub</span><span class="op" id="3977019">,</span>&nbsp;<span class="ident" id="3977021">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977030">return</span>&nbsp;<span class="ident" id="3977037">nil</span><span class="op" id="3977040">,</span>&nbsp;<span class="ident" id="3977042">nil</span><br>
<span class="lineno"></span><span class="op" id="3977046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3977049">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3977128">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3977153">func</span>&nbsp;<span class="op" id="3977158">(</span><span class="ident" id="3977159">c</span>&nbsp;<span class="op" id="3977161">*</span><span class="ident" id="3977162">Conn</span><span class="op" id="3977166">)</span>&nbsp;<span class="ident" id="3977168">tryCipherSuite</span><span class="op" id="3977182">(</span><span class="ident" id="3977183">id</span>&nbsp;<span class="builtintype" id="3977186">uint16</span><span class="op" id="3977192">,</span>&nbsp;<span class="ident" id="3977194">supportedCipherSuites</span>&nbsp;<span class="op" id="3977216">[</span><span class="op" id="3977217">]</span><span class="builtintype" id="3977218">uint16</span><span class="op" id="3977224">,</span>&nbsp;<span class="ident" id="3977226">version</span>&nbsp;<span class="builtintype" id="3977234">uint16</span><span class="op" id="3977240">,</span>&nbsp;<span class="ident" id="3977242">ellipticOk</span><span class="op" id="3977252">,</span>&nbsp;<span class="ident" id="3977254">ecdsaOk</span>&nbsp;<span class="builtintype" id="3977262">bool</span><span class="op" id="3977266">)</span>&nbsp;<span class="op" id="3977268">*</span><span class="ident" id="3977269">cipherSuite</span>&nbsp;<span class="op" id="3977281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977284">for</span>&nbsp;<span class="ident" id="3977288">_</span><span class="op" id="3977289">,</span>&nbsp;<span class="ident" id="3977291">supported</span>&nbsp;<span class="op" id="3977301">:=</span>&nbsp;<span class="keyword" id="3977304">range</span>&nbsp;<span class="ident" id="3977310">supportedCipherSuites</span>&nbsp;<span class="op" id="3977332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977336">if</span>&nbsp;<span class="ident" id="3977339">id</span>&nbsp;<span class="op" id="3977342">==</span>&nbsp;<span class="ident" id="3977345">supported</span>&nbsp;<span class="op" id="3977355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977360">var</span>&nbsp;<span class="ident" id="3977364">candidate</span>&nbsp;<span class="op" id="3977374">*</span><span class="ident" id="3977375">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977391">for</span>&nbsp;<span class="ident" id="3977395">_</span><span class="op" id="3977396">,</span>&nbsp;<span class="ident" id="3977398">s</span>&nbsp;<span class="op" id="3977400">:=</span>&nbsp;<span class="keyword" id="3977403">range</span>&nbsp;<span class="ident" id="3977409">cipherSuites</span>&nbsp;<span class="op" id="3977422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977428">if</span>&nbsp;<span class="ident" id="3977431">s</span><span class="op" id="3977432">.</span><span class="ident" id="3977433">id</span>&nbsp;<span class="op" id="3977436">==</span>&nbsp;<span class="ident" id="3977439">id</span>&nbsp;<span class="op" id="3977442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3977449">candidate</span>&nbsp;<span class="op" id="3977459">=</span>&nbsp;<span class="ident" id="3977461">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977468">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977478">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977488">if</span>&nbsp;<span class="ident" id="3977491">candidate</span>&nbsp;<span class="op" id="3977501">==</span>&nbsp;<span class="ident" id="3977504">nil</span>&nbsp;<span class="op" id="3977508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977514">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3977531">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3977579">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977610">if</span>&nbsp;<span class="op" id="3977613">(</span><span class="ident" id="3977614">candidate</span><span class="op" id="3977623">.</span><span class="ident" id="3977624">flags</span><span class="op" id="3977629">&amp;</span><span class="ident" id="3977630">suiteECDHE</span>&nbsp;<span class="op" id="3977641">!=</span>&nbsp;<span class="num" id="3977644">0</span><span class="op" id="3977645">)</span>&nbsp;<span class="op" id="3977647">&amp;&amp;</span>&nbsp;<span class="op" id="3977650">!</span><span class="ident" id="3977651">ellipticOk</span>&nbsp;<span class="op" id="3977662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977668">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977685">if</span>&nbsp;<span class="op" id="3977688">(</span><span class="ident" id="3977689">candidate</span><span class="op" id="3977698">.</span><span class="ident" id="3977699">flags</span><span class="op" id="3977704">&amp;</span><span class="ident" id="3977705">suiteECDSA</span>&nbsp;<span class="op" id="3977716">!=</span>&nbsp;<span class="num" id="3977719">0</span><span class="op" id="3977720">)</span>&nbsp;<span class="op" id="3977722">!=</span>&nbsp;<span class="ident" id="3977725">ecdsaOk</span>&nbsp;<span class="op" id="3977733">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977739">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977756">if</span>&nbsp;<span class="ident" id="3977759">version</span>&nbsp;<span class="op" id="3977767">&lt;</span>&nbsp;<span class="ident" id="3977769">VersionTLS12</span>&nbsp;<span class="op" id="3977782">&amp;&amp;</span>&nbsp;<span class="ident" id="3977785">candidate</span><span class="op" id="3977794">.</span><span class="ident" id="3977795">flags</span><span class="op" id="3977800">&amp;</span><span class="ident" id="3977801">suiteTLS12</span>&nbsp;<span class="op" id="3977812">!=</span>&nbsp;<span class="num" id="3977815">0</span>&nbsp;<span class="op" id="3977817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977823">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977835">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977840">return</span>&nbsp;<span class="ident" id="3977847">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3977862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3977866">return</span>&nbsp;<span class="ident" id="3977873">nil</span><br>
<span class="lineno">685</span><span class="op" id="3977877">}</span>
</div>
</body>
</html>
