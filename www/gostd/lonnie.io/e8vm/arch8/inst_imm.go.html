<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="3569823">package</span>&nbsp;<span class="ident" id="3569831">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3569838">//&nbsp;InstImm&nbsp;executes&nbsp;immediate&nbsp;instructions</span><br>
<span class="lineno"></span><span class="keyword" id="3569881">type</span>&nbsp;<span class="ident" id="3569886">instImm</span>&nbsp;<span class="keyword" id="3569894">struct</span><span class="op" id="3569900">{</span><span class="op" id="3569901">}</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3569904">//&nbsp;I&nbsp;executes&nbsp;the&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="3569935">//&nbsp;Might&nbsp;return&nbsp;invalid&nbsp;instruction&nbsp;exception,</span><br>
<span class="lineno"></span><span class="comment" id="3569982">//&nbsp;or&nbsp;memory&nbsp;related&nbsp;exceptions.</span><br>
<span class="lineno"></span><span class="keyword" id="3570015">func</span>&nbsp;<span class="op" id="3570020">(</span><span class="ident" id="3570021">i</span>&nbsp;<span class="op" id="3570023">*</span><span class="ident" id="3570024">instImm</span><span class="op" id="3570031">)</span>&nbsp;<span class="ident" id="3570033">I</span><span class="op" id="3570034">(</span><span class="ident" id="3570035">cpu</span>&nbsp;<span class="op" id="3570039">*</span><span class="ident" id="3570040">cpu</span><span class="op" id="3570043">,</span>&nbsp;<span class="ident" id="3570045">in</span>&nbsp;<span class="builtintype" id="3570048">uint32</span><span class="op" id="3570054">)</span>&nbsp;<span class="op" id="3570056">*</span><span class="ident" id="3570057">Excep</span>&nbsp;<span class="op" id="3570063">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570066">op</span>&nbsp;<span class="op" id="3570069">:=</span>&nbsp;<span class="op" id="3570072">(</span><span class="ident" id="3570073">in</span>&nbsp;<span class="op" id="3570076">&gt;&gt;</span>&nbsp;<span class="num" id="3570079">24</span><span class="op" id="3570081">)</span>&nbsp;<span class="op" id="3570083">&amp;</span>&nbsp;<span class="num" id="3570085">0xff</span>&nbsp;&nbsp;<span class="comment" id="3570091">//&nbsp;(32:24]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570103">dest</span>&nbsp;<span class="op" id="3570108">:=</span>&nbsp;<span class="op" id="3570111">(</span><span class="ident" id="3570112">in</span>&nbsp;<span class="op" id="3570115">&gt;&gt;</span>&nbsp;<span class="num" id="3570118">21</span><span class="op" id="3570120">)</span>&nbsp;<span class="op" id="3570122">&amp;</span>&nbsp;<span class="num" id="3570124">0x7</span>&nbsp;<span class="comment" id="3570128">//&nbsp;(24:21]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570140">src</span>&nbsp;<span class="op" id="3570144">:=</span>&nbsp;<span class="op" id="3570147">(</span><span class="ident" id="3570148">in</span>&nbsp;<span class="op" id="3570151">&gt;&gt;</span>&nbsp;<span class="num" id="3570154">18</span><span class="op" id="3570156">)</span>&nbsp;<span class="op" id="3570158">&amp;</span>&nbsp;<span class="num" id="3570160">0x7</span>&nbsp;&nbsp;<span class="comment" id="3570165">//&nbsp;(21:18]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570177">im</span>&nbsp;<span class="op" id="3570180">:=</span>&nbsp;<span class="ident" id="3570183">in</span>&nbsp;<span class="op" id="3570186">&amp;</span>&nbsp;<span class="num" id="3570188">0xffff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3570202">//&nbsp;(16:0]</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570214">s</span>&nbsp;<span class="op" id="3570216">:=</span>&nbsp;<span class="ident" id="3570219">cpu</span><span class="op" id="3570222">.</span><span class="ident" id="3570223">regs</span><span class="op" id="3570227">[</span><span class="ident" id="3570228">src</span><span class="op" id="3570231">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570234">d</span>&nbsp;<span class="op" id="3570236">:=</span>&nbsp;<span class="ident" id="3570239">cpu</span><span class="op" id="3570242">.</span><span class="ident" id="3570243">regs</span><span class="op" id="3570247">[</span><span class="ident" id="3570248">dest</span><span class="op" id="3570252">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570255">ims</span>&nbsp;<span class="op" id="3570259">:=</span>&nbsp;<span class="builtintype" id="3570262">uint32</span><span class="op" id="3570268">(</span><span class="builtintype" id="3570269">int32</span><span class="op" id="3570274">(</span><span class="ident" id="3570275">im</span><span class="op" id="3570277">&lt;&lt;</span><span class="num" id="3570279">16</span><span class="op" id="3570281">)</span>&nbsp;<span class="op" id="3570283">&gt;&gt;</span>&nbsp;<span class="num" id="3570286">16</span><span class="op" id="3570288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570291">addr</span>&nbsp;<span class="op" id="3570296">:=</span>&nbsp;<span class="ident" id="3570299">s</span>&nbsp;<span class="op" id="3570301">+</span>&nbsp;<span class="ident" id="3570303">ims</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570308">var</span>&nbsp;<span class="ident" id="3570312">e</span>&nbsp;<span class="op" id="3570314">*</span><span class="ident" id="3570315">Excep</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570322">var</span>&nbsp;<span class="ident" id="3570326">b</span>&nbsp;<span class="builtintype" id="3570328">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570335">switch</span>&nbsp;<span class="ident" id="3570342">op</span>&nbsp;<span class="op" id="3570345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570348">case</span>&nbsp;<span class="num" id="3570353">0</span><span class="op" id="3570354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3570358">panic</span><span class="op" id="3570363">(</span><span class="string" id="3570364">&#34;register&nbsp;based&nbsp;instruction&#34;</span><span class="op" id="3570392">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570395">case</span>&nbsp;<span class="num" id="3570400">1</span><span class="op" id="3570401">:</span>&nbsp;<span class="comment" id="3570403">//&nbsp;addi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570413">d</span>&nbsp;<span class="op" id="3570415">=</span>&nbsp;<span class="ident" id="3570417">s</span>&nbsp;<span class="op" id="3570419">+</span>&nbsp;<span class="ident" id="3570421">ims</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570426">case</span>&nbsp;<span class="num" id="3570431">2</span><span class="op" id="3570432">:</span>&nbsp;<span class="comment" id="3570434">//&nbsp;slti</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570444">if</span>&nbsp;<span class="builtintype" id="3570447">int32</span><span class="op" id="3570452">(</span><span class="ident" id="3570453">s</span><span class="op" id="3570454">)</span>&nbsp;<span class="op" id="3570456">&lt;</span>&nbsp;<span class="builtintype" id="3570458">int32</span><span class="op" id="3570463">(</span><span class="ident" id="3570464">ims</span><span class="op" id="3570467">)</span>&nbsp;<span class="op" id="3570469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570474">d</span>&nbsp;<span class="op" id="3570476">=</span>&nbsp;<span class="num" id="3570478">1</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570482">}</span>&nbsp;<span class="keyword" id="3570484">else</span>&nbsp;<span class="op" id="3570489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570494">d</span>&nbsp;<span class="op" id="3570496">=</span>&nbsp;<span class="num" id="3570498">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570505">case</span>&nbsp;<span class="num" id="3570510">3</span><span class="op" id="3570511">:</span>&nbsp;<span class="comment" id="3570513">//&nbsp;andi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570523">d</span>&nbsp;<span class="op" id="3570525">=</span>&nbsp;<span class="ident" id="3570527">s</span>&nbsp;<span class="op" id="3570529">&amp;</span>&nbsp;<span class="ident" id="3570531">im</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570535">case</span>&nbsp;<span class="num" id="3570540">4</span><span class="op" id="3570541">:</span>&nbsp;<span class="comment" id="3570543">//&nbsp;ori</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570552">d</span>&nbsp;<span class="op" id="3570554">=</span>&nbsp;<span class="ident" id="3570556">s</span>&nbsp;<span class="op" id="3570558">|</span>&nbsp;<span class="ident" id="3570560">im</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570564">case</span>&nbsp;<span class="num" id="3570569">5</span><span class="op" id="3570570">:</span>&nbsp;<span class="comment" id="3570572">//&nbsp;lui</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570581">d</span>&nbsp;<span class="op" id="3570583">=</span>&nbsp;<span class="ident" id="3570585">im</span>&nbsp;<span class="op" id="3570588">&lt;&lt;</span>&nbsp;<span class="num" id="3570591">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570595">case</span>&nbsp;<span class="num" id="3570600">6</span><span class="op" id="3570601">:</span>&nbsp;<span class="comment" id="3570603">//&nbsp;lw</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570611">d</span><span class="op" id="3570612">,</span>&nbsp;<span class="ident" id="3570614">e</span>&nbsp;<span class="op" id="3570616">=</span>&nbsp;<span class="ident" id="3570618">cpu</span><span class="op" id="3570621">.</span><span class="ident" id="3570622">readWord</span><span class="op" id="3570630">(</span><span class="ident" id="3570631">addr</span><span class="op" id="3570635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570638">case</span>&nbsp;<span class="num" id="3570643">7</span><span class="op" id="3570644">:</span>&nbsp;<span class="comment" id="3570646">//&nbsp;lb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570654">b</span><span class="op" id="3570655">,</span>&nbsp;<span class="ident" id="3570657">e</span>&nbsp;<span class="op" id="3570659">=</span>&nbsp;<span class="ident" id="3570661">cpu</span><span class="op" id="3570664">.</span><span class="ident" id="3570665">readByte</span><span class="op" id="3570673">(</span><span class="ident" id="3570674">addr</span><span class="op" id="3570678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570682">d</span>&nbsp;<span class="op" id="3570684">=</span>&nbsp;<span class="builtintype" id="3570686">uint32</span><span class="op" id="3570692">(</span><span class="builtintype" id="3570693">int32</span><span class="op" id="3570698">(</span><span class="builtintype" id="3570699">int8</span><span class="op" id="3570703">(</span><span class="ident" id="3570704">b</span><span class="op" id="3570705">)</span><span class="op" id="3570706">)</span><span class="op" id="3570707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570710">case</span>&nbsp;<span class="num" id="3570715">8</span><span class="op" id="3570716">:</span>&nbsp;<span class="comment" id="3570718">//&nbsp;lbu</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570727">b</span><span class="op" id="3570728">,</span>&nbsp;<span class="ident" id="3570730">e</span>&nbsp;<span class="op" id="3570732">=</span>&nbsp;<span class="ident" id="3570734">cpu</span><span class="op" id="3570737">.</span><span class="ident" id="3570738">readByte</span><span class="op" id="3570746">(</span><span class="ident" id="3570747">addr</span><span class="op" id="3570751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570755">d</span>&nbsp;<span class="op" id="3570757">=</span>&nbsp;<span class="builtintype" id="3570759">uint32</span><span class="op" id="3570765">(</span><span class="ident" id="3570766">b</span><span class="op" id="3570767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570770">case</span>&nbsp;<span class="num" id="3570775">9</span><span class="op" id="3570776">:</span>&nbsp;<span class="comment" id="3570778">//&nbsp;sw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570786">e</span>&nbsp;<span class="op" id="3570788">=</span>&nbsp;<span class="ident" id="3570790">cpu</span><span class="op" id="3570793">.</span><span class="ident" id="3570794">writeWord</span><span class="op" id="3570803">(</span><span class="ident" id="3570804">addr</span><span class="op" id="3570808">,</span>&nbsp;<span class="ident" id="3570810">d</span><span class="op" id="3570811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570814">case</span>&nbsp;<span class="num" id="3570819">10</span><span class="op" id="3570821">:</span>&nbsp;<span class="comment" id="3570823">//&nbsp;sb</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570831">e</span>&nbsp;<span class="op" id="3570833">=</span>&nbsp;<span class="ident" id="3570835">cpu</span><span class="op" id="3570838">.</span><span class="ident" id="3570839">writeByte</span><span class="op" id="3570848">(</span><span class="ident" id="3570849">addr</span><span class="op" id="3570853">,</span>&nbsp;<span class="builtintype" id="3570855">byte</span><span class="op" id="3570859">(</span><span class="ident" id="3570860">d</span><span class="op" id="3570861">)</span><span class="op" id="3570862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570865">default</span><span class="op" id="3570872">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570876">return</span>&nbsp;<span class="ident" id="3570883">errInvalidInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570903">if</span>&nbsp;<span class="ident" id="3570906">e</span>&nbsp;<span class="op" id="3570908">!=</span>&nbsp;<span class="ident" id="3570911">nil</span>&nbsp;<span class="op" id="3570915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570919">return</span>&nbsp;<span class="ident" id="3570926">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570933">cpu</span><span class="op" id="3570936">.</span><span class="ident" id="3570937">regs</span><span class="op" id="3570941">[</span><span class="ident" id="3570942">dest</span><span class="op" id="3570946">]</span>&nbsp;<span class="op" id="3570948">=</span>&nbsp;<span class="ident" id="3570950">d</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570953">return</span>&nbsp;<span class="ident" id="3570960">nil</span><br>
<span class="lineno"></span><span class="op" id="3570964">}</span>
</div>
</body>
</html>
