<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5579604">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5579659">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5579713">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5579764">package</span>&nbsp;<span class="ident" id="5579772">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579777">import</span>&nbsp;<span class="op" id="5579784">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5579787">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5579796">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5579806">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5579813">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5579818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5579821">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5579866">type</span>&nbsp;<span class="ident" id="5579871">writer</span>&nbsp;<span class="keyword" id="5579878">interface</span>&nbsp;<span class="op" id="5579888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5579891">io</span><span class="op" id="5579893">.</span><span class="ident" id="5579894">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5579906">Flush</span><span class="op" id="5579911">(</span><span class="op" id="5579912">)</span>&nbsp;<span class="builtintype" id="5579914">error</span><br>
<span class="lineno"></span><span class="op" id="5579920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5579923">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5580000">type</span>&nbsp;<span class="ident" id="5580005">errWriteCloser</span>&nbsp;<span class="keyword" id="5580020">struct</span>&nbsp;<span class="op" id="5580027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580030">err</span>&nbsp;<span class="builtintype" id="5580034">error</span><br>
<span class="lineno"></span><span class="op" id="5580040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5580043">func</span>&nbsp;<span class="op" id="5580048">(</span><span class="ident" id="5580049">e</span>&nbsp;<span class="op" id="5580051">*</span><span class="ident" id="5580052">errWriteCloser</span><span class="op" id="5580066">)</span>&nbsp;<span class="ident" id="5580068">Write</span><span class="op" id="5580073">(</span><span class="op" id="5580074">[</span><span class="op" id="5580075">]</span><span class="builtintype" id="5580076">byte</span><span class="op" id="5580080">)</span>&nbsp;<span class="op" id="5580082">(</span><span class="builtintype" id="5580083">int</span><span class="op" id="5580086">,</span>&nbsp;<span class="builtintype" id="5580088">error</span><span class="op" id="5580093">)</span>&nbsp;<span class="op" id="5580095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5580098">return</span>&nbsp;<span class="num" id="5580105">0</span><span class="op" id="5580106">,</span>&nbsp;<span class="ident" id="5580108">e</span><span class="op" id="5580109">.</span><span class="ident" id="5580110">err</span><br>
<span class="lineno"></span><span class="op" id="5580114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5580117">func</span>&nbsp;<span class="op" id="5580122">(</span><span class="ident" id="5580123">e</span>&nbsp;<span class="op" id="5580125">*</span><span class="ident" id="5580126">errWriteCloser</span><span class="op" id="5580140">)</span>&nbsp;<span class="ident" id="5580142">Close</span><span class="op" id="5580147">(</span><span class="op" id="5580148">)</span>&nbsp;<span class="builtintype" id="5580150">error</span>&nbsp;<span class="op" id="5580156">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5580159">return</span>&nbsp;<span class="ident" id="5580166">e</span><span class="op" id="5580167">.</span><span class="ident" id="5580168">err</span><br>
<span class="lineno"></span><span class="op" id="5580172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5580175">const</span>&nbsp;<span class="op" id="5580181">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580184">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580256">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580297">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5580309">=</span>&nbsp;<span class="num" id="5580311">1</span><span class="op" id="5580312">&lt;&lt;</span><span class="num" id="5580314">12</span>&nbsp;<span class="op" id="5580317">-</span>&nbsp;<span class="num" id="5580319">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580322">invalidCode</span>&nbsp;<span class="op" id="5580334">=</span>&nbsp;<span class="num" id="5580336">1</span><span class="op" id="5580337">&lt;&lt;</span><span class="num" id="5580339">32</span>&nbsp;<span class="op" id="5580342">-</span>&nbsp;<span class="num" id="5580344">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580347">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580424">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580503">tableSize</span>&nbsp;<span class="op" id="5580513">=</span>&nbsp;<span class="num" id="5580515">4</span>&nbsp;<span class="op" id="5580517">*</span>&nbsp;<span class="num" id="5580519">1</span>&nbsp;<span class="op" id="5580521">&lt;&lt;</span>&nbsp;<span class="num" id="5580524">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580528">tableMask</span>&nbsp;<span class="op" id="5580538">=</span>&nbsp;<span class="ident" id="5580540">tableSize</span>&nbsp;<span class="op" id="5580550">-</span>&nbsp;<span class="num" id="5580552">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580555">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580626">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580689">invalidEntry</span>&nbsp;<span class="op" id="5580702">=</span>&nbsp;<span class="num" id="5580704">0</span><br>
<span class="lineno">45</span><span class="op" id="5580706">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5580709">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5580739">type</span>&nbsp;<span class="ident" id="5580744">encoder</span>&nbsp;<span class="keyword" id="5580752">struct</span>&nbsp;<span class="op" id="5580759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580762">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580820">w</span>&nbsp;<span class="ident" id="5580822">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580830">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5580888">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580937">order</span>&nbsp;<span class="ident" id="5580943">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580950">write</span>&nbsp;<span class="keyword" id="5580956">func</span><span class="op" id="5580960">(</span><span class="op" id="5580961">*</span><span class="ident" id="5580962">encoder</span><span class="op" id="5580969">,</span>&nbsp;<span class="builtintype" id="5580971">uint32</span><span class="op" id="5580977">)</span>&nbsp;<span class="builtintype" id="5580979">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5580986">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5580992">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581000">nBits</span>&nbsp;<span class="builtintype" id="5581006">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581012">width</span>&nbsp;<span class="builtintype" id="5581018">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581024">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581076">litWidth</span>&nbsp;<span class="builtintype" id="5581085">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581091">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581145">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581208">hi</span><span class="op" id="5581210">,</span>&nbsp;<span class="ident" id="5581212">overflow</span>&nbsp;<span class="builtintype" id="5581221">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581229">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581303">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581367">savedCode</span>&nbsp;<span class="builtintype" id="5581377">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581385">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581460">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581514">err</span>&nbsp;<span class="builtintype" id="5581518">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581525">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581599">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581672">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5581743">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581777">table</span>&nbsp;<span class="op" id="5581783">[</span><span class="ident" id="5581784">tableSize</span><span class="op" id="5581793">]</span><span class="builtintype" id="5581794">uint32</span><br>
<span class="lineno"></span><span class="op" id="5581801">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5581804">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5581875">func</span>&nbsp;<span class="op" id="5581880">(</span><span class="ident" id="5581881">e</span>&nbsp;<span class="op" id="5581883">*</span><span class="ident" id="5581884">encoder</span><span class="op" id="5581891">)</span>&nbsp;<span class="ident" id="5581893">writeLSB</span><span class="op" id="5581901">(</span><span class="ident" id="5581902">c</span>&nbsp;<span class="builtintype" id="5581904">uint32</span><span class="op" id="5581910">)</span>&nbsp;<span class="builtintype" id="5581912">error</span>&nbsp;<span class="op" id="5581918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581921">e</span><span class="op" id="5581922">.</span><span class="ident" id="5581923">bits</span>&nbsp;<span class="op" id="5581928">|=</span>&nbsp;<span class="ident" id="5581931">c</span>&nbsp;<span class="op" id="5581933">&lt;&lt;</span>&nbsp;<span class="ident" id="5581936">e</span><span class="op" id="5581937">.</span><span class="ident" id="5581938">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5581945">e</span><span class="op" id="5581946">.</span><span class="ident" id="5581947">nBits</span>&nbsp;<span class="op" id="5581953">+=</span>&nbsp;<span class="ident" id="5581956">e</span><span class="op" id="5581957">.</span><span class="ident" id="5581958">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5581965">for</span>&nbsp;<span class="ident" id="5581969">e</span><span class="op" id="5581970">.</span><span class="ident" id="5581971">nBits</span>&nbsp;<span class="op" id="5581977">&gt;=</span>&nbsp;<span class="num" id="5581980">8</span>&nbsp;<span class="op" id="5581982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5581986">if</span>&nbsp;<span class="ident" id="5581989">err</span>&nbsp;<span class="op" id="5581993">:=</span>&nbsp;<span class="ident" id="5581996">e</span><span class="op" id="5581997">.</span><span class="ident" id="5581998">w</span><span class="op" id="5581999">.</span><span class="ident" id="5582000">WriteByte</span><span class="op" id="5582009">(</span><span class="builtintype" id="5582010">uint8</span><span class="op" id="5582015">(</span><span class="ident" id="5582016">e</span><span class="op" id="5582017">.</span><span class="ident" id="5582018">bits</span><span class="op" id="5582022">)</span><span class="op" id="5582023">)</span><span class="op" id="5582024">;</span>&nbsp;<span class="ident" id="5582026">err</span>&nbsp;<span class="op" id="5582030">!=</span>&nbsp;<span class="ident" id="5582033">nil</span>&nbsp;<span class="op" id="5582037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582042">return</span>&nbsp;<span class="ident" id="5582049">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5582055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582059">e</span><span class="op" id="5582060">.</span><span class="ident" id="5582061">bits</span>&nbsp;<span class="op" id="5582066">&gt;&gt;=</span>&nbsp;<span class="num" id="5582070">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582074">e</span><span class="op" id="5582075">.</span><span class="ident" id="5582076">nBits</span>&nbsp;<span class="op" id="5582082">-=</span>&nbsp;<span class="num" id="5582085">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5582088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582091">return</span>&nbsp;<span class="ident" id="5582098">nil</span><br>
<span class="lineno"></span><span class="op" id="5582102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5582105">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5582175">func</span>&nbsp;<span class="op" id="5582180">(</span><span class="ident" id="5582181">e</span>&nbsp;<span class="op" id="5582183">*</span><span class="ident" id="5582184">encoder</span><span class="op" id="5582191">)</span>&nbsp;<span class="ident" id="5582193">writeMSB</span><span class="op" id="5582201">(</span><span class="ident" id="5582202">c</span>&nbsp;<span class="builtintype" id="5582204">uint32</span><span class="op" id="5582210">)</span>&nbsp;<span class="builtintype" id="5582212">error</span>&nbsp;<span class="op" id="5582218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582221">e</span><span class="op" id="5582222">.</span><span class="ident" id="5582223">bits</span>&nbsp;<span class="op" id="5582228">|=</span>&nbsp;<span class="ident" id="5582231">c</span>&nbsp;<span class="op" id="5582233">&lt;&lt;</span>&nbsp;<span class="op" id="5582236">(</span><span class="num" id="5582237">32</span>&nbsp;<span class="op" id="5582240">-</span>&nbsp;<span class="ident" id="5582242">e</span><span class="op" id="5582243">.</span><span class="ident" id="5582244">width</span>&nbsp;<span class="op" id="5582250">-</span>&nbsp;<span class="ident" id="5582252">e</span><span class="op" id="5582253">.</span><span class="ident" id="5582254">nBits</span><span class="op" id="5582259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582262">e</span><span class="op" id="5582263">.</span><span class="ident" id="5582264">nBits</span>&nbsp;<span class="op" id="5582270">+=</span>&nbsp;<span class="ident" id="5582273">e</span><span class="op" id="5582274">.</span><span class="ident" id="5582275">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582282">for</span>&nbsp;<span class="ident" id="5582286">e</span><span class="op" id="5582287">.</span><span class="ident" id="5582288">nBits</span>&nbsp;<span class="op" id="5582294">&gt;=</span>&nbsp;<span class="num" id="5582297">8</span>&nbsp;<span class="op" id="5582299">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582303">if</span>&nbsp;<span class="ident" id="5582306">err</span>&nbsp;<span class="op" id="5582310">:=</span>&nbsp;<span class="ident" id="5582313">e</span><span class="op" id="5582314">.</span><span class="ident" id="5582315">w</span><span class="op" id="5582316">.</span><span class="ident" id="5582317">WriteByte</span><span class="op" id="5582326">(</span><span class="builtintype" id="5582327">uint8</span><span class="op" id="5582332">(</span><span class="ident" id="5582333">e</span><span class="op" id="5582334">.</span><span class="ident" id="5582335">bits</span>&nbsp;<span class="op" id="5582340">&gt;&gt;</span>&nbsp;<span class="num" id="5582343">24</span><span class="op" id="5582345">)</span><span class="op" id="5582346">)</span><span class="op" id="5582347">;</span>&nbsp;<span class="ident" id="5582349">err</span>&nbsp;<span class="op" id="5582353">!=</span>&nbsp;<span class="ident" id="5582356">nil</span>&nbsp;<span class="op" id="5582360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582365">return</span>&nbsp;<span class="ident" id="5582372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5582378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582382">e</span><span class="op" id="5582383">.</span><span class="ident" id="5582384">bits</span>&nbsp;<span class="op" id="5582389">&lt;&lt;=</span>&nbsp;<span class="num" id="5582393">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582397">e</span><span class="op" id="5582398">.</span><span class="ident" id="5582399">nBits</span>&nbsp;<span class="op" id="5582405">-=</span>&nbsp;<span class="num" id="5582408">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5582411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582414">return</span>&nbsp;<span class="ident" id="5582421">nil</span><br>
<span class="lineno"></span><span class="op" id="5582425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5582428">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5582506">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5582565">var</span>&nbsp;<span class="ident" id="5582569">errOutOfCodes</span>&nbsp;<span class="op" id="5582583">=</span>&nbsp;<span class="ident" id="5582585">errors</span><span class="op" id="5582591">.</span><span class="ident" id="5582592">New</span><span class="op" id="5582595">(</span><span class="string" id="5582596">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5582615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5582618">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5582691">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5582765">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5582809">func</span>&nbsp;<span class="op" id="5582814">(</span><span class="ident" id="5582815">e</span>&nbsp;<span class="op" id="5582817">*</span><span class="ident" id="5582818">encoder</span><span class="op" id="5582825">)</span>&nbsp;<span class="ident" id="5582827">incHi</span><span class="op" id="5582832">(</span><span class="op" id="5582833">)</span>&nbsp;<span class="builtintype" id="5582835">error</span>&nbsp;<span class="op" id="5582841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582844">e</span><span class="op" id="5582845">.</span><span class="ident" id="5582846">hi</span><span class="op" id="5582848">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582852">if</span>&nbsp;<span class="ident" id="5582855">e</span><span class="op" id="5582856">.</span><span class="ident" id="5582857">hi</span>&nbsp;<span class="op" id="5582860">==</span>&nbsp;<span class="ident" id="5582863">e</span><span class="op" id="5582864">.</span><span class="ident" id="5582865">overflow</span>&nbsp;<span class="op" id="5582874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582878">e</span><span class="op" id="5582879">.</span><span class="ident" id="5582880">width</span><span class="op" id="5582885">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582890">e</span><span class="op" id="5582891">.</span><span class="ident" id="5582892">overflow</span>&nbsp;<span class="op" id="5582901">&lt;&lt;=</span>&nbsp;<span class="num" id="5582905">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5582908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582911">if</span>&nbsp;<span class="ident" id="5582914">e</span><span class="op" id="5582915">.</span><span class="ident" id="5582916">hi</span>&nbsp;<span class="op" id="5582919">==</span>&nbsp;<span class="ident" id="5582922">maxCode</span>&nbsp;<span class="op" id="5582930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5582934">clear</span>&nbsp;<span class="op" id="5582940">:=</span>&nbsp;<span class="builtintype" id="5582943">uint32</span><span class="op" id="5582949">(</span><span class="num" id="5582950">1</span><span class="op" id="5582951">)</span>&nbsp;<span class="op" id="5582953">&lt;&lt;</span>&nbsp;<span class="ident" id="5582956">e</span><span class="op" id="5582957">.</span><span class="ident" id="5582958">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5582969">if</span>&nbsp;<span class="ident" id="5582972">err</span>&nbsp;<span class="op" id="5582976">:=</span>&nbsp;<span class="ident" id="5582979">e</span><span class="op" id="5582980">.</span><span class="ident" id="5582981">write</span><span class="op" id="5582986">(</span><span class="ident" id="5582987">e</span><span class="op" id="5582988">,</span>&nbsp;<span class="ident" id="5582990">clear</span><span class="op" id="5582995">)</span><span class="op" id="5582996">;</span>&nbsp;<span class="ident" id="5582998">err</span>&nbsp;<span class="op" id="5583002">!=</span>&nbsp;<span class="ident" id="5583005">nil</span>&nbsp;<span class="op" id="5583009">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583014">return</span>&nbsp;<span class="ident" id="5583021">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583031">e</span><span class="op" id="5583032">.</span><span class="ident" id="5583033">width</span>&nbsp;<span class="op" id="5583039">=</span>&nbsp;<span class="builtintype" id="5583041">uint</span><span class="op" id="5583045">(</span><span class="ident" id="5583046">e</span><span class="op" id="5583047">.</span><span class="ident" id="5583048">litWidth</span><span class="op" id="5583056">)</span>&nbsp;<span class="op" id="5583058">+</span>&nbsp;<span class="num" id="5583060">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583064">e</span><span class="op" id="5583065">.</span><span class="ident" id="5583066">hi</span>&nbsp;<span class="op" id="5583069">=</span>&nbsp;<span class="ident" id="5583071">clear</span>&nbsp;<span class="op" id="5583077">+</span>&nbsp;<span class="num" id="5583079">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583083">e</span><span class="op" id="5583084">.</span><span class="ident" id="5583085">overflow</span>&nbsp;<span class="op" id="5583094">=</span>&nbsp;<span class="ident" id="5583096">clear</span>&nbsp;<span class="op" id="5583102">&lt;&lt;</span>&nbsp;<span class="num" id="5583105">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583109">for</span>&nbsp;<span class="ident" id="5583113">i</span>&nbsp;<span class="op" id="5583115">:=</span>&nbsp;<span class="keyword" id="5583118">range</span>&nbsp;<span class="ident" id="5583124">e</span><span class="op" id="5583125">.</span><span class="ident" id="5583126">table</span>&nbsp;<span class="op" id="5583132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583137">e</span><span class="op" id="5583138">.</span><span class="ident" id="5583139">table</span><span class="op" id="5583144">[</span><span class="ident" id="5583145">i</span><span class="op" id="5583146">]</span>&nbsp;<span class="op" id="5583148">=</span>&nbsp;<span class="ident" id="5583150">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583169">return</span>&nbsp;<span class="ident" id="5583176">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583191">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583194">return</span>&nbsp;<span class="ident" id="5583201">nil</span><br>
<span class="lineno"></span><span class="op" id="5583205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5583208">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5583283">func</span>&nbsp;<span class="op" id="5583288">(</span><span class="ident" id="5583289">e</span>&nbsp;<span class="op" id="5583291">*</span><span class="ident" id="5583292">encoder</span><span class="op" id="5583299">)</span>&nbsp;<span class="ident" id="5583301">Write</span><span class="op" id="5583306">(</span><span class="ident" id="5583307">p</span>&nbsp;<span class="op" id="5583309">[</span><span class="op" id="5583310">]</span><span class="builtintype" id="5583311">byte</span><span class="op" id="5583315">)</span>&nbsp;<span class="op" id="5583317">(</span><span class="ident" id="5583318">n</span>&nbsp;<span class="builtintype" id="5583320">int</span><span class="op" id="5583323">,</span>&nbsp;<span class="ident" id="5583325">err</span>&nbsp;<span class="builtintype" id="5583329">error</span><span class="op" id="5583334">)</span>&nbsp;<span class="op" id="5583336">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583339">if</span>&nbsp;<span class="ident" id="5583342">e</span><span class="op" id="5583343">.</span><span class="ident" id="5583344">err</span>&nbsp;<span class="op" id="5583348">!=</span>&nbsp;<span class="ident" id="5583351">nil</span>&nbsp;<span class="op" id="5583355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583359">return</span>&nbsp;<span class="num" id="5583366">0</span><span class="op" id="5583367">,</span>&nbsp;<span class="ident" id="5583369">e</span><span class="op" id="5583370">.</span><span class="ident" id="5583371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583379">if</span>&nbsp;<span class="builtinfunc" id="5583382">len</span><span class="op" id="5583385">(</span><span class="ident" id="5583386">p</span><span class="op" id="5583387">)</span>&nbsp;<span class="op" id="5583389">==</span>&nbsp;<span class="num" id="5583392">0</span>&nbsp;<span class="op" id="5583394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583398">return</span>&nbsp;<span class="num" id="5583405">0</span><span class="op" id="5583406">,</span>&nbsp;<span class="ident" id="5583408">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583416">n</span>&nbsp;<span class="op" id="5583418">=</span>&nbsp;<span class="builtinfunc" id="5583420">len</span><span class="op" id="5583423">(</span><span class="ident" id="5583424">p</span><span class="op" id="5583425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583428">litMask</span>&nbsp;<span class="op" id="5583436">:=</span>&nbsp;<span class="builtintype" id="5583439">uint32</span><span class="op" id="5583445">(</span><span class="num" id="5583446">1</span><span class="op" id="5583447">&lt;&lt;</span><span class="ident" id="5583449">e</span><span class="op" id="5583450">.</span><span class="ident" id="5583451">litWidth</span>&nbsp;<span class="op" id="5583460">-</span>&nbsp;<span class="num" id="5583462">1</span><span class="op" id="5583463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583466">code</span>&nbsp;<span class="op" id="5583471">:=</span>&nbsp;<span class="ident" id="5583474">e</span><span class="op" id="5583475">.</span><span class="ident" id="5583476">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583487">if</span>&nbsp;<span class="ident" id="5583490">code</span>&nbsp;<span class="op" id="5583495">==</span>&nbsp;<span class="ident" id="5583498">invalidCode</span>&nbsp;<span class="op" id="5583510">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5583514">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583565">code</span><span class="op" id="5583569">,</span>&nbsp;<span class="ident" id="5583571">p</span>&nbsp;<span class="op" id="5583573">=</span>&nbsp;<span class="builtintype" id="5583575">uint32</span><span class="op" id="5583581">(</span><span class="ident" id="5583582">p</span><span class="op" id="5583583">[</span><span class="num" id="5583584">0</span><span class="op" id="5583585">]</span><span class="op" id="5583586">)</span><span class="op" id="5583587">&amp;</span><span class="ident" id="5583588">litMask</span><span class="op" id="5583595">,</span>&nbsp;<span class="ident" id="5583597">p</span><span class="op" id="5583598">[</span><span class="num" id="5583599">1</span><span class="op" id="5583600">:</span><span class="op" id="5583601">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583604">}</span><br>
<span class="lineno"></span><span class="ident" id="5583606">loop</span><span class="op" id="5583610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583613">for</span>&nbsp;<span class="ident" id="5583617">_</span><span class="op" id="5583618">,</span>&nbsp;<span class="ident" id="5583620">x</span>&nbsp;<span class="op" id="5583622">:=</span>&nbsp;<span class="keyword" id="5583625">range</span>&nbsp;<span class="ident" id="5583631">p</span>&nbsp;<span class="op" id="5583633">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583637">literal</span>&nbsp;<span class="op" id="5583645">:=</span>&nbsp;<span class="builtintype" id="5583648">uint32</span><span class="op" id="5583654">(</span><span class="ident" id="5583655">x</span><span class="op" id="5583656">)</span>&nbsp;<span class="op" id="5583658">&amp;</span>&nbsp;<span class="ident" id="5583660">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583670">key</span>&nbsp;<span class="op" id="5583674">:=</span>&nbsp;<span class="ident" id="5583677">code</span><span class="op" id="5583681">&lt;&lt;</span><span class="num" id="5583683">8</span>&nbsp;<span class="op" id="5583685">|</span>&nbsp;<span class="ident" id="5583687">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5583697">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5583770">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583803">hash</span>&nbsp;<span class="op" id="5583808">:=</span>&nbsp;<span class="op" id="5583811">(</span><span class="ident" id="5583812">key</span><span class="op" id="5583815">&gt;&gt;</span><span class="num" id="5583817">12</span>&nbsp;<span class="op" id="5583820">^</span>&nbsp;<span class="ident" id="5583822">key</span><span class="op" id="5583825">)</span>&nbsp;<span class="op" id="5583827">&amp;</span>&nbsp;<span class="ident" id="5583829">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583841">for</span>&nbsp;<span class="ident" id="5583845">h</span><span class="op" id="5583846">,</span>&nbsp;<span class="ident" id="5583848">t</span>&nbsp;<span class="op" id="5583850">:=</span>&nbsp;<span class="ident" id="5583853">hash</span><span class="op" id="5583857">,</span>&nbsp;<span class="ident" id="5583859">e</span><span class="op" id="5583860">.</span><span class="ident" id="5583861">table</span><span class="op" id="5583866">[</span><span class="ident" id="5583867">hash</span><span class="op" id="5583871">]</span><span class="op" id="5583872">;</span>&nbsp;<span class="ident" id="5583874">t</span>&nbsp;<span class="op" id="5583876">!=</span>&nbsp;<span class="ident" id="5583879">invalidEntry</span><span class="op" id="5583891">;</span>&nbsp;<span class="op" id="5583893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583898">if</span>&nbsp;<span class="ident" id="5583901">key</span>&nbsp;<span class="op" id="5583905">==</span>&nbsp;<span class="ident" id="5583908">t</span><span class="op" id="5583909">&gt;&gt;</span><span class="num" id="5583911">12</span>&nbsp;<span class="op" id="5583914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583920">code</span>&nbsp;<span class="op" id="5583925">=</span>&nbsp;<span class="ident" id="5583927">t</span>&nbsp;<span class="op" id="5583929">&amp;</span>&nbsp;<span class="ident" id="5583931">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5583943">continue</span>&nbsp;<span class="ident" id="5583952">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5583960">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583965">h</span>&nbsp;<span class="op" id="5583967">=</span>&nbsp;<span class="op" id="5583969">(</span><span class="ident" id="5583970">h</span>&nbsp;<span class="op" id="5583972">+</span>&nbsp;<span class="num" id="5583974">1</span><span class="op" id="5583975">)</span>&nbsp;<span class="op" id="5583977">&amp;</span>&nbsp;<span class="ident" id="5583979">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5583992">t</span>&nbsp;<span class="op" id="5583994">=</span>&nbsp;<span class="ident" id="5583996">e</span><span class="op" id="5583997">.</span><span class="ident" id="5583998">table</span><span class="op" id="5584003">[</span><span class="ident" id="5584004">h</span><span class="op" id="5584005">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5584013">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5584086">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584114">if</span>&nbsp;<span class="ident" id="5584117">e</span><span class="op" id="5584118">.</span><span class="ident" id="5584119">err</span>&nbsp;<span class="op" id="5584123">=</span>&nbsp;<span class="ident" id="5584125">e</span><span class="op" id="5584126">.</span><span class="ident" id="5584127">write</span><span class="op" id="5584132">(</span><span class="ident" id="5584133">e</span><span class="op" id="5584134">,</span>&nbsp;<span class="ident" id="5584136">code</span><span class="op" id="5584140">)</span><span class="op" id="5584141">;</span>&nbsp;<span class="ident" id="5584143">e</span><span class="op" id="5584144">.</span><span class="ident" id="5584145">err</span>&nbsp;<span class="op" id="5584149">!=</span>&nbsp;<span class="ident" id="5584152">nil</span>&nbsp;<span class="op" id="5584156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584161">return</span>&nbsp;<span class="num" id="5584168">0</span><span class="op" id="5584169">,</span>&nbsp;<span class="ident" id="5584171">e</span><span class="op" id="5584172">.</span><span class="ident" id="5584173">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5584183">code</span>&nbsp;<span class="op" id="5584188">=</span>&nbsp;<span class="ident" id="5584190">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5584200">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5584274">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584347">if</span>&nbsp;<span class="ident" id="5584350">err1</span>&nbsp;<span class="op" id="5584355">:=</span>&nbsp;<span class="ident" id="5584358">e</span><span class="op" id="5584359">.</span><span class="ident" id="5584360">incHi</span><span class="op" id="5584365">(</span><span class="op" id="5584366">)</span><span class="op" id="5584367">;</span>&nbsp;<span class="ident" id="5584369">err1</span>&nbsp;<span class="op" id="5584374">!=</span>&nbsp;<span class="ident" id="5584377">nil</span>&nbsp;<span class="op" id="5584381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584386">if</span>&nbsp;<span class="ident" id="5584389">err1</span>&nbsp;<span class="op" id="5584394">==</span>&nbsp;<span class="ident" id="5584397">errOutOfCodes</span>&nbsp;<span class="op" id="5584411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584417">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584429">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5584434">e</span><span class="op" id="5584435">.</span><span class="ident" id="5584436">err</span>&nbsp;<span class="op" id="5584440">=</span>&nbsp;<span class="ident" id="5584442">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584450">return</span>&nbsp;<span class="num" id="5584457">0</span><span class="op" id="5584458">,</span>&nbsp;<span class="ident" id="5584460">e</span><span class="op" id="5584461">.</span><span class="ident" id="5584462">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5584472">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584545">for</span>&nbsp;<span class="op" id="5584549">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584554">if</span>&nbsp;<span class="ident" id="5584557">e</span><span class="op" id="5584558">.</span><span class="ident" id="5584559">table</span><span class="op" id="5584564">[</span><span class="ident" id="5584565">hash</span><span class="op" id="5584569">]</span>&nbsp;<span class="op" id="5584571">==</span>&nbsp;<span class="ident" id="5584574">invalidEntry</span>&nbsp;<span class="op" id="5584587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5584593">e</span><span class="op" id="5584594">.</span><span class="ident" id="5584595">table</span><span class="op" id="5584600">[</span><span class="ident" id="5584601">hash</span><span class="op" id="5584605">]</span>&nbsp;<span class="op" id="5584607">=</span>&nbsp;<span class="op" id="5584609">(</span><span class="ident" id="5584610">key</span>&nbsp;<span class="op" id="5584614">&lt;&lt;</span>&nbsp;<span class="num" id="5584617">12</span><span class="op" id="5584619">)</span>&nbsp;<span class="op" id="5584621">|</span>&nbsp;<span class="ident" id="5584623">e</span><span class="op" id="5584624">.</span><span class="ident" id="5584625">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584632">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5584646">hash</span>&nbsp;<span class="op" id="5584651">=</span>&nbsp;<span class="op" id="5584653">(</span><span class="ident" id="5584654">hash</span>&nbsp;<span class="op" id="5584659">+</span>&nbsp;<span class="num" id="5584661">1</span><span class="op" id="5584662">)</span>&nbsp;<span class="op" id="5584664">&amp;</span>&nbsp;<span class="ident" id="5584666">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5584684">e</span><span class="op" id="5584685">.</span><span class="ident" id="5584686">savedCode</span>&nbsp;<span class="op" id="5584696">=</span>&nbsp;<span class="ident" id="5584698">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584704">return</span>&nbsp;<span class="ident" id="5584711">n</span><span class="op" id="5584712">,</span>&nbsp;<span class="ident" id="5584714">nil</span><br>
<span class="lineno"></span><span class="op" id="5584718">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5584721">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5584800">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5584832">func</span>&nbsp;<span class="op" id="5584837">(</span><span class="ident" id="5584838">e</span>&nbsp;<span class="op" id="5584840">*</span><span class="ident" id="5584841">encoder</span><span class="op" id="5584848">)</span>&nbsp;<span class="ident" id="5584850">Close</span><span class="op" id="5584855">(</span><span class="op" id="5584856">)</span>&nbsp;<span class="builtintype" id="5584858">error</span>&nbsp;<span class="op" id="5584864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584867">if</span>&nbsp;<span class="ident" id="5584870">e</span><span class="op" id="5584871">.</span><span class="ident" id="5584872">err</span>&nbsp;<span class="op" id="5584876">!=</span>&nbsp;<span class="ident" id="5584879">nil</span>&nbsp;<span class="op" id="5584883">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584887">if</span>&nbsp;<span class="ident" id="5584890">e</span><span class="op" id="5584891">.</span><span class="ident" id="5584892">err</span>&nbsp;<span class="op" id="5584896">==</span>&nbsp;<span class="ident" id="5584899">errClosed</span>&nbsp;<span class="op" id="5584909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584914">return</span>&nbsp;<span class="ident" id="5584921">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5584931">return</span>&nbsp;<span class="ident" id="5584938">e</span><span class="op" id="5584939">.</span><span class="ident" id="5584940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5584945">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5584948">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585001">e</span><span class="op" id="5585002">.</span><span class="ident" id="5585003">err</span>&nbsp;<span class="op" id="5585007">=</span>&nbsp;<span class="ident" id="5585009">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5585020">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585054">if</span>&nbsp;<span class="ident" id="5585057">e</span><span class="op" id="5585058">.</span><span class="ident" id="5585059">savedCode</span>&nbsp;<span class="op" id="5585069">!=</span>&nbsp;<span class="ident" id="5585072">invalidCode</span>&nbsp;<span class="op" id="5585084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585088">if</span>&nbsp;<span class="ident" id="5585091">err</span>&nbsp;<span class="op" id="5585095">:=</span>&nbsp;<span class="ident" id="5585098">e</span><span class="op" id="5585099">.</span><span class="ident" id="5585100">write</span><span class="op" id="5585105">(</span><span class="ident" id="5585106">e</span><span class="op" id="5585107">,</span>&nbsp;<span class="ident" id="5585109">e</span><span class="op" id="5585110">.</span><span class="ident" id="5585111">savedCode</span><span class="op" id="5585120">)</span><span class="op" id="5585121">;</span>&nbsp;<span class="ident" id="5585123">err</span>&nbsp;<span class="op" id="5585127">!=</span>&nbsp;<span class="ident" id="5585130">nil</span>&nbsp;<span class="op" id="5585134">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585139">return</span>&nbsp;<span class="ident" id="5585146">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585156">if</span>&nbsp;<span class="ident" id="5585159">err</span>&nbsp;<span class="op" id="5585163">:=</span>&nbsp;<span class="ident" id="5585166">e</span><span class="op" id="5585167">.</span><span class="ident" id="5585168">incHi</span><span class="op" id="5585173">(</span><span class="op" id="5585174">)</span><span class="op" id="5585175">;</span>&nbsp;<span class="ident" id="5585177">err</span>&nbsp;<span class="op" id="5585181">!=</span>&nbsp;<span class="ident" id="5585184">nil</span>&nbsp;<span class="op" id="5585188">&amp;&amp;</span>&nbsp;<span class="ident" id="5585191">err</span>&nbsp;<span class="op" id="5585195">!=</span>&nbsp;<span class="ident" id="5585198">errOutOfCodes</span>&nbsp;<span class="op" id="5585212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585217">return</span>&nbsp;<span class="ident" id="5585224">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585230">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5585236">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585260">eof</span>&nbsp;<span class="op" id="5585264">:=</span>&nbsp;<span class="builtintype" id="5585267">uint32</span><span class="op" id="5585273">(</span><span class="num" id="5585274">1</span><span class="op" id="5585275">)</span><span class="op" id="5585276">&lt;&lt;</span><span class="ident" id="5585278">e</span><span class="op" id="5585279">.</span><span class="ident" id="5585280">litWidth</span>&nbsp;<span class="op" id="5585289">+</span>&nbsp;<span class="num" id="5585291">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585294">if</span>&nbsp;<span class="ident" id="5585297">err</span>&nbsp;<span class="op" id="5585301">:=</span>&nbsp;<span class="ident" id="5585304">e</span><span class="op" id="5585305">.</span><span class="ident" id="5585306">write</span><span class="op" id="5585311">(</span><span class="ident" id="5585312">e</span><span class="op" id="5585313">,</span>&nbsp;<span class="ident" id="5585315">eof</span><span class="op" id="5585318">)</span><span class="op" id="5585319">;</span>&nbsp;<span class="ident" id="5585321">err</span>&nbsp;<span class="op" id="5585325">!=</span>&nbsp;<span class="ident" id="5585328">nil</span>&nbsp;<span class="op" id="5585332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585336">return</span>&nbsp;<span class="ident" id="5585343">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5585351">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585377">if</span>&nbsp;<span class="ident" id="5585380">e</span><span class="op" id="5585381">.</span><span class="ident" id="5585382">nBits</span>&nbsp;<span class="op" id="5585388">&gt;</span>&nbsp;<span class="num" id="5585390">0</span>&nbsp;<span class="op" id="5585392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585396">if</span>&nbsp;<span class="ident" id="5585399">e</span><span class="op" id="5585400">.</span><span class="ident" id="5585401">order</span>&nbsp;<span class="op" id="5585407">==</span>&nbsp;<span class="ident" id="5585410">MSB</span>&nbsp;<span class="op" id="5585414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585419">e</span><span class="op" id="5585420">.</span><span class="ident" id="5585421">bits</span>&nbsp;<span class="op" id="5585426">&gt;&gt;=</span>&nbsp;<span class="num" id="5585430">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585439">if</span>&nbsp;<span class="ident" id="5585442">err</span>&nbsp;<span class="op" id="5585446">:=</span>&nbsp;<span class="ident" id="5585449">e</span><span class="op" id="5585450">.</span><span class="ident" id="5585451">w</span><span class="op" id="5585452">.</span><span class="ident" id="5585453">WriteByte</span><span class="op" id="5585462">(</span><span class="builtintype" id="5585463">uint8</span><span class="op" id="5585468">(</span><span class="ident" id="5585469">e</span><span class="op" id="5585470">.</span><span class="ident" id="5585471">bits</span><span class="op" id="5585475">)</span><span class="op" id="5585476">)</span><span class="op" id="5585477">;</span>&nbsp;<span class="ident" id="5585479">err</span>&nbsp;<span class="op" id="5585483">!=</span>&nbsp;<span class="ident" id="5585486">nil</span>&nbsp;<span class="op" id="5585490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585495">return</span>&nbsp;<span class="ident" id="5585502">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5585511">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585514">return</span>&nbsp;<span class="ident" id="5585521">e</span><span class="op" id="5585522">.</span><span class="ident" id="5585523">w</span><span class="op" id="5585524">.</span><span class="ident" id="5585525">Flush</span><span class="op" id="5585530">(</span><span class="op" id="5585531">)</span><br>
<span class="lineno"></span><span class="op" id="5585533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5585536">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5585579">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5585653">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5585728">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5585749">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5585822">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5585857">func</span>&nbsp;<span class="ident" id="5585862">NewWriter</span><span class="op" id="5585871">(</span><span class="ident" id="5585872">w</span>&nbsp;<span class="ident" id="5585874">io</span><span class="op" id="5585876">.</span><span class="ident" id="5585877">Writer</span><span class="op" id="5585883">,</span>&nbsp;<span class="ident" id="5585885">order</span>&nbsp;<span class="ident" id="5585891">Order</span><span class="op" id="5585896">,</span>&nbsp;<span class="ident" id="5585898">litWidth</span>&nbsp;<span class="builtintype" id="5585907">int</span><span class="op" id="5585910">)</span>&nbsp;<span class="ident" id="5585912">io</span><span class="op" id="5585914">.</span><span class="ident" id="5585915">WriteCloser</span>&nbsp;<span class="op" id="5585927">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585930">var</span>&nbsp;<span class="ident" id="5585934">write</span>&nbsp;<span class="keyword" id="5585940">func</span><span class="op" id="5585944">(</span><span class="op" id="5585945">*</span><span class="ident" id="5585946">encoder</span><span class="op" id="5585953">,</span>&nbsp;<span class="builtintype" id="5585955">uint32</span><span class="op" id="5585961">)</span>&nbsp;<span class="builtintype" id="5585963">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585970">switch</span>&nbsp;<span class="ident" id="5585977">order</span>&nbsp;<span class="op" id="5585983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5585986">case</span>&nbsp;<span class="ident" id="5585991">LSB</span><span class="op" id="5585994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585998">write</span>&nbsp;<span class="op" id="5586004">=</span>&nbsp;<span class="op" id="5586006">(</span><span class="op" id="5586007">*</span><span class="ident" id="5586008">encoder</span><span class="op" id="5586015">)</span><span class="op" id="5586016">.</span><span class="ident" id="5586017">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586027">case</span>&nbsp;<span class="ident" id="5586032">MSB</span><span class="op" id="5586035">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586039">write</span>&nbsp;<span class="op" id="5586045">=</span>&nbsp;<span class="op" id="5586047">(</span><span class="op" id="5586048">*</span><span class="ident" id="5586049">encoder</span><span class="op" id="5586056">)</span><span class="op" id="5586057">.</span><span class="ident" id="5586058">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586068">default</span><span class="op" id="5586075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586079">return</span>&nbsp;<span class="op" id="5586086">&amp;</span><span class="ident" id="5586087">errWriteCloser</span><span class="op" id="5586101">{</span><span class="ident" id="5586102">errors</span><span class="op" id="5586108">.</span><span class="ident" id="5586109">New</span><span class="op" id="5586112">(</span><span class="string" id="5586113">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5586133">)</span><span class="op" id="5586134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5586137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586140">if</span>&nbsp;<span class="ident" id="5586143">litWidth</span>&nbsp;<span class="op" id="5586152">&lt;</span>&nbsp;<span class="num" id="5586154">2</span>&nbsp;<span class="op" id="5586156">||</span>&nbsp;<span class="num" id="5586159">8</span>&nbsp;<span class="op" id="5586161">&lt;</span>&nbsp;<span class="ident" id="5586163">litWidth</span>&nbsp;<span class="op" id="5586172">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586176">return</span>&nbsp;<span class="op" id="5586183">&amp;</span><span class="ident" id="5586184">errWriteCloser</span><span class="op" id="5586198">{</span><span class="ident" id="5586199">fmt</span><span class="op" id="5586202">.</span><span class="ident" id="5586203">Errorf</span><span class="op" id="5586209">(</span><span class="string" id="5586210">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5586241">,</span>&nbsp;<span class="ident" id="5586243">litWidth</span><span class="op" id="5586251">)</span><span class="op" id="5586252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5586255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586258">bw</span><span class="op" id="5586260">,</span>&nbsp;<span class="ident" id="5586262">ok</span>&nbsp;<span class="op" id="5586265">:=</span>&nbsp;<span class="ident" id="5586268">w</span><span class="op" id="5586269">.</span><span class="op" id="5586270">(</span><span class="ident" id="5586271">writer</span><span class="op" id="5586277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586280">if</span>&nbsp;<span class="op" id="5586283">!</span><span class="ident" id="5586284">ok</span>&nbsp;<span class="op" id="5586287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586291">bw</span>&nbsp;<span class="op" id="5586294">=</span>&nbsp;<span class="ident" id="5586296">bufio</span><span class="op" id="5586301">.</span><span class="ident" id="5586302">NewWriter</span><span class="op" id="5586311">(</span><span class="ident" id="5586312">w</span><span class="op" id="5586313">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5586316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586319">lw</span>&nbsp;<span class="op" id="5586322">:=</span>&nbsp;<span class="builtintype" id="5586325">uint</span><span class="op" id="5586329">(</span><span class="ident" id="5586330">litWidth</span><span class="op" id="5586338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5586341">return</span>&nbsp;<span class="op" id="5586348">&amp;</span><span class="ident" id="5586349">encoder</span><span class="op" id="5586356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586360">w</span><span class="op" id="5586361">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586371">bw</span><span class="op" id="5586373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586377">order</span><span class="op" id="5586382">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586388">order</span><span class="op" id="5586393">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586397">write</span><span class="op" id="5586402">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586408">write</span><span class="op" id="5586413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586417">width</span><span class="op" id="5586422">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5586428">1</span>&nbsp;<span class="op" id="5586430">+</span>&nbsp;<span class="ident" id="5586432">lw</span><span class="op" id="5586434">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586438">litWidth</span><span class="op" id="5586446">:</span>&nbsp;&nbsp;<span class="ident" id="5586449">lw</span><span class="op" id="5586451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586455">hi</span><span class="op" id="5586457">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5586466">1</span><span class="op" id="5586467">&lt;&lt;</span><span class="ident" id="5586469">lw</span>&nbsp;<span class="op" id="5586472">+</span>&nbsp;<span class="num" id="5586474">1</span><span class="op" id="5586475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586479">overflow</span><span class="op" id="5586487">:</span>&nbsp;&nbsp;<span class="num" id="5586490">1</span>&nbsp;<span class="op" id="5586492">&lt;&lt;</span>&nbsp;<span class="op" id="5586495">(</span><span class="ident" id="5586496">lw</span>&nbsp;<span class="op" id="5586499">+</span>&nbsp;<span class="num" id="5586501">1</span><span class="op" id="5586502">)</span><span class="op" id="5586503">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586507">savedCode</span><span class="op" id="5586516">:</span>&nbsp;<span class="ident" id="5586518">invalidCode</span><span class="op" id="5586529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5586532">}</span><br>
<span class="lineno"></span><span class="op" id="5586534">}</span>
</div>
</body>
</html>
