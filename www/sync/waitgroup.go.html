<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1852525">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1852580">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1852634">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1852685">package</span>&nbsp;<span class="ident" id="1852693">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1852699">import</span>&nbsp;<span class="op" id="1852706">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1852709">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1852724">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1852733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1852736">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1852799">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1852852">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1852908">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1852965">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1853030">type</span>&nbsp;<span class="ident" id="1853035">WaitGroup</span>&nbsp;<span class="keyword" id="1853045">struct</span>&nbsp;<span class="op" id="1853052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1853055">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1853063"><a href="/sync/mutex.go.html#1837076">Mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1853070">counter</span>&nbsp;<span class="builtintype" id="1853078">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1853085">waiters</span>&nbsp;<span class="builtintype" id="1853093">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1853100">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1853108">*</span><span class="builtintype" id="1853109">uint32</span><br>
<span class="lineno"></span><span class="op" id="1853116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1853119">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1853184">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1853237">//</span><br>
<span class="lineno"></span><span class="comment" id="1853240">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1853254">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1853269">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1853341">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1853422">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1853488">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1853539">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1853554">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1853629">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1853697">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1853774">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1853819">//</span><br>
<span class="lineno">40</span><span class="comment" id="1853822">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1853899">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1853974">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1854053">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1854069">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1854146">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1854205">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1854235">func</span>&nbsp;<span class="op" id="1854240">(</span><span class="ident" id="1854241">wg</span>&nbsp;<span class="op" id="1854244">*</span><span class="ident" id="1854245"><a href="/sync/waitgroup.go.html#1853035">WaitGroup</a></span><span class="op" id="1854254">)</span>&nbsp;<span class="ident" id="1854256">Add</span><span class="op" id="1854259">(</span><span class="ident" id="1854260">delta</span>&nbsp;<span class="builtintype" id="1854266">int</span><span class="op" id="1854269">)</span>&nbsp;<span class="op" id="1854271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854274">if</span>&nbsp;<span class="ident" id="1854277"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1854289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1854293">_</span>&nbsp;<span class="op" id="1854295">=</span>&nbsp;<span class="ident" id="1854297"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854299">.</span><span class="ident" id="1854300">m</span><span class="op" id="1854301">.</span><span class="ident" id="1854302">state</span>&nbsp;<span class="comment" id="1854308">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854337">if</span>&nbsp;<span class="ident" id="1854340"><a href="/sync/waitgroup.go.html#1854260">delta</a></span>&nbsp;<span class="op" id="1854346">&lt;</span>&nbsp;<span class="num" id="1854348">0</span>&nbsp;<span class="op" id="1854350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1854355">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1854395"><a href="/sync/race0.go.html#1847273">raceReleaseMerge</a></span><span class="op" id="1854411">(</span><span class="ident" id="1854412"><a href="/sync/waitgroup.go.html#1852724">unsafe</a></span><span class="op" id="1854418">.</span><span class="ident" id="1854419">Pointer</span><span class="op" id="1854426">(</span><span class="ident" id="1854427"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854429">)</span><span class="op" id="1854430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1854434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1854438"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1854449">(</span><span class="op" id="1854450">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854454">defer</span>&nbsp;<span class="ident" id="1854460"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1854470">(</span><span class="op" id="1854471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1854474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1854477">v</span>&nbsp;<span class="op" id="1854479">:=</span>&nbsp;<span class="ident" id="1854482"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1854488">.</span><span class="ident" id="1854489">AddInt32</span><span class="op" id="1854497">(</span><span class="op" id="1854498">&amp;</span><span class="ident" id="1854499"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854501">.</span><span class="ident" id="1854502">counter</span><span class="op" id="1854509">,</span>&nbsp;<span class="builtintype" id="1854511">int32</span><span class="op" id="1854516">(</span><span class="ident" id="1854517"><a href="/sync/waitgroup.go.html#1854260">delta</a></span><span class="op" id="1854522">)</span><span class="op" id="1854523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854526">if</span>&nbsp;<span class="ident" id="1854529"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1854541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854545">if</span>&nbsp;<span class="ident" id="1854548"><a href="/sync/waitgroup.go.html#1854260">delta</a></span>&nbsp;<span class="op" id="1854554">&gt;</span>&nbsp;<span class="num" id="1854556">0</span>&nbsp;<span class="op" id="1854558">&amp;&amp;</span>&nbsp;<span class="ident" id="1854561"><a href="/sync/waitgroup.go.html#1854477">v</a></span>&nbsp;<span class="op" id="1854563">==</span>&nbsp;<span class="builtintype" id="1854566">int32</span><span class="op" id="1854571">(</span><span class="ident" id="1854572"><a href="/sync/waitgroup.go.html#1854260">delta</a></span><span class="op" id="1854577">)</span>&nbsp;<span class="op" id="1854579">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1854584">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1854642">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1854699">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1854755"><a href="/sync/race0.go.html#1847368">raceRead</a></span><span class="op" id="1854763">(</span><span class="ident" id="1854764"><a href="/sync/waitgroup.go.html#1852724">unsafe</a></span><span class="op" id="1854770">.</span><span class="ident" id="1854771">Pointer</span><span class="op" id="1854778">(</span><span class="op" id="1854779">&amp;</span><span class="ident" id="1854780"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854782">.</span><span class="ident" id="1854783">sema</span><span class="op" id="1854787">)</span><span class="op" id="1854788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1854792">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1854795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854798">if</span>&nbsp;<span class="ident" id="1854801"><a href="/sync/waitgroup.go.html#1854477">v</a></span>&nbsp;<span class="op" id="1854803">&lt;</span>&nbsp;<span class="num" id="1854805">0</span>&nbsp;<span class="op" id="1854807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1854811">panic</span><span class="op" id="1854816">(</span><span class="string" id="1854817">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1854851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1854854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854857">if</span>&nbsp;<span class="ident" id="1854860"><a href="/sync/waitgroup.go.html#1854477">v</a></span>&nbsp;<span class="op" id="1854862">&gt;</span>&nbsp;<span class="num" id="1854864">0</span>&nbsp;<span class="op" id="1854866">||</span>&nbsp;<span class="ident" id="1854869"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1854875">.</span><span class="ident" id="1854876">LoadInt32</span><span class="op" id="1854885">(</span><span class="op" id="1854886">&amp;</span><span class="ident" id="1854887"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854889">.</span><span class="ident" id="1854890">waiters</span><span class="op" id="1854897">)</span>&nbsp;<span class="op" id="1854899">==</span>&nbsp;<span class="num" id="1854902">0</span>&nbsp;<span class="op" id="1854904">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854908">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1854916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1854919"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854921">.</span><span class="ident" id="1854922">m</span><span class="op" id="1854923">.</span><span class="ident" id="1854924">Lock</span><span class="op" id="1854928">(</span><span class="op" id="1854929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854932">if</span>&nbsp;<span class="ident" id="1854935"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1854941">.</span><span class="ident" id="1854942">LoadInt32</span><span class="op" id="1854951">(</span><span class="op" id="1854952">&amp;</span><span class="ident" id="1854953"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854955">.</span><span class="ident" id="1854956">counter</span><span class="op" id="1854963">)</span>&nbsp;<span class="op" id="1854965">==</span>&nbsp;<span class="num" id="1854968">0</span>&nbsp;<span class="op" id="1854970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1854974">for</span>&nbsp;<span class="ident" id="1854978">i</span>&nbsp;<span class="op" id="1854980">:=</span>&nbsp;<span class="builtintype" id="1854983">int32</span><span class="op" id="1854988">(</span><span class="num" id="1854989">0</span><span class="op" id="1854990">)</span><span class="op" id="1854991">;</span>&nbsp;<span class="ident" id="1854993"><a href="/sync/waitgroup.go.html#1854978">i</a></span>&nbsp;<span class="op" id="1854995">&lt;</span>&nbsp;<span class="ident" id="1854997"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1854999">.</span><span class="ident" id="1855000">waiters</span><span class="op" id="1855007">;</span>&nbsp;<span class="ident" id="1855009"><a href="/sync/waitgroup.go.html#1854978">i</a></span><span class="op" id="1855010">++</span>&nbsp;<span class="op" id="1855013">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855018"><a href="/sync/runtime.go.html#1848127">runtime_Semrelease</a></span><span class="op" id="1855036">(</span><span class="ident" id="1855037"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1855039">.</span><span class="ident" id="1855040">sema</span><span class="op" id="1855044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855052"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1855054">.</span><span class="ident" id="1855055">waiters</span>&nbsp;<span class="op" id="1855063">=</span>&nbsp;<span class="num" id="1855065">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855069"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1855071">.</span><span class="ident" id="1855072">sema</span>&nbsp;<span class="op" id="1855077">=</span>&nbsp;<span class="ident" id="1855079">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855084">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855087"><a href="/sync/waitgroup.go.html#1854241">wg</a></span><span class="op" id="1855089">.</span><span class="ident" id="1855090">m</span><span class="op" id="1855091">.</span><span class="ident" id="1855092">Unlock</span><span class="op" id="1855098">(</span><span class="op" id="1855099">)</span><br>
<span class="lineno"></span><span class="op" id="1855101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1855104">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1855146">func</span>&nbsp;<span class="op" id="1855151">(</span><span class="ident" id="1855152">wg</span>&nbsp;<span class="op" id="1855155">*</span><span class="ident" id="1855156"><a href="/sync/waitgroup.go.html#1853035">WaitGroup</a></span><span class="op" id="1855165">)</span>&nbsp;<span class="ident" id="1855167">Done</span><span class="op" id="1855171">(</span><span class="op" id="1855172">)</span>&nbsp;<span class="op" id="1855174">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855177"><a href="/sync/waitgroup.go.html#1855152">wg</a></span><span class="op" id="1855179">.</span><span class="ident" id="1855180">Add</span><span class="op" id="1855183">(</span><span class="op" id="1855184">-</span><span class="num" id="1855185">1</span><span class="op" id="1855186">)</span><br>
<span class="lineno"></span><span class="op" id="1855188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1855191">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1855243">func</span>&nbsp;<span class="op" id="1855248">(</span><span class="ident" id="1855249">wg</span>&nbsp;<span class="op" id="1855252">*</span><span class="ident" id="1855253"><a href="/sync/waitgroup.go.html#1853035">WaitGroup</a></span><span class="op" id="1855262">)</span>&nbsp;<span class="ident" id="1855264">Wait</span><span class="op" id="1855268">(</span><span class="op" id="1855269">)</span>&nbsp;<span class="op" id="1855271">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855274">if</span>&nbsp;<span class="ident" id="1855277"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1855289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855293">_</span>&nbsp;<span class="op" id="1855295">=</span>&nbsp;<span class="ident" id="1855297"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855299">.</span><span class="ident" id="1855300">m</span><span class="op" id="1855301">.</span><span class="ident" id="1855302">state</span>&nbsp;<span class="comment" id="1855308">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855337"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1855348">(</span><span class="op" id="1855349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855355">if</span>&nbsp;<span class="ident" id="1855358"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1855364">.</span><span class="ident" id="1855365">LoadInt32</span><span class="op" id="1855374">(</span><span class="op" id="1855375">&amp;</span><span class="ident" id="1855376"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855378">.</span><span class="ident" id="1855379">counter</span><span class="op" id="1855386">)</span>&nbsp;<span class="op" id="1855388">==</span>&nbsp;<span class="num" id="1855391">0</span>&nbsp;<span class="op" id="1855393">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855397">if</span>&nbsp;<span class="ident" id="1855400"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1855412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855417"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1855427">(</span><span class="op" id="1855428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855433"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1855444">(</span><span class="ident" id="1855445"><a href="/sync/waitgroup.go.html#1852724">unsafe</a></span><span class="op" id="1855451">.</span><span class="ident" id="1855452">Pointer</span><span class="op" id="1855459">(</span><span class="ident" id="1855460"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855462">)</span><span class="op" id="1855463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855471">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855482"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855484">.</span><span class="ident" id="1855485">m</span><span class="op" id="1855486">.</span><span class="ident" id="1855487">Lock</span><span class="op" id="1855491">(</span><span class="op" id="1855492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855495">w</span>&nbsp;<span class="op" id="1855497">:=</span>&nbsp;<span class="ident" id="1855500"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1855506">.</span><span class="ident" id="1855507">AddInt32</span><span class="op" id="1855515">(</span><span class="op" id="1855516">&amp;</span><span class="ident" id="1855517"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855519">.</span><span class="ident" id="1855520">waiters</span><span class="op" id="1855527">,</span>&nbsp;<span class="num" id="1855529">1</span><span class="op" id="1855530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1855533">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1855594">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1855654">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1855724">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855753">if</span>&nbsp;<span class="ident" id="1855756"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1855762">.</span><span class="ident" id="1855763">LoadInt32</span><span class="op" id="1855772">(</span><span class="op" id="1855773">&amp;</span><span class="ident" id="1855774"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855776">.</span><span class="ident" id="1855777">counter</span><span class="op" id="1855784">)</span>&nbsp;<span class="op" id="1855786">==</span>&nbsp;<span class="num" id="1855789">0</span>&nbsp;<span class="op" id="1855791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855795"><a href="/sync/waitgroup.go.html#1852709">atomic</a></span><span class="op" id="1855801">.</span><span class="ident" id="1855802">AddInt32</span><span class="op" id="1855810">(</span><span class="op" id="1855811">&amp;</span><span class="ident" id="1855812"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855814">.</span><span class="ident" id="1855815">waiters</span><span class="op" id="1855822">,</span>&nbsp;<span class="op" id="1855824">-</span><span class="num" id="1855825">1</span><span class="op" id="1855826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855830">if</span>&nbsp;<span class="ident" id="1855833"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1855845">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855850"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1855860">(</span><span class="op" id="1855861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855866"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1855877">(</span><span class="ident" id="1855878"><a href="/sync/waitgroup.go.html#1852724">unsafe</a></span><span class="op" id="1855884">.</span><span class="ident" id="1855885">Pointer</span><span class="op" id="1855892">(</span><span class="ident" id="1855893"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855895">)</span><span class="op" id="1855896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855901"><a href="/sync/race0.go.html#1847321">raceDisable</a></span><span class="op" id="1855912">(</span><span class="op" id="1855913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855921"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1855923">.</span><span class="ident" id="1855924">m</span><span class="op" id="1855925">.</span><span class="ident" id="1855926">Unlock</span><span class="op" id="1855932">(</span><span class="op" id="1855933">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855937">if</span>&nbsp;<span class="ident" id="1855940"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1855952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1855957"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1855967">(</span><span class="op" id="1855968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855976">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1855984">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1855987">if</span>&nbsp;<span class="ident" id="1855990"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1856002">&amp;&amp;</span>&nbsp;<span class="ident" id="1856005"><a href="/sync/waitgroup.go.html#1855495">w</a></span>&nbsp;<span class="op" id="1856007">==</span>&nbsp;<span class="num" id="1856010">1</span>&nbsp;<span class="op" id="1856012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1856016">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1856067">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1856135">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1856202">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856261"><a href="/sync/race0.go.html#1847408">raceWrite</a></span><span class="op" id="1856270">(</span><span class="ident" id="1856271"><a href="/sync/waitgroup.go.html#1852724">unsafe</a></span><span class="op" id="1856277">.</span><span class="ident" id="1856278">Pointer</span><span class="op" id="1856285">(</span><span class="op" id="1856286">&amp;</span><span class="ident" id="1856287"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1856289">.</span><span class="ident" id="1856290">sema</span><span class="op" id="1856294">)</span><span class="op" id="1856295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1856298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1856301">if</span>&nbsp;<span class="ident" id="1856304"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1856306">.</span><span class="ident" id="1856307">sema</span>&nbsp;<span class="op" id="1856312">==</span>&nbsp;<span class="ident" id="1856315">nil</span>&nbsp;<span class="op" id="1856319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856323"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1856325">.</span><span class="ident" id="1856326">sema</span>&nbsp;<span class="op" id="1856331">=</span>&nbsp;<span class="builtinfunc" id="1856333">new</span><span class="op" id="1856336">(</span><span class="builtintype" id="1856337">uint32</span><span class="op" id="1856343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1856346">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856349">s</span>&nbsp;<span class="op" id="1856351">:=</span>&nbsp;<span class="ident" id="1856354"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1856356">.</span><span class="ident" id="1856357">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856363"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1856365">.</span><span class="ident" id="1856366">m</span><span class="op" id="1856367">.</span><span class="ident" id="1856368">Unlock</span><span class="op" id="1856374">(</span><span class="op" id="1856375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856378"><a href="/sync/runtime.go.html#1847861">runtime_Semacquire</a></span><span class="op" id="1856396">(</span><span class="ident" id="1856397"><a href="/sync/waitgroup.go.html#1856349">s</a></span><span class="op" id="1856398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1856401">if</span>&nbsp;<span class="ident" id="1856404"><a href="/sync/race0.go.html#1847161">raceenabled</a></span>&nbsp;<span class="op" id="1856416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856420"><a href="/sync/race0.go.html#1847345">raceEnable</a></span><span class="op" id="1856430">(</span><span class="op" id="1856431">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856435"><a href="/sync/race0.go.html#1847187">raceAcquire</a></span><span class="op" id="1856446">(</span><span class="ident" id="1856447"><a href="/sync/waitgroup.go.html#1852724">unsafe</a></span><span class="op" id="1856453">.</span><span class="ident" id="1856454">Pointer</span><span class="op" id="1856461">(</span><span class="ident" id="1856462"><a href="/sync/waitgroup.go.html#1855249">wg</a></span><span class="op" id="1856464">)</span><span class="op" id="1856465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1856468">}</span><br>
<span class="lineno"></span><span class="op" id="1856470">}</span>
</div>
</body>
</html>
