<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3408597">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3408652">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3408706">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3408757">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3408786">package</span>&nbsp;<span class="ident" id="3408794">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3408804">import</span>&nbsp;<span class="op" id="3408811">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408814">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408828">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408836">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408843">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408850">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408862">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3408868">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3408875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3408878">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="3408949">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="3409012">type</span>&nbsp;<span class="ident" id="3409017">Server</span>&nbsp;<span class="keyword" id="3409024">struct</span>&nbsp;<span class="op" id="3409031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409034">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3409043">string</span>&nbsp;<span class="comment" id="3409050">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409113">Listener</span>&nbsp;<span class="ident" id="3409122">net</span><span class="op" id="3409125">.</span><span class="ident" id="3409126">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409137">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409208">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409280">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409343">TLS</span>&nbsp;<span class="op" id="3409347">*</span><span class="ident" id="3409348">tls</span><span class="op" id="3409351">.</span><span class="ident" id="3409352">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409361">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409424">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409454">Config</span>&nbsp;<span class="op" id="3409461">*</span><span class="ident" id="3409462">http</span><span class="op" id="3409466">.</span><span class="ident" id="3409467">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409476">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409546">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409596">wg</span>&nbsp;<span class="ident" id="3409599">sync</span><span class="op" id="3409603">.</span><span class="ident" id="3409604">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="3409614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3409617">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="3409682">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="3409695">type</span>&nbsp;<span class="ident" id="3409700">historyListener</span>&nbsp;<span class="keyword" id="3409716">struct</span>&nbsp;<span class="op" id="3409723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409726">net</span><span class="op" id="3409729">.</span><span class="ident" id="3409730">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409740">sync</span><span class="op" id="3409744">.</span><span class="ident" id="3409745">Mutex</span>&nbsp;<span class="comment" id="3409751">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409772">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409783">[</span><span class="op" id="3409784">]</span><span class="ident" id="3409785">net</span><span class="op" id="3409788">.</span><span class="ident" id="3409789">Conn</span><br>
<span class="lineno">45</span><span class="op" id="3409794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3409797">func</span>&nbsp;<span class="op" id="3409802">(</span><span class="ident" id="3409803">hs</span>&nbsp;<span class="op" id="3409806">*</span><span class="ident" id="3409807">historyListener</span><span class="op" id="3409822">)</span>&nbsp;<span class="ident" id="3409824">Accept</span><span class="op" id="3409830">(</span><span class="op" id="3409831">)</span>&nbsp;<span class="op" id="3409833">(</span><span class="ident" id="3409834">c</span>&nbsp;<span class="ident" id="3409836">net</span><span class="op" id="3409839">.</span><span class="ident" id="3409840">Conn</span><span class="op" id="3409844">,</span>&nbsp;<span class="ident" id="3409846">err</span>&nbsp;<span class="builtintype" id="3409850">error</span><span class="op" id="3409855">)</span>&nbsp;<span class="op" id="3409857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409860">c</span><span class="op" id="3409861">,</span>&nbsp;<span class="ident" id="3409863">err</span>&nbsp;<span class="op" id="3409867">=</span>&nbsp;<span class="ident" id="3409869">hs</span><span class="op" id="3409871">.</span><span class="ident" id="3409872">Listener</span><span class="op" id="3409880">.</span><span class="ident" id="3409881">Accept</span><span class="op" id="3409887">(</span><span class="op" id="3409888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409891">if</span>&nbsp;<span class="ident" id="3409894">err</span>&nbsp;<span class="op" id="3409898">==</span>&nbsp;<span class="ident" id="3409901">nil</span>&nbsp;<span class="op" id="3409905">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409909">hs</span><span class="op" id="3409911">.</span><span class="ident" id="3409912">Lock</span><span class="op" id="3409916">(</span><span class="op" id="3409917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409921">hs</span><span class="op" id="3409923">.</span><span class="ident" id="3409924">history</span>&nbsp;<span class="op" id="3409932">=</span>&nbsp;<span class="builtinfunc" id="3409934">append</span><span class="op" id="3409940">(</span><span class="ident" id="3409941">hs</span><span class="op" id="3409943">.</span><span class="ident" id="3409944">history</span><span class="op" id="3409951">,</span>&nbsp;<span class="ident" id="3409953">c</span><span class="op" id="3409954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409958">hs</span><span class="op" id="3409960">.</span><span class="ident" id="3409961">Unlock</span><span class="op" id="3409967">(</span><span class="op" id="3409968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409974">return</span><br>
<span class="lineno">55</span><span class="op" id="3409981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3409984">func</span>&nbsp;<span class="ident" id="3409989">newLocalListener</span><span class="op" id="3410005">(</span><span class="op" id="3410006">)</span>&nbsp;<span class="ident" id="3410008">net</span><span class="op" id="3410011">.</span><span class="ident" id="3410012">Listener</span>&nbsp;<span class="op" id="3410021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410024">if</span>&nbsp;<span class="op" id="3410027">*</span><span class="ident" id="3410028">serve</span>&nbsp;<span class="op" id="3410034">!=</span>&nbsp;<span class="string" id="3410037">&#34;&#34;</span>&nbsp;<span class="op" id="3410040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3410044">l</span><span class="op" id="3410045">,</span>&nbsp;<span class="ident" id="3410047">err</span>&nbsp;<span class="op" id="3410051">:=</span>&nbsp;<span class="ident" id="3410054">net</span><span class="op" id="3410057">.</span><span class="ident" id="3410058">Listen</span><span class="op" id="3410064">(</span><span class="string" id="3410065">&#34;tcp&#34;</span><span class="op" id="3410070">,</span>&nbsp;<span class="op" id="3410072">*</span><span class="ident" id="3410073">serve</span><span class="op" id="3410078">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410082">if</span>&nbsp;<span class="ident" id="3410085">err</span>&nbsp;<span class="op" id="3410089">!=</span>&nbsp;<span class="ident" id="3410092">nil</span>&nbsp;<span class="op" id="3410096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3410101">panic</span><span class="op" id="3410106">(</span><span class="ident" id="3410107">fmt</span><span class="op" id="3410110">.</span><span class="ident" id="3410111">Sprintf</span><span class="op" id="3410118">(</span><span class="string" id="3410119">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="3410157">,</span>&nbsp;<span class="op" id="3410159">*</span><span class="ident" id="3410160">serve</span><span class="op" id="3410165">,</span>&nbsp;<span class="ident" id="3410167">err</span><span class="op" id="3410170">)</span><span class="op" id="3410171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410179">return</span>&nbsp;<span class="ident" id="3410186">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410189">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3410192">l</span><span class="op" id="3410193">,</span>&nbsp;<span class="ident" id="3410195">err</span>&nbsp;<span class="op" id="3410199">:=</span>&nbsp;<span class="ident" id="3410202">net</span><span class="op" id="3410205">.</span><span class="ident" id="3410206">Listen</span><span class="op" id="3410212">(</span><span class="string" id="3410213">&#34;tcp&#34;</span><span class="op" id="3410218">,</span>&nbsp;<span class="string" id="3410220">&#34;127.0.0.1:0&#34;</span><span class="op" id="3410233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410236">if</span>&nbsp;<span class="ident" id="3410239">err</span>&nbsp;<span class="op" id="3410243">!=</span>&nbsp;<span class="ident" id="3410246">nil</span>&nbsp;<span class="op" id="3410250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410254">if</span>&nbsp;<span class="ident" id="3410257">l</span><span class="op" id="3410258">,</span>&nbsp;<span class="ident" id="3410260">err</span>&nbsp;<span class="op" id="3410264">=</span>&nbsp;<span class="ident" id="3410266">net</span><span class="op" id="3410269">.</span><span class="ident" id="3410270">Listen</span><span class="op" id="3410276">(</span><span class="string" id="3410277">&#34;tcp6&#34;</span><span class="op" id="3410283">,</span>&nbsp;<span class="string" id="3410285">&#34;[::1]:0&#34;</span><span class="op" id="3410294">)</span><span class="op" id="3410295">;</span>&nbsp;<span class="ident" id="3410297">err</span>&nbsp;<span class="op" id="3410301">!=</span>&nbsp;<span class="ident" id="3410304">nil</span>&nbsp;<span class="op" id="3410308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3410313">panic</span><span class="op" id="3410318">(</span><span class="ident" id="3410319">fmt</span><span class="op" id="3410322">.</span><span class="ident" id="3410323">Sprintf</span><span class="op" id="3410330">(</span><span class="string" id="3410331">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="3410373">,</span>&nbsp;<span class="ident" id="3410375">err</span><span class="op" id="3410378">)</span><span class="op" id="3410379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410383">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410389">return</span>&nbsp;<span class="ident" id="3410396">l</span><br>
<span class="lineno"></span><span class="op" id="3410398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410401">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="3410456">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="3410482">//&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="3410540">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="3410608">var</span>&nbsp;<span class="ident" id="3410612">serve</span>&nbsp;<span class="op" id="3410618">=</span>&nbsp;<span class="ident" id="3410620">flag</span><span class="op" id="3410624">.</span><span class="ident" id="3410625">String</span><span class="op" id="3410631">(</span><span class="string" id="3410632">&#34;httptest.serve&#34;</span><span class="op" id="3410648">,</span>&nbsp;<span class="string" id="3410650">&#34;&#34;</span><span class="op" id="3410652">,</span>&nbsp;<span class="string" id="3410654">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="3410722">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3410725">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="3410771">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="3410835">func</span>&nbsp;<span class="ident" id="3410840">NewServer</span><span class="op" id="3410849">(</span><span class="ident" id="3410850">handler</span>&nbsp;<span class="ident" id="3410858">http</span><span class="op" id="3410862">.</span><span class="ident" id="3410863">Handler</span><span class="op" id="3410870">)</span>&nbsp;<span class="op" id="3410872">*</span><span class="ident" id="3410873">Server</span>&nbsp;<span class="op" id="3410880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3410883">ts</span>&nbsp;<span class="op" id="3410886">:=</span>&nbsp;<span class="ident" id="3410889">NewUnstartedServer</span><span class="op" id="3410907">(</span><span class="ident" id="3410908">handler</span><span class="op" id="3410915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3410918">ts</span><span class="op" id="3410920">.</span><span class="ident" id="3410921">Start</span><span class="op" id="3410926">(</span><span class="op" id="3410927">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410930">return</span>&nbsp;<span class="ident" id="3410937">ts</span><br>
<span class="lineno"></span><span class="op" id="3410940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410943">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="3411008">//</span><br>
<span class="lineno">90</span><span class="comment" id="3411011">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3411080">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="3411093">//</span><br>
<span class="lineno"></span><span class="comment" id="3411096">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="3411160">func</span>&nbsp;<span class="ident" id="3411165">NewUnstartedServer</span><span class="op" id="3411183">(</span><span class="ident" id="3411184">handler</span>&nbsp;<span class="ident" id="3411192">http</span><span class="op" id="3411196">.</span><span class="ident" id="3411197">Handler</span><span class="op" id="3411204">)</span>&nbsp;<span class="op" id="3411206">*</span><span class="ident" id="3411207">Server</span>&nbsp;<span class="op" id="3411214">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411217">return</span>&nbsp;<span class="op" id="3411224">&amp;</span><span class="ident" id="3411225">Server</span><span class="op" id="3411231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411235">Listener</span><span class="op" id="3411243">:</span>&nbsp;<span class="ident" id="3411245">newLocalListener</span><span class="op" id="3411261">(</span><span class="op" id="3411262">)</span><span class="op" id="3411263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411267">Config</span><span class="op" id="3411273">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3411277">&amp;</span><span class="ident" id="3411278">http</span><span class="op" id="3411282">.</span><span class="ident" id="3411283">Server</span><span class="op" id="3411289">{</span><span class="ident" id="3411290">Handler</span><span class="op" id="3411297">:</span>&nbsp;<span class="ident" id="3411299">handler</span><span class="op" id="3411306">}</span><span class="op" id="3411307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411310">}</span><br>
<span class="lineno"></span><span class="op" id="3411312">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3411315">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="3411365">func</span>&nbsp;<span class="op" id="3411370">(</span><span class="ident" id="3411371">s</span>&nbsp;<span class="op" id="3411373">*</span><span class="ident" id="3411374">Server</span><span class="op" id="3411380">)</span>&nbsp;<span class="ident" id="3411382">Start</span><span class="op" id="3411387">(</span><span class="op" id="3411388">)</span>&nbsp;<span class="op" id="3411390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411393">if</span>&nbsp;<span class="ident" id="3411396">s</span><span class="op" id="3411397">.</span><span class="ident" id="3411398">URL</span>&nbsp;<span class="op" id="3411402">!=</span>&nbsp;<span class="string" id="3411405">&#34;&#34;</span>&nbsp;<span class="op" id="3411408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3411412">panic</span><span class="op" id="3411417">(</span><span class="string" id="3411418">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="3411442">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411448">s</span><span class="op" id="3411449">.</span><span class="ident" id="3411450">Listener</span>&nbsp;<span class="op" id="3411459">=</span>&nbsp;<span class="op" id="3411461">&amp;</span><span class="ident" id="3411462">historyListener</span><span class="op" id="3411477">{</span><span class="ident" id="3411478">Listener</span><span class="op" id="3411486">:</span>&nbsp;<span class="ident" id="3411488">s</span><span class="op" id="3411489">.</span><span class="ident" id="3411490">Listener</span><span class="op" id="3411498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411501">s</span><span class="op" id="3411502">.</span><span class="ident" id="3411503">URL</span>&nbsp;<span class="op" id="3411507">=</span>&nbsp;<span class="string" id="3411509">&#34;http://&#34;</span>&nbsp;<span class="op" id="3411519">+</span>&nbsp;<span class="ident" id="3411521">s</span><span class="op" id="3411522">.</span><span class="ident" id="3411523">Listener</span><span class="op" id="3411531">.</span><span class="ident" id="3411532">Addr</span><span class="op" id="3411536">(</span><span class="op" id="3411537">)</span><span class="op" id="3411538">.</span><span class="ident" id="3411539">String</span><span class="op" id="3411545">(</span><span class="op" id="3411546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411549">s</span><span class="op" id="3411550">.</span><span class="ident" id="3411551">wrapHandler</span><span class="op" id="3411562">(</span><span class="op" id="3411563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411566">go</span>&nbsp;<span class="ident" id="3411569">s</span><span class="op" id="3411570">.</span><span class="ident" id="3411571">Config</span><span class="op" id="3411577">.</span><span class="ident" id="3411578">Serve</span><span class="op" id="3411583">(</span><span class="ident" id="3411584">s</span><span class="op" id="3411585">.</span><span class="ident" id="3411586">Listener</span><span class="op" id="3411594">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411597">if</span>&nbsp;<span class="op" id="3411600">*</span><span class="ident" id="3411601">serve</span>&nbsp;<span class="op" id="3411607">!=</span>&nbsp;<span class="string" id="3411610">&#34;&#34;</span>&nbsp;<span class="op" id="3411613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411617">fmt</span><span class="op" id="3411620">.</span><span class="ident" id="3411621">Fprintln</span><span class="op" id="3411629">(</span><span class="ident" id="3411630">os</span><span class="op" id="3411632">.</span><span class="ident" id="3411633">Stderr</span><span class="op" id="3411639">,</span>&nbsp;<span class="string" id="3411641">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="3411663">,</span>&nbsp;<span class="ident" id="3411665">s</span><span class="op" id="3411666">.</span><span class="ident" id="3411667">URL</span><span class="op" id="3411670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411674">select</span>&nbsp;<span class="op" id="3411681">{</span><span class="op" id="3411682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411685">}</span><br>
<span class="lineno"></span><span class="op" id="3411687">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="3411690">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="3411750">func</span>&nbsp;<span class="op" id="3411755">(</span><span class="ident" id="3411756">s</span>&nbsp;<span class="op" id="3411758">*</span><span class="ident" id="3411759">Server</span><span class="op" id="3411765">)</span>&nbsp;<span class="ident" id="3411767">StartTLS</span><span class="op" id="3411775">(</span><span class="op" id="3411776">)</span>&nbsp;<span class="op" id="3411778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411781">if</span>&nbsp;<span class="ident" id="3411784">s</span><span class="op" id="3411785">.</span><span class="ident" id="3411786">URL</span>&nbsp;<span class="op" id="3411790">!=</span>&nbsp;<span class="string" id="3411793">&#34;&#34;</span>&nbsp;<span class="op" id="3411796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3411800">panic</span><span class="op" id="3411805">(</span><span class="string" id="3411806">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="3411830">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411836">cert</span><span class="op" id="3411840">,</span>&nbsp;<span class="ident" id="3411842">err</span>&nbsp;<span class="op" id="3411846">:=</span>&nbsp;<span class="ident" id="3411849">tls</span><span class="op" id="3411852">.</span><span class="ident" id="3411853">X509KeyPair</span><span class="op" id="3411864">(</span><span class="ident" id="3411865">localhostCert</span><span class="op" id="3411878">,</span>&nbsp;<span class="ident" id="3411880">localhostKey</span><span class="op" id="3411892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411895">if</span>&nbsp;<span class="ident" id="3411898">err</span>&nbsp;<span class="op" id="3411902">!=</span>&nbsp;<span class="ident" id="3411905">nil</span>&nbsp;<span class="op" id="3411909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3411913">panic</span><span class="op" id="3411918">(</span><span class="ident" id="3411919">fmt</span><span class="op" id="3411922">.</span><span class="ident" id="3411923">Sprintf</span><span class="op" id="3411930">(</span><span class="string" id="3411931">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="3411959">,</span>&nbsp;<span class="ident" id="3411961">err</span><span class="op" id="3411964">)</span><span class="op" id="3411965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411968">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411972">existingConfig</span>&nbsp;<span class="op" id="3411987">:=</span>&nbsp;<span class="ident" id="3411990">s</span><span class="op" id="3411991">.</span><span class="ident" id="3411992">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411997">s</span><span class="op" id="3411998">.</span><span class="ident" id="3411999">TLS</span>&nbsp;<span class="op" id="3412003">=</span>&nbsp;<span class="builtinfunc" id="3412005">new</span><span class="op" id="3412008">(</span><span class="ident" id="3412009">tls</span><span class="op" id="3412012">.</span><span class="ident" id="3412013">Config</span><span class="op" id="3412019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412022">if</span>&nbsp;<span class="ident" id="3412025">existingConfig</span>&nbsp;<span class="op" id="3412040">!=</span>&nbsp;<span class="ident" id="3412043">nil</span>&nbsp;<span class="op" id="3412047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412051">*</span><span class="ident" id="3412052">s</span><span class="op" id="3412053">.</span><span class="ident" id="3412054">TLS</span>&nbsp;<span class="op" id="3412058">=</span>&nbsp;<span class="op" id="3412060">*</span><span class="ident" id="3412061">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412080">if</span>&nbsp;<span class="ident" id="3412083">s</span><span class="op" id="3412084">.</span><span class="ident" id="3412085">TLS</span><span class="op" id="3412088">.</span><span class="ident" id="3412089">NextProtos</span>&nbsp;<span class="op" id="3412100">==</span>&nbsp;<span class="ident" id="3412103">nil</span>&nbsp;<span class="op" id="3412107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412111">s</span><span class="op" id="3412112">.</span><span class="ident" id="3412113">TLS</span><span class="op" id="3412116">.</span><span class="ident" id="3412117">NextProtos</span>&nbsp;<span class="op" id="3412128">=</span>&nbsp;<span class="op" id="3412130">[</span><span class="op" id="3412131">]</span><span class="builtintype" id="3412132">string</span><span class="op" id="3412138">{</span><span class="string" id="3412139">&#34;http/1.1&#34;</span><span class="op" id="3412149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412155">if</span>&nbsp;<span class="builtinfunc" id="3412158">len</span><span class="op" id="3412161">(</span><span class="ident" id="3412162">s</span><span class="op" id="3412163">.</span><span class="ident" id="3412164">TLS</span><span class="op" id="3412167">.</span><span class="ident" id="3412168">Certificates</span><span class="op" id="3412180">)</span>&nbsp;<span class="op" id="3412182">==</span>&nbsp;<span class="num" id="3412185">0</span>&nbsp;<span class="op" id="3412187">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412191">s</span><span class="op" id="3412192">.</span><span class="ident" id="3412193">TLS</span><span class="op" id="3412196">.</span><span class="ident" id="3412197">Certificates</span>&nbsp;<span class="op" id="3412210">=</span>&nbsp;<span class="op" id="3412212">[</span><span class="op" id="3412213">]</span><span class="ident" id="3412214">tls</span><span class="op" id="3412217">.</span><span class="ident" id="3412218">Certificate</span><span class="op" id="3412229">{</span><span class="ident" id="3412230">cert</span><span class="op" id="3412234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412240">tlsListener</span>&nbsp;<span class="op" id="3412252">:=</span>&nbsp;<span class="ident" id="3412255">tls</span><span class="op" id="3412258">.</span><span class="ident" id="3412259">NewListener</span><span class="op" id="3412270">(</span><span class="ident" id="3412271">s</span><span class="op" id="3412272">.</span><span class="ident" id="3412273">Listener</span><span class="op" id="3412281">,</span>&nbsp;<span class="ident" id="3412283">s</span><span class="op" id="3412284">.</span><span class="ident" id="3412285">TLS</span><span class="op" id="3412288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412292">s</span><span class="op" id="3412293">.</span><span class="ident" id="3412294">Listener</span>&nbsp;<span class="op" id="3412303">=</span>&nbsp;<span class="op" id="3412305">&amp;</span><span class="ident" id="3412306">historyListener</span><span class="op" id="3412321">{</span><span class="ident" id="3412322">Listener</span><span class="op" id="3412330">:</span>&nbsp;<span class="ident" id="3412332">tlsListener</span><span class="op" id="3412343">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412346">s</span><span class="op" id="3412347">.</span><span class="ident" id="3412348">URL</span>&nbsp;<span class="op" id="3412352">=</span>&nbsp;<span class="string" id="3412354">&#34;https://&#34;</span>&nbsp;<span class="op" id="3412365">+</span>&nbsp;<span class="ident" id="3412367">s</span><span class="op" id="3412368">.</span><span class="ident" id="3412369">Listener</span><span class="op" id="3412377">.</span><span class="ident" id="3412378">Addr</span><span class="op" id="3412382">(</span><span class="op" id="3412383">)</span><span class="op" id="3412384">.</span><span class="ident" id="3412385">String</span><span class="op" id="3412391">(</span><span class="op" id="3412392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412395">s</span><span class="op" id="3412396">.</span><span class="ident" id="3412397">wrapHandler</span><span class="op" id="3412408">(</span><span class="op" id="3412409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412412">go</span>&nbsp;<span class="ident" id="3412415">s</span><span class="op" id="3412416">.</span><span class="ident" id="3412417">Config</span><span class="op" id="3412423">.</span><span class="ident" id="3412424">Serve</span><span class="op" id="3412429">(</span><span class="ident" id="3412430">s</span><span class="op" id="3412431">.</span><span class="ident" id="3412432">Listener</span><span class="op" id="3412440">)</span><br>
<span class="lineno"></span><span class="op" id="3412442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="3412445">func</span>&nbsp;<span class="op" id="3412450">(</span><span class="ident" id="3412451">s</span>&nbsp;<span class="op" id="3412453">*</span><span class="ident" id="3412454">Server</span><span class="op" id="3412460">)</span>&nbsp;<span class="ident" id="3412462">wrapHandler</span><span class="op" id="3412473">(</span><span class="op" id="3412474">)</span>&nbsp;<span class="op" id="3412476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412479">h</span>&nbsp;<span class="op" id="3412481">:=</span>&nbsp;<span class="ident" id="3412484">s</span><span class="op" id="3412485">.</span><span class="ident" id="3412486">Config</span><span class="op" id="3412492">.</span><span class="ident" id="3412493">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412502">if</span>&nbsp;<span class="ident" id="3412505">h</span>&nbsp;<span class="op" id="3412507">==</span>&nbsp;<span class="ident" id="3412510">nil</span>&nbsp;<span class="op" id="3412514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412518">h</span>&nbsp;<span class="op" id="3412520">=</span>&nbsp;<span class="ident" id="3412522">http</span><span class="op" id="3412526">.</span><span class="ident" id="3412527">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412544">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412547">s</span><span class="op" id="3412548">.</span><span class="ident" id="3412549">Config</span><span class="op" id="3412555">.</span><span class="ident" id="3412556">Handler</span>&nbsp;<span class="op" id="3412564">=</span>&nbsp;<span class="op" id="3412566">&amp;</span><span class="ident" id="3412567">waitGroupHandler</span><span class="op" id="3412583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412587">s</span><span class="op" id="3412588">:</span>&nbsp;<span class="ident" id="3412590">s</span><span class="op" id="3412591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412595">h</span><span class="op" id="3412596">:</span>&nbsp;<span class="ident" id="3412598">h</span><span class="op" id="3412599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412602">}</span><br>
<span class="lineno"></span><span class="op" id="3412604">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3412607">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="3412666">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="3412730">func</span>&nbsp;<span class="ident" id="3412735">NewTLSServer</span><span class="op" id="3412747">(</span><span class="ident" id="3412748">handler</span>&nbsp;<span class="ident" id="3412756">http</span><span class="op" id="3412760">.</span><span class="ident" id="3412761">Handler</span><span class="op" id="3412768">)</span>&nbsp;<span class="op" id="3412770">*</span><span class="ident" id="3412771">Server</span>&nbsp;<span class="op" id="3412778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412781">ts</span>&nbsp;<span class="op" id="3412784">:=</span>&nbsp;<span class="ident" id="3412787">NewUnstartedServer</span><span class="op" id="3412805">(</span><span class="ident" id="3412806">handler</span><span class="op" id="3412813">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412816">ts</span><span class="op" id="3412818">.</span><span class="ident" id="3412819">StartTLS</span><span class="op" id="3412827">(</span><span class="op" id="3412828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412831">return</span>&nbsp;<span class="ident" id="3412838">ts</span><br>
<span class="lineno"></span><span class="op" id="3412841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3412844">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="3412908">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3412951">func</span>&nbsp;<span class="op" id="3412956">(</span><span class="ident" id="3412957">s</span>&nbsp;<span class="op" id="3412959">*</span><span class="ident" id="3412960">Server</span><span class="op" id="3412966">)</span>&nbsp;<span class="ident" id="3412968">Close</span><span class="op" id="3412973">(</span><span class="op" id="3412974">)</span>&nbsp;<span class="op" id="3412976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412979">s</span><span class="op" id="3412980">.</span><span class="ident" id="3412981">Listener</span><span class="op" id="3412989">.</span><span class="ident" id="3412990">Close</span><span class="op" id="3412995">(</span><span class="op" id="3412996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412999">s</span><span class="op" id="3413000">.</span><span class="ident" id="3413001">wg</span><span class="op" id="3413003">.</span><span class="ident" id="3413004">Wait</span><span class="op" id="3413008">(</span><span class="op" id="3413009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413012">s</span><span class="op" id="3413013">.</span><span class="ident" id="3413014">CloseClientConnections</span><span class="op" id="3413036">(</span><span class="op" id="3413037">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413040">if</span>&nbsp;<span class="ident" id="3413043">t</span><span class="op" id="3413044">,</span>&nbsp;<span class="ident" id="3413046">ok</span>&nbsp;<span class="op" id="3413049">:=</span>&nbsp;<span class="ident" id="3413052">http</span><span class="op" id="3413056">.</span><span class="ident" id="3413057">DefaultTransport</span><span class="op" id="3413073">.</span><span class="op" id="3413074">(</span><span class="op" id="3413075">*</span><span class="ident" id="3413076">http</span><span class="op" id="3413080">.</span><span class="ident" id="3413081">Transport</span><span class="op" id="3413090">)</span><span class="op" id="3413091">;</span>&nbsp;<span class="ident" id="3413093">ok</span>&nbsp;<span class="op" id="3413096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413100">t</span><span class="op" id="3413101">.</span><span class="ident" id="3413102">CloseIdleConnections</span><span class="op" id="3413122">(</span><span class="op" id="3413123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413126">}</span><br>
<span class="lineno"></span><span class="op" id="3413128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="3413131">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="3413200">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="3413223">func</span>&nbsp;<span class="op" id="3413228">(</span><span class="ident" id="3413229">s</span>&nbsp;<span class="op" id="3413231">*</span><span class="ident" id="3413232">Server</span><span class="op" id="3413238">)</span>&nbsp;<span class="ident" id="3413240">CloseClientConnections</span><span class="op" id="3413262">(</span><span class="op" id="3413263">)</span>&nbsp;<span class="op" id="3413265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413268">hl</span><span class="op" id="3413270">,</span>&nbsp;<span class="ident" id="3413272">ok</span>&nbsp;<span class="op" id="3413275">:=</span>&nbsp;<span class="ident" id="3413278">s</span><span class="op" id="3413279">.</span><span class="ident" id="3413280">Listener</span><span class="op" id="3413288">.</span><span class="op" id="3413289">(</span><span class="op" id="3413290">*</span><span class="ident" id="3413291">historyListener</span><span class="op" id="3413306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413309">if</span>&nbsp;<span class="op" id="3413312">!</span><span class="ident" id="3413313">ok</span>&nbsp;<span class="op" id="3413316">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413320">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413331">hl</span><span class="op" id="3413333">.</span><span class="ident" id="3413334">Lock</span><span class="op" id="3413338">(</span><span class="op" id="3413339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413342">for</span>&nbsp;<span class="ident" id="3413346">_</span><span class="op" id="3413347">,</span>&nbsp;<span class="ident" id="3413349">conn</span>&nbsp;<span class="op" id="3413354">:=</span>&nbsp;<span class="keyword" id="3413357">range</span>&nbsp;<span class="ident" id="3413363">hl</span><span class="op" id="3413365">.</span><span class="ident" id="3413366">history</span>&nbsp;<span class="op" id="3413374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413378">conn</span><span class="op" id="3413382">.</span><span class="ident" id="3413383">Close</span><span class="op" id="3413388">(</span><span class="op" id="3413389">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413395">hl</span><span class="op" id="3413397">.</span><span class="ident" id="3413398">Unlock</span><span class="op" id="3413404">(</span><span class="op" id="3413405">)</span><br>
<span class="lineno"></span><span class="op" id="3413407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3413410">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="3413479">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3413546">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="3413590">type</span>&nbsp;<span class="ident" id="3413595">waitGroupHandler</span>&nbsp;<span class="keyword" id="3413612">struct</span>&nbsp;<span class="op" id="3413619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413622">s</span>&nbsp;<span class="op" id="3413624">*</span><span class="ident" id="3413625">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413633">h</span>&nbsp;<span class="ident" id="3413635">http</span><span class="op" id="3413639">.</span><span class="ident" id="3413640">Handler</span>&nbsp;<span class="comment" id="3413648">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="3413659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3413662">func</span>&nbsp;<span class="op" id="3413667">(</span><span class="ident" id="3413668">h</span>&nbsp;<span class="op" id="3413670">*</span><span class="ident" id="3413671">waitGroupHandler</span><span class="op" id="3413687">)</span>&nbsp;<span class="ident" id="3413689">ServeHTTP</span><span class="op" id="3413698">(</span><span class="ident" id="3413699">w</span>&nbsp;<span class="ident" id="3413701">http</span><span class="op" id="3413705">.</span><span class="ident" id="3413706">ResponseWriter</span><span class="op" id="3413720">,</span>&nbsp;<span class="ident" id="3413722">r</span>&nbsp;<span class="op" id="3413724">*</span><span class="ident" id="3413725">http</span><span class="op" id="3413729">.</span><span class="ident" id="3413730">Request</span><span class="op" id="3413737">)</span>&nbsp;<span class="op" id="3413739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413742">h</span><span class="op" id="3413743">.</span><span class="ident" id="3413744">s</span><span class="op" id="3413745">.</span><span class="ident" id="3413746">wg</span><span class="op" id="3413748">.</span><span class="ident" id="3413749">Add</span><span class="op" id="3413752">(</span><span class="num" id="3413753">1</span><span class="op" id="3413754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413757">defer</span>&nbsp;<span class="ident" id="3413763">h</span><span class="op" id="3413764">.</span><span class="ident" id="3413765">s</span><span class="op" id="3413766">.</span><span class="ident" id="3413767">wg</span><span class="op" id="3413769">.</span><span class="ident" id="3413770">Done</span><span class="op" id="3413774">(</span><span class="op" id="3413775">)</span>&nbsp;<span class="comment" id="3413777">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413821">h</span><span class="op" id="3413822">.</span><span class="ident" id="3413823">h</span><span class="op" id="3413824">.</span><span class="ident" id="3413825">ServeHTTP</span><span class="op" id="3413834">(</span><span class="ident" id="3413835">w</span><span class="op" id="3413836">,</span>&nbsp;<span class="ident" id="3413838">r</span><span class="op" id="3413839">)</span><br>
<span class="lineno"></span><span class="op" id="3413841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3413844">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="3413900">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="3413973">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="3413992">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="3414026">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="3414162">var</span>&nbsp;<span class="ident" id="3414166">localhostCert</span>&nbsp;<span class="op" id="3414180">=</span>&nbsp;<span class="op" id="3414182">[</span><span class="op" id="3414183">]</span><span class="builtintype" id="3414184">byte</span><span class="op" id="3414188">(</span><span class="string" id="3414189">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="3414760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3414763">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="3414817">var</span>&nbsp;<span class="ident" id="3414821">localhostKey</span>&nbsp;<span class="op" id="3414834">=</span>&nbsp;<span class="op" id="3414836">[</span><span class="op" id="3414837">]</span><span class="builtintype" id="3414838">byte</span><span class="op" id="3414842">(</span><span class="string" id="3414843">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="3415341">)</span>
</div>
</body>
</html>
