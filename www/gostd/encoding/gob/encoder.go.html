<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5030261">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5030316">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5030370">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5030421">package</span>&nbsp;<span class="ident" id="5030429">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5030434">import</span>&nbsp;<span class="op" id="5030441">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5030444">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5030450">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5030461">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5030468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5030471">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5030546">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="5030577">type</span>&nbsp;<span class="ident" id="5030582">Encoder</span>&nbsp;<span class="keyword" id="5030590">struct</span>&nbsp;<span class="op" id="5030597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030600">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030611">sync</span><span class="op" id="5030615">.</span><span class="ident" id="5030616">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030635">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030673">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030684">[</span><span class="op" id="5030685">]</span><span class="ident" id="5030686">io</span><span class="op" id="5030688">.</span><span class="ident" id="5030689">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030708">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030735">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030746">map</span><span class="op" id="5030749">[</span><span class="ident" id="5030750">reflect</span><span class="op" id="5030757">.</span><span class="ident" id="5030758">Type</span><span class="op" id="5030762">]</span><span class="ident" id="5030763">typeId</span>&nbsp;<span class="comment" id="5030770">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030805">countState</span>&nbsp;<span class="op" id="5030816">*</span><span class="ident" id="5030817">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030840">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030869">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5030880">*</span><span class="ident" id="5030881">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030904">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030956">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030967">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030991">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031029">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5031040">error</span><br>
<span class="lineno"></span><span class="op" id="5031046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5031049">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5031116">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5031183">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5031245">const</span>&nbsp;<span class="ident" id="5031251">maxLength</span>&nbsp;<span class="op" id="5031261">=</span>&nbsp;<span class="num" id="5031263">9</span>&nbsp;<span class="comment" id="5031265">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5031303">var</span>&nbsp;<span class="ident" id="5031307">spaceForLength</span>&nbsp;<span class="op" id="5031322">=</span>&nbsp;<span class="builtinfunc" id="5031324">make</span><span class="op" id="5031328">(</span><span class="op" id="5031329">[</span><span class="op" id="5031330">]</span><span class="builtintype" id="5031331">byte</span><span class="op" id="5031335">,</span>&nbsp;<span class="ident" id="5031337">maxLength</span><span class="op" id="5031346">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="5031349">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5031422">func</span>&nbsp;<span class="ident" id="5031427">NewEncoder</span><span class="op" id="5031437">(</span><span class="ident" id="5031438">w</span>&nbsp;<span class="ident" id="5031440">io</span><span class="op" id="5031442">.</span><span class="ident" id="5031443">Writer</span><span class="op" id="5031449">)</span>&nbsp;<span class="op" id="5031451">*</span><span class="ident" id="5031452">Encoder</span>&nbsp;<span class="op" id="5031460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031463">enc</span>&nbsp;<span class="op" id="5031467">:=</span>&nbsp;<span class="builtinfunc" id="5031470">new</span><span class="op" id="5031473">(</span><span class="ident" id="5031474">Encoder</span><span class="op" id="5031481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031484">enc</span><span class="op" id="5031487">.</span><span class="ident" id="5031488">w</span>&nbsp;<span class="op" id="5031490">=</span>&nbsp;<span class="op" id="5031492">[</span><span class="op" id="5031493">]</span><span class="ident" id="5031494">io</span><span class="op" id="5031496">.</span><span class="ident" id="5031497">Writer</span><span class="op" id="5031503">{</span><span class="ident" id="5031504">w</span><span class="op" id="5031505">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031508">enc</span><span class="op" id="5031511">.</span><span class="ident" id="5031512">sent</span>&nbsp;<span class="op" id="5031517">=</span>&nbsp;<span class="builtinfunc" id="5031519">make</span><span class="op" id="5031523">(</span><span class="keyword" id="5031524">map</span><span class="op" id="5031527">[</span><span class="ident" id="5031528">reflect</span><span class="op" id="5031535">.</span><span class="ident" id="5031536">Type</span><span class="op" id="5031540">]</span><span class="ident" id="5031541">typeId</span><span class="op" id="5031547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031550">enc</span><span class="op" id="5031553">.</span><span class="ident" id="5031554">countState</span>&nbsp;<span class="op" id="5031565">=</span>&nbsp;<span class="ident" id="5031567">enc</span><span class="op" id="5031570">.</span><span class="ident" id="5031571">newEncoderState</span><span class="op" id="5031586">(</span><span class="builtinfunc" id="5031587">new</span><span class="op" id="5031590">(</span><span class="ident" id="5031591">encBuffer</span><span class="op" id="5031600">)</span><span class="op" id="5031601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031604">return</span>&nbsp;<span class="ident" id="5031611">enc</span><br>
<span class="lineno"></span><span class="op" id="5031615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5031618">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="5031680">func</span>&nbsp;<span class="op" id="5031685">(</span><span class="ident" id="5031686">enc</span>&nbsp;<span class="op" id="5031690">*</span><span class="ident" id="5031691">Encoder</span><span class="op" id="5031698">)</span>&nbsp;<span class="ident" id="5031700">writer</span><span class="op" id="5031706">(</span><span class="op" id="5031707">)</span>&nbsp;<span class="ident" id="5031709">io</span><span class="op" id="5031711">.</span><span class="ident" id="5031712">Writer</span>&nbsp;<span class="op" id="5031719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031722">return</span>&nbsp;<span class="ident" id="5031729">enc</span><span class="op" id="5031732">.</span><span class="ident" id="5031733">w</span><span class="op" id="5031734">[</span><span class="builtinfunc" id="5031735">len</span><span class="op" id="5031738">(</span><span class="ident" id="5031739">enc</span><span class="op" id="5031742">.</span><span class="ident" id="5031743">w</span><span class="op" id="5031744">)</span><span class="op" id="5031745">-</span><span class="num" id="5031746">1</span><span class="op" id="5031747">]</span><br>
<span class="lineno"></span><span class="op" id="5031749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5031752">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5031796">func</span>&nbsp;<span class="op" id="5031801">(</span><span class="ident" id="5031802">enc</span>&nbsp;<span class="op" id="5031806">*</span><span class="ident" id="5031807">Encoder</span><span class="op" id="5031814">)</span>&nbsp;<span class="ident" id="5031816">pushWriter</span><span class="op" id="5031826">(</span><span class="ident" id="5031827">w</span>&nbsp;<span class="ident" id="5031829">io</span><span class="op" id="5031831">.</span><span class="ident" id="5031832">Writer</span><span class="op" id="5031838">)</span>&nbsp;<span class="op" id="5031840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031843">enc</span><span class="op" id="5031846">.</span><span class="ident" id="5031847">w</span>&nbsp;<span class="op" id="5031849">=</span>&nbsp;<span class="builtinfunc" id="5031851">append</span><span class="op" id="5031857">(</span><span class="ident" id="5031858">enc</span><span class="op" id="5031861">.</span><span class="ident" id="5031862">w</span><span class="op" id="5031863">,</span>&nbsp;<span class="ident" id="5031865">w</span><span class="op" id="5031866">)</span><br>
<span class="lineno"></span><span class="op" id="5031868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5031871">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5031911">func</span>&nbsp;<span class="op" id="5031916">(</span><span class="ident" id="5031917">enc</span>&nbsp;<span class="op" id="5031921">*</span><span class="ident" id="5031922">Encoder</span><span class="op" id="5031929">)</span>&nbsp;<span class="ident" id="5031931">popWriter</span><span class="op" id="5031940">(</span><span class="op" id="5031941">)</span>&nbsp;<span class="op" id="5031943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031946">enc</span><span class="op" id="5031949">.</span><span class="ident" id="5031950">w</span>&nbsp;<span class="op" id="5031952">=</span>&nbsp;<span class="ident" id="5031954">enc</span><span class="op" id="5031957">.</span><span class="ident" id="5031958">w</span><span class="op" id="5031959">[</span><span class="num" id="5031960">0</span>&nbsp;<span class="op" id="5031962">:</span>&nbsp;<span class="builtinfunc" id="5031964">len</span><span class="op" id="5031967">(</span><span class="ident" id="5031968">enc</span><span class="op" id="5031971">.</span><span class="ident" id="5031972">w</span><span class="op" id="5031973">)</span><span class="op" id="5031974">-</span><span class="num" id="5031975">1</span><span class="op" id="5031976">]</span><br>
<span class="lineno"></span><span class="op" id="5031978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5031981">func</span>&nbsp;<span class="op" id="5031986">(</span><span class="ident" id="5031987">enc</span>&nbsp;<span class="op" id="5031991">*</span><span class="ident" id="5031992">Encoder</span><span class="op" id="5031999">)</span>&nbsp;<span class="ident" id="5032001">setError</span><span class="op" id="5032009">(</span><span class="ident" id="5032010">err</span>&nbsp;<span class="builtintype" id="5032014">error</span><span class="op" id="5032019">)</span>&nbsp;<span class="op" id="5032021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032024">if</span>&nbsp;<span class="ident" id="5032027">enc</span><span class="op" id="5032030">.</span><span class="ident" id="5032031">err</span>&nbsp;<span class="op" id="5032035">==</span>&nbsp;<span class="ident" id="5032038">nil</span>&nbsp;<span class="op" id="5032042">{</span>&nbsp;<span class="comment" id="5032044">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032069">enc</span><span class="op" id="5032072">.</span><span class="ident" id="5032073">err</span>&nbsp;<span class="op" id="5032077">=</span>&nbsp;<span class="ident" id="5032079">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032084">}</span><br>
<span class="lineno"></span><span class="op" id="5032086">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5032089">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5032169">func</span>&nbsp;<span class="op" id="5032174">(</span><span class="ident" id="5032175">enc</span>&nbsp;<span class="op" id="5032179">*</span><span class="ident" id="5032180">Encoder</span><span class="op" id="5032187">)</span>&nbsp;<span class="ident" id="5032189">writeMessage</span><span class="op" id="5032201">(</span><span class="ident" id="5032202">w</span>&nbsp;<span class="ident" id="5032204">io</span><span class="op" id="5032206">.</span><span class="ident" id="5032207">Writer</span><span class="op" id="5032213">,</span>&nbsp;<span class="ident" id="5032215">b</span>&nbsp;<span class="op" id="5032217">*</span><span class="ident" id="5032218">encBuffer</span><span class="op" id="5032227">)</span>&nbsp;<span class="op" id="5032229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032232">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032303">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032383">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032399">message</span>&nbsp;<span class="op" id="5032407">:=</span>&nbsp;<span class="ident" id="5032410">b</span><span class="op" id="5032411">.</span><span class="ident" id="5032412">Bytes</span><span class="op" id="5032417">(</span><span class="op" id="5032418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032421">messageLen</span>&nbsp;<span class="op" id="5032432">:=</span>&nbsp;<span class="builtinfunc" id="5032435">len</span><span class="op" id="5032438">(</span><span class="ident" id="5032439">message</span><span class="op" id="5032446">)</span>&nbsp;<span class="op" id="5032448">-</span>&nbsp;<span class="ident" id="5032450">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032461">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032484">enc</span><span class="op" id="5032487">.</span><span class="ident" id="5032488">countState</span><span class="op" id="5032498">.</span><span class="ident" id="5032499">b</span><span class="op" id="5032500">.</span><span class="ident" id="5032501">Reset</span><span class="op" id="5032506">(</span><span class="op" id="5032507">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032510">enc</span><span class="op" id="5032513">.</span><span class="ident" id="5032514">countState</span><span class="op" id="5032524">.</span><span class="ident" id="5032525">encodeUint</span><span class="op" id="5032535">(</span><span class="ident" id="5032536">uint64</span><span class="op" id="5032542">(</span><span class="ident" id="5032543">messageLen</span><span class="op" id="5032553">)</span><span class="op" id="5032554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032557">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032608">offset</span>&nbsp;<span class="op" id="5032615">:=</span>&nbsp;<span class="ident" id="5032618">maxLength</span>&nbsp;<span class="op" id="5032628">-</span>&nbsp;<span class="ident" id="5032630">enc</span><span class="op" id="5032633">.</span><span class="ident" id="5032634">countState</span><span class="op" id="5032644">.</span><span class="ident" id="5032645">b</span><span class="op" id="5032646">.</span><span class="ident" id="5032647">Len</span><span class="op" id="5032650">(</span><span class="op" id="5032651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5032654">copy</span><span class="op" id="5032658">(</span><span class="ident" id="5032659">message</span><span class="op" id="5032666">[</span><span class="ident" id="5032667">offset</span><span class="op" id="5032673">:</span><span class="op" id="5032674">]</span><span class="op" id="5032675">,</span>&nbsp;<span class="ident" id="5032677">enc</span><span class="op" id="5032680">.</span><span class="ident" id="5032681">countState</span><span class="op" id="5032691">.</span><span class="ident" id="5032692">b</span><span class="op" id="5032693">.</span><span class="ident" id="5032694">Bytes</span><span class="op" id="5032699">(</span><span class="op" id="5032700">)</span><span class="op" id="5032701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032704">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032724">_</span><span class="op" id="5032725">,</span>&nbsp;<span class="ident" id="5032727">err</span>&nbsp;<span class="op" id="5032731">:=</span>&nbsp;<span class="ident" id="5032734">w</span><span class="op" id="5032735">.</span><span class="ident" id="5032736">Write</span><span class="op" id="5032741">(</span><span class="ident" id="5032742">message</span><span class="op" id="5032749">[</span><span class="ident" id="5032750">offset</span><span class="op" id="5032756">:</span><span class="op" id="5032757">]</span><span class="op" id="5032758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032761">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032852">b</span><span class="op" id="5032853">.</span><span class="ident" id="5032854">Reset</span><span class="op" id="5032859">(</span><span class="op" id="5032860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032863">b</span><span class="op" id="5032864">.</span><span class="ident" id="5032865">Write</span><span class="op" id="5032870">(</span><span class="ident" id="5032871">spaceForLength</span><span class="op" id="5032885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032888">if</span>&nbsp;<span class="ident" id="5032891">err</span>&nbsp;<span class="op" id="5032895">!=</span>&nbsp;<span class="ident" id="5032898">nil</span>&nbsp;<span class="op" id="5032902">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032906">enc</span><span class="op" id="5032909">.</span><span class="ident" id="5032910">setError</span><span class="op" id="5032918">(</span><span class="ident" id="5032919">err</span><span class="op" id="5032922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032925">}</span><br>
<span class="lineno"></span><span class="op" id="5032927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5032930">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="5033012">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="5033038">func</span>&nbsp;<span class="op" id="5033043">(</span><span class="ident" id="5033044">enc</span>&nbsp;<span class="op" id="5033048">*</span><span class="ident" id="5033049">Encoder</span><span class="op" id="5033056">)</span>&nbsp;<span class="ident" id="5033058">sendActualType</span><span class="op" id="5033072">(</span><span class="ident" id="5033073">w</span>&nbsp;<span class="ident" id="5033075">io</span><span class="op" id="5033077">.</span><span class="ident" id="5033078">Writer</span><span class="op" id="5033084">,</span>&nbsp;<span class="ident" id="5033086">state</span>&nbsp;<span class="op" id="5033092">*</span><span class="ident" id="5033093">encoderState</span><span class="op" id="5033105">,</span>&nbsp;<span class="ident" id="5033107">ut</span>&nbsp;<span class="op" id="5033110">*</span><span class="ident" id="5033111">userTypeInfo</span><span class="op" id="5033123">,</span>&nbsp;<span class="ident" id="5033125">actual</span>&nbsp;<span class="ident" id="5033132">reflect</span><span class="op" id="5033139">.</span><span class="ident" id="5033140">Type</span><span class="op" id="5033144">)</span>&nbsp;<span class="op" id="5033146">(</span><span class="ident" id="5033147">sent</span>&nbsp;<span class="builtintype" id="5033152">bool</span><span class="op" id="5033156">)</span>&nbsp;<span class="op" id="5033158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033161">if</span>&nbsp;<span class="ident" id="5033164">_</span><span class="op" id="5033165">,</span>&nbsp;<span class="ident" id="5033167">alreadySent</span>&nbsp;<span class="op" id="5033179">:=</span>&nbsp;<span class="ident" id="5033182">enc</span><span class="op" id="5033185">.</span><span class="ident" id="5033186">sent</span><span class="op" id="5033190">[</span><span class="ident" id="5033191">actual</span><span class="op" id="5033197">]</span><span class="op" id="5033198">;</span>&nbsp;<span class="ident" id="5033200">alreadySent</span>&nbsp;<span class="op" id="5033212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033216">return</span>&nbsp;<span class="builtintype" id="5033223">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033230">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033233">info</span><span class="op" id="5033237">,</span>&nbsp;<span class="ident" id="5033239">err</span>&nbsp;<span class="op" id="5033243">:=</span>&nbsp;<span class="ident" id="5033246">getTypeInfo</span><span class="op" id="5033257">(</span><span class="ident" id="5033258">ut</span><span class="op" id="5033260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033263">if</span>&nbsp;<span class="ident" id="5033266">err</span>&nbsp;<span class="op" id="5033270">!=</span>&nbsp;<span class="ident" id="5033273">nil</span>&nbsp;<span class="op" id="5033277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033281">enc</span><span class="op" id="5033284">.</span><span class="ident" id="5033285">setError</span><span class="op" id="5033293">(</span><span class="ident" id="5033294">err</span><span class="op" id="5033297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033309">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033312">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033342">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033350">state</span><span class="op" id="5033355">.</span><span class="ident" id="5033356">encodeInt</span><span class="op" id="5033365">(</span><span class="op" id="5033366">-</span><span class="ident" id="5033367">int64</span><span class="op" id="5033372">(</span><span class="ident" id="5033373">info</span><span class="op" id="5033377">.</span><span class="ident" id="5033378">id</span><span class="op" id="5033380">)</span><span class="op" id="5033381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033384">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033394">enc</span><span class="op" id="5033397">.</span><span class="ident" id="5033398">encode</span><span class="op" id="5033404">(</span><span class="ident" id="5033405">state</span><span class="op" id="5033410">.</span><span class="ident" id="5033411">b</span><span class="op" id="5033412">,</span>&nbsp;<span class="ident" id="5033414">reflect</span><span class="op" id="5033421">.</span><span class="ident" id="5033422">ValueOf</span><span class="op" id="5033429">(</span><span class="ident" id="5033430">info</span><span class="op" id="5033434">.</span><span class="ident" id="5033435">wire</span><span class="op" id="5033439">)</span><span class="op" id="5033440">,</span>&nbsp;<span class="ident" id="5033442">wireTypeUserInfo</span><span class="op" id="5033458">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033461">enc</span><span class="op" id="5033464">.</span><span class="ident" id="5033465">writeMessage</span><span class="op" id="5033477">(</span><span class="ident" id="5033478">w</span><span class="op" id="5033479">,</span>&nbsp;<span class="ident" id="5033481">state</span><span class="op" id="5033486">.</span><span class="ident" id="5033487">b</span><span class="op" id="5033488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033491">if</span>&nbsp;<span class="ident" id="5033494">enc</span><span class="op" id="5033497">.</span><span class="ident" id="5033498">err</span>&nbsp;<span class="op" id="5033502">!=</span>&nbsp;<span class="ident" id="5033505">nil</span>&nbsp;<span class="op" id="5033509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033513">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033525">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033606">enc</span><span class="op" id="5033609">.</span><span class="ident" id="5033610">sent</span><span class="op" id="5033614">[</span><span class="ident" id="5033615">ut</span><span class="op" id="5033617">.</span><span class="ident" id="5033618">base</span><span class="op" id="5033622">]</span>&nbsp;<span class="op" id="5033624">=</span>&nbsp;<span class="ident" id="5033626">info</span><span class="op" id="5033630">.</span><span class="ident" id="5033631">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033635">if</span>&nbsp;<span class="ident" id="5033638">ut</span><span class="op" id="5033640">.</span><span class="ident" id="5033641">user</span>&nbsp;<span class="op" id="5033646">!=</span>&nbsp;<span class="ident" id="5033649">ut</span><span class="op" id="5033651">.</span><span class="ident" id="5033652">base</span>&nbsp;<span class="op" id="5033657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033661">enc</span><span class="op" id="5033664">.</span><span class="ident" id="5033665">sent</span><span class="op" id="5033669">[</span><span class="ident" id="5033670">ut</span><span class="op" id="5033672">.</span><span class="ident" id="5033673">user</span><span class="op" id="5033677">]</span>&nbsp;<span class="op" id="5033679">=</span>&nbsp;<span class="ident" id="5033681">info</span><span class="op" id="5033685">.</span><span class="ident" id="5033686">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033690">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033693">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033722">switch</span>&nbsp;<span class="ident" id="5033729">st</span>&nbsp;<span class="op" id="5033732">:=</span>&nbsp;<span class="ident" id="5033735">actual</span><span class="op" id="5033741">;</span>&nbsp;<span class="ident" id="5033743">st</span><span class="op" id="5033745">.</span><span class="ident" id="5033746">Kind</span><span class="op" id="5033750">(</span><span class="op" id="5033751">)</span>&nbsp;<span class="op" id="5033753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033756">case</span>&nbsp;<span class="ident" id="5033761">reflect</span><span class="op" id="5033768">.</span><span class="ident" id="5033769">Struct</span><span class="op" id="5033775">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033779">for</span>&nbsp;<span class="ident" id="5033783">i</span>&nbsp;<span class="op" id="5033785">:=</span>&nbsp;<span class="num" id="5033788">0</span><span class="op" id="5033789">;</span>&nbsp;<span class="ident" id="5033791">i</span>&nbsp;<span class="op" id="5033793">&lt;</span>&nbsp;<span class="ident" id="5033795">st</span><span class="op" id="5033797">.</span><span class="ident" id="5033798">NumField</span><span class="op" id="5033806">(</span><span class="op" id="5033807">)</span><span class="op" id="5033808">;</span>&nbsp;<span class="ident" id="5033810">i</span><span class="op" id="5033811">++</span>&nbsp;<span class="op" id="5033814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033819">if</span>&nbsp;<span class="ident" id="5033822">isExported</span><span class="op" id="5033832">(</span><span class="ident" id="5033833">st</span><span class="op" id="5033835">.</span><span class="ident" id="5033836">Field</span><span class="op" id="5033841">(</span><span class="ident" id="5033842">i</span><span class="op" id="5033843">)</span><span class="op" id="5033844">.</span><span class="ident" id="5033845">Name</span><span class="op" id="5033849">)</span>&nbsp;<span class="op" id="5033851">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033857">enc</span><span class="op" id="5033860">.</span><span class="ident" id="5033861">sendType</span><span class="op" id="5033869">(</span><span class="ident" id="5033870">w</span><span class="op" id="5033871">,</span>&nbsp;<span class="ident" id="5033873">state</span><span class="op" id="5033878">,</span>&nbsp;<span class="ident" id="5033880">st</span><span class="op" id="5033882">.</span><span class="ident" id="5033883">Field</span><span class="op" id="5033888">(</span><span class="ident" id="5033889">i</span><span class="op" id="5033890">)</span><span class="op" id="5033891">.</span><span class="ident" id="5033892">Type</span><span class="op" id="5033896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033908">case</span>&nbsp;<span class="ident" id="5033913">reflect</span><span class="op" id="5033920">.</span><span class="ident" id="5033921">Array</span><span class="op" id="5033926">,</span>&nbsp;<span class="ident" id="5033928">reflect</span><span class="op" id="5033935">.</span><span class="ident" id="5033936">Slice</span><span class="op" id="5033941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033945">enc</span><span class="op" id="5033948">.</span><span class="ident" id="5033949">sendType</span><span class="op" id="5033957">(</span><span class="ident" id="5033958">w</span><span class="op" id="5033959">,</span>&nbsp;<span class="ident" id="5033961">state</span><span class="op" id="5033966">,</span>&nbsp;<span class="ident" id="5033968">st</span><span class="op" id="5033970">.</span><span class="ident" id="5033971">Elem</span><span class="op" id="5033975">(</span><span class="op" id="5033976">)</span><span class="op" id="5033977">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033980">case</span>&nbsp;<span class="ident" id="5033985">reflect</span><span class="op" id="5033992">.</span><span class="ident" id="5033993">Map</span><span class="op" id="5033996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034000">enc</span><span class="op" id="5034003">.</span><span class="ident" id="5034004">sendType</span><span class="op" id="5034012">(</span><span class="ident" id="5034013">w</span><span class="op" id="5034014">,</span>&nbsp;<span class="ident" id="5034016">state</span><span class="op" id="5034021">,</span>&nbsp;<span class="ident" id="5034023">st</span><span class="op" id="5034025">.</span><span class="ident" id="5034026">Key</span><span class="op" id="5034029">(</span><span class="op" id="5034030">)</span><span class="op" id="5034031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034035">enc</span><span class="op" id="5034038">.</span><span class="ident" id="5034039">sendType</span><span class="op" id="5034047">(</span><span class="ident" id="5034048">w</span><span class="op" id="5034049">,</span>&nbsp;<span class="ident" id="5034051">state</span><span class="op" id="5034056">,</span>&nbsp;<span class="ident" id="5034058">st</span><span class="op" id="5034060">.</span><span class="ident" id="5034061">Elem</span><span class="op" id="5034065">(</span><span class="op" id="5034066">)</span><span class="op" id="5034067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5034070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034073">return</span>&nbsp;<span class="builtintype" id="5034080">true</span><br>
<span class="lineno">125</span><span class="op" id="5034085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5034088">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5034153">func</span>&nbsp;<span class="op" id="5034158">(</span><span class="ident" id="5034159">enc</span>&nbsp;<span class="op" id="5034163">*</span><span class="ident" id="5034164">Encoder</span><span class="op" id="5034171">)</span>&nbsp;<span class="ident" id="5034173">sendType</span><span class="op" id="5034181">(</span><span class="ident" id="5034182">w</span>&nbsp;<span class="ident" id="5034184">io</span><span class="op" id="5034186">.</span><span class="ident" id="5034187">Writer</span><span class="op" id="5034193">,</span>&nbsp;<span class="ident" id="5034195">state</span>&nbsp;<span class="op" id="5034201">*</span><span class="ident" id="5034202">encoderState</span><span class="op" id="5034214">,</span>&nbsp;<span class="ident" id="5034216">origt</span>&nbsp;<span class="ident" id="5034222">reflect</span><span class="op" id="5034229">.</span><span class="ident" id="5034230">Type</span><span class="op" id="5034234">)</span>&nbsp;<span class="op" id="5034236">(</span><span class="ident" id="5034237">sent</span>&nbsp;<span class="builtintype" id="5034242">bool</span><span class="op" id="5034246">)</span>&nbsp;<span class="op" id="5034248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034251">ut</span>&nbsp;<span class="op" id="5034254">:=</span>&nbsp;<span class="ident" id="5034257">userType</span><span class="op" id="5034265">(</span><span class="ident" id="5034266">origt</span><span class="op" id="5034271">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034274">if</span>&nbsp;<span class="ident" id="5034277">ut</span><span class="op" id="5034279">.</span><span class="ident" id="5034280">externalEnc</span>&nbsp;<span class="op" id="5034292">!=</span>&nbsp;<span class="num" id="5034295">0</span>&nbsp;<span class="op" id="5034297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034301">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034383">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034455">return</span>&nbsp;<span class="ident" id="5034462">enc</span><span class="op" id="5034465">.</span><span class="ident" id="5034466">sendActualType</span><span class="op" id="5034480">(</span><span class="ident" id="5034481">w</span><span class="op" id="5034482">,</span>&nbsp;<span class="ident" id="5034484">state</span><span class="op" id="5034489">,</span>&nbsp;<span class="ident" id="5034491">ut</span><span class="op" id="5034493">,</span>&nbsp;<span class="ident" id="5034495">ut</span><span class="op" id="5034497">.</span><span class="ident" id="5034498">base</span><span class="op" id="5034502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5034505">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034509">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034568">switch</span>&nbsp;<span class="ident" id="5034575">rt</span>&nbsp;<span class="op" id="5034578">:=</span>&nbsp;<span class="ident" id="5034581">ut</span><span class="op" id="5034583">.</span><span class="ident" id="5034584">base</span><span class="op" id="5034588">;</span>&nbsp;<span class="ident" id="5034590">rt</span><span class="op" id="5034592">.</span><span class="ident" id="5034593">Kind</span><span class="op" id="5034597">(</span><span class="op" id="5034598">)</span>&nbsp;<span class="op" id="5034600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034603">default</span><span class="op" id="5034610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034614">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034675">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034683">case</span>&nbsp;<span class="ident" id="5034688">reflect</span><span class="op" id="5034695">.</span><span class="ident" id="5034696">Slice</span><span class="op" id="5034701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034705">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034762">if</span>&nbsp;<span class="ident" id="5034765">rt</span><span class="op" id="5034767">.</span><span class="ident" id="5034768">Elem</span><span class="op" id="5034772">(</span><span class="op" id="5034773">)</span><span class="op" id="5034774">.</span><span class="ident" id="5034775">Kind</span><span class="op" id="5034779">(</span><span class="op" id="5034780">)</span>&nbsp;<span class="op" id="5034782">==</span>&nbsp;<span class="ident" id="5034785">reflect</span><span class="op" id="5034792">.</span><span class="ident" id="5034793">Uint8</span>&nbsp;<span class="op" id="5034799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034804">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5034813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034817">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034844">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034851">case</span>&nbsp;<span class="ident" id="5034856">reflect</span><span class="op" id="5034863">.</span><span class="ident" id="5034864">Array</span><span class="op" id="5034869">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034873">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034942">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034949">case</span>&nbsp;<span class="ident" id="5034954">reflect</span><span class="op" id="5034961">.</span><span class="ident" id="5034962">Map</span><span class="op" id="5034965">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5034969">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035038">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035045">case</span>&nbsp;<span class="ident" id="5035050">reflect</span><span class="op" id="5035057">.</span><span class="ident" id="5035058">Struct</span><span class="op" id="5035064">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5035068">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035119">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035126">case</span>&nbsp;<span class="ident" id="5035131">reflect</span><span class="op" id="5035138">.</span><span class="ident" id="5035139">Chan</span><span class="op" id="5035143">,</span>&nbsp;<span class="ident" id="5035145">reflect</span><span class="op" id="5035152">.</span><span class="ident" id="5035153">Func</span><span class="op" id="5035157">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5035161">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035219">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035231">return</span>&nbsp;<span class="ident" id="5035238">enc</span><span class="op" id="5035241">.</span><span class="ident" id="5035242">sendActualType</span><span class="op" id="5035256">(</span><span class="ident" id="5035257">w</span><span class="op" id="5035258">,</span>&nbsp;<span class="ident" id="5035260">state</span><span class="op" id="5035265">,</span>&nbsp;<span class="ident" id="5035267">ut</span><span class="op" id="5035269">,</span>&nbsp;<span class="ident" id="5035271">ut</span><span class="op" id="5035273">.</span><span class="ident" id="5035274">base</span><span class="op" id="5035278">)</span><br>
<span class="lineno"></span><span class="op" id="5035280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5035283">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5035359">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5035439">func</span>&nbsp;<span class="op" id="5035444">(</span><span class="ident" id="5035445">enc</span>&nbsp;<span class="op" id="5035449">*</span><span class="ident" id="5035450">Encoder</span><span class="op" id="5035457">)</span>&nbsp;<span class="ident" id="5035459">Encode</span><span class="op" id="5035465">(</span><span class="ident" id="5035466">e</span>&nbsp;<span class="keyword" id="5035468">interface</span><span class="op" id="5035477">{</span><span class="op" id="5035478">}</span><span class="op" id="5035479">)</span>&nbsp;<span class="builtintype" id="5035481">error</span>&nbsp;<span class="op" id="5035487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035490">return</span>&nbsp;<span class="ident" id="5035497">enc</span><span class="op" id="5035500">.</span><span class="ident" id="5035501">EncodeValue</span><span class="op" id="5035512">(</span><span class="ident" id="5035513">reflect</span><span class="op" id="5035520">.</span><span class="ident" id="5035521">ValueOf</span><span class="op" id="5035528">(</span><span class="ident" id="5035529">e</span><span class="op" id="5035530">)</span><span class="op" id="5035531">)</span><br>
<span class="lineno"></span><span class="op" id="5035533">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="5035536">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5035608">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="5035681">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="5035690">func</span>&nbsp;<span class="op" id="5035695">(</span><span class="ident" id="5035696">enc</span>&nbsp;<span class="op" id="5035700">*</span><span class="ident" id="5035701">Encoder</span><span class="op" id="5035708">)</span>&nbsp;<span class="ident" id="5035710">sendTypeDescriptor</span><span class="op" id="5035728">(</span><span class="ident" id="5035729">w</span>&nbsp;<span class="ident" id="5035731">io</span><span class="op" id="5035733">.</span><span class="ident" id="5035734">Writer</span><span class="op" id="5035740">,</span>&nbsp;<span class="ident" id="5035742">state</span>&nbsp;<span class="op" id="5035748">*</span><span class="ident" id="5035749">encoderState</span><span class="op" id="5035761">,</span>&nbsp;<span class="ident" id="5035763">ut</span>&nbsp;<span class="op" id="5035766">*</span><span class="ident" id="5035767">userTypeInfo</span><span class="op" id="5035779">)</span>&nbsp;<span class="op" id="5035781">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5035784">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5035835">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035878">rt</span>&nbsp;<span class="op" id="5035881">:=</span>&nbsp;<span class="ident" id="5035884">ut</span><span class="op" id="5035886">.</span><span class="ident" id="5035887">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035893">if</span>&nbsp;<span class="ident" id="5035896">ut</span><span class="op" id="5035898">.</span><span class="ident" id="5035899">externalEnc</span>&nbsp;<span class="op" id="5035911">!=</span>&nbsp;<span class="num" id="5035914">0</span>&nbsp;<span class="op" id="5035916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035920">rt</span>&nbsp;<span class="op" id="5035923">=</span>&nbsp;<span class="ident" id="5035925">ut</span><span class="op" id="5035927">.</span><span class="ident" id="5035928">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035937">if</span>&nbsp;<span class="ident" id="5035940">_</span><span class="op" id="5035941">,</span>&nbsp;<span class="ident" id="5035943">alreadySent</span>&nbsp;<span class="op" id="5035955">:=</span>&nbsp;<span class="ident" id="5035958">enc</span><span class="op" id="5035961">.</span><span class="ident" id="5035962">sent</span><span class="op" id="5035966">[</span><span class="ident" id="5035967">rt</span><span class="op" id="5035969">]</span><span class="op" id="5035970">;</span>&nbsp;<span class="op" id="5035972">!</span><span class="ident" id="5035973">alreadySent</span>&nbsp;<span class="op" id="5035985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5035989">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036010">sent</span>&nbsp;<span class="op" id="5036015">:=</span>&nbsp;<span class="ident" id="5036018">enc</span><span class="op" id="5036021">.</span><span class="ident" id="5036022">sendType</span><span class="op" id="5036030">(</span><span class="ident" id="5036031">w</span><span class="op" id="5036032">,</span>&nbsp;<span class="ident" id="5036034">state</span><span class="op" id="5036039">,</span>&nbsp;<span class="ident" id="5036041">rt</span><span class="op" id="5036043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036047">if</span>&nbsp;<span class="ident" id="5036050">enc</span><span class="op" id="5036053">.</span><span class="ident" id="5036054">err</span>&nbsp;<span class="op" id="5036058">!=</span>&nbsp;<span class="ident" id="5036061">nil</span>&nbsp;<span class="op" id="5036065">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036070">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5036083">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5036154">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5036225">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036292">if</span>&nbsp;<span class="op" id="5036295">!</span><span class="ident" id="5036296">sent</span>&nbsp;<span class="op" id="5036301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036306">info</span><span class="op" id="5036310">,</span>&nbsp;<span class="ident" id="5036312">err</span>&nbsp;<span class="op" id="5036316">:=</span>&nbsp;<span class="ident" id="5036319">getTypeInfo</span><span class="op" id="5036330">(</span><span class="ident" id="5036331">ut</span><span class="op" id="5036333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036338">if</span>&nbsp;<span class="ident" id="5036341">err</span>&nbsp;<span class="op" id="5036345">!=</span>&nbsp;<span class="ident" id="5036348">nil</span>&nbsp;<span class="op" id="5036352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036358">enc</span><span class="op" id="5036361">.</span><span class="ident" id="5036362">setError</span><span class="op" id="5036370">(</span><span class="ident" id="5036371">err</span><span class="op" id="5036374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036380">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036395">enc</span><span class="op" id="5036398">.</span><span class="ident" id="5036399">sent</span><span class="op" id="5036403">[</span><span class="ident" id="5036404">rt</span><span class="op" id="5036406">]</span>&nbsp;<span class="op" id="5036408">=</span>&nbsp;<span class="ident" id="5036410">info</span><span class="op" id="5036414">.</span><span class="ident" id="5036415">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036423">}</span><br>
<span class="lineno"></span><span class="op" id="5036425">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5036428">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5036494">func</span>&nbsp;<span class="op" id="5036499">(</span><span class="ident" id="5036500">enc</span>&nbsp;<span class="op" id="5036504">*</span><span class="ident" id="5036505">Encoder</span><span class="op" id="5036512">)</span>&nbsp;<span class="ident" id="5036514">sendTypeId</span><span class="op" id="5036524">(</span><span class="ident" id="5036525">state</span>&nbsp;<span class="op" id="5036531">*</span><span class="ident" id="5036532">encoderState</span><span class="op" id="5036544">,</span>&nbsp;<span class="ident" id="5036546">ut</span>&nbsp;<span class="op" id="5036549">*</span><span class="ident" id="5036550">userTypeInfo</span><span class="op" id="5036562">)</span>&nbsp;<span class="op" id="5036564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5036567">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036614">state</span><span class="op" id="5036619">.</span><span class="ident" id="5036620">encodeInt</span><span class="op" id="5036629">(</span><span class="ident" id="5036630">int64</span><span class="op" id="5036635">(</span><span class="ident" id="5036636">enc</span><span class="op" id="5036639">.</span><span class="ident" id="5036640">sent</span><span class="op" id="5036644">[</span><span class="ident" id="5036645">ut</span><span class="op" id="5036647">.</span><span class="ident" id="5036648">base</span><span class="op" id="5036652">]</span><span class="op" id="5036653">)</span><span class="op" id="5036654">)</span><br>
<span class="lineno">205</span><span class="op" id="5036656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5036659">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5036735">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5036815">func</span>&nbsp;<span class="op" id="5036820">(</span><span class="ident" id="5036821">enc</span>&nbsp;<span class="op" id="5036825">*</span><span class="ident" id="5036826">Encoder</span><span class="op" id="5036833">)</span>&nbsp;<span class="ident" id="5036835">EncodeValue</span><span class="op" id="5036846">(</span><span class="ident" id="5036847">value</span>&nbsp;<span class="ident" id="5036853">reflect</span><span class="op" id="5036860">.</span><span class="ident" id="5036861">Value</span><span class="op" id="5036866">)</span>&nbsp;<span class="builtintype" id="5036868">error</span>&nbsp;<span class="op" id="5036874">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5036877">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5036944">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036973">if</span>&nbsp;<span class="ident" id="5036976">value</span><span class="op" id="5036981">.</span><span class="ident" id="5036982">Kind</span><span class="op" id="5036986">(</span><span class="op" id="5036987">)</span>&nbsp;<span class="op" id="5036989">==</span>&nbsp;<span class="ident" id="5036992">reflect</span><span class="op" id="5036999">.</span><span class="ident" id="5037000">Ptr</span>&nbsp;<span class="op" id="5037004">&amp;&amp;</span>&nbsp;<span class="ident" id="5037007">value</span><span class="op" id="5037012">.</span><span class="ident" id="5037013">IsNil</span><span class="op" id="5037018">(</span><span class="op" id="5037019">)</span>&nbsp;<span class="op" id="5037021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5037025">panic</span><span class="op" id="5037030">(</span><span class="string" id="5037031">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5037073">+</span>&nbsp;<span class="ident" id="5037075">value</span><span class="op" id="5037080">.</span><span class="ident" id="5037081">Type</span><span class="op" id="5037085">(</span><span class="op" id="5037086">)</span><span class="op" id="5037087">.</span><span class="ident" id="5037088">String</span><span class="op" id="5037094">(</span><span class="op" id="5037095">)</span><span class="op" id="5037096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037099">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037103">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037165">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037202">enc</span><span class="op" id="5037205">.</span><span class="ident" id="5037206">mutex</span><span class="op" id="5037211">.</span><span class="ident" id="5037212">Lock</span><span class="op" id="5037216">(</span><span class="op" id="5037217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037220">defer</span>&nbsp;<span class="ident" id="5037226">enc</span><span class="op" id="5037229">.</span><span class="ident" id="5037230">mutex</span><span class="op" id="5037235">.</span><span class="ident" id="5037236">Unlock</span><span class="op" id="5037242">(</span><span class="op" id="5037243">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037247">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037311">enc</span><span class="op" id="5037314">.</span><span class="ident" id="5037315">w</span>&nbsp;<span class="op" id="5037317">=</span>&nbsp;<span class="ident" id="5037319">enc</span><span class="op" id="5037322">.</span><span class="ident" id="5037323">w</span><span class="op" id="5037324">[</span><span class="num" id="5037325">0</span><span class="op" id="5037326">:</span><span class="num" id="5037327">1</span><span class="op" id="5037328">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037332">ut</span><span class="op" id="5037334">,</span>&nbsp;<span class="ident" id="5037336">err</span>&nbsp;<span class="op" id="5037340">:=</span>&nbsp;<span class="ident" id="5037343">validUserType</span><span class="op" id="5037356">(</span><span class="ident" id="5037357">value</span><span class="op" id="5037362">.</span><span class="ident" id="5037363">Type</span><span class="op" id="5037367">(</span><span class="op" id="5037368">)</span><span class="op" id="5037369">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037372">if</span>&nbsp;<span class="ident" id="5037375">err</span>&nbsp;<span class="op" id="5037379">!=</span>&nbsp;<span class="ident" id="5037382">nil</span>&nbsp;<span class="op" id="5037386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037390">return</span>&nbsp;<span class="ident" id="5037397">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037406">enc</span><span class="op" id="5037409">.</span><span class="ident" id="5037410">err</span>&nbsp;<span class="op" id="5037414">=</span>&nbsp;<span class="ident" id="5037416">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037421">enc</span><span class="op" id="5037424">.</span><span class="ident" id="5037425">byteBuf</span><span class="op" id="5037432">.</span><span class="ident" id="5037433">Reset</span><span class="op" id="5037438">(</span><span class="op" id="5037439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037442">enc</span><span class="op" id="5037445">.</span><span class="ident" id="5037446">byteBuf</span><span class="op" id="5037453">.</span><span class="ident" id="5037454">Write</span><span class="op" id="5037459">(</span><span class="ident" id="5037460">spaceForLength</span><span class="op" id="5037474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037477">state</span>&nbsp;<span class="op" id="5037483">:=</span>&nbsp;<span class="ident" id="5037486">enc</span><span class="op" id="5037489">.</span><span class="ident" id="5037490">newEncoderState</span><span class="op" id="5037505">(</span><span class="op" id="5037506">&amp;</span><span class="ident" id="5037507">enc</span><span class="op" id="5037510">.</span><span class="ident" id="5037511">byteBuf</span><span class="op" id="5037518">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037522">enc</span><span class="op" id="5037525">.</span><span class="ident" id="5037526">sendTypeDescriptor</span><span class="op" id="5037544">(</span><span class="ident" id="5037545">enc</span><span class="op" id="5037548">.</span><span class="ident" id="5037549">writer</span><span class="op" id="5037555">(</span><span class="op" id="5037556">)</span><span class="op" id="5037557">,</span>&nbsp;<span class="ident" id="5037559">state</span><span class="op" id="5037564">,</span>&nbsp;<span class="ident" id="5037566">ut</span><span class="op" id="5037568">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037571">enc</span><span class="op" id="5037574">.</span><span class="ident" id="5037575">sendTypeId</span><span class="op" id="5037585">(</span><span class="ident" id="5037586">state</span><span class="op" id="5037591">,</span>&nbsp;<span class="ident" id="5037593">ut</span><span class="op" id="5037595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037598">if</span>&nbsp;<span class="ident" id="5037601">enc</span><span class="op" id="5037604">.</span><span class="ident" id="5037605">err</span>&nbsp;<span class="op" id="5037609">!=</span>&nbsp;<span class="ident" id="5037612">nil</span>&nbsp;<span class="op" id="5037616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037620">return</span>&nbsp;<span class="ident" id="5037627">enc</span><span class="op" id="5037630">.</span><span class="ident" id="5037631">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037640">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037663">enc</span><span class="op" id="5037666">.</span><span class="ident" id="5037667">encode</span><span class="op" id="5037673">(</span><span class="ident" id="5037674">state</span><span class="op" id="5037679">.</span><span class="ident" id="5037680">b</span><span class="op" id="5037681">,</span>&nbsp;<span class="ident" id="5037683">value</span><span class="op" id="5037688">,</span>&nbsp;<span class="ident" id="5037690">ut</span><span class="op" id="5037692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037695">if</span>&nbsp;<span class="ident" id="5037698">enc</span><span class="op" id="5037701">.</span><span class="ident" id="5037702">err</span>&nbsp;<span class="op" id="5037706">==</span>&nbsp;<span class="ident" id="5037709">nil</span>&nbsp;<span class="op" id="5037713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037717">enc</span><span class="op" id="5037720">.</span><span class="ident" id="5037721">writeMessage</span><span class="op" id="5037733">(</span><span class="ident" id="5037734">enc</span><span class="op" id="5037737">.</span><span class="ident" id="5037738">writer</span><span class="op" id="5037744">(</span><span class="op" id="5037745">)</span><span class="op" id="5037746">,</span>&nbsp;<span class="ident" id="5037748">state</span><span class="op" id="5037753">.</span><span class="ident" id="5037754">b</span><span class="op" id="5037755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037758">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037762">enc</span><span class="op" id="5037765">.</span><span class="ident" id="5037766">freeEncoderState</span><span class="op" id="5037782">(</span><span class="ident" id="5037783">state</span><span class="op" id="5037788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037791">return</span>&nbsp;<span class="ident" id="5037798">enc</span><span class="op" id="5037801">.</span><span class="ident" id="5037802">err</span><br>
<span class="lineno"></span><span class="op" id="5037806">}</span>
</div>
</body>
</html>
