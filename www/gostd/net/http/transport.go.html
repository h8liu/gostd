<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3144985">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3145040">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3145094">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3145145">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3145190">//</span><br>
<span class="lineno"></span><span class="comment" id="3145193">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3145260">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3145306">package</span>&nbsp;<span class="ident" id="3145314">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3145320">import</span>&nbsp;<span class="op" id="3145327">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145330">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145339">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145356">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145370">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145380">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145387">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145393">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145400">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145407">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145418">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145424">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145435">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145443">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3145450">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3145453">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3145523">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3145594">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3145665">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3145733">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3145770">var</span>&nbsp;<span class="ident" id="3145774">DefaultTransport</span>&nbsp;<span class="ident" id="3145791">RoundTripper</span>&nbsp;<span class="op" id="3145804">=</span>&nbsp;<span class="op" id="3145806">&amp;</span><span class="ident" id="3145807">Transport</span><span class="op" id="3145816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145819">Proxy</span><span class="op" id="3145824">:</span>&nbsp;<span class="ident" id="3145826">ProxyFromEnvironment</span><span class="op" id="3145846">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145849">Dial</span><span class="op" id="3145853">:</span>&nbsp;<span class="op" id="3145855">(</span><span class="op" id="3145856">&amp;</span><span class="ident" id="3145857">net</span><span class="op" id="3145860">.</span><span class="ident" id="3145861">Dialer</span><span class="op" id="3145867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145871">Timeout</span><span class="op" id="3145878">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3145882">30</span>&nbsp;<span class="op" id="3145885">*</span>&nbsp;<span class="ident" id="3145887">time</span><span class="op" id="3145891">.</span><span class="ident" id="3145892">Second</span><span class="op" id="3145898">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145902">KeepAlive</span><span class="op" id="3145911">:</span>&nbsp;<span class="num" id="3145913">30</span>&nbsp;<span class="op" id="3145916">*</span>&nbsp;<span class="ident" id="3145918">time</span><span class="op" id="3145922">.</span><span class="ident" id="3145923">Second</span><span class="op" id="3145929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145932">}</span><span class="op" id="3145933">)</span><span class="op" id="3145934">.</span><span class="ident" id="3145935">Dial</span><span class="op" id="3145939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145942">TLSHandshakeTimeout</span><span class="op" id="3145961">:</span>&nbsp;<span class="num" id="3145963">10</span>&nbsp;<span class="op" id="3145966">*</span>&nbsp;<span class="ident" id="3145968">time</span><span class="op" id="3145972">.</span><span class="ident" id="3145973">Second</span><span class="op" id="3145979">,</span><br>
<span class="lineno">40</span><span class="op" id="3145981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3145984">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3146050">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3146074">const</span>&nbsp;<span class="ident" id="3146080">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3146107">=</span>&nbsp;<span class="num" id="3146109">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3146112">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3146182">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3146250">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3146309">type</span>&nbsp;<span class="ident" id="3146314">Transport</span>&nbsp;<span class="keyword" id="3146324">struct</span>&nbsp;<span class="op" id="3146331">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146334">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3146345">sync</span><span class="op" id="3146349">.</span><span class="ident" id="3146350">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146357">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3146368">bool</span>&nbsp;<span class="comment" id="3146373">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146420">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3146431">map</span><span class="op" id="3146434">[</span><span class="ident" id="3146435">connectMethodKey</span><span class="op" id="3146451">]</span><span class="op" id="3146452">[</span><span class="op" id="3146453">]</span><span class="op" id="3146454">*</span><span class="ident" id="3146455">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146468">idleConnCh</span>&nbsp;<span class="keyword" id="3146479">map</span><span class="op" id="3146482">[</span><span class="ident" id="3146483">connectMethodKey</span><span class="op" id="3146499">]</span><span class="keyword" id="3146500">chan</span>&nbsp;<span class="op" id="3146505">*</span><span class="ident" id="3146506">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146520">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3146532">sync</span><span class="op" id="3146536">.</span><span class="ident" id="3146537">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146544">reqCanceler</span>&nbsp;<span class="keyword" id="3146556">map</span><span class="op" id="3146559">[</span><span class="op" id="3146560">*</span><span class="ident" id="3146561">Request</span><span class="op" id="3146568">]</span><span class="keyword" id="3146569">func</span><span class="op" id="3146573">(</span><span class="op" id="3146574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146578">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3146587">sync</span><span class="op" id="3146591">.</span><span class="ident" id="3146592">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146601">altProto</span>&nbsp;<span class="keyword" id="3146610">map</span><span class="op" id="3146613">[</span><span class="builtintype" id="3146614">string</span><span class="op" id="3146620">]</span><span class="ident" id="3146621">RoundTripper</span>&nbsp;<span class="comment" id="3146634">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3146680">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3146741">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3146799">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3146847">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146908">Proxy</span>&nbsp;<span class="keyword" id="3146914">func</span><span class="op" id="3146918">(</span><span class="op" id="3146919">*</span><span class="ident" id="3146920">Request</span><span class="op" id="3146927">)</span>&nbsp;<span class="op" id="3146929">(</span><span class="op" id="3146930">*</span><span class="ident" id="3146931">url</span><span class="op" id="3146934">.</span><span class="ident" id="3146935">URL</span><span class="op" id="3146938">,</span>&nbsp;<span class="builtintype" id="3146940">error</span><span class="op" id="3146945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3146949">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147011">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147032">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147070">Dial</span>&nbsp;<span class="keyword" id="3147075">func</span><span class="op" id="3147079">(</span><span class="ident" id="3147080">network</span><span class="op" id="3147087">,</span>&nbsp;<span class="ident" id="3147089">addr</span>&nbsp;<span class="builtintype" id="3147094">string</span><span class="op" id="3147100">)</span>&nbsp;<span class="op" id="3147102">(</span><span class="ident" id="3147103">net</span><span class="op" id="3147106">.</span><span class="ident" id="3147107">Conn</span><span class="op" id="3147111">,</span>&nbsp;<span class="builtintype" id="3147113">error</span><span class="op" id="3147118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147122">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147183">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147235">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147239">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147297">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147301">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147360">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147421">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147485">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147513">DialTLS</span>&nbsp;<span class="keyword" id="3147521">func</span><span class="op" id="3147525">(</span><span class="ident" id="3147526">network</span><span class="op" id="3147533">,</span>&nbsp;<span class="ident" id="3147535">addr</span>&nbsp;<span class="builtintype" id="3147540">string</span><span class="op" id="3147546">)</span>&nbsp;<span class="op" id="3147548">(</span><span class="ident" id="3147549">net</span><span class="op" id="3147552">.</span><span class="ident" id="3147553">Conn</span><span class="op" id="3147557">,</span>&nbsp;<span class="builtintype" id="3147559">error</span><span class="op" id="3147564">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147568">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147632">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147691">TLSClientConfig</span>&nbsp;<span class="op" id="3147707">*</span><span class="ident" id="3147708">tls</span><span class="op" id="3147711">.</span><span class="ident" id="3147712">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147721">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147793">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147846">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3147866">time</span><span class="op" id="3147870">.</span><span class="ident" id="3147871">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147882">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147949">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147986">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3148004">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148011">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148072">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148131">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148188">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148249">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148309">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148364">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148418">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148436">DisableCompression</span>&nbsp;<span class="builtintype" id="3148455">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148462">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148526">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148571">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148611">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3148631">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148637">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148701">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148762">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148821">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148883">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3148905">time</span><span class="op" id="3148909">.</span><span class="ident" id="3148910">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148921">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148972">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3149022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3149025">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3149091">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3149151">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3149218">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3149286">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3149299">//</span><br>
<span class="lineno"></span><span class="comment" id="3149302">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3149362">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3149424">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3149482">//</span><br>
<span class="lineno">130</span><span class="comment" id="3149485">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3149555">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3149624">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3149651">//</span><br>
<span class="lineno"></span><span class="comment" id="3149654">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3149724">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3149790">func</span>&nbsp;<span class="ident" id="3149795">ProxyFromEnvironment</span><span class="op" id="3149815">(</span><span class="ident" id="3149816">req</span>&nbsp;<span class="op" id="3149820">*</span><span class="ident" id="3149821">Request</span><span class="op" id="3149828">)</span>&nbsp;<span class="op" id="3149830">(</span><span class="op" id="3149831">*</span><span class="ident" id="3149832">url</span><span class="op" id="3149835">.</span><span class="ident" id="3149836">URL</span><span class="op" id="3149839">,</span>&nbsp;<span class="builtintype" id="3149841">error</span><span class="op" id="3149846">)</span>&nbsp;<span class="op" id="3149848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149851">var</span>&nbsp;<span class="ident" id="3149855">proxy</span>&nbsp;<span class="builtintype" id="3149861">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149869">if</span>&nbsp;<span class="ident" id="3149872">req</span><span class="op" id="3149875">.</span><span class="ident" id="3149876">URL</span><span class="op" id="3149879">.</span><span class="ident" id="3149880">Scheme</span>&nbsp;<span class="op" id="3149887">==</span>&nbsp;<span class="string" id="3149890">&#34;https&#34;</span>&nbsp;<span class="op" id="3149898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149902">proxy</span>&nbsp;<span class="op" id="3149908">=</span>&nbsp;<span class="ident" id="3149910">httpsProxyEnv</span><span class="op" id="3149923">.</span><span class="ident" id="3149924">Get</span><span class="op" id="3149927">(</span><span class="op" id="3149928">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149934">if</span>&nbsp;<span class="ident" id="3149937">proxy</span>&nbsp;<span class="op" id="3149943">==</span>&nbsp;<span class="string" id="3149946">&#34;&#34;</span>&nbsp;<span class="op" id="3149949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149953">proxy</span>&nbsp;<span class="op" id="3149959">=</span>&nbsp;<span class="ident" id="3149961">httpProxyEnv</span><span class="op" id="3149973">.</span><span class="ident" id="3149974">Get</span><span class="op" id="3149977">(</span><span class="op" id="3149978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149984">if</span>&nbsp;<span class="ident" id="3149987">proxy</span>&nbsp;<span class="op" id="3149993">==</span>&nbsp;<span class="string" id="3149996">&#34;&#34;</span>&nbsp;<span class="op" id="3149999">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150003">return</span>&nbsp;<span class="ident" id="3150010">nil</span><span class="op" id="3150013">,</span>&nbsp;<span class="ident" id="3150015">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150023">if</span>&nbsp;<span class="op" id="3150026">!</span><span class="ident" id="3150027">useProxy</span><span class="op" id="3150035">(</span><span class="ident" id="3150036">canonicalAddr</span><span class="op" id="3150049">(</span><span class="ident" id="3150050">req</span><span class="op" id="3150053">.</span><span class="ident" id="3150054">URL</span><span class="op" id="3150057">)</span><span class="op" id="3150058">)</span>&nbsp;<span class="op" id="3150060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150064">return</span>&nbsp;<span class="ident" id="3150071">nil</span><span class="op" id="3150074">,</span>&nbsp;<span class="ident" id="3150076">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150081">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150084">proxyURL</span><span class="op" id="3150092">,</span>&nbsp;<span class="ident" id="3150094">err</span>&nbsp;<span class="op" id="3150098">:=</span>&nbsp;<span class="ident" id="3150101">url</span><span class="op" id="3150104">.</span><span class="ident" id="3150105">Parse</span><span class="op" id="3150110">(</span><span class="ident" id="3150111">proxy</span><span class="op" id="3150116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150119">if</span>&nbsp;<span class="ident" id="3150122">err</span>&nbsp;<span class="op" id="3150126">!=</span>&nbsp;<span class="ident" id="3150129">nil</span>&nbsp;<span class="op" id="3150133">||</span>&nbsp;<span class="op" id="3150136">!</span><span class="ident" id="3150137">strings</span><span class="op" id="3150144">.</span><span class="ident" id="3150145">HasPrefix</span><span class="op" id="3150154">(</span><span class="ident" id="3150155">proxyURL</span><span class="op" id="3150163">.</span><span class="ident" id="3150164">Scheme</span><span class="op" id="3150170">,</span>&nbsp;<span class="string" id="3150172">&#34;http&#34;</span><span class="op" id="3150178">)</span>&nbsp;<span class="op" id="3150180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150184">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150241">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150292">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150342">if</span>&nbsp;<span class="ident" id="3150345">proxyURL</span><span class="op" id="3150353">,</span>&nbsp;<span class="ident" id="3150355">err</span>&nbsp;<span class="op" id="3150359">:=</span>&nbsp;<span class="ident" id="3150362">url</span><span class="op" id="3150365">.</span><span class="ident" id="3150366">Parse</span><span class="op" id="3150371">(</span><span class="string" id="3150372">&#34;http://&#34;</span>&nbsp;<span class="op" id="3150382">+</span>&nbsp;<span class="ident" id="3150384">proxy</span><span class="op" id="3150389">)</span><span class="op" id="3150390">;</span>&nbsp;<span class="ident" id="3150392">err</span>&nbsp;<span class="op" id="3150396">==</span>&nbsp;<span class="ident" id="3150399">nil</span>&nbsp;<span class="op" id="3150403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150408">return</span>&nbsp;<span class="ident" id="3150415">proxyURL</span><span class="op" id="3150423">,</span>&nbsp;<span class="ident" id="3150425">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150437">if</span>&nbsp;<span class="ident" id="3150440">err</span>&nbsp;<span class="op" id="3150444">!=</span>&nbsp;<span class="ident" id="3150447">nil</span>&nbsp;<span class="op" id="3150451">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150455">return</span>&nbsp;<span class="ident" id="3150462">nil</span><span class="op" id="3150465">,</span>&nbsp;<span class="ident" id="3150467">fmt</span><span class="op" id="3150470">.</span><span class="ident" id="3150471">Errorf</span><span class="op" id="3150477">(</span><span class="string" id="3150478">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3150508">,</span>&nbsp;<span class="ident" id="3150510">proxy</span><span class="op" id="3150515">,</span>&nbsp;<span class="ident" id="3150517">err</span><span class="op" id="3150520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150526">return</span>&nbsp;<span class="ident" id="3150533">proxyURL</span><span class="op" id="3150541">,</span>&nbsp;<span class="ident" id="3150543">nil</span><br>
<span class="lineno"></span><span class="op" id="3150547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3150550">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3150612">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3150649">func</span>&nbsp;<span class="ident" id="3150654">ProxyURL</span><span class="op" id="3150662">(</span><span class="ident" id="3150663">fixedURL</span>&nbsp;<span class="op" id="3150672">*</span><span class="ident" id="3150673">url</span><span class="op" id="3150676">.</span><span class="ident" id="3150677">URL</span><span class="op" id="3150680">)</span>&nbsp;<span class="keyword" id="3150682">func</span><span class="op" id="3150686">(</span><span class="op" id="3150687">*</span><span class="ident" id="3150688">Request</span><span class="op" id="3150695">)</span>&nbsp;<span class="op" id="3150697">(</span><span class="op" id="3150698">*</span><span class="ident" id="3150699">url</span><span class="op" id="3150702">.</span><span class="ident" id="3150703">URL</span><span class="op" id="3150706">,</span>&nbsp;<span class="builtintype" id="3150708">error</span><span class="op" id="3150713">)</span>&nbsp;<span class="op" id="3150715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150718">return</span>&nbsp;<span class="keyword" id="3150725">func</span><span class="op" id="3150729">(</span><span class="op" id="3150730">*</span><span class="ident" id="3150731">Request</span><span class="op" id="3150738">)</span>&nbsp;<span class="op" id="3150740">(</span><span class="op" id="3150741">*</span><span class="ident" id="3150742">url</span><span class="op" id="3150745">.</span><span class="ident" id="3150746">URL</span><span class="op" id="3150749">,</span>&nbsp;<span class="builtintype" id="3150751">error</span><span class="op" id="3150756">)</span>&nbsp;<span class="op" id="3150758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150762">return</span>&nbsp;<span class="ident" id="3150769">fixedURL</span><span class="op" id="3150777">,</span>&nbsp;<span class="ident" id="3150779">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150784">}</span><br>
<span class="lineno"></span><span class="op" id="3150786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3150789">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3150850">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3150886">type</span>&nbsp;<span class="ident" id="3150891">transportRequest</span>&nbsp;<span class="keyword" id="3150908">struct</span>&nbsp;<span class="op" id="3150915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150918">*</span><span class="ident" id="3150919">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3150934">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150974">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3150983">Header</span>&nbsp;<span class="comment" id="3150990">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3151024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3151027">func</span>&nbsp;<span class="op" id="3151032">(</span><span class="ident" id="3151033">tr</span>&nbsp;<span class="op" id="3151036">*</span><span class="ident" id="3151037">transportRequest</span><span class="op" id="3151053">)</span>&nbsp;<span class="ident" id="3151055">extraHeaders</span><span class="op" id="3151067">(</span><span class="op" id="3151068">)</span>&nbsp;<span class="ident" id="3151070">Header</span>&nbsp;<span class="op" id="3151077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151080">if</span>&nbsp;<span class="ident" id="3151083">tr</span><span class="op" id="3151085">.</span><span class="ident" id="3151086">extra</span>&nbsp;<span class="op" id="3151092">==</span>&nbsp;<span class="ident" id="3151095">nil</span>&nbsp;<span class="op" id="3151099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151103">tr</span><span class="op" id="3151105">.</span><span class="ident" id="3151106">extra</span>&nbsp;<span class="op" id="3151112">=</span>&nbsp;<span class="builtinfunc" id="3151114">make</span><span class="op" id="3151118">(</span><span class="ident" id="3151119">Header</span><span class="op" id="3151125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151131">return</span>&nbsp;<span class="ident" id="3151138">tr</span><span class="op" id="3151140">.</span><span class="ident" id="3151141">extra</span><br>
<span class="lineno">185</span><span class="op" id="3151147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3151150">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3151202">//</span><br>
<span class="lineno"></span><span class="comment" id="3151205">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3151274">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3151329">func</span>&nbsp;<span class="op" id="3151334">(</span><span class="ident" id="3151335">t</span>&nbsp;<span class="op" id="3151337">*</span><span class="ident" id="3151338">Transport</span><span class="op" id="3151347">)</span>&nbsp;<span class="ident" id="3151349">RoundTrip</span><span class="op" id="3151358">(</span><span class="ident" id="3151359">req</span>&nbsp;<span class="op" id="3151363">*</span><span class="ident" id="3151364">Request</span><span class="op" id="3151371">)</span>&nbsp;<span class="op" id="3151373">(</span><span class="ident" id="3151374">resp</span>&nbsp;<span class="op" id="3151379">*</span><span class="ident" id="3151380">Response</span><span class="op" id="3151388">,</span>&nbsp;<span class="ident" id="3151390">err</span>&nbsp;<span class="builtintype" id="3151394">error</span><span class="op" id="3151399">)</span>&nbsp;<span class="op" id="3151401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151404">if</span>&nbsp;<span class="ident" id="3151407">req</span><span class="op" id="3151410">.</span><span class="ident" id="3151411">URL</span>&nbsp;<span class="op" id="3151415">==</span>&nbsp;<span class="ident" id="3151418">nil</span>&nbsp;<span class="op" id="3151422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151426">req</span><span class="op" id="3151429">.</span><span class="ident" id="3151430">closeBody</span><span class="op" id="3151439">(</span><span class="op" id="3151440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151444">return</span>&nbsp;<span class="ident" id="3151451">nil</span><span class="op" id="3151454">,</span>&nbsp;<span class="ident" id="3151456">errors</span><span class="op" id="3151462">.</span><span class="ident" id="3151463">New</span><span class="op" id="3151466">(</span><span class="string" id="3151467">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3151490">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151496">if</span>&nbsp;<span class="ident" id="3151499">req</span><span class="op" id="3151502">.</span><span class="ident" id="3151503">Header</span>&nbsp;<span class="op" id="3151510">==</span>&nbsp;<span class="ident" id="3151513">nil</span>&nbsp;<span class="op" id="3151517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151521">req</span><span class="op" id="3151524">.</span><span class="ident" id="3151525">closeBody</span><span class="op" id="3151534">(</span><span class="op" id="3151535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151539">return</span>&nbsp;<span class="ident" id="3151546">nil</span><span class="op" id="3151549">,</span>&nbsp;<span class="ident" id="3151551">errors</span><span class="op" id="3151557">.</span><span class="ident" id="3151558">New</span><span class="op" id="3151561">(</span><span class="string" id="3151562">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3151588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151591">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151594">if</span>&nbsp;<span class="ident" id="3151597">req</span><span class="op" id="3151600">.</span><span class="ident" id="3151601">URL</span><span class="op" id="3151604">.</span><span class="ident" id="3151605">Scheme</span>&nbsp;<span class="op" id="3151612">!=</span>&nbsp;<span class="string" id="3151615">&#34;http&#34;</span>&nbsp;<span class="op" id="3151622">&amp;&amp;</span>&nbsp;<span class="ident" id="3151625">req</span><span class="op" id="3151628">.</span><span class="ident" id="3151629">URL</span><span class="op" id="3151632">.</span><span class="ident" id="3151633">Scheme</span>&nbsp;<span class="op" id="3151640">!=</span>&nbsp;<span class="string" id="3151643">&#34;https&#34;</span>&nbsp;<span class="op" id="3151651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151655">t</span><span class="op" id="3151656">.</span><span class="ident" id="3151657">altMu</span><span class="op" id="3151662">.</span><span class="ident" id="3151663">RLock</span><span class="op" id="3151668">(</span><span class="op" id="3151669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151673">var</span>&nbsp;<span class="ident" id="3151677">rt</span>&nbsp;<span class="ident" id="3151680">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151695">if</span>&nbsp;<span class="ident" id="3151698">t</span><span class="op" id="3151699">.</span><span class="ident" id="3151700">altProto</span>&nbsp;<span class="op" id="3151709">!=</span>&nbsp;<span class="ident" id="3151712">nil</span>&nbsp;<span class="op" id="3151716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151721">rt</span>&nbsp;<span class="op" id="3151724">=</span>&nbsp;<span class="ident" id="3151726">t</span><span class="op" id="3151727">.</span><span class="ident" id="3151728">altProto</span><span class="op" id="3151736">[</span><span class="ident" id="3151737">req</span><span class="op" id="3151740">.</span><span class="ident" id="3151741">URL</span><span class="op" id="3151744">.</span><span class="ident" id="3151745">Scheme</span><span class="op" id="3151751">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151759">t</span><span class="op" id="3151760">.</span><span class="ident" id="3151761">altMu</span><span class="op" id="3151766">.</span><span class="ident" id="3151767">RUnlock</span><span class="op" id="3151774">(</span><span class="op" id="3151775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151779">if</span>&nbsp;<span class="ident" id="3151782">rt</span>&nbsp;<span class="op" id="3151785">==</span>&nbsp;<span class="ident" id="3151788">nil</span>&nbsp;<span class="op" id="3151792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151797">req</span><span class="op" id="3151800">.</span><span class="ident" id="3151801">closeBody</span><span class="op" id="3151810">(</span><span class="op" id="3151811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151816">return</span>&nbsp;<span class="ident" id="3151823">nil</span><span class="op" id="3151826">,</span>&nbsp;<span class="op" id="3151828">&amp;</span><span class="ident" id="3151829">badStringError</span><span class="op" id="3151843">{</span><span class="string" id="3151844">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3151873">,</span>&nbsp;<span class="ident" id="3151875">req</span><span class="op" id="3151878">.</span><span class="ident" id="3151879">URL</span><span class="op" id="3151882">.</span><span class="ident" id="3151883">Scheme</span><span class="op" id="3151889">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151897">return</span>&nbsp;<span class="ident" id="3151904">rt</span><span class="op" id="3151906">.</span><span class="ident" id="3151907">RoundTrip</span><span class="op" id="3151916">(</span><span class="ident" id="3151917">req</span><span class="op" id="3151920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151926">if</span>&nbsp;<span class="ident" id="3151929">req</span><span class="op" id="3151932">.</span><span class="ident" id="3151933">URL</span><span class="op" id="3151936">.</span><span class="ident" id="3151937">Host</span>&nbsp;<span class="op" id="3151942">==</span>&nbsp;<span class="string" id="3151945">&#34;&#34;</span>&nbsp;<span class="op" id="3151948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151952">req</span><span class="op" id="3151955">.</span><span class="ident" id="3151956">closeBody</span><span class="op" id="3151965">(</span><span class="op" id="3151966">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151970">return</span>&nbsp;<span class="ident" id="3151977">nil</span><span class="op" id="3151980">,</span>&nbsp;<span class="ident" id="3151982">errors</span><span class="op" id="3151988">.</span><span class="ident" id="3151989">New</span><span class="op" id="3151992">(</span><span class="string" id="3151993">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3152023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152029">treq</span>&nbsp;<span class="op" id="3152034">:=</span>&nbsp;<span class="op" id="3152037">&amp;</span><span class="ident" id="3152038">transportRequest</span><span class="op" id="3152054">{</span><span class="ident" id="3152055">Request</span><span class="op" id="3152062">:</span>&nbsp;<span class="ident" id="3152064">req</span><span class="op" id="3152067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152070">cm</span><span class="op" id="3152072">,</span>&nbsp;<span class="ident" id="3152074">err</span>&nbsp;<span class="op" id="3152078">:=</span>&nbsp;<span class="ident" id="3152081">t</span><span class="op" id="3152082">.</span><span class="ident" id="3152083">connectMethodForRequest</span><span class="op" id="3152106">(</span><span class="ident" id="3152107">treq</span><span class="op" id="3152111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152114">if</span>&nbsp;<span class="ident" id="3152117">err</span>&nbsp;<span class="op" id="3152121">!=</span>&nbsp;<span class="ident" id="3152124">nil</span>&nbsp;<span class="op" id="3152128">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152132">req</span><span class="op" id="3152135">.</span><span class="ident" id="3152136">closeBody</span><span class="op" id="3152145">(</span><span class="op" id="3152146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152150">return</span>&nbsp;<span class="ident" id="3152157">nil</span><span class="op" id="3152160">,</span>&nbsp;<span class="ident" id="3152162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152171">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152232">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152296">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152360">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152385">pconn</span><span class="op" id="3152390">,</span>&nbsp;<span class="ident" id="3152392">err</span>&nbsp;<span class="op" id="3152396">:=</span>&nbsp;<span class="ident" id="3152399">t</span><span class="op" id="3152400">.</span><span class="ident" id="3152401">getConn</span><span class="op" id="3152408">(</span><span class="ident" id="3152409">req</span><span class="op" id="3152412">,</span>&nbsp;<span class="ident" id="3152414">cm</span><span class="op" id="3152416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152419">if</span>&nbsp;<span class="ident" id="3152422">err</span>&nbsp;<span class="op" id="3152426">!=</span>&nbsp;<span class="ident" id="3152429">nil</span>&nbsp;<span class="op" id="3152433">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152437">t</span><span class="op" id="3152438">.</span><span class="ident" id="3152439">setReqCanceler</span><span class="op" id="3152453">(</span><span class="ident" id="3152454">req</span><span class="op" id="3152457">,</span>&nbsp;<span class="ident" id="3152459">nil</span><span class="op" id="3152462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152466">req</span><span class="op" id="3152469">.</span><span class="ident" id="3152470">closeBody</span><span class="op" id="3152479">(</span><span class="op" id="3152480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152484">return</span>&nbsp;<span class="ident" id="3152491">nil</span><span class="op" id="3152494">,</span>&nbsp;<span class="ident" id="3152496">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152505">return</span>&nbsp;<span class="ident" id="3152512">pconn</span><span class="op" id="3152517">.</span><span class="ident" id="3152518">roundTrip</span><span class="op" id="3152527">(</span><span class="ident" id="3152528">treq</span><span class="op" id="3152532">)</span><br>
<span class="lineno"></span><span class="op" id="3152534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3152537">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3152595">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3152661">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3152726">//</span><br>
<span class="lineno"></span><span class="comment" id="3152729">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3152790">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3152851">func</span>&nbsp;<span class="op" id="3152856">(</span><span class="ident" id="3152857">t</span>&nbsp;<span class="op" id="3152859">*</span><span class="ident" id="3152860">Transport</span><span class="op" id="3152869">)</span>&nbsp;<span class="ident" id="3152871">RegisterProtocol</span><span class="op" id="3152887">(</span><span class="ident" id="3152888">scheme</span>&nbsp;<span class="builtintype" id="3152895">string</span><span class="op" id="3152901">,</span>&nbsp;<span class="ident" id="3152903">rt</span>&nbsp;<span class="ident" id="3152906">RoundTripper</span><span class="op" id="3152918">)</span>&nbsp;<span class="op" id="3152920">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152923">if</span>&nbsp;<span class="ident" id="3152926">scheme</span>&nbsp;<span class="op" id="3152933">==</span>&nbsp;<span class="string" id="3152936">&#34;http&#34;</span>&nbsp;<span class="op" id="3152943">||</span>&nbsp;<span class="ident" id="3152946">scheme</span>&nbsp;<span class="op" id="3152953">==</span>&nbsp;<span class="string" id="3152956">&#34;https&#34;</span>&nbsp;<span class="op" id="3152964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3152968">panic</span><span class="op" id="3152973">(</span><span class="string" id="3152974">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3152986">+</span>&nbsp;<span class="ident" id="3152988">scheme</span>&nbsp;<span class="op" id="3152995">+</span>&nbsp;<span class="string" id="3152997">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3153018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3153021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153024">t</span><span class="op" id="3153025">.</span><span class="ident" id="3153026">altMu</span><span class="op" id="3153031">.</span><span class="ident" id="3153032">Lock</span><span class="op" id="3153036">(</span><span class="op" id="3153037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3153040">defer</span>&nbsp;<span class="ident" id="3153046">t</span><span class="op" id="3153047">.</span><span class="ident" id="3153048">altMu</span><span class="op" id="3153053">.</span><span class="ident" id="3153054">Unlock</span><span class="op" id="3153060">(</span><span class="op" id="3153061">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3153064">if</span>&nbsp;<span class="ident" id="3153067">t</span><span class="op" id="3153068">.</span><span class="ident" id="3153069">altProto</span>&nbsp;<span class="op" id="3153078">==</span>&nbsp;<span class="ident" id="3153081">nil</span>&nbsp;<span class="op" id="3153085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153089">t</span><span class="op" id="3153090">.</span><span class="ident" id="3153091">altProto</span>&nbsp;<span class="op" id="3153100">=</span>&nbsp;<span class="builtinfunc" id="3153102">make</span><span class="op" id="3153106">(</span><span class="keyword" id="3153107">map</span><span class="op" id="3153110">[</span><span class="builtintype" id="3153111">string</span><span class="op" id="3153117">]</span><span class="ident" id="3153118">RoundTripper</span><span class="op" id="3153130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3153133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3153136">if</span>&nbsp;<span class="ident" id="3153139">_</span><span class="op" id="3153140">,</span>&nbsp;<span class="ident" id="3153142">exists</span>&nbsp;<span class="op" id="3153149">:=</span>&nbsp;<span class="ident" id="3153152">t</span><span class="op" id="3153153">.</span><span class="ident" id="3153154">altProto</span><span class="op" id="3153162">[</span><span class="ident" id="3153163">scheme</span><span class="op" id="3153169">]</span><span class="op" id="3153170">;</span>&nbsp;<span class="ident" id="3153172">exists</span>&nbsp;<span class="op" id="3153179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3153183">panic</span><span class="op" id="3153188">(</span><span class="string" id="3153189">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3153201">+</span>&nbsp;<span class="ident" id="3153203">scheme</span>&nbsp;<span class="op" id="3153210">+</span>&nbsp;<span class="string" id="3153212">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3153233">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3153236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153239">t</span><span class="op" id="3153240">.</span><span class="ident" id="3153241">altProto</span><span class="op" id="3153249">[</span><span class="ident" id="3153250">scheme</span><span class="op" id="3153256">]</span>&nbsp;<span class="op" id="3153258">=</span>&nbsp;<span class="ident" id="3153260">rt</span><br>
<span class="lineno"></span><span class="op" id="3153263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3153266">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3153335">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3153399">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3153472">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3153483">func</span>&nbsp;<span class="op" id="3153488">(</span><span class="ident" id="3153489">t</span>&nbsp;<span class="op" id="3153491">*</span><span class="ident" id="3153492">Transport</span><span class="op" id="3153501">)</span>&nbsp;<span class="ident" id="3153503">CloseIdleConnections</span><span class="op" id="3153523">(</span><span class="op" id="3153524">)</span>&nbsp;<span class="op" id="3153526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153529">t</span><span class="op" id="3153530">.</span><span class="ident" id="3153531">idleMu</span><span class="op" id="3153537">.</span><span class="ident" id="3153538">Lock</span><span class="op" id="3153542">(</span><span class="op" id="3153543">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153546">m</span>&nbsp;<span class="op" id="3153548">:=</span>&nbsp;<span class="ident" id="3153551">t</span><span class="op" id="3153552">.</span><span class="ident" id="3153553">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153563">t</span><span class="op" id="3153564">.</span><span class="ident" id="3153565">idleConn</span>&nbsp;<span class="op" id="3153574">=</span>&nbsp;<span class="ident" id="3153576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153581">t</span><span class="op" id="3153582">.</span><span class="ident" id="3153583">idleConnCh</span>&nbsp;<span class="op" id="3153594">=</span>&nbsp;<span class="ident" id="3153596">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153601">t</span><span class="op" id="3153602">.</span><span class="ident" id="3153603">wantIdle</span>&nbsp;<span class="op" id="3153612">=</span>&nbsp;<span class="builtintype" id="3153614">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153620">t</span><span class="op" id="3153621">.</span><span class="ident" id="3153622">idleMu</span><span class="op" id="3153628">.</span><span class="ident" id="3153629">Unlock</span><span class="op" id="3153635">(</span><span class="op" id="3153636">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3153639">for</span>&nbsp;<span class="ident" id="3153643">_</span><span class="op" id="3153644">,</span>&nbsp;<span class="ident" id="3153646">conns</span>&nbsp;<span class="op" id="3153652">:=</span>&nbsp;<span class="keyword" id="3153655">range</span>&nbsp;<span class="ident" id="3153661">m</span>&nbsp;<span class="op" id="3153663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3153667">for</span>&nbsp;<span class="ident" id="3153671">_</span><span class="op" id="3153672">,</span>&nbsp;<span class="ident" id="3153674">pconn</span>&nbsp;<span class="op" id="3153680">:=</span>&nbsp;<span class="keyword" id="3153683">range</span>&nbsp;<span class="ident" id="3153689">conns</span>&nbsp;<span class="op" id="3153695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153700">pconn</span><span class="op" id="3153705">.</span><span class="builtinfunc" id="3153706">close</span><span class="op" id="3153711">(</span><span class="op" id="3153712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3153716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3153719">}</span><br>
<span class="lineno">275</span><span class="op" id="3153721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3153724">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3153785">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3153800">func</span>&nbsp;<span class="op" id="3153805">(</span><span class="ident" id="3153806">t</span>&nbsp;<span class="op" id="3153808">*</span><span class="ident" id="3153809">Transport</span><span class="op" id="3153818">)</span>&nbsp;<span class="ident" id="3153820">CancelRequest</span><span class="op" id="3153833">(</span><span class="ident" id="3153834">req</span>&nbsp;<span class="op" id="3153838">*</span><span class="ident" id="3153839">Request</span><span class="op" id="3153846">)</span>&nbsp;<span class="op" id="3153848">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153851">t</span><span class="op" id="3153852">.</span><span class="ident" id="3153853">reqMu</span><span class="op" id="3153858">.</span><span class="ident" id="3153859">Lock</span><span class="op" id="3153863">(</span><span class="op" id="3153864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153867">cancel</span>&nbsp;<span class="op" id="3153874">:=</span>&nbsp;<span class="ident" id="3153877">t</span><span class="op" id="3153878">.</span><span class="ident" id="3153879">reqCanceler</span><span class="op" id="3153890">[</span><span class="ident" id="3153891">req</span><span class="op" id="3153894">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153897">t</span><span class="op" id="3153898">.</span><span class="ident" id="3153899">reqMu</span><span class="op" id="3153904">.</span><span class="ident" id="3153905">Unlock</span><span class="op" id="3153911">(</span><span class="op" id="3153912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3153915">if</span>&nbsp;<span class="ident" id="3153918">cancel</span>&nbsp;<span class="op" id="3153925">!=</span>&nbsp;<span class="ident" id="3153928">nil</span>&nbsp;<span class="op" id="3153932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3153936">cancel</span><span class="op" id="3153942">(</span><span class="op" id="3153943">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3153946">}</span><br>
<span class="lineno"></span><span class="op" id="3153948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3153951">//</span><br>
<span class="lineno"></span><span class="comment" id="3153954">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3153997">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3154001">var</span>&nbsp;<span class="op" id="3154005">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154008">httpProxyEnv</span>&nbsp;<span class="op" id="3154021">=</span>&nbsp;<span class="op" id="3154023">&amp;</span><span class="ident" id="3154024">envOnce</span><span class="op" id="3154031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154035">names</span><span class="op" id="3154040">:</span>&nbsp;<span class="op" id="3154042">[</span><span class="op" id="3154043">]</span><span class="builtintype" id="3154044">string</span><span class="op" id="3154050">{</span><span class="string" id="3154051">&#34;HTTP_PROXY&#34;</span><span class="op" id="3154063">,</span>&nbsp;<span class="string" id="3154065">&#34;http_proxy&#34;</span><span class="op" id="3154077">}</span><span class="op" id="3154078">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3154081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154084">httpsProxyEnv</span>&nbsp;<span class="op" id="3154098">=</span>&nbsp;<span class="op" id="3154100">&amp;</span><span class="ident" id="3154101">envOnce</span><span class="op" id="3154108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154112">names</span><span class="op" id="3154117">:</span>&nbsp;<span class="op" id="3154119">[</span><span class="op" id="3154120">]</span><span class="builtintype" id="3154121">string</span><span class="op" id="3154127">{</span><span class="string" id="3154128">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3154141">,</span>&nbsp;<span class="string" id="3154143">&#34;https_proxy&#34;</span><span class="op" id="3154156">}</span><span class="op" id="3154157">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3154160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154163">noProxyEnv</span>&nbsp;<span class="op" id="3154174">=</span>&nbsp;<span class="op" id="3154176">&amp;</span><span class="ident" id="3154177">envOnce</span><span class="op" id="3154184">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154188">names</span><span class="op" id="3154193">:</span>&nbsp;<span class="op" id="3154195">[</span><span class="op" id="3154196">]</span><span class="builtintype" id="3154197">string</span><span class="op" id="3154203">{</span><span class="string" id="3154204">&#34;NO_PROXY&#34;</span><span class="op" id="3154214">,</span>&nbsp;<span class="string" id="3154216">&#34;no_proxy&#34;</span><span class="op" id="3154226">}</span><span class="op" id="3154227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3154230">}</span><br>
<span class="lineno"></span><span class="op" id="3154232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3154235">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3154303">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3154368">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3154387">type</span>&nbsp;<span class="ident" id="3154392">envOnce</span>&nbsp;<span class="keyword" id="3154400">struct</span>&nbsp;<span class="op" id="3154407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154410">names</span>&nbsp;<span class="op" id="3154416">[</span><span class="op" id="3154417">]</span><span class="builtintype" id="3154418">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154426">once</span>&nbsp;&nbsp;<span class="ident" id="3154432">sync</span><span class="op" id="3154436">.</span><span class="ident" id="3154437">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154443">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3154449">string</span><br>
<span class="lineno"></span><span class="op" id="3154456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3154459">func</span>&nbsp;<span class="op" id="3154464">(</span><span class="ident" id="3154465">e</span>&nbsp;<span class="op" id="3154467">*</span><span class="ident" id="3154468">envOnce</span><span class="op" id="3154475">)</span>&nbsp;<span class="ident" id="3154477">Get</span><span class="op" id="3154480">(</span><span class="op" id="3154481">)</span>&nbsp;<span class="builtintype" id="3154483">string</span>&nbsp;<span class="op" id="3154490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154493">e</span><span class="op" id="3154494">.</span><span class="ident" id="3154495">once</span><span class="op" id="3154499">.</span><span class="ident" id="3154500">Do</span><span class="op" id="3154502">(</span><span class="ident" id="3154503">e</span><span class="op" id="3154504">.</span><span class="ident" id="3154505">init</span><span class="op" id="3154509">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3154512">return</span>&nbsp;<span class="ident" id="3154519">e</span><span class="op" id="3154520">.</span><span class="ident" id="3154521">val</span><br>
<span class="lineno"></span><span class="op" id="3154525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3154528">func</span>&nbsp;<span class="op" id="3154533">(</span><span class="ident" id="3154534">e</span>&nbsp;<span class="op" id="3154536">*</span><span class="ident" id="3154537">envOnce</span><span class="op" id="3154544">)</span>&nbsp;<span class="ident" id="3154546">init</span><span class="op" id="3154550">(</span><span class="op" id="3154551">)</span>&nbsp;<span class="op" id="3154553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3154556">for</span>&nbsp;<span class="ident" id="3154560">_</span><span class="op" id="3154561">,</span>&nbsp;<span class="ident" id="3154563">n</span>&nbsp;<span class="op" id="3154565">:=</span>&nbsp;<span class="keyword" id="3154568">range</span>&nbsp;<span class="ident" id="3154574">e</span><span class="op" id="3154575">.</span><span class="ident" id="3154576">names</span>&nbsp;<span class="op" id="3154582">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154586">e</span><span class="op" id="3154587">.</span><span class="ident" id="3154588">val</span>&nbsp;<span class="op" id="3154592">=</span>&nbsp;<span class="ident" id="3154594">os</span><span class="op" id="3154596">.</span><span class="ident" id="3154597">Getenv</span><span class="op" id="3154603">(</span><span class="ident" id="3154604">n</span><span class="op" id="3154605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3154609">if</span>&nbsp;<span class="ident" id="3154612">e</span><span class="op" id="3154613">.</span><span class="ident" id="3154614">val</span>&nbsp;<span class="op" id="3154618">!=</span>&nbsp;<span class="string" id="3154621">&#34;&#34;</span>&nbsp;<span class="op" id="3154624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3154629">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3154638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3154641">}</span><br>
<span class="lineno">325</span><span class="op" id="3154643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3154646">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3154672">func</span>&nbsp;<span class="op" id="3154677">(</span><span class="ident" id="3154678">e</span>&nbsp;<span class="op" id="3154680">*</span><span class="ident" id="3154681">envOnce</span><span class="op" id="3154688">)</span>&nbsp;<span class="ident" id="3154690">reset</span><span class="op" id="3154695">(</span><span class="op" id="3154696">)</span>&nbsp;<span class="op" id="3154698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154701">e</span><span class="op" id="3154702">.</span><span class="ident" id="3154703">once</span>&nbsp;<span class="op" id="3154708">=</span>&nbsp;<span class="ident" id="3154710">sync</span><span class="op" id="3154714">.</span><span class="ident" id="3154715">Once</span><span class="op" id="3154719">{</span><span class="op" id="3154720">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154723">e</span><span class="op" id="3154724">.</span><span class="ident" id="3154725">val</span>&nbsp;<span class="op" id="3154729">=</span>&nbsp;<span class="string" id="3154731">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3154734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3154737">func</span>&nbsp;<span class="op" id="3154742">(</span><span class="ident" id="3154743">t</span>&nbsp;<span class="op" id="3154745">*</span><span class="ident" id="3154746">Transport</span><span class="op" id="3154755">)</span>&nbsp;<span class="ident" id="3154757">connectMethodForRequest</span><span class="op" id="3154780">(</span><span class="ident" id="3154781">treq</span>&nbsp;<span class="op" id="3154786">*</span><span class="ident" id="3154787">transportRequest</span><span class="op" id="3154803">)</span>&nbsp;<span class="op" id="3154805">(</span><span class="ident" id="3154806">cm</span>&nbsp;<span class="ident" id="3154809">connectMethod</span><span class="op" id="3154822">,</span>&nbsp;<span class="ident" id="3154824">err</span>&nbsp;<span class="builtintype" id="3154828">error</span><span class="op" id="3154833">)</span>&nbsp;<span class="op" id="3154835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154838">cm</span><span class="op" id="3154840">.</span><span class="ident" id="3154841">targetScheme</span>&nbsp;<span class="op" id="3154854">=</span>&nbsp;<span class="ident" id="3154856">treq</span><span class="op" id="3154860">.</span><span class="ident" id="3154861">URL</span><span class="op" id="3154864">.</span><span class="ident" id="3154865">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154873">cm</span><span class="op" id="3154875">.</span><span class="ident" id="3154876">targetAddr</span>&nbsp;<span class="op" id="3154887">=</span>&nbsp;<span class="ident" id="3154889">canonicalAddr</span><span class="op" id="3154902">(</span><span class="ident" id="3154903">treq</span><span class="op" id="3154907">.</span><span class="ident" id="3154908">URL</span><span class="op" id="3154911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3154914">if</span>&nbsp;<span class="ident" id="3154917">t</span><span class="op" id="3154918">.</span><span class="ident" id="3154919">Proxy</span>&nbsp;<span class="op" id="3154925">!=</span>&nbsp;<span class="ident" id="3154928">nil</span>&nbsp;<span class="op" id="3154932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3154936">cm</span><span class="op" id="3154938">.</span><span class="ident" id="3154939">proxyURL</span><span class="op" id="3154947">,</span>&nbsp;<span class="ident" id="3154949">err</span>&nbsp;<span class="op" id="3154953">=</span>&nbsp;<span class="ident" id="3154955">t</span><span class="op" id="3154956">.</span><span class="ident" id="3154957">Proxy</span><span class="op" id="3154962">(</span><span class="ident" id="3154963">treq</span><span class="op" id="3154967">.</span><span class="ident" id="3154968">Request</span><span class="op" id="3154975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3154978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3154981">return</span>&nbsp;<span class="ident" id="3154988">cm</span><span class="op" id="3154990">,</span>&nbsp;<span class="ident" id="3154992">err</span><br>
<span class="lineno">340</span><span class="op" id="3154996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3154999">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3155058">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3155089">func</span>&nbsp;<span class="op" id="3155094">(</span><span class="ident" id="3155095">cm</span>&nbsp;<span class="op" id="3155098">*</span><span class="ident" id="3155099">connectMethod</span><span class="op" id="3155112">)</span>&nbsp;<span class="ident" id="3155114">proxyAuth</span><span class="op" id="3155123">(</span><span class="op" id="3155124">)</span>&nbsp;<span class="builtintype" id="3155126">string</span>&nbsp;<span class="op" id="3155133">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155136">if</span>&nbsp;<span class="ident" id="3155139">cm</span><span class="op" id="3155141">.</span><span class="ident" id="3155142">proxyURL</span>&nbsp;<span class="op" id="3155151">==</span>&nbsp;<span class="ident" id="3155154">nil</span>&nbsp;<span class="op" id="3155158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155162">return</span>&nbsp;<span class="string" id="3155169">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3155173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155176">if</span>&nbsp;<span class="ident" id="3155179">u</span>&nbsp;<span class="op" id="3155181">:=</span>&nbsp;<span class="ident" id="3155184">cm</span><span class="op" id="3155186">.</span><span class="ident" id="3155187">proxyURL</span><span class="op" id="3155195">.</span><span class="ident" id="3155196">User</span><span class="op" id="3155200">;</span>&nbsp;<span class="ident" id="3155202">u</span>&nbsp;<span class="op" id="3155204">!=</span>&nbsp;<span class="ident" id="3155207">nil</span>&nbsp;<span class="op" id="3155211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155215">username</span>&nbsp;<span class="op" id="3155224">:=</span>&nbsp;<span class="ident" id="3155227">u</span><span class="op" id="3155228">.</span><span class="ident" id="3155229">Username</span><span class="op" id="3155237">(</span><span class="op" id="3155238">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155242">password</span><span class="op" id="3155250">,</span>&nbsp;<span class="ident" id="3155252">_</span>&nbsp;<span class="op" id="3155254">:=</span>&nbsp;<span class="ident" id="3155257">u</span><span class="op" id="3155258">.</span><span class="ident" id="3155259">Password</span><span class="op" id="3155267">(</span><span class="op" id="3155268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155272">return</span>&nbsp;<span class="string" id="3155279">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3155288">+</span>&nbsp;<span class="ident" id="3155290">basicAuth</span><span class="op" id="3155299">(</span><span class="ident" id="3155300">username</span><span class="op" id="3155308">,</span>&nbsp;<span class="ident" id="3155310">password</span><span class="op" id="3155318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3155321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155324">return</span>&nbsp;<span class="string" id="3155331">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3155334">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3155337">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3155415">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3155433">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3155501">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3155519">func</span>&nbsp;<span class="op" id="3155524">(</span><span class="ident" id="3155525">t</span>&nbsp;<span class="op" id="3155527">*</span><span class="ident" id="3155528">Transport</span><span class="op" id="3155537">)</span>&nbsp;<span class="ident" id="3155539">putIdleConn</span><span class="op" id="3155550">(</span><span class="ident" id="3155551">pconn</span>&nbsp;<span class="op" id="3155557">*</span><span class="ident" id="3155558">persistConn</span><span class="op" id="3155569">)</span>&nbsp;<span class="builtintype" id="3155571">bool</span>&nbsp;<span class="op" id="3155576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155579">if</span>&nbsp;<span class="ident" id="3155582">t</span><span class="op" id="3155583">.</span><span class="ident" id="3155584">DisableKeepAlives</span>&nbsp;<span class="op" id="3155602">||</span>&nbsp;<span class="ident" id="3155605">t</span><span class="op" id="3155606">.</span><span class="ident" id="3155607">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3155627">&lt;</span>&nbsp;<span class="num" id="3155629">0</span>&nbsp;<span class="op" id="3155631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155635">pconn</span><span class="op" id="3155640">.</span><span class="builtinfunc" id="3155641">close</span><span class="op" id="3155646">(</span><span class="op" id="3155647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155651">return</span>&nbsp;<span class="builtintype" id="3155658">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3155665">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155668">if</span>&nbsp;<span class="ident" id="3155671">pconn</span><span class="op" id="3155676">.</span><span class="ident" id="3155677">isBroken</span><span class="op" id="3155685">(</span><span class="op" id="3155686">)</span>&nbsp;<span class="op" id="3155688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155692">return</span>&nbsp;<span class="builtintype" id="3155699">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3155706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155709">key</span>&nbsp;<span class="op" id="3155713">:=</span>&nbsp;<span class="ident" id="3155716">pconn</span><span class="op" id="3155721">.</span><span class="ident" id="3155722">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155732">max</span>&nbsp;<span class="op" id="3155736">:=</span>&nbsp;<span class="ident" id="3155739">t</span><span class="op" id="3155740">.</span><span class="ident" id="3155741">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155762">if</span>&nbsp;<span class="ident" id="3155765">max</span>&nbsp;<span class="op" id="3155769">==</span>&nbsp;<span class="num" id="3155772">0</span>&nbsp;<span class="op" id="3155774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155778">max</span>&nbsp;<span class="op" id="3155782">=</span>&nbsp;<span class="ident" id="3155784">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3155812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155815">t</span><span class="op" id="3155816">.</span><span class="ident" id="3155817">idleMu</span><span class="op" id="3155823">.</span><span class="ident" id="3155824">Lock</span><span class="op" id="3155828">(</span><span class="op" id="3155829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3155833">waitingDialer</span>&nbsp;<span class="op" id="3155847">:=</span>&nbsp;<span class="ident" id="3155850">t</span><span class="op" id="3155851">.</span><span class="ident" id="3155852">idleConnCh</span><span class="op" id="3155862">[</span><span class="ident" id="3155863">key</span><span class="op" id="3155866">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155869">select</span>&nbsp;<span class="op" id="3155876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3155879">case</span>&nbsp;<span class="ident" id="3155884">waitingDialer</span>&nbsp;<span class="op" id="3155898">&lt;-</span>&nbsp;<span class="ident" id="3155901">pconn</span><span class="op" id="3155906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3155910">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3155963">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3156019">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3156065">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3156122">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156190">t</span><span class="op" id="3156191">.</span><span class="ident" id="3156192">idleMu</span><span class="op" id="3156198">.</span><span class="ident" id="3156199">Unlock</span><span class="op" id="3156205">(</span><span class="op" id="3156206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156210">return</span>&nbsp;<span class="builtintype" id="3156217">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156223">default</span><span class="op" id="3156230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156234">if</span>&nbsp;<span class="ident" id="3156237">waitingDialer</span>&nbsp;<span class="op" id="3156251">!=</span>&nbsp;<span class="ident" id="3156254">nil</span>&nbsp;<span class="op" id="3156258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3156263">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3156313">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3156361">delete</span><span class="op" id="3156367">(</span><span class="ident" id="3156368">t</span><span class="op" id="3156369">.</span><span class="ident" id="3156370">idleConnCh</span><span class="op" id="3156380">,</span>&nbsp;<span class="ident" id="3156382">key</span><span class="op" id="3156385">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156395">if</span>&nbsp;<span class="ident" id="3156398">t</span><span class="op" id="3156399">.</span><span class="ident" id="3156400">wantIdle</span>&nbsp;<span class="op" id="3156409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156413">t</span><span class="op" id="3156414">.</span><span class="ident" id="3156415">idleMu</span><span class="op" id="3156421">.</span><span class="ident" id="3156422">Unlock</span><span class="op" id="3156428">(</span><span class="op" id="3156429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156433">pconn</span><span class="op" id="3156438">.</span><span class="builtinfunc" id="3156439">close</span><span class="op" id="3156444">(</span><span class="op" id="3156445">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156449">return</span>&nbsp;<span class="builtintype" id="3156456">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156466">if</span>&nbsp;<span class="ident" id="3156469">t</span><span class="op" id="3156470">.</span><span class="ident" id="3156471">idleConn</span>&nbsp;<span class="op" id="3156480">==</span>&nbsp;<span class="ident" id="3156483">nil</span>&nbsp;<span class="op" id="3156487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156491">t</span><span class="op" id="3156492">.</span><span class="ident" id="3156493">idleConn</span>&nbsp;<span class="op" id="3156502">=</span>&nbsp;<span class="builtinfunc" id="3156504">make</span><span class="op" id="3156508">(</span><span class="keyword" id="3156509">map</span><span class="op" id="3156512">[</span><span class="ident" id="3156513">connectMethodKey</span><span class="op" id="3156529">]</span><span class="op" id="3156530">[</span><span class="op" id="3156531">]</span><span class="op" id="3156532">*</span><span class="ident" id="3156533">persistConn</span><span class="op" id="3156544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156547">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156550">if</span>&nbsp;<span class="builtinfunc" id="3156553">len</span><span class="op" id="3156556">(</span><span class="ident" id="3156557">t</span><span class="op" id="3156558">.</span><span class="ident" id="3156559">idleConn</span><span class="op" id="3156567">[</span><span class="ident" id="3156568">key</span><span class="op" id="3156571">]</span><span class="op" id="3156572">)</span>&nbsp;<span class="op" id="3156574">&gt;=</span>&nbsp;<span class="ident" id="3156577">max</span>&nbsp;<span class="op" id="3156581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156585">t</span><span class="op" id="3156586">.</span><span class="ident" id="3156587">idleMu</span><span class="op" id="3156593">.</span><span class="ident" id="3156594">Unlock</span><span class="op" id="3156600">(</span><span class="op" id="3156601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156605">pconn</span><span class="op" id="3156610">.</span><span class="builtinfunc" id="3156611">close</span><span class="op" id="3156616">(</span><span class="op" id="3156617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156621">return</span>&nbsp;<span class="builtintype" id="3156628">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156635">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156638">for</span>&nbsp;<span class="ident" id="3156642">_</span><span class="op" id="3156643">,</span>&nbsp;<span class="ident" id="3156645">exist</span>&nbsp;<span class="op" id="3156651">:=</span>&nbsp;<span class="keyword" id="3156654">range</span>&nbsp;<span class="ident" id="3156660">t</span><span class="op" id="3156661">.</span><span class="ident" id="3156662">idleConn</span><span class="op" id="3156670">[</span><span class="ident" id="3156671">key</span><span class="op" id="3156674">]</span>&nbsp;<span class="op" id="3156676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156680">if</span>&nbsp;<span class="ident" id="3156683">exist</span>&nbsp;<span class="op" id="3156689">==</span>&nbsp;<span class="ident" id="3156692">pconn</span>&nbsp;<span class="op" id="3156698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156703">log</span><span class="op" id="3156706">.</span><span class="ident" id="3156707">Fatalf</span><span class="op" id="3156713">(</span><span class="string" id="3156714">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3156745">,</span>&nbsp;<span class="ident" id="3156747">pconn</span><span class="op" id="3156752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3156759">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156762">t</span><span class="op" id="3156763">.</span><span class="ident" id="3156764">idleConn</span><span class="op" id="3156772">[</span><span class="ident" id="3156773">key</span><span class="op" id="3156776">]</span>&nbsp;<span class="op" id="3156778">=</span>&nbsp;<span class="builtinfunc" id="3156780">append</span><span class="op" id="3156786">(</span><span class="ident" id="3156787">t</span><span class="op" id="3156788">.</span><span class="ident" id="3156789">idleConn</span><span class="op" id="3156797">[</span><span class="ident" id="3156798">key</span><span class="op" id="3156801">]</span><span class="op" id="3156802">,</span>&nbsp;<span class="ident" id="3156804">pconn</span><span class="op" id="3156809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3156812">t</span><span class="op" id="3156813">.</span><span class="ident" id="3156814">idleMu</span><span class="op" id="3156820">.</span><span class="ident" id="3156821">Unlock</span><span class="op" id="3156827">(</span><span class="op" id="3156828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3156831">return</span>&nbsp;<span class="builtintype" id="3156838">true</span><br>
<span class="lineno"></span><span class="op" id="3156843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3156846">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3156908">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3156962">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3157030">func</span>&nbsp;<span class="op" id="3157035">(</span><span class="ident" id="3157036">t</span>&nbsp;<span class="op" id="3157038">*</span><span class="ident" id="3157039">Transport</span><span class="op" id="3157048">)</span>&nbsp;<span class="ident" id="3157050">getIdleConnCh</span><span class="op" id="3157063">(</span><span class="ident" id="3157064">cm</span>&nbsp;<span class="ident" id="3157067">connectMethod</span><span class="op" id="3157080">)</span>&nbsp;<span class="keyword" id="3157082">chan</span>&nbsp;<span class="op" id="3157087">*</span><span class="ident" id="3157088">persistConn</span>&nbsp;<span class="op" id="3157100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157103">if</span>&nbsp;<span class="ident" id="3157106">t</span><span class="op" id="3157107">.</span><span class="ident" id="3157108">DisableKeepAlives</span>&nbsp;<span class="op" id="3157126">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157130">return</span>&nbsp;<span class="ident" id="3157137">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157145">key</span>&nbsp;<span class="op" id="3157149">:=</span>&nbsp;<span class="ident" id="3157152">cm</span><span class="op" id="3157154">.</span><span class="ident" id="3157155">key</span><span class="op" id="3157158">(</span><span class="op" id="3157159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157162">t</span><span class="op" id="3157163">.</span><span class="ident" id="3157164">idleMu</span><span class="op" id="3157170">.</span><span class="ident" id="3157171">Lock</span><span class="op" id="3157175">(</span><span class="op" id="3157176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157179">defer</span>&nbsp;<span class="ident" id="3157185">t</span><span class="op" id="3157186">.</span><span class="ident" id="3157187">idleMu</span><span class="op" id="3157193">.</span><span class="ident" id="3157194">Unlock</span><span class="op" id="3157200">(</span><span class="op" id="3157201">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157204">t</span><span class="op" id="3157205">.</span><span class="ident" id="3157206">wantIdle</span>&nbsp;<span class="op" id="3157215">=</span>&nbsp;<span class="builtintype" id="3157217">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157224">if</span>&nbsp;<span class="ident" id="3157227">t</span><span class="op" id="3157228">.</span><span class="ident" id="3157229">idleConnCh</span>&nbsp;<span class="op" id="3157240">==</span>&nbsp;<span class="ident" id="3157243">nil</span>&nbsp;<span class="op" id="3157247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157251">t</span><span class="op" id="3157252">.</span><span class="ident" id="3157253">idleConnCh</span>&nbsp;<span class="op" id="3157264">=</span>&nbsp;<span class="builtinfunc" id="3157266">make</span><span class="op" id="3157270">(</span><span class="keyword" id="3157271">map</span><span class="op" id="3157274">[</span><span class="ident" id="3157275">connectMethodKey</span><span class="op" id="3157291">]</span><span class="keyword" id="3157292">chan</span>&nbsp;<span class="op" id="3157297">*</span><span class="ident" id="3157298">persistConn</span><span class="op" id="3157309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157315">ch</span><span class="op" id="3157317">,</span>&nbsp;<span class="ident" id="3157319">ok</span>&nbsp;<span class="op" id="3157322">:=</span>&nbsp;<span class="ident" id="3157325">t</span><span class="op" id="3157326">.</span><span class="ident" id="3157327">idleConnCh</span><span class="op" id="3157337">[</span><span class="ident" id="3157338">key</span><span class="op" id="3157341">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157344">if</span>&nbsp;<span class="op" id="3157347">!</span><span class="ident" id="3157348">ok</span>&nbsp;<span class="op" id="3157351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157355">ch</span>&nbsp;<span class="op" id="3157358">=</span>&nbsp;<span class="builtinfunc" id="3157360">make</span><span class="op" id="3157364">(</span><span class="keyword" id="3157365">chan</span>&nbsp;<span class="op" id="3157370">*</span><span class="ident" id="3157371">persistConn</span><span class="op" id="3157382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157386">t</span><span class="op" id="3157387">.</span><span class="ident" id="3157388">idleConnCh</span><span class="op" id="3157398">[</span><span class="ident" id="3157399">key</span><span class="op" id="3157402">]</span>&nbsp;<span class="op" id="3157404">=</span>&nbsp;<span class="ident" id="3157406">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157413">return</span>&nbsp;<span class="ident" id="3157420">ch</span><br>
<span class="lineno">435</span><span class="op" id="3157423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3157426">func</span>&nbsp;<span class="op" id="3157431">(</span><span class="ident" id="3157432">t</span>&nbsp;<span class="op" id="3157434">*</span><span class="ident" id="3157435">Transport</span><span class="op" id="3157444">)</span>&nbsp;<span class="ident" id="3157446">getIdleConn</span><span class="op" id="3157457">(</span><span class="ident" id="3157458">cm</span>&nbsp;<span class="ident" id="3157461">connectMethod</span><span class="op" id="3157474">)</span>&nbsp;<span class="op" id="3157476">(</span><span class="ident" id="3157477">pconn</span>&nbsp;<span class="op" id="3157483">*</span><span class="ident" id="3157484">persistConn</span><span class="op" id="3157495">)</span>&nbsp;<span class="op" id="3157497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157500">key</span>&nbsp;<span class="op" id="3157504">:=</span>&nbsp;<span class="ident" id="3157507">cm</span><span class="op" id="3157509">.</span><span class="ident" id="3157510">key</span><span class="op" id="3157513">(</span><span class="op" id="3157514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157517">t</span><span class="op" id="3157518">.</span><span class="ident" id="3157519">idleMu</span><span class="op" id="3157525">.</span><span class="ident" id="3157526">Lock</span><span class="op" id="3157530">(</span><span class="op" id="3157531">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157534">defer</span>&nbsp;<span class="ident" id="3157540">t</span><span class="op" id="3157541">.</span><span class="ident" id="3157542">idleMu</span><span class="op" id="3157548">.</span><span class="ident" id="3157549">Unlock</span><span class="op" id="3157555">(</span><span class="op" id="3157556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157559">if</span>&nbsp;<span class="ident" id="3157562">t</span><span class="op" id="3157563">.</span><span class="ident" id="3157564">idleConn</span>&nbsp;<span class="op" id="3157573">==</span>&nbsp;<span class="ident" id="3157576">nil</span>&nbsp;<span class="op" id="3157580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157584">return</span>&nbsp;<span class="ident" id="3157591">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157599">for</span>&nbsp;<span class="op" id="3157603">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157607">pconns</span><span class="op" id="3157613">,</span>&nbsp;<span class="ident" id="3157615">ok</span>&nbsp;<span class="op" id="3157618">:=</span>&nbsp;<span class="ident" id="3157621">t</span><span class="op" id="3157622">.</span><span class="ident" id="3157623">idleConn</span><span class="op" id="3157631">[</span><span class="ident" id="3157632">key</span><span class="op" id="3157635">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157639">if</span>&nbsp;<span class="op" id="3157642">!</span><span class="ident" id="3157643">ok</span>&nbsp;<span class="op" id="3157646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157651">return</span>&nbsp;<span class="ident" id="3157658">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157668">if</span>&nbsp;<span class="builtinfunc" id="3157671">len</span><span class="op" id="3157674">(</span><span class="ident" id="3157675">pconns</span><span class="op" id="3157681">)</span>&nbsp;<span class="op" id="3157683">==</span>&nbsp;<span class="num" id="3157686">1</span>&nbsp;<span class="op" id="3157688">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157693">pconn</span>&nbsp;<span class="op" id="3157699">=</span>&nbsp;<span class="ident" id="3157701">pconns</span><span class="op" id="3157707">[</span><span class="num" id="3157708">0</span><span class="op" id="3157709">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3157714">delete</span><span class="op" id="3157720">(</span><span class="ident" id="3157721">t</span><span class="op" id="3157722">.</span><span class="ident" id="3157723">idleConn</span><span class="op" id="3157731">,</span>&nbsp;<span class="ident" id="3157733">key</span><span class="op" id="3157736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157740">}</span>&nbsp;<span class="keyword" id="3157742">else</span>&nbsp;<span class="op" id="3157747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3157752">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3157797">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157816">pconn</span>&nbsp;<span class="op" id="3157822">=</span>&nbsp;<span class="ident" id="3157824">pconns</span><span class="op" id="3157830">[</span><span class="builtinfunc" id="3157831">len</span><span class="op" id="3157834">(</span><span class="ident" id="3157835">pconns</span><span class="op" id="3157841">)</span><span class="op" id="3157842">-</span><span class="num" id="3157843">1</span><span class="op" id="3157844">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3157849">t</span><span class="op" id="3157850">.</span><span class="ident" id="3157851">idleConn</span><span class="op" id="3157859">[</span><span class="ident" id="3157860">key</span><span class="op" id="3157863">]</span>&nbsp;<span class="op" id="3157865">=</span>&nbsp;<span class="ident" id="3157867">pconns</span><span class="op" id="3157873">[</span><span class="op" id="3157874">:</span><span class="builtinfunc" id="3157875">len</span><span class="op" id="3157878">(</span><span class="ident" id="3157879">pconns</span><span class="op" id="3157885">)</span><span class="op" id="3157886">-</span><span class="num" id="3157887">1</span><span class="op" id="3157888">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157896">if</span>&nbsp;<span class="op" id="3157899">!</span><span class="ident" id="3157900">pconn</span><span class="op" id="3157905">.</span><span class="ident" id="3157906">isBroken</span><span class="op" id="3157914">(</span><span class="op" id="3157915">)</span>&nbsp;<span class="op" id="3157917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3157922">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3157934">}</span><br>
<span class="lineno"></span><span class="op" id="3157936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3157939">func</span>&nbsp;<span class="op" id="3157944">(</span><span class="ident" id="3157945">t</span>&nbsp;<span class="op" id="3157947">*</span><span class="ident" id="3157948">Transport</span><span class="op" id="3157957">)</span>&nbsp;<span class="ident" id="3157959">setReqCanceler</span><span class="op" id="3157973">(</span><span class="ident" id="3157974">r</span>&nbsp;<span class="op" id="3157976">*</span><span class="ident" id="3157977">Request</span><span class="op" id="3157984">,</span>&nbsp;<span class="ident" id="3157986">fn</span>&nbsp;<span class="keyword" id="3157989">func</span><span class="op" id="3157993">(</span><span class="op" id="3157994">)</span><span class="op" id="3157995">)</span>&nbsp;<span class="op" id="3157997">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158000">t</span><span class="op" id="3158001">.</span><span class="ident" id="3158002">reqMu</span><span class="op" id="3158007">.</span><span class="ident" id="3158008">Lock</span><span class="op" id="3158012">(</span><span class="op" id="3158013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158016">defer</span>&nbsp;<span class="ident" id="3158022">t</span><span class="op" id="3158023">.</span><span class="ident" id="3158024">reqMu</span><span class="op" id="3158029">.</span><span class="ident" id="3158030">Unlock</span><span class="op" id="3158036">(</span><span class="op" id="3158037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158040">if</span>&nbsp;<span class="ident" id="3158043">t</span><span class="op" id="3158044">.</span><span class="ident" id="3158045">reqCanceler</span>&nbsp;<span class="op" id="3158057">==</span>&nbsp;<span class="ident" id="3158060">nil</span>&nbsp;<span class="op" id="3158064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158068">t</span><span class="op" id="3158069">.</span><span class="ident" id="3158070">reqCanceler</span>&nbsp;<span class="op" id="3158082">=</span>&nbsp;<span class="builtinfunc" id="3158084">make</span><span class="op" id="3158088">(</span><span class="keyword" id="3158089">map</span><span class="op" id="3158092">[</span><span class="op" id="3158093">*</span><span class="ident" id="3158094">Request</span><span class="op" id="3158101">]</span><span class="keyword" id="3158102">func</span><span class="op" id="3158106">(</span><span class="op" id="3158107">)</span><span class="op" id="3158108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158111">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158114">if</span>&nbsp;<span class="ident" id="3158117">fn</span>&nbsp;<span class="op" id="3158120">!=</span>&nbsp;<span class="ident" id="3158123">nil</span>&nbsp;<span class="op" id="3158127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158131">t</span><span class="op" id="3158132">.</span><span class="ident" id="3158133">reqCanceler</span><span class="op" id="3158144">[</span><span class="ident" id="3158145">r</span><span class="op" id="3158146">]</span>&nbsp;<span class="op" id="3158148">=</span>&nbsp;<span class="ident" id="3158150">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158154">}</span>&nbsp;<span class="keyword" id="3158156">else</span>&nbsp;<span class="op" id="3158161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3158165">delete</span><span class="op" id="3158171">(</span><span class="ident" id="3158172">t</span><span class="op" id="3158173">.</span><span class="ident" id="3158174">reqCanceler</span><span class="op" id="3158185">,</span>&nbsp;<span class="ident" id="3158187">r</span><span class="op" id="3158188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158191">}</span><br>
<span class="lineno">475</span><span class="op" id="3158193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3158196">func</span>&nbsp;<span class="op" id="3158201">(</span><span class="ident" id="3158202">t</span>&nbsp;<span class="op" id="3158204">*</span><span class="ident" id="3158205">Transport</span><span class="op" id="3158214">)</span>&nbsp;<span class="ident" id="3158216">dial</span><span class="op" id="3158220">(</span><span class="ident" id="3158221">network</span><span class="op" id="3158228">,</span>&nbsp;<span class="ident" id="3158230">addr</span>&nbsp;<span class="builtintype" id="3158235">string</span><span class="op" id="3158241">)</span>&nbsp;<span class="op" id="3158243">(</span><span class="ident" id="3158244">c</span>&nbsp;<span class="ident" id="3158246">net</span><span class="op" id="3158249">.</span><span class="ident" id="3158250">Conn</span><span class="op" id="3158254">,</span>&nbsp;<span class="ident" id="3158256">err</span>&nbsp;<span class="builtintype" id="3158260">error</span><span class="op" id="3158265">)</span>&nbsp;<span class="op" id="3158267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158270">if</span>&nbsp;<span class="ident" id="3158273">t</span><span class="op" id="3158274">.</span><span class="ident" id="3158275">Dial</span>&nbsp;<span class="op" id="3158280">!=</span>&nbsp;<span class="ident" id="3158283">nil</span>&nbsp;<span class="op" id="3158287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158291">return</span>&nbsp;<span class="ident" id="3158298">t</span><span class="op" id="3158299">.</span><span class="ident" id="3158300">Dial</span><span class="op" id="3158304">(</span><span class="ident" id="3158305">network</span><span class="op" id="3158312">,</span>&nbsp;<span class="ident" id="3158314">addr</span><span class="op" id="3158318">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158324">return</span>&nbsp;<span class="ident" id="3158331">net</span><span class="op" id="3158334">.</span><span class="ident" id="3158335">Dial</span><span class="op" id="3158339">(</span><span class="ident" id="3158340">network</span><span class="op" id="3158347">,</span>&nbsp;<span class="ident" id="3158349">addr</span><span class="op" id="3158353">)</span><br>
<span class="lineno"></span><span class="op" id="3158355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3158358">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3158376">var</span>&nbsp;<span class="ident" id="3158380">prePendingDial</span><span class="op" id="3158394">,</span>&nbsp;<span class="ident" id="3158396">postPendingDial</span>&nbsp;<span class="keyword" id="3158412">func</span><span class="op" id="3158416">(</span><span class="op" id="3158417">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3158420">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3158484">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3158556">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3158632">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3158666">func</span>&nbsp;<span class="op" id="3158671">(</span><span class="ident" id="3158672">t</span>&nbsp;<span class="op" id="3158674">*</span><span class="ident" id="3158675">Transport</span><span class="op" id="3158684">)</span>&nbsp;<span class="ident" id="3158686">getConn</span><span class="op" id="3158693">(</span><span class="ident" id="3158694">req</span>&nbsp;<span class="op" id="3158698">*</span><span class="ident" id="3158699">Request</span><span class="op" id="3158706">,</span>&nbsp;<span class="ident" id="3158708">cm</span>&nbsp;<span class="ident" id="3158711">connectMethod</span><span class="op" id="3158724">)</span>&nbsp;<span class="op" id="3158726">(</span><span class="op" id="3158727">*</span><span class="ident" id="3158728">persistConn</span><span class="op" id="3158739">,</span>&nbsp;<span class="builtintype" id="3158741">error</span><span class="op" id="3158746">)</span>&nbsp;<span class="op" id="3158748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158751">if</span>&nbsp;<span class="ident" id="3158754">pc</span>&nbsp;<span class="op" id="3158757">:=</span>&nbsp;<span class="ident" id="3158760">t</span><span class="op" id="3158761">.</span><span class="ident" id="3158762">getIdleConn</span><span class="op" id="3158773">(</span><span class="ident" id="3158774">cm</span><span class="op" id="3158776">)</span><span class="op" id="3158777">;</span>&nbsp;<span class="ident" id="3158779">pc</span>&nbsp;<span class="op" id="3158782">!=</span>&nbsp;<span class="ident" id="3158785">nil</span>&nbsp;<span class="op" id="3158789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158793">return</span>&nbsp;<span class="ident" id="3158800">pc</span><span class="op" id="3158802">,</span>&nbsp;<span class="ident" id="3158804">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158809">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158813">type</span>&nbsp;<span class="ident" id="3158818">dialRes</span>&nbsp;<span class="keyword" id="3158826">struct</span>&nbsp;<span class="op" id="3158833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158837">pc</span>&nbsp;&nbsp;<span class="op" id="3158841">*</span><span class="ident" id="3158842">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158856">err</span>&nbsp;<span class="builtintype" id="3158860">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158867">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158870">dialc</span>&nbsp;<span class="op" id="3158876">:=</span>&nbsp;<span class="builtinfunc" id="3158879">make</span><span class="op" id="3158883">(</span><span class="keyword" id="3158884">chan</span>&nbsp;<span class="ident" id="3158889">dialRes</span><span class="op" id="3158896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158900">handlePendingDial</span>&nbsp;<span class="op" id="3158918">:=</span>&nbsp;<span class="keyword" id="3158921">func</span><span class="op" id="3158925">(</span><span class="op" id="3158926">)</span>&nbsp;<span class="op" id="3158928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158932">if</span>&nbsp;<span class="ident" id="3158935">prePendingDial</span>&nbsp;<span class="op" id="3158950">!=</span>&nbsp;<span class="ident" id="3158953">nil</span>&nbsp;<span class="op" id="3158957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3158962">prePendingDial</span><span class="op" id="3158976">(</span><span class="op" id="3158977">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3158981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3158985">go</span>&nbsp;<span class="keyword" id="3158988">func</span><span class="op" id="3158992">(</span><span class="op" id="3158993">)</span>&nbsp;<span class="op" id="3158995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159000">if</span>&nbsp;<span class="ident" id="3159003">v</span>&nbsp;<span class="op" id="3159005">:=</span>&nbsp;<span class="op" id="3159008">&lt;-</span><span class="ident" id="3159010">dialc</span><span class="op" id="3159015">;</span>&nbsp;<span class="ident" id="3159017">v</span><span class="op" id="3159018">.</span><span class="ident" id="3159019">err</span>&nbsp;<span class="op" id="3159023">==</span>&nbsp;<span class="ident" id="3159026">nil</span>&nbsp;<span class="op" id="3159030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159036">t</span><span class="op" id="3159037">.</span><span class="ident" id="3159038">putIdleConn</span><span class="op" id="3159049">(</span><span class="ident" id="3159050">v</span><span class="op" id="3159051">.</span><span class="ident" id="3159052">pc</span><span class="op" id="3159054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3159059">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159064">if</span>&nbsp;<span class="ident" id="3159067">postPendingDial</span>&nbsp;<span class="op" id="3159083">!=</span>&nbsp;<span class="ident" id="3159086">nil</span>&nbsp;<span class="op" id="3159090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159096">postPendingDial</span><span class="op" id="3159111">(</span><span class="op" id="3159112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3159117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3159121">}</span><span class="op" id="3159122">(</span><span class="op" id="3159123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3159126">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159130">cancelc</span>&nbsp;<span class="op" id="3159138">:=</span>&nbsp;<span class="builtinfunc" id="3159141">make</span><span class="op" id="3159145">(</span><span class="keyword" id="3159146">chan</span>&nbsp;<span class="keyword" id="3159151">struct</span><span class="op" id="3159157">{</span><span class="op" id="3159158">}</span><span class="op" id="3159159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159162">t</span><span class="op" id="3159163">.</span><span class="ident" id="3159164">setReqCanceler</span><span class="op" id="3159178">(</span><span class="ident" id="3159179">req</span><span class="op" id="3159182">,</span>&nbsp;<span class="keyword" id="3159184">func</span><span class="op" id="3159188">(</span><span class="op" id="3159189">)</span>&nbsp;<span class="op" id="3159191">{</span>&nbsp;<span class="builtinfunc" id="3159193">close</span><span class="op" id="3159198">(</span><span class="ident" id="3159199">cancelc</span><span class="op" id="3159206">)</span>&nbsp;<span class="op" id="3159208">}</span><span class="op" id="3159209">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159213">go</span>&nbsp;<span class="keyword" id="3159216">func</span><span class="op" id="3159220">(</span><span class="op" id="3159221">)</span>&nbsp;<span class="op" id="3159223">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159227">pc</span><span class="op" id="3159229">,</span>&nbsp;<span class="ident" id="3159231">err</span>&nbsp;<span class="op" id="3159235">:=</span>&nbsp;<span class="ident" id="3159238">t</span><span class="op" id="3159239">.</span><span class="ident" id="3159240">dialConn</span><span class="op" id="3159248">(</span><span class="ident" id="3159249">cm</span><span class="op" id="3159251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159255">dialc</span>&nbsp;<span class="op" id="3159261">&lt;-</span>&nbsp;<span class="ident" id="3159264">dialRes</span><span class="op" id="3159271">{</span><span class="ident" id="3159272">pc</span><span class="op" id="3159274">,</span>&nbsp;<span class="ident" id="3159276">err</span><span class="op" id="3159279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3159282">}</span><span class="op" id="3159283">(</span><span class="op" id="3159284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159288">idleConnCh</span>&nbsp;<span class="op" id="3159299">:=</span>&nbsp;<span class="ident" id="3159302">t</span><span class="op" id="3159303">.</span><span class="ident" id="3159304">getIdleConnCh</span><span class="op" id="3159317">(</span><span class="ident" id="3159318">cm</span><span class="op" id="3159320">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159323">select</span>&nbsp;<span class="op" id="3159330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159333">case</span>&nbsp;<span class="ident" id="3159338">v</span>&nbsp;<span class="op" id="3159340">:=</span>&nbsp;<span class="op" id="3159343">&lt;-</span><span class="ident" id="3159345">dialc</span><span class="op" id="3159350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3159354">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159378">return</span>&nbsp;<span class="ident" id="3159385">v</span><span class="op" id="3159386">.</span><span class="ident" id="3159387">pc</span><span class="op" id="3159389">,</span>&nbsp;<span class="ident" id="3159391">v</span><span class="op" id="3159392">.</span><span class="ident" id="3159393">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159398">case</span>&nbsp;<span class="ident" id="3159403">pc</span>&nbsp;<span class="op" id="3159406">:=</span>&nbsp;<span class="op" id="3159409">&lt;-</span><span class="ident" id="3159411">idleConnCh</span><span class="op" id="3159421">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3159425">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3159478">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3159529">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3159568">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3159618">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159641">handlePendingDial</span><span class="op" id="3159658">(</span><span class="op" id="3159659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159663">return</span>&nbsp;<span class="ident" id="3159670">pc</span><span class="op" id="3159672">,</span>&nbsp;<span class="ident" id="3159674">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159679">case</span>&nbsp;<span class="op" id="3159684">&lt;-</span><span class="ident" id="3159686">cancelc</span><span class="op" id="3159693">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159697">handlePendingDial</span><span class="op" id="3159714">(</span><span class="op" id="3159715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3159719">return</span>&nbsp;<span class="ident" id="3159726">nil</span><span class="op" id="3159729">,</span>&nbsp;<span class="ident" id="3159731">errors</span><span class="op" id="3159737">.</span><span class="ident" id="3159738">New</span><span class="op" id="3159741">(</span><span class="string" id="3159742">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3159799">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3159802">}</span><br>
<span class="lineno"></span><span class="op" id="3159804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3159807">func</span>&nbsp;<span class="op" id="3159812">(</span><span class="ident" id="3159813">t</span>&nbsp;<span class="op" id="3159815">*</span><span class="ident" id="3159816">Transport</span><span class="op" id="3159825">)</span>&nbsp;<span class="ident" id="3159827">dialConn</span><span class="op" id="3159835">(</span><span class="ident" id="3159836">cm</span>&nbsp;<span class="ident" id="3159839">connectMethod</span><span class="op" id="3159852">)</span>&nbsp;<span class="op" id="3159854">(</span><span class="op" id="3159855">*</span><span class="ident" id="3159856">persistConn</span><span class="op" id="3159867">,</span>&nbsp;<span class="builtintype" id="3159869">error</span><span class="op" id="3159874">)</span>&nbsp;<span class="op" id="3159876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159879">pconn</span>&nbsp;<span class="op" id="3159885">:=</span>&nbsp;<span class="op" id="3159888">&amp;</span><span class="ident" id="3159889">persistConn</span><span class="op" id="3159900">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159904">t</span><span class="op" id="3159905">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3159916">t</span><span class="op" id="3159917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159921">cacheKey</span><span class="op" id="3159929">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3159933">cm</span><span class="op" id="3159935">.</span><span class="ident" id="3159936">key</span><span class="op" id="3159939">(</span><span class="op" id="3159940">)</span><span class="op" id="3159941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159945">reqch</span><span class="op" id="3159950">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3159957">make</span><span class="op" id="3159961">(</span><span class="keyword" id="3159962">chan</span>&nbsp;<span class="ident" id="3159967">requestAndChan</span><span class="op" id="3159981">,</span>&nbsp;<span class="num" id="3159983">1</span><span class="op" id="3159984">)</span><span class="op" id="3159985">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3159989">writech</span><span class="op" id="3159996">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3160001">make</span><span class="op" id="3160005">(</span><span class="keyword" id="3160006">chan</span>&nbsp;<span class="ident" id="3160011">writeRequest</span><span class="op" id="3160023">,</span>&nbsp;<span class="num" id="3160025">1</span><span class="op" id="3160026">)</span><span class="op" id="3160027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160031">closech</span><span class="op" id="3160038">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3160043">make</span><span class="op" id="3160047">(</span><span class="keyword" id="3160048">chan</span>&nbsp;<span class="keyword" id="3160053">struct</span><span class="op" id="3160059">{</span><span class="op" id="3160060">}</span><span class="op" id="3160061">)</span><span class="op" id="3160062">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160066">writeErrCh</span><span class="op" id="3160076">:</span>&nbsp;<span class="builtinfunc" id="3160078">make</span><span class="op" id="3160082">(</span><span class="keyword" id="3160083">chan</span>&nbsp;<span class="builtintype" id="3160088">error</span><span class="op" id="3160093">,</span>&nbsp;<span class="num" id="3160095">1</span><span class="op" id="3160096">)</span><span class="op" id="3160097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160103">tlsDial</span>&nbsp;<span class="op" id="3160111">:=</span>&nbsp;<span class="ident" id="3160114">t</span><span class="op" id="3160115">.</span><span class="ident" id="3160116">DialTLS</span>&nbsp;<span class="op" id="3160124">!=</span>&nbsp;<span class="ident" id="3160127">nil</span>&nbsp;<span class="op" id="3160131">&amp;&amp;</span>&nbsp;<span class="ident" id="3160134">cm</span><span class="op" id="3160136">.</span><span class="ident" id="3160137">targetScheme</span>&nbsp;<span class="op" id="3160150">==</span>&nbsp;<span class="string" id="3160153">&#34;https&#34;</span>&nbsp;<span class="op" id="3160161">&amp;&amp;</span>&nbsp;<span class="ident" id="3160164">cm</span><span class="op" id="3160166">.</span><span class="ident" id="3160167">proxyURL</span>&nbsp;<span class="op" id="3160176">==</span>&nbsp;<span class="ident" id="3160179">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160184">if</span>&nbsp;<span class="ident" id="3160187">tlsDial</span>&nbsp;<span class="op" id="3160195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160199">var</span>&nbsp;<span class="ident" id="3160203">err</span>&nbsp;<span class="builtintype" id="3160207">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160215">pconn</span><span class="op" id="3160220">.</span><span class="ident" id="3160221">conn</span><span class="op" id="3160225">,</span>&nbsp;<span class="ident" id="3160227">err</span>&nbsp;<span class="op" id="3160231">=</span>&nbsp;<span class="ident" id="3160233">t</span><span class="op" id="3160234">.</span><span class="ident" id="3160235">DialTLS</span><span class="op" id="3160242">(</span><span class="string" id="3160243">&#34;tcp&#34;</span><span class="op" id="3160248">,</span>&nbsp;<span class="ident" id="3160250">cm</span><span class="op" id="3160252">.</span><span class="ident" id="3160253">addr</span><span class="op" id="3160257">(</span><span class="op" id="3160258">)</span><span class="op" id="3160259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160263">if</span>&nbsp;<span class="ident" id="3160266">err</span>&nbsp;<span class="op" id="3160270">!=</span>&nbsp;<span class="ident" id="3160273">nil</span>&nbsp;<span class="op" id="3160277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160282">return</span>&nbsp;<span class="ident" id="3160289">nil</span><span class="op" id="3160292">,</span>&nbsp;<span class="ident" id="3160294">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160304">if</span>&nbsp;<span class="ident" id="3160307">tc</span><span class="op" id="3160309">,</span>&nbsp;<span class="ident" id="3160311">ok</span>&nbsp;<span class="op" id="3160314">:=</span>&nbsp;<span class="ident" id="3160317">pconn</span><span class="op" id="3160322">.</span><span class="ident" id="3160323">conn</span><span class="op" id="3160327">.</span><span class="op" id="3160328">(</span><span class="op" id="3160329">*</span><span class="ident" id="3160330">tls</span><span class="op" id="3160333">.</span><span class="ident" id="3160334">Conn</span><span class="op" id="3160338">)</span><span class="op" id="3160339">;</span>&nbsp;<span class="ident" id="3160341">ok</span>&nbsp;<span class="op" id="3160344">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160349">cs</span>&nbsp;<span class="op" id="3160352">:=</span>&nbsp;<span class="ident" id="3160355">tc</span><span class="op" id="3160357">.</span><span class="ident" id="3160358">ConnectionState</span><span class="op" id="3160373">(</span><span class="op" id="3160374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160379">pconn</span><span class="op" id="3160384">.</span><span class="ident" id="3160385">tlsState</span>&nbsp;<span class="op" id="3160394">=</span>&nbsp;<span class="op" id="3160396">&amp;</span><span class="ident" id="3160397">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160405">}</span>&nbsp;<span class="keyword" id="3160407">else</span>&nbsp;<span class="op" id="3160412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160416">conn</span><span class="op" id="3160420">,</span>&nbsp;<span class="ident" id="3160422">err</span>&nbsp;<span class="op" id="3160426">:=</span>&nbsp;<span class="ident" id="3160429">t</span><span class="op" id="3160430">.</span><span class="ident" id="3160431">dial</span><span class="op" id="3160435">(</span><span class="string" id="3160436">&#34;tcp&#34;</span><span class="op" id="3160441">,</span>&nbsp;<span class="ident" id="3160443">cm</span><span class="op" id="3160445">.</span><span class="ident" id="3160446">addr</span><span class="op" id="3160450">(</span><span class="op" id="3160451">)</span><span class="op" id="3160452">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160456">if</span>&nbsp;<span class="ident" id="3160459">err</span>&nbsp;<span class="op" id="3160463">!=</span>&nbsp;<span class="ident" id="3160466">nil</span>&nbsp;<span class="op" id="3160470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160475">if</span>&nbsp;<span class="ident" id="3160478">cm</span><span class="op" id="3160480">.</span><span class="ident" id="3160481">proxyURL</span>&nbsp;<span class="op" id="3160490">!=</span>&nbsp;<span class="ident" id="3160493">nil</span>&nbsp;<span class="op" id="3160497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160503">err</span>&nbsp;<span class="op" id="3160507">=</span>&nbsp;<span class="ident" id="3160509">fmt</span><span class="op" id="3160512">.</span><span class="ident" id="3160513">Errorf</span><span class="op" id="3160519">(</span><span class="string" id="3160520">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3160560">,</span>&nbsp;<span class="ident" id="3160562">cm</span><span class="op" id="3160564">.</span><span class="ident" id="3160565">proxyURL</span><span class="op" id="3160573">,</span>&nbsp;<span class="ident" id="3160575">err</span><span class="op" id="3160578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160588">return</span>&nbsp;<span class="ident" id="3160595">nil</span><span class="op" id="3160598">,</span>&nbsp;<span class="ident" id="3160600">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160610">pconn</span><span class="op" id="3160615">.</span><span class="ident" id="3160616">conn</span>&nbsp;<span class="op" id="3160621">=</span>&nbsp;<span class="ident" id="3160623">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3160633">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160650">switch</span>&nbsp;<span class="op" id="3160657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160660">case</span>&nbsp;<span class="ident" id="3160665">cm</span><span class="op" id="3160667">.</span><span class="ident" id="3160668">proxyURL</span>&nbsp;<span class="op" id="3160677">==</span>&nbsp;<span class="ident" id="3160680">nil</span><span class="op" id="3160683">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3160687">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160722">case</span>&nbsp;<span class="ident" id="3160727">cm</span><span class="op" id="3160729">.</span><span class="ident" id="3160730">targetScheme</span>&nbsp;<span class="op" id="3160743">==</span>&nbsp;<span class="string" id="3160746">&#34;http&#34;</span><span class="op" id="3160752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160756">pconn</span><span class="op" id="3160761">.</span><span class="ident" id="3160762">isProxy</span>&nbsp;<span class="op" id="3160770">=</span>&nbsp;<span class="builtintype" id="3160772">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160779">if</span>&nbsp;<span class="ident" id="3160782">pa</span>&nbsp;<span class="op" id="3160785">:=</span>&nbsp;<span class="ident" id="3160788">cm</span><span class="op" id="3160790">.</span><span class="ident" id="3160791">proxyAuth</span><span class="op" id="3160800">(</span><span class="op" id="3160801">)</span><span class="op" id="3160802">;</span>&nbsp;<span class="ident" id="3160804">pa</span>&nbsp;<span class="op" id="3160807">!=</span>&nbsp;<span class="string" id="3160810">&#34;&#34;</span>&nbsp;<span class="op" id="3160813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160818">pconn</span><span class="op" id="3160823">.</span><span class="ident" id="3160824">mutateHeaderFunc</span>&nbsp;<span class="op" id="3160841">=</span>&nbsp;<span class="keyword" id="3160843">func</span><span class="op" id="3160847">(</span><span class="ident" id="3160848">h</span>&nbsp;<span class="ident" id="3160850">Header</span><span class="op" id="3160856">)</span>&nbsp;<span class="op" id="3160858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160864">h</span><span class="op" id="3160865">.</span><span class="ident" id="3160866">Set</span><span class="op" id="3160869">(</span><span class="string" id="3160870">&#34;Proxy-Authorization&#34;</span><span class="op" id="3160891">,</span>&nbsp;<span class="ident" id="3160893">pa</span><span class="op" id="3160895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3160904">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3160907">case</span>&nbsp;<span class="ident" id="3160912">cm</span><span class="op" id="3160914">.</span><span class="ident" id="3160915">targetScheme</span>&nbsp;<span class="op" id="3160928">==</span>&nbsp;<span class="string" id="3160931">&#34;https&#34;</span><span class="op" id="3160938">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160942">conn</span>&nbsp;<span class="op" id="3160947">:=</span>&nbsp;<span class="ident" id="3160950">pconn</span><span class="op" id="3160955">.</span><span class="ident" id="3160956">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160963">connectReq</span>&nbsp;<span class="op" id="3160974">:=</span>&nbsp;<span class="op" id="3160977">&amp;</span><span class="ident" id="3160978">Request</span><span class="op" id="3160985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3160990">Method</span><span class="op" id="3160996">:</span>&nbsp;<span class="string" id="3160998">&#34;CONNECT&#34;</span><span class="op" id="3161007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161012">URL</span><span class="op" id="3161015">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3161020">&amp;</span><span class="ident" id="3161021">url</span><span class="op" id="3161024">.</span><span class="ident" id="3161025">URL</span><span class="op" id="3161028">{</span><span class="ident" id="3161029">Opaque</span><span class="op" id="3161035">:</span>&nbsp;<span class="ident" id="3161037">cm</span><span class="op" id="3161039">.</span><span class="ident" id="3161040">targetAddr</span><span class="op" id="3161050">}</span><span class="op" id="3161051">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161056">Host</span><span class="op" id="3161060">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3161064">cm</span><span class="op" id="3161066">.</span><span class="ident" id="3161067">targetAddr</span><span class="op" id="3161077">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161082">Header</span><span class="op" id="3161088">:</span>&nbsp;<span class="builtinfunc" id="3161090">make</span><span class="op" id="3161094">(</span><span class="ident" id="3161095">Header</span><span class="op" id="3161101">)</span><span class="op" id="3161102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161110">if</span>&nbsp;<span class="ident" id="3161113">pa</span>&nbsp;<span class="op" id="3161116">:=</span>&nbsp;<span class="ident" id="3161119">cm</span><span class="op" id="3161121">.</span><span class="ident" id="3161122">proxyAuth</span><span class="op" id="3161131">(</span><span class="op" id="3161132">)</span><span class="op" id="3161133">;</span>&nbsp;<span class="ident" id="3161135">pa</span>&nbsp;<span class="op" id="3161138">!=</span>&nbsp;<span class="string" id="3161141">&#34;&#34;</span>&nbsp;<span class="op" id="3161144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161149">connectReq</span><span class="op" id="3161159">.</span><span class="ident" id="3161160">Header</span><span class="op" id="3161166">.</span><span class="ident" id="3161167">Set</span><span class="op" id="3161170">(</span><span class="string" id="3161171">&#34;Proxy-Authorization&#34;</span><span class="op" id="3161192">,</span>&nbsp;<span class="ident" id="3161194">pa</span><span class="op" id="3161196">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161204">connectReq</span><span class="op" id="3161214">.</span><span class="ident" id="3161215">Write</span><span class="op" id="3161220">(</span><span class="ident" id="3161221">conn</span><span class="op" id="3161225">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3161230">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3161250">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3161309">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161357">br</span>&nbsp;<span class="op" id="3161360">:=</span>&nbsp;<span class="ident" id="3161363">bufio</span><span class="op" id="3161368">.</span><span class="ident" id="3161369">NewReader</span><span class="op" id="3161378">(</span><span class="ident" id="3161379">conn</span><span class="op" id="3161383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161387">resp</span><span class="op" id="3161391">,</span>&nbsp;<span class="ident" id="3161393">err</span>&nbsp;<span class="op" id="3161397">:=</span>&nbsp;<span class="ident" id="3161400">ReadResponse</span><span class="op" id="3161412">(</span><span class="ident" id="3161413">br</span><span class="op" id="3161415">,</span>&nbsp;<span class="ident" id="3161417">connectReq</span><span class="op" id="3161427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161431">if</span>&nbsp;<span class="ident" id="3161434">err</span>&nbsp;<span class="op" id="3161438">!=</span>&nbsp;<span class="ident" id="3161441">nil</span>&nbsp;<span class="op" id="3161445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161450">conn</span><span class="op" id="3161454">.</span><span class="ident" id="3161455">Close</span><span class="op" id="3161460">(</span><span class="op" id="3161461">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161466">return</span>&nbsp;<span class="ident" id="3161473">nil</span><span class="op" id="3161476">,</span>&nbsp;<span class="ident" id="3161478">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161488">if</span>&nbsp;<span class="ident" id="3161491">resp</span><span class="op" id="3161495">.</span><span class="ident" id="3161496">StatusCode</span>&nbsp;<span class="op" id="3161507">!=</span>&nbsp;<span class="num" id="3161510">200</span>&nbsp;<span class="op" id="3161514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161519">f</span>&nbsp;<span class="op" id="3161521">:=</span>&nbsp;<span class="ident" id="3161524">strings</span><span class="op" id="3161531">.</span><span class="ident" id="3161532">SplitN</span><span class="op" id="3161538">(</span><span class="ident" id="3161539">resp</span><span class="op" id="3161543">.</span><span class="ident" id="3161544">Status</span><span class="op" id="3161550">,</span>&nbsp;<span class="string" id="3161552">&#34;&nbsp;&#34;</span><span class="op" id="3161555">,</span>&nbsp;<span class="num" id="3161557">2</span><span class="op" id="3161558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161563">conn</span><span class="op" id="3161567">.</span><span class="ident" id="3161568">Close</span><span class="op" id="3161573">(</span><span class="op" id="3161574">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161579">return</span>&nbsp;<span class="ident" id="3161586">nil</span><span class="op" id="3161589">,</span>&nbsp;<span class="ident" id="3161591">errors</span><span class="op" id="3161597">.</span><span class="ident" id="3161598">New</span><span class="op" id="3161601">(</span><span class="ident" id="3161602">f</span><span class="op" id="3161603">[</span><span class="num" id="3161604">1</span><span class="op" id="3161605">]</span><span class="op" id="3161606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161617">if</span>&nbsp;<span class="ident" id="3161620">cm</span><span class="op" id="3161622">.</span><span class="ident" id="3161623">targetScheme</span>&nbsp;<span class="op" id="3161636">==</span>&nbsp;<span class="string" id="3161639">&#34;https&#34;</span>&nbsp;<span class="op" id="3161647">&amp;&amp;</span>&nbsp;<span class="op" id="3161650">!</span><span class="ident" id="3161651">tlsDial</span>&nbsp;<span class="op" id="3161659">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3161663">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161729">cfg</span>&nbsp;<span class="op" id="3161733">:=</span>&nbsp;<span class="ident" id="3161736">t</span><span class="op" id="3161737">.</span><span class="ident" id="3161738">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161756">if</span>&nbsp;<span class="ident" id="3161759">cfg</span>&nbsp;<span class="op" id="3161763">==</span>&nbsp;<span class="ident" id="3161766">nil</span>&nbsp;<span class="op" id="3161770">||</span>&nbsp;<span class="ident" id="3161773">cfg</span><span class="op" id="3161776">.</span><span class="ident" id="3161777">ServerName</span>&nbsp;<span class="op" id="3161788">==</span>&nbsp;<span class="string" id="3161791">&#34;&#34;</span>&nbsp;<span class="op" id="3161794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161799">host</span>&nbsp;<span class="op" id="3161804">:=</span>&nbsp;<span class="ident" id="3161807">cm</span><span class="op" id="3161809">.</span><span class="ident" id="3161810">tlsHost</span><span class="op" id="3161817">(</span><span class="op" id="3161818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3161823">if</span>&nbsp;<span class="ident" id="3161826">cfg</span>&nbsp;<span class="op" id="3161830">==</span>&nbsp;<span class="ident" id="3161833">nil</span>&nbsp;<span class="op" id="3161837">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161843">cfg</span>&nbsp;<span class="op" id="3161847">=</span>&nbsp;<span class="op" id="3161849">&amp;</span><span class="ident" id="3161850">tls</span><span class="op" id="3161853">.</span><span class="ident" id="3161854">Config</span><span class="op" id="3161860">{</span><span class="ident" id="3161861">ServerName</span><span class="op" id="3161871">:</span>&nbsp;<span class="ident" id="3161873">host</span><span class="op" id="3161877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161882">}</span>&nbsp;<span class="keyword" id="3161884">else</span>&nbsp;<span class="op" id="3161889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161895">clone</span>&nbsp;<span class="op" id="3161901">:=</span>&nbsp;<span class="op" id="3161904">*</span><span class="ident" id="3161905">cfg</span>&nbsp;<span class="comment" id="3161909">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161930">clone</span><span class="op" id="3161935">.</span><span class="ident" id="3161936">ServerName</span>&nbsp;<span class="op" id="3161947">=</span>&nbsp;<span class="ident" id="3161949">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161958">cfg</span>&nbsp;<span class="op" id="3161962">=</span>&nbsp;<span class="op" id="3161964">&amp;</span><span class="ident" id="3161965">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3161978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3161982">plainConn</span>&nbsp;<span class="op" id="3161992">:=</span>&nbsp;<span class="ident" id="3161995">pconn</span><span class="op" id="3162000">.</span><span class="ident" id="3162001">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162008">tlsConn</span>&nbsp;<span class="op" id="3162016">:=</span>&nbsp;<span class="ident" id="3162019">tls</span><span class="op" id="3162022">.</span><span class="ident" id="3162023">Client</span><span class="op" id="3162029">(</span><span class="ident" id="3162030">plainConn</span><span class="op" id="3162039">,</span>&nbsp;<span class="ident" id="3162041">cfg</span><span class="op" id="3162044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162048">errc</span>&nbsp;<span class="op" id="3162053">:=</span>&nbsp;<span class="builtinfunc" id="3162056">make</span><span class="op" id="3162060">(</span><span class="keyword" id="3162061">chan</span>&nbsp;<span class="builtintype" id="3162066">error</span><span class="op" id="3162071">,</span>&nbsp;<span class="num" id="3162073">2</span><span class="op" id="3162074">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162078">var</span>&nbsp;<span class="ident" id="3162082">timer</span>&nbsp;<span class="op" id="3162088">*</span><span class="ident" id="3162089">time</span><span class="op" id="3162093">.</span><span class="ident" id="3162094">Timer</span>&nbsp;<span class="comment" id="3162100">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162133">if</span>&nbsp;<span class="ident" id="3162136">d</span>&nbsp;<span class="op" id="3162138">:=</span>&nbsp;<span class="ident" id="3162141">t</span><span class="op" id="3162142">.</span><span class="ident" id="3162143">TLSHandshakeTimeout</span><span class="op" id="3162162">;</span>&nbsp;<span class="ident" id="3162164">d</span>&nbsp;<span class="op" id="3162166">!=</span>&nbsp;<span class="num" id="3162169">0</span>&nbsp;<span class="op" id="3162171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162176">timer</span>&nbsp;<span class="op" id="3162182">=</span>&nbsp;<span class="ident" id="3162184">time</span><span class="op" id="3162188">.</span><span class="ident" id="3162189">AfterFunc</span><span class="op" id="3162198">(</span><span class="ident" id="3162199">d</span><span class="op" id="3162200">,</span>&nbsp;<span class="keyword" id="3162202">func</span><span class="op" id="3162206">(</span><span class="op" id="3162207">)</span>&nbsp;<span class="op" id="3162209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162215">errc</span>&nbsp;<span class="op" id="3162220">&lt;-</span>&nbsp;<span class="ident" id="3162223">tlsHandshakeTimeoutError</span><span class="op" id="3162247">{</span><span class="op" id="3162248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162253">}</span><span class="op" id="3162254">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162262">go</span>&nbsp;<span class="keyword" id="3162265">func</span><span class="op" id="3162269">(</span><span class="op" id="3162270">)</span>&nbsp;<span class="op" id="3162272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162277">err</span>&nbsp;<span class="op" id="3162281">:=</span>&nbsp;<span class="ident" id="3162284">tlsConn</span><span class="op" id="3162291">.</span><span class="ident" id="3162292">Handshake</span><span class="op" id="3162301">(</span><span class="op" id="3162302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162307">if</span>&nbsp;<span class="ident" id="3162310">timer</span>&nbsp;<span class="op" id="3162316">!=</span>&nbsp;<span class="ident" id="3162319">nil</span>&nbsp;<span class="op" id="3162323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162329">timer</span><span class="op" id="3162334">.</span><span class="ident" id="3162335">Stop</span><span class="op" id="3162339">(</span><span class="op" id="3162340">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162350">errc</span>&nbsp;<span class="op" id="3162355">&lt;-</span>&nbsp;<span class="ident" id="3162358">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162364">}</span><span class="op" id="3162365">(</span><span class="op" id="3162366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162370">if</span>&nbsp;<span class="ident" id="3162373">err</span>&nbsp;<span class="op" id="3162377">:=</span>&nbsp;<span class="op" id="3162380">&lt;-</span><span class="ident" id="3162382">errc</span><span class="op" id="3162386">;</span>&nbsp;<span class="ident" id="3162388">err</span>&nbsp;<span class="op" id="3162392">!=</span>&nbsp;<span class="ident" id="3162395">nil</span>&nbsp;<span class="op" id="3162399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162404">plainConn</span><span class="op" id="3162413">.</span><span class="ident" id="3162414">Close</span><span class="op" id="3162419">(</span><span class="op" id="3162420">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162425">return</span>&nbsp;<span class="ident" id="3162432">nil</span><span class="op" id="3162435">,</span>&nbsp;<span class="ident" id="3162437">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162447">if</span>&nbsp;<span class="op" id="3162450">!</span><span class="ident" id="3162451">cfg</span><span class="op" id="3162454">.</span><span class="ident" id="3162455">InsecureSkipVerify</span>&nbsp;<span class="op" id="3162474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162479">if</span>&nbsp;<span class="ident" id="3162482">err</span>&nbsp;<span class="op" id="3162486">:=</span>&nbsp;<span class="ident" id="3162489">tlsConn</span><span class="op" id="3162496">.</span><span class="ident" id="3162497">VerifyHostname</span><span class="op" id="3162511">(</span><span class="ident" id="3162512">cfg</span><span class="op" id="3162515">.</span><span class="ident" id="3162516">ServerName</span><span class="op" id="3162526">)</span><span class="op" id="3162527">;</span>&nbsp;<span class="ident" id="3162529">err</span>&nbsp;<span class="op" id="3162533">!=</span>&nbsp;<span class="ident" id="3162536">nil</span>&nbsp;<span class="op" id="3162540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162546">plainConn</span><span class="op" id="3162555">.</span><span class="ident" id="3162556">Close</span><span class="op" id="3162561">(</span><span class="op" id="3162562">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162568">return</span>&nbsp;<span class="ident" id="3162575">nil</span><span class="op" id="3162578">,</span>&nbsp;<span class="ident" id="3162580">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162595">cs</span>&nbsp;<span class="op" id="3162598">:=</span>&nbsp;<span class="ident" id="3162601">tlsConn</span><span class="op" id="3162608">.</span><span class="ident" id="3162609">ConnectionState</span><span class="op" id="3162624">(</span><span class="op" id="3162625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162629">pconn</span><span class="op" id="3162634">.</span><span class="ident" id="3162635">tlsState</span>&nbsp;<span class="op" id="3162644">=</span>&nbsp;<span class="op" id="3162646">&amp;</span><span class="ident" id="3162647">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162652">pconn</span><span class="op" id="3162657">.</span><span class="ident" id="3162658">conn</span>&nbsp;<span class="op" id="3162663">=</span>&nbsp;<span class="ident" id="3162665">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3162674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162678">pconn</span><span class="op" id="3162683">.</span><span class="ident" id="3162684">br</span>&nbsp;<span class="op" id="3162687">=</span>&nbsp;<span class="ident" id="3162689">bufio</span><span class="op" id="3162694">.</span><span class="ident" id="3162695">NewReader</span><span class="op" id="3162704">(</span><span class="ident" id="3162705">noteEOFReader</span><span class="op" id="3162718">{</span><span class="ident" id="3162719">pconn</span><span class="op" id="3162724">.</span><span class="ident" id="3162725">conn</span><span class="op" id="3162729">,</span>&nbsp;<span class="op" id="3162731">&amp;</span><span class="ident" id="3162732">pconn</span><span class="op" id="3162737">.</span><span class="ident" id="3162738">sawEOF</span><span class="op" id="3162744">}</span><span class="op" id="3162745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3162748">pconn</span><span class="op" id="3162753">.</span><span class="ident" id="3162754">bw</span>&nbsp;<span class="op" id="3162757">=</span>&nbsp;<span class="ident" id="3162759">bufio</span><span class="op" id="3162764">.</span><span class="ident" id="3162765">NewWriter</span><span class="op" id="3162774">(</span><span class="ident" id="3162775">pconn</span><span class="op" id="3162780">.</span><span class="ident" id="3162781">conn</span><span class="op" id="3162785">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162788">go</span>&nbsp;<span class="ident" id="3162791">pconn</span><span class="op" id="3162796">.</span><span class="ident" id="3162797">readLoop</span><span class="op" id="3162805">(</span><span class="op" id="3162806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162809">go</span>&nbsp;<span class="ident" id="3162812">pconn</span><span class="op" id="3162817">.</span><span class="ident" id="3162818">writeLoop</span><span class="op" id="3162827">(</span><span class="op" id="3162828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3162831">return</span>&nbsp;<span class="ident" id="3162838">pconn</span><span class="op" id="3162843">,</span>&nbsp;<span class="ident" id="3162845">nil</span><br>
<span class="lineno"></span><span class="op" id="3162849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3162852">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3162917">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3162980">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3163036">func</span>&nbsp;<span class="ident" id="3163041">useProxy</span><span class="op" id="3163049">(</span><span class="ident" id="3163050">addr</span>&nbsp;<span class="builtintype" id="3163055">string</span><span class="op" id="3163061">)</span>&nbsp;<span class="builtintype" id="3163063">bool</span>&nbsp;<span class="op" id="3163068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163071">if</span>&nbsp;<span class="builtinfunc" id="3163074">len</span><span class="op" id="3163077">(</span><span class="ident" id="3163078">addr</span><span class="op" id="3163082">)</span>&nbsp;<span class="op" id="3163084">==</span>&nbsp;<span class="num" id="3163087">0</span>&nbsp;<span class="op" id="3163089">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163093">return</span>&nbsp;<span class="builtintype" id="3163100">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3163109">host</span><span class="op" id="3163113">,</span>&nbsp;<span class="ident" id="3163115">_</span><span class="op" id="3163116">,</span>&nbsp;<span class="ident" id="3163118">err</span>&nbsp;<span class="op" id="3163122">:=</span>&nbsp;<span class="ident" id="3163125">net</span><span class="op" id="3163128">.</span><span class="ident" id="3163129">SplitHostPort</span><span class="op" id="3163142">(</span><span class="ident" id="3163143">addr</span><span class="op" id="3163147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163150">if</span>&nbsp;<span class="ident" id="3163153">err</span>&nbsp;<span class="op" id="3163157">!=</span>&nbsp;<span class="ident" id="3163160">nil</span>&nbsp;<span class="op" id="3163164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163168">return</span>&nbsp;<span class="builtintype" id="3163175">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163185">if</span>&nbsp;<span class="ident" id="3163188">host</span>&nbsp;<span class="op" id="3163193">==</span>&nbsp;<span class="string" id="3163196">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3163208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163212">return</span>&nbsp;<span class="builtintype" id="3163219">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163229">if</span>&nbsp;<span class="ident" id="3163232">ip</span>&nbsp;<span class="op" id="3163235">:=</span>&nbsp;<span class="ident" id="3163238">net</span><span class="op" id="3163241">.</span><span class="ident" id="3163242">ParseIP</span><span class="op" id="3163249">(</span><span class="ident" id="3163250">host</span><span class="op" id="3163254">)</span><span class="op" id="3163255">;</span>&nbsp;<span class="ident" id="3163257">ip</span>&nbsp;<span class="op" id="3163260">!=</span>&nbsp;<span class="ident" id="3163263">nil</span>&nbsp;<span class="op" id="3163267">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163271">if</span>&nbsp;<span class="ident" id="3163274">ip</span><span class="op" id="3163276">.</span><span class="ident" id="3163277">IsLoopback</span><span class="op" id="3163287">(</span><span class="op" id="3163288">)</span>&nbsp;<span class="op" id="3163290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163295">return</span>&nbsp;<span class="builtintype" id="3163302">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3163317">no_proxy</span>&nbsp;<span class="op" id="3163326">:=</span>&nbsp;<span class="ident" id="3163329">noProxyEnv</span><span class="op" id="3163339">.</span><span class="ident" id="3163340">Get</span><span class="op" id="3163343">(</span><span class="op" id="3163344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163347">if</span>&nbsp;<span class="ident" id="3163350">no_proxy</span>&nbsp;<span class="op" id="3163359">==</span>&nbsp;<span class="string" id="3163362">&#34;*&#34;</span>&nbsp;<span class="op" id="3163366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163370">return</span>&nbsp;<span class="builtintype" id="3163377">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3163388">addr</span>&nbsp;<span class="op" id="3163393">=</span>&nbsp;<span class="ident" id="3163395">strings</span><span class="op" id="3163402">.</span><span class="ident" id="3163403">ToLower</span><span class="op" id="3163410">(</span><span class="ident" id="3163411">strings</span><span class="op" id="3163418">.</span><span class="ident" id="3163419">TrimSpace</span><span class="op" id="3163428">(</span><span class="ident" id="3163429">addr</span><span class="op" id="3163433">)</span><span class="op" id="3163434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163437">if</span>&nbsp;<span class="ident" id="3163440">hasPort</span><span class="op" id="3163447">(</span><span class="ident" id="3163448">addr</span><span class="op" id="3163452">)</span>&nbsp;<span class="op" id="3163454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3163458">addr</span>&nbsp;<span class="op" id="3163463">=</span>&nbsp;<span class="ident" id="3163465">addr</span><span class="op" id="3163469">[</span><span class="op" id="3163470">:</span><span class="ident" id="3163471">strings</span><span class="op" id="3163478">.</span><span class="ident" id="3163479">LastIndex</span><span class="op" id="3163488">(</span><span class="ident" id="3163489">addr</span><span class="op" id="3163493">,</span>&nbsp;<span class="string" id="3163495">&#34;:&#34;</span><span class="op" id="3163498">)</span><span class="op" id="3163499">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163506">for</span>&nbsp;<span class="ident" id="3163510">_</span><span class="op" id="3163511">,</span>&nbsp;<span class="ident" id="3163513">p</span>&nbsp;<span class="op" id="3163515">:=</span>&nbsp;<span class="keyword" id="3163518">range</span>&nbsp;<span class="ident" id="3163524">strings</span><span class="op" id="3163531">.</span><span class="ident" id="3163532">Split</span><span class="op" id="3163537">(</span><span class="ident" id="3163538">no_proxy</span><span class="op" id="3163546">,</span>&nbsp;<span class="string" id="3163548">&#34;,&#34;</span><span class="op" id="3163551">)</span>&nbsp;<span class="op" id="3163553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3163557">p</span>&nbsp;<span class="op" id="3163559">=</span>&nbsp;<span class="ident" id="3163561">strings</span><span class="op" id="3163568">.</span><span class="ident" id="3163569">ToLower</span><span class="op" id="3163576">(</span><span class="ident" id="3163577">strings</span><span class="op" id="3163584">.</span><span class="ident" id="3163585">TrimSpace</span><span class="op" id="3163594">(</span><span class="ident" id="3163595">p</span><span class="op" id="3163596">)</span><span class="op" id="3163597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163601">if</span>&nbsp;<span class="builtinfunc" id="3163604">len</span><span class="op" id="3163607">(</span><span class="ident" id="3163608">p</span><span class="op" id="3163609">)</span>&nbsp;<span class="op" id="3163611">==</span>&nbsp;<span class="num" id="3163614">0</span>&nbsp;<span class="op" id="3163616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163621">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163632">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163636">if</span>&nbsp;<span class="ident" id="3163639">hasPort</span><span class="op" id="3163646">(</span><span class="ident" id="3163647">p</span><span class="op" id="3163648">)</span>&nbsp;<span class="op" id="3163650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3163655">p</span>&nbsp;<span class="op" id="3163657">=</span>&nbsp;<span class="ident" id="3163659">p</span><span class="op" id="3163660">[</span><span class="op" id="3163661">:</span><span class="ident" id="3163662">strings</span><span class="op" id="3163669">.</span><span class="ident" id="3163670">LastIndex</span><span class="op" id="3163679">(</span><span class="ident" id="3163680">p</span><span class="op" id="3163681">,</span>&nbsp;<span class="string" id="3163683">&#34;:&#34;</span><span class="op" id="3163686">)</span><span class="op" id="3163687">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163695">if</span>&nbsp;<span class="ident" id="3163698">addr</span>&nbsp;<span class="op" id="3163703">==</span>&nbsp;<span class="ident" id="3163706">p</span>&nbsp;<span class="op" id="3163708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163713">return</span>&nbsp;<span class="builtintype" id="3163720">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163732">if</span>&nbsp;<span class="ident" id="3163735">p</span><span class="op" id="3163736">[</span><span class="num" id="3163737">0</span><span class="op" id="3163738">]</span>&nbsp;<span class="op" id="3163740">==</span>&nbsp;<span class="string" id="3163743">&#39;.&#39;</span>&nbsp;<span class="op" id="3163747">&amp;&amp;</span>&nbsp;<span class="op" id="3163750">(</span><span class="ident" id="3163751">strings</span><span class="op" id="3163758">.</span><span class="ident" id="3163759">HasSuffix</span><span class="op" id="3163768">(</span><span class="ident" id="3163769">addr</span><span class="op" id="3163773">,</span>&nbsp;<span class="ident" id="3163775">p</span><span class="op" id="3163776">)</span>&nbsp;<span class="op" id="3163778">||</span>&nbsp;<span class="ident" id="3163781">addr</span>&nbsp;<span class="op" id="3163786">==</span>&nbsp;<span class="ident" id="3163789">p</span><span class="op" id="3163790">[</span><span class="num" id="3163791">1</span><span class="op" id="3163792">:</span><span class="op" id="3163793">]</span><span class="op" id="3163794">)</span>&nbsp;<span class="op" id="3163796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3163801">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163862">return</span>&nbsp;<span class="builtintype" id="3163869">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3163877">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3163881">if</span>&nbsp;<span class="ident" id="3163884">p</span><span class="op" id="3163885">[</span><span class="num" id="3163886">0</span><span class="op" id="3163887">]</span>&nbsp;<span class="op" id="3163889">!=</span>&nbsp;<span class="string" id="3163892">&#39;.&#39;</span>&nbsp;<span class="op" id="3163896">&amp;&amp;</span>&nbsp;<span class="ident" id="3163899">strings</span><span class="op" id="3163906">.</span><span class="ident" id="3163907">HasSuffix</span><span class="op" id="3163916">(</span><span class="ident" id="3163917">addr</span><span class="op" id="3163921">,</span>&nbsp;<span class="ident" id="3163923">p</span><span class="op" id="3163924">)</span>&nbsp;<span class="op" id="3163926">&amp;&amp;</span>&nbsp;<span class="ident" id="3163929">addr</span><span class="op" id="3163933">[</span><span class="builtinfunc" id="3163934">len</span><span class="op" id="3163937">(</span><span class="ident" id="3163938">addr</span><span class="op" id="3163942">)</span><span class="op" id="3163943">-</span><span class="builtinfunc" id="3163944">len</span><span class="op" id="3163947">(</span><span class="ident" id="3163948">p</span><span class="op" id="3163949">)</span><span class="op" id="3163950">-</span><span class="num" id="3163951">1</span><span class="op" id="3163952">]</span>&nbsp;<span class="op" id="3163954">==</span>&nbsp;<span class="string" id="3163957">&#39;.&#39;</span>&nbsp;<span class="op" id="3163961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3163966">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3164013">return</span>&nbsp;<span class="builtintype" id="3164020">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3164028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3164031">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3164034">return</span>&nbsp;<span class="builtintype" id="3164041">true</span><br>
<span class="lineno"></span><span class="op" id="3164046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3164049">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3164125">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3164180">//</span><br>
<span class="lineno"></span><span class="comment" id="3164183">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3164234">//</span><br>
<span class="lineno"></span><span class="comment" id="3164237">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3164282">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3164341">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3164408">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3164476">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3164550">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3164628">//</span><br>
<span class="lineno">730</span><span class="comment" id="3164631">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3164678">//</span><br>
<span class="lineno"></span><span class="keyword" id="3164681">type</span>&nbsp;<span class="ident" id="3164686">connectMethod</span>&nbsp;<span class="keyword" id="3164700">struct</span>&nbsp;<span class="op" id="3164707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3164710">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3164723">*</span><span class="ident" id="3164724">url</span><span class="op" id="3164727">.</span><span class="ident" id="3164728">URL</span>&nbsp;<span class="comment" id="3164732">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3164774">targetScheme</span>&nbsp;<span class="builtintype" id="3164787">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3164796">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3164818">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3164831">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3164840">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3164904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3164907">func</span>&nbsp;<span class="op" id="3164912">(</span><span class="ident" id="3164913">cm</span>&nbsp;<span class="op" id="3164916">*</span><span class="ident" id="3164917">connectMethod</span><span class="op" id="3164930">)</span>&nbsp;<span class="ident" id="3164932">key</span><span class="op" id="3164935">(</span><span class="op" id="3164936">)</span>&nbsp;<span class="ident" id="3164938">connectMethodKey</span>&nbsp;<span class="op" id="3164955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3164958">proxyStr</span>&nbsp;<span class="op" id="3164967">:=</span>&nbsp;<span class="string" id="3164970">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3164974">targetAddr</span>&nbsp;<span class="op" id="3164985">:=</span>&nbsp;<span class="ident" id="3164988">cm</span><span class="op" id="3164990">.</span><span class="ident" id="3164991">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165003">if</span>&nbsp;<span class="ident" id="3165006">cm</span><span class="op" id="3165008">.</span><span class="ident" id="3165009">proxyURL</span>&nbsp;<span class="op" id="3165018">!=</span>&nbsp;<span class="ident" id="3165021">nil</span>&nbsp;<span class="op" id="3165025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165029">proxyStr</span>&nbsp;<span class="op" id="3165038">=</span>&nbsp;<span class="ident" id="3165040">cm</span><span class="op" id="3165042">.</span><span class="ident" id="3165043">proxyURL</span><span class="op" id="3165051">.</span><span class="ident" id="3165052">String</span><span class="op" id="3165058">(</span><span class="op" id="3165059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165063">if</span>&nbsp;<span class="ident" id="3165066">cm</span><span class="op" id="3165068">.</span><span class="ident" id="3165069">targetScheme</span>&nbsp;<span class="op" id="3165082">==</span>&nbsp;<span class="string" id="3165085">&#34;http&#34;</span>&nbsp;<span class="op" id="3165092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165097">targetAddr</span>&nbsp;<span class="op" id="3165108">=</span>&nbsp;<span class="string" id="3165110">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3165115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3165118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165121">return</span>&nbsp;<span class="ident" id="3165128">connectMethodKey</span><span class="op" id="3165144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165148">proxy</span><span class="op" id="3165153">:</span>&nbsp;&nbsp;<span class="ident" id="3165156">proxyStr</span><span class="op" id="3165164">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165168">scheme</span><span class="op" id="3165174">:</span>&nbsp;<span class="ident" id="3165176">cm</span><span class="op" id="3165178">.</span><span class="ident" id="3165179">targetScheme</span><span class="op" id="3165191">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165195">addr</span><span class="op" id="3165199">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3165203">targetAddr</span><span class="op" id="3165213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3165216">}</span><br>
<span class="lineno"></span><span class="op" id="3165218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3165221">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3165296">func</span>&nbsp;<span class="op" id="3165301">(</span><span class="ident" id="3165302">cm</span>&nbsp;<span class="op" id="3165305">*</span><span class="ident" id="3165306">connectMethod</span><span class="op" id="3165319">)</span>&nbsp;<span class="ident" id="3165321">addr</span><span class="op" id="3165325">(</span><span class="op" id="3165326">)</span>&nbsp;<span class="builtintype" id="3165328">string</span>&nbsp;<span class="op" id="3165335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165338">if</span>&nbsp;<span class="ident" id="3165341">cm</span><span class="op" id="3165343">.</span><span class="ident" id="3165344">proxyURL</span>&nbsp;<span class="op" id="3165353">!=</span>&nbsp;<span class="ident" id="3165356">nil</span>&nbsp;<span class="op" id="3165360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165364">return</span>&nbsp;<span class="ident" id="3165371">canonicalAddr</span><span class="op" id="3165384">(</span><span class="ident" id="3165385">cm</span><span class="op" id="3165387">.</span><span class="ident" id="3165388">proxyURL</span><span class="op" id="3165396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3165399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165402">return</span>&nbsp;<span class="ident" id="3165409">cm</span><span class="op" id="3165411">.</span><span class="ident" id="3165412">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3165423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3165426">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3165487">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3165507">func</span>&nbsp;<span class="op" id="3165512">(</span><span class="ident" id="3165513">cm</span>&nbsp;<span class="op" id="3165516">*</span><span class="ident" id="3165517">connectMethod</span><span class="op" id="3165530">)</span>&nbsp;<span class="ident" id="3165532">tlsHost</span><span class="op" id="3165539">(</span><span class="op" id="3165540">)</span>&nbsp;<span class="builtintype" id="3165542">string</span>&nbsp;<span class="op" id="3165549">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165552">h</span>&nbsp;<span class="op" id="3165554">:=</span>&nbsp;<span class="ident" id="3165557">cm</span><span class="op" id="3165559">.</span><span class="ident" id="3165560">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165572">if</span>&nbsp;<span class="ident" id="3165575">hasPort</span><span class="op" id="3165582">(</span><span class="ident" id="3165583">h</span><span class="op" id="3165584">)</span>&nbsp;<span class="op" id="3165586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165590">h</span>&nbsp;<span class="op" id="3165592">=</span>&nbsp;<span class="ident" id="3165594">h</span><span class="op" id="3165595">[</span><span class="op" id="3165596">:</span><span class="ident" id="3165597">strings</span><span class="op" id="3165604">.</span><span class="ident" id="3165605">LastIndex</span><span class="op" id="3165614">(</span><span class="ident" id="3165615">h</span><span class="op" id="3165616">,</span>&nbsp;<span class="string" id="3165618">&#34;:&#34;</span><span class="op" id="3165621">)</span><span class="op" id="3165622">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3165625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165628">return</span>&nbsp;<span class="ident" id="3165635">h</span><br>
<span class="lineno">770</span><span class="op" id="3165637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3165640">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3165708">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3165779">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3165789">type</span>&nbsp;<span class="ident" id="3165794">connectMethodKey</span>&nbsp;<span class="keyword" id="3165811">struct</span>&nbsp;<span class="op" id="3165818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3165821">proxy</span><span class="op" id="3165826">,</span>&nbsp;<span class="ident" id="3165828">scheme</span><span class="op" id="3165834">,</span>&nbsp;<span class="ident" id="3165836">addr</span>&nbsp;<span class="builtintype" id="3165841">string</span><br>
<span class="lineno"></span><span class="op" id="3165848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3165851">func</span>&nbsp;<span class="op" id="3165856">(</span><span class="ident" id="3165857">k</span>&nbsp;<span class="ident" id="3165859">connectMethodKey</span><span class="op" id="3165875">)</span>&nbsp;<span class="ident" id="3165877">String</span><span class="op" id="3165883">(</span><span class="op" id="3165884">)</span>&nbsp;<span class="builtintype" id="3165886">string</span>&nbsp;<span class="op" id="3165893">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3165896">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3165920">return</span>&nbsp;<span class="ident" id="3165927">fmt</span><span class="op" id="3165930">.</span><span class="ident" id="3165931">Sprintf</span><span class="op" id="3165938">(</span><span class="string" id="3165939">&#34;%s|%s|%s&#34;</span><span class="op" id="3165949">,</span>&nbsp;<span class="ident" id="3165951">k</span><span class="op" id="3165952">.</span><span class="ident" id="3165953">proxy</span><span class="op" id="3165958">,</span>&nbsp;<span class="ident" id="3165960">k</span><span class="op" id="3165961">.</span><span class="ident" id="3165962">scheme</span><span class="op" id="3165968">,</span>&nbsp;<span class="ident" id="3165970">k</span><span class="op" id="3165971">.</span><span class="ident" id="3165972">addr</span><span class="op" id="3165976">)</span><br>
<span class="lineno"></span><span class="op" id="3165978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3165981">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3166041">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3166098">type</span>&nbsp;<span class="ident" id="3166103">persistConn</span>&nbsp;<span class="keyword" id="3166115">struct</span>&nbsp;<span class="op" id="3166122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166125">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166134">*</span><span class="ident" id="3166135">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166146">cacheKey</span>&nbsp;<span class="ident" id="3166155">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166173">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3166182">net</span><span class="op" id="3166185">.</span><span class="ident" id="3166186">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166192">tlsState</span>&nbsp;<span class="op" id="3166201">*</span><span class="ident" id="3166202">tls</span><span class="op" id="3166205">.</span><span class="ident" id="3166206">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166223">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166232">*</span><span class="ident" id="3166233">bufio</span><span class="op" id="3166238">.</span><span class="ident" id="3166239">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3166252">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166266">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3166275">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3166295">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166351">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166360">*</span><span class="ident" id="3166361">bufio</span><span class="op" id="3166366">.</span><span class="ident" id="3166367">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3166380">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166392">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166401">chan</span>&nbsp;<span class="ident" id="3166406">requestAndChan</span>&nbsp;<span class="comment" id="3166421">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166464">writech</span>&nbsp;&nbsp;<span class="keyword" id="3166473">chan</span>&nbsp;<span class="ident" id="3166478">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3166493">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166537">closech</span>&nbsp;&nbsp;<span class="keyword" id="3166546">chan</span>&nbsp;<span class="keyword" id="3166551">struct</span><span class="op" id="3166557">{</span><span class="op" id="3166558">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3166566">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166594">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3166603">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3166609">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3166669">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3166731">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3166795">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166854">writeErrCh</span>&nbsp;<span class="keyword" id="3166865">chan</span>&nbsp;<span class="builtintype" id="3166870">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166878">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3166899">sync</span><span class="op" id="3166903">.</span><span class="ident" id="3166904">Mutex</span>&nbsp;<span class="comment" id="3166910">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166938">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3166959">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166964">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3166985">bool</span>&nbsp;<span class="comment" id="3166990">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167023">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3167044">bool</span>&nbsp;<span class="comment" id="3167049">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3167129">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3167186">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3167249">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167306">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3167323">func</span><span class="op" id="3167327">(</span><span class="ident" id="3167328">Header</span><span class="op" id="3167334">)</span><br>
<span class="lineno"></span><span class="op" id="3167336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3167339">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3167411">func</span>&nbsp;<span class="op" id="3167416">(</span><span class="ident" id="3167417">pc</span>&nbsp;<span class="op" id="3167420">*</span><span class="ident" id="3167421">persistConn</span><span class="op" id="3167432">)</span>&nbsp;<span class="ident" id="3167434">isBroken</span><span class="op" id="3167442">(</span><span class="op" id="3167443">)</span>&nbsp;<span class="builtintype" id="3167445">bool</span>&nbsp;<span class="op" id="3167450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167453">pc</span><span class="op" id="3167455">.</span><span class="ident" id="3167456">lk</span><span class="op" id="3167458">.</span><span class="ident" id="3167459">Lock</span><span class="op" id="3167463">(</span><span class="op" id="3167464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167467">b</span>&nbsp;<span class="op" id="3167469">:=</span>&nbsp;<span class="ident" id="3167472">pc</span><span class="op" id="3167474">.</span><span class="ident" id="3167475">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167483">pc</span><span class="op" id="3167485">.</span><span class="ident" id="3167486">lk</span><span class="op" id="3167488">.</span><span class="ident" id="3167489">Unlock</span><span class="op" id="3167495">(</span><span class="op" id="3167496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167499">return</span>&nbsp;<span class="ident" id="3167506">b</span><br>
<span class="lineno">820</span><span class="op" id="3167508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3167511">func</span>&nbsp;<span class="op" id="3167516">(</span><span class="ident" id="3167517">pc</span>&nbsp;<span class="op" id="3167520">*</span><span class="ident" id="3167521">persistConn</span><span class="op" id="3167532">)</span>&nbsp;<span class="ident" id="3167534">cancelRequest</span><span class="op" id="3167547">(</span><span class="op" id="3167548">)</span>&nbsp;<span class="op" id="3167550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167553">pc</span><span class="op" id="3167555">.</span><span class="ident" id="3167556">conn</span><span class="op" id="3167560">.</span><span class="ident" id="3167561">Close</span><span class="op" id="3167566">(</span><span class="op" id="3167567">)</span><br>
<span class="lineno"></span><span class="op" id="3167569">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3167572">var</span>&nbsp;<span class="ident" id="3167576">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3167597">func</span><span class="op" id="3167601">(</span><span class="builtintype" id="3167602">error</span><span class="op" id="3167607">)</span>&nbsp;<span class="builtintype" id="3167609">bool</span>&nbsp;<span class="comment" id="3167614">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3167640">func</span>&nbsp;<span class="ident" id="3167645">remoteSideClosed</span><span class="op" id="3167661">(</span><span class="ident" id="3167662">err</span>&nbsp;<span class="builtintype" id="3167666">error</span><span class="op" id="3167671">)</span>&nbsp;<span class="builtintype" id="3167673">bool</span>&nbsp;<span class="op" id="3167678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167681">if</span>&nbsp;<span class="ident" id="3167684">err</span>&nbsp;<span class="op" id="3167688">==</span>&nbsp;<span class="ident" id="3167691">io</span><span class="op" id="3167693">.</span><span class="ident" id="3167694">EOF</span>&nbsp;<span class="op" id="3167698">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167702">return</span>&nbsp;<span class="builtintype" id="3167709">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167718">if</span>&nbsp;<span class="ident" id="3167721">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3167742">!=</span>&nbsp;<span class="ident" id="3167745">nil</span>&nbsp;<span class="op" id="3167749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167753">return</span>&nbsp;<span class="ident" id="3167760">remoteSideClosedFunc</span><span class="op" id="3167780">(</span><span class="ident" id="3167781">err</span><span class="op" id="3167784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167787">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167790">return</span>&nbsp;<span class="builtintype" id="3167797">false</span><br>
<span class="lineno"></span><span class="op" id="3167803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3167806">func</span>&nbsp;<span class="op" id="3167811">(</span><span class="ident" id="3167812">pc</span>&nbsp;<span class="op" id="3167815">*</span><span class="ident" id="3167816">persistConn</span><span class="op" id="3167827">)</span>&nbsp;<span class="ident" id="3167829">readLoop</span><span class="op" id="3167837">(</span><span class="op" id="3167838">)</span>&nbsp;<span class="op" id="3167840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167843">alive</span>&nbsp;<span class="op" id="3167849">:=</span>&nbsp;<span class="builtintype" id="3167852">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167859">for</span>&nbsp;<span class="ident" id="3167863">alive</span>&nbsp;<span class="op" id="3167869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167873">pb</span><span class="op" id="3167875">,</span>&nbsp;<span class="ident" id="3167877">err</span>&nbsp;<span class="op" id="3167881">:=</span>&nbsp;<span class="ident" id="3167884">pc</span><span class="op" id="3167886">.</span><span class="ident" id="3167887">br</span><span class="op" id="3167889">.</span><span class="ident" id="3167890">Peek</span><span class="op" id="3167894">(</span><span class="num" id="3167895">1</span><span class="op" id="3167896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167901">pc</span><span class="op" id="3167903">.</span><span class="ident" id="3167904">lk</span><span class="op" id="3167906">.</span><span class="ident" id="3167907">Lock</span><span class="op" id="3167911">(</span><span class="op" id="3167912">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167916">if</span>&nbsp;<span class="ident" id="3167919">pc</span><span class="op" id="3167921">.</span><span class="ident" id="3167922">numExpectedResponses</span>&nbsp;<span class="op" id="3167943">==</span>&nbsp;<span class="num" id="3167946">0</span>&nbsp;<span class="op" id="3167948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167953">if</span>&nbsp;<span class="op" id="3167956">!</span><span class="ident" id="3167957">pc</span><span class="op" id="3167959">.</span><span class="ident" id="3167960">closed</span>&nbsp;<span class="op" id="3167967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167973">pc</span><span class="op" id="3167975">.</span><span class="ident" id="3167976">closeLocked</span><span class="op" id="3167987">(</span><span class="op" id="3167988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167994">if</span>&nbsp;<span class="builtinfunc" id="3167997">len</span><span class="op" id="3168000">(</span><span class="ident" id="3168001">pb</span><span class="op" id="3168003">)</span>&nbsp;<span class="op" id="3168005">&gt;</span>&nbsp;<span class="num" id="3168007">0</span>&nbsp;<span class="op" id="3168009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168016">log</span><span class="op" id="3168019">.</span><span class="ident" id="3168020">Printf</span><span class="op" id="3168026">(</span><span class="string" id="3168027">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3168104">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3168112">string</span><span class="op" id="3168118">(</span><span class="ident" id="3168119">pb</span><span class="op" id="3168121">)</span><span class="op" id="3168122">,</span>&nbsp;<span class="ident" id="3168124">err</span><span class="op" id="3168127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168143">pc</span><span class="op" id="3168145">.</span><span class="ident" id="3168146">lk</span><span class="op" id="3168148">.</span><span class="ident" id="3168149">Unlock</span><span class="op" id="3168155">(</span><span class="op" id="3168156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168161">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168174">pc</span><span class="op" id="3168176">.</span><span class="ident" id="3168177">lk</span><span class="op" id="3168179">.</span><span class="ident" id="3168180">Unlock</span><span class="op" id="3168186">(</span><span class="op" id="3168187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168192">rc</span>&nbsp;<span class="op" id="3168195">:=</span>&nbsp;<span class="op" id="3168198">&lt;-</span><span class="ident" id="3168200">pc</span><span class="op" id="3168202">.</span><span class="ident" id="3168203">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168212">var</span>&nbsp;<span class="ident" id="3168216">resp</span>&nbsp;<span class="op" id="3168221">*</span><span class="ident" id="3168222">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168233">if</span>&nbsp;<span class="ident" id="3168236">err</span>&nbsp;<span class="op" id="3168240">==</span>&nbsp;<span class="ident" id="3168243">nil</span>&nbsp;<span class="op" id="3168247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168252">resp</span><span class="op" id="3168256">,</span>&nbsp;<span class="ident" id="3168258">err</span>&nbsp;<span class="op" id="3168262">=</span>&nbsp;<span class="ident" id="3168264">ReadResponse</span><span class="op" id="3168276">(</span><span class="ident" id="3168277">pc</span><span class="op" id="3168279">.</span><span class="ident" id="3168280">br</span><span class="op" id="3168282">,</span>&nbsp;<span class="ident" id="3168284">rc</span><span class="op" id="3168286">.</span><span class="ident" id="3168287">req</span><span class="op" id="3168290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168295">if</span>&nbsp;<span class="ident" id="3168298">err</span>&nbsp;<span class="op" id="3168302">==</span>&nbsp;<span class="ident" id="3168305">nil</span>&nbsp;<span class="op" id="3168309">&amp;&amp;</span>&nbsp;<span class="ident" id="3168312">resp</span><span class="op" id="3168316">.</span><span class="ident" id="3168317">StatusCode</span>&nbsp;<span class="op" id="3168328">==</span>&nbsp;<span class="num" id="3168331">100</span>&nbsp;<span class="op" id="3168335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168341">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168379">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168440">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168500">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168566">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168614">resp</span><span class="op" id="3168618">,</span>&nbsp;<span class="ident" id="3168620">err</span>&nbsp;<span class="op" id="3168624">=</span>&nbsp;<span class="ident" id="3168626">ReadResponse</span><span class="op" id="3168638">(</span><span class="ident" id="3168639">pc</span><span class="op" id="3168641">.</span><span class="ident" id="3168642">br</span><span class="op" id="3168644">,</span>&nbsp;<span class="ident" id="3168646">rc</span><span class="op" id="3168648">.</span><span class="ident" id="3168649">req</span><span class="op" id="3168652">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168666">if</span>&nbsp;<span class="ident" id="3168669">resp</span>&nbsp;<span class="op" id="3168674">!=</span>&nbsp;<span class="ident" id="3168677">nil</span>&nbsp;<span class="op" id="3168681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168686">resp</span><span class="op" id="3168690">.</span><span class="ident" id="3168691">TLS</span>&nbsp;<span class="op" id="3168695">=</span>&nbsp;<span class="ident" id="3168697">pc</span><span class="op" id="3168699">.</span><span class="ident" id="3168700">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168716">hasBody</span>&nbsp;<span class="op" id="3168724">:=</span>&nbsp;<span class="ident" id="3168727">resp</span>&nbsp;<span class="op" id="3168732">!=</span>&nbsp;<span class="ident" id="3168735">nil</span>&nbsp;<span class="op" id="3168739">&amp;&amp;</span>&nbsp;<span class="ident" id="3168742">rc</span><span class="op" id="3168744">.</span><span class="ident" id="3168745">req</span><span class="op" id="3168748">.</span><span class="ident" id="3168749">Method</span>&nbsp;<span class="op" id="3168756">!=</span>&nbsp;<span class="string" id="3168759">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3168766">&amp;&amp;</span>&nbsp;<span class="ident" id="3168769">resp</span><span class="op" id="3168773">.</span><span class="ident" id="3168774">ContentLength</span>&nbsp;<span class="op" id="3168788">!=</span>&nbsp;<span class="num" id="3168791">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168796">if</span>&nbsp;<span class="ident" id="3168799">err</span>&nbsp;<span class="op" id="3168803">!=</span>&nbsp;<span class="ident" id="3168806">nil</span>&nbsp;<span class="op" id="3168810">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168815">pc</span><span class="op" id="3168817">.</span><span class="builtinfunc" id="3168818">close</span><span class="op" id="3168823">(</span><span class="op" id="3168824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168828">}</span>&nbsp;<span class="keyword" id="3168830">else</span>&nbsp;<span class="op" id="3168835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168840">if</span>&nbsp;<span class="ident" id="3168843">rc</span><span class="op" id="3168845">.</span><span class="ident" id="3168846">addedGzip</span>&nbsp;<span class="op" id="3168856">&amp;&amp;</span>&nbsp;<span class="ident" id="3168859">hasBody</span>&nbsp;<span class="op" id="3168867">&amp;&amp;</span>&nbsp;<span class="ident" id="3168870">resp</span><span class="op" id="3168874">.</span><span class="ident" id="3168875">Header</span><span class="op" id="3168881">.</span><span class="ident" id="3168882">Get</span><span class="op" id="3168885">(</span><span class="string" id="3168886">&#34;Content-Encoding&#34;</span><span class="op" id="3168904">)</span>&nbsp;<span class="op" id="3168906">==</span>&nbsp;<span class="string" id="3168909">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3168916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168922">resp</span><span class="op" id="3168926">.</span><span class="ident" id="3168927">Header</span><span class="op" id="3168933">.</span><span class="ident" id="3168934">Del</span><span class="op" id="3168937">(</span><span class="string" id="3168938">&#34;Content-Encoding&#34;</span><span class="op" id="3168956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168962">resp</span><span class="op" id="3168966">.</span><span class="ident" id="3168967">Header</span><span class="op" id="3168973">.</span><span class="ident" id="3168974">Del</span><span class="op" id="3168977">(</span><span class="string" id="3168978">&#34;Content-Length&#34;</span><span class="op" id="3168994">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169000">resp</span><span class="op" id="3169004">.</span><span class="ident" id="3169005">ContentLength</span>&nbsp;<span class="op" id="3169019">=</span>&nbsp;<span class="op" id="3169021">-</span><span class="num" id="3169022">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169028">resp</span><span class="op" id="3169032">.</span><span class="ident" id="3169033">Body</span>&nbsp;<span class="op" id="3169038">=</span>&nbsp;<span class="op" id="3169040">&amp;</span><span class="ident" id="3169041">gzipReader</span><span class="op" id="3169051">{</span><span class="ident" id="3169052">body</span><span class="op" id="3169056">:</span>&nbsp;<span class="ident" id="3169058">resp</span><span class="op" id="3169062">.</span><span class="ident" id="3169063">Body</span><span class="op" id="3169067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169077">resp</span><span class="op" id="3169081">.</span><span class="ident" id="3169082">Body</span>&nbsp;<span class="op" id="3169087">=</span>&nbsp;<span class="op" id="3169089">&amp;</span><span class="ident" id="3169090">bodyEOFSignal</span><span class="op" id="3169103">{</span><span class="ident" id="3169104">body</span><span class="op" id="3169108">:</span>&nbsp;<span class="ident" id="3169110">resp</span><span class="op" id="3169114">.</span><span class="ident" id="3169115">Body</span><span class="op" id="3169119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169123">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169128">if</span>&nbsp;<span class="ident" id="3169131">err</span>&nbsp;<span class="op" id="3169135">!=</span>&nbsp;<span class="ident" id="3169138">nil</span>&nbsp;<span class="op" id="3169142">||</span>&nbsp;<span class="ident" id="3169145">resp</span><span class="op" id="3169149">.</span><span class="ident" id="3169150">Close</span>&nbsp;<span class="op" id="3169156">||</span>&nbsp;<span class="ident" id="3169159">rc</span><span class="op" id="3169161">.</span><span class="ident" id="3169162">req</span><span class="op" id="3169165">.</span><span class="ident" id="3169166">Close</span>&nbsp;<span class="op" id="3169172">||</span>&nbsp;<span class="ident" id="3169175">resp</span><span class="op" id="3169179">.</span><span class="ident" id="3169180">StatusCode</span>&nbsp;<span class="op" id="3169191">&lt;=</span>&nbsp;<span class="num" id="3169194">199</span>&nbsp;<span class="op" id="3169198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169203">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169272">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169332">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169379">alive</span>&nbsp;<span class="op" id="3169385">=</span>&nbsp;<span class="builtintype" id="3169387">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169400">var</span>&nbsp;<span class="ident" id="3169404">waitForBodyRead</span>&nbsp;<span class="keyword" id="3169420">chan</span>&nbsp;<span class="builtintype" id="3169425">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169432">if</span>&nbsp;<span class="ident" id="3169435">hasBody</span>&nbsp;<span class="op" id="3169443">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169448">waitForBodyRead</span>&nbsp;<span class="op" id="3169464">=</span>&nbsp;<span class="builtinfunc" id="3169466">make</span><span class="op" id="3169470">(</span><span class="keyword" id="3169471">chan</span>&nbsp;<span class="builtintype" id="3169476">bool</span><span class="op" id="3169480">,</span>&nbsp;<span class="num" id="3169482">2</span><span class="op" id="3169483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169488">resp</span><span class="op" id="3169492">.</span><span class="ident" id="3169493">Body</span><span class="op" id="3169497">.</span><span class="op" id="3169498">(</span><span class="op" id="3169499">*</span><span class="ident" id="3169500">bodyEOFSignal</span><span class="op" id="3169513">)</span><span class="op" id="3169514">.</span><span class="ident" id="3169515">earlyCloseFn</span>&nbsp;<span class="op" id="3169528">=</span>&nbsp;<span class="keyword" id="3169530">func</span><span class="op" id="3169534">(</span><span class="op" id="3169535">)</span>&nbsp;<span class="builtintype" id="3169537">error</span>&nbsp;<span class="op" id="3169543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169549">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169589">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169628">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169642">waitForBodyRead</span>&nbsp;<span class="op" id="3169658">&lt;-</span>&nbsp;<span class="builtintype" id="3169661">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169671">return</span>&nbsp;<span class="ident" id="3169678">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169690">resp</span><span class="op" id="3169694">.</span><span class="ident" id="3169695">Body</span><span class="op" id="3169699">.</span><span class="op" id="3169700">(</span><span class="op" id="3169701">*</span><span class="ident" id="3169702">bodyEOFSignal</span><span class="op" id="3169715">)</span><span class="op" id="3169716">.</span><span class="ident" id="3169717">fn</span>&nbsp;<span class="op" id="3169720">=</span>&nbsp;<span class="keyword" id="3169722">func</span><span class="op" id="3169726">(</span><span class="ident" id="3169727">err</span>&nbsp;<span class="builtintype" id="3169731">error</span><span class="op" id="3169736">)</span>&nbsp;<span class="op" id="3169738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169744">waitForBodyRead</span>&nbsp;<span class="op" id="3169760">&lt;-</span>&nbsp;<span class="ident" id="3169763">alive</span>&nbsp;<span class="op" id="3169769">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169777">err</span>&nbsp;<span class="op" id="3169781">==</span>&nbsp;<span class="ident" id="3169784">nil</span>&nbsp;<span class="op" id="3169788">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169796">!</span><span class="ident" id="3169797">pc</span><span class="op" id="3169799">.</span><span class="ident" id="3169800">sawEOF</span>&nbsp;<span class="op" id="3169807">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169815">pc</span><span class="op" id="3169817">.</span><span class="ident" id="3169818">wroteRequest</span><span class="op" id="3169830">(</span><span class="op" id="3169831">)</span>&nbsp;<span class="op" id="3169833">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169841">pc</span><span class="op" id="3169843">.</span><span class="ident" id="3169844">t</span><span class="op" id="3169845">.</span><span class="ident" id="3169846">putIdleConn</span><span class="op" id="3169857">(</span><span class="ident" id="3169858">pc</span><span class="op" id="3169860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169865">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169874">if</span>&nbsp;<span class="ident" id="3169877">alive</span>&nbsp;<span class="op" id="3169883">&amp;&amp;</span>&nbsp;<span class="op" id="3169886">!</span><span class="ident" id="3169887">hasBody</span>&nbsp;<span class="op" id="3169895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169900">alive</span>&nbsp;<span class="op" id="3169906">=</span>&nbsp;<span class="op" id="3169908">!</span><span class="ident" id="3169909">pc</span><span class="op" id="3169911">.</span><span class="ident" id="3169912">sawEOF</span>&nbsp;<span class="op" id="3169919">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169926">pc</span><span class="op" id="3169928">.</span><span class="ident" id="3169929">wroteRequest</span><span class="op" id="3169941">(</span><span class="op" id="3169942">)</span>&nbsp;<span class="op" id="3169944">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169951">pc</span><span class="op" id="3169953">.</span><span class="ident" id="3169954">t</span><span class="op" id="3169955">.</span><span class="ident" id="3169956">putIdleConn</span><span class="op" id="3169967">(</span><span class="ident" id="3169968">pc</span><span class="op" id="3169970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169979">rc</span><span class="op" id="3169981">.</span><span class="ident" id="3169982">ch</span>&nbsp;<span class="op" id="3169985">&lt;-</span>&nbsp;<span class="ident" id="3169988">responseAndError</span><span class="op" id="3170004">{</span><span class="ident" id="3170005">resp</span><span class="op" id="3170009">,</span>&nbsp;<span class="ident" id="3170011">err</span><span class="op" id="3170014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3170019">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3170086">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170147">if</span>&nbsp;<span class="ident" id="3170150">waitForBodyRead</span>&nbsp;<span class="op" id="3170166">!=</span>&nbsp;<span class="ident" id="3170169">nil</span>&nbsp;<span class="op" id="3170173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170178">select</span>&nbsp;<span class="op" id="3170185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170190">case</span>&nbsp;<span class="ident" id="3170195">alive</span>&nbsp;<span class="op" id="3170201">=</span>&nbsp;<span class="op" id="3170203">&lt;-</span><span class="ident" id="3170205">waitForBodyRead</span><span class="op" id="3170220">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170225">case</span>&nbsp;<span class="op" id="3170230">&lt;-</span><span class="ident" id="3170232">pc</span><span class="op" id="3170234">.</span><span class="ident" id="3170235">closech</span><span class="op" id="3170242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170248">alive</span>&nbsp;<span class="op" id="3170254">=</span>&nbsp;<span class="builtintype" id="3170256">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170274">pc</span><span class="op" id="3170276">.</span><span class="ident" id="3170277">t</span><span class="op" id="3170278">.</span><span class="ident" id="3170279">setReqCanceler</span><span class="op" id="3170293">(</span><span class="ident" id="3170294">rc</span><span class="op" id="3170296">.</span><span class="ident" id="3170297">req</span><span class="op" id="3170300">,</span>&nbsp;<span class="ident" id="3170302">nil</span><span class="op" id="3170305">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170310">if</span>&nbsp;<span class="op" id="3170313">!</span><span class="ident" id="3170314">alive</span>&nbsp;<span class="op" id="3170320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170325">pc</span><span class="op" id="3170327">.</span><span class="builtinfunc" id="3170328">close</span><span class="op" id="3170333">(</span><span class="op" id="3170334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170338">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170341">}</span><br>
<span class="lineno"></span><span class="op" id="3170343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3170346">func</span>&nbsp;<span class="op" id="3170351">(</span><span class="ident" id="3170352">pc</span>&nbsp;<span class="op" id="3170355">*</span><span class="ident" id="3170356">persistConn</span><span class="op" id="3170367">)</span>&nbsp;<span class="ident" id="3170369">writeLoop</span><span class="op" id="3170378">(</span><span class="op" id="3170379">)</span>&nbsp;<span class="op" id="3170381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170384">for</span>&nbsp;<span class="op" id="3170388">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170392">select</span>&nbsp;<span class="op" id="3170399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170403">case</span>&nbsp;<span class="ident" id="3170408">wr</span>&nbsp;<span class="op" id="3170411">:=</span>&nbsp;<span class="op" id="3170414">&lt;-</span><span class="ident" id="3170416">pc</span><span class="op" id="3170418">.</span><span class="ident" id="3170419">writech</span><span class="op" id="3170426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170431">if</span>&nbsp;<span class="ident" id="3170434">pc</span><span class="op" id="3170436">.</span><span class="ident" id="3170437">isBroken</span><span class="op" id="3170445">(</span><span class="op" id="3170446">)</span>&nbsp;<span class="op" id="3170448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170454">wr</span><span class="op" id="3170456">.</span><span class="ident" id="3170457">ch</span>&nbsp;<span class="op" id="3170460">&lt;-</span>&nbsp;<span class="ident" id="3170463">errors</span><span class="op" id="3170469">.</span><span class="ident" id="3170470">New</span><span class="op" id="3170473">(</span><span class="string" id="3170474">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3170527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170533">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170550">err</span>&nbsp;<span class="op" id="3170554">:=</span>&nbsp;<span class="ident" id="3170557">wr</span><span class="op" id="3170559">.</span><span class="ident" id="3170560">req</span><span class="op" id="3170563">.</span><span class="ident" id="3170564">Request</span><span class="op" id="3170571">.</span><span class="ident" id="3170572">write</span><span class="op" id="3170577">(</span><span class="ident" id="3170578">pc</span><span class="op" id="3170580">.</span><span class="ident" id="3170581">bw</span><span class="op" id="3170583">,</span>&nbsp;<span class="ident" id="3170585">pc</span><span class="op" id="3170587">.</span><span class="ident" id="3170588">isProxy</span><span class="op" id="3170595">,</span>&nbsp;<span class="ident" id="3170597">wr</span><span class="op" id="3170599">.</span><span class="ident" id="3170600">req</span><span class="op" id="3170603">.</span><span class="ident" id="3170604">extra</span><span class="op" id="3170609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170614">if</span>&nbsp;<span class="ident" id="3170617">err</span>&nbsp;<span class="op" id="3170621">==</span>&nbsp;<span class="ident" id="3170624">nil</span>&nbsp;<span class="op" id="3170628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170634">err</span>&nbsp;<span class="op" id="3170638">=</span>&nbsp;<span class="ident" id="3170640">pc</span><span class="op" id="3170642">.</span><span class="ident" id="3170643">bw</span><span class="op" id="3170645">.</span><span class="ident" id="3170646">Flush</span><span class="op" id="3170651">(</span><span class="op" id="3170652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170657">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170662">if</span>&nbsp;<span class="ident" id="3170665">err</span>&nbsp;<span class="op" id="3170669">!=</span>&nbsp;<span class="ident" id="3170672">nil</span>&nbsp;<span class="op" id="3170676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170682">pc</span><span class="op" id="3170684">.</span><span class="ident" id="3170685">markBroken</span><span class="op" id="3170695">(</span><span class="op" id="3170696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170702">wr</span><span class="op" id="3170704">.</span><span class="ident" id="3170705">req</span><span class="op" id="3170708">.</span><span class="ident" id="3170709">Request</span><span class="op" id="3170716">.</span><span class="ident" id="3170717">closeBody</span><span class="op" id="3170726">(</span><span class="op" id="3170727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170737">pc</span><span class="op" id="3170739">.</span><span class="ident" id="3170740">writeErrCh</span>&nbsp;<span class="op" id="3170751">&lt;-</span>&nbsp;<span class="ident" id="3170754">err</span>&nbsp;<span class="comment" id="3170758">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170807">wr</span><span class="op" id="3170809">.</span><span class="ident" id="3170810">ch</span>&nbsp;<span class="op" id="3170813">&lt;-</span>&nbsp;<span class="ident" id="3170816">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3170828">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170859">case</span>&nbsp;<span class="op" id="3170864">&lt;-</span><span class="ident" id="3170866">pc</span><span class="op" id="3170868">.</span><span class="ident" id="3170869">closech</span><span class="op" id="3170876">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170893">}</span><br>
<span class="lineno">965</span><span class="op" id="3170895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3170898">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3170979">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3171034">func</span>&nbsp;<span class="op" id="3171039">(</span><span class="ident" id="3171040">pc</span>&nbsp;<span class="op" id="3171043">*</span><span class="ident" id="3171044">persistConn</span><span class="op" id="3171055">)</span>&nbsp;<span class="ident" id="3171057">wroteRequest</span><span class="op" id="3171069">(</span><span class="op" id="3171070">)</span>&nbsp;<span class="builtintype" id="3171072">bool</span>&nbsp;<span class="op" id="3171077">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171080">select</span>&nbsp;<span class="op" id="3171087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171090">case</span>&nbsp;<span class="ident" id="3171095">err</span>&nbsp;<span class="op" id="3171099">:=</span>&nbsp;<span class="op" id="3171102">&lt;-</span><span class="ident" id="3171104">pc</span><span class="op" id="3171106">.</span><span class="ident" id="3171107">writeErrCh</span><span class="op" id="3171117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171121">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171187">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171216">return</span>&nbsp;<span class="ident" id="3171223">err</span>&nbsp;<span class="op" id="3171227">==</span>&nbsp;<span class="ident" id="3171230">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171235">default</span><span class="op" id="3171242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171246">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171309">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171372">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171439">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171494">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171499">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171563">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171628">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171692">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3171756">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171787">select</span>&nbsp;<span class="op" id="3171794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171798">case</span>&nbsp;<span class="ident" id="3171803">err</span>&nbsp;<span class="op" id="3171807">:=</span>&nbsp;<span class="op" id="3171810">&lt;-</span><span class="ident" id="3171812">pc</span><span class="op" id="3171814">.</span><span class="ident" id="3171815">writeErrCh</span><span class="op" id="3171825">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171830">return</span>&nbsp;<span class="ident" id="3171837">err</span>&nbsp;<span class="op" id="3171841">==</span>&nbsp;<span class="ident" id="3171844">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171850">case</span>&nbsp;<span class="op" id="3171855">&lt;-</span><span class="ident" id="3171857">time</span><span class="op" id="3171861">.</span><span class="ident" id="3171862">After</span><span class="op" id="3171867">(</span><span class="num" id="3171868">50</span>&nbsp;<span class="op" id="3171871">*</span>&nbsp;<span class="ident" id="3171873">time</span><span class="op" id="3171877">.</span><span class="ident" id="3171878">Millisecond</span><span class="op" id="3171889">)</span><span class="op" id="3171890">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3171895">return</span>&nbsp;<span class="builtintype" id="3171902">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3171910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3171913">}</span><br>
<span class="lineno"></span><span class="op" id="3171915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3171918">type</span>&nbsp;<span class="ident" id="3171923">responseAndError</span>&nbsp;<span class="keyword" id="3171940">struct</span>&nbsp;<span class="op" id="3171947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3171950">res</span>&nbsp;<span class="op" id="3171954">*</span><span class="ident" id="3171955">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3171965">err</span>&nbsp;<span class="builtintype" id="3171969">error</span><br>
<span class="lineno"></span><span class="op" id="3171975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3171978">type</span>&nbsp;<span class="ident" id="3171983">requestAndChan</span>&nbsp;<span class="keyword" id="3171998">struct</span>&nbsp;<span class="op" id="3172005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172008">req</span>&nbsp;<span class="op" id="3172012">*</span><span class="ident" id="3172013">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172022">ch</span>&nbsp;&nbsp;<span class="keyword" id="3172026">chan</span>&nbsp;<span class="ident" id="3172031">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3172050">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3172111">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3172168">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172206">addedGzip</span>&nbsp;<span class="builtintype" id="3172216">bool</span><br>
<span class="lineno"></span><span class="op" id="3172221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3172224">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3172285">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3172349">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3172415">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3172425">type</span>&nbsp;<span class="ident" id="3172430">writeRequest</span>&nbsp;<span class="keyword" id="3172443">struct</span>&nbsp;<span class="op" id="3172450">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172453">req</span>&nbsp;<span class="op" id="3172457">*</span><span class="ident" id="3172458">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172476">ch</span>&nbsp;&nbsp;<span class="keyword" id="3172480">chan</span><span class="op" id="3172484">&lt;-</span>&nbsp;<span class="builtintype" id="3172487">error</span><br>
<span class="lineno"></span><span class="op" id="3172493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3172496">type</span>&nbsp;<span class="ident" id="3172501">httpError</span>&nbsp;<span class="keyword" id="3172511">struct</span>&nbsp;<span class="op" id="3172518">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172521">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3172529">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3172537">timeout</span>&nbsp;<span class="builtintype" id="3172545">bool</span><br>
<span class="lineno"></span><span class="op" id="3172550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3172553">func</span>&nbsp;<span class="op" id="3172558">(</span><span class="ident" id="3172559">e</span>&nbsp;<span class="op" id="3172561">*</span><span class="ident" id="3172562">httpError</span><span class="op" id="3172571">)</span>&nbsp;<span class="ident" id="3172573">Error</span><span class="op" id="3172578">(</span><span class="op" id="3172579">)</span>&nbsp;<span class="builtintype" id="3172581">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3172590">{</span>&nbsp;<span class="keyword" id="3172592">return</span>&nbsp;<span class="ident" id="3172599">e</span><span class="op" id="3172600">.</span><span class="ident" id="3172601">err</span>&nbsp;<span class="op" id="3172605">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3172607">func</span>&nbsp;<span class="op" id="3172612">(</span><span class="ident" id="3172613">e</span>&nbsp;<span class="op" id="3172615">*</span><span class="ident" id="3172616">httpError</span><span class="op" id="3172625">)</span>&nbsp;<span class="ident" id="3172627">Timeout</span><span class="op" id="3172634">(</span><span class="op" id="3172635">)</span>&nbsp;<span class="builtintype" id="3172637">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3172644">{</span>&nbsp;<span class="keyword" id="3172646">return</span>&nbsp;<span class="ident" id="3172653">e</span><span class="op" id="3172654">.</span><span class="ident" id="3172655">timeout</span>&nbsp;<span class="op" id="3172663">}</span><br>
<span class="lineno"></span><span class="keyword" id="3172665">func</span>&nbsp;<span class="op" id="3172670">(</span><span class="ident" id="3172671">e</span>&nbsp;<span class="op" id="3172673">*</span><span class="ident" id="3172674">httpError</span><span class="op" id="3172683">)</span>&nbsp;<span class="ident" id="3172685">Temporary</span><span class="op" id="3172694">(</span><span class="op" id="3172695">)</span>&nbsp;<span class="builtintype" id="3172697">bool</span>&nbsp;<span class="op" id="3172702">{</span>&nbsp;<span class="keyword" id="3172704">return</span>&nbsp;<span class="builtintype" id="3172711">true</span>&nbsp;<span class="op" id="3172716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3172719">var</span>&nbsp;<span class="ident" id="3172723">errTimeout</span>&nbsp;<span class="builtintype" id="3172734">error</span>&nbsp;<span class="op" id="3172740">=</span>&nbsp;<span class="op" id="3172742">&amp;</span><span class="ident" id="3172743">httpError</span><span class="op" id="3172752">{</span><span class="ident" id="3172753">err</span><span class="op" id="3172756">:</span>&nbsp;<span class="string" id="3172758">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3172803">,</span>&nbsp;<span class="ident" id="3172805">timeout</span><span class="op" id="3172812">:</span>&nbsp;<span class="builtintype" id="3172814">true</span><span class="op" id="3172818">}</span><br>
<span class="lineno"></span><span class="keyword" id="3172820">var</span>&nbsp;<span class="ident" id="3172824">errClosed</span>&nbsp;<span class="builtintype" id="3172834">error</span>&nbsp;<span class="op" id="3172840">=</span>&nbsp;<span class="op" id="3172842">&amp;</span><span class="ident" id="3172843">httpError</span><span class="op" id="3172852">{</span><span class="ident" id="3172853">err</span><span class="op" id="3172856">:</span>&nbsp;<span class="string" id="3172858">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3172915">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3172918">func</span>&nbsp;<span class="op" id="3172923">(</span><span class="ident" id="3172924">pc</span>&nbsp;<span class="op" id="3172927">*</span><span class="ident" id="3172928">persistConn</span><span class="op" id="3172939">)</span>&nbsp;<span class="ident" id="3172941">roundTrip</span><span class="op" id="3172950">(</span><span class="ident" id="3172951">req</span>&nbsp;<span class="op" id="3172955">*</span><span class="ident" id="3172956">transportRequest</span><span class="op" id="3172972">)</span>&nbsp;<span class="op" id="3172974">(</span><span class="ident" id="3172975">resp</span>&nbsp;<span class="op" id="3172980">*</span><span class="ident" id="3172981">Response</span><span class="op" id="3172989">,</span>&nbsp;<span class="ident" id="3172991">err</span>&nbsp;<span class="builtintype" id="3172995">error</span><span class="op" id="3173000">)</span>&nbsp;<span class="op" id="3173002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173005">pc</span><span class="op" id="3173007">.</span><span class="ident" id="3173008">t</span><span class="op" id="3173009">.</span><span class="ident" id="3173010">setReqCanceler</span><span class="op" id="3173024">(</span><span class="ident" id="3173025">req</span><span class="op" id="3173028">.</span><span class="ident" id="3173029">Request</span><span class="op" id="3173036">,</span>&nbsp;<span class="ident" id="3173038">pc</span><span class="op" id="3173040">.</span><span class="ident" id="3173041">cancelRequest</span><span class="op" id="3173054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173057">pc</span><span class="op" id="3173059">.</span><span class="ident" id="3173060">lk</span><span class="op" id="3173062">.</span><span class="ident" id="3173063">Lock</span><span class="op" id="3173067">(</span><span class="op" id="3173068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173071">pc</span><span class="op" id="3173073">.</span><span class="ident" id="3173074">numExpectedResponses</span><span class="op" id="3173094">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173098">headerFn</span>&nbsp;<span class="op" id="3173107">:=</span>&nbsp;<span class="ident" id="3173110">pc</span><span class="op" id="3173112">.</span><span class="ident" id="3173113">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173131">pc</span><span class="op" id="3173133">.</span><span class="ident" id="3173134">lk</span><span class="op" id="3173136">.</span><span class="ident" id="3173137">Unlock</span><span class="op" id="3173143">(</span><span class="op" id="3173144">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3173148">if</span>&nbsp;<span class="ident" id="3173151">headerFn</span>&nbsp;<span class="op" id="3173160">!=</span>&nbsp;<span class="ident" id="3173163">nil</span>&nbsp;<span class="op" id="3173167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173171">headerFn</span><span class="op" id="3173179">(</span><span class="ident" id="3173180">req</span><span class="op" id="3173183">.</span><span class="ident" id="3173184">extraHeaders</span><span class="op" id="3173196">(</span><span class="op" id="3173197">)</span><span class="op" id="3173198">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3173201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173205">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173269">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173323">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173380">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173398">requestedGzip</span>&nbsp;<span class="op" id="3173412">:=</span>&nbsp;<span class="builtintype" id="3173415">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3173422">if</span>&nbsp;<span class="op" id="3173425">!</span><span class="ident" id="3173426">pc</span><span class="op" id="3173428">.</span><span class="ident" id="3173429">t</span><span class="op" id="3173430">.</span><span class="ident" id="3173431">DisableCompression</span>&nbsp;<span class="op" id="3173450">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173455">req</span><span class="op" id="3173458">.</span><span class="ident" id="3173459">Header</span><span class="op" id="3173465">.</span><span class="ident" id="3173466">Get</span><span class="op" id="3173469">(</span><span class="string" id="3173470">&#34;Accept-Encoding&#34;</span><span class="op" id="3173487">)</span>&nbsp;<span class="op" id="3173489">==</span>&nbsp;<span class="string" id="3173492">&#34;&#34;</span>&nbsp;<span class="op" id="3173495">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173500">req</span><span class="op" id="3173503">.</span><span class="ident" id="3173504">Header</span><span class="op" id="3173510">.</span><span class="ident" id="3173511">Get</span><span class="op" id="3173514">(</span><span class="string" id="3173515">&#34;Range&#34;</span><span class="op" id="3173522">)</span>&nbsp;<span class="op" id="3173524">==</span>&nbsp;<span class="string" id="3173527">&#34;&#34;</span>&nbsp;<span class="op" id="3173530">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3173535">req</span><span class="op" id="3173538">.</span><span class="ident" id="3173539">Method</span>&nbsp;<span class="op" id="3173546">!=</span>&nbsp;<span class="string" id="3173549">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3173556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173560">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173622">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173664">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173719">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173724">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173780">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173808">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173854">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173890">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173895">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3173959">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174025">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174071">requestedGzip</span>&nbsp;<span class="op" id="3174085">=</span>&nbsp;<span class="builtintype" id="3174087">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174094">req</span><span class="op" id="3174097">.</span><span class="ident" id="3174098">extraHeaders</span><span class="op" id="3174110">(</span><span class="op" id="3174111">)</span><span class="op" id="3174112">.</span><span class="ident" id="3174113">Set</span><span class="op" id="3174116">(</span><span class="string" id="3174117">&#34;Accept-Encoding&#34;</span><span class="op" id="3174134">,</span>&nbsp;<span class="string" id="3174136">&#34;gzip&#34;</span><span class="op" id="3174142">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3174145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174149">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174213">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174277">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174295">writeErrCh</span>&nbsp;<span class="op" id="3174306">:=</span>&nbsp;<span class="builtinfunc" id="3174309">make</span><span class="op" id="3174313">(</span><span class="keyword" id="3174314">chan</span>&nbsp;<span class="builtintype" id="3174319">error</span><span class="op" id="3174324">,</span>&nbsp;<span class="num" id="3174326">1</span><span class="op" id="3174327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174330">pc</span><span class="op" id="3174332">.</span><span class="ident" id="3174333">writech</span>&nbsp;<span class="op" id="3174341">&lt;-</span>&nbsp;<span class="ident" id="3174344">writeRequest</span><span class="op" id="3174356">{</span><span class="ident" id="3174357">req</span><span class="op" id="3174360">,</span>&nbsp;<span class="ident" id="3174362">writeErrCh</span><span class="op" id="3174372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174376">resc</span>&nbsp;<span class="op" id="3174381">:=</span>&nbsp;<span class="builtinfunc" id="3174384">make</span><span class="op" id="3174388">(</span><span class="keyword" id="3174389">chan</span>&nbsp;<span class="ident" id="3174394">responseAndError</span><span class="op" id="3174410">,</span>&nbsp;<span class="num" id="3174412">1</span><span class="op" id="3174413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174416">pc</span><span class="op" id="3174418">.</span><span class="ident" id="3174419">reqch</span>&nbsp;<span class="op" id="3174425">&lt;-</span>&nbsp;<span class="ident" id="3174428">requestAndChan</span><span class="op" id="3174442">{</span><span class="ident" id="3174443">req</span><span class="op" id="3174446">.</span><span class="ident" id="3174447">Request</span><span class="op" id="3174454">,</span>&nbsp;<span class="ident" id="3174456">resc</span><span class="op" id="3174460">,</span>&nbsp;<span class="ident" id="3174462">requestedGzip</span><span class="op" id="3174475">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174479">var</span>&nbsp;<span class="ident" id="3174483">re</span>&nbsp;<span class="ident" id="3174486">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174504">var</span>&nbsp;<span class="ident" id="3174508">pconnDeadCh</span>&nbsp;<span class="op" id="3174520">=</span>&nbsp;<span class="ident" id="3174522">pc</span><span class="op" id="3174524">.</span><span class="ident" id="3174525">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174534">var</span>&nbsp;<span class="ident" id="3174538">failTicker</span>&nbsp;<span class="op" id="3174549">&lt;-</span><span class="keyword" id="3174551">chan</span>&nbsp;<span class="ident" id="3174556">time</span><span class="op" id="3174560">.</span><span class="ident" id="3174561">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174567">var</span>&nbsp;<span class="ident" id="3174571">respHeaderTimer</span>&nbsp;<span class="op" id="3174587">&lt;-</span><span class="keyword" id="3174589">chan</span>&nbsp;<span class="ident" id="3174594">time</span><span class="op" id="3174598">.</span><span class="ident" id="3174599">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3174604">WaitResponse</span><span class="op" id="3174616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174619">for</span>&nbsp;<span class="op" id="3174623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174627">select</span>&nbsp;<span class="op" id="3174634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174638">case</span>&nbsp;<span class="ident" id="3174643">err</span>&nbsp;<span class="op" id="3174647">:=</span>&nbsp;<span class="op" id="3174650">&lt;-</span><span class="ident" id="3174652">writeErrCh</span><span class="op" id="3174662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174667">if</span>&nbsp;<span class="ident" id="3174670">err</span>&nbsp;<span class="op" id="3174674">!=</span>&nbsp;<span class="ident" id="3174677">nil</span>&nbsp;<span class="op" id="3174681">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174687">re</span>&nbsp;<span class="op" id="3174690">=</span>&nbsp;<span class="ident" id="3174692">responseAndError</span><span class="op" id="3174708">{</span><span class="ident" id="3174709">nil</span><span class="op" id="3174712">,</span>&nbsp;<span class="ident" id="3174714">err</span><span class="op" id="3174717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174723">pc</span><span class="op" id="3174725">.</span><span class="builtinfunc" id="3174726">close</span><span class="op" id="3174731">(</span><span class="op" id="3174732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174738">break</span>&nbsp;<span class="ident" id="3174744">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3174760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174765">if</span>&nbsp;<span class="ident" id="3174768">d</span>&nbsp;<span class="op" id="3174770">:=</span>&nbsp;<span class="ident" id="3174773">pc</span><span class="op" id="3174775">.</span><span class="ident" id="3174776">t</span><span class="op" id="3174777">.</span><span class="ident" id="3174778">ResponseHeaderTimeout</span><span class="op" id="3174799">;</span>&nbsp;<span class="ident" id="3174801">d</span>&nbsp;<span class="op" id="3174803">&gt;</span>&nbsp;<span class="num" id="3174805">0</span>&nbsp;<span class="op" id="3174807">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3174813">respHeaderTimer</span>&nbsp;<span class="op" id="3174829">=</span>&nbsp;<span class="ident" id="3174831">time</span><span class="op" id="3174835">.</span><span class="ident" id="3174836">After</span><span class="op" id="3174841">(</span><span class="ident" id="3174842">d</span><span class="op" id="3174843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3174848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3174852">case</span>&nbsp;<span class="op" id="3174857">&lt;-</span><span class="ident" id="3174859">pconnDeadCh</span><span class="op" id="3174870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174875">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174928">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3174988">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175045">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175099">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175158">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175216">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175273">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175307">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175313">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175378">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3175434">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175477">pconnDeadCh</span>&nbsp;<span class="op" id="3175489">=</span>&nbsp;<span class="ident" id="3175491">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3175525">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175546">failTicker</span>&nbsp;<span class="op" id="3175557">=</span>&nbsp;<span class="ident" id="3175559">time</span><span class="op" id="3175563">.</span><span class="ident" id="3175564">After</span><span class="op" id="3175569">(</span><span class="num" id="3175570">100</span>&nbsp;<span class="op" id="3175574">*</span>&nbsp;<span class="ident" id="3175576">time</span><span class="op" id="3175580">.</span><span class="ident" id="3175581">Millisecond</span><span class="op" id="3175592">)</span>&nbsp;<span class="comment" id="3175594">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175631">case</span>&nbsp;<span class="op" id="3175636">&lt;-</span><span class="ident" id="3175638">failTicker</span><span class="op" id="3175648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175653">re</span>&nbsp;<span class="op" id="3175656">=</span>&nbsp;<span class="ident" id="3175658">responseAndError</span><span class="op" id="3175674">{</span><span class="ident" id="3175675">err</span><span class="op" id="3175678">:</span>&nbsp;<span class="ident" id="3175680">errClosed</span><span class="op" id="3175689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175694">break</span>&nbsp;<span class="ident" id="3175700">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175715">case</span>&nbsp;<span class="op" id="3175720">&lt;-</span><span class="ident" id="3175722">respHeaderTimer</span><span class="op" id="3175737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175742">pc</span><span class="op" id="3175744">.</span><span class="builtinfunc" id="3175745">close</span><span class="op" id="3175750">(</span><span class="op" id="3175751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175756">re</span>&nbsp;<span class="op" id="3175759">=</span>&nbsp;<span class="ident" id="3175761">responseAndError</span><span class="op" id="3175777">{</span><span class="ident" id="3175778">err</span><span class="op" id="3175781">:</span>&nbsp;<span class="ident" id="3175783">errTimeout</span><span class="op" id="3175793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175798">break</span>&nbsp;<span class="ident" id="3175804">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175819">case</span>&nbsp;<span class="ident" id="3175824">re</span>&nbsp;<span class="op" id="3175827">=</span>&nbsp;<span class="op" id="3175829">&lt;-</span><span class="ident" id="3175831">resc</span><span class="op" id="3175835">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175840">break</span>&nbsp;<span class="ident" id="3175846">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175868">pc</span><span class="op" id="3175870">.</span><span class="ident" id="3175871">lk</span><span class="op" id="3175873">.</span><span class="ident" id="3175874">Lock</span><span class="op" id="3175878">(</span><span class="op" id="3175879">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175882">pc</span><span class="op" id="3175884">.</span><span class="ident" id="3175885">numExpectedResponses</span><span class="op" id="3175905">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175909">pc</span><span class="op" id="3175911">.</span><span class="ident" id="3175912">lk</span><span class="op" id="3175914">.</span><span class="ident" id="3175915">Unlock</span><span class="op" id="3175921">(</span><span class="op" id="3175922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175926">if</span>&nbsp;<span class="ident" id="3175929">re</span><span class="op" id="3175931">.</span><span class="ident" id="3175932">err</span>&nbsp;<span class="op" id="3175936">!=</span>&nbsp;<span class="ident" id="3175939">nil</span>&nbsp;<span class="op" id="3175943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3175947">pc</span><span class="op" id="3175949">.</span><span class="ident" id="3175950">t</span><span class="op" id="3175951">.</span><span class="ident" id="3175952">setReqCanceler</span><span class="op" id="3175966">(</span><span class="ident" id="3175967">req</span><span class="op" id="3175970">.</span><span class="ident" id="3175971">Request</span><span class="op" id="3175978">,</span>&nbsp;<span class="ident" id="3175980">nil</span><span class="op" id="3175983">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3175986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3175989">return</span>&nbsp;<span class="ident" id="3175996">re</span><span class="op" id="3175998">.</span><span class="ident" id="3175999">res</span><span class="op" id="3176002">,</span>&nbsp;<span class="ident" id="3176004">re</span><span class="op" id="3176006">.</span><span class="ident" id="3176007">err</span><br>
<span class="lineno"></span><span class="op" id="3176011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3176014">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3176079">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3176144">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3176194">func</span>&nbsp;<span class="op" id="3176199">(</span><span class="ident" id="3176200">pc</span>&nbsp;<span class="op" id="3176203">*</span><span class="ident" id="3176204">persistConn</span><span class="op" id="3176215">)</span>&nbsp;<span class="ident" id="3176217">markBroken</span><span class="op" id="3176227">(</span><span class="op" id="3176228">)</span>&nbsp;<span class="op" id="3176230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176233">pc</span><span class="op" id="3176235">.</span><span class="ident" id="3176236">lk</span><span class="op" id="3176238">.</span><span class="ident" id="3176239">Lock</span><span class="op" id="3176243">(</span><span class="op" id="3176244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176247">defer</span>&nbsp;<span class="ident" id="3176253">pc</span><span class="op" id="3176255">.</span><span class="ident" id="3176256">lk</span><span class="op" id="3176258">.</span><span class="ident" id="3176259">Unlock</span><span class="op" id="3176265">(</span><span class="op" id="3176266">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176269">pc</span><span class="op" id="3176271">.</span><span class="ident" id="3176272">broken</span>&nbsp;<span class="op" id="3176279">=</span>&nbsp;<span class="builtintype" id="3176281">true</span><br>
<span class="lineno"></span><span class="op" id="3176286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3176289">func</span>&nbsp;<span class="op" id="3176294">(</span><span class="ident" id="3176295">pc</span>&nbsp;<span class="op" id="3176298">*</span><span class="ident" id="3176299">persistConn</span><span class="op" id="3176310">)</span>&nbsp;<span class="builtinfunc" id="3176312">close</span><span class="op" id="3176317">(</span><span class="op" id="3176318">)</span>&nbsp;<span class="op" id="3176320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176323">pc</span><span class="op" id="3176325">.</span><span class="ident" id="3176326">lk</span><span class="op" id="3176328">.</span><span class="ident" id="3176329">Lock</span><span class="op" id="3176333">(</span><span class="op" id="3176334">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176337">defer</span>&nbsp;<span class="ident" id="3176343">pc</span><span class="op" id="3176345">.</span><span class="ident" id="3176346">lk</span><span class="op" id="3176348">.</span><span class="ident" id="3176349">Unlock</span><span class="op" id="3176355">(</span><span class="op" id="3176356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176359">pc</span><span class="op" id="3176361">.</span><span class="ident" id="3176362">closeLocked</span><span class="op" id="3176373">(</span><span class="op" id="3176374">)</span><br>
<span class="lineno"></span><span class="op" id="3176376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3176379">func</span>&nbsp;<span class="op" id="3176384">(</span><span class="ident" id="3176385">pc</span>&nbsp;<span class="op" id="3176388">*</span><span class="ident" id="3176389">persistConn</span><span class="op" id="3176400">)</span>&nbsp;<span class="ident" id="3176402">closeLocked</span><span class="op" id="3176413">(</span><span class="op" id="3176414">)</span>&nbsp;<span class="op" id="3176416">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176419">pc</span><span class="op" id="3176421">.</span><span class="ident" id="3176422">broken</span>&nbsp;<span class="op" id="3176429">=</span>&nbsp;<span class="builtintype" id="3176431">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176437">if</span>&nbsp;<span class="op" id="3176440">!</span><span class="ident" id="3176441">pc</span><span class="op" id="3176443">.</span><span class="ident" id="3176444">closed</span>&nbsp;<span class="op" id="3176451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176455">pc</span><span class="op" id="3176457">.</span><span class="ident" id="3176458">conn</span><span class="op" id="3176462">.</span><span class="ident" id="3176463">Close</span><span class="op" id="3176468">(</span><span class="op" id="3176469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176473">pc</span><span class="op" id="3176475">.</span><span class="ident" id="3176476">closed</span>&nbsp;<span class="op" id="3176483">=</span>&nbsp;<span class="builtintype" id="3176485">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3176492">close</span><span class="op" id="3176497">(</span><span class="ident" id="3176498">pc</span><span class="op" id="3176500">.</span><span class="ident" id="3176501">closech</span><span class="op" id="3176508">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176514">pc</span><span class="op" id="3176516">.</span><span class="ident" id="3176517">mutateHeaderFunc</span>&nbsp;<span class="op" id="3176534">=</span>&nbsp;<span class="ident" id="3176536">nil</span><br>
<span class="lineno"></span><span class="op" id="3176540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3176543">var</span>&nbsp;<span class="ident" id="3176547">portMap</span>&nbsp;<span class="op" id="3176555">=</span>&nbsp;<span class="keyword" id="3176557">map</span><span class="op" id="3176560">[</span><span class="builtintype" id="3176561">string</span><span class="op" id="3176567">]</span><span class="builtintype" id="3176568">string</span><span class="op" id="3176574">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3176577">&#34;http&#34;</span><span class="op" id="3176583">:</span>&nbsp;&nbsp;<span class="string" id="3176586">&#34;80&#34;</span><span class="op" id="3176590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3176593">&#34;https&#34;</span><span class="op" id="3176600">:</span>&nbsp;<span class="string" id="3176602">&#34;443&#34;</span><span class="op" id="3176607">,</span><br>
<span class="lineno"></span><span class="op" id="3176609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3176612">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3176679">func</span>&nbsp;<span class="ident" id="3176684">canonicalAddr</span><span class="op" id="3176697">(</span><span class="ident" id="3176698">url</span>&nbsp;<span class="op" id="3176702">*</span><span class="ident" id="3176703">url</span><span class="op" id="3176706">.</span><span class="ident" id="3176707">URL</span><span class="op" id="3176710">)</span>&nbsp;<span class="builtintype" id="3176712">string</span>&nbsp;<span class="op" id="3176719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3176722">addr</span>&nbsp;<span class="op" id="3176727">:=</span>&nbsp;<span class="ident" id="3176730">url</span><span class="op" id="3176733">.</span><span class="ident" id="3176734">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176740">if</span>&nbsp;<span class="op" id="3176743">!</span><span class="ident" id="3176744">hasPort</span><span class="op" id="3176751">(</span><span class="ident" id="3176752">addr</span><span class="op" id="3176756">)</span>&nbsp;<span class="op" id="3176758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176762">return</span>&nbsp;<span class="ident" id="3176769">addr</span>&nbsp;<span class="op" id="3176774">+</span>&nbsp;<span class="string" id="3176776">&#34;:&#34;</span>&nbsp;<span class="op" id="3176780">+</span>&nbsp;<span class="ident" id="3176782">portMap</span><span class="op" id="3176789">[</span><span class="ident" id="3176790">url</span><span class="op" id="3176793">.</span><span class="ident" id="3176794">Scheme</span><span class="op" id="3176800">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3176803">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3176806">return</span>&nbsp;<span class="ident" id="3176813">addr</span><br>
<span class="lineno"></span><span class="op" id="3176818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3176821">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3176890">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3176959">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3177025">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3177090">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3177138">type</span>&nbsp;<span class="ident" id="3177143">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3177157">struct</span>&nbsp;<span class="op" id="3177164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177167">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3177180">io</span><span class="op" id="3177182">.</span><span class="ident" id="3177183">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177195">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3177208">sync</span><span class="op" id="3177212">.</span><span class="ident" id="3177213">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3177221">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177251">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3177264">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3177277">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177311">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3177324">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3177337">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177359">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3177372">func</span><span class="op" id="3177376">(</span><span class="builtintype" id="3177377">error</span><span class="op" id="3177382">)</span>&nbsp;&nbsp;<span class="comment" id="3177385">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177422">earlyCloseFn</span>&nbsp;<span class="keyword" id="3177435">func</span><span class="op" id="3177439">(</span><span class="op" id="3177440">)</span>&nbsp;<span class="builtintype" id="3177442">error</span>&nbsp;<span class="comment" id="3177448">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3177499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3177502">func</span>&nbsp;<span class="op" id="3177507">(</span><span class="ident" id="3177508">es</span>&nbsp;<span class="op" id="3177511">*</span><span class="ident" id="3177512">bodyEOFSignal</span><span class="op" id="3177525">)</span>&nbsp;<span class="ident" id="3177527">Read</span><span class="op" id="3177531">(</span><span class="ident" id="3177532">p</span>&nbsp;<span class="op" id="3177534">[</span><span class="op" id="3177535">]</span><span class="builtintype" id="3177536">byte</span><span class="op" id="3177540">)</span>&nbsp;<span class="op" id="3177542">(</span><span class="ident" id="3177543">n</span>&nbsp;<span class="builtintype" id="3177545">int</span><span class="op" id="3177548">,</span>&nbsp;<span class="ident" id="3177550">err</span>&nbsp;<span class="builtintype" id="3177554">error</span><span class="op" id="3177559">)</span>&nbsp;<span class="op" id="3177561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177564">es</span><span class="op" id="3177566">.</span><span class="ident" id="3177567">mu</span><span class="op" id="3177569">.</span><span class="ident" id="3177570">Lock</span><span class="op" id="3177574">(</span><span class="op" id="3177575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177578">closed</span><span class="op" id="3177584">,</span>&nbsp;<span class="ident" id="3177586">rerr</span>&nbsp;<span class="op" id="3177591">:=</span>&nbsp;<span class="ident" id="3177594">es</span><span class="op" id="3177596">.</span><span class="ident" id="3177597">closed</span><span class="op" id="3177603">,</span>&nbsp;<span class="ident" id="3177605">es</span><span class="op" id="3177607">.</span><span class="ident" id="3177608">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177614">es</span><span class="op" id="3177616">.</span><span class="ident" id="3177617">mu</span><span class="op" id="3177619">.</span><span class="ident" id="3177620">Unlock</span><span class="op" id="3177626">(</span><span class="op" id="3177627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177630">if</span>&nbsp;<span class="ident" id="3177633">closed</span>&nbsp;<span class="op" id="3177640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177644">return</span>&nbsp;<span class="num" id="3177651">0</span><span class="op" id="3177652">,</span>&nbsp;<span class="ident" id="3177654">errors</span><span class="op" id="3177660">.</span><span class="ident" id="3177661">New</span><span class="op" id="3177664">(</span><span class="string" id="3177665">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="3177701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177707">if</span>&nbsp;<span class="ident" id="3177710">rerr</span>&nbsp;<span class="op" id="3177715">!=</span>&nbsp;<span class="ident" id="3177718">nil</span>&nbsp;<span class="op" id="3177722">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177726">return</span>&nbsp;<span class="num" id="3177733">0</span><span class="op" id="3177734">,</span>&nbsp;<span class="ident" id="3177736">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177746">n</span><span class="op" id="3177747">,</span>&nbsp;<span class="ident" id="3177749">err</span>&nbsp;<span class="op" id="3177753">=</span>&nbsp;<span class="ident" id="3177755">es</span><span class="op" id="3177757">.</span><span class="ident" id="3177758">body</span><span class="op" id="3177762">.</span><span class="ident" id="3177763">Read</span><span class="op" id="3177767">(</span><span class="ident" id="3177768">p</span><span class="op" id="3177769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177772">if</span>&nbsp;<span class="ident" id="3177775">err</span>&nbsp;<span class="op" id="3177779">!=</span>&nbsp;<span class="ident" id="3177782">nil</span>&nbsp;<span class="op" id="3177786">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177790">es</span><span class="op" id="3177792">.</span><span class="ident" id="3177793">mu</span><span class="op" id="3177795">.</span><span class="ident" id="3177796">Lock</span><span class="op" id="3177800">(</span><span class="op" id="3177801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177805">defer</span>&nbsp;<span class="ident" id="3177811">es</span><span class="op" id="3177813">.</span><span class="ident" id="3177814">mu</span><span class="op" id="3177816">.</span><span class="ident" id="3177817">Unlock</span><span class="op" id="3177823">(</span><span class="op" id="3177824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177828">if</span>&nbsp;<span class="ident" id="3177831">es</span><span class="op" id="3177833">.</span><span class="ident" id="3177834">rerr</span>&nbsp;<span class="op" id="3177839">==</span>&nbsp;<span class="ident" id="3177842">nil</span>&nbsp;<span class="op" id="3177846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177851">es</span><span class="op" id="3177853">.</span><span class="ident" id="3177854">rerr</span>&nbsp;<span class="op" id="3177859">=</span>&nbsp;<span class="ident" id="3177861">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177867">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177871">es</span><span class="op" id="3177873">.</span><span class="ident" id="3177874">condfn</span><span class="op" id="3177880">(</span><span class="ident" id="3177881">err</span><span class="op" id="3177884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3177887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177890">return</span><br>
<span class="lineno"></span><span class="op" id="3177897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="3177900">func</span>&nbsp;<span class="op" id="3177905">(</span><span class="ident" id="3177906">es</span>&nbsp;<span class="op" id="3177909">*</span><span class="ident" id="3177910">bodyEOFSignal</span><span class="op" id="3177923">)</span>&nbsp;<span class="ident" id="3177925">Close</span><span class="op" id="3177930">(</span><span class="op" id="3177931">)</span>&nbsp;<span class="builtintype" id="3177933">error</span>&nbsp;<span class="op" id="3177939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3177942">es</span><span class="op" id="3177944">.</span><span class="ident" id="3177945">mu</span><span class="op" id="3177947">.</span><span class="ident" id="3177948">Lock</span><span class="op" id="3177952">(</span><span class="op" id="3177953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177956">defer</span>&nbsp;<span class="ident" id="3177962">es</span><span class="op" id="3177964">.</span><span class="ident" id="3177965">mu</span><span class="op" id="3177967">.</span><span class="ident" id="3177968">Unlock</span><span class="op" id="3177974">(</span><span class="op" id="3177975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177978">if</span>&nbsp;<span class="ident" id="3177981">es</span><span class="op" id="3177983">.</span><span class="ident" id="3177984">closed</span>&nbsp;<span class="op" id="3177991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3177995">return</span>&nbsp;<span class="ident" id="3178002">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178010">es</span><span class="op" id="3178012">.</span><span class="ident" id="3178013">closed</span>&nbsp;<span class="op" id="3178020">=</span>&nbsp;<span class="builtintype" id="3178022">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178028">if</span>&nbsp;<span class="ident" id="3178031">es</span><span class="op" id="3178033">.</span><span class="ident" id="3178034">earlyCloseFn</span>&nbsp;<span class="op" id="3178047">!=</span>&nbsp;<span class="ident" id="3178050">nil</span>&nbsp;<span class="op" id="3178054">&amp;&amp;</span>&nbsp;<span class="ident" id="3178057">es</span><span class="op" id="3178059">.</span><span class="ident" id="3178060">rerr</span>&nbsp;<span class="op" id="3178065">!=</span>&nbsp;<span class="ident" id="3178068">io</span><span class="op" id="3178070">.</span><span class="ident" id="3178071">EOF</span>&nbsp;<span class="op" id="3178075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178079">return</span>&nbsp;<span class="ident" id="3178086">es</span><span class="op" id="3178088">.</span><span class="ident" id="3178089">earlyCloseFn</span><span class="op" id="3178101">(</span><span class="op" id="3178102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178105">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178108">err</span>&nbsp;<span class="op" id="3178112">:=</span>&nbsp;<span class="ident" id="3178115">es</span><span class="op" id="3178117">.</span><span class="ident" id="3178118">body</span><span class="op" id="3178122">.</span><span class="ident" id="3178123">Close</span><span class="op" id="3178128">(</span><span class="op" id="3178129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178132">es</span><span class="op" id="3178134">.</span><span class="ident" id="3178135">condfn</span><span class="op" id="3178141">(</span><span class="ident" id="3178142">err</span><span class="op" id="3178145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178148">return</span>&nbsp;<span class="ident" id="3178155">err</span><br>
<span class="lineno"></span><span class="op" id="3178159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="3178162">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3178189">func</span>&nbsp;<span class="op" id="3178194">(</span><span class="ident" id="3178195">es</span>&nbsp;<span class="op" id="3178198">*</span><span class="ident" id="3178199">bodyEOFSignal</span><span class="op" id="3178212">)</span>&nbsp;<span class="ident" id="3178214">condfn</span><span class="op" id="3178220">(</span><span class="ident" id="3178221">err</span>&nbsp;<span class="builtintype" id="3178225">error</span><span class="op" id="3178230">)</span>&nbsp;<span class="op" id="3178232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178235">if</span>&nbsp;<span class="ident" id="3178238">es</span><span class="op" id="3178240">.</span><span class="ident" id="3178241">fn</span>&nbsp;<span class="op" id="3178244">==</span>&nbsp;<span class="ident" id="3178247">nil</span>&nbsp;<span class="op" id="3178251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178255">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178263">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178266">if</span>&nbsp;<span class="ident" id="3178269">err</span>&nbsp;<span class="op" id="3178273">==</span>&nbsp;<span class="ident" id="3178276">io</span><span class="op" id="3178278">.</span><span class="ident" id="3178279">EOF</span>&nbsp;<span class="op" id="3178283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178287">err</span>&nbsp;<span class="op" id="3178291">=</span>&nbsp;<span class="ident" id="3178293">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178301">es</span><span class="op" id="3178303">.</span><span class="ident" id="3178304">fn</span><span class="op" id="3178306">(</span><span class="ident" id="3178307">err</span><span class="op" id="3178310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178313">es</span><span class="op" id="3178315">.</span><span class="ident" id="3178316">fn</span>&nbsp;<span class="op" id="3178319">=</span>&nbsp;<span class="ident" id="3178321">nil</span><br>
<span class="lineno">1230</span><span class="op" id="3178325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3178328">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="3178381">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="3178430">type</span>&nbsp;<span class="ident" id="3178435">gzipReader</span>&nbsp;<span class="keyword" id="3178446">struct</span>&nbsp;<span class="op" id="3178453">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178456">body</span>&nbsp;<span class="ident" id="3178461">io</span><span class="op" id="3178463">.</span><span class="ident" id="3178464">ReadCloser</span>&nbsp;<span class="comment" id="3178475">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178504">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3178509">io</span><span class="op" id="3178511">.</span><span class="ident" id="3178512">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3178523">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="3178557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3178560">func</span>&nbsp;<span class="op" id="3178565">(</span><span class="ident" id="3178566">gz</span>&nbsp;<span class="op" id="3178569">*</span><span class="ident" id="3178570">gzipReader</span><span class="op" id="3178580">)</span>&nbsp;<span class="ident" id="3178582">Read</span><span class="op" id="3178586">(</span><span class="ident" id="3178587">p</span>&nbsp;<span class="op" id="3178589">[</span><span class="op" id="3178590">]</span><span class="builtintype" id="3178591">byte</span><span class="op" id="3178595">)</span>&nbsp;<span class="op" id="3178597">(</span><span class="ident" id="3178598">n</span>&nbsp;<span class="builtintype" id="3178600">int</span><span class="op" id="3178603">,</span>&nbsp;<span class="ident" id="3178605">err</span>&nbsp;<span class="builtintype" id="3178609">error</span><span class="op" id="3178614">)</span>&nbsp;<span class="op" id="3178616">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178619">if</span>&nbsp;<span class="ident" id="3178622">gz</span><span class="op" id="3178624">.</span><span class="ident" id="3178625">zr</span>&nbsp;<span class="op" id="3178628">==</span>&nbsp;<span class="ident" id="3178631">nil</span>&nbsp;<span class="op" id="3178635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178639">gz</span><span class="op" id="3178641">.</span><span class="ident" id="3178642">zr</span><span class="op" id="3178644">,</span>&nbsp;<span class="ident" id="3178646">err</span>&nbsp;<span class="op" id="3178650">=</span>&nbsp;<span class="ident" id="3178652">gzip</span><span class="op" id="3178656">.</span><span class="ident" id="3178657">NewReader</span><span class="op" id="3178666">(</span><span class="ident" id="3178667">gz</span><span class="op" id="3178669">.</span><span class="ident" id="3178670">body</span><span class="op" id="3178674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178678">if</span>&nbsp;<span class="ident" id="3178681">err</span>&nbsp;<span class="op" id="3178685">!=</span>&nbsp;<span class="ident" id="3178688">nil</span>&nbsp;<span class="op" id="3178692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178697">return</span>&nbsp;<span class="num" id="3178704">0</span><span class="op" id="3178705">,</span>&nbsp;<span class="ident" id="3178707">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178713">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3178716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178719">return</span>&nbsp;<span class="ident" id="3178726">gz</span><span class="op" id="3178728">.</span><span class="ident" id="3178729">zr</span><span class="op" id="3178731">.</span><span class="ident" id="3178732">Read</span><span class="op" id="3178736">(</span><span class="ident" id="3178737">p</span><span class="op" id="3178738">)</span><br>
<span class="lineno"></span><span class="op" id="3178740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3178743">func</span>&nbsp;<span class="op" id="3178748">(</span><span class="ident" id="3178749">gz</span>&nbsp;<span class="op" id="3178752">*</span><span class="ident" id="3178753">gzipReader</span><span class="op" id="3178763">)</span>&nbsp;<span class="ident" id="3178765">Close</span><span class="op" id="3178770">(</span><span class="op" id="3178771">)</span>&nbsp;<span class="builtintype" id="3178773">error</span>&nbsp;<span class="op" id="3178779">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3178782">return</span>&nbsp;<span class="ident" id="3178789">gz</span><span class="op" id="3178791">.</span><span class="ident" id="3178792">body</span><span class="op" id="3178796">.</span><span class="ident" id="3178797">Close</span><span class="op" id="3178802">(</span><span class="op" id="3178803">)</span><br>
<span class="lineno"></span><span class="op" id="3178805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3178808">type</span>&nbsp;<span class="ident" id="3178813">readerAndCloser</span>&nbsp;<span class="keyword" id="3178829">struct</span>&nbsp;<span class="op" id="3178836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178839">io</span><span class="op" id="3178841">.</span><span class="ident" id="3178842">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3178850">io</span><span class="op" id="3178852">.</span><span class="ident" id="3178853">Closer</span><br>
<span class="lineno"></span><span class="op" id="3178860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3178863">type</span>&nbsp;<span class="ident" id="3178868">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="3178893">struct</span><span class="op" id="3178899">{</span><span class="op" id="3178900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="3178903">func</span>&nbsp;<span class="op" id="3178908">(</span><span class="ident" id="3178909">tlsHandshakeTimeoutError</span><span class="op" id="3178933">)</span>&nbsp;<span class="ident" id="3178935">Timeout</span><span class="op" id="3178942">(</span><span class="op" id="3178943">)</span>&nbsp;<span class="builtintype" id="3178945">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3178952">{</span>&nbsp;<span class="keyword" id="3178954">return</span>&nbsp;<span class="builtintype" id="3178961">true</span>&nbsp;<span class="op" id="3178966">}</span><br>
<span class="lineno"></span><span class="keyword" id="3178968">func</span>&nbsp;<span class="op" id="3178973">(</span><span class="ident" id="3178974">tlsHandshakeTimeoutError</span><span class="op" id="3178998">)</span>&nbsp;<span class="ident" id="3179000">Temporary</span><span class="op" id="3179009">(</span><span class="op" id="3179010">)</span>&nbsp;<span class="builtintype" id="3179012">bool</span>&nbsp;<span class="op" id="3179017">{</span>&nbsp;<span class="keyword" id="3179019">return</span>&nbsp;<span class="builtintype" id="3179026">true</span>&nbsp;<span class="op" id="3179031">}</span><br>
<span class="lineno"></span><span class="keyword" id="3179033">func</span>&nbsp;<span class="op" id="3179038">(</span><span class="ident" id="3179039">tlsHandshakeTimeoutError</span><span class="op" id="3179063">)</span>&nbsp;<span class="ident" id="3179065">Error</span><span class="op" id="3179070">(</span><span class="op" id="3179071">)</span>&nbsp;<span class="builtintype" id="3179073">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3179082">{</span>&nbsp;<span class="keyword" id="3179084">return</span>&nbsp;<span class="string" id="3179091">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="3179125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3179128">type</span>&nbsp;<span class="ident" id="3179133">noteEOFReader</span>&nbsp;<span class="keyword" id="3179147">struct</span>&nbsp;<span class="op" id="3179154">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179157">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3179164">io</span><span class="op" id="3179166">.</span><span class="ident" id="3179167">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179175">sawEOF</span>&nbsp;<span class="op" id="3179182">*</span><span class="builtintype" id="3179183">bool</span><br>
<span class="lineno"></span><span class="op" id="3179188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3179191">func</span>&nbsp;<span class="op" id="3179196">(</span><span class="ident" id="3179197">nr</span>&nbsp;<span class="ident" id="3179200">noteEOFReader</span><span class="op" id="3179213">)</span>&nbsp;<span class="ident" id="3179215">Read</span><span class="op" id="3179219">(</span><span class="ident" id="3179220">p</span>&nbsp;<span class="op" id="3179222">[</span><span class="op" id="3179223">]</span><span class="builtintype" id="3179224">byte</span><span class="op" id="3179228">)</span>&nbsp;<span class="op" id="3179230">(</span><span class="ident" id="3179231">n</span>&nbsp;<span class="builtintype" id="3179233">int</span><span class="op" id="3179236">,</span>&nbsp;<span class="ident" id="3179238">err</span>&nbsp;<span class="builtintype" id="3179242">error</span><span class="op" id="3179247">)</span>&nbsp;<span class="op" id="3179249">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3179252">n</span><span class="op" id="3179253">,</span>&nbsp;<span class="ident" id="3179255">err</span>&nbsp;<span class="op" id="3179259">=</span>&nbsp;<span class="ident" id="3179261">nr</span><span class="op" id="3179263">.</span><span class="ident" id="3179264">r</span><span class="op" id="3179265">.</span><span class="ident" id="3179266">Read</span><span class="op" id="3179270">(</span><span class="ident" id="3179271">p</span><span class="op" id="3179272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179275">if</span>&nbsp;<span class="ident" id="3179278">err</span>&nbsp;<span class="op" id="3179282">==</span>&nbsp;<span class="ident" id="3179285">io</span><span class="op" id="3179287">.</span><span class="ident" id="3179288">EOF</span>&nbsp;<span class="op" id="3179292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179296">*</span><span class="ident" id="3179297">nr</span><span class="op" id="3179299">.</span><span class="ident" id="3179300">sawEOF</span>&nbsp;<span class="op" id="3179307">=</span>&nbsp;<span class="builtintype" id="3179309">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3179315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3179318">return</span><br>
<span class="lineno">1275</span><span class="op" id="3179325">}</span>
</div>
</body>
</html>
