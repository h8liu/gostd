<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1364854">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1364909">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1364963">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1365014">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1365087">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1365167">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1365242">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1365289">//</span><br>
<span class="lineno">10</span><span class="comment" id="1365292">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1365369">package</span>&nbsp;<span class="ident" id="1365377">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1365383">import</span>&nbsp;<span class="op" id="1365390">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1365393">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1365408">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1365417">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1365420">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1365459">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1365514">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1365566">type</span>&nbsp;<span class="ident" id="1365571">Mutex</span>&nbsp;<span class="keyword" id="1365577">struct</span>&nbsp;<span class="op" id="1365584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365587">state</span>&nbsp;<span class="builtintype" id="1365593">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365600">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1365606">uint32</span><br>
<span class="lineno"></span><span class="op" id="1365613">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1365616">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1365682">type</span>&nbsp;<span class="ident" id="1365687">Locker</span>&nbsp;<span class="keyword" id="1365694">interface</span>&nbsp;<span class="op" id="1365704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365707">Lock</span><span class="op" id="1365711">(</span><span class="op" id="1365712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365715">Unlock</span><span class="op" id="1365721">(</span><span class="op" id="1365722">)</span><br>
<span class="lineno">30</span><span class="op" id="1365724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1365727">const</span>&nbsp;<span class="op" id="1365733">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365736">mutexLocked</span>&nbsp;<span class="op" id="1365748">=</span>&nbsp;<span class="num" id="1365750">1</span>&nbsp;<span class="op" id="1365752">&lt;&lt;</span>&nbsp;<span class="ident" id="1365755">iota</span>&nbsp;<span class="comment" id="1365760">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365780">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365792">mutexWaiterShift</span>&nbsp;<span class="op" id="1365809">=</span>&nbsp;<span class="ident" id="1365811">iota</span><br>
<span class="lineno"></span><span class="op" id="1365816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1365819">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1365836">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1365892">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1365932">func</span>&nbsp;<span class="op" id="1365937">(</span><span class="ident" id="1365938">m</span>&nbsp;<span class="op" id="1365940">*</span><span class="ident" id="1365941">Mutex</span><span class="op" id="1365946">)</span>&nbsp;<span class="ident" id="1365948">Lock</span><span class="op" id="1365952">(</span><span class="op" id="1365953">)</span>&nbsp;<span class="op" id="1365955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1365958">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365994">if</span>&nbsp;<span class="ident" id="1365997">atomic</span><span class="op" id="1366003">.</span><span class="ident" id="1366004">CompareAndSwapInt32</span><span class="op" id="1366023">(</span><span class="op" id="1366024">&amp;</span><span class="ident" id="1366025">m</span><span class="op" id="1366026">.</span><span class="ident" id="1366027">state</span><span class="op" id="1366032">,</span>&nbsp;<span class="num" id="1366034">0</span><span class="op" id="1366035">,</span>&nbsp;<span class="ident" id="1366037">mutexLocked</span><span class="op" id="1366048">)</span>&nbsp;<span class="op" id="1366050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366054">if</span>&nbsp;<span class="ident" id="1366057">raceenabled</span>&nbsp;<span class="op" id="1366069">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366074">raceAcquire</span><span class="op" id="1366085">(</span><span class="ident" id="1366086">unsafe</span><span class="op" id="1366092">.</span><span class="ident" id="1366093">Pointer</span><span class="op" id="1366100">(</span><span class="ident" id="1366101">m</span><span class="op" id="1366102">)</span><span class="op" id="1366103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366111">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366123">awoke</span>&nbsp;<span class="op" id="1366129">:=</span>&nbsp;<span class="builtintype" id="1366132">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366139">for</span>&nbsp;<span class="op" id="1366143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366147">old</span>&nbsp;<span class="op" id="1366151">:=</span>&nbsp;<span class="ident" id="1366154">m</span><span class="op" id="1366155">.</span><span class="ident" id="1366156">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1366164">new</span>&nbsp;<span class="op" id="1366168">:=</span>&nbsp;<span class="ident" id="1366171">old</span>&nbsp;<span class="op" id="1366175">|</span>&nbsp;<span class="ident" id="1366177">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366191">if</span>&nbsp;<span class="ident" id="1366194">old</span><span class="op" id="1366197">&amp;</span><span class="ident" id="1366198">mutexLocked</span>&nbsp;<span class="op" id="1366210">!=</span>&nbsp;<span class="num" id="1366213">0</span>&nbsp;<span class="op" id="1366215">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1366220">new</span>&nbsp;<span class="op" id="1366224">=</span>&nbsp;<span class="ident" id="1366226">old</span>&nbsp;<span class="op" id="1366230">+</span>&nbsp;<span class="num" id="1366232">1</span><span class="op" id="1366233">&lt;&lt;</span><span class="ident" id="1366235">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366258">if</span>&nbsp;<span class="ident" id="1366261">awoke</span>&nbsp;<span class="op" id="1366267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1366272">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1366319">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1366370">new</span>&nbsp;<span class="op" id="1366374">&amp;^=</span>&nbsp;<span class="ident" id="1366378">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366395">if</span>&nbsp;<span class="ident" id="1366398">atomic</span><span class="op" id="1366404">.</span><span class="ident" id="1366405">CompareAndSwapInt32</span><span class="op" id="1366424">(</span><span class="op" id="1366425">&amp;</span><span class="ident" id="1366426">m</span><span class="op" id="1366427">.</span><span class="ident" id="1366428">state</span><span class="op" id="1366433">,</span>&nbsp;<span class="ident" id="1366435">old</span><span class="op" id="1366438">,</span>&nbsp;<span class="builtinfunc" id="1366440">new</span><span class="op" id="1366443">)</span>&nbsp;<span class="op" id="1366445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366450">if</span>&nbsp;<span class="ident" id="1366453">old</span><span class="op" id="1366456">&amp;</span><span class="ident" id="1366457">mutexLocked</span>&nbsp;<span class="op" id="1366469">==</span>&nbsp;<span class="num" id="1366472">0</span>&nbsp;<span class="op" id="1366474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366480">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366494">runtime_Semacquire</span><span class="op" id="1366512">(</span><span class="op" id="1366513">&amp;</span><span class="ident" id="1366514">m</span><span class="op" id="1366515">.</span><span class="ident" id="1366516">sema</span><span class="op" id="1366520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366525">awoke</span>&nbsp;<span class="op" id="1366531">=</span>&nbsp;<span class="builtintype" id="1366533">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366543">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366547">if</span>&nbsp;<span class="ident" id="1366550">raceenabled</span>&nbsp;<span class="op" id="1366562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366566">raceAcquire</span><span class="op" id="1366577">(</span><span class="ident" id="1366578">unsafe</span><span class="op" id="1366584">.</span><span class="ident" id="1366585">Pointer</span><span class="op" id="1366592">(</span><span class="ident" id="1366593">m</span><span class="op" id="1366594">)</span><span class="op" id="1366595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366598">}</span><br>
<span class="lineno"></span><span class="op" id="1366600">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1366603">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1366624">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1366689">//</span><br>
<span class="lineno"></span><span class="comment" id="1366692">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1366757">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1366817">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1366864">func</span>&nbsp;<span class="op" id="1366869">(</span><span class="ident" id="1366870">m</span>&nbsp;<span class="op" id="1366872">*</span><span class="ident" id="1366873">Mutex</span><span class="op" id="1366878">)</span>&nbsp;<span class="ident" id="1366880">Unlock</span><span class="op" id="1366886">(</span><span class="op" id="1366887">)</span>&nbsp;<span class="op" id="1366889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366892">if</span>&nbsp;<span class="ident" id="1366895">raceenabled</span>&nbsp;<span class="op" id="1366907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366911">_</span>&nbsp;<span class="op" id="1366913">=</span>&nbsp;<span class="ident" id="1366915">m</span><span class="op" id="1366916">.</span><span class="ident" id="1366917">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366925">raceRelease</span><span class="op" id="1366936">(</span><span class="ident" id="1366937">unsafe</span><span class="op" id="1366943">.</span><span class="ident" id="1366944">Pointer</span><span class="op" id="1366951">(</span><span class="ident" id="1366952">m</span><span class="op" id="1366953">)</span><span class="op" id="1366954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1366961">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1366991">new</span>&nbsp;<span class="op" id="1366995">:=</span>&nbsp;<span class="ident" id="1366998">atomic</span><span class="op" id="1367004">.</span><span class="ident" id="1367005">AddInt32</span><span class="op" id="1367013">(</span><span class="op" id="1367014">&amp;</span><span class="ident" id="1367015">m</span><span class="op" id="1367016">.</span><span class="ident" id="1367017">state</span><span class="op" id="1367022">,</span>&nbsp;<span class="op" id="1367024">-</span><span class="ident" id="1367025">mutexLocked</span><span class="op" id="1367036">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367039">if</span>&nbsp;<span class="op" id="1367042">(</span><span class="builtinfunc" id="1367043">new</span><span class="op" id="1367046">+</span><span class="ident" id="1367047">mutexLocked</span><span class="op" id="1367058">)</span><span class="op" id="1367059">&amp;</span><span class="ident" id="1367060">mutexLocked</span>&nbsp;<span class="op" id="1367072">==</span>&nbsp;<span class="num" id="1367075">0</span>&nbsp;<span class="op" id="1367077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1367081">panic</span><span class="op" id="1367086">(</span><span class="string" id="1367087">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1367119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367126">old</span>&nbsp;<span class="op" id="1367130">:=</span>&nbsp;<span class="builtinfunc" id="1367133">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367138">for</span>&nbsp;<span class="op" id="1367142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367146">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367202">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367263">if</span>&nbsp;<span class="ident" id="1367266">old</span><span class="op" id="1367269">&gt;&gt;</span><span class="ident" id="1367271">mutexWaiterShift</span>&nbsp;<span class="op" id="1367288">==</span>&nbsp;<span class="num" id="1367291">0</span>&nbsp;<span class="op" id="1367293">||</span>&nbsp;<span class="ident" id="1367296">old</span><span class="op" id="1367299">&amp;</span><span class="op" id="1367300">(</span><span class="ident" id="1367301">mutexLocked</span><span class="op" id="1367312">|</span><span class="ident" id="1367313">mutexWoken</span><span class="op" id="1367323">)</span>&nbsp;<span class="op" id="1367325">!=</span>&nbsp;<span class="num" id="1367328">0</span>&nbsp;<span class="op" id="1367330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367335">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367348">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1367385">new</span>&nbsp;<span class="op" id="1367389">=</span>&nbsp;<span class="op" id="1367391">(</span><span class="ident" id="1367392">old</span>&nbsp;<span class="op" id="1367396">-</span>&nbsp;<span class="num" id="1367398">1</span><span class="op" id="1367399">&lt;&lt;</span><span class="ident" id="1367401">mutexWaiterShift</span><span class="op" id="1367417">)</span>&nbsp;<span class="op" id="1367419">|</span>&nbsp;<span class="ident" id="1367421">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367434">if</span>&nbsp;<span class="ident" id="1367437">atomic</span><span class="op" id="1367443">.</span><span class="ident" id="1367444">CompareAndSwapInt32</span><span class="op" id="1367463">(</span><span class="op" id="1367464">&amp;</span><span class="ident" id="1367465">m</span><span class="op" id="1367466">.</span><span class="ident" id="1367467">state</span><span class="op" id="1367472">,</span>&nbsp;<span class="ident" id="1367474">old</span><span class="op" id="1367477">,</span>&nbsp;<span class="builtinfunc" id="1367479">new</span><span class="op" id="1367482">)</span>&nbsp;<span class="op" id="1367484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367489">runtime_Semrelease</span><span class="op" id="1367507">(</span><span class="op" id="1367508">&amp;</span><span class="ident" id="1367509">m</span><span class="op" id="1367510">.</span><span class="ident" id="1367511">sema</span><span class="op" id="1367515">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367520">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367533">old</span>&nbsp;<span class="op" id="1367537">=</span>&nbsp;<span class="ident" id="1367539">m</span><span class="op" id="1367540">.</span><span class="ident" id="1367541">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367548">}</span><br>
<span class="lineno"></span><span class="op" id="1367550">}</span>
</div>
</body>
</html>
