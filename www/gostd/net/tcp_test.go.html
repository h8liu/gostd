<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html" class="current">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6761041">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6761096">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6761150">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6761201">package</span>&nbsp;<span class="ident" id="6761209">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6761214">import</span>&nbsp;<span class="op" id="6761221">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761224">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761231">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761237">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761248">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761259">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761267">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6761278">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6761285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6761288">func</span>&nbsp;<span class="ident" id="6761293">BenchmarkTCP4OneShot</span><span class="op" id="6761313">(</span><span class="ident" id="6761314">b</span>&nbsp;<span class="op" id="6761316">*</span><span class="ident" id="6761317">testing</span><span class="op" id="6761324">.</span><span class="ident" id="6761325">B</span><span class="op" id="6761326">)</span>&nbsp;<span class="op" id="6761328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761331">benchmarkTCP</span><span class="op" id="6761343">(</span><span class="ident" id="6761344">b</span><span class="op" id="6761345">,</span>&nbsp;<span class="builtintype" id="6761347">false</span><span class="op" id="6761352">,</span>&nbsp;<span class="builtintype" id="6761354">false</span><span class="op" id="6761359">,</span>&nbsp;<span class="string" id="6761361">&#34;127.0.0.1:0&#34;</span><span class="op" id="6761374">)</span><br>
<span class="lineno"></span><span class="op" id="6761376">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6761379">func</span>&nbsp;<span class="ident" id="6761384">BenchmarkTCP4OneShotTimeout</span><span class="op" id="6761411">(</span><span class="ident" id="6761412">b</span>&nbsp;<span class="op" id="6761414">*</span><span class="ident" id="6761415">testing</span><span class="op" id="6761422">.</span><span class="ident" id="6761423">B</span><span class="op" id="6761424">)</span>&nbsp;<span class="op" id="6761426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761429">benchmarkTCP</span><span class="op" id="6761441">(</span><span class="ident" id="6761442">b</span><span class="op" id="6761443">,</span>&nbsp;<span class="builtintype" id="6761445">false</span><span class="op" id="6761450">,</span>&nbsp;<span class="builtintype" id="6761452">true</span><span class="op" id="6761456">,</span>&nbsp;<span class="string" id="6761458">&#34;127.0.0.1:0&#34;</span><span class="op" id="6761471">)</span><br>
<span class="lineno"></span><span class="op" id="6761473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6761476">func</span>&nbsp;<span class="ident" id="6761481">BenchmarkTCP4Persistent</span><span class="op" id="6761504">(</span><span class="ident" id="6761505">b</span>&nbsp;<span class="op" id="6761507">*</span><span class="ident" id="6761508">testing</span><span class="op" id="6761515">.</span><span class="ident" id="6761516">B</span><span class="op" id="6761517">)</span>&nbsp;<span class="op" id="6761519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761522">benchmarkTCP</span><span class="op" id="6761534">(</span><span class="ident" id="6761535">b</span><span class="op" id="6761536">,</span>&nbsp;<span class="builtintype" id="6761538">true</span><span class="op" id="6761542">,</span>&nbsp;<span class="builtintype" id="6761544">false</span><span class="op" id="6761549">,</span>&nbsp;<span class="string" id="6761551">&#34;127.0.0.1:0&#34;</span><span class="op" id="6761564">)</span><br>
<span class="lineno"></span><span class="op" id="6761566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6761569">func</span>&nbsp;<span class="ident" id="6761574">BenchmarkTCP4PersistentTimeout</span><span class="op" id="6761604">(</span><span class="ident" id="6761605">b</span>&nbsp;<span class="op" id="6761607">*</span><span class="ident" id="6761608">testing</span><span class="op" id="6761615">.</span><span class="ident" id="6761616">B</span><span class="op" id="6761617">)</span>&nbsp;<span class="op" id="6761619">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761622">benchmarkTCP</span><span class="op" id="6761634">(</span><span class="ident" id="6761635">b</span><span class="op" id="6761636">,</span>&nbsp;<span class="builtintype" id="6761638">true</span><span class="op" id="6761642">,</span>&nbsp;<span class="builtintype" id="6761644">true</span><span class="op" id="6761648">,</span>&nbsp;<span class="string" id="6761650">&#34;127.0.0.1:0&#34;</span><span class="op" id="6761663">)</span><br>
<span class="lineno"></span><span class="op" id="6761665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6761668">func</span>&nbsp;<span class="ident" id="6761673">BenchmarkTCP6OneShot</span><span class="op" id="6761693">(</span><span class="ident" id="6761694">b</span>&nbsp;<span class="op" id="6761696">*</span><span class="ident" id="6761697">testing</span><span class="op" id="6761704">.</span><span class="ident" id="6761705">B</span><span class="op" id="6761706">)</span>&nbsp;<span class="op" id="6761708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6761711">if</span>&nbsp;<span class="op" id="6761714">!</span><span class="ident" id="6761715">supportsIPv6</span>&nbsp;<span class="op" id="6761728">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761732">b</span><span class="op" id="6761733">.</span><span class="ident" id="6761734">Skip</span><span class="op" id="6761738">(</span><span class="string" id="6761739">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6761762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6761765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761768">benchmarkTCP</span><span class="op" id="6761780">(</span><span class="ident" id="6761781">b</span><span class="op" id="6761782">,</span>&nbsp;<span class="builtintype" id="6761784">false</span><span class="op" id="6761789">,</span>&nbsp;<span class="builtintype" id="6761791">false</span><span class="op" id="6761796">,</span>&nbsp;<span class="string" id="6761798">&#34;[::1]:0&#34;</span><span class="op" id="6761807">)</span><br>
<span class="lineno"></span><span class="op" id="6761809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6761812">func</span>&nbsp;<span class="ident" id="6761817">BenchmarkTCP6OneShotTimeout</span><span class="op" id="6761844">(</span><span class="ident" id="6761845">b</span>&nbsp;<span class="op" id="6761847">*</span><span class="ident" id="6761848">testing</span><span class="op" id="6761855">.</span><span class="ident" id="6761856">B</span><span class="op" id="6761857">)</span>&nbsp;<span class="op" id="6761859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6761862">if</span>&nbsp;<span class="op" id="6761865">!</span><span class="ident" id="6761866">supportsIPv6</span>&nbsp;<span class="op" id="6761879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761883">b</span><span class="op" id="6761884">.</span><span class="ident" id="6761885">Skip</span><span class="op" id="6761889">(</span><span class="string" id="6761890">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6761913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6761916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6761919">benchmarkTCP</span><span class="op" id="6761931">(</span><span class="ident" id="6761932">b</span><span class="op" id="6761933">,</span>&nbsp;<span class="builtintype" id="6761935">false</span><span class="op" id="6761940">,</span>&nbsp;<span class="builtintype" id="6761942">true</span><span class="op" id="6761946">,</span>&nbsp;<span class="string" id="6761948">&#34;[::1]:0&#34;</span><span class="op" id="6761957">)</span><br>
<span class="lineno">45</span><span class="op" id="6761959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6761962">func</span>&nbsp;<span class="ident" id="6761967">BenchmarkTCP6Persistent</span><span class="op" id="6761990">(</span><span class="ident" id="6761991">b</span>&nbsp;<span class="op" id="6761993">*</span><span class="ident" id="6761994">testing</span><span class="op" id="6762001">.</span><span class="ident" id="6762002">B</span><span class="op" id="6762003">)</span>&nbsp;<span class="op" id="6762005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762008">if</span>&nbsp;<span class="op" id="6762011">!</span><span class="ident" id="6762012">supportsIPv6</span>&nbsp;<span class="op" id="6762025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762029">b</span><span class="op" id="6762030">.</span><span class="ident" id="6762031">Skip</span><span class="op" id="6762035">(</span><span class="string" id="6762036">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6762059">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762065">benchmarkTCP</span><span class="op" id="6762077">(</span><span class="ident" id="6762078">b</span><span class="op" id="6762079">,</span>&nbsp;<span class="builtintype" id="6762081">true</span><span class="op" id="6762085">,</span>&nbsp;<span class="builtintype" id="6762087">false</span><span class="op" id="6762092">,</span>&nbsp;<span class="string" id="6762094">&#34;[::1]:0&#34;</span><span class="op" id="6762103">)</span><br>
<span class="lineno"></span><span class="op" id="6762105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6762108">func</span>&nbsp;<span class="ident" id="6762113">BenchmarkTCP6PersistentTimeout</span><span class="op" id="6762143">(</span><span class="ident" id="6762144">b</span>&nbsp;<span class="op" id="6762146">*</span><span class="ident" id="6762147">testing</span><span class="op" id="6762154">.</span><span class="ident" id="6762155">B</span><span class="op" id="6762156">)</span>&nbsp;<span class="op" id="6762158">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762161">if</span>&nbsp;<span class="op" id="6762164">!</span><span class="ident" id="6762165">supportsIPv6</span>&nbsp;<span class="op" id="6762178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762182">b</span><span class="op" id="6762183">.</span><span class="ident" id="6762184">Skip</span><span class="op" id="6762188">(</span><span class="string" id="6762189">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6762212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762218">benchmarkTCP</span><span class="op" id="6762230">(</span><span class="ident" id="6762231">b</span><span class="op" id="6762232">,</span>&nbsp;<span class="builtintype" id="6762234">true</span><span class="op" id="6762238">,</span>&nbsp;<span class="builtintype" id="6762240">true</span><span class="op" id="6762244">,</span>&nbsp;<span class="string" id="6762246">&#34;[::1]:0&#34;</span><span class="op" id="6762255">)</span><br>
<span class="lineno"></span><span class="op" id="6762257">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6762260">func</span>&nbsp;<span class="ident" id="6762265">benchmarkTCP</span><span class="op" id="6762277">(</span><span class="ident" id="6762278">b</span>&nbsp;<span class="op" id="6762280">*</span><span class="ident" id="6762281">testing</span><span class="op" id="6762288">.</span><span class="ident" id="6762289">B</span><span class="op" id="6762290">,</span>&nbsp;<span class="ident" id="6762292">persistent</span><span class="op" id="6762302">,</span>&nbsp;<span class="ident" id="6762304">timeout</span>&nbsp;<span class="builtintype" id="6762312">bool</span><span class="op" id="6762316">,</span>&nbsp;<span class="ident" id="6762318">laddr</span>&nbsp;<span class="builtintype" id="6762324">string</span><span class="op" id="6762330">)</span>&nbsp;<span class="op" id="6762332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762335">const</span>&nbsp;<span class="ident" id="6762341">msgLen</span>&nbsp;<span class="op" id="6762348">=</span>&nbsp;<span class="num" id="6762350">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762355">conns</span>&nbsp;<span class="op" id="6762361">:=</span>&nbsp;<span class="ident" id="6762364">b</span><span class="op" id="6762365">.</span><span class="ident" id="6762366">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762369">numConcurrent</span>&nbsp;<span class="op" id="6762383">:=</span>&nbsp;<span class="ident" id="6762386">runtime</span><span class="op" id="6762393">.</span><span class="ident" id="6762394">GOMAXPROCS</span><span class="op" id="6762404">(</span><span class="op" id="6762405">-</span><span class="num" id="6762406">1</span><span class="op" id="6762407">)</span>&nbsp;<span class="op" id="6762409">*</span>&nbsp;<span class="num" id="6762411">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762414">msgs</span>&nbsp;<span class="op" id="6762419">:=</span>&nbsp;<span class="num" id="6762422">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762425">if</span>&nbsp;<span class="ident" id="6762428">persistent</span>&nbsp;<span class="op" id="6762439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762443">conns</span>&nbsp;<span class="op" id="6762449">=</span>&nbsp;<span class="ident" id="6762451">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762467">msgs</span>&nbsp;<span class="op" id="6762472">=</span>&nbsp;<span class="ident" id="6762474">b</span><span class="op" id="6762475">.</span><span class="ident" id="6762476">N</span>&nbsp;<span class="op" id="6762478">/</span>&nbsp;<span class="ident" id="6762480">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762488">if</span>&nbsp;<span class="ident" id="6762491">msgs</span>&nbsp;<span class="op" id="6762496">==</span>&nbsp;<span class="num" id="6762499">0</span>&nbsp;<span class="op" id="6762501">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762506">msgs</span>&nbsp;<span class="op" id="6762511">=</span>&nbsp;<span class="num" id="6762513">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762521">if</span>&nbsp;<span class="ident" id="6762524">conns</span>&nbsp;<span class="op" id="6762530">&gt;</span>&nbsp;<span class="ident" id="6762532">b</span><span class="op" id="6762533">.</span><span class="ident" id="6762534">N</span>&nbsp;<span class="op" id="6762536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762541">conns</span>&nbsp;<span class="op" id="6762547">=</span>&nbsp;<span class="ident" id="6762549">b</span><span class="op" id="6762550">.</span><span class="ident" id="6762551">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762555">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762561">sendMsg</span>&nbsp;<span class="op" id="6762569">:=</span>&nbsp;<span class="keyword" id="6762572">func</span><span class="op" id="6762576">(</span><span class="ident" id="6762577">c</span>&nbsp;<span class="ident" id="6762579">Conn</span><span class="op" id="6762583">,</span>&nbsp;<span class="ident" id="6762585">buf</span>&nbsp;<span class="op" id="6762589">[</span><span class="op" id="6762590">]</span><span class="builtintype" id="6762591">byte</span><span class="op" id="6762595">)</span>&nbsp;<span class="builtintype" id="6762597">bool</span>&nbsp;<span class="op" id="6762602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762606">n</span><span class="op" id="6762607">,</span>&nbsp;<span class="ident" id="6762609">err</span>&nbsp;<span class="op" id="6762613">:=</span>&nbsp;<span class="ident" id="6762616">c</span><span class="op" id="6762617">.</span><span class="ident" id="6762618">Write</span><span class="op" id="6762623">(</span><span class="ident" id="6762624">buf</span><span class="op" id="6762627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762631">if</span>&nbsp;<span class="ident" id="6762634">n</span>&nbsp;<span class="op" id="6762636">!=</span>&nbsp;<span class="builtinfunc" id="6762639">len</span><span class="op" id="6762642">(</span><span class="ident" id="6762643">buf</span><span class="op" id="6762646">)</span>&nbsp;<span class="op" id="6762648">||</span>&nbsp;<span class="ident" id="6762651">err</span>&nbsp;<span class="op" id="6762655">!=</span>&nbsp;<span class="builtintype" id="6762658">nil</span>&nbsp;<span class="op" id="6762662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762667">b</span><span class="op" id="6762668">.</span><span class="ident" id="6762669">Logf</span><span class="op" id="6762673">(</span><span class="string" id="6762674">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6762692">,</span>&nbsp;<span class="ident" id="6762694">err</span><span class="op" id="6762697">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762702">return</span>&nbsp;<span class="builtintype" id="6762709">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762721">return</span>&nbsp;<span class="builtintype" id="6762728">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762737">recvMsg</span>&nbsp;<span class="op" id="6762745">:=</span>&nbsp;<span class="keyword" id="6762748">func</span><span class="op" id="6762752">(</span><span class="ident" id="6762753">c</span>&nbsp;<span class="ident" id="6762755">Conn</span><span class="op" id="6762759">,</span>&nbsp;<span class="ident" id="6762761">buf</span>&nbsp;<span class="op" id="6762765">[</span><span class="op" id="6762766">]</span><span class="builtintype" id="6762767">byte</span><span class="op" id="6762771">)</span>&nbsp;<span class="builtintype" id="6762773">bool</span>&nbsp;<span class="op" id="6762778">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762782">for</span>&nbsp;<span class="ident" id="6762786">read</span>&nbsp;<span class="op" id="6762791">:=</span>&nbsp;<span class="num" id="6762794">0</span><span class="op" id="6762795">;</span>&nbsp;<span class="ident" id="6762797">read</span>&nbsp;<span class="op" id="6762802">!=</span>&nbsp;<span class="builtinfunc" id="6762805">len</span><span class="op" id="6762808">(</span><span class="ident" id="6762809">buf</span><span class="op" id="6762812">)</span><span class="op" id="6762813">;</span>&nbsp;<span class="op" id="6762815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762820">n</span><span class="op" id="6762821">,</span>&nbsp;<span class="ident" id="6762823">err</span>&nbsp;<span class="op" id="6762827">:=</span>&nbsp;<span class="ident" id="6762830">c</span><span class="op" id="6762831">.</span><span class="ident" id="6762832">Read</span><span class="op" id="6762836">(</span><span class="ident" id="6762837">buf</span><span class="op" id="6762840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762845">read</span>&nbsp;<span class="op" id="6762850">+=</span>&nbsp;<span class="ident" id="6762853">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762858">if</span>&nbsp;<span class="ident" id="6762861">err</span>&nbsp;<span class="op" id="6762865">!=</span>&nbsp;<span class="builtintype" id="6762868">nil</span>&nbsp;<span class="op" id="6762872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762878">b</span><span class="op" id="6762879">.</span><span class="ident" id="6762880">Logf</span><span class="op" id="6762884">(</span><span class="string" id="6762885">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6762902">,</span>&nbsp;<span class="ident" id="6762904">err</span><span class="op" id="6762907">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762913">return</span>&nbsp;<span class="builtintype" id="6762920">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762937">return</span>&nbsp;<span class="builtintype" id="6762944">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6762950">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6762953">ln</span><span class="op" id="6762955">,</span>&nbsp;<span class="ident" id="6762957">err</span>&nbsp;<span class="op" id="6762961">:=</span>&nbsp;<span class="ident" id="6762964">Listen</span><span class="op" id="6762970">(</span><span class="string" id="6762971">&#34;tcp&#34;</span><span class="op" id="6762976">,</span>&nbsp;<span class="ident" id="6762978">laddr</span><span class="op" id="6762983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6762986">if</span>&nbsp;<span class="ident" id="6762989">err</span>&nbsp;<span class="op" id="6762993">!=</span>&nbsp;<span class="builtintype" id="6762996">nil</span>&nbsp;<span class="op" id="6763000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763004">b</span><span class="op" id="6763005">.</span><span class="ident" id="6763006">Fatalf</span><span class="op" id="6763012">(</span><span class="string" id="6763013">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6763032">,</span>&nbsp;<span class="ident" id="6763034">err</span><span class="op" id="6763037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763043">defer</span>&nbsp;<span class="ident" id="6763049">ln</span><span class="op" id="6763051">.</span><span class="ident" id="6763052">Close</span><span class="op" id="6763057">(</span><span class="op" id="6763058">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763061">serverSem</span>&nbsp;<span class="op" id="6763071">:=</span>&nbsp;<span class="builtinfunc" id="6763074">make</span><span class="op" id="6763078">(</span><span class="keyword" id="6763079">chan</span>&nbsp;<span class="builtintype" id="6763084">bool</span><span class="op" id="6763088">,</span>&nbsp;<span class="ident" id="6763090">numConcurrent</span><span class="op" id="6763103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6763106">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763120">go</span>&nbsp;<span class="keyword" id="6763123">func</span><span class="op" id="6763127">(</span><span class="op" id="6763128">)</span>&nbsp;<span class="op" id="6763130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763134">for</span>&nbsp;<span class="op" id="6763138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763143">c</span><span class="op" id="6763144">,</span>&nbsp;<span class="ident" id="6763146">err</span>&nbsp;<span class="op" id="6763150">:=</span>&nbsp;<span class="ident" id="6763153">ln</span><span class="op" id="6763155">.</span><span class="ident" id="6763156">Accept</span><span class="op" id="6763162">(</span><span class="op" id="6763163">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763168">if</span>&nbsp;<span class="ident" id="6763171">err</span>&nbsp;<span class="op" id="6763175">!=</span>&nbsp;<span class="builtintype" id="6763178">nil</span>&nbsp;<span class="op" id="6763182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763202">serverSem</span>&nbsp;<span class="op" id="6763212">&lt;-</span>&nbsp;<span class="builtintype" id="6763215">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6763223">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763248">go</span>&nbsp;<span class="keyword" id="6763251">func</span><span class="op" id="6763255">(</span><span class="ident" id="6763256">c</span>&nbsp;<span class="ident" id="6763258">Conn</span><span class="op" id="6763262">)</span>&nbsp;<span class="op" id="6763264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763270">defer</span>&nbsp;<span class="keyword" id="6763276">func</span><span class="op" id="6763280">(</span><span class="op" id="6763281">)</span>&nbsp;<span class="op" id="6763283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763290">c</span><span class="op" id="6763291">.</span><span class="ident" id="6763292">Close</span><span class="op" id="6763297">(</span><span class="op" id="6763298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763305">&lt;-</span><span class="ident" id="6763307">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763321">}</span><span class="op" id="6763322">(</span><span class="op" id="6763323">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763329">if</span>&nbsp;<span class="ident" id="6763332">timeout</span>&nbsp;<span class="op" id="6763340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763347">c</span><span class="op" id="6763348">.</span><span class="ident" id="6763349">SetDeadline</span><span class="op" id="6763360">(</span><span class="ident" id="6763361">time</span><span class="op" id="6763365">.</span><span class="ident" id="6763366">Now</span><span class="op" id="6763369">(</span><span class="op" id="6763370">)</span><span class="op" id="6763371">.</span><span class="ident" id="6763372">Add</span><span class="op" id="6763375">(</span><span class="ident" id="6763376">time</span><span class="op" id="6763380">.</span><span class="ident" id="6763381">Hour</span><span class="op" id="6763385">)</span><span class="op" id="6763386">)</span>&nbsp;<span class="comment" id="6763388">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763423">var</span>&nbsp;<span class="ident" id="6763427">buf</span>&nbsp;<span class="op" id="6763431">[</span><span class="ident" id="6763432">msgLen</span><span class="op" id="6763438">]</span><span class="builtintype" id="6763439">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763448">for</span>&nbsp;<span class="ident" id="6763452">m</span>&nbsp;<span class="op" id="6763454">:=</span>&nbsp;<span class="num" id="6763457">0</span><span class="op" id="6763458">;</span>&nbsp;<span class="ident" id="6763460">m</span>&nbsp;<span class="op" id="6763462">&lt;</span>&nbsp;<span class="ident" id="6763464">msgs</span><span class="op" id="6763468">;</span>&nbsp;<span class="ident" id="6763470">m</span><span class="op" id="6763471">++</span>&nbsp;<span class="op" id="6763474">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763481">if</span>&nbsp;<span class="op" id="6763484">!</span><span class="ident" id="6763485">recvMsg</span><span class="op" id="6763492">(</span><span class="ident" id="6763493">c</span><span class="op" id="6763494">,</span>&nbsp;<span class="ident" id="6763496">buf</span><span class="op" id="6763499">[</span><span class="op" id="6763500">:</span><span class="op" id="6763501">]</span><span class="op" id="6763502">)</span>&nbsp;<span class="op" id="6763504">||</span>&nbsp;<span class="op" id="6763507">!</span><span class="ident" id="6763508">sendMsg</span><span class="op" id="6763515">(</span><span class="ident" id="6763516">c</span><span class="op" id="6763517">,</span>&nbsp;<span class="ident" id="6763519">buf</span><span class="op" id="6763522">[</span><span class="op" id="6763523">:</span><span class="op" id="6763524">]</span><span class="op" id="6763525">)</span>&nbsp;<span class="op" id="6763527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763535">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763557">}</span><span class="op" id="6763558">(</span><span class="ident" id="6763559">c</span><span class="op" id="6763560">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763567">}</span><span class="op" id="6763568">(</span><span class="op" id="6763569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763572">clientSem</span>&nbsp;<span class="op" id="6763582">:=</span>&nbsp;<span class="builtinfunc" id="6763585">make</span><span class="op" id="6763589">(</span><span class="keyword" id="6763590">chan</span>&nbsp;<span class="builtintype" id="6763595">bool</span><span class="op" id="6763599">,</span>&nbsp;<span class="ident" id="6763601">numConcurrent</span><span class="op" id="6763614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763617">for</span>&nbsp;<span class="ident" id="6763621">i</span>&nbsp;<span class="op" id="6763623">:=</span>&nbsp;<span class="num" id="6763626">0</span><span class="op" id="6763627">;</span>&nbsp;<span class="ident" id="6763629">i</span>&nbsp;<span class="op" id="6763631">&lt;</span>&nbsp;<span class="ident" id="6763633">conns</span><span class="op" id="6763638">;</span>&nbsp;<span class="ident" id="6763640">i</span><span class="op" id="6763641">++</span>&nbsp;<span class="op" id="6763644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763648">clientSem</span>&nbsp;<span class="op" id="6763658">&lt;-</span>&nbsp;<span class="builtintype" id="6763661">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6763668">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763692">go</span>&nbsp;<span class="keyword" id="6763695">func</span><span class="op" id="6763699">(</span><span class="op" id="6763700">)</span>&nbsp;<span class="op" id="6763702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763707">defer</span>&nbsp;<span class="keyword" id="6763713">func</span><span class="op" id="6763717">(</span><span class="op" id="6763718">)</span>&nbsp;<span class="op" id="6763720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763726">&lt;-</span><span class="ident" id="6763728">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763741">}</span><span class="op" id="6763742">(</span><span class="op" id="6763743">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763748">c</span><span class="op" id="6763749">,</span>&nbsp;<span class="ident" id="6763751">err</span>&nbsp;<span class="op" id="6763755">:=</span>&nbsp;<span class="ident" id="6763758">Dial</span><span class="op" id="6763762">(</span><span class="string" id="6763763">&#34;tcp&#34;</span><span class="op" id="6763768">,</span>&nbsp;<span class="ident" id="6763770">ln</span><span class="op" id="6763772">.</span><span class="ident" id="6763773">Addr</span><span class="op" id="6763777">(</span><span class="op" id="6763778">)</span><span class="op" id="6763779">.</span><span class="ident" id="6763780">String</span><span class="op" id="6763786">(</span><span class="op" id="6763787">)</span><span class="op" id="6763788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763793">if</span>&nbsp;<span class="ident" id="6763796">err</span>&nbsp;<span class="op" id="6763800">!=</span>&nbsp;<span class="builtintype" id="6763803">nil</span>&nbsp;<span class="op" id="6763807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763813">b</span><span class="op" id="6763814">.</span><span class="ident" id="6763815">Logf</span><span class="op" id="6763819">(</span><span class="string" id="6763820">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6763837">,</span>&nbsp;<span class="ident" id="6763839">err</span><span class="op" id="6763842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763848">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763858">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763863">defer</span>&nbsp;<span class="ident" id="6763869">c</span><span class="op" id="6763870">.</span><span class="ident" id="6763871">Close</span><span class="op" id="6763876">(</span><span class="op" id="6763877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763882">if</span>&nbsp;<span class="ident" id="6763885">timeout</span>&nbsp;<span class="op" id="6763893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6763899">c</span><span class="op" id="6763900">.</span><span class="ident" id="6763901">SetDeadline</span><span class="op" id="6763912">(</span><span class="ident" id="6763913">time</span><span class="op" id="6763917">.</span><span class="ident" id="6763918">Now</span><span class="op" id="6763921">(</span><span class="op" id="6763922">)</span><span class="op" id="6763923">.</span><span class="ident" id="6763924">Add</span><span class="op" id="6763927">(</span><span class="ident" id="6763928">time</span><span class="op" id="6763932">.</span><span class="ident" id="6763933">Hour</span><span class="op" id="6763937">)</span><span class="op" id="6763938">)</span>&nbsp;<span class="comment" id="6763940">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6763968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763973">var</span>&nbsp;<span class="ident" id="6763977">buf</span>&nbsp;<span class="op" id="6763981">[</span><span class="ident" id="6763982">msgLen</span><span class="op" id="6763988">]</span><span class="builtintype" id="6763989">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6763997">for</span>&nbsp;<span class="ident" id="6764001">m</span>&nbsp;<span class="op" id="6764003">:=</span>&nbsp;<span class="num" id="6764006">0</span><span class="op" id="6764007">;</span>&nbsp;<span class="ident" id="6764009">m</span>&nbsp;<span class="op" id="6764011">&lt;</span>&nbsp;<span class="ident" id="6764013">msgs</span><span class="op" id="6764017">;</span>&nbsp;<span class="ident" id="6764019">m</span><span class="op" id="6764020">++</span>&nbsp;<span class="op" id="6764023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764029">if</span>&nbsp;<span class="op" id="6764032">!</span><span class="ident" id="6764033">sendMsg</span><span class="op" id="6764040">(</span><span class="ident" id="6764041">c</span><span class="op" id="6764042">,</span>&nbsp;<span class="ident" id="6764044">buf</span><span class="op" id="6764047">[</span><span class="op" id="6764048">:</span><span class="op" id="6764049">]</span><span class="op" id="6764050">)</span>&nbsp;<span class="op" id="6764052">||</span>&nbsp;<span class="op" id="6764055">!</span><span class="ident" id="6764056">recvMsg</span><span class="op" id="6764063">(</span><span class="ident" id="6764064">c</span><span class="op" id="6764065">,</span>&nbsp;<span class="ident" id="6764067">buf</span><span class="op" id="6764070">[</span><span class="op" id="6764071">:</span><span class="op" id="6764072">]</span><span class="op" id="6764073">)</span>&nbsp;<span class="op" id="6764075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764082">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764097">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764101">}</span><span class="op" id="6764102">(</span><span class="op" id="6764103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764109">for</span>&nbsp;<span class="ident" id="6764113">i</span>&nbsp;<span class="op" id="6764115">:=</span>&nbsp;<span class="num" id="6764118">0</span><span class="op" id="6764119">;</span>&nbsp;<span class="ident" id="6764121">i</span>&nbsp;<span class="op" id="6764123">&lt;</span>&nbsp;<span class="ident" id="6764125">numConcurrent</span><span class="op" id="6764138">;</span>&nbsp;<span class="ident" id="6764140">i</span><span class="op" id="6764141">++</span>&nbsp;<span class="op" id="6764144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764148">clientSem</span>&nbsp;<span class="op" id="6764158">&lt;-</span>&nbsp;<span class="builtintype" id="6764161">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764168">serverSem</span>&nbsp;<span class="op" id="6764178">&lt;-</span>&nbsp;<span class="builtintype" id="6764181">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764187">}</span><br>
<span class="lineno"></span><span class="op" id="6764189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6764192">func</span>&nbsp;<span class="ident" id="6764197">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="6764229">(</span><span class="ident" id="6764230">b</span>&nbsp;<span class="op" id="6764232">*</span><span class="ident" id="6764233">testing</span><span class="op" id="6764240">.</span><span class="ident" id="6764241">B</span><span class="op" id="6764242">)</span>&nbsp;<span class="op" id="6764244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764247">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6764278">(</span><span class="ident" id="6764279">b</span><span class="op" id="6764280">,</span>&nbsp;<span class="string" id="6764282">&#34;127.0.0.1:0&#34;</span><span class="op" id="6764295">)</span><br>
<span class="lineno">160</span><span class="op" id="6764297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6764300">func</span>&nbsp;<span class="ident" id="6764305">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="6764337">(</span><span class="ident" id="6764338">b</span>&nbsp;<span class="op" id="6764340">*</span><span class="ident" id="6764341">testing</span><span class="op" id="6764348">.</span><span class="ident" id="6764349">B</span><span class="op" id="6764350">)</span>&nbsp;<span class="op" id="6764352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6764355">if</span>&nbsp;<span class="op" id="6764358">!</span><span class="ident" id="6764359">supportsIPv6</span>&nbsp;<span class="op" id="6764372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764376">b</span><span class="op" id="6764377">.</span><span class="ident" id="6764378">Skip</span><span class="op" id="6764382">(</span><span class="string" id="6764383">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6764406">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6764409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764412">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6764443">(</span><span class="ident" id="6764444">b</span><span class="op" id="6764445">,</span>&nbsp;<span class="string" id="6764447">&#34;[::1]:0&#34;</span><span class="op" id="6764456">)</span><br>
<span class="lineno"></span><span class="op" id="6764458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6764461">func</span>&nbsp;<span class="ident" id="6764466">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6764497">(</span><span class="ident" id="6764498">b</span>&nbsp;<span class="op" id="6764500">*</span><span class="ident" id="6764501">testing</span><span class="op" id="6764508">.</span><span class="ident" id="6764509">B</span><span class="op" id="6764510">,</span>&nbsp;<span class="ident" id="6764512">laddr</span>&nbsp;<span class="builtintype" id="6764518">string</span><span class="op" id="6764524">)</span>&nbsp;<span class="op" id="6764526">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6764529">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6764587">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6764670">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6764752">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764803">b</span><span class="op" id="6764804">.</span><span class="ident" id="6764805">StopTimer</span><span class="op" id="6764814">(</span><span class="op" id="6764815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764819">P</span>&nbsp;<span class="op" id="6764821">:=</span>&nbsp;<span class="ident" id="6764824">runtime</span><span class="op" id="6764831">.</span><span class="ident" id="6764832">GOMAXPROCS</span><span class="op" id="6764842">(</span><span class="num" id="6764843">0</span><span class="op" id="6764844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764847">N</span>&nbsp;<span class="op" id="6764849">:=</span>&nbsp;<span class="ident" id="6764852">b</span><span class="op" id="6764853">.</span><span class="ident" id="6764854">N</span>&nbsp;<span class="op" id="6764856">/</span>&nbsp;<span class="ident" id="6764858">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764861">W</span>&nbsp;<span class="op" id="6764863">:=</span>&nbsp;<span class="num" id="6764866">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6764873">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764912">clients</span>&nbsp;<span class="op" id="6764920">:=</span>&nbsp;<span class="builtinfunc" id="6764923">make</span><span class="op" id="6764927">(</span><span class="op" id="6764928">[</span><span class="op" id="6764929">]</span><span class="ident" id="6764930">Conn</span><span class="op" id="6764934">,</span>&nbsp;<span class="ident" id="6764936">P</span><span class="op" id="6764937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764940">servers</span>&nbsp;<span class="op" id="6764948">:=</span>&nbsp;<span class="builtinfunc" id="6764951">make</span><span class="op" id="6764955">(</span><span class="op" id="6764956">[</span><span class="op" id="6764957">]</span><span class="ident" id="6764958">Conn</span><span class="op" id="6764962">,</span>&nbsp;<span class="ident" id="6764964">P</span><span class="op" id="6764965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6764968">ln</span><span class="op" id="6764970">,</span>&nbsp;<span class="ident" id="6764972">err</span>&nbsp;<span class="op" id="6764976">:=</span>&nbsp;<span class="ident" id="6764979">Listen</span><span class="op" id="6764985">(</span><span class="string" id="6764986">&#34;tcp&#34;</span><span class="op" id="6764991">,</span>&nbsp;<span class="ident" id="6764993">laddr</span><span class="op" id="6764998">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765001">if</span>&nbsp;<span class="ident" id="6765004">err</span>&nbsp;<span class="op" id="6765008">!=</span>&nbsp;<span class="builtintype" id="6765011">nil</span>&nbsp;<span class="op" id="6765015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765019">b</span><span class="op" id="6765020">.</span><span class="ident" id="6765021">Fatalf</span><span class="op" id="6765027">(</span><span class="string" id="6765028">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6765047">,</span>&nbsp;<span class="ident" id="6765049">err</span><span class="op" id="6765052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765058">defer</span>&nbsp;<span class="ident" id="6765064">ln</span><span class="op" id="6765066">.</span><span class="ident" id="6765067">Close</span><span class="op" id="6765072">(</span><span class="op" id="6765073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765076">done</span>&nbsp;<span class="op" id="6765081">:=</span>&nbsp;<span class="builtinfunc" id="6765084">make</span><span class="op" id="6765088">(</span><span class="keyword" id="6765089">chan</span>&nbsp;<span class="builtintype" id="6765094">bool</span><span class="op" id="6765098">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765101">go</span>&nbsp;<span class="keyword" id="6765104">func</span><span class="op" id="6765108">(</span><span class="op" id="6765109">)</span>&nbsp;<span class="op" id="6765111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765115">for</span>&nbsp;<span class="ident" id="6765119">p</span>&nbsp;<span class="op" id="6765121">:=</span>&nbsp;<span class="num" id="6765124">0</span><span class="op" id="6765125">;</span>&nbsp;<span class="ident" id="6765127">p</span>&nbsp;<span class="op" id="6765129">&lt;</span>&nbsp;<span class="ident" id="6765131">P</span><span class="op" id="6765132">;</span>&nbsp;<span class="ident" id="6765134">p</span><span class="op" id="6765135">++</span>&nbsp;<span class="op" id="6765138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765143">s</span><span class="op" id="6765144">,</span>&nbsp;<span class="ident" id="6765146">err</span>&nbsp;<span class="op" id="6765150">:=</span>&nbsp;<span class="ident" id="6765153">ln</span><span class="op" id="6765155">.</span><span class="ident" id="6765156">Accept</span><span class="op" id="6765162">(</span><span class="op" id="6765163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765168">if</span>&nbsp;<span class="ident" id="6765171">err</span>&nbsp;<span class="op" id="6765175">!=</span>&nbsp;<span class="builtintype" id="6765178">nil</span>&nbsp;<span class="op" id="6765182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765188">b</span><span class="op" id="6765189">.</span><span class="ident" id="6765190">Errorf</span><span class="op" id="6765196">(</span><span class="string" id="6765197">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6765216">,</span>&nbsp;<span class="ident" id="6765218">err</span><span class="op" id="6765221">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765227">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765242">servers</span><span class="op" id="6765249">[</span><span class="ident" id="6765250">p</span><span class="op" id="6765251">]</span>&nbsp;<span class="op" id="6765253">=</span>&nbsp;<span class="ident" id="6765255">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765263">done</span>&nbsp;<span class="op" id="6765268">&lt;-</span>&nbsp;<span class="builtintype" id="6765271">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765277">}</span><span class="op" id="6765278">(</span><span class="op" id="6765279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765282">for</span>&nbsp;<span class="ident" id="6765286">p</span>&nbsp;<span class="op" id="6765288">:=</span>&nbsp;<span class="num" id="6765291">0</span><span class="op" id="6765292">;</span>&nbsp;<span class="ident" id="6765294">p</span>&nbsp;<span class="op" id="6765296">&lt;</span>&nbsp;<span class="ident" id="6765298">P</span><span class="op" id="6765299">;</span>&nbsp;<span class="ident" id="6765301">p</span><span class="op" id="6765302">++</span>&nbsp;<span class="op" id="6765305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765309">c</span><span class="op" id="6765310">,</span>&nbsp;<span class="ident" id="6765312">err</span>&nbsp;<span class="op" id="6765316">:=</span>&nbsp;<span class="ident" id="6765319">Dial</span><span class="op" id="6765323">(</span><span class="string" id="6765324">&#34;tcp&#34;</span><span class="op" id="6765329">,</span>&nbsp;<span class="ident" id="6765331">ln</span><span class="op" id="6765333">.</span><span class="ident" id="6765334">Addr</span><span class="op" id="6765338">(</span><span class="op" id="6765339">)</span><span class="op" id="6765340">.</span><span class="ident" id="6765341">String</span><span class="op" id="6765347">(</span><span class="op" id="6765348">)</span><span class="op" id="6765349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765353">if</span>&nbsp;<span class="ident" id="6765356">err</span>&nbsp;<span class="op" id="6765360">!=</span>&nbsp;<span class="builtintype" id="6765363">nil</span>&nbsp;<span class="op" id="6765367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765372">b</span><span class="op" id="6765373">.</span><span class="ident" id="6765374">Fatalf</span><span class="op" id="6765380">(</span><span class="string" id="6765381">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6765398">,</span>&nbsp;<span class="ident" id="6765400">err</span><span class="op" id="6765403">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765411">clients</span><span class="op" id="6765418">[</span><span class="ident" id="6765419">p</span><span class="op" id="6765420">]</span>&nbsp;<span class="op" id="6765422">=</span>&nbsp;<span class="ident" id="6765424">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765430">&lt;-</span><span class="ident" id="6765432">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765439">b</span><span class="op" id="6765440">.</span><span class="ident" id="6765441">StartTimer</span><span class="op" id="6765451">(</span><span class="op" id="6765452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765456">var</span>&nbsp;<span class="ident" id="6765460">wg</span>&nbsp;<span class="ident" id="6765463">sync</span><span class="op" id="6765467">.</span><span class="ident" id="6765468">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765479">wg</span><span class="op" id="6765481">.</span><span class="ident" id="6765482">Add</span><span class="op" id="6765485">(</span><span class="num" id="6765486">4</span>&nbsp;<span class="op" id="6765488">*</span>&nbsp;<span class="ident" id="6765490">P</span><span class="op" id="6765491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765494">for</span>&nbsp;<span class="ident" id="6765498">p</span>&nbsp;<span class="op" id="6765500">:=</span>&nbsp;<span class="num" id="6765503">0</span><span class="op" id="6765504">;</span>&nbsp;<span class="ident" id="6765506">p</span>&nbsp;<span class="op" id="6765508">&lt;</span>&nbsp;<span class="ident" id="6765510">P</span><span class="op" id="6765511">;</span>&nbsp;<span class="ident" id="6765513">p</span><span class="op" id="6765514">++</span>&nbsp;<span class="op" id="6765517">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6765521">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765541">go</span>&nbsp;<span class="keyword" id="6765544">func</span><span class="op" id="6765548">(</span><span class="ident" id="6765549">c</span>&nbsp;<span class="ident" id="6765551">Conn</span><span class="op" id="6765555">)</span>&nbsp;<span class="op" id="6765557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765562">defer</span>&nbsp;<span class="ident" id="6765568">wg</span><span class="op" id="6765570">.</span><span class="ident" id="6765571">Done</span><span class="op" id="6765575">(</span><span class="op" id="6765576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765581">var</span>&nbsp;<span class="ident" id="6765585">buf</span>&nbsp;<span class="op" id="6765589">[</span><span class="num" id="6765590">1</span><span class="op" id="6765591">]</span><span class="builtintype" id="6765592">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765600">for</span>&nbsp;<span class="ident" id="6765604">i</span>&nbsp;<span class="op" id="6765606">:=</span>&nbsp;<span class="num" id="6765609">0</span><span class="op" id="6765610">;</span>&nbsp;<span class="ident" id="6765612">i</span>&nbsp;<span class="op" id="6765614">&lt;</span>&nbsp;<span class="ident" id="6765616">N</span><span class="op" id="6765617">;</span>&nbsp;<span class="ident" id="6765619">i</span><span class="op" id="6765620">++</span>&nbsp;<span class="op" id="6765623">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765629">v</span>&nbsp;<span class="op" id="6765631">:=</span>&nbsp;<span class="builtintype" id="6765634">byte</span><span class="op" id="6765638">(</span><span class="ident" id="6765639">i</span><span class="op" id="6765640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765646">for</span>&nbsp;<span class="ident" id="6765650">w</span>&nbsp;<span class="op" id="6765652">:=</span>&nbsp;<span class="num" id="6765655">0</span><span class="op" id="6765656">;</span>&nbsp;<span class="ident" id="6765658">w</span>&nbsp;<span class="op" id="6765660">&lt;</span>&nbsp;<span class="ident" id="6765662">W</span><span class="op" id="6765663">;</span>&nbsp;<span class="ident" id="6765665">w</span><span class="op" id="6765666">++</span>&nbsp;<span class="op" id="6765669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765676">v</span>&nbsp;<span class="op" id="6765678">*=</span>&nbsp;<span class="ident" id="6765681">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765693">buf</span><span class="op" id="6765696">[</span><span class="num" id="6765697">0</span><span class="op" id="6765698">]</span>&nbsp;<span class="op" id="6765700">=</span>&nbsp;<span class="ident" id="6765702">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765708">_</span><span class="op" id="6765709">,</span>&nbsp;<span class="ident" id="6765711">err</span>&nbsp;<span class="op" id="6765715">:=</span>&nbsp;<span class="ident" id="6765718">c</span><span class="op" id="6765719">.</span><span class="ident" id="6765720">Write</span><span class="op" id="6765725">(</span><span class="ident" id="6765726">buf</span><span class="op" id="6765729">[</span><span class="op" id="6765730">:</span><span class="op" id="6765731">]</span><span class="op" id="6765732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765738">if</span>&nbsp;<span class="ident" id="6765741">err</span>&nbsp;<span class="op" id="6765745">!=</span>&nbsp;<span class="builtintype" id="6765748">nil</span>&nbsp;<span class="op" id="6765752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765759">b</span><span class="op" id="6765760">.</span><span class="ident" id="6765761">Errorf</span><span class="op" id="6765767">(</span><span class="string" id="6765768">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6765786">,</span>&nbsp;<span class="ident" id="6765788">err</span><span class="op" id="6765791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765798">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765809">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6765818">}</span><span class="op" id="6765819">(</span><span class="ident" id="6765820">clients</span><span class="op" id="6765827">[</span><span class="ident" id="6765828">p</span><span class="op" id="6765829">]</span><span class="op" id="6765830">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6765835">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6765886">pipe</span>&nbsp;<span class="op" id="6765891">:=</span>&nbsp;<span class="builtinfunc" id="6765894">make</span><span class="op" id="6765898">(</span><span class="keyword" id="6765899">chan</span>&nbsp;<span class="builtintype" id="6765904">byte</span><span class="op" id="6765908">,</span>&nbsp;<span class="num" id="6765910">128</span><span class="op" id="6765913">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6765918">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765938">go</span>&nbsp;<span class="keyword" id="6765941">func</span><span class="op" id="6765945">(</span><span class="ident" id="6765946">s</span>&nbsp;<span class="ident" id="6765948">Conn</span><span class="op" id="6765952">)</span>&nbsp;<span class="op" id="6765954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765959">defer</span>&nbsp;<span class="ident" id="6765965">wg</span><span class="op" id="6765967">.</span><span class="ident" id="6765968">Done</span><span class="op" id="6765972">(</span><span class="op" id="6765973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765978">var</span>&nbsp;<span class="ident" id="6765982">buf</span>&nbsp;<span class="op" id="6765986">[</span><span class="num" id="6765987">1</span><span class="op" id="6765988">]</span><span class="builtintype" id="6765989">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6765997">for</span>&nbsp;<span class="ident" id="6766001">i</span>&nbsp;<span class="op" id="6766003">:=</span>&nbsp;<span class="num" id="6766006">0</span><span class="op" id="6766007">;</span>&nbsp;<span class="ident" id="6766009">i</span>&nbsp;<span class="op" id="6766011">&lt;</span>&nbsp;<span class="ident" id="6766013">N</span><span class="op" id="6766014">;</span>&nbsp;<span class="ident" id="6766016">i</span><span class="op" id="6766017">++</span>&nbsp;<span class="op" id="6766020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766026">_</span><span class="op" id="6766027">,</span>&nbsp;<span class="ident" id="6766029">err</span>&nbsp;<span class="op" id="6766033">:=</span>&nbsp;<span class="ident" id="6766036">s</span><span class="op" id="6766037">.</span><span class="ident" id="6766038">Read</span><span class="op" id="6766042">(</span><span class="ident" id="6766043">buf</span><span class="op" id="6766046">[</span><span class="op" id="6766047">:</span><span class="op" id="6766048">]</span><span class="op" id="6766049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766055">if</span>&nbsp;<span class="ident" id="6766058">err</span>&nbsp;<span class="op" id="6766062">!=</span>&nbsp;<span class="builtintype" id="6766065">nil</span>&nbsp;<span class="op" id="6766069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766076">b</span><span class="op" id="6766077">.</span><span class="ident" id="6766078">Errorf</span><span class="op" id="6766084">(</span><span class="string" id="6766085">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6766102">,</span>&nbsp;<span class="ident" id="6766104">err</span><span class="op" id="6766107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766114">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766131">pipe</span>&nbsp;<span class="op" id="6766136">&lt;-</span>&nbsp;<span class="ident" id="6766139">buf</span><span class="op" id="6766142">[</span><span class="num" id="6766143">0</span><span class="op" id="6766144">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766153">}</span><span class="op" id="6766154">(</span><span class="ident" id="6766155">servers</span><span class="op" id="6766162">[</span><span class="ident" id="6766163">p</span><span class="op" id="6766164">]</span><span class="op" id="6766165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6766170">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766190">go</span>&nbsp;<span class="keyword" id="6766193">func</span><span class="op" id="6766197">(</span><span class="ident" id="6766198">s</span>&nbsp;<span class="ident" id="6766200">Conn</span><span class="op" id="6766204">)</span>&nbsp;<span class="op" id="6766206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766211">defer</span>&nbsp;<span class="ident" id="6766217">wg</span><span class="op" id="6766219">.</span><span class="ident" id="6766220">Done</span><span class="op" id="6766224">(</span><span class="op" id="6766225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766230">var</span>&nbsp;<span class="ident" id="6766234">buf</span>&nbsp;<span class="op" id="6766238">[</span><span class="num" id="6766239">1</span><span class="op" id="6766240">]</span><span class="builtintype" id="6766241">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766249">for</span>&nbsp;<span class="ident" id="6766253">i</span>&nbsp;<span class="op" id="6766255">:=</span>&nbsp;<span class="num" id="6766258">0</span><span class="op" id="6766259">;</span>&nbsp;<span class="ident" id="6766261">i</span>&nbsp;<span class="op" id="6766263">&lt;</span>&nbsp;<span class="ident" id="6766265">N</span><span class="op" id="6766266">;</span>&nbsp;<span class="ident" id="6766268">i</span><span class="op" id="6766269">++</span>&nbsp;<span class="op" id="6766272">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766278">v</span>&nbsp;<span class="op" id="6766280">:=</span>&nbsp;<span class="op" id="6766283">&lt;-</span><span class="ident" id="6766285">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766294">for</span>&nbsp;<span class="ident" id="6766298">w</span>&nbsp;<span class="op" id="6766300">:=</span>&nbsp;<span class="num" id="6766303">0</span><span class="op" id="6766304">;</span>&nbsp;<span class="ident" id="6766306">w</span>&nbsp;<span class="op" id="6766308">&lt;</span>&nbsp;<span class="ident" id="6766310">W</span><span class="op" id="6766311">;</span>&nbsp;<span class="ident" id="6766313">w</span><span class="op" id="6766314">++</span>&nbsp;<span class="op" id="6766317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766324">v</span>&nbsp;<span class="op" id="6766326">*=</span>&nbsp;<span class="ident" id="6766329">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766341">buf</span><span class="op" id="6766344">[</span><span class="num" id="6766345">0</span><span class="op" id="6766346">]</span>&nbsp;<span class="op" id="6766348">=</span>&nbsp;<span class="ident" id="6766350">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766356">_</span><span class="op" id="6766357">,</span>&nbsp;<span class="ident" id="6766359">err</span>&nbsp;<span class="op" id="6766363">:=</span>&nbsp;<span class="ident" id="6766366">s</span><span class="op" id="6766367">.</span><span class="ident" id="6766368">Write</span><span class="op" id="6766373">(</span><span class="ident" id="6766374">buf</span><span class="op" id="6766377">[</span><span class="op" id="6766378">:</span><span class="op" id="6766379">]</span><span class="op" id="6766380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766386">if</span>&nbsp;<span class="ident" id="6766389">err</span>&nbsp;<span class="op" id="6766393">!=</span>&nbsp;<span class="builtintype" id="6766396">nil</span>&nbsp;<span class="op" id="6766400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766407">b</span><span class="op" id="6766408">.</span><span class="ident" id="6766409">Errorf</span><span class="op" id="6766415">(</span><span class="string" id="6766416">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6766434">,</span>&nbsp;<span class="ident" id="6766436">err</span><span class="op" id="6766439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766446">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766457">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766467">s</span><span class="op" id="6766468">.</span><span class="ident" id="6766469">Close</span><span class="op" id="6766474">(</span><span class="op" id="6766475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766479">}</span><span class="op" id="6766480">(</span><span class="ident" id="6766481">servers</span><span class="op" id="6766488">[</span><span class="ident" id="6766489">p</span><span class="op" id="6766490">]</span><span class="op" id="6766491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6766496">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766516">go</span>&nbsp;<span class="keyword" id="6766519">func</span><span class="op" id="6766523">(</span><span class="ident" id="6766524">c</span>&nbsp;<span class="ident" id="6766526">Conn</span><span class="op" id="6766530">)</span>&nbsp;<span class="op" id="6766532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766537">defer</span>&nbsp;<span class="ident" id="6766543">wg</span><span class="op" id="6766545">.</span><span class="ident" id="6766546">Done</span><span class="op" id="6766550">(</span><span class="op" id="6766551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766556">var</span>&nbsp;<span class="ident" id="6766560">buf</span>&nbsp;<span class="op" id="6766564">[</span><span class="num" id="6766565">1</span><span class="op" id="6766566">]</span><span class="builtintype" id="6766567">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766575">for</span>&nbsp;<span class="ident" id="6766579">i</span>&nbsp;<span class="op" id="6766581">:=</span>&nbsp;<span class="num" id="6766584">0</span><span class="op" id="6766585">;</span>&nbsp;<span class="ident" id="6766587">i</span>&nbsp;<span class="op" id="6766589">&lt;</span>&nbsp;<span class="ident" id="6766591">N</span><span class="op" id="6766592">;</span>&nbsp;<span class="ident" id="6766594">i</span><span class="op" id="6766595">++</span>&nbsp;<span class="op" id="6766598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766604">_</span><span class="op" id="6766605">,</span>&nbsp;<span class="ident" id="6766607">err</span>&nbsp;<span class="op" id="6766611">:=</span>&nbsp;<span class="ident" id="6766614">c</span><span class="op" id="6766615">.</span><span class="ident" id="6766616">Read</span><span class="op" id="6766620">(</span><span class="ident" id="6766621">buf</span><span class="op" id="6766624">[</span><span class="op" id="6766625">:</span><span class="op" id="6766626">]</span><span class="op" id="6766627">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766633">if</span>&nbsp;<span class="ident" id="6766636">err</span>&nbsp;<span class="op" id="6766640">!=</span>&nbsp;<span class="builtintype" id="6766643">nil</span>&nbsp;<span class="op" id="6766647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766654">b</span><span class="op" id="6766655">.</span><span class="ident" id="6766656">Errorf</span><span class="op" id="6766662">(</span><span class="string" id="6766663">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6766680">,</span>&nbsp;<span class="ident" id="6766682">err</span><span class="op" id="6766685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6766692">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766708">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766713">c</span><span class="op" id="6766714">.</span><span class="ident" id="6766715">Close</span><span class="op" id="6766720">(</span><span class="op" id="6766721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766725">}</span><span class="op" id="6766726">(</span><span class="ident" id="6766727">clients</span><span class="op" id="6766734">[</span><span class="ident" id="6766735">p</span><span class="op" id="6766736">]</span><span class="op" id="6766737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766743">wg</span><span class="op" id="6766745">.</span><span class="ident" id="6766746">Wait</span><span class="op" id="6766750">(</span><span class="op" id="6766751">)</span><br>
<span class="lineno"></span><span class="op" id="6766753">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="6766756">type</span>&nbsp;<span class="ident" id="6766761">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="6766780">struct</span>&nbsp;<span class="op" id="6766787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766790">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6766804">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766812">litAddrOrName</span>&nbsp;<span class="builtintype" id="6766826">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766834">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766848">*</span><span class="ident" id="6766849">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6766858">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6766872">error</span><br>
<span class="lineno"></span><span class="op" id="6766878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6766881">var</span>&nbsp;<span class="ident" id="6766885">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6766905">=</span>&nbsp;<span class="op" id="6766907">[</span><span class="op" id="6766908">]</span><span class="ident" id="6766909">resolveTCPAddrTest</span><span class="op" id="6766927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6766930">{</span><span class="string" id="6766931">&#34;tcp&#34;</span><span class="op" id="6766936">,</span>&nbsp;<span class="string" id="6766938">&#34;127.0.0.1:0&#34;</span><span class="op" id="6766951">,</span>&nbsp;<span class="op" id="6766953">&amp;</span><span class="ident" id="6766954">TCPAddr</span><span class="op" id="6766961">{</span><span class="ident" id="6766962">IP</span><span class="op" id="6766964">:</span>&nbsp;<span class="ident" id="6766966">IPv4</span><span class="op" id="6766970">(</span><span class="num" id="6766971">127</span><span class="op" id="6766974">,</span>&nbsp;<span class="num" id="6766976">0</span><span class="op" id="6766977">,</span>&nbsp;<span class="num" id="6766979">0</span><span class="op" id="6766980">,</span>&nbsp;<span class="num" id="6766982">1</span><span class="op" id="6766983">)</span><span class="op" id="6766984">,</span>&nbsp;<span class="ident" id="6766986">Port</span><span class="op" id="6766990">:</span>&nbsp;<span class="num" id="6766992">0</span><span class="op" id="6766993">}</span><span class="op" id="6766994">,</span>&nbsp;<span class="builtintype" id="6766996">nil</span><span class="op" id="6766999">}</span><span class="op" id="6767000">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767003">{</span><span class="string" id="6767004">&#34;tcp4&#34;</span><span class="op" id="6767010">,</span>&nbsp;<span class="string" id="6767012">&#34;127.0.0.1:65535&#34;</span><span class="op" id="6767029">,</span>&nbsp;<span class="op" id="6767031">&amp;</span><span class="ident" id="6767032">TCPAddr</span><span class="op" id="6767039">{</span><span class="ident" id="6767040">IP</span><span class="op" id="6767042">:</span>&nbsp;<span class="ident" id="6767044">IPv4</span><span class="op" id="6767048">(</span><span class="num" id="6767049">127</span><span class="op" id="6767052">,</span>&nbsp;<span class="num" id="6767054">0</span><span class="op" id="6767055">,</span>&nbsp;<span class="num" id="6767057">0</span><span class="op" id="6767058">,</span>&nbsp;<span class="num" id="6767060">1</span><span class="op" id="6767061">)</span><span class="op" id="6767062">,</span>&nbsp;<span class="ident" id="6767064">Port</span><span class="op" id="6767068">:</span>&nbsp;<span class="num" id="6767070">65535</span><span class="op" id="6767075">}</span><span class="op" id="6767076">,</span>&nbsp;<span class="builtintype" id="6767078">nil</span><span class="op" id="6767081">}</span><span class="op" id="6767082">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767086">{</span><span class="string" id="6767087">&#34;tcp&#34;</span><span class="op" id="6767092">,</span>&nbsp;<span class="string" id="6767094">&#34;[::1]:1&#34;</span><span class="op" id="6767103">,</span>&nbsp;<span class="op" id="6767105">&amp;</span><span class="ident" id="6767106">TCPAddr</span><span class="op" id="6767113">{</span><span class="ident" id="6767114">IP</span><span class="op" id="6767116">:</span>&nbsp;<span class="ident" id="6767118">ParseIP</span><span class="op" id="6767125">(</span><span class="string" id="6767126">&#34;::1&#34;</span><span class="op" id="6767131">)</span><span class="op" id="6767132">,</span>&nbsp;<span class="ident" id="6767134">Port</span><span class="op" id="6767138">:</span>&nbsp;<span class="num" id="6767140">1</span><span class="op" id="6767141">}</span><span class="op" id="6767142">,</span>&nbsp;<span class="builtintype" id="6767144">nil</span><span class="op" id="6767147">}</span><span class="op" id="6767148">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767151">{</span><span class="string" id="6767152">&#34;tcp6&#34;</span><span class="op" id="6767158">,</span>&nbsp;<span class="string" id="6767160">&#34;[::1]:65534&#34;</span><span class="op" id="6767173">,</span>&nbsp;<span class="op" id="6767175">&amp;</span><span class="ident" id="6767176">TCPAddr</span><span class="op" id="6767183">{</span><span class="ident" id="6767184">IP</span><span class="op" id="6767186">:</span>&nbsp;<span class="ident" id="6767188">ParseIP</span><span class="op" id="6767195">(</span><span class="string" id="6767196">&#34;::1&#34;</span><span class="op" id="6767201">)</span><span class="op" id="6767202">,</span>&nbsp;<span class="ident" id="6767204">Port</span><span class="op" id="6767208">:</span>&nbsp;<span class="num" id="6767210">65534</span><span class="op" id="6767215">}</span><span class="op" id="6767216">,</span>&nbsp;<span class="builtintype" id="6767218">nil</span><span class="op" id="6767221">}</span><span class="op" id="6767222">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767226">{</span><span class="string" id="6767227">&#34;tcp&#34;</span><span class="op" id="6767232">,</span>&nbsp;<span class="string" id="6767234">&#34;[::1%en0]:1&#34;</span><span class="op" id="6767247">,</span>&nbsp;<span class="op" id="6767249">&amp;</span><span class="ident" id="6767250">TCPAddr</span><span class="op" id="6767257">{</span><span class="ident" id="6767258">IP</span><span class="op" id="6767260">:</span>&nbsp;<span class="ident" id="6767262">ParseIP</span><span class="op" id="6767269">(</span><span class="string" id="6767270">&#34;::1&#34;</span><span class="op" id="6767275">)</span><span class="op" id="6767276">,</span>&nbsp;<span class="ident" id="6767278">Port</span><span class="op" id="6767282">:</span>&nbsp;<span class="num" id="6767284">1</span><span class="op" id="6767285">,</span>&nbsp;<span class="ident" id="6767287">Zone</span><span class="op" id="6767291">:</span>&nbsp;<span class="string" id="6767293">&#34;en0&#34;</span><span class="op" id="6767298">}</span><span class="op" id="6767299">,</span>&nbsp;<span class="builtintype" id="6767301">nil</span><span class="op" id="6767304">}</span><span class="op" id="6767305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767308">{</span><span class="string" id="6767309">&#34;tcp6&#34;</span><span class="op" id="6767315">,</span>&nbsp;<span class="string" id="6767317">&#34;[::1%911]:2&#34;</span><span class="op" id="6767330">,</span>&nbsp;<span class="op" id="6767332">&amp;</span><span class="ident" id="6767333">TCPAddr</span><span class="op" id="6767340">{</span><span class="ident" id="6767341">IP</span><span class="op" id="6767343">:</span>&nbsp;<span class="ident" id="6767345">ParseIP</span><span class="op" id="6767352">(</span><span class="string" id="6767353">&#34;::1&#34;</span><span class="op" id="6767358">)</span><span class="op" id="6767359">,</span>&nbsp;<span class="ident" id="6767361">Port</span><span class="op" id="6767365">:</span>&nbsp;<span class="num" id="6767367">2</span><span class="op" id="6767368">,</span>&nbsp;<span class="ident" id="6767370">Zone</span><span class="op" id="6767374">:</span>&nbsp;<span class="string" id="6767376">&#34;911&#34;</span><span class="op" id="6767381">}</span><span class="op" id="6767382">,</span>&nbsp;<span class="builtintype" id="6767384">nil</span><span class="op" id="6767387">}</span><span class="op" id="6767388">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767392">{</span><span class="string" id="6767393">&#34;&#34;</span><span class="op" id="6767395">,</span>&nbsp;<span class="string" id="6767397">&#34;127.0.0.1:0&#34;</span><span class="op" id="6767410">,</span>&nbsp;<span class="op" id="6767412">&amp;</span><span class="ident" id="6767413">TCPAddr</span><span class="op" id="6767420">{</span><span class="ident" id="6767421">IP</span><span class="op" id="6767423">:</span>&nbsp;<span class="ident" id="6767425">IPv4</span><span class="op" id="6767429">(</span><span class="num" id="6767430">127</span><span class="op" id="6767433">,</span>&nbsp;<span class="num" id="6767435">0</span><span class="op" id="6767436">,</span>&nbsp;<span class="num" id="6767438">0</span><span class="op" id="6767439">,</span>&nbsp;<span class="num" id="6767441">1</span><span class="op" id="6767442">)</span><span class="op" id="6767443">,</span>&nbsp;<span class="ident" id="6767445">Port</span><span class="op" id="6767449">:</span>&nbsp;<span class="num" id="6767451">0</span><span class="op" id="6767452">}</span><span class="op" id="6767453">,</span>&nbsp;<span class="builtintype" id="6767455">nil</span><span class="op" id="6767458">}</span><span class="op" id="6767459">,</span>&nbsp;<span class="comment" id="6767461">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767481">{</span><span class="string" id="6767482">&#34;&#34;</span><span class="op" id="6767484">,</span>&nbsp;<span class="string" id="6767486">&#34;[::1]:0&#34;</span><span class="op" id="6767495">,</span>&nbsp;<span class="op" id="6767497">&amp;</span><span class="ident" id="6767498">TCPAddr</span><span class="op" id="6767505">{</span><span class="ident" id="6767506">IP</span><span class="op" id="6767508">:</span>&nbsp;<span class="ident" id="6767510">ParseIP</span><span class="op" id="6767517">(</span><span class="string" id="6767518">&#34;::1&#34;</span><span class="op" id="6767523">)</span><span class="op" id="6767524">,</span>&nbsp;<span class="ident" id="6767526">Port</span><span class="op" id="6767530">:</span>&nbsp;<span class="num" id="6767532">0</span><span class="op" id="6767533">}</span><span class="op" id="6767534">,</span>&nbsp;<span class="builtintype" id="6767536">nil</span><span class="op" id="6767539">}</span><span class="op" id="6767540">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6767550">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767571">{</span><span class="string" id="6767572">&#34;tcp&#34;</span><span class="op" id="6767577">,</span>&nbsp;<span class="string" id="6767579">&#34;:12345&#34;</span><span class="op" id="6767587">,</span>&nbsp;<span class="op" id="6767589">&amp;</span><span class="ident" id="6767590">TCPAddr</span><span class="op" id="6767597">{</span><span class="ident" id="6767598">Port</span><span class="op" id="6767602">:</span>&nbsp;<span class="num" id="6767604">12345</span><span class="op" id="6767609">}</span><span class="op" id="6767610">,</span>&nbsp;<span class="builtintype" id="6767612">nil</span><span class="op" id="6767615">}</span><span class="op" id="6767616">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767620">{</span><span class="string" id="6767621">&#34;http&#34;</span><span class="op" id="6767627">,</span>&nbsp;<span class="string" id="6767629">&#34;127.0.0.1:0&#34;</span><span class="op" id="6767642">,</span>&nbsp;<span class="builtintype" id="6767644">nil</span><span class="op" id="6767647">,</span>&nbsp;<span class="ident" id="6767649">UnknownNetworkError</span><span class="op" id="6767668">(</span><span class="string" id="6767669">&#34;http&#34;</span><span class="op" id="6767675">)</span><span class="op" id="6767676">}</span><span class="op" id="6767677">,</span><br>
<span class="lineno"></span><span class="op" id="6767679">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="6767682">func</span>&nbsp;<span class="ident" id="6767687">init</span><span class="op" id="6767691">(</span><span class="op" id="6767692">)</span>&nbsp;<span class="op" id="6767694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6767697">if</span>&nbsp;<span class="ident" id="6767700">ifi</span>&nbsp;<span class="op" id="6767704">:=</span>&nbsp;<span class="ident" id="6767707">loopbackInterface</span><span class="op" id="6767724">(</span><span class="op" id="6767725">)</span><span class="op" id="6767726">;</span>&nbsp;<span class="ident" id="6767728">ifi</span>&nbsp;<span class="op" id="6767732">!=</span>&nbsp;<span class="builtintype" id="6767735">nil</span>&nbsp;<span class="op" id="6767739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767743">index</span>&nbsp;<span class="op" id="6767749">:=</span>&nbsp;<span class="ident" id="6767752">fmt</span><span class="op" id="6767755">.</span><span class="ident" id="6767756">Sprintf</span><span class="op" id="6767763">(</span><span class="string" id="6767764">&#34;%v&#34;</span><span class="op" id="6767768">,</span>&nbsp;<span class="ident" id="6767770">ifi</span><span class="op" id="6767773">.</span><span class="ident" id="6767774">Index</span><span class="op" id="6767779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6767783">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6767803">=</span>&nbsp;<span class="builtinfunc" id="6767805">append</span><span class="op" id="6767811">(</span><span class="ident" id="6767812">resolveTCPAddrTests</span><span class="op" id="6767831">,</span>&nbsp;<span class="op" id="6767833">[</span><span class="op" id="6767834">]</span><span class="ident" id="6767835">resolveTCPAddrTest</span><span class="op" id="6767853">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767858">{</span><span class="string" id="6767859">&#34;tcp6&#34;</span><span class="op" id="6767865">,</span>&nbsp;<span class="string" id="6767867">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6767879">+</span>&nbsp;<span class="ident" id="6767881">ifi</span><span class="op" id="6767884">.</span><span class="ident" id="6767885">Name</span>&nbsp;<span class="op" id="6767890">+</span>&nbsp;<span class="string" id="6767892">&#34;]:3&#34;</span><span class="op" id="6767897">,</span>&nbsp;<span class="op" id="6767899">&amp;</span><span class="ident" id="6767900">TCPAddr</span><span class="op" id="6767907">{</span><span class="ident" id="6767908">IP</span><span class="op" id="6767910">:</span>&nbsp;<span class="ident" id="6767912">ParseIP</span><span class="op" id="6767919">(</span><span class="string" id="6767920">&#34;fe80::1&#34;</span><span class="op" id="6767929">)</span><span class="op" id="6767930">,</span>&nbsp;<span class="ident" id="6767932">Port</span><span class="op" id="6767936">:</span>&nbsp;<span class="num" id="6767938">3</span><span class="op" id="6767939">,</span>&nbsp;<span class="ident" id="6767941">Zone</span><span class="op" id="6767945">:</span>&nbsp;<span class="ident" id="6767947">zoneToString</span><span class="op" id="6767959">(</span><span class="ident" id="6767960">ifi</span><span class="op" id="6767963">.</span><span class="ident" id="6767964">Index</span><span class="op" id="6767969">)</span><span class="op" id="6767970">}</span><span class="op" id="6767971">,</span>&nbsp;<span class="builtintype" id="6767973">nil</span><span class="op" id="6767976">}</span><span class="op" id="6767977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6767982">{</span><span class="string" id="6767983">&#34;tcp6&#34;</span><span class="op" id="6767989">,</span>&nbsp;<span class="string" id="6767991">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6768003">+</span>&nbsp;<span class="ident" id="6768005">index</span>&nbsp;<span class="op" id="6768011">+</span>&nbsp;<span class="string" id="6768013">&#34;]:4&#34;</span><span class="op" id="6768018">,</span>&nbsp;<span class="op" id="6768020">&amp;</span><span class="ident" id="6768021">TCPAddr</span><span class="op" id="6768028">{</span><span class="ident" id="6768029">IP</span><span class="op" id="6768031">:</span>&nbsp;<span class="ident" id="6768033">ParseIP</span><span class="op" id="6768040">(</span><span class="string" id="6768041">&#34;fe80::1&#34;</span><span class="op" id="6768050">)</span><span class="op" id="6768051">,</span>&nbsp;<span class="ident" id="6768053">Port</span><span class="op" id="6768057">:</span>&nbsp;<span class="num" id="6768059">4</span><span class="op" id="6768060">,</span>&nbsp;<span class="ident" id="6768062">Zone</span><span class="op" id="6768066">:</span>&nbsp;<span class="ident" id="6768068">index</span><span class="op" id="6768073">}</span><span class="op" id="6768074">,</span>&nbsp;<span class="builtintype" id="6768076">nil</span><span class="op" id="6768079">}</span><span class="op" id="6768080">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768084">}</span><span class="op" id="6768085">...</span><span class="op" id="6768088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768094">if</span>&nbsp;<span class="ident" id="6768097">ips</span><span class="op" id="6768100">,</span>&nbsp;<span class="ident" id="6768102">err</span>&nbsp;<span class="op" id="6768106">:=</span>&nbsp;<span class="ident" id="6768109">LookupIP</span><span class="op" id="6768117">(</span><span class="string" id="6768118">&#34;localhost&#34;</span><span class="op" id="6768129">)</span><span class="op" id="6768130">;</span>&nbsp;<span class="ident" id="6768132">err</span>&nbsp;<span class="op" id="6768136">==</span>&nbsp;<span class="builtintype" id="6768139">nil</span>&nbsp;<span class="op" id="6768143">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6768146">len</span><span class="op" id="6768149">(</span><span class="ident" id="6768150">ips</span><span class="op" id="6768153">)</span>&nbsp;<span class="op" id="6768155">&gt;</span>&nbsp;<span class="num" id="6768157">1</span>&nbsp;<span class="op" id="6768159">&amp;&amp;</span>&nbsp;<span class="ident" id="6768162">supportsIPv4</span>&nbsp;<span class="op" id="6768175">&amp;&amp;</span>&nbsp;<span class="ident" id="6768178">supportsIPv6</span>&nbsp;<span class="op" id="6768191">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768195">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6768215">=</span>&nbsp;<span class="builtinfunc" id="6768217">append</span><span class="op" id="6768223">(</span><span class="ident" id="6768224">resolveTCPAddrTests</span><span class="op" id="6768243">,</span>&nbsp;<span class="op" id="6768245">[</span><span class="op" id="6768246">]</span><span class="ident" id="6768247">resolveTCPAddrTest</span><span class="op" id="6768265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768270">{</span><span class="string" id="6768271">&#34;tcp&#34;</span><span class="op" id="6768276">,</span>&nbsp;<span class="string" id="6768278">&#34;localhost:5&#34;</span><span class="op" id="6768291">,</span>&nbsp;<span class="op" id="6768293">&amp;</span><span class="ident" id="6768294">TCPAddr</span><span class="op" id="6768301">{</span><span class="ident" id="6768302">IP</span><span class="op" id="6768304">:</span>&nbsp;<span class="ident" id="6768306">IPv4</span><span class="op" id="6768310">(</span><span class="num" id="6768311">127</span><span class="op" id="6768314">,</span>&nbsp;<span class="num" id="6768316">0</span><span class="op" id="6768317">,</span>&nbsp;<span class="num" id="6768319">0</span><span class="op" id="6768320">,</span>&nbsp;<span class="num" id="6768322">1</span><span class="op" id="6768323">)</span><span class="op" id="6768324">,</span>&nbsp;<span class="ident" id="6768326">Port</span><span class="op" id="6768330">:</span>&nbsp;<span class="num" id="6768332">5</span><span class="op" id="6768333">}</span><span class="op" id="6768334">,</span>&nbsp;<span class="builtintype" id="6768336">nil</span><span class="op" id="6768339">}</span><span class="op" id="6768340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768345">{</span><span class="string" id="6768346">&#34;tcp4&#34;</span><span class="op" id="6768352">,</span>&nbsp;<span class="string" id="6768354">&#34;localhost:6&#34;</span><span class="op" id="6768367">,</span>&nbsp;<span class="op" id="6768369">&amp;</span><span class="ident" id="6768370">TCPAddr</span><span class="op" id="6768377">{</span><span class="ident" id="6768378">IP</span><span class="op" id="6768380">:</span>&nbsp;<span class="ident" id="6768382">IPv4</span><span class="op" id="6768386">(</span><span class="num" id="6768387">127</span><span class="op" id="6768390">,</span>&nbsp;<span class="num" id="6768392">0</span><span class="op" id="6768393">,</span>&nbsp;<span class="num" id="6768395">0</span><span class="op" id="6768396">,</span>&nbsp;<span class="num" id="6768398">1</span><span class="op" id="6768399">)</span><span class="op" id="6768400">,</span>&nbsp;<span class="ident" id="6768402">Port</span><span class="op" id="6768406">:</span>&nbsp;<span class="num" id="6768408">6</span><span class="op" id="6768409">}</span><span class="op" id="6768410">,</span>&nbsp;<span class="builtintype" id="6768412">nil</span><span class="op" id="6768415">}</span><span class="op" id="6768416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768421">{</span><span class="string" id="6768422">&#34;tcp6&#34;</span><span class="op" id="6768428">,</span>&nbsp;<span class="string" id="6768430">&#34;localhost:7&#34;</span><span class="op" id="6768443">,</span>&nbsp;<span class="op" id="6768445">&amp;</span><span class="ident" id="6768446">TCPAddr</span><span class="op" id="6768453">{</span><span class="ident" id="6768454">IP</span><span class="op" id="6768456">:</span>&nbsp;<span class="ident" id="6768458">IPv6loopback</span><span class="op" id="6768470">,</span>&nbsp;<span class="ident" id="6768472">Port</span><span class="op" id="6768476">:</span>&nbsp;<span class="num" id="6768478">7</span><span class="op" id="6768479">}</span><span class="op" id="6768480">,</span>&nbsp;<span class="builtintype" id="6768482">nil</span><span class="op" id="6768485">}</span><span class="op" id="6768486">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768490">}</span><span class="op" id="6768491">...</span><span class="op" id="6768494">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768497">}</span><br>
<span class="lineno"></span><span class="op" id="6768499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6768502">func</span>&nbsp;<span class="ident" id="6768507">TestResolveTCPAddr</span><span class="op" id="6768525">(</span><span class="ident" id="6768526">t</span>&nbsp;<span class="op" id="6768528">*</span><span class="ident" id="6768529">testing</span><span class="op" id="6768536">.</span><span class="ident" id="6768537">T</span><span class="op" id="6768538">)</span>&nbsp;<span class="op" id="6768540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768543">for</span>&nbsp;<span class="ident" id="6768547">_</span><span class="op" id="6768548">,</span>&nbsp;<span class="ident" id="6768550">tt</span>&nbsp;<span class="op" id="6768553">:=</span>&nbsp;<span class="keyword" id="6768556">range</span>&nbsp;<span class="ident" id="6768562">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6768582">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768586">addr</span><span class="op" id="6768590">,</span>&nbsp;<span class="ident" id="6768592">err</span>&nbsp;<span class="op" id="6768596">:=</span>&nbsp;<span class="ident" id="6768599">ResolveTCPAddr</span><span class="op" id="6768613">(</span><span class="ident" id="6768614">tt</span><span class="op" id="6768616">.</span><span class="ident" id="6768617">net</span><span class="op" id="6768620">,</span>&nbsp;<span class="ident" id="6768622">tt</span><span class="op" id="6768624">.</span><span class="ident" id="6768625">litAddrOrName</span><span class="op" id="6768638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768642">if</span>&nbsp;<span class="ident" id="6768645">err</span>&nbsp;<span class="op" id="6768649">!=</span>&nbsp;<span class="ident" id="6768652">tt</span><span class="op" id="6768654">.</span><span class="ident" id="6768655">err</span>&nbsp;<span class="op" id="6768659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768664">t</span><span class="op" id="6768665">.</span><span class="ident" id="6768666">Fatalf</span><span class="op" id="6768672">(</span><span class="string" id="6768673">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6768708">,</span>&nbsp;<span class="ident" id="6768710">tt</span><span class="op" id="6768712">.</span><span class="ident" id="6768713">net</span><span class="op" id="6768716">,</span>&nbsp;<span class="ident" id="6768718">tt</span><span class="op" id="6768720">.</span><span class="ident" id="6768721">litAddrOrName</span><span class="op" id="6768734">,</span>&nbsp;<span class="ident" id="6768736">err</span><span class="op" id="6768739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768747">if</span>&nbsp;<span class="op" id="6768750">!</span><span class="ident" id="6768751">reflect</span><span class="op" id="6768758">.</span><span class="ident" id="6768759">DeepEqual</span><span class="op" id="6768768">(</span><span class="ident" id="6768769">addr</span><span class="op" id="6768773">,</span>&nbsp;<span class="ident" id="6768775">tt</span><span class="op" id="6768777">.</span><span class="ident" id="6768778">addr</span><span class="op" id="6768782">)</span>&nbsp;<span class="op" id="6768784">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768789">t</span><span class="op" id="6768790">.</span><span class="ident" id="6768791">Fatalf</span><span class="op" id="6768797">(</span><span class="string" id="6768798">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6768838">,</span>&nbsp;<span class="ident" id="6768840">tt</span><span class="op" id="6768842">.</span><span class="ident" id="6768843">net</span><span class="op" id="6768846">,</span>&nbsp;<span class="ident" id="6768848">tt</span><span class="op" id="6768850">.</span><span class="ident" id="6768851">litAddrOrName</span><span class="op" id="6768864">,</span>&nbsp;<span class="ident" id="6768866">addr</span><span class="op" id="6768870">,</span>&nbsp;<span class="ident" id="6768872">tt</span><span class="op" id="6768874">.</span><span class="ident" id="6768875">addr</span><span class="op" id="6768879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6768883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768887">if</span>&nbsp;<span class="ident" id="6768890">err</span>&nbsp;<span class="op" id="6768894">==</span>&nbsp;<span class="builtintype" id="6768897">nil</span>&nbsp;<span class="op" id="6768901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768906">str</span>&nbsp;<span class="op" id="6768910">:=</span>&nbsp;<span class="ident" id="6768913">addr</span><span class="op" id="6768917">.</span><span class="ident" id="6768918">String</span><span class="op" id="6768924">(</span><span class="op" id="6768925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768930">addr1</span><span class="op" id="6768935">,</span>&nbsp;<span class="ident" id="6768937">err</span>&nbsp;<span class="op" id="6768941">:=</span>&nbsp;<span class="ident" id="6768944">ResolveTCPAddr</span><span class="op" id="6768958">(</span><span class="ident" id="6768959">tt</span><span class="op" id="6768961">.</span><span class="ident" id="6768962">net</span><span class="op" id="6768965">,</span>&nbsp;<span class="ident" id="6768967">str</span><span class="op" id="6768970">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6768975">if</span>&nbsp;<span class="ident" id="6768978">err</span>&nbsp;<span class="op" id="6768982">!=</span>&nbsp;<span class="builtintype" id="6768985">nil</span>&nbsp;<span class="op" id="6768989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6768995">t</span><span class="op" id="6768996">.</span><span class="ident" id="6768997">Fatalf</span><span class="op" id="6769003">(</span><span class="string" id="6769004">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="6769042">,</span>&nbsp;<span class="ident" id="6769044">tt</span><span class="op" id="6769046">.</span><span class="ident" id="6769047">net</span><span class="op" id="6769050">,</span>&nbsp;<span class="ident" id="6769052">str</span><span class="op" id="6769055">,</span>&nbsp;<span class="ident" id="6769057">tt</span><span class="op" id="6769059">.</span><span class="ident" id="6769060">litAddrOrName</span><span class="op" id="6769073">,</span>&nbsp;<span class="ident" id="6769075">err</span><span class="op" id="6769078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769088">if</span>&nbsp;<span class="op" id="6769091">!</span><span class="ident" id="6769092">reflect</span><span class="op" id="6769099">.</span><span class="ident" id="6769100">DeepEqual</span><span class="op" id="6769109">(</span><span class="ident" id="6769110">addr1</span><span class="op" id="6769115">,</span>&nbsp;<span class="ident" id="6769117">addr</span><span class="op" id="6769121">)</span>&nbsp;<span class="op" id="6769123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769129">t</span><span class="op" id="6769130">.</span><span class="ident" id="6769131">Fatalf</span><span class="op" id="6769137">(</span><span class="string" id="6769138">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6769188">,</span>&nbsp;<span class="ident" id="6769190">tt</span><span class="op" id="6769192">.</span><span class="ident" id="6769193">net</span><span class="op" id="6769196">,</span>&nbsp;<span class="ident" id="6769198">str</span><span class="op" id="6769201">,</span>&nbsp;<span class="ident" id="6769203">tt</span><span class="op" id="6769205">.</span><span class="ident" id="6769206">litAddrOrName</span><span class="op" id="6769219">,</span>&nbsp;<span class="ident" id="6769221">addr1</span><span class="op" id="6769226">,</span>&nbsp;<span class="ident" id="6769228">addr</span><span class="op" id="6769232">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769244">}</span><br>
<span class="lineno"></span><span class="op" id="6769246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="6769249">var</span>&nbsp;<span class="ident" id="6769253">tcpListenerNameTests</span>&nbsp;<span class="op" id="6769274">=</span>&nbsp;<span class="op" id="6769276">[</span><span class="op" id="6769277">]</span><span class="keyword" id="6769278">struct</span>&nbsp;<span class="op" id="6769285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769288">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6769294">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769302">laddr</span>&nbsp;<span class="op" id="6769308">*</span><span class="ident" id="6769309">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="6769317">}</span><span class="op" id="6769318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769321">{</span><span class="string" id="6769322">&#34;tcp4&#34;</span><span class="op" id="6769328">,</span>&nbsp;<span class="op" id="6769330">&amp;</span><span class="ident" id="6769331">TCPAddr</span><span class="op" id="6769338">{</span><span class="ident" id="6769339">IP</span><span class="op" id="6769341">:</span>&nbsp;<span class="ident" id="6769343">IPv4</span><span class="op" id="6769347">(</span><span class="num" id="6769348">127</span><span class="op" id="6769351">,</span>&nbsp;<span class="num" id="6769353">0</span><span class="op" id="6769354">,</span>&nbsp;<span class="num" id="6769356">0</span><span class="op" id="6769357">,</span>&nbsp;<span class="num" id="6769359">1</span><span class="op" id="6769360">)</span><span class="op" id="6769361">}</span><span class="op" id="6769362">}</span><span class="op" id="6769363">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769366">{</span><span class="string" id="6769367">&#34;tcp4&#34;</span><span class="op" id="6769373">,</span>&nbsp;<span class="op" id="6769375">&amp;</span><span class="ident" id="6769376">TCPAddr</span><span class="op" id="6769383">{</span><span class="op" id="6769384">}</span><span class="op" id="6769385">}</span><span class="op" id="6769386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769389">{</span><span class="string" id="6769390">&#34;tcp4&#34;</span><span class="op" id="6769396">,</span>&nbsp;<span class="builtintype" id="6769398">nil</span><span class="op" id="6769401">}</span><span class="op" id="6769402">,</span><br>
<span class="lineno"></span><span class="op" id="6769404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6769407">func</span>&nbsp;<span class="ident" id="6769412">TestTCPListenerName</span><span class="op" id="6769431">(</span><span class="ident" id="6769432">t</span>&nbsp;<span class="op" id="6769434">*</span><span class="ident" id="6769435">testing</span><span class="op" id="6769442">.</span><span class="ident" id="6769443">T</span><span class="op" id="6769444">)</span>&nbsp;<span class="op" id="6769446">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769449">if</span>&nbsp;<span class="ident" id="6769452">testing</span><span class="op" id="6769459">.</span><span class="ident" id="6769460">Short</span><span class="op" id="6769465">(</span><span class="op" id="6769466">)</span>&nbsp;<span class="op" id="6769468">||</span>&nbsp;<span class="op" id="6769471">!</span><span class="op" id="6769472">*</span><span class="ident" id="6769473">testExternal</span>&nbsp;<span class="op" id="6769486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769490">t</span><span class="op" id="6769491">.</span><span class="ident" id="6769492">Skip</span><span class="op" id="6769496">(</span><span class="string" id="6769497">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6769538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769545">for</span>&nbsp;<span class="ident" id="6769549">_</span><span class="op" id="6769550">,</span>&nbsp;<span class="ident" id="6769552">tt</span>&nbsp;<span class="op" id="6769555">:=</span>&nbsp;<span class="keyword" id="6769558">range</span>&nbsp;<span class="ident" id="6769564">tcpListenerNameTests</span>&nbsp;<span class="op" id="6769585">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769589">ln</span><span class="op" id="6769591">,</span>&nbsp;<span class="ident" id="6769593">err</span>&nbsp;<span class="op" id="6769597">:=</span>&nbsp;<span class="ident" id="6769600">ListenTCP</span><span class="op" id="6769609">(</span><span class="ident" id="6769610">tt</span><span class="op" id="6769612">.</span><span class="ident" id="6769613">net</span><span class="op" id="6769616">,</span>&nbsp;<span class="ident" id="6769618">tt</span><span class="op" id="6769620">.</span><span class="ident" id="6769621">laddr</span><span class="op" id="6769626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769630">if</span>&nbsp;<span class="ident" id="6769633">err</span>&nbsp;<span class="op" id="6769637">!=</span>&nbsp;<span class="builtintype" id="6769640">nil</span>&nbsp;<span class="op" id="6769644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769649">t</span><span class="op" id="6769650">.</span><span class="ident" id="6769651">Fatalf</span><span class="op" id="6769657">(</span><span class="string" id="6769658">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6769680">,</span>&nbsp;<span class="ident" id="6769682">err</span><span class="op" id="6769685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769693">defer</span>&nbsp;<span class="ident" id="6769699">ln</span><span class="op" id="6769701">.</span><span class="ident" id="6769702">Close</span><span class="op" id="6769707">(</span><span class="op" id="6769708">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769712">la</span>&nbsp;<span class="op" id="6769715">:=</span>&nbsp;<span class="ident" id="6769718">ln</span><span class="op" id="6769720">.</span><span class="ident" id="6769721">Addr</span><span class="op" id="6769725">(</span><span class="op" id="6769726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769730">if</span>&nbsp;<span class="ident" id="6769733">a</span><span class="op" id="6769734">,</span>&nbsp;<span class="ident" id="6769736">ok</span>&nbsp;<span class="op" id="6769739">:=</span>&nbsp;<span class="ident" id="6769742">la</span><span class="op" id="6769744">.</span><span class="op" id="6769745">(</span><span class="op" id="6769746">*</span><span class="ident" id="6769747">TCPAddr</span><span class="op" id="6769754">)</span><span class="op" id="6769755">;</span>&nbsp;<span class="op" id="6769757">!</span><span class="ident" id="6769758">ok</span>&nbsp;<span class="op" id="6769761">||</span>&nbsp;<span class="ident" id="6769764">a</span><span class="op" id="6769765">.</span><span class="ident" id="6769766">Port</span>&nbsp;<span class="op" id="6769771">==</span>&nbsp;<span class="num" id="6769774">0</span>&nbsp;<span class="op" id="6769776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769781">t</span><span class="op" id="6769782">.</span><span class="ident" id="6769783">Fatalf</span><span class="op" id="6769789">(</span><span class="string" id="6769790">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="6769851">,</span>&nbsp;<span class="ident" id="6769853">la</span><span class="op" id="6769855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6769862">}</span><br>
<span class="lineno">375</span><span class="op" id="6769864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6769867">func</span>&nbsp;<span class="ident" id="6769872">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="6769899">(</span><span class="ident" id="6769900">t</span>&nbsp;<span class="op" id="6769902">*</span><span class="ident" id="6769903">testing</span><span class="op" id="6769910">.</span><span class="ident" id="6769911">T</span><span class="op" id="6769912">)</span>&nbsp;<span class="op" id="6769914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6769917">if</span>&nbsp;<span class="ident" id="6769920">testing</span><span class="op" id="6769927">.</span><span class="ident" id="6769928">Short</span><span class="op" id="6769933">(</span><span class="op" id="6769934">)</span>&nbsp;<span class="op" id="6769936">||</span>&nbsp;<span class="op" id="6769939">!</span><span class="op" id="6769940">*</span><span class="ident" id="6769941">testExternal</span>&nbsp;<span class="op" id="6769954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6769958">t</span><span class="op" id="6769959">.</span><span class="ident" id="6769960">Skip</span><span class="op" id="6769964">(</span><span class="string" id="6769965">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6770006">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770012">if</span>&nbsp;<span class="op" id="6770015">!</span><span class="ident" id="6770016">supportsIPv6</span>&nbsp;<span class="op" id="6770029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770033">t</span><span class="op" id="6770034">.</span><span class="ident" id="6770035">Skip</span><span class="op" id="6770039">(</span><span class="string" id="6770040">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6770063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770069">ifi</span>&nbsp;<span class="op" id="6770073">:=</span>&nbsp;<span class="ident" id="6770076">loopbackInterface</span><span class="op" id="6770093">(</span><span class="op" id="6770094">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770097">if</span>&nbsp;<span class="ident" id="6770100">ifi</span>&nbsp;<span class="op" id="6770104">==</span>&nbsp;<span class="builtintype" id="6770107">nil</span>&nbsp;<span class="op" id="6770111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770115">t</span><span class="op" id="6770116">.</span><span class="ident" id="6770117">Skip</span><span class="op" id="6770121">(</span><span class="string" id="6770122">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="6770152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770158">laddr</span>&nbsp;<span class="op" id="6770164">:=</span>&nbsp;<span class="ident" id="6770167">ipv6LinkLocalUnicastAddr</span><span class="op" id="6770191">(</span><span class="ident" id="6770192">ifi</span><span class="op" id="6770195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770198">if</span>&nbsp;<span class="ident" id="6770201">laddr</span>&nbsp;<span class="op" id="6770207">==</span>&nbsp;<span class="string" id="6770210">&#34;&#34;</span>&nbsp;<span class="op" id="6770213">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770217">t</span><span class="op" id="6770218">.</span><span class="ident" id="6770219">Skip</span><span class="op" id="6770223">(</span><span class="string" id="6770224">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="6770268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770275">type</span>&nbsp;<span class="ident" id="6770280">test</span>&nbsp;<span class="keyword" id="6770285">struct</span>&nbsp;<span class="op" id="6770292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770296">net</span><span class="op" id="6770299">,</span>&nbsp;<span class="ident" id="6770301">addr</span>&nbsp;&nbsp;<span class="builtintype" id="6770307">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770316">nameLookup</span>&nbsp;<span class="builtintype" id="6770327">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770336">var</span>&nbsp;<span class="ident" id="6770340">tests</span>&nbsp;<span class="op" id="6770346">=</span>&nbsp;<span class="op" id="6770348">[</span><span class="op" id="6770349">]</span><span class="ident" id="6770350">test</span><span class="op" id="6770354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770358">{</span><span class="string" id="6770359">&#34;tcp&#34;</span><span class="op" id="6770364">,</span>&nbsp;<span class="string" id="6770366">&#34;[&#34;</span>&nbsp;<span class="op" id="6770370">+</span>&nbsp;<span class="ident" id="6770372">laddr</span>&nbsp;<span class="op" id="6770378">+</span>&nbsp;<span class="string" id="6770380">&#34;%&#34;</span>&nbsp;<span class="op" id="6770384">+</span>&nbsp;<span class="ident" id="6770386">ifi</span><span class="op" id="6770389">.</span><span class="ident" id="6770390">Name</span>&nbsp;<span class="op" id="6770395">+</span>&nbsp;<span class="string" id="6770397">&#34;]:0&#34;</span><span class="op" id="6770402">,</span>&nbsp;<span class="builtintype" id="6770404">false</span><span class="op" id="6770409">}</span><span class="op" id="6770410">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770414">{</span><span class="string" id="6770415">&#34;tcp6&#34;</span><span class="op" id="6770421">,</span>&nbsp;<span class="string" id="6770423">&#34;[&#34;</span>&nbsp;<span class="op" id="6770427">+</span>&nbsp;<span class="ident" id="6770429">laddr</span>&nbsp;<span class="op" id="6770435">+</span>&nbsp;<span class="string" id="6770437">&#34;%&#34;</span>&nbsp;<span class="op" id="6770441">+</span>&nbsp;<span class="ident" id="6770443">ifi</span><span class="op" id="6770446">.</span><span class="ident" id="6770447">Name</span>&nbsp;<span class="op" id="6770452">+</span>&nbsp;<span class="string" id="6770454">&#34;]:0&#34;</span><span class="op" id="6770459">,</span>&nbsp;<span class="builtintype" id="6770461">false</span><span class="op" id="6770466">}</span><span class="op" id="6770467">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770473">switch</span>&nbsp;<span class="ident" id="6770480">runtime</span><span class="op" id="6770487">.</span><span class="ident" id="6770488">GOOS</span>&nbsp;<span class="op" id="6770493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770496">case</span>&nbsp;<span class="string" id="6770501">&#34;darwin&#34;</span><span class="op" id="6770509">,</span>&nbsp;<span class="string" id="6770511">&#34;freebsd&#34;</span><span class="op" id="6770520">,</span>&nbsp;<span class="string" id="6770522">&#34;openbsd&#34;</span><span class="op" id="6770531">,</span>&nbsp;<span class="string" id="6770533">&#34;netbsd&#34;</span><span class="op" id="6770541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770545">tests</span>&nbsp;<span class="op" id="6770551">=</span>&nbsp;<span class="builtinfunc" id="6770553">append</span><span class="op" id="6770559">(</span><span class="ident" id="6770560">tests</span><span class="op" id="6770565">,</span>&nbsp;<span class="op" id="6770567">[</span><span class="op" id="6770568">]</span><span class="ident" id="6770569">test</span><span class="op" id="6770573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770578">{</span><span class="string" id="6770579">&#34;tcp&#34;</span><span class="op" id="6770584">,</span>&nbsp;<span class="string" id="6770586">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6770600">+</span>&nbsp;<span class="ident" id="6770602">ifi</span><span class="op" id="6770605">.</span><span class="ident" id="6770606">Name</span>&nbsp;<span class="op" id="6770611">+</span>&nbsp;<span class="string" id="6770613">&#34;]:0&#34;</span><span class="op" id="6770618">,</span>&nbsp;<span class="builtintype" id="6770620">true</span><span class="op" id="6770624">}</span><span class="op" id="6770625">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770630">{</span><span class="string" id="6770631">&#34;tcp6&#34;</span><span class="op" id="6770637">,</span>&nbsp;<span class="string" id="6770639">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6770653">+</span>&nbsp;<span class="ident" id="6770655">ifi</span><span class="op" id="6770658">.</span><span class="ident" id="6770659">Name</span>&nbsp;<span class="op" id="6770664">+</span>&nbsp;<span class="string" id="6770666">&#34;]:0&#34;</span><span class="op" id="6770671">,</span>&nbsp;<span class="builtintype" id="6770673">true</span><span class="op" id="6770677">}</span><span class="op" id="6770678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770682">}</span><span class="op" id="6770683">...</span><span class="op" id="6770686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770689">case</span>&nbsp;<span class="string" id="6770694">&#34;linux&#34;</span><span class="op" id="6770701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770705">tests</span>&nbsp;<span class="op" id="6770711">=</span>&nbsp;<span class="builtinfunc" id="6770713">append</span><span class="op" id="6770719">(</span><span class="ident" id="6770720">tests</span><span class="op" id="6770725">,</span>&nbsp;<span class="op" id="6770727">[</span><span class="op" id="6770728">]</span><span class="ident" id="6770729">test</span><span class="op" id="6770733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770738">{</span><span class="string" id="6770739">&#34;tcp&#34;</span><span class="op" id="6770744">,</span>&nbsp;<span class="string" id="6770746">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6770764">+</span>&nbsp;<span class="ident" id="6770766">ifi</span><span class="op" id="6770769">.</span><span class="ident" id="6770770">Name</span>&nbsp;<span class="op" id="6770775">+</span>&nbsp;<span class="string" id="6770777">&#34;]:0&#34;</span><span class="op" id="6770782">,</span>&nbsp;<span class="builtintype" id="6770784">true</span><span class="op" id="6770788">}</span><span class="op" id="6770789">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770794">{</span><span class="string" id="6770795">&#34;tcp6&#34;</span><span class="op" id="6770801">,</span>&nbsp;<span class="string" id="6770803">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6770821">+</span>&nbsp;<span class="ident" id="6770823">ifi</span><span class="op" id="6770826">.</span><span class="ident" id="6770827">Name</span>&nbsp;<span class="op" id="6770832">+</span>&nbsp;<span class="string" id="6770834">&#34;]:0&#34;</span><span class="op" id="6770839">,</span>&nbsp;<span class="builtintype" id="6770841">true</span><span class="op" id="6770845">}</span><span class="op" id="6770846">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770850">}</span><span class="op" id="6770851">...</span><span class="op" id="6770854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6770857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770860">for</span>&nbsp;<span class="ident" id="6770864">_</span><span class="op" id="6770865">,</span>&nbsp;<span class="ident" id="6770867">tt</span>&nbsp;<span class="op" id="6770870">:=</span>&nbsp;<span class="keyword" id="6770873">range</span>&nbsp;<span class="ident" id="6770879">tests</span>&nbsp;<span class="op" id="6770885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6770889">ln</span><span class="op" id="6770891">,</span>&nbsp;<span class="ident" id="6770893">err</span>&nbsp;<span class="op" id="6770897">:=</span>&nbsp;<span class="ident" id="6770900">Listen</span><span class="op" id="6770906">(</span><span class="ident" id="6770907">tt</span><span class="op" id="6770909">.</span><span class="ident" id="6770910">net</span><span class="op" id="6770913">,</span>&nbsp;<span class="ident" id="6770915">tt</span><span class="op" id="6770917">.</span><span class="ident" id="6770918">addr</span><span class="op" id="6770922">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6770926">if</span>&nbsp;<span class="ident" id="6770929">err</span>&nbsp;<span class="op" id="6770933">!=</span>&nbsp;<span class="builtintype" id="6770936">nil</span>&nbsp;<span class="op" id="6770940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6770945">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6770991">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771040">t</span><span class="op" id="6771041">.</span><span class="ident" id="6771042">Logf</span><span class="op" id="6771046">(</span><span class="string" id="6771047">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6771066">,</span>&nbsp;<span class="ident" id="6771068">err</span><span class="op" id="6771071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771076">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771091">defer</span>&nbsp;<span class="ident" id="6771097">ln</span><span class="op" id="6771099">.</span><span class="ident" id="6771100">Close</span><span class="op" id="6771105">(</span><span class="op" id="6771106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771110">if</span>&nbsp;<span class="ident" id="6771113">la</span><span class="op" id="6771115">,</span>&nbsp;<span class="ident" id="6771117">ok</span>&nbsp;<span class="op" id="6771120">:=</span>&nbsp;<span class="ident" id="6771123">ln</span><span class="op" id="6771125">.</span><span class="ident" id="6771126">Addr</span><span class="op" id="6771130">(</span><span class="op" id="6771131">)</span><span class="op" id="6771132">.</span><span class="op" id="6771133">(</span><span class="op" id="6771134">*</span><span class="ident" id="6771135">TCPAddr</span><span class="op" id="6771142">)</span><span class="op" id="6771143">;</span>&nbsp;<span class="op" id="6771145">!</span><span class="ident" id="6771146">ok</span>&nbsp;<span class="op" id="6771149">||</span>&nbsp;<span class="op" id="6771152">!</span><span class="ident" id="6771153">tt</span><span class="op" id="6771155">.</span><span class="ident" id="6771156">nameLookup</span>&nbsp;<span class="op" id="6771167">&amp;&amp;</span>&nbsp;<span class="ident" id="6771170">la</span><span class="op" id="6771172">.</span><span class="ident" id="6771173">Zone</span>&nbsp;<span class="op" id="6771178">==</span>&nbsp;<span class="string" id="6771181">&#34;&#34;</span>&nbsp;<span class="op" id="6771184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771189">t</span><span class="op" id="6771190">.</span><span class="ident" id="6771191">Fatalf</span><span class="op" id="6771197">(</span><span class="string" id="6771198">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6771254">,</span>&nbsp;<span class="ident" id="6771256">la</span><span class="op" id="6771258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771262">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771267">done</span>&nbsp;<span class="op" id="6771272">:=</span>&nbsp;<span class="builtinfunc" id="6771275">make</span><span class="op" id="6771279">(</span><span class="keyword" id="6771280">chan</span>&nbsp;<span class="builtintype" id="6771285">int</span><span class="op" id="6771288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771292">go</span>&nbsp;<span class="ident" id="6771295">transponder</span><span class="op" id="6771306">(</span><span class="ident" id="6771307">t</span><span class="op" id="6771308">,</span>&nbsp;<span class="ident" id="6771310">ln</span><span class="op" id="6771312">,</span>&nbsp;<span class="ident" id="6771314">done</span><span class="op" id="6771318">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771323">c</span><span class="op" id="6771324">,</span>&nbsp;<span class="ident" id="6771326">err</span>&nbsp;<span class="op" id="6771330">:=</span>&nbsp;<span class="ident" id="6771333">Dial</span><span class="op" id="6771337">(</span><span class="ident" id="6771338">tt</span><span class="op" id="6771340">.</span><span class="ident" id="6771341">net</span><span class="op" id="6771344">,</span>&nbsp;<span class="ident" id="6771346">ln</span><span class="op" id="6771348">.</span><span class="ident" id="6771349">Addr</span><span class="op" id="6771353">(</span><span class="op" id="6771354">)</span><span class="op" id="6771355">.</span><span class="ident" id="6771356">String</span><span class="op" id="6771362">(</span><span class="op" id="6771363">)</span><span class="op" id="6771364">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771368">if</span>&nbsp;<span class="ident" id="6771371">err</span>&nbsp;<span class="op" id="6771375">!=</span>&nbsp;<span class="builtintype" id="6771378">nil</span>&nbsp;<span class="op" id="6771382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771387">t</span><span class="op" id="6771388">.</span><span class="ident" id="6771389">Fatalf</span><span class="op" id="6771395">(</span><span class="string" id="6771396">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6771413">,</span>&nbsp;<span class="ident" id="6771415">err</span><span class="op" id="6771418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771426">defer</span>&nbsp;<span class="ident" id="6771432">c</span><span class="op" id="6771433">.</span><span class="ident" id="6771434">Close</span><span class="op" id="6771439">(</span><span class="op" id="6771440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771444">if</span>&nbsp;<span class="ident" id="6771447">la</span><span class="op" id="6771449">,</span>&nbsp;<span class="ident" id="6771451">ok</span>&nbsp;<span class="op" id="6771454">:=</span>&nbsp;<span class="ident" id="6771457">c</span><span class="op" id="6771458">.</span><span class="ident" id="6771459">LocalAddr</span><span class="op" id="6771468">(</span><span class="op" id="6771469">)</span><span class="op" id="6771470">.</span><span class="op" id="6771471">(</span><span class="op" id="6771472">*</span><span class="ident" id="6771473">TCPAddr</span><span class="op" id="6771480">)</span><span class="op" id="6771481">;</span>&nbsp;<span class="op" id="6771483">!</span><span class="ident" id="6771484">ok</span>&nbsp;<span class="op" id="6771487">||</span>&nbsp;<span class="op" id="6771490">!</span><span class="ident" id="6771491">tt</span><span class="op" id="6771493">.</span><span class="ident" id="6771494">nameLookup</span>&nbsp;<span class="op" id="6771505">&amp;&amp;</span>&nbsp;<span class="ident" id="6771508">la</span><span class="op" id="6771510">.</span><span class="ident" id="6771511">Zone</span>&nbsp;<span class="op" id="6771516">==</span>&nbsp;<span class="string" id="6771519">&#34;&#34;</span>&nbsp;<span class="op" id="6771522">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771527">t</span><span class="op" id="6771528">.</span><span class="ident" id="6771529">Fatalf</span><span class="op" id="6771535">(</span><span class="string" id="6771536">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6771592">,</span>&nbsp;<span class="ident" id="6771594">la</span><span class="op" id="6771596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771604">if</span>&nbsp;<span class="ident" id="6771607">ra</span><span class="op" id="6771609">,</span>&nbsp;<span class="ident" id="6771611">ok</span>&nbsp;<span class="op" id="6771614">:=</span>&nbsp;<span class="ident" id="6771617">c</span><span class="op" id="6771618">.</span><span class="ident" id="6771619">RemoteAddr</span><span class="op" id="6771629">(</span><span class="op" id="6771630">)</span><span class="op" id="6771631">.</span><span class="op" id="6771632">(</span><span class="op" id="6771633">*</span><span class="ident" id="6771634">TCPAddr</span><span class="op" id="6771641">)</span><span class="op" id="6771642">;</span>&nbsp;<span class="op" id="6771644">!</span><span class="ident" id="6771645">ok</span>&nbsp;<span class="op" id="6771648">||</span>&nbsp;<span class="op" id="6771651">!</span><span class="ident" id="6771652">tt</span><span class="op" id="6771654">.</span><span class="ident" id="6771655">nameLookup</span>&nbsp;<span class="op" id="6771666">&amp;&amp;</span>&nbsp;<span class="ident" id="6771669">ra</span><span class="op" id="6771671">.</span><span class="ident" id="6771672">Zone</span>&nbsp;<span class="op" id="6771677">==</span>&nbsp;<span class="string" id="6771680">&#34;&#34;</span>&nbsp;<span class="op" id="6771683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771688">t</span><span class="op" id="6771689">.</span><span class="ident" id="6771690">Fatalf</span><span class="op" id="6771696">(</span><span class="string" id="6771697">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6771753">,</span>&nbsp;<span class="ident" id="6771755">ra</span><span class="op" id="6771757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771761">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771766">if</span>&nbsp;<span class="ident" id="6771769">_</span><span class="op" id="6771770">,</span>&nbsp;<span class="ident" id="6771772">err</span>&nbsp;<span class="op" id="6771776">:=</span>&nbsp;<span class="ident" id="6771779">c</span><span class="op" id="6771780">.</span><span class="ident" id="6771781">Write</span><span class="op" id="6771786">(</span><span class="op" id="6771787">[</span><span class="op" id="6771788">]</span><span class="builtintype" id="6771789">byte</span><span class="op" id="6771793">(</span><span class="string" id="6771794">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="6771824">)</span><span class="op" id="6771825">)</span><span class="op" id="6771826">;</span>&nbsp;<span class="ident" id="6771828">err</span>&nbsp;<span class="op" id="6771832">!=</span>&nbsp;<span class="builtintype" id="6771835">nil</span>&nbsp;<span class="op" id="6771839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771844">t</span><span class="op" id="6771845">.</span><span class="ident" id="6771846">Fatalf</span><span class="op" id="6771852">(</span><span class="string" id="6771853">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6771876">,</span>&nbsp;<span class="ident" id="6771878">err</span><span class="op" id="6771881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771889">b</span>&nbsp;<span class="op" id="6771891">:=</span>&nbsp;<span class="builtinfunc" id="6771894">make</span><span class="op" id="6771898">(</span><span class="op" id="6771899">[</span><span class="op" id="6771900">]</span><span class="builtintype" id="6771901">byte</span><span class="op" id="6771905">,</span>&nbsp;<span class="num" id="6771907">32</span><span class="op" id="6771909">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6771913">if</span>&nbsp;<span class="ident" id="6771916">_</span><span class="op" id="6771917">,</span>&nbsp;<span class="ident" id="6771919">err</span>&nbsp;<span class="op" id="6771923">:=</span>&nbsp;<span class="ident" id="6771926">c</span><span class="op" id="6771927">.</span><span class="ident" id="6771928">Read</span><span class="op" id="6771932">(</span><span class="ident" id="6771933">b</span><span class="op" id="6771934">)</span><span class="op" id="6771935">;</span>&nbsp;<span class="ident" id="6771937">err</span>&nbsp;<span class="op" id="6771941">!=</span>&nbsp;<span class="builtintype" id="6771944">nil</span>&nbsp;<span class="op" id="6771948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6771953">t</span><span class="op" id="6771954">.</span><span class="ident" id="6771955">Fatalf</span><span class="op" id="6771961">(</span><span class="string" id="6771962">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6771984">,</span>&nbsp;<span class="ident" id="6771986">err</span><span class="op" id="6771989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6771998">&lt;-</span><span class="ident" id="6772000">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772006">}</span><br>
<span class="lineno"></span><span class="op" id="6772008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6772011">func</span>&nbsp;<span class="ident" id="6772016">TestTCPConcurrentAccept</span><span class="op" id="6772039">(</span><span class="ident" id="6772040">t</span>&nbsp;<span class="op" id="6772042">*</span><span class="ident" id="6772043">testing</span><span class="op" id="6772050">.</span><span class="ident" id="6772051">T</span><span class="op" id="6772052">)</span>&nbsp;<span class="op" id="6772054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772057">defer</span>&nbsp;<span class="ident" id="6772063">runtime</span><span class="op" id="6772070">.</span><span class="ident" id="6772071">GOMAXPROCS</span><span class="op" id="6772081">(</span><span class="ident" id="6772082">runtime</span><span class="op" id="6772089">.</span><span class="ident" id="6772090">GOMAXPROCS</span><span class="op" id="6772100">(</span><span class="num" id="6772101">4</span><span class="op" id="6772102">)</span><span class="op" id="6772103">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772106">ln</span><span class="op" id="6772108">,</span>&nbsp;<span class="ident" id="6772110">err</span>&nbsp;<span class="op" id="6772114">:=</span>&nbsp;<span class="ident" id="6772117">Listen</span><span class="op" id="6772123">(</span><span class="string" id="6772124">&#34;tcp&#34;</span><span class="op" id="6772129">,</span>&nbsp;<span class="string" id="6772131">&#34;127.0.0.1:0&#34;</span><span class="op" id="6772144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772147">if</span>&nbsp;<span class="ident" id="6772150">err</span>&nbsp;<span class="op" id="6772154">!=</span>&nbsp;<span class="builtintype" id="6772157">nil</span>&nbsp;<span class="op" id="6772161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772165">t</span><span class="op" id="6772166">.</span><span class="ident" id="6772167">Fatalf</span><span class="op" id="6772173">(</span><span class="string" id="6772174">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6772193">,</span>&nbsp;<span class="ident" id="6772195">err</span><span class="op" id="6772198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772204">const</span>&nbsp;<span class="ident" id="6772210">N</span>&nbsp;<span class="op" id="6772212">=</span>&nbsp;<span class="num" id="6772214">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772218">var</span>&nbsp;<span class="ident" id="6772222">wg</span>&nbsp;<span class="ident" id="6772225">sync</span><span class="op" id="6772229">.</span><span class="ident" id="6772230">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772241">wg</span><span class="op" id="6772243">.</span><span class="ident" id="6772244">Add</span><span class="op" id="6772247">(</span><span class="ident" id="6772248">N</span><span class="op" id="6772249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772252">for</span>&nbsp;<span class="ident" id="6772256">i</span>&nbsp;<span class="op" id="6772258">:=</span>&nbsp;<span class="num" id="6772261">0</span><span class="op" id="6772262">;</span>&nbsp;<span class="ident" id="6772264">i</span>&nbsp;<span class="op" id="6772266">&lt;</span>&nbsp;<span class="ident" id="6772268">N</span><span class="op" id="6772269">;</span>&nbsp;<span class="ident" id="6772271">i</span><span class="op" id="6772272">++</span>&nbsp;<span class="op" id="6772275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772279">go</span>&nbsp;<span class="keyword" id="6772282">func</span><span class="op" id="6772286">(</span><span class="op" id="6772287">)</span>&nbsp;<span class="op" id="6772289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772294">for</span>&nbsp;<span class="op" id="6772298">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772304">c</span><span class="op" id="6772305">,</span>&nbsp;<span class="ident" id="6772307">err</span>&nbsp;<span class="op" id="6772311">:=</span>&nbsp;<span class="ident" id="6772314">ln</span><span class="op" id="6772316">.</span><span class="ident" id="6772317">Accept</span><span class="op" id="6772323">(</span><span class="op" id="6772324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772330">if</span>&nbsp;<span class="ident" id="6772333">err</span>&nbsp;<span class="op" id="6772337">!=</span>&nbsp;<span class="builtintype" id="6772340">nil</span>&nbsp;<span class="op" id="6772344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772351">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772367">c</span><span class="op" id="6772368">.</span><span class="ident" id="6772369">Close</span><span class="op" id="6772374">(</span><span class="op" id="6772375">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772385">wg</span><span class="op" id="6772387">.</span><span class="ident" id="6772388">Done</span><span class="op" id="6772392">(</span><span class="op" id="6772393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772397">}</span><span class="op" id="6772398">(</span><span class="op" id="6772399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772405">attempts</span>&nbsp;<span class="op" id="6772414">:=</span>&nbsp;<span class="num" id="6772417">10</span>&nbsp;<span class="op" id="6772420">*</span>&nbsp;<span class="ident" id="6772422">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772425">fails</span>&nbsp;<span class="op" id="6772431">:=</span>&nbsp;<span class="num" id="6772434">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772437">d</span>&nbsp;<span class="op" id="6772439">:=</span>&nbsp;<span class="op" id="6772442">&amp;</span><span class="ident" id="6772443">Dialer</span><span class="op" id="6772449">{</span><span class="ident" id="6772450">Timeout</span><span class="op" id="6772457">:</span>&nbsp;<span class="num" id="6772459">200</span>&nbsp;<span class="op" id="6772463">*</span>&nbsp;<span class="ident" id="6772465">time</span><span class="op" id="6772469">.</span><span class="ident" id="6772470">Millisecond</span><span class="op" id="6772481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772484">for</span>&nbsp;<span class="ident" id="6772488">i</span>&nbsp;<span class="op" id="6772490">:=</span>&nbsp;<span class="num" id="6772493">0</span><span class="op" id="6772494">;</span>&nbsp;<span class="ident" id="6772496">i</span>&nbsp;<span class="op" id="6772498">&lt;</span>&nbsp;<span class="ident" id="6772500">attempts</span><span class="op" id="6772508">;</span>&nbsp;<span class="ident" id="6772510">i</span><span class="op" id="6772511">++</span>&nbsp;<span class="op" id="6772514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772518">c</span><span class="op" id="6772519">,</span>&nbsp;<span class="ident" id="6772521">err</span>&nbsp;<span class="op" id="6772525">:=</span>&nbsp;<span class="ident" id="6772528">d</span><span class="op" id="6772529">.</span><span class="ident" id="6772530">Dial</span><span class="op" id="6772534">(</span><span class="string" id="6772535">&#34;tcp&#34;</span><span class="op" id="6772540">,</span>&nbsp;<span class="ident" id="6772542">ln</span><span class="op" id="6772544">.</span><span class="ident" id="6772545">Addr</span><span class="op" id="6772549">(</span><span class="op" id="6772550">)</span><span class="op" id="6772551">.</span><span class="ident" id="6772552">String</span><span class="op" id="6772558">(</span><span class="op" id="6772559">)</span><span class="op" id="6772560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772564">if</span>&nbsp;<span class="ident" id="6772567">err</span>&nbsp;<span class="op" id="6772571">!=</span>&nbsp;<span class="builtintype" id="6772574">nil</span>&nbsp;<span class="op" id="6772578">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772583">fails</span><span class="op" id="6772588">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772593">}</span>&nbsp;<span class="keyword" id="6772595">else</span>&nbsp;<span class="op" id="6772600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772605">c</span><span class="op" id="6772606">.</span><span class="ident" id="6772607">Close</span><span class="op" id="6772612">(</span><span class="op" id="6772613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772620">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772623">ln</span><span class="op" id="6772625">.</span><span class="ident" id="6772626">Close</span><span class="op" id="6772631">(</span><span class="op" id="6772632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772635">wg</span><span class="op" id="6772637">.</span><span class="ident" id="6772638">Wait</span><span class="op" id="6772642">(</span><span class="op" id="6772643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772646">if</span>&nbsp;<span class="ident" id="6772649">fails</span>&nbsp;<span class="op" id="6772655">&gt;</span>&nbsp;<span class="ident" id="6772657">attempts</span><span class="op" id="6772665">/</span><span class="num" id="6772666">9</span>&nbsp;<span class="op" id="6772668">{</span>&nbsp;<span class="comment" id="6772670">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772700">t</span><span class="op" id="6772701">.</span><span class="ident" id="6772702">Fatalf</span><span class="op" id="6772708">(</span><span class="string" id="6772709">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6772735">,</span>&nbsp;<span class="ident" id="6772737">fails</span><span class="op" id="6772742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772745">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772748">if</span>&nbsp;<span class="ident" id="6772751">fails</span>&nbsp;<span class="op" id="6772757">&gt;</span>&nbsp;<span class="num" id="6772759">0</span>&nbsp;<span class="op" id="6772761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772765">t</span><span class="op" id="6772766">.</span><span class="ident" id="6772767">Logf</span><span class="op" id="6772771">(</span><span class="string" id="6772772">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="6772795">,</span>&nbsp;<span class="ident" id="6772797">fails</span><span class="op" id="6772802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772805">}</span><br>
<span class="lineno"></span><span class="op" id="6772807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="6772810">func</span>&nbsp;<span class="ident" id="6772815">TestTCPReadWriteMallocs</span><span class="op" id="6772838">(</span><span class="ident" id="6772839">t</span>&nbsp;<span class="op" id="6772841">*</span><span class="ident" id="6772842">testing</span><span class="op" id="6772849">.</span><span class="ident" id="6772850">T</span><span class="op" id="6772851">)</span>&nbsp;<span class="op" id="6772853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772856">if</span>&nbsp;<span class="ident" id="6772859">testing</span><span class="op" id="6772866">.</span><span class="ident" id="6772867">Short</span><span class="op" id="6772872">(</span><span class="op" id="6772873">)</span>&nbsp;<span class="op" id="6772875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772879">t</span><span class="op" id="6772880">.</span><span class="ident" id="6772881">Skip</span><span class="op" id="6772885">(</span><span class="string" id="6772886">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6772923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6772926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772929">ln</span><span class="op" id="6772931">,</span>&nbsp;<span class="ident" id="6772933">err</span>&nbsp;<span class="op" id="6772937">:=</span>&nbsp;<span class="ident" id="6772940">Listen</span><span class="op" id="6772946">(</span><span class="string" id="6772947">&#34;tcp&#34;</span><span class="op" id="6772952">,</span>&nbsp;<span class="string" id="6772954">&#34;127.0.0.1:0&#34;</span><span class="op" id="6772967">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6772970">if</span>&nbsp;<span class="ident" id="6772973">err</span>&nbsp;<span class="op" id="6772977">!=</span>&nbsp;<span class="builtintype" id="6772980">nil</span>&nbsp;<span class="op" id="6772984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6772988">t</span><span class="op" id="6772989">.</span><span class="ident" id="6772990">Fatalf</span><span class="op" id="6772996">(</span><span class="string" id="6772997">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6773016">,</span>&nbsp;<span class="ident" id="6773018">err</span><span class="op" id="6773021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773027">defer</span>&nbsp;<span class="ident" id="6773033">ln</span><span class="op" id="6773035">.</span><span class="ident" id="6773036">Close</span><span class="op" id="6773041">(</span><span class="op" id="6773042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773045">var</span>&nbsp;<span class="ident" id="6773049">server</span>&nbsp;<span class="ident" id="6773056">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773062">errc</span>&nbsp;<span class="op" id="6773067">:=</span>&nbsp;<span class="builtinfunc" id="6773070">make</span><span class="op" id="6773074">(</span><span class="keyword" id="6773075">chan</span>&nbsp;<span class="builtintype" id="6773080">error</span><span class="op" id="6773085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773088">go</span>&nbsp;<span class="keyword" id="6773091">func</span><span class="op" id="6773095">(</span><span class="op" id="6773096">)</span>&nbsp;<span class="op" id="6773098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773102">var</span>&nbsp;<span class="ident" id="6773106">err</span>&nbsp;<span class="builtintype" id="6773110">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773118">server</span><span class="op" id="6773124">,</span>&nbsp;<span class="ident" id="6773126">err</span>&nbsp;<span class="op" id="6773130">=</span>&nbsp;<span class="ident" id="6773132">ln</span><span class="op" id="6773134">.</span><span class="ident" id="6773135">Accept</span><span class="op" id="6773141">(</span><span class="op" id="6773142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773146">errc</span>&nbsp;<span class="op" id="6773151">&lt;-</span>&nbsp;<span class="ident" id="6773154">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773159">}</span><span class="op" id="6773160">(</span><span class="op" id="6773161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773164">client</span><span class="op" id="6773170">,</span>&nbsp;<span class="ident" id="6773172">err</span>&nbsp;<span class="op" id="6773176">:=</span>&nbsp;<span class="ident" id="6773179">Dial</span><span class="op" id="6773183">(</span><span class="string" id="6773184">&#34;tcp&#34;</span><span class="op" id="6773189">,</span>&nbsp;<span class="ident" id="6773191">ln</span><span class="op" id="6773193">.</span><span class="ident" id="6773194">Addr</span><span class="op" id="6773198">(</span><span class="op" id="6773199">)</span><span class="op" id="6773200">.</span><span class="ident" id="6773201">String</span><span class="op" id="6773207">(</span><span class="op" id="6773208">)</span><span class="op" id="6773209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773212">if</span>&nbsp;<span class="ident" id="6773215">err</span>&nbsp;<span class="op" id="6773219">!=</span>&nbsp;<span class="builtintype" id="6773222">nil</span>&nbsp;<span class="op" id="6773226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773230">t</span><span class="op" id="6773231">.</span><span class="ident" id="6773232">Fatalf</span><span class="op" id="6773238">(</span><span class="string" id="6773239">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6773256">,</span>&nbsp;<span class="ident" id="6773258">err</span><span class="op" id="6773261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773264">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773267">if</span>&nbsp;<span class="ident" id="6773270">err</span>&nbsp;<span class="op" id="6773274">:=</span>&nbsp;<span class="op" id="6773277">&lt;-</span><span class="ident" id="6773279">errc</span><span class="op" id="6773283">;</span>&nbsp;<span class="ident" id="6773285">err</span>&nbsp;<span class="op" id="6773289">!=</span>&nbsp;<span class="builtintype" id="6773292">nil</span>&nbsp;<span class="op" id="6773296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773300">t</span><span class="op" id="6773301">.</span><span class="ident" id="6773302">Fatalf</span><span class="op" id="6773308">(</span><span class="string" id="6773309">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6773328">,</span>&nbsp;<span class="ident" id="6773330">err</span><span class="op" id="6773333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773339">defer</span>&nbsp;<span class="ident" id="6773345">server</span><span class="op" id="6773351">.</span><span class="ident" id="6773352">Close</span><span class="op" id="6773357">(</span><span class="op" id="6773358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773361">var</span>&nbsp;<span class="ident" id="6773365">buf</span>&nbsp;<span class="op" id="6773369">[</span><span class="num" id="6773370">128</span><span class="op" id="6773373">]</span><span class="builtintype" id="6773374">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773380">mallocs</span>&nbsp;<span class="op" id="6773388">:=</span>&nbsp;<span class="ident" id="6773391">testing</span><span class="op" id="6773398">.</span><span class="ident" id="6773399">AllocsPerRun</span><span class="op" id="6773411">(</span><span class="num" id="6773412">1000</span><span class="op" id="6773416">,</span>&nbsp;<span class="keyword" id="6773418">func</span><span class="op" id="6773422">(</span><span class="op" id="6773423">)</span>&nbsp;<span class="op" id="6773425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773429">_</span><span class="op" id="6773430">,</span>&nbsp;<span class="ident" id="6773432">err</span>&nbsp;<span class="op" id="6773436">:=</span>&nbsp;<span class="ident" id="6773439">server</span><span class="op" id="6773445">.</span><span class="ident" id="6773446">Write</span><span class="op" id="6773451">(</span><span class="ident" id="6773452">buf</span><span class="op" id="6773455">[</span><span class="op" id="6773456">:</span><span class="op" id="6773457">]</span><span class="op" id="6773458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773462">if</span>&nbsp;<span class="ident" id="6773465">err</span>&nbsp;<span class="op" id="6773469">!=</span>&nbsp;<span class="builtintype" id="6773472">nil</span>&nbsp;<span class="op" id="6773476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773481">t</span><span class="op" id="6773482">.</span><span class="ident" id="6773483">Fatalf</span><span class="op" id="6773489">(</span><span class="string" id="6773490">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6773508">,</span>&nbsp;<span class="ident" id="6773510">err</span><span class="op" id="6773513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773517">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773521">_</span><span class="op" id="6773522">,</span>&nbsp;<span class="ident" id="6773524">err</span>&nbsp;<span class="op" id="6773528">=</span>&nbsp;<span class="ident" id="6773530">io</span><span class="op" id="6773532">.</span><span class="ident" id="6773533">ReadFull</span><span class="op" id="6773541">(</span><span class="ident" id="6773542">client</span><span class="op" id="6773548">,</span>&nbsp;<span class="ident" id="6773550">buf</span><span class="op" id="6773553">[</span><span class="op" id="6773554">:</span><span class="op" id="6773555">]</span><span class="op" id="6773556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773560">if</span>&nbsp;<span class="ident" id="6773563">err</span>&nbsp;<span class="op" id="6773567">!=</span>&nbsp;<span class="builtintype" id="6773570">nil</span>&nbsp;<span class="op" id="6773574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773579">t</span><span class="op" id="6773580">.</span><span class="ident" id="6773581">Fatalf</span><span class="op" id="6773587">(</span><span class="string" id="6773588">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6773605">,</span>&nbsp;<span class="ident" id="6773607">err</span><span class="op" id="6773610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773617">}</span><span class="op" id="6773618">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773621">if</span>&nbsp;<span class="ident" id="6773624">mallocs</span>&nbsp;<span class="op" id="6773632">&gt;</span>&nbsp;<span class="num" id="6773634">0</span>&nbsp;<span class="op" id="6773636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773640">t</span><span class="op" id="6773641">.</span><span class="ident" id="6773642">Fatalf</span><span class="op" id="6773648">(</span><span class="string" id="6773649">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="6773672">,</span>&nbsp;<span class="ident" id="6773674">mallocs</span><span class="op" id="6773681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773684">}</span><br>
<span class="lineno"></span><span class="op" id="6773686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6773689">func</span>&nbsp;<span class="ident" id="6773694">TestTCPStress</span><span class="op" id="6773707">(</span><span class="ident" id="6773708">t</span>&nbsp;<span class="op" id="6773710">*</span><span class="ident" id="6773711">testing</span><span class="op" id="6773718">.</span><span class="ident" id="6773719">T</span><span class="op" id="6773720">)</span>&nbsp;<span class="op" id="6773722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773725">const</span>&nbsp;<span class="ident" id="6773731">conns</span>&nbsp;<span class="op" id="6773737">=</span>&nbsp;<span class="num" id="6773739">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773742">const</span>&nbsp;<span class="ident" id="6773748">msgLen</span>&nbsp;<span class="op" id="6773755">=</span>&nbsp;<span class="num" id="6773757">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773762">msgs</span>&nbsp;<span class="op" id="6773767">:=</span>&nbsp;<span class="builtintype" id="6773770">int</span><span class="op" id="6773773">(</span><span class="num" id="6773774">1e4</span><span class="op" id="6773777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773780">if</span>&nbsp;<span class="ident" id="6773783">testing</span><span class="op" id="6773790">.</span><span class="ident" id="6773791">Short</span><span class="op" id="6773796">(</span><span class="op" id="6773797">)</span>&nbsp;<span class="op" id="6773799">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773803">msgs</span>&nbsp;<span class="op" id="6773808">=</span>&nbsp;<span class="num" id="6773810">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773819">sendMsg</span>&nbsp;<span class="op" id="6773827">:=</span>&nbsp;<span class="keyword" id="6773830">func</span><span class="op" id="6773834">(</span><span class="ident" id="6773835">c</span>&nbsp;<span class="ident" id="6773837">Conn</span><span class="op" id="6773841">,</span>&nbsp;<span class="ident" id="6773843">buf</span>&nbsp;<span class="op" id="6773847">[</span><span class="op" id="6773848">]</span><span class="builtintype" id="6773849">byte</span><span class="op" id="6773853">)</span>&nbsp;<span class="builtintype" id="6773855">bool</span>&nbsp;<span class="op" id="6773860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773864">n</span><span class="op" id="6773865">,</span>&nbsp;<span class="ident" id="6773867">err</span>&nbsp;<span class="op" id="6773871">:=</span>&nbsp;<span class="ident" id="6773874">c</span><span class="op" id="6773875">.</span><span class="ident" id="6773876">Write</span><span class="op" id="6773881">(</span><span class="ident" id="6773882">buf</span><span class="op" id="6773885">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773889">if</span>&nbsp;<span class="ident" id="6773892">n</span>&nbsp;<span class="op" id="6773894">!=</span>&nbsp;<span class="builtinfunc" id="6773897">len</span><span class="op" id="6773900">(</span><span class="ident" id="6773901">buf</span><span class="op" id="6773904">)</span>&nbsp;<span class="op" id="6773906">||</span>&nbsp;<span class="ident" id="6773909">err</span>&nbsp;<span class="op" id="6773913">!=</span>&nbsp;<span class="builtintype" id="6773916">nil</span>&nbsp;<span class="op" id="6773920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773925">t</span><span class="op" id="6773926">.</span><span class="ident" id="6773927">Logf</span><span class="op" id="6773931">(</span><span class="string" id="6773932">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6773950">,</span>&nbsp;<span class="ident" id="6773952">err</span><span class="op" id="6773955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773960">return</span>&nbsp;<span class="builtintype" id="6773967">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6773979">return</span>&nbsp;<span class="builtintype" id="6773986">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6773992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6773995">recvMsg</span>&nbsp;<span class="op" id="6774003">:=</span>&nbsp;<span class="keyword" id="6774006">func</span><span class="op" id="6774010">(</span><span class="ident" id="6774011">c</span>&nbsp;<span class="ident" id="6774013">Conn</span><span class="op" id="6774017">,</span>&nbsp;<span class="ident" id="6774019">buf</span>&nbsp;<span class="op" id="6774023">[</span><span class="op" id="6774024">]</span><span class="builtintype" id="6774025">byte</span><span class="op" id="6774029">)</span>&nbsp;<span class="builtintype" id="6774031">bool</span>&nbsp;<span class="op" id="6774036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774040">for</span>&nbsp;<span class="ident" id="6774044">read</span>&nbsp;<span class="op" id="6774049">:=</span>&nbsp;<span class="num" id="6774052">0</span><span class="op" id="6774053">;</span>&nbsp;<span class="ident" id="6774055">read</span>&nbsp;<span class="op" id="6774060">!=</span>&nbsp;<span class="builtinfunc" id="6774063">len</span><span class="op" id="6774066">(</span><span class="ident" id="6774067">buf</span><span class="op" id="6774070">)</span><span class="op" id="6774071">;</span>&nbsp;<span class="op" id="6774073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774078">n</span><span class="op" id="6774079">,</span>&nbsp;<span class="ident" id="6774081">err</span>&nbsp;<span class="op" id="6774085">:=</span>&nbsp;<span class="ident" id="6774088">c</span><span class="op" id="6774089">.</span><span class="ident" id="6774090">Read</span><span class="op" id="6774094">(</span><span class="ident" id="6774095">buf</span><span class="op" id="6774098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774103">read</span>&nbsp;<span class="op" id="6774108">+=</span>&nbsp;<span class="ident" id="6774111">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774116">if</span>&nbsp;<span class="ident" id="6774119">err</span>&nbsp;<span class="op" id="6774123">!=</span>&nbsp;<span class="builtintype" id="6774126">nil</span>&nbsp;<span class="op" id="6774130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774136">t</span><span class="op" id="6774137">.</span><span class="ident" id="6774138">Logf</span><span class="op" id="6774142">(</span><span class="string" id="6774143">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6774160">,</span>&nbsp;<span class="ident" id="6774162">err</span><span class="op" id="6774165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774171">return</span>&nbsp;<span class="builtintype" id="6774178">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774191">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774195">return</span>&nbsp;<span class="builtintype" id="6774202">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774212">ln</span><span class="op" id="6774214">,</span>&nbsp;<span class="ident" id="6774216">err</span>&nbsp;<span class="op" id="6774220">:=</span>&nbsp;<span class="ident" id="6774223">Listen</span><span class="op" id="6774229">(</span><span class="string" id="6774230">&#34;tcp&#34;</span><span class="op" id="6774235">,</span>&nbsp;<span class="string" id="6774237">&#34;127.0.0.1:0&#34;</span><span class="op" id="6774250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774253">if</span>&nbsp;<span class="ident" id="6774256">err</span>&nbsp;<span class="op" id="6774260">!=</span>&nbsp;<span class="builtintype" id="6774263">nil</span>&nbsp;<span class="op" id="6774267">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774271">t</span><span class="op" id="6774272">.</span><span class="ident" id="6774273">Fatalf</span><span class="op" id="6774279">(</span><span class="string" id="6774280">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6774299">,</span>&nbsp;<span class="ident" id="6774301">err</span><span class="op" id="6774304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774310">defer</span>&nbsp;<span class="ident" id="6774316">ln</span><span class="op" id="6774318">.</span><span class="ident" id="6774319">Close</span><span class="op" id="6774324">(</span><span class="op" id="6774325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6774328">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774342">go</span>&nbsp;<span class="keyword" id="6774345">func</span><span class="op" id="6774349">(</span><span class="op" id="6774350">)</span>&nbsp;<span class="op" id="6774352">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774356">for</span>&nbsp;<span class="op" id="6774360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774365">c</span><span class="op" id="6774366">,</span>&nbsp;<span class="ident" id="6774368">err</span>&nbsp;<span class="op" id="6774372">:=</span>&nbsp;<span class="ident" id="6774375">ln</span><span class="op" id="6774377">.</span><span class="ident" id="6774378">Accept</span><span class="op" id="6774384">(</span><span class="op" id="6774385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774390">if</span>&nbsp;<span class="ident" id="6774393">err</span>&nbsp;<span class="op" id="6774397">!=</span>&nbsp;<span class="builtintype" id="6774400">nil</span>&nbsp;<span class="op" id="6774404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774410">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774419">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6774424">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774449">go</span>&nbsp;<span class="keyword" id="6774452">func</span><span class="op" id="6774456">(</span><span class="ident" id="6774457">c</span>&nbsp;<span class="ident" id="6774459">Conn</span><span class="op" id="6774463">)</span>&nbsp;<span class="op" id="6774465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774471">defer</span>&nbsp;<span class="ident" id="6774477">c</span><span class="op" id="6774478">.</span><span class="ident" id="6774479">Close</span><span class="op" id="6774484">(</span><span class="op" id="6774485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774491">var</span>&nbsp;<span class="ident" id="6774495">buf</span>&nbsp;<span class="op" id="6774499">[</span><span class="ident" id="6774500">msgLen</span><span class="op" id="6774506">]</span><span class="builtintype" id="6774507">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774516">for</span>&nbsp;<span class="ident" id="6774520">m</span>&nbsp;<span class="op" id="6774522">:=</span>&nbsp;<span class="num" id="6774525">0</span><span class="op" id="6774526">;</span>&nbsp;<span class="ident" id="6774528">m</span>&nbsp;<span class="op" id="6774530">&lt;</span>&nbsp;<span class="ident" id="6774532">msgs</span><span class="op" id="6774536">;</span>&nbsp;<span class="ident" id="6774538">m</span><span class="op" id="6774539">++</span>&nbsp;<span class="op" id="6774542">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774549">if</span>&nbsp;<span class="op" id="6774552">!</span><span class="ident" id="6774553">recvMsg</span><span class="op" id="6774560">(</span><span class="ident" id="6774561">c</span><span class="op" id="6774562">,</span>&nbsp;<span class="ident" id="6774564">buf</span><span class="op" id="6774567">[</span><span class="op" id="6774568">:</span><span class="op" id="6774569">]</span><span class="op" id="6774570">)</span>&nbsp;<span class="op" id="6774572">||</span>&nbsp;<span class="op" id="6774575">!</span><span class="ident" id="6774576">sendMsg</span><span class="op" id="6774583">(</span><span class="ident" id="6774584">c</span><span class="op" id="6774585">,</span>&nbsp;<span class="ident" id="6774587">buf</span><span class="op" id="6774590">[</span><span class="op" id="6774591">:</span><span class="op" id="6774592">]</span><span class="op" id="6774593">)</span>&nbsp;<span class="op" id="6774595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774603">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774625">}</span><span class="op" id="6774626">(</span><span class="ident" id="6774627">c</span><span class="op" id="6774628">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774635">}</span><span class="op" id="6774636">(</span><span class="op" id="6774637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774640">done</span>&nbsp;<span class="op" id="6774645">:=</span>&nbsp;<span class="builtinfunc" id="6774648">make</span><span class="op" id="6774652">(</span><span class="keyword" id="6774653">chan</span>&nbsp;<span class="builtintype" id="6774658">bool</span><span class="op" id="6774662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774665">for</span>&nbsp;<span class="ident" id="6774669">i</span>&nbsp;<span class="op" id="6774671">:=</span>&nbsp;<span class="num" id="6774674">0</span><span class="op" id="6774675">;</span>&nbsp;<span class="ident" id="6774677">i</span>&nbsp;<span class="op" id="6774679">&lt;</span>&nbsp;<span class="ident" id="6774681">conns</span><span class="op" id="6774686">;</span>&nbsp;<span class="ident" id="6774688">i</span><span class="op" id="6774689">++</span>&nbsp;<span class="op" id="6774692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6774696">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774720">go</span>&nbsp;<span class="keyword" id="6774723">func</span><span class="op" id="6774727">(</span><span class="op" id="6774728">)</span>&nbsp;<span class="op" id="6774730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774735">defer</span>&nbsp;<span class="keyword" id="6774741">func</span><span class="op" id="6774745">(</span><span class="op" id="6774746">)</span>&nbsp;<span class="op" id="6774748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774754">done</span>&nbsp;<span class="op" id="6774759">&lt;-</span>&nbsp;<span class="builtintype" id="6774762">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774770">}</span><span class="op" id="6774771">(</span><span class="op" id="6774772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774777">c</span><span class="op" id="6774778">,</span>&nbsp;<span class="ident" id="6774780">err</span>&nbsp;<span class="op" id="6774784">:=</span>&nbsp;<span class="ident" id="6774787">Dial</span><span class="op" id="6774791">(</span><span class="string" id="6774792">&#34;tcp&#34;</span><span class="op" id="6774797">,</span>&nbsp;<span class="ident" id="6774799">ln</span><span class="op" id="6774801">.</span><span class="ident" id="6774802">Addr</span><span class="op" id="6774806">(</span><span class="op" id="6774807">)</span><span class="op" id="6774808">.</span><span class="ident" id="6774809">String</span><span class="op" id="6774815">(</span><span class="op" id="6774816">)</span><span class="op" id="6774817">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774822">if</span>&nbsp;<span class="ident" id="6774825">err</span>&nbsp;<span class="op" id="6774829">!=</span>&nbsp;<span class="builtintype" id="6774832">nil</span>&nbsp;<span class="op" id="6774836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6774842">t</span><span class="op" id="6774843">.</span><span class="ident" id="6774844">Logf</span><span class="op" id="6774848">(</span><span class="string" id="6774849">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6774866">,</span>&nbsp;<span class="ident" id="6774868">err</span><span class="op" id="6774871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774877">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6774887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774892">defer</span>&nbsp;<span class="ident" id="6774898">c</span><span class="op" id="6774899">.</span><span class="ident" id="6774900">Close</span><span class="op" id="6774905">(</span><span class="op" id="6774906">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774911">var</span>&nbsp;<span class="ident" id="6774915">buf</span>&nbsp;<span class="op" id="6774919">[</span><span class="ident" id="6774920">msgLen</span><span class="op" id="6774926">]</span><span class="builtintype" id="6774927">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774935">for</span>&nbsp;<span class="ident" id="6774939">m</span>&nbsp;<span class="op" id="6774941">:=</span>&nbsp;<span class="num" id="6774944">0</span><span class="op" id="6774945">;</span>&nbsp;<span class="ident" id="6774947">m</span>&nbsp;<span class="op" id="6774949">&lt;</span>&nbsp;<span class="ident" id="6774951">msgs</span><span class="op" id="6774955">;</span>&nbsp;<span class="ident" id="6774957">m</span><span class="op" id="6774958">++</span>&nbsp;<span class="op" id="6774961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6774967">if</span>&nbsp;<span class="op" id="6774970">!</span><span class="ident" id="6774971">sendMsg</span><span class="op" id="6774978">(</span><span class="ident" id="6774979">c</span><span class="op" id="6774980">,</span>&nbsp;<span class="ident" id="6774982">buf</span><span class="op" id="6774985">[</span><span class="op" id="6774986">:</span><span class="op" id="6774987">]</span><span class="op" id="6774988">)</span>&nbsp;<span class="op" id="6774990">||</span>&nbsp;<span class="op" id="6774993">!</span><span class="ident" id="6774994">recvMsg</span><span class="op" id="6775001">(</span><span class="ident" id="6775002">c</span><span class="op" id="6775003">,</span>&nbsp;<span class="ident" id="6775005">buf</span><span class="op" id="6775008">[</span><span class="op" id="6775009">:</span><span class="op" id="6775010">]</span><span class="op" id="6775011">)</span>&nbsp;<span class="op" id="6775013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775020">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775030">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775039">}</span><span class="op" id="6775040">(</span><span class="op" id="6775041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6775047">for</span>&nbsp;<span class="ident" id="6775051">i</span>&nbsp;<span class="op" id="6775053">:=</span>&nbsp;<span class="num" id="6775056">0</span><span class="op" id="6775057">;</span>&nbsp;<span class="ident" id="6775059">i</span>&nbsp;<span class="op" id="6775061">&lt;</span>&nbsp;<span class="ident" id="6775063">conns</span><span class="op" id="6775068">;</span>&nbsp;<span class="ident" id="6775070">i</span><span class="op" id="6775071">++</span>&nbsp;<span class="op" id="6775074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775078">&lt;-</span><span class="ident" id="6775080">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6775086">}</span><br>
<span class="lineno"></span><span class="op" id="6775088">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
