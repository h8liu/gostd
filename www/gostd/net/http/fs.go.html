<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3374524">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3374579">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3374633">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3374684">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3374721">package</span>&nbsp;<span class="ident" id="3374729">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3374735">import</span>&nbsp;<span class="op" id="3374742">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374745">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374755">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374762">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374768">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374776">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374794">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374811">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374822">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374828">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374836">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374853">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374864">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3374875">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3374882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3374885">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3374961">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="3374989">//</span><br>
<span class="lineno"></span><span class="comment" id="3374992">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3375070">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="3375150">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="3375205">//</span><br>
<span class="lineno"></span><span class="comment" id="3375208">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3375243">type</span>&nbsp;<span class="ident" id="3375248">Dir</span>&nbsp;<span class="builtintype" id="3375252">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="3375260">func</span>&nbsp;<span class="op" id="3375265">(</span><span class="ident" id="3375266">d</span>&nbsp;<span class="ident" id="3375268">Dir</span><span class="op" id="3375271">)</span>&nbsp;<span class="ident" id="3375273">Open</span><span class="op" id="3375277">(</span><span class="ident" id="3375278">name</span>&nbsp;<span class="builtintype" id="3375283">string</span><span class="op" id="3375289">)</span>&nbsp;<span class="op" id="3375291">(</span><span class="ident" id="3375292">File</span><span class="op" id="3375296">,</span>&nbsp;<span class="builtintype" id="3375298">error</span><span class="op" id="3375303">)</span>&nbsp;<span class="op" id="3375305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375308">if</span>&nbsp;<span class="ident" id="3375311">filepath</span><span class="op" id="3375319">.</span><span class="ident" id="3375320">Separator</span>&nbsp;<span class="op" id="3375330">!=</span>&nbsp;<span class="string" id="3375333">&#39;/&#39;</span>&nbsp;<span class="op" id="3375337">&amp;&amp;</span>&nbsp;<span class="ident" id="3375340">strings</span><span class="op" id="3375347">.</span><span class="ident" id="3375348">IndexRune</span><span class="op" id="3375357">(</span><span class="ident" id="3375358">name</span><span class="op" id="3375362">,</span>&nbsp;<span class="ident" id="3375364">filepath</span><span class="op" id="3375372">.</span><span class="ident" id="3375373">Separator</span><span class="op" id="3375382">)</span>&nbsp;<span class="op" id="3375384">&gt;=</span>&nbsp;<span class="num" id="3375387">0</span>&nbsp;<span class="op" id="3375389">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375394">strings</span><span class="op" id="3375401">.</span><span class="ident" id="3375402">Contains</span><span class="op" id="3375410">(</span><span class="ident" id="3375411">name</span><span class="op" id="3375415">,</span>&nbsp;<span class="string" id="3375417">&#34;\x00&#34;</span><span class="op" id="3375423">)</span>&nbsp;<span class="op" id="3375425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375429">return</span>&nbsp;<span class="ident" id="3375436">nil</span><span class="op" id="3375439">,</span>&nbsp;<span class="ident" id="3375441">errors</span><span class="op" id="3375447">.</span><span class="ident" id="3375448">New</span><span class="op" id="3375451">(</span><span class="string" id="3375452">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="3375490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375493">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375496">dir</span>&nbsp;<span class="op" id="3375500">:=</span>&nbsp;<span class="builtintype" id="3375503">string</span><span class="op" id="3375509">(</span><span class="ident" id="3375510">d</span><span class="op" id="3375511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375514">if</span>&nbsp;<span class="ident" id="3375517">dir</span>&nbsp;<span class="op" id="3375521">==</span>&nbsp;<span class="string" id="3375524">&#34;&#34;</span>&nbsp;<span class="op" id="3375527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375531">dir</span>&nbsp;<span class="op" id="3375535">=</span>&nbsp;<span class="string" id="3375537">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375545">f</span><span class="op" id="3375546">,</span>&nbsp;<span class="ident" id="3375548">err</span>&nbsp;<span class="op" id="3375552">:=</span>&nbsp;<span class="ident" id="3375555">os</span><span class="op" id="3375557">.</span><span class="ident" id="3375558">Open</span><span class="op" id="3375562">(</span><span class="ident" id="3375563">filepath</span><span class="op" id="3375571">.</span><span class="ident" id="3375572">Join</span><span class="op" id="3375576">(</span><span class="ident" id="3375577">dir</span><span class="op" id="3375580">,</span>&nbsp;<span class="ident" id="3375582">filepath</span><span class="op" id="3375590">.</span><span class="ident" id="3375591">FromSlash</span><span class="op" id="3375600">(</span><span class="ident" id="3375601">path</span><span class="op" id="3375605">.</span><span class="ident" id="3375606">Clean</span><span class="op" id="3375611">(</span><span class="string" id="3375612">&#34;/&#34;</span><span class="op" id="3375615">+</span><span class="ident" id="3375616">name</span><span class="op" id="3375620">)</span><span class="op" id="3375621">)</span><span class="op" id="3375622">)</span><span class="op" id="3375623">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375626">if</span>&nbsp;<span class="ident" id="3375629">err</span>&nbsp;<span class="op" id="3375633">!=</span>&nbsp;<span class="ident" id="3375636">nil</span>&nbsp;<span class="op" id="3375640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375644">return</span>&nbsp;<span class="ident" id="3375651">nil</span><span class="op" id="3375654">,</span>&nbsp;<span class="ident" id="3375656">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375664">return</span>&nbsp;<span class="ident" id="3375671">f</span><span class="op" id="3375672">,</span>&nbsp;<span class="ident" id="3375674">nil</span><br>
<span class="lineno"></span><span class="op" id="3375678">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="3375681">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="3375747">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="3375815">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="3375878">type</span>&nbsp;<span class="ident" id="3375883">FileSystem</span>&nbsp;<span class="keyword" id="3375894">interface</span>&nbsp;<span class="op" id="3375904">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375907">Open</span><span class="op" id="3375911">(</span><span class="ident" id="3375912">name</span>&nbsp;<span class="builtintype" id="3375917">string</span><span class="op" id="3375923">)</span>&nbsp;<span class="op" id="3375925">(</span><span class="ident" id="3375926">File</span><span class="op" id="3375930">,</span>&nbsp;<span class="builtintype" id="3375932">error</span><span class="op" id="3375937">)</span><br>
<span class="lineno"></span><span class="op" id="3375939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3375942">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3376005">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="3376049">//</span><br>
<span class="lineno"></span><span class="comment" id="3376052">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="3376115">type</span>&nbsp;<span class="ident" id="3376120">File</span>&nbsp;<span class="keyword" id="3376125">interface</span>&nbsp;<span class="op" id="3376135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376138">io</span><span class="op" id="3376140">.</span><span class="ident" id="3376141">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376149">io</span><span class="op" id="3376151">.</span><span class="ident" id="3376152">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376160">Readdir</span><span class="op" id="3376167">(</span><span class="ident" id="3376168">count</span>&nbsp;<span class="builtintype" id="3376174">int</span><span class="op" id="3376177">)</span>&nbsp;<span class="op" id="3376179">(</span><span class="op" id="3376180">[</span><span class="op" id="3376181">]</span><span class="ident" id="3376182">os</span><span class="op" id="3376184">.</span><span class="ident" id="3376185">FileInfo</span><span class="op" id="3376193">,</span>&nbsp;<span class="builtintype" id="3376195">error</span><span class="op" id="3376200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376203">Seek</span><span class="op" id="3376207">(</span><span class="ident" id="3376208">offset</span>&nbsp;<span class="ident" id="3376215">int64</span><span class="op" id="3376220">,</span>&nbsp;<span class="ident" id="3376222">whence</span>&nbsp;<span class="builtintype" id="3376229">int</span><span class="op" id="3376232">)</span>&nbsp;<span class="op" id="3376234">(</span><span class="ident" id="3376235">int64</span><span class="op" id="3376240">,</span>&nbsp;<span class="builtintype" id="3376242">error</span><span class="op" id="3376247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376250">Stat</span><span class="op" id="3376254">(</span><span class="op" id="3376255">)</span>&nbsp;<span class="op" id="3376257">(</span><span class="ident" id="3376258">os</span><span class="op" id="3376260">.</span><span class="ident" id="3376261">FileInfo</span><span class="op" id="3376269">,</span>&nbsp;<span class="builtintype" id="3376271">error</span><span class="op" id="3376276">)</span><br>
<span class="lineno"></span><span class="op" id="3376278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3376281">func</span>&nbsp;<span class="ident" id="3376286">dirList</span><span class="op" id="3376293">(</span><span class="ident" id="3376294">w</span>&nbsp;<span class="ident" id="3376296">ResponseWriter</span><span class="op" id="3376310">,</span>&nbsp;<span class="ident" id="3376312">f</span>&nbsp;<span class="ident" id="3376314">File</span><span class="op" id="3376318">)</span>&nbsp;<span class="op" id="3376320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376323">w</span><span class="op" id="3376324">.</span><span class="ident" id="3376325">Header</span><span class="op" id="3376331">(</span><span class="op" id="3376332">)</span><span class="op" id="3376333">.</span><span class="ident" id="3376334">Set</span><span class="op" id="3376337">(</span><span class="string" id="3376338">&#34;Content-Type&#34;</span><span class="op" id="3376352">,</span>&nbsp;<span class="string" id="3376354">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="3376380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376383">fmt</span><span class="op" id="3376386">.</span><span class="ident" id="3376387">Fprintf</span><span class="op" id="3376394">(</span><span class="ident" id="3376395">w</span><span class="op" id="3376396">,</span>&nbsp;<span class="string" id="3376398">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="3376407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376410">for</span>&nbsp;<span class="op" id="3376414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376418">dirs</span><span class="op" id="3376422">,</span>&nbsp;<span class="ident" id="3376424">err</span>&nbsp;<span class="op" id="3376428">:=</span>&nbsp;<span class="ident" id="3376431">f</span><span class="op" id="3376432">.</span><span class="ident" id="3376433">Readdir</span><span class="op" id="3376440">(</span><span class="num" id="3376441">100</span><span class="op" id="3376444">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376448">if</span>&nbsp;<span class="ident" id="3376451">err</span>&nbsp;<span class="op" id="3376455">!=</span>&nbsp;<span class="ident" id="3376458">nil</span>&nbsp;<span class="op" id="3376462">||</span>&nbsp;<span class="builtinfunc" id="3376465">len</span><span class="op" id="3376468">(</span><span class="ident" id="3376469">dirs</span><span class="op" id="3376473">)</span>&nbsp;<span class="op" id="3376475">==</span>&nbsp;<span class="num" id="3376478">0</span>&nbsp;<span class="op" id="3376480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376485">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376497">for</span>&nbsp;<span class="ident" id="3376501">_</span><span class="op" id="3376502">,</span>&nbsp;<span class="ident" id="3376504">d</span>&nbsp;<span class="op" id="3376506">:=</span>&nbsp;<span class="keyword" id="3376509">range</span>&nbsp;<span class="ident" id="3376515">dirs</span>&nbsp;<span class="op" id="3376520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376525">name</span>&nbsp;<span class="op" id="3376530">:=</span>&nbsp;<span class="ident" id="3376533">d</span><span class="op" id="3376534">.</span><span class="ident" id="3376535">Name</span><span class="op" id="3376539">(</span><span class="op" id="3376540">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376545">if</span>&nbsp;<span class="ident" id="3376548">d</span><span class="op" id="3376549">.</span><span class="ident" id="3376550">IsDir</span><span class="op" id="3376555">(</span><span class="op" id="3376556">)</span>&nbsp;<span class="op" id="3376558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376564">name</span>&nbsp;<span class="op" id="3376569">+=</span>&nbsp;<span class="string" id="3376572">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376584">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376651">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376717">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376743">url</span>&nbsp;<span class="op" id="3376747">:=</span>&nbsp;<span class="ident" id="3376750">url</span><span class="op" id="3376753">.</span><span class="ident" id="3376754">URL</span><span class="op" id="3376757">{</span><span class="ident" id="3376758">Path</span><span class="op" id="3376762">:</span>&nbsp;<span class="ident" id="3376764">name</span><span class="op" id="3376768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376773">fmt</span><span class="op" id="3376776">.</span><span class="ident" id="3376777">Fprintf</span><span class="op" id="3376784">(</span><span class="ident" id="3376785">w</span><span class="op" id="3376786">,</span>&nbsp;<span class="string" id="3376788">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="3376813">,</span>&nbsp;<span class="ident" id="3376815">url</span><span class="op" id="3376818">.</span><span class="ident" id="3376819">String</span><span class="op" id="3376825">(</span><span class="op" id="3376826">)</span><span class="op" id="3376827">,</span>&nbsp;<span class="ident" id="3376829">htmlReplacer</span><span class="op" id="3376841">.</span><span class="ident" id="3376842">Replace</span><span class="op" id="3376849">(</span><span class="ident" id="3376850">name</span><span class="op" id="3376854">)</span><span class="op" id="3376855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376862">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376865">fmt</span><span class="op" id="3376868">.</span><span class="ident" id="3376869">Fprintf</span><span class="op" id="3376876">(</span><span class="ident" id="3376877">w</span><span class="op" id="3376878">,</span>&nbsp;<span class="string" id="3376880">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="3376890">)</span><br>
<span class="lineno"></span><span class="op" id="3376892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3376895">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3376959">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="3377030">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3377101">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="3377140">//</span><br>
<span class="lineno"></span><span class="comment" id="3377143">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="3377209">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="3377275">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3377346">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="3377386">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3377456">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3377487">//</span><br>
<span class="lineno">105</span><span class="comment" id="3377490">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3377556">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3377625">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="3377690">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="3377738">//</span><br>
<span class="lineno">110</span><span class="comment" id="3377741">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="3377799">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="3377858">//</span><br>
<span class="lineno"></span><span class="comment" id="3377861">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3377927">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="3377980">//</span><br>
<span class="lineno"></span><span class="comment" id="3377983">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3378045">func</span>&nbsp;<span class="ident" id="3378050">ServeContent</span><span class="op" id="3378062">(</span><span class="ident" id="3378063">w</span>&nbsp;<span class="ident" id="3378065">ResponseWriter</span><span class="op" id="3378079">,</span>&nbsp;<span class="ident" id="3378081">req</span>&nbsp;<span class="op" id="3378085">*</span><span class="ident" id="3378086">Request</span><span class="op" id="3378093">,</span>&nbsp;<span class="ident" id="3378095">name</span>&nbsp;<span class="builtintype" id="3378100">string</span><span class="op" id="3378106">,</span>&nbsp;<span class="ident" id="3378108">modtime</span>&nbsp;<span class="ident" id="3378116">time</span><span class="op" id="3378120">.</span><span class="ident" id="3378121">Time</span><span class="op" id="3378125">,</span>&nbsp;<span class="ident" id="3378127">content</span>&nbsp;<span class="ident" id="3378135">io</span><span class="op" id="3378137">.</span><span class="ident" id="3378138">ReadSeeker</span><span class="op" id="3378148">)</span>&nbsp;<span class="op" id="3378150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378153">sizeFunc</span>&nbsp;<span class="op" id="3378162">:=</span>&nbsp;<span class="keyword" id="3378165">func</span><span class="op" id="3378169">(</span><span class="op" id="3378170">)</span>&nbsp;<span class="op" id="3378172">(</span><span class="ident" id="3378173">int64</span><span class="op" id="3378178">,</span>&nbsp;<span class="builtintype" id="3378180">error</span><span class="op" id="3378185">)</span>&nbsp;<span class="op" id="3378187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378191">size</span><span class="op" id="3378195">,</span>&nbsp;<span class="ident" id="3378197">err</span>&nbsp;<span class="op" id="3378201">:=</span>&nbsp;<span class="ident" id="3378204">content</span><span class="op" id="3378211">.</span><span class="ident" id="3378212">Seek</span><span class="op" id="3378216">(</span><span class="num" id="3378217">0</span><span class="op" id="3378218">,</span>&nbsp;<span class="ident" id="3378220">os</span><span class="op" id="3378222">.</span><span class="ident" id="3378223">SEEK_END</span><span class="op" id="3378231">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378235">if</span>&nbsp;<span class="ident" id="3378238">err</span>&nbsp;<span class="op" id="3378242">!=</span>&nbsp;<span class="ident" id="3378245">nil</span>&nbsp;<span class="op" id="3378249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378254">return</span>&nbsp;<span class="num" id="3378261">0</span><span class="op" id="3378262">,</span>&nbsp;<span class="ident" id="3378264">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378280">_</span><span class="op" id="3378281">,</span>&nbsp;<span class="ident" id="3378283">err</span>&nbsp;<span class="op" id="3378287">=</span>&nbsp;<span class="ident" id="3378289">content</span><span class="op" id="3378296">.</span><span class="ident" id="3378297">Seek</span><span class="op" id="3378301">(</span><span class="num" id="3378302">0</span><span class="op" id="3378303">,</span>&nbsp;<span class="ident" id="3378305">os</span><span class="op" id="3378307">.</span><span class="ident" id="3378308">SEEK_SET</span><span class="op" id="3378316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378320">if</span>&nbsp;<span class="ident" id="3378323">err</span>&nbsp;<span class="op" id="3378327">!=</span>&nbsp;<span class="ident" id="3378330">nil</span>&nbsp;<span class="op" id="3378334">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378339">return</span>&nbsp;<span class="num" id="3378346">0</span><span class="op" id="3378347">,</span>&nbsp;<span class="ident" id="3378349">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378365">return</span>&nbsp;<span class="ident" id="3378372">size</span><span class="op" id="3378376">,</span>&nbsp;<span class="ident" id="3378378">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378386">serveContent</span><span class="op" id="3378398">(</span><span class="ident" id="3378399">w</span><span class="op" id="3378400">,</span>&nbsp;<span class="ident" id="3378402">req</span><span class="op" id="3378405">,</span>&nbsp;<span class="ident" id="3378407">name</span><span class="op" id="3378411">,</span>&nbsp;<span class="ident" id="3378413">modtime</span><span class="op" id="3378420">,</span>&nbsp;<span class="ident" id="3378422">sizeFunc</span><span class="op" id="3378430">,</span>&nbsp;<span class="ident" id="3378432">content</span><span class="op" id="3378439">)</span><br>
<span class="lineno">130</span><span class="op" id="3378441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3378444">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3378513">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3378580">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="3378648">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="3378658">var</span>&nbsp;<span class="ident" id="3378662">errSeeker</span>&nbsp;<span class="op" id="3378672">=</span>&nbsp;<span class="ident" id="3378674">errors</span><span class="op" id="3378680">.</span><span class="ident" id="3378681">New</span><span class="op" id="3378684">(</span><span class="string" id="3378685">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3378704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3378707">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="3378787">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="3378831">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3378887">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3378976">func</span>&nbsp;<span class="ident" id="3378981">serveContent</span><span class="op" id="3378993">(</span><span class="ident" id="3378994">w</span>&nbsp;<span class="ident" id="3378996">ResponseWriter</span><span class="op" id="3379010">,</span>&nbsp;<span class="ident" id="3379012">r</span>&nbsp;<span class="op" id="3379014">*</span><span class="ident" id="3379015">Request</span><span class="op" id="3379022">,</span>&nbsp;<span class="ident" id="3379024">name</span>&nbsp;<span class="builtintype" id="3379029">string</span><span class="op" id="3379035">,</span>&nbsp;<span class="ident" id="3379037">modtime</span>&nbsp;<span class="ident" id="3379045">time</span><span class="op" id="3379049">.</span><span class="ident" id="3379050">Time</span><span class="op" id="3379054">,</span>&nbsp;<span class="ident" id="3379056">sizeFunc</span>&nbsp;<span class="keyword" id="3379065">func</span><span class="op" id="3379069">(</span><span class="op" id="3379070">)</span>&nbsp;<span class="op" id="3379072">(</span><span class="ident" id="3379073">int64</span><span class="op" id="3379078">,</span>&nbsp;<span class="builtintype" id="3379080">error</span><span class="op" id="3379085">)</span><span class="op" id="3379086">,</span>&nbsp;<span class="ident" id="3379088">content</span>&nbsp;<span class="ident" id="3379096">io</span><span class="op" id="3379098">.</span><span class="ident" id="3379099">ReadSeeker</span><span class="op" id="3379109">)</span>&nbsp;<span class="op" id="3379111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379114">if</span>&nbsp;<span class="ident" id="3379117">checkLastModified</span><span class="op" id="3379134">(</span><span class="ident" id="3379135">w</span><span class="op" id="3379136">,</span>&nbsp;<span class="ident" id="3379138">r</span><span class="op" id="3379139">,</span>&nbsp;<span class="ident" id="3379141">modtime</span><span class="op" id="3379148">)</span>&nbsp;<span class="op" id="3379150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379154">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379165">rangeReq</span><span class="op" id="3379173">,</span>&nbsp;<span class="ident" id="3379175">done</span>&nbsp;<span class="op" id="3379180">:=</span>&nbsp;<span class="ident" id="3379183">checkETag</span><span class="op" id="3379192">(</span><span class="ident" id="3379193">w</span><span class="op" id="3379194">,</span>&nbsp;<span class="ident" id="3379196">r</span><span class="op" id="3379197">,</span>&nbsp;<span class="ident" id="3379199">modtime</span><span class="op" id="3379206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379209">if</span>&nbsp;<span class="ident" id="3379212">done</span>&nbsp;<span class="op" id="3379217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379221">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379229">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379233">code</span>&nbsp;<span class="op" id="3379238">:=</span>&nbsp;<span class="ident" id="3379241">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379252">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379324">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379392">ctypes</span><span class="op" id="3379398">,</span>&nbsp;<span class="ident" id="3379400">haveType</span>&nbsp;<span class="op" id="3379409">:=</span>&nbsp;<span class="ident" id="3379412">w</span><span class="op" id="3379413">.</span><span class="ident" id="3379414">Header</span><span class="op" id="3379420">(</span><span class="op" id="3379421">)</span><span class="op" id="3379422">[</span><span class="string" id="3379423">&#34;Content-Type&#34;</span><span class="op" id="3379437">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379440">var</span>&nbsp;<span class="ident" id="3379444">ctype</span>&nbsp;<span class="builtintype" id="3379450">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379458">if</span>&nbsp;<span class="op" id="3379461">!</span><span class="ident" id="3379462">haveType</span>&nbsp;<span class="op" id="3379471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379475">ctype</span>&nbsp;<span class="op" id="3379481">=</span>&nbsp;<span class="ident" id="3379483">mime</span><span class="op" id="3379487">.</span><span class="ident" id="3379488">TypeByExtension</span><span class="op" id="3379503">(</span><span class="ident" id="3379504">filepath</span><span class="op" id="3379512">.</span><span class="ident" id="3379513">Ext</span><span class="op" id="3379516">(</span><span class="ident" id="3379517">name</span><span class="op" id="3379521">)</span><span class="op" id="3379522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379526">if</span>&nbsp;<span class="ident" id="3379529">ctype</span>&nbsp;<span class="op" id="3379535">==</span>&nbsp;<span class="string" id="3379538">&#34;&#34;</span>&nbsp;<span class="op" id="3379541">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379546">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379605">var</span>&nbsp;<span class="ident" id="3379609">buf</span>&nbsp;<span class="op" id="3379613">[</span><span class="ident" id="3379614">sniffLen</span><span class="op" id="3379622">]</span><span class="builtintype" id="3379623">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379631">n</span><span class="op" id="3379632">,</span>&nbsp;<span class="ident" id="3379634">_</span>&nbsp;<span class="op" id="3379636">:=</span>&nbsp;<span class="ident" id="3379639">io</span><span class="op" id="3379641">.</span><span class="ident" id="3379642">ReadFull</span><span class="op" id="3379650">(</span><span class="ident" id="3379651">content</span><span class="op" id="3379658">,</span>&nbsp;<span class="ident" id="3379660">buf</span><span class="op" id="3379663">[</span><span class="op" id="3379664">:</span><span class="op" id="3379665">]</span><span class="op" id="3379666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379671">ctype</span>&nbsp;<span class="op" id="3379677">=</span>&nbsp;<span class="ident" id="3379679">DetectContentType</span><span class="op" id="3379696">(</span><span class="ident" id="3379697">buf</span><span class="op" id="3379700">[</span><span class="op" id="3379701">:</span><span class="ident" id="3379702">n</span><span class="op" id="3379703">]</span><span class="op" id="3379704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379709">_</span><span class="op" id="3379710">,</span>&nbsp;<span class="ident" id="3379712">err</span>&nbsp;<span class="op" id="3379716">:=</span>&nbsp;<span class="ident" id="3379719">content</span><span class="op" id="3379726">.</span><span class="ident" id="3379727">Seek</span><span class="op" id="3379731">(</span><span class="num" id="3379732">0</span><span class="op" id="3379733">,</span>&nbsp;<span class="ident" id="3379735">os</span><span class="op" id="3379737">.</span><span class="ident" id="3379738">SEEK_SET</span><span class="op" id="3379746">)</span>&nbsp;<span class="comment" id="3379748">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379782">if</span>&nbsp;<span class="ident" id="3379785">err</span>&nbsp;<span class="op" id="3379789">!=</span>&nbsp;<span class="ident" id="3379792">nil</span>&nbsp;<span class="op" id="3379796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379802">Error</span><span class="op" id="3379807">(</span><span class="ident" id="3379808">w</span><span class="op" id="3379809">,</span>&nbsp;<span class="string" id="3379811">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3379830">,</span>&nbsp;<span class="ident" id="3379832">StatusInternalServerError</span><span class="op" id="3379857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379877">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379881">w</span><span class="op" id="3379882">.</span><span class="ident" id="3379883">Header</span><span class="op" id="3379889">(</span><span class="op" id="3379890">)</span><span class="op" id="3379891">.</span><span class="ident" id="3379892">Set</span><span class="op" id="3379895">(</span><span class="string" id="3379896">&#34;Content-Type&#34;</span><span class="op" id="3379910">,</span>&nbsp;<span class="ident" id="3379912">ctype</span><span class="op" id="3379917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379920">}</span>&nbsp;<span class="keyword" id="3379922">else</span>&nbsp;<span class="keyword" id="3379927">if</span>&nbsp;<span class="builtinfunc" id="3379930">len</span><span class="op" id="3379933">(</span><span class="ident" id="3379934">ctypes</span><span class="op" id="3379940">)</span>&nbsp;<span class="op" id="3379942">&gt;</span>&nbsp;<span class="num" id="3379944">0</span>&nbsp;<span class="op" id="3379946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379950">ctype</span>&nbsp;<span class="op" id="3379956">=</span>&nbsp;<span class="ident" id="3379958">ctypes</span><span class="op" id="3379964">[</span><span class="num" id="3379965">0</span><span class="op" id="3379966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379973">size</span><span class="op" id="3379977">,</span>&nbsp;<span class="ident" id="3379979">err</span>&nbsp;<span class="op" id="3379983">:=</span>&nbsp;<span class="ident" id="3379986">sizeFunc</span><span class="op" id="3379994">(</span><span class="op" id="3379995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379998">if</span>&nbsp;<span class="ident" id="3380001">err</span>&nbsp;<span class="op" id="3380005">!=</span>&nbsp;<span class="ident" id="3380008">nil</span>&nbsp;<span class="op" id="3380012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380016">Error</span><span class="op" id="3380021">(</span><span class="ident" id="3380022">w</span><span class="op" id="3380023">,</span>&nbsp;<span class="ident" id="3380025">err</span><span class="op" id="3380028">.</span><span class="ident" id="3380029">Error</span><span class="op" id="3380034">(</span><span class="op" id="3380035">)</span><span class="op" id="3380036">,</span>&nbsp;<span class="ident" id="3380038">StatusInternalServerError</span><span class="op" id="3380063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380067">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380075">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380079">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380112">sendSize</span>&nbsp;<span class="op" id="3380121">:=</span>&nbsp;<span class="ident" id="3380124">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380130">var</span>&nbsp;<span class="ident" id="3380134">sendContent</span>&nbsp;<span class="ident" id="3380146">io</span><span class="op" id="3380148">.</span><span class="ident" id="3380149">Reader</span>&nbsp;<span class="op" id="3380156">=</span>&nbsp;<span class="ident" id="3380158">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380167">if</span>&nbsp;<span class="ident" id="3380170">size</span>&nbsp;<span class="op" id="3380175">&gt;=</span>&nbsp;<span class="num" id="3380178">0</span>&nbsp;<span class="op" id="3380180">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380184">ranges</span><span class="op" id="3380190">,</span>&nbsp;<span class="ident" id="3380192">err</span>&nbsp;<span class="op" id="3380196">:=</span>&nbsp;<span class="ident" id="3380199">parseRange</span><span class="op" id="3380209">(</span><span class="ident" id="3380210">rangeReq</span><span class="op" id="3380218">,</span>&nbsp;<span class="ident" id="3380220">size</span><span class="op" id="3380224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380228">if</span>&nbsp;<span class="ident" id="3380231">err</span>&nbsp;<span class="op" id="3380235">!=</span>&nbsp;<span class="ident" id="3380238">nil</span>&nbsp;<span class="op" id="3380242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380247">Error</span><span class="op" id="3380252">(</span><span class="ident" id="3380253">w</span><span class="op" id="3380254">,</span>&nbsp;<span class="ident" id="3380256">err</span><span class="op" id="3380259">.</span><span class="ident" id="3380260">Error</span><span class="op" id="3380265">(</span><span class="op" id="3380266">)</span><span class="op" id="3380267">,</span>&nbsp;<span class="ident" id="3380269">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3380303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380308">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380317">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380321">if</span>&nbsp;<span class="ident" id="3380324">sumRangesSize</span><span class="op" id="3380337">(</span><span class="ident" id="3380338">ranges</span><span class="op" id="3380344">)</span>&nbsp;<span class="op" id="3380346">&gt;</span>&nbsp;<span class="ident" id="3380348">size</span>&nbsp;<span class="op" id="3380353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380358">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380408">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380453">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380503">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380549">ranges</span>&nbsp;<span class="op" id="3380556">=</span>&nbsp;<span class="ident" id="3380558">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380568">switch</span>&nbsp;<span class="op" id="3380575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380579">case</span>&nbsp;<span class="builtinfunc" id="3380584">len</span><span class="op" id="3380587">(</span><span class="ident" id="3380588">ranges</span><span class="op" id="3380594">)</span>&nbsp;<span class="op" id="3380596">==</span>&nbsp;<span class="num" id="3380599">1</span><span class="op" id="3380600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380605">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380636">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380697">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380753">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380809">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380864">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380917">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3380973">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381001">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381011">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381069">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381127">ra</span>&nbsp;<span class="op" id="3381130">:=</span>&nbsp;<span class="ident" id="3381133">ranges</span><span class="op" id="3381139">[</span><span class="num" id="3381140">0</span><span class="op" id="3381141">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381146">if</span>&nbsp;<span class="ident" id="3381149">_</span><span class="op" id="3381150">,</span>&nbsp;<span class="ident" id="3381152">err</span>&nbsp;<span class="op" id="3381156">:=</span>&nbsp;<span class="ident" id="3381159">content</span><span class="op" id="3381166">.</span><span class="ident" id="3381167">Seek</span><span class="op" id="3381171">(</span><span class="ident" id="3381172">ra</span><span class="op" id="3381174">.</span><span class="ident" id="3381175">start</span><span class="op" id="3381180">,</span>&nbsp;<span class="ident" id="3381182">os</span><span class="op" id="3381184">.</span><span class="ident" id="3381185">SEEK_SET</span><span class="op" id="3381193">)</span><span class="op" id="3381194">;</span>&nbsp;<span class="ident" id="3381196">err</span>&nbsp;<span class="op" id="3381200">!=</span>&nbsp;<span class="ident" id="3381203">nil</span>&nbsp;<span class="op" id="3381207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381213">Error</span><span class="op" id="3381218">(</span><span class="ident" id="3381219">w</span><span class="op" id="3381220">,</span>&nbsp;<span class="ident" id="3381222">err</span><span class="op" id="3381225">.</span><span class="ident" id="3381226">Error</span><span class="op" id="3381231">(</span><span class="op" id="3381232">)</span><span class="op" id="3381233">,</span>&nbsp;<span class="ident" id="3381235">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3381269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381275">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381285">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381290">sendSize</span>&nbsp;<span class="op" id="3381299">=</span>&nbsp;<span class="ident" id="3381301">ra</span><span class="op" id="3381303">.</span><span class="ident" id="3381304">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381314">code</span>&nbsp;<span class="op" id="3381319">=</span>&nbsp;<span class="ident" id="3381321">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381345">w</span><span class="op" id="3381346">.</span><span class="ident" id="3381347">Header</span><span class="op" id="3381353">(</span><span class="op" id="3381354">)</span><span class="op" id="3381355">.</span><span class="ident" id="3381356">Set</span><span class="op" id="3381359">(</span><span class="string" id="3381360">&#34;Content-Range&#34;</span><span class="op" id="3381375">,</span>&nbsp;<span class="ident" id="3381377">ra</span><span class="op" id="3381379">.</span><span class="ident" id="3381380">contentRange</span><span class="op" id="3381392">(</span><span class="ident" id="3381393">size</span><span class="op" id="3381397">)</span><span class="op" id="3381398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381402">case</span>&nbsp;<span class="builtinfunc" id="3381407">len</span><span class="op" id="3381410">(</span><span class="ident" id="3381411">ranges</span><span class="op" id="3381417">)</span>&nbsp;<span class="op" id="3381419">&gt;</span>&nbsp;<span class="num" id="3381421">1</span><span class="op" id="3381422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381427">sendSize</span>&nbsp;<span class="op" id="3381436">=</span>&nbsp;<span class="ident" id="3381438">rangesMIMESize</span><span class="op" id="3381452">(</span><span class="ident" id="3381453">ranges</span><span class="op" id="3381459">,</span>&nbsp;<span class="ident" id="3381461">ctype</span><span class="op" id="3381466">,</span>&nbsp;<span class="ident" id="3381468">size</span><span class="op" id="3381472">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381477">code</span>&nbsp;<span class="op" id="3381482">=</span>&nbsp;<span class="ident" id="3381484">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381509">pr</span><span class="op" id="3381511">,</span>&nbsp;<span class="ident" id="3381513">pw</span>&nbsp;<span class="op" id="3381516">:=</span>&nbsp;<span class="ident" id="3381519">io</span><span class="op" id="3381521">.</span><span class="ident" id="3381522">Pipe</span><span class="op" id="3381526">(</span><span class="op" id="3381527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381532">mw</span>&nbsp;<span class="op" id="3381535">:=</span>&nbsp;<span class="ident" id="3381538">multipart</span><span class="op" id="3381547">.</span><span class="ident" id="3381548">NewWriter</span><span class="op" id="3381557">(</span><span class="ident" id="3381558">pw</span><span class="op" id="3381560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381565">w</span><span class="op" id="3381566">.</span><span class="ident" id="3381567">Header</span><span class="op" id="3381573">(</span><span class="op" id="3381574">)</span><span class="op" id="3381575">.</span><span class="ident" id="3381576">Set</span><span class="op" id="3381579">(</span><span class="string" id="3381580">&#34;Content-Type&#34;</span><span class="op" id="3381594">,</span>&nbsp;<span class="string" id="3381596">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="3381629">+</span><span class="ident" id="3381630">mw</span><span class="op" id="3381632">.</span><span class="ident" id="3381633">Boundary</span><span class="op" id="3381641">(</span><span class="op" id="3381642">)</span><span class="op" id="3381643">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381648">sendContent</span>&nbsp;<span class="op" id="3381660">=</span>&nbsp;<span class="ident" id="3381662">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381668">defer</span>&nbsp;<span class="ident" id="3381674">pr</span><span class="op" id="3381676">.</span><span class="ident" id="3381677">Close</span><span class="op" id="3381682">(</span><span class="op" id="3381683">)</span>&nbsp;<span class="comment" id="3381685">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381757">go</span>&nbsp;<span class="keyword" id="3381760">func</span><span class="op" id="3381764">(</span><span class="op" id="3381765">)</span>&nbsp;<span class="op" id="3381767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381773">for</span>&nbsp;<span class="ident" id="3381777">_</span><span class="op" id="3381778">,</span>&nbsp;<span class="ident" id="3381780">ra</span>&nbsp;<span class="op" id="3381783">:=</span>&nbsp;<span class="keyword" id="3381786">range</span>&nbsp;<span class="ident" id="3381792">ranges</span>&nbsp;<span class="op" id="3381799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381806">part</span><span class="op" id="3381810">,</span>&nbsp;<span class="ident" id="3381812">err</span>&nbsp;<span class="op" id="3381816">:=</span>&nbsp;<span class="ident" id="3381819">mw</span><span class="op" id="3381821">.</span><span class="ident" id="3381822">CreatePart</span><span class="op" id="3381832">(</span><span class="ident" id="3381833">ra</span><span class="op" id="3381835">.</span><span class="ident" id="3381836">mimeHeader</span><span class="op" id="3381846">(</span><span class="ident" id="3381847">ctype</span><span class="op" id="3381852">,</span>&nbsp;<span class="ident" id="3381854">size</span><span class="op" id="3381858">)</span><span class="op" id="3381859">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381866">if</span>&nbsp;<span class="ident" id="3381869">err</span>&nbsp;<span class="op" id="3381873">!=</span>&nbsp;<span class="ident" id="3381876">nil</span>&nbsp;<span class="op" id="3381880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381888">pw</span><span class="op" id="3381890">.</span><span class="ident" id="3381891">CloseWithError</span><span class="op" id="3381905">(</span><span class="ident" id="3381906">err</span><span class="op" id="3381909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381917">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381936">if</span>&nbsp;<span class="ident" id="3381939">_</span><span class="op" id="3381940">,</span>&nbsp;<span class="ident" id="3381942">err</span>&nbsp;<span class="op" id="3381946">:=</span>&nbsp;<span class="ident" id="3381949">content</span><span class="op" id="3381956">.</span><span class="ident" id="3381957">Seek</span><span class="op" id="3381961">(</span><span class="ident" id="3381962">ra</span><span class="op" id="3381964">.</span><span class="ident" id="3381965">start</span><span class="op" id="3381970">,</span>&nbsp;<span class="ident" id="3381972">os</span><span class="op" id="3381974">.</span><span class="ident" id="3381975">SEEK_SET</span><span class="op" id="3381983">)</span><span class="op" id="3381984">;</span>&nbsp;<span class="ident" id="3381986">err</span>&nbsp;<span class="op" id="3381990">!=</span>&nbsp;<span class="ident" id="3381993">nil</span>&nbsp;<span class="op" id="3381997">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382005">pw</span><span class="op" id="3382007">.</span><span class="ident" id="3382008">CloseWithError</span><span class="op" id="3382022">(</span><span class="ident" id="3382023">err</span><span class="op" id="3382026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382034">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382053">if</span>&nbsp;<span class="ident" id="3382056">_</span><span class="op" id="3382057">,</span>&nbsp;<span class="ident" id="3382059">err</span>&nbsp;<span class="op" id="3382063">:=</span>&nbsp;<span class="ident" id="3382066">io</span><span class="op" id="3382068">.</span><span class="ident" id="3382069">CopyN</span><span class="op" id="3382074">(</span><span class="ident" id="3382075">part</span><span class="op" id="3382079">,</span>&nbsp;<span class="ident" id="3382081">content</span><span class="op" id="3382088">,</span>&nbsp;<span class="ident" id="3382090">ra</span><span class="op" id="3382092">.</span><span class="ident" id="3382093">length</span><span class="op" id="3382099">)</span><span class="op" id="3382100">;</span>&nbsp;<span class="ident" id="3382102">err</span>&nbsp;<span class="op" id="3382106">!=</span>&nbsp;<span class="ident" id="3382109">nil</span>&nbsp;<span class="op" id="3382113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382121">pw</span><span class="op" id="3382123">.</span><span class="ident" id="3382124">CloseWithError</span><span class="op" id="3382138">(</span><span class="ident" id="3382139">err</span><span class="op" id="3382142">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382150">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382174">mw</span><span class="op" id="3382176">.</span><span class="ident" id="3382177">Close</span><span class="op" id="3382182">(</span><span class="op" id="3382183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382189">pw</span><span class="op" id="3382191">.</span><span class="ident" id="3382192">Close</span><span class="op" id="3382197">(</span><span class="op" id="3382198">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382203">}</span><span class="op" id="3382204">(</span><span class="op" id="3382205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382214">w</span><span class="op" id="3382215">.</span><span class="ident" id="3382216">Header</span><span class="op" id="3382222">(</span><span class="op" id="3382223">)</span><span class="op" id="3382224">.</span><span class="ident" id="3382225">Set</span><span class="op" id="3382228">(</span><span class="string" id="3382229">&#34;Accept-Ranges&#34;</span><span class="op" id="3382244">,</span>&nbsp;<span class="string" id="3382246">&#34;bytes&#34;</span><span class="op" id="3382253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382257">if</span>&nbsp;<span class="ident" id="3382260">w</span><span class="op" id="3382261">.</span><span class="ident" id="3382262">Header</span><span class="op" id="3382268">(</span><span class="op" id="3382269">)</span><span class="op" id="3382270">.</span><span class="ident" id="3382271">Get</span><span class="op" id="3382274">(</span><span class="string" id="3382275">&#34;Content-Encoding&#34;</span><span class="op" id="3382293">)</span>&nbsp;<span class="op" id="3382295">==</span>&nbsp;<span class="string" id="3382298">&#34;&#34;</span>&nbsp;<span class="op" id="3382301">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382306">w</span><span class="op" id="3382307">.</span><span class="ident" id="3382308">Header</span><span class="op" id="3382314">(</span><span class="op" id="3382315">)</span><span class="op" id="3382316">.</span><span class="ident" id="3382317">Set</span><span class="op" id="3382320">(</span><span class="string" id="3382321">&#34;Content-Length&#34;</span><span class="op" id="3382337">,</span>&nbsp;<span class="ident" id="3382339">strconv</span><span class="op" id="3382346">.</span><span class="ident" id="3382347">FormatInt</span><span class="op" id="3382356">(</span><span class="ident" id="3382357">sendSize</span><span class="op" id="3382365">,</span>&nbsp;<span class="num" id="3382367">10</span><span class="op" id="3382369">)</span><span class="op" id="3382370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382381">w</span><span class="op" id="3382382">.</span><span class="ident" id="3382383">WriteHeader</span><span class="op" id="3382394">(</span><span class="ident" id="3382395">code</span><span class="op" id="3382399">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382403">if</span>&nbsp;<span class="ident" id="3382406">r</span><span class="op" id="3382407">.</span><span class="ident" id="3382408">Method</span>&nbsp;<span class="op" id="3382415">!=</span>&nbsp;<span class="string" id="3382418">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3382425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382429">io</span><span class="op" id="3382431">.</span><span class="ident" id="3382432">CopyN</span><span class="op" id="3382437">(</span><span class="ident" id="3382438">w</span><span class="op" id="3382439">,</span>&nbsp;<span class="ident" id="3382441">sendContent</span><span class="op" id="3382452">,</span>&nbsp;<span class="ident" id="3382454">sendSize</span><span class="op" id="3382462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382465">}</span><br>
<span class="lineno"></span><span class="op" id="3382467">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3382470">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="3382549">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="3382606">func</span>&nbsp;<span class="ident" id="3382611">checkLastModified</span><span class="op" id="3382628">(</span><span class="ident" id="3382629">w</span>&nbsp;<span class="ident" id="3382631">ResponseWriter</span><span class="op" id="3382645">,</span>&nbsp;<span class="ident" id="3382647">r</span>&nbsp;<span class="op" id="3382649">*</span><span class="ident" id="3382650">Request</span><span class="op" id="3382657">,</span>&nbsp;<span class="ident" id="3382659">modtime</span>&nbsp;<span class="ident" id="3382667">time</span><span class="op" id="3382671">.</span><span class="ident" id="3382672">Time</span><span class="op" id="3382676">)</span>&nbsp;<span class="builtintype" id="3382678">bool</span>&nbsp;<span class="op" id="3382683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382686">if</span>&nbsp;<span class="ident" id="3382689">modtime</span><span class="op" id="3382696">.</span><span class="ident" id="3382697">IsZero</span><span class="op" id="3382703">(</span><span class="op" id="3382704">)</span>&nbsp;<span class="op" id="3382706">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382710">return</span>&nbsp;<span class="builtintype" id="3382717">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382728">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382792">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382860">if</span>&nbsp;<span class="ident" id="3382863">t</span><span class="op" id="3382864">,</span>&nbsp;<span class="ident" id="3382866">err</span>&nbsp;<span class="op" id="3382870">:=</span>&nbsp;<span class="ident" id="3382873">time</span><span class="op" id="3382877">.</span><span class="ident" id="3382878">Parse</span><span class="op" id="3382883">(</span><span class="ident" id="3382884">TimeFormat</span><span class="op" id="3382894">,</span>&nbsp;<span class="ident" id="3382896">r</span><span class="op" id="3382897">.</span><span class="ident" id="3382898">Header</span><span class="op" id="3382904">.</span><span class="ident" id="3382905">Get</span><span class="op" id="3382908">(</span><span class="string" id="3382909">&#34;If-Modified-Since&#34;</span><span class="op" id="3382928">)</span><span class="op" id="3382929">)</span><span class="op" id="3382930">;</span>&nbsp;<span class="ident" id="3382932">err</span>&nbsp;<span class="op" id="3382936">==</span>&nbsp;<span class="ident" id="3382939">nil</span>&nbsp;<span class="op" id="3382943">&amp;&amp;</span>&nbsp;<span class="ident" id="3382946">modtime</span><span class="op" id="3382953">.</span><span class="ident" id="3382954">Before</span><span class="op" id="3382960">(</span><span class="ident" id="3382961">t</span><span class="op" id="3382962">.</span><span class="ident" id="3382963">Add</span><span class="op" id="3382966">(</span><span class="num" id="3382967">1</span><span class="op" id="3382968">*</span><span class="ident" id="3382969">time</span><span class="op" id="3382973">.</span><span class="ident" id="3382974">Second</span><span class="op" id="3382980">)</span><span class="op" id="3382981">)</span>&nbsp;<span class="op" id="3382983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382987">h</span>&nbsp;<span class="op" id="3382989">:=</span>&nbsp;<span class="ident" id="3382992">w</span><span class="op" id="3382993">.</span><span class="ident" id="3382994">Header</span><span class="op" id="3383000">(</span><span class="op" id="3383001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3383005">delete</span><span class="op" id="3383011">(</span><span class="ident" id="3383012">h</span><span class="op" id="3383013">,</span>&nbsp;<span class="string" id="3383015">&#34;Content-Type&#34;</span><span class="op" id="3383029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3383033">delete</span><span class="op" id="3383039">(</span><span class="ident" id="3383040">h</span><span class="op" id="3383041">,</span>&nbsp;<span class="string" id="3383043">&#34;Content-Length&#34;</span><span class="op" id="3383059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383063">w</span><span class="op" id="3383064">.</span><span class="ident" id="3383065">WriteHeader</span><span class="op" id="3383076">(</span><span class="ident" id="3383077">StatusNotModified</span><span class="op" id="3383094">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383098">return</span>&nbsp;<span class="builtintype" id="3383105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383114">w</span><span class="op" id="3383115">.</span><span class="ident" id="3383116">Header</span><span class="op" id="3383122">(</span><span class="op" id="3383123">)</span><span class="op" id="3383124">.</span><span class="ident" id="3383125">Set</span><span class="op" id="3383128">(</span><span class="string" id="3383129">&#34;Last-Modified&#34;</span><span class="op" id="3383144">,</span>&nbsp;<span class="ident" id="3383146">modtime</span><span class="op" id="3383153">.</span><span class="ident" id="3383154">UTC</span><span class="op" id="3383157">(</span><span class="op" id="3383158">)</span><span class="op" id="3383159">.</span><span class="ident" id="3383160">Format</span><span class="op" id="3383166">(</span><span class="ident" id="3383167">TimeFormat</span><span class="op" id="3383177">)</span><span class="op" id="3383178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383181">return</span>&nbsp;<span class="builtintype" id="3383188">false</span><br>
<span class="lineno"></span><span class="op" id="3383194">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3383197">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="3383256">//</span><br>
<span class="lineno"></span><span class="comment" id="3383259">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3383319">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="3383388">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="3383446">//</span><br>
<span class="lineno"></span><span class="comment" id="3383449">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3383520">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="3383568">func</span>&nbsp;<span class="ident" id="3383573">checkETag</span><span class="op" id="3383582">(</span><span class="ident" id="3383583">w</span>&nbsp;<span class="ident" id="3383585">ResponseWriter</span><span class="op" id="3383599">,</span>&nbsp;<span class="ident" id="3383601">r</span>&nbsp;<span class="op" id="3383603">*</span><span class="ident" id="3383604">Request</span><span class="op" id="3383611">,</span>&nbsp;<span class="ident" id="3383613">modtime</span>&nbsp;<span class="ident" id="3383621">time</span><span class="op" id="3383625">.</span><span class="ident" id="3383626">Time</span><span class="op" id="3383630">)</span>&nbsp;<span class="op" id="3383632">(</span><span class="ident" id="3383633">rangeReq</span>&nbsp;<span class="builtintype" id="3383642">string</span><span class="op" id="3383648">,</span>&nbsp;<span class="ident" id="3383650">done</span>&nbsp;<span class="builtintype" id="3383655">bool</span><span class="op" id="3383659">)</span>&nbsp;<span class="op" id="3383661">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383664">etag</span>&nbsp;<span class="op" id="3383669">:=</span>&nbsp;<span class="ident" id="3383672">w</span><span class="op" id="3383673">.</span><span class="ident" id="3383674">Header</span><span class="op" id="3383680">(</span><span class="op" id="3383681">)</span><span class="op" id="3383682">.</span><span class="ident" id="3383683">get</span><span class="op" id="3383686">(</span><span class="string" id="3383687">&#34;Etag&#34;</span><span class="op" id="3383693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383696">rangeReq</span>&nbsp;<span class="op" id="3383705">=</span>&nbsp;<span class="ident" id="3383707">r</span><span class="op" id="3383708">.</span><span class="ident" id="3383709">Header</span><span class="op" id="3383715">.</span><span class="ident" id="3383716">get</span><span class="op" id="3383719">(</span><span class="string" id="3383720">&#34;Range&#34;</span><span class="op" id="3383727">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383731">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383800">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383830">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383913">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383932">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383967">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384030">if</span>&nbsp;<span class="ident" id="3384033">ir</span>&nbsp;<span class="op" id="3384036">:=</span>&nbsp;<span class="ident" id="3384039">r</span><span class="op" id="3384040">.</span><span class="ident" id="3384041">Header</span><span class="op" id="3384047">.</span><span class="ident" id="3384048">get</span><span class="op" id="3384051">(</span><span class="string" id="3384052">&#34;If-Range&#34;</span><span class="op" id="3384062">)</span><span class="op" id="3384063">;</span>&nbsp;<span class="ident" id="3384065">ir</span>&nbsp;<span class="op" id="3384068">!=</span>&nbsp;<span class="string" id="3384071">&#34;&#34;</span>&nbsp;<span class="op" id="3384074">&amp;&amp;</span>&nbsp;<span class="ident" id="3384077">ir</span>&nbsp;<span class="op" id="3384080">!=</span>&nbsp;<span class="ident" id="3384083">etag</span>&nbsp;<span class="op" id="3384088">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384092">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384164">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384214">timeMatches</span>&nbsp;<span class="op" id="3384226">:=</span>&nbsp;<span class="builtintype" id="3384229">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384237">if</span>&nbsp;<span class="op" id="3384240">!</span><span class="ident" id="3384241">modtime</span><span class="op" id="3384248">.</span><span class="ident" id="3384249">IsZero</span><span class="op" id="3384255">(</span><span class="op" id="3384256">)</span>&nbsp;<span class="op" id="3384258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384263">if</span>&nbsp;<span class="ident" id="3384266">t</span><span class="op" id="3384267">,</span>&nbsp;<span class="ident" id="3384269">err</span>&nbsp;<span class="op" id="3384273">:=</span>&nbsp;<span class="ident" id="3384276">ParseTime</span><span class="op" id="3384285">(</span><span class="ident" id="3384286">ir</span><span class="op" id="3384288">)</span><span class="op" id="3384289">;</span>&nbsp;<span class="ident" id="3384291">err</span>&nbsp;<span class="op" id="3384295">==</span>&nbsp;<span class="ident" id="3384298">nil</span>&nbsp;<span class="op" id="3384302">&amp;&amp;</span>&nbsp;<span class="ident" id="3384305">t</span><span class="op" id="3384306">.</span><span class="ident" id="3384307">Unix</span><span class="op" id="3384311">(</span><span class="op" id="3384312">)</span>&nbsp;<span class="op" id="3384314">==</span>&nbsp;<span class="ident" id="3384317">modtime</span><span class="op" id="3384324">.</span><span class="ident" id="3384325">Unix</span><span class="op" id="3384329">(</span><span class="op" id="3384330">)</span>&nbsp;<span class="op" id="3384332">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384338">timeMatches</span>&nbsp;<span class="op" id="3384350">=</span>&nbsp;<span class="builtintype" id="3384352">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384368">if</span>&nbsp;<span class="op" id="3384371">!</span><span class="ident" id="3384372">timeMatches</span>&nbsp;<span class="op" id="3384384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384389">rangeReq</span>&nbsp;<span class="op" id="3384398">=</span>&nbsp;<span class="string" id="3384400">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384412">if</span>&nbsp;<span class="ident" id="3384415">inm</span>&nbsp;<span class="op" id="3384419">:=</span>&nbsp;<span class="ident" id="3384422">r</span><span class="op" id="3384423">.</span><span class="ident" id="3384424">Header</span><span class="op" id="3384430">.</span><span class="ident" id="3384431">get</span><span class="op" id="3384434">(</span><span class="string" id="3384435">&#34;If-None-Match&#34;</span><span class="op" id="3384450">)</span><span class="op" id="3384451">;</span>&nbsp;<span class="ident" id="3384453">inm</span>&nbsp;<span class="op" id="3384457">!=</span>&nbsp;<span class="string" id="3384460">&#34;&#34;</span>&nbsp;<span class="op" id="3384463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384467">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384488">if</span>&nbsp;<span class="ident" id="3384491">etag</span>&nbsp;<span class="op" id="3384496">==</span>&nbsp;<span class="string" id="3384499">&#34;&#34;</span>&nbsp;<span class="op" id="3384502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384507">return</span>&nbsp;<span class="ident" id="3384514">rangeReq</span><span class="op" id="3384522">,</span>&nbsp;<span class="builtintype" id="3384524">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384537">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384599">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384652">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384712">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384772">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384827">if</span>&nbsp;<span class="ident" id="3384830">r</span><span class="op" id="3384831">.</span><span class="ident" id="3384832">Method</span>&nbsp;<span class="op" id="3384839">!=</span>&nbsp;<span class="string" id="3384842">&#34;GET&#34;</span>&nbsp;<span class="op" id="3384848">&amp;&amp;</span>&nbsp;<span class="ident" id="3384851">r</span><span class="op" id="3384852">.</span><span class="ident" id="3384853">Method</span>&nbsp;<span class="op" id="3384860">!=</span>&nbsp;<span class="string" id="3384863">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3384870">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384875">return</span>&nbsp;<span class="ident" id="3384882">rangeReq</span><span class="op" id="3384890">,</span>&nbsp;<span class="builtintype" id="3384892">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384905">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384971">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385038">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385066">if</span>&nbsp;<span class="ident" id="3385069">inm</span>&nbsp;<span class="op" id="3385073">==</span>&nbsp;<span class="ident" id="3385076">etag</span>&nbsp;<span class="op" id="3385081">||</span>&nbsp;<span class="ident" id="3385084">inm</span>&nbsp;<span class="op" id="3385088">==</span>&nbsp;<span class="string" id="3385091">&#34;*&#34;</span>&nbsp;<span class="op" id="3385095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385100">h</span>&nbsp;<span class="op" id="3385102">:=</span>&nbsp;<span class="ident" id="3385105">w</span><span class="op" id="3385106">.</span><span class="ident" id="3385107">Header</span><span class="op" id="3385113">(</span><span class="op" id="3385114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3385119">delete</span><span class="op" id="3385125">(</span><span class="ident" id="3385126">h</span><span class="op" id="3385127">,</span>&nbsp;<span class="string" id="3385129">&#34;Content-Type&#34;</span><span class="op" id="3385143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3385148">delete</span><span class="op" id="3385154">(</span><span class="ident" id="3385155">h</span><span class="op" id="3385156">,</span>&nbsp;<span class="string" id="3385158">&#34;Content-Length&#34;</span><span class="op" id="3385174">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385179">w</span><span class="op" id="3385180">.</span><span class="ident" id="3385181">WriteHeader</span><span class="op" id="3385192">(</span><span class="ident" id="3385193">StatusNotModified</span><span class="op" id="3385210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385215">return</span>&nbsp;<span class="string" id="3385222">&#34;&#34;</span><span class="op" id="3385224">,</span>&nbsp;<span class="builtintype" id="3385226">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385239">return</span>&nbsp;<span class="ident" id="3385246">rangeReq</span><span class="op" id="3385254">,</span>&nbsp;<span class="builtintype" id="3385256">false</span><br>
<span class="lineno">340</span><span class="op" id="3385262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3385265">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="3385315">func</span>&nbsp;<span class="ident" id="3385320">serveFile</span><span class="op" id="3385329">(</span><span class="ident" id="3385330">w</span>&nbsp;<span class="ident" id="3385332">ResponseWriter</span><span class="op" id="3385346">,</span>&nbsp;<span class="ident" id="3385348">r</span>&nbsp;<span class="op" id="3385350">*</span><span class="ident" id="3385351">Request</span><span class="op" id="3385358">,</span>&nbsp;<span class="ident" id="3385360">fs</span>&nbsp;<span class="ident" id="3385363">FileSystem</span><span class="op" id="3385373">,</span>&nbsp;<span class="ident" id="3385375">name</span>&nbsp;<span class="builtintype" id="3385380">string</span><span class="op" id="3385386">,</span>&nbsp;<span class="ident" id="3385388">redirect</span>&nbsp;<span class="builtintype" id="3385397">bool</span><span class="op" id="3385401">)</span>&nbsp;<span class="op" id="3385403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385406">const</span>&nbsp;<span class="ident" id="3385412">indexPage</span>&nbsp;<span class="op" id="3385422">=</span>&nbsp;<span class="string" id="3385424">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385440">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385476">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385544">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385599">if</span>&nbsp;<span class="ident" id="3385602">strings</span><span class="op" id="3385609">.</span><span class="ident" id="3385610">HasSuffix</span><span class="op" id="3385619">(</span><span class="ident" id="3385620">r</span><span class="op" id="3385621">.</span><span class="ident" id="3385622">URL</span><span class="op" id="3385625">.</span><span class="ident" id="3385626">Path</span><span class="op" id="3385630">,</span>&nbsp;<span class="ident" id="3385632">indexPage</span><span class="op" id="3385641">)</span>&nbsp;<span class="op" id="3385643">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385647">localRedirect</span><span class="op" id="3385660">(</span><span class="ident" id="3385661">w</span><span class="op" id="3385662">,</span>&nbsp;<span class="ident" id="3385664">r</span><span class="op" id="3385665">,</span>&nbsp;<span class="string" id="3385667">&#34;./&#34;</span><span class="op" id="3385671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385675">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385687">f</span><span class="op" id="3385688">,</span>&nbsp;<span class="ident" id="3385690">err</span>&nbsp;<span class="op" id="3385694">:=</span>&nbsp;<span class="ident" id="3385697">fs</span><span class="op" id="3385699">.</span><span class="ident" id="3385700">Open</span><span class="op" id="3385704">(</span><span class="ident" id="3385705">name</span><span class="op" id="3385709">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385712">if</span>&nbsp;<span class="ident" id="3385715">err</span>&nbsp;<span class="op" id="3385719">!=</span>&nbsp;<span class="ident" id="3385722">nil</span>&nbsp;<span class="op" id="3385726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385730">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385761">NotFound</span><span class="op" id="3385769">(</span><span class="ident" id="3385770">w</span><span class="op" id="3385771">,</span>&nbsp;<span class="ident" id="3385773">r</span><span class="op" id="3385774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385778">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385786">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385789">defer</span>&nbsp;<span class="ident" id="3385795">f</span><span class="op" id="3385796">.</span><span class="ident" id="3385797">Close</span><span class="op" id="3385802">(</span><span class="op" id="3385803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385807">d</span><span class="op" id="3385808">,</span>&nbsp;<span class="ident" id="3385810">err1</span>&nbsp;<span class="op" id="3385815">:=</span>&nbsp;<span class="ident" id="3385818">f</span><span class="op" id="3385819">.</span><span class="ident" id="3385820">Stat</span><span class="op" id="3385824">(</span><span class="op" id="3385825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385828">if</span>&nbsp;<span class="ident" id="3385831">err1</span>&nbsp;<span class="op" id="3385836">!=</span>&nbsp;<span class="ident" id="3385839">nil</span>&nbsp;<span class="op" id="3385843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385847">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385878">NotFound</span><span class="op" id="3385886">(</span><span class="ident" id="3385887">w</span><span class="op" id="3385888">,</span>&nbsp;<span class="ident" id="3385890">r</span><span class="op" id="3385891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385895">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385907">if</span>&nbsp;<span class="ident" id="3385910">redirect</span>&nbsp;<span class="op" id="3385919">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385923">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385982">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386019">url</span>&nbsp;<span class="op" id="3386023">:=</span>&nbsp;<span class="ident" id="3386026">r</span><span class="op" id="3386027">.</span><span class="ident" id="3386028">URL</span><span class="op" id="3386031">.</span><span class="ident" id="3386032">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386039">if</span>&nbsp;<span class="ident" id="3386042">d</span><span class="op" id="3386043">.</span><span class="ident" id="3386044">IsDir</span><span class="op" id="3386049">(</span><span class="op" id="3386050">)</span>&nbsp;<span class="op" id="3386052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386057">if</span>&nbsp;<span class="ident" id="3386060">url</span><span class="op" id="3386063">[</span><span class="builtinfunc" id="3386064">len</span><span class="op" id="3386067">(</span><span class="ident" id="3386068">url</span><span class="op" id="3386071">)</span><span class="op" id="3386072">-</span><span class="num" id="3386073">1</span><span class="op" id="3386074">]</span>&nbsp;<span class="op" id="3386076">!=</span>&nbsp;<span class="string" id="3386079">&#39;/&#39;</span>&nbsp;<span class="op" id="3386083">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386089">localRedirect</span><span class="op" id="3386102">(</span><span class="ident" id="3386103">w</span><span class="op" id="3386104">,</span>&nbsp;<span class="ident" id="3386106">r</span><span class="op" id="3386107">,</span>&nbsp;<span class="ident" id="3386109">path</span><span class="op" id="3386113">.</span><span class="ident" id="3386114">Base</span><span class="op" id="3386118">(</span><span class="ident" id="3386119">url</span><span class="op" id="3386122">)</span><span class="op" id="3386123">+</span><span class="string" id="3386124">&#34;/&#34;</span><span class="op" id="3386127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386133">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386147">}</span>&nbsp;<span class="keyword" id="3386149">else</span>&nbsp;<span class="op" id="3386154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386159">if</span>&nbsp;<span class="ident" id="3386162">url</span><span class="op" id="3386165">[</span><span class="builtinfunc" id="3386166">len</span><span class="op" id="3386169">(</span><span class="ident" id="3386170">url</span><span class="op" id="3386173">)</span><span class="op" id="3386174">-</span><span class="num" id="3386175">1</span><span class="op" id="3386176">]</span>&nbsp;<span class="op" id="3386178">==</span>&nbsp;<span class="string" id="3386181">&#39;/&#39;</span>&nbsp;<span class="op" id="3386185">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386191">localRedirect</span><span class="op" id="3386204">(</span><span class="ident" id="3386205">w</span><span class="op" id="3386206">,</span>&nbsp;<span class="ident" id="3386208">r</span><span class="op" id="3386209">,</span>&nbsp;<span class="string" id="3386211">&#34;../&#34;</span><span class="op" id="3386216">+</span><span class="ident" id="3386217">path</span><span class="op" id="3386221">.</span><span class="ident" id="3386222">Base</span><span class="op" id="3386226">(</span><span class="ident" id="3386227">url</span><span class="op" id="3386230">)</span><span class="op" id="3386231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386237">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386254">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386258">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386315">if</span>&nbsp;<span class="ident" id="3386318">d</span><span class="op" id="3386319">.</span><span class="ident" id="3386320">IsDir</span><span class="op" id="3386325">(</span><span class="op" id="3386326">)</span>&nbsp;<span class="op" id="3386328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386332">index</span>&nbsp;<span class="op" id="3386338">:=</span>&nbsp;<span class="ident" id="3386341">strings</span><span class="op" id="3386348">.</span><span class="ident" id="3386349">TrimSuffix</span><span class="op" id="3386359">(</span><span class="ident" id="3386360">name</span><span class="op" id="3386364">,</span>&nbsp;<span class="string" id="3386366">&#34;/&#34;</span><span class="op" id="3386369">)</span>&nbsp;<span class="op" id="3386371">+</span>&nbsp;<span class="ident" id="3386373">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386385">ff</span><span class="op" id="3386387">,</span>&nbsp;<span class="ident" id="3386389">err</span>&nbsp;<span class="op" id="3386393">:=</span>&nbsp;<span class="ident" id="3386396">fs</span><span class="op" id="3386398">.</span><span class="ident" id="3386399">Open</span><span class="op" id="3386403">(</span><span class="ident" id="3386404">index</span><span class="op" id="3386409">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386413">if</span>&nbsp;<span class="ident" id="3386416">err</span>&nbsp;<span class="op" id="3386420">==</span>&nbsp;<span class="ident" id="3386423">nil</span>&nbsp;<span class="op" id="3386427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386432">defer</span>&nbsp;<span class="ident" id="3386438">ff</span><span class="op" id="3386440">.</span><span class="ident" id="3386441">Close</span><span class="op" id="3386446">(</span><span class="op" id="3386447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386452">dd</span><span class="op" id="3386454">,</span>&nbsp;<span class="ident" id="3386456">err</span>&nbsp;<span class="op" id="3386460">:=</span>&nbsp;<span class="ident" id="3386463">ff</span><span class="op" id="3386465">.</span><span class="ident" id="3386466">Stat</span><span class="op" id="3386470">(</span><span class="op" id="3386471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386476">if</span>&nbsp;<span class="ident" id="3386479">err</span>&nbsp;<span class="op" id="3386483">==</span>&nbsp;<span class="ident" id="3386486">nil</span>&nbsp;<span class="op" id="3386490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386496">name</span>&nbsp;<span class="op" id="3386501">=</span>&nbsp;<span class="ident" id="3386503">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386513">d</span>&nbsp;<span class="op" id="3386515">=</span>&nbsp;<span class="ident" id="3386517">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386524">f</span>&nbsp;<span class="op" id="3386526">=</span>&nbsp;<span class="ident" id="3386528">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386541">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386545">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386604">if</span>&nbsp;<span class="ident" id="3386607">d</span><span class="op" id="3386608">.</span><span class="ident" id="3386609">IsDir</span><span class="op" id="3386614">(</span><span class="op" id="3386615">)</span>&nbsp;<span class="op" id="3386617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386621">if</span>&nbsp;<span class="ident" id="3386624">checkLastModified</span><span class="op" id="3386641">(</span><span class="ident" id="3386642">w</span><span class="op" id="3386643">,</span>&nbsp;<span class="ident" id="3386645">r</span><span class="op" id="3386646">,</span>&nbsp;<span class="ident" id="3386648">d</span><span class="op" id="3386649">.</span><span class="ident" id="3386650">ModTime</span><span class="op" id="3386657">(</span><span class="op" id="3386658">)</span><span class="op" id="3386659">)</span>&nbsp;<span class="op" id="3386661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386666">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386679">dirList</span><span class="op" id="3386686">(</span><span class="ident" id="3386687">w</span><span class="op" id="3386688">,</span>&nbsp;<span class="ident" id="3386690">f</span><span class="op" id="3386691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386695">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386707">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386753">sizeFunc</span>&nbsp;<span class="op" id="3386762">:=</span>&nbsp;<span class="keyword" id="3386765">func</span><span class="op" id="3386769">(</span><span class="op" id="3386770">)</span>&nbsp;<span class="op" id="3386772">(</span><span class="ident" id="3386773">int64</span><span class="op" id="3386778">,</span>&nbsp;<span class="builtintype" id="3386780">error</span><span class="op" id="3386785">)</span>&nbsp;<span class="op" id="3386787">{</span>&nbsp;<span class="keyword" id="3386789">return</span>&nbsp;<span class="ident" id="3386796">d</span><span class="op" id="3386797">.</span><span class="ident" id="3386798">Size</span><span class="op" id="3386802">(</span><span class="op" id="3386803">)</span><span class="op" id="3386804">,</span>&nbsp;<span class="ident" id="3386806">nil</span>&nbsp;<span class="op" id="3386810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386813">serveContent</span><span class="op" id="3386825">(</span><span class="ident" id="3386826">w</span><span class="op" id="3386827">,</span>&nbsp;<span class="ident" id="3386829">r</span><span class="op" id="3386830">,</span>&nbsp;<span class="ident" id="3386832">d</span><span class="op" id="3386833">.</span><span class="ident" id="3386834">Name</span><span class="op" id="3386838">(</span><span class="op" id="3386839">)</span><span class="op" id="3386840">,</span>&nbsp;<span class="ident" id="3386842">d</span><span class="op" id="3386843">.</span><span class="ident" id="3386844">ModTime</span><span class="op" id="3386851">(</span><span class="op" id="3386852">)</span><span class="op" id="3386853">,</span>&nbsp;<span class="ident" id="3386855">sizeFunc</span><span class="op" id="3386863">,</span>&nbsp;<span class="ident" id="3386865">f</span><span class="op" id="3386866">)</span><br>
<span class="lineno"></span><span class="op" id="3386868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3386871">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3386924">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="3387000">func</span>&nbsp;<span class="ident" id="3387005">localRedirect</span><span class="op" id="3387018">(</span><span class="ident" id="3387019">w</span>&nbsp;<span class="ident" id="3387021">ResponseWriter</span><span class="op" id="3387035">,</span>&nbsp;<span class="ident" id="3387037">r</span>&nbsp;<span class="op" id="3387039">*</span><span class="ident" id="3387040">Request</span><span class="op" id="3387047">,</span>&nbsp;<span class="ident" id="3387049">newPath</span>&nbsp;<span class="builtintype" id="3387057">string</span><span class="op" id="3387063">)</span>&nbsp;<span class="op" id="3387065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387068">if</span>&nbsp;<span class="ident" id="3387071">q</span>&nbsp;<span class="op" id="3387073">:=</span>&nbsp;<span class="ident" id="3387076">r</span><span class="op" id="3387077">.</span><span class="ident" id="3387078">URL</span><span class="op" id="3387081">.</span><span class="ident" id="3387082">RawQuery</span><span class="op" id="3387090">;</span>&nbsp;<span class="ident" id="3387092">q</span>&nbsp;<span class="op" id="3387094">!=</span>&nbsp;<span class="string" id="3387097">&#34;&#34;</span>&nbsp;<span class="op" id="3387100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387104">newPath</span>&nbsp;<span class="op" id="3387112">+=</span>&nbsp;<span class="string" id="3387115">&#34;?&#34;</span>&nbsp;<span class="op" id="3387119">+</span>&nbsp;<span class="ident" id="3387121">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387127">w</span><span class="op" id="3387128">.</span><span class="ident" id="3387129">Header</span><span class="op" id="3387135">(</span><span class="op" id="3387136">)</span><span class="op" id="3387137">.</span><span class="ident" id="3387138">Set</span><span class="op" id="3387141">(</span><span class="string" id="3387142">&#34;Location&#34;</span><span class="op" id="3387152">,</span>&nbsp;<span class="ident" id="3387154">newPath</span><span class="op" id="3387161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387164">w</span><span class="op" id="3387165">.</span><span class="ident" id="3387166">WriteHeader</span><span class="op" id="3387177">(</span><span class="ident" id="3387178">StatusMovedPermanently</span><span class="op" id="3387200">)</span><br>
<span class="lineno"></span><span class="op" id="3387202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="3387205">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="3387291">func</span>&nbsp;<span class="ident" id="3387296">ServeFile</span><span class="op" id="3387305">(</span><span class="ident" id="3387306">w</span>&nbsp;<span class="ident" id="3387308">ResponseWriter</span><span class="op" id="3387322">,</span>&nbsp;<span class="ident" id="3387324">r</span>&nbsp;<span class="op" id="3387326">*</span><span class="ident" id="3387327">Request</span><span class="op" id="3387334">,</span>&nbsp;<span class="ident" id="3387336">name</span>&nbsp;<span class="builtintype" id="3387341">string</span><span class="op" id="3387347">)</span>&nbsp;<span class="op" id="3387349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387352">dir</span><span class="op" id="3387355">,</span>&nbsp;<span class="ident" id="3387357">file</span>&nbsp;<span class="op" id="3387362">:=</span>&nbsp;<span class="ident" id="3387365">filepath</span><span class="op" id="3387373">.</span><span class="ident" id="3387374">Split</span><span class="op" id="3387379">(</span><span class="ident" id="3387380">name</span><span class="op" id="3387384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387387">serveFile</span><span class="op" id="3387396">(</span><span class="ident" id="3387397">w</span><span class="op" id="3387398">,</span>&nbsp;<span class="ident" id="3387400">r</span><span class="op" id="3387401">,</span>&nbsp;<span class="ident" id="3387403">Dir</span><span class="op" id="3387406">(</span><span class="ident" id="3387407">dir</span><span class="op" id="3387410">)</span><span class="op" id="3387411">,</span>&nbsp;<span class="ident" id="3387413">file</span><span class="op" id="3387417">,</span>&nbsp;<span class="builtintype" id="3387419">false</span><span class="op" id="3387424">)</span><br>
<span class="lineno"></span><span class="op" id="3387426">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3387429">type</span>&nbsp;<span class="ident" id="3387434">fileHandler</span>&nbsp;<span class="keyword" id="3387446">struct</span>&nbsp;<span class="op" id="3387453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387456">root</span>&nbsp;<span class="ident" id="3387461">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="3387472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="3387475">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3387533">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="3387589">//</span><br>
<span class="lineno"></span><span class="comment" id="3387592">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="3387653">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="3387670">//</span><br>
<span class="lineno"></span><span class="comment" id="3387673">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="3387732">func</span>&nbsp;<span class="ident" id="3387737">FileServer</span><span class="op" id="3387747">(</span><span class="ident" id="3387748">root</span>&nbsp;<span class="ident" id="3387753">FileSystem</span><span class="op" id="3387763">)</span>&nbsp;<span class="ident" id="3387765">Handler</span>&nbsp;<span class="op" id="3387773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387776">return</span>&nbsp;<span class="op" id="3387783">&amp;</span><span class="ident" id="3387784">fileHandler</span><span class="op" id="3387795">{</span><span class="ident" id="3387796">root</span><span class="op" id="3387800">}</span><br>
<span class="lineno"></span><span class="op" id="3387802">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="3387805">func</span>&nbsp;<span class="op" id="3387810">(</span><span class="ident" id="3387811">f</span>&nbsp;<span class="op" id="3387813">*</span><span class="ident" id="3387814">fileHandler</span><span class="op" id="3387825">)</span>&nbsp;<span class="ident" id="3387827">ServeHTTP</span><span class="op" id="3387836">(</span><span class="ident" id="3387837">w</span>&nbsp;<span class="ident" id="3387839">ResponseWriter</span><span class="op" id="3387853">,</span>&nbsp;<span class="ident" id="3387855">r</span>&nbsp;<span class="op" id="3387857">*</span><span class="ident" id="3387858">Request</span><span class="op" id="3387865">)</span>&nbsp;<span class="op" id="3387867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387870">upath</span>&nbsp;<span class="op" id="3387876">:=</span>&nbsp;<span class="ident" id="3387879">r</span><span class="op" id="3387880">.</span><span class="ident" id="3387881">URL</span><span class="op" id="3387884">.</span><span class="ident" id="3387885">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387891">if</span>&nbsp;<span class="op" id="3387894">!</span><span class="ident" id="3387895">strings</span><span class="op" id="3387902">.</span><span class="ident" id="3387903">HasPrefix</span><span class="op" id="3387912">(</span><span class="ident" id="3387913">upath</span><span class="op" id="3387918">,</span>&nbsp;<span class="string" id="3387920">&#34;/&#34;</span><span class="op" id="3387923">)</span>&nbsp;<span class="op" id="3387925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387929">upath</span>&nbsp;<span class="op" id="3387935">=</span>&nbsp;<span class="string" id="3387937">&#34;/&#34;</span>&nbsp;<span class="op" id="3387941">+</span>&nbsp;<span class="ident" id="3387943">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387951">r</span><span class="op" id="3387952">.</span><span class="ident" id="3387953">URL</span><span class="op" id="3387956">.</span><span class="ident" id="3387957">Path</span>&nbsp;<span class="op" id="3387962">=</span>&nbsp;<span class="ident" id="3387964">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387974">serveFile</span><span class="op" id="3387983">(</span><span class="ident" id="3387984">w</span><span class="op" id="3387985">,</span>&nbsp;<span class="ident" id="3387987">r</span><span class="op" id="3387988">,</span>&nbsp;<span class="ident" id="3387990">f</span><span class="op" id="3387991">.</span><span class="ident" id="3387992">root</span><span class="op" id="3387996">,</span>&nbsp;<span class="ident" id="3387998">path</span><span class="op" id="3388002">.</span><span class="ident" id="3388003">Clean</span><span class="op" id="3388008">(</span><span class="ident" id="3388009">upath</span><span class="op" id="3388014">)</span><span class="op" id="3388015">,</span>&nbsp;<span class="builtintype" id="3388017">true</span><span class="op" id="3388021">)</span><br>
<span class="lineno"></span><span class="op" id="3388023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="3388026">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3388090">type</span>&nbsp;<span class="ident" id="3388095">httpRange</span>&nbsp;<span class="keyword" id="3388105">struct</span>&nbsp;<span class="op" id="3388112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388115">start</span><span class="op" id="3388120">,</span>&nbsp;<span class="ident" id="3388122">length</span>&nbsp;<span class="ident" id="3388129">int64</span><br>
<span class="lineno"></span><span class="op" id="3388135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="3388138">func</span>&nbsp;<span class="op" id="3388143">(</span><span class="ident" id="3388144">r</span>&nbsp;<span class="ident" id="3388146">httpRange</span><span class="op" id="3388155">)</span>&nbsp;<span class="ident" id="3388157">contentRange</span><span class="op" id="3388169">(</span><span class="ident" id="3388170">size</span>&nbsp;<span class="ident" id="3388175">int64</span><span class="op" id="3388180">)</span>&nbsp;<span class="builtintype" id="3388182">string</span>&nbsp;<span class="op" id="3388189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388192">return</span>&nbsp;<span class="ident" id="3388199">fmt</span><span class="op" id="3388202">.</span><span class="ident" id="3388203">Sprintf</span><span class="op" id="3388210">(</span><span class="string" id="3388211">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="3388227">,</span>&nbsp;<span class="ident" id="3388229">r</span><span class="op" id="3388230">.</span><span class="ident" id="3388231">start</span><span class="op" id="3388236">,</span>&nbsp;<span class="ident" id="3388238">r</span><span class="op" id="3388239">.</span><span class="ident" id="3388240">start</span><span class="op" id="3388245">+</span><span class="ident" id="3388246">r</span><span class="op" id="3388247">.</span><span class="ident" id="3388248">length</span><span class="op" id="3388254">-</span><span class="num" id="3388255">1</span><span class="op" id="3388256">,</span>&nbsp;<span class="ident" id="3388258">size</span><span class="op" id="3388262">)</span><br>
<span class="lineno"></span><span class="op" id="3388264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3388267">func</span>&nbsp;<span class="op" id="3388272">(</span><span class="ident" id="3388273">r</span>&nbsp;<span class="ident" id="3388275">httpRange</span><span class="op" id="3388284">)</span>&nbsp;<span class="ident" id="3388286">mimeHeader</span><span class="op" id="3388296">(</span><span class="ident" id="3388297">contentType</span>&nbsp;<span class="builtintype" id="3388309">string</span><span class="op" id="3388315">,</span>&nbsp;<span class="ident" id="3388317">size</span>&nbsp;<span class="ident" id="3388322">int64</span><span class="op" id="3388327">)</span>&nbsp;<span class="ident" id="3388329">textproto</span><span class="op" id="3388338">.</span><span class="ident" id="3388339">MIMEHeader</span>&nbsp;<span class="op" id="3388350">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388353">return</span>&nbsp;<span class="ident" id="3388360">textproto</span><span class="op" id="3388369">.</span><span class="ident" id="3388370">MIMEHeader</span><span class="op" id="3388380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3388384">&#34;Content-Range&#34;</span><span class="op" id="3388399">:</span>&nbsp;<span class="op" id="3388401">{</span><span class="ident" id="3388402">r</span><span class="op" id="3388403">.</span><span class="ident" id="3388404">contentRange</span><span class="op" id="3388416">(</span><span class="ident" id="3388417">size</span><span class="op" id="3388421">)</span><span class="op" id="3388422">}</span><span class="op" id="3388423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3388427">&#34;Content-Type&#34;</span><span class="op" id="3388441">:</span>&nbsp;&nbsp;<span class="op" id="3388444">{</span><span class="ident" id="3388445">contentType</span><span class="op" id="3388456">}</span><span class="op" id="3388457">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388460">}</span><br>
<span class="lineno"></span><span class="op" id="3388462">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3388465">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="3388525">func</span>&nbsp;<span class="ident" id="3388530">parseRange</span><span class="op" id="3388540">(</span><span class="ident" id="3388541">s</span>&nbsp;<span class="builtintype" id="3388543">string</span><span class="op" id="3388549">,</span>&nbsp;<span class="ident" id="3388551">size</span>&nbsp;<span class="ident" id="3388556">int64</span><span class="op" id="3388561">)</span>&nbsp;<span class="op" id="3388563">(</span><span class="op" id="3388564">[</span><span class="op" id="3388565">]</span><span class="ident" id="3388566">httpRange</span><span class="op" id="3388575">,</span>&nbsp;<span class="builtintype" id="3388577">error</span><span class="op" id="3388582">)</span>&nbsp;<span class="op" id="3388584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388587">if</span>&nbsp;<span class="ident" id="3388590">s</span>&nbsp;<span class="op" id="3388592">==</span>&nbsp;<span class="string" id="3388595">&#34;&#34;</span>&nbsp;<span class="op" id="3388598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388602">return</span>&nbsp;<span class="ident" id="3388609">nil</span><span class="op" id="3388612">,</span>&nbsp;<span class="ident" id="3388614">nil</span>&nbsp;<span class="comment" id="3388618">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388644">const</span>&nbsp;<span class="ident" id="3388650">b</span>&nbsp;<span class="op" id="3388652">=</span>&nbsp;<span class="string" id="3388654">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388664">if</span>&nbsp;<span class="op" id="3388667">!</span><span class="ident" id="3388668">strings</span><span class="op" id="3388675">.</span><span class="ident" id="3388676">HasPrefix</span><span class="op" id="3388685">(</span><span class="ident" id="3388686">s</span><span class="op" id="3388687">,</span>&nbsp;<span class="ident" id="3388689">b</span><span class="op" id="3388690">)</span>&nbsp;<span class="op" id="3388692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388696">return</span>&nbsp;<span class="ident" id="3388703">nil</span><span class="op" id="3388706">,</span>&nbsp;<span class="ident" id="3388708">errors</span><span class="op" id="3388714">.</span><span class="ident" id="3388715">New</span><span class="op" id="3388718">(</span><span class="string" id="3388719">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3388734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388737">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388740">var</span>&nbsp;<span class="ident" id="3388744">ranges</span>&nbsp;<span class="op" id="3388751">[</span><span class="op" id="3388752">]</span><span class="ident" id="3388753">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388764">for</span>&nbsp;<span class="ident" id="3388768">_</span><span class="op" id="3388769">,</span>&nbsp;<span class="ident" id="3388771">ra</span>&nbsp;<span class="op" id="3388774">:=</span>&nbsp;<span class="keyword" id="3388777">range</span>&nbsp;<span class="ident" id="3388783">strings</span><span class="op" id="3388790">.</span><span class="ident" id="3388791">Split</span><span class="op" id="3388796">(</span><span class="ident" id="3388797">s</span><span class="op" id="3388798">[</span><span class="builtinfunc" id="3388799">len</span><span class="op" id="3388802">(</span><span class="ident" id="3388803">b</span><span class="op" id="3388804">)</span><span class="op" id="3388805">:</span><span class="op" id="3388806">]</span><span class="op" id="3388807">,</span>&nbsp;<span class="string" id="3388809">&#34;,&#34;</span><span class="op" id="3388812">)</span>&nbsp;<span class="op" id="3388814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388818">ra</span>&nbsp;<span class="op" id="3388821">=</span>&nbsp;<span class="ident" id="3388823">strings</span><span class="op" id="3388830">.</span><span class="ident" id="3388831">TrimSpace</span><span class="op" id="3388840">(</span><span class="ident" id="3388841">ra</span><span class="op" id="3388843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388847">if</span>&nbsp;<span class="ident" id="3388850">ra</span>&nbsp;<span class="op" id="3388853">==</span>&nbsp;<span class="string" id="3388856">&#34;&#34;</span>&nbsp;<span class="op" id="3388859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388864">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388879">i</span>&nbsp;<span class="op" id="3388881">:=</span>&nbsp;<span class="ident" id="3388884">strings</span><span class="op" id="3388891">.</span><span class="ident" id="3388892">Index</span><span class="op" id="3388897">(</span><span class="ident" id="3388898">ra</span><span class="op" id="3388900">,</span>&nbsp;<span class="string" id="3388902">&#34;-&#34;</span><span class="op" id="3388905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388909">if</span>&nbsp;<span class="ident" id="3388912">i</span>&nbsp;<span class="op" id="3388914">&lt;</span>&nbsp;<span class="num" id="3388916">0</span>&nbsp;<span class="op" id="3388918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388923">return</span>&nbsp;<span class="ident" id="3388930">nil</span><span class="op" id="3388933">,</span>&nbsp;<span class="ident" id="3388935">errors</span><span class="op" id="3388941">.</span><span class="ident" id="3388942">New</span><span class="op" id="3388945">(</span><span class="string" id="3388946">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3388961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388965">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388969">start</span><span class="op" id="3388974">,</span>&nbsp;<span class="ident" id="3388976">end</span>&nbsp;<span class="op" id="3388980">:=</span>&nbsp;<span class="ident" id="3388983">strings</span><span class="op" id="3388990">.</span><span class="ident" id="3388991">TrimSpace</span><span class="op" id="3389000">(</span><span class="ident" id="3389001">ra</span><span class="op" id="3389003">[</span><span class="op" id="3389004">:</span><span class="ident" id="3389005">i</span><span class="op" id="3389006">]</span><span class="op" id="3389007">)</span><span class="op" id="3389008">,</span>&nbsp;<span class="ident" id="3389010">strings</span><span class="op" id="3389017">.</span><span class="ident" id="3389018">TrimSpace</span><span class="op" id="3389027">(</span><span class="ident" id="3389028">ra</span><span class="op" id="3389030">[</span><span class="ident" id="3389031">i</span><span class="op" id="3389032">+</span><span class="num" id="3389033">1</span><span class="op" id="3389034">:</span><span class="op" id="3389035">]</span><span class="op" id="3389036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389040">var</span>&nbsp;<span class="ident" id="3389044">r</span>&nbsp;<span class="ident" id="3389046">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389058">if</span>&nbsp;<span class="ident" id="3389061">start</span>&nbsp;<span class="op" id="3389067">==</span>&nbsp;<span class="string" id="3389070">&#34;&#34;</span>&nbsp;<span class="op" id="3389073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389078">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389128">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389179">i</span><span class="op" id="3389180">,</span>&nbsp;<span class="ident" id="3389182">err</span>&nbsp;<span class="op" id="3389186">:=</span>&nbsp;<span class="ident" id="3389189">strconv</span><span class="op" id="3389196">.</span><span class="ident" id="3389197">ParseInt</span><span class="op" id="3389205">(</span><span class="ident" id="3389206">end</span><span class="op" id="3389209">,</span>&nbsp;<span class="num" id="3389211">10</span><span class="op" id="3389213">,</span>&nbsp;<span class="num" id="3389215">64</span><span class="op" id="3389217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389222">if</span>&nbsp;<span class="ident" id="3389225">err</span>&nbsp;<span class="op" id="3389229">!=</span>&nbsp;<span class="ident" id="3389232">nil</span>&nbsp;<span class="op" id="3389236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389242">return</span>&nbsp;<span class="ident" id="3389249">nil</span><span class="op" id="3389252">,</span>&nbsp;<span class="ident" id="3389254">errors</span><span class="op" id="3389260">.</span><span class="ident" id="3389261">New</span><span class="op" id="3389264">(</span><span class="string" id="3389265">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3389280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389290">if</span>&nbsp;<span class="ident" id="3389293">i</span>&nbsp;<span class="op" id="3389295">&gt;</span>&nbsp;<span class="ident" id="3389297">size</span>&nbsp;<span class="op" id="3389302">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389308">i</span>&nbsp;<span class="op" id="3389310">=</span>&nbsp;<span class="ident" id="3389312">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389325">r</span><span class="op" id="3389326">.</span><span class="ident" id="3389327">start</span>&nbsp;<span class="op" id="3389333">=</span>&nbsp;<span class="ident" id="3389335">size</span>&nbsp;<span class="op" id="3389340">-</span>&nbsp;<span class="ident" id="3389342">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389347">r</span><span class="op" id="3389348">.</span><span class="ident" id="3389349">length</span>&nbsp;<span class="op" id="3389356">=</span>&nbsp;<span class="ident" id="3389358">size</span>&nbsp;<span class="op" id="3389363">-</span>&nbsp;<span class="ident" id="3389365">r</span><span class="op" id="3389366">.</span><span class="ident" id="3389367">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389375">}</span>&nbsp;<span class="keyword" id="3389377">else</span>&nbsp;<span class="op" id="3389382">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389387">i</span><span class="op" id="3389388">,</span>&nbsp;<span class="ident" id="3389390">err</span>&nbsp;<span class="op" id="3389394">:=</span>&nbsp;<span class="ident" id="3389397">strconv</span><span class="op" id="3389404">.</span><span class="ident" id="3389405">ParseInt</span><span class="op" id="3389413">(</span><span class="ident" id="3389414">start</span><span class="op" id="3389419">,</span>&nbsp;<span class="num" id="3389421">10</span><span class="op" id="3389423">,</span>&nbsp;<span class="num" id="3389425">64</span><span class="op" id="3389427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389432">if</span>&nbsp;<span class="ident" id="3389435">err</span>&nbsp;<span class="op" id="3389439">!=</span>&nbsp;<span class="ident" id="3389442">nil</span>&nbsp;<span class="op" id="3389446">||</span>&nbsp;<span class="ident" id="3389449">i</span>&nbsp;<span class="op" id="3389451">&gt;</span>&nbsp;<span class="ident" id="3389453">size</span>&nbsp;<span class="op" id="3389458">||</span>&nbsp;<span class="ident" id="3389461">i</span>&nbsp;<span class="op" id="3389463">&lt;</span>&nbsp;<span class="num" id="3389465">0</span>&nbsp;<span class="op" id="3389467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389473">return</span>&nbsp;<span class="ident" id="3389480">nil</span><span class="op" id="3389483">,</span>&nbsp;<span class="ident" id="3389485">errors</span><span class="op" id="3389491">.</span><span class="ident" id="3389492">New</span><span class="op" id="3389495">(</span><span class="string" id="3389496">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3389511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389521">r</span><span class="op" id="3389522">.</span><span class="ident" id="3389523">start</span>&nbsp;<span class="op" id="3389529">=</span>&nbsp;<span class="ident" id="3389531">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389536">if</span>&nbsp;<span class="ident" id="3389539">end</span>&nbsp;<span class="op" id="3389543">==</span>&nbsp;<span class="string" id="3389546">&#34;&#34;</span>&nbsp;<span class="op" id="3389549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389555">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389620">r</span><span class="op" id="3389621">.</span><span class="ident" id="3389622">length</span>&nbsp;<span class="op" id="3389629">=</span>&nbsp;<span class="ident" id="3389631">size</span>&nbsp;<span class="op" id="3389636">-</span>&nbsp;<span class="ident" id="3389638">r</span><span class="op" id="3389639">.</span><span class="ident" id="3389640">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389649">}</span>&nbsp;<span class="keyword" id="3389651">else</span>&nbsp;<span class="op" id="3389656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389662">i</span><span class="op" id="3389663">,</span>&nbsp;<span class="ident" id="3389665">err</span>&nbsp;<span class="op" id="3389669">:=</span>&nbsp;<span class="ident" id="3389672">strconv</span><span class="op" id="3389679">.</span><span class="ident" id="3389680">ParseInt</span><span class="op" id="3389688">(</span><span class="ident" id="3389689">end</span><span class="op" id="3389692">,</span>&nbsp;<span class="num" id="3389694">10</span><span class="op" id="3389696">,</span>&nbsp;<span class="num" id="3389698">64</span><span class="op" id="3389700">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389706">if</span>&nbsp;<span class="ident" id="3389709">err</span>&nbsp;<span class="op" id="3389713">!=</span>&nbsp;<span class="ident" id="3389716">nil</span>&nbsp;<span class="op" id="3389720">||</span>&nbsp;<span class="ident" id="3389723">r</span><span class="op" id="3389724">.</span><span class="ident" id="3389725">start</span>&nbsp;<span class="op" id="3389731">&gt;</span>&nbsp;<span class="ident" id="3389733">i</span>&nbsp;<span class="op" id="3389735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389742">return</span>&nbsp;<span class="ident" id="3389749">nil</span><span class="op" id="3389752">,</span>&nbsp;<span class="ident" id="3389754">errors</span><span class="op" id="3389760">.</span><span class="ident" id="3389761">New</span><span class="op" id="3389764">(</span><span class="string" id="3389765">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3389780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389792">if</span>&nbsp;<span class="ident" id="3389795">i</span>&nbsp;<span class="op" id="3389797">&gt;=</span>&nbsp;<span class="ident" id="3389800">size</span>&nbsp;<span class="op" id="3389805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389812">i</span>&nbsp;<span class="op" id="3389814">=</span>&nbsp;<span class="ident" id="3389816">size</span>&nbsp;<span class="op" id="3389821">-</span>&nbsp;<span class="num" id="3389823">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389835">r</span><span class="op" id="3389836">.</span><span class="ident" id="3389837">length</span>&nbsp;<span class="op" id="3389844">=</span>&nbsp;<span class="ident" id="3389846">i</span>&nbsp;<span class="op" id="3389848">-</span>&nbsp;<span class="ident" id="3389850">r</span><span class="op" id="3389851">.</span><span class="ident" id="3389852">start</span>&nbsp;<span class="op" id="3389858">+</span>&nbsp;<span class="num" id="3389860">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389873">ranges</span>&nbsp;<span class="op" id="3389880">=</span>&nbsp;<span class="builtinfunc" id="3389882">append</span><span class="op" id="3389888">(</span><span class="ident" id="3389889">ranges</span><span class="op" id="3389895">,</span>&nbsp;<span class="ident" id="3389897">r</span><span class="op" id="3389898">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389904">return</span>&nbsp;<span class="ident" id="3389911">ranges</span><span class="op" id="3389917">,</span>&nbsp;<span class="ident" id="3389919">nil</span><br>
<span class="lineno"></span><span class="op" id="3389923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3389926">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="3389991">type</span>&nbsp;<span class="ident" id="3389996">countingWriter</span>&nbsp;<span class="ident" id="3390011">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3390018">func</span>&nbsp;<span class="op" id="3390023">(</span><span class="ident" id="3390024">w</span>&nbsp;<span class="op" id="3390026">*</span><span class="ident" id="3390027">countingWriter</span><span class="op" id="3390041">)</span>&nbsp;<span class="ident" id="3390043">Write</span><span class="op" id="3390048">(</span><span class="ident" id="3390049">p</span>&nbsp;<span class="op" id="3390051">[</span><span class="op" id="3390052">]</span><span class="builtintype" id="3390053">byte</span><span class="op" id="3390057">)</span>&nbsp;<span class="op" id="3390059">(</span><span class="ident" id="3390060">n</span>&nbsp;<span class="builtintype" id="3390062">int</span><span class="op" id="3390065">,</span>&nbsp;<span class="ident" id="3390067">err</span>&nbsp;<span class="builtintype" id="3390071">error</span><span class="op" id="3390076">)</span>&nbsp;<span class="op" id="3390078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390081">*</span><span class="ident" id="3390082">w</span>&nbsp;<span class="op" id="3390084">+=</span>&nbsp;<span class="ident" id="3390087">countingWriter</span><span class="op" id="3390101">(</span><span class="builtinfunc" id="3390102">len</span><span class="op" id="3390105">(</span><span class="ident" id="3390106">p</span><span class="op" id="3390107">)</span><span class="op" id="3390108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390111">return</span>&nbsp;<span class="builtinfunc" id="3390118">len</span><span class="op" id="3390121">(</span><span class="ident" id="3390122">p</span><span class="op" id="3390123">)</span><span class="op" id="3390124">,</span>&nbsp;<span class="ident" id="3390126">nil</span><br>
<span class="lineno">535</span><span class="op" id="3390130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3390133">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3390202">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3390246">func</span>&nbsp;<span class="ident" id="3390251">rangesMIMESize</span><span class="op" id="3390265">(</span><span class="ident" id="3390266">ranges</span>&nbsp;<span class="op" id="3390273">[</span><span class="op" id="3390274">]</span><span class="ident" id="3390275">httpRange</span><span class="op" id="3390284">,</span>&nbsp;<span class="ident" id="3390286">contentType</span>&nbsp;<span class="builtintype" id="3390298">string</span><span class="op" id="3390304">,</span>&nbsp;<span class="ident" id="3390306">contentSize</span>&nbsp;<span class="ident" id="3390318">int64</span><span class="op" id="3390323">)</span>&nbsp;<span class="op" id="3390325">(</span><span class="ident" id="3390326">encSize</span>&nbsp;<span class="ident" id="3390334">int64</span><span class="op" id="3390339">)</span>&nbsp;<span class="op" id="3390341">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390344">var</span>&nbsp;<span class="ident" id="3390348">w</span>&nbsp;<span class="ident" id="3390350">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390366">mw</span>&nbsp;<span class="op" id="3390369">:=</span>&nbsp;<span class="ident" id="3390372">multipart</span><span class="op" id="3390381">.</span><span class="ident" id="3390382">NewWriter</span><span class="op" id="3390391">(</span><span class="op" id="3390392">&amp;</span><span class="ident" id="3390393">w</span><span class="op" id="3390394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390397">for</span>&nbsp;<span class="ident" id="3390401">_</span><span class="op" id="3390402">,</span>&nbsp;<span class="ident" id="3390404">ra</span>&nbsp;<span class="op" id="3390407">:=</span>&nbsp;<span class="keyword" id="3390410">range</span>&nbsp;<span class="ident" id="3390416">ranges</span>&nbsp;<span class="op" id="3390423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390427">mw</span><span class="op" id="3390429">.</span><span class="ident" id="3390430">CreatePart</span><span class="op" id="3390440">(</span><span class="ident" id="3390441">ra</span><span class="op" id="3390443">.</span><span class="ident" id="3390444">mimeHeader</span><span class="op" id="3390454">(</span><span class="ident" id="3390455">contentType</span><span class="op" id="3390466">,</span>&nbsp;<span class="ident" id="3390468">contentSize</span><span class="op" id="3390479">)</span><span class="op" id="3390480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390484">encSize</span>&nbsp;<span class="op" id="3390492">+=</span>&nbsp;<span class="ident" id="3390495">ra</span><span class="op" id="3390497">.</span><span class="ident" id="3390498">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390509">mw</span><span class="op" id="3390511">.</span><span class="ident" id="3390512">Close</span><span class="op" id="3390517">(</span><span class="op" id="3390518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390521">encSize</span>&nbsp;<span class="op" id="3390529">+=</span>&nbsp;<span class="ident" id="3390532">int64</span><span class="op" id="3390537">(</span><span class="ident" id="3390538">w</span><span class="op" id="3390539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390542">return</span><br>
<span class="lineno"></span><span class="op" id="3390549">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="3390552">func</span>&nbsp;<span class="ident" id="3390557">sumRangesSize</span><span class="op" id="3390570">(</span><span class="ident" id="3390571">ranges</span>&nbsp;<span class="op" id="3390578">[</span><span class="op" id="3390579">]</span><span class="ident" id="3390580">httpRange</span><span class="op" id="3390589">)</span>&nbsp;<span class="op" id="3390591">(</span><span class="ident" id="3390592">size</span>&nbsp;<span class="ident" id="3390597">int64</span><span class="op" id="3390602">)</span>&nbsp;<span class="op" id="3390604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390607">for</span>&nbsp;<span class="ident" id="3390611">_</span><span class="op" id="3390612">,</span>&nbsp;<span class="ident" id="3390614">ra</span>&nbsp;<span class="op" id="3390617">:=</span>&nbsp;<span class="keyword" id="3390620">range</span>&nbsp;<span class="ident" id="3390626">ranges</span>&nbsp;<span class="op" id="3390633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390637">size</span>&nbsp;<span class="op" id="3390642">+=</span>&nbsp;<span class="ident" id="3390645">ra</span><span class="op" id="3390647">.</span><span class="ident" id="3390648">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390656">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390659">return</span><br>
<span class="lineno"></span><span class="op" id="3390666">}</span>
</div>
</body>
</html>
