<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6403331">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6403386">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6403440">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6403491">package</span>&nbsp;<span class="ident" id="6403499">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403509">import</span>&nbsp;<span class="op" id="6403516">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403519">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403528">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403538">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403544">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403551">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403563">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6403580">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6403587">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403590">var</span>&nbsp;<span class="op" id="6403594">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403597">ErrPersistEOF</span>&nbsp;<span class="op" id="6403611">=</span>&nbsp;<span class="op" id="6403613">&amp;</span><span class="ident" id="6403614">http</span><span class="op" id="6403618">.</span><span class="ident" id="6403619">ProtocolError</span><span class="op" id="6403632">{</span><span class="ident" id="6403633">ErrorString</span><span class="op" id="6403644">:</span>&nbsp;<span class="string" id="6403646">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6403676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403679">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403693">=</span>&nbsp;<span class="op" id="6403695">&amp;</span><span class="ident" id="6403696">http</span><span class="op" id="6403700">.</span><span class="ident" id="6403701">ProtocolError</span><span class="op" id="6403714">{</span><span class="ident" id="6403715">ErrorString</span><span class="op" id="6403726">:</span>&nbsp;<span class="string" id="6403728">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6403755">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403758">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6403772">=</span>&nbsp;<span class="op" id="6403774">&amp;</span><span class="ident" id="6403775">http</span><span class="op" id="6403779">.</span><span class="ident" id="6403780">ProtocolError</span><span class="op" id="6403793">{</span><span class="ident" id="6403794">ErrorString</span><span class="op" id="6403805">:</span>&nbsp;<span class="string" id="6403807">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6403823">}</span><br>
<span class="lineno"></span><span class="op" id="6403825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6403828">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6403886">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6403951">var</span>&nbsp;<span class="ident" id="6403955">errClosed</span>&nbsp;<span class="op" id="6403965">=</span>&nbsp;<span class="ident" id="6403967">errors</span><span class="op" id="6403973">.</span><span class="ident" id="6403974">New</span><span class="op" id="6403977">(</span><span class="string" id="6403978">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6404014">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6404017">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6404087">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6404161">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6404230">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6404305">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6404380">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6404414">//</span><br>
<span class="lineno"></span><span class="comment" id="6404417">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6404492">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6404520">type</span>&nbsp;<span class="ident" id="6404525">ServerConn</span>&nbsp;<span class="keyword" id="6404536">struct</span>&nbsp;<span class="op" id="6404543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404546">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404562">sync</span><span class="op" id="6404566">.</span><span class="ident" id="6404567">Mutex</span>&nbsp;<span class="comment" id="6404573">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404618">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404634">net</span><span class="op" id="6404637">.</span><span class="ident" id="6404638">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404644">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404660">*</span><span class="ident" id="6404661">bufio</span><span class="op" id="6404666">.</span><span class="ident" id="6404667">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404675">re</span><span class="op" id="6404677">,</span>&nbsp;<span class="ident" id="6404679">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6404691">error</span>&nbsp;<span class="comment" id="6404697">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404719">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404735">io</span><span class="op" id="6404737">.</span><span class="ident" id="6404738">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404750">nread</span><span class="op" id="6404755">,</span>&nbsp;<span class="ident" id="6404757">nwritten</span>&nbsp;<span class="builtintype" id="6404766">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404771">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404787">map</span><span class="op" id="6404790">[</span><span class="op" id="6404791">*</span><span class="ident" id="6404792">http</span><span class="op" id="6404796">.</span><span class="ident" id="6404797">Request</span><span class="op" id="6404804">]</span><span class="builtintype" id="6404805">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404812">pipe</span>&nbsp;<span class="ident" id="6404817">textproto</span><span class="op" id="6404826">.</span><span class="ident" id="6404827">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6404836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6404839">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6404916">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6404964">//</span><br>
<span class="lineno"></span><span class="comment" id="6404967">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6405042">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6405070">func</span>&nbsp;<span class="ident" id="6405075">NewServerConn</span><span class="op" id="6405088">(</span><span class="ident" id="6405089">c</span>&nbsp;<span class="ident" id="6405091">net</span><span class="op" id="6405094">.</span><span class="ident" id="6405095">Conn</span><span class="op" id="6405099">,</span>&nbsp;<span class="ident" id="6405101">r</span>&nbsp;<span class="op" id="6405103">*</span><span class="ident" id="6405104">bufio</span><span class="op" id="6405109">.</span><span class="ident" id="6405110">Reader</span><span class="op" id="6405116">)</span>&nbsp;<span class="op" id="6405118">*</span><span class="ident" id="6405119">ServerConn</span>&nbsp;<span class="op" id="6405130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405133">if</span>&nbsp;<span class="ident" id="6405136">r</span>&nbsp;<span class="op" id="6405138">==</span>&nbsp;<span class="ident" id="6405141">nil</span>&nbsp;<span class="op" id="6405145">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405149">r</span>&nbsp;<span class="op" id="6405151">=</span>&nbsp;<span class="ident" id="6405153">bufio</span><span class="op" id="6405158">.</span><span class="ident" id="6405159">NewReader</span><span class="op" id="6405168">(</span><span class="ident" id="6405169">c</span><span class="op" id="6405170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405176">return</span>&nbsp;<span class="op" id="6405183">&amp;</span><span class="ident" id="6405184">ServerConn</span><span class="op" id="6405194">{</span><span class="ident" id="6405195">c</span><span class="op" id="6405196">:</span>&nbsp;<span class="ident" id="6405198">c</span><span class="op" id="6405199">,</span>&nbsp;<span class="ident" id="6405201">r</span><span class="op" id="6405202">:</span>&nbsp;<span class="ident" id="6405204">r</span><span class="op" id="6405205">,</span>&nbsp;<span class="ident" id="6405207">pipereq</span><span class="op" id="6405214">:</span>&nbsp;<span class="builtinfunc" id="6405216">make</span><span class="op" id="6405220">(</span><span class="keyword" id="6405221">map</span><span class="op" id="6405224">[</span><span class="op" id="6405225">*</span><span class="ident" id="6405226">http</span><span class="op" id="6405230">.</span><span class="ident" id="6405231">Request</span><span class="op" id="6405238">]</span><span class="builtintype" id="6405239">uint</span><span class="op" id="6405243">)</span><span class="op" id="6405244">}</span><br>
<span class="lineno"></span><span class="op" id="6405246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6405249">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6405329">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6405405">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6405482">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6405544">func</span>&nbsp;<span class="op" id="6405549">(</span><span class="ident" id="6405550">sc</span>&nbsp;<span class="op" id="6405553">*</span><span class="ident" id="6405554">ServerConn</span><span class="op" id="6405564">)</span>&nbsp;<span class="ident" id="6405566">Hijack</span><span class="op" id="6405572">(</span><span class="op" id="6405573">)</span>&nbsp;<span class="op" id="6405575">(</span><span class="ident" id="6405576">c</span>&nbsp;<span class="ident" id="6405578">net</span><span class="op" id="6405581">.</span><span class="ident" id="6405582">Conn</span><span class="op" id="6405586">,</span>&nbsp;<span class="ident" id="6405588">r</span>&nbsp;<span class="op" id="6405590">*</span><span class="ident" id="6405591">bufio</span><span class="op" id="6405596">.</span><span class="ident" id="6405597">Reader</span><span class="op" id="6405603">)</span>&nbsp;<span class="op" id="6405605">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405608">sc</span><span class="op" id="6405610">.</span><span class="ident" id="6405611">lk</span><span class="op" id="6405613">.</span><span class="ident" id="6405614">Lock</span><span class="op" id="6405618">(</span><span class="op" id="6405619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405622">defer</span>&nbsp;<span class="ident" id="6405628">sc</span><span class="op" id="6405630">.</span><span class="ident" id="6405631">lk</span><span class="op" id="6405633">.</span><span class="ident" id="6405634">Unlock</span><span class="op" id="6405640">(</span><span class="op" id="6405641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405644">c</span>&nbsp;<span class="op" id="6405646">=</span>&nbsp;<span class="ident" id="6405648">sc</span><span class="op" id="6405650">.</span><span class="ident" id="6405651">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405654">r</span>&nbsp;<span class="op" id="6405656">=</span>&nbsp;<span class="ident" id="6405658">sc</span><span class="op" id="6405660">.</span><span class="ident" id="6405661">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405664">sc</span><span class="op" id="6405666">.</span><span class="ident" id="6405667">c</span>&nbsp;<span class="op" id="6405669">=</span>&nbsp;<span class="ident" id="6405671">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405676">sc</span><span class="op" id="6405678">.</span><span class="ident" id="6405679">r</span>&nbsp;<span class="op" id="6405681">=</span>&nbsp;<span class="ident" id="6405683">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405688">return</span><br>
<span class="lineno"></span><span class="op" id="6405695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6405698">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6405767">func</span>&nbsp;<span class="op" id="6405772">(</span><span class="ident" id="6405773">sc</span>&nbsp;<span class="op" id="6405776">*</span><span class="ident" id="6405777">ServerConn</span><span class="op" id="6405787">)</span>&nbsp;<span class="ident" id="6405789">Close</span><span class="op" id="6405794">(</span><span class="op" id="6405795">)</span>&nbsp;<span class="builtintype" id="6405797">error</span>&nbsp;<span class="op" id="6405803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405806">c</span><span class="op" id="6405807">,</span>&nbsp;<span class="ident" id="6405809">_</span>&nbsp;<span class="op" id="6405811">:=</span>&nbsp;<span class="ident" id="6405814">sc</span><span class="op" id="6405816">.</span><span class="ident" id="6405817">Hijack</span><span class="op" id="6405823">(</span><span class="op" id="6405824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405827">if</span>&nbsp;<span class="ident" id="6405830">c</span>&nbsp;<span class="op" id="6405832">!=</span>&nbsp;<span class="ident" id="6405835">nil</span>&nbsp;<span class="op" id="6405839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405843">return</span>&nbsp;<span class="ident" id="6405850">c</span><span class="op" id="6405851">.</span><span class="ident" id="6405852">Close</span><span class="op" id="6405857">(</span><span class="op" id="6405858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405861">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405864">return</span>&nbsp;<span class="ident" id="6405871">nil</span><br>
<span class="lineno"></span><span class="op" id="6405875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6405878">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6405956">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6406035">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6406112">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6406137">func</span>&nbsp;<span class="op" id="6406142">(</span><span class="ident" id="6406143">sc</span>&nbsp;<span class="op" id="6406146">*</span><span class="ident" id="6406147">ServerConn</span><span class="op" id="6406157">)</span>&nbsp;<span class="ident" id="6406159">Read</span><span class="op" id="6406163">(</span><span class="op" id="6406164">)</span>&nbsp;<span class="op" id="6406166">(</span><span class="ident" id="6406167">req</span>&nbsp;<span class="op" id="6406171">*</span><span class="ident" id="6406172">http</span><span class="op" id="6406176">.</span><span class="ident" id="6406177">Request</span><span class="op" id="6406184">,</span>&nbsp;<span class="ident" id="6406186">err</span>&nbsp;<span class="builtintype" id="6406190">error</span><span class="op" id="6406195">)</span>&nbsp;<span class="op" id="6406197">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6406201">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406250">id</span>&nbsp;<span class="op" id="6406253">:=</span>&nbsp;<span class="ident" id="6406256">sc</span><span class="op" id="6406258">.</span><span class="ident" id="6406259">pipe</span><span class="op" id="6406263">.</span><span class="ident" id="6406264">Next</span><span class="op" id="6406268">(</span><span class="op" id="6406269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406272">sc</span><span class="op" id="6406274">.</span><span class="ident" id="6406275">pipe</span><span class="op" id="6406279">.</span><span class="ident" id="6406280">StartRequest</span><span class="op" id="6406292">(</span><span class="ident" id="6406293">id</span><span class="op" id="6406295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406298">defer</span>&nbsp;<span class="keyword" id="6406304">func</span><span class="op" id="6406308">(</span><span class="op" id="6406309">)</span>&nbsp;<span class="op" id="6406311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406315">sc</span><span class="op" id="6406317">.</span><span class="ident" id="6406318">pipe</span><span class="op" id="6406322">.</span><span class="ident" id="6406323">EndRequest</span><span class="op" id="6406333">(</span><span class="ident" id="6406334">id</span><span class="op" id="6406336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406340">if</span>&nbsp;<span class="ident" id="6406343">req</span>&nbsp;<span class="op" id="6406347">==</span>&nbsp;<span class="ident" id="6406350">nil</span>&nbsp;<span class="op" id="6406354">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406359">sc</span><span class="op" id="6406361">.</span><span class="ident" id="6406362">pipe</span><span class="op" id="6406366">.</span><span class="ident" id="6406367">StartResponse</span><span class="op" id="6406380">(</span><span class="ident" id="6406381">id</span><span class="op" id="6406383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406388">sc</span><span class="op" id="6406390">.</span><span class="ident" id="6406391">pipe</span><span class="op" id="6406395">.</span><span class="ident" id="6406396">EndResponse</span><span class="op" id="6406407">(</span><span class="ident" id="6406408">id</span><span class="op" id="6406410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406414">}</span>&nbsp;<span class="keyword" id="6406416">else</span>&nbsp;<span class="op" id="6406421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6406426">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406473">sc</span><span class="op" id="6406475">.</span><span class="ident" id="6406476">lk</span><span class="op" id="6406478">.</span><span class="ident" id="6406479">Lock</span><span class="op" id="6406483">(</span><span class="op" id="6406484">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406489">sc</span><span class="op" id="6406491">.</span><span class="ident" id="6406492">pipereq</span><span class="op" id="6406499">[</span><span class="ident" id="6406500">req</span><span class="op" id="6406503">]</span>&nbsp;<span class="op" id="6406505">=</span>&nbsp;<span class="ident" id="6406507">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406513">sc</span><span class="op" id="6406515">.</span><span class="ident" id="6406516">lk</span><span class="op" id="6406518">.</span><span class="ident" id="6406519">Unlock</span><span class="op" id="6406525">(</span><span class="op" id="6406526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406533">}</span><span class="op" id="6406534">(</span><span class="op" id="6406535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406539">sc</span><span class="op" id="6406541">.</span><span class="ident" id="6406542">lk</span><span class="op" id="6406544">.</span><span class="ident" id="6406545">Lock</span><span class="op" id="6406549">(</span><span class="op" id="6406550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406553">if</span>&nbsp;<span class="ident" id="6406556">sc</span><span class="op" id="6406558">.</span><span class="ident" id="6406559">we</span>&nbsp;<span class="op" id="6406562">!=</span>&nbsp;<span class="ident" id="6406565">nil</span>&nbsp;<span class="op" id="6406569">{</span>&nbsp;<span class="comment" id="6406571">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406626">defer</span>&nbsp;<span class="ident" id="6406632">sc</span><span class="op" id="6406634">.</span><span class="ident" id="6406635">lk</span><span class="op" id="6406637">.</span><span class="ident" id="6406638">Unlock</span><span class="op" id="6406644">(</span><span class="op" id="6406645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406649">return</span>&nbsp;<span class="ident" id="6406656">nil</span><span class="op" id="6406659">,</span>&nbsp;<span class="ident" id="6406661">sc</span><span class="op" id="6406663">.</span><span class="ident" id="6406664">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406668">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406671">if</span>&nbsp;<span class="ident" id="6406674">sc</span><span class="op" id="6406676">.</span><span class="ident" id="6406677">re</span>&nbsp;<span class="op" id="6406680">!=</span>&nbsp;<span class="ident" id="6406683">nil</span>&nbsp;<span class="op" id="6406687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406691">defer</span>&nbsp;<span class="ident" id="6406697">sc</span><span class="op" id="6406699">.</span><span class="ident" id="6406700">lk</span><span class="op" id="6406702">.</span><span class="ident" id="6406703">Unlock</span><span class="op" id="6406709">(</span><span class="op" id="6406710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406714">return</span>&nbsp;<span class="ident" id="6406721">nil</span><span class="op" id="6406724">,</span>&nbsp;<span class="ident" id="6406726">sc</span><span class="op" id="6406728">.</span><span class="ident" id="6406729">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406736">if</span>&nbsp;<span class="ident" id="6406739">sc</span><span class="op" id="6406741">.</span><span class="ident" id="6406742">r</span>&nbsp;<span class="op" id="6406744">==</span>&nbsp;<span class="ident" id="6406747">nil</span>&nbsp;<span class="op" id="6406751">{</span>&nbsp;<span class="comment" id="6406753">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406800">defer</span>&nbsp;<span class="ident" id="6406806">sc</span><span class="op" id="6406808">.</span><span class="ident" id="6406809">lk</span><span class="op" id="6406811">.</span><span class="ident" id="6406812">Unlock</span><span class="op" id="6406818">(</span><span class="op" id="6406819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406823">return</span>&nbsp;<span class="ident" id="6406830">nil</span><span class="op" id="6406833">,</span>&nbsp;<span class="ident" id="6406835">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406849">r</span>&nbsp;<span class="op" id="6406851">:=</span>&nbsp;<span class="ident" id="6406854">sc</span><span class="op" id="6406856">.</span><span class="ident" id="6406857">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406860">lastbody</span>&nbsp;<span class="op" id="6406869">:=</span>&nbsp;<span class="ident" id="6406872">sc</span><span class="op" id="6406874">.</span><span class="ident" id="6406875">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406885">sc</span><span class="op" id="6406887">.</span><span class="ident" id="6406888">lastbody</span>&nbsp;<span class="op" id="6406897">=</span>&nbsp;<span class="ident" id="6406899">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406904">sc</span><span class="op" id="6406906">.</span><span class="ident" id="6406907">lk</span><span class="op" id="6406909">.</span><span class="ident" id="6406910">Unlock</span><span class="op" id="6406916">(</span><span class="op" id="6406917">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6406921">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406997">if</span>&nbsp;<span class="ident" id="6407000">lastbody</span>&nbsp;<span class="op" id="6407009">!=</span>&nbsp;<span class="ident" id="6407012">nil</span>&nbsp;<span class="op" id="6407016">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407020">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407086">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407144">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407159">err</span>&nbsp;<span class="op" id="6407163">=</span>&nbsp;<span class="ident" id="6407165">lastbody</span><span class="op" id="6407173">.</span><span class="ident" id="6407174">Close</span><span class="op" id="6407179">(</span><span class="op" id="6407180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407184">if</span>&nbsp;<span class="ident" id="6407187">err</span>&nbsp;<span class="op" id="6407191">!=</span>&nbsp;<span class="ident" id="6407194">nil</span>&nbsp;<span class="op" id="6407198">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407203">sc</span><span class="op" id="6407205">.</span><span class="ident" id="6407206">lk</span><span class="op" id="6407208">.</span><span class="ident" id="6407209">Lock</span><span class="op" id="6407213">(</span><span class="op" id="6407214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407219">defer</span>&nbsp;<span class="ident" id="6407225">sc</span><span class="op" id="6407227">.</span><span class="ident" id="6407228">lk</span><span class="op" id="6407230">.</span><span class="ident" id="6407231">Unlock</span><span class="op" id="6407237">(</span><span class="op" id="6407238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407243">sc</span><span class="op" id="6407245">.</span><span class="ident" id="6407246">re</span>&nbsp;<span class="op" id="6407249">=</span>&nbsp;<span class="ident" id="6407251">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407258">return</span>&nbsp;<span class="ident" id="6407265">nil</span><span class="op" id="6407268">,</span>&nbsp;<span class="ident" id="6407270">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407276">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407283">req</span><span class="op" id="6407286">,</span>&nbsp;<span class="ident" id="6407288">err</span>&nbsp;<span class="op" id="6407292">=</span>&nbsp;<span class="ident" id="6407294">http</span><span class="op" id="6407298">.</span><span class="ident" id="6407299">ReadRequest</span><span class="op" id="6407310">(</span><span class="ident" id="6407311">r</span><span class="op" id="6407312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407315">sc</span><span class="op" id="6407317">.</span><span class="ident" id="6407318">lk</span><span class="op" id="6407320">.</span><span class="ident" id="6407321">Lock</span><span class="op" id="6407325">(</span><span class="op" id="6407326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407329">defer</span>&nbsp;<span class="ident" id="6407335">sc</span><span class="op" id="6407337">.</span><span class="ident" id="6407338">lk</span><span class="op" id="6407340">.</span><span class="ident" id="6407341">Unlock</span><span class="op" id="6407347">(</span><span class="op" id="6407348">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407351">if</span>&nbsp;<span class="ident" id="6407354">err</span>&nbsp;<span class="op" id="6407358">!=</span>&nbsp;<span class="ident" id="6407361">nil</span>&nbsp;<span class="op" id="6407365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407369">if</span>&nbsp;<span class="ident" id="6407372">err</span>&nbsp;<span class="op" id="6407376">==</span>&nbsp;<span class="ident" id="6407379">io</span><span class="op" id="6407381">.</span><span class="ident" id="6407382">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6407399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407404">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407459">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407517">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407546">sc</span><span class="op" id="6407548">.</span><span class="ident" id="6407549">re</span>&nbsp;<span class="op" id="6407552">=</span>&nbsp;<span class="ident" id="6407554">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407571">return</span>&nbsp;<span class="ident" id="6407578">nil</span><span class="op" id="6407581">,</span>&nbsp;<span class="ident" id="6407583">sc</span><span class="op" id="6407585">.</span><span class="ident" id="6407586">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407591">}</span>&nbsp;<span class="keyword" id="6407593">else</span>&nbsp;<span class="op" id="6407598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407603">sc</span><span class="op" id="6407605">.</span><span class="ident" id="6407606">re</span>&nbsp;<span class="op" id="6407609">=</span>&nbsp;<span class="ident" id="6407611">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407618">return</span>&nbsp;<span class="ident" id="6407625">req</span><span class="op" id="6407628">,</span>&nbsp;<span class="ident" id="6407630">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407642">sc</span><span class="op" id="6407644">.</span><span class="ident" id="6407645">lastbody</span>&nbsp;<span class="op" id="6407654">=</span>&nbsp;<span class="ident" id="6407656">req</span><span class="op" id="6407659">.</span><span class="ident" id="6407660">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407666">sc</span><span class="op" id="6407668">.</span><span class="ident" id="6407669">nread</span><span class="op" id="6407674">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407678">if</span>&nbsp;<span class="ident" id="6407681">req</span><span class="op" id="6407684">.</span><span class="ident" id="6407685">Close</span>&nbsp;<span class="op" id="6407691">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407695">sc</span><span class="op" id="6407697">.</span><span class="ident" id="6407698">re</span>&nbsp;<span class="op" id="6407701">=</span>&nbsp;<span class="ident" id="6407703">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407719">return</span>&nbsp;<span class="ident" id="6407726">req</span><span class="op" id="6407729">,</span>&nbsp;<span class="ident" id="6407731">sc</span><span class="op" id="6407733">.</span><span class="ident" id="6407734">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407741">return</span>&nbsp;<span class="ident" id="6407748">req</span><span class="op" id="6407751">,</span>&nbsp;<span class="ident" id="6407753">err</span><br>
<span class="lineno"></span><span class="op" id="6407757">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6407760">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6407813">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6407859">func</span>&nbsp;<span class="op" id="6407864">(</span><span class="ident" id="6407865">sc</span>&nbsp;<span class="op" id="6407868">*</span><span class="ident" id="6407869">ServerConn</span><span class="op" id="6407879">)</span>&nbsp;<span class="ident" id="6407881">Pending</span><span class="op" id="6407888">(</span><span class="op" id="6407889">)</span>&nbsp;<span class="builtintype" id="6407891">int</span>&nbsp;<span class="op" id="6407895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407898">sc</span><span class="op" id="6407900">.</span><span class="ident" id="6407901">lk</span><span class="op" id="6407903">.</span><span class="ident" id="6407904">Lock</span><span class="op" id="6407908">(</span><span class="op" id="6407909">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407912">defer</span>&nbsp;<span class="ident" id="6407918">sc</span><span class="op" id="6407920">.</span><span class="ident" id="6407921">lk</span><span class="op" id="6407923">.</span><span class="ident" id="6407924">Unlock</span><span class="op" id="6407930">(</span><span class="op" id="6407931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407934">return</span>&nbsp;<span class="ident" id="6407941">sc</span><span class="op" id="6407943">.</span><span class="ident" id="6407944">nread</span>&nbsp;<span class="op" id="6407950">-</span>&nbsp;<span class="ident" id="6407952">sc</span><span class="op" id="6407954">.</span><span class="ident" id="6407955">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6407964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6407967">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6408052">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6408130">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6408206">func</span>&nbsp;<span class="op" id="6408211">(</span><span class="ident" id="6408212">sc</span>&nbsp;<span class="op" id="6408215">*</span><span class="ident" id="6408216">ServerConn</span><span class="op" id="6408226">)</span>&nbsp;<span class="ident" id="6408228">Write</span><span class="op" id="6408233">(</span><span class="ident" id="6408234">req</span>&nbsp;<span class="op" id="6408238">*</span><span class="ident" id="6408239">http</span><span class="op" id="6408243">.</span><span class="ident" id="6408244">Request</span><span class="op" id="6408251">,</span>&nbsp;<span class="ident" id="6408253">resp</span>&nbsp;<span class="op" id="6408258">*</span><span class="ident" id="6408259">http</span><span class="op" id="6408263">.</span><span class="ident" id="6408264">Response</span><span class="op" id="6408272">)</span>&nbsp;<span class="builtintype" id="6408274">error</span>&nbsp;<span class="op" id="6408280">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408284">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408343">sc</span><span class="op" id="6408345">.</span><span class="ident" id="6408346">lk</span><span class="op" id="6408348">.</span><span class="ident" id="6408349">Lock</span><span class="op" id="6408353">(</span><span class="op" id="6408354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408357">id</span><span class="op" id="6408359">,</span>&nbsp;<span class="ident" id="6408361">ok</span>&nbsp;<span class="op" id="6408364">:=</span>&nbsp;<span class="ident" id="6408367">sc</span><span class="op" id="6408369">.</span><span class="ident" id="6408370">pipereq</span><span class="op" id="6408377">[</span><span class="ident" id="6408378">req</span><span class="op" id="6408381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6408384">delete</span><span class="op" id="6408390">(</span><span class="ident" id="6408391">sc</span><span class="op" id="6408393">.</span><span class="ident" id="6408394">pipereq</span><span class="op" id="6408401">,</span>&nbsp;<span class="ident" id="6408403">req</span><span class="op" id="6408406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408409">if</span>&nbsp;<span class="op" id="6408412">!</span><span class="ident" id="6408413">ok</span>&nbsp;<span class="op" id="6408416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408420">sc</span><span class="op" id="6408422">.</span><span class="ident" id="6408423">lk</span><span class="op" id="6408425">.</span><span class="ident" id="6408426">Unlock</span><span class="op" id="6408432">(</span><span class="op" id="6408433">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408437">return</span>&nbsp;<span class="ident" id="6408444">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408460">sc</span><span class="op" id="6408462">.</span><span class="ident" id="6408463">lk</span><span class="op" id="6408465">.</span><span class="ident" id="6408466">Unlock</span><span class="op" id="6408472">(</span><span class="op" id="6408473">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408477">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408503">sc</span><span class="op" id="6408505">.</span><span class="ident" id="6408506">pipe</span><span class="op" id="6408510">.</span><span class="ident" id="6408511">StartResponse</span><span class="op" id="6408524">(</span><span class="ident" id="6408525">id</span><span class="op" id="6408527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408530">defer</span>&nbsp;<span class="ident" id="6408536">sc</span><span class="op" id="6408538">.</span><span class="ident" id="6408539">pipe</span><span class="op" id="6408543">.</span><span class="ident" id="6408544">EndResponse</span><span class="op" id="6408555">(</span><span class="ident" id="6408556">id</span><span class="op" id="6408558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408562">sc</span><span class="op" id="6408564">.</span><span class="ident" id="6408565">lk</span><span class="op" id="6408567">.</span><span class="ident" id="6408568">Lock</span><span class="op" id="6408572">(</span><span class="op" id="6408573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408576">if</span>&nbsp;<span class="ident" id="6408579">sc</span><span class="op" id="6408581">.</span><span class="ident" id="6408582">we</span>&nbsp;<span class="op" id="6408585">!=</span>&nbsp;<span class="ident" id="6408588">nil</span>&nbsp;<span class="op" id="6408592">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408596">defer</span>&nbsp;<span class="ident" id="6408602">sc</span><span class="op" id="6408604">.</span><span class="ident" id="6408605">lk</span><span class="op" id="6408607">.</span><span class="ident" id="6408608">Unlock</span><span class="op" id="6408614">(</span><span class="op" id="6408615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408619">return</span>&nbsp;<span class="ident" id="6408626">sc</span><span class="op" id="6408628">.</span><span class="ident" id="6408629">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408636">if</span>&nbsp;<span class="ident" id="6408639">sc</span><span class="op" id="6408641">.</span><span class="ident" id="6408642">c</span>&nbsp;<span class="op" id="6408644">==</span>&nbsp;<span class="ident" id="6408647">nil</span>&nbsp;<span class="op" id="6408651">{</span>&nbsp;<span class="comment" id="6408653">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408700">defer</span>&nbsp;<span class="ident" id="6408706">sc</span><span class="op" id="6408708">.</span><span class="ident" id="6408709">lk</span><span class="op" id="6408711">.</span><span class="ident" id="6408712">Unlock</span><span class="op" id="6408718">(</span><span class="op" id="6408719">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408723">return</span>&nbsp;<span class="ident" id="6408730">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408744">c</span>&nbsp;<span class="op" id="6408746">:=</span>&nbsp;<span class="ident" id="6408749">sc</span><span class="op" id="6408751">.</span><span class="ident" id="6408752">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408755">if</span>&nbsp;<span class="ident" id="6408758">sc</span><span class="op" id="6408760">.</span><span class="ident" id="6408761">nread</span>&nbsp;<span class="op" id="6408767">&lt;=</span>&nbsp;<span class="ident" id="6408770">sc</span><span class="op" id="6408772">.</span><span class="ident" id="6408773">nwritten</span>&nbsp;<span class="op" id="6408782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408786">defer</span>&nbsp;<span class="ident" id="6408792">sc</span><span class="op" id="6408794">.</span><span class="ident" id="6408795">lk</span><span class="op" id="6408797">.</span><span class="ident" id="6408798">Unlock</span><span class="op" id="6408804">(</span><span class="op" id="6408805">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408809">return</span>&nbsp;<span class="ident" id="6408816">errors</span><span class="op" id="6408822">.</span><span class="ident" id="6408823">New</span><span class="op" id="6408826">(</span><span class="string" id="6408827">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6408854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408860">if</span>&nbsp;<span class="ident" id="6408863">resp</span><span class="op" id="6408867">.</span><span class="ident" id="6408868">Close</span>&nbsp;<span class="op" id="6408874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408878">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408940">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6409003">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409026">sc</span><span class="op" id="6409028">.</span><span class="ident" id="6409029">re</span>&nbsp;<span class="op" id="6409032">=</span>&nbsp;<span class="ident" id="6409034">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409052">sc</span><span class="op" id="6409054">.</span><span class="ident" id="6409055">lk</span><span class="op" id="6409057">.</span><span class="ident" id="6409058">Unlock</span><span class="op" id="6409064">(</span><span class="op" id="6409065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409069">err</span>&nbsp;<span class="op" id="6409073">:=</span>&nbsp;<span class="ident" id="6409076">resp</span><span class="op" id="6409080">.</span><span class="ident" id="6409081">Write</span><span class="op" id="6409086">(</span><span class="ident" id="6409087">c</span><span class="op" id="6409088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409091">sc</span><span class="op" id="6409093">.</span><span class="ident" id="6409094">lk</span><span class="op" id="6409096">.</span><span class="ident" id="6409097">Lock</span><span class="op" id="6409101">(</span><span class="op" id="6409102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409105">defer</span>&nbsp;<span class="ident" id="6409111">sc</span><span class="op" id="6409113">.</span><span class="ident" id="6409114">lk</span><span class="op" id="6409116">.</span><span class="ident" id="6409117">Unlock</span><span class="op" id="6409123">(</span><span class="op" id="6409124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409127">if</span>&nbsp;<span class="ident" id="6409130">err</span>&nbsp;<span class="op" id="6409134">!=</span>&nbsp;<span class="ident" id="6409137">nil</span>&nbsp;<span class="op" id="6409141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409145">sc</span><span class="op" id="6409147">.</span><span class="ident" id="6409148">we</span>&nbsp;<span class="op" id="6409151">=</span>&nbsp;<span class="ident" id="6409153">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409159">return</span>&nbsp;<span class="ident" id="6409166">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409174">sc</span><span class="op" id="6409176">.</span><span class="ident" id="6409177">nwritten</span><span class="op" id="6409185">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409190">return</span>&nbsp;<span class="ident" id="6409197">nil</span><br>
<span class="lineno">220</span><span class="op" id="6409201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6409204">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6409274">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6409343">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6409398">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6409472">//</span><br>
<span class="lineno"></span><span class="comment" id="6409475">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6409543">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6409591">type</span>&nbsp;<span class="ident" id="6409596">ClientConn</span>&nbsp;<span class="keyword" id="6409607">struct</span>&nbsp;<span class="op" id="6409614">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409617">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6409633">sync</span><span class="op" id="6409637">.</span><span class="ident" id="6409638">Mutex</span>&nbsp;<span class="comment" id="6409644">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409689">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6409705">net</span><span class="op" id="6409708">.</span><span class="ident" id="6409709">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409715">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6409731">*</span><span class="ident" id="6409732">bufio</span><span class="op" id="6409737">.</span><span class="ident" id="6409738">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409746">re</span><span class="op" id="6409748">,</span>&nbsp;<span class="ident" id="6409750">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6409762">error</span>&nbsp;<span class="comment" id="6409768">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409790">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6409806">io</span><span class="op" id="6409808">.</span><span class="ident" id="6409809">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409821">nread</span><span class="op" id="6409826">,</span>&nbsp;<span class="ident" id="6409828">nwritten</span>&nbsp;<span class="builtintype" id="6409837">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409842">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6409858">map</span><span class="op" id="6409861">[</span><span class="op" id="6409862">*</span><span class="ident" id="6409863">http</span><span class="op" id="6409867">.</span><span class="ident" id="6409868">Request</span><span class="op" id="6409875">]</span><span class="builtintype" id="6409876">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409883">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6409892">textproto</span><span class="op" id="6409901">.</span><span class="ident" id="6409902">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409912">writeReq</span>&nbsp;<span class="keyword" id="6409921">func</span><span class="op" id="6409925">(</span><span class="op" id="6409926">*</span><span class="ident" id="6409927">http</span><span class="op" id="6409931">.</span><span class="ident" id="6409932">Request</span><span class="op" id="6409939">,</span>&nbsp;<span class="ident" id="6409941">io</span><span class="op" id="6409943">.</span><span class="ident" id="6409944">Writer</span><span class="op" id="6409950">)</span>&nbsp;<span class="builtintype" id="6409952">error</span><br>
<span class="lineno">240</span><span class="op" id="6409958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6409961">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6410039">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6410087">//</span><br>
<span class="lineno">245</span><span class="comment" id="6410090">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6410160">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6410198">func</span>&nbsp;<span class="ident" id="6410203">NewClientConn</span><span class="op" id="6410216">(</span><span class="ident" id="6410217">c</span>&nbsp;<span class="ident" id="6410219">net</span><span class="op" id="6410222">.</span><span class="ident" id="6410223">Conn</span><span class="op" id="6410227">,</span>&nbsp;<span class="ident" id="6410229">r</span>&nbsp;<span class="op" id="6410231">*</span><span class="ident" id="6410232">bufio</span><span class="op" id="6410237">.</span><span class="ident" id="6410238">Reader</span><span class="op" id="6410244">)</span>&nbsp;<span class="op" id="6410246">*</span><span class="ident" id="6410247">ClientConn</span>&nbsp;<span class="op" id="6410258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6410261">if</span>&nbsp;<span class="ident" id="6410264">r</span>&nbsp;<span class="op" id="6410266">==</span>&nbsp;<span class="ident" id="6410269">nil</span>&nbsp;<span class="op" id="6410273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410277">r</span>&nbsp;<span class="op" id="6410279">=</span>&nbsp;<span class="ident" id="6410281">bufio</span><span class="op" id="6410286">.</span><span class="ident" id="6410287">NewReader</span><span class="op" id="6410296">(</span><span class="ident" id="6410297">c</span><span class="op" id="6410298">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6410301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6410304">return</span>&nbsp;<span class="op" id="6410311">&amp;</span><span class="ident" id="6410312">ClientConn</span><span class="op" id="6410322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410326">c</span><span class="op" id="6410327">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410336">c</span><span class="op" id="6410337">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410341">r</span><span class="op" id="6410342">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410351">r</span><span class="op" id="6410352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410356">pipereq</span><span class="op" id="6410363">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6410366">make</span><span class="op" id="6410370">(</span><span class="keyword" id="6410371">map</span><span class="op" id="6410374">[</span><span class="op" id="6410375">*</span><span class="ident" id="6410376">http</span><span class="op" id="6410380">.</span><span class="ident" id="6410381">Request</span><span class="op" id="6410388">]</span><span class="builtintype" id="6410389">uint</span><span class="op" id="6410393">)</span><span class="op" id="6410394">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410398">writeReq</span><span class="op" id="6410406">:</span>&nbsp;<span class="op" id="6410408">(</span><span class="op" id="6410409">*</span><span class="ident" id="6410410">http</span><span class="op" id="6410414">.</span><span class="ident" id="6410415">Request</span><span class="op" id="6410422">)</span><span class="op" id="6410423">.</span><span class="ident" id="6410424">Write</span><span class="op" id="6410429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6410432">}</span><br>
<span class="lineno"></span><span class="op" id="6410434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6410437">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6410504">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6410542">//</span><br>
<span class="lineno"></span><span class="comment" id="6410545">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6410606">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6410652">func</span>&nbsp;<span class="ident" id="6410657">NewProxyClientConn</span><span class="op" id="6410675">(</span><span class="ident" id="6410676">c</span>&nbsp;<span class="ident" id="6410678">net</span><span class="op" id="6410681">.</span><span class="ident" id="6410682">Conn</span><span class="op" id="6410686">,</span>&nbsp;<span class="ident" id="6410688">r</span>&nbsp;<span class="op" id="6410690">*</span><span class="ident" id="6410691">bufio</span><span class="op" id="6410696">.</span><span class="ident" id="6410697">Reader</span><span class="op" id="6410703">)</span>&nbsp;<span class="op" id="6410705">*</span><span class="ident" id="6410706">ClientConn</span>&nbsp;<span class="op" id="6410717">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410720">cc</span>&nbsp;<span class="op" id="6410723">:=</span>&nbsp;<span class="ident" id="6410726">NewClientConn</span><span class="op" id="6410739">(</span><span class="ident" id="6410740">c</span><span class="op" id="6410741">,</span>&nbsp;<span class="ident" id="6410743">r</span><span class="op" id="6410744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6410747">cc</span><span class="op" id="6410749">.</span><span class="ident" id="6410750">writeReq</span>&nbsp;<span class="op" id="6410759">=</span>&nbsp;<span class="op" id="6410761">(</span><span class="op" id="6410762">*</span><span class="ident" id="6410763">http</span><span class="op" id="6410767">.</span><span class="ident" id="6410768">Request</span><span class="op" id="6410775">)</span><span class="op" id="6410776">.</span><span class="ident" id="6410777">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6410789">return</span>&nbsp;<span class="ident" id="6410796">cc</span><br>
<span class="lineno"></span><span class="op" id="6410799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6410802">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6410882">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6410958">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6411032">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6411110">func</span>&nbsp;<span class="op" id="6411115">(</span><span class="ident" id="6411116">cc</span>&nbsp;<span class="op" id="6411119">*</span><span class="ident" id="6411120">ClientConn</span><span class="op" id="6411130">)</span>&nbsp;<span class="ident" id="6411132">Hijack</span><span class="op" id="6411138">(</span><span class="op" id="6411139">)</span>&nbsp;<span class="op" id="6411141">(</span><span class="ident" id="6411142">c</span>&nbsp;<span class="ident" id="6411144">net</span><span class="op" id="6411147">.</span><span class="ident" id="6411148">Conn</span><span class="op" id="6411152">,</span>&nbsp;<span class="ident" id="6411154">r</span>&nbsp;<span class="op" id="6411156">*</span><span class="ident" id="6411157">bufio</span><span class="op" id="6411162">.</span><span class="ident" id="6411163">Reader</span><span class="op" id="6411169">)</span>&nbsp;<span class="op" id="6411171">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411174">cc</span><span class="op" id="6411176">.</span><span class="ident" id="6411177">lk</span><span class="op" id="6411179">.</span><span class="ident" id="6411180">Lock</span><span class="op" id="6411184">(</span><span class="op" id="6411185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6411188">defer</span>&nbsp;<span class="ident" id="6411194">cc</span><span class="op" id="6411196">.</span><span class="ident" id="6411197">lk</span><span class="op" id="6411199">.</span><span class="ident" id="6411200">Unlock</span><span class="op" id="6411206">(</span><span class="op" id="6411207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411210">c</span>&nbsp;<span class="op" id="6411212">=</span>&nbsp;<span class="ident" id="6411214">cc</span><span class="op" id="6411216">.</span><span class="ident" id="6411217">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411220">r</span>&nbsp;<span class="op" id="6411222">=</span>&nbsp;<span class="ident" id="6411224">cc</span><span class="op" id="6411226">.</span><span class="ident" id="6411227">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411230">cc</span><span class="op" id="6411232">.</span><span class="ident" id="6411233">c</span>&nbsp;<span class="op" id="6411235">=</span>&nbsp;<span class="ident" id="6411237">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411242">cc</span><span class="op" id="6411244">.</span><span class="ident" id="6411245">r</span>&nbsp;<span class="op" id="6411247">=</span>&nbsp;<span class="ident" id="6411249">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6411254">return</span><br>
<span class="lineno"></span><span class="op" id="6411261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6411264">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6411333">func</span>&nbsp;<span class="op" id="6411338">(</span><span class="ident" id="6411339">cc</span>&nbsp;<span class="op" id="6411342">*</span><span class="ident" id="6411343">ClientConn</span><span class="op" id="6411353">)</span>&nbsp;<span class="ident" id="6411355">Close</span><span class="op" id="6411360">(</span><span class="op" id="6411361">)</span>&nbsp;<span class="builtintype" id="6411363">error</span>&nbsp;<span class="op" id="6411369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411372">c</span><span class="op" id="6411373">,</span>&nbsp;<span class="ident" id="6411375">_</span>&nbsp;<span class="op" id="6411377">:=</span>&nbsp;<span class="ident" id="6411380">cc</span><span class="op" id="6411382">.</span><span class="ident" id="6411383">Hijack</span><span class="op" id="6411389">(</span><span class="op" id="6411390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6411393">if</span>&nbsp;<span class="ident" id="6411396">c</span>&nbsp;<span class="op" id="6411398">!=</span>&nbsp;<span class="ident" id="6411401">nil</span>&nbsp;<span class="op" id="6411405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6411409">return</span>&nbsp;<span class="ident" id="6411416">c</span><span class="op" id="6411417">.</span><span class="ident" id="6411418">Close</span><span class="op" id="6411423">(</span><span class="op" id="6411424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6411427">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6411430">return</span>&nbsp;<span class="ident" id="6411437">nil</span><br>
<span class="lineno"></span><span class="op" id="6411441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6411444">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6411524">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6411601">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6411681">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6411756">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6411833">func</span>&nbsp;<span class="op" id="6411838">(</span><span class="ident" id="6411839">cc</span>&nbsp;<span class="op" id="6411842">*</span><span class="ident" id="6411843">ClientConn</span><span class="op" id="6411853">)</span>&nbsp;<span class="ident" id="6411855">Write</span><span class="op" id="6411860">(</span><span class="ident" id="6411861">req</span>&nbsp;<span class="op" id="6411865">*</span><span class="ident" id="6411866">http</span><span class="op" id="6411870">.</span><span class="ident" id="6411871">Request</span><span class="op" id="6411878">)</span>&nbsp;<span class="op" id="6411880">(</span><span class="ident" id="6411881">err</span>&nbsp;<span class="builtintype" id="6411885">error</span><span class="op" id="6411890">)</span>&nbsp;<span class="op" id="6411892">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6411896">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411935">id</span>&nbsp;<span class="op" id="6411938">:=</span>&nbsp;<span class="ident" id="6411941">cc</span><span class="op" id="6411943">.</span><span class="ident" id="6411944">pipe</span><span class="op" id="6411948">.</span><span class="ident" id="6411949">Next</span><span class="op" id="6411953">(</span><span class="op" id="6411954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6411957">cc</span><span class="op" id="6411959">.</span><span class="ident" id="6411960">pipe</span><span class="op" id="6411964">.</span><span class="ident" id="6411965">StartRequest</span><span class="op" id="6411977">(</span><span class="ident" id="6411978">id</span><span class="op" id="6411980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6411983">defer</span>&nbsp;<span class="keyword" id="6411989">func</span><span class="op" id="6411993">(</span><span class="op" id="6411994">)</span>&nbsp;<span class="op" id="6411996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412000">cc</span><span class="op" id="6412002">.</span><span class="ident" id="6412003">pipe</span><span class="op" id="6412007">.</span><span class="ident" id="6412008">EndRequest</span><span class="op" id="6412018">(</span><span class="ident" id="6412019">id</span><span class="op" id="6412021">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412025">if</span>&nbsp;<span class="ident" id="6412028">err</span>&nbsp;<span class="op" id="6412032">!=</span>&nbsp;<span class="ident" id="6412035">nil</span>&nbsp;<span class="op" id="6412039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412044">cc</span><span class="op" id="6412046">.</span><span class="ident" id="6412047">pipe</span><span class="op" id="6412051">.</span><span class="ident" id="6412052">StartResponse</span><span class="op" id="6412065">(</span><span class="ident" id="6412066">id</span><span class="op" id="6412068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412073">cc</span><span class="op" id="6412075">.</span><span class="ident" id="6412076">pipe</span><span class="op" id="6412080">.</span><span class="ident" id="6412081">EndResponse</span><span class="op" id="6412092">(</span><span class="ident" id="6412093">id</span><span class="op" id="6412095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412099">}</span>&nbsp;<span class="keyword" id="6412101">else</span>&nbsp;<span class="op" id="6412106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6412111">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412158">cc</span><span class="op" id="6412160">.</span><span class="ident" id="6412161">lk</span><span class="op" id="6412163">.</span><span class="ident" id="6412164">Lock</span><span class="op" id="6412168">(</span><span class="op" id="6412169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412174">cc</span><span class="op" id="6412176">.</span><span class="ident" id="6412177">pipereq</span><span class="op" id="6412184">[</span><span class="ident" id="6412185">req</span><span class="op" id="6412188">]</span>&nbsp;<span class="op" id="6412190">=</span>&nbsp;<span class="ident" id="6412192">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412198">cc</span><span class="op" id="6412200">.</span><span class="ident" id="6412201">lk</span><span class="op" id="6412203">.</span><span class="ident" id="6412204">Unlock</span><span class="op" id="6412210">(</span><span class="op" id="6412211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412218">}</span><span class="op" id="6412219">(</span><span class="op" id="6412220">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412224">cc</span><span class="op" id="6412226">.</span><span class="ident" id="6412227">lk</span><span class="op" id="6412229">.</span><span class="ident" id="6412230">Lock</span><span class="op" id="6412234">(</span><span class="op" id="6412235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412238">if</span>&nbsp;<span class="ident" id="6412241">cc</span><span class="op" id="6412243">.</span><span class="ident" id="6412244">re</span>&nbsp;<span class="op" id="6412247">!=</span>&nbsp;<span class="ident" id="6412250">nil</span>&nbsp;<span class="op" id="6412254">{</span>&nbsp;<span class="comment" id="6412256">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412308">defer</span>&nbsp;<span class="ident" id="6412314">cc</span><span class="op" id="6412316">.</span><span class="ident" id="6412317">lk</span><span class="op" id="6412319">.</span><span class="ident" id="6412320">Unlock</span><span class="op" id="6412326">(</span><span class="op" id="6412327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412331">return</span>&nbsp;<span class="ident" id="6412338">cc</span><span class="op" id="6412340">.</span><span class="ident" id="6412341">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412348">if</span>&nbsp;<span class="ident" id="6412351">cc</span><span class="op" id="6412353">.</span><span class="ident" id="6412354">we</span>&nbsp;<span class="op" id="6412357">!=</span>&nbsp;<span class="ident" id="6412360">nil</span>&nbsp;<span class="op" id="6412364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412368">defer</span>&nbsp;<span class="ident" id="6412374">cc</span><span class="op" id="6412376">.</span><span class="ident" id="6412377">lk</span><span class="op" id="6412379">.</span><span class="ident" id="6412380">Unlock</span><span class="op" id="6412386">(</span><span class="op" id="6412387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412391">return</span>&nbsp;<span class="ident" id="6412398">cc</span><span class="op" id="6412400">.</span><span class="ident" id="6412401">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412405">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412408">if</span>&nbsp;<span class="ident" id="6412411">cc</span><span class="op" id="6412413">.</span><span class="ident" id="6412414">c</span>&nbsp;<span class="op" id="6412416">==</span>&nbsp;<span class="ident" id="6412419">nil</span>&nbsp;<span class="op" id="6412423">{</span>&nbsp;<span class="comment" id="6412425">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412472">defer</span>&nbsp;<span class="ident" id="6412478">cc</span><span class="op" id="6412480">.</span><span class="ident" id="6412481">lk</span><span class="op" id="6412483">.</span><span class="ident" id="6412484">Unlock</span><span class="op" id="6412490">(</span><span class="op" id="6412491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412495">return</span>&nbsp;<span class="ident" id="6412502">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412516">c</span>&nbsp;<span class="op" id="6412518">:=</span>&nbsp;<span class="ident" id="6412521">cc</span><span class="op" id="6412523">.</span><span class="ident" id="6412524">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412527">if</span>&nbsp;<span class="ident" id="6412530">req</span><span class="op" id="6412533">.</span><span class="ident" id="6412534">Close</span>&nbsp;<span class="op" id="6412540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6412544">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6412605">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412646">cc</span><span class="op" id="6412648">.</span><span class="ident" id="6412649">we</span>&nbsp;<span class="op" id="6412652">=</span>&nbsp;<span class="ident" id="6412654">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412669">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412672">cc</span><span class="op" id="6412674">.</span><span class="ident" id="6412675">lk</span><span class="op" id="6412677">.</span><span class="ident" id="6412678">Unlock</span><span class="op" id="6412684">(</span><span class="op" id="6412685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412689">err</span>&nbsp;<span class="op" id="6412693">=</span>&nbsp;<span class="ident" id="6412695">cc</span><span class="op" id="6412697">.</span><span class="ident" id="6412698">writeReq</span><span class="op" id="6412706">(</span><span class="ident" id="6412707">req</span><span class="op" id="6412710">,</span>&nbsp;<span class="ident" id="6412712">c</span><span class="op" id="6412713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412716">cc</span><span class="op" id="6412718">.</span><span class="ident" id="6412719">lk</span><span class="op" id="6412721">.</span><span class="ident" id="6412722">Lock</span><span class="op" id="6412726">(</span><span class="op" id="6412727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412730">defer</span>&nbsp;<span class="ident" id="6412736">cc</span><span class="op" id="6412738">.</span><span class="ident" id="6412739">lk</span><span class="op" id="6412741">.</span><span class="ident" id="6412742">Unlock</span><span class="op" id="6412748">(</span><span class="op" id="6412749">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412752">if</span>&nbsp;<span class="ident" id="6412755">err</span>&nbsp;<span class="op" id="6412759">!=</span>&nbsp;<span class="ident" id="6412762">nil</span>&nbsp;<span class="op" id="6412766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412770">cc</span><span class="op" id="6412772">.</span><span class="ident" id="6412773">we</span>&nbsp;<span class="op" id="6412776">=</span>&nbsp;<span class="ident" id="6412778">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412784">return</span>&nbsp;<span class="ident" id="6412791">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6412796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412799">cc</span><span class="op" id="6412801">.</span><span class="ident" id="6412802">nwritten</span><span class="op" id="6412810">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412815">return</span>&nbsp;<span class="ident" id="6412822">nil</span><br>
<span class="lineno"></span><span class="op" id="6412826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6412829">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6412882">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6412924">func</span>&nbsp;<span class="op" id="6412929">(</span><span class="ident" id="6412930">cc</span>&nbsp;<span class="op" id="6412933">*</span><span class="ident" id="6412934">ClientConn</span><span class="op" id="6412944">)</span>&nbsp;<span class="ident" id="6412946">Pending</span><span class="op" id="6412953">(</span><span class="op" id="6412954">)</span>&nbsp;<span class="builtintype" id="6412956">int</span>&nbsp;<span class="op" id="6412960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6412963">cc</span><span class="op" id="6412965">.</span><span class="ident" id="6412966">lk</span><span class="op" id="6412968">.</span><span class="ident" id="6412969">Lock</span><span class="op" id="6412973">(</span><span class="op" id="6412974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412977">defer</span>&nbsp;<span class="ident" id="6412983">cc</span><span class="op" id="6412985">.</span><span class="ident" id="6412986">lk</span><span class="op" id="6412988">.</span><span class="ident" id="6412989">Unlock</span><span class="op" id="6412995">(</span><span class="op" id="6412996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6412999">return</span>&nbsp;<span class="ident" id="6413006">cc</span><span class="op" id="6413008">.</span><span class="ident" id="6413009">nwritten</span>&nbsp;<span class="op" id="6413018">-</span>&nbsp;<span class="ident" id="6413020">cc</span><span class="op" id="6413022">.</span><span class="ident" id="6413023">nread</span><br>
<span class="lineno">355</span><span class="op" id="6413029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6413032">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6413105">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6413177">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6413249">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6413304">func</span>&nbsp;<span class="op" id="6413309">(</span><span class="ident" id="6413310">cc</span>&nbsp;<span class="op" id="6413313">*</span><span class="ident" id="6413314">ClientConn</span><span class="op" id="6413324">)</span>&nbsp;<span class="ident" id="6413326">Read</span><span class="op" id="6413330">(</span><span class="ident" id="6413331">req</span>&nbsp;<span class="op" id="6413335">*</span><span class="ident" id="6413336">http</span><span class="op" id="6413340">.</span><span class="ident" id="6413341">Request</span><span class="op" id="6413348">)</span>&nbsp;<span class="op" id="6413350">(</span><span class="ident" id="6413351">resp</span>&nbsp;<span class="op" id="6413356">*</span><span class="ident" id="6413357">http</span><span class="op" id="6413361">.</span><span class="ident" id="6413362">Response</span><span class="op" id="6413370">,</span>&nbsp;<span class="ident" id="6413372">err</span>&nbsp;<span class="builtintype" id="6413376">error</span><span class="op" id="6413381">)</span>&nbsp;<span class="op" id="6413383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6413386">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413445">cc</span><span class="op" id="6413447">.</span><span class="ident" id="6413448">lk</span><span class="op" id="6413450">.</span><span class="ident" id="6413451">Lock</span><span class="op" id="6413455">(</span><span class="op" id="6413456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413459">id</span><span class="op" id="6413461">,</span>&nbsp;<span class="ident" id="6413463">ok</span>&nbsp;<span class="op" id="6413466">:=</span>&nbsp;<span class="ident" id="6413469">cc</span><span class="op" id="6413471">.</span><span class="ident" id="6413472">pipereq</span><span class="op" id="6413479">[</span><span class="ident" id="6413480">req</span><span class="op" id="6413483">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6413486">delete</span><span class="op" id="6413492">(</span><span class="ident" id="6413493">cc</span><span class="op" id="6413495">.</span><span class="ident" id="6413496">pipereq</span><span class="op" id="6413503">,</span>&nbsp;<span class="ident" id="6413505">req</span><span class="op" id="6413508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413511">if</span>&nbsp;<span class="op" id="6413514">!</span><span class="ident" id="6413515">ok</span>&nbsp;<span class="op" id="6413518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413522">cc</span><span class="op" id="6413524">.</span><span class="ident" id="6413525">lk</span><span class="op" id="6413527">.</span><span class="ident" id="6413528">Unlock</span><span class="op" id="6413534">(</span><span class="op" id="6413535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413539">return</span>&nbsp;<span class="ident" id="6413546">nil</span><span class="op" id="6413549">,</span>&nbsp;<span class="ident" id="6413551">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413564">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413567">cc</span><span class="op" id="6413569">.</span><span class="ident" id="6413570">lk</span><span class="op" id="6413572">.</span><span class="ident" id="6413573">Unlock</span><span class="op" id="6413579">(</span><span class="op" id="6413580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6413584">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413610">cc</span><span class="op" id="6413612">.</span><span class="ident" id="6413613">pipe</span><span class="op" id="6413617">.</span><span class="ident" id="6413618">StartResponse</span><span class="op" id="6413631">(</span><span class="ident" id="6413632">id</span><span class="op" id="6413634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413637">defer</span>&nbsp;<span class="ident" id="6413643">cc</span><span class="op" id="6413645">.</span><span class="ident" id="6413646">pipe</span><span class="op" id="6413650">.</span><span class="ident" id="6413651">EndResponse</span><span class="op" id="6413662">(</span><span class="ident" id="6413663">id</span><span class="op" id="6413665">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413669">cc</span><span class="op" id="6413671">.</span><span class="ident" id="6413672">lk</span><span class="op" id="6413674">.</span><span class="ident" id="6413675">Lock</span><span class="op" id="6413679">(</span><span class="op" id="6413680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413683">if</span>&nbsp;<span class="ident" id="6413686">cc</span><span class="op" id="6413688">.</span><span class="ident" id="6413689">re</span>&nbsp;<span class="op" id="6413692">!=</span>&nbsp;<span class="ident" id="6413695">nil</span>&nbsp;<span class="op" id="6413699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413703">defer</span>&nbsp;<span class="ident" id="6413709">cc</span><span class="op" id="6413711">.</span><span class="ident" id="6413712">lk</span><span class="op" id="6413714">.</span><span class="ident" id="6413715">Unlock</span><span class="op" id="6413721">(</span><span class="op" id="6413722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413726">return</span>&nbsp;<span class="ident" id="6413733">nil</span><span class="op" id="6413736">,</span>&nbsp;<span class="ident" id="6413738">cc</span><span class="op" id="6413740">.</span><span class="ident" id="6413741">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413748">if</span>&nbsp;<span class="ident" id="6413751">cc</span><span class="op" id="6413753">.</span><span class="ident" id="6413754">r</span>&nbsp;<span class="op" id="6413756">==</span>&nbsp;<span class="ident" id="6413759">nil</span>&nbsp;<span class="op" id="6413763">{</span>&nbsp;<span class="comment" id="6413765">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413812">defer</span>&nbsp;<span class="ident" id="6413818">cc</span><span class="op" id="6413820">.</span><span class="ident" id="6413821">lk</span><span class="op" id="6413823">.</span><span class="ident" id="6413824">Unlock</span><span class="op" id="6413830">(</span><span class="op" id="6413831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6413835">return</span>&nbsp;<span class="ident" id="6413842">nil</span><span class="op" id="6413845">,</span>&nbsp;<span class="ident" id="6413847">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6413858">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413861">r</span>&nbsp;<span class="op" id="6413863">:=</span>&nbsp;<span class="ident" id="6413866">cc</span><span class="op" id="6413868">.</span><span class="ident" id="6413869">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413872">lastbody</span>&nbsp;<span class="op" id="6413881">:=</span>&nbsp;<span class="ident" id="6413884">cc</span><span class="op" id="6413886">.</span><span class="ident" id="6413887">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413897">cc</span><span class="op" id="6413899">.</span><span class="ident" id="6413900">lastbody</span>&nbsp;<span class="op" id="6413909">=</span>&nbsp;<span class="ident" id="6413911">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6413916">cc</span><span class="op" id="6413918">.</span><span class="ident" id="6413919">lk</span><span class="op" id="6413921">.</span><span class="ident" id="6413922">Unlock</span><span class="op" id="6413928">(</span><span class="op" id="6413929">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6413933">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414009">if</span>&nbsp;<span class="ident" id="6414012">lastbody</span>&nbsp;<span class="op" id="6414021">!=</span>&nbsp;<span class="ident" id="6414024">nil</span>&nbsp;<span class="op" id="6414028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6414032">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6414098">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6414156">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414171">err</span>&nbsp;<span class="op" id="6414175">=</span>&nbsp;<span class="ident" id="6414177">lastbody</span><span class="op" id="6414185">.</span><span class="ident" id="6414186">Close</span><span class="op" id="6414191">(</span><span class="op" id="6414192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414196">if</span>&nbsp;<span class="ident" id="6414199">err</span>&nbsp;<span class="op" id="6414203">!=</span>&nbsp;<span class="ident" id="6414206">nil</span>&nbsp;<span class="op" id="6414210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414215">cc</span><span class="op" id="6414217">.</span><span class="ident" id="6414218">lk</span><span class="op" id="6414220">.</span><span class="ident" id="6414221">Lock</span><span class="op" id="6414225">(</span><span class="op" id="6414226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414231">defer</span>&nbsp;<span class="ident" id="6414237">cc</span><span class="op" id="6414239">.</span><span class="ident" id="6414240">lk</span><span class="op" id="6414242">.</span><span class="ident" id="6414243">Unlock</span><span class="op" id="6414249">(</span><span class="op" id="6414250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414255">cc</span><span class="op" id="6414257">.</span><span class="ident" id="6414258">re</span>&nbsp;<span class="op" id="6414261">=</span>&nbsp;<span class="ident" id="6414263">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414270">return</span>&nbsp;<span class="ident" id="6414277">nil</span><span class="op" id="6414280">,</span>&nbsp;<span class="ident" id="6414282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414295">resp</span><span class="op" id="6414299">,</span>&nbsp;<span class="ident" id="6414301">err</span>&nbsp;<span class="op" id="6414305">=</span>&nbsp;<span class="ident" id="6414307">http</span><span class="op" id="6414311">.</span><span class="ident" id="6414312">ReadResponse</span><span class="op" id="6414324">(</span><span class="ident" id="6414325">r</span><span class="op" id="6414326">,</span>&nbsp;<span class="ident" id="6414328">req</span><span class="op" id="6414331">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414334">cc</span><span class="op" id="6414336">.</span><span class="ident" id="6414337">lk</span><span class="op" id="6414339">.</span><span class="ident" id="6414340">Lock</span><span class="op" id="6414344">(</span><span class="op" id="6414345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414348">defer</span>&nbsp;<span class="ident" id="6414354">cc</span><span class="op" id="6414356">.</span><span class="ident" id="6414357">lk</span><span class="op" id="6414359">.</span><span class="ident" id="6414360">Unlock</span><span class="op" id="6414366">(</span><span class="op" id="6414367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414370">if</span>&nbsp;<span class="ident" id="6414373">err</span>&nbsp;<span class="op" id="6414377">!=</span>&nbsp;<span class="ident" id="6414380">nil</span>&nbsp;<span class="op" id="6414384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414388">cc</span><span class="op" id="6414390">.</span><span class="ident" id="6414391">re</span>&nbsp;<span class="op" id="6414394">=</span>&nbsp;<span class="ident" id="6414396">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414402">return</span>&nbsp;<span class="ident" id="6414409">resp</span><span class="op" id="6414413">,</span>&nbsp;<span class="ident" id="6414415">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414423">cc</span><span class="op" id="6414425">.</span><span class="ident" id="6414426">lastbody</span>&nbsp;<span class="op" id="6414435">=</span>&nbsp;<span class="ident" id="6414437">resp</span><span class="op" id="6414441">.</span><span class="ident" id="6414442">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414449">cc</span><span class="op" id="6414451">.</span><span class="ident" id="6414452">nread</span><span class="op" id="6414457">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414462">if</span>&nbsp;<span class="ident" id="6414465">resp</span><span class="op" id="6414469">.</span><span class="ident" id="6414470">Close</span>&nbsp;<span class="op" id="6414476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414480">cc</span><span class="op" id="6414482">.</span><span class="ident" id="6414483">re</span>&nbsp;<span class="op" id="6414486">=</span>&nbsp;<span class="ident" id="6414488">ErrPersistEOF</span>&nbsp;<span class="comment" id="6414502">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414536">return</span>&nbsp;<span class="ident" id="6414543">resp</span><span class="op" id="6414547">,</span>&nbsp;<span class="ident" id="6414549">cc</span><span class="op" id="6414551">.</span><span class="ident" id="6414552">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414559">return</span>&nbsp;<span class="ident" id="6414566">resp</span><span class="op" id="6414570">,</span>&nbsp;<span class="ident" id="6414572">err</span><br>
<span class="lineno">420</span><span class="op" id="6414576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6414579">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6414651">func</span>&nbsp;<span class="op" id="6414656">(</span><span class="ident" id="6414657">cc</span>&nbsp;<span class="op" id="6414660">*</span><span class="ident" id="6414661">ClientConn</span><span class="op" id="6414671">)</span>&nbsp;<span class="ident" id="6414673">Do</span><span class="op" id="6414675">(</span><span class="ident" id="6414676">req</span>&nbsp;<span class="op" id="6414680">*</span><span class="ident" id="6414681">http</span><span class="op" id="6414685">.</span><span class="ident" id="6414686">Request</span><span class="op" id="6414693">)</span>&nbsp;<span class="op" id="6414695">(</span><span class="ident" id="6414696">resp</span>&nbsp;<span class="op" id="6414701">*</span><span class="ident" id="6414702">http</span><span class="op" id="6414706">.</span><span class="ident" id="6414707">Response</span><span class="op" id="6414715">,</span>&nbsp;<span class="ident" id="6414717">err</span>&nbsp;<span class="builtintype" id="6414721">error</span><span class="op" id="6414726">)</span>&nbsp;<span class="op" id="6414728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6414731">err</span>&nbsp;<span class="op" id="6414735">=</span>&nbsp;<span class="ident" id="6414737">cc</span><span class="op" id="6414739">.</span><span class="ident" id="6414740">Write</span><span class="op" id="6414745">(</span><span class="ident" id="6414746">req</span><span class="op" id="6414749">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414752">if</span>&nbsp;<span class="ident" id="6414755">err</span>&nbsp;<span class="op" id="6414759">!=</span>&nbsp;<span class="ident" id="6414762">nil</span>&nbsp;<span class="op" id="6414766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6414778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6414781">return</span>&nbsp;<span class="ident" id="6414788">cc</span><span class="op" id="6414790">.</span><span class="ident" id="6414791">Read</span><span class="op" id="6414795">(</span><span class="ident" id="6414796">req</span><span class="op" id="6414799">)</span><br>
<span class="lineno"></span><span class="op" id="6414801">}</span>
</div>
</body>
</html>
