<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5427710">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5427765">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5427819">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5427870">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5427899">package</span>&nbsp;<span class="ident" id="5427907">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5427917">import</span>&nbsp;<span class="op" id="5427924">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427927">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427941">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427949">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427956">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427963">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427975">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5427981">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5427988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5427991">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="5428062">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="5428125">type</span>&nbsp;<span class="ident" id="5428130">Server</span>&nbsp;<span class="keyword" id="5428137">struct</span>&nbsp;<span class="op" id="5428144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428147">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5428156">string</span>&nbsp;<span class="comment" id="5428163">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428226">Listener</span>&nbsp;<span class="ident" id="5428235">net</span><span class="op" id="5428238">.</span><span class="ident" id="5428239">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428250">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428321">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428393">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428456">TLS</span>&nbsp;<span class="op" id="5428460">*</span><span class="ident" id="5428461">tls</span><span class="op" id="5428464">.</span><span class="ident" id="5428465">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428474">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428537">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428567">Config</span>&nbsp;<span class="op" id="5428574">*</span><span class="ident" id="5428575">http</span><span class="op" id="5428579">.</span><span class="ident" id="5428580">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428589">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5428659">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428709">wg</span>&nbsp;<span class="ident" id="5428712">sync</span><span class="op" id="5428716">.</span><span class="ident" id="5428717">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="5428727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5428730">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="5428795">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="5428808">type</span>&nbsp;<span class="ident" id="5428813">historyListener</span>&nbsp;<span class="keyword" id="5428829">struct</span>&nbsp;<span class="op" id="5428836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428839">net</span><span class="op" id="5428842">.</span><span class="ident" id="5428843">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428853">sync</span><span class="op" id="5428857">.</span><span class="ident" id="5428858">Mutex</span>&nbsp;<span class="comment" id="5428864">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428885">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5428896">[</span><span class="op" id="5428897">]</span><span class="ident" id="5428898">net</span><span class="op" id="5428901">.</span><span class="ident" id="5428902">Conn</span><br>
<span class="lineno">45</span><span class="op" id="5428907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5428910">func</span>&nbsp;<span class="op" id="5428915">(</span><span class="ident" id="5428916">hs</span>&nbsp;<span class="op" id="5428919">*</span><span class="ident" id="5428920">historyListener</span><span class="op" id="5428935">)</span>&nbsp;<span class="ident" id="5428937">Accept</span><span class="op" id="5428943">(</span><span class="op" id="5428944">)</span>&nbsp;<span class="op" id="5428946">(</span><span class="ident" id="5428947">c</span>&nbsp;<span class="ident" id="5428949">net</span><span class="op" id="5428952">.</span><span class="ident" id="5428953">Conn</span><span class="op" id="5428957">,</span>&nbsp;<span class="ident" id="5428959">err</span>&nbsp;<span class="builtintype" id="5428963">error</span><span class="op" id="5428968">)</span>&nbsp;<span class="op" id="5428970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5428973">c</span><span class="op" id="5428974">,</span>&nbsp;<span class="ident" id="5428976">err</span>&nbsp;<span class="op" id="5428980">=</span>&nbsp;<span class="ident" id="5428982">hs</span><span class="op" id="5428984">.</span><span class="ident" id="5428985">Listener</span><span class="op" id="5428993">.</span><span class="ident" id="5428994">Accept</span><span class="op" id="5429000">(</span><span class="op" id="5429001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429004">if</span>&nbsp;<span class="ident" id="5429007">err</span>&nbsp;<span class="op" id="5429011">==</span>&nbsp;<span class="ident" id="5429014">nil</span>&nbsp;<span class="op" id="5429018">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5429022">hs</span><span class="op" id="5429024">.</span><span class="ident" id="5429025">Lock</span><span class="op" id="5429029">(</span><span class="op" id="5429030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5429034">hs</span><span class="op" id="5429036">.</span><span class="ident" id="5429037">history</span>&nbsp;<span class="op" id="5429045">=</span>&nbsp;<span class="builtinfunc" id="5429047">append</span><span class="op" id="5429053">(</span><span class="ident" id="5429054">hs</span><span class="op" id="5429056">.</span><span class="ident" id="5429057">history</span><span class="op" id="5429064">,</span>&nbsp;<span class="ident" id="5429066">c</span><span class="op" id="5429067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5429071">hs</span><span class="op" id="5429073">.</span><span class="ident" id="5429074">Unlock</span><span class="op" id="5429080">(</span><span class="op" id="5429081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5429084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429087">return</span><br>
<span class="lineno">55</span><span class="op" id="5429094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5429097">func</span>&nbsp;<span class="ident" id="5429102">newLocalListener</span><span class="op" id="5429118">(</span><span class="op" id="5429119">)</span>&nbsp;<span class="ident" id="5429121">net</span><span class="op" id="5429124">.</span><span class="ident" id="5429125">Listener</span>&nbsp;<span class="op" id="5429134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429137">if</span>&nbsp;<span class="op" id="5429140">*</span><span class="ident" id="5429141">serve</span>&nbsp;<span class="op" id="5429147">!=</span>&nbsp;<span class="string" id="5429150">&#34;&#34;</span>&nbsp;<span class="op" id="5429153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5429157">l</span><span class="op" id="5429158">,</span>&nbsp;<span class="ident" id="5429160">err</span>&nbsp;<span class="op" id="5429164">:=</span>&nbsp;<span class="ident" id="5429167">net</span><span class="op" id="5429170">.</span><span class="ident" id="5429171">Listen</span><span class="op" id="5429177">(</span><span class="string" id="5429178">&#34;tcp&#34;</span><span class="op" id="5429183">,</span>&nbsp;<span class="op" id="5429185">*</span><span class="ident" id="5429186">serve</span><span class="op" id="5429191">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429195">if</span>&nbsp;<span class="ident" id="5429198">err</span>&nbsp;<span class="op" id="5429202">!=</span>&nbsp;<span class="ident" id="5429205">nil</span>&nbsp;<span class="op" id="5429209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5429214">panic</span><span class="op" id="5429219">(</span><span class="ident" id="5429220">fmt</span><span class="op" id="5429223">.</span><span class="ident" id="5429224">Sprintf</span><span class="op" id="5429231">(</span><span class="string" id="5429232">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="5429270">,</span>&nbsp;<span class="op" id="5429272">*</span><span class="ident" id="5429273">serve</span><span class="op" id="5429278">,</span>&nbsp;<span class="ident" id="5429280">err</span><span class="op" id="5429283">)</span><span class="op" id="5429284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5429288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429292">return</span>&nbsp;<span class="ident" id="5429299">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5429302">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5429305">l</span><span class="op" id="5429306">,</span>&nbsp;<span class="ident" id="5429308">err</span>&nbsp;<span class="op" id="5429312">:=</span>&nbsp;<span class="ident" id="5429315">net</span><span class="op" id="5429318">.</span><span class="ident" id="5429319">Listen</span><span class="op" id="5429325">(</span><span class="string" id="5429326">&#34;tcp&#34;</span><span class="op" id="5429331">,</span>&nbsp;<span class="string" id="5429333">&#34;127.0.0.1:0&#34;</span><span class="op" id="5429346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429349">if</span>&nbsp;<span class="ident" id="5429352">err</span>&nbsp;<span class="op" id="5429356">!=</span>&nbsp;<span class="ident" id="5429359">nil</span>&nbsp;<span class="op" id="5429363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429367">if</span>&nbsp;<span class="ident" id="5429370">l</span><span class="op" id="5429371">,</span>&nbsp;<span class="ident" id="5429373">err</span>&nbsp;<span class="op" id="5429377">=</span>&nbsp;<span class="ident" id="5429379">net</span><span class="op" id="5429382">.</span><span class="ident" id="5429383">Listen</span><span class="op" id="5429389">(</span><span class="string" id="5429390">&#34;tcp6&#34;</span><span class="op" id="5429396">,</span>&nbsp;<span class="string" id="5429398">&#34;[::1]:0&#34;</span><span class="op" id="5429407">)</span><span class="op" id="5429408">;</span>&nbsp;<span class="ident" id="5429410">err</span>&nbsp;<span class="op" id="5429414">!=</span>&nbsp;<span class="ident" id="5429417">nil</span>&nbsp;<span class="op" id="5429421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5429426">panic</span><span class="op" id="5429431">(</span><span class="ident" id="5429432">fmt</span><span class="op" id="5429435">.</span><span class="ident" id="5429436">Sprintf</span><span class="op" id="5429443">(</span><span class="string" id="5429444">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="5429486">,</span>&nbsp;<span class="ident" id="5429488">err</span><span class="op" id="5429491">)</span><span class="op" id="5429492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5429496">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5429499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5429502">return</span>&nbsp;<span class="ident" id="5429509">l</span><br>
<span class="lineno"></span><span class="op" id="5429511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5429514">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="5429569">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5429595">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="5429653">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="5429721">var</span>&nbsp;<span class="ident" id="5429725">serve</span>&nbsp;<span class="op" id="5429731">=</span>&nbsp;<span class="ident" id="5429733">flag</span><span class="op" id="5429737">.</span><span class="ident" id="5429738">String</span><span class="op" id="5429744">(</span><span class="string" id="5429745">&#34;httptest.serve&#34;</span><span class="op" id="5429761">,</span>&nbsp;<span class="string" id="5429763">&#34;&#34;</span><span class="op" id="5429765">,</span>&nbsp;<span class="string" id="5429767">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="5429835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5429838">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="5429884">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5429948">func</span>&nbsp;<span class="ident" id="5429953">NewServer</span><span class="op" id="5429962">(</span><span class="ident" id="5429963">handler</span>&nbsp;<span class="ident" id="5429971">http</span><span class="op" id="5429975">.</span><span class="ident" id="5429976">Handler</span><span class="op" id="5429983">)</span>&nbsp;<span class="op" id="5429985">*</span><span class="ident" id="5429986">Server</span>&nbsp;<span class="op" id="5429993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5429996">ts</span>&nbsp;<span class="op" id="5429999">:=</span>&nbsp;<span class="ident" id="5430002">NewUnstartedServer</span><span class="op" id="5430020">(</span><span class="ident" id="5430021">handler</span><span class="op" id="5430028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430031">ts</span><span class="op" id="5430033">.</span><span class="ident" id="5430034">Start</span><span class="op" id="5430039">(</span><span class="op" id="5430040">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430043">return</span>&nbsp;<span class="ident" id="5430050">ts</span><br>
<span class="lineno"></span><span class="op" id="5430053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5430056">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5430121">//</span><br>
<span class="lineno">90</span><span class="comment" id="5430124">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5430193">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="5430206">//</span><br>
<span class="lineno"></span><span class="comment" id="5430209">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5430273">func</span>&nbsp;<span class="ident" id="5430278">NewUnstartedServer</span><span class="op" id="5430296">(</span><span class="ident" id="5430297">handler</span>&nbsp;<span class="ident" id="5430305">http</span><span class="op" id="5430309">.</span><span class="ident" id="5430310">Handler</span><span class="op" id="5430317">)</span>&nbsp;<span class="op" id="5430319">*</span><span class="ident" id="5430320">Server</span>&nbsp;<span class="op" id="5430327">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430330">return</span>&nbsp;<span class="op" id="5430337">&amp;</span><span class="ident" id="5430338">Server</span><span class="op" id="5430344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430348">Listener</span><span class="op" id="5430356">:</span>&nbsp;<span class="ident" id="5430358">newLocalListener</span><span class="op" id="5430374">(</span><span class="op" id="5430375">)</span><span class="op" id="5430376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430380">Config</span><span class="op" id="5430386">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5430390">&amp;</span><span class="ident" id="5430391">http</span><span class="op" id="5430395">.</span><span class="ident" id="5430396">Server</span><span class="op" id="5430402">{</span><span class="ident" id="5430403">Handler</span><span class="op" id="5430410">:</span>&nbsp;<span class="ident" id="5430412">handler</span><span class="op" id="5430419">}</span><span class="op" id="5430420">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5430423">}</span><br>
<span class="lineno"></span><span class="op" id="5430425">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5430428">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5430478">func</span>&nbsp;<span class="op" id="5430483">(</span><span class="ident" id="5430484">s</span>&nbsp;<span class="op" id="5430486">*</span><span class="ident" id="5430487">Server</span><span class="op" id="5430493">)</span>&nbsp;<span class="ident" id="5430495">Start</span><span class="op" id="5430500">(</span><span class="op" id="5430501">)</span>&nbsp;<span class="op" id="5430503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430506">if</span>&nbsp;<span class="ident" id="5430509">s</span><span class="op" id="5430510">.</span><span class="ident" id="5430511">URL</span>&nbsp;<span class="op" id="5430515">!=</span>&nbsp;<span class="string" id="5430518">&#34;&#34;</span>&nbsp;<span class="op" id="5430521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5430525">panic</span><span class="op" id="5430530">(</span><span class="string" id="5430531">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5430555">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5430558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430561">s</span><span class="op" id="5430562">.</span><span class="ident" id="5430563">Listener</span>&nbsp;<span class="op" id="5430572">=</span>&nbsp;<span class="op" id="5430574">&amp;</span><span class="ident" id="5430575">historyListener</span><span class="op" id="5430590">{</span><span class="ident" id="5430591">Listener</span><span class="op" id="5430599">:</span>&nbsp;<span class="ident" id="5430601">s</span><span class="op" id="5430602">.</span><span class="ident" id="5430603">Listener</span><span class="op" id="5430611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430614">s</span><span class="op" id="5430615">.</span><span class="ident" id="5430616">URL</span>&nbsp;<span class="op" id="5430620">=</span>&nbsp;<span class="string" id="5430622">&#34;http://&#34;</span>&nbsp;<span class="op" id="5430632">+</span>&nbsp;<span class="ident" id="5430634">s</span><span class="op" id="5430635">.</span><span class="ident" id="5430636">Listener</span><span class="op" id="5430644">.</span><span class="ident" id="5430645">Addr</span><span class="op" id="5430649">(</span><span class="op" id="5430650">)</span><span class="op" id="5430651">.</span><span class="ident" id="5430652">String</span><span class="op" id="5430658">(</span><span class="op" id="5430659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430662">s</span><span class="op" id="5430663">.</span><span class="ident" id="5430664">wrapHandler</span><span class="op" id="5430675">(</span><span class="op" id="5430676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430679">go</span>&nbsp;<span class="ident" id="5430682">s</span><span class="op" id="5430683">.</span><span class="ident" id="5430684">Config</span><span class="op" id="5430690">.</span><span class="ident" id="5430691">Serve</span><span class="op" id="5430696">(</span><span class="ident" id="5430697">s</span><span class="op" id="5430698">.</span><span class="ident" id="5430699">Listener</span><span class="op" id="5430707">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430710">if</span>&nbsp;<span class="op" id="5430713">*</span><span class="ident" id="5430714">serve</span>&nbsp;<span class="op" id="5430720">!=</span>&nbsp;<span class="string" id="5430723">&#34;&#34;</span>&nbsp;<span class="op" id="5430726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430730">fmt</span><span class="op" id="5430733">.</span><span class="ident" id="5430734">Fprintln</span><span class="op" id="5430742">(</span><span class="ident" id="5430743">os</span><span class="op" id="5430745">.</span><span class="ident" id="5430746">Stderr</span><span class="op" id="5430752">,</span>&nbsp;<span class="string" id="5430754">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="5430776">,</span>&nbsp;<span class="ident" id="5430778">s</span><span class="op" id="5430779">.</span><span class="ident" id="5430780">URL</span><span class="op" id="5430783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430787">select</span>&nbsp;<span class="op" id="5430794">{</span><span class="op" id="5430795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5430798">}</span><br>
<span class="lineno"></span><span class="op" id="5430800">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5430803">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5430863">func</span>&nbsp;<span class="op" id="5430868">(</span><span class="ident" id="5430869">s</span>&nbsp;<span class="op" id="5430871">*</span><span class="ident" id="5430872">Server</span><span class="op" id="5430878">)</span>&nbsp;<span class="ident" id="5430880">StartTLS</span><span class="op" id="5430888">(</span><span class="op" id="5430889">)</span>&nbsp;<span class="op" id="5430891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5430894">if</span>&nbsp;<span class="ident" id="5430897">s</span><span class="op" id="5430898">.</span><span class="ident" id="5430899">URL</span>&nbsp;<span class="op" id="5430903">!=</span>&nbsp;<span class="string" id="5430906">&#34;&#34;</span>&nbsp;<span class="op" id="5430909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5430913">panic</span><span class="op" id="5430918">(</span><span class="string" id="5430919">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5430943">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5430946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5430949">cert</span><span class="op" id="5430953">,</span>&nbsp;<span class="ident" id="5430955">err</span>&nbsp;<span class="op" id="5430959">:=</span>&nbsp;<span class="ident" id="5430962">tls</span><span class="op" id="5430965">.</span><span class="ident" id="5430966">X509KeyPair</span><span class="op" id="5430977">(</span><span class="ident" id="5430978">localhostCert</span><span class="op" id="5430991">,</span>&nbsp;<span class="ident" id="5430993">localhostKey</span><span class="op" id="5431005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431008">if</span>&nbsp;<span class="ident" id="5431011">err</span>&nbsp;<span class="op" id="5431015">!=</span>&nbsp;<span class="ident" id="5431018">nil</span>&nbsp;<span class="op" id="5431022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5431026">panic</span><span class="op" id="5431031">(</span><span class="ident" id="5431032">fmt</span><span class="op" id="5431035">.</span><span class="ident" id="5431036">Sprintf</span><span class="op" id="5431043">(</span><span class="string" id="5431044">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="5431072">,</span>&nbsp;<span class="ident" id="5431074">err</span><span class="op" id="5431077">)</span><span class="op" id="5431078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431081">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431085">existingConfig</span>&nbsp;<span class="op" id="5431100">:=</span>&nbsp;<span class="ident" id="5431103">s</span><span class="op" id="5431104">.</span><span class="ident" id="5431105">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431110">s</span><span class="op" id="5431111">.</span><span class="ident" id="5431112">TLS</span>&nbsp;<span class="op" id="5431116">=</span>&nbsp;<span class="builtinfunc" id="5431118">new</span><span class="op" id="5431121">(</span><span class="ident" id="5431122">tls</span><span class="op" id="5431125">.</span><span class="ident" id="5431126">Config</span><span class="op" id="5431132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431135">if</span>&nbsp;<span class="ident" id="5431138">existingConfig</span>&nbsp;<span class="op" id="5431153">!=</span>&nbsp;<span class="ident" id="5431156">nil</span>&nbsp;<span class="op" id="5431160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431164">*</span><span class="ident" id="5431165">s</span><span class="op" id="5431166">.</span><span class="ident" id="5431167">TLS</span>&nbsp;<span class="op" id="5431171">=</span>&nbsp;<span class="op" id="5431173">*</span><span class="ident" id="5431174">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431193">if</span>&nbsp;<span class="ident" id="5431196">s</span><span class="op" id="5431197">.</span><span class="ident" id="5431198">TLS</span><span class="op" id="5431201">.</span><span class="ident" id="5431202">NextProtos</span>&nbsp;<span class="op" id="5431213">==</span>&nbsp;<span class="ident" id="5431216">nil</span>&nbsp;<span class="op" id="5431220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431224">s</span><span class="op" id="5431225">.</span><span class="ident" id="5431226">TLS</span><span class="op" id="5431229">.</span><span class="ident" id="5431230">NextProtos</span>&nbsp;<span class="op" id="5431241">=</span>&nbsp;<span class="op" id="5431243">[</span><span class="op" id="5431244">]</span><span class="builtintype" id="5431245">string</span><span class="op" id="5431251">{</span><span class="string" id="5431252">&#34;http/1.1&#34;</span><span class="op" id="5431262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431268">if</span>&nbsp;<span class="builtinfunc" id="5431271">len</span><span class="op" id="5431274">(</span><span class="ident" id="5431275">s</span><span class="op" id="5431276">.</span><span class="ident" id="5431277">TLS</span><span class="op" id="5431280">.</span><span class="ident" id="5431281">Certificates</span><span class="op" id="5431293">)</span>&nbsp;<span class="op" id="5431295">==</span>&nbsp;<span class="num" id="5431298">0</span>&nbsp;<span class="op" id="5431300">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431304">s</span><span class="op" id="5431305">.</span><span class="ident" id="5431306">TLS</span><span class="op" id="5431309">.</span><span class="ident" id="5431310">Certificates</span>&nbsp;<span class="op" id="5431323">=</span>&nbsp;<span class="op" id="5431325">[</span><span class="op" id="5431326">]</span><span class="ident" id="5431327">tls</span><span class="op" id="5431330">.</span><span class="ident" id="5431331">Certificate</span><span class="op" id="5431342">{</span><span class="ident" id="5431343">cert</span><span class="op" id="5431347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431353">tlsListener</span>&nbsp;<span class="op" id="5431365">:=</span>&nbsp;<span class="ident" id="5431368">tls</span><span class="op" id="5431371">.</span><span class="ident" id="5431372">NewListener</span><span class="op" id="5431383">(</span><span class="ident" id="5431384">s</span><span class="op" id="5431385">.</span><span class="ident" id="5431386">Listener</span><span class="op" id="5431394">,</span>&nbsp;<span class="ident" id="5431396">s</span><span class="op" id="5431397">.</span><span class="ident" id="5431398">TLS</span><span class="op" id="5431401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431405">s</span><span class="op" id="5431406">.</span><span class="ident" id="5431407">Listener</span>&nbsp;<span class="op" id="5431416">=</span>&nbsp;<span class="op" id="5431418">&amp;</span><span class="ident" id="5431419">historyListener</span><span class="op" id="5431434">{</span><span class="ident" id="5431435">Listener</span><span class="op" id="5431443">:</span>&nbsp;<span class="ident" id="5431445">tlsListener</span><span class="op" id="5431456">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431459">s</span><span class="op" id="5431460">.</span><span class="ident" id="5431461">URL</span>&nbsp;<span class="op" id="5431465">=</span>&nbsp;<span class="string" id="5431467">&#34;https://&#34;</span>&nbsp;<span class="op" id="5431478">+</span>&nbsp;<span class="ident" id="5431480">s</span><span class="op" id="5431481">.</span><span class="ident" id="5431482">Listener</span><span class="op" id="5431490">.</span><span class="ident" id="5431491">Addr</span><span class="op" id="5431495">(</span><span class="op" id="5431496">)</span><span class="op" id="5431497">.</span><span class="ident" id="5431498">String</span><span class="op" id="5431504">(</span><span class="op" id="5431505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431508">s</span><span class="op" id="5431509">.</span><span class="ident" id="5431510">wrapHandler</span><span class="op" id="5431521">(</span><span class="op" id="5431522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431525">go</span>&nbsp;<span class="ident" id="5431528">s</span><span class="op" id="5431529">.</span><span class="ident" id="5431530">Config</span><span class="op" id="5431536">.</span><span class="ident" id="5431537">Serve</span><span class="op" id="5431542">(</span><span class="ident" id="5431543">s</span><span class="op" id="5431544">.</span><span class="ident" id="5431545">Listener</span><span class="op" id="5431553">)</span><br>
<span class="lineno"></span><span class="op" id="5431555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5431558">func</span>&nbsp;<span class="op" id="5431563">(</span><span class="ident" id="5431564">s</span>&nbsp;<span class="op" id="5431566">*</span><span class="ident" id="5431567">Server</span><span class="op" id="5431573">)</span>&nbsp;<span class="ident" id="5431575">wrapHandler</span><span class="op" id="5431586">(</span><span class="op" id="5431587">)</span>&nbsp;<span class="op" id="5431589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431592">h</span>&nbsp;<span class="op" id="5431594">:=</span>&nbsp;<span class="ident" id="5431597">s</span><span class="op" id="5431598">.</span><span class="ident" id="5431599">Config</span><span class="op" id="5431605">.</span><span class="ident" id="5431606">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431615">if</span>&nbsp;<span class="ident" id="5431618">h</span>&nbsp;<span class="op" id="5431620">==</span>&nbsp;<span class="ident" id="5431623">nil</span>&nbsp;<span class="op" id="5431627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431631">h</span>&nbsp;<span class="op" id="5431633">=</span>&nbsp;<span class="ident" id="5431635">http</span><span class="op" id="5431639">.</span><span class="ident" id="5431640">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431657">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431660">s</span><span class="op" id="5431661">.</span><span class="ident" id="5431662">Config</span><span class="op" id="5431668">.</span><span class="ident" id="5431669">Handler</span>&nbsp;<span class="op" id="5431677">=</span>&nbsp;<span class="op" id="5431679">&amp;</span><span class="ident" id="5431680">waitGroupHandler</span><span class="op" id="5431696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431700">s</span><span class="op" id="5431701">:</span>&nbsp;<span class="ident" id="5431703">s</span><span class="op" id="5431704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431708">h</span><span class="op" id="5431709">:</span>&nbsp;<span class="ident" id="5431711">h</span><span class="op" id="5431712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5431715">}</span><br>
<span class="lineno"></span><span class="op" id="5431717">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5431720">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="5431779">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5431843">func</span>&nbsp;<span class="ident" id="5431848">NewTLSServer</span><span class="op" id="5431860">(</span><span class="ident" id="5431861">handler</span>&nbsp;<span class="ident" id="5431869">http</span><span class="op" id="5431873">.</span><span class="ident" id="5431874">Handler</span><span class="op" id="5431881">)</span>&nbsp;<span class="op" id="5431883">*</span><span class="ident" id="5431884">Server</span>&nbsp;<span class="op" id="5431891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431894">ts</span>&nbsp;<span class="op" id="5431897">:=</span>&nbsp;<span class="ident" id="5431900">NewUnstartedServer</span><span class="op" id="5431918">(</span><span class="ident" id="5431919">handler</span><span class="op" id="5431926">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5431929">ts</span><span class="op" id="5431931">.</span><span class="ident" id="5431932">StartTLS</span><span class="op" id="5431940">(</span><span class="op" id="5431941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5431944">return</span>&nbsp;<span class="ident" id="5431951">ts</span><br>
<span class="lineno"></span><span class="op" id="5431954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5431957">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="5432021">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5432064">func</span>&nbsp;<span class="op" id="5432069">(</span><span class="ident" id="5432070">s</span>&nbsp;<span class="op" id="5432072">*</span><span class="ident" id="5432073">Server</span><span class="op" id="5432079">)</span>&nbsp;<span class="ident" id="5432081">Close</span><span class="op" id="5432086">(</span><span class="op" id="5432087">)</span>&nbsp;<span class="op" id="5432089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432092">s</span><span class="op" id="5432093">.</span><span class="ident" id="5432094">Listener</span><span class="op" id="5432102">.</span><span class="ident" id="5432103">Close</span><span class="op" id="5432108">(</span><span class="op" id="5432109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432112">s</span><span class="op" id="5432113">.</span><span class="ident" id="5432114">wg</span><span class="op" id="5432116">.</span><span class="ident" id="5432117">Wait</span><span class="op" id="5432121">(</span><span class="op" id="5432122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432125">s</span><span class="op" id="5432126">.</span><span class="ident" id="5432127">CloseClientConnections</span><span class="op" id="5432149">(</span><span class="op" id="5432150">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5432153">if</span>&nbsp;<span class="ident" id="5432156">t</span><span class="op" id="5432157">,</span>&nbsp;<span class="ident" id="5432159">ok</span>&nbsp;<span class="op" id="5432162">:=</span>&nbsp;<span class="ident" id="5432165">http</span><span class="op" id="5432169">.</span><span class="ident" id="5432170">DefaultTransport</span><span class="op" id="5432186">.</span><span class="op" id="5432187">(</span><span class="op" id="5432188">*</span><span class="ident" id="5432189">http</span><span class="op" id="5432193">.</span><span class="ident" id="5432194">Transport</span><span class="op" id="5432203">)</span><span class="op" id="5432204">;</span>&nbsp;<span class="ident" id="5432206">ok</span>&nbsp;<span class="op" id="5432209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432213">t</span><span class="op" id="5432214">.</span><span class="ident" id="5432215">CloseIdleConnections</span><span class="op" id="5432235">(</span><span class="op" id="5432236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5432239">}</span><br>
<span class="lineno"></span><span class="op" id="5432241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5432244">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="5432313">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5432336">func</span>&nbsp;<span class="op" id="5432341">(</span><span class="ident" id="5432342">s</span>&nbsp;<span class="op" id="5432344">*</span><span class="ident" id="5432345">Server</span><span class="op" id="5432351">)</span>&nbsp;<span class="ident" id="5432353">CloseClientConnections</span><span class="op" id="5432375">(</span><span class="op" id="5432376">)</span>&nbsp;<span class="op" id="5432378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432381">hl</span><span class="op" id="5432383">,</span>&nbsp;<span class="ident" id="5432385">ok</span>&nbsp;<span class="op" id="5432388">:=</span>&nbsp;<span class="ident" id="5432391">s</span><span class="op" id="5432392">.</span><span class="ident" id="5432393">Listener</span><span class="op" id="5432401">.</span><span class="op" id="5432402">(</span><span class="op" id="5432403">*</span><span class="ident" id="5432404">historyListener</span><span class="op" id="5432419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5432422">if</span>&nbsp;<span class="op" id="5432425">!</span><span class="ident" id="5432426">ok</span>&nbsp;<span class="op" id="5432429">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5432433">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5432441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432444">hl</span><span class="op" id="5432446">.</span><span class="ident" id="5432447">Lock</span><span class="op" id="5432451">(</span><span class="op" id="5432452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5432455">for</span>&nbsp;<span class="ident" id="5432459">_</span><span class="op" id="5432460">,</span>&nbsp;<span class="ident" id="5432462">conn</span>&nbsp;<span class="op" id="5432467">:=</span>&nbsp;<span class="keyword" id="5432470">range</span>&nbsp;<span class="ident" id="5432476">hl</span><span class="op" id="5432478">.</span><span class="ident" id="5432479">history</span>&nbsp;<span class="op" id="5432487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432491">conn</span><span class="op" id="5432495">.</span><span class="ident" id="5432496">Close</span><span class="op" id="5432501">(</span><span class="op" id="5432502">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5432505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432508">hl</span><span class="op" id="5432510">.</span><span class="ident" id="5432511">Unlock</span><span class="op" id="5432517">(</span><span class="op" id="5432518">)</span><br>
<span class="lineno"></span><span class="op" id="5432520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5432523">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="5432592">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="5432659">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="5432703">type</span>&nbsp;<span class="ident" id="5432708">waitGroupHandler</span>&nbsp;<span class="keyword" id="5432725">struct</span>&nbsp;<span class="op" id="5432732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432735">s</span>&nbsp;<span class="op" id="5432737">*</span><span class="ident" id="5432738">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432746">h</span>&nbsp;<span class="ident" id="5432748">http</span><span class="op" id="5432752">.</span><span class="ident" id="5432753">Handler</span>&nbsp;<span class="comment" id="5432761">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="5432772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5432775">func</span>&nbsp;<span class="op" id="5432780">(</span><span class="ident" id="5432781">h</span>&nbsp;<span class="op" id="5432783">*</span><span class="ident" id="5432784">waitGroupHandler</span><span class="op" id="5432800">)</span>&nbsp;<span class="ident" id="5432802">ServeHTTP</span><span class="op" id="5432811">(</span><span class="ident" id="5432812">w</span>&nbsp;<span class="ident" id="5432814">http</span><span class="op" id="5432818">.</span><span class="ident" id="5432819">ResponseWriter</span><span class="op" id="5432833">,</span>&nbsp;<span class="ident" id="5432835">r</span>&nbsp;<span class="op" id="5432837">*</span><span class="ident" id="5432838">http</span><span class="op" id="5432842">.</span><span class="ident" id="5432843">Request</span><span class="op" id="5432850">)</span>&nbsp;<span class="op" id="5432852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432855">h</span><span class="op" id="5432856">.</span><span class="ident" id="5432857">s</span><span class="op" id="5432858">.</span><span class="ident" id="5432859">wg</span><span class="op" id="5432861">.</span><span class="ident" id="5432862">Add</span><span class="op" id="5432865">(</span><span class="num" id="5432866">1</span><span class="op" id="5432867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5432870">defer</span>&nbsp;<span class="ident" id="5432876">h</span><span class="op" id="5432877">.</span><span class="ident" id="5432878">s</span><span class="op" id="5432879">.</span><span class="ident" id="5432880">wg</span><span class="op" id="5432882">.</span><span class="ident" id="5432883">Done</span><span class="op" id="5432887">(</span><span class="op" id="5432888">)</span>&nbsp;<span class="comment" id="5432890">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5432934">h</span><span class="op" id="5432935">.</span><span class="ident" id="5432936">h</span><span class="op" id="5432937">.</span><span class="ident" id="5432938">ServeHTTP</span><span class="op" id="5432947">(</span><span class="ident" id="5432948">w</span><span class="op" id="5432949">,</span>&nbsp;<span class="ident" id="5432951">r</span><span class="op" id="5432952">)</span><br>
<span class="lineno"></span><span class="op" id="5432954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5432957">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="5433013">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="5433086">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="5433105">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="5433139">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="5433275">var</span>&nbsp;<span class="ident" id="5433279">localhostCert</span>&nbsp;<span class="op" id="5433293">=</span>&nbsp;<span class="op" id="5433295">[</span><span class="op" id="5433296">]</span><span class="builtintype" id="5433297">byte</span><span class="op" id="5433301">(</span><span class="string" id="5433302">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="5433873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5433876">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="5433930">var</span>&nbsp;<span class="ident" id="5433934">localhostKey</span>&nbsp;<span class="op" id="5433947">=</span>&nbsp;<span class="op" id="5433949">[</span><span class="op" id="5433950">]</span><span class="builtintype" id="5433951">byte</span><span class="op" id="5433955">(</span><span class="string" id="5433956">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="5434454">)</span>
</div>
</body>
</html>
