<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6229223">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6229278">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6229332">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6229383">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6229457">package</span>&nbsp;<span class="ident" id="6229465">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6229473">import</span>&nbsp;<span class="op" id="6229480">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229483">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229492">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229502">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229512">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229524">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229530">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229543">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229549">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6229566">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="6229576">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6229579">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="6229646">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6229714">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="6229771">//</span><br>
<span class="lineno">25</span><span class="keyword" id="6229774">func</span>&nbsp;<span class="ident" id="6229779">readSource</span><span class="op" id="6229789">(</span><span class="ident" id="6229790">filename</span>&nbsp;<span class="builtintype" id="6229799">string</span><span class="op" id="6229805">,</span>&nbsp;<span class="ident" id="6229807">src</span>&nbsp;<span class="keyword" id="6229811">interface</span><span class="op" id="6229820">{</span><span class="op" id="6229821">}</span><span class="op" id="6229822">)</span>&nbsp;<span class="op" id="6229824">(</span><span class="op" id="6229825">[</span><span class="op" id="6229826">]</span><span class="builtintype" id="6229827">byte</span><span class="op" id="6229831">,</span>&nbsp;<span class="builtintype" id="6229833">error</span><span class="op" id="6229838">)</span>&nbsp;<span class="op" id="6229840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229843">if</span>&nbsp;<span class="ident" id="6229846">src</span>&nbsp;<span class="op" id="6229850">!=</span>&nbsp;<span class="ident" id="6229853">nil</span>&nbsp;<span class="op" id="6229857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229861">switch</span>&nbsp;<span class="ident" id="6229868">s</span>&nbsp;<span class="op" id="6229870">:=</span>&nbsp;<span class="ident" id="6229873">src</span><span class="op" id="6229876">.</span><span class="op" id="6229877">(</span><span class="keyword" id="6229878">type</span><span class="op" id="6229882">)</span>&nbsp;<span class="op" id="6229884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229888">case</span>&nbsp;<span class="builtintype" id="6229893">string</span><span class="op" id="6229899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229904">return</span>&nbsp;<span class="op" id="6229911">[</span><span class="op" id="6229912">]</span><span class="builtintype" id="6229913">byte</span><span class="op" id="6229917">(</span><span class="ident" id="6229918">s</span><span class="op" id="6229919">)</span><span class="op" id="6229920">,</span>&nbsp;<span class="ident" id="6229922">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229928">case</span>&nbsp;<span class="op" id="6229933">[</span><span class="op" id="6229934">]</span><span class="builtintype" id="6229935">byte</span><span class="op" id="6229939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229944">return</span>&nbsp;<span class="ident" id="6229951">s</span><span class="op" id="6229952">,</span>&nbsp;<span class="ident" id="6229954">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229960">case</span>&nbsp;<span class="op" id="6229965">*</span><span class="ident" id="6229966">bytes</span><span class="op" id="6229971">.</span><span class="ident" id="6229972">Buffer</span><span class="op" id="6229978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6229983">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230047">if</span>&nbsp;<span class="ident" id="6230050">s</span>&nbsp;<span class="op" id="6230052">!=</span>&nbsp;<span class="ident" id="6230055">nil</span>&nbsp;<span class="op" id="6230059">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230065">return</span>&nbsp;<span class="ident" id="6230072">s</span><span class="op" id="6230073">.</span><span class="ident" id="6230074">Bytes</span><span class="op" id="6230079">(</span><span class="op" id="6230080">)</span><span class="op" id="6230081">,</span>&nbsp;<span class="ident" id="6230083">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230094">case</span>&nbsp;<span class="ident" id="6230099">io</span><span class="op" id="6230101">.</span><span class="ident" id="6230102">Reader</span><span class="op" id="6230108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230113">var</span>&nbsp;<span class="ident" id="6230117">buf</span>&nbsp;<span class="ident" id="6230121">bytes</span><span class="op" id="6230126">.</span><span class="ident" id="6230127">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230137">if</span>&nbsp;<span class="ident" id="6230140">_</span><span class="op" id="6230141">,</span>&nbsp;<span class="ident" id="6230143">err</span>&nbsp;<span class="op" id="6230147">:=</span>&nbsp;<span class="ident" id="6230150">io</span><span class="op" id="6230152">.</span><span class="ident" id="6230153">Copy</span><span class="op" id="6230157">(</span><span class="op" id="6230158">&amp;</span><span class="ident" id="6230159">buf</span><span class="op" id="6230162">,</span>&nbsp;<span class="ident" id="6230164">s</span><span class="op" id="6230165">)</span><span class="op" id="6230166">;</span>&nbsp;<span class="ident" id="6230168">err</span>&nbsp;<span class="op" id="6230172">!=</span>&nbsp;<span class="ident" id="6230175">nil</span>&nbsp;<span class="op" id="6230179">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230185">return</span>&nbsp;<span class="ident" id="6230192">nil</span><span class="op" id="6230195">,</span>&nbsp;<span class="ident" id="6230197">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230209">return</span>&nbsp;<span class="ident" id="6230216">buf</span><span class="op" id="6230219">.</span><span class="ident" id="6230220">Bytes</span><span class="op" id="6230225">(</span><span class="op" id="6230226">)</span><span class="op" id="6230227">,</span>&nbsp;<span class="ident" id="6230229">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230239">return</span>&nbsp;<span class="ident" id="6230246">nil</span><span class="op" id="6230249">,</span>&nbsp;<span class="ident" id="6230251">errors</span><span class="op" id="6230257">.</span><span class="ident" id="6230258">New</span><span class="op" id="6230261">(</span><span class="string" id="6230262">&#34;invalid&nbsp;source&#34;</span><span class="op" id="6230278">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230284">return</span>&nbsp;<span class="ident" id="6230291">ioutil</span><span class="op" id="6230297">.</span><span class="ident" id="6230298">ReadFile</span><span class="op" id="6230306">(</span><span class="ident" id="6230307">filename</span><span class="op" id="6230315">)</span><br>
<span class="lineno"></span><span class="op" id="6230317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6230320">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="6230362">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="6230430">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="6230455">//</span><br>
<span class="lineno"></span><span class="keyword" id="6230458">type</span>&nbsp;<span class="ident" id="6230463">Mode</span>&nbsp;<span class="builtintype" id="6230468">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="6230474">const</span>&nbsp;<span class="op" id="6230480">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230483">PackageClauseOnly</span>&nbsp;<span class="ident" id="6230501">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230518">=</span>&nbsp;<span class="num" id="6230520">1</span>&nbsp;<span class="op" id="6230522">&lt;&lt;</span>&nbsp;<span class="ident" id="6230525">iota</span>&nbsp;<span class="comment" id="6230530">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230568">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6230615">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230658">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6230705">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230744">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6230791">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230831">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6230878">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230908">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6230955">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231005">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6231023">=</span>&nbsp;<span class="ident" id="6231025">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6231052">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="6231116">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="6231119">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6231194">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="6231266">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="6231328">//</span><br>
<span class="lineno"></span><span class="comment" id="6231331">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="6231406">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="6231481">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="6231544">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="6231611">//</span><br>
<span class="lineno"></span><span class="comment" id="6231614">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="6231688">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6231762">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="6231780">//</span><br>
<span class="lineno"></span><span class="comment" id="6231783">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6231856">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="6231925">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="6231996">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="6232069">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="6232143">//</span><br>
<span class="lineno"></span><span class="keyword" id="6232146">func</span>&nbsp;<span class="ident" id="6232151">ParseFile</span><span class="op" id="6232160">(</span><span class="ident" id="6232161">fset</span>&nbsp;<span class="op" id="6232166">*</span><span class="ident" id="6232167">token</span><span class="op" id="6232172">.</span><span class="ident" id="6232173">FileSet</span><span class="op" id="6232180">,</span>&nbsp;<span class="ident" id="6232182">filename</span>&nbsp;<span class="builtintype" id="6232191">string</span><span class="op" id="6232197">,</span>&nbsp;<span class="ident" id="6232199">src</span>&nbsp;<span class="keyword" id="6232203">interface</span><span class="op" id="6232212">{</span><span class="op" id="6232213">}</span><span class="op" id="6232214">,</span>&nbsp;<span class="ident" id="6232216">mode</span>&nbsp;<span class="ident" id="6232221">Mode</span><span class="op" id="6232225">)</span>&nbsp;<span class="op" id="6232227">(</span><span class="ident" id="6232228">f</span>&nbsp;<span class="op" id="6232230">*</span><span class="ident" id="6232231">ast</span><span class="op" id="6232234">.</span><span class="ident" id="6232235">File</span><span class="op" id="6232239">,</span>&nbsp;<span class="ident" id="6232241">err</span>&nbsp;<span class="builtintype" id="6232245">error</span><span class="op" id="6232250">)</span>&nbsp;<span class="op" id="6232252">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232255">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232270">text</span><span class="op" id="6232274">,</span>&nbsp;<span class="ident" id="6232276">err</span>&nbsp;<span class="op" id="6232280">:=</span>&nbsp;<span class="ident" id="6232283">readSource</span><span class="op" id="6232293">(</span><span class="ident" id="6232294">filename</span><span class="op" id="6232302">,</span>&nbsp;<span class="ident" id="6232304">src</span><span class="op" id="6232307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232310">if</span>&nbsp;<span class="ident" id="6232313">err</span>&nbsp;<span class="op" id="6232317">!=</span>&nbsp;<span class="ident" id="6232320">nil</span>&nbsp;<span class="op" id="6232324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232328">return</span>&nbsp;<span class="ident" id="6232335">nil</span><span class="op" id="6232338">,</span>&nbsp;<span class="ident" id="6232340">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6232345">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232349">var</span>&nbsp;<span class="ident" id="6232353">p</span>&nbsp;<span class="ident" id="6232355">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232363">defer</span>&nbsp;<span class="keyword" id="6232369">func</span><span class="op" id="6232373">(</span><span class="op" id="6232374">)</span>&nbsp;<span class="op" id="6232376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232380">if</span>&nbsp;<span class="ident" id="6232383">e</span>&nbsp;<span class="op" id="6232385">:=</span>&nbsp;<span class="builtinfunc" id="6232388">recover</span><span class="op" id="6232395">(</span><span class="op" id="6232396">)</span><span class="op" id="6232397">;</span>&nbsp;<span class="ident" id="6232399">e</span>&nbsp;<span class="op" id="6232401">!=</span>&nbsp;<span class="ident" id="6232404">nil</span>&nbsp;<span class="op" id="6232408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232413">_</span>&nbsp;<span class="op" id="6232415">=</span>&nbsp;<span class="ident" id="6232417">e</span><span class="op" id="6232418">.</span><span class="op" id="6232419">(</span><span class="ident" id="6232420">bailout</span><span class="op" id="6232427">)</span>&nbsp;<span class="comment" id="6232429">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6232466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232471">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232494">if</span>&nbsp;<span class="ident" id="6232497">f</span>&nbsp;<span class="op" id="6232499">==</span>&nbsp;<span class="ident" id="6232502">nil</span>&nbsp;<span class="op" id="6232506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232511">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232564">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232615">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232631">f</span>&nbsp;<span class="op" id="6232633">=</span>&nbsp;<span class="op" id="6232635">&amp;</span><span class="ident" id="6232636">ast</span><span class="op" id="6232639">.</span><span class="ident" id="6232640">File</span><span class="op" id="6232644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232650">Name</span><span class="op" id="6232654">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6232657">new</span><span class="op" id="6232660">(</span><span class="ident" id="6232661">ast</span><span class="op" id="6232664">.</span><span class="ident" id="6232665">Ident</span><span class="op" id="6232670">)</span><span class="op" id="6232671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232677">Scope</span><span class="op" id="6232682">:</span>&nbsp;<span class="ident" id="6232684">ast</span><span class="op" id="6232687">.</span><span class="ident" id="6232688">NewScope</span><span class="op" id="6232696">(</span><span class="ident" id="6232697">nil</span><span class="op" id="6232700">)</span><span class="op" id="6232701">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6232706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6232710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232715">p</span><span class="op" id="6232716">.</span><span class="ident" id="6232717">errors</span><span class="op" id="6232723">.</span><span class="ident" id="6232724">Sort</span><span class="op" id="6232728">(</span><span class="op" id="6232729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232733">err</span>&nbsp;<span class="op" id="6232737">=</span>&nbsp;<span class="ident" id="6232739">p</span><span class="op" id="6232740">.</span><span class="ident" id="6232741">errors</span><span class="op" id="6232747">.</span><span class="ident" id="6232748">Err</span><span class="op" id="6232751">(</span><span class="op" id="6232752">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6232755">}</span><span class="op" id="6232756">(</span><span class="op" id="6232757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232761">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232778">p</span><span class="op" id="6232779">.</span><span class="ident" id="6232780">init</span><span class="op" id="6232784">(</span><span class="ident" id="6232785">fset</span><span class="op" id="6232789">,</span>&nbsp;<span class="ident" id="6232791">filename</span><span class="op" id="6232799">,</span>&nbsp;<span class="ident" id="6232801">text</span><span class="op" id="6232805">,</span>&nbsp;<span class="ident" id="6232807">mode</span><span class="op" id="6232811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232814">f</span>&nbsp;<span class="op" id="6232816">=</span>&nbsp;<span class="ident" id="6232818">p</span><span class="op" id="6232819">.</span><span class="ident" id="6232820">parseFile</span><span class="op" id="6232829">(</span><span class="op" id="6232830">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232834">return</span><br>
<span class="lineno"></span><span class="op" id="6232841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6232844">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="6232920">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="6232996">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="6233032">//</span><br>
<span class="lineno"></span><span class="comment" id="6233035">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="6233112">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="6233189">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="6233258">//</span><br>
<span class="lineno"></span><span class="comment" id="6233261">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="6233338">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6233415">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="6233456">//</span><br>
<span class="lineno"></span><span class="keyword" id="6233459">func</span>&nbsp;<span class="ident" id="6233464">ParseDir</span><span class="op" id="6233472">(</span><span class="ident" id="6233473">fset</span>&nbsp;<span class="op" id="6233478">*</span><span class="ident" id="6233479">token</span><span class="op" id="6233484">.</span><span class="ident" id="6233485">FileSet</span><span class="op" id="6233492">,</span>&nbsp;<span class="ident" id="6233494">path</span>&nbsp;<span class="builtintype" id="6233499">string</span><span class="op" id="6233505">,</span>&nbsp;<span class="ident" id="6233507">filter</span>&nbsp;<span class="keyword" id="6233514">func</span><span class="op" id="6233518">(</span><span class="ident" id="6233519">os</span><span class="op" id="6233521">.</span><span class="ident" id="6233522">FileInfo</span><span class="op" id="6233530">)</span>&nbsp;<span class="builtintype" id="6233532">bool</span><span class="op" id="6233536">,</span>&nbsp;<span class="ident" id="6233538">mode</span>&nbsp;<span class="ident" id="6233543">Mode</span><span class="op" id="6233547">)</span>&nbsp;<span class="op" id="6233549">(</span><span class="ident" id="6233550">pkgs</span>&nbsp;<span class="keyword" id="6233555">map</span><span class="op" id="6233558">[</span><span class="builtintype" id="6233559">string</span><span class="op" id="6233565">]</span><span class="op" id="6233566">*</span><span class="ident" id="6233567">ast</span><span class="op" id="6233570">.</span><span class="ident" id="6233571">Package</span><span class="op" id="6233578">,</span>&nbsp;<span class="ident" id="6233580">first</span>&nbsp;<span class="builtintype" id="6233586">error</span><span class="op" id="6233591">)</span>&nbsp;<span class="op" id="6233593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233596">fd</span><span class="op" id="6233598">,</span>&nbsp;<span class="ident" id="6233600">err</span>&nbsp;<span class="op" id="6233604">:=</span>&nbsp;<span class="ident" id="6233607">os</span><span class="op" id="6233609">.</span><span class="ident" id="6233610">Open</span><span class="op" id="6233614">(</span><span class="ident" id="6233615">path</span><span class="op" id="6233619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233622">if</span>&nbsp;<span class="ident" id="6233625">err</span>&nbsp;<span class="op" id="6233629">!=</span>&nbsp;<span class="ident" id="6233632">nil</span>&nbsp;<span class="op" id="6233636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233640">return</span>&nbsp;<span class="ident" id="6233647">nil</span><span class="op" id="6233650">,</span>&nbsp;<span class="ident" id="6233652">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233660">defer</span>&nbsp;<span class="ident" id="6233666">fd</span><span class="op" id="6233668">.</span><span class="ident" id="6233669">Close</span><span class="op" id="6233674">(</span><span class="op" id="6233675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233679">list</span><span class="op" id="6233683">,</span>&nbsp;<span class="ident" id="6233685">err</span>&nbsp;<span class="op" id="6233689">:=</span>&nbsp;<span class="ident" id="6233692">fd</span><span class="op" id="6233694">.</span><span class="ident" id="6233695">Readdir</span><span class="op" id="6233702">(</span><span class="op" id="6233703">-</span><span class="num" id="6233704">1</span><span class="op" id="6233705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233708">if</span>&nbsp;<span class="ident" id="6233711">err</span>&nbsp;<span class="op" id="6233715">!=</span>&nbsp;<span class="ident" id="6233718">nil</span>&nbsp;<span class="op" id="6233722">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233726">return</span>&nbsp;<span class="ident" id="6233733">nil</span><span class="op" id="6233736">,</span>&nbsp;<span class="ident" id="6233738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233747">pkgs</span>&nbsp;<span class="op" id="6233752">=</span>&nbsp;<span class="builtinfunc" id="6233754">make</span><span class="op" id="6233758">(</span><span class="keyword" id="6233759">map</span><span class="op" id="6233762">[</span><span class="builtintype" id="6233763">string</span><span class="op" id="6233769">]</span><span class="op" id="6233770">*</span><span class="ident" id="6233771">ast</span><span class="op" id="6233774">.</span><span class="ident" id="6233775">Package</span><span class="op" id="6233782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233785">for</span>&nbsp;<span class="ident" id="6233789">_</span><span class="op" id="6233790">,</span>&nbsp;<span class="ident" id="6233792">d</span>&nbsp;<span class="op" id="6233794">:=</span>&nbsp;<span class="keyword" id="6233797">range</span>&nbsp;<span class="ident" id="6233803">list</span>&nbsp;<span class="op" id="6233808">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233812">if</span>&nbsp;<span class="ident" id="6233815">strings</span><span class="op" id="6233822">.</span><span class="ident" id="6233823">HasSuffix</span><span class="op" id="6233832">(</span><span class="ident" id="6233833">d</span><span class="op" id="6233834">.</span><span class="ident" id="6233835">Name</span><span class="op" id="6233839">(</span><span class="op" id="6233840">)</span><span class="op" id="6233841">,</span>&nbsp;<span class="string" id="6233843">&#34;.go&#34;</span><span class="op" id="6233848">)</span>&nbsp;<span class="op" id="6233850">&amp;&amp;</span>&nbsp;<span class="op" id="6233853">(</span><span class="ident" id="6233854">filter</span>&nbsp;<span class="op" id="6233861">==</span>&nbsp;<span class="ident" id="6233864">nil</span>&nbsp;<span class="op" id="6233868">||</span>&nbsp;<span class="ident" id="6233871">filter</span><span class="op" id="6233877">(</span><span class="ident" id="6233878">d</span><span class="op" id="6233879">)</span><span class="op" id="6233880">)</span>&nbsp;<span class="op" id="6233882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233887">filename</span>&nbsp;<span class="op" id="6233896">:=</span>&nbsp;<span class="ident" id="6233899">filepath</span><span class="op" id="6233907">.</span><span class="ident" id="6233908">Join</span><span class="op" id="6233912">(</span><span class="ident" id="6233913">path</span><span class="op" id="6233917">,</span>&nbsp;<span class="ident" id="6233919">d</span><span class="op" id="6233920">.</span><span class="ident" id="6233921">Name</span><span class="op" id="6233925">(</span><span class="op" id="6233926">)</span><span class="op" id="6233927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233932">if</span>&nbsp;<span class="ident" id="6233935">src</span><span class="op" id="6233938">,</span>&nbsp;<span class="ident" id="6233940">err</span>&nbsp;<span class="op" id="6233944">:=</span>&nbsp;<span class="ident" id="6233947">ParseFile</span><span class="op" id="6233956">(</span><span class="ident" id="6233957">fset</span><span class="op" id="6233961">,</span>&nbsp;<span class="ident" id="6233963">filename</span><span class="op" id="6233971">,</span>&nbsp;<span class="ident" id="6233973">nil</span><span class="op" id="6233976">,</span>&nbsp;<span class="ident" id="6233978">mode</span><span class="op" id="6233982">)</span><span class="op" id="6233983">;</span>&nbsp;<span class="ident" id="6233985">err</span>&nbsp;<span class="op" id="6233989">==</span>&nbsp;<span class="ident" id="6233992">nil</span>&nbsp;<span class="op" id="6233996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234002">name</span>&nbsp;<span class="op" id="6234007">:=</span>&nbsp;<span class="ident" id="6234010">src</span><span class="op" id="6234013">.</span><span class="ident" id="6234014">Name</span><span class="op" id="6234018">.</span><span class="ident" id="6234019">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234028">pkg</span><span class="op" id="6234031">,</span>&nbsp;<span class="ident" id="6234033">found</span>&nbsp;<span class="op" id="6234039">:=</span>&nbsp;<span class="ident" id="6234042">pkgs</span><span class="op" id="6234046">[</span><span class="ident" id="6234047">name</span><span class="op" id="6234051">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6234057">if</span>&nbsp;<span class="op" id="6234060">!</span><span class="ident" id="6234061">found</span>&nbsp;<span class="op" id="6234067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234074">pkg</span>&nbsp;<span class="op" id="6234078">=</span>&nbsp;<span class="op" id="6234080">&amp;</span><span class="ident" id="6234081">ast</span><span class="op" id="6234084">.</span><span class="ident" id="6234085">Package</span><span class="op" id="6234092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234100">Name</span><span class="op" id="6234104">:</span>&nbsp;&nbsp;<span class="ident" id="6234107">name</span><span class="op" id="6234111">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234119">Files</span><span class="op" id="6234124">:</span>&nbsp;<span class="builtinfunc" id="6234126">make</span><span class="op" id="6234130">(</span><span class="keyword" id="6234131">map</span><span class="op" id="6234134">[</span><span class="builtintype" id="6234135">string</span><span class="op" id="6234141">]</span><span class="op" id="6234142">*</span><span class="ident" id="6234143">ast</span><span class="op" id="6234146">.</span><span class="ident" id="6234147">File</span><span class="op" id="6234151">)</span><span class="op" id="6234152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6234159">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234166">pkgs</span><span class="op" id="6234170">[</span><span class="ident" id="6234171">name</span><span class="op" id="6234175">]</span>&nbsp;<span class="op" id="6234177">=</span>&nbsp;<span class="ident" id="6234179">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6234187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234193">pkg</span><span class="op" id="6234196">.</span><span class="ident" id="6234197">Files</span><span class="op" id="6234202">[</span><span class="ident" id="6234203">filename</span><span class="op" id="6234211">]</span>&nbsp;<span class="op" id="6234213">=</span>&nbsp;<span class="ident" id="6234215">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6234222">}</span>&nbsp;<span class="keyword" id="6234224">else</span>&nbsp;<span class="keyword" id="6234229">if</span>&nbsp;<span class="ident" id="6234232">first</span>&nbsp;<span class="op" id="6234238">==</span>&nbsp;<span class="ident" id="6234241">nil</span>&nbsp;<span class="op" id="6234245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234251">first</span>&nbsp;<span class="op" id="6234257">=</span>&nbsp;<span class="ident" id="6234259">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6234266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6234270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6234273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6234277">return</span><br>
<span class="lineno">165</span><span class="op" id="6234284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6234287">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="6234368">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="6234448">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="6234490">//</span><br>
<span class="lineno"></span><span class="keyword" id="6234493">func</span>&nbsp;<span class="ident" id="6234498">ParseExpr</span><span class="op" id="6234507">(</span><span class="ident" id="6234508">x</span>&nbsp;<span class="builtintype" id="6234510">string</span><span class="op" id="6234516">)</span>&nbsp;<span class="op" id="6234518">(</span><span class="ident" id="6234519">ast</span><span class="op" id="6234522">.</span><span class="ident" id="6234523">Expr</span><span class="op" id="6234527">,</span>&nbsp;<span class="builtintype" id="6234529">error</span><span class="op" id="6234534">)</span>&nbsp;<span class="op" id="6234536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6234539">var</span>&nbsp;<span class="ident" id="6234543">p</span>&nbsp;<span class="ident" id="6234545">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234553">p</span><span class="op" id="6234554">.</span><span class="ident" id="6234555">init</span><span class="op" id="6234559">(</span><span class="ident" id="6234560">token</span><span class="op" id="6234565">.</span><span class="ident" id="6234566">NewFileSet</span><span class="op" id="6234576">(</span><span class="op" id="6234577">)</span><span class="op" id="6234578">,</span>&nbsp;<span class="string" id="6234580">&#34;&#34;</span><span class="op" id="6234582">,</span>&nbsp;<span class="op" id="6234584">[</span><span class="op" id="6234585">]</span><span class="builtintype" id="6234586">byte</span><span class="op" id="6234590">(</span><span class="ident" id="6234591">x</span><span class="op" id="6234592">)</span><span class="op" id="6234593">,</span>&nbsp;<span class="num" id="6234595">0</span><span class="op" id="6234596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6234600">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6234657">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6234714">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6234773">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234804">p</span><span class="op" id="6234805">.</span><span class="ident" id="6234806">openScope</span><span class="op" id="6234815">(</span><span class="op" id="6234816">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234819">p</span><span class="op" id="6234820">.</span><span class="ident" id="6234821">pkgScope</span>&nbsp;<span class="op" id="6234830">=</span>&nbsp;<span class="ident" id="6234832">p</span><span class="op" id="6234833">.</span><span class="ident" id="6234834">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234844">e</span>&nbsp;<span class="op" id="6234846">:=</span>&nbsp;<span class="ident" id="6234849">p</span><span class="op" id="6234850">.</span><span class="ident" id="6234851">parseRhsOrType</span><span class="op" id="6234865">(</span><span class="op" id="6234866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234869">p</span><span class="op" id="6234870">.</span><span class="ident" id="6234871">closeScope</span><span class="op" id="6234881">(</span><span class="op" id="6234882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6234885">assert</span><span class="op" id="6234891">(</span><span class="ident" id="6234892">p</span><span class="op" id="6234893">.</span><span class="ident" id="6234894">topScope</span>&nbsp;<span class="op" id="6234903">==</span>&nbsp;<span class="ident" id="6234906">nil</span><span class="op" id="6234909">,</span>&nbsp;<span class="string" id="6234911">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="6234930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6234934">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6234979">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6235023">if</span>&nbsp;<span class="ident" id="6235026">p</span><span class="op" id="6235027">.</span><span class="ident" id="6235028">tok</span>&nbsp;<span class="op" id="6235032">==</span>&nbsp;<span class="ident" id="6235035">token</span><span class="op" id="6235040">.</span><span class="ident" id="6235041">SEMICOLON</span>&nbsp;<span class="op" id="6235051">&amp;&amp;</span>&nbsp;<span class="ident" id="6235054">p</span><span class="op" id="6235055">.</span><span class="ident" id="6235056">lit</span>&nbsp;<span class="op" id="6235060">==</span>&nbsp;<span class="string" id="6235063">&#34;\n&#34;</span>&nbsp;<span class="op" id="6235068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6235072">p</span><span class="op" id="6235073">.</span><span class="ident" id="6235074">next</span><span class="op" id="6235078">(</span><span class="op" id="6235079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6235082">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6235085">p</span><span class="op" id="6235086">.</span><span class="ident" id="6235087">expect</span><span class="op" id="6235093">(</span><span class="ident" id="6235094">token</span><span class="op" id="6235099">.</span><span class="ident" id="6235100">EOF</span><span class="op" id="6235103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6235107">if</span>&nbsp;<span class="ident" id="6235110">p</span><span class="op" id="6235111">.</span><span class="ident" id="6235112">errors</span><span class="op" id="6235118">.</span><span class="ident" id="6235119">Len</span><span class="op" id="6235122">(</span><span class="op" id="6235123">)</span>&nbsp;<span class="op" id="6235125">&gt;</span>&nbsp;<span class="num" id="6235127">0</span>&nbsp;<span class="op" id="6235129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6235133">p</span><span class="op" id="6235134">.</span><span class="ident" id="6235135">errors</span><span class="op" id="6235141">.</span><span class="ident" id="6235142">Sort</span><span class="op" id="6235146">(</span><span class="op" id="6235147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6235151">return</span>&nbsp;<span class="ident" id="6235158">nil</span><span class="op" id="6235161">,</span>&nbsp;<span class="ident" id="6235163">p</span><span class="op" id="6235164">.</span><span class="ident" id="6235165">errors</span><span class="op" id="6235171">.</span><span class="ident" id="6235172">Err</span><span class="op" id="6235175">(</span><span class="op" id="6235176">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6235179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6235183">return</span>&nbsp;<span class="ident" id="6235190">e</span><span class="op" id="6235191">,</span>&nbsp;<span class="ident" id="6235193">nil</span><br>
<span class="lineno"></span><span class="op" id="6235197">}</span>
</div>
</body>
</html>
