<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6809033">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6809088">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6809142">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6809193">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6809226">package</span>&nbsp;<span class="ident" id="6809234">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6809242">import</span>&nbsp;<span class="op" id="6809249">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809252">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809261">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809268">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809274">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809287">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809294">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809301">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809307">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809315">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6809326">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6809333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6809336">func</span>&nbsp;<span class="ident" id="6809341">runPktSyslog</span><span class="op" id="6809353">(</span><span class="ident" id="6809354">c</span>&nbsp;<span class="ident" id="6809356">net</span><span class="op" id="6809359">.</span><span class="ident" id="6809360">PacketConn</span><span class="op" id="6809370">,</span>&nbsp;<span class="ident" id="6809372">done</span>&nbsp;<span class="keyword" id="6809377">chan</span><span class="op" id="6809381">&lt;-</span>&nbsp;<span class="builtintype" id="6809384">string</span><span class="op" id="6809390">)</span>&nbsp;<span class="op" id="6809392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809395">var</span>&nbsp;<span class="ident" id="6809399">buf</span>&nbsp;<span class="op" id="6809403">[</span><span class="num" id="6809404">4096</span><span class="op" id="6809408">]</span><span class="builtintype" id="6809409">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809415">var</span>&nbsp;<span class="ident" id="6809419">rcvd</span>&nbsp;<span class="builtintype" id="6809424">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809432">ct</span>&nbsp;<span class="op" id="6809435">:=</span>&nbsp;<span class="num" id="6809438">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809441">for</span>&nbsp;<span class="op" id="6809445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809449">var</span>&nbsp;<span class="ident" id="6809453">n</span>&nbsp;<span class="builtintype" id="6809455">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809461">var</span>&nbsp;<span class="ident" id="6809465">err</span>&nbsp;<span class="builtintype" id="6809469">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809478">c</span><span class="op" id="6809479">.</span><span class="ident" id="6809480">SetReadDeadline</span><span class="op" id="6809495">(</span><span class="ident" id="6809496">time</span><span class="op" id="6809500">.</span><span class="ident" id="6809501">Now</span><span class="op" id="6809504">(</span><span class="op" id="6809505">)</span><span class="op" id="6809506">.</span><span class="ident" id="6809507">Add</span><span class="op" id="6809510">(</span><span class="num" id="6809511">100</span>&nbsp;<span class="op" id="6809515">*</span>&nbsp;<span class="ident" id="6809517">time</span><span class="op" id="6809521">.</span><span class="ident" id="6809522">Millisecond</span><span class="op" id="6809533">)</span><span class="op" id="6809534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809538">n</span><span class="op" id="6809539">,</span>&nbsp;<span class="ident" id="6809541">_</span><span class="op" id="6809542">,</span>&nbsp;<span class="ident" id="6809544">err</span>&nbsp;<span class="op" id="6809548">=</span>&nbsp;<span class="ident" id="6809550">c</span><span class="op" id="6809551">.</span><span class="ident" id="6809552">ReadFrom</span><span class="op" id="6809560">(</span><span class="ident" id="6809561">buf</span><span class="op" id="6809564">[</span><span class="op" id="6809565">:</span><span class="op" id="6809566">]</span><span class="op" id="6809567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809571">rcvd</span>&nbsp;<span class="op" id="6809576">+=</span>&nbsp;<span class="builtintype" id="6809579">string</span><span class="op" id="6809585">(</span><span class="ident" id="6809586">buf</span><span class="op" id="6809589">[</span><span class="op" id="6809590">:</span><span class="ident" id="6809591">n</span><span class="op" id="6809592">]</span><span class="op" id="6809593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809597">if</span>&nbsp;<span class="ident" id="6809600">err</span>&nbsp;<span class="op" id="6809604">!=</span>&nbsp;<span class="ident" id="6809607">nil</span>&nbsp;<span class="op" id="6809611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809616">if</span>&nbsp;<span class="ident" id="6809619">oe</span><span class="op" id="6809621">,</span>&nbsp;<span class="ident" id="6809623">ok</span>&nbsp;<span class="op" id="6809626">:=</span>&nbsp;<span class="ident" id="6809629">err</span><span class="op" id="6809632">.</span><span class="op" id="6809633">(</span><span class="op" id="6809634">*</span><span class="ident" id="6809635">net</span><span class="op" id="6809638">.</span><span class="ident" id="6809639">OpError</span><span class="op" id="6809646">)</span><span class="op" id="6809647">;</span>&nbsp;<span class="ident" id="6809649">ok</span>&nbsp;<span class="op" id="6809652">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809658">if</span>&nbsp;<span class="ident" id="6809661">ct</span>&nbsp;<span class="op" id="6809664">&lt;</span>&nbsp;<span class="num" id="6809666">3</span>&nbsp;<span class="op" id="6809668">&amp;&amp;</span>&nbsp;<span class="ident" id="6809671">oe</span><span class="op" id="6809673">.</span><span class="ident" id="6809674">Temporary</span><span class="op" id="6809683">(</span><span class="op" id="6809684">)</span>&nbsp;<span class="op" id="6809686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809693">ct</span><span class="op" id="6809695">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809703">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6809716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6809721">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809726">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6809734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6809737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809740">c</span><span class="op" id="6809741">.</span><span class="ident" id="6809742">Close</span><span class="op" id="6809747">(</span><span class="op" id="6809748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809751">done</span>&nbsp;<span class="op" id="6809756">&lt;-</span>&nbsp;<span class="ident" id="6809759">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="6809764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6809767">var</span>&nbsp;<span class="ident" id="6809771">crashy</span>&nbsp;<span class="op" id="6809778">=</span>&nbsp;<span class="builtintype" id="6809780">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6809787">func</span>&nbsp;<span class="ident" id="6809792">runStreamSyslog</span><span class="op" id="6809807">(</span><span class="ident" id="6809808">l</span>&nbsp;<span class="ident" id="6809810">net</span><span class="op" id="6809813">.</span><span class="ident" id="6809814">Listener</span><span class="op" id="6809822">,</span>&nbsp;<span class="ident" id="6809824">done</span>&nbsp;<span class="keyword" id="6809829">chan</span><span class="op" id="6809833">&lt;-</span>&nbsp;<span class="builtintype" id="6809836">string</span><span class="op" id="6809842">,</span>&nbsp;<span class="ident" id="6809844">wg</span>&nbsp;<span class="op" id="6809847">*</span><span class="ident" id="6809848">sync</span><span class="op" id="6809852">.</span><span class="ident" id="6809853">WaitGroup</span><span class="op" id="6809862">)</span>&nbsp;<span class="op" id="6809864">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809867">for</span>&nbsp;<span class="op" id="6809871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809875">var</span>&nbsp;<span class="ident" id="6809879">c</span>&nbsp;<span class="ident" id="6809881">net</span><span class="op" id="6809884">.</span><span class="ident" id="6809885">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809892">var</span>&nbsp;<span class="ident" id="6809896">err</span>&nbsp;<span class="builtintype" id="6809900">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809908">if</span>&nbsp;<span class="ident" id="6809911">c</span><span class="op" id="6809912">,</span>&nbsp;<span class="ident" id="6809914">err</span>&nbsp;<span class="op" id="6809918">=</span>&nbsp;<span class="ident" id="6809920">l</span><span class="op" id="6809921">.</span><span class="ident" id="6809922">Accept</span><span class="op" id="6809928">(</span><span class="op" id="6809929">)</span><span class="op" id="6809930">;</span>&nbsp;<span class="ident" id="6809932">err</span>&nbsp;<span class="op" id="6809936">!=</span>&nbsp;<span class="ident" id="6809939">nil</span>&nbsp;<span class="op" id="6809943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809948">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6809957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6809961">wg</span><span class="op" id="6809963">.</span><span class="ident" id="6809964">Add</span><span class="op" id="6809967">(</span><span class="num" id="6809968">1</span><span class="op" id="6809969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809973">go</span>&nbsp;<span class="keyword" id="6809976">func</span><span class="op" id="6809980">(</span><span class="ident" id="6809981">c</span>&nbsp;<span class="ident" id="6809983">net</span><span class="op" id="6809986">.</span><span class="ident" id="6809987">Conn</span><span class="op" id="6809991">)</span>&nbsp;<span class="op" id="6809993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6809998">defer</span>&nbsp;<span class="ident" id="6810004">wg</span><span class="op" id="6810006">.</span><span class="ident" id="6810007">Done</span><span class="op" id="6810011">(</span><span class="op" id="6810012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810017">c</span><span class="op" id="6810018">.</span><span class="ident" id="6810019">SetReadDeadline</span><span class="op" id="6810034">(</span><span class="ident" id="6810035">time</span><span class="op" id="6810039">.</span><span class="ident" id="6810040">Now</span><span class="op" id="6810043">(</span><span class="op" id="6810044">)</span><span class="op" id="6810045">.</span><span class="ident" id="6810046">Add</span><span class="op" id="6810049">(</span><span class="num" id="6810050">5</span>&nbsp;<span class="op" id="6810052">*</span>&nbsp;<span class="ident" id="6810054">time</span><span class="op" id="6810058">.</span><span class="ident" id="6810059">Second</span><span class="op" id="6810065">)</span><span class="op" id="6810066">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810071">b</span>&nbsp;<span class="op" id="6810073">:=</span>&nbsp;<span class="ident" id="6810076">bufio</span><span class="op" id="6810081">.</span><span class="ident" id="6810082">NewReader</span><span class="op" id="6810091">(</span><span class="ident" id="6810092">c</span><span class="op" id="6810093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810098">for</span>&nbsp;<span class="ident" id="6810102">ct</span>&nbsp;<span class="op" id="6810105">:=</span>&nbsp;<span class="num" id="6810108">1</span><span class="op" id="6810109">;</span>&nbsp;<span class="op" id="6810111">!</span><span class="ident" id="6810112">crashy</span>&nbsp;<span class="op" id="6810119">||</span>&nbsp;<span class="ident" id="6810122">ct</span><span class="op" id="6810124">&amp;</span><span class="num" id="6810125">7</span>&nbsp;<span class="op" id="6810127">!=</span>&nbsp;<span class="num" id="6810130">0</span><span class="op" id="6810131">;</span>&nbsp;<span class="ident" id="6810133">ct</span><span class="op" id="6810135">++</span>&nbsp;<span class="op" id="6810138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810144">s</span><span class="op" id="6810145">,</span>&nbsp;<span class="ident" id="6810147">err</span>&nbsp;<span class="op" id="6810151">:=</span>&nbsp;<span class="ident" id="6810154">b</span><span class="op" id="6810155">.</span><span class="ident" id="6810156">ReadString</span><span class="op" id="6810166">(</span><span class="string" id="6810167">&#39;\n&#39;</span><span class="op" id="6810171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810177">if</span>&nbsp;<span class="ident" id="6810180">err</span>&nbsp;<span class="op" id="6810184">!=</span>&nbsp;<span class="ident" id="6810187">nil</span>&nbsp;<span class="op" id="6810191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810198">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810214">done</span>&nbsp;<span class="op" id="6810219">&lt;-</span>&nbsp;<span class="ident" id="6810222">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810232">c</span><span class="op" id="6810233">.</span><span class="ident" id="6810234">Close</span><span class="op" id="6810239">(</span><span class="op" id="6810240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810244">}</span><span class="op" id="6810245">(</span><span class="ident" id="6810246">c</span><span class="op" id="6810247">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810250">}</span><br>
<span class="lineno"></span><span class="op" id="6810252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6810255">func</span>&nbsp;<span class="ident" id="6810260">startServer</span><span class="op" id="6810271">(</span><span class="ident" id="6810272">n</span><span class="op" id="6810273">,</span>&nbsp;<span class="ident" id="6810275">la</span>&nbsp;<span class="builtintype" id="6810278">string</span><span class="op" id="6810284">,</span>&nbsp;<span class="ident" id="6810286">done</span>&nbsp;<span class="keyword" id="6810291">chan</span><span class="op" id="6810295">&lt;-</span>&nbsp;<span class="builtintype" id="6810298">string</span><span class="op" id="6810304">)</span>&nbsp;<span class="op" id="6810306">(</span><span class="ident" id="6810307">addr</span>&nbsp;<span class="builtintype" id="6810312">string</span><span class="op" id="6810318">,</span>&nbsp;<span class="ident" id="6810320">sock</span>&nbsp;<span class="ident" id="6810325">io</span><span class="op" id="6810327">.</span><span class="ident" id="6810328">Closer</span><span class="op" id="6810334">,</span>&nbsp;<span class="ident" id="6810336">wg</span>&nbsp;<span class="op" id="6810339">*</span><span class="ident" id="6810340">sync</span><span class="op" id="6810344">.</span><span class="ident" id="6810345">WaitGroup</span><span class="op" id="6810354">)</span>&nbsp;<span class="op" id="6810356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810359">if</span>&nbsp;<span class="ident" id="6810362">n</span>&nbsp;<span class="op" id="6810364">==</span>&nbsp;<span class="string" id="6810367">&#34;udp&#34;</span>&nbsp;<span class="op" id="6810373">||</span>&nbsp;<span class="ident" id="6810376">n</span>&nbsp;<span class="op" id="6810378">==</span>&nbsp;<span class="string" id="6810381">&#34;tcp&#34;</span>&nbsp;<span class="op" id="6810387">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810391">la</span>&nbsp;<span class="op" id="6810394">=</span>&nbsp;<span class="string" id="6810396">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810411">}</span>&nbsp;<span class="keyword" id="6810413">else</span>&nbsp;<span class="op" id="6810418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6810422">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810478">if</span>&nbsp;<span class="ident" id="6810481">la</span>&nbsp;<span class="op" id="6810484">==</span>&nbsp;<span class="string" id="6810487">&#34;&#34;</span>&nbsp;<span class="op" id="6810490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6810495">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810550">f</span><span class="op" id="6810551">,</span>&nbsp;<span class="ident" id="6810553">err</span>&nbsp;<span class="op" id="6810557">:=</span>&nbsp;<span class="ident" id="6810560">ioutil</span><span class="op" id="6810566">.</span><span class="ident" id="6810567">TempFile</span><span class="op" id="6810575">(</span><span class="string" id="6810576">&#34;&#34;</span><span class="op" id="6810578">,</span>&nbsp;<span class="string" id="6810580">&#34;syslogtest&#34;</span><span class="op" id="6810592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810597">if</span>&nbsp;<span class="ident" id="6810600">err</span>&nbsp;<span class="op" id="6810604">!=</span>&nbsp;<span class="ident" id="6810607">nil</span>&nbsp;<span class="op" id="6810611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810617">log</span><span class="op" id="6810620">.</span><span class="ident" id="6810621">Fatal</span><span class="op" id="6810626">(</span><span class="string" id="6810627">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="6810639">,</span>&nbsp;<span class="ident" id="6810641">err</span><span class="op" id="6810644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810654">f</span><span class="op" id="6810655">.</span><span class="ident" id="6810656">Close</span><span class="op" id="6810661">(</span><span class="op" id="6810662">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810667">la</span>&nbsp;<span class="op" id="6810670">=</span>&nbsp;<span class="ident" id="6810672">f</span><span class="op" id="6810673">.</span><span class="ident" id="6810674">Name</span><span class="op" id="6810678">(</span><span class="op" id="6810679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810687">os</span><span class="op" id="6810689">.</span><span class="ident" id="6810690">Remove</span><span class="op" id="6810696">(</span><span class="ident" id="6810697">la</span><span class="op" id="6810699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810706">wg</span>&nbsp;<span class="op" id="6810709">=</span>&nbsp;<span class="builtinfunc" id="6810711">new</span><span class="op" id="6810714">(</span><span class="ident" id="6810715">sync</span><span class="op" id="6810719">.</span><span class="ident" id="6810720">WaitGroup</span><span class="op" id="6810729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810732">if</span>&nbsp;<span class="ident" id="6810735">n</span>&nbsp;<span class="op" id="6810737">==</span>&nbsp;<span class="string" id="6810740">&#34;udp&#34;</span>&nbsp;<span class="op" id="6810746">||</span>&nbsp;<span class="ident" id="6810749">n</span>&nbsp;<span class="op" id="6810751">==</span>&nbsp;<span class="string" id="6810754">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="6810765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810769">l</span><span class="op" id="6810770">,</span>&nbsp;<span class="ident" id="6810772">e</span>&nbsp;<span class="op" id="6810774">:=</span>&nbsp;<span class="ident" id="6810777">net</span><span class="op" id="6810780">.</span><span class="ident" id="6810781">ListenPacket</span><span class="op" id="6810793">(</span><span class="ident" id="6810794">n</span><span class="op" id="6810795">,</span>&nbsp;<span class="ident" id="6810797">la</span><span class="op" id="6810799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810803">if</span>&nbsp;<span class="ident" id="6810806">e</span>&nbsp;<span class="op" id="6810808">!=</span>&nbsp;<span class="ident" id="6810811">nil</span>&nbsp;<span class="op" id="6810815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810820">log</span><span class="op" id="6810823">.</span><span class="ident" id="6810824">Fatalf</span><span class="op" id="6810830">(</span><span class="string" id="6810831">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6810855">,</span>&nbsp;<span class="ident" id="6810857">e</span><span class="op" id="6810858">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810866">addr</span>&nbsp;<span class="op" id="6810871">=</span>&nbsp;<span class="ident" id="6810873">l</span><span class="op" id="6810874">.</span><span class="ident" id="6810875">LocalAddr</span><span class="op" id="6810884">(</span><span class="op" id="6810885">)</span><span class="op" id="6810886">.</span><span class="ident" id="6810887">String</span><span class="op" id="6810893">(</span><span class="op" id="6810894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810898">sock</span>&nbsp;<span class="op" id="6810903">=</span>&nbsp;<span class="ident" id="6810905">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810909">wg</span><span class="op" id="6810911">.</span><span class="ident" id="6810912">Add</span><span class="op" id="6810915">(</span><span class="num" id="6810916">1</span><span class="op" id="6810917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810921">go</span>&nbsp;<span class="keyword" id="6810924">func</span><span class="op" id="6810928">(</span><span class="op" id="6810929">)</span>&nbsp;<span class="op" id="6810931">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6810936">defer</span>&nbsp;<span class="ident" id="6810942">wg</span><span class="op" id="6810944">.</span><span class="ident" id="6810945">Done</span><span class="op" id="6810949">(</span><span class="op" id="6810950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810955">runPktSyslog</span><span class="op" id="6810967">(</span><span class="ident" id="6810968">l</span><span class="op" id="6810969">,</span>&nbsp;<span class="ident" id="6810971">done</span><span class="op" id="6810975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810979">}</span><span class="op" id="6810980">(</span><span class="op" id="6810981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6810984">}</span>&nbsp;<span class="keyword" id="6810986">else</span>&nbsp;<span class="op" id="6810991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6810995">l</span><span class="op" id="6810996">,</span>&nbsp;<span class="ident" id="6810998">e</span>&nbsp;<span class="op" id="6811000">:=</span>&nbsp;<span class="ident" id="6811003">net</span><span class="op" id="6811006">.</span><span class="ident" id="6811007">Listen</span><span class="op" id="6811013">(</span><span class="ident" id="6811014">n</span><span class="op" id="6811015">,</span>&nbsp;<span class="ident" id="6811017">la</span><span class="op" id="6811019">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811023">if</span>&nbsp;<span class="ident" id="6811026">e</span>&nbsp;<span class="op" id="6811028">!=</span>&nbsp;<span class="ident" id="6811031">nil</span>&nbsp;<span class="op" id="6811035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811040">log</span><span class="op" id="6811043">.</span><span class="ident" id="6811044">Fatalf</span><span class="op" id="6811050">(</span><span class="string" id="6811051">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6811075">,</span>&nbsp;<span class="ident" id="6811077">e</span><span class="op" id="6811078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811086">addr</span>&nbsp;<span class="op" id="6811091">=</span>&nbsp;<span class="ident" id="6811093">l</span><span class="op" id="6811094">.</span><span class="ident" id="6811095">Addr</span><span class="op" id="6811099">(</span><span class="op" id="6811100">)</span><span class="op" id="6811101">.</span><span class="ident" id="6811102">String</span><span class="op" id="6811108">(</span><span class="op" id="6811109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811113">sock</span>&nbsp;<span class="op" id="6811118">=</span>&nbsp;<span class="ident" id="6811120">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811124">wg</span><span class="op" id="6811126">.</span><span class="ident" id="6811127">Add</span><span class="op" id="6811130">(</span><span class="num" id="6811131">1</span><span class="op" id="6811132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811136">go</span>&nbsp;<span class="keyword" id="6811139">func</span><span class="op" id="6811143">(</span><span class="op" id="6811144">)</span>&nbsp;<span class="op" id="6811146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811151">defer</span>&nbsp;<span class="ident" id="6811157">wg</span><span class="op" id="6811159">.</span><span class="ident" id="6811160">Done</span><span class="op" id="6811164">(</span><span class="op" id="6811165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811170">runStreamSyslog</span><span class="op" id="6811185">(</span><span class="ident" id="6811186">l</span><span class="op" id="6811187">,</span>&nbsp;<span class="ident" id="6811189">done</span><span class="op" id="6811193">,</span>&nbsp;<span class="ident" id="6811195">wg</span><span class="op" id="6811197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811201">}</span><span class="op" id="6811202">(</span><span class="op" id="6811203">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811209">return</span><br>
<span class="lineno"></span><span class="op" id="6811216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6811219">func</span>&nbsp;<span class="ident" id="6811224">TestWithSimulated</span><span class="op" id="6811241">(</span><span class="ident" id="6811242">t</span>&nbsp;<span class="op" id="6811244">*</span><span class="ident" id="6811245">testing</span><span class="op" id="6811252">.</span><span class="ident" id="6811253">T</span><span class="op" id="6811254">)</span>&nbsp;<span class="op" id="6811256">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811259">msg</span>&nbsp;<span class="op" id="6811263">:=</span>&nbsp;<span class="string" id="6811266">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811278">transport</span>&nbsp;<span class="op" id="6811288">:=</span>&nbsp;<span class="op" id="6811291">[</span><span class="op" id="6811292">]</span><span class="builtintype" id="6811293">string</span><span class="op" id="6811299">{</span><span class="string" id="6811300">&#34;unix&#34;</span><span class="op" id="6811306">,</span>&nbsp;<span class="string" id="6811308">&#34;unixgram&#34;</span><span class="op" id="6811318">,</span>&nbsp;<span class="string" id="6811320">&#34;udp&#34;</span><span class="op" id="6811325">,</span>&nbsp;<span class="string" id="6811327">&#34;tcp&#34;</span><span class="op" id="6811332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811336">for</span>&nbsp;<span class="ident" id="6811340">_</span><span class="op" id="6811341">,</span>&nbsp;<span class="ident" id="6811343">tr</span>&nbsp;<span class="op" id="6811346">:=</span>&nbsp;<span class="keyword" id="6811349">range</span>&nbsp;<span class="ident" id="6811355">transport</span>&nbsp;<span class="op" id="6811365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811369">done</span>&nbsp;<span class="op" id="6811374">:=</span>&nbsp;<span class="builtinfunc" id="6811377">make</span><span class="op" id="6811381">(</span><span class="keyword" id="6811382">chan</span>&nbsp;<span class="builtintype" id="6811387">string</span><span class="op" id="6811393">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811397">addr</span><span class="op" id="6811401">,</span>&nbsp;<span class="ident" id="6811403">sock</span><span class="op" id="6811407">,</span>&nbsp;<span class="ident" id="6811409">srvWG</span>&nbsp;<span class="op" id="6811415">:=</span>&nbsp;<span class="ident" id="6811418">startServer</span><span class="op" id="6811429">(</span><span class="ident" id="6811430">tr</span><span class="op" id="6811432">,</span>&nbsp;<span class="string" id="6811434">&#34;&#34;</span><span class="op" id="6811436">,</span>&nbsp;<span class="ident" id="6811438">done</span><span class="op" id="6811442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811446">defer</span>&nbsp;<span class="ident" id="6811452">srvWG</span><span class="op" id="6811457">.</span><span class="ident" id="6811458">Wait</span><span class="op" id="6811462">(</span><span class="op" id="6811463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811467">defer</span>&nbsp;<span class="ident" id="6811473">sock</span><span class="op" id="6811477">.</span><span class="ident" id="6811478">Close</span><span class="op" id="6811483">(</span><span class="op" id="6811484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811488">if</span>&nbsp;<span class="ident" id="6811491">tr</span>&nbsp;<span class="op" id="6811494">==</span>&nbsp;<span class="string" id="6811497">&#34;unix&#34;</span>&nbsp;<span class="op" id="6811504">||</span>&nbsp;<span class="ident" id="6811507">tr</span>&nbsp;<span class="op" id="6811510">==</span>&nbsp;<span class="string" id="6811513">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="6811524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811529">defer</span>&nbsp;<span class="ident" id="6811535">os</span><span class="op" id="6811537">.</span><span class="ident" id="6811538">Remove</span><span class="op" id="6811544">(</span><span class="ident" id="6811545">addr</span><span class="op" id="6811549">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811557">s</span><span class="op" id="6811558">,</span>&nbsp;<span class="ident" id="6811560">err</span>&nbsp;<span class="op" id="6811564">:=</span>&nbsp;<span class="ident" id="6811567">Dial</span><span class="op" id="6811571">(</span><span class="ident" id="6811572">tr</span><span class="op" id="6811574">,</span>&nbsp;<span class="ident" id="6811576">addr</span><span class="op" id="6811580">,</span>&nbsp;<span class="ident" id="6811582">LOG_INFO</span><span class="op" id="6811590">|</span><span class="ident" id="6811591">LOG_USER</span><span class="op" id="6811599">,</span>&nbsp;<span class="string" id="6811601">&#34;syslog_test&#34;</span><span class="op" id="6811614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811618">if</span>&nbsp;<span class="ident" id="6811621">err</span>&nbsp;<span class="op" id="6811625">!=</span>&nbsp;<span class="ident" id="6811628">nil</span>&nbsp;<span class="op" id="6811632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811637">t</span><span class="op" id="6811638">.</span><span class="ident" id="6811639">Fatalf</span><span class="op" id="6811645">(</span><span class="string" id="6811646">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6811665">,</span>&nbsp;<span class="ident" id="6811667">err</span><span class="op" id="6811670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811674">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811678">err</span>&nbsp;<span class="op" id="6811682">=</span>&nbsp;<span class="ident" id="6811684">s</span><span class="op" id="6811685">.</span><span class="ident" id="6811686">Info</span><span class="op" id="6811690">(</span><span class="ident" id="6811691">msg</span><span class="op" id="6811694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811698">if</span>&nbsp;<span class="ident" id="6811701">err</span>&nbsp;<span class="op" id="6811705">!=</span>&nbsp;<span class="ident" id="6811708">nil</span>&nbsp;<span class="op" id="6811712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811717">t</span><span class="op" id="6811718">.</span><span class="ident" id="6811719">Fatalf</span><span class="op" id="6811725">(</span><span class="string" id="6811726">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6811742">,</span>&nbsp;<span class="ident" id="6811744">err</span><span class="op" id="6811747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811755">check</span><span class="op" id="6811760">(</span><span class="ident" id="6811761">t</span><span class="op" id="6811762">,</span>&nbsp;<span class="ident" id="6811764">msg</span><span class="op" id="6811767">,</span>&nbsp;<span class="op" id="6811769">&lt;-</span><span class="ident" id="6811771">done</span><span class="op" id="6811775">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811779">s</span><span class="op" id="6811780">.</span><span class="ident" id="6811781">Close</span><span class="op" id="6811786">(</span><span class="op" id="6811787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6811790">}</span><br>
<span class="lineno"></span><span class="op" id="6811792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6811795">func</span>&nbsp;<span class="ident" id="6811800">TestFlap</span><span class="op" id="6811808">(</span><span class="ident" id="6811809">t</span>&nbsp;<span class="op" id="6811811">*</span><span class="ident" id="6811812">testing</span><span class="op" id="6811819">.</span><span class="ident" id="6811820">T</span><span class="op" id="6811821">)</span>&nbsp;<span class="op" id="6811823">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811826">net</span>&nbsp;<span class="op" id="6811830">:=</span>&nbsp;<span class="string" id="6811833">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811841">done</span>&nbsp;<span class="op" id="6811846">:=</span>&nbsp;<span class="builtinfunc" id="6811849">make</span><span class="op" id="6811853">(</span><span class="keyword" id="6811854">chan</span>&nbsp;<span class="builtintype" id="6811859">string</span><span class="op" id="6811865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811868">addr</span><span class="op" id="6811872">,</span>&nbsp;<span class="ident" id="6811874">sock</span><span class="op" id="6811878">,</span>&nbsp;<span class="ident" id="6811880">srvWG</span>&nbsp;<span class="op" id="6811886">:=</span>&nbsp;<span class="ident" id="6811889">startServer</span><span class="op" id="6811900">(</span><span class="ident" id="6811901">net</span><span class="op" id="6811904">,</span>&nbsp;<span class="string" id="6811906">&#34;&#34;</span><span class="op" id="6811908">,</span>&nbsp;<span class="ident" id="6811910">done</span><span class="op" id="6811914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811917">defer</span>&nbsp;<span class="ident" id="6811923">srvWG</span><span class="op" id="6811928">.</span><span class="ident" id="6811929">Wait</span><span class="op" id="6811933">(</span><span class="op" id="6811934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811937">defer</span>&nbsp;<span class="ident" id="6811943">os</span><span class="op" id="6811945">.</span><span class="ident" id="6811946">Remove</span><span class="op" id="6811952">(</span><span class="ident" id="6811953">addr</span><span class="op" id="6811957">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6811960">defer</span>&nbsp;<span class="ident" id="6811966">sock</span><span class="op" id="6811970">.</span><span class="ident" id="6811971">Close</span><span class="op" id="6811976">(</span><span class="op" id="6811977">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6811981">s</span><span class="op" id="6811982">,</span>&nbsp;<span class="ident" id="6811984">err</span>&nbsp;<span class="op" id="6811988">:=</span>&nbsp;<span class="ident" id="6811991">Dial</span><span class="op" id="6811995">(</span><span class="ident" id="6811996">net</span><span class="op" id="6811999">,</span>&nbsp;<span class="ident" id="6812001">addr</span><span class="op" id="6812005">,</span>&nbsp;<span class="ident" id="6812007">LOG_INFO</span><span class="op" id="6812015">|</span><span class="ident" id="6812016">LOG_USER</span><span class="op" id="6812024">,</span>&nbsp;<span class="string" id="6812026">&#34;syslog_test&#34;</span><span class="op" id="6812039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812042">if</span>&nbsp;<span class="ident" id="6812045">err</span>&nbsp;<span class="op" id="6812049">!=</span>&nbsp;<span class="ident" id="6812052">nil</span>&nbsp;<span class="op" id="6812056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812060">t</span><span class="op" id="6812061">.</span><span class="ident" id="6812062">Fatalf</span><span class="op" id="6812068">(</span><span class="string" id="6812069">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6812088">,</span>&nbsp;<span class="ident" id="6812090">err</span><span class="op" id="6812093">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812099">msg</span>&nbsp;<span class="op" id="6812103">:=</span>&nbsp;<span class="string" id="6812106">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812115">err</span>&nbsp;<span class="op" id="6812119">=</span>&nbsp;<span class="ident" id="6812121">s</span><span class="op" id="6812122">.</span><span class="ident" id="6812123">Info</span><span class="op" id="6812127">(</span><span class="ident" id="6812128">msg</span><span class="op" id="6812131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812134">if</span>&nbsp;<span class="ident" id="6812137">err</span>&nbsp;<span class="op" id="6812141">!=</span>&nbsp;<span class="ident" id="6812144">nil</span>&nbsp;<span class="op" id="6812148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812152">t</span><span class="op" id="6812153">.</span><span class="ident" id="6812154">Fatalf</span><span class="op" id="6812160">(</span><span class="string" id="6812161">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6812177">,</span>&nbsp;<span class="ident" id="6812179">err</span><span class="op" id="6812182">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812188">check</span><span class="op" id="6812193">(</span><span class="ident" id="6812194">t</span><span class="op" id="6812195">,</span>&nbsp;<span class="ident" id="6812197">msg</span><span class="op" id="6812200">,</span>&nbsp;<span class="op" id="6812202">&lt;-</span><span class="ident" id="6812204">done</span><span class="op" id="6812208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6812212">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812235">_</span><span class="op" id="6812236">,</span>&nbsp;<span class="ident" id="6812238">sock2</span><span class="op" id="6812243">,</span>&nbsp;<span class="ident" id="6812245">srvWG2</span>&nbsp;<span class="op" id="6812252">:=</span>&nbsp;<span class="ident" id="6812255">startServer</span><span class="op" id="6812266">(</span><span class="ident" id="6812267">net</span><span class="op" id="6812270">,</span>&nbsp;<span class="ident" id="6812272">addr</span><span class="op" id="6812276">,</span>&nbsp;<span class="ident" id="6812278">done</span><span class="op" id="6812282">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812285">defer</span>&nbsp;<span class="ident" id="6812291">srvWG2</span><span class="op" id="6812297">.</span><span class="ident" id="6812298">Wait</span><span class="op" id="6812302">(</span><span class="op" id="6812303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812306">defer</span>&nbsp;<span class="ident" id="6812312">sock2</span><span class="op" id="6812317">.</span><span class="ident" id="6812318">Close</span><span class="op" id="6812323">(</span><span class="op" id="6812324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6812328">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812355">msg</span>&nbsp;<span class="op" id="6812359">=</span>&nbsp;<span class="string" id="6812361">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812370">err</span>&nbsp;<span class="op" id="6812374">=</span>&nbsp;<span class="ident" id="6812376">s</span><span class="op" id="6812377">.</span><span class="ident" id="6812378">Info</span><span class="op" id="6812382">(</span><span class="ident" id="6812383">msg</span><span class="op" id="6812386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812389">if</span>&nbsp;<span class="ident" id="6812392">err</span>&nbsp;<span class="op" id="6812396">!=</span>&nbsp;<span class="ident" id="6812399">nil</span>&nbsp;<span class="op" id="6812403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812407">t</span><span class="op" id="6812408">.</span><span class="ident" id="6812409">Fatalf</span><span class="op" id="6812415">(</span><span class="string" id="6812416">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6812432">,</span>&nbsp;<span class="ident" id="6812434">err</span><span class="op" id="6812437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812443">check</span><span class="op" id="6812448">(</span><span class="ident" id="6812449">t</span><span class="op" id="6812450">,</span>&nbsp;<span class="ident" id="6812452">msg</span><span class="op" id="6812455">,</span>&nbsp;<span class="op" id="6812457">&lt;-</span><span class="ident" id="6812459">done</span><span class="op" id="6812463">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812467">s</span><span class="op" id="6812468">.</span><span class="ident" id="6812469">Close</span><span class="op" id="6812474">(</span><span class="op" id="6812475">)</span><br>
<span class="lineno"></span><span class="op" id="6812477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6812480">func</span>&nbsp;<span class="ident" id="6812485">TestNew</span><span class="op" id="6812492">(</span><span class="ident" id="6812493">t</span>&nbsp;<span class="op" id="6812495">*</span><span class="ident" id="6812496">testing</span><span class="op" id="6812503">.</span><span class="ident" id="6812504">T</span><span class="op" id="6812505">)</span>&nbsp;<span class="op" id="6812507">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812510">if</span>&nbsp;<span class="ident" id="6812513">LOG_LOCAL7</span>&nbsp;<span class="op" id="6812524">!=</span>&nbsp;<span class="num" id="6812527">23</span><span class="op" id="6812529">&lt;&lt;</span><span class="num" id="6812531">3</span>&nbsp;<span class="op" id="6812533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812537">t</span><span class="op" id="6812538">.</span><span class="ident" id="6812539">Fatalf</span><span class="op" id="6812545">(</span><span class="string" id="6812546">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="6812574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812580">if</span>&nbsp;<span class="ident" id="6812583">testing</span><span class="op" id="6812590">.</span><span class="ident" id="6812591">Short</span><span class="op" id="6812596">(</span><span class="op" id="6812597">)</span>&nbsp;<span class="op" id="6812599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6812603">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812666">t</span><span class="op" id="6812667">.</span><span class="ident" id="6812668">Skip</span><span class="op" id="6812672">(</span><span class="string" id="6812673">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="6812709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812716">s</span><span class="op" id="6812717">,</span>&nbsp;<span class="ident" id="6812719">err</span>&nbsp;<span class="op" id="6812723">:=</span>&nbsp;<span class="ident" id="6812726">New</span><span class="op" id="6812729">(</span><span class="ident" id="6812730">LOG_INFO</span><span class="op" id="6812738">|</span><span class="ident" id="6812739">LOG_USER</span><span class="op" id="6812747">,</span>&nbsp;<span class="string" id="6812749">&#34;the_tag&#34;</span><span class="op" id="6812758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812761">if</span>&nbsp;<span class="ident" id="6812764">err</span>&nbsp;<span class="op" id="6812768">!=</span>&nbsp;<span class="ident" id="6812771">nil</span>&nbsp;<span class="op" id="6812775">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812779">t</span><span class="op" id="6812780">.</span><span class="ident" id="6812781">Fatalf</span><span class="op" id="6812787">(</span><span class="string" id="6812788">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6812806">,</span>&nbsp;<span class="ident" id="6812808">err</span><span class="op" id="6812811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6812817">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812846">s</span><span class="op" id="6812847">.</span><span class="ident" id="6812848">Close</span><span class="op" id="6812853">(</span><span class="op" id="6812854">)</span><br>
<span class="lineno"></span><span class="op" id="6812856">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="6812859">func</span>&nbsp;<span class="ident" id="6812864">TestNewLogger</span><span class="op" id="6812877">(</span><span class="ident" id="6812878">t</span>&nbsp;<span class="op" id="6812880">*</span><span class="ident" id="6812881">testing</span><span class="op" id="6812888">.</span><span class="ident" id="6812889">T</span><span class="op" id="6812890">)</span>&nbsp;<span class="op" id="6812892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6812895">if</span>&nbsp;<span class="ident" id="6812898">testing</span><span class="op" id="6812905">.</span><span class="ident" id="6812906">Short</span><span class="op" id="6812911">(</span><span class="op" id="6812912">)</span>&nbsp;<span class="op" id="6812914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812918">t</span><span class="op" id="6812919">.</span><span class="ident" id="6812920">Skip</span><span class="op" id="6812924">(</span><span class="string" id="6812925">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="6812961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6812964">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6812967">f</span><span class="op" id="6812968">,</span>&nbsp;<span class="ident" id="6812970">err</span>&nbsp;<span class="op" id="6812974">:=</span>&nbsp;<span class="ident" id="6812977">NewLogger</span><span class="op" id="6812986">(</span><span class="ident" id="6812987">LOG_USER</span><span class="op" id="6812995">|</span><span class="ident" id="6812996">LOG_INFO</span><span class="op" id="6813004">,</span>&nbsp;<span class="num" id="6813006">0</span><span class="op" id="6813007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813010">if</span>&nbsp;<span class="ident" id="6813013">f</span>&nbsp;<span class="op" id="6813015">==</span>&nbsp;<span class="ident" id="6813018">nil</span>&nbsp;<span class="op" id="6813022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813026">t</span><span class="op" id="6813027">.</span><span class="ident" id="6813028">Error</span><span class="op" id="6813033">(</span><span class="ident" id="6813034">err</span><span class="op" id="6813037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813040">}</span><br>
<span class="lineno"></span><span class="op" id="6813042">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="6813045">func</span>&nbsp;<span class="ident" id="6813050">TestDial</span><span class="op" id="6813058">(</span><span class="ident" id="6813059">t</span>&nbsp;<span class="op" id="6813061">*</span><span class="ident" id="6813062">testing</span><span class="op" id="6813069">.</span><span class="ident" id="6813070">T</span><span class="op" id="6813071">)</span>&nbsp;<span class="op" id="6813073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813076">if</span>&nbsp;<span class="ident" id="6813079">testing</span><span class="op" id="6813086">.</span><span class="ident" id="6813087">Short</span><span class="op" id="6813092">(</span><span class="op" id="6813093">)</span>&nbsp;<span class="op" id="6813095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813099">t</span><span class="op" id="6813100">.</span><span class="ident" id="6813101">Skip</span><span class="op" id="6813105">(</span><span class="string" id="6813106">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="6813142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813145">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813148">f</span><span class="op" id="6813149">,</span>&nbsp;<span class="ident" id="6813151">err</span>&nbsp;<span class="op" id="6813155">:=</span>&nbsp;<span class="ident" id="6813158">Dial</span><span class="op" id="6813162">(</span><span class="string" id="6813163">&#34;&#34;</span><span class="op" id="6813165">,</span>&nbsp;<span class="string" id="6813167">&#34;&#34;</span><span class="op" id="6813169">,</span>&nbsp;<span class="op" id="6813171">(</span><span class="ident" id="6813172">LOG_LOCAL7</span><span class="op" id="6813182">|</span><span class="ident" id="6813183">LOG_DEBUG</span><span class="op" id="6813192">)</span><span class="op" id="6813193">+</span><span class="num" id="6813194">1</span><span class="op" id="6813195">,</span>&nbsp;<span class="string" id="6813197">&#34;syslog_test&#34;</span><span class="op" id="6813210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813213">if</span>&nbsp;<span class="ident" id="6813216">f</span>&nbsp;<span class="op" id="6813218">!=</span>&nbsp;<span class="ident" id="6813221">nil</span>&nbsp;<span class="op" id="6813225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813229">t</span><span class="op" id="6813230">.</span><span class="ident" id="6813231">Fatalf</span><span class="op" id="6813237">(</span><span class="string" id="6813238">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="6813272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813278">f</span><span class="op" id="6813279">,</span>&nbsp;<span class="ident" id="6813281">err</span>&nbsp;<span class="op" id="6813285">=</span>&nbsp;<span class="ident" id="6813287">Dial</span><span class="op" id="6813291">(</span><span class="string" id="6813292">&#34;&#34;</span><span class="op" id="6813294">,</span>&nbsp;<span class="string" id="6813296">&#34;&#34;</span><span class="op" id="6813298">,</span>&nbsp;<span class="op" id="6813300">-</span><span class="num" id="6813301">1</span><span class="op" id="6813302">,</span>&nbsp;<span class="string" id="6813304">&#34;syslog_test&#34;</span><span class="op" id="6813317">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813320">if</span>&nbsp;<span class="ident" id="6813323">f</span>&nbsp;<span class="op" id="6813325">!=</span>&nbsp;<span class="ident" id="6813328">nil</span>&nbsp;<span class="op" id="6813332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813336">t</span><span class="op" id="6813337">.</span><span class="ident" id="6813338">Fatalf</span><span class="op" id="6813344">(</span><span class="string" id="6813345">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="6813379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813385">l</span><span class="op" id="6813386">,</span>&nbsp;<span class="ident" id="6813388">err</span>&nbsp;<span class="op" id="6813392">:=</span>&nbsp;<span class="ident" id="6813395">Dial</span><span class="op" id="6813399">(</span><span class="string" id="6813400">&#34;&#34;</span><span class="op" id="6813402">,</span>&nbsp;<span class="string" id="6813404">&#34;&#34;</span><span class="op" id="6813406">,</span>&nbsp;<span class="ident" id="6813408">LOG_USER</span><span class="op" id="6813416">|</span><span class="ident" id="6813417">LOG_ERR</span><span class="op" id="6813424">,</span>&nbsp;<span class="string" id="6813426">&#34;syslog_test&#34;</span><span class="op" id="6813439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813442">if</span>&nbsp;<span class="ident" id="6813445">err</span>&nbsp;<span class="op" id="6813449">!=</span>&nbsp;<span class="ident" id="6813452">nil</span>&nbsp;<span class="op" id="6813456">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813460">t</span><span class="op" id="6813461">.</span><span class="ident" id="6813462">Fatalf</span><span class="op" id="6813468">(</span><span class="string" id="6813469">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6813488">,</span>&nbsp;<span class="ident" id="6813490">err</span><span class="op" id="6813493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813499">l</span><span class="op" id="6813500">.</span><span class="ident" id="6813501">Close</span><span class="op" id="6813506">(</span><span class="op" id="6813507">)</span><br>
<span class="lineno"></span><span class="op" id="6813509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6813512">func</span>&nbsp;<span class="ident" id="6813517">check</span><span class="op" id="6813522">(</span><span class="ident" id="6813523">t</span>&nbsp;<span class="op" id="6813525">*</span><span class="ident" id="6813526">testing</span><span class="op" id="6813533">.</span><span class="ident" id="6813534">T</span><span class="op" id="6813535">,</span>&nbsp;<span class="ident" id="6813537">in</span><span class="op" id="6813539">,</span>&nbsp;<span class="ident" id="6813541">out</span>&nbsp;<span class="builtintype" id="6813545">string</span><span class="op" id="6813551">)</span>&nbsp;<span class="op" id="6813553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813556">tmpl</span>&nbsp;<span class="op" id="6813561">:=</span>&nbsp;<span class="ident" id="6813564">fmt</span><span class="op" id="6813567">.</span><span class="ident" id="6813568">Sprintf</span><span class="op" id="6813575">(</span><span class="string" id="6813576">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="6813612">,</span>&nbsp;<span class="ident" id="6813614">LOG_USER</span><span class="op" id="6813622">+</span><span class="ident" id="6813623">LOG_INFO</span><span class="op" id="6813631">,</span>&nbsp;<span class="ident" id="6813633">in</span><span class="op" id="6813635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813638">if</span>&nbsp;<span class="ident" id="6813641">hostname</span><span class="op" id="6813649">,</span>&nbsp;<span class="ident" id="6813651">err</span>&nbsp;<span class="op" id="6813655">:=</span>&nbsp;<span class="ident" id="6813658">os</span><span class="op" id="6813660">.</span><span class="ident" id="6813661">Hostname</span><span class="op" id="6813669">(</span><span class="op" id="6813670">)</span><span class="op" id="6813671">;</span>&nbsp;<span class="ident" id="6813673">err</span>&nbsp;<span class="op" id="6813677">!=</span>&nbsp;<span class="ident" id="6813680">nil</span>&nbsp;<span class="op" id="6813684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813688">t</span><span class="op" id="6813689">.</span><span class="ident" id="6813690">Error</span><span class="op" id="6813695">(</span><span class="string" id="6813696">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="6813723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813726">}</span>&nbsp;<span class="keyword" id="6813728">else</span>&nbsp;<span class="op" id="6813733">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813737">var</span>&nbsp;<span class="ident" id="6813741">parsedHostname</span><span class="op" id="6813755">,</span>&nbsp;<span class="ident" id="6813757">timestamp</span>&nbsp;<span class="builtintype" id="6813767">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813776">var</span>&nbsp;<span class="ident" id="6813780">pid</span>&nbsp;<span class="builtintype" id="6813784">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6813790">if</span>&nbsp;<span class="ident" id="6813793">n</span><span class="op" id="6813794">,</span>&nbsp;<span class="ident" id="6813796">err</span>&nbsp;<span class="op" id="6813800">:=</span>&nbsp;<span class="ident" id="6813803">fmt</span><span class="op" id="6813806">.</span><span class="ident" id="6813807">Sscanf</span><span class="op" id="6813813">(</span><span class="ident" id="6813814">out</span><span class="op" id="6813817">,</span>&nbsp;<span class="ident" id="6813819">tmpl</span><span class="op" id="6813823">,</span>&nbsp;<span class="op" id="6813825">&amp;</span><span class="ident" id="6813826">timestamp</span><span class="op" id="6813835">,</span>&nbsp;<span class="op" id="6813837">&amp;</span><span class="ident" id="6813838">parsedHostname</span><span class="op" id="6813852">,</span>&nbsp;<span class="op" id="6813854">&amp;</span><span class="ident" id="6813855">pid</span><span class="op" id="6813858">)</span><span class="op" id="6813859">;</span>&nbsp;<span class="ident" id="6813861">n</span>&nbsp;<span class="op" id="6813863">!=</span>&nbsp;<span class="num" id="6813866">3</span>&nbsp;<span class="op" id="6813868">||</span>&nbsp;<span class="ident" id="6813871">err</span>&nbsp;<span class="op" id="6813875">!=</span>&nbsp;<span class="ident" id="6813878">nil</span>&nbsp;<span class="op" id="6813882">||</span>&nbsp;<span class="ident" id="6813885">hostname</span>&nbsp;<span class="op" id="6813894">!=</span>&nbsp;<span class="ident" id="6813897">parsedHostname</span>&nbsp;<span class="op" id="6813912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6813917">t</span><span class="op" id="6813918">.</span><span class="ident" id="6813919">Errorf</span><span class="op" id="6813925">(</span><span class="string" id="6813926">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="6813970">,</span>&nbsp;<span class="ident" id="6813972">out</span><span class="op" id="6813975">,</span>&nbsp;<span class="ident" id="6813977">tmpl</span><span class="op" id="6813981">,</span>&nbsp;<span class="ident" id="6813983">n</span><span class="op" id="6813984">,</span>&nbsp;<span class="ident" id="6813986">err</span><span class="op" id="6813989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813993">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6813996">}</span><br>
<span class="lineno"></span><span class="op" id="6813998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6814001">func</span>&nbsp;<span class="ident" id="6814006">TestWrite</span><span class="op" id="6814015">(</span><span class="ident" id="6814016">t</span>&nbsp;<span class="op" id="6814018">*</span><span class="ident" id="6814019">testing</span><span class="op" id="6814026">.</span><span class="ident" id="6814027">T</span><span class="op" id="6814028">)</span>&nbsp;<span class="op" id="6814030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814033">tests</span>&nbsp;<span class="op" id="6814039">:=</span>&nbsp;<span class="op" id="6814042">[</span><span class="op" id="6814043">]</span><span class="keyword" id="6814044">struct</span>&nbsp;<span class="op" id="6814051">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814055">pri</span>&nbsp;<span class="ident" id="6814059">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814070">pre</span>&nbsp;<span class="builtintype" id="6814074">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814083">msg</span>&nbsp;<span class="builtintype" id="6814087">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814096">exp</span>&nbsp;<span class="builtintype" id="6814100">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814108">}</span><span class="op" id="6814109">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814113">{</span><span class="ident" id="6814114">LOG_USER</span>&nbsp;<span class="op" id="6814123">|</span>&nbsp;<span class="ident" id="6814125">LOG_ERR</span><span class="op" id="6814132">,</span>&nbsp;<span class="string" id="6814134">&#34;syslog_test&#34;</span><span class="op" id="6814147">,</span>&nbsp;<span class="string" id="6814149">&#34;&#34;</span><span class="op" id="6814151">,</span>&nbsp;<span class="string" id="6814153">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="6814180">}</span><span class="op" id="6814181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814185">{</span><span class="ident" id="6814186">LOG_USER</span>&nbsp;<span class="op" id="6814195">|</span>&nbsp;<span class="ident" id="6814197">LOG_ERR</span><span class="op" id="6814204">,</span>&nbsp;<span class="string" id="6814206">&#34;syslog_test&#34;</span><span class="op" id="6814219">,</span>&nbsp;<span class="string" id="6814221">&#34;write&nbsp;test&#34;</span><span class="op" id="6814233">,</span>&nbsp;<span class="string" id="6814235">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="6814272">}</span><span class="op" id="6814273">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6814277">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814330">{</span><span class="ident" id="6814331">LOG_USER</span>&nbsp;<span class="op" id="6814340">|</span>&nbsp;<span class="ident" id="6814342">LOG_ERR</span><span class="op" id="6814349">,</span>&nbsp;<span class="string" id="6814351">&#34;syslog_test&#34;</span><span class="op" id="6814364">,</span>&nbsp;<span class="string" id="6814366">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="6814382">,</span>&nbsp;<span class="string" id="6814384">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="6814423">}</span><span class="op" id="6814424">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814427">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814431">if</span>&nbsp;<span class="ident" id="6814434">hostname</span><span class="op" id="6814442">,</span>&nbsp;<span class="ident" id="6814444">err</span>&nbsp;<span class="op" id="6814448">:=</span>&nbsp;<span class="ident" id="6814451">os</span><span class="op" id="6814453">.</span><span class="ident" id="6814454">Hostname</span><span class="op" id="6814462">(</span><span class="op" id="6814463">)</span><span class="op" id="6814464">;</span>&nbsp;<span class="ident" id="6814466">err</span>&nbsp;<span class="op" id="6814470">!=</span>&nbsp;<span class="ident" id="6814473">nil</span>&nbsp;<span class="op" id="6814477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814481">t</span><span class="op" id="6814482">.</span><span class="ident" id="6814483">Fatalf</span><span class="op" id="6814489">(</span><span class="string" id="6814490">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="6814517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814520">}</span>&nbsp;<span class="keyword" id="6814522">else</span>&nbsp;<span class="op" id="6814527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814531">for</span>&nbsp;<span class="ident" id="6814535">_</span><span class="op" id="6814536">,</span>&nbsp;<span class="ident" id="6814538">test</span>&nbsp;<span class="op" id="6814543">:=</span>&nbsp;<span class="keyword" id="6814546">range</span>&nbsp;<span class="ident" id="6814552">tests</span>&nbsp;<span class="op" id="6814558">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814563">done</span>&nbsp;<span class="op" id="6814568">:=</span>&nbsp;<span class="builtinfunc" id="6814571">make</span><span class="op" id="6814575">(</span><span class="keyword" id="6814576">chan</span>&nbsp;<span class="builtintype" id="6814581">string</span><span class="op" id="6814587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814592">addr</span><span class="op" id="6814596">,</span>&nbsp;<span class="ident" id="6814598">sock</span><span class="op" id="6814602">,</span>&nbsp;<span class="ident" id="6814604">srvWG</span>&nbsp;<span class="op" id="6814610">:=</span>&nbsp;<span class="ident" id="6814613">startServer</span><span class="op" id="6814624">(</span><span class="string" id="6814625">&#34;udp&#34;</span><span class="op" id="6814630">,</span>&nbsp;<span class="string" id="6814632">&#34;&#34;</span><span class="op" id="6814634">,</span>&nbsp;<span class="ident" id="6814636">done</span><span class="op" id="6814640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814645">defer</span>&nbsp;<span class="ident" id="6814651">srvWG</span><span class="op" id="6814656">.</span><span class="ident" id="6814657">Wait</span><span class="op" id="6814661">(</span><span class="op" id="6814662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814667">defer</span>&nbsp;<span class="ident" id="6814673">sock</span><span class="op" id="6814677">.</span><span class="ident" id="6814678">Close</span><span class="op" id="6814683">(</span><span class="op" id="6814684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814689">l</span><span class="op" id="6814690">,</span>&nbsp;<span class="ident" id="6814692">err</span>&nbsp;<span class="op" id="6814696">:=</span>&nbsp;<span class="ident" id="6814699">Dial</span><span class="op" id="6814703">(</span><span class="string" id="6814704">&#34;udp&#34;</span><span class="op" id="6814709">,</span>&nbsp;<span class="ident" id="6814711">addr</span><span class="op" id="6814715">,</span>&nbsp;<span class="ident" id="6814717">test</span><span class="op" id="6814721">.</span><span class="ident" id="6814722">pri</span><span class="op" id="6814725">,</span>&nbsp;<span class="ident" id="6814727">test</span><span class="op" id="6814731">.</span><span class="ident" id="6814732">pre</span><span class="op" id="6814735">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814740">if</span>&nbsp;<span class="ident" id="6814743">err</span>&nbsp;<span class="op" id="6814747">!=</span>&nbsp;<span class="ident" id="6814750">nil</span>&nbsp;<span class="op" id="6814754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814760">t</span><span class="op" id="6814761">.</span><span class="ident" id="6814762">Fatalf</span><span class="op" id="6814768">(</span><span class="string" id="6814769">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6814795">,</span>&nbsp;<span class="ident" id="6814797">err</span><span class="op" id="6814800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814810">defer</span>&nbsp;<span class="ident" id="6814816">l</span><span class="op" id="6814817">.</span><span class="ident" id="6814818">Close</span><span class="op" id="6814823">(</span><span class="op" id="6814824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814829">_</span><span class="op" id="6814830">,</span>&nbsp;<span class="ident" id="6814832">err</span>&nbsp;<span class="op" id="6814836">=</span>&nbsp;<span class="ident" id="6814838">io</span><span class="op" id="6814840">.</span><span class="ident" id="6814841">WriteString</span><span class="op" id="6814852">(</span><span class="ident" id="6814853">l</span><span class="op" id="6814854">,</span>&nbsp;<span class="ident" id="6814856">test</span><span class="op" id="6814860">.</span><span class="ident" id="6814861">msg</span><span class="op" id="6814864">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6814869">if</span>&nbsp;<span class="ident" id="6814872">err</span>&nbsp;<span class="op" id="6814876">!=</span>&nbsp;<span class="ident" id="6814879">nil</span>&nbsp;<span class="op" id="6814883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814889">t</span><span class="op" id="6814890">.</span><span class="ident" id="6814891">Fatalf</span><span class="op" id="6814897">(</span><span class="string" id="6814898">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6814924">,</span>&nbsp;<span class="ident" id="6814926">err</span><span class="op" id="6814929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6814934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814939">rcvd</span>&nbsp;<span class="op" id="6814944">:=</span>&nbsp;<span class="op" id="6814947">&lt;-</span><span class="ident" id="6814949">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6814957">test</span><span class="op" id="6814961">.</span><span class="ident" id="6814962">exp</span>&nbsp;<span class="op" id="6814966">=</span>&nbsp;<span class="ident" id="6814968">fmt</span><span class="op" id="6814971">.</span><span class="ident" id="6814972">Sprintf</span><span class="op" id="6814979">(</span><span class="string" id="6814980">&#34;&lt;%d&gt;&#34;</span><span class="op" id="6814986">,</span>&nbsp;<span class="ident" id="6814988">test</span><span class="op" id="6814992">.</span><span class="ident" id="6814993">pri</span><span class="op" id="6814996">)</span>&nbsp;<span class="op" id="6814998">+</span>&nbsp;<span class="ident" id="6815000">test</span><span class="op" id="6815004">.</span><span class="ident" id="6815005">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815012">var</span>&nbsp;<span class="ident" id="6815016">parsedHostname</span><span class="op" id="6815030">,</span>&nbsp;<span class="ident" id="6815032">timestamp</span>&nbsp;<span class="builtintype" id="6815042">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815052">var</span>&nbsp;<span class="ident" id="6815056">pid</span>&nbsp;<span class="builtintype" id="6815060">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815067">if</span>&nbsp;<span class="ident" id="6815070">n</span><span class="op" id="6815071">,</span>&nbsp;<span class="ident" id="6815073">err</span>&nbsp;<span class="op" id="6815077">:=</span>&nbsp;<span class="ident" id="6815080">fmt</span><span class="op" id="6815083">.</span><span class="ident" id="6815084">Sscanf</span><span class="op" id="6815090">(</span><span class="ident" id="6815091">rcvd</span><span class="op" id="6815095">,</span>&nbsp;<span class="ident" id="6815097">test</span><span class="op" id="6815101">.</span><span class="ident" id="6815102">exp</span><span class="op" id="6815105">,</span>&nbsp;<span class="op" id="6815107">&amp;</span><span class="ident" id="6815108">timestamp</span><span class="op" id="6815117">,</span>&nbsp;<span class="op" id="6815119">&amp;</span><span class="ident" id="6815120">parsedHostname</span><span class="op" id="6815134">,</span>&nbsp;<span class="op" id="6815136">&amp;</span><span class="ident" id="6815137">pid</span><span class="op" id="6815140">)</span><span class="op" id="6815141">;</span>&nbsp;<span class="ident" id="6815143">n</span>&nbsp;<span class="op" id="6815145">!=</span>&nbsp;<span class="num" id="6815148">3</span>&nbsp;<span class="op" id="6815150">||</span>&nbsp;<span class="ident" id="6815153">err</span>&nbsp;<span class="op" id="6815157">!=</span>&nbsp;<span class="ident" id="6815160">nil</span>&nbsp;<span class="op" id="6815164">||</span>&nbsp;<span class="ident" id="6815167">hostname</span>&nbsp;<span class="op" id="6815176">!=</span>&nbsp;<span class="ident" id="6815179">parsedHostname</span>&nbsp;<span class="op" id="6815194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815200">t</span><span class="op" id="6815201">.</span><span class="ident" id="6815202">Errorf</span><span class="op" id="6815208">(</span><span class="string" id="6815209">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="6815253">,</span>&nbsp;<span class="ident" id="6815255">rcvd</span><span class="op" id="6815259">,</span>&nbsp;<span class="ident" id="6815261">test</span><span class="op" id="6815265">.</span><span class="ident" id="6815266">exp</span><span class="op" id="6815269">,</span>&nbsp;<span class="ident" id="6815271">n</span><span class="op" id="6815272">,</span>&nbsp;<span class="ident" id="6815274">err</span><span class="op" id="6815277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815282">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815289">}</span><br>
<span class="lineno"></span><span class="op" id="6815291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6815294">func</span>&nbsp;<span class="ident" id="6815299">TestConcurrentWrite</span><span class="op" id="6815318">(</span><span class="ident" id="6815319">t</span>&nbsp;<span class="op" id="6815321">*</span><span class="ident" id="6815322">testing</span><span class="op" id="6815329">.</span><span class="ident" id="6815330">T</span><span class="op" id="6815331">)</span>&nbsp;<span class="op" id="6815333">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815336">addr</span><span class="op" id="6815340">,</span>&nbsp;<span class="ident" id="6815342">sock</span><span class="op" id="6815346">,</span>&nbsp;<span class="ident" id="6815348">srvWG</span>&nbsp;<span class="op" id="6815354">:=</span>&nbsp;<span class="ident" id="6815357">startServer</span><span class="op" id="6815368">(</span><span class="string" id="6815369">&#34;udp&#34;</span><span class="op" id="6815374">,</span>&nbsp;<span class="string" id="6815376">&#34;&#34;</span><span class="op" id="6815378">,</span>&nbsp;<span class="builtinfunc" id="6815380">make</span><span class="op" id="6815384">(</span><span class="keyword" id="6815385">chan</span>&nbsp;<span class="builtintype" id="6815390">string</span><span class="op" id="6815396">,</span>&nbsp;<span class="num" id="6815398">1</span><span class="op" id="6815399">)</span><span class="op" id="6815400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815403">defer</span>&nbsp;<span class="ident" id="6815409">srvWG</span><span class="op" id="6815414">.</span><span class="ident" id="6815415">Wait</span><span class="op" id="6815419">(</span><span class="op" id="6815420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815423">defer</span>&nbsp;<span class="ident" id="6815429">sock</span><span class="op" id="6815433">.</span><span class="ident" id="6815434">Close</span><span class="op" id="6815439">(</span><span class="op" id="6815440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815443">w</span><span class="op" id="6815444">,</span>&nbsp;<span class="ident" id="6815446">err</span>&nbsp;<span class="op" id="6815450">:=</span>&nbsp;<span class="ident" id="6815453">Dial</span><span class="op" id="6815457">(</span><span class="string" id="6815458">&#34;udp&#34;</span><span class="op" id="6815463">,</span>&nbsp;<span class="ident" id="6815465">addr</span><span class="op" id="6815469">,</span>&nbsp;<span class="ident" id="6815471">LOG_USER</span><span class="op" id="6815479">|</span><span class="ident" id="6815480">LOG_ERR</span><span class="op" id="6815487">,</span>&nbsp;<span class="string" id="6815489">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="6815506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815509">if</span>&nbsp;<span class="ident" id="6815512">err</span>&nbsp;<span class="op" id="6815516">!=</span>&nbsp;<span class="ident" id="6815519">nil</span>&nbsp;<span class="op" id="6815523">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815527">t</span><span class="op" id="6815528">.</span><span class="ident" id="6815529">Fatalf</span><span class="op" id="6815535">(</span><span class="string" id="6815536">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6815562">,</span>&nbsp;<span class="ident" id="6815564">err</span><span class="op" id="6815567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815573">var</span>&nbsp;<span class="ident" id="6815577">wg</span>&nbsp;<span class="ident" id="6815580">sync</span><span class="op" id="6815584">.</span><span class="ident" id="6815585">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815596">for</span>&nbsp;<span class="ident" id="6815600">i</span>&nbsp;<span class="op" id="6815602">:=</span>&nbsp;<span class="num" id="6815605">0</span><span class="op" id="6815606">;</span>&nbsp;<span class="ident" id="6815608">i</span>&nbsp;<span class="op" id="6815610">&lt;</span>&nbsp;<span class="num" id="6815612">10</span><span class="op" id="6815614">;</span>&nbsp;<span class="ident" id="6815616">i</span><span class="op" id="6815617">++</span>&nbsp;<span class="op" id="6815620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815624">wg</span><span class="op" id="6815626">.</span><span class="ident" id="6815627">Add</span><span class="op" id="6815630">(</span><span class="num" id="6815631">1</span><span class="op" id="6815632">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815636">go</span>&nbsp;<span class="keyword" id="6815639">func</span><span class="op" id="6815643">(</span><span class="op" id="6815644">)</span>&nbsp;<span class="op" id="6815646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815651">defer</span>&nbsp;<span class="ident" id="6815657">wg</span><span class="op" id="6815659">.</span><span class="ident" id="6815660">Done</span><span class="op" id="6815664">(</span><span class="op" id="6815665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815670">err</span>&nbsp;<span class="op" id="6815674">:=</span>&nbsp;<span class="ident" id="6815677">w</span><span class="op" id="6815678">.</span><span class="ident" id="6815679">Info</span><span class="op" id="6815683">(</span><span class="string" id="6815684">&#34;test&#34;</span><span class="op" id="6815690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815695">if</span>&nbsp;<span class="ident" id="6815698">err</span>&nbsp;<span class="op" id="6815702">!=</span>&nbsp;<span class="ident" id="6815705">nil</span>&nbsp;<span class="op" id="6815709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815715">t</span><span class="op" id="6815716">.</span><span class="ident" id="6815717">Errorf</span><span class="op" id="6815723">(</span><span class="string" id="6815724">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6815743">,</span>&nbsp;<span class="ident" id="6815745">err</span><span class="op" id="6815748">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815754">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815768">}</span><span class="op" id="6815769">(</span><span class="op" id="6815770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6815773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815776">wg</span><span class="op" id="6815778">.</span><span class="ident" id="6815779">Wait</span><span class="op" id="6815783">(</span><span class="op" id="6815784">)</span><br>
<span class="lineno">300</span><span class="op" id="6815786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6815789">func</span>&nbsp;<span class="ident" id="6815794">TestConcurrentReconnect</span><span class="op" id="6815817">(</span><span class="ident" id="6815818">t</span>&nbsp;<span class="op" id="6815820">*</span><span class="ident" id="6815821">testing</span><span class="op" id="6815828">.</span><span class="ident" id="6815829">T</span><span class="op" id="6815830">)</span>&nbsp;<span class="op" id="6815832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815835">crashy</span>&nbsp;<span class="op" id="6815842">=</span>&nbsp;<span class="builtintype" id="6815844">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815850">defer</span>&nbsp;<span class="keyword" id="6815856">func</span><span class="op" id="6815860">(</span><span class="op" id="6815861">)</span>&nbsp;<span class="op" id="6815863">{</span>&nbsp;<span class="ident" id="6815865">crashy</span>&nbsp;<span class="op" id="6815872">=</span>&nbsp;<span class="builtintype" id="6815874">false</span>&nbsp;<span class="op" id="6815880">}</span><span class="op" id="6815881">(</span><span class="op" id="6815882">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815886">const</span>&nbsp;<span class="ident" id="6815892">N</span>&nbsp;<span class="op" id="6815894">=</span>&nbsp;<span class="num" id="6815896">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6815900">const</span>&nbsp;<span class="ident" id="6815906">M</span>&nbsp;<span class="op" id="6815908">=</span>&nbsp;<span class="num" id="6815910">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815915">net</span>&nbsp;<span class="op" id="6815919">:=</span>&nbsp;<span class="string" id="6815922">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815930">done</span>&nbsp;<span class="op" id="6815935">:=</span>&nbsp;<span class="builtinfunc" id="6815938">make</span><span class="op" id="6815942">(</span><span class="keyword" id="6815943">chan</span>&nbsp;<span class="builtintype" id="6815948">string</span><span class="op" id="6815954">,</span>&nbsp;<span class="ident" id="6815956">N</span><span class="op" id="6815957">*</span><span class="ident" id="6815958">M</span><span class="op" id="6815959">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6815962">addr</span><span class="op" id="6815966">,</span>&nbsp;<span class="ident" id="6815968">sock</span><span class="op" id="6815972">,</span>&nbsp;<span class="ident" id="6815974">srvWG</span>&nbsp;<span class="op" id="6815980">:=</span>&nbsp;<span class="ident" id="6815983">startServer</span><span class="op" id="6815994">(</span><span class="ident" id="6815995">net</span><span class="op" id="6815998">,</span>&nbsp;<span class="string" id="6816000">&#34;&#34;</span><span class="op" id="6816002">,</span>&nbsp;<span class="ident" id="6816004">done</span><span class="op" id="6816008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816011">defer</span>&nbsp;<span class="ident" id="6816017">os</span><span class="op" id="6816019">.</span><span class="ident" id="6816020">Remove</span><span class="op" id="6816026">(</span><span class="ident" id="6816027">addr</span><span class="op" id="6816031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6816035">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816071">count</span>&nbsp;<span class="op" id="6816077">:=</span>&nbsp;<span class="builtinfunc" id="6816080">make</span><span class="op" id="6816084">(</span><span class="keyword" id="6816085">chan</span>&nbsp;<span class="builtintype" id="6816090">int</span><span class="op" id="6816093">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816096">go</span>&nbsp;<span class="keyword" id="6816099">func</span><span class="op" id="6816103">(</span><span class="op" id="6816104">)</span>&nbsp;<span class="op" id="6816106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816110">ct</span>&nbsp;<span class="op" id="6816113">:=</span>&nbsp;<span class="num" id="6816116">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816120">for</span>&nbsp;<span class="keyword" id="6816124">range</span>&nbsp;<span class="ident" id="6816130">done</span>&nbsp;<span class="op" id="6816135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816140">ct</span><span class="op" id="6816142">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6816148">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6816196">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6816245">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816284">if</span>&nbsp;<span class="ident" id="6816287">ct</span>&nbsp;<span class="op" id="6816290">&gt;</span>&nbsp;<span class="ident" id="6816292">N</span><span class="op" id="6816293">*</span><span class="ident" id="6816294">M</span><span class="op" id="6816295">/</span><span class="num" id="6816296">2</span>&nbsp;<span class="op" id="6816298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816304">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816313">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816321">count</span>&nbsp;<span class="op" id="6816327">&lt;-</span>&nbsp;<span class="ident" id="6816330">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816334">}</span><span class="op" id="6816335">(</span><span class="op" id="6816336">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816340">var</span>&nbsp;<span class="ident" id="6816344">wg</span>&nbsp;<span class="ident" id="6816347">sync</span><span class="op" id="6816351">.</span><span class="ident" id="6816352">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816363">wg</span><span class="op" id="6816365">.</span><span class="ident" id="6816366">Add</span><span class="op" id="6816369">(</span><span class="ident" id="6816370">N</span><span class="op" id="6816371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816374">for</span>&nbsp;<span class="ident" id="6816378">i</span>&nbsp;<span class="op" id="6816380">:=</span>&nbsp;<span class="num" id="6816383">0</span><span class="op" id="6816384">;</span>&nbsp;<span class="ident" id="6816386">i</span>&nbsp;<span class="op" id="6816388">&lt;</span>&nbsp;<span class="ident" id="6816390">N</span><span class="op" id="6816391">;</span>&nbsp;<span class="ident" id="6816393">i</span><span class="op" id="6816394">++</span>&nbsp;<span class="op" id="6816397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816401">go</span>&nbsp;<span class="keyword" id="6816404">func</span><span class="op" id="6816408">(</span><span class="op" id="6816409">)</span>&nbsp;<span class="op" id="6816411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816416">defer</span>&nbsp;<span class="ident" id="6816422">wg</span><span class="op" id="6816424">.</span><span class="ident" id="6816425">Done</span><span class="op" id="6816429">(</span><span class="op" id="6816430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816435">w</span><span class="op" id="6816436">,</span>&nbsp;<span class="ident" id="6816438">err</span>&nbsp;<span class="op" id="6816442">:=</span>&nbsp;<span class="ident" id="6816445">Dial</span><span class="op" id="6816449">(</span><span class="ident" id="6816450">net</span><span class="op" id="6816453">,</span>&nbsp;<span class="ident" id="6816455">addr</span><span class="op" id="6816459">,</span>&nbsp;<span class="ident" id="6816461">LOG_USER</span><span class="op" id="6816469">|</span><span class="ident" id="6816470">LOG_ERR</span><span class="op" id="6816477">,</span>&nbsp;<span class="string" id="6816479">&#34;tag&#34;</span><span class="op" id="6816484">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816489">if</span>&nbsp;<span class="ident" id="6816492">err</span>&nbsp;<span class="op" id="6816496">!=</span>&nbsp;<span class="ident" id="6816499">nil</span>&nbsp;<span class="op" id="6816503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816509">t</span><span class="op" id="6816510">.</span><span class="ident" id="6816511">Fatalf</span><span class="op" id="6816517">(</span><span class="string" id="6816518">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6816544">,</span>&nbsp;<span class="ident" id="6816546">err</span><span class="op" id="6816549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816559">defer</span>&nbsp;<span class="ident" id="6816565">w</span><span class="op" id="6816566">.</span><span class="ident" id="6816567">Close</span><span class="op" id="6816572">(</span><span class="op" id="6816573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816578">for</span>&nbsp;<span class="ident" id="6816582">i</span>&nbsp;<span class="op" id="6816584">:=</span>&nbsp;<span class="num" id="6816587">0</span><span class="op" id="6816588">;</span>&nbsp;<span class="ident" id="6816590">i</span>&nbsp;<span class="op" id="6816592">&lt;</span>&nbsp;<span class="ident" id="6816594">M</span><span class="op" id="6816595">;</span>&nbsp;<span class="ident" id="6816597">i</span><span class="op" id="6816598">++</span>&nbsp;<span class="op" id="6816601">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816607">err</span>&nbsp;<span class="op" id="6816611">:=</span>&nbsp;<span class="ident" id="6816614">w</span><span class="op" id="6816615">.</span><span class="ident" id="6816616">Info</span><span class="op" id="6816620">(</span><span class="string" id="6816621">&#34;test&#34;</span><span class="op" id="6816627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816633">if</span>&nbsp;<span class="ident" id="6816636">err</span>&nbsp;<span class="op" id="6816640">!=</span>&nbsp;<span class="ident" id="6816643">nil</span>&nbsp;<span class="op" id="6816647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816654">t</span><span class="op" id="6816655">.</span><span class="ident" id="6816656">Errorf</span><span class="op" id="6816662">(</span><span class="string" id="6816663">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6816682">,</span>&nbsp;<span class="ident" id="6816684">err</span><span class="op" id="6816687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816694">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816705">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816714">}</span><span class="op" id="6816715">(</span><span class="op" id="6816716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816722">wg</span><span class="op" id="6816724">.</span><span class="ident" id="6816725">Wait</span><span class="op" id="6816729">(</span><span class="op" id="6816730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816733">sock</span><span class="op" id="6816737">.</span><span class="ident" id="6816738">Close</span><span class="op" id="6816743">(</span><span class="op" id="6816744">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816747">srvWG</span><span class="op" id="6816752">.</span><span class="ident" id="6816753">Wait</span><span class="op" id="6816757">(</span><span class="op" id="6816758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6816761">close</span><span class="op" id="6816766">(</span><span class="ident" id="6816767">done</span><span class="op" id="6816771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816775">select</span>&nbsp;<span class="op" id="6816782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816785">case</span>&nbsp;<span class="op" id="6816790">&lt;-</span><span class="ident" id="6816792">count</span><span class="op" id="6816797">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6816800">case</span>&nbsp;<span class="op" id="6816805">&lt;-</span><span class="ident" id="6816807">time</span><span class="op" id="6816811">.</span><span class="ident" id="6816812">After</span><span class="op" id="6816817">(</span><span class="num" id="6816818">100</span>&nbsp;<span class="op" id="6816822">*</span>&nbsp;<span class="ident" id="6816824">time</span><span class="op" id="6816828">.</span><span class="ident" id="6816829">Millisecond</span><span class="op" id="6816840">)</span><span class="op" id="6816841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6816845">t</span><span class="op" id="6816846">.</span><span class="ident" id="6816847">Error</span><span class="op" id="6816852">(</span><span class="string" id="6816853">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="6816886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6816889">}</span><br>
<span class="lineno"></span><span class="op" id="6816891">}</span>
</div>
</body>
</html>
