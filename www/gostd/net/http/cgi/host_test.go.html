<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7642236">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7642291">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7642345">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7642396">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7642422">package</span>&nbsp;<span class="ident" id="7642430">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7642435">import</span>&nbsp;<span class="op" id="7642442">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642445">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642454">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642461">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642467">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642474">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642486">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642507">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642513">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642524">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642541">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642552">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642563">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642574">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7642585">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7642592">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="7642595">func</span>&nbsp;<span class="ident" id="7642600">newRequest</span><span class="op" id="7642610">(</span><span class="ident" id="7642611">httpreq</span>&nbsp;<span class="builtintype" id="7642619">string</span><span class="op" id="7642625">)</span>&nbsp;<span class="op" id="7642627">*</span><span class="ident" id="7642628">http</span><span class="op" id="7642632">.</span><span class="ident" id="7642633">Request</span>&nbsp;<span class="op" id="7642641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642644">buf</span>&nbsp;<span class="op" id="7642648">:=</span>&nbsp;<span class="ident" id="7642651">bufio</span><span class="op" id="7642656">.</span><span class="ident" id="7642657">NewReader</span><span class="op" id="7642666">(</span><span class="ident" id="7642667">strings</span><span class="op" id="7642674">.</span><span class="ident" id="7642675">NewReader</span><span class="op" id="7642684">(</span><span class="ident" id="7642685">httpreq</span><span class="op" id="7642692">)</span><span class="op" id="7642693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642696">req</span><span class="op" id="7642699">,</span>&nbsp;<span class="ident" id="7642701">err</span>&nbsp;<span class="op" id="7642705">:=</span>&nbsp;<span class="ident" id="7642708">http</span><span class="op" id="7642712">.</span><span class="ident" id="7642713">ReadRequest</span><span class="op" id="7642724">(</span><span class="ident" id="7642725">buf</span><span class="op" id="7642728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642731">if</span>&nbsp;<span class="ident" id="7642734">err</span>&nbsp;<span class="op" id="7642738">!=</span>&nbsp;<span class="ident" id="7642741">nil</span>&nbsp;<span class="op" id="7642745">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7642749">panic</span><span class="op" id="7642754">(</span><span class="string" id="7642755">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="7642791">+</span>&nbsp;<span class="ident" id="7642793">httpreq</span><span class="op" id="7642800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642806">req</span><span class="op" id="7642809">.</span><span class="ident" id="7642810">RemoteAddr</span>&nbsp;<span class="op" id="7642821">=</span>&nbsp;<span class="string" id="7642823">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642834">return</span>&nbsp;<span class="ident" id="7642841">req</span><br>
<span class="lineno"></span><span class="op" id="7642845">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="7642848">func</span>&nbsp;<span class="ident" id="7642853">runCgiTest</span><span class="op" id="7642863">(</span><span class="ident" id="7642864">t</span>&nbsp;<span class="op" id="7642866">*</span><span class="ident" id="7642867">testing</span><span class="op" id="7642874">.</span><span class="ident" id="7642875">T</span><span class="op" id="7642876">,</span>&nbsp;<span class="ident" id="7642878">h</span>&nbsp;<span class="op" id="7642880">*</span><span class="ident" id="7642881">Handler</span><span class="op" id="7642888">,</span>&nbsp;<span class="ident" id="7642890">httpreq</span>&nbsp;<span class="builtintype" id="7642898">string</span><span class="op" id="7642904">,</span>&nbsp;<span class="ident" id="7642906">expectedMap</span>&nbsp;<span class="keyword" id="7642918">map</span><span class="op" id="7642921">[</span><span class="builtintype" id="7642922">string</span><span class="op" id="7642928">]</span><span class="builtintype" id="7642929">string</span><span class="op" id="7642935">)</span>&nbsp;<span class="op" id="7642937">*</span><span class="ident" id="7642938">httptest</span><span class="op" id="7642946">.</span><span class="ident" id="7642947">ResponseRecorder</span>&nbsp;<span class="op" id="7642964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642967">rw</span>&nbsp;<span class="op" id="7642970">:=</span>&nbsp;<span class="ident" id="7642973">httptest</span><span class="op" id="7642981">.</span><span class="ident" id="7642982">NewRecorder</span><span class="op" id="7642993">(</span><span class="op" id="7642994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642997">req</span>&nbsp;<span class="op" id="7643001">:=</span>&nbsp;<span class="ident" id="7643004">newRequest</span><span class="op" id="7643014">(</span><span class="ident" id="7643015">httpreq</span><span class="op" id="7643022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643025">h</span><span class="op" id="7643026">.</span><span class="ident" id="7643027">ServeHTTP</span><span class="op" id="7643036">(</span><span class="ident" id="7643037">rw</span><span class="op" id="7643039">,</span>&nbsp;<span class="ident" id="7643041">req</span><span class="op" id="7643044">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7643048">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643106">m</span>&nbsp;<span class="op" id="7643108">:=</span>&nbsp;<span class="builtinfunc" id="7643111">make</span><span class="op" id="7643115">(</span><span class="keyword" id="7643116">map</span><span class="op" id="7643119">[</span><span class="builtintype" id="7643120">string</span><span class="op" id="7643126">]</span><span class="builtintype" id="7643127">string</span><span class="op" id="7643133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643136">m</span><span class="op" id="7643137">[</span><span class="string" id="7643138">&#34;_body&#34;</span><span class="op" id="7643145">]</span>&nbsp;<span class="op" id="7643147">=</span>&nbsp;<span class="ident" id="7643149">rw</span><span class="op" id="7643151">.</span><span class="ident" id="7643152">Body</span><span class="op" id="7643156">.</span><span class="ident" id="7643157">String</span><span class="op" id="7643163">(</span><span class="op" id="7643164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643167">linesRead</span>&nbsp;<span class="op" id="7643177">:=</span>&nbsp;<span class="num" id="7643180">0</span><br>
<span class="lineno">45</span><span class="ident" id="7643182">readlines</span><span class="op" id="7643191">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643194">for</span>&nbsp;<span class="op" id="7643198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643202">line</span><span class="op" id="7643206">,</span>&nbsp;<span class="ident" id="7643208">err</span>&nbsp;<span class="op" id="7643212">:=</span>&nbsp;<span class="ident" id="7643215">rw</span><span class="op" id="7643217">.</span><span class="ident" id="7643218">Body</span><span class="op" id="7643222">.</span><span class="ident" id="7643223">ReadString</span><span class="op" id="7643233">(</span><span class="string" id="7643234">&#39;\n&#39;</span><span class="op" id="7643238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643242">switch</span>&nbsp;<span class="op" id="7643249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643253">case</span>&nbsp;<span class="ident" id="7643258">err</span>&nbsp;<span class="op" id="7643262">==</span>&nbsp;<span class="ident" id="7643265">io</span><span class="op" id="7643267">.</span><span class="ident" id="7643268">EOF</span><span class="op" id="7643271">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643276">break</span>&nbsp;<span class="ident" id="7643282">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643294">case</span>&nbsp;<span class="ident" id="7643299">err</span>&nbsp;<span class="op" id="7643303">!=</span>&nbsp;<span class="ident" id="7643306">nil</span><span class="op" id="7643309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643314">t</span><span class="op" id="7643315">.</span><span class="ident" id="7643316">Fatalf</span><span class="op" id="7643322">(</span><span class="string" id="7643323">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="7643362">,</span>&nbsp;<span class="ident" id="7643364">err</span><span class="op" id="7643367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643375">linesRead</span><span class="op" id="7643384">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643389">trimmedLine</span>&nbsp;<span class="op" id="7643401">:=</span>&nbsp;<span class="ident" id="7643404">strings</span><span class="op" id="7643411">.</span><span class="ident" id="7643412">TrimRight</span><span class="op" id="7643421">(</span><span class="ident" id="7643422">line</span><span class="op" id="7643426">,</span>&nbsp;<span class="string" id="7643428">&#34;\r\n&#34;</span><span class="op" id="7643434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643438">split</span>&nbsp;<span class="op" id="7643444">:=</span>&nbsp;<span class="ident" id="7643447">strings</span><span class="op" id="7643454">.</span><span class="ident" id="7643455">SplitN</span><span class="op" id="7643461">(</span><span class="ident" id="7643462">trimmedLine</span><span class="op" id="7643473">,</span>&nbsp;<span class="string" id="7643475">&#34;=&#34;</span><span class="op" id="7643478">,</span>&nbsp;<span class="num" id="7643480">2</span><span class="op" id="7643481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643485">if</span>&nbsp;<span class="builtinfunc" id="7643488">len</span><span class="op" id="7643491">(</span><span class="ident" id="7643492">split</span><span class="op" id="7643497">)</span>&nbsp;<span class="op" id="7643499">!=</span>&nbsp;<span class="num" id="7643502">2</span>&nbsp;<span class="op" id="7643504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643509">t</span><span class="op" id="7643510">.</span><span class="ident" id="7643511">Fatalf</span><span class="op" id="7643517">(</span><span class="string" id="7643518">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="7643588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7643594">len</span><span class="op" id="7643597">(</span><span class="ident" id="7643598">split</span><span class="op" id="7643603">)</span><span class="op" id="7643604">,</span>&nbsp;<span class="ident" id="7643606">linesRead</span><span class="op" id="7643615">,</span>&nbsp;<span class="ident" id="7643617">line</span><span class="op" id="7643621">,</span>&nbsp;<span class="ident" id="7643623">m</span><span class="op" id="7643624">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643632">m</span><span class="op" id="7643633">[</span><span class="ident" id="7643634">split</span><span class="op" id="7643639">[</span><span class="num" id="7643640">0</span><span class="op" id="7643641">]</span><span class="op" id="7643642">]</span>&nbsp;<span class="op" id="7643644">=</span>&nbsp;<span class="ident" id="7643646">split</span><span class="op" id="7643651">[</span><span class="num" id="7643652">1</span><span class="op" id="7643653">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643660">for</span>&nbsp;<span class="ident" id="7643664">key</span><span class="op" id="7643667">,</span>&nbsp;<span class="ident" id="7643669">expected</span>&nbsp;<span class="op" id="7643678">:=</span>&nbsp;<span class="keyword" id="7643681">range</span>&nbsp;<span class="ident" id="7643687">expectedMap</span>&nbsp;<span class="op" id="7643699">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643703">got</span>&nbsp;<span class="op" id="7643707">:=</span>&nbsp;<span class="ident" id="7643710">m</span><span class="op" id="7643711">[</span><span class="ident" id="7643712">key</span><span class="op" id="7643715">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643719">if</span>&nbsp;<span class="ident" id="7643722">key</span>&nbsp;<span class="op" id="7643726">==</span>&nbsp;<span class="string" id="7643729">&#34;cwd&#34;</span>&nbsp;<span class="op" id="7643735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7643740">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643782">fi1</span><span class="op" id="7643785">,</span>&nbsp;<span class="ident" id="7643787">_</span>&nbsp;<span class="op" id="7643789">:=</span>&nbsp;<span class="ident" id="7643792">os</span><span class="op" id="7643794">.</span><span class="ident" id="7643795">Stat</span><span class="op" id="7643799">(</span><span class="ident" id="7643800">got</span><span class="op" id="7643803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643808">fi2</span><span class="op" id="7643811">,</span>&nbsp;<span class="ident" id="7643813">_</span>&nbsp;<span class="op" id="7643815">:=</span>&nbsp;<span class="ident" id="7643818">os</span><span class="op" id="7643820">.</span><span class="ident" id="7643821">Stat</span><span class="op" id="7643825">(</span><span class="ident" id="7643826">expected</span><span class="op" id="7643834">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643839">if</span>&nbsp;<span class="ident" id="7643842">os</span><span class="op" id="7643844">.</span><span class="ident" id="7643845">SameFile</span><span class="op" id="7643853">(</span><span class="ident" id="7643854">fi1</span><span class="op" id="7643857">,</span>&nbsp;<span class="ident" id="7643859">fi2</span><span class="op" id="7643862">)</span>&nbsp;<span class="op" id="7643864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643870">got</span>&nbsp;<span class="op" id="7643874">=</span>&nbsp;<span class="ident" id="7643876">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643896">if</span>&nbsp;<span class="ident" id="7643899">got</span>&nbsp;<span class="op" id="7643903">!=</span>&nbsp;<span class="ident" id="7643906">expected</span>&nbsp;<span class="op" id="7643915">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643920">t</span><span class="op" id="7643921">.</span><span class="ident" id="7643922">Errorf</span><span class="op" id="7643928">(</span><span class="string" id="7643929">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7643961">,</span>&nbsp;<span class="ident" id="7643963">key</span><span class="op" id="7643966">,</span>&nbsp;<span class="ident" id="7643968">got</span><span class="op" id="7643971">,</span>&nbsp;<span class="ident" id="7643973">expected</span><span class="op" id="7643981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643991">return</span>&nbsp;<span class="ident" id="7643998">rw</span><br>
<span class="lineno"></span><span class="op" id="7644001">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7644004">var</span>&nbsp;<span class="ident" id="7644008">cgiTested</span><span class="op" id="7644017">,</span>&nbsp;<span class="ident" id="7644019">cgiWorks</span>&nbsp;<span class="builtintype" id="7644028">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7644034">func</span>&nbsp;<span class="ident" id="7644039">check</span><span class="op" id="7644044">(</span><span class="ident" id="7644045">t</span>&nbsp;<span class="op" id="7644047">*</span><span class="ident" id="7644048">testing</span><span class="op" id="7644055">.</span><span class="ident" id="7644056">T</span><span class="op" id="7644057">)</span>&nbsp;<span class="op" id="7644059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644062">if</span>&nbsp;<span class="op" id="7644065">!</span><span class="ident" id="7644066">cgiTested</span>&nbsp;<span class="op" id="7644076">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644080">cgiTested</span>&nbsp;<span class="op" id="7644090">=</span>&nbsp;<span class="builtintype" id="7644092">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644099">cgiWorks</span>&nbsp;<span class="op" id="7644108">=</span>&nbsp;<span class="ident" id="7644110">exec</span><span class="op" id="7644114">.</span><span class="ident" id="7644115">Command</span><span class="op" id="7644122">(</span><span class="string" id="7644123">&#34;./testdata/test.cgi&#34;</span><span class="op" id="7644144">)</span><span class="op" id="7644145">.</span><span class="ident" id="7644146">Run</span><span class="op" id="7644149">(</span><span class="op" id="7644150">)</span>&nbsp;<span class="op" id="7644152">==</span>&nbsp;<span class="ident" id="7644155">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644163">if</span>&nbsp;<span class="op" id="7644166">!</span><span class="ident" id="7644167">cgiWorks</span>&nbsp;<span class="op" id="7644176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7644180">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7644224">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644275">t</span><span class="op" id="7644276">.</span><span class="ident" id="7644277">Skip</span><span class="op" id="7644281">(</span><span class="string" id="7644282">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="7644315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644318">}</span><br>
<span class="lineno"></span><span class="op" id="7644320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7644323">func</span>&nbsp;<span class="ident" id="7644328">TestCGIBasicGet</span><span class="op" id="7644343">(</span><span class="ident" id="7644344">t</span>&nbsp;<span class="op" id="7644346">*</span><span class="ident" id="7644347">testing</span><span class="op" id="7644354">.</span><span class="ident" id="7644355">T</span><span class="op" id="7644356">)</span>&nbsp;<span class="op" id="7644358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644361">check</span><span class="op" id="7644366">(</span><span class="ident" id="7644367">t</span><span class="op" id="7644368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644371">h</span>&nbsp;<span class="op" id="7644373">:=</span>&nbsp;<span class="op" id="7644376">&amp;</span><span class="ident" id="7644377">Handler</span><span class="op" id="7644384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644388">Path</span><span class="op" id="7644392">:</span>&nbsp;<span class="string" id="7644394">&#34;testdata/test.cgi&#34;</span><span class="op" id="7644413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644417">Root</span><span class="op" id="7644421">:</span>&nbsp;<span class="string" id="7644423">&#34;/test.cgi&#34;</span><span class="op" id="7644434">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644440">expectedMap</span>&nbsp;<span class="op" id="7644452">:=</span>&nbsp;<span class="keyword" id="7644455">map</span><span class="op" id="7644458">[</span><span class="builtintype" id="7644459">string</span><span class="op" id="7644465">]</span><span class="builtintype" id="7644466">string</span><span class="op" id="7644472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644476">&#34;test&#34;</span><span class="op" id="7644482">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644501">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7644512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644516">&#34;param-a&#34;</span><span class="op" id="7644525">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644541">&#34;b&#34;</span><span class="op" id="7644544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644548">&#34;param-foo&#34;</span><span class="op" id="7644559">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644573">&#34;bar&#34;</span><span class="op" id="7644578">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644582">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7644605">:</span>&nbsp;<span class="string" id="7644607">&#34;CGI/1.1&#34;</span><span class="op" id="7644616">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644620">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7644635">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644645">&#34;example.com&#34;</span><span class="op" id="7644658">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644662">&#34;env-PATH_INFO&#34;</span><span class="op" id="7644677">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644687">&#34;&#34;</span><span class="op" id="7644689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644693">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7644711">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644718">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7644731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644735">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7644752">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644760">&#34;1.2.3.4&#34;</span><span class="op" id="7644769">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644773">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7644790">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644798">&#34;1.2.3.4&#34;</span><span class="op" id="7644807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644811">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7644831">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644836">&#34;GET&#34;</span><span class="op" id="7644841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644845">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7644862">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644870">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7644893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644897">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7644918">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7644922">&#34;testdata/test.cgi&#34;</span><span class="op" id="7644941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644945">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7644962">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7644970">&#34;/test.cgi&#34;</span><span class="op" id="7644981">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7644985">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7645002">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7645010">&#34;example.com&#34;</span><span class="op" id="7645023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7645027">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7645044">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7645052">&#34;80&#34;</span><span class="op" id="7645056">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7645060">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7645081">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7645085">&#34;go&#34;</span><span class="op" id="7645089">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645095">replay</span>&nbsp;<span class="op" id="7645102">:=</span>&nbsp;<span class="ident" id="7645105">runCgiTest</span><span class="op" id="7645115">(</span><span class="ident" id="7645116">t</span><span class="op" id="7645117">,</span>&nbsp;<span class="ident" id="7645119">h</span><span class="op" id="7645120">,</span>&nbsp;<span class="string" id="7645122">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7645181">,</span>&nbsp;<span class="ident" id="7645183">expectedMap</span><span class="op" id="7645194">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645198">if</span>&nbsp;<span class="ident" id="7645201">expected</span><span class="op" id="7645209">,</span>&nbsp;<span class="ident" id="7645211">got</span>&nbsp;<span class="op" id="7645215">:=</span>&nbsp;<span class="string" id="7645218">&#34;text/html&#34;</span><span class="op" id="7645229">,</span>&nbsp;<span class="ident" id="7645231">replay</span><span class="op" id="7645237">.</span><span class="ident" id="7645238">Header</span><span class="op" id="7645244">(</span><span class="op" id="7645245">)</span><span class="op" id="7645246">.</span><span class="ident" id="7645247">Get</span><span class="op" id="7645250">(</span><span class="string" id="7645251">&#34;Content-Type&#34;</span><span class="op" id="7645265">)</span><span class="op" id="7645266">;</span>&nbsp;<span class="ident" id="7645268">got</span>&nbsp;<span class="op" id="7645272">!=</span>&nbsp;<span class="ident" id="7645275">expected</span>&nbsp;<span class="op" id="7645284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645288">t</span><span class="op" id="7645289">.</span><span class="ident" id="7645290">Errorf</span><span class="op" id="7645296">(</span><span class="string" id="7645297">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7645336">,</span>&nbsp;<span class="ident" id="7645338">got</span><span class="op" id="7645341">,</span>&nbsp;<span class="ident" id="7645343">expected</span><span class="op" id="7645351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645357">if</span>&nbsp;<span class="ident" id="7645360">expected</span><span class="op" id="7645368">,</span>&nbsp;<span class="ident" id="7645370">got</span>&nbsp;<span class="op" id="7645374">:=</span>&nbsp;<span class="string" id="7645377">&#34;X-Test-Value&#34;</span><span class="op" id="7645391">,</span>&nbsp;<span class="ident" id="7645393">replay</span><span class="op" id="7645399">.</span><span class="ident" id="7645400">Header</span><span class="op" id="7645406">(</span><span class="op" id="7645407">)</span><span class="op" id="7645408">.</span><span class="ident" id="7645409">Get</span><span class="op" id="7645412">(</span><span class="string" id="7645413">&#34;X-Test-Header&#34;</span><span class="op" id="7645428">)</span><span class="op" id="7645429">;</span>&nbsp;<span class="ident" id="7645431">got</span>&nbsp;<span class="op" id="7645435">!=</span>&nbsp;<span class="ident" id="7645438">expected</span>&nbsp;<span class="op" id="7645447">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645451">t</span><span class="op" id="7645452">.</span><span class="ident" id="7645453">Errorf</span><span class="op" id="7645459">(</span><span class="string" id="7645460">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7645500">,</span>&nbsp;<span class="ident" id="7645502">got</span><span class="op" id="7645505">,</span>&nbsp;<span class="ident" id="7645507">expected</span><span class="op" id="7645515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645518">}</span><br>
<span class="lineno"></span><span class="op" id="7645520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7645523">func</span>&nbsp;<span class="ident" id="7645528">TestCGIBasicGetAbsPath</span><span class="op" id="7645550">(</span><span class="ident" id="7645551">t</span>&nbsp;<span class="op" id="7645553">*</span><span class="ident" id="7645554">testing</span><span class="op" id="7645561">.</span><span class="ident" id="7645562">T</span><span class="op" id="7645563">)</span>&nbsp;<span class="op" id="7645565">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645568">check</span><span class="op" id="7645573">(</span><span class="ident" id="7645574">t</span><span class="op" id="7645575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645578">pwd</span><span class="op" id="7645581">,</span>&nbsp;<span class="ident" id="7645583">err</span>&nbsp;<span class="op" id="7645587">:=</span>&nbsp;<span class="ident" id="7645590">os</span><span class="op" id="7645592">.</span><span class="ident" id="7645593">Getwd</span><span class="op" id="7645598">(</span><span class="op" id="7645599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645602">if</span>&nbsp;<span class="ident" id="7645605">err</span>&nbsp;<span class="op" id="7645609">!=</span>&nbsp;<span class="ident" id="7645612">nil</span>&nbsp;<span class="op" id="7645616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645620">t</span><span class="op" id="7645621">.</span><span class="ident" id="7645622">Fatalf</span><span class="op" id="7645628">(</span><span class="string" id="7645629">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7645646">,</span>&nbsp;<span class="ident" id="7645648">err</span><span class="op" id="7645651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645654">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645657">h</span>&nbsp;<span class="op" id="7645659">:=</span>&nbsp;<span class="op" id="7645662">&amp;</span><span class="ident" id="7645663">Handler</span><span class="op" id="7645670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645674">Path</span><span class="op" id="7645678">:</span>&nbsp;<span class="ident" id="7645680">pwd</span>&nbsp;<span class="op" id="7645684">+</span>&nbsp;<span class="string" id="7645686">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7645706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645710">Root</span><span class="op" id="7645714">:</span>&nbsp;<span class="string" id="7645716">&#34;/test.cgi&#34;</span><span class="op" id="7645727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645733">expectedMap</span>&nbsp;<span class="op" id="7645745">:=</span>&nbsp;<span class="keyword" id="7645748">map</span><span class="op" id="7645751">[</span><span class="builtintype" id="7645752">string</span><span class="op" id="7645758">]</span><span class="builtintype" id="7645759">string</span><span class="op" id="7645765">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7645769">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7645786">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7645792">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7645815">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7645819">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7645840">:</span>&nbsp;<span class="ident" id="7645842">pwd</span>&nbsp;<span class="op" id="7645846">+</span>&nbsp;<span class="string" id="7645848">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7645868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7645872">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7645889">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7645895">&#34;/test.cgi&#34;</span><span class="op" id="7645906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645912">runCgiTest</span><span class="op" id="7645922">(</span><span class="ident" id="7645923">t</span><span class="op" id="7645924">,</span>&nbsp;<span class="ident" id="7645926">h</span><span class="op" id="7645927">,</span>&nbsp;<span class="string" id="7645929">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7645988">,</span>&nbsp;<span class="ident" id="7645990">expectedMap</span><span class="op" id="7646001">)</span><br>
<span class="lineno">145</span><span class="op" id="7646003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7646006">func</span>&nbsp;<span class="ident" id="7646011">TestPathInfo</span><span class="op" id="7646023">(</span><span class="ident" id="7646024">t</span>&nbsp;<span class="op" id="7646026">*</span><span class="ident" id="7646027">testing</span><span class="op" id="7646034">.</span><span class="ident" id="7646035">T</span><span class="op" id="7646036">)</span>&nbsp;<span class="op" id="7646038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646041">check</span><span class="op" id="7646046">(</span><span class="ident" id="7646047">t</span><span class="op" id="7646048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646051">h</span>&nbsp;<span class="op" id="7646053">:=</span>&nbsp;<span class="op" id="7646056">&amp;</span><span class="ident" id="7646057">Handler</span><span class="op" id="7646064">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646068">Path</span><span class="op" id="7646072">:</span>&nbsp;<span class="string" id="7646074">&#34;testdata/test.cgi&#34;</span><span class="op" id="7646093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646097">Root</span><span class="op" id="7646101">:</span>&nbsp;<span class="string" id="7646103">&#34;/test.cgi&#34;</span><span class="op" id="7646114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646120">expectedMap</span>&nbsp;<span class="op" id="7646132">:=</span>&nbsp;<span class="keyword" id="7646135">map</span><span class="op" id="7646138">[</span><span class="builtintype" id="7646139">string</span><span class="op" id="7646145">]</span><span class="builtintype" id="7646146">string</span><span class="op" id="7646152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646156">&#34;param-a&#34;</span><span class="op" id="7646165">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646179">&#34;b&#34;</span><span class="op" id="7646182">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646186">&#34;env-PATH_INFO&#34;</span><span class="op" id="7646201">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646209">&#34;/extrapath&#34;</span><span class="op" id="7646221">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646225">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7646243">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646248">&#34;a=b&#34;</span><span class="op" id="7646253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646257">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7646274">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646280">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="7646305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646309">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7646330">:</span>&nbsp;<span class="string" id="7646332">&#34;testdata/test.cgi&#34;</span><span class="op" id="7646351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646355">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7646372">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646378">&#34;/test.cgi&#34;</span><span class="op" id="7646389">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646395">runCgiTest</span><span class="op" id="7646405">(</span><span class="ident" id="7646406">t</span><span class="op" id="7646407">,</span>&nbsp;<span class="ident" id="7646409">h</span><span class="op" id="7646410">,</span>&nbsp;<span class="string" id="7646412">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7646473">,</span>&nbsp;<span class="ident" id="7646475">expectedMap</span><span class="op" id="7646486">)</span><br>
<span class="lineno"></span><span class="op" id="7646488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7646491">func</span>&nbsp;<span class="ident" id="7646496">TestPathInfoDirRoot</span><span class="op" id="7646515">(</span><span class="ident" id="7646516">t</span>&nbsp;<span class="op" id="7646518">*</span><span class="ident" id="7646519">testing</span><span class="op" id="7646526">.</span><span class="ident" id="7646527">T</span><span class="op" id="7646528">)</span>&nbsp;<span class="op" id="7646530">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646533">check</span><span class="op" id="7646538">(</span><span class="ident" id="7646539">t</span><span class="op" id="7646540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646543">h</span>&nbsp;<span class="op" id="7646545">:=</span>&nbsp;<span class="op" id="7646548">&amp;</span><span class="ident" id="7646549">Handler</span><span class="op" id="7646556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646560">Path</span><span class="op" id="7646564">:</span>&nbsp;<span class="string" id="7646566">&#34;testdata/test.cgi&#34;</span><span class="op" id="7646585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646589">Root</span><span class="op" id="7646593">:</span>&nbsp;<span class="string" id="7646595">&#34;/myscript/&#34;</span><span class="op" id="7646607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646610">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646613">expectedMap</span>&nbsp;<span class="op" id="7646625">:=</span>&nbsp;<span class="keyword" id="7646628">map</span><span class="op" id="7646631">[</span><span class="builtintype" id="7646632">string</span><span class="op" id="7646638">]</span><span class="builtintype" id="7646639">string</span><span class="op" id="7646645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646649">&#34;env-PATH_INFO&#34;</span><span class="op" id="7646664">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646672">&#34;bar&#34;</span><span class="op" id="7646677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646681">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7646699">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646704">&#34;a=b&#34;</span><span class="op" id="7646709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646713">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7646730">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646736">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7646755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646759">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7646780">:</span>&nbsp;<span class="string" id="7646782">&#34;testdata/test.cgi&#34;</span><span class="op" id="7646801">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7646805">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7646822">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7646828">&#34;/myscript/&#34;</span><span class="op" id="7646840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646846">runCgiTest</span><span class="op" id="7646856">(</span><span class="ident" id="7646857">t</span><span class="op" id="7646858">,</span>&nbsp;<span class="ident" id="7646860">h</span><span class="op" id="7646861">,</span>&nbsp;<span class="string" id="7646863">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7646918">,</span>&nbsp;<span class="ident" id="7646920">expectedMap</span><span class="op" id="7646931">)</span><br>
<span class="lineno"></span><span class="op" id="7646933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7646936">func</span>&nbsp;<span class="ident" id="7646941">TestDupHeaders</span><span class="op" id="7646955">(</span><span class="ident" id="7646956">t</span>&nbsp;<span class="op" id="7646958">*</span><span class="ident" id="7646959">testing</span><span class="op" id="7646966">.</span><span class="ident" id="7646967">T</span><span class="op" id="7646968">)</span>&nbsp;<span class="op" id="7646970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646973">check</span><span class="op" id="7646978">(</span><span class="ident" id="7646979">t</span><span class="op" id="7646980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646983">h</span>&nbsp;<span class="op" id="7646985">:=</span>&nbsp;<span class="op" id="7646988">&amp;</span><span class="ident" id="7646989">Handler</span><span class="op" id="7646996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647000">Path</span><span class="op" id="7647004">:</span>&nbsp;<span class="string" id="7647006">&#34;testdata/test.cgi&#34;</span><span class="op" id="7647025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647028">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647031">expectedMap</span>&nbsp;<span class="op" id="7647043">:=</span>&nbsp;<span class="keyword" id="7647046">map</span><span class="op" id="7647049">[</span><span class="builtintype" id="7647050">string</span><span class="op" id="7647056">]</span><span class="builtintype" id="7647057">string</span><span class="op" id="7647063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647067">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7647084">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647090">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7647109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647113">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7647134">:</span>&nbsp;<span class="string" id="7647136">&#34;testdata/test.cgi&#34;</span><span class="op" id="7647155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647159">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="7647176">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647182">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="7647200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647204">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="7647220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647227">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="7647239">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647245">runCgiTest</span><span class="op" id="7647255">(</span><span class="ident" id="7647256">t</span><span class="op" id="7647257">,</span>&nbsp;<span class="ident" id="7647259">h</span><span class="op" id="7647260">,</span>&nbsp;<span class="string" id="7647262">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="7647296">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647300">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="7647319">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647323">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="7647342">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647346">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="7647361">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647365">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="7647380">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647384">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="7647407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647411">expectedMap</span><span class="op" id="7647422">)</span><br>
<span class="lineno"></span><span class="op" id="7647424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="7647427">func</span>&nbsp;<span class="ident" id="7647432">TestPathInfoNoRoot</span><span class="op" id="7647450">(</span><span class="ident" id="7647451">t</span>&nbsp;<span class="op" id="7647453">*</span><span class="ident" id="7647454">testing</span><span class="op" id="7647461">.</span><span class="ident" id="7647462">T</span><span class="op" id="7647463">)</span>&nbsp;<span class="op" id="7647465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647468">check</span><span class="op" id="7647473">(</span><span class="ident" id="7647474">t</span><span class="op" id="7647475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647478">h</span>&nbsp;<span class="op" id="7647480">:=</span>&nbsp;<span class="op" id="7647483">&amp;</span><span class="ident" id="7647484">Handler</span><span class="op" id="7647491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647495">Path</span><span class="op" id="7647499">:</span>&nbsp;<span class="string" id="7647501">&#34;testdata/test.cgi&#34;</span><span class="op" id="7647520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647524">Root</span><span class="op" id="7647528">:</span>&nbsp;<span class="string" id="7647530">&#34;&#34;</span><span class="op" id="7647532">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647538">expectedMap</span>&nbsp;<span class="op" id="7647550">:=</span>&nbsp;<span class="keyword" id="7647553">map</span><span class="op" id="7647556">[</span><span class="builtintype" id="7647557">string</span><span class="op" id="7647563">]</span><span class="builtintype" id="7647564">string</span><span class="op" id="7647570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647574">&#34;env-PATH_INFO&#34;</span><span class="op" id="7647589">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647597">&#34;/bar&#34;</span><span class="op" id="7647603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647607">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7647625">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647630">&#34;a=b&#34;</span><span class="op" id="7647635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647639">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7647656">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647662">&#34;/bar?a=b&#34;</span><span class="op" id="7647672">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647676">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7647697">:</span>&nbsp;<span class="string" id="7647699">&#34;testdata/test.cgi&#34;</span><span class="op" id="7647718">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647722">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7647739">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7647745">&#34;/&#34;</span><span class="op" id="7647748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647754">runCgiTest</span><span class="op" id="7647764">(</span><span class="ident" id="7647765">t</span><span class="op" id="7647766">,</span>&nbsp;<span class="ident" id="7647768">h</span><span class="op" id="7647769">,</span>&nbsp;<span class="string" id="7647771">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7647817">,</span>&nbsp;<span class="ident" id="7647819">expectedMap</span><span class="op" id="7647830">)</span><br>
<span class="lineno"></span><span class="op" id="7647832">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7647835">func</span>&nbsp;<span class="ident" id="7647840">TestCGIBasicPost</span><span class="op" id="7647856">(</span><span class="ident" id="7647857">t</span>&nbsp;<span class="op" id="7647859">*</span><span class="ident" id="7647860">testing</span><span class="op" id="7647867">.</span><span class="ident" id="7647868">T</span><span class="op" id="7647869">)</span>&nbsp;<span class="op" id="7647871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647874">check</span><span class="op" id="7647879">(</span><span class="ident" id="7647880">t</span><span class="op" id="7647881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647884">postReq</span>&nbsp;<span class="op" id="7647892">:=</span>&nbsp;<span class="string" id="7647895">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648028">h</span>&nbsp;<span class="op" id="7648030">:=</span>&nbsp;<span class="op" id="7648033">&amp;</span><span class="ident" id="7648034">Handler</span><span class="op" id="7648041">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648045">Path</span><span class="op" id="7648049">:</span>&nbsp;<span class="string" id="7648051">&#34;testdata/test.cgi&#34;</span><span class="op" id="7648070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648074">Root</span><span class="op" id="7648078">:</span>&nbsp;<span class="string" id="7648080">&#34;/test.cgi&#34;</span><span class="op" id="7648091">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648097">expectedMap</span>&nbsp;<span class="op" id="7648109">:=</span>&nbsp;<span class="keyword" id="7648112">map</span><span class="op" id="7648115">[</span><span class="builtintype" id="7648116">string</span><span class="op" id="7648122">]</span><span class="builtintype" id="7648123">string</span><span class="op" id="7648129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7648133">&#34;test&#34;</span><span class="op" id="7648139">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7648155">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7648166">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7648170">&#34;param-postfoo&#34;</span><span class="op" id="7648185">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7648192">&#34;postbar&#34;</span><span class="op" id="7648201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7648205">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7648225">:</span>&nbsp;<span class="string" id="7648227">&#34;POST&#34;</span><span class="op" id="7648233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7648237">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="7648257">:</span>&nbsp;<span class="string" id="7648259">&#34;15&#34;</span><span class="op" id="7648263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7648267">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7648284">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7648289">&#34;/test.cgi?a=b&#34;</span><span class="op" id="7648304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648307">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648310">runCgiTest</span><span class="op" id="7648320">(</span><span class="ident" id="7648321">t</span><span class="op" id="7648322">,</span>&nbsp;<span class="ident" id="7648324">h</span><span class="op" id="7648325">,</span>&nbsp;<span class="ident" id="7648327">postReq</span><span class="op" id="7648334">,</span>&nbsp;<span class="ident" id="7648336">expectedMap</span><span class="op" id="7648347">)</span><br>
<span class="lineno"></span><span class="op" id="7648349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7648352">func</span>&nbsp;<span class="ident" id="7648357">chunk</span><span class="op" id="7648362">(</span><span class="ident" id="7648363">s</span>&nbsp;<span class="builtintype" id="7648365">string</span><span class="op" id="7648371">)</span>&nbsp;<span class="builtintype" id="7648373">string</span>&nbsp;<span class="op" id="7648380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648383">return</span>&nbsp;<span class="ident" id="7648390">fmt</span><span class="op" id="7648393">.</span><span class="ident" id="7648394">Sprintf</span><span class="op" id="7648401">(</span><span class="string" id="7648402">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="7648416">,</span>&nbsp;<span class="builtinfunc" id="7648418">len</span><span class="op" id="7648421">(</span><span class="ident" id="7648422">s</span><span class="op" id="7648423">)</span><span class="op" id="7648424">,</span>&nbsp;<span class="ident" id="7648426">s</span><span class="op" id="7648427">)</span><br>
<span class="lineno">240</span><span class="op" id="7648429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7648432">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="7648480">func</span>&nbsp;<span class="ident" id="7648485">TestCGIPostChunked</span><span class="op" id="7648503">(</span><span class="ident" id="7648504">t</span>&nbsp;<span class="op" id="7648506">*</span><span class="ident" id="7648507">testing</span><span class="op" id="7648514">.</span><span class="ident" id="7648515">T</span><span class="op" id="7648516">)</span>&nbsp;<span class="op" id="7648518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648521">check</span><span class="op" id="7648526">(</span><span class="ident" id="7648527">t</span><span class="op" id="7648528">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648531">postReq</span>&nbsp;<span class="op" id="7648539">:=</span>&nbsp;<span class="string" id="7648542">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="7648667">+</span>&nbsp;<span class="ident" id="7648669">chunk</span><span class="op" id="7648674">(</span><span class="string" id="7648675">&#34;postfoo&#34;</span><span class="op" id="7648684">)</span>&nbsp;<span class="op" id="7648686">+</span>&nbsp;<span class="ident" id="7648688">chunk</span><span class="op" id="7648693">(</span><span class="string" id="7648694">&#34;=&#34;</span><span class="op" id="7648697">)</span>&nbsp;<span class="op" id="7648699">+</span>&nbsp;<span class="ident" id="7648701">chunk</span><span class="op" id="7648706">(</span><span class="string" id="7648707">&#34;postbar&#34;</span><span class="op" id="7648716">)</span>&nbsp;<span class="op" id="7648718">+</span>&nbsp;<span class="ident" id="7648720">chunk</span><span class="op" id="7648725">(</span><span class="string" id="7648726">&#34;&#34;</span><span class="op" id="7648728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648732">h</span>&nbsp;<span class="op" id="7648734">:=</span>&nbsp;<span class="op" id="7648737">&amp;</span><span class="ident" id="7648738">Handler</span><span class="op" id="7648745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648749">Path</span><span class="op" id="7648753">:</span>&nbsp;<span class="string" id="7648755">&#34;testdata/test.cgi&#34;</span><span class="op" id="7648774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648778">Root</span><span class="op" id="7648782">:</span>&nbsp;<span class="string" id="7648784">&#34;/test.cgi&#34;</span><span class="op" id="7648795">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648801">expectedMap</span>&nbsp;<span class="op" id="7648813">:=</span>&nbsp;<span class="keyword" id="7648816">map</span><span class="op" id="7648819">[</span><span class="builtintype" id="7648820">string</span><span class="op" id="7648826">]</span><span class="builtintype" id="7648827">string</span><span class="op" id="7648833">{</span><span class="op" id="7648834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648837">resp</span>&nbsp;<span class="op" id="7648842">:=</span>&nbsp;<span class="ident" id="7648845">runCgiTest</span><span class="op" id="7648855">(</span><span class="ident" id="7648856">t</span><span class="op" id="7648857">,</span>&nbsp;<span class="ident" id="7648859">h</span><span class="op" id="7648860">,</span>&nbsp;<span class="ident" id="7648862">postReq</span><span class="op" id="7648869">,</span>&nbsp;<span class="ident" id="7648871">expectedMap</span><span class="op" id="7648882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648885">if</span>&nbsp;<span class="ident" id="7648888">got</span><span class="op" id="7648891">,</span>&nbsp;<span class="ident" id="7648893">expected</span>&nbsp;<span class="op" id="7648902">:=</span>&nbsp;<span class="ident" id="7648905">resp</span><span class="op" id="7648909">.</span><span class="ident" id="7648910">Code</span><span class="op" id="7648914">,</span>&nbsp;<span class="ident" id="7648916">http</span><span class="op" id="7648920">.</span><span class="ident" id="7648921">StatusBadRequest</span><span class="op" id="7648937">;</span>&nbsp;<span class="ident" id="7648939">got</span>&nbsp;<span class="op" id="7648943">!=</span>&nbsp;<span class="ident" id="7648946">expected</span>&nbsp;<span class="op" id="7648955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648959">t</span><span class="op" id="7648960">.</span><span class="ident" id="7648961">Fatalf</span><span class="op" id="7648967">(</span><span class="string" id="7648968">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7649029">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649034">expected</span><span class="op" id="7649042">,</span>&nbsp;<span class="ident" id="7649044">got</span><span class="op" id="7649047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649050">}</span><br>
<span class="lineno"></span><span class="op" id="7649052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7649055">func</span>&nbsp;<span class="ident" id="7649060">TestRedirect</span><span class="op" id="7649072">(</span><span class="ident" id="7649073">t</span>&nbsp;<span class="op" id="7649075">*</span><span class="ident" id="7649076">testing</span><span class="op" id="7649083">.</span><span class="ident" id="7649084">T</span><span class="op" id="7649085">)</span>&nbsp;<span class="op" id="7649087">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649090">check</span><span class="op" id="7649095">(</span><span class="ident" id="7649096">t</span><span class="op" id="7649097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649100">h</span>&nbsp;<span class="op" id="7649102">:=</span>&nbsp;<span class="op" id="7649105">&amp;</span><span class="ident" id="7649106">Handler</span><span class="op" id="7649113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649117">Path</span><span class="op" id="7649121">:</span>&nbsp;<span class="string" id="7649123">&#34;testdata/test.cgi&#34;</span><span class="op" id="7649142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649146">Root</span><span class="op" id="7649150">:</span>&nbsp;<span class="string" id="7649152">&#34;/test.cgi&#34;</span><span class="op" id="7649163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649166">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649169">rec</span>&nbsp;<span class="op" id="7649173">:=</span>&nbsp;<span class="ident" id="7649176">runCgiTest</span><span class="op" id="7649186">(</span><span class="ident" id="7649187">t</span><span class="op" id="7649188">,</span>&nbsp;<span class="ident" id="7649190">h</span><span class="op" id="7649191">,</span>&nbsp;<span class="string" id="7649193">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7649260">,</span>&nbsp;<span class="ident" id="7649262">nil</span><span class="op" id="7649265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649268">if</span>&nbsp;<span class="ident" id="7649271">e</span><span class="op" id="7649272">,</span>&nbsp;<span class="ident" id="7649274">g</span>&nbsp;<span class="op" id="7649276">:=</span>&nbsp;<span class="num" id="7649279">302</span><span class="op" id="7649282">,</span>&nbsp;<span class="ident" id="7649284">rec</span><span class="op" id="7649287">.</span><span class="ident" id="7649288">Code</span><span class="op" id="7649292">;</span>&nbsp;<span class="ident" id="7649294">e</span>&nbsp;<span class="op" id="7649296">!=</span>&nbsp;<span class="ident" id="7649299">g</span>&nbsp;<span class="op" id="7649301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649305">t</span><span class="op" id="7649306">.</span><span class="ident" id="7649307">Errorf</span><span class="op" id="7649313">(</span><span class="string" id="7649314">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7649347">,</span>&nbsp;<span class="ident" id="7649349">e</span><span class="op" id="7649350">,</span>&nbsp;<span class="ident" id="7649352">g</span><span class="op" id="7649353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649359">if</span>&nbsp;<span class="ident" id="7649362">e</span><span class="op" id="7649363">,</span>&nbsp;<span class="ident" id="7649365">g</span>&nbsp;<span class="op" id="7649367">:=</span>&nbsp;<span class="string" id="7649370">&#34;http://foo.com/&#34;</span><span class="op" id="7649387">,</span>&nbsp;<span class="ident" id="7649389">rec</span><span class="op" id="7649392">.</span><span class="ident" id="7649393">Header</span><span class="op" id="7649399">(</span><span class="op" id="7649400">)</span><span class="op" id="7649401">.</span><span class="ident" id="7649402">Get</span><span class="op" id="7649405">(</span><span class="string" id="7649406">&#34;Location&#34;</span><span class="op" id="7649416">)</span><span class="op" id="7649417">;</span>&nbsp;<span class="ident" id="7649419">e</span>&nbsp;<span class="op" id="7649421">!=</span>&nbsp;<span class="ident" id="7649424">g</span>&nbsp;<span class="op" id="7649426">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649430">t</span><span class="op" id="7649431">.</span><span class="ident" id="7649432">Errorf</span><span class="op" id="7649438">(</span><span class="string" id="7649439">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7649479">,</span>&nbsp;<span class="ident" id="7649481">e</span><span class="op" id="7649482">,</span>&nbsp;<span class="ident" id="7649484">g</span><span class="op" id="7649485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649488">}</span><br>
<span class="lineno"></span><span class="op" id="7649490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7649493">func</span>&nbsp;<span class="ident" id="7649498">TestInternalRedirect</span><span class="op" id="7649518">(</span><span class="ident" id="7649519">t</span>&nbsp;<span class="op" id="7649521">*</span><span class="ident" id="7649522">testing</span><span class="op" id="7649529">.</span><span class="ident" id="7649530">T</span><span class="op" id="7649531">)</span>&nbsp;<span class="op" id="7649533">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649536">check</span><span class="op" id="7649541">(</span><span class="ident" id="7649542">t</span><span class="op" id="7649543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649546">baseHandler</span>&nbsp;<span class="op" id="7649558">:=</span>&nbsp;<span class="ident" id="7649561">http</span><span class="op" id="7649565">.</span><span class="ident" id="7649566">HandlerFunc</span><span class="op" id="7649577">(</span><span class="keyword" id="7649578">func</span><span class="op" id="7649582">(</span><span class="ident" id="7649583">rw</span>&nbsp;<span class="ident" id="7649586">http</span><span class="op" id="7649590">.</span><span class="ident" id="7649591">ResponseWriter</span><span class="op" id="7649605">,</span>&nbsp;<span class="ident" id="7649607">req</span>&nbsp;<span class="op" id="7649611">*</span><span class="ident" id="7649612">http</span><span class="op" id="7649616">.</span><span class="ident" id="7649617">Request</span><span class="op" id="7649624">)</span>&nbsp;<span class="op" id="7649626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649630">fmt</span><span class="op" id="7649633">.</span><span class="ident" id="7649634">Fprintf</span><span class="op" id="7649641">(</span><span class="ident" id="7649642">rw</span><span class="op" id="7649644">,</span>&nbsp;<span class="string" id="7649646">&#34;basepath=%s\n&#34;</span><span class="op" id="7649661">,</span>&nbsp;<span class="ident" id="7649663">req</span><span class="op" id="7649666">.</span><span class="ident" id="7649667">URL</span><span class="op" id="7649670">.</span><span class="ident" id="7649671">Path</span><span class="op" id="7649675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649679">fmt</span><span class="op" id="7649682">.</span><span class="ident" id="7649683">Fprintf</span><span class="op" id="7649690">(</span><span class="ident" id="7649691">rw</span><span class="op" id="7649693">,</span>&nbsp;<span class="string" id="7649695">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="7649712">,</span>&nbsp;<span class="ident" id="7649714">req</span><span class="op" id="7649717">.</span><span class="ident" id="7649718">RemoteAddr</span><span class="op" id="7649728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649731">}</span><span class="op" id="7649732">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649735">h</span>&nbsp;<span class="op" id="7649737">:=</span>&nbsp;<span class="op" id="7649740">&amp;</span><span class="ident" id="7649741">Handler</span><span class="op" id="7649748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649752">Path</span><span class="op" id="7649756">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7649773">&#34;testdata/test.cgi&#34;</span><span class="op" id="7649792">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649796">Root</span><span class="op" id="7649800">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7649817">&#34;/test.cgi&#34;</span><span class="op" id="7649828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649832">PathLocationHandler</span><span class="op" id="7649851">:</span>&nbsp;<span class="ident" id="7649853">baseHandler</span><span class="op" id="7649864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649867">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649870">expectedMap</span>&nbsp;<span class="op" id="7649882">:=</span>&nbsp;<span class="keyword" id="7649885">map</span><span class="op" id="7649888">[</span><span class="builtintype" id="7649889">string</span><span class="op" id="7649895">]</span><span class="builtintype" id="7649896">string</span><span class="op" id="7649902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7649906">&#34;basepath&#34;</span><span class="op" id="7649916">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7649920">&#34;/foo&#34;</span><span class="op" id="7649926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7649930">&#34;remoteaddr&#34;</span><span class="op" id="7649942">:</span>&nbsp;<span class="string" id="7649944">&#34;1.2.3.4&#34;</span><span class="op" id="7649953">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649959">runCgiTest</span><span class="op" id="7649969">(</span><span class="ident" id="7649970">t</span><span class="op" id="7649971">,</span>&nbsp;<span class="ident" id="7649973">h</span><span class="op" id="7649974">,</span>&nbsp;<span class="string" id="7649976">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7650032">,</span>&nbsp;<span class="ident" id="7650034">expectedMap</span><span class="op" id="7650045">)</span><br>
<span class="lineno">295</span><span class="op" id="7650047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7650050">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="7650126">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="7650189">func</span>&nbsp;<span class="ident" id="7650194">TestCopyError</span><span class="op" id="7650207">(</span><span class="ident" id="7650208">t</span>&nbsp;<span class="op" id="7650210">*</span><span class="ident" id="7650211">testing</span><span class="op" id="7650218">.</span><span class="ident" id="7650219">T</span><span class="op" id="7650220">)</span>&nbsp;<span class="op" id="7650222">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650225">check</span><span class="op" id="7650230">(</span><span class="ident" id="7650231">t</span><span class="op" id="7650232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650235">if</span>&nbsp;<span class="ident" id="7650238">runtime</span><span class="op" id="7650245">.</span><span class="ident" id="7650246">GOOS</span>&nbsp;<span class="op" id="7650251">==</span>&nbsp;<span class="string" id="7650254">&#34;windows&#34;</span>&nbsp;<span class="op" id="7650264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650268">t</span><span class="op" id="7650269">.</span><span class="ident" id="7650270">Skipf</span><span class="op" id="7650275">(</span><span class="string" id="7650276">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7650297">,</span>&nbsp;<span class="ident" id="7650299">runtime</span><span class="op" id="7650306">.</span><span class="ident" id="7650307">GOOS</span><span class="op" id="7650311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650317">h</span>&nbsp;<span class="op" id="7650319">:=</span>&nbsp;<span class="op" id="7650322">&amp;</span><span class="ident" id="7650323">Handler</span><span class="op" id="7650330">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650334">Path</span><span class="op" id="7650338">:</span>&nbsp;<span class="string" id="7650340">&#34;testdata/test.cgi&#34;</span><span class="op" id="7650359">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650363">Root</span><span class="op" id="7650367">:</span>&nbsp;<span class="string" id="7650369">&#34;/test.cgi&#34;</span><span class="op" id="7650380">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650386">ts</span>&nbsp;<span class="op" id="7650389">:=</span>&nbsp;<span class="ident" id="7650392">httptest</span><span class="op" id="7650400">.</span><span class="ident" id="7650401">NewServer</span><span class="op" id="7650410">(</span><span class="ident" id="7650411">h</span><span class="op" id="7650412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650415">defer</span>&nbsp;<span class="ident" id="7650421">ts</span><span class="op" id="7650423">.</span><span class="ident" id="7650424">Close</span><span class="op" id="7650429">(</span><span class="op" id="7650430">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650434">conn</span><span class="op" id="7650438">,</span>&nbsp;<span class="ident" id="7650440">err</span>&nbsp;<span class="op" id="7650444">:=</span>&nbsp;<span class="ident" id="7650447">net</span><span class="op" id="7650450">.</span><span class="ident" id="7650451">Dial</span><span class="op" id="7650455">(</span><span class="string" id="7650456">&#34;tcp&#34;</span><span class="op" id="7650461">,</span>&nbsp;<span class="ident" id="7650463">ts</span><span class="op" id="7650465">.</span><span class="ident" id="7650466">Listener</span><span class="op" id="7650474">.</span><span class="ident" id="7650475">Addr</span><span class="op" id="7650479">(</span><span class="op" id="7650480">)</span><span class="op" id="7650481">.</span><span class="ident" id="7650482">String</span><span class="op" id="7650488">(</span><span class="op" id="7650489">)</span><span class="op" id="7650490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650493">if</span>&nbsp;<span class="ident" id="7650496">err</span>&nbsp;<span class="op" id="7650500">!=</span>&nbsp;<span class="ident" id="7650503">nil</span>&nbsp;<span class="op" id="7650507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650511">t</span><span class="op" id="7650512">.</span><span class="ident" id="7650513">Fatal</span><span class="op" id="7650518">(</span><span class="ident" id="7650519">err</span><span class="op" id="7650522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650525">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650528">req</span><span class="op" id="7650531">,</span>&nbsp;<span class="ident" id="7650533">_</span>&nbsp;<span class="op" id="7650535">:=</span>&nbsp;<span class="ident" id="7650538">http</span><span class="op" id="7650542">.</span><span class="ident" id="7650543">NewRequest</span><span class="op" id="7650553">(</span><span class="string" id="7650554">&#34;GET&#34;</span><span class="op" id="7650559">,</span>&nbsp;<span class="string" id="7650561">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="7650604">,</span>&nbsp;<span class="ident" id="7650606">nil</span><span class="op" id="7650609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650612">err</span>&nbsp;<span class="op" id="7650616">=</span>&nbsp;<span class="ident" id="7650618">req</span><span class="op" id="7650621">.</span><span class="ident" id="7650622">Write</span><span class="op" id="7650627">(</span><span class="ident" id="7650628">conn</span><span class="op" id="7650632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650635">if</span>&nbsp;<span class="ident" id="7650638">err</span>&nbsp;<span class="op" id="7650642">!=</span>&nbsp;<span class="ident" id="7650645">nil</span>&nbsp;<span class="op" id="7650649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650653">t</span><span class="op" id="7650654">.</span><span class="ident" id="7650655">Fatalf</span><span class="op" id="7650661">(</span><span class="string" id="7650662">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="7650673">,</span>&nbsp;<span class="ident" id="7650675">err</span><span class="op" id="7650678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650681">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650685">res</span><span class="op" id="7650688">,</span>&nbsp;<span class="ident" id="7650690">err</span>&nbsp;<span class="op" id="7650694">:=</span>&nbsp;<span class="ident" id="7650697">http</span><span class="op" id="7650701">.</span><span class="ident" id="7650702">ReadResponse</span><span class="op" id="7650714">(</span><span class="ident" id="7650715">bufio</span><span class="op" id="7650720">.</span><span class="ident" id="7650721">NewReader</span><span class="op" id="7650730">(</span><span class="ident" id="7650731">conn</span><span class="op" id="7650735">)</span><span class="op" id="7650736">,</span>&nbsp;<span class="ident" id="7650738">req</span><span class="op" id="7650741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650744">if</span>&nbsp;<span class="ident" id="7650747">err</span>&nbsp;<span class="op" id="7650751">!=</span>&nbsp;<span class="ident" id="7650754">nil</span>&nbsp;<span class="op" id="7650758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650762">t</span><span class="op" id="7650763">.</span><span class="ident" id="7650764">Fatalf</span><span class="op" id="7650770">(</span><span class="string" id="7650771">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="7650789">,</span>&nbsp;<span class="ident" id="7650791">err</span><span class="op" id="7650794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650797">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650801">pidstr</span>&nbsp;<span class="op" id="7650808">:=</span>&nbsp;<span class="ident" id="7650811">res</span><span class="op" id="7650814">.</span><span class="ident" id="7650815">Header</span><span class="op" id="7650821">.</span><span class="ident" id="7650822">Get</span><span class="op" id="7650825">(</span><span class="string" id="7650826">&#34;X-CGI-Pid&#34;</span><span class="op" id="7650837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650840">if</span>&nbsp;<span class="ident" id="7650843">pidstr</span>&nbsp;<span class="op" id="7650850">==</span>&nbsp;<span class="string" id="7650853">&#34;&#34;</span>&nbsp;<span class="op" id="7650856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650860">t</span><span class="op" id="7650861">.</span><span class="ident" id="7650862">Fatalf</span><span class="op" id="7650868">(</span><span class="string" id="7650869">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="7650911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650914">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650917">pid</span><span class="op" id="7650920">,</span>&nbsp;<span class="ident" id="7650922">err</span>&nbsp;<span class="op" id="7650926">:=</span>&nbsp;<span class="ident" id="7650929">strconv</span><span class="op" id="7650936">.</span><span class="ident" id="7650937">Atoi</span><span class="op" id="7650941">(</span><span class="ident" id="7650942">pidstr</span><span class="op" id="7650948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650951">if</span>&nbsp;<span class="ident" id="7650954">err</span>&nbsp;<span class="op" id="7650958">!=</span>&nbsp;<span class="ident" id="7650961">nil</span>&nbsp;<span class="op" id="7650965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650969">t</span><span class="op" id="7650970">.</span><span class="ident" id="7650971">Fatalf</span><span class="op" id="7650977">(</span><span class="string" id="7650978">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="7651003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651010">var</span>&nbsp;<span class="ident" id="7651014">buf</span>&nbsp;<span class="op" id="7651018">[</span><span class="num" id="7651019">5000</span><span class="op" id="7651023">]</span><span class="builtintype" id="7651024">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651030">n</span><span class="op" id="7651031">,</span>&nbsp;<span class="ident" id="7651033">err</span>&nbsp;<span class="op" id="7651037">:=</span>&nbsp;<span class="ident" id="7651040">io</span><span class="op" id="7651042">.</span><span class="ident" id="7651043">ReadFull</span><span class="op" id="7651051">(</span><span class="ident" id="7651052">res</span><span class="op" id="7651055">.</span><span class="ident" id="7651056">Body</span><span class="op" id="7651060">,</span>&nbsp;<span class="ident" id="7651062">buf</span><span class="op" id="7651065">[</span><span class="op" id="7651066">:</span><span class="op" id="7651067">]</span><span class="op" id="7651068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651071">if</span>&nbsp;<span class="ident" id="7651074">err</span>&nbsp;<span class="op" id="7651078">!=</span>&nbsp;<span class="ident" id="7651081">nil</span>&nbsp;<span class="op" id="7651085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651089">t</span><span class="op" id="7651090">.</span><span class="ident" id="7651091">Fatalf</span><span class="op" id="7651097">(</span><span class="string" id="7651098">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="7651122">,</span>&nbsp;<span class="ident" id="7651124">n</span><span class="op" id="7651125">,</span>&nbsp;<span class="ident" id="7651127">err</span><span class="op" id="7651130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651133">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651137">childRunning</span>&nbsp;<span class="op" id="7651150">:=</span>&nbsp;<span class="keyword" id="7651153">func</span><span class="op" id="7651157">(</span><span class="op" id="7651158">)</span>&nbsp;<span class="builtintype" id="7651160">bool</span>&nbsp;<span class="op" id="7651165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651169">return</span>&nbsp;<span class="ident" id="7651176">isProcessRunning</span><span class="op" id="7651192">(</span><span class="ident" id="7651193">t</span><span class="op" id="7651194">,</span>&nbsp;<span class="ident" id="7651196">pid</span><span class="op" id="7651199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651206">if</span>&nbsp;<span class="op" id="7651209">!</span><span class="ident" id="7651210">childRunning</span><span class="op" id="7651222">(</span><span class="op" id="7651223">)</span>&nbsp;<span class="op" id="7651225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651229">t</span><span class="op" id="7651230">.</span><span class="ident" id="7651231">Fatalf</span><span class="op" id="7651237">(</span><span class="string" id="7651238">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="7651284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651290">conn</span><span class="op" id="7651294">.</span><span class="ident" id="7651295">Close</span><span class="op" id="7651300">(</span><span class="op" id="7651301">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651305">tries</span>&nbsp;<span class="op" id="7651311">:=</span>&nbsp;<span class="num" id="7651314">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651317">for</span>&nbsp;<span class="ident" id="7651321">tries</span>&nbsp;<span class="op" id="7651327">&lt;</span>&nbsp;<span class="num" id="7651329">25</span>&nbsp;<span class="op" id="7651332">&amp;&amp;</span>&nbsp;<span class="ident" id="7651335">childRunning</span><span class="op" id="7651347">(</span><span class="op" id="7651348">)</span>&nbsp;<span class="op" id="7651350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651354">time</span><span class="op" id="7651358">.</span><span class="ident" id="7651359">Sleep</span><span class="op" id="7651364">(</span><span class="num" id="7651365">50</span>&nbsp;<span class="op" id="7651368">*</span>&nbsp;<span class="ident" id="7651370">time</span><span class="op" id="7651374">.</span><span class="ident" id="7651375">Millisecond</span>&nbsp;<span class="op" id="7651387">*</span>&nbsp;<span class="ident" id="7651389">time</span><span class="op" id="7651393">.</span><span class="ident" id="7651394">Duration</span><span class="op" id="7651402">(</span><span class="ident" id="7651403">tries</span><span class="op" id="7651408">)</span><span class="op" id="7651409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651413">tries</span><span class="op" id="7651418">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651422">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651425">if</span>&nbsp;<span class="ident" id="7651428">childRunning</span><span class="op" id="7651440">(</span><span class="op" id="7651441">)</span>&nbsp;<span class="op" id="7651443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651447">t</span><span class="op" id="7651448">.</span><span class="ident" id="7651449">Fatalf</span><span class="op" id="7651455">(</span><span class="string" id="7651456">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="7651500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651503">}</span><br>
<span class="lineno"></span><span class="op" id="7651505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="7651508">func</span>&nbsp;<span class="ident" id="7651513">TestDirUnix</span><span class="op" id="7651524">(</span><span class="ident" id="7651525">t</span>&nbsp;<span class="op" id="7651527">*</span><span class="ident" id="7651528">testing</span><span class="op" id="7651535">.</span><span class="ident" id="7651536">T</span><span class="op" id="7651537">)</span>&nbsp;<span class="op" id="7651539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651542">check</span><span class="op" id="7651547">(</span><span class="ident" id="7651548">t</span><span class="op" id="7651549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651552">if</span>&nbsp;<span class="ident" id="7651555">runtime</span><span class="op" id="7651562">.</span><span class="ident" id="7651563">GOOS</span>&nbsp;<span class="op" id="7651568">==</span>&nbsp;<span class="string" id="7651571">&#34;windows&#34;</span>&nbsp;<span class="op" id="7651581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651585">t</span><span class="op" id="7651586">.</span><span class="ident" id="7651587">Skipf</span><span class="op" id="7651592">(</span><span class="string" id="7651593">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7651614">,</span>&nbsp;<span class="ident" id="7651616">runtime</span><span class="op" id="7651623">.</span><span class="ident" id="7651624">GOOS</span><span class="op" id="7651628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651631">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651634">cwd</span><span class="op" id="7651637">,</span>&nbsp;<span class="ident" id="7651639">_</span>&nbsp;<span class="op" id="7651641">:=</span>&nbsp;<span class="ident" id="7651644">os</span><span class="op" id="7651646">.</span><span class="ident" id="7651647">Getwd</span><span class="op" id="7651652">(</span><span class="op" id="7651653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651656">h</span>&nbsp;<span class="op" id="7651658">:=</span>&nbsp;<span class="op" id="7651661">&amp;</span><span class="ident" id="7651662">Handler</span><span class="op" id="7651669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651673">Path</span><span class="op" id="7651677">:</span>&nbsp;<span class="string" id="7651679">&#34;testdata/test.cgi&#34;</span><span class="op" id="7651698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651702">Root</span><span class="op" id="7651706">:</span>&nbsp;<span class="string" id="7651708">&#34;/test.cgi&#34;</span><span class="op" id="7651719">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651723">Dir</span><span class="op" id="7651726">:</span>&nbsp;&nbsp;<span class="ident" id="7651729">cwd</span><span class="op" id="7651732">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651738">expectedMap</span>&nbsp;<span class="op" id="7651750">:=</span>&nbsp;<span class="keyword" id="7651753">map</span><span class="op" id="7651756">[</span><span class="builtintype" id="7651757">string</span><span class="op" id="7651763">]</span><span class="builtintype" id="7651764">string</span><span class="op" id="7651770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7651774">&#34;cwd&#34;</span><span class="op" id="7651779">:</span>&nbsp;<span class="ident" id="7651781">cwd</span><span class="op" id="7651784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651790">runCgiTest</span><span class="op" id="7651800">(</span><span class="ident" id="7651801">t</span><span class="op" id="7651802">,</span>&nbsp;<span class="ident" id="7651804">h</span><span class="op" id="7651805">,</span>&nbsp;<span class="string" id="7651807">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7651854">,</span>&nbsp;<span class="ident" id="7651856">expectedMap</span><span class="op" id="7651867">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651871">cwd</span><span class="op" id="7651874">,</span>&nbsp;<span class="ident" id="7651876">_</span>&nbsp;<span class="op" id="7651878">=</span>&nbsp;<span class="ident" id="7651880">os</span><span class="op" id="7651882">.</span><span class="ident" id="7651883">Getwd</span><span class="op" id="7651888">(</span><span class="op" id="7651889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651892">cwd</span>&nbsp;<span class="op" id="7651896">=</span>&nbsp;<span class="ident" id="7651898">filepath</span><span class="op" id="7651906">.</span><span class="ident" id="7651907">Join</span><span class="op" id="7651911">(</span><span class="ident" id="7651912">cwd</span><span class="op" id="7651915">,</span>&nbsp;<span class="string" id="7651917">&#34;testdata&#34;</span><span class="op" id="7651927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651930">h</span>&nbsp;<span class="op" id="7651932">=</span>&nbsp;<span class="op" id="7651934">&amp;</span><span class="ident" id="7651935">Handler</span><span class="op" id="7651942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651946">Path</span><span class="op" id="7651950">:</span>&nbsp;<span class="string" id="7651952">&#34;testdata/test.cgi&#34;</span><span class="op" id="7651971">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651975">Root</span><span class="op" id="7651979">:</span>&nbsp;<span class="string" id="7651981">&#34;/test.cgi&#34;</span><span class="op" id="7651992">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651998">expectedMap</span>&nbsp;<span class="op" id="7652010">=</span>&nbsp;<span class="keyword" id="7652012">map</span><span class="op" id="7652015">[</span><span class="builtintype" id="7652016">string</span><span class="op" id="7652022">]</span><span class="builtintype" id="7652023">string</span><span class="op" id="7652029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7652033">&#34;cwd&#34;</span><span class="op" id="7652038">:</span>&nbsp;<span class="ident" id="7652040">cwd</span><span class="op" id="7652043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7652046">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652049">runCgiTest</span><span class="op" id="7652059">(</span><span class="ident" id="7652060">t</span><span class="op" id="7652061">,</span>&nbsp;<span class="ident" id="7652063">h</span><span class="op" id="7652064">,</span>&nbsp;<span class="string" id="7652066">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7652113">,</span>&nbsp;<span class="ident" id="7652115">expectedMap</span><span class="op" id="7652126">)</span><br>
<span class="lineno"></span><span class="op" id="7652128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7652131">func</span>&nbsp;<span class="ident" id="7652136">TestDirWindows</span><span class="op" id="7652150">(</span><span class="ident" id="7652151">t</span>&nbsp;<span class="op" id="7652153">*</span><span class="ident" id="7652154">testing</span><span class="op" id="7652161">.</span><span class="ident" id="7652162">T</span><span class="op" id="7652163">)</span>&nbsp;<span class="op" id="7652165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7652168">if</span>&nbsp;<span class="ident" id="7652171">runtime</span><span class="op" id="7652178">.</span><span class="ident" id="7652179">GOOS</span>&nbsp;<span class="op" id="7652184">!=</span>&nbsp;<span class="string" id="7652187">&#34;windows&#34;</span>&nbsp;<span class="op" id="7652197">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652201">t</span><span class="op" id="7652202">.</span><span class="ident" id="7652203">Skip</span><span class="op" id="7652207">(</span><span class="string" id="7652208">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="7652241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7652244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652248">cgifile</span><span class="op" id="7652255">,</span>&nbsp;<span class="ident" id="7652257">_</span>&nbsp;<span class="op" id="7652259">:=</span>&nbsp;<span class="ident" id="7652262">filepath</span><span class="op" id="7652270">.</span><span class="ident" id="7652271">Abs</span><span class="op" id="7652274">(</span><span class="string" id="7652275">&#34;testdata/test.cgi&#34;</span><span class="op" id="7652294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7652298">var</span>&nbsp;<span class="ident" id="7652302">perl</span>&nbsp;<span class="builtintype" id="7652307">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7652315">var</span>&nbsp;<span class="ident" id="7652319">err</span>&nbsp;<span class="builtintype" id="7652323">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652330">perl</span><span class="op" id="7652334">,</span>&nbsp;<span class="ident" id="7652336">err</span>&nbsp;<span class="op" id="7652340">=</span>&nbsp;<span class="ident" id="7652342">exec</span><span class="op" id="7652346">.</span><span class="ident" id="7652347">LookPath</span><span class="op" id="7652355">(</span><span class="string" id="7652356">&#34;perl&#34;</span><span class="op" id="7652362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7652365">if</span>&nbsp;<span class="ident" id="7652368">err</span>&nbsp;<span class="op" id="7652372">!=</span>&nbsp;<span class="ident" id="7652375">nil</span>&nbsp;<span class="op" id="7652379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652383">t</span><span class="op" id="7652384">.</span><span class="ident" id="7652385">Skip</span><span class="op" id="7652389">(</span><span class="string" id="7652390">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7652422">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7652425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652428">perl</span><span class="op" id="7652432">,</span>&nbsp;<span class="ident" id="7652434">_</span>&nbsp;<span class="op" id="7652436">=</span>&nbsp;<span class="ident" id="7652438">filepath</span><span class="op" id="7652446">.</span><span class="ident" id="7652447">Abs</span><span class="op" id="7652450">(</span><span class="ident" id="7652451">perl</span><span class="op" id="7652455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652459">cwd</span><span class="op" id="7652462">,</span>&nbsp;<span class="ident" id="7652464">_</span>&nbsp;<span class="op" id="7652466">:=</span>&nbsp;<span class="ident" id="7652469">os</span><span class="op" id="7652471">.</span><span class="ident" id="7652472">Getwd</span><span class="op" id="7652477">(</span><span class="op" id="7652478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652481">h</span>&nbsp;<span class="op" id="7652483">:=</span>&nbsp;<span class="op" id="7652486">&amp;</span><span class="ident" id="7652487">Handler</span><span class="op" id="7652494">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652498">Path</span><span class="op" id="7652502">:</span>&nbsp;<span class="ident" id="7652504">perl</span><span class="op" id="7652508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652512">Root</span><span class="op" id="7652516">:</span>&nbsp;<span class="string" id="7652518">&#34;/test.cgi&#34;</span><span class="op" id="7652529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652533">Dir</span><span class="op" id="7652536">:</span>&nbsp;&nbsp;<span class="ident" id="7652539">cwd</span><span class="op" id="7652542">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652546">Args</span><span class="op" id="7652550">:</span>&nbsp;<span class="op" id="7652552">[</span><span class="op" id="7652553">]</span><span class="builtintype" id="7652554">string</span><span class="op" id="7652560">{</span><span class="ident" id="7652561">cgifile</span><span class="op" id="7652568">}</span><span class="op" id="7652569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652573">Env</span><span class="op" id="7652576">:</span>&nbsp;&nbsp;<span class="op" id="7652579">[</span><span class="op" id="7652580">]</span><span class="builtintype" id="7652581">string</span><span class="op" id="7652587">{</span><span class="string" id="7652588">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7652607">+</span>&nbsp;<span class="ident" id="7652609">cgifile</span><span class="op" id="7652616">}</span><span class="op" id="7652617">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7652620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652623">expectedMap</span>&nbsp;<span class="op" id="7652635">:=</span>&nbsp;<span class="keyword" id="7652638">map</span><span class="op" id="7652641">[</span><span class="builtintype" id="7652642">string</span><span class="op" id="7652648">]</span><span class="builtintype" id="7652649">string</span><span class="op" id="7652655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7652659">&#34;cwd&#34;</span><span class="op" id="7652664">:</span>&nbsp;<span class="ident" id="7652666">cwd</span><span class="op" id="7652669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7652672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652675">runCgiTest</span><span class="op" id="7652685">(</span><span class="ident" id="7652686">t</span><span class="op" id="7652687">,</span>&nbsp;<span class="ident" id="7652689">h</span><span class="op" id="7652690">,</span>&nbsp;<span class="string" id="7652692">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7652739">,</span>&nbsp;<span class="ident" id="7652741">expectedMap</span><span class="op" id="7652752">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7652756">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7652819">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652847">cwd</span><span class="op" id="7652850">,</span>&nbsp;<span class="ident" id="7652852">_</span>&nbsp;<span class="op" id="7652854">=</span>&nbsp;<span class="ident" id="7652856">filepath</span><span class="op" id="7652864">.</span><span class="ident" id="7652865">Split</span><span class="op" id="7652870">(</span><span class="ident" id="7652871">perl</span><span class="op" id="7652875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7652878">if</span>&nbsp;<span class="ident" id="7652881">cwd</span>&nbsp;<span class="op" id="7652885">!=</span>&nbsp;<span class="string" id="7652888">&#34;&#34;</span>&nbsp;<span class="op" id="7652891">&amp;&amp;</span>&nbsp;<span class="ident" id="7652894">cwd</span><span class="op" id="7652897">[</span><span class="builtinfunc" id="7652898">len</span><span class="op" id="7652901">(</span><span class="ident" id="7652902">cwd</span><span class="op" id="7652905">)</span><span class="op" id="7652906">-</span><span class="num" id="7652907">1</span><span class="op" id="7652908">]</span>&nbsp;<span class="op" id="7652910">==</span>&nbsp;<span class="ident" id="7652913">filepath</span><span class="op" id="7652921">.</span><span class="ident" id="7652922">Separator</span>&nbsp;<span class="op" id="7652932">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652936">cwd</span>&nbsp;<span class="op" id="7652940">=</span>&nbsp;<span class="ident" id="7652942">cwd</span><span class="op" id="7652945">[</span><span class="op" id="7652946">:</span><span class="builtinfunc" id="7652947">len</span><span class="op" id="7652950">(</span><span class="ident" id="7652951">cwd</span><span class="op" id="7652954">)</span><span class="op" id="7652955">-</span><span class="num" id="7652956">1</span><span class="op" id="7652957">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7652960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652963">h</span>&nbsp;<span class="op" id="7652965">=</span>&nbsp;<span class="op" id="7652967">&amp;</span><span class="ident" id="7652968">Handler</span><span class="op" id="7652975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652979">Path</span><span class="op" id="7652983">:</span>&nbsp;<span class="ident" id="7652985">perl</span><span class="op" id="7652989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7652993">Root</span><span class="op" id="7652997">:</span>&nbsp;<span class="string" id="7652999">&#34;/test.cgi&#34;</span><span class="op" id="7653010">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653014">Args</span><span class="op" id="7653018">:</span>&nbsp;<span class="op" id="7653020">[</span><span class="op" id="7653021">]</span><span class="builtintype" id="7653022">string</span><span class="op" id="7653028">{</span><span class="ident" id="7653029">cgifile</span><span class="op" id="7653036">}</span><span class="op" id="7653037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653041">Env</span><span class="op" id="7653044">:</span>&nbsp;&nbsp;<span class="op" id="7653047">[</span><span class="op" id="7653048">]</span><span class="builtintype" id="7653049">string</span><span class="op" id="7653055">{</span><span class="string" id="7653056">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7653075">+</span>&nbsp;<span class="ident" id="7653077">cgifile</span><span class="op" id="7653084">}</span><span class="op" id="7653085">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7653088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653091">expectedMap</span>&nbsp;<span class="op" id="7653103">=</span>&nbsp;<span class="keyword" id="7653105">map</span><span class="op" id="7653108">[</span><span class="builtintype" id="7653109">string</span><span class="op" id="7653115">]</span><span class="builtintype" id="7653116">string</span><span class="op" id="7653122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7653126">&#34;cwd&#34;</span><span class="op" id="7653131">:</span>&nbsp;<span class="ident" id="7653133">cwd</span><span class="op" id="7653136">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7653139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653142">runCgiTest</span><span class="op" id="7653152">(</span><span class="ident" id="7653153">t</span><span class="op" id="7653154">,</span>&nbsp;<span class="ident" id="7653156">h</span><span class="op" id="7653157">,</span>&nbsp;<span class="string" id="7653159">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7653206">,</span>&nbsp;<span class="ident" id="7653208">expectedMap</span><span class="op" id="7653219">)</span><br>
<span class="lineno"></span><span class="op" id="7653221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7653224">func</span>&nbsp;<span class="ident" id="7653229">TestEnvOverride</span><span class="op" id="7653244">(</span><span class="ident" id="7653245">t</span>&nbsp;<span class="op" id="7653247">*</span><span class="ident" id="7653248">testing</span><span class="op" id="7653255">.</span><span class="ident" id="7653256">T</span><span class="op" id="7653257">)</span>&nbsp;<span class="op" id="7653259">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653262">cgifile</span><span class="op" id="7653269">,</span>&nbsp;<span class="ident" id="7653271">_</span>&nbsp;<span class="op" id="7653273">:=</span>&nbsp;<span class="ident" id="7653276">filepath</span><span class="op" id="7653284">.</span><span class="ident" id="7653285">Abs</span><span class="op" id="7653288">(</span><span class="string" id="7653289">&#34;testdata/test.cgi&#34;</span><span class="op" id="7653308">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7653312">var</span>&nbsp;<span class="ident" id="7653316">perl</span>&nbsp;<span class="builtintype" id="7653321">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7653329">var</span>&nbsp;<span class="ident" id="7653333">err</span>&nbsp;<span class="builtintype" id="7653337">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653344">perl</span><span class="op" id="7653348">,</span>&nbsp;<span class="ident" id="7653350">err</span>&nbsp;<span class="op" id="7653354">=</span>&nbsp;<span class="ident" id="7653356">exec</span><span class="op" id="7653360">.</span><span class="ident" id="7653361">LookPath</span><span class="op" id="7653369">(</span><span class="string" id="7653370">&#34;perl&#34;</span><span class="op" id="7653376">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7653379">if</span>&nbsp;<span class="ident" id="7653382">err</span>&nbsp;<span class="op" id="7653386">!=</span>&nbsp;<span class="ident" id="7653389">nil</span>&nbsp;<span class="op" id="7653393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653397">t</span><span class="op" id="7653398">.</span><span class="ident" id="7653399">Skipf</span><span class="op" id="7653404">(</span><span class="string" id="7653405">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7653437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7653440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653443">perl</span><span class="op" id="7653447">,</span>&nbsp;<span class="ident" id="7653449">_</span>&nbsp;<span class="op" id="7653451">=</span>&nbsp;<span class="ident" id="7653453">filepath</span><span class="op" id="7653461">.</span><span class="ident" id="7653462">Abs</span><span class="op" id="7653465">(</span><span class="ident" id="7653466">perl</span><span class="op" id="7653470">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653474">cwd</span><span class="op" id="7653477">,</span>&nbsp;<span class="ident" id="7653479">_</span>&nbsp;<span class="op" id="7653481">:=</span>&nbsp;<span class="ident" id="7653484">os</span><span class="op" id="7653486">.</span><span class="ident" id="7653487">Getwd</span><span class="op" id="7653492">(</span><span class="op" id="7653493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653496">h</span>&nbsp;<span class="op" id="7653498">:=</span>&nbsp;<span class="op" id="7653501">&amp;</span><span class="ident" id="7653502">Handler</span><span class="op" id="7653509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653513">Path</span><span class="op" id="7653517">:</span>&nbsp;<span class="ident" id="7653519">perl</span><span class="op" id="7653523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653527">Root</span><span class="op" id="7653531">:</span>&nbsp;<span class="string" id="7653533">&#34;/test.cgi&#34;</span><span class="op" id="7653544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653548">Dir</span><span class="op" id="7653551">:</span>&nbsp;&nbsp;<span class="ident" id="7653554">cwd</span><span class="op" id="7653557">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653561">Args</span><span class="op" id="7653565">:</span>&nbsp;<span class="op" id="7653567">[</span><span class="op" id="7653568">]</span><span class="builtintype" id="7653569">string</span><span class="op" id="7653575">{</span><span class="ident" id="7653576">cgifile</span><span class="op" id="7653583">}</span><span class="op" id="7653584">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653588">Env</span><span class="op" id="7653591">:</span>&nbsp;<span class="op" id="7653593">[</span><span class="op" id="7653594">]</span><span class="builtintype" id="7653595">string</span><span class="op" id="7653601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7653606">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7653625">+</span>&nbsp;<span class="ident" id="7653627">cgifile</span><span class="op" id="7653634">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7653639">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="7653661">}</span><span class="op" id="7653662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7653665">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653668">expectedMap</span>&nbsp;<span class="op" id="7653680">:=</span>&nbsp;<span class="keyword" id="7653683">map</span><span class="op" id="7653686">[</span><span class="builtintype" id="7653687">string</span><span class="op" id="7653693">]</span><span class="builtintype" id="7653694">string</span><span class="op" id="7653700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7653704">&#34;cwd&#34;</span><span class="op" id="7653709">:</span>&nbsp;<span class="ident" id="7653711">cwd</span><span class="op" id="7653714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7653718">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7653739">:</span>&nbsp;<span class="ident" id="7653741">cgifile</span><span class="op" id="7653748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7653752">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7653769">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7653775">&#34;/foo/bar&#34;</span><span class="op" id="7653785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7653788">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7653791">runCgiTest</span><span class="op" id="7653801">(</span><span class="ident" id="7653802">t</span><span class="op" id="7653803">,</span>&nbsp;<span class="ident" id="7653805">h</span><span class="op" id="7653806">,</span>&nbsp;<span class="string" id="7653808">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7653855">,</span>&nbsp;<span class="ident" id="7653857">expectedMap</span><span class="op" id="7653868">)</span><br>
<span class="lineno"></span><span class="op" id="7653870">}</span>
</div>
</body>
</html>
