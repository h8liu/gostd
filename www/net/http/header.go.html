<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3528562">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3528618">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3528672">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3528723">package</span>&nbsp;<span class="ident" id="3528731">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3528737">import</span>&nbsp;<span class="op" id="3528744">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3528747">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3528753">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3528770">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3528778">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3528789">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3528797">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3528804">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3528807">var</span>&nbsp;<span class="ident" id="3528811">raceEnabled</span>&nbsp;<span class="op" id="3528823">=</span>&nbsp;<span class="ident" id="3528825">false</span>&nbsp;<span class="comment" id="3528831">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3528850">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3528912">type</span>&nbsp;<span class="ident" id="3528917">Header</span>&nbsp;<span class="keyword" id="3528924">map</span><span class="op" id="3528927">[</span><span class="builtintype" id="3528928">string</span><span class="op" id="3528934">]</span><span class="op" id="3528935">[</span><span class="op" id="3528936">]</span><span class="builtintype" id="3528937">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3528945">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3528992">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3529050">func</span>&nbsp;<span class="op" id="3529055">(</span><span class="ident" id="3529056">h</span>&nbsp;<span class="ident" id="3529058">Header</span><span class="op" id="3529064">)</span>&nbsp;<span class="ident" id="3529066">Add</span><span class="op" id="3529069">(</span><span class="ident" id="3529070">key</span><span class="op" id="3529073">,</span>&nbsp;<span class="ident" id="3529075">value</span>&nbsp;<span class="builtintype" id="3529081">string</span><span class="op" id="3529087">)</span>&nbsp;<span class="op" id="3529089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529092">textproto</span><span class="op" id="3529101">.</span><span class="ident" id="3529102">MIMEHeader</span><span class="op" id="3529112">(</span><span class="ident" id="3529113">h</span><span class="op" id="3529114">)</span><span class="op" id="3529115">.</span><span class="ident" id="3529116">Add</span><span class="op" id="3529119">(</span><span class="ident" id="3529120">key</span><span class="op" id="3529123">,</span>&nbsp;<span class="ident" id="3529125">value</span><span class="op" id="3529130">)</span><br>
<span class="lineno">25</span><span class="op" id="3529132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3529135">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3529189">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="3529244">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="3529275">func</span>&nbsp;<span class="op" id="3529280">(</span><span class="ident" id="3529281">h</span>&nbsp;<span class="ident" id="3529283">Header</span><span class="op" id="3529289">)</span>&nbsp;<span class="ident" id="3529291">Set</span><span class="op" id="3529294">(</span><span class="ident" id="3529295">key</span><span class="op" id="3529298">,</span>&nbsp;<span class="ident" id="3529300">value</span>&nbsp;<span class="builtintype" id="3529306">string</span><span class="op" id="3529312">)</span>&nbsp;<span class="op" id="3529314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529317">textproto</span><span class="op" id="3529326">.</span><span class="ident" id="3529327">MIMEHeader</span><span class="op" id="3529337">(</span><span class="ident" id="3529338">h</span><span class="op" id="3529339">)</span><span class="op" id="3529340">.</span><span class="ident" id="3529341">Set</span><span class="op" id="3529344">(</span><span class="ident" id="3529345">key</span><span class="op" id="3529348">,</span>&nbsp;<span class="ident" id="3529350">value</span><span class="op" id="3529355">)</span><br>
<span class="lineno"></span><span class="op" id="3529357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3529360">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="3529419">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3529486">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3529549">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="3529577">func</span>&nbsp;<span class="op" id="3529582">(</span><span class="ident" id="3529583">h</span>&nbsp;<span class="ident" id="3529585">Header</span><span class="op" id="3529591">)</span>&nbsp;<span class="ident" id="3529593">Get</span><span class="op" id="3529596">(</span><span class="ident" id="3529597">key</span>&nbsp;<span class="builtintype" id="3529601">string</span><span class="op" id="3529607">)</span>&nbsp;<span class="builtintype" id="3529609">string</span>&nbsp;<span class="op" id="3529616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529619">return</span>&nbsp;<span class="ident" id="3529626">textproto</span><span class="op" id="3529635">.</span><span class="ident" id="3529636">MIMEHeader</span><span class="op" id="3529646">(</span><span class="ident" id="3529647">h</span><span class="op" id="3529648">)</span><span class="op" id="3529649">.</span><span class="ident" id="3529650">Get</span><span class="op" id="3529653">(</span><span class="ident" id="3529654">key</span><span class="op" id="3529657">)</span><br>
<span class="lineno">40</span><span class="op" id="3529659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3529662">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="3529734">func</span>&nbsp;<span class="op" id="3529739">(</span><span class="ident" id="3529740">h</span>&nbsp;<span class="ident" id="3529742">Header</span><span class="op" id="3529748">)</span>&nbsp;<span class="ident" id="3529750">get</span><span class="op" id="3529753">(</span><span class="ident" id="3529754">key</span>&nbsp;<span class="builtintype" id="3529758">string</span><span class="op" id="3529764">)</span>&nbsp;<span class="builtintype" id="3529766">string</span>&nbsp;<span class="op" id="3529773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529776">if</span>&nbsp;<span class="ident" id="3529779">v</span>&nbsp;<span class="op" id="3529781">:=</span>&nbsp;<span class="ident" id="3529784">h</span><span class="op" id="3529785">[</span><span class="ident" id="3529786">key</span><span class="op" id="3529789">]</span><span class="op" id="3529790">;</span>&nbsp;<span class="builtinfunc" id="3529792">len</span><span class="op" id="3529795">(</span><span class="ident" id="3529796">v</span><span class="op" id="3529797">)</span>&nbsp;<span class="op" id="3529799">&gt;</span>&nbsp;<span class="num" id="3529801">0</span>&nbsp;<span class="op" id="3529803">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529807">return</span>&nbsp;<span class="ident" id="3529814">v</span><span class="op" id="3529815">[</span><span class="num" id="3529816">0</span><span class="op" id="3529817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529823">return</span>&nbsp;<span class="string" id="3529830">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3529833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3529836">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3529883">func</span>&nbsp;<span class="op" id="3529888">(</span><span class="ident" id="3529889">h</span>&nbsp;<span class="ident" id="3529891">Header</span><span class="op" id="3529897">)</span>&nbsp;<span class="ident" id="3529899">Del</span><span class="op" id="3529902">(</span><span class="ident" id="3529903">key</span>&nbsp;<span class="builtintype" id="3529907">string</span><span class="op" id="3529913">)</span>&nbsp;<span class="op" id="3529915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529918">textproto</span><span class="op" id="3529927">.</span><span class="ident" id="3529928">MIMEHeader</span><span class="op" id="3529938">(</span><span class="ident" id="3529939">h</span><span class="op" id="3529940">)</span><span class="op" id="3529941">.</span><span class="ident" id="3529942">Del</span><span class="op" id="3529945">(</span><span class="ident" id="3529946">key</span><span class="op" id="3529949">)</span><br>
<span class="lineno"></span><span class="op" id="3529951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3529954">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3529995">func</span>&nbsp;<span class="op" id="3530000">(</span><span class="ident" id="3530001">h</span>&nbsp;<span class="ident" id="3530003">Header</span><span class="op" id="3530009">)</span>&nbsp;<span class="ident" id="3530011">Write</span><span class="op" id="3530016">(</span><span class="ident" id="3530017">w</span>&nbsp;<span class="ident" id="3530019">io</span><span class="op" id="3530021">.</span><span class="ident" id="3530022">Writer</span><span class="op" id="3530028">)</span>&nbsp;<span class="builtintype" id="3530030">error</span>&nbsp;<span class="op" id="3530036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530039">return</span>&nbsp;<span class="ident" id="3530046">h</span><span class="op" id="3530047">.</span><span class="ident" id="3530048">WriteSubset</span><span class="op" id="3530059">(</span><span class="ident" id="3530060">w</span><span class="op" id="3530061">,</span>&nbsp;<span class="ident" id="3530063">nil</span><span class="op" id="3530066">)</span><br>
<span class="lineno"></span><span class="op" id="3530068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3530071">func</span>&nbsp;<span class="op" id="3530076">(</span><span class="ident" id="3530077">h</span>&nbsp;<span class="ident" id="3530079">Header</span><span class="op" id="3530085">)</span>&nbsp;<span class="ident" id="3530087">clone</span><span class="op" id="3530092">(</span><span class="op" id="3530093">)</span>&nbsp;<span class="ident" id="3530095">Header</span>&nbsp;<span class="op" id="3530102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530105">h2</span>&nbsp;<span class="op" id="3530108">:=</span>&nbsp;<span class="builtinfunc" id="3530111">make</span><span class="op" id="3530115">(</span><span class="ident" id="3530116">Header</span><span class="op" id="3530122">,</span>&nbsp;<span class="builtinfunc" id="3530124">len</span><span class="op" id="3530127">(</span><span class="ident" id="3530128">h</span><span class="op" id="3530129">)</span><span class="op" id="3530130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530133">for</span>&nbsp;<span class="ident" id="3530137">k</span><span class="op" id="3530138">,</span>&nbsp;<span class="ident" id="3530140">vv</span>&nbsp;<span class="op" id="3530143">:=</span>&nbsp;<span class="keyword" id="3530146">range</span>&nbsp;<span class="ident" id="3530152">h</span>&nbsp;<span class="op" id="3530154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530158">vv2</span>&nbsp;<span class="op" id="3530162">:=</span>&nbsp;<span class="builtinfunc" id="3530165">make</span><span class="op" id="3530169">(</span><span class="op" id="3530170">[</span><span class="op" id="3530171">]</span><span class="builtintype" id="3530172">string</span><span class="op" id="3530178">,</span>&nbsp;<span class="builtinfunc" id="3530180">len</span><span class="op" id="3530183">(</span><span class="ident" id="3530184">vv</span><span class="op" id="3530186">)</span><span class="op" id="3530187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3530191">copy</span><span class="op" id="3530195">(</span><span class="ident" id="3530196">vv2</span><span class="op" id="3530199">,</span>&nbsp;<span class="ident" id="3530201">vv</span><span class="op" id="3530203">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530207">h2</span><span class="op" id="3530209">[</span><span class="ident" id="3530210">k</span><span class="op" id="3530211">]</span>&nbsp;<span class="op" id="3530213">=</span>&nbsp;<span class="ident" id="3530215">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530223">return</span>&nbsp;<span class="ident" id="3530230">h2</span><br>
<span class="lineno"></span><span class="op" id="3530233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3530236">var</span>&nbsp;<span class="ident" id="3530240">timeFormats</span>&nbsp;<span class="op" id="3530252">=</span>&nbsp;<span class="op" id="3530254">[</span><span class="op" id="3530255">]</span><span class="builtintype" id="3530256">string</span><span class="op" id="3530262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530265">TimeFormat</span><span class="op" id="3530275">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530278">time</span><span class="op" id="3530282">.</span><span class="ident" id="3530283">RFC850</span><span class="op" id="3530289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530292">time</span><span class="op" id="3530296">.</span><span class="ident" id="3530297">ANSIC</span><span class="op" id="3530302">,</span><br>
<span class="lineno"></span><span class="op" id="3530304">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="3530307">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="3530369">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="3530426">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="3530470">func</span>&nbsp;<span class="ident" id="3530475">ParseTime</span><span class="op" id="3530484">(</span><span class="ident" id="3530485">text</span>&nbsp;<span class="builtintype" id="3530490">string</span><span class="op" id="3530496">)</span>&nbsp;<span class="op" id="3530498">(</span><span class="ident" id="3530499">t</span>&nbsp;<span class="ident" id="3530501">time</span><span class="op" id="3530505">.</span><span class="ident" id="3530506">Time</span><span class="op" id="3530510">,</span>&nbsp;<span class="ident" id="3530512">err</span>&nbsp;<span class="builtintype" id="3530516">error</span><span class="op" id="3530521">)</span>&nbsp;<span class="op" id="3530523">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530526">for</span>&nbsp;<span class="ident" id="3530530">_</span><span class="op" id="3530531">,</span>&nbsp;<span class="ident" id="3530533">layout</span>&nbsp;<span class="op" id="3530540">:=</span>&nbsp;<span class="keyword" id="3530543">range</span>&nbsp;<span class="ident" id="3530549">timeFormats</span>&nbsp;<span class="op" id="3530561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530565">t</span><span class="op" id="3530566">,</span>&nbsp;<span class="ident" id="3530568">err</span>&nbsp;<span class="op" id="3530572">=</span>&nbsp;<span class="ident" id="3530574">time</span><span class="op" id="3530578">.</span><span class="ident" id="3530579">Parse</span><span class="op" id="3530584">(</span><span class="ident" id="3530585">layout</span><span class="op" id="3530591">,</span>&nbsp;<span class="ident" id="3530593">text</span><span class="op" id="3530597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530601">if</span>&nbsp;<span class="ident" id="3530604">err</span>&nbsp;<span class="op" id="3530608">==</span>&nbsp;<span class="ident" id="3530611">nil</span>&nbsp;<span class="op" id="3530615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530620">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530629">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530635">return</span><br>
<span class="lineno"></span><span class="op" id="3530642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3530645">var</span>&nbsp;<span class="ident" id="3530649">headerNewlineToSpace</span>&nbsp;<span class="op" id="3530670">=</span>&nbsp;<span class="ident" id="3530672">strings</span><span class="op" id="3530679">.</span><span class="ident" id="3530680">NewReplacer</span><span class="op" id="3530691">(</span><span class="string" id="3530692">&#34;\n&#34;</span><span class="op" id="3530696">,</span>&nbsp;<span class="string" id="3530698">&#34;&nbsp;&#34;</span><span class="op" id="3530701">,</span>&nbsp;<span class="string" id="3530703">&#34;\r&#34;</span><span class="op" id="3530707">,</span>&nbsp;<span class="string" id="3530709">&#34;&nbsp;&#34;</span><span class="op" id="3530712">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3530715">type</span>&nbsp;<span class="ident" id="3530720">writeStringer</span>&nbsp;<span class="keyword" id="3530734">interface</span>&nbsp;<span class="op" id="3530744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530747">WriteString</span><span class="op" id="3530758">(</span><span class="builtintype" id="3530759">string</span><span class="op" id="3530765">)</span>&nbsp;<span class="op" id="3530767">(</span><span class="builtintype" id="3530768">int</span><span class="op" id="3530771">,</span>&nbsp;<span class="builtintype" id="3530773">error</span><span class="op" id="3530778">)</span><br>
<span class="lineno"></span><span class="op" id="3530780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3530783">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3530835">type</span>&nbsp;<span class="ident" id="3530840">stringWriter</span>&nbsp;<span class="keyword" id="3530853">struct</span>&nbsp;<span class="op" id="3530860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530863">w</span>&nbsp;<span class="ident" id="3530865">io</span><span class="op" id="3530867">.</span><span class="ident" id="3530868">Writer</span><br>
<span class="lineno"></span><span class="op" id="3530875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3530878">func</span>&nbsp;<span class="op" id="3530883">(</span><span class="ident" id="3530884">w</span>&nbsp;<span class="ident" id="3530886">stringWriter</span><span class="op" id="3530898">)</span>&nbsp;<span class="ident" id="3530900">WriteString</span><span class="op" id="3530911">(</span><span class="ident" id="3530912">s</span>&nbsp;<span class="builtintype" id="3530914">string</span><span class="op" id="3530920">)</span>&nbsp;<span class="op" id="3530922">(</span><span class="ident" id="3530923">n</span>&nbsp;<span class="builtintype" id="3530925">int</span><span class="op" id="3530928">,</span>&nbsp;<span class="ident" id="3530930">err</span>&nbsp;<span class="builtintype" id="3530934">error</span><span class="op" id="3530939">)</span>&nbsp;<span class="op" id="3530941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530944">return</span>&nbsp;<span class="ident" id="3530951">w</span><span class="op" id="3530952">.</span><span class="ident" id="3530953">w</span><span class="op" id="3530954">.</span><span class="ident" id="3530955">Write</span><span class="op" id="3530960">(</span><span class="op" id="3530961">[</span><span class="op" id="3530962">]</span><span class="builtintype" id="3530963">byte</span><span class="op" id="3530967">(</span><span class="ident" id="3530968">s</span><span class="op" id="3530969">)</span><span class="op" id="3530970">)</span><br>
<span class="lineno"></span><span class="op" id="3530972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3530975">type</span>&nbsp;<span class="ident" id="3530980">keyValues</span>&nbsp;<span class="keyword" id="3530990">struct</span>&nbsp;<span class="op" id="3530997">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531000">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3531007">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531015">values</span>&nbsp;<span class="op" id="3531022">[</span><span class="op" id="3531023">]</span><span class="builtintype" id="3531024">string</span><br>
<span class="lineno"></span><span class="op" id="3531031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531034">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="3531103">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="3531172">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3531211">type</span>&nbsp;<span class="ident" id="3531216">headerSorter</span>&nbsp;<span class="keyword" id="3531229">struct</span>&nbsp;<span class="op" id="3531236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531239">kvs</span>&nbsp;<span class="op" id="3531243">[</span><span class="op" id="3531244">]</span><span class="ident" id="3531245">keyValues</span><br>
<span class="lineno"></span><span class="op" id="3531255">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="3531258">func</span>&nbsp;<span class="op" id="3531263">(</span><span class="ident" id="3531264">s</span>&nbsp;<span class="op" id="3531266">*</span><span class="ident" id="3531267">headerSorter</span><span class="op" id="3531279">)</span>&nbsp;<span class="ident" id="3531281">Len</span><span class="op" id="3531284">(</span><span class="op" id="3531285">)</span>&nbsp;<span class="builtintype" id="3531287">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3531301">{</span>&nbsp;<span class="keyword" id="3531303">return</span>&nbsp;<span class="builtinfunc" id="3531310">len</span><span class="op" id="3531313">(</span><span class="ident" id="3531314">s</span><span class="op" id="3531315">.</span><span class="ident" id="3531316">kvs</span><span class="op" id="3531319">)</span>&nbsp;<span class="op" id="3531321">}</span><br>
<span class="lineno"></span><span class="keyword" id="3531323">func</span>&nbsp;<span class="op" id="3531328">(</span><span class="ident" id="3531329">s</span>&nbsp;<span class="op" id="3531331">*</span><span class="ident" id="3531332">headerSorter</span><span class="op" id="3531344">)</span>&nbsp;<span class="ident" id="3531346">Swap</span><span class="op" id="3531350">(</span><span class="ident" id="3531351">i</span><span class="op" id="3531352">,</span>&nbsp;<span class="ident" id="3531354">j</span>&nbsp;<span class="builtintype" id="3531356">int</span><span class="op" id="3531359">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3531366">{</span>&nbsp;<span class="ident" id="3531368">s</span><span class="op" id="3531369">.</span><span class="ident" id="3531370">kvs</span><span class="op" id="3531373">[</span><span class="ident" id="3531374">i</span><span class="op" id="3531375">]</span><span class="op" id="3531376">,</span>&nbsp;<span class="ident" id="3531378">s</span><span class="op" id="3531379">.</span><span class="ident" id="3531380">kvs</span><span class="op" id="3531383">[</span><span class="ident" id="3531384">j</span><span class="op" id="3531385">]</span>&nbsp;<span class="op" id="3531387">=</span>&nbsp;<span class="ident" id="3531389">s</span><span class="op" id="3531390">.</span><span class="ident" id="3531391">kvs</span><span class="op" id="3531394">[</span><span class="ident" id="3531395">j</span><span class="op" id="3531396">]</span><span class="op" id="3531397">,</span>&nbsp;<span class="ident" id="3531399">s</span><span class="op" id="3531400">.</span><span class="ident" id="3531401">kvs</span><span class="op" id="3531404">[</span><span class="ident" id="3531405">i</span><span class="op" id="3531406">]</span>&nbsp;<span class="op" id="3531408">}</span><br>
<span class="lineno"></span><span class="keyword" id="3531410">func</span>&nbsp;<span class="op" id="3531415">(</span><span class="ident" id="3531416">s</span>&nbsp;<span class="op" id="3531418">*</span><span class="ident" id="3531419">headerSorter</span><span class="op" id="3531431">)</span>&nbsp;<span class="ident" id="3531433">Less</span><span class="op" id="3531437">(</span><span class="ident" id="3531438">i</span><span class="op" id="3531439">,</span>&nbsp;<span class="ident" id="3531441">j</span>&nbsp;<span class="builtintype" id="3531443">int</span><span class="op" id="3531446">)</span>&nbsp;<span class="builtintype" id="3531448">bool</span>&nbsp;<span class="op" id="3531453">{</span>&nbsp;<span class="keyword" id="3531455">return</span>&nbsp;<span class="ident" id="3531462">s</span><span class="op" id="3531463">.</span><span class="ident" id="3531464">kvs</span><span class="op" id="3531467">[</span><span class="ident" id="3531468">i</span><span class="op" id="3531469">]</span><span class="op" id="3531470">.</span><span class="ident" id="3531471">key</span>&nbsp;<span class="op" id="3531475">&lt;</span>&nbsp;<span class="ident" id="3531477">s</span><span class="op" id="3531478">.</span><span class="ident" id="3531479">kvs</span><span class="op" id="3531482">[</span><span class="ident" id="3531483">j</span><span class="op" id="3531484">]</span><span class="op" id="3531485">.</span><span class="ident" id="3531486">key</span>&nbsp;<span class="op" id="3531490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="3531493">var</span>&nbsp;<span class="ident" id="3531497">headerSorterPool</span>&nbsp;<span class="op" id="3531514">=</span>&nbsp;<span class="ident" id="3531516">sync</span><span class="op" id="3531520">.</span><span class="ident" id="3531521">Pool</span><span class="op" id="3531525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531528">New</span><span class="op" id="3531531">:</span>&nbsp;<span class="keyword" id="3531533">func</span><span class="op" id="3531537">(</span><span class="op" id="3531538">)</span>&nbsp;<span class="keyword" id="3531540">interface</span><span class="op" id="3531549">{</span><span class="op" id="3531550">}</span>&nbsp;<span class="op" id="3531552">{</span>&nbsp;<span class="keyword" id="3531554">return</span>&nbsp;<span class="builtinfunc" id="3531561">new</span><span class="op" id="3531564">(</span><span class="ident" id="3531565">headerSorter</span><span class="op" id="3531577">)</span>&nbsp;<span class="op" id="3531579">}</span><span class="op" id="3531580">,</span><br>
<span class="lineno"></span><span class="op" id="3531582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531585">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="3531648">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="3531719">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="3531751">func</span>&nbsp;<span class="op" id="3531756">(</span><span class="ident" id="3531757">h</span>&nbsp;<span class="ident" id="3531759">Header</span><span class="op" id="3531765">)</span>&nbsp;<span class="ident" id="3531767">sortedKeyValues</span><span class="op" id="3531782">(</span><span class="ident" id="3531783">exclude</span>&nbsp;<span class="keyword" id="3531791">map</span><span class="op" id="3531794">[</span><span class="builtintype" id="3531795">string</span><span class="op" id="3531801">]</span><span class="builtintype" id="3531802">bool</span><span class="op" id="3531806">)</span>&nbsp;<span class="op" id="3531808">(</span><span class="ident" id="3531809">kvs</span>&nbsp;<span class="op" id="3531813">[</span><span class="op" id="3531814">]</span><span class="ident" id="3531815">keyValues</span><span class="op" id="3531824">,</span>&nbsp;<span class="ident" id="3531826">hs</span>&nbsp;<span class="op" id="3531829">*</span><span class="ident" id="3531830">headerSorter</span><span class="op" id="3531842">)</span>&nbsp;<span class="op" id="3531844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531847">hs</span>&nbsp;<span class="op" id="3531850">=</span>&nbsp;<span class="ident" id="3531852">headerSorterPool</span><span class="op" id="3531868">.</span><span class="ident" id="3531869">Get</span><span class="op" id="3531872">(</span><span class="op" id="3531873">)</span><span class="op" id="3531874">.</span><span class="op" id="3531875">(</span><span class="op" id="3531876">*</span><span class="ident" id="3531877">headerSorter</span><span class="op" id="3531889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531892">if</span>&nbsp;<span class="builtinfunc" id="3531895">cap</span><span class="op" id="3531898">(</span><span class="ident" id="3531899">hs</span><span class="op" id="3531901">.</span><span class="ident" id="3531902">kvs</span><span class="op" id="3531905">)</span>&nbsp;<span class="op" id="3531907">&lt;</span>&nbsp;<span class="builtinfunc" id="3531909">len</span><span class="op" id="3531912">(</span><span class="ident" id="3531913">h</span><span class="op" id="3531914">)</span>&nbsp;<span class="op" id="3531916">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531920">hs</span><span class="op" id="3531922">.</span><span class="ident" id="3531923">kvs</span>&nbsp;<span class="op" id="3531927">=</span>&nbsp;<span class="builtinfunc" id="3531929">make</span><span class="op" id="3531933">(</span><span class="op" id="3531934">[</span><span class="op" id="3531935">]</span><span class="ident" id="3531936">keyValues</span><span class="op" id="3531945">,</span>&nbsp;<span class="num" id="3531947">0</span><span class="op" id="3531948">,</span>&nbsp;<span class="builtinfunc" id="3531950">len</span><span class="op" id="3531953">(</span><span class="ident" id="3531954">h</span><span class="op" id="3531955">)</span><span class="op" id="3531956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531962">kvs</span>&nbsp;<span class="op" id="3531966">=</span>&nbsp;<span class="ident" id="3531968">hs</span><span class="op" id="3531970">.</span><span class="ident" id="3531971">kvs</span><span class="op" id="3531974">[</span><span class="op" id="3531975">:</span><span class="num" id="3531976">0</span><span class="op" id="3531977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531980">for</span>&nbsp;<span class="ident" id="3531984">k</span><span class="op" id="3531985">,</span>&nbsp;<span class="ident" id="3531987">vv</span>&nbsp;<span class="op" id="3531990">:=</span>&nbsp;<span class="keyword" id="3531993">range</span>&nbsp;<span class="ident" id="3531999">h</span>&nbsp;<span class="op" id="3532001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532005">if</span>&nbsp;<span class="op" id="3532008">!</span><span class="ident" id="3532009">exclude</span><span class="op" id="3532016">[</span><span class="ident" id="3532017">k</span><span class="op" id="3532018">]</span>&nbsp;<span class="op" id="3532020">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532025">kvs</span>&nbsp;<span class="op" id="3532029">=</span>&nbsp;<span class="builtinfunc" id="3532031">append</span><span class="op" id="3532037">(</span><span class="ident" id="3532038">kvs</span><span class="op" id="3532041">,</span>&nbsp;<span class="ident" id="3532043">keyValues</span><span class="op" id="3532052">{</span><span class="ident" id="3532053">k</span><span class="op" id="3532054">,</span>&nbsp;<span class="ident" id="3532056">vv</span><span class="op" id="3532058">}</span><span class="op" id="3532059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532069">hs</span><span class="op" id="3532071">.</span><span class="ident" id="3532072">kvs</span>&nbsp;<span class="op" id="3532076">=</span>&nbsp;<span class="ident" id="3532078">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532083">sort</span><span class="op" id="3532087">.</span><span class="ident" id="3532088">Sort</span><span class="op" id="3532092">(</span><span class="ident" id="3532093">hs</span><span class="op" id="3532095">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532098">return</span>&nbsp;<span class="ident" id="3532105">kvs</span><span class="op" id="3532108">,</span>&nbsp;<span class="ident" id="3532110">hs</span><br>
<span class="lineno"></span><span class="op" id="3532113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532116">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="3532163">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="3532238">func</span>&nbsp;<span class="op" id="3532243">(</span><span class="ident" id="3532244">h</span>&nbsp;<span class="ident" id="3532246">Header</span><span class="op" id="3532252">)</span>&nbsp;<span class="ident" id="3532254">WriteSubset</span><span class="op" id="3532265">(</span><span class="ident" id="3532266">w</span>&nbsp;<span class="ident" id="3532268">io</span><span class="op" id="3532270">.</span><span class="ident" id="3532271">Writer</span><span class="op" id="3532277">,</span>&nbsp;<span class="ident" id="3532279">exclude</span>&nbsp;<span class="keyword" id="3532287">map</span><span class="op" id="3532290">[</span><span class="builtintype" id="3532291">string</span><span class="op" id="3532297">]</span><span class="builtintype" id="3532298">bool</span><span class="op" id="3532302">)</span>&nbsp;<span class="builtintype" id="3532304">error</span>&nbsp;<span class="op" id="3532310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532313">ws</span><span class="op" id="3532315">,</span>&nbsp;<span class="ident" id="3532317">ok</span>&nbsp;<span class="op" id="3532320">:=</span>&nbsp;<span class="ident" id="3532323">w</span><span class="op" id="3532324">.</span><span class="op" id="3532325">(</span><span class="ident" id="3532326">writeStringer</span><span class="op" id="3532339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532342">if</span>&nbsp;<span class="op" id="3532345">!</span><span class="ident" id="3532346">ok</span>&nbsp;<span class="op" id="3532349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532353">ws</span>&nbsp;<span class="op" id="3532356">=</span>&nbsp;<span class="ident" id="3532358">stringWriter</span><span class="op" id="3532370">{</span><span class="ident" id="3532371">w</span><span class="op" id="3532372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532375">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532378">kvs</span><span class="op" id="3532381">,</span>&nbsp;<span class="ident" id="3532383">sorter</span>&nbsp;<span class="op" id="3532390">:=</span>&nbsp;<span class="ident" id="3532393">h</span><span class="op" id="3532394">.</span><span class="ident" id="3532395">sortedKeyValues</span><span class="op" id="3532410">(</span><span class="ident" id="3532411">exclude</span><span class="op" id="3532418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532421">for</span>&nbsp;<span class="ident" id="3532425">_</span><span class="op" id="3532426">,</span>&nbsp;<span class="ident" id="3532428">kv</span>&nbsp;<span class="op" id="3532431">:=</span>&nbsp;<span class="keyword" id="3532434">range</span>&nbsp;<span class="ident" id="3532440">kvs</span>&nbsp;<span class="op" id="3532444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532448">for</span>&nbsp;<span class="ident" id="3532452">_</span><span class="op" id="3532453">,</span>&nbsp;<span class="ident" id="3532455">v</span>&nbsp;<span class="op" id="3532457">:=</span>&nbsp;<span class="keyword" id="3532460">range</span>&nbsp;<span class="ident" id="3532466">kv</span><span class="op" id="3532468">.</span><span class="ident" id="3532469">values</span>&nbsp;<span class="op" id="3532476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532481">v</span>&nbsp;<span class="op" id="3532483">=</span>&nbsp;<span class="ident" id="3532485">headerNewlineToSpace</span><span class="op" id="3532505">.</span><span class="ident" id="3532506">Replace</span><span class="op" id="3532513">(</span><span class="ident" id="3532514">v</span><span class="op" id="3532515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532520">v</span>&nbsp;<span class="op" id="3532522">=</span>&nbsp;<span class="ident" id="3532524">textproto</span><span class="op" id="3532533">.</span><span class="ident" id="3532534">TrimString</span><span class="op" id="3532544">(</span><span class="ident" id="3532545">v</span><span class="op" id="3532546">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532551">for</span>&nbsp;<span class="ident" id="3532555">_</span><span class="op" id="3532556">,</span>&nbsp;<span class="ident" id="3532558">s</span>&nbsp;<span class="op" id="3532560">:=</span>&nbsp;<span class="keyword" id="3532563">range</span>&nbsp;<span class="op" id="3532569">[</span><span class="op" id="3532570">]</span><span class="builtintype" id="3532571">string</span><span class="op" id="3532577">{</span><span class="ident" id="3532578">kv</span><span class="op" id="3532580">.</span><span class="ident" id="3532581">key</span><span class="op" id="3532584">,</span>&nbsp;<span class="string" id="3532586">&#34;:&nbsp;&#34;</span><span class="op" id="3532590">,</span>&nbsp;<span class="ident" id="3532592">v</span><span class="op" id="3532593">,</span>&nbsp;<span class="string" id="3532595">&#34;\r\n&#34;</span><span class="op" id="3532601">}</span>&nbsp;<span class="op" id="3532603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532609">if</span>&nbsp;<span class="ident" id="3532612">_</span><span class="op" id="3532613">,</span>&nbsp;<span class="ident" id="3532615">err</span>&nbsp;<span class="op" id="3532619">:=</span>&nbsp;<span class="ident" id="3532622">ws</span><span class="op" id="3532624">.</span><span class="ident" id="3532625">WriteString</span><span class="op" id="3532636">(</span><span class="ident" id="3532637">s</span><span class="op" id="3532638">)</span><span class="op" id="3532639">;</span>&nbsp;<span class="ident" id="3532641">err</span>&nbsp;<span class="op" id="3532645">!=</span>&nbsp;<span class="ident" id="3532648">nil</span>&nbsp;<span class="op" id="3532652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532659">return</span>&nbsp;<span class="ident" id="3532666">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532679">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532689">headerSorterPool</span><span class="op" id="3532705">.</span><span class="ident" id="3532706">Put</span><span class="op" id="3532709">(</span><span class="ident" id="3532710">sorter</span><span class="op" id="3532716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532719">return</span>&nbsp;<span class="ident" id="3532726">nil</span><br>
<span class="lineno"></span><span class="op" id="3532730">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3532733">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3532791">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3532849">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="3532908">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="3532966">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3533027">func</span>&nbsp;<span class="ident" id="3533032">CanonicalHeaderKey</span><span class="op" id="3533050">(</span><span class="ident" id="3533051">s</span>&nbsp;<span class="builtintype" id="3533053">string</span><span class="op" id="3533059">)</span>&nbsp;<span class="builtintype" id="3533061">string</span>&nbsp;<span class="op" id="3533068">{</span>&nbsp;<span class="keyword" id="3533070">return</span>&nbsp;<span class="ident" id="3533077">textproto</span><span class="op" id="3533086">.</span><span class="ident" id="3533087">CanonicalMIMEHeaderKey</span><span class="op" id="3533109">(</span><span class="ident" id="3533110">s</span><span class="op" id="3533111">)</span>&nbsp;<span class="op" id="3533113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533116">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="3533172">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="3533225">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="3533257">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="3533287">func</span>&nbsp;<span class="ident" id="3533292">hasToken</span><span class="op" id="3533300">(</span><span class="ident" id="3533301">v</span><span class="op" id="3533302">,</span>&nbsp;<span class="ident" id="3533304">token</span>&nbsp;<span class="builtintype" id="3533310">string</span><span class="op" id="3533316">)</span>&nbsp;<span class="builtintype" id="3533318">bool</span>&nbsp;<span class="op" id="3533323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533326">if</span>&nbsp;<span class="builtinfunc" id="3533329">len</span><span class="op" id="3533332">(</span><span class="ident" id="3533333">token</span><span class="op" id="3533338">)</span>&nbsp;<span class="op" id="3533340">&gt;</span>&nbsp;<span class="builtinfunc" id="3533342">len</span><span class="op" id="3533345">(</span><span class="ident" id="3533346">v</span><span class="op" id="3533347">)</span>&nbsp;<span class="op" id="3533349">||</span>&nbsp;<span class="ident" id="3533352">token</span>&nbsp;<span class="op" id="3533358">==</span>&nbsp;<span class="string" id="3533361">&#34;&#34;</span>&nbsp;<span class="op" id="3533364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533368">return</span>&nbsp;<span class="ident" id="3533375">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533385">if</span>&nbsp;<span class="ident" id="3533388">v</span>&nbsp;<span class="op" id="3533390">==</span>&nbsp;<span class="ident" id="3533393">token</span>&nbsp;<span class="op" id="3533399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533403">return</span>&nbsp;<span class="ident" id="3533410">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533419">for</span>&nbsp;<span class="ident" id="3533423">sp</span>&nbsp;<span class="op" id="3533426">:=</span>&nbsp;<span class="num" id="3533429">0</span><span class="op" id="3533430">;</span>&nbsp;<span class="ident" id="3533432">sp</span>&nbsp;<span class="op" id="3533435">&lt;=</span>&nbsp;<span class="builtinfunc" id="3533438">len</span><span class="op" id="3533441">(</span><span class="ident" id="3533442">v</span><span class="op" id="3533443">)</span><span class="op" id="3533444">-</span><span class="builtinfunc" id="3533445">len</span><span class="op" id="3533448">(</span><span class="ident" id="3533449">token</span><span class="op" id="3533454">)</span><span class="op" id="3533455">;</span>&nbsp;<span class="ident" id="3533457">sp</span><span class="op" id="3533459">++</span>&nbsp;<span class="op" id="3533462">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533466">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533507">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533563">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533616">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533671">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533725">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533784">if</span>&nbsp;<span class="ident" id="3533787">b</span>&nbsp;<span class="op" id="3533789">:=</span>&nbsp;<span class="ident" id="3533792">v</span><span class="op" id="3533793">[</span><span class="ident" id="3533794">sp</span><span class="op" id="3533796">]</span><span class="op" id="3533797">;</span>&nbsp;<span class="ident" id="3533799">b</span>&nbsp;<span class="op" id="3533801">!=</span>&nbsp;<span class="ident" id="3533804">token</span><span class="op" id="3533809">[</span><span class="num" id="3533810">0</span><span class="op" id="3533811">]</span>&nbsp;<span class="op" id="3533813">&amp;&amp;</span>&nbsp;<span class="ident" id="3533816">b</span><span class="op" id="3533817">|</span><span class="num" id="3533818">0x20</span>&nbsp;<span class="op" id="3533823">!=</span>&nbsp;<span class="ident" id="3533826">token</span><span class="op" id="3533831">[</span><span class="num" id="3533832">0</span><span class="op" id="3533833">]</span>&nbsp;<span class="op" id="3533835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533840">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533855">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533911">if</span>&nbsp;<span class="ident" id="3533914">sp</span>&nbsp;<span class="op" id="3533917">&gt;</span>&nbsp;<span class="num" id="3533919">0</span>&nbsp;<span class="op" id="3533921">&amp;&amp;</span>&nbsp;<span class="op" id="3533924">!</span><span class="ident" id="3533925">isTokenBoundary</span><span class="op" id="3533940">(</span><span class="ident" id="3533941">v</span><span class="op" id="3533942">[</span><span class="ident" id="3533943">sp</span><span class="op" id="3533945">-</span><span class="num" id="3533946">1</span><span class="op" id="3533947">]</span><span class="op" id="3533948">)</span>&nbsp;<span class="op" id="3533950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533955">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3533970">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534024">if</span>&nbsp;<span class="ident" id="3534027">endPos</span>&nbsp;<span class="op" id="3534034">:=</span>&nbsp;<span class="ident" id="3534037">sp</span>&nbsp;<span class="op" id="3534040">+</span>&nbsp;<span class="builtinfunc" id="3534042">len</span><span class="op" id="3534045">(</span><span class="ident" id="3534046">token</span><span class="op" id="3534051">)</span><span class="op" id="3534052">;</span>&nbsp;<span class="ident" id="3534054">endPos</span>&nbsp;<span class="op" id="3534061">!=</span>&nbsp;<span class="builtinfunc" id="3534064">len</span><span class="op" id="3534067">(</span><span class="ident" id="3534068">v</span><span class="op" id="3534069">)</span>&nbsp;<span class="op" id="3534071">&amp;&amp;</span>&nbsp;<span class="op" id="3534074">!</span><span class="ident" id="3534075">isTokenBoundary</span><span class="op" id="3534090">(</span><span class="ident" id="3534091">v</span><span class="op" id="3534092">[</span><span class="ident" id="3534093">endPos</span><span class="op" id="3534099">]</span><span class="op" id="3534100">)</span>&nbsp;<span class="op" id="3534102">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534107">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534122">if</span>&nbsp;<span class="ident" id="3534125">strings</span><span class="op" id="3534132">.</span><span class="ident" id="3534133">EqualFold</span><span class="op" id="3534142">(</span><span class="ident" id="3534143">v</span><span class="op" id="3534144">[</span><span class="ident" id="3534145">sp</span><span class="op" id="3534147">:</span><span class="ident" id="3534148">sp</span><span class="op" id="3534150">+</span><span class="builtinfunc" id="3534151">len</span><span class="op" id="3534154">(</span><span class="ident" id="3534155">token</span><span class="op" id="3534160">)</span><span class="op" id="3534161">]</span><span class="op" id="3534162">,</span>&nbsp;<span class="ident" id="3534164">token</span><span class="op" id="3534169">)</span>&nbsp;<span class="op" id="3534171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534176">return</span>&nbsp;<span class="ident" id="3534183">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534190">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534196">return</span>&nbsp;<span class="ident" id="3534203">false</span><br>
<span class="lineno"></span><span class="op" id="3534209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3534212">func</span>&nbsp;<span class="ident" id="3534217">isTokenBoundary</span><span class="op" id="3534232">(</span><span class="ident" id="3534233">b</span>&nbsp;<span class="builtintype" id="3534235">byte</span><span class="op" id="3534239">)</span>&nbsp;<span class="builtintype" id="3534241">bool</span>&nbsp;<span class="op" id="3534246">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534249">return</span>&nbsp;<span class="ident" id="3534256">b</span>&nbsp;<span class="op" id="3534258">==</span>&nbsp;<span class="string" id="3534261">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3534265">||</span>&nbsp;<span class="ident" id="3534268">b</span>&nbsp;<span class="op" id="3534270">==</span>&nbsp;<span class="string" id="3534273">&#39;,&#39;</span>&nbsp;<span class="op" id="3534277">||</span>&nbsp;<span class="ident" id="3534280">b</span>&nbsp;<span class="op" id="3534282">==</span>&nbsp;<span class="string" id="3534285">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="3534290">}</span>
</div>
</body>
</html>
