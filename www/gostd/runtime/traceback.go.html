<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1718786">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1718841">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1718895">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1718946">package</span>&nbsp;<span class="ident" id="1718954">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1718963">import</span>&nbsp;<span class="string" id="1718970">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1718980">//&nbsp;The&nbsp;code&nbsp;in&nbsp;this&nbsp;file&nbsp;implements&nbsp;stack&nbsp;trace&nbsp;walking&nbsp;for&nbsp;all&nbsp;architectures.</span><br>
<span class="lineno">10</span><span class="comment" id="1719059">//&nbsp;The&nbsp;most&nbsp;important&nbsp;fact&nbsp;about&nbsp;a&nbsp;given&nbsp;architecture&nbsp;is&nbsp;whether&nbsp;it&nbsp;uses&nbsp;a&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span><span class="comment" id="1719149">//&nbsp;On&nbsp;systems&nbsp;with&nbsp;link&nbsp;registers,&nbsp;the&nbsp;prologue&nbsp;for&nbsp;a&nbsp;non-leaf&nbsp;function&nbsp;stores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1719232">//&nbsp;incoming&nbsp;value&nbsp;of&nbsp;LR&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;newly&nbsp;allocated&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno"></span><span class="comment" id="1719306">//&nbsp;On&nbsp;systems&nbsp;without&nbsp;link&nbsp;registers,&nbsp;the&nbsp;architecture&nbsp;pushes&nbsp;a&nbsp;return&nbsp;PC&nbsp;during</span><br>
<span class="lineno"></span><span class="comment" id="1719387">//&nbsp;the&nbsp;call&nbsp;instruction,&nbsp;so&nbsp;the&nbsp;return&nbsp;PC&nbsp;ends&nbsp;up&nbsp;above&nbsp;the&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno">15</span><span class="comment" id="1719460">//&nbsp;In&nbsp;this&nbsp;file,&nbsp;the&nbsp;return&nbsp;PC&nbsp;is&nbsp;always&nbsp;called&nbsp;LR,&nbsp;no&nbsp;matter&nbsp;how&nbsp;it&nbsp;was&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="1719540">//</span><br>
<span class="lineno"></span><span class="comment" id="1719543">//&nbsp;To&nbsp;date,&nbsp;the&nbsp;opposite&nbsp;of&nbsp;a&nbsp;link&nbsp;register&nbsp;architecture&nbsp;is&nbsp;an&nbsp;x86&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="comment" id="1719624">//&nbsp;This&nbsp;code&nbsp;may&nbsp;need&nbsp;to&nbsp;change&nbsp;if&nbsp;some&nbsp;other&nbsp;kind&nbsp;of&nbsp;non-link-register</span><br>
<span class="lineno"></span><span class="comment" id="1719696">//&nbsp;architecture&nbsp;comes&nbsp;along.</span><br>
<span class="lineno">20</span><span class="comment" id="1719725">//</span><br>
<span class="lineno"></span><span class="comment" id="1719728">//&nbsp;The&nbsp;other&nbsp;important&nbsp;fact&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;pointer:&nbsp;on&nbsp;32-bit&nbsp;systems&nbsp;the&nbsp;LR</span><br>
<span class="lineno"></span><span class="comment" id="1719807">//&nbsp;takes&nbsp;up&nbsp;only&nbsp;4&nbsp;bytes&nbsp;on&nbsp;the&nbsp;stack,&nbsp;while&nbsp;on&nbsp;64-bit&nbsp;systems&nbsp;it&nbsp;takes&nbsp;up&nbsp;8&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1719891">//&nbsp;Typically&nbsp;this&nbsp;is&nbsp;ptrSize.</span><br>
<span class="lineno"></span><span class="comment" id="1719921">//</span><br>
<span class="lineno">25</span><span class="comment" id="1719924">//&nbsp;As&nbsp;an&nbsp;exception,&nbsp;amd64p32&nbsp;has&nbsp;ptrSize&nbsp;==&nbsp;4&nbsp;but&nbsp;the&nbsp;CALL&nbsp;instruction&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="1720001">//&nbsp;stores&nbsp;an&nbsp;8-byte&nbsp;return&nbsp;PC&nbsp;onto&nbsp;the&nbsp;stack.&nbsp;To&nbsp;accommodate&nbsp;this,&nbsp;we&nbsp;use&nbsp;regSize</span><br>
<span class="lineno"></span><span class="comment" id="1720083">//&nbsp;as&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;architecture-pushed&nbsp;return&nbsp;PC.</span><br>
<span class="lineno"></span><span class="comment" id="1720136">//</span><br>
<span class="lineno"></span><span class="comment" id="1720139">//&nbsp;usesLR&nbsp;is&nbsp;defined&nbsp;below.&nbsp;ptrSize&nbsp;and&nbsp;regSize&nbsp;are&nbsp;defined&nbsp;in&nbsp;stubs.go.</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1720213">const</span>&nbsp;<span class="ident" id="1720219">usesLR</span>&nbsp;<span class="op" id="1720226">=</span>&nbsp;<span class="ident" id="1720228">GOARCH</span>&nbsp;<span class="op" id="1720235">!=</span>&nbsp;<span class="string" id="1720238">&#34;amd64&#34;</span>&nbsp;<span class="op" id="1720246">&amp;&amp;</span>&nbsp;<span class="ident" id="1720249">GOARCH</span>&nbsp;<span class="op" id="1720256">!=</span>&nbsp;<span class="string" id="1720259">&#34;amd64p32&#34;</span>&nbsp;<span class="op" id="1720270">&amp;&amp;</span>&nbsp;<span class="ident" id="1720273">GOARCH</span>&nbsp;<span class="op" id="1720280">!=</span>&nbsp;<span class="string" id="1720283">&#34;386&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1720290">var</span>&nbsp;<span class="op" id="1720294">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1720297">//&nbsp;initialized&nbsp;in&nbsp;tracebackinit</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720330">deferprocPC</span>&nbsp;<span class="builtintype" id="1720342">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720351">goexitPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1720363">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720372">jmpdeferPC</span>&nbsp;&nbsp;<span class="builtintype" id="1720384">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720393">mcallPC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1720405">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720414">morestackPC</span>&nbsp;<span class="builtintype" id="1720426">uintptr</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720435">mstartPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1720447">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720456">newprocPC</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1720468">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720477">rt0_goPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1720489">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720498">sigpanicPC</span>&nbsp;&nbsp;<span class="builtintype" id="1720510">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720520">externalthreadhandlerp</span>&nbsp;<span class="builtintype" id="1720543">uintptr</span>&nbsp;<span class="comment" id="1720551">//&nbsp;initialized&nbsp;elsewhere</span><br>
<span class="lineno"></span><span class="op" id="1720576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1720579">func</span>&nbsp;<span class="ident" id="1720584">tracebackinit</span><span class="op" id="1720597">(</span><span class="op" id="1720598">)</span>&nbsp;<span class="op" id="1720600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1720603">//&nbsp;Go&nbsp;variable&nbsp;initialization&nbsp;happens&nbsp;late&nbsp;during&nbsp;runtime&nbsp;startup.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1720671">//&nbsp;Instead&nbsp;of&nbsp;initializing&nbsp;the&nbsp;variables&nbsp;above&nbsp;in&nbsp;the&nbsp;declarations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1720740">//&nbsp;schedinit&nbsp;calls&nbsp;this&nbsp;function&nbsp;so&nbsp;that&nbsp;the&nbsp;variables&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1720800">//&nbsp;initialized&nbsp;and&nbsp;available&nbsp;earlier&nbsp;in&nbsp;the&nbsp;startup&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720863">deferprocPC</span>&nbsp;<span class="op" id="1720875">=</span>&nbsp;<span class="ident" id="1720877">funcPC</span><span class="op" id="1720883">(</span><span class="ident" id="1720884">deferproc</span><span class="op" id="1720893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720896">goexitPC</span>&nbsp;<span class="op" id="1720905">=</span>&nbsp;<span class="ident" id="1720907">funcPC</span><span class="op" id="1720913">(</span><span class="ident" id="1720914">goexit</span><span class="op" id="1720920">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720923">jmpdeferPC</span>&nbsp;<span class="op" id="1720934">=</span>&nbsp;<span class="ident" id="1720936">funcPC</span><span class="op" id="1720942">(</span><span class="ident" id="1720943">jmpdefer</span><span class="op" id="1720951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720954">mcallPC</span>&nbsp;<span class="op" id="1720962">=</span>&nbsp;<span class="ident" id="1720964">funcPC</span><span class="op" id="1720970">(</span><span class="ident" id="1720971">mcall</span><span class="op" id="1720976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720979">morestackPC</span>&nbsp;<span class="op" id="1720991">=</span>&nbsp;<span class="ident" id="1720993">funcPC</span><span class="op" id="1720999">(</span><span class="ident" id="1721000">morestack</span><span class="op" id="1721009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721012">mstartPC</span>&nbsp;<span class="op" id="1721021">=</span>&nbsp;<span class="ident" id="1721023">funcPC</span><span class="op" id="1721029">(</span><span class="ident" id="1721030">mstart</span><span class="op" id="1721036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721039">newprocPC</span>&nbsp;<span class="op" id="1721049">=</span>&nbsp;<span class="ident" id="1721051">funcPC</span><span class="op" id="1721057">(</span><span class="ident" id="1721058">newproc</span><span class="op" id="1721065">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721068">rt0_goPC</span>&nbsp;<span class="op" id="1721077">=</span>&nbsp;<span class="ident" id="1721079">funcPC</span><span class="op" id="1721085">(</span><span class="ident" id="1721086">rt0_go</span><span class="op" id="1721092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721095">sigpanicPC</span>&nbsp;<span class="op" id="1721106">=</span>&nbsp;<span class="ident" id="1721108">funcPC</span><span class="op" id="1721114">(</span><span class="ident" id="1721115">sigpanic</span><span class="op" id="1721123">)</span><br>
<span class="lineno"></span><span class="op" id="1721125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1721128">//&nbsp;Traceback&nbsp;over&nbsp;the&nbsp;deferred&nbsp;function&nbsp;calls.</span><br>
<span class="lineno">65</span><span class="comment" id="1721175">//&nbsp;Report&nbsp;them&nbsp;like&nbsp;calls&nbsp;that&nbsp;have&nbsp;been&nbsp;invoked&nbsp;but&nbsp;not&nbsp;started&nbsp;executing&nbsp;yet.</span><br>
<span class="lineno"></span><span class="keyword" id="1721255">func</span>&nbsp;<span class="ident" id="1721260">tracebackdefers</span><span class="op" id="1721275">(</span><span class="ident" id="1721276">gp</span>&nbsp;<span class="op" id="1721279">*</span><span class="ident" id="1721280">g</span><span class="op" id="1721281">,</span>&nbsp;<span class="ident" id="1721283">callback</span>&nbsp;<span class="keyword" id="1721292">func</span><span class="op" id="1721296">(</span><span class="op" id="1721297">*</span><span class="ident" id="1721298">stkframe</span><span class="op" id="1721306">,</span>&nbsp;<span class="ident" id="1721308">unsafe</span><span class="op" id="1721314">.</span><span class="ident" id="1721315">Pointer</span><span class="op" id="1721322">)</span>&nbsp;<span class="builtintype" id="1721324">bool</span><span class="op" id="1721328">,</span>&nbsp;<span class="ident" id="1721330">v</span>&nbsp;<span class="ident" id="1721332">unsafe</span><span class="op" id="1721338">.</span><span class="ident" id="1721339">Pointer</span><span class="op" id="1721346">)</span>&nbsp;<span class="op" id="1721348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721351">var</span>&nbsp;<span class="ident" id="1721355">frame</span>&nbsp;<span class="ident" id="1721361">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721371">for</span>&nbsp;<span class="ident" id="1721375">d</span>&nbsp;<span class="op" id="1721377">:=</span>&nbsp;<span class="ident" id="1721380">gp</span><span class="op" id="1721382">.</span><span class="ident" id="1721383">_defer</span><span class="op" id="1721389">;</span>&nbsp;<span class="ident" id="1721391">d</span>&nbsp;<span class="op" id="1721393">!=</span>&nbsp;<span class="ident" id="1721396">nil</span><span class="op" id="1721399">;</span>&nbsp;<span class="ident" id="1721401">d</span>&nbsp;<span class="op" id="1721403">=</span>&nbsp;<span class="ident" id="1721405">d</span><span class="op" id="1721406">.</span><span class="ident" id="1721407">link</span>&nbsp;<span class="op" id="1721412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721416">fn</span>&nbsp;<span class="op" id="1721419">:=</span>&nbsp;<span class="ident" id="1721422">d</span><span class="op" id="1721423">.</span><span class="ident" id="1721424">fn</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721429">if</span>&nbsp;<span class="ident" id="1721432">fn</span>&nbsp;<span class="op" id="1721435">==</span>&nbsp;<span class="ident" id="1721438">nil</span>&nbsp;<span class="op" id="1721442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1721447">//&nbsp;Defer&nbsp;of&nbsp;nil&nbsp;function.&nbsp;Args&nbsp;don&#39;t&nbsp;matter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721495">frame</span><span class="op" id="1721500">.</span><span class="ident" id="1721501">pc</span>&nbsp;<span class="op" id="1721504">=</span>&nbsp;<span class="num" id="1721506">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721511">frame</span><span class="op" id="1721516">.</span><span class="ident" id="1721517">fn</span>&nbsp;<span class="op" id="1721520">=</span>&nbsp;<span class="ident" id="1721522">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721529">frame</span><span class="op" id="1721534">.</span><span class="ident" id="1721535">argp</span>&nbsp;<span class="op" id="1721540">=</span>&nbsp;<span class="num" id="1721542">0</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721547">frame</span><span class="op" id="1721552">.</span><span class="ident" id="1721553">arglen</span>&nbsp;<span class="op" id="1721560">=</span>&nbsp;<span class="num" id="1721562">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721567">frame</span><span class="op" id="1721572">.</span><span class="ident" id="1721573">argmap</span>&nbsp;<span class="op" id="1721580">=</span>&nbsp;<span class="ident" id="1721582">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721588">}</span>&nbsp;<span class="keyword" id="1721590">else</span>&nbsp;<span class="op" id="1721595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721600">frame</span><span class="op" id="1721605">.</span><span class="ident" id="1721606">pc</span>&nbsp;<span class="op" id="1721609">=</span>&nbsp;<span class="builtintype" id="1721611">uintptr</span><span class="op" id="1721618">(</span><span class="ident" id="1721619">fn</span><span class="op" id="1721621">.</span><span class="ident" id="1721622">fn</span><span class="op" id="1721624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721629">f</span>&nbsp;<span class="op" id="1721631">:=</span>&nbsp;<span class="ident" id="1721634">findfunc</span><span class="op" id="1721642">(</span><span class="ident" id="1721643">frame</span><span class="op" id="1721648">.</span><span class="ident" id="1721649">pc</span><span class="op" id="1721651">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721656">if</span>&nbsp;<span class="ident" id="1721659">f</span>&nbsp;<span class="op" id="1721661">==</span>&nbsp;<span class="ident" id="1721664">nil</span>&nbsp;<span class="op" id="1721668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1721674">print</span><span class="op" id="1721679">(</span><span class="string" id="1721680">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;in&nbsp;defer&nbsp;&#34;</span><span class="op" id="1721711">,</span>&nbsp;<span class="ident" id="1721713">hex</span><span class="op" id="1721716">(</span><span class="ident" id="1721717">frame</span><span class="op" id="1721722">.</span><span class="ident" id="1721723">pc</span><span class="op" id="1721725">)</span><span class="op" id="1721726">,</span>&nbsp;<span class="string" id="1721728">&#34;\n&#34;</span><span class="op" id="1721732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721738">gothrow</span><span class="op" id="1721745">(</span><span class="string" id="1721746">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1721758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721768">frame</span><span class="op" id="1721773">.</span><span class="ident" id="1721774">fn</span>&nbsp;<span class="op" id="1721777">=</span>&nbsp;<span class="ident" id="1721779">f</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721784">frame</span><span class="op" id="1721789">.</span><span class="ident" id="1721790">argp</span>&nbsp;<span class="op" id="1721795">=</span>&nbsp;<span class="builtintype" id="1721797">uintptr</span><span class="op" id="1721804">(</span><span class="ident" id="1721805">deferArgs</span><span class="op" id="1721814">(</span><span class="ident" id="1721815">d</span><span class="op" id="1721816">)</span><span class="op" id="1721817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721822">setArgInfo</span><span class="op" id="1721832">(</span><span class="op" id="1721833">&amp;</span><span class="ident" id="1721834">frame</span><span class="op" id="1721839">,</span>&nbsp;<span class="ident" id="1721841">f</span><span class="op" id="1721842">,</span>&nbsp;<span class="builtintype" id="1721844">true</span><span class="op" id="1721848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721856">frame</span><span class="op" id="1721861">.</span><span class="ident" id="1721862">continpc</span>&nbsp;<span class="op" id="1721871">=</span>&nbsp;<span class="ident" id="1721873">frame</span><span class="op" id="1721878">.</span><span class="ident" id="1721879">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721884">if</span>&nbsp;<span class="op" id="1721887">!</span><span class="ident" id="1721888">callback</span><span class="op" id="1721896">(</span><span class="op" id="1721897">(</span><span class="op" id="1721898">*</span><span class="ident" id="1721899">stkframe</span><span class="op" id="1721907">)</span><span class="op" id="1721908">(</span><span class="ident" id="1721909">noescape</span><span class="op" id="1721917">(</span><span class="ident" id="1721918">unsafe</span><span class="op" id="1721924">.</span><span class="ident" id="1721925">Pointer</span><span class="op" id="1721932">(</span><span class="op" id="1721933">&amp;</span><span class="ident" id="1721934">frame</span><span class="op" id="1721939">)</span><span class="op" id="1721940">)</span><span class="op" id="1721941">)</span><span class="op" id="1721942">,</span>&nbsp;<span class="ident" id="1721944">v</span><span class="op" id="1721945">)</span>&nbsp;<span class="op" id="1721947">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721952">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721964">}</span><br>
<span class="lineno"></span><span class="op" id="1721966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="1721969">//&nbsp;Generic&nbsp;traceback.&nbsp;&nbsp;Handles&nbsp;runtime&nbsp;stack&nbsp;prints&nbsp;(pcbuf&nbsp;==&nbsp;nil),</span><br>
<span class="lineno"></span><span class="comment" id="1722037">//&nbsp;the&nbsp;runtime.Callers&nbsp;function&nbsp;(pcbuf&nbsp;!=&nbsp;nil),&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="1722108">//&nbsp;collector&nbsp;(callback&nbsp;!=&nbsp;nil).&nbsp;&nbsp;A&nbsp;little&nbsp;clunky&nbsp;to&nbsp;merge&nbsp;these,&nbsp;but&nbsp;avoids</span><br>
<span class="lineno"></span><span class="comment" id="1722184">//&nbsp;duplicating&nbsp;the&nbsp;code&nbsp;and&nbsp;all&nbsp;its&nbsp;subtlety.</span><br>
<span class="lineno"></span><span class="keyword" id="1722230">func</span>&nbsp;<span class="ident" id="1722235">gentraceback</span><span class="op" id="1722247">(</span><span class="ident" id="1722248">pc0</span>&nbsp;<span class="builtintype" id="1722252">uintptr</span><span class="op" id="1722259">,</span>&nbsp;<span class="ident" id="1722261">sp0</span>&nbsp;<span class="builtintype" id="1722265">uintptr</span><span class="op" id="1722272">,</span>&nbsp;<span class="ident" id="1722274">lr0</span>&nbsp;<span class="builtintype" id="1722278">uintptr</span><span class="op" id="1722285">,</span>&nbsp;<span class="ident" id="1722287">gp</span>&nbsp;<span class="op" id="1722290">*</span><span class="ident" id="1722291">g</span><span class="op" id="1722292">,</span>&nbsp;<span class="ident" id="1722294">skip</span>&nbsp;<span class="builtintype" id="1722299">int</span><span class="op" id="1722302">,</span>&nbsp;<span class="ident" id="1722304">pcbuf</span>&nbsp;<span class="op" id="1722310">*</span><span class="builtintype" id="1722311">uintptr</span><span class="op" id="1722318">,</span>&nbsp;<span class="ident" id="1722320">max</span>&nbsp;<span class="builtintype" id="1722324">int</span><span class="op" id="1722327">,</span>&nbsp;<span class="ident" id="1722329">callback</span>&nbsp;<span class="keyword" id="1722338">func</span><span class="op" id="1722342">(</span><span class="op" id="1722343">*</span><span class="ident" id="1722344">stkframe</span><span class="op" id="1722352">,</span>&nbsp;<span class="ident" id="1722354">unsafe</span><span class="op" id="1722360">.</span><span class="ident" id="1722361">Pointer</span><span class="op" id="1722368">)</span>&nbsp;<span class="builtintype" id="1722370">bool</span><span class="op" id="1722374">,</span>&nbsp;<span class="ident" id="1722376">v</span>&nbsp;<span class="ident" id="1722378">unsafe</span><span class="op" id="1722384">.</span><span class="ident" id="1722385">Pointer</span><span class="op" id="1722392">,</span>&nbsp;<span class="ident" id="1722394">flags</span>&nbsp;<span class="builtintype" id="1722400">uint</span><span class="op" id="1722404">)</span>&nbsp;<span class="builtintype" id="1722406">int</span>&nbsp;<span class="op" id="1722410">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722413">if</span>&nbsp;<span class="ident" id="1722416">goexitPC</span>&nbsp;<span class="op" id="1722425">==</span>&nbsp;<span class="num" id="1722428">0</span>&nbsp;<span class="op" id="1722430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722434">gothrow</span><span class="op" id="1722441">(</span><span class="string" id="1722442">&#34;gentraceback&nbsp;before&nbsp;goexitPC&nbsp;initialization&#34;</span><span class="op" id="1722487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1722490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722493">g</span>&nbsp;<span class="op" id="1722495">:=</span>&nbsp;<span class="ident" id="1722498">getg</span><span class="op" id="1722502">(</span><span class="op" id="1722503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722506">if</span>&nbsp;<span class="ident" id="1722509">g</span>&nbsp;<span class="op" id="1722511">==</span>&nbsp;<span class="ident" id="1722514">gp</span>&nbsp;<span class="op" id="1722517">&amp;&amp;</span>&nbsp;<span class="ident" id="1722520">g</span>&nbsp;<span class="op" id="1722522">==</span>&nbsp;<span class="ident" id="1722525">g</span><span class="op" id="1722526">.</span><span class="ident" id="1722527">m</span><span class="op" id="1722528">.</span><span class="ident" id="1722529">curg</span>&nbsp;<span class="op" id="1722534">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722538">//&nbsp;The&nbsp;starting&nbsp;sp&nbsp;has&nbsp;been&nbsp;passed&nbsp;in&nbsp;as&nbsp;a&nbsp;uintptr,&nbsp;and&nbsp;the&nbsp;caller&nbsp;may</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722611">//&nbsp;have&nbsp;other&nbsp;uintptr-typed&nbsp;stack&nbsp;references&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722667">//&nbsp;If&nbsp;during&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;that&nbsp;got&nbsp;us&nbsp;here&nbsp;or&nbsp;during&nbsp;one&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722737">//&nbsp;callbacks&nbsp;below&nbsp;the&nbsp;stack&nbsp;must&nbsp;be&nbsp;grown,&nbsp;all&nbsp;these&nbsp;uintptr&nbsp;references</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722812">//&nbsp;to&nbsp;the&nbsp;stack&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;and&nbsp;gentraceback&nbsp;will&nbsp;continue</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722882">//&nbsp;to&nbsp;inspect&nbsp;the&nbsp;old&nbsp;stack&nbsp;memory,&nbsp;which&nbsp;may&nbsp;no&nbsp;longer&nbsp;be&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722950">//&nbsp;Even&nbsp;if&nbsp;all&nbsp;the&nbsp;variables&nbsp;were&nbsp;updated&nbsp;correctly,&nbsp;it&nbsp;is&nbsp;not&nbsp;clear&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723026">//&nbsp;we&nbsp;want&nbsp;to&nbsp;expose&nbsp;a&nbsp;traceback&nbsp;that&nbsp;begins&nbsp;on&nbsp;one&nbsp;stack&nbsp;and&nbsp;ends</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723095">//&nbsp;on&nbsp;another&nbsp;stack.&nbsp;That&nbsp;could&nbsp;confuse&nbsp;callers&nbsp;quite&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723158">//&nbsp;Instead,&nbsp;we&nbsp;require&nbsp;that&nbsp;gentraceback&nbsp;and&nbsp;any&nbsp;other&nbsp;function&nbsp;that</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723229">//&nbsp;accepts&nbsp;an&nbsp;sp&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;(typically&nbsp;obtained&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723297">//&nbsp;calling&nbsp;getcallersp)&nbsp;must&nbsp;not&nbsp;run&nbsp;on&nbsp;that&nbsp;goroutine&#39;s&nbsp;stack&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723366">//&nbsp;instead&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723396">gothrow</span><span class="op" id="1723403">(</span><span class="string" id="1723404">&#34;gentraceback&nbsp;cannot&nbsp;trace&nbsp;user&nbsp;goroutine&nbsp;on&nbsp;its&nbsp;own&nbsp;stack&#34;</span><span class="op" id="1723463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723466">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723469">gotraceback</span>&nbsp;<span class="op" id="1723481">:=</span>&nbsp;<span class="ident" id="1723484">gotraceback</span><span class="op" id="1723495">(</span><span class="ident" id="1723496">nil</span><span class="op" id="1723499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723502">if</span>&nbsp;<span class="ident" id="1723505">pc0</span>&nbsp;<span class="op" id="1723509">==</span>&nbsp;<span class="op" id="1723512">^</span><span class="builtintype" id="1723513">uintptr</span><span class="op" id="1723520">(</span><span class="num" id="1723521">0</span><span class="op" id="1723522">)</span>&nbsp;<span class="op" id="1723524">&amp;&amp;</span>&nbsp;<span class="ident" id="1723527">sp0</span>&nbsp;<span class="op" id="1723531">==</span>&nbsp;<span class="op" id="1723534">^</span><span class="builtintype" id="1723535">uintptr</span><span class="op" id="1723542">(</span><span class="num" id="1723543">0</span><span class="op" id="1723544">)</span>&nbsp;<span class="op" id="1723546">{</span>&nbsp;<span class="comment" id="1723548">//&nbsp;Signal&nbsp;to&nbsp;fetch&nbsp;saved&nbsp;values&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723591">if</span>&nbsp;<span class="ident" id="1723594">gp</span><span class="op" id="1723596">.</span><span class="ident" id="1723597">syscallsp</span>&nbsp;<span class="op" id="1723607">!=</span>&nbsp;<span class="num" id="1723610">0</span>&nbsp;<span class="op" id="1723612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723617">pc0</span>&nbsp;<span class="op" id="1723621">=</span>&nbsp;<span class="ident" id="1723623">gp</span><span class="op" id="1723625">.</span><span class="ident" id="1723626">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723639">sp0</span>&nbsp;<span class="op" id="1723643">=</span>&nbsp;<span class="ident" id="1723645">gp</span><span class="op" id="1723647">.</span><span class="ident" id="1723648">syscallsp</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723661">if</span>&nbsp;<span class="ident" id="1723664">usesLR</span>&nbsp;<span class="op" id="1723671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723677">lr0</span>&nbsp;<span class="op" id="1723681">=</span>&nbsp;<span class="num" id="1723683">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723692">}</span>&nbsp;<span class="keyword" id="1723694">else</span>&nbsp;<span class="op" id="1723699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723704">pc0</span>&nbsp;<span class="op" id="1723708">=</span>&nbsp;<span class="ident" id="1723710">gp</span><span class="op" id="1723712">.</span><span class="ident" id="1723713">sched</span><span class="op" id="1723718">.</span><span class="ident" id="1723719">pc</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723725">sp0</span>&nbsp;<span class="op" id="1723729">=</span>&nbsp;<span class="ident" id="1723731">gp</span><span class="op" id="1723733">.</span><span class="ident" id="1723734">sched</span><span class="op" id="1723739">.</span><span class="ident" id="1723740">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723746">if</span>&nbsp;<span class="ident" id="1723749">usesLR</span>&nbsp;<span class="op" id="1723756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723762">lr0</span>&nbsp;<span class="op" id="1723766">=</span>&nbsp;<span class="ident" id="1723768">gp</span><span class="op" id="1723770">.</span><span class="ident" id="1723771">sched</span><span class="op" id="1723776">.</span><span class="ident" id="1723777">lr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723787">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723794">nprint</span>&nbsp;<span class="op" id="1723801">:=</span>&nbsp;<span class="num" id="1723804">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723807">var</span>&nbsp;<span class="ident" id="1723811">frame</span>&nbsp;<span class="ident" id="1723817">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723827">frame</span><span class="op" id="1723832">.</span><span class="ident" id="1723833">pc</span>&nbsp;<span class="op" id="1723836">=</span>&nbsp;<span class="ident" id="1723838">pc0</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723843">frame</span><span class="op" id="1723848">.</span><span class="ident" id="1723849">sp</span>&nbsp;<span class="op" id="1723852">=</span>&nbsp;<span class="ident" id="1723854">sp0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723859">if</span>&nbsp;<span class="ident" id="1723862">usesLR</span>&nbsp;<span class="op" id="1723869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723873">frame</span><span class="op" id="1723878">.</span><span class="ident" id="1723879">lr</span>&nbsp;<span class="op" id="1723882">=</span>&nbsp;<span class="ident" id="1723884">lr0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723892">waspanic</span>&nbsp;<span class="op" id="1723901">:=</span>&nbsp;<span class="builtintype" id="1723904">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723911">wasnewproc</span>&nbsp;<span class="op" id="1723922">:=</span>&nbsp;<span class="builtintype" id="1723925">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723932">printing</span>&nbsp;<span class="op" id="1723941">:=</span>&nbsp;<span class="ident" id="1723944">pcbuf</span>&nbsp;<span class="op" id="1723950">==</span>&nbsp;<span class="ident" id="1723953">nil</span>&nbsp;<span class="op" id="1723957">&amp;&amp;</span>&nbsp;<span class="ident" id="1723960">callback</span>&nbsp;<span class="op" id="1723969">==</span>&nbsp;<span class="ident" id="1723972">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723977">_defer</span>&nbsp;<span class="op" id="1723984">:=</span>&nbsp;<span class="ident" id="1723987">gp</span><span class="op" id="1723989">.</span><span class="ident" id="1723990">_defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723999">for</span>&nbsp;<span class="ident" id="1724003">_defer</span>&nbsp;<span class="op" id="1724010">!=</span>&nbsp;<span class="ident" id="1724013">nil</span>&nbsp;<span class="op" id="1724017">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1724020">uintptr</span><span class="op" id="1724027">(</span><span class="ident" id="1724028">_defer</span><span class="op" id="1724034">.</span><span class="ident" id="1724035">argp</span><span class="op" id="1724039">)</span>&nbsp;<span class="op" id="1724041">==</span>&nbsp;<span class="ident" id="1724044">_NoArgs</span>&nbsp;<span class="op" id="1724052">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724056">_defer</span>&nbsp;<span class="op" id="1724063">=</span>&nbsp;<span class="ident" id="1724065">_defer</span><span class="op" id="1724071">.</span><span class="ident" id="1724072">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724082">//&nbsp;If&nbsp;the&nbsp;PC&nbsp;is&nbsp;zero,&nbsp;it&#39;s&nbsp;likely&nbsp;a&nbsp;nil&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724138">//&nbsp;Start&nbsp;in&nbsp;the&nbsp;caller&#39;s&nbsp;frame.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724171">if</span>&nbsp;<span class="ident" id="1724174">frame</span><span class="op" id="1724179">.</span><span class="ident" id="1724180">pc</span>&nbsp;<span class="op" id="1724183">==</span>&nbsp;<span class="num" id="1724186">0</span>&nbsp;<span class="op" id="1724188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724192">if</span>&nbsp;<span class="ident" id="1724195">usesLR</span>&nbsp;<span class="op" id="1724202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724207">frame</span><span class="op" id="1724212">.</span><span class="ident" id="1724213">pc</span>&nbsp;<span class="op" id="1724216">=</span>&nbsp;<span class="op" id="1724218">*</span><span class="op" id="1724219">(</span><span class="op" id="1724220">*</span><span class="builtintype" id="1724221">uintptr</span><span class="op" id="1724228">)</span><span class="op" id="1724229">(</span><span class="ident" id="1724230">unsafe</span><span class="op" id="1724236">.</span><span class="ident" id="1724237">Pointer</span><span class="op" id="1724244">(</span><span class="ident" id="1724245">frame</span><span class="op" id="1724250">.</span><span class="ident" id="1724251">sp</span><span class="op" id="1724253">)</span><span class="op" id="1724254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724259">frame</span><span class="op" id="1724264">.</span><span class="ident" id="1724265">lr</span>&nbsp;<span class="op" id="1724268">=</span>&nbsp;<span class="num" id="1724270">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724274">}</span>&nbsp;<span class="keyword" id="1724276">else</span>&nbsp;<span class="op" id="1724281">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724286">frame</span><span class="op" id="1724291">.</span><span class="ident" id="1724292">pc</span>&nbsp;<span class="op" id="1724295">=</span>&nbsp;<span class="builtintype" id="1724297">uintptr</span><span class="op" id="1724304">(</span><span class="op" id="1724305">*</span><span class="op" id="1724306">(</span><span class="op" id="1724307">*</span><span class="ident" id="1724308">uintreg</span><span class="op" id="1724315">)</span><span class="op" id="1724316">(</span><span class="ident" id="1724317">unsafe</span><span class="op" id="1724323">.</span><span class="ident" id="1724324">Pointer</span><span class="op" id="1724331">(</span><span class="ident" id="1724332">frame</span><span class="op" id="1724337">.</span><span class="ident" id="1724338">sp</span><span class="op" id="1724340">)</span><span class="op" id="1724341">)</span><span class="op" id="1724342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724347">frame</span><span class="op" id="1724352">.</span><span class="ident" id="1724353">sp</span>&nbsp;<span class="op" id="1724356">+=</span>&nbsp;<span class="ident" id="1724359">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724376">f</span>&nbsp;<span class="op" id="1724378">:=</span>&nbsp;<span class="ident" id="1724381">findfunc</span><span class="op" id="1724389">(</span><span class="ident" id="1724390">frame</span><span class="op" id="1724395">.</span><span class="ident" id="1724396">pc</span><span class="op" id="1724398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724401">if</span>&nbsp;<span class="ident" id="1724404">f</span>&nbsp;<span class="op" id="1724406">==</span>&nbsp;<span class="ident" id="1724409">nil</span>&nbsp;<span class="op" id="1724413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724417">if</span>&nbsp;<span class="ident" id="1724420">callback</span>&nbsp;<span class="op" id="1724429">!=</span>&nbsp;<span class="ident" id="1724432">nil</span>&nbsp;<span class="op" id="1724436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1724441">print</span><span class="op" id="1724446">(</span><span class="string" id="1724447">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;&#34;</span><span class="op" id="1724469">,</span>&nbsp;<span class="ident" id="1724471">hex</span><span class="op" id="1724474">(</span><span class="ident" id="1724475">frame</span><span class="op" id="1724480">.</span><span class="ident" id="1724481">pc</span><span class="op" id="1724483">)</span><span class="op" id="1724484">,</span>&nbsp;<span class="string" id="1724486">&#34;\n&#34;</span><span class="op" id="1724490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724495">gothrow</span><span class="op" id="1724502">(</span><span class="string" id="1724503">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1724515">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724523">return</span>&nbsp;<span class="num" id="1724530">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724536">frame</span><span class="op" id="1724541">.</span><span class="ident" id="1724542">fn</span>&nbsp;<span class="op" id="1724545">=</span>&nbsp;<span class="ident" id="1724547">f</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724551">n</span>&nbsp;<span class="op" id="1724553">:=</span>&nbsp;<span class="num" id="1724556">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724559">for</span>&nbsp;<span class="ident" id="1724563">n</span>&nbsp;<span class="op" id="1724565">&lt;</span>&nbsp;<span class="ident" id="1724567">max</span>&nbsp;<span class="op" id="1724571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724575">//&nbsp;Typically:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724591">//&nbsp;&nbsp;&nbsp;&nbsppc&nbsp;is&nbsp;the&nbsp;PC&nbsp;of&nbsp;the&nbsp;running&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724634">//&nbsp;&nbsp;&nbsp;&nbspsp&nbsp;is&nbsp;the&nbsp;stack&nbsp;pointer&nbsp;at&nbsp;that&nbsp;program&nbsp;counter.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724688">//&nbsp;&nbsp;&nbsp;&nbspfp&nbsp;is&nbsp;the&nbsp;frame&nbsp;pointer&nbsp;(caller&#39;s&nbsp;stack&nbsp;pointer)&nbsp;at&nbsp;that&nbsp;program&nbsp;counter,&nbsp;or&nbsp;nil&nbsp;if&nbsp;unknown.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724786">//&nbsp;&nbsp;&nbsp;&nbspstk&nbsp;is&nbsp;the&nbsp;stack&nbsp;containing&nbsp;sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724823">//&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;caller&#39;s&nbsp;program&nbsp;counter&nbsp;is&nbsp;lr,&nbsp;unless&nbsp;lr&nbsp;is&nbsp;zero,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;is&nbsp;*(uintptr*)sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724918">f</span>&nbsp;<span class="op" id="1724920">=</span>&nbsp;<span class="ident" id="1724922">frame</span><span class="op" id="1724927">.</span><span class="ident" id="1724928">fn</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724934">//&nbsp;Found&nbsp;an&nbsp;actual&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724965">//&nbsp;Derive&nbsp;frame&nbsp;pointer&nbsp;and&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725010">if</span>&nbsp;<span class="ident" id="1725013">frame</span><span class="op" id="1725018">.</span><span class="ident" id="1725019">fp</span>&nbsp;<span class="op" id="1725022">==</span>&nbsp;<span class="num" id="1725025">0</span>&nbsp;<span class="op" id="1725027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725032">frame</span><span class="op" id="1725037">.</span><span class="ident" id="1725038">fp</span>&nbsp;<span class="op" id="1725041">=</span>&nbsp;<span class="ident" id="1725043">frame</span><span class="op" id="1725048">.</span><span class="ident" id="1725049">sp</span>&nbsp;<span class="op" id="1725052">+</span>&nbsp;<span class="builtintype" id="1725054">uintptr</span><span class="op" id="1725061">(</span><span class="ident" id="1725062">funcspdelta</span><span class="op" id="1725073">(</span><span class="ident" id="1725074">f</span><span class="op" id="1725075">,</span>&nbsp;<span class="ident" id="1725077">frame</span><span class="op" id="1725082">.</span><span class="ident" id="1725083">pc</span><span class="op" id="1725085">)</span><span class="op" id="1725086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725091">if</span>&nbsp;<span class="op" id="1725094">!</span><span class="ident" id="1725095">usesLR</span>&nbsp;<span class="op" id="1725102">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725108">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725187">frame</span><span class="op" id="1725192">.</span><span class="ident" id="1725193">fp</span>&nbsp;<span class="op" id="1725196">+=</span>&nbsp;<span class="ident" id="1725199">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725218">var</span>&nbsp;<span class="ident" id="1725222">flr</span>&nbsp;<span class="op" id="1725226">*</span><span class="ident" id="1725227">_func</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725235">if</span>&nbsp;<span class="ident" id="1725238">topofstack</span><span class="op" id="1725248">(</span><span class="ident" id="1725249">f</span><span class="op" id="1725250">)</span>&nbsp;<span class="op" id="1725252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725257">frame</span><span class="op" id="1725262">.</span><span class="ident" id="1725263">lr</span>&nbsp;<span class="op" id="1725266">=</span>&nbsp;<span class="num" id="1725268">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725273">flr</span>&nbsp;<span class="op" id="1725277">=</span>&nbsp;<span class="ident" id="1725279">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725285">}</span>&nbsp;<span class="keyword" id="1725287">else</span>&nbsp;<span class="keyword" id="1725292">if</span>&nbsp;<span class="ident" id="1725295">usesLR</span>&nbsp;<span class="op" id="1725302">&amp;&amp;</span>&nbsp;<span class="ident" id="1725305">f</span><span class="op" id="1725306">.</span><span class="ident" id="1725307">entry</span>&nbsp;<span class="op" id="1725313">==</span>&nbsp;<span class="ident" id="1725316">jmpdeferPC</span>&nbsp;<span class="op" id="1725327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725332">//&nbsp;jmpdefer&nbsp;modifies&nbsp;SP/LR/PC&nbsp;non-atomically.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725381">//&nbsp;If&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;arrives&nbsp;during&nbsp;jmpdefer,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725437">//&nbsp;the&nbsp;stack&nbsp;unwind&nbsp;may&nbsp;see&nbsp;a&nbsp;mismatched&nbsp;register&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725494">//&nbsp;and&nbsp;get&nbsp;confused.&nbsp;Stop&nbsp;if&nbsp;we&nbsp;see&nbsp;PC&nbsp;within&nbsp;jmpdefer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725552">//&nbsp;to&nbsp;avoid&nbsp;that&nbsp;confusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725583">//&nbsp;See&nbsp;golang.org/issue/8153.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725616">if</span>&nbsp;<span class="ident" id="1725619">callback</span>&nbsp;<span class="op" id="1725628">!=</span>&nbsp;<span class="ident" id="1725631">nil</span>&nbsp;<span class="op" id="1725635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725641">gothrow</span><span class="op" id="1725648">(</span><span class="string" id="1725649">&#34;traceback_arm:&nbsp;found&nbsp;jmpdefer&nbsp;when&nbsp;tracing&nbsp;with&nbsp;callback&#34;</span><span class="op" id="1725707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725717">frame</span><span class="op" id="1725722">.</span><span class="ident" id="1725723">lr</span>&nbsp;<span class="op" id="1725726">=</span>&nbsp;<span class="num" id="1725728">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725732">}</span>&nbsp;<span class="keyword" id="1725734">else</span>&nbsp;<span class="op" id="1725739">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725744">if</span>&nbsp;<span class="ident" id="1725747">usesLR</span>&nbsp;<span class="op" id="1725754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725760">if</span>&nbsp;<span class="ident" id="1725763">n</span>&nbsp;<span class="op" id="1725765">==</span>&nbsp;<span class="num" id="1725768">0</span>&nbsp;<span class="op" id="1725770">&amp;&amp;</span>&nbsp;<span class="ident" id="1725773">frame</span><span class="op" id="1725778">.</span><span class="ident" id="1725779">sp</span>&nbsp;<span class="op" id="1725782">&lt;</span>&nbsp;<span class="ident" id="1725784">frame</span><span class="op" id="1725789">.</span><span class="ident" id="1725790">fp</span>&nbsp;<span class="op" id="1725793">||</span>&nbsp;<span class="ident" id="1725796">frame</span><span class="op" id="1725801">.</span><span class="ident" id="1725802">lr</span>&nbsp;<span class="op" id="1725805">==</span>&nbsp;<span class="num" id="1725808">0</span>&nbsp;<span class="op" id="1725810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725817">frame</span><span class="op" id="1725822">.</span><span class="ident" id="1725823">lr</span>&nbsp;<span class="op" id="1725826">=</span>&nbsp;<span class="op" id="1725828">*</span><span class="op" id="1725829">(</span><span class="op" id="1725830">*</span><span class="builtintype" id="1725831">uintptr</span><span class="op" id="1725838">)</span><span class="op" id="1725839">(</span><span class="ident" id="1725840">unsafe</span><span class="op" id="1725846">.</span><span class="ident" id="1725847">Pointer</span><span class="op" id="1725854">(</span><span class="ident" id="1725855">frame</span><span class="op" id="1725860">.</span><span class="ident" id="1725861">sp</span><span class="op" id="1725863">)</span><span class="op" id="1725864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725875">}</span>&nbsp;<span class="keyword" id="1725877">else</span>&nbsp;<span class="op" id="1725882">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725888">if</span>&nbsp;<span class="ident" id="1725891">frame</span><span class="op" id="1725896">.</span><span class="ident" id="1725897">lr</span>&nbsp;<span class="op" id="1725900">==</span>&nbsp;<span class="num" id="1725903">0</span>&nbsp;<span class="op" id="1725905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725912">frame</span><span class="op" id="1725917">.</span><span class="ident" id="1725918">lr</span>&nbsp;<span class="op" id="1725921">=</span>&nbsp;<span class="builtintype" id="1725923">uintptr</span><span class="op" id="1725930">(</span><span class="op" id="1725931">*</span><span class="op" id="1725932">(</span><span class="op" id="1725933">*</span><span class="ident" id="1725934">uintreg</span><span class="op" id="1725941">)</span><span class="op" id="1725942">(</span><span class="ident" id="1725943">unsafe</span><span class="op" id="1725949">.</span><span class="ident" id="1725950">Pointer</span><span class="op" id="1725957">(</span><span class="ident" id="1725958">frame</span><span class="op" id="1725963">.</span><span class="ident" id="1725964">fp</span>&nbsp;<span class="op" id="1725967">-</span>&nbsp;<span class="ident" id="1725969">regSize</span><span class="op" id="1725976">)</span><span class="op" id="1725977">)</span><span class="op" id="1725978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725994">flr</span>&nbsp;<span class="op" id="1725998">=</span>&nbsp;<span class="ident" id="1726000">findfunc</span><span class="op" id="1726008">(</span><span class="ident" id="1726009">frame</span><span class="op" id="1726014">.</span><span class="ident" id="1726015">lr</span><span class="op" id="1726017">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726022">if</span>&nbsp;<span class="ident" id="1726025">flr</span>&nbsp;<span class="op" id="1726029">==</span>&nbsp;<span class="ident" id="1726032">nil</span>&nbsp;<span class="op" id="1726036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726042">//&nbsp;This&nbsp;happens&nbsp;if&nbsp;you&nbsp;get&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;at&nbsp;just&nbsp;the&nbsp;wrong&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726119">//&nbsp;In&nbsp;that&nbsp;context&nbsp;it&nbsp;is&nbsp;okay&nbsp;to&nbsp;stop&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726168">//&nbsp;But&nbsp;if&nbsp;callback&nbsp;is&nbsp;set,&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;and&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726241">//&nbsp;get&nbsp;everything,&nbsp;so&nbsp;crash&nbsp;loudly.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726281">if</span>&nbsp;<span class="ident" id="1726284">callback</span>&nbsp;<span class="op" id="1726293">!=</span>&nbsp;<span class="ident" id="1726296">nil</span>&nbsp;<span class="op" id="1726300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1726307">print</span><span class="op" id="1726312">(</span><span class="string" id="1726313">&#34;runtime:&nbsp;unexpected&nbsp;return&nbsp;pc&nbsp;for&nbsp;&#34;</span><span class="op" id="1726349">,</span>&nbsp;<span class="ident" id="1726351">gofuncname</span><span class="op" id="1726361">(</span><span class="ident" id="1726362">f</span><span class="op" id="1726363">)</span><span class="op" id="1726364">,</span>&nbsp;<span class="string" id="1726366">&#34;&nbsp;called&nbsp;from&nbsp;&#34;</span><span class="op" id="1726381">,</span>&nbsp;<span class="ident" id="1726383">hex</span><span class="op" id="1726386">(</span><span class="ident" id="1726387">frame</span><span class="op" id="1726392">.</span><span class="ident" id="1726393">lr</span><span class="op" id="1726395">)</span><span class="op" id="1726396">,</span>&nbsp;<span class="string" id="1726398">&#34;\n&#34;</span><span class="op" id="1726402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726409">gothrow</span><span class="op" id="1726416">(</span><span class="string" id="1726417">&#34;unknown&nbsp;caller&nbsp;pc&#34;</span><span class="op" id="1726436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726447">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726456">frame</span><span class="op" id="1726461">.</span><span class="ident" id="1726462">varp</span>&nbsp;<span class="op" id="1726467">=</span>&nbsp;<span class="ident" id="1726469">frame</span><span class="op" id="1726474">.</span><span class="ident" id="1726475">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726480">if</span>&nbsp;<span class="op" id="1726483">!</span><span class="ident" id="1726484">usesLR</span>&nbsp;<span class="op" id="1726491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726496">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726574">frame</span><span class="op" id="1726579">.</span><span class="ident" id="1726580">varp</span>&nbsp;<span class="op" id="1726585">-=</span>&nbsp;<span class="ident" id="1726588">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726603">//&nbsp;Derive&nbsp;size&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726634">//&nbsp;Most&nbsp;functions&nbsp;have&nbsp;a&nbsp;fixed-size&nbsp;argument&nbsp;block,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726688">//&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;metadata&nbsp;about&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726738">//&nbsp;Not&nbsp;all,&nbsp;though:&nbsp;there&nbsp;are&nbsp;some&nbsp;variadic&nbsp;functions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726794">//&nbsp;in&nbsp;package&nbsp;runtime&nbsp;and&nbsp;reflect,&nbsp;and&nbsp;for&nbsp;those&nbsp;we&nbsp;use&nbsp;call-specific</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726866">//&nbsp;metadata&nbsp;recorded&nbsp;by&nbsp;f&#39;s&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726904">if</span>&nbsp;<span class="ident" id="1726907">callback</span>&nbsp;<span class="op" id="1726916">!=</span>&nbsp;<span class="ident" id="1726919">nil</span>&nbsp;<span class="op" id="1726923">||</span>&nbsp;<span class="ident" id="1726926">printing</span>&nbsp;<span class="op" id="1726935">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726940">frame</span><span class="op" id="1726945">.</span><span class="ident" id="1726946">argp</span>&nbsp;<span class="op" id="1726951">=</span>&nbsp;<span class="ident" id="1726953">frame</span><span class="op" id="1726958">.</span><span class="ident" id="1726959">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726965">if</span>&nbsp;<span class="ident" id="1726968">usesLR</span>&nbsp;<span class="op" id="1726975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726981">frame</span><span class="op" id="1726986">.</span><span class="ident" id="1726987">argp</span>&nbsp;<span class="op" id="1726992">+=</span>&nbsp;<span class="ident" id="1726995">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1727006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727011">setArgInfo</span><span class="op" id="1727021">(</span><span class="op" id="1727022">&amp;</span><span class="ident" id="1727023">frame</span><span class="op" id="1727028">,</span>&nbsp;<span class="ident" id="1727030">f</span><span class="op" id="1727031">,</span>&nbsp;<span class="ident" id="1727033">callback</span>&nbsp;<span class="op" id="1727042">!=</span>&nbsp;<span class="ident" id="1727045">nil</span><span class="op" id="1727048">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1727052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727057">//&nbsp;Determine&nbsp;function&nbsp;SP&nbsp;where&nbsp;deferproc&nbsp;would&nbsp;find&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727126">var</span>&nbsp;<span class="ident" id="1727130">sparg</span>&nbsp;<span class="builtintype" id="1727136">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727146">if</span>&nbsp;<span class="ident" id="1727149">usesLR</span>&nbsp;<span class="op" id="1727156">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727161">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack&nbsp;plus&nbsp;1&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727247">//&nbsp;for&nbsp;the&nbsp;saved&nbsp;LR.&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727333">//&nbsp;however,&nbsp;the&nbsp;SP&nbsp;is&nbsp;three&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727389">//&nbsp;If&nbsp;the&nbsp;function&nbsp;has&nbsp;no&nbsp;frame&nbsp;at&nbsp;all&nbsp;-&nbsp;perhaps&nbsp;it&nbsp;just&nbsp;started,&nbsp;or&nbsp;perhaps</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727469">//&nbsp;it&nbsp;is&nbsp;a&nbsp;leaf&nbsp;with&nbsp;no&nbsp;local&nbsp;variables&nbsp;-&nbsp;then&nbsp;we&nbsp;cannot&nbsp;possibly&nbsp;find&nbsp;its</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727547">//&nbsp;SP&nbsp;in&nbsp;a&nbsp;defer,&nbsp;and&nbsp;we&nbsp;might&nbsp;confuse&nbsp;its&nbsp;SP&nbsp;for&nbsp;its&nbsp;caller&#39;s&nbsp;SP,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727620">//&nbsp;leave&nbsp;sparg=0&nbsp;in&nbsp;that&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727654">if</span>&nbsp;<span class="ident" id="1727657">frame</span><span class="op" id="1727662">.</span><span class="ident" id="1727663">fp</span>&nbsp;<span class="op" id="1727666">!=</span>&nbsp;<span class="ident" id="1727669">frame</span><span class="op" id="1727674">.</span><span class="ident" id="1727675">sp</span>&nbsp;<span class="op" id="1727678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727684">sparg</span>&nbsp;<span class="op" id="1727690">=</span>&nbsp;<span class="ident" id="1727692">frame</span><span class="op" id="1727697">.</span><span class="ident" id="1727698">sp</span>&nbsp;<span class="op" id="1727701">+</span>&nbsp;<span class="ident" id="1727703">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727715">if</span>&nbsp;<span class="ident" id="1727718">wasnewproc</span>&nbsp;<span class="op" id="1727729">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727736">sparg</span>&nbsp;<span class="op" id="1727742">+=</span>&nbsp;<span class="num" id="1727745">3</span>&nbsp;<span class="op" id="1727747">*</span>&nbsp;<span class="ident" id="1727749">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1727761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1727766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1727770">}</span>&nbsp;<span class="keyword" id="1727772">else</span>&nbsp;<span class="op" id="1727777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727782">//&nbsp;On&nbsp;x86&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack,&nbsp;so&nbsp;SP&nbsp;exactly.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727847">//&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,&nbsp;however,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727924">//&nbsp;the&nbsp;SP&nbsp;is&nbsp;two&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727969">sparg</span>&nbsp;<span class="op" id="1727975">=</span>&nbsp;<span class="ident" id="1727977">frame</span><span class="op" id="1727982">.</span><span class="ident" id="1727983">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727989">if</span>&nbsp;<span class="ident" id="1727992">wasnewproc</span>&nbsp;<span class="op" id="1728003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728009">sparg</span>&nbsp;<span class="op" id="1728015">+=</span>&nbsp;<span class="num" id="1728018">2</span>&nbsp;<span class="op" id="1728020">*</span>&nbsp;<span class="ident" id="1728022">ptrSize</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728042">//&nbsp;Determine&nbsp;frame&#39;s&nbsp;&#39;continuation&nbsp;PC&#39;,&nbsp;where&nbsp;it&nbsp;can&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728107">//&nbsp;Normally&nbsp;this&nbsp;is&nbsp;the&nbsp;return&nbsp;address&nbsp;on&nbsp;the&nbsp;stack,&nbsp;but&nbsp;if&nbsp;sigpanic</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728178">//&nbsp;is&nbsp;immediately&nbsp;below&nbsp;this&nbsp;function&nbsp;on&nbsp;the&nbsp;stack,&nbsp;then&nbsp;the&nbsp;frame</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728247">//&nbsp;stopped&nbsp;executing&nbsp;due&nbsp;to&nbsp;a&nbsp;trap,&nbsp;and&nbsp;frame.pc&nbsp;is&nbsp;probably&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728314">//&nbsp;a&nbsp;safe&nbsp;point&nbsp;for&nbsp;looking&nbsp;up&nbsp;liveness&nbsp;information.&nbsp;In&nbsp;this&nbsp;panicking&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728393">//&nbsp;the&nbsp;function&nbsp;either&nbsp;doesn&#39;t&nbsp;return&nbsp;at&nbsp;all&nbsp;(if&nbsp;it&nbsp;has&nbsp;no&nbsp;defers&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728471">//&nbsp;defers&nbsp;do&nbsp;not&nbsp;recover)&nbsp;or&nbsp;it&nbsp;returns&nbsp;from&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;to</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728538">//&nbsp;deferproc&nbsp;a&nbsp;second&nbsp;time&nbsp;(if&nbsp;the&nbsp;corresponding&nbsp;deferred&nbsp;func&nbsp;recovers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728614">//&nbsp;It&nbsp;suffices&nbsp;to&nbsp;assume&nbsp;that&nbsp;the&nbsp;most&nbsp;recent&nbsp;deferproc&nbsp;is&nbsp;the&nbsp;one&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728688">//&nbsp;returns;&nbsp;everything&nbsp;live&nbsp;at&nbsp;earlier&nbsp;deferprocs&nbsp;is&nbsp;still&nbsp;live&nbsp;at&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728767">frame</span><span class="op" id="1728772">.</span><span class="ident" id="1728773">continpc</span>&nbsp;<span class="op" id="1728782">=</span>&nbsp;<span class="ident" id="1728784">frame</span><span class="op" id="1728789">.</span><span class="ident" id="1728790">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728795">if</span>&nbsp;<span class="ident" id="1728798">waspanic</span>&nbsp;<span class="op" id="1728807">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728812">if</span>&nbsp;<span class="ident" id="1728815">_defer</span>&nbsp;<span class="op" id="1728822">!=</span>&nbsp;<span class="ident" id="1728825">nil</span>&nbsp;<span class="op" id="1728829">&amp;&amp;</span>&nbsp;<span class="ident" id="1728832">_defer</span><span class="op" id="1728838">.</span><span class="ident" id="1728839">argp</span>&nbsp;<span class="op" id="1728844">==</span>&nbsp;<span class="ident" id="1728847">sparg</span>&nbsp;<span class="op" id="1728853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728859">frame</span><span class="op" id="1728864">.</span><span class="ident" id="1728865">continpc</span>&nbsp;<span class="op" id="1728874">=</span>&nbsp;<span class="ident" id="1728876">_defer</span><span class="op" id="1728882">.</span><span class="ident" id="1728883">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728889">}</span>&nbsp;<span class="keyword" id="1728891">else</span>&nbsp;<span class="op" id="1728896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728902">frame</span><span class="op" id="1728907">.</span><span class="ident" id="1728908">continpc</span>&nbsp;<span class="op" id="1728917">=</span>&nbsp;<span class="num" id="1728919">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728924">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728933">//&nbsp;Unwind&nbsp;our&nbsp;local&nbsp;defer&nbsp;stack&nbsp;past&nbsp;this&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728984">for</span>&nbsp;<span class="ident" id="1728988">_defer</span>&nbsp;<span class="op" id="1728995">!=</span>&nbsp;<span class="ident" id="1728998">nil</span>&nbsp;<span class="op" id="1729002">&amp;&amp;</span>&nbsp;<span class="op" id="1729005">(</span><span class="ident" id="1729006">_defer</span><span class="op" id="1729012">.</span><span class="ident" id="1729013">argp</span>&nbsp;<span class="op" id="1729018">==</span>&nbsp;<span class="ident" id="1729021">sparg</span>&nbsp;<span class="op" id="1729027">||</span>&nbsp;<span class="ident" id="1729030">_defer</span><span class="op" id="1729036">.</span><span class="ident" id="1729037">argp</span>&nbsp;<span class="op" id="1729042">==</span>&nbsp;<span class="ident" id="1729045">_NoArgs</span><span class="op" id="1729052">)</span>&nbsp;<span class="op" id="1729054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729059">_defer</span>&nbsp;<span class="op" id="1729066">=</span>&nbsp;<span class="ident" id="1729068">_defer</span><span class="op" id="1729074">.</span><span class="ident" id="1729075">link</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729087">if</span>&nbsp;<span class="ident" id="1729090">skip</span>&nbsp;<span class="op" id="1729095">&gt;</span>&nbsp;<span class="num" id="1729097">0</span>&nbsp;<span class="op" id="1729099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729104">skip</span><span class="op" id="1729108">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729114">goto</span>&nbsp;<span class="ident" id="1729119">skipped</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729134">if</span>&nbsp;<span class="ident" id="1729137">pcbuf</span>&nbsp;<span class="op" id="1729143">!=</span>&nbsp;<span class="ident" id="1729146">nil</span>&nbsp;<span class="op" id="1729150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729155">(</span><span class="op" id="1729156">*</span><span class="op" id="1729157">[</span><span class="num" id="1729158">1</span>&nbsp;<span class="op" id="1729160">&lt;&lt;</span>&nbsp;<span class="num" id="1729163">20</span><span class="op" id="1729165">]</span><span class="builtintype" id="1729166">uintptr</span><span class="op" id="1729173">)</span><span class="op" id="1729174">(</span><span class="ident" id="1729175">unsafe</span><span class="op" id="1729181">.</span><span class="ident" id="1729182">Pointer</span><span class="op" id="1729189">(</span><span class="ident" id="1729190">pcbuf</span><span class="op" id="1729195">)</span><span class="op" id="1729196">)</span><span class="op" id="1729197">[</span><span class="ident" id="1729198">n</span><span class="op" id="1729199">]</span>&nbsp;<span class="op" id="1729201">=</span>&nbsp;<span class="ident" id="1729203">frame</span><span class="op" id="1729208">.</span><span class="ident" id="1729209">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729214">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729218">if</span>&nbsp;<span class="ident" id="1729221">callback</span>&nbsp;<span class="op" id="1729230">!=</span>&nbsp;<span class="ident" id="1729233">nil</span>&nbsp;<span class="op" id="1729237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729242">if</span>&nbsp;<span class="op" id="1729245">!</span><span class="ident" id="1729246">callback</span><span class="op" id="1729254">(</span><span class="op" id="1729255">(</span><span class="op" id="1729256">*</span><span class="ident" id="1729257">stkframe</span><span class="op" id="1729265">)</span><span class="op" id="1729266">(</span><span class="ident" id="1729267">noescape</span><span class="op" id="1729275">(</span><span class="ident" id="1729276">unsafe</span><span class="op" id="1729282">.</span><span class="ident" id="1729283">Pointer</span><span class="op" id="1729290">(</span><span class="op" id="1729291">&amp;</span><span class="ident" id="1729292">frame</span><span class="op" id="1729297">)</span><span class="op" id="1729298">)</span><span class="op" id="1729299">)</span><span class="op" id="1729300">,</span>&nbsp;<span class="ident" id="1729302">v</span><span class="op" id="1729303">)</span>&nbsp;<span class="op" id="1729305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729311">return</span>&nbsp;<span class="ident" id="1729318">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729327">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729331">if</span>&nbsp;<span class="ident" id="1729334">printing</span>&nbsp;<span class="op" id="1729343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729348">if</span>&nbsp;<span class="op" id="1729351">(</span><span class="ident" id="1729352">flags</span><span class="op" id="1729357">&amp;</span><span class="ident" id="1729358">_TraceRuntimeFrames</span><span class="op" id="1729377">)</span>&nbsp;<span class="op" id="1729379">!=</span>&nbsp;<span class="num" id="1729382">0</span>&nbsp;<span class="op" id="1729384">||</span>&nbsp;<span class="ident" id="1729387">showframe</span><span class="op" id="1729396">(</span><span class="ident" id="1729397">f</span><span class="op" id="1729398">,</span>&nbsp;<span class="ident" id="1729400">gp</span><span class="op" id="1729402">)</span>&nbsp;<span class="op" id="1729404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1729410">//&nbsp;Print&nbsp;during&nbsp;crash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1729437">//&nbsp;&nbsp;&nbsp;&nbspmain(0x1,&nbsp;0x2,&nbsp;0x3)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1729464">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp/home/rsc/go/src/runtime/x.go:23&nbsp;+0xf</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1729510">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729517">tracepc</span>&nbsp;<span class="op" id="1729525">:=</span>&nbsp;<span class="ident" id="1729528">frame</span><span class="op" id="1729533">.</span><span class="ident" id="1729534">pc</span>&nbsp;<span class="comment" id="1729537">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729586">if</span>&nbsp;<span class="op" id="1729589">(</span><span class="ident" id="1729590">n</span>&nbsp;<span class="op" id="1729592">&gt;</span>&nbsp;<span class="num" id="1729594">0</span>&nbsp;<span class="op" id="1729596">||</span>&nbsp;<span class="ident" id="1729599">flags</span><span class="op" id="1729604">&amp;</span><span class="ident" id="1729605">_TraceTrap</span>&nbsp;<span class="op" id="1729616">==</span>&nbsp;<span class="num" id="1729619">0</span><span class="op" id="1729620">)</span>&nbsp;<span class="op" id="1729622">&amp;&amp;</span>&nbsp;<span class="ident" id="1729625">frame</span><span class="op" id="1729630">.</span><span class="ident" id="1729631">pc</span>&nbsp;<span class="op" id="1729634">&gt;</span>&nbsp;<span class="ident" id="1729636">f</span><span class="op" id="1729637">.</span><span class="ident" id="1729638">entry</span>&nbsp;<span class="op" id="1729644">&amp;&amp;</span>&nbsp;<span class="op" id="1729647">!</span><span class="ident" id="1729648">waspanic</span>&nbsp;<span class="op" id="1729657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729664">tracepc</span><span class="op" id="1729671">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729678">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1729684">print</span><span class="op" id="1729689">(</span><span class="ident" id="1729690">gofuncname</span><span class="op" id="1729700">(</span><span class="ident" id="1729701">f</span><span class="op" id="1729702">)</span><span class="op" id="1729703">,</span>&nbsp;<span class="string" id="1729705">&#34;(&#34;</span><span class="op" id="1729708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729714">argp</span>&nbsp;<span class="op" id="1729719">:=</span>&nbsp;<span class="op" id="1729722">(</span><span class="op" id="1729723">*</span><span class="op" id="1729724">[</span><span class="num" id="1729725">100</span><span class="op" id="1729728">]</span><span class="builtintype" id="1729729">uintptr</span><span class="op" id="1729736">)</span><span class="op" id="1729737">(</span><span class="ident" id="1729738">unsafe</span><span class="op" id="1729744">.</span><span class="ident" id="1729745">Pointer</span><span class="op" id="1729752">(</span><span class="ident" id="1729753">frame</span><span class="op" id="1729758">.</span><span class="ident" id="1729759">argp</span><span class="op" id="1729763">)</span><span class="op" id="1729764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729770">for</span>&nbsp;<span class="ident" id="1729774">i</span>&nbsp;<span class="op" id="1729776">:=</span>&nbsp;<span class="builtintype" id="1729779">uintptr</span><span class="op" id="1729786">(</span><span class="num" id="1729787">0</span><span class="op" id="1729788">)</span><span class="op" id="1729789">;</span>&nbsp;<span class="ident" id="1729791">i</span>&nbsp;<span class="op" id="1729793">&lt;</span>&nbsp;<span class="ident" id="1729795">frame</span><span class="op" id="1729800">.</span><span class="ident" id="1729801">arglen</span><span class="op" id="1729807">/</span><span class="ident" id="1729808">ptrSize</span><span class="op" id="1729815">;</span>&nbsp;<span class="ident" id="1729817">i</span><span class="op" id="1729818">++</span>&nbsp;<span class="op" id="1729821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729828">if</span>&nbsp;<span class="ident" id="1729831">i</span>&nbsp;<span class="op" id="1729833">&gt;=</span>&nbsp;<span class="num" id="1729836">10</span>&nbsp;<span class="op" id="1729839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1729847">print</span><span class="op" id="1729852">(</span><span class="string" id="1729853">&#34;,&nbsp;...&#34;</span><span class="op" id="1729860">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729868">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729886">if</span>&nbsp;<span class="ident" id="1729889">i</span>&nbsp;<span class="op" id="1729891">!=</span>&nbsp;<span class="num" id="1729894">0</span>&nbsp;<span class="op" id="1729896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1729904">print</span><span class="op" id="1729909">(</span><span class="string" id="1729910">&#34;,&nbsp;&#34;</span><span class="op" id="1729914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729921">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1729928">print</span><span class="op" id="1729933">(</span><span class="ident" id="1729934">hex</span><span class="op" id="1729937">(</span><span class="ident" id="1729938">argp</span><span class="op" id="1729942">[</span><span class="ident" id="1729943">i</span><span class="op" id="1729944">]</span><span class="op" id="1729945">)</span><span class="op" id="1729946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1729958">print</span><span class="op" id="1729963">(</span><span class="string" id="1729964">&#34;)\n&#34;</span><span class="op" id="1729969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729975">var</span>&nbsp;<span class="ident" id="1729979">file</span>&nbsp;<span class="builtintype" id="1729984">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729995">line</span>&nbsp;<span class="op" id="1730000">:=</span>&nbsp;<span class="ident" id="1730003">funcline</span><span class="op" id="1730011">(</span><span class="ident" id="1730012">f</span><span class="op" id="1730013">,</span>&nbsp;<span class="ident" id="1730015">tracepc</span><span class="op" id="1730022">,</span>&nbsp;<span class="op" id="1730024">&amp;</span><span class="ident" id="1730025">file</span><span class="op" id="1730029">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1730035">print</span><span class="op" id="1730040">(</span><span class="string" id="1730041">&#34;\t&#34;</span><span class="op" id="1730045">,</span>&nbsp;<span class="ident" id="1730047">file</span><span class="op" id="1730051">,</span>&nbsp;<span class="string" id="1730053">&#34;:&#34;</span><span class="op" id="1730056">,</span>&nbsp;<span class="ident" id="1730058">line</span><span class="op" id="1730062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730068">if</span>&nbsp;<span class="ident" id="1730071">frame</span><span class="op" id="1730076">.</span><span class="ident" id="1730077">pc</span>&nbsp;<span class="op" id="1730080">&gt;</span>&nbsp;<span class="ident" id="1730082">f</span><span class="op" id="1730083">.</span><span class="ident" id="1730084">entry</span>&nbsp;<span class="op" id="1730090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1730097">print</span><span class="op" id="1730102">(</span><span class="string" id="1730103">&#34;&nbsp;+&#34;</span><span class="op" id="1730107">,</span>&nbsp;<span class="ident" id="1730109">hex</span><span class="op" id="1730112">(</span><span class="ident" id="1730113">frame</span><span class="op" id="1730118">.</span><span class="ident" id="1730119">pc</span><span class="op" id="1730121">-</span><span class="ident" id="1730122">f</span><span class="op" id="1730123">.</span><span class="ident" id="1730124">entry</span><span class="op" id="1730129">)</span><span class="op" id="1730130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730142">if</span>&nbsp;<span class="ident" id="1730145">g</span><span class="op" id="1730146">.</span><span class="ident" id="1730147">m</span><span class="op" id="1730148">.</span><span class="ident" id="1730149">throwing</span>&nbsp;<span class="op" id="1730158">&gt;</span>&nbsp;<span class="num" id="1730160">0</span>&nbsp;<span class="op" id="1730162">&amp;&amp;</span>&nbsp;<span class="ident" id="1730165">gp</span>&nbsp;<span class="op" id="1730168">==</span>&nbsp;<span class="ident" id="1730171">g</span><span class="op" id="1730172">.</span><span class="ident" id="1730173">m</span><span class="op" id="1730174">.</span><span class="ident" id="1730175">curg</span>&nbsp;<span class="op" id="1730180">||</span>&nbsp;<span class="ident" id="1730183">gotraceback</span>&nbsp;<span class="op" id="1730195">&gt;=</span>&nbsp;<span class="num" id="1730198">2</span>&nbsp;<span class="op" id="1730200">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1730207">print</span><span class="op" id="1730212">(</span><span class="string" id="1730213">&#34;&nbsp;fp=&#34;</span><span class="op" id="1730219">,</span>&nbsp;<span class="ident" id="1730221">hex</span><span class="op" id="1730224">(</span><span class="ident" id="1730225">frame</span><span class="op" id="1730230">.</span><span class="ident" id="1730231">fp</span><span class="op" id="1730233">)</span><span class="op" id="1730234">,</span>&nbsp;<span class="string" id="1730236">&#34;&nbsp;sp=&#34;</span><span class="op" id="1730242">,</span>&nbsp;<span class="ident" id="1730244">hex</span><span class="op" id="1730247">(</span><span class="ident" id="1730248">frame</span><span class="op" id="1730253">.</span><span class="ident" id="1730254">sp</span><span class="op" id="1730256">)</span><span class="op" id="1730257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1730269">print</span><span class="op" id="1730274">(</span><span class="string" id="1730275">&#34;\n&#34;</span><span class="op" id="1730279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730285">nprint</span><span class="op" id="1730291">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730297">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730305">n</span><span class="op" id="1730306">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730311">skipped</span><span class="op" id="1730318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730322">waspanic</span>&nbsp;<span class="op" id="1730331">=</span>&nbsp;<span class="ident" id="1730333">f</span><span class="op" id="1730334">.</span><span class="ident" id="1730335">entry</span>&nbsp;<span class="op" id="1730341">==</span>&nbsp;<span class="ident" id="1730344">sigpanicPC</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730357">wasnewproc</span>&nbsp;<span class="op" id="1730368">=</span>&nbsp;<span class="ident" id="1730370">f</span><span class="op" id="1730371">.</span><span class="ident" id="1730372">entry</span>&nbsp;<span class="op" id="1730378">==</span>&nbsp;<span class="ident" id="1730381">newprocPC</span>&nbsp;<span class="op" id="1730391">||</span>&nbsp;<span class="ident" id="1730394">f</span><span class="op" id="1730395">.</span><span class="ident" id="1730396">entry</span>&nbsp;<span class="op" id="1730402">==</span>&nbsp;<span class="ident" id="1730405">deferprocPC</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1730420">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;past&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730469">if</span>&nbsp;<span class="ident" id="1730472">flr</span>&nbsp;<span class="op" id="1730476">==</span>&nbsp;<span class="ident" id="1730479">nil</span>&nbsp;<span class="op" id="1730483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730488">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1730501">//&nbsp;Unwind&nbsp;to&nbsp;next&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730528">frame</span><span class="op" id="1730533">.</span><span class="ident" id="1730534">fn</span>&nbsp;<span class="op" id="1730537">=</span>&nbsp;<span class="ident" id="1730539">flr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730545">frame</span><span class="op" id="1730550">.</span><span class="ident" id="1730551">pc</span>&nbsp;<span class="op" id="1730554">=</span>&nbsp;<span class="ident" id="1730556">frame</span><span class="op" id="1730561">.</span><span class="ident" id="1730562">lr</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730567">frame</span><span class="op" id="1730572">.</span><span class="ident" id="1730573">lr</span>&nbsp;<span class="op" id="1730576">=</span>&nbsp;<span class="num" id="1730578">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730582">frame</span><span class="op" id="1730587">.</span><span class="ident" id="1730588">sp</span>&nbsp;<span class="op" id="1730591">=</span>&nbsp;<span class="ident" id="1730593">frame</span><span class="op" id="1730598">.</span><span class="ident" id="1730599">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730604">frame</span><span class="op" id="1730609">.</span><span class="ident" id="1730610">fp</span>&nbsp;<span class="op" id="1730613">=</span>&nbsp;<span class="num" id="1730615">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730619">frame</span><span class="op" id="1730624">.</span><span class="ident" id="1730625">argmap</span>&nbsp;<span class="op" id="1730632">=</span>&nbsp;<span class="ident" id="1730634">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1730641">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;sighandler&nbsp;saves&nbsp;the&nbsp;LR&nbsp;on&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1730711">//&nbsp;before&nbsp;faking&nbsp;a&nbsp;call&nbsp;to&nbsp;sigpanic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730750">if</span>&nbsp;<span class="ident" id="1730753">usesLR</span>&nbsp;<span class="op" id="1730760">&amp;&amp;</span>&nbsp;<span class="ident" id="1730763">waspanic</span>&nbsp;<span class="op" id="1730772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730777">x</span>&nbsp;<span class="op" id="1730779">:=</span>&nbsp;<span class="op" id="1730782">*</span><span class="op" id="1730783">(</span><span class="op" id="1730784">*</span><span class="builtintype" id="1730785">uintptr</span><span class="op" id="1730792">)</span><span class="op" id="1730793">(</span><span class="ident" id="1730794">unsafe</span><span class="op" id="1730800">.</span><span class="ident" id="1730801">Pointer</span><span class="op" id="1730808">(</span><span class="ident" id="1730809">frame</span><span class="op" id="1730814">.</span><span class="ident" id="1730815">sp</span><span class="op" id="1730817">)</span><span class="op" id="1730818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730823">frame</span><span class="op" id="1730828">.</span><span class="ident" id="1730829">sp</span>&nbsp;<span class="op" id="1730832">+=</span>&nbsp;<span class="ident" id="1730835">ptrSize</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730846">f</span>&nbsp;<span class="op" id="1730848">=</span>&nbsp;<span class="ident" id="1730850">findfunc</span><span class="op" id="1730858">(</span><span class="ident" id="1730859">frame</span><span class="op" id="1730864">.</span><span class="ident" id="1730865">pc</span><span class="op" id="1730867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730872">frame</span><span class="op" id="1730877">.</span><span class="ident" id="1730878">fn</span>&nbsp;<span class="op" id="1730881">=</span>&nbsp;<span class="ident" id="1730883">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730888">if</span>&nbsp;<span class="ident" id="1730891">f</span>&nbsp;<span class="op" id="1730893">==</span>&nbsp;<span class="ident" id="1730896">nil</span>&nbsp;<span class="op" id="1730900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730906">frame</span><span class="op" id="1730911">.</span><span class="ident" id="1730912">pc</span>&nbsp;<span class="op" id="1730915">=</span>&nbsp;<span class="ident" id="1730917">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730922">}</span>&nbsp;<span class="keyword" id="1730924">else</span>&nbsp;<span class="keyword" id="1730929">if</span>&nbsp;<span class="ident" id="1730932">f</span><span class="op" id="1730933">.</span><span class="ident" id="1730934">frame</span>&nbsp;<span class="op" id="1730940">==</span>&nbsp;<span class="num" id="1730943">0</span>&nbsp;<span class="op" id="1730945">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730951">frame</span><span class="op" id="1730956">.</span><span class="ident" id="1730957">lr</span>&nbsp;<span class="op" id="1730960">=</span>&nbsp;<span class="ident" id="1730962">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730978">if</span>&nbsp;<span class="ident" id="1730981">pcbuf</span>&nbsp;<span class="op" id="1730987">==</span>&nbsp;<span class="ident" id="1730990">nil</span>&nbsp;<span class="op" id="1730994">&amp;&amp;</span>&nbsp;<span class="ident" id="1730997">callback</span>&nbsp;<span class="op" id="1731006">==</span>&nbsp;<span class="ident" id="1731009">nil</span>&nbsp;<span class="op" id="1731013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731017">n</span>&nbsp;<span class="op" id="1731019">=</span>&nbsp;<span class="ident" id="1731021">nprint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1731029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731033">//&nbsp;If&nbsp;callback&nbsp;!=&nbsp;nil,&nbsp;we&#39;re&nbsp;being&nbsp;called&nbsp;to&nbsp;gather&nbsp;stack&nbsp;information&nbsp;during</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731111">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth.&nbsp;In&nbsp;that&nbsp;context,&nbsp;require&nbsp;that&nbsp;we&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731189">//&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;not,&nbsp;then&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;somewhere&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731266">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth&nbsp;may&nbsp;not&nbsp;have&nbsp;seen&nbsp;the&nbsp;correct&nbsp;picture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731343">//&nbsp;of&nbsp;the&nbsp;stack.&nbsp;Crash&nbsp;now&nbsp;instead&nbsp;of&nbsp;silently&nbsp;executing&nbsp;the&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731424">//&nbsp;or&nbsp;stack&nbsp;copy&nbsp;incorrectly&nbsp;and&nbsp;setting&nbsp;up&nbsp;for&nbsp;a&nbsp;mysterious&nbsp;crash&nbsp;later.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731499">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731503">//&nbsp;Note&nbsp;that&nbsp;panic&nbsp;!=&nbsp;nil&nbsp;is&nbsp;okay&nbsp;here:&nbsp;there&nbsp;can&nbsp;be&nbsp;leftover&nbsp;panics,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731574">//&nbsp;because&nbsp;the&nbsp;defers&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;do&nbsp;not&nbsp;nest&nbsp;in&nbsp;frame&nbsp;order&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731646">//&nbsp;they&nbsp;do&nbsp;on&nbsp;the&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;you&nbsp;have:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731691">//</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731695">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;1&nbsp;defers&nbsp;d1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731717">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;2&nbsp;defers&nbsp;d2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731739">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;3&nbsp;defers&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731761">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;4&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731780">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;4&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731822">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;5,&nbsp;running&nbsp;d3,&nbsp;defers&nbsp;d4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731857">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;5&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731876">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;5&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731918">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;6,&nbsp;running&nbsp;d4,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731960">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;6,&nbsp;running&nbsp;d2,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732002">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732006">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d4,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d4&nbsp;-&gt;&nbsp;d3,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732073">//&nbsp;is&nbsp;nested&nbsp;properly,&nbsp;and&nbsp;we&#39;ll&nbsp;treat&nbsp;frame&nbsp;3&nbsp;as&nbsp;resumable,&nbsp;because&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732146">//&nbsp;can&nbsp;find&nbsp;d3.&nbsp;(And&nbsp;in&nbsp;fact&nbsp;frame&nbsp;3&nbsp;is&nbsp;resumable.&nbsp;If&nbsp;d4&nbsp;recovers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732213">//&nbsp;and&nbsp;frame&nbsp;5&nbsp;continues&nbsp;running,&nbsp;d3,&nbsp;d3&nbsp;can&nbsp;recover&nbsp;and&nbsp;we&#39;ll</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732277">//&nbsp;resume&nbsp;execution&nbsp;in&nbsp;(returning&nbsp;from)&nbsp;frame&nbsp;3.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732328">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732332">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d2,&nbsp;however,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d2&nbsp;-&gt;&nbsp;d3,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732402">//&nbsp;which&nbsp;is&nbsp;inverted.&nbsp;The&nbsp;scan&nbsp;will&nbsp;match&nbsp;d2&nbsp;to&nbsp;frame&nbsp;2&nbsp;but&nbsp;having</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732470">//&nbsp;d2&nbsp;on&nbsp;the&nbsp;stack&nbsp;until&nbsp;then&nbsp;means&nbsp;it&nbsp;will&nbsp;not&nbsp;match&nbsp;d3&nbsp;to&nbsp;frame&nbsp;3.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732540">//&nbsp;This&nbsp;is&nbsp;okay:&nbsp;if&nbsp;we&#39;re&nbsp;running&nbsp;d2,&nbsp;then&nbsp;all&nbsp;the&nbsp;defers&nbsp;after&nbsp;d2&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732613">//&nbsp;completed&nbsp;and&nbsp;their&nbsp;corresponding&nbsp;frames&nbsp;are&nbsp;dead.&nbsp;Not&nbsp;finding&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732683">//&nbsp;for&nbsp;frame&nbsp;3&nbsp;means&nbsp;we&#39;ll&nbsp;set&nbsp;frame&nbsp;3&#39;s&nbsp;continpc&nbsp;==&nbsp;0,&nbsp;which&nbsp;is&nbsp;correct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732757">//&nbsp;(frame&nbsp;3&nbsp;is&nbsp;dead).&nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;walk&nbsp;the&nbsp;panic&nbsp;stack&nbsp;can&nbsp;thus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732828">//&nbsp;contain&nbsp;defers&nbsp;(d3&nbsp;in&nbsp;this&nbsp;case)&nbsp;for&nbsp;dead&nbsp;frames.&nbsp;The&nbsp;inversion&nbsp;here</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732901">//&nbsp;always&nbsp;indicates&nbsp;a&nbsp;dead&nbsp;frame,&nbsp;and&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;inversion&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1732975">//&nbsp;scan&nbsp;is&nbsp;to&nbsp;hide&nbsp;those&nbsp;dead&nbsp;frames,&nbsp;so&nbsp;the&nbsp;scan&nbsp;is&nbsp;still&nbsp;okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733041">//&nbsp;what&#39;s&nbsp;left&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;are&nbsp;exactly&nbsp;(and&nbsp;only)&nbsp;the&nbsp;dead&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733116">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733120">//&nbsp;We&nbsp;require&nbsp;callback&nbsp;!=&nbsp;nil&nbsp;here&nbsp;because&nbsp;only&nbsp;when&nbsp;callback&nbsp;!=&nbsp;nil</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733190">//&nbsp;do&nbsp;we&nbsp;know&nbsp;that&nbsp;gentraceback&nbsp;is&nbsp;being&nbsp;called&nbsp;in&nbsp;a&nbsp;&#34;must&nbsp;be&nbsp;correct&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733262">//&nbsp;context&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;&#34;best&nbsp;effort&#34;&nbsp;context.&nbsp;The&nbsp;tracebacks&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733333">//&nbsp;callbacks&nbsp;only&nbsp;happen&nbsp;when&nbsp;everything&nbsp;is&nbsp;stopped&nbsp;nicely.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733394">//&nbsp;At&nbsp;other&nbsp;times,&nbsp;such&nbsp;as&nbsp;when&nbsp;gathering&nbsp;a&nbsp;stack&nbsp;for&nbsp;a&nbsp;profiling&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733468">//&nbsp;or&nbsp;when&nbsp;printing&nbsp;a&nbsp;traceback&nbsp;during&nbsp;a&nbsp;crash,&nbsp;everything&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733539">//&nbsp;stopped&nbsp;nicely,&nbsp;and&nbsp;the&nbsp;stack&nbsp;walk&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;complete.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733607">//&nbsp;It&#39;s&nbsp;okay&nbsp;in&nbsp;those&nbsp;situations&nbsp;not&nbsp;to&nbsp;use&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1733679">//&nbsp;incomplete&nbsp;information&nbsp;then&nbsp;is&nbsp;still&nbsp;better&nbsp;than&nbsp;nothing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1733741">if</span>&nbsp;<span class="ident" id="1733744">callback</span>&nbsp;<span class="op" id="1733753">!=</span>&nbsp;<span class="ident" id="1733756">nil</span>&nbsp;<span class="op" id="1733760">&amp;&amp;</span>&nbsp;<span class="ident" id="1733763">n</span>&nbsp;<span class="op" id="1733765">&lt;</span>&nbsp;<span class="ident" id="1733767">max</span>&nbsp;<span class="op" id="1733771">&amp;&amp;</span>&nbsp;<span class="ident" id="1733774">_defer</span>&nbsp;<span class="op" id="1733781">!=</span>&nbsp;<span class="ident" id="1733784">nil</span>&nbsp;<span class="op" id="1733788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1733792">if</span>&nbsp;<span class="ident" id="1733795">_defer</span>&nbsp;<span class="op" id="1733802">!=</span>&nbsp;<span class="ident" id="1733805">nil</span>&nbsp;<span class="op" id="1733809">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1733814">print</span><span class="op" id="1733819">(</span><span class="string" id="1733820">&#34;runtime:&nbsp;g&#34;</span><span class="op" id="1733832">,</span>&nbsp;<span class="ident" id="1733834">gp</span><span class="op" id="1733836">.</span><span class="ident" id="1733837">goid</span><span class="op" id="1733841">,</span>&nbsp;<span class="string" id="1733843">&#34;:&nbsp;leftover&nbsp;defer&nbsp;argp=&#34;</span><span class="op" id="1733867">,</span>&nbsp;<span class="ident" id="1733869">hex</span><span class="op" id="1733872">(</span><span class="ident" id="1733873">_defer</span><span class="op" id="1733879">.</span><span class="ident" id="1733880">argp</span><span class="op" id="1733884">)</span><span class="op" id="1733885">,</span>&nbsp;<span class="string" id="1733887">&#34;&nbsp;pc=&#34;</span><span class="op" id="1733893">,</span>&nbsp;<span class="ident" id="1733895">hex</span><span class="op" id="1733898">(</span><span class="ident" id="1733899">_defer</span><span class="op" id="1733905">.</span><span class="ident" id="1733906">pc</span><span class="op" id="1733908">)</span><span class="op" id="1733909">,</span>&nbsp;<span class="string" id="1733911">&#34;\n&#34;</span><span class="op" id="1733915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1733919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1733923">for</span>&nbsp;<span class="ident" id="1733927">_defer</span>&nbsp;<span class="op" id="1733934">=</span>&nbsp;<span class="ident" id="1733936">gp</span><span class="op" id="1733938">.</span><span class="ident" id="1733939">_defer</span><span class="op" id="1733945">;</span>&nbsp;<span class="ident" id="1733947">_defer</span>&nbsp;<span class="op" id="1733954">!=</span>&nbsp;<span class="ident" id="1733957">nil</span><span class="op" id="1733960">;</span>&nbsp;<span class="ident" id="1733962">_defer</span>&nbsp;<span class="op" id="1733969">=</span>&nbsp;<span class="ident" id="1733971">_defer</span><span class="op" id="1733977">.</span><span class="ident" id="1733978">link</span>&nbsp;<span class="op" id="1733983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1733988">print</span><span class="op" id="1733993">(</span><span class="string" id="1733994">&#34;\tdefer&nbsp;&#34;</span><span class="op" id="1734004">,</span>&nbsp;<span class="ident" id="1734006">_defer</span><span class="op" id="1734012">,</span>&nbsp;<span class="string" id="1734014">&#34;&nbsp;argp=&#34;</span><span class="op" id="1734022">,</span>&nbsp;<span class="ident" id="1734024">hex</span><span class="op" id="1734027">(</span><span class="ident" id="1734028">_defer</span><span class="op" id="1734034">.</span><span class="ident" id="1734035">argp</span><span class="op" id="1734039">)</span><span class="op" id="1734040">,</span>&nbsp;<span class="string" id="1734042">&#34;&nbsp;pc=&#34;</span><span class="op" id="1734048">,</span>&nbsp;<span class="ident" id="1734050">hex</span><span class="op" id="1734053">(</span><span class="ident" id="1734054">_defer</span><span class="op" id="1734060">.</span><span class="ident" id="1734061">pc</span><span class="op" id="1734063">)</span><span class="op" id="1734064">,</span>&nbsp;<span class="string" id="1734066">&#34;\n&#34;</span><span class="op" id="1734070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1734074">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734078">gothrow</span><span class="op" id="1734085">(</span><span class="string" id="1734086">&#34;traceback&nbsp;has&nbsp;leftover&nbsp;defers&#34;</span><span class="op" id="1734117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1734120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734124">return</span>&nbsp;<span class="ident" id="1734131">n</span><br>
<span class="lineno"></span><span class="op" id="1734133">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1734136">func</span>&nbsp;<span class="ident" id="1734141">setArgInfo</span><span class="op" id="1734151">(</span><span class="ident" id="1734152">frame</span>&nbsp;<span class="op" id="1734158">*</span><span class="ident" id="1734159">stkframe</span><span class="op" id="1734167">,</span>&nbsp;<span class="ident" id="1734169">f</span>&nbsp;<span class="op" id="1734171">*</span><span class="ident" id="1734172">_func</span><span class="op" id="1734177">,</span>&nbsp;<span class="ident" id="1734179">needArgMap</span>&nbsp;<span class="builtintype" id="1734190">bool</span><span class="op" id="1734194">)</span>&nbsp;<span class="op" id="1734196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734199">frame</span><span class="op" id="1734204">.</span><span class="ident" id="1734205">arglen</span>&nbsp;<span class="op" id="1734212">=</span>&nbsp;<span class="builtintype" id="1734214">uintptr</span><span class="op" id="1734221">(</span><span class="ident" id="1734222">f</span><span class="op" id="1734223">.</span><span class="ident" id="1734224">args</span><span class="op" id="1734228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734231">if</span>&nbsp;<span class="ident" id="1734234">needArgMap</span>&nbsp;<span class="op" id="1734245">&amp;&amp;</span>&nbsp;<span class="ident" id="1734248">f</span><span class="op" id="1734249">.</span><span class="ident" id="1734250">args</span>&nbsp;<span class="op" id="1734255">==</span>&nbsp;<span class="ident" id="1734258">_ArgsSizeUnknown</span>&nbsp;<span class="op" id="1734275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1734279">//&nbsp;Extract&nbsp;argument&nbsp;bitmaps&nbsp;for&nbsp;reflect&nbsp;stubs&nbsp;from&nbsp;the&nbsp;calls&nbsp;they&nbsp;made&nbsp;to&nbsp;reflect.</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734364">switch</span>&nbsp;<span class="ident" id="1734371">gofuncname</span><span class="op" id="1734381">(</span><span class="ident" id="1734382">f</span><span class="op" id="1734383">)</span>&nbsp;<span class="op" id="1734385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734389">case</span>&nbsp;<span class="string" id="1734394">&#34;reflect.makeFuncStub&#34;</span><span class="op" id="1734416">,</span>&nbsp;<span class="string" id="1734418">&#34;reflect.methodValueCall&#34;</span><span class="op" id="1734443">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734448">arg0</span>&nbsp;<span class="op" id="1734453">:=</span>&nbsp;<span class="ident" id="1734456">frame</span><span class="op" id="1734461">.</span><span class="ident" id="1734462">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734468">if</span>&nbsp;<span class="ident" id="1734471">usesLR</span>&nbsp;<span class="op" id="1734478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734484">arg0</span>&nbsp;<span class="op" id="1734489">+=</span>&nbsp;<span class="ident" id="1734492">ptrSize</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1734503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734508">fn</span>&nbsp;<span class="op" id="1734511">:=</span>&nbsp;<span class="op" id="1734514">*</span><span class="op" id="1734515">(</span><span class="op" id="1734516">*</span><span class="op" id="1734517">*</span><span class="op" id="1734518">[</span><span class="num" id="1734519">2</span><span class="op" id="1734520">]</span><span class="builtintype" id="1734521">uintptr</span><span class="op" id="1734528">)</span><span class="op" id="1734529">(</span><span class="ident" id="1734530">unsafe</span><span class="op" id="1734536">.</span><span class="ident" id="1734537">Pointer</span><span class="op" id="1734544">(</span><span class="ident" id="1734545">arg0</span><span class="op" id="1734549">)</span><span class="op" id="1734550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734555">if</span>&nbsp;<span class="ident" id="1734558">fn</span><span class="op" id="1734560">[</span><span class="num" id="1734561">0</span><span class="op" id="1734562">]</span>&nbsp;<span class="op" id="1734564">!=</span>&nbsp;<span class="ident" id="1734567">f</span><span class="op" id="1734568">.</span><span class="ident" id="1734569">entry</span>&nbsp;<span class="op" id="1734575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1734581">print</span><span class="op" id="1734586">(</span><span class="string" id="1734587">&#34;runtime:&nbsp;confused&nbsp;by&nbsp;&#34;</span><span class="op" id="1734610">,</span>&nbsp;<span class="ident" id="1734612">gofuncname</span><span class="op" id="1734622">(</span><span class="ident" id="1734623">f</span><span class="op" id="1734624">)</span><span class="op" id="1734625">,</span>&nbsp;<span class="string" id="1734627">&#34;\n&#34;</span><span class="op" id="1734631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734637">gothrow</span><span class="op" id="1734644">(</span><span class="string" id="1734645">&#34;reflect&nbsp;mismatch&#34;</span><span class="op" id="1734663">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1734668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734673">bv</span>&nbsp;<span class="op" id="1734676">:=</span>&nbsp;<span class="op" id="1734679">(</span><span class="op" id="1734680">*</span><span class="ident" id="1734681">bitvector</span><span class="op" id="1734690">)</span><span class="op" id="1734691">(</span><span class="ident" id="1734692">unsafe</span><span class="op" id="1734698">.</span><span class="ident" id="1734699">Pointer</span><span class="op" id="1734706">(</span><span class="ident" id="1734707">fn</span><span class="op" id="1734709">[</span><span class="num" id="1734710">1</span><span class="op" id="1734711">]</span><span class="op" id="1734712">)</span><span class="op" id="1734713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734718">frame</span><span class="op" id="1734723">.</span><span class="ident" id="1734724">arglen</span>&nbsp;<span class="op" id="1734731">=</span>&nbsp;<span class="builtintype" id="1734733">uintptr</span><span class="op" id="1734740">(</span><span class="ident" id="1734741">bv</span><span class="op" id="1734743">.</span><span class="ident" id="1734744">n</span>&nbsp;<span class="op" id="1734746">/</span>&nbsp;<span class="num" id="1734748">2</span>&nbsp;<span class="op" id="1734750">*</span>&nbsp;<span class="ident" id="1734752">ptrSize</span><span class="op" id="1734759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734764">frame</span><span class="op" id="1734769">.</span><span class="ident" id="1734770">argmap</span>&nbsp;<span class="op" id="1734777">=</span>&nbsp;<span class="ident" id="1734779">bv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1734784">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1734787">}</span><br>
<span class="lineno"></span><span class="op" id="1734789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1734792">func</span>&nbsp;<span class="ident" id="1734797">printcreatedby</span><span class="op" id="1734811">(</span><span class="ident" id="1734812">gp</span>&nbsp;<span class="op" id="1734815">*</span><span class="ident" id="1734816">g</span><span class="op" id="1734817">)</span>&nbsp;<span class="op" id="1734819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1734822">//&nbsp;Show&nbsp;what&nbsp;created&nbsp;goroutine,&nbsp;except&nbsp;main&nbsp;goroutine&nbsp;(goid&nbsp;1).</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734887">pc</span>&nbsp;<span class="op" id="1734890">:=</span>&nbsp;<span class="ident" id="1734893">gp</span><span class="op" id="1734895">.</span><span class="ident" id="1734896">gopc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1734902">f</span>&nbsp;<span class="op" id="1734904">:=</span>&nbsp;<span class="ident" id="1734907">findfunc</span><span class="op" id="1734915">(</span><span class="ident" id="1734916">pc</span><span class="op" id="1734918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1734921">if</span>&nbsp;<span class="ident" id="1734924">f</span>&nbsp;<span class="op" id="1734926">!=</span>&nbsp;<span class="ident" id="1734929">nil</span>&nbsp;<span class="op" id="1734933">&amp;&amp;</span>&nbsp;<span class="ident" id="1734936">showframe</span><span class="op" id="1734945">(</span><span class="ident" id="1734946">f</span><span class="op" id="1734947">,</span>&nbsp;<span class="ident" id="1734949">gp</span><span class="op" id="1734951">)</span>&nbsp;<span class="op" id="1734953">&amp;&amp;</span>&nbsp;<span class="ident" id="1734956">gp</span><span class="op" id="1734958">.</span><span class="ident" id="1734959">goid</span>&nbsp;<span class="op" id="1734964">!=</span>&nbsp;<span class="num" id="1734967">1</span>&nbsp;<span class="op" id="1734969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1734973">print</span><span class="op" id="1734978">(</span><span class="string" id="1734979">&#34;created&nbsp;by&nbsp;&#34;</span><span class="op" id="1734992">,</span>&nbsp;<span class="ident" id="1734994">gofuncname</span><span class="op" id="1735004">(</span><span class="ident" id="1735005">f</span><span class="op" id="1735006">)</span><span class="op" id="1735007">,</span>&nbsp;<span class="string" id="1735009">&#34;\n&#34;</span><span class="op" id="1735013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1735017">tracepc</span>&nbsp;<span class="op" id="1735025">:=</span>&nbsp;<span class="ident" id="1735028">pc</span>&nbsp;<span class="comment" id="1735031">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1735078">if</span>&nbsp;<span class="ident" id="1735081">pc</span>&nbsp;<span class="op" id="1735084">&gt;</span>&nbsp;<span class="ident" id="1735086">f</span><span class="op" id="1735087">.</span><span class="ident" id="1735088">entry</span>&nbsp;<span class="op" id="1735094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1735099">tracepc</span>&nbsp;<span class="op" id="1735107">-=</span>&nbsp;<span class="ident" id="1735110">_PCQuantum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1735123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1735127">var</span>&nbsp;<span class="ident" id="1735131">file</span>&nbsp;<span class="builtintype" id="1735136">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1735145">line</span>&nbsp;<span class="op" id="1735150">:=</span>&nbsp;<span class="ident" id="1735153">funcline</span><span class="op" id="1735161">(</span><span class="ident" id="1735162">f</span><span class="op" id="1735163">,</span>&nbsp;<span class="ident" id="1735165">tracepc</span><span class="op" id="1735172">,</span>&nbsp;<span class="op" id="1735174">&amp;</span><span class="ident" id="1735175">file</span><span class="op" id="1735179">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1735183">print</span><span class="op" id="1735188">(</span><span class="string" id="1735189">&#34;\t&#34;</span><span class="op" id="1735193">,</span>&nbsp;<span class="ident" id="1735195">file</span><span class="op" id="1735199">,</span>&nbsp;<span class="string" id="1735201">&#34;:&#34;</span><span class="op" id="1735204">,</span>&nbsp;<span class="ident" id="1735206">line</span><span class="op" id="1735210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1735214">if</span>&nbsp;<span class="ident" id="1735217">pc</span>&nbsp;<span class="op" id="1735220">&gt;</span>&nbsp;<span class="ident" id="1735222">f</span><span class="op" id="1735223">.</span><span class="ident" id="1735224">entry</span>&nbsp;<span class="op" id="1735230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1735235">print</span><span class="op" id="1735240">(</span><span class="string" id="1735241">&#34;&nbsp;+&#34;</span><span class="op" id="1735245">,</span>&nbsp;<span class="ident" id="1735247">hex</span><span class="op" id="1735250">(</span><span class="ident" id="1735251">pc</span><span class="op" id="1735253">-</span><span class="ident" id="1735254">f</span><span class="op" id="1735255">.</span><span class="ident" id="1735256">entry</span><span class="op" id="1735261">)</span><span class="op" id="1735262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1735266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1735270">print</span><span class="op" id="1735275">(</span><span class="string" id="1735276">&#34;\n&#34;</span><span class="op" id="1735280">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1735283">}</span><br>
<span class="lineno"></span><span class="op" id="1735285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1735288">func</span>&nbsp;<span class="ident" id="1735293">traceback</span><span class="op" id="1735302">(</span><span class="ident" id="1735303">pc</span>&nbsp;<span class="builtintype" id="1735306">uintptr</span><span class="op" id="1735313">,</span>&nbsp;<span class="ident" id="1735315">sp</span>&nbsp;<span class="builtintype" id="1735318">uintptr</span><span class="op" id="1735325">,</span>&nbsp;<span class="ident" id="1735327">lr</span>&nbsp;<span class="builtintype" id="1735330">uintptr</span><span class="op" id="1735337">,</span>&nbsp;<span class="ident" id="1735339">gp</span>&nbsp;<span class="op" id="1735342">*</span><span class="ident" id="1735343">g</span><span class="op" id="1735344">)</span>&nbsp;<span class="op" id="1735346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1735349">traceback1</span><span class="op" id="1735359">(</span><span class="ident" id="1735360">pc</span><span class="op" id="1735362">,</span>&nbsp;<span class="ident" id="1735364">sp</span><span class="op" id="1735366">,</span>&nbsp;<span class="ident" id="1735368">lr</span><span class="op" id="1735370">,</span>&nbsp;<span class="ident" id="1735372">gp</span><span class="op" id="1735374">,</span>&nbsp;<span class="num" id="1735376">0</span><span class="op" id="1735377">)</span><br>
<span class="lineno">495</span><span class="op" id="1735379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1735382">//&nbsp;tracebacktrap&nbsp;is&nbsp;like&nbsp;traceback&nbsp;but&nbsp;expects&nbsp;that&nbsp;the&nbsp;PC&nbsp;and&nbsp;SP&nbsp;were&nbsp;obtained</span><br>
<span class="lineno"></span><span class="comment" id="1735462">//&nbsp;from&nbsp;a&nbsp;trap,&nbsp;not&nbsp;from&nbsp;gp-&gt;sched&nbsp;or&nbsp;gp-&gt;syscallpc/gp-&gt;syscallsp&nbsp;or&nbsp;getcallerpc/getcallersp.</span><br>
<span class="lineno"></span><span class="comment" id="1735556">//&nbsp;Because&nbsp;they&nbsp;are&nbsp;from&nbsp;a&nbsp;trap&nbsp;instead&nbsp;of&nbsp;from&nbsp;a&nbsp;saved&nbsp;pair,</span><br>
<span class="lineno">500</span><span class="comment" id="1735618">//&nbsp;the&nbsp;initial&nbsp;PC&nbsp;must&nbsp;not&nbsp;be&nbsp;rewound&nbsp;to&nbsp;the&nbsp;previous&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="1735685">//&nbsp;(All&nbsp;the&nbsp;saved&nbsp;pairs&nbsp;record&nbsp;a&nbsp;PC&nbsp;that&nbsp;is&nbsp;a&nbsp;return&nbsp;address,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="1735753">//&nbsp;rewind&nbsp;it&nbsp;into&nbsp;the&nbsp;CALL&nbsp;instruction.)</span><br>
<span class="lineno"></span><span class="keyword" id="1735794">func</span>&nbsp;<span class="ident" id="1735799">tracebacktrap</span><span class="op" id="1735812">(</span><span class="ident" id="1735813">pc</span>&nbsp;<span class="builtintype" id="1735816">uintptr</span><span class="op" id="1735823">,</span>&nbsp;<span class="ident" id="1735825">sp</span>&nbsp;<span class="builtintype" id="1735828">uintptr</span><span class="op" id="1735835">,</span>&nbsp;<span class="ident" id="1735837">lr</span>&nbsp;<span class="builtintype" id="1735840">uintptr</span><span class="op" id="1735847">,</span>&nbsp;<span class="ident" id="1735849">gp</span>&nbsp;<span class="op" id="1735852">*</span><span class="ident" id="1735853">g</span><span class="op" id="1735854">)</span>&nbsp;<span class="op" id="1735856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1735859">traceback1</span><span class="op" id="1735869">(</span><span class="ident" id="1735870">pc</span><span class="op" id="1735872">,</span>&nbsp;<span class="ident" id="1735874">sp</span><span class="op" id="1735876">,</span>&nbsp;<span class="ident" id="1735878">lr</span><span class="op" id="1735880">,</span>&nbsp;<span class="ident" id="1735882">gp</span><span class="op" id="1735884">,</span>&nbsp;<span class="ident" id="1735886">_TraceTrap</span><span class="op" id="1735896">)</span><br>
<span class="lineno">505</span><span class="op" id="1735898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1735901">func</span>&nbsp;<span class="ident" id="1735906">traceback1</span><span class="op" id="1735916">(</span><span class="ident" id="1735917">pc</span>&nbsp;<span class="builtintype" id="1735920">uintptr</span><span class="op" id="1735927">,</span>&nbsp;<span class="ident" id="1735929">sp</span>&nbsp;<span class="builtintype" id="1735932">uintptr</span><span class="op" id="1735939">,</span>&nbsp;<span class="ident" id="1735941">lr</span>&nbsp;<span class="builtintype" id="1735944">uintptr</span><span class="op" id="1735951">,</span>&nbsp;<span class="ident" id="1735953">gp</span>&nbsp;<span class="op" id="1735956">*</span><span class="ident" id="1735957">g</span><span class="op" id="1735958">,</span>&nbsp;<span class="ident" id="1735960">flags</span>&nbsp;<span class="builtintype" id="1735966">uint</span><span class="op" id="1735970">)</span>&nbsp;<span class="op" id="1735972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1735975">var</span>&nbsp;<span class="ident" id="1735979">n</span>&nbsp;<span class="builtintype" id="1735981">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1735986">if</span>&nbsp;<span class="ident" id="1735989">readgstatus</span><span class="op" id="1736000">(</span><span class="ident" id="1736001">gp</span><span class="op" id="1736003">)</span><span class="op" id="1736004">&amp;^</span><span class="ident" id="1736006">_Gscan</span>&nbsp;<span class="op" id="1736013">==</span>&nbsp;<span class="ident" id="1736016">_Gsyscall</span>&nbsp;<span class="op" id="1736026">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1736030">//&nbsp;Override&nbsp;registers&nbsp;if&nbsp;blocked&nbsp;in&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736081">pc</span>&nbsp;<span class="op" id="1736084">=</span>&nbsp;<span class="ident" id="1736086">gp</span><span class="op" id="1736088">.</span><span class="ident" id="1736089">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736101">sp</span>&nbsp;<span class="op" id="1736104">=</span>&nbsp;<span class="ident" id="1736106">gp</span><span class="op" id="1736108">.</span><span class="ident" id="1736109">syscallsp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736121">flags</span>&nbsp;<span class="op" id="1736127">&amp;^=</span>&nbsp;<span class="ident" id="1736131">_TraceTrap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1736143">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1736146">//&nbsp;Print&nbsp;traceback.&nbsp;By&nbsp;default,&nbsp;omits&nbsp;runtime&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1736201">//&nbsp;If&nbsp;that&nbsp;means&nbsp;we&nbsp;print&nbsp;nothing&nbsp;at&nbsp;all,&nbsp;repeat&nbsp;forcing&nbsp;all&nbsp;frames&nbsp;printed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736279">n</span>&nbsp;<span class="op" id="1736281">=</span>&nbsp;<span class="ident" id="1736283">gentraceback</span><span class="op" id="1736295">(</span><span class="ident" id="1736296">pc</span><span class="op" id="1736298">,</span>&nbsp;<span class="ident" id="1736300">sp</span><span class="op" id="1736302">,</span>&nbsp;<span class="ident" id="1736304">lr</span><span class="op" id="1736306">,</span>&nbsp;<span class="ident" id="1736308">gp</span><span class="op" id="1736310">,</span>&nbsp;<span class="num" id="1736312">0</span><span class="op" id="1736313">,</span>&nbsp;<span class="ident" id="1736315">nil</span><span class="op" id="1736318">,</span>&nbsp;<span class="ident" id="1736320">_TracebackMaxFrames</span><span class="op" id="1736339">,</span>&nbsp;<span class="ident" id="1736341">nil</span><span class="op" id="1736344">,</span>&nbsp;<span class="ident" id="1736346">nil</span><span class="op" id="1736349">,</span>&nbsp;<span class="ident" id="1736351">flags</span><span class="op" id="1736356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1736359">if</span>&nbsp;<span class="ident" id="1736362">n</span>&nbsp;<span class="op" id="1736364">==</span>&nbsp;<span class="num" id="1736367">0</span>&nbsp;<span class="op" id="1736369">&amp;&amp;</span>&nbsp;<span class="op" id="1736372">(</span><span class="ident" id="1736373">flags</span><span class="op" id="1736378">&amp;</span><span class="ident" id="1736379">_TraceRuntimeFrames</span><span class="op" id="1736398">)</span>&nbsp;<span class="op" id="1736400">==</span>&nbsp;<span class="num" id="1736403">0</span>&nbsp;<span class="op" id="1736405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736409">n</span>&nbsp;<span class="op" id="1736411">=</span>&nbsp;<span class="ident" id="1736413">gentraceback</span><span class="op" id="1736425">(</span><span class="ident" id="1736426">pc</span><span class="op" id="1736428">,</span>&nbsp;<span class="ident" id="1736430">sp</span><span class="op" id="1736432">,</span>&nbsp;<span class="ident" id="1736434">lr</span><span class="op" id="1736436">,</span>&nbsp;<span class="ident" id="1736438">gp</span><span class="op" id="1736440">,</span>&nbsp;<span class="num" id="1736442">0</span><span class="op" id="1736443">,</span>&nbsp;<span class="ident" id="1736445">nil</span><span class="op" id="1736448">,</span>&nbsp;<span class="ident" id="1736450">_TracebackMaxFrames</span><span class="op" id="1736469">,</span>&nbsp;<span class="ident" id="1736471">nil</span><span class="op" id="1736474">,</span>&nbsp;<span class="ident" id="1736476">nil</span><span class="op" id="1736479">,</span>&nbsp;<span class="ident" id="1736481">flags</span><span class="op" id="1736486">|</span><span class="ident" id="1736487">_TraceRuntimeFrames</span><span class="op" id="1736506">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1736509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1736512">if</span>&nbsp;<span class="ident" id="1736515">n</span>&nbsp;<span class="op" id="1736517">==</span>&nbsp;<span class="ident" id="1736520">_TracebackMaxFrames</span>&nbsp;<span class="op" id="1736540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1736544">print</span><span class="op" id="1736549">(</span><span class="string" id="1736550">&#34;...additional&nbsp;frames&nbsp;elided...\n&#34;</span><span class="op" id="1736584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1736587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736590">printcreatedby</span><span class="op" id="1736604">(</span><span class="ident" id="1736605">gp</span><span class="op" id="1736607">)</span><br>
<span class="lineno">525</span><span class="op" id="1736609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1736612">func</span>&nbsp;<span class="ident" id="1736617">callers</span><span class="op" id="1736624">(</span><span class="ident" id="1736625">skip</span>&nbsp;<span class="builtintype" id="1736630">int</span><span class="op" id="1736633">,</span>&nbsp;<span class="ident" id="1736635">pcbuf</span>&nbsp;<span class="op" id="1736641">*</span><span class="builtintype" id="1736642">uintptr</span><span class="op" id="1736649">,</span>&nbsp;<span class="ident" id="1736651">m</span>&nbsp;<span class="builtintype" id="1736653">int</span><span class="op" id="1736656">)</span>&nbsp;<span class="builtintype" id="1736658">int</span>&nbsp;<span class="op" id="1736662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736665">sp</span>&nbsp;<span class="op" id="1736668">:=</span>&nbsp;<span class="ident" id="1736671">getcallersp</span><span class="op" id="1736682">(</span><span class="ident" id="1736683">unsafe</span><span class="op" id="1736689">.</span><span class="ident" id="1736690">Pointer</span><span class="op" id="1736697">(</span><span class="op" id="1736698">&amp;</span><span class="ident" id="1736699">skip</span><span class="op" id="1736703">)</span><span class="op" id="1736704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736707">pc</span>&nbsp;<span class="op" id="1736710">:=</span>&nbsp;<span class="builtintype" id="1736713">uintptr</span><span class="op" id="1736720">(</span><span class="ident" id="1736721">getcallerpc</span><span class="op" id="1736732">(</span><span class="ident" id="1736733">unsafe</span><span class="op" id="1736739">.</span><span class="ident" id="1736740">Pointer</span><span class="op" id="1736747">(</span><span class="op" id="1736748">&amp;</span><span class="ident" id="1736749">skip</span><span class="op" id="1736753">)</span><span class="op" id="1736754">)</span><span class="op" id="1736755">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1736758">var</span>&nbsp;<span class="ident" id="1736762">n</span>&nbsp;<span class="builtintype" id="1736764">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736769">onM</span><span class="op" id="1736772">(</span><span class="keyword" id="1736773">func</span><span class="op" id="1736777">(</span><span class="op" id="1736778">)</span>&nbsp;<span class="op" id="1736780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1736784">n</span>&nbsp;<span class="op" id="1736786">=</span>&nbsp;<span class="ident" id="1736788">gentraceback</span><span class="op" id="1736800">(</span><span class="ident" id="1736801">pc</span><span class="op" id="1736803">,</span>&nbsp;<span class="ident" id="1736805">sp</span><span class="op" id="1736807">,</span>&nbsp;<span class="num" id="1736809">0</span><span class="op" id="1736810">,</span>&nbsp;<span class="ident" id="1736812">getg</span><span class="op" id="1736816">(</span><span class="op" id="1736817">)</span><span class="op" id="1736818">,</span>&nbsp;<span class="ident" id="1736820">skip</span><span class="op" id="1736824">,</span>&nbsp;<span class="ident" id="1736826">pcbuf</span><span class="op" id="1736831">,</span>&nbsp;<span class="ident" id="1736833">m</span><span class="op" id="1736834">,</span>&nbsp;<span class="ident" id="1736836">nil</span><span class="op" id="1736839">,</span>&nbsp;<span class="ident" id="1736841">nil</span><span class="op" id="1736844">,</span>&nbsp;<span class="num" id="1736846">0</span><span class="op" id="1736847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1736850">}</span><span class="op" id="1736851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1736854">return</span>&nbsp;<span class="ident" id="1736861">n</span><br>
<span class="lineno">535</span><span class="op" id="1736863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1736866">func</span>&nbsp;<span class="ident" id="1736871">gcallers</span><span class="op" id="1736879">(</span><span class="ident" id="1736880">gp</span>&nbsp;<span class="op" id="1736883">*</span><span class="ident" id="1736884">g</span><span class="op" id="1736885">,</span>&nbsp;<span class="ident" id="1736887">skip</span>&nbsp;<span class="builtintype" id="1736892">int</span><span class="op" id="1736895">,</span>&nbsp;<span class="ident" id="1736897">pcbuf</span>&nbsp;<span class="op" id="1736903">*</span><span class="builtintype" id="1736904">uintptr</span><span class="op" id="1736911">,</span>&nbsp;<span class="ident" id="1736913">m</span>&nbsp;<span class="builtintype" id="1736915">int</span><span class="op" id="1736918">)</span>&nbsp;<span class="builtintype" id="1736920">int</span>&nbsp;<span class="op" id="1736924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1736927">return</span>&nbsp;<span class="ident" id="1736934">gentraceback</span><span class="op" id="1736946">(</span><span class="op" id="1736947">^</span><span class="builtintype" id="1736948">uintptr</span><span class="op" id="1736955">(</span><span class="num" id="1736956">0</span><span class="op" id="1736957">)</span><span class="op" id="1736958">,</span>&nbsp;<span class="op" id="1736960">^</span><span class="builtintype" id="1736961">uintptr</span><span class="op" id="1736968">(</span><span class="num" id="1736969">0</span><span class="op" id="1736970">)</span><span class="op" id="1736971">,</span>&nbsp;<span class="num" id="1736973">0</span><span class="op" id="1736974">,</span>&nbsp;<span class="ident" id="1736976">gp</span><span class="op" id="1736978">,</span>&nbsp;<span class="ident" id="1736980">skip</span><span class="op" id="1736984">,</span>&nbsp;<span class="ident" id="1736986">pcbuf</span><span class="op" id="1736991">,</span>&nbsp;<span class="ident" id="1736993">m</span><span class="op" id="1736994">,</span>&nbsp;<span class="ident" id="1736996">nil</span><span class="op" id="1736999">,</span>&nbsp;<span class="ident" id="1737001">nil</span><span class="op" id="1737004">,</span>&nbsp;<span class="num" id="1737006">0</span><span class="op" id="1737007">)</span><br>
<span class="lineno"></span><span class="op" id="1737009">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="1737012">func</span>&nbsp;<span class="ident" id="1737017">showframe</span><span class="op" id="1737026">(</span><span class="ident" id="1737027">f</span>&nbsp;<span class="op" id="1737029">*</span><span class="ident" id="1737030">_func</span><span class="op" id="1737035">,</span>&nbsp;<span class="ident" id="1737037">gp</span>&nbsp;<span class="op" id="1737040">*</span><span class="ident" id="1737041">g</span><span class="op" id="1737042">)</span>&nbsp;<span class="builtintype" id="1737044">bool</span>&nbsp;<span class="op" id="1737049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737052">g</span>&nbsp;<span class="op" id="1737054">:=</span>&nbsp;<span class="ident" id="1737057">getg</span><span class="op" id="1737061">(</span><span class="op" id="1737062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737065">if</span>&nbsp;<span class="ident" id="1737068">g</span><span class="op" id="1737069">.</span><span class="ident" id="1737070">m</span><span class="op" id="1737071">.</span><span class="ident" id="1737072">throwing</span>&nbsp;<span class="op" id="1737081">&gt;</span>&nbsp;<span class="num" id="1737083">0</span>&nbsp;<span class="op" id="1737085">&amp;&amp;</span>&nbsp;<span class="ident" id="1737088">gp</span>&nbsp;<span class="op" id="1737091">!=</span>&nbsp;<span class="ident" id="1737094">nil</span>&nbsp;<span class="op" id="1737098">&amp;&amp;</span>&nbsp;<span class="op" id="1737101">(</span><span class="ident" id="1737102">gp</span>&nbsp;<span class="op" id="1737105">==</span>&nbsp;<span class="ident" id="1737108">g</span><span class="op" id="1737109">.</span><span class="ident" id="1737110">m</span><span class="op" id="1737111">.</span><span class="ident" id="1737112">curg</span>&nbsp;<span class="op" id="1737117">||</span>&nbsp;<span class="ident" id="1737120">gp</span>&nbsp;<span class="op" id="1737123">==</span>&nbsp;<span class="ident" id="1737126">g</span><span class="op" id="1737127">.</span><span class="ident" id="1737128">m</span><span class="op" id="1737129">.</span><span class="ident" id="1737130">caughtsig</span><span class="op" id="1737139">)</span>&nbsp;<span class="op" id="1737141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737145">return</span>&nbsp;<span class="builtintype" id="1737152">true</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1737158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737161">traceback</span>&nbsp;<span class="op" id="1737171">:=</span>&nbsp;<span class="ident" id="1737174">gotraceback</span><span class="op" id="1737185">(</span><span class="ident" id="1737186">nil</span><span class="op" id="1737189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737192">name</span>&nbsp;<span class="op" id="1737197">:=</span>&nbsp;<span class="ident" id="1737200">gostringnocopy</span><span class="op" id="1737214">(</span><span class="ident" id="1737215">funcname</span><span class="op" id="1737223">(</span><span class="ident" id="1737224">f</span><span class="op" id="1737225">)</span><span class="op" id="1737226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1737230">//&nbsp;Special&nbsp;case:&nbsp;always&nbsp;show&nbsp;runtime.panic&nbsp;frame,&nbsp;so&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1737296">//&nbsp;see&nbsp;where&nbsp;a&nbsp;panic&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1737358">//&nbsp;See&nbsp;golang.org/issue/5832.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737389">if</span>&nbsp;<span class="ident" id="1737392">name</span>&nbsp;<span class="op" id="1737397">==</span>&nbsp;<span class="string" id="1737400">&#34;runtime.panic&#34;</span>&nbsp;<span class="op" id="1737416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737420">return</span>&nbsp;<span class="builtintype" id="1737427">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1737433">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737437">return</span>&nbsp;<span class="ident" id="1737444">traceback</span>&nbsp;<span class="op" id="1737454">&gt;</span>&nbsp;<span class="num" id="1737456">1</span>&nbsp;<span class="op" id="1737458">||</span>&nbsp;<span class="ident" id="1737461">f</span>&nbsp;<span class="op" id="1737463">!=</span>&nbsp;<span class="ident" id="1737466">nil</span>&nbsp;<span class="op" id="1737470">&amp;&amp;</span>&nbsp;<span class="ident" id="1737473">contains</span><span class="op" id="1737481">(</span><span class="ident" id="1737482">name</span><span class="op" id="1737486">,</span>&nbsp;<span class="string" id="1737488">&#34;.&#34;</span><span class="op" id="1737491">)</span>&nbsp;<span class="op" id="1737493">&amp;&amp;</span>&nbsp;<span class="op" id="1737496">(</span><span class="op" id="1737497">!</span><span class="ident" id="1737498">hasprefix</span><span class="op" id="1737507">(</span><span class="ident" id="1737508">name</span><span class="op" id="1737512">,</span>&nbsp;<span class="string" id="1737514">&#34;runtime.&#34;</span><span class="op" id="1737524">)</span>&nbsp;<span class="op" id="1737526">||</span>&nbsp;<span class="ident" id="1737529">isExportedRuntime</span><span class="op" id="1737546">(</span><span class="ident" id="1737547">name</span><span class="op" id="1737551">)</span><span class="op" id="1737552">)</span><br>
<span class="lineno"></span><span class="op" id="1737554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1737557">//&nbsp;isExportedRuntime&nbsp;reports&nbsp;whether&nbsp;name&nbsp;is&nbsp;an&nbsp;exported&nbsp;runtime&nbsp;function.</span><br>
<span class="lineno">560</span><span class="comment" id="1737632">//&nbsp;It&nbsp;is&nbsp;only&nbsp;for&nbsp;runtime&nbsp;functions,&nbsp;so&nbsp;ASCII&nbsp;A-Z&nbsp;is&nbsp;fine.</span><br>
<span class="lineno"></span><span class="keyword" id="1737691">func</span>&nbsp;<span class="ident" id="1737696">isExportedRuntime</span><span class="op" id="1737713">(</span><span class="ident" id="1737714">name</span>&nbsp;<span class="builtintype" id="1737719">string</span><span class="op" id="1737725">)</span>&nbsp;<span class="builtintype" id="1737727">bool</span>&nbsp;<span class="op" id="1737732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737735">const</span>&nbsp;<span class="ident" id="1737741">n</span>&nbsp;<span class="op" id="1737743">=</span>&nbsp;<span class="builtinfunc" id="1737745">len</span><span class="op" id="1737748">(</span><span class="string" id="1737749">&#34;runtime.&#34;</span><span class="op" id="1737759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1737762">return</span>&nbsp;<span class="builtinfunc" id="1737769">len</span><span class="op" id="1737772">(</span><span class="ident" id="1737773">name</span><span class="op" id="1737777">)</span>&nbsp;<span class="op" id="1737779">&gt;</span>&nbsp;<span class="ident" id="1737781">n</span>&nbsp;<span class="op" id="1737783">&amp;&amp;</span>&nbsp;<span class="ident" id="1737786">name</span><span class="op" id="1737790">[</span><span class="op" id="1737791">:</span><span class="ident" id="1737792">n</span><span class="op" id="1737793">]</span>&nbsp;<span class="op" id="1737795">==</span>&nbsp;<span class="string" id="1737798">&#34;runtime.&#34;</span>&nbsp;<span class="op" id="1737809">&amp;&amp;</span>&nbsp;<span class="string" id="1737812">&#39;A&#39;</span>&nbsp;<span class="op" id="1737816">&lt;=</span>&nbsp;<span class="ident" id="1737819">name</span><span class="op" id="1737823">[</span><span class="ident" id="1737824">n</span><span class="op" id="1737825">]</span>&nbsp;<span class="op" id="1737827">&amp;&amp;</span>&nbsp;<span class="ident" id="1737830">name</span><span class="op" id="1737834">[</span><span class="ident" id="1737835">n</span><span class="op" id="1737836">]</span>&nbsp;<span class="op" id="1737838">&lt;=</span>&nbsp;<span class="string" id="1737841">&#39;Z&#39;</span><br>
<span class="lineno"></span><span class="op" id="1737845">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1737848">var</span>&nbsp;<span class="ident" id="1737852">gStatusStrings</span>&nbsp;<span class="op" id="1737867">=</span>&nbsp;<span class="op" id="1737869">[</span><span class="op" id="1737870">...</span><span class="op" id="1737873">]</span><span class="builtintype" id="1737874">string</span><span class="op" id="1737880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737883">_Gidle</span><span class="op" id="1737889">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1737896">&#34;idle&#34;</span><span class="op" id="1737902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737905">_Grunnable</span><span class="op" id="1737915">:</span>&nbsp;&nbsp;<span class="string" id="1737918">&#34;runnable&#34;</span><span class="op" id="1737928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737931">_Grunning</span><span class="op" id="1737940">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1737944">&#34;running&#34;</span><span class="op" id="1737953">,</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737956">_Gsyscall</span><span class="op" id="1737965">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1737969">&#34;syscall&#34;</span><span class="op" id="1737978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1737981">_Gwaiting</span><span class="op" id="1737990">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1737994">&#34;waiting&#34;</span><span class="op" id="1738003">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738006">_Gdead</span><span class="op" id="1738012">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1738019">&#34;dead&#34;</span><span class="op" id="1738025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738028">_Genqueue</span><span class="op" id="1738037">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1738041">&#34;enqueue&#34;</span><span class="op" id="1738050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738053">_Gcopystack</span><span class="op" id="1738064">:</span>&nbsp;<span class="string" id="1738066">&#34;copystack&#34;</span><span class="op" id="1738077">,</span><br>
<span class="lineno">575</span><span class="op" id="1738079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1738082">var</span>&nbsp;<span class="ident" id="1738086">gScanStatusStrings</span>&nbsp;<span class="op" id="1738105">=</span>&nbsp;<span class="op" id="1738107">[</span><span class="op" id="1738108">...</span><span class="op" id="1738111">]</span><span class="builtintype" id="1738112">string</span><span class="op" id="1738118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="1738121">0</span><span class="op" id="1738122">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1738133">&#34;scan&#34;</span><span class="op" id="1738139">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738142">_Grunnable</span><span class="op" id="1738152">:</span>&nbsp;<span class="string" id="1738154">&#34;scanrunnable&#34;</span><span class="op" id="1738168">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738171">_Grunning</span><span class="op" id="1738180">:</span>&nbsp;&nbsp;<span class="string" id="1738183">&#34;scanrunning&#34;</span><span class="op" id="1738196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738199">_Gsyscall</span><span class="op" id="1738208">:</span>&nbsp;&nbsp;<span class="string" id="1738211">&#34;scansyscall&#34;</span><span class="op" id="1738224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738227">_Gwaiting</span><span class="op" id="1738236">:</span>&nbsp;&nbsp;<span class="string" id="1738239">&#34;scanwaiting&#34;</span><span class="op" id="1738252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738255">_Gdead</span><span class="op" id="1738261">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1738267">&#34;scandead&#34;</span><span class="op" id="1738277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738280">_Genqueue</span><span class="op" id="1738289">:</span>&nbsp;&nbsp;<span class="string" id="1738292">&#34;scanenqueue&#34;</span><span class="op" id="1738305">,</span><br>
<span class="lineno">585</span><span class="op" id="1738307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1738310">func</span>&nbsp;<span class="ident" id="1738315">goroutineheader</span><span class="op" id="1738330">(</span><span class="ident" id="1738331">gp</span>&nbsp;<span class="op" id="1738334">*</span><span class="ident" id="1738335">g</span><span class="op" id="1738336">)</span>&nbsp;<span class="op" id="1738338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738341">gpstatus</span>&nbsp;<span class="op" id="1738350">:=</span>&nbsp;<span class="ident" id="1738353">readgstatus</span><span class="op" id="1738364">(</span><span class="ident" id="1738365">gp</span><span class="op" id="1738367">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1738371">//&nbsp;Basic&nbsp;string&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1738395">var</span>&nbsp;<span class="ident" id="1738399">status</span>&nbsp;<span class="builtintype" id="1738406">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1738414">if</span>&nbsp;<span class="num" id="1738417">0</span>&nbsp;<span class="op" id="1738419">&lt;=</span>&nbsp;<span class="ident" id="1738422">gpstatus</span>&nbsp;<span class="op" id="1738431">&amp;&amp;</span>&nbsp;<span class="ident" id="1738434">gpstatus</span>&nbsp;<span class="op" id="1738443">&lt;</span>&nbsp;<span class="builtintype" id="1738445">uint32</span><span class="op" id="1738451">(</span><span class="builtinfunc" id="1738452">len</span><span class="op" id="1738455">(</span><span class="ident" id="1738456">gStatusStrings</span><span class="op" id="1738470">)</span><span class="op" id="1738471">)</span>&nbsp;<span class="op" id="1738473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738477">status</span>&nbsp;<span class="op" id="1738484">=</span>&nbsp;<span class="ident" id="1738486">gStatusStrings</span><span class="op" id="1738500">[</span><span class="ident" id="1738501">gpstatus</span><span class="op" id="1738509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1738512">}</span>&nbsp;<span class="keyword" id="1738514">else</span>&nbsp;<span class="keyword" id="1738519">if</span>&nbsp;<span class="ident" id="1738522">gpstatus</span><span class="op" id="1738530">&amp;</span><span class="ident" id="1738531">_Gscan</span>&nbsp;<span class="op" id="1738538">!=</span>&nbsp;<span class="num" id="1738541">0</span>&nbsp;<span class="op" id="1738543">&amp;&amp;</span>&nbsp;<span class="num" id="1738546">0</span>&nbsp;<span class="op" id="1738548">&lt;=</span>&nbsp;<span class="ident" id="1738551">gpstatus</span><span class="op" id="1738559">&amp;^</span><span class="ident" id="1738561">_Gscan</span>&nbsp;<span class="op" id="1738568">&amp;&amp;</span>&nbsp;<span class="ident" id="1738571">gpstatus</span><span class="op" id="1738579">&amp;^</span><span class="ident" id="1738581">_Gscan</span>&nbsp;<span class="op" id="1738588">&lt;</span>&nbsp;<span class="builtintype" id="1738590">uint32</span><span class="op" id="1738596">(</span><span class="builtinfunc" id="1738597">len</span><span class="op" id="1738600">(</span><span class="ident" id="1738601">gStatusStrings</span><span class="op" id="1738615">)</span><span class="op" id="1738616">)</span>&nbsp;<span class="op" id="1738618">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738622">status</span>&nbsp;<span class="op" id="1738629">=</span>&nbsp;<span class="ident" id="1738631">gStatusStrings</span><span class="op" id="1738645">[</span><span class="ident" id="1738646">gpstatus</span><span class="op" id="1738654">&amp;^</span><span class="ident" id="1738656">_Gscan</span><span class="op" id="1738662">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1738665">}</span>&nbsp;<span class="keyword" id="1738667">else</span>&nbsp;<span class="op" id="1738672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738676">status</span>&nbsp;<span class="op" id="1738683">=</span>&nbsp;<span class="string" id="1738685">&#34;???&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1738692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1738696">//&nbsp;Override.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1738710">if</span>&nbsp;<span class="op" id="1738713">(</span><span class="ident" id="1738714">gpstatus</span>&nbsp;<span class="op" id="1738723">==</span>&nbsp;<span class="ident" id="1738726">_Gwaiting</span>&nbsp;<span class="op" id="1738736">||</span>&nbsp;<span class="ident" id="1738739">gpstatus</span>&nbsp;<span class="op" id="1738748">==</span>&nbsp;<span class="ident" id="1738751">_Gscanwaiting</span><span class="op" id="1738764">)</span>&nbsp;<span class="op" id="1738766">&amp;&amp;</span>&nbsp;<span class="ident" id="1738769">gp</span><span class="op" id="1738771">.</span><span class="ident" id="1738772">waitreason</span>&nbsp;<span class="op" id="1738783">!=</span>&nbsp;<span class="string" id="1738786">&#34;&#34;</span>&nbsp;<span class="op" id="1738789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738793">status</span>&nbsp;<span class="op" id="1738800">=</span>&nbsp;<span class="ident" id="1738802">gp</span><span class="op" id="1738804">.</span><span class="ident" id="1738805">waitreason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1738817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1738821">//&nbsp;approx&nbsp;time&nbsp;the&nbsp;G&nbsp;is&nbsp;blocked,&nbsp;in&nbsp;minutes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1738866">var</span>&nbsp;<span class="ident" id="1738870">waitfor</span>&nbsp;<span class="ident" id="1738878">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1738885">gpstatus</span>&nbsp;<span class="op" id="1738894">&amp;^=</span>&nbsp;<span class="ident" id="1738898">_Gscan</span>&nbsp;<span class="comment" id="1738905">//&nbsp;drop&nbsp;the&nbsp;scan&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1738927">if</span>&nbsp;<span class="op" id="1738930">(</span><span class="ident" id="1738931">gpstatus</span>&nbsp;<span class="op" id="1738940">==</span>&nbsp;<span class="ident" id="1738943">_Gwaiting</span>&nbsp;<span class="op" id="1738953">||</span>&nbsp;<span class="ident" id="1738956">gpstatus</span>&nbsp;<span class="op" id="1738965">==</span>&nbsp;<span class="ident" id="1738968">_Gsyscall</span><span class="op" id="1738977">)</span>&nbsp;<span class="op" id="1738979">&amp;&amp;</span>&nbsp;<span class="ident" id="1738982">gp</span><span class="op" id="1738984">.</span><span class="ident" id="1738985">waitsince</span>&nbsp;<span class="op" id="1738995">!=</span>&nbsp;<span class="num" id="1738998">0</span>&nbsp;<span class="op" id="1739000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739004">waitfor</span>&nbsp;<span class="op" id="1739012">=</span>&nbsp;<span class="op" id="1739014">(</span><span class="ident" id="1739015">nanotime</span><span class="op" id="1739023">(</span><span class="op" id="1739024">)</span>&nbsp;<span class="op" id="1739026">-</span>&nbsp;<span class="ident" id="1739028">gp</span><span class="op" id="1739030">.</span><span class="ident" id="1739031">waitsince</span><span class="op" id="1739040">)</span>&nbsp;<span class="op" id="1739042">/</span>&nbsp;<span class="num" id="1739044">60e9</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739053">print</span><span class="op" id="1739058">(</span><span class="string" id="1739059">&#34;goroutine&nbsp;&#34;</span><span class="op" id="1739071">,</span>&nbsp;<span class="ident" id="1739073">gp</span><span class="op" id="1739075">.</span><span class="ident" id="1739076">goid</span><span class="op" id="1739080">,</span>&nbsp;<span class="string" id="1739082">&#34;&nbsp;[&#34;</span><span class="op" id="1739086">,</span>&nbsp;<span class="ident" id="1739088">status</span><span class="op" id="1739094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739097">if</span>&nbsp;<span class="ident" id="1739100">waitfor</span>&nbsp;<span class="op" id="1739108">&gt;=</span>&nbsp;<span class="num" id="1739111">1</span>&nbsp;<span class="op" id="1739113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739117">print</span><span class="op" id="1739122">(</span><span class="string" id="1739123">&#34;,&nbsp;&#34;</span><span class="op" id="1739127">,</span>&nbsp;<span class="ident" id="1739129">waitfor</span><span class="op" id="1739136">,</span>&nbsp;<span class="string" id="1739138">&#34;&nbsp;minutes&#34;</span><span class="op" id="1739148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739151">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739154">if</span>&nbsp;<span class="ident" id="1739157">gp</span><span class="op" id="1739159">.</span><span class="ident" id="1739160">lockedm</span>&nbsp;<span class="op" id="1739168">!=</span>&nbsp;<span class="ident" id="1739171">nil</span>&nbsp;<span class="op" id="1739175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739179">print</span><span class="op" id="1739184">(</span><span class="string" id="1739185">&#34;,&nbsp;locked&nbsp;to&nbsp;thread&#34;</span><span class="op" id="1739205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739211">print</span><span class="op" id="1739216">(</span><span class="string" id="1739217">&#34;]:\n&#34;</span><span class="op" id="1739223">)</span><br>
<span class="lineno"></span><span class="op" id="1739225">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="1739228">func</span>&nbsp;<span class="ident" id="1739233">tracebackothers</span><span class="op" id="1739248">(</span><span class="ident" id="1739249">me</span>&nbsp;<span class="op" id="1739252">*</span><span class="ident" id="1739253">g</span><span class="op" id="1739254">)</span>&nbsp;<span class="op" id="1739256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739259">level</span>&nbsp;<span class="op" id="1739265">:=</span>&nbsp;<span class="ident" id="1739268">gotraceback</span><span class="op" id="1739279">(</span><span class="ident" id="1739280">nil</span><span class="op" id="1739283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1739287">//&nbsp;Show&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;first,&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739348">g</span>&nbsp;<span class="op" id="1739350">:=</span>&nbsp;<span class="ident" id="1739353">getg</span><span class="op" id="1739357">(</span><span class="op" id="1739358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739361">gp</span>&nbsp;<span class="op" id="1739364">:=</span>&nbsp;<span class="ident" id="1739367">g</span><span class="op" id="1739368">.</span><span class="ident" id="1739369">m</span><span class="op" id="1739370">.</span><span class="ident" id="1739371">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739377">if</span>&nbsp;<span class="ident" id="1739380">gp</span>&nbsp;<span class="op" id="1739383">!=</span>&nbsp;<span class="ident" id="1739386">nil</span>&nbsp;<span class="op" id="1739390">&amp;&amp;</span>&nbsp;<span class="ident" id="1739393">gp</span>&nbsp;<span class="op" id="1739396">!=</span>&nbsp;<span class="ident" id="1739399">me</span>&nbsp;<span class="op" id="1739402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739406">print</span><span class="op" id="1739411">(</span><span class="string" id="1739412">&#34;\n&#34;</span><span class="op" id="1739416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739420">goroutineheader</span><span class="op" id="1739435">(</span><span class="ident" id="1739436">gp</span><span class="op" id="1739438">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739442">traceback</span><span class="op" id="1739451">(</span><span class="op" id="1739452">^</span><span class="builtintype" id="1739453">uintptr</span><span class="op" id="1739460">(</span><span class="num" id="1739461">0</span><span class="op" id="1739462">)</span><span class="op" id="1739463">,</span>&nbsp;<span class="op" id="1739465">^</span><span class="builtintype" id="1739466">uintptr</span><span class="op" id="1739473">(</span><span class="num" id="1739474">0</span><span class="op" id="1739475">)</span><span class="op" id="1739476">,</span>&nbsp;<span class="num" id="1739478">0</span><span class="op" id="1739479">,</span>&nbsp;<span class="ident" id="1739481">gp</span><span class="op" id="1739483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739490">lock</span><span class="op" id="1739494">(</span><span class="op" id="1739495">&amp;</span><span class="ident" id="1739496">allglock</span><span class="op" id="1739504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739507">for</span>&nbsp;<span class="ident" id="1739511">_</span><span class="op" id="1739512">,</span>&nbsp;<span class="ident" id="1739514">gp</span>&nbsp;<span class="op" id="1739517">:=</span>&nbsp;<span class="keyword" id="1739520">range</span>&nbsp;<span class="ident" id="1739526">allgs</span>&nbsp;<span class="op" id="1739532">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739536">if</span>&nbsp;<span class="ident" id="1739539">gp</span>&nbsp;<span class="op" id="1739542">==</span>&nbsp;<span class="ident" id="1739545">me</span>&nbsp;<span class="op" id="1739548">||</span>&nbsp;<span class="ident" id="1739551">gp</span>&nbsp;<span class="op" id="1739554">==</span>&nbsp;<span class="ident" id="1739557">g</span><span class="op" id="1739558">.</span><span class="ident" id="1739559">m</span><span class="op" id="1739560">.</span><span class="ident" id="1739561">curg</span>&nbsp;<span class="op" id="1739566">||</span>&nbsp;<span class="ident" id="1739569">readgstatus</span><span class="op" id="1739580">(</span><span class="ident" id="1739581">gp</span><span class="op" id="1739583">)</span>&nbsp;<span class="op" id="1739585">==</span>&nbsp;<span class="ident" id="1739588">_Gdead</span>&nbsp;<span class="op" id="1739595">||</span>&nbsp;<span class="ident" id="1739598">gp</span><span class="op" id="1739600">.</span><span class="ident" id="1739601">issystem</span>&nbsp;<span class="op" id="1739610">&amp;&amp;</span>&nbsp;<span class="ident" id="1739613">level</span>&nbsp;<span class="op" id="1739619">&lt;</span>&nbsp;<span class="num" id="1739621">2</span>&nbsp;<span class="op" id="1739623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739643">print</span><span class="op" id="1739648">(</span><span class="string" id="1739649">&#34;\n&#34;</span><span class="op" id="1739653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739657">goroutineheader</span><span class="op" id="1739672">(</span><span class="ident" id="1739673">gp</span><span class="op" id="1739675">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739679">if</span>&nbsp;<span class="ident" id="1739682">readgstatus</span><span class="op" id="1739693">(</span><span class="ident" id="1739694">gp</span><span class="op" id="1739696">)</span><span class="op" id="1739697">&amp;^</span><span class="ident" id="1739699">_Gscan</span>&nbsp;<span class="op" id="1739706">==</span>&nbsp;<span class="ident" id="1739709">_Grunning</span>&nbsp;<span class="op" id="1739719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1739724">print</span><span class="op" id="1739729">(</span><span class="string" id="1739730">&#34;\tgoroutine&nbsp;running&nbsp;on&nbsp;other&nbsp;thread;&nbsp;stack&nbsp;unavailable\n&#34;</span><span class="op" id="1739788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739793">printcreatedby</span><span class="op" id="1739807">(</span><span class="ident" id="1739808">gp</span><span class="op" id="1739810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739814">}</span>&nbsp;<span class="keyword" id="1739816">else</span>&nbsp;<span class="op" id="1739821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739826">traceback</span><span class="op" id="1739835">(</span><span class="op" id="1739836">^</span><span class="builtintype" id="1739837">uintptr</span><span class="op" id="1739844">(</span><span class="num" id="1739845">0</span><span class="op" id="1739846">)</span><span class="op" id="1739847">,</span>&nbsp;<span class="op" id="1739849">^</span><span class="builtintype" id="1739850">uintptr</span><span class="op" id="1739857">(</span><span class="num" id="1739858">0</span><span class="op" id="1739859">)</span><span class="op" id="1739860">,</span>&nbsp;<span class="num" id="1739862">0</span><span class="op" id="1739863">,</span>&nbsp;<span class="ident" id="1739865">gp</span><span class="op" id="1739867">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1739874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739877">unlock</span><span class="op" id="1739883">(</span><span class="op" id="1739884">&amp;</span><span class="ident" id="1739885">allglock</span><span class="op" id="1739893">)</span><br>
<span class="lineno"></span><span class="op" id="1739895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="1739898">//&nbsp;Does&nbsp;f&nbsp;mark&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;goroutine&nbsp;stack?</span><br>
<span class="lineno"></span><span class="keyword" id="1739943">func</span>&nbsp;<span class="ident" id="1739948">topofstack</span><span class="op" id="1739958">(</span><span class="ident" id="1739959">f</span>&nbsp;<span class="op" id="1739961">*</span><span class="ident" id="1739962">_func</span><span class="op" id="1739967">)</span>&nbsp;<span class="builtintype" id="1739969">bool</span>&nbsp;<span class="op" id="1739974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1739977">pc</span>&nbsp;<span class="op" id="1739980">:=</span>&nbsp;<span class="ident" id="1739983">f</span><span class="op" id="1739984">.</span><span class="ident" id="1739985">entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1739992">return</span>&nbsp;<span class="ident" id="1739999">pc</span>&nbsp;<span class="op" id="1740002">==</span>&nbsp;<span class="ident" id="1740005">goexitPC</span>&nbsp;<span class="op" id="1740014">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1740019">pc</span>&nbsp;<span class="op" id="1740022">==</span>&nbsp;<span class="ident" id="1740025">mstartPC</span>&nbsp;<span class="op" id="1740034">||</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1740039">pc</span>&nbsp;<span class="op" id="1740042">==</span>&nbsp;<span class="ident" id="1740045">mcallPC</span>&nbsp;<span class="op" id="1740053">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1740058">pc</span>&nbsp;<span class="op" id="1740061">==</span>&nbsp;<span class="ident" id="1740064">morestackPC</span>&nbsp;<span class="op" id="1740076">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1740081">pc</span>&nbsp;<span class="op" id="1740084">==</span>&nbsp;<span class="ident" id="1740087">rt0_goPC</span>&nbsp;<span class="op" id="1740096">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1740101">externalthreadhandlerp</span>&nbsp;<span class="op" id="1740124">!=</span>&nbsp;<span class="num" id="1740127">0</span>&nbsp;<span class="op" id="1740129">&amp;&amp;</span>&nbsp;<span class="ident" id="1740132">pc</span>&nbsp;<span class="op" id="1740135">==</span>&nbsp;<span class="ident" id="1740138">externalthreadhandlerp</span><br>
<span class="lineno"></span><span class="op" id="1740161">}</span>
</div>
</body>
</html>
