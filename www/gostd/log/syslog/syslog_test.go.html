<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html" class="current">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7877732">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7877787">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7877841">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7877892">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7877925">package</span>&nbsp;<span class="ident" id="7877933">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7877941">import</span>&nbsp;<span class="op" id="7877948">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7877951">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7877960">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7877967">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7877973">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7877986">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7877993">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7878000">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7878006">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7878014">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7878025">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7878032">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7878035">func</span>&nbsp;<span class="ident" id="7878040">runPktSyslog</span><span class="op" id="7878052">(</span><span class="ident" id="7878053">c</span>&nbsp;<span class="ident" id="7878055">net</span><span class="op" id="7878058">.</span><span class="ident" id="7878059">PacketConn</span><span class="op" id="7878069">,</span>&nbsp;<span class="ident" id="7878071">done</span>&nbsp;<span class="keyword" id="7878076">chan</span><span class="op" id="7878080">&lt;-</span>&nbsp;<span class="builtintype" id="7878083">string</span><span class="op" id="7878089">)</span>&nbsp;<span class="op" id="7878091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878094">var</span>&nbsp;<span class="ident" id="7878098">buf</span>&nbsp;<span class="op" id="7878102">[</span><span class="num" id="7878103">4096</span><span class="op" id="7878107">]</span><span class="builtintype" id="7878108">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878114">var</span>&nbsp;<span class="ident" id="7878118">rcvd</span>&nbsp;<span class="builtintype" id="7878123">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878131">ct</span>&nbsp;<span class="op" id="7878134">:=</span>&nbsp;<span class="num" id="7878137">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878140">for</span>&nbsp;<span class="op" id="7878144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878148">var</span>&nbsp;<span class="ident" id="7878152">n</span>&nbsp;<span class="builtintype" id="7878154">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878160">var</span>&nbsp;<span class="ident" id="7878164">err</span>&nbsp;<span class="builtintype" id="7878168">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878177">c</span><span class="op" id="7878178">.</span><span class="ident" id="7878179">SetReadDeadline</span><span class="op" id="7878194">(</span><span class="ident" id="7878195">time</span><span class="op" id="7878199">.</span><span class="ident" id="7878200">Now</span><span class="op" id="7878203">(</span><span class="op" id="7878204">)</span><span class="op" id="7878205">.</span><span class="ident" id="7878206">Add</span><span class="op" id="7878209">(</span><span class="num" id="7878210">100</span>&nbsp;<span class="op" id="7878214">*</span>&nbsp;<span class="ident" id="7878216">time</span><span class="op" id="7878220">.</span><span class="ident" id="7878221">Millisecond</span><span class="op" id="7878232">)</span><span class="op" id="7878233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878237">n</span><span class="op" id="7878238">,</span>&nbsp;<span class="ident" id="7878240">_</span><span class="op" id="7878241">,</span>&nbsp;<span class="ident" id="7878243">err</span>&nbsp;<span class="op" id="7878247">=</span>&nbsp;<span class="ident" id="7878249">c</span><span class="op" id="7878250">.</span><span class="ident" id="7878251">ReadFrom</span><span class="op" id="7878259">(</span><span class="ident" id="7878260">buf</span><span class="op" id="7878263">[</span><span class="op" id="7878264">:</span><span class="op" id="7878265">]</span><span class="op" id="7878266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878270">rcvd</span>&nbsp;<span class="op" id="7878275">+=</span>&nbsp;<span class="builtintype" id="7878278">string</span><span class="op" id="7878284">(</span><span class="ident" id="7878285">buf</span><span class="op" id="7878288">[</span><span class="op" id="7878289">:</span><span class="ident" id="7878290">n</span><span class="op" id="7878291">]</span><span class="op" id="7878292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878296">if</span>&nbsp;<span class="ident" id="7878299">err</span>&nbsp;<span class="op" id="7878303">!=</span>&nbsp;<span class="ident" id="7878306">nil</span>&nbsp;<span class="op" id="7878310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878315">if</span>&nbsp;<span class="ident" id="7878318">oe</span><span class="op" id="7878320">,</span>&nbsp;<span class="ident" id="7878322">ok</span>&nbsp;<span class="op" id="7878325">:=</span>&nbsp;<span class="ident" id="7878328">err</span><span class="op" id="7878331">.</span><span class="op" id="7878332">(</span><span class="op" id="7878333">*</span><span class="ident" id="7878334">net</span><span class="op" id="7878337">.</span><span class="ident" id="7878338">OpError</span><span class="op" id="7878345">)</span><span class="op" id="7878346">;</span>&nbsp;<span class="ident" id="7878348">ok</span>&nbsp;<span class="op" id="7878351">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878357">if</span>&nbsp;<span class="ident" id="7878360">ct</span>&nbsp;<span class="op" id="7878363">&lt;</span>&nbsp;<span class="num" id="7878365">3</span>&nbsp;<span class="op" id="7878367">&amp;&amp;</span>&nbsp;<span class="ident" id="7878370">oe</span><span class="op" id="7878372">.</span><span class="ident" id="7878373">Temporary</span><span class="op" id="7878382">(</span><span class="op" id="7878383">)</span>&nbsp;<span class="op" id="7878385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878392">ct</span><span class="op" id="7878394">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878402">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878420">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878425">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878439">c</span><span class="op" id="7878440">.</span><span class="ident" id="7878441">Close</span><span class="op" id="7878446">(</span><span class="op" id="7878447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878450">done</span>&nbsp;<span class="op" id="7878455">&lt;-</span>&nbsp;<span class="ident" id="7878458">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7878463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7878466">var</span>&nbsp;<span class="ident" id="7878470">crashy</span>&nbsp;<span class="op" id="7878477">=</span>&nbsp;<span class="builtintype" id="7878479">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7878486">func</span>&nbsp;<span class="ident" id="7878491">runStreamSyslog</span><span class="op" id="7878506">(</span><span class="ident" id="7878507">l</span>&nbsp;<span class="ident" id="7878509">net</span><span class="op" id="7878512">.</span><span class="ident" id="7878513">Listener</span><span class="op" id="7878521">,</span>&nbsp;<span class="ident" id="7878523">done</span>&nbsp;<span class="keyword" id="7878528">chan</span><span class="op" id="7878532">&lt;-</span>&nbsp;<span class="builtintype" id="7878535">string</span><span class="op" id="7878541">,</span>&nbsp;<span class="ident" id="7878543">wg</span>&nbsp;<span class="op" id="7878546">*</span><span class="ident" id="7878547">sync</span><span class="op" id="7878551">.</span><span class="ident" id="7878552">WaitGroup</span><span class="op" id="7878561">)</span>&nbsp;<span class="op" id="7878563">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878566">for</span>&nbsp;<span class="op" id="7878570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878574">var</span>&nbsp;<span class="ident" id="7878578">c</span>&nbsp;<span class="ident" id="7878580">net</span><span class="op" id="7878583">.</span><span class="ident" id="7878584">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878591">var</span>&nbsp;<span class="ident" id="7878595">err</span>&nbsp;<span class="builtintype" id="7878599">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878607">if</span>&nbsp;<span class="ident" id="7878610">c</span><span class="op" id="7878611">,</span>&nbsp;<span class="ident" id="7878613">err</span>&nbsp;<span class="op" id="7878617">=</span>&nbsp;<span class="ident" id="7878619">l</span><span class="op" id="7878620">.</span><span class="ident" id="7878621">Accept</span><span class="op" id="7878627">(</span><span class="op" id="7878628">)</span><span class="op" id="7878629">;</span>&nbsp;<span class="ident" id="7878631">err</span>&nbsp;<span class="op" id="7878635">!=</span>&nbsp;<span class="ident" id="7878638">nil</span>&nbsp;<span class="op" id="7878642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878647">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878660">wg</span><span class="op" id="7878662">.</span><span class="ident" id="7878663">Add</span><span class="op" id="7878666">(</span><span class="num" id="7878667">1</span><span class="op" id="7878668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878672">go</span>&nbsp;<span class="keyword" id="7878675">func</span><span class="op" id="7878679">(</span><span class="ident" id="7878680">c</span>&nbsp;<span class="ident" id="7878682">net</span><span class="op" id="7878685">.</span><span class="ident" id="7878686">Conn</span><span class="op" id="7878690">)</span>&nbsp;<span class="op" id="7878692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878697">defer</span>&nbsp;<span class="ident" id="7878703">wg</span><span class="op" id="7878705">.</span><span class="ident" id="7878706">Done</span><span class="op" id="7878710">(</span><span class="op" id="7878711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878716">c</span><span class="op" id="7878717">.</span><span class="ident" id="7878718">SetReadDeadline</span><span class="op" id="7878733">(</span><span class="ident" id="7878734">time</span><span class="op" id="7878738">.</span><span class="ident" id="7878739">Now</span><span class="op" id="7878742">(</span><span class="op" id="7878743">)</span><span class="op" id="7878744">.</span><span class="ident" id="7878745">Add</span><span class="op" id="7878748">(</span><span class="num" id="7878749">5</span>&nbsp;<span class="op" id="7878751">*</span>&nbsp;<span class="ident" id="7878753">time</span><span class="op" id="7878757">.</span><span class="ident" id="7878758">Second</span><span class="op" id="7878764">)</span><span class="op" id="7878765">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878770">b</span>&nbsp;<span class="op" id="7878772">:=</span>&nbsp;<span class="ident" id="7878775">bufio</span><span class="op" id="7878780">.</span><span class="ident" id="7878781">NewReader</span><span class="op" id="7878790">(</span><span class="ident" id="7878791">c</span><span class="op" id="7878792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878797">for</span>&nbsp;<span class="ident" id="7878801">ct</span>&nbsp;<span class="op" id="7878804">:=</span>&nbsp;<span class="num" id="7878807">1</span><span class="op" id="7878808">;</span>&nbsp;<span class="op" id="7878810">!</span><span class="ident" id="7878811">crashy</span>&nbsp;<span class="op" id="7878818">||</span>&nbsp;<span class="ident" id="7878821">ct</span><span class="op" id="7878823">&amp;</span><span class="num" id="7878824">7</span>&nbsp;<span class="op" id="7878826">!=</span>&nbsp;<span class="num" id="7878829">0</span><span class="op" id="7878830">;</span>&nbsp;<span class="ident" id="7878832">ct</span><span class="op" id="7878834">++</span>&nbsp;<span class="op" id="7878837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878843">s</span><span class="op" id="7878844">,</span>&nbsp;<span class="ident" id="7878846">err</span>&nbsp;<span class="op" id="7878850">:=</span>&nbsp;<span class="ident" id="7878853">b</span><span class="op" id="7878854">.</span><span class="ident" id="7878855">ReadString</span><span class="op" id="7878865">(</span><span class="string" id="7878866">&#39;\n&#39;</span><span class="op" id="7878870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878876">if</span>&nbsp;<span class="ident" id="7878879">err</span>&nbsp;<span class="op" id="7878883">!=</span>&nbsp;<span class="ident" id="7878886">nil</span>&nbsp;<span class="op" id="7878890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7878897">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878913">done</span>&nbsp;<span class="op" id="7878918">&lt;-</span>&nbsp;<span class="ident" id="7878921">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7878931">c</span><span class="op" id="7878932">.</span><span class="ident" id="7878933">Close</span><span class="op" id="7878938">(</span><span class="op" id="7878939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878943">}</span><span class="op" id="7878944">(</span><span class="ident" id="7878945">c</span><span class="op" id="7878946">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7878949">}</span><br>
<span class="lineno"></span><span class="op" id="7878951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7878954">func</span>&nbsp;<span class="ident" id="7878959">startServer</span><span class="op" id="7878970">(</span><span class="ident" id="7878971">n</span><span class="op" id="7878972">,</span>&nbsp;<span class="ident" id="7878974">la</span>&nbsp;<span class="builtintype" id="7878977">string</span><span class="op" id="7878983">,</span>&nbsp;<span class="ident" id="7878985">done</span>&nbsp;<span class="keyword" id="7878990">chan</span><span class="op" id="7878994">&lt;-</span>&nbsp;<span class="builtintype" id="7878997">string</span><span class="op" id="7879003">)</span>&nbsp;<span class="op" id="7879005">(</span><span class="ident" id="7879006">addr</span>&nbsp;<span class="builtintype" id="7879011">string</span><span class="op" id="7879017">,</span>&nbsp;<span class="ident" id="7879019">sock</span>&nbsp;<span class="ident" id="7879024">io</span><span class="op" id="7879026">.</span><span class="ident" id="7879027">Closer</span><span class="op" id="7879033">,</span>&nbsp;<span class="ident" id="7879035">wg</span>&nbsp;<span class="op" id="7879038">*</span><span class="ident" id="7879039">sync</span><span class="op" id="7879043">.</span><span class="ident" id="7879044">WaitGroup</span><span class="op" id="7879053">)</span>&nbsp;<span class="op" id="7879055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879058">if</span>&nbsp;<span class="ident" id="7879061">n</span>&nbsp;<span class="op" id="7879063">==</span>&nbsp;<span class="string" id="7879066">&#34;udp&#34;</span>&nbsp;<span class="op" id="7879072">||</span>&nbsp;<span class="ident" id="7879075">n</span>&nbsp;<span class="op" id="7879077">==</span>&nbsp;<span class="string" id="7879080">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7879086">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879090">la</span>&nbsp;<span class="op" id="7879093">=</span>&nbsp;<span class="string" id="7879095">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879110">}</span>&nbsp;<span class="keyword" id="7879112">else</span>&nbsp;<span class="op" id="7879117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7879121">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879177">if</span>&nbsp;<span class="ident" id="7879180">la</span>&nbsp;<span class="op" id="7879183">==</span>&nbsp;<span class="string" id="7879186">&#34;&#34;</span>&nbsp;<span class="op" id="7879189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7879194">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879249">f</span><span class="op" id="7879250">,</span>&nbsp;<span class="ident" id="7879252">err</span>&nbsp;<span class="op" id="7879256">:=</span>&nbsp;<span class="ident" id="7879259">ioutil</span><span class="op" id="7879265">.</span><span class="ident" id="7879266">TempFile</span><span class="op" id="7879274">(</span><span class="string" id="7879275">&#34;&#34;</span><span class="op" id="7879277">,</span>&nbsp;<span class="string" id="7879279">&#34;syslogtest&#34;</span><span class="op" id="7879291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879296">if</span>&nbsp;<span class="ident" id="7879299">err</span>&nbsp;<span class="op" id="7879303">!=</span>&nbsp;<span class="ident" id="7879306">nil</span>&nbsp;<span class="op" id="7879310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879316">log</span><span class="op" id="7879319">.</span><span class="ident" id="7879320">Fatal</span><span class="op" id="7879325">(</span><span class="string" id="7879326">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7879338">,</span>&nbsp;<span class="ident" id="7879340">err</span><span class="op" id="7879343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879353">f</span><span class="op" id="7879354">.</span><span class="ident" id="7879355">Close</span><span class="op" id="7879360">(</span><span class="op" id="7879361">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879366">la</span>&nbsp;<span class="op" id="7879369">=</span>&nbsp;<span class="ident" id="7879371">f</span><span class="op" id="7879372">.</span><span class="ident" id="7879373">Name</span><span class="op" id="7879377">(</span><span class="op" id="7879378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879386">os</span><span class="op" id="7879388">.</span><span class="ident" id="7879389">Remove</span><span class="op" id="7879395">(</span><span class="ident" id="7879396">la</span><span class="op" id="7879398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879405">wg</span>&nbsp;<span class="op" id="7879408">=</span>&nbsp;<span class="builtinfunc" id="7879410">new</span><span class="op" id="7879413">(</span><span class="ident" id="7879414">sync</span><span class="op" id="7879418">.</span><span class="ident" id="7879419">WaitGroup</span><span class="op" id="7879428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879431">if</span>&nbsp;<span class="ident" id="7879434">n</span>&nbsp;<span class="op" id="7879436">==</span>&nbsp;<span class="string" id="7879439">&#34;udp&#34;</span>&nbsp;<span class="op" id="7879445">||</span>&nbsp;<span class="ident" id="7879448">n</span>&nbsp;<span class="op" id="7879450">==</span>&nbsp;<span class="string" id="7879453">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7879464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879468">l</span><span class="op" id="7879469">,</span>&nbsp;<span class="ident" id="7879471">e</span>&nbsp;<span class="op" id="7879473">:=</span>&nbsp;<span class="ident" id="7879476">net</span><span class="op" id="7879479">.</span><span class="ident" id="7879480">ListenPacket</span><span class="op" id="7879492">(</span><span class="ident" id="7879493">n</span><span class="op" id="7879494">,</span>&nbsp;<span class="ident" id="7879496">la</span><span class="op" id="7879498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879502">if</span>&nbsp;<span class="ident" id="7879505">e</span>&nbsp;<span class="op" id="7879507">!=</span>&nbsp;<span class="ident" id="7879510">nil</span>&nbsp;<span class="op" id="7879514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879519">log</span><span class="op" id="7879522">.</span><span class="ident" id="7879523">Fatalf</span><span class="op" id="7879529">(</span><span class="string" id="7879530">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7879554">,</span>&nbsp;<span class="ident" id="7879556">e</span><span class="op" id="7879557">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879565">addr</span>&nbsp;<span class="op" id="7879570">=</span>&nbsp;<span class="ident" id="7879572">l</span><span class="op" id="7879573">.</span><span class="ident" id="7879574">LocalAddr</span><span class="op" id="7879583">(</span><span class="op" id="7879584">)</span><span class="op" id="7879585">.</span><span class="ident" id="7879586">String</span><span class="op" id="7879592">(</span><span class="op" id="7879593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879597">sock</span>&nbsp;<span class="op" id="7879602">=</span>&nbsp;<span class="ident" id="7879604">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879608">wg</span><span class="op" id="7879610">.</span><span class="ident" id="7879611">Add</span><span class="op" id="7879614">(</span><span class="num" id="7879615">1</span><span class="op" id="7879616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879620">go</span>&nbsp;<span class="keyword" id="7879623">func</span><span class="op" id="7879627">(</span><span class="op" id="7879628">)</span>&nbsp;<span class="op" id="7879630">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879635">defer</span>&nbsp;<span class="ident" id="7879641">wg</span><span class="op" id="7879643">.</span><span class="ident" id="7879644">Done</span><span class="op" id="7879648">(</span><span class="op" id="7879649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879654">runPktSyslog</span><span class="op" id="7879666">(</span><span class="ident" id="7879667">l</span><span class="op" id="7879668">,</span>&nbsp;<span class="ident" id="7879670">done</span><span class="op" id="7879674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879678">}</span><span class="op" id="7879679">(</span><span class="op" id="7879680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879683">}</span>&nbsp;<span class="keyword" id="7879685">else</span>&nbsp;<span class="op" id="7879690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879694">l</span><span class="op" id="7879695">,</span>&nbsp;<span class="ident" id="7879697">e</span>&nbsp;<span class="op" id="7879699">:=</span>&nbsp;<span class="ident" id="7879702">net</span><span class="op" id="7879705">.</span><span class="ident" id="7879706">Listen</span><span class="op" id="7879712">(</span><span class="ident" id="7879713">n</span><span class="op" id="7879714">,</span>&nbsp;<span class="ident" id="7879716">la</span><span class="op" id="7879718">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879722">if</span>&nbsp;<span class="ident" id="7879725">e</span>&nbsp;<span class="op" id="7879727">!=</span>&nbsp;<span class="ident" id="7879730">nil</span>&nbsp;<span class="op" id="7879734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879739">log</span><span class="op" id="7879742">.</span><span class="ident" id="7879743">Fatalf</span><span class="op" id="7879749">(</span><span class="string" id="7879750">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7879774">,</span>&nbsp;<span class="ident" id="7879776">e</span><span class="op" id="7879777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879785">addr</span>&nbsp;<span class="op" id="7879790">=</span>&nbsp;<span class="ident" id="7879792">l</span><span class="op" id="7879793">.</span><span class="ident" id="7879794">Addr</span><span class="op" id="7879798">(</span><span class="op" id="7879799">)</span><span class="op" id="7879800">.</span><span class="ident" id="7879801">String</span><span class="op" id="7879807">(</span><span class="op" id="7879808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879812">sock</span>&nbsp;<span class="op" id="7879817">=</span>&nbsp;<span class="ident" id="7879819">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879823">wg</span><span class="op" id="7879825">.</span><span class="ident" id="7879826">Add</span><span class="op" id="7879829">(</span><span class="num" id="7879830">1</span><span class="op" id="7879831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879835">go</span>&nbsp;<span class="keyword" id="7879838">func</span><span class="op" id="7879842">(</span><span class="op" id="7879843">)</span>&nbsp;<span class="op" id="7879845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879850">defer</span>&nbsp;<span class="ident" id="7879856">wg</span><span class="op" id="7879858">.</span><span class="ident" id="7879859">Done</span><span class="op" id="7879863">(</span><span class="op" id="7879864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879869">runStreamSyslog</span><span class="op" id="7879884">(</span><span class="ident" id="7879885">l</span><span class="op" id="7879886">,</span>&nbsp;<span class="ident" id="7879888">done</span><span class="op" id="7879892">,</span>&nbsp;<span class="ident" id="7879894">wg</span><span class="op" id="7879896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879900">}</span><span class="op" id="7879901">(</span><span class="op" id="7879902">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7879905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7879908">return</span><br>
<span class="lineno"></span><span class="op" id="7879915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7879918">func</span>&nbsp;<span class="ident" id="7879923">TestWithSimulated</span><span class="op" id="7879940">(</span><span class="ident" id="7879941">t</span>&nbsp;<span class="op" id="7879943">*</span><span class="ident" id="7879944">testing</span><span class="op" id="7879951">.</span><span class="ident" id="7879952">T</span><span class="op" id="7879953">)</span>&nbsp;<span class="op" id="7879955">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879958">msg</span>&nbsp;<span class="op" id="7879962">:=</span>&nbsp;<span class="string" id="7879965">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7879977">transport</span>&nbsp;<span class="op" id="7879987">:=</span>&nbsp;<span class="op" id="7879990">[</span><span class="op" id="7879991">]</span><span class="builtintype" id="7879992">string</span><span class="op" id="7879998">{</span><span class="string" id="7879999">&#34;unix&#34;</span><span class="op" id="7880005">,</span>&nbsp;<span class="string" id="7880007">&#34;unixgram&#34;</span><span class="op" id="7880017">,</span>&nbsp;<span class="string" id="7880019">&#34;udp&#34;</span><span class="op" id="7880024">,</span>&nbsp;<span class="string" id="7880026">&#34;tcp&#34;</span><span class="op" id="7880031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880035">for</span>&nbsp;<span class="ident" id="7880039">_</span><span class="op" id="7880040">,</span>&nbsp;<span class="ident" id="7880042">tr</span>&nbsp;<span class="op" id="7880045">:=</span>&nbsp;<span class="keyword" id="7880048">range</span>&nbsp;<span class="ident" id="7880054">transport</span>&nbsp;<span class="op" id="7880064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880068">done</span>&nbsp;<span class="op" id="7880073">:=</span>&nbsp;<span class="builtinfunc" id="7880076">make</span><span class="op" id="7880080">(</span><span class="keyword" id="7880081">chan</span>&nbsp;<span class="builtintype" id="7880086">string</span><span class="op" id="7880092">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880096">addr</span><span class="op" id="7880100">,</span>&nbsp;<span class="ident" id="7880102">sock</span><span class="op" id="7880106">,</span>&nbsp;<span class="ident" id="7880108">srvWG</span>&nbsp;<span class="op" id="7880114">:=</span>&nbsp;<span class="ident" id="7880117">startServer</span><span class="op" id="7880128">(</span><span class="ident" id="7880129">tr</span><span class="op" id="7880131">,</span>&nbsp;<span class="string" id="7880133">&#34;&#34;</span><span class="op" id="7880135">,</span>&nbsp;<span class="ident" id="7880137">done</span><span class="op" id="7880141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880145">defer</span>&nbsp;<span class="ident" id="7880151">srvWG</span><span class="op" id="7880156">.</span><span class="ident" id="7880157">Wait</span><span class="op" id="7880161">(</span><span class="op" id="7880162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880166">defer</span>&nbsp;<span class="ident" id="7880172">sock</span><span class="op" id="7880176">.</span><span class="ident" id="7880177">Close</span><span class="op" id="7880182">(</span><span class="op" id="7880183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880187">if</span>&nbsp;<span class="ident" id="7880190">tr</span>&nbsp;<span class="op" id="7880193">==</span>&nbsp;<span class="string" id="7880196">&#34;unix&#34;</span>&nbsp;<span class="op" id="7880203">||</span>&nbsp;<span class="ident" id="7880206">tr</span>&nbsp;<span class="op" id="7880209">==</span>&nbsp;<span class="string" id="7880212">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7880223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880228">defer</span>&nbsp;<span class="ident" id="7880234">os</span><span class="op" id="7880236">.</span><span class="ident" id="7880237">Remove</span><span class="op" id="7880243">(</span><span class="ident" id="7880244">addr</span><span class="op" id="7880248">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7880252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880256">s</span><span class="op" id="7880257">,</span>&nbsp;<span class="ident" id="7880259">err</span>&nbsp;<span class="op" id="7880263">:=</span>&nbsp;<span class="ident" id="7880266">Dial</span><span class="op" id="7880270">(</span><span class="ident" id="7880271">tr</span><span class="op" id="7880273">,</span>&nbsp;<span class="ident" id="7880275">addr</span><span class="op" id="7880279">,</span>&nbsp;<span class="ident" id="7880281">LOG_INFO</span><span class="op" id="7880289">|</span><span class="ident" id="7880290">LOG_USER</span><span class="op" id="7880298">,</span>&nbsp;<span class="string" id="7880300">&#34;syslog_test&#34;</span><span class="op" id="7880313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880317">if</span>&nbsp;<span class="ident" id="7880320">err</span>&nbsp;<span class="op" id="7880324">!=</span>&nbsp;<span class="ident" id="7880327">nil</span>&nbsp;<span class="op" id="7880331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880336">t</span><span class="op" id="7880337">.</span><span class="ident" id="7880338">Fatalf</span><span class="op" id="7880344">(</span><span class="string" id="7880345">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7880364">,</span>&nbsp;<span class="ident" id="7880366">err</span><span class="op" id="7880369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7880373">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880377">err</span>&nbsp;<span class="op" id="7880381">=</span>&nbsp;<span class="ident" id="7880383">s</span><span class="op" id="7880384">.</span><span class="ident" id="7880385">Info</span><span class="op" id="7880389">(</span><span class="ident" id="7880390">msg</span><span class="op" id="7880393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880397">if</span>&nbsp;<span class="ident" id="7880400">err</span>&nbsp;<span class="op" id="7880404">!=</span>&nbsp;<span class="ident" id="7880407">nil</span>&nbsp;<span class="op" id="7880411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880416">t</span><span class="op" id="7880417">.</span><span class="ident" id="7880418">Fatalf</span><span class="op" id="7880424">(</span><span class="string" id="7880425">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7880441">,</span>&nbsp;<span class="ident" id="7880443">err</span><span class="op" id="7880446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7880450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880454">check</span><span class="op" id="7880459">(</span><span class="ident" id="7880460">t</span><span class="op" id="7880461">,</span>&nbsp;<span class="ident" id="7880463">msg</span><span class="op" id="7880466">,</span>&nbsp;<span class="op" id="7880468">&lt;-</span><span class="ident" id="7880470">done</span><span class="op" id="7880474">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880478">s</span><span class="op" id="7880479">.</span><span class="ident" id="7880480">Close</span><span class="op" id="7880485">(</span><span class="op" id="7880486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7880489">}</span><br>
<span class="lineno"></span><span class="op" id="7880491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7880494">func</span>&nbsp;<span class="ident" id="7880499">TestFlap</span><span class="op" id="7880507">(</span><span class="ident" id="7880508">t</span>&nbsp;<span class="op" id="7880510">*</span><span class="ident" id="7880511">testing</span><span class="op" id="7880518">.</span><span class="ident" id="7880519">T</span><span class="op" id="7880520">)</span>&nbsp;<span class="op" id="7880522">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880525">net</span>&nbsp;<span class="op" id="7880529">:=</span>&nbsp;<span class="string" id="7880532">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880540">done</span>&nbsp;<span class="op" id="7880545">:=</span>&nbsp;<span class="builtinfunc" id="7880548">make</span><span class="op" id="7880552">(</span><span class="keyword" id="7880553">chan</span>&nbsp;<span class="builtintype" id="7880558">string</span><span class="op" id="7880564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880567">addr</span><span class="op" id="7880571">,</span>&nbsp;<span class="ident" id="7880573">sock</span><span class="op" id="7880577">,</span>&nbsp;<span class="ident" id="7880579">srvWG</span>&nbsp;<span class="op" id="7880585">:=</span>&nbsp;<span class="ident" id="7880588">startServer</span><span class="op" id="7880599">(</span><span class="ident" id="7880600">net</span><span class="op" id="7880603">,</span>&nbsp;<span class="string" id="7880605">&#34;&#34;</span><span class="op" id="7880607">,</span>&nbsp;<span class="ident" id="7880609">done</span><span class="op" id="7880613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880616">defer</span>&nbsp;<span class="ident" id="7880622">srvWG</span><span class="op" id="7880627">.</span><span class="ident" id="7880628">Wait</span><span class="op" id="7880632">(</span><span class="op" id="7880633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880636">defer</span>&nbsp;<span class="ident" id="7880642">os</span><span class="op" id="7880644">.</span><span class="ident" id="7880645">Remove</span><span class="op" id="7880651">(</span><span class="ident" id="7880652">addr</span><span class="op" id="7880656">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880659">defer</span>&nbsp;<span class="ident" id="7880665">sock</span><span class="op" id="7880669">.</span><span class="ident" id="7880670">Close</span><span class="op" id="7880675">(</span><span class="op" id="7880676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880680">s</span><span class="op" id="7880681">,</span>&nbsp;<span class="ident" id="7880683">err</span>&nbsp;<span class="op" id="7880687">:=</span>&nbsp;<span class="ident" id="7880690">Dial</span><span class="op" id="7880694">(</span><span class="ident" id="7880695">net</span><span class="op" id="7880698">,</span>&nbsp;<span class="ident" id="7880700">addr</span><span class="op" id="7880704">,</span>&nbsp;<span class="ident" id="7880706">LOG_INFO</span><span class="op" id="7880714">|</span><span class="ident" id="7880715">LOG_USER</span><span class="op" id="7880723">,</span>&nbsp;<span class="string" id="7880725">&#34;syslog_test&#34;</span><span class="op" id="7880738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880741">if</span>&nbsp;<span class="ident" id="7880744">err</span>&nbsp;<span class="op" id="7880748">!=</span>&nbsp;<span class="ident" id="7880751">nil</span>&nbsp;<span class="op" id="7880755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880759">t</span><span class="op" id="7880760">.</span><span class="ident" id="7880761">Fatalf</span><span class="op" id="7880767">(</span><span class="string" id="7880768">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7880787">,</span>&nbsp;<span class="ident" id="7880789">err</span><span class="op" id="7880792">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7880795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880798">msg</span>&nbsp;<span class="op" id="7880802">:=</span>&nbsp;<span class="string" id="7880805">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880814">err</span>&nbsp;<span class="op" id="7880818">=</span>&nbsp;<span class="ident" id="7880820">s</span><span class="op" id="7880821">.</span><span class="ident" id="7880822">Info</span><span class="op" id="7880826">(</span><span class="ident" id="7880827">msg</span><span class="op" id="7880830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880833">if</span>&nbsp;<span class="ident" id="7880836">err</span>&nbsp;<span class="op" id="7880840">!=</span>&nbsp;<span class="ident" id="7880843">nil</span>&nbsp;<span class="op" id="7880847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880851">t</span><span class="op" id="7880852">.</span><span class="ident" id="7880853">Fatalf</span><span class="op" id="7880859">(</span><span class="string" id="7880860">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7880876">,</span>&nbsp;<span class="ident" id="7880878">err</span><span class="op" id="7880881">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7880884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880887">check</span><span class="op" id="7880892">(</span><span class="ident" id="7880893">t</span><span class="op" id="7880894">,</span>&nbsp;<span class="ident" id="7880896">msg</span><span class="op" id="7880899">,</span>&nbsp;<span class="op" id="7880901">&lt;-</span><span class="ident" id="7880903">done</span><span class="op" id="7880907">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7880911">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7880934">_</span><span class="op" id="7880935">,</span>&nbsp;<span class="ident" id="7880937">sock2</span><span class="op" id="7880942">,</span>&nbsp;<span class="ident" id="7880944">srvWG2</span>&nbsp;<span class="op" id="7880951">:=</span>&nbsp;<span class="ident" id="7880954">startServer</span><span class="op" id="7880965">(</span><span class="ident" id="7880966">net</span><span class="op" id="7880969">,</span>&nbsp;<span class="ident" id="7880971">addr</span><span class="op" id="7880975">,</span>&nbsp;<span class="ident" id="7880977">done</span><span class="op" id="7880981">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7880984">defer</span>&nbsp;<span class="ident" id="7880990">srvWG2</span><span class="op" id="7880996">.</span><span class="ident" id="7880997">Wait</span><span class="op" id="7881001">(</span><span class="op" id="7881002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881005">defer</span>&nbsp;<span class="ident" id="7881011">sock2</span><span class="op" id="7881016">.</span><span class="ident" id="7881017">Close</span><span class="op" id="7881022">(</span><span class="op" id="7881023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7881027">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881054">msg</span>&nbsp;<span class="op" id="7881058">=</span>&nbsp;<span class="string" id="7881060">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881069">err</span>&nbsp;<span class="op" id="7881073">=</span>&nbsp;<span class="ident" id="7881075">s</span><span class="op" id="7881076">.</span><span class="ident" id="7881077">Info</span><span class="op" id="7881081">(</span><span class="ident" id="7881082">msg</span><span class="op" id="7881085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881088">if</span>&nbsp;<span class="ident" id="7881091">err</span>&nbsp;<span class="op" id="7881095">!=</span>&nbsp;<span class="ident" id="7881098">nil</span>&nbsp;<span class="op" id="7881102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881106">t</span><span class="op" id="7881107">.</span><span class="ident" id="7881108">Fatalf</span><span class="op" id="7881114">(</span><span class="string" id="7881115">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7881131">,</span>&nbsp;<span class="ident" id="7881133">err</span><span class="op" id="7881136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881142">check</span><span class="op" id="7881147">(</span><span class="ident" id="7881148">t</span><span class="op" id="7881149">,</span>&nbsp;<span class="ident" id="7881151">msg</span><span class="op" id="7881154">,</span>&nbsp;<span class="op" id="7881156">&lt;-</span><span class="ident" id="7881158">done</span><span class="op" id="7881162">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881166">s</span><span class="op" id="7881167">.</span><span class="ident" id="7881168">Close</span><span class="op" id="7881173">(</span><span class="op" id="7881174">)</span><br>
<span class="lineno"></span><span class="op" id="7881176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7881179">func</span>&nbsp;<span class="ident" id="7881184">TestNew</span><span class="op" id="7881191">(</span><span class="ident" id="7881192">t</span>&nbsp;<span class="op" id="7881194">*</span><span class="ident" id="7881195">testing</span><span class="op" id="7881202">.</span><span class="ident" id="7881203">T</span><span class="op" id="7881204">)</span>&nbsp;<span class="op" id="7881206">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881209">if</span>&nbsp;<span class="ident" id="7881212">LOG_LOCAL7</span>&nbsp;<span class="op" id="7881223">!=</span>&nbsp;<span class="num" id="7881226">23</span><span class="op" id="7881228">&lt;&lt;</span><span class="num" id="7881230">3</span>&nbsp;<span class="op" id="7881232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881236">t</span><span class="op" id="7881237">.</span><span class="ident" id="7881238">Fatalf</span><span class="op" id="7881244">(</span><span class="string" id="7881245">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7881273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881279">if</span>&nbsp;<span class="ident" id="7881282">testing</span><span class="op" id="7881289">.</span><span class="ident" id="7881290">Short</span><span class="op" id="7881295">(</span><span class="op" id="7881296">)</span>&nbsp;<span class="op" id="7881298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7881302">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881365">t</span><span class="op" id="7881366">.</span><span class="ident" id="7881367">Skip</span><span class="op" id="7881371">(</span><span class="string" id="7881372">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7881408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881415">s</span><span class="op" id="7881416">,</span>&nbsp;<span class="ident" id="7881418">err</span>&nbsp;<span class="op" id="7881422">:=</span>&nbsp;<span class="ident" id="7881425">New</span><span class="op" id="7881428">(</span><span class="ident" id="7881429">LOG_INFO</span><span class="op" id="7881437">|</span><span class="ident" id="7881438">LOG_USER</span><span class="op" id="7881446">,</span>&nbsp;<span class="string" id="7881448">&#34;the_tag&#34;</span><span class="op" id="7881457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881460">if</span>&nbsp;<span class="ident" id="7881463">err</span>&nbsp;<span class="op" id="7881467">!=</span>&nbsp;<span class="ident" id="7881470">nil</span>&nbsp;<span class="op" id="7881474">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881478">t</span><span class="op" id="7881479">.</span><span class="ident" id="7881480">Fatalf</span><span class="op" id="7881486">(</span><span class="string" id="7881487">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7881505">,</span>&nbsp;<span class="ident" id="7881507">err</span><span class="op" id="7881510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7881516">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881545">s</span><span class="op" id="7881546">.</span><span class="ident" id="7881547">Close</span><span class="op" id="7881552">(</span><span class="op" id="7881553">)</span><br>
<span class="lineno"></span><span class="op" id="7881555">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7881558">func</span>&nbsp;<span class="ident" id="7881563">TestNewLogger</span><span class="op" id="7881576">(</span><span class="ident" id="7881577">t</span>&nbsp;<span class="op" id="7881579">*</span><span class="ident" id="7881580">testing</span><span class="op" id="7881587">.</span><span class="ident" id="7881588">T</span><span class="op" id="7881589">)</span>&nbsp;<span class="op" id="7881591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881594">if</span>&nbsp;<span class="ident" id="7881597">testing</span><span class="op" id="7881604">.</span><span class="ident" id="7881605">Short</span><span class="op" id="7881610">(</span><span class="op" id="7881611">)</span>&nbsp;<span class="op" id="7881613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881617">t</span><span class="op" id="7881618">.</span><span class="ident" id="7881619">Skip</span><span class="op" id="7881623">(</span><span class="string" id="7881624">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7881660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881663">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881666">f</span><span class="op" id="7881667">,</span>&nbsp;<span class="ident" id="7881669">err</span>&nbsp;<span class="op" id="7881673">:=</span>&nbsp;<span class="ident" id="7881676">NewLogger</span><span class="op" id="7881685">(</span><span class="ident" id="7881686">LOG_USER</span><span class="op" id="7881694">|</span><span class="ident" id="7881695">LOG_INFO</span><span class="op" id="7881703">,</span>&nbsp;<span class="num" id="7881705">0</span><span class="op" id="7881706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881709">if</span>&nbsp;<span class="ident" id="7881712">f</span>&nbsp;<span class="op" id="7881714">==</span>&nbsp;<span class="ident" id="7881717">nil</span>&nbsp;<span class="op" id="7881721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881725">t</span><span class="op" id="7881726">.</span><span class="ident" id="7881727">Error</span><span class="op" id="7881732">(</span><span class="ident" id="7881733">err</span><span class="op" id="7881736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881739">}</span><br>
<span class="lineno"></span><span class="op" id="7881741">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7881744">func</span>&nbsp;<span class="ident" id="7881749">TestDial</span><span class="op" id="7881757">(</span><span class="ident" id="7881758">t</span>&nbsp;<span class="op" id="7881760">*</span><span class="ident" id="7881761">testing</span><span class="op" id="7881768">.</span><span class="ident" id="7881769">T</span><span class="op" id="7881770">)</span>&nbsp;<span class="op" id="7881772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881775">if</span>&nbsp;<span class="ident" id="7881778">testing</span><span class="op" id="7881785">.</span><span class="ident" id="7881786">Short</span><span class="op" id="7881791">(</span><span class="op" id="7881792">)</span>&nbsp;<span class="op" id="7881794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881798">t</span><span class="op" id="7881799">.</span><span class="ident" id="7881800">Skip</span><span class="op" id="7881804">(</span><span class="string" id="7881805">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7881841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881844">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881847">f</span><span class="op" id="7881848">,</span>&nbsp;<span class="ident" id="7881850">err</span>&nbsp;<span class="op" id="7881854">:=</span>&nbsp;<span class="ident" id="7881857">Dial</span><span class="op" id="7881861">(</span><span class="string" id="7881862">&#34;&#34;</span><span class="op" id="7881864">,</span>&nbsp;<span class="string" id="7881866">&#34;&#34;</span><span class="op" id="7881868">,</span>&nbsp;<span class="op" id="7881870">(</span><span class="ident" id="7881871">LOG_LOCAL7</span><span class="op" id="7881881">|</span><span class="ident" id="7881882">LOG_DEBUG</span><span class="op" id="7881891">)</span><span class="op" id="7881892">+</span><span class="num" id="7881893">1</span><span class="op" id="7881894">,</span>&nbsp;<span class="string" id="7881896">&#34;syslog_test&#34;</span><span class="op" id="7881909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7881912">if</span>&nbsp;<span class="ident" id="7881915">f</span>&nbsp;<span class="op" id="7881917">!=</span>&nbsp;<span class="ident" id="7881920">nil</span>&nbsp;<span class="op" id="7881924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881928">t</span><span class="op" id="7881929">.</span><span class="ident" id="7881930">Fatalf</span><span class="op" id="7881936">(</span><span class="string" id="7881937">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7881971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7881974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7881977">f</span><span class="op" id="7881978">,</span>&nbsp;<span class="ident" id="7881980">err</span>&nbsp;<span class="op" id="7881984">=</span>&nbsp;<span class="ident" id="7881986">Dial</span><span class="op" id="7881990">(</span><span class="string" id="7881991">&#34;&#34;</span><span class="op" id="7881993">,</span>&nbsp;<span class="string" id="7881995">&#34;&#34;</span><span class="op" id="7881997">,</span>&nbsp;<span class="op" id="7881999">-</span><span class="num" id="7882000">1</span><span class="op" id="7882001">,</span>&nbsp;<span class="string" id="7882003">&#34;syslog_test&#34;</span><span class="op" id="7882016">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7882019">if</span>&nbsp;<span class="ident" id="7882022">f</span>&nbsp;<span class="op" id="7882024">!=</span>&nbsp;<span class="ident" id="7882027">nil</span>&nbsp;<span class="op" id="7882031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882035">t</span><span class="op" id="7882036">.</span><span class="ident" id="7882037">Fatalf</span><span class="op" id="7882043">(</span><span class="string" id="7882044">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7882078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882084">l</span><span class="op" id="7882085">,</span>&nbsp;<span class="ident" id="7882087">err</span>&nbsp;<span class="op" id="7882091">:=</span>&nbsp;<span class="ident" id="7882094">Dial</span><span class="op" id="7882098">(</span><span class="string" id="7882099">&#34;&#34;</span><span class="op" id="7882101">,</span>&nbsp;<span class="string" id="7882103">&#34;&#34;</span><span class="op" id="7882105">,</span>&nbsp;<span class="ident" id="7882107">LOG_USER</span><span class="op" id="7882115">|</span><span class="ident" id="7882116">LOG_ERR</span><span class="op" id="7882123">,</span>&nbsp;<span class="string" id="7882125">&#34;syslog_test&#34;</span><span class="op" id="7882138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7882141">if</span>&nbsp;<span class="ident" id="7882144">err</span>&nbsp;<span class="op" id="7882148">!=</span>&nbsp;<span class="ident" id="7882151">nil</span>&nbsp;<span class="op" id="7882155">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882159">t</span><span class="op" id="7882160">.</span><span class="ident" id="7882161">Fatalf</span><span class="op" id="7882167">(</span><span class="string" id="7882168">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7882187">,</span>&nbsp;<span class="ident" id="7882189">err</span><span class="op" id="7882192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882198">l</span><span class="op" id="7882199">.</span><span class="ident" id="7882200">Close</span><span class="op" id="7882205">(</span><span class="op" id="7882206">)</span><br>
<span class="lineno"></span><span class="op" id="7882208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7882211">func</span>&nbsp;<span class="ident" id="7882216">check</span><span class="op" id="7882221">(</span><span class="ident" id="7882222">t</span>&nbsp;<span class="op" id="7882224">*</span><span class="ident" id="7882225">testing</span><span class="op" id="7882232">.</span><span class="ident" id="7882233">T</span><span class="op" id="7882234">,</span>&nbsp;<span class="ident" id="7882236">in</span><span class="op" id="7882238">,</span>&nbsp;<span class="ident" id="7882240">out</span>&nbsp;<span class="builtintype" id="7882244">string</span><span class="op" id="7882250">)</span>&nbsp;<span class="op" id="7882252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882255">tmpl</span>&nbsp;<span class="op" id="7882260">:=</span>&nbsp;<span class="ident" id="7882263">fmt</span><span class="op" id="7882266">.</span><span class="ident" id="7882267">Sprintf</span><span class="op" id="7882274">(</span><span class="string" id="7882275">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7882311">,</span>&nbsp;<span class="ident" id="7882313">LOG_USER</span><span class="op" id="7882321">+</span><span class="ident" id="7882322">LOG_INFO</span><span class="op" id="7882330">,</span>&nbsp;<span class="ident" id="7882332">in</span><span class="op" id="7882334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7882337">if</span>&nbsp;<span class="ident" id="7882340">hostname</span><span class="op" id="7882348">,</span>&nbsp;<span class="ident" id="7882350">err</span>&nbsp;<span class="op" id="7882354">:=</span>&nbsp;<span class="ident" id="7882357">os</span><span class="op" id="7882359">.</span><span class="ident" id="7882360">Hostname</span><span class="op" id="7882368">(</span><span class="op" id="7882369">)</span><span class="op" id="7882370">;</span>&nbsp;<span class="ident" id="7882372">err</span>&nbsp;<span class="op" id="7882376">!=</span>&nbsp;<span class="ident" id="7882379">nil</span>&nbsp;<span class="op" id="7882383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882387">t</span><span class="op" id="7882388">.</span><span class="ident" id="7882389">Error</span><span class="op" id="7882394">(</span><span class="string" id="7882395">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7882422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882425">}</span>&nbsp;<span class="keyword" id="7882427">else</span>&nbsp;<span class="op" id="7882432">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7882436">var</span>&nbsp;<span class="ident" id="7882440">parsedHostname</span><span class="op" id="7882454">,</span>&nbsp;<span class="ident" id="7882456">timestamp</span>&nbsp;<span class="builtintype" id="7882466">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7882475">var</span>&nbsp;<span class="ident" id="7882479">pid</span>&nbsp;<span class="builtintype" id="7882483">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7882489">if</span>&nbsp;<span class="ident" id="7882492">n</span><span class="op" id="7882493">,</span>&nbsp;<span class="ident" id="7882495">err</span>&nbsp;<span class="op" id="7882499">:=</span>&nbsp;<span class="ident" id="7882502">fmt</span><span class="op" id="7882505">.</span><span class="ident" id="7882506">Sscanf</span><span class="op" id="7882512">(</span><span class="ident" id="7882513">out</span><span class="op" id="7882516">,</span>&nbsp;<span class="ident" id="7882518">tmpl</span><span class="op" id="7882522">,</span>&nbsp;<span class="op" id="7882524">&amp;</span><span class="ident" id="7882525">timestamp</span><span class="op" id="7882534">,</span>&nbsp;<span class="op" id="7882536">&amp;</span><span class="ident" id="7882537">parsedHostname</span><span class="op" id="7882551">,</span>&nbsp;<span class="op" id="7882553">&amp;</span><span class="ident" id="7882554">pid</span><span class="op" id="7882557">)</span><span class="op" id="7882558">;</span>&nbsp;<span class="ident" id="7882560">n</span>&nbsp;<span class="op" id="7882562">!=</span>&nbsp;<span class="num" id="7882565">3</span>&nbsp;<span class="op" id="7882567">||</span>&nbsp;<span class="ident" id="7882570">err</span>&nbsp;<span class="op" id="7882574">!=</span>&nbsp;<span class="ident" id="7882577">nil</span>&nbsp;<span class="op" id="7882581">||</span>&nbsp;<span class="ident" id="7882584">hostname</span>&nbsp;<span class="op" id="7882593">!=</span>&nbsp;<span class="ident" id="7882596">parsedHostname</span>&nbsp;<span class="op" id="7882611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882616">t</span><span class="op" id="7882617">.</span><span class="ident" id="7882618">Errorf</span><span class="op" id="7882624">(</span><span class="string" id="7882625">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7882669">,</span>&nbsp;<span class="ident" id="7882671">out</span><span class="op" id="7882674">,</span>&nbsp;<span class="ident" id="7882676">tmpl</span><span class="op" id="7882680">,</span>&nbsp;<span class="ident" id="7882682">n</span><span class="op" id="7882683">,</span>&nbsp;<span class="ident" id="7882685">err</span><span class="op" id="7882688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882692">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882695">}</span><br>
<span class="lineno"></span><span class="op" id="7882697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7882700">func</span>&nbsp;<span class="ident" id="7882705">TestWrite</span><span class="op" id="7882714">(</span><span class="ident" id="7882715">t</span>&nbsp;<span class="op" id="7882717">*</span><span class="ident" id="7882718">testing</span><span class="op" id="7882725">.</span><span class="ident" id="7882726">T</span><span class="op" id="7882727">)</span>&nbsp;<span class="op" id="7882729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882732">tests</span>&nbsp;<span class="op" id="7882738">:=</span>&nbsp;<span class="op" id="7882741">[</span><span class="op" id="7882742">]</span><span class="keyword" id="7882743">struct</span>&nbsp;<span class="op" id="7882750">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882754">pri</span>&nbsp;<span class="ident" id="7882758">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882769">pre</span>&nbsp;<span class="builtintype" id="7882773">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882782">msg</span>&nbsp;<span class="builtintype" id="7882786">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7882795">exp</span>&nbsp;<span class="builtintype" id="7882799">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882807">}</span><span class="op" id="7882808">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882812">{</span><span class="ident" id="7882813">LOG_USER</span>&nbsp;<span class="op" id="7882822">|</span>&nbsp;<span class="ident" id="7882824">LOG_ERR</span><span class="op" id="7882831">,</span>&nbsp;<span class="string" id="7882833">&#34;syslog_test&#34;</span><span class="op" id="7882846">,</span>&nbsp;<span class="string" id="7882848">&#34;&#34;</span><span class="op" id="7882850">,</span>&nbsp;<span class="string" id="7882852">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7882879">}</span><span class="op" id="7882880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7882884">{</span><span class="ident" id="7882885">LOG_USER</span>&nbsp;<span class="op" id="7882894">|</span>&nbsp;<span class="ident" id="7882896">LOG_ERR</span><span class="op" id="7882903">,</span>&nbsp;<span class="string" id="7882905">&#34;syslog_test&#34;</span><span class="op" id="7882918">,</span>&nbsp;<span class="string" id="7882920">&#34;write&nbsp;test&#34;</span><span class="op" id="7882932">,</span>&nbsp;<span class="string" id="7882934">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7882971">}</span><span class="op" id="7882972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7882976">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883029">{</span><span class="ident" id="7883030">LOG_USER</span>&nbsp;<span class="op" id="7883039">|</span>&nbsp;<span class="ident" id="7883041">LOG_ERR</span><span class="op" id="7883048">,</span>&nbsp;<span class="string" id="7883050">&#34;syslog_test&#34;</span><span class="op" id="7883063">,</span>&nbsp;<span class="string" id="7883065">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7883081">,</span>&nbsp;<span class="string" id="7883083">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7883122">}</span><span class="op" id="7883123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883126">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883130">if</span>&nbsp;<span class="ident" id="7883133">hostname</span><span class="op" id="7883141">,</span>&nbsp;<span class="ident" id="7883143">err</span>&nbsp;<span class="op" id="7883147">:=</span>&nbsp;<span class="ident" id="7883150">os</span><span class="op" id="7883152">.</span><span class="ident" id="7883153">Hostname</span><span class="op" id="7883161">(</span><span class="op" id="7883162">)</span><span class="op" id="7883163">;</span>&nbsp;<span class="ident" id="7883165">err</span>&nbsp;<span class="op" id="7883169">!=</span>&nbsp;<span class="ident" id="7883172">nil</span>&nbsp;<span class="op" id="7883176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883180">t</span><span class="op" id="7883181">.</span><span class="ident" id="7883182">Fatalf</span><span class="op" id="7883188">(</span><span class="string" id="7883189">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7883216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883219">}</span>&nbsp;<span class="keyword" id="7883221">else</span>&nbsp;<span class="op" id="7883226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883230">for</span>&nbsp;<span class="ident" id="7883234">_</span><span class="op" id="7883235">,</span>&nbsp;<span class="ident" id="7883237">test</span>&nbsp;<span class="op" id="7883242">:=</span>&nbsp;<span class="keyword" id="7883245">range</span>&nbsp;<span class="ident" id="7883251">tests</span>&nbsp;<span class="op" id="7883257">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883262">done</span>&nbsp;<span class="op" id="7883267">:=</span>&nbsp;<span class="builtinfunc" id="7883270">make</span><span class="op" id="7883274">(</span><span class="keyword" id="7883275">chan</span>&nbsp;<span class="builtintype" id="7883280">string</span><span class="op" id="7883286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883291">addr</span><span class="op" id="7883295">,</span>&nbsp;<span class="ident" id="7883297">sock</span><span class="op" id="7883301">,</span>&nbsp;<span class="ident" id="7883303">srvWG</span>&nbsp;<span class="op" id="7883309">:=</span>&nbsp;<span class="ident" id="7883312">startServer</span><span class="op" id="7883323">(</span><span class="string" id="7883324">&#34;udp&#34;</span><span class="op" id="7883329">,</span>&nbsp;<span class="string" id="7883331">&#34;&#34;</span><span class="op" id="7883333">,</span>&nbsp;<span class="ident" id="7883335">done</span><span class="op" id="7883339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883344">defer</span>&nbsp;<span class="ident" id="7883350">srvWG</span><span class="op" id="7883355">.</span><span class="ident" id="7883356">Wait</span><span class="op" id="7883360">(</span><span class="op" id="7883361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883366">defer</span>&nbsp;<span class="ident" id="7883372">sock</span><span class="op" id="7883376">.</span><span class="ident" id="7883377">Close</span><span class="op" id="7883382">(</span><span class="op" id="7883383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883388">l</span><span class="op" id="7883389">,</span>&nbsp;<span class="ident" id="7883391">err</span>&nbsp;<span class="op" id="7883395">:=</span>&nbsp;<span class="ident" id="7883398">Dial</span><span class="op" id="7883402">(</span><span class="string" id="7883403">&#34;udp&#34;</span><span class="op" id="7883408">,</span>&nbsp;<span class="ident" id="7883410">addr</span><span class="op" id="7883414">,</span>&nbsp;<span class="ident" id="7883416">test</span><span class="op" id="7883420">.</span><span class="ident" id="7883421">pri</span><span class="op" id="7883424">,</span>&nbsp;<span class="ident" id="7883426">test</span><span class="op" id="7883430">.</span><span class="ident" id="7883431">pre</span><span class="op" id="7883434">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883439">if</span>&nbsp;<span class="ident" id="7883442">err</span>&nbsp;<span class="op" id="7883446">!=</span>&nbsp;<span class="ident" id="7883449">nil</span>&nbsp;<span class="op" id="7883453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883459">t</span><span class="op" id="7883460">.</span><span class="ident" id="7883461">Fatalf</span><span class="op" id="7883467">(</span><span class="string" id="7883468">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7883494">,</span>&nbsp;<span class="ident" id="7883496">err</span><span class="op" id="7883499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883509">defer</span>&nbsp;<span class="ident" id="7883515">l</span><span class="op" id="7883516">.</span><span class="ident" id="7883517">Close</span><span class="op" id="7883522">(</span><span class="op" id="7883523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883528">_</span><span class="op" id="7883529">,</span>&nbsp;<span class="ident" id="7883531">err</span>&nbsp;<span class="op" id="7883535">=</span>&nbsp;<span class="ident" id="7883537">io</span><span class="op" id="7883539">.</span><span class="ident" id="7883540">WriteString</span><span class="op" id="7883551">(</span><span class="ident" id="7883552">l</span><span class="op" id="7883553">,</span>&nbsp;<span class="ident" id="7883555">test</span><span class="op" id="7883559">.</span><span class="ident" id="7883560">msg</span><span class="op" id="7883563">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883568">if</span>&nbsp;<span class="ident" id="7883571">err</span>&nbsp;<span class="op" id="7883575">!=</span>&nbsp;<span class="ident" id="7883578">nil</span>&nbsp;<span class="op" id="7883582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883588">t</span><span class="op" id="7883589">.</span><span class="ident" id="7883590">Fatalf</span><span class="op" id="7883596">(</span><span class="string" id="7883597">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7883623">,</span>&nbsp;<span class="ident" id="7883625">err</span><span class="op" id="7883628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883638">rcvd</span>&nbsp;<span class="op" id="7883643">:=</span>&nbsp;<span class="op" id="7883646">&lt;-</span><span class="ident" id="7883648">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883656">test</span><span class="op" id="7883660">.</span><span class="ident" id="7883661">exp</span>&nbsp;<span class="op" id="7883665">=</span>&nbsp;<span class="ident" id="7883667">fmt</span><span class="op" id="7883670">.</span><span class="ident" id="7883671">Sprintf</span><span class="op" id="7883678">(</span><span class="string" id="7883679">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7883685">,</span>&nbsp;<span class="ident" id="7883687">test</span><span class="op" id="7883691">.</span><span class="ident" id="7883692">pri</span><span class="op" id="7883695">)</span>&nbsp;<span class="op" id="7883697">+</span>&nbsp;<span class="ident" id="7883699">test</span><span class="op" id="7883703">.</span><span class="ident" id="7883704">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883711">var</span>&nbsp;<span class="ident" id="7883715">parsedHostname</span><span class="op" id="7883729">,</span>&nbsp;<span class="ident" id="7883731">timestamp</span>&nbsp;<span class="builtintype" id="7883741">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883751">var</span>&nbsp;<span class="ident" id="7883755">pid</span>&nbsp;<span class="builtintype" id="7883759">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7883766">if</span>&nbsp;<span class="ident" id="7883769">n</span><span class="op" id="7883770">,</span>&nbsp;<span class="ident" id="7883772">err</span>&nbsp;<span class="op" id="7883776">:=</span>&nbsp;<span class="ident" id="7883779">fmt</span><span class="op" id="7883782">.</span><span class="ident" id="7883783">Sscanf</span><span class="op" id="7883789">(</span><span class="ident" id="7883790">rcvd</span><span class="op" id="7883794">,</span>&nbsp;<span class="ident" id="7883796">test</span><span class="op" id="7883800">.</span><span class="ident" id="7883801">exp</span><span class="op" id="7883804">,</span>&nbsp;<span class="op" id="7883806">&amp;</span><span class="ident" id="7883807">timestamp</span><span class="op" id="7883816">,</span>&nbsp;<span class="op" id="7883818">&amp;</span><span class="ident" id="7883819">parsedHostname</span><span class="op" id="7883833">,</span>&nbsp;<span class="op" id="7883835">&amp;</span><span class="ident" id="7883836">pid</span><span class="op" id="7883839">)</span><span class="op" id="7883840">;</span>&nbsp;<span class="ident" id="7883842">n</span>&nbsp;<span class="op" id="7883844">!=</span>&nbsp;<span class="num" id="7883847">3</span>&nbsp;<span class="op" id="7883849">||</span>&nbsp;<span class="ident" id="7883852">err</span>&nbsp;<span class="op" id="7883856">!=</span>&nbsp;<span class="ident" id="7883859">nil</span>&nbsp;<span class="op" id="7883863">||</span>&nbsp;<span class="ident" id="7883866">hostname</span>&nbsp;<span class="op" id="7883875">!=</span>&nbsp;<span class="ident" id="7883878">parsedHostname</span>&nbsp;<span class="op" id="7883893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7883899">t</span><span class="op" id="7883900">.</span><span class="ident" id="7883901">Errorf</span><span class="op" id="7883907">(</span><span class="string" id="7883908">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7883952">,</span>&nbsp;<span class="ident" id="7883954">rcvd</span><span class="op" id="7883958">,</span>&nbsp;<span class="ident" id="7883960">test</span><span class="op" id="7883964">.</span><span class="ident" id="7883965">exp</span><span class="op" id="7883968">,</span>&nbsp;<span class="ident" id="7883970">n</span><span class="op" id="7883971">,</span>&nbsp;<span class="ident" id="7883973">err</span><span class="op" id="7883976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883981">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7883988">}</span><br>
<span class="lineno"></span><span class="op" id="7883990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7883993">func</span>&nbsp;<span class="ident" id="7883998">TestConcurrentWrite</span><span class="op" id="7884017">(</span><span class="ident" id="7884018">t</span>&nbsp;<span class="op" id="7884020">*</span><span class="ident" id="7884021">testing</span><span class="op" id="7884028">.</span><span class="ident" id="7884029">T</span><span class="op" id="7884030">)</span>&nbsp;<span class="op" id="7884032">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884035">addr</span><span class="op" id="7884039">,</span>&nbsp;<span class="ident" id="7884041">sock</span><span class="op" id="7884045">,</span>&nbsp;<span class="ident" id="7884047">srvWG</span>&nbsp;<span class="op" id="7884053">:=</span>&nbsp;<span class="ident" id="7884056">startServer</span><span class="op" id="7884067">(</span><span class="string" id="7884068">&#34;udp&#34;</span><span class="op" id="7884073">,</span>&nbsp;<span class="string" id="7884075">&#34;&#34;</span><span class="op" id="7884077">,</span>&nbsp;<span class="builtinfunc" id="7884079">make</span><span class="op" id="7884083">(</span><span class="keyword" id="7884084">chan</span>&nbsp;<span class="builtintype" id="7884089">string</span><span class="op" id="7884095">,</span>&nbsp;<span class="num" id="7884097">1</span><span class="op" id="7884098">)</span><span class="op" id="7884099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884102">defer</span>&nbsp;<span class="ident" id="7884108">srvWG</span><span class="op" id="7884113">.</span><span class="ident" id="7884114">Wait</span><span class="op" id="7884118">(</span><span class="op" id="7884119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884122">defer</span>&nbsp;<span class="ident" id="7884128">sock</span><span class="op" id="7884132">.</span><span class="ident" id="7884133">Close</span><span class="op" id="7884138">(</span><span class="op" id="7884139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884142">w</span><span class="op" id="7884143">,</span>&nbsp;<span class="ident" id="7884145">err</span>&nbsp;<span class="op" id="7884149">:=</span>&nbsp;<span class="ident" id="7884152">Dial</span><span class="op" id="7884156">(</span><span class="string" id="7884157">&#34;udp&#34;</span><span class="op" id="7884162">,</span>&nbsp;<span class="ident" id="7884164">addr</span><span class="op" id="7884168">,</span>&nbsp;<span class="ident" id="7884170">LOG_USER</span><span class="op" id="7884178">|</span><span class="ident" id="7884179">LOG_ERR</span><span class="op" id="7884186">,</span>&nbsp;<span class="string" id="7884188">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7884205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884208">if</span>&nbsp;<span class="ident" id="7884211">err</span>&nbsp;<span class="op" id="7884215">!=</span>&nbsp;<span class="ident" id="7884218">nil</span>&nbsp;<span class="op" id="7884222">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884226">t</span><span class="op" id="7884227">.</span><span class="ident" id="7884228">Fatalf</span><span class="op" id="7884234">(</span><span class="string" id="7884235">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7884261">,</span>&nbsp;<span class="ident" id="7884263">err</span><span class="op" id="7884266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7884269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884272">var</span>&nbsp;<span class="ident" id="7884276">wg</span>&nbsp;<span class="ident" id="7884279">sync</span><span class="op" id="7884283">.</span><span class="ident" id="7884284">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884295">for</span>&nbsp;<span class="ident" id="7884299">i</span>&nbsp;<span class="op" id="7884301">:=</span>&nbsp;<span class="num" id="7884304">0</span><span class="op" id="7884305">;</span>&nbsp;<span class="ident" id="7884307">i</span>&nbsp;<span class="op" id="7884309">&lt;</span>&nbsp;<span class="num" id="7884311">10</span><span class="op" id="7884313">;</span>&nbsp;<span class="ident" id="7884315">i</span><span class="op" id="7884316">++</span>&nbsp;<span class="op" id="7884319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884323">wg</span><span class="op" id="7884325">.</span><span class="ident" id="7884326">Add</span><span class="op" id="7884329">(</span><span class="num" id="7884330">1</span><span class="op" id="7884331">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884335">go</span>&nbsp;<span class="keyword" id="7884338">func</span><span class="op" id="7884342">(</span><span class="op" id="7884343">)</span>&nbsp;<span class="op" id="7884345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884350">defer</span>&nbsp;<span class="ident" id="7884356">wg</span><span class="op" id="7884358">.</span><span class="ident" id="7884359">Done</span><span class="op" id="7884363">(</span><span class="op" id="7884364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884369">err</span>&nbsp;<span class="op" id="7884373">:=</span>&nbsp;<span class="ident" id="7884376">w</span><span class="op" id="7884377">.</span><span class="ident" id="7884378">Info</span><span class="op" id="7884382">(</span><span class="string" id="7884383">&#34;test&#34;</span><span class="op" id="7884389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884394">if</span>&nbsp;<span class="ident" id="7884397">err</span>&nbsp;<span class="op" id="7884401">!=</span>&nbsp;<span class="ident" id="7884404">nil</span>&nbsp;<span class="op" id="7884408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884414">t</span><span class="op" id="7884415">.</span><span class="ident" id="7884416">Errorf</span><span class="op" id="7884422">(</span><span class="string" id="7884423">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7884442">,</span>&nbsp;<span class="ident" id="7884444">err</span><span class="op" id="7884447">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884453">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7884463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7884467">}</span><span class="op" id="7884468">(</span><span class="op" id="7884469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7884472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884475">wg</span><span class="op" id="7884477">.</span><span class="ident" id="7884478">Wait</span><span class="op" id="7884482">(</span><span class="op" id="7884483">)</span><br>
<span class="lineno">300</span><span class="op" id="7884485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7884488">func</span>&nbsp;<span class="ident" id="7884493">TestConcurrentReconnect</span><span class="op" id="7884516">(</span><span class="ident" id="7884517">t</span>&nbsp;<span class="op" id="7884519">*</span><span class="ident" id="7884520">testing</span><span class="op" id="7884527">.</span><span class="ident" id="7884528">T</span><span class="op" id="7884529">)</span>&nbsp;<span class="op" id="7884531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884534">crashy</span>&nbsp;<span class="op" id="7884541">=</span>&nbsp;<span class="builtintype" id="7884543">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884549">defer</span>&nbsp;<span class="keyword" id="7884555">func</span><span class="op" id="7884559">(</span><span class="op" id="7884560">)</span>&nbsp;<span class="op" id="7884562">{</span>&nbsp;<span class="ident" id="7884564">crashy</span>&nbsp;<span class="op" id="7884571">=</span>&nbsp;<span class="builtintype" id="7884573">false</span>&nbsp;<span class="op" id="7884579">}</span><span class="op" id="7884580">(</span><span class="op" id="7884581">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884585">const</span>&nbsp;<span class="ident" id="7884591">N</span>&nbsp;<span class="op" id="7884593">=</span>&nbsp;<span class="num" id="7884595">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884599">const</span>&nbsp;<span class="ident" id="7884605">M</span>&nbsp;<span class="op" id="7884607">=</span>&nbsp;<span class="num" id="7884609">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884614">net</span>&nbsp;<span class="op" id="7884618">:=</span>&nbsp;<span class="string" id="7884621">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884629">done</span>&nbsp;<span class="op" id="7884634">:=</span>&nbsp;<span class="builtinfunc" id="7884637">make</span><span class="op" id="7884641">(</span><span class="keyword" id="7884642">chan</span>&nbsp;<span class="builtintype" id="7884647">string</span><span class="op" id="7884653">,</span>&nbsp;<span class="ident" id="7884655">N</span><span class="op" id="7884656">*</span><span class="ident" id="7884657">M</span><span class="op" id="7884658">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884661">addr</span><span class="op" id="7884665">,</span>&nbsp;<span class="ident" id="7884667">sock</span><span class="op" id="7884671">,</span>&nbsp;<span class="ident" id="7884673">srvWG</span>&nbsp;<span class="op" id="7884679">:=</span>&nbsp;<span class="ident" id="7884682">startServer</span><span class="op" id="7884693">(</span><span class="ident" id="7884694">net</span><span class="op" id="7884697">,</span>&nbsp;<span class="string" id="7884699">&#34;&#34;</span><span class="op" id="7884701">,</span>&nbsp;<span class="ident" id="7884703">done</span><span class="op" id="7884707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884710">defer</span>&nbsp;<span class="ident" id="7884716">os</span><span class="op" id="7884718">.</span><span class="ident" id="7884719">Remove</span><span class="op" id="7884725">(</span><span class="ident" id="7884726">addr</span><span class="op" id="7884730">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7884734">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884770">count</span>&nbsp;<span class="op" id="7884776">:=</span>&nbsp;<span class="builtinfunc" id="7884779">make</span><span class="op" id="7884783">(</span><span class="keyword" id="7884784">chan</span>&nbsp;<span class="builtintype" id="7884789">int</span><span class="op" id="7884792">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884795">go</span>&nbsp;<span class="keyword" id="7884798">func</span><span class="op" id="7884802">(</span><span class="op" id="7884803">)</span>&nbsp;<span class="op" id="7884805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884809">ct</span>&nbsp;<span class="op" id="7884812">:=</span>&nbsp;<span class="num" id="7884815">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884819">for</span>&nbsp;<span class="keyword" id="7884823">range</span>&nbsp;<span class="ident" id="7884829">done</span>&nbsp;<span class="op" id="7884834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7884839">ct</span><span class="op" id="7884841">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7884847">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7884895">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7884944">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7884983">if</span>&nbsp;<span class="ident" id="7884986">ct</span>&nbsp;<span class="op" id="7884989">&gt;</span>&nbsp;<span class="ident" id="7884991">N</span><span class="op" id="7884992">*</span><span class="ident" id="7884993">M</span><span class="op" id="7884994">/</span><span class="num" id="7884995">2</span>&nbsp;<span class="op" id="7884997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885003">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885012">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885020">count</span>&nbsp;<span class="op" id="7885026">&lt;-</span>&nbsp;<span class="ident" id="7885029">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885033">}</span><span class="op" id="7885034">(</span><span class="op" id="7885035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885039">var</span>&nbsp;<span class="ident" id="7885043">wg</span>&nbsp;<span class="ident" id="7885046">sync</span><span class="op" id="7885050">.</span><span class="ident" id="7885051">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885062">wg</span><span class="op" id="7885064">.</span><span class="ident" id="7885065">Add</span><span class="op" id="7885068">(</span><span class="ident" id="7885069">N</span><span class="op" id="7885070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885073">for</span>&nbsp;<span class="ident" id="7885077">i</span>&nbsp;<span class="op" id="7885079">:=</span>&nbsp;<span class="num" id="7885082">0</span><span class="op" id="7885083">;</span>&nbsp;<span class="ident" id="7885085">i</span>&nbsp;<span class="op" id="7885087">&lt;</span>&nbsp;<span class="ident" id="7885089">N</span><span class="op" id="7885090">;</span>&nbsp;<span class="ident" id="7885092">i</span><span class="op" id="7885093">++</span>&nbsp;<span class="op" id="7885096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885100">go</span>&nbsp;<span class="keyword" id="7885103">func</span><span class="op" id="7885107">(</span><span class="op" id="7885108">)</span>&nbsp;<span class="op" id="7885110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885115">defer</span>&nbsp;<span class="ident" id="7885121">wg</span><span class="op" id="7885123">.</span><span class="ident" id="7885124">Done</span><span class="op" id="7885128">(</span><span class="op" id="7885129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885134">w</span><span class="op" id="7885135">,</span>&nbsp;<span class="ident" id="7885137">err</span>&nbsp;<span class="op" id="7885141">:=</span>&nbsp;<span class="ident" id="7885144">Dial</span><span class="op" id="7885148">(</span><span class="ident" id="7885149">net</span><span class="op" id="7885152">,</span>&nbsp;<span class="ident" id="7885154">addr</span><span class="op" id="7885158">,</span>&nbsp;<span class="ident" id="7885160">LOG_USER</span><span class="op" id="7885168">|</span><span class="ident" id="7885169">LOG_ERR</span><span class="op" id="7885176">,</span>&nbsp;<span class="string" id="7885178">&#34;tag&#34;</span><span class="op" id="7885183">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885188">if</span>&nbsp;<span class="ident" id="7885191">err</span>&nbsp;<span class="op" id="7885195">!=</span>&nbsp;<span class="ident" id="7885198">nil</span>&nbsp;<span class="op" id="7885202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885208">t</span><span class="op" id="7885209">.</span><span class="ident" id="7885210">Fatalf</span><span class="op" id="7885216">(</span><span class="string" id="7885217">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7885243">,</span>&nbsp;<span class="ident" id="7885245">err</span><span class="op" id="7885248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885258">defer</span>&nbsp;<span class="ident" id="7885264">w</span><span class="op" id="7885265">.</span><span class="ident" id="7885266">Close</span><span class="op" id="7885271">(</span><span class="op" id="7885272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885277">for</span>&nbsp;<span class="ident" id="7885281">i</span>&nbsp;<span class="op" id="7885283">:=</span>&nbsp;<span class="num" id="7885286">0</span><span class="op" id="7885287">;</span>&nbsp;<span class="ident" id="7885289">i</span>&nbsp;<span class="op" id="7885291">&lt;</span>&nbsp;<span class="ident" id="7885293">M</span><span class="op" id="7885294">;</span>&nbsp;<span class="ident" id="7885296">i</span><span class="op" id="7885297">++</span>&nbsp;<span class="op" id="7885300">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885306">err</span>&nbsp;<span class="op" id="7885310">:=</span>&nbsp;<span class="ident" id="7885313">w</span><span class="op" id="7885314">.</span><span class="ident" id="7885315">Info</span><span class="op" id="7885319">(</span><span class="string" id="7885320">&#34;test&#34;</span><span class="op" id="7885326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885332">if</span>&nbsp;<span class="ident" id="7885335">err</span>&nbsp;<span class="op" id="7885339">!=</span>&nbsp;<span class="ident" id="7885342">nil</span>&nbsp;<span class="op" id="7885346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885353">t</span><span class="op" id="7885354">.</span><span class="ident" id="7885355">Errorf</span><span class="op" id="7885361">(</span><span class="string" id="7885362">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7885381">,</span>&nbsp;<span class="ident" id="7885383">err</span><span class="op" id="7885386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885393">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885404">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885413">}</span><span class="op" id="7885414">(</span><span class="op" id="7885415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885421">wg</span><span class="op" id="7885423">.</span><span class="ident" id="7885424">Wait</span><span class="op" id="7885428">(</span><span class="op" id="7885429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885432">sock</span><span class="op" id="7885436">.</span><span class="ident" id="7885437">Close</span><span class="op" id="7885442">(</span><span class="op" id="7885443">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885446">srvWG</span><span class="op" id="7885451">.</span><span class="ident" id="7885452">Wait</span><span class="op" id="7885456">(</span><span class="op" id="7885457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7885460">close</span><span class="op" id="7885465">(</span><span class="ident" id="7885466">done</span><span class="op" id="7885470">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885474">select</span>&nbsp;<span class="op" id="7885481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885484">case</span>&nbsp;<span class="op" id="7885489">&lt;-</span><span class="ident" id="7885491">count</span><span class="op" id="7885496">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885499">case</span>&nbsp;<span class="op" id="7885504">&lt;-</span><span class="ident" id="7885506">time</span><span class="op" id="7885510">.</span><span class="ident" id="7885511">After</span><span class="op" id="7885516">(</span><span class="num" id="7885517">100</span>&nbsp;<span class="op" id="7885521">*</span>&nbsp;<span class="ident" id="7885523">time</span><span class="op" id="7885527">.</span><span class="ident" id="7885528">Millisecond</span><span class="op" id="7885539">)</span><span class="op" id="7885540">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885544">t</span><span class="op" id="7885545">.</span><span class="ident" id="7885546">Error</span><span class="op" id="7885551">(</span><span class="string" id="7885552">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7885585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885588">}</span><br>
<span class="lineno"></span><span class="op" id="7885590">}</span>
</div>
</body>
</html>
