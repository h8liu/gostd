<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html" class="current">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7825355">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7825410">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7825464">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7825515">package</span>&nbsp;<span class="ident" id="7825523">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7825529">import</span>&nbsp;<span class="op" id="7825536">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825539">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825548">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825555">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825564">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825579">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825585">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825598">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825611">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825617">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825628">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7825638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7825641">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7825715">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7825793">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7825854">func</span>&nbsp;<span class="ident" id="7825859">TestDecodeProgressive</span><span class="op" id="7825880">(</span><span class="ident" id="7825881">t</span>&nbsp;<span class="op" id="7825883">*</span><span class="ident" id="7825884">testing</span><span class="op" id="7825891">.</span><span class="ident" id="7825892">T</span><span class="op" id="7825893">)</span>&nbsp;<span class="op" id="7825895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7825898">testCases</span>&nbsp;<span class="op" id="7825908">:=</span>&nbsp;<span class="op" id="7825911">[</span><span class="op" id="7825912">]</span><span class="builtintype" id="7825913">string</span><span class="op" id="7825919">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825923">&#34;../testdata/video-001&#34;</span><span class="op" id="7825946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825950">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7825981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7825985">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7826016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7826020">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7826051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7826055">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7826086">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7826090">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7826122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7826126">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7826162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7826166">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7826213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7826216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826219">for</span>&nbsp;<span class="ident" id="7826223">_</span><span class="op" id="7826224">,</span>&nbsp;<span class="ident" id="7826226">tc</span>&nbsp;<span class="op" id="7826229">:=</span>&nbsp;<span class="keyword" id="7826232">range</span>&nbsp;<span class="ident" id="7826238">testCases</span>&nbsp;<span class="op" id="7826248">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826252">m0</span><span class="op" id="7826254">,</span>&nbsp;<span class="ident" id="7826256">err</span>&nbsp;<span class="op" id="7826260">:=</span>&nbsp;<span class="ident" id="7826263">decodeFile</span><span class="op" id="7826273">(</span><span class="ident" id="7826274">tc</span>&nbsp;<span class="op" id="7826277">+</span>&nbsp;<span class="string" id="7826279">&#34;.jpeg&#34;</span><span class="op" id="7826286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826290">if</span>&nbsp;<span class="ident" id="7826293">err</span>&nbsp;<span class="op" id="7826297">!=</span>&nbsp;<span class="builtintype" id="7826300">nil</span>&nbsp;<span class="op" id="7826304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826309">t</span><span class="op" id="7826310">.</span><span class="ident" id="7826311">Errorf</span><span class="op" id="7826317">(</span><span class="string" id="7826318">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7826326">,</span>&nbsp;<span class="ident" id="7826328">tc</span><span class="op" id="7826330">+</span><span class="string" id="7826331">&#34;.jpeg&#34;</span><span class="op" id="7826338">,</span>&nbsp;<span class="ident" id="7826340">err</span><span class="op" id="7826343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826348">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7826359">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826363">m1</span><span class="op" id="7826365">,</span>&nbsp;<span class="ident" id="7826367">err</span>&nbsp;<span class="op" id="7826371">:=</span>&nbsp;<span class="ident" id="7826374">decodeFile</span><span class="op" id="7826384">(</span><span class="ident" id="7826385">tc</span>&nbsp;<span class="op" id="7826388">+</span>&nbsp;<span class="string" id="7826390">&#34;.progressive.jpeg&#34;</span><span class="op" id="7826409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826413">if</span>&nbsp;<span class="ident" id="7826416">err</span>&nbsp;<span class="op" id="7826420">!=</span>&nbsp;<span class="builtintype" id="7826423">nil</span>&nbsp;<span class="op" id="7826427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826432">t</span><span class="op" id="7826433">.</span><span class="ident" id="7826434">Errorf</span><span class="op" id="7826440">(</span><span class="string" id="7826441">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7826449">,</span>&nbsp;<span class="ident" id="7826451">tc</span><span class="op" id="7826453">+</span><span class="string" id="7826454">&#34;.progressive.jpeg&#34;</span><span class="op" id="7826473">,</span>&nbsp;<span class="ident" id="7826475">err</span><span class="op" id="7826478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826483">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7826494">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826498">if</span>&nbsp;<span class="ident" id="7826501">m0</span><span class="op" id="7826503">.</span><span class="ident" id="7826504">Bounds</span><span class="op" id="7826510">(</span><span class="op" id="7826511">)</span>&nbsp;<span class="op" id="7826513">!=</span>&nbsp;<span class="ident" id="7826516">m1</span><span class="op" id="7826518">.</span><span class="ident" id="7826519">Bounds</span><span class="op" id="7826525">(</span><span class="op" id="7826526">)</span>&nbsp;<span class="op" id="7826528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826533">t</span><span class="op" id="7826534">.</span><span class="ident" id="7826535">Errorf</span><span class="op" id="7826541">(</span><span class="string" id="7826542">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7826572">,</span>&nbsp;<span class="ident" id="7826574">tc</span><span class="op" id="7826576">,</span>&nbsp;<span class="ident" id="7826578">m0</span><span class="op" id="7826580">.</span><span class="ident" id="7826581">Bounds</span><span class="op" id="7826587">(</span><span class="op" id="7826588">)</span><span class="op" id="7826589">,</span>&nbsp;<span class="ident" id="7826591">m1</span><span class="op" id="7826593">.</span><span class="ident" id="7826594">Bounds</span><span class="op" id="7826600">(</span><span class="op" id="7826601">)</span><span class="op" id="7826602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826607">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7826618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7826622">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826670">if</span>&nbsp;<span class="ident" id="7826673">m0</span><span class="op" id="7826675">.</span><span class="ident" id="7826676">Bounds</span><span class="op" id="7826682">(</span><span class="op" id="7826683">)</span>&nbsp;<span class="op" id="7826685">!=</span>&nbsp;<span class="ident" id="7826688">image</span><span class="op" id="7826693">.</span><span class="ident" id="7826694">Rect</span><span class="op" id="7826698">(</span><span class="num" id="7826699">0</span><span class="op" id="7826700">,</span>&nbsp;<span class="num" id="7826702">0</span><span class="op" id="7826703">,</span>&nbsp;<span class="num" id="7826705">150</span><span class="op" id="7826708">,</span>&nbsp;<span class="num" id="7826710">103</span><span class="op" id="7826713">)</span>&nbsp;<span class="op" id="7826715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826720">t</span><span class="op" id="7826721">.</span><span class="ident" id="7826722">Errorf</span><span class="op" id="7826728">(</span><span class="string" id="7826729">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7826749">,</span>&nbsp;<span class="ident" id="7826751">tc</span><span class="op" id="7826753">,</span>&nbsp;<span class="ident" id="7826755">m0</span><span class="op" id="7826757">.</span><span class="ident" id="7826758">Bounds</span><span class="op" id="7826764">(</span><span class="op" id="7826765">)</span><span class="op" id="7826766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826771">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7826782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826787">switch</span>&nbsp;<span class="ident" id="7826794">m0</span>&nbsp;<span class="op" id="7826797">:=</span>&nbsp;<span class="ident" id="7826800">m0</span><span class="op" id="7826802">.</span><span class="op" id="7826803">(</span><span class="keyword" id="7826804">type</span><span class="op" id="7826808">)</span>&nbsp;<span class="op" id="7826810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826814">case</span>&nbsp;<span class="op" id="7826819">*</span><span class="ident" id="7826820">image</span><span class="op" id="7826825">.</span><span class="ident" id="7826826">YCbCr</span><span class="op" id="7826831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826836">m1</span>&nbsp;<span class="op" id="7826839">:=</span>&nbsp;<span class="ident" id="7826842">m1</span><span class="op" id="7826844">.</span><span class="op" id="7826845">(</span><span class="op" id="7826846">*</span><span class="ident" id="7826847">image</span><span class="op" id="7826852">.</span><span class="ident" id="7826853">YCbCr</span><span class="op" id="7826858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826863">if</span>&nbsp;<span class="ident" id="7826866">err</span>&nbsp;<span class="op" id="7826870">:=</span>&nbsp;<span class="ident" id="7826873">check</span><span class="op" id="7826878">(</span><span class="ident" id="7826879">m0</span><span class="op" id="7826881">.</span><span class="ident" id="7826882">Bounds</span><span class="op" id="7826888">(</span><span class="op" id="7826889">)</span><span class="op" id="7826890">,</span>&nbsp;<span class="ident" id="7826892">m0</span><span class="op" id="7826894">.</span><span class="ident" id="7826895">Y</span><span class="op" id="7826896">,</span>&nbsp;<span class="ident" id="7826898">m1</span><span class="op" id="7826900">.</span><span class="ident" id="7826901">Y</span><span class="op" id="7826902">,</span>&nbsp;<span class="ident" id="7826904">m0</span><span class="op" id="7826906">.</span><span class="ident" id="7826907">YStride</span><span class="op" id="7826914">,</span>&nbsp;<span class="ident" id="7826916">m1</span><span class="op" id="7826918">.</span><span class="ident" id="7826919">YStride</span><span class="op" id="7826926">)</span><span class="op" id="7826927">;</span>&nbsp;<span class="ident" id="7826929">err</span>&nbsp;<span class="op" id="7826933">!=</span>&nbsp;<span class="builtintype" id="7826936">nil</span>&nbsp;<span class="op" id="7826940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7826946">t</span><span class="op" id="7826947">.</span><span class="ident" id="7826948">Errorf</span><span class="op" id="7826954">(</span><span class="string" id="7826955">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7826967">,</span>&nbsp;<span class="ident" id="7826969">tc</span><span class="op" id="7826971">,</span>&nbsp;<span class="ident" id="7826973">err</span><span class="op" id="7826976">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826982">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7826994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7826999">if</span>&nbsp;<span class="ident" id="7827002">err</span>&nbsp;<span class="op" id="7827006">:=</span>&nbsp;<span class="ident" id="7827009">check</span><span class="op" id="7827014">(</span><span class="ident" id="7827015">m0</span><span class="op" id="7827017">.</span><span class="ident" id="7827018">Bounds</span><span class="op" id="7827024">(</span><span class="op" id="7827025">)</span><span class="op" id="7827026">,</span>&nbsp;<span class="ident" id="7827028">m0</span><span class="op" id="7827030">.</span><span class="ident" id="7827031">Cb</span><span class="op" id="7827033">,</span>&nbsp;<span class="ident" id="7827035">m1</span><span class="op" id="7827037">.</span><span class="ident" id="7827038">Cb</span><span class="op" id="7827040">,</span>&nbsp;<span class="ident" id="7827042">m0</span><span class="op" id="7827044">.</span><span class="ident" id="7827045">CStride</span><span class="op" id="7827052">,</span>&nbsp;<span class="ident" id="7827054">m1</span><span class="op" id="7827056">.</span><span class="ident" id="7827057">CStride</span><span class="op" id="7827064">)</span><span class="op" id="7827065">;</span>&nbsp;<span class="ident" id="7827067">err</span>&nbsp;<span class="op" id="7827071">!=</span>&nbsp;<span class="builtintype" id="7827074">nil</span>&nbsp;<span class="op" id="7827078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827084">t</span><span class="op" id="7827085">.</span><span class="ident" id="7827086">Errorf</span><span class="op" id="7827092">(</span><span class="string" id="7827093">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7827106">,</span>&nbsp;<span class="ident" id="7827108">tc</span><span class="op" id="7827110">,</span>&nbsp;<span class="ident" id="7827112">err</span><span class="op" id="7827115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827121">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827138">if</span>&nbsp;<span class="ident" id="7827141">err</span>&nbsp;<span class="op" id="7827145">:=</span>&nbsp;<span class="ident" id="7827148">check</span><span class="op" id="7827153">(</span><span class="ident" id="7827154">m0</span><span class="op" id="7827156">.</span><span class="ident" id="7827157">Bounds</span><span class="op" id="7827163">(</span><span class="op" id="7827164">)</span><span class="op" id="7827165">,</span>&nbsp;<span class="ident" id="7827167">m0</span><span class="op" id="7827169">.</span><span class="ident" id="7827170">Cr</span><span class="op" id="7827172">,</span>&nbsp;<span class="ident" id="7827174">m1</span><span class="op" id="7827176">.</span><span class="ident" id="7827177">Cr</span><span class="op" id="7827179">,</span>&nbsp;<span class="ident" id="7827181">m0</span><span class="op" id="7827183">.</span><span class="ident" id="7827184">CStride</span><span class="op" id="7827191">,</span>&nbsp;<span class="ident" id="7827193">m1</span><span class="op" id="7827195">.</span><span class="ident" id="7827196">CStride</span><span class="op" id="7827203">)</span><span class="op" id="7827204">;</span>&nbsp;<span class="ident" id="7827206">err</span>&nbsp;<span class="op" id="7827210">!=</span>&nbsp;<span class="builtintype" id="7827213">nil</span>&nbsp;<span class="op" id="7827217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827223">t</span><span class="op" id="7827224">.</span><span class="ident" id="7827225">Errorf</span><span class="op" id="7827231">(</span><span class="string" id="7827232">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7827245">,</span>&nbsp;<span class="ident" id="7827247">tc</span><span class="op" id="7827249">,</span>&nbsp;<span class="ident" id="7827251">err</span><span class="op" id="7827254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827260">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827272">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827276">case</span>&nbsp;<span class="op" id="7827281">*</span><span class="ident" id="7827282">image</span><span class="op" id="7827287">.</span><span class="ident" id="7827288">Gray</span><span class="op" id="7827292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827297">m1</span>&nbsp;<span class="op" id="7827300">:=</span>&nbsp;<span class="ident" id="7827303">m1</span><span class="op" id="7827305">.</span><span class="op" id="7827306">(</span><span class="op" id="7827307">*</span><span class="ident" id="7827308">image</span><span class="op" id="7827313">.</span><span class="ident" id="7827314">Gray</span><span class="op" id="7827318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827323">if</span>&nbsp;<span class="ident" id="7827326">err</span>&nbsp;<span class="op" id="7827330">:=</span>&nbsp;<span class="ident" id="7827333">check</span><span class="op" id="7827338">(</span><span class="ident" id="7827339">m0</span><span class="op" id="7827341">.</span><span class="ident" id="7827342">Bounds</span><span class="op" id="7827348">(</span><span class="op" id="7827349">)</span><span class="op" id="7827350">,</span>&nbsp;<span class="ident" id="7827352">m0</span><span class="op" id="7827354">.</span><span class="ident" id="7827355">Pix</span><span class="op" id="7827358">,</span>&nbsp;<span class="ident" id="7827360">m1</span><span class="op" id="7827362">.</span><span class="ident" id="7827363">Pix</span><span class="op" id="7827366">,</span>&nbsp;<span class="ident" id="7827368">m0</span><span class="op" id="7827370">.</span><span class="ident" id="7827371">Stride</span><span class="op" id="7827377">,</span>&nbsp;<span class="ident" id="7827379">m1</span><span class="op" id="7827381">.</span><span class="ident" id="7827382">Stride</span><span class="op" id="7827388">)</span><span class="op" id="7827389">;</span>&nbsp;<span class="ident" id="7827391">err</span>&nbsp;<span class="op" id="7827395">!=</span>&nbsp;<span class="builtintype" id="7827398">nil</span>&nbsp;<span class="op" id="7827402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827408">t</span><span class="op" id="7827409">.</span><span class="ident" id="7827410">Errorf</span><span class="op" id="7827416">(</span><span class="string" id="7827417">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7827425">,</span>&nbsp;<span class="ident" id="7827427">tc</span><span class="op" id="7827429">,</span>&nbsp;<span class="ident" id="7827431">err</span><span class="op" id="7827434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827440">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827456">default</span><span class="op" id="7827463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827468">t</span><span class="op" id="7827469">.</span><span class="ident" id="7827470">Errorf</span><span class="op" id="7827476">(</span><span class="string" id="7827477">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7827507">,</span>&nbsp;<span class="ident" id="7827509">tc</span><span class="op" id="7827511">,</span>&nbsp;<span class="ident" id="7827513">m0</span><span class="op" id="7827515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827520">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827531">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827534">}</span><br>
<span class="lineno"></span><span class="op" id="7827536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7827539">func</span>&nbsp;<span class="ident" id="7827544">decodeFile</span><span class="op" id="7827554">(</span><span class="ident" id="7827555">filename</span>&nbsp;<span class="builtintype" id="7827564">string</span><span class="op" id="7827570">)</span>&nbsp;<span class="op" id="7827572">(</span><span class="ident" id="7827573">image</span><span class="op" id="7827578">.</span><span class="ident" id="7827579">Image</span><span class="op" id="7827584">,</span>&nbsp;<span class="builtintype" id="7827586">error</span><span class="op" id="7827591">)</span>&nbsp;<span class="op" id="7827593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827596">f</span><span class="op" id="7827597">,</span>&nbsp;<span class="ident" id="7827599">err</span>&nbsp;<span class="op" id="7827603">:=</span>&nbsp;<span class="ident" id="7827606">os</span><span class="op" id="7827608">.</span><span class="ident" id="7827609">Open</span><span class="op" id="7827613">(</span><span class="ident" id="7827614">filename</span><span class="op" id="7827622">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827625">if</span>&nbsp;<span class="ident" id="7827628">err</span>&nbsp;<span class="op" id="7827632">!=</span>&nbsp;<span class="builtintype" id="7827635">nil</span>&nbsp;<span class="op" id="7827639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827643">return</span>&nbsp;<span class="builtintype" id="7827650">nil</span><span class="op" id="7827653">,</span>&nbsp;<span class="ident" id="7827655">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827663">defer</span>&nbsp;<span class="ident" id="7827669">f</span><span class="op" id="7827670">.</span><span class="ident" id="7827671">Close</span><span class="op" id="7827676">(</span><span class="op" id="7827677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827680">return</span>&nbsp;<span class="ident" id="7827687">Decode</span><span class="op" id="7827693">(</span><span class="ident" id="7827694">f</span><span class="op" id="7827695">)</span><br>
<span class="lineno">90</span><span class="op" id="7827697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7827700">type</span>&nbsp;<span class="ident" id="7827705">eofReader</span>&nbsp;<span class="keyword" id="7827715">struct</span>&nbsp;<span class="op" id="7827722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827725">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827734">[</span><span class="op" id="7827735">]</span><span class="builtintype" id="7827736">byte</span>&nbsp;<span class="comment" id="7827741">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827775">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7827784">[</span><span class="op" id="7827785">]</span><span class="builtintype" id="7827786">byte</span>&nbsp;<span class="comment" id="7827791">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827841">lenAtEOF</span>&nbsp;<span class="builtintype" id="7827850">int</span><br>
<span class="lineno"></span><span class="op" id="7827854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7827857">func</span>&nbsp;<span class="op" id="7827862">(</span><span class="ident" id="7827863">r</span>&nbsp;<span class="op" id="7827865">*</span><span class="ident" id="7827866">eofReader</span><span class="op" id="7827875">)</span>&nbsp;<span class="ident" id="7827877">Read</span><span class="op" id="7827881">(</span><span class="ident" id="7827882">b</span>&nbsp;<span class="op" id="7827884">[</span><span class="op" id="7827885">]</span><span class="builtintype" id="7827886">byte</span><span class="op" id="7827890">)</span>&nbsp;<span class="op" id="7827892">(</span><span class="ident" id="7827893">n</span>&nbsp;<span class="builtintype" id="7827895">int</span><span class="op" id="7827898">,</span>&nbsp;<span class="ident" id="7827900">err</span>&nbsp;<span class="builtintype" id="7827904">error</span><span class="op" id="7827909">)</span>&nbsp;<span class="op" id="7827911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7827914">if</span>&nbsp;<span class="builtinfunc" id="7827917">len</span><span class="op" id="7827920">(</span><span class="ident" id="7827921">r</span><span class="op" id="7827922">.</span><span class="ident" id="7827923">data</span><span class="op" id="7827927">)</span>&nbsp;<span class="op" id="7827929">&gt;</span>&nbsp;<span class="num" id="7827931">0</span>&nbsp;<span class="op" id="7827933">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827937">n</span>&nbsp;<span class="op" id="7827939">=</span>&nbsp;<span class="builtinfunc" id="7827941">copy</span><span class="op" id="7827945">(</span><span class="ident" id="7827946">b</span><span class="op" id="7827947">,</span>&nbsp;<span class="ident" id="7827949">r</span><span class="op" id="7827950">.</span><span class="ident" id="7827951">data</span><span class="op" id="7827955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827959">r</span><span class="op" id="7827960">.</span><span class="ident" id="7827961">data</span>&nbsp;<span class="op" id="7827966">=</span>&nbsp;<span class="ident" id="7827968">r</span><span class="op" id="7827969">.</span><span class="ident" id="7827970">data</span><span class="op" id="7827974">[</span><span class="ident" id="7827975">n</span><span class="op" id="7827976">:</span><span class="op" id="7827977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7827980">}</span>&nbsp;<span class="keyword" id="7827982">else</span>&nbsp;<span class="op" id="7827987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7827991">n</span>&nbsp;<span class="op" id="7827993">=</span>&nbsp;<span class="builtinfunc" id="7827995">copy</span><span class="op" id="7827999">(</span><span class="ident" id="7828000">b</span><span class="op" id="7828001">,</span>&nbsp;<span class="ident" id="7828003">r</span><span class="op" id="7828004">.</span><span class="ident" id="7828005">dataEOF</span><span class="op" id="7828012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828016">r</span><span class="op" id="7828017">.</span><span class="ident" id="7828018">dataEOF</span>&nbsp;<span class="op" id="7828026">=</span>&nbsp;<span class="ident" id="7828028">r</span><span class="op" id="7828029">.</span><span class="ident" id="7828030">dataEOF</span><span class="op" id="7828037">[</span><span class="ident" id="7828038">n</span><span class="op" id="7828039">:</span><span class="op" id="7828040">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828044">if</span>&nbsp;<span class="builtinfunc" id="7828047">len</span><span class="op" id="7828050">(</span><span class="ident" id="7828051">r</span><span class="op" id="7828052">.</span><span class="ident" id="7828053">dataEOF</span><span class="op" id="7828060">)</span>&nbsp;<span class="op" id="7828062">==</span>&nbsp;<span class="num" id="7828065">0</span>&nbsp;<span class="op" id="7828067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828072">err</span>&nbsp;<span class="op" id="7828076">=</span>&nbsp;<span class="ident" id="7828078">io</span><span class="op" id="7828080">.</span><span class="ident" id="7828081">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828088">if</span>&nbsp;<span class="ident" id="7828091">r</span><span class="op" id="7828092">.</span><span class="ident" id="7828093">lenAtEOF</span>&nbsp;<span class="op" id="7828102">==</span>&nbsp;<span class="op" id="7828105">-</span><span class="num" id="7828106">1</span>&nbsp;<span class="op" id="7828108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828114">r</span><span class="op" id="7828115">.</span><span class="ident" id="7828116">lenAtEOF</span>&nbsp;<span class="op" id="7828125">=</span>&nbsp;<span class="ident" id="7828127">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828132">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828142">return</span><br>
<span class="lineno"></span><span class="op" id="7828149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7828152">func</span>&nbsp;<span class="ident" id="7828157">TestDecodeEOF</span><span class="op" id="7828170">(</span><span class="ident" id="7828171">t</span>&nbsp;<span class="op" id="7828173">*</span><span class="ident" id="7828174">testing</span><span class="op" id="7828181">.</span><span class="ident" id="7828182">T</span><span class="op" id="7828183">)</span>&nbsp;<span class="op" id="7828185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7828188">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828271">data</span><span class="op" id="7828275">,</span>&nbsp;<span class="ident" id="7828277">err</span>&nbsp;<span class="op" id="7828281">:=</span>&nbsp;<span class="ident" id="7828284">ioutil</span><span class="op" id="7828290">.</span><span class="ident" id="7828291">ReadFile</span><span class="op" id="7828299">(</span><span class="string" id="7828300">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7828328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828331">if</span>&nbsp;<span class="ident" id="7828334">err</span>&nbsp;<span class="op" id="7828338">!=</span>&nbsp;<span class="builtintype" id="7828341">nil</span>&nbsp;<span class="op" id="7828345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828349">t</span><span class="op" id="7828350">.</span><span class="ident" id="7828351">Fatal</span><span class="op" id="7828356">(</span><span class="ident" id="7828357">err</span><span class="op" id="7828360">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828367">n</span>&nbsp;<span class="op" id="7828369">:=</span>&nbsp;<span class="builtinfunc" id="7828372">len</span><span class="op" id="7828375">(</span><span class="ident" id="7828376">data</span><span class="op" id="7828380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828383">for</span>&nbsp;<span class="ident" id="7828387">i</span>&nbsp;<span class="op" id="7828389">:=</span>&nbsp;<span class="num" id="7828392">0</span><span class="op" id="7828393">;</span>&nbsp;<span class="ident" id="7828395">i</span>&nbsp;<span class="op" id="7828397">&lt;</span>&nbsp;<span class="ident" id="7828399">n</span><span class="op" id="7828400">;</span>&nbsp;<span class="op" id="7828402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828406">r</span>&nbsp;<span class="op" id="7828408">:=</span>&nbsp;<span class="op" id="7828411">&amp;</span><span class="ident" id="7828412">eofReader</span><span class="op" id="7828421">{</span><span class="ident" id="7828422">data</span><span class="op" id="7828426">[</span><span class="op" id="7828427">:</span><span class="ident" id="7828428">n</span><span class="op" id="7828429">-</span><span class="ident" id="7828430">i</span><span class="op" id="7828431">]</span><span class="op" id="7828432">,</span>&nbsp;<span class="ident" id="7828434">data</span><span class="op" id="7828438">[</span><span class="ident" id="7828439">n</span><span class="op" id="7828440">-</span><span class="ident" id="7828441">i</span><span class="op" id="7828442">:</span><span class="op" id="7828443">]</span><span class="op" id="7828444">,</span>&nbsp;<span class="op" id="7828446">-</span><span class="num" id="7828447">1</span><span class="op" id="7828448">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828452">_</span><span class="op" id="7828453">,</span>&nbsp;<span class="ident" id="7828455">err</span>&nbsp;<span class="op" id="7828459">:=</span>&nbsp;<span class="ident" id="7828462">Decode</span><span class="op" id="7828468">(</span><span class="ident" id="7828469">r</span><span class="op" id="7828470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828474">if</span>&nbsp;<span class="ident" id="7828477">err</span>&nbsp;<span class="op" id="7828481">!=</span>&nbsp;<span class="builtintype" id="7828484">nil</span>&nbsp;<span class="op" id="7828488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828493">t</span><span class="op" id="7828494">.</span><span class="ident" id="7828495">Errorf</span><span class="op" id="7828501">(</span><span class="string" id="7828502">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7828536">,</span>&nbsp;<span class="ident" id="7828538">r</span><span class="op" id="7828539">.</span><span class="ident" id="7828540">lenAtEOF</span><span class="op" id="7828548">,</span>&nbsp;<span class="ident" id="7828550">err</span><span class="op" id="7828553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828561">if</span>&nbsp;<span class="ident" id="7828564">i</span>&nbsp;<span class="op" id="7828566">==</span>&nbsp;<span class="num" id="7828569">0</span>&nbsp;<span class="op" id="7828571">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828576">i</span>&nbsp;<span class="op" id="7828578">=</span>&nbsp;<span class="num" id="7828580">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828584">}</span>&nbsp;<span class="keyword" id="7828586">else</span>&nbsp;<span class="op" id="7828591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7828596">i</span>&nbsp;<span class="op" id="7828598">*=</span>&nbsp;<span class="num" id="7828601">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828608">}</span><br>
<span class="lineno">135</span><span class="op" id="7828610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7828613">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7828687">func</span>&nbsp;<span class="ident" id="7828692">check</span><span class="op" id="7828697">(</span><span class="ident" id="7828698">bounds</span>&nbsp;<span class="ident" id="7828705">image</span><span class="op" id="7828710">.</span><span class="ident" id="7828711">Rectangle</span><span class="op" id="7828720">,</span>&nbsp;<span class="ident" id="7828722">pix0</span><span class="op" id="7828726">,</span>&nbsp;<span class="ident" id="7828728">pix1</span>&nbsp;<span class="op" id="7828733">[</span><span class="op" id="7828734">]</span><span class="builtintype" id="7828735">byte</span><span class="op" id="7828739">,</span>&nbsp;<span class="ident" id="7828741">stride0</span><span class="op" id="7828748">,</span>&nbsp;<span class="ident" id="7828750">stride1</span>&nbsp;<span class="builtintype" id="7828758">int</span><span class="op" id="7828761">)</span>&nbsp;<span class="builtintype" id="7828763">error</span>&nbsp;<span class="op" id="7828769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828772">if</span>&nbsp;<span class="ident" id="7828775">stride0</span>&nbsp;<span class="op" id="7828783">&lt;=</span>&nbsp;<span class="num" id="7828786">0</span>&nbsp;<span class="op" id="7828788">||</span>&nbsp;<span class="ident" id="7828791">stride0</span><span class="op" id="7828798">%</span><span class="num" id="7828799">8</span>&nbsp;<span class="op" id="7828801">!=</span>&nbsp;<span class="num" id="7828804">0</span>&nbsp;<span class="op" id="7828806">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828810">return</span>&nbsp;<span class="ident" id="7828817">fmt</span><span class="op" id="7828820">.</span><span class="ident" id="7828821">Errorf</span><span class="op" id="7828827">(</span><span class="string" id="7828828">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7828843">,</span>&nbsp;<span class="ident" id="7828845">stride0</span><span class="op" id="7828852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828858">if</span>&nbsp;<span class="ident" id="7828861">stride1</span>&nbsp;<span class="op" id="7828869">&lt;=</span>&nbsp;<span class="num" id="7828872">0</span>&nbsp;<span class="op" id="7828874">||</span>&nbsp;<span class="ident" id="7828877">stride1</span><span class="op" id="7828884">%</span><span class="num" id="7828885">8</span>&nbsp;<span class="op" id="7828887">!=</span>&nbsp;<span class="num" id="7828890">0</span>&nbsp;<span class="op" id="7828892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828896">return</span>&nbsp;<span class="ident" id="7828903">fmt</span><span class="op" id="7828906">.</span><span class="ident" id="7828907">Errorf</span><span class="op" id="7828913">(</span><span class="string" id="7828914">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7828929">,</span>&nbsp;<span class="ident" id="7828931">stride1</span><span class="op" id="7828938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7828941">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7828944">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7828999">for</span>&nbsp;<span class="ident" id="7829003">y</span>&nbsp;<span class="op" id="7829005">:=</span>&nbsp;<span class="num" id="7829008">0</span><span class="op" id="7829009">;</span>&nbsp;<span class="ident" id="7829011">y</span>&nbsp;<span class="op" id="7829013">&lt;</span>&nbsp;<span class="builtinfunc" id="7829015">len</span><span class="op" id="7829018">(</span><span class="ident" id="7829019">pix0</span><span class="op" id="7829023">)</span><span class="op" id="7829024">/</span><span class="ident" id="7829025">stride0</span>&nbsp;<span class="op" id="7829033">&amp;&amp;</span>&nbsp;<span class="ident" id="7829036">y</span>&nbsp;<span class="op" id="7829038">&lt;</span>&nbsp;<span class="builtinfunc" id="7829040">len</span><span class="op" id="7829043">(</span><span class="ident" id="7829044">pix1</span><span class="op" id="7829048">)</span><span class="op" id="7829049">/</span><span class="ident" id="7829050">stride1</span><span class="op" id="7829057">;</span>&nbsp;<span class="ident" id="7829059">y</span>&nbsp;<span class="op" id="7829061">+=</span>&nbsp;<span class="num" id="7829064">8</span>&nbsp;<span class="op" id="7829066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829070">for</span>&nbsp;<span class="ident" id="7829074">x</span>&nbsp;<span class="op" id="7829076">:=</span>&nbsp;<span class="num" id="7829079">0</span><span class="op" id="7829080">;</span>&nbsp;<span class="ident" id="7829082">x</span>&nbsp;<span class="op" id="7829084">&lt;</span>&nbsp;<span class="ident" id="7829086">stride0</span>&nbsp;<span class="op" id="7829094">&amp;&amp;</span>&nbsp;<span class="ident" id="7829097">x</span>&nbsp;<span class="op" id="7829099">&lt;</span>&nbsp;<span class="ident" id="7829101">stride1</span><span class="op" id="7829108">;</span>&nbsp;<span class="ident" id="7829110">x</span>&nbsp;<span class="op" id="7829112">+=</span>&nbsp;<span class="num" id="7829115">8</span>&nbsp;<span class="op" id="7829117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829122">if</span>&nbsp;<span class="ident" id="7829125">x</span>&nbsp;<span class="op" id="7829127">&gt;=</span>&nbsp;<span class="ident" id="7829130">bounds</span><span class="op" id="7829136">.</span><span class="ident" id="7829137">Max</span><span class="op" id="7829140">.</span><span class="ident" id="7829141">X</span>&nbsp;<span class="op" id="7829143">||</span>&nbsp;<span class="ident" id="7829146">y</span>&nbsp;<span class="op" id="7829148">&gt;=</span>&nbsp;<span class="ident" id="7829151">bounds</span><span class="op" id="7829157">.</span><span class="ident" id="7829158">Max</span><span class="op" id="7829161">.</span><span class="ident" id="7829162">Y</span>&nbsp;<span class="op" id="7829164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7829170">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7829238">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7829307">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7829378">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7829445">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7829513">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829581">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829599">for</span>&nbsp;<span class="ident" id="7829603">j</span>&nbsp;<span class="op" id="7829605">:=</span>&nbsp;<span class="num" id="7829608">0</span><span class="op" id="7829609">;</span>&nbsp;<span class="ident" id="7829611">j</span>&nbsp;<span class="op" id="7829613">&lt;</span>&nbsp;<span class="num" id="7829615">8</span><span class="op" id="7829616">;</span>&nbsp;<span class="ident" id="7829618">j</span><span class="op" id="7829619">++</span>&nbsp;<span class="op" id="7829622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829628">for</span>&nbsp;<span class="ident" id="7829632">i</span>&nbsp;<span class="op" id="7829634">:=</span>&nbsp;<span class="num" id="7829637">0</span><span class="op" id="7829638">;</span>&nbsp;<span class="ident" id="7829640">i</span>&nbsp;<span class="op" id="7829642">&lt;</span>&nbsp;<span class="num" id="7829644">8</span><span class="op" id="7829645">;</span>&nbsp;<span class="ident" id="7829647">i</span><span class="op" id="7829648">++</span>&nbsp;<span class="op" id="7829651">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7829658">index0</span>&nbsp;<span class="op" id="7829665">:=</span>&nbsp;<span class="op" id="7829668">(</span><span class="ident" id="7829669">y</span><span class="op" id="7829670">+</span><span class="ident" id="7829671">j</span><span class="op" id="7829672">)</span><span class="op" id="7829673">*</span><span class="ident" id="7829674">stride0</span>&nbsp;<span class="op" id="7829682">+</span>&nbsp;<span class="op" id="7829684">(</span><span class="ident" id="7829685">x</span>&nbsp;<span class="op" id="7829687">+</span>&nbsp;<span class="ident" id="7829689">i</span><span class="op" id="7829690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7829697">index1</span>&nbsp;<span class="op" id="7829704">:=</span>&nbsp;<span class="op" id="7829707">(</span><span class="ident" id="7829708">y</span><span class="op" id="7829709">+</span><span class="ident" id="7829710">j</span><span class="op" id="7829711">)</span><span class="op" id="7829712">*</span><span class="ident" id="7829713">stride1</span>&nbsp;<span class="op" id="7829721">+</span>&nbsp;<span class="op" id="7829723">(</span><span class="ident" id="7829724">x</span>&nbsp;<span class="op" id="7829726">+</span>&nbsp;<span class="ident" id="7829728">i</span><span class="op" id="7829729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829736">if</span>&nbsp;<span class="ident" id="7829739">pix0</span><span class="op" id="7829743">[</span><span class="ident" id="7829744">index0</span><span class="op" id="7829750">]</span>&nbsp;<span class="op" id="7829752">!=</span>&nbsp;<span class="ident" id="7829755">pix1</span><span class="op" id="7829759">[</span><span class="ident" id="7829760">index1</span><span class="op" id="7829766">]</span>&nbsp;<span class="op" id="7829768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829776">return</span>&nbsp;<span class="ident" id="7829783">fmt</span><span class="op" id="7829786">.</span><span class="ident" id="7829787">Errorf</span><span class="op" id="7829793">(</span><span class="string" id="7829794">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7829833">,</span>&nbsp;<span class="ident" id="7829835">x</span><span class="op" id="7829836">,</span>&nbsp;<span class="ident" id="7829838">y</span><span class="op" id="7829839">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7829848">pixString</span><span class="op" id="7829857">(</span><span class="ident" id="7829858">pix0</span><span class="op" id="7829862">,</span>&nbsp;<span class="ident" id="7829864">stride0</span><span class="op" id="7829871">,</span>&nbsp;<span class="ident" id="7829873">x</span><span class="op" id="7829874">,</span>&nbsp;<span class="ident" id="7829876">y</span><span class="op" id="7829877">)</span><span class="op" id="7829878">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7829887">pixString</span><span class="op" id="7829896">(</span><span class="ident" id="7829897">pix1</span><span class="op" id="7829901">,</span>&nbsp;<span class="ident" id="7829903">stride1</span><span class="op" id="7829910">,</span>&nbsp;<span class="ident" id="7829912">x</span><span class="op" id="7829913">,</span>&nbsp;<span class="ident" id="7829915">y</span><span class="op" id="7829916">)</span><span class="op" id="7829917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829943">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7829950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7829953">return</span>&nbsp;<span class="builtintype" id="7829960">nil</span><br>
<span class="lineno"></span><span class="op" id="7829964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7829967">func</span>&nbsp;<span class="ident" id="7829972">pixString</span><span class="op" id="7829981">(</span><span class="ident" id="7829982">pix</span>&nbsp;<span class="op" id="7829986">[</span><span class="op" id="7829987">]</span><span class="builtintype" id="7829988">byte</span><span class="op" id="7829992">,</span>&nbsp;<span class="ident" id="7829994">stride</span><span class="op" id="7830000">,</span>&nbsp;<span class="ident" id="7830002">x</span><span class="op" id="7830003">,</span>&nbsp;<span class="ident" id="7830005">y</span>&nbsp;<span class="builtintype" id="7830007">int</span><span class="op" id="7830010">)</span>&nbsp;<span class="builtintype" id="7830012">string</span>&nbsp;<span class="op" id="7830019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830022">s</span>&nbsp;<span class="op" id="7830024">:=</span>&nbsp;<span class="ident" id="7830027">bytes</span><span class="op" id="7830032">.</span><span class="ident" id="7830033">NewBuffer</span><span class="op" id="7830042">(</span><span class="builtintype" id="7830043">nil</span><span class="op" id="7830046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830049">for</span>&nbsp;<span class="ident" id="7830053">j</span>&nbsp;<span class="op" id="7830055">:=</span>&nbsp;<span class="num" id="7830058">0</span><span class="op" id="7830059">;</span>&nbsp;<span class="ident" id="7830061">j</span>&nbsp;<span class="op" id="7830063">&lt;</span>&nbsp;<span class="num" id="7830065">8</span><span class="op" id="7830066">;</span>&nbsp;<span class="ident" id="7830068">j</span><span class="op" id="7830069">++</span>&nbsp;<span class="op" id="7830072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830076">fmt</span><span class="op" id="7830079">.</span><span class="ident" id="7830080">Fprintf</span><span class="op" id="7830087">(</span><span class="ident" id="7830088">s</span><span class="op" id="7830089">,</span>&nbsp;<span class="string" id="7830091">&#34;\t&#34;</span><span class="op" id="7830095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830099">for</span>&nbsp;<span class="ident" id="7830103">i</span>&nbsp;<span class="op" id="7830105">:=</span>&nbsp;<span class="num" id="7830108">0</span><span class="op" id="7830109">;</span>&nbsp;<span class="ident" id="7830111">i</span>&nbsp;<span class="op" id="7830113">&lt;</span>&nbsp;<span class="num" id="7830115">8</span><span class="op" id="7830116">;</span>&nbsp;<span class="ident" id="7830118">i</span><span class="op" id="7830119">++</span>&nbsp;<span class="op" id="7830122">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830127">fmt</span><span class="op" id="7830130">.</span><span class="ident" id="7830131">Fprintf</span><span class="op" id="7830138">(</span><span class="ident" id="7830139">s</span><span class="op" id="7830140">,</span>&nbsp;<span class="string" id="7830142">&#34;%02x&nbsp;&#34;</span><span class="op" id="7830149">,</span>&nbsp;<span class="ident" id="7830151">pix</span><span class="op" id="7830154">[</span><span class="op" id="7830155">(</span><span class="ident" id="7830156">y</span><span class="op" id="7830157">+</span><span class="ident" id="7830158">j</span><span class="op" id="7830159">)</span><span class="op" id="7830160">*</span><span class="ident" id="7830161">stride</span><span class="op" id="7830167">+</span><span class="op" id="7830168">(</span><span class="ident" id="7830169">x</span><span class="op" id="7830170">+</span><span class="ident" id="7830171">i</span><span class="op" id="7830172">)</span><span class="op" id="7830173">]</span><span class="op" id="7830174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7830178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830182">fmt</span><span class="op" id="7830185">.</span><span class="ident" id="7830186">Fprintf</span><span class="op" id="7830193">(</span><span class="ident" id="7830194">s</span><span class="op" id="7830195">,</span>&nbsp;<span class="string" id="7830197">&#34;\n&#34;</span><span class="op" id="7830201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7830204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830207">return</span>&nbsp;<span class="ident" id="7830214">s</span><span class="op" id="7830215">.</span><span class="ident" id="7830216">String</span><span class="op" id="7830222">(</span><span class="op" id="7830223">)</span><br>
<span class="lineno">185</span><span class="op" id="7830225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7830228">func</span>&nbsp;<span class="ident" id="7830233">TestExtraneousData</span><span class="op" id="7830251">(</span><span class="ident" id="7830252">t</span>&nbsp;<span class="op" id="7830254">*</span><span class="ident" id="7830255">testing</span><span class="op" id="7830262">.</span><span class="ident" id="7830263">T</span><span class="op" id="7830264">)</span>&nbsp;<span class="op" id="7830266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7830269">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830297">src</span>&nbsp;<span class="op" id="7830301">:=</span>&nbsp;<span class="ident" id="7830304">image</span><span class="op" id="7830309">.</span><span class="ident" id="7830310">NewRGBA</span><span class="op" id="7830317">(</span><span class="ident" id="7830318">image</span><span class="op" id="7830323">.</span><span class="ident" id="7830324">Rect</span><span class="op" id="7830328">(</span><span class="num" id="7830329">0</span><span class="op" id="7830330">,</span>&nbsp;<span class="num" id="7830332">0</span><span class="op" id="7830333">,</span>&nbsp;<span class="num" id="7830335">1</span><span class="op" id="7830336">,</span>&nbsp;<span class="num" id="7830338">1</span><span class="op" id="7830339">)</span><span class="op" id="7830340">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830343">src</span><span class="op" id="7830346">.</span><span class="ident" id="7830347">Set</span><span class="op" id="7830350">(</span><span class="num" id="7830351">0</span><span class="op" id="7830352">,</span>&nbsp;<span class="num" id="7830354">0</span><span class="op" id="7830355">,</span>&nbsp;<span class="ident" id="7830357">color</span><span class="op" id="7830362">.</span><span class="ident" id="7830363">RGBA</span><span class="op" id="7830367">{</span><span class="num" id="7830368">0xff</span><span class="op" id="7830372">,</span>&nbsp;<span class="num" id="7830374">0x00</span><span class="op" id="7830378">,</span>&nbsp;<span class="num" id="7830380">0x00</span><span class="op" id="7830384">,</span>&nbsp;<span class="num" id="7830386">0xff</span><span class="op" id="7830390">}</span><span class="op" id="7830391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830394">buf</span>&nbsp;<span class="op" id="7830398">:=</span>&nbsp;<span class="builtinfunc" id="7830401">new</span><span class="op" id="7830404">(</span><span class="ident" id="7830405">bytes</span><span class="op" id="7830410">.</span><span class="ident" id="7830411">Buffer</span><span class="op" id="7830417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830420">if</span>&nbsp;<span class="ident" id="7830423">err</span>&nbsp;<span class="op" id="7830427">:=</span>&nbsp;<span class="ident" id="7830430">Encode</span><span class="op" id="7830436">(</span><span class="ident" id="7830437">buf</span><span class="op" id="7830440">,</span>&nbsp;<span class="ident" id="7830442">src</span><span class="op" id="7830445">,</span>&nbsp;<span class="builtintype" id="7830447">nil</span><span class="op" id="7830450">)</span><span class="op" id="7830451">;</span>&nbsp;<span class="ident" id="7830453">err</span>&nbsp;<span class="op" id="7830457">!=</span>&nbsp;<span class="builtintype" id="7830460">nil</span>&nbsp;<span class="op" id="7830464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830468">t</span><span class="op" id="7830469">.</span><span class="ident" id="7830470">Fatalf</span><span class="op" id="7830476">(</span><span class="string" id="7830477">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7830489">,</span>&nbsp;<span class="ident" id="7830491">err</span><span class="op" id="7830494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7830497">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830500">enc</span>&nbsp;<span class="op" id="7830504">:=</span>&nbsp;<span class="ident" id="7830507">buf</span><span class="op" id="7830510">.</span><span class="ident" id="7830511">String</span><span class="op" id="7830517">(</span><span class="op" id="7830518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7830521">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7830594">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7830666">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830703">if</span>&nbsp;<span class="builtinfunc" id="7830706">len</span><span class="op" id="7830709">(</span><span class="ident" id="7830710">enc</span><span class="op" id="7830713">)</span>&nbsp;<span class="op" id="7830715">&lt;</span>&nbsp;<span class="num" id="7830717">64</span>&nbsp;<span class="op" id="7830720">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830724">t</span><span class="op" id="7830725">.</span><span class="ident" id="7830726">Fatalf</span><span class="op" id="7830732">(</span><span class="string" id="7830733">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7830770">,</span>&nbsp;<span class="builtinfunc" id="7830772">len</span><span class="op" id="7830775">(</span><span class="ident" id="7830776">enc</span><span class="op" id="7830779">)</span><span class="op" id="7830780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7830783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830786">if</span>&nbsp;<span class="ident" id="7830789">got</span><span class="op" id="7830792">,</span>&nbsp;<span class="ident" id="7830794">want</span>&nbsp;<span class="op" id="7830799">:=</span>&nbsp;<span class="ident" id="7830802">enc</span><span class="op" id="7830805">[</span><span class="builtinfunc" id="7830806">len</span><span class="op" id="7830809">(</span><span class="ident" id="7830810">enc</span><span class="op" id="7830813">)</span><span class="op" id="7830814">-</span><span class="num" id="7830815">2</span><span class="op" id="7830816">:</span><span class="op" id="7830817">]</span><span class="op" id="7830818">,</span>&nbsp;<span class="string" id="7830820">&#34;\xff\xd9&#34;</span><span class="op" id="7830830">;</span>&nbsp;<span class="ident" id="7830832">got</span>&nbsp;<span class="op" id="7830836">!=</span>&nbsp;<span class="ident" id="7830839">want</span>&nbsp;<span class="op" id="7830844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830848">t</span><span class="op" id="7830849">.</span><span class="ident" id="7830850">Fatalf</span><span class="op" id="7830856">(</span><span class="string" id="7830857">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7830893">,</span>&nbsp;<span class="ident" id="7830895">got</span><span class="op" id="7830898">,</span>&nbsp;<span class="ident" id="7830900">want</span><span class="op" id="7830904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7830907">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7830910">if</span>&nbsp;<span class="ident" id="7830913">s</span>&nbsp;<span class="op" id="7830915">:=</span>&nbsp;<span class="ident" id="7830918">enc</span><span class="op" id="7830921">[</span><span class="builtinfunc" id="7830922">len</span><span class="op" id="7830925">(</span><span class="ident" id="7830926">enc</span><span class="op" id="7830929">)</span><span class="op" id="7830930">-</span><span class="num" id="7830931">64</span><span class="op" id="7830933">:</span><span class="op" id="7830934">]</span><span class="op" id="7830935">;</span>&nbsp;<span class="op" id="7830937">!</span><span class="ident" id="7830938">strings</span><span class="op" id="7830945">.</span><span class="ident" id="7830946">Contains</span><span class="op" id="7830954">(</span><span class="ident" id="7830955">s</span><span class="op" id="7830956">,</span>&nbsp;<span class="string" id="7830958">&#34;\xff\xda&#34;</span><span class="op" id="7830968">)</span>&nbsp;<span class="op" id="7830970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7830974">t</span><span class="op" id="7830975">.</span><span class="ident" id="7830976">Fatalf</span><span class="op" id="7830982">(</span><span class="string" id="7830983">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7831053">,</span>&nbsp;<span class="ident" id="7831055">s</span><span class="op" id="7831056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7831059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831062">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831131">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831176">rnd</span>&nbsp;<span class="op" id="7831180">:=</span>&nbsp;<span class="ident" id="7831183">rand</span><span class="op" id="7831187">.</span><span class="ident" id="7831188">New</span><span class="op" id="7831191">(</span><span class="ident" id="7831192">rand</span><span class="op" id="7831196">.</span><span class="ident" id="7831197">NewSource</span><span class="op" id="7831206">(</span><span class="num" id="7831207">1</span><span class="op" id="7831208">)</span><span class="op" id="7831209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7831212">for</span>&nbsp;<span class="ident" id="7831216">i</span><span class="op" id="7831217">,</span>&nbsp;<span class="ident" id="7831219">nerr</span>&nbsp;<span class="op" id="7831224">:=</span>&nbsp;<span class="num" id="7831227">0</span><span class="op" id="7831228">,</span>&nbsp;<span class="num" id="7831230">0</span><span class="op" id="7831231">;</span>&nbsp;<span class="ident" id="7831233">i</span>&nbsp;<span class="op" id="7831235">&lt;</span>&nbsp;<span class="num" id="7831237">1000</span>&nbsp;<span class="op" id="7831242">&amp;&amp;</span>&nbsp;<span class="ident" id="7831245">nerr</span>&nbsp;<span class="op" id="7831250">&lt;</span>&nbsp;<span class="num" id="7831252">10</span><span class="op" id="7831254">;</span>&nbsp;<span class="ident" id="7831256">i</span><span class="op" id="7831257">++</span>&nbsp;<span class="op" id="7831260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831264">buf</span><span class="op" id="7831267">.</span><span class="ident" id="7831268">Reset</span><span class="op" id="7831273">(</span><span class="op" id="7831274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831278">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831333">buf</span><span class="op" id="7831336">.</span><span class="ident" id="7831337">WriteString</span><span class="op" id="7831348">(</span><span class="ident" id="7831349">enc</span><span class="op" id="7831352">[</span><span class="op" id="7831353">:</span><span class="builtinfunc" id="7831354">len</span><span class="op" id="7831357">(</span><span class="ident" id="7831358">enc</span><span class="op" id="7831361">)</span><span class="op" id="7831362">-</span><span class="num" id="7831363">2</span><span class="op" id="7831364">]</span><span class="op" id="7831365">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831369">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7831409">for</span>&nbsp;<span class="ident" id="7831413">n</span>&nbsp;<span class="op" id="7831415">:=</span>&nbsp;<span class="ident" id="7831418">rnd</span><span class="op" id="7831421">.</span><span class="ident" id="7831422">Intn</span><span class="op" id="7831426">(</span><span class="num" id="7831427">10</span><span class="op" id="7831429">)</span><span class="op" id="7831430">;</span>&nbsp;<span class="ident" id="7831432">n</span>&nbsp;<span class="op" id="7831434">&gt;</span>&nbsp;<span class="num" id="7831436">0</span><span class="op" id="7831437">;</span>&nbsp;<span class="ident" id="7831439">n</span><span class="op" id="7831440">--</span>&nbsp;<span class="op" id="7831443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7831448">if</span>&nbsp;<span class="ident" id="7831451">x</span>&nbsp;<span class="op" id="7831453">:=</span>&nbsp;<span class="builtintype" id="7831456">byte</span><span class="op" id="7831460">(</span><span class="ident" id="7831461">rnd</span><span class="op" id="7831464">.</span><span class="ident" id="7831465">Intn</span><span class="op" id="7831469">(</span><span class="num" id="7831470">256</span><span class="op" id="7831473">)</span><span class="op" id="7831474">)</span><span class="op" id="7831475">;</span>&nbsp;<span class="ident" id="7831477">x</span>&nbsp;<span class="op" id="7831479">!=</span>&nbsp;<span class="num" id="7831482">0xff</span>&nbsp;<span class="op" id="7831487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831493">buf</span><span class="op" id="7831496">.</span><span class="ident" id="7831497">WriteByte</span><span class="op" id="7831506">(</span><span class="ident" id="7831507">x</span><span class="op" id="7831508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7831513">}</span>&nbsp;<span class="keyword" id="7831515">else</span>&nbsp;<span class="op" id="7831520">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831526">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831593">buf</span><span class="op" id="7831596">.</span><span class="ident" id="7831597">WriteString</span><span class="op" id="7831608">(</span><span class="string" id="7831609">&#34;\xff\x00&#34;</span><span class="op" id="7831619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7831624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7831628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831632">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831670">buf</span><span class="op" id="7831673">.</span><span class="ident" id="7831674">WriteString</span><span class="op" id="7831685">(</span><span class="string" id="7831686">&#34;\xff\xd9&#34;</span><span class="op" id="7831696">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7831701">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831758">got</span><span class="op" id="7831761">,</span>&nbsp;<span class="ident" id="7831763">err</span>&nbsp;<span class="op" id="7831767">:=</span>&nbsp;<span class="ident" id="7831770">Decode</span><span class="op" id="7831776">(</span><span class="ident" id="7831777">buf</span><span class="op" id="7831780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7831784">if</span>&nbsp;<span class="ident" id="7831787">err</span>&nbsp;<span class="op" id="7831791">!=</span>&nbsp;<span class="builtintype" id="7831794">nil</span>&nbsp;<span class="op" id="7831798">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831803">t</span><span class="op" id="7831804">.</span><span class="ident" id="7831805">Errorf</span><span class="op" id="7831811">(</span><span class="string" id="7831812">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7831844">,</span>&nbsp;<span class="ident" id="7831846">i</span><span class="op" id="7831847">,</span>&nbsp;<span class="ident" id="7831849">err</span><span class="op" id="7831852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831857">nerr</span><span class="op" id="7831861">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7831867">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7831878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7831882">if</span>&nbsp;<span class="ident" id="7831885">got</span><span class="op" id="7831888">.</span><span class="ident" id="7831889">Bounds</span><span class="op" id="7831895">(</span><span class="op" id="7831896">)</span>&nbsp;<span class="op" id="7831898">!=</span>&nbsp;<span class="ident" id="7831901">src</span><span class="op" id="7831904">.</span><span class="ident" id="7831905">Bounds</span><span class="op" id="7831911">(</span><span class="op" id="7831912">)</span>&nbsp;<span class="op" id="7831914">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7831919">t</span><span class="op" id="7831920">.</span><span class="ident" id="7831921">Errorf</span><span class="op" id="7831927">(</span><span class="string" id="7831928">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7831965">,</span>&nbsp;<span class="ident" id="7831967">i</span><span class="op" id="7831968">,</span>&nbsp;<span class="ident" id="7831970">got</span><span class="op" id="7831973">.</span><span class="ident" id="7831974">Bounds</span><span class="op" id="7831980">(</span><span class="op" id="7831981">)</span><span class="op" id="7831982">,</span>&nbsp;<span class="ident" id="7831984">src</span><span class="op" id="7831987">.</span><span class="ident" id="7831988">Bounds</span><span class="op" id="7831994">(</span><span class="op" id="7831995">)</span><span class="op" id="7831996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832001">nerr</span><span class="op" id="7832005">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7832011">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7832022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7832026">if</span>&nbsp;<span class="ident" id="7832029">averageDelta</span><span class="op" id="7832041">(</span><span class="ident" id="7832042">got</span><span class="op" id="7832045">,</span>&nbsp;<span class="ident" id="7832047">src</span><span class="op" id="7832050">)</span>&nbsp;<span class="op" id="7832052">&gt;</span>&nbsp;<span class="num" id="7832054">2</span><span class="op" id="7832055">&lt;&lt;</span><span class="num" id="7832057">8</span>&nbsp;<span class="op" id="7832059">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832064">t</span><span class="op" id="7832065">.</span><span class="ident" id="7832066">Errorf</span><span class="op" id="7832072">(</span><span class="string" id="7832073">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7832120">,</span>&nbsp;<span class="ident" id="7832122">i</span><span class="op" id="7832123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832128">nerr</span><span class="op" id="7832132">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7832138">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7832149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7832152">}</span><br>
<span class="lineno">245</span><span class="op" id="7832154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7832157">func</span>&nbsp;<span class="ident" id="7832162">benchmarkDecode</span><span class="op" id="7832177">(</span><span class="ident" id="7832178">b</span>&nbsp;<span class="op" id="7832180">*</span><span class="ident" id="7832181">testing</span><span class="op" id="7832188">.</span><span class="ident" id="7832189">B</span><span class="op" id="7832190">,</span>&nbsp;<span class="ident" id="7832192">filename</span>&nbsp;<span class="builtintype" id="7832201">string</span><span class="op" id="7832207">)</span>&nbsp;<span class="op" id="7832209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832212">b</span><span class="op" id="7832213">.</span><span class="ident" id="7832214">StopTimer</span><span class="op" id="7832223">(</span><span class="op" id="7832224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832227">data</span><span class="op" id="7832231">,</span>&nbsp;<span class="ident" id="7832233">err</span>&nbsp;<span class="op" id="7832237">:=</span>&nbsp;<span class="ident" id="7832240">ioutil</span><span class="op" id="7832246">.</span><span class="ident" id="7832247">ReadFile</span><span class="op" id="7832255">(</span><span class="ident" id="7832256">filename</span><span class="op" id="7832264">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7832267">if</span>&nbsp;<span class="ident" id="7832270">err</span>&nbsp;<span class="op" id="7832274">!=</span>&nbsp;<span class="builtintype" id="7832277">nil</span>&nbsp;<span class="op" id="7832281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832285">b</span><span class="op" id="7832286">.</span><span class="ident" id="7832287">Fatal</span><span class="op" id="7832292">(</span><span class="ident" id="7832293">err</span><span class="op" id="7832296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7832299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832302">cfg</span><span class="op" id="7832305">,</span>&nbsp;<span class="ident" id="7832307">err</span>&nbsp;<span class="op" id="7832311">:=</span>&nbsp;<span class="ident" id="7832314">DecodeConfig</span><span class="op" id="7832326">(</span><span class="ident" id="7832327">bytes</span><span class="op" id="7832332">.</span><span class="ident" id="7832333">NewReader</span><span class="op" id="7832342">(</span><span class="ident" id="7832343">data</span><span class="op" id="7832347">)</span><span class="op" id="7832348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7832351">if</span>&nbsp;<span class="ident" id="7832354">err</span>&nbsp;<span class="op" id="7832358">!=</span>&nbsp;<span class="builtintype" id="7832361">nil</span>&nbsp;<span class="op" id="7832365">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832369">b</span><span class="op" id="7832370">.</span><span class="ident" id="7832371">Fatal</span><span class="op" id="7832376">(</span><span class="ident" id="7832377">err</span><span class="op" id="7832380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7832383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832386">b</span><span class="op" id="7832387">.</span><span class="ident" id="7832388">SetBytes</span><span class="op" id="7832396">(</span><span class="ident" id="7832397">int64</span><span class="op" id="7832402">(</span><span class="ident" id="7832403">cfg</span><span class="op" id="7832406">.</span><span class="ident" id="7832407">Width</span>&nbsp;<span class="op" id="7832413">*</span>&nbsp;<span class="ident" id="7832415">cfg</span><span class="op" id="7832418">.</span><span class="ident" id="7832419">Height</span>&nbsp;<span class="op" id="7832426">*</span>&nbsp;<span class="num" id="7832428">4</span><span class="op" id="7832429">)</span><span class="op" id="7832430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832433">b</span><span class="op" id="7832434">.</span><span class="ident" id="7832435">StartTimer</span><span class="op" id="7832445">(</span><span class="op" id="7832446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7832449">for</span>&nbsp;<span class="ident" id="7832453">i</span>&nbsp;<span class="op" id="7832455">:=</span>&nbsp;<span class="num" id="7832458">0</span><span class="op" id="7832459">;</span>&nbsp;<span class="ident" id="7832461">i</span>&nbsp;<span class="op" id="7832463">&lt;</span>&nbsp;<span class="ident" id="7832465">b</span><span class="op" id="7832466">.</span><span class="ident" id="7832467">N</span><span class="op" id="7832468">;</span>&nbsp;<span class="ident" id="7832470">i</span><span class="op" id="7832471">++</span>&nbsp;<span class="op" id="7832474">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832478">Decode</span><span class="op" id="7832484">(</span><span class="ident" id="7832485">bytes</span><span class="op" id="7832490">.</span><span class="ident" id="7832491">NewReader</span><span class="op" id="7832500">(</span><span class="ident" id="7832501">data</span><span class="op" id="7832505">)</span><span class="op" id="7832506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7832509">}</span><br>
<span class="lineno"></span><span class="op" id="7832511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7832514">func</span>&nbsp;<span class="ident" id="7832519">BenchmarkDecodeBaseline</span><span class="op" id="7832542">(</span><span class="ident" id="7832543">b</span>&nbsp;<span class="op" id="7832545">*</span><span class="ident" id="7832546">testing</span><span class="op" id="7832553">.</span><span class="ident" id="7832554">B</span><span class="op" id="7832555">)</span>&nbsp;<span class="op" id="7832557">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832560">benchmarkDecode</span><span class="op" id="7832575">(</span><span class="ident" id="7832576">b</span><span class="op" id="7832577">,</span>&nbsp;<span class="string" id="7832579">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7832607">)</span><br>
<span class="lineno"></span><span class="op" id="7832609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7832612">func</span>&nbsp;<span class="ident" id="7832617">BenchmarkDecodeProgressive</span><span class="op" id="7832643">(</span><span class="ident" id="7832644">b</span>&nbsp;<span class="op" id="7832646">*</span><span class="ident" id="7832647">testing</span><span class="op" id="7832654">.</span><span class="ident" id="7832655">B</span><span class="op" id="7832656">)</span>&nbsp;<span class="op" id="7832658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7832661">benchmarkDecode</span><span class="op" id="7832676">(</span><span class="ident" id="7832677">b</span><span class="op" id="7832678">,</span>&nbsp;<span class="string" id="7832680">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7832720">)</span><br>
<span class="lineno">270</span><span class="op" id="7832722">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
