<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/pem</h2>
<ul>
<li><a href="/gostd/encoding/pem/pem.go.html" class="current">pem.go</a></li>
<li><a href="/gostd/encoding/pem/pem_test.go.html">pem_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4768470">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4768525">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4768579">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4768630">//&nbsp;Package&nbsp;pem&nbsp;implements&nbsp;the&nbsp;PEM&nbsp;data&nbsp;encoding,&nbsp;which&nbsp;originated&nbsp;in&nbsp;Privacy</span><br>
<span class="lineno"></span><span class="comment" id="4768707">//&nbsp;Enhanced&nbsp;Mail.&nbsp;The&nbsp;most&nbsp;common&nbsp;use&nbsp;of&nbsp;PEM&nbsp;encoding&nbsp;today&nbsp;is&nbsp;in&nbsp;TLS&nbsp;keys&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4768786">//&nbsp;certificates.&nbsp;See&nbsp;RFC&nbsp;1421.</span><br>
<span class="lineno"></span><span class="keyword" id="4768817">package</span>&nbsp;<span class="ident" id="4768825">pem</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4768830">import</span>&nbsp;<span class="op" id="4768837">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4768840">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4768849">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4768868">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4768874">&#34;sort&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4768881">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4768884">//&nbsp;A&nbsp;Block&nbsp;represents&nbsp;a&nbsp;PEM&nbsp;encoded&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4768931">//</span><br>
<span class="lineno"></span><span class="comment" id="4768934">//&nbsp;The&nbsp;encoded&nbsp;form&nbsp;is:</span><br>
<span class="lineno">20</span><span class="comment" id="4768958">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4768985">//&nbsp;&nbsp;&nbsp;&nbsp;Headers</span><br>
<span class="lineno"></span><span class="comment" id="4768999">//&nbsp;&nbsp;&nbsp;&nbsp;base64-encoded&nbsp;Bytes</span><br>
<span class="lineno"></span><span class="comment" id="4769026">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4769051">//&nbsp;where&nbsp;Headers&nbsp;is&nbsp;a&nbsp;possibly&nbsp;empty&nbsp;sequence&nbsp;of&nbsp;Key:&nbsp;Value&nbsp;lines.</span><br>
<span class="lineno">25</span><span class="keyword" id="4769118">type</span>&nbsp;<span class="ident" id="4769123">Block</span>&nbsp;<span class="keyword" id="4769129">struct</span>&nbsp;<span class="op" id="4769136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769139">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4769147">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4769165">//&nbsp;The&nbsp;type,&nbsp;taken&nbsp;from&nbsp;the&nbsp;preamble&nbsp;(i.e.&nbsp;&#34;RSA&nbsp;PRIVATE&nbsp;KEY&#34;).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769229">Headers</span>&nbsp;<span class="keyword" id="4769237">map</span><span class="op" id="4769240">[</span><span class="builtintype" id="4769241">string</span><span class="op" id="4769247">]</span><span class="builtintype" id="4769248">string</span>&nbsp;<span class="comment" id="4769255">//&nbsp;Optional&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769277">Bytes</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4769285">[</span><span class="op" id="4769286">]</span><span class="builtintype" id="4769287">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4769303">//&nbsp;The&nbsp;decoded&nbsp;bytes&nbsp;of&nbsp;the&nbsp;contents.&nbsp;Typically&nbsp;a&nbsp;DER&nbsp;encoded&nbsp;ASN.1&nbsp;structure.</span><br>
<span class="lineno"></span><span class="op" id="4769382">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4769385">//&nbsp;getLine&nbsp;results&nbsp;the&nbsp;first&nbsp;\r\n&nbsp;or&nbsp;\n&nbsp;delineated&nbsp;line&nbsp;from&nbsp;the&nbsp;given&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="4769461">//&nbsp;array.&nbsp;The&nbsp;line&nbsp;does&nbsp;not&nbsp;include&nbsp;trailing&nbsp;whitespace&nbsp;or&nbsp;the&nbsp;trailing&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4769537">//&nbsp;line&nbsp;bytes.&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;byte&nbsp;array&nbsp;(also&nbsp;not&nbsp;including&nbsp;the&nbsp;new&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4769617">//&nbsp;bytes)&nbsp;is&nbsp;also&nbsp;returned&nbsp;and&nbsp;this&nbsp;will&nbsp;always&nbsp;be&nbsp;smaller&nbsp;than&nbsp;the&nbsp;original</span><br>
<span class="lineno">35</span><span class="comment" id="4769694">//&nbsp;argument.</span><br>
<span class="lineno"></span><span class="keyword" id="4769707">func</span>&nbsp;<span class="ident" id="4769712">getLine</span><span class="op" id="4769719">(</span><span class="ident" id="4769720">data</span>&nbsp;<span class="op" id="4769725">[</span><span class="op" id="4769726">]</span><span class="builtintype" id="4769727">byte</span><span class="op" id="4769731">)</span>&nbsp;<span class="op" id="4769733">(</span><span class="ident" id="4769734">line</span><span class="op" id="4769738">,</span>&nbsp;<span class="ident" id="4769740">rest</span>&nbsp;<span class="op" id="4769745">[</span><span class="op" id="4769746">]</span><span class="builtintype" id="4769747">byte</span><span class="op" id="4769751">)</span>&nbsp;<span class="op" id="4769753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769756">i</span>&nbsp;<span class="op" id="4769758">:=</span>&nbsp;<span class="ident" id="4769761">bytes</span><span class="op" id="4769766">.</span><span class="ident" id="4769767">Index</span><span class="op" id="4769772">(</span><span class="ident" id="4769773">data</span><span class="op" id="4769777">,</span>&nbsp;<span class="op" id="4769779">[</span><span class="op" id="4769780">]</span><span class="builtintype" id="4769781">byte</span><span class="op" id="4769785">{</span><span class="string" id="4769786">&#39;\n&#39;</span><span class="op" id="4769790">}</span><span class="op" id="4769791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769794">var</span>&nbsp;<span class="ident" id="4769798">j</span>&nbsp;<span class="builtintype" id="4769800">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769805">if</span>&nbsp;<span class="ident" id="4769808">i</span>&nbsp;<span class="op" id="4769810">&lt;</span>&nbsp;<span class="num" id="4769812">0</span>&nbsp;<span class="op" id="4769814">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769818">i</span>&nbsp;<span class="op" id="4769820">=</span>&nbsp;<span class="builtinfunc" id="4769822">len</span><span class="op" id="4769825">(</span><span class="ident" id="4769826">data</span><span class="op" id="4769830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769834">j</span>&nbsp;<span class="op" id="4769836">=</span>&nbsp;<span class="ident" id="4769838">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769841">}</span>&nbsp;<span class="keyword" id="4769843">else</span>&nbsp;<span class="op" id="4769848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769852">j</span>&nbsp;<span class="op" id="4769854">=</span>&nbsp;<span class="ident" id="4769856">i</span>&nbsp;<span class="op" id="4769858">+</span>&nbsp;<span class="num" id="4769860">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769864">if</span>&nbsp;<span class="ident" id="4769867">i</span>&nbsp;<span class="op" id="4769869">&gt;</span>&nbsp;<span class="num" id="4769871">0</span>&nbsp;<span class="op" id="4769873">&amp;&amp;</span>&nbsp;<span class="ident" id="4769876">data</span><span class="op" id="4769880">[</span><span class="ident" id="4769881">i</span><span class="op" id="4769882">-</span><span class="num" id="4769883">1</span><span class="op" id="4769884">]</span>&nbsp;<span class="op" id="4769886">==</span>&nbsp;<span class="string" id="4769889">&#39;\r&#39;</span>&nbsp;<span class="op" id="4769894">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769899">i</span><span class="op" id="4769900">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769911">return</span>&nbsp;<span class="ident" id="4769918">bytes</span><span class="op" id="4769923">.</span><span class="ident" id="4769924">TrimRight</span><span class="op" id="4769933">(</span><span class="ident" id="4769934">data</span><span class="op" id="4769938">[</span><span class="num" id="4769939">0</span><span class="op" id="4769940">:</span><span class="ident" id="4769941">i</span><span class="op" id="4769942">]</span><span class="op" id="4769943">,</span>&nbsp;<span class="string" id="4769945">&#34;&nbsp;\t&#34;</span><span class="op" id="4769950">)</span><span class="op" id="4769951">,</span>&nbsp;<span class="ident" id="4769953">data</span><span class="op" id="4769957">[</span><span class="ident" id="4769958">j</span><span class="op" id="4769959">:</span><span class="op" id="4769960">]</span><br>
<span class="lineno"></span><span class="op" id="4769962">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4769965">//&nbsp;removeWhitespace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;its&nbsp;input&nbsp;with&nbsp;all&nbsp;spaces,&nbsp;tab&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4770038">//&nbsp;newline&nbsp;characters&nbsp;removed.</span><br>
<span class="lineno"></span><span class="keyword" id="4770069">func</span>&nbsp;<span class="ident" id="4770074">removeWhitespace</span><span class="op" id="4770090">(</span><span class="ident" id="4770091">data</span>&nbsp;<span class="op" id="4770096">[</span><span class="op" id="4770097">]</span><span class="builtintype" id="4770098">byte</span><span class="op" id="4770102">)</span>&nbsp;<span class="op" id="4770104">[</span><span class="op" id="4770105">]</span><span class="builtintype" id="4770106">byte</span>&nbsp;<span class="op" id="4770111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770114">result</span>&nbsp;<span class="op" id="4770121">:=</span>&nbsp;<span class="builtinfunc" id="4770124">make</span><span class="op" id="4770128">(</span><span class="op" id="4770129">[</span><span class="op" id="4770130">]</span><span class="builtintype" id="4770131">byte</span><span class="op" id="4770135">,</span>&nbsp;<span class="builtinfunc" id="4770137">len</span><span class="op" id="4770140">(</span><span class="ident" id="4770141">data</span><span class="op" id="4770145">)</span><span class="op" id="4770146">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770149">n</span>&nbsp;<span class="op" id="4770151">:=</span>&nbsp;<span class="num" id="4770154">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770158">for</span>&nbsp;<span class="ident" id="4770162">_</span><span class="op" id="4770163">,</span>&nbsp;<span class="ident" id="4770165">b</span>&nbsp;<span class="op" id="4770167">:=</span>&nbsp;<span class="keyword" id="4770170">range</span>&nbsp;<span class="ident" id="4770176">data</span>&nbsp;<span class="op" id="4770181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770185">if</span>&nbsp;<span class="ident" id="4770188">b</span>&nbsp;<span class="op" id="4770190">==</span>&nbsp;<span class="string" id="4770193">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4770197">||</span>&nbsp;<span class="ident" id="4770200">b</span>&nbsp;<span class="op" id="4770202">==</span>&nbsp;<span class="string" id="4770205">&#39;\t&#39;</span>&nbsp;<span class="op" id="4770210">||</span>&nbsp;<span class="ident" id="4770213">b</span>&nbsp;<span class="op" id="4770215">==</span>&nbsp;<span class="string" id="4770218">&#39;\r&#39;</span>&nbsp;<span class="op" id="4770223">||</span>&nbsp;<span class="ident" id="4770226">b</span>&nbsp;<span class="op" id="4770228">==</span>&nbsp;<span class="string" id="4770231">&#39;\n&#39;</span>&nbsp;<span class="op" id="4770236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770241">continue</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770256">result</span><span class="op" id="4770262">[</span><span class="ident" id="4770263">n</span><span class="op" id="4770264">]</span>&nbsp;<span class="op" id="4770266">=</span>&nbsp;<span class="ident" id="4770268">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770272">n</span><span class="op" id="4770273">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770281">return</span>&nbsp;<span class="ident" id="4770288">result</span><span class="op" id="4770294">[</span><span class="num" id="4770295">0</span><span class="op" id="4770296">:</span><span class="ident" id="4770297">n</span><span class="op" id="4770298">]</span><br>
<span class="lineno"></span><span class="op" id="4770300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4770303">var</span>&nbsp;<span class="ident" id="4770307">pemStart</span>&nbsp;<span class="op" id="4770316">=</span>&nbsp;<span class="op" id="4770318">[</span><span class="op" id="4770319">]</span><span class="builtintype" id="4770320">byte</span><span class="op" id="4770324">(</span><span class="string" id="4770325">&#34;\n-----BEGIN&nbsp;&#34;</span><span class="op" id="4770340">)</span><br>
<span class="lineno"></span><span class="keyword" id="4770342">var</span>&nbsp;<span class="ident" id="4770346">pemEnd</span>&nbsp;<span class="op" id="4770353">=</span>&nbsp;<span class="op" id="4770355">[</span><span class="op" id="4770356">]</span><span class="builtintype" id="4770357">byte</span><span class="op" id="4770361">(</span><span class="string" id="4770362">&#34;\n-----END&nbsp;&#34;</span><span class="op" id="4770375">)</span><br>
<span class="lineno">70</span><span class="keyword" id="4770377">var</span>&nbsp;<span class="ident" id="4770381">pemEndOfLine</span>&nbsp;<span class="op" id="4770394">=</span>&nbsp;<span class="op" id="4770396">[</span><span class="op" id="4770397">]</span><span class="builtintype" id="4770398">byte</span><span class="op" id="4770402">(</span><span class="string" id="4770403">&#34;-----&#34;</span><span class="op" id="4770410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4770413">//&nbsp;Decode&nbsp;will&nbsp;find&nbsp;the&nbsp;next&nbsp;PEM&nbsp;formatted&nbsp;block&nbsp;(certificate,&nbsp;private&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="4770488">//&nbsp;etc)&nbsp;in&nbsp;the&nbsp;input.&nbsp;It&nbsp;returns&nbsp;that&nbsp;block&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;input.&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4770567">//&nbsp;no&nbsp;PEM&nbsp;data&nbsp;is&nbsp;found,&nbsp;p&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;whole&nbsp;of&nbsp;the&nbsp;input&nbsp;is&nbsp;returned&nbsp;in</span><br>
<span class="lineno">75</span><span class="comment" id="4770643">//&nbsp;rest.</span><br>
<span class="lineno"></span><span class="keyword" id="4770652">func</span>&nbsp;<span class="ident" id="4770657">Decode</span><span class="op" id="4770663">(</span><span class="ident" id="4770664">data</span>&nbsp;<span class="op" id="4770669">[</span><span class="op" id="4770670">]</span><span class="builtintype" id="4770671">byte</span><span class="op" id="4770675">)</span>&nbsp;<span class="op" id="4770677">(</span><span class="ident" id="4770678">p</span>&nbsp;<span class="op" id="4770680">*</span><span class="ident" id="4770681">Block</span><span class="op" id="4770686">,</span>&nbsp;<span class="ident" id="4770688">rest</span>&nbsp;<span class="op" id="4770693">[</span><span class="op" id="4770694">]</span><span class="builtintype" id="4770695">byte</span><span class="op" id="4770699">)</span>&nbsp;<span class="op" id="4770701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770704">//&nbsp;pemStart&nbsp;begins&nbsp;with&nbsp;a&nbsp;newline.&nbsp;However,&nbsp;at&nbsp;the&nbsp;very&nbsp;beginning&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770774">//&nbsp;the&nbsp;byte&nbsp;array,&nbsp;we&#39;ll&nbsp;accept&nbsp;the&nbsp;start&nbsp;string&nbsp;without&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770836">rest</span>&nbsp;<span class="op" id="4770841">=</span>&nbsp;<span class="ident" id="4770843">data</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770849">if</span>&nbsp;<span class="ident" id="4770852">bytes</span><span class="op" id="4770857">.</span><span class="ident" id="4770858">HasPrefix</span><span class="op" id="4770867">(</span><span class="ident" id="4770868">data</span><span class="op" id="4770872">,</span>&nbsp;<span class="ident" id="4770874">pemStart</span><span class="op" id="4770882">[</span><span class="num" id="4770883">1</span><span class="op" id="4770884">:</span><span class="op" id="4770885">]</span><span class="op" id="4770886">)</span>&nbsp;<span class="op" id="4770888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770892">rest</span>&nbsp;<span class="op" id="4770897">=</span>&nbsp;<span class="ident" id="4770899">rest</span><span class="op" id="4770903">[</span><span class="builtinfunc" id="4770904">len</span><span class="op" id="4770907">(</span><span class="ident" id="4770908">pemStart</span><span class="op" id="4770916">)</span><span class="op" id="4770917">-</span><span class="num" id="4770918">1</span>&nbsp;<span class="op" id="4770920">:</span>&nbsp;<span class="builtinfunc" id="4770922">len</span><span class="op" id="4770925">(</span><span class="ident" id="4770926">data</span><span class="op" id="4770930">)</span><span class="op" id="4770931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770934">}</span>&nbsp;<span class="keyword" id="4770936">else</span>&nbsp;<span class="keyword" id="4770941">if</span>&nbsp;<span class="ident" id="4770944">i</span>&nbsp;<span class="op" id="4770946">:=</span>&nbsp;<span class="ident" id="4770949">bytes</span><span class="op" id="4770954">.</span><span class="ident" id="4770955">Index</span><span class="op" id="4770960">(</span><span class="ident" id="4770961">data</span><span class="op" id="4770965">,</span>&nbsp;<span class="ident" id="4770967">pemStart</span><span class="op" id="4770975">)</span><span class="op" id="4770976">;</span>&nbsp;<span class="ident" id="4770978">i</span>&nbsp;<span class="op" id="4770980">&gt;=</span>&nbsp;<span class="num" id="4770983">0</span>&nbsp;<span class="op" id="4770985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770989">rest</span>&nbsp;<span class="op" id="4770994">=</span>&nbsp;<span class="ident" id="4770996">rest</span><span class="op" id="4771000">[</span><span class="ident" id="4771001">i</span><span class="op" id="4771002">+</span><span class="builtinfunc" id="4771003">len</span><span class="op" id="4771006">(</span><span class="ident" id="4771007">pemStart</span><span class="op" id="4771015">)</span>&nbsp;<span class="op" id="4771017">:</span>&nbsp;<span class="builtinfunc" id="4771019">len</span><span class="op" id="4771022">(</span><span class="ident" id="4771023">data</span><span class="op" id="4771027">)</span><span class="op" id="4771028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771031">}</span>&nbsp;<span class="keyword" id="4771033">else</span>&nbsp;<span class="op" id="4771038">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771042">return</span>&nbsp;<span class="ident" id="4771049">nil</span><span class="op" id="4771052">,</span>&nbsp;<span class="ident" id="4771054">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771064">typeLine</span><span class="op" id="4771072">,</span>&nbsp;<span class="ident" id="4771074">rest</span>&nbsp;<span class="op" id="4771079">:=</span>&nbsp;<span class="ident" id="4771082">getLine</span><span class="op" id="4771089">(</span><span class="ident" id="4771090">rest</span><span class="op" id="4771094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771097">if</span>&nbsp;<span class="op" id="4771100">!</span><span class="ident" id="4771101">bytes</span><span class="op" id="4771106">.</span><span class="ident" id="4771107">HasSuffix</span><span class="op" id="4771116">(</span><span class="ident" id="4771117">typeLine</span><span class="op" id="4771125">,</span>&nbsp;<span class="ident" id="4771127">pemEndOfLine</span><span class="op" id="4771139">)</span>&nbsp;<span class="op" id="4771141">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771145">return</span>&nbsp;<span class="ident" id="4771152">decodeError</span><span class="op" id="4771163">(</span><span class="ident" id="4771164">data</span><span class="op" id="4771168">,</span>&nbsp;<span class="ident" id="4771170">rest</span><span class="op" id="4771174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771180">typeLine</span>&nbsp;<span class="op" id="4771189">=</span>&nbsp;<span class="ident" id="4771191">typeLine</span><span class="op" id="4771199">[</span><span class="num" id="4771200">0</span>&nbsp;<span class="op" id="4771202">:</span>&nbsp;<span class="builtinfunc" id="4771204">len</span><span class="op" id="4771207">(</span><span class="ident" id="4771208">typeLine</span><span class="op" id="4771216">)</span><span class="op" id="4771217">-</span><span class="builtinfunc" id="4771218">len</span><span class="op" id="4771221">(</span><span class="ident" id="4771222">pemEndOfLine</span><span class="op" id="4771234">)</span><span class="op" id="4771235">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771239">p</span>&nbsp;<span class="op" id="4771241">=</span>&nbsp;<span class="op" id="4771243">&amp;</span><span class="ident" id="4771244">Block</span><span class="op" id="4771249">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771253">Headers</span><span class="op" id="4771260">:</span>&nbsp;<span class="builtinfunc" id="4771262">make</span><span class="op" id="4771266">(</span><span class="keyword" id="4771267">map</span><span class="op" id="4771270">[</span><span class="builtintype" id="4771271">string</span><span class="op" id="4771277">]</span><span class="builtintype" id="4771278">string</span><span class="op" id="4771284">)</span><span class="op" id="4771285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771289">Type</span><span class="op" id="4771293">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4771298">string</span><span class="op" id="4771304">(</span><span class="ident" id="4771305">typeLine</span><span class="op" id="4771313">)</span><span class="op" id="4771314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771321">for</span>&nbsp;<span class="op" id="4771325">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771329">//&nbsp;This&nbsp;loop&nbsp;terminates&nbsp;because&nbsp;getLine&#39;s&nbsp;second&nbsp;result&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771390">//&nbsp;always&nbsp;smaller&nbsp;than&nbsp;its&nbsp;argument.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771429">if</span>&nbsp;<span class="builtinfunc" id="4771432">len</span><span class="op" id="4771435">(</span><span class="ident" id="4771436">rest</span><span class="op" id="4771440">)</span>&nbsp;<span class="op" id="4771442">==</span>&nbsp;<span class="num" id="4771445">0</span>&nbsp;<span class="op" id="4771447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771452">return</span>&nbsp;<span class="ident" id="4771459">nil</span><span class="op" id="4771462">,</span>&nbsp;<span class="ident" id="4771464">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771471">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771475">line</span><span class="op" id="4771479">,</span>&nbsp;<span class="ident" id="4771481">next</span>&nbsp;<span class="op" id="4771486">:=</span>&nbsp;<span class="ident" id="4771489">getLine</span><span class="op" id="4771496">(</span><span class="ident" id="4771497">rest</span><span class="op" id="4771501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771506">i</span>&nbsp;<span class="op" id="4771508">:=</span>&nbsp;<span class="ident" id="4771511">bytes</span><span class="op" id="4771516">.</span><span class="ident" id="4771517">Index</span><span class="op" id="4771522">(</span><span class="ident" id="4771523">line</span><span class="op" id="4771527">,</span>&nbsp;<span class="op" id="4771529">[</span><span class="op" id="4771530">]</span><span class="builtintype" id="4771531">byte</span><span class="op" id="4771535">{</span><span class="string" id="4771536">&#39;:&#39;</span><span class="op" id="4771539">}</span><span class="op" id="4771540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771544">if</span>&nbsp;<span class="ident" id="4771547">i</span>&nbsp;<span class="op" id="4771549">==</span>&nbsp;<span class="op" id="4771552">-</span><span class="num" id="4771553">1</span>&nbsp;<span class="op" id="4771555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771560">break</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771573">//&nbsp;TODO(agl):&nbsp;need&nbsp;to&nbsp;cope&nbsp;with&nbsp;values&nbsp;that&nbsp;spread&nbsp;across&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771640">key</span><span class="op" id="4771643">,</span>&nbsp;<span class="ident" id="4771645">val</span>&nbsp;<span class="op" id="4771649">:=</span>&nbsp;<span class="ident" id="4771652">line</span><span class="op" id="4771656">[</span><span class="num" id="4771657">0</span><span class="op" id="4771658">:</span><span class="ident" id="4771659">i</span><span class="op" id="4771660">]</span><span class="op" id="4771661">,</span>&nbsp;<span class="ident" id="4771663">line</span><span class="op" id="4771667">[</span><span class="ident" id="4771668">i</span><span class="op" id="4771669">+</span><span class="num" id="4771670">1</span><span class="op" id="4771671">:</span><span class="op" id="4771672">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771676">key</span>&nbsp;<span class="op" id="4771680">=</span>&nbsp;<span class="ident" id="4771682">bytes</span><span class="op" id="4771687">.</span><span class="ident" id="4771688">TrimSpace</span><span class="op" id="4771697">(</span><span class="ident" id="4771698">key</span><span class="op" id="4771701">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771705">val</span>&nbsp;<span class="op" id="4771709">=</span>&nbsp;<span class="ident" id="4771711">bytes</span><span class="op" id="4771716">.</span><span class="ident" id="4771717">TrimSpace</span><span class="op" id="4771726">(</span><span class="ident" id="4771727">val</span><span class="op" id="4771730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771734">p</span><span class="op" id="4771735">.</span><span class="ident" id="4771736">Headers</span><span class="op" id="4771743">[</span><span class="builtintype" id="4771744">string</span><span class="op" id="4771750">(</span><span class="ident" id="4771751">key</span><span class="op" id="4771754">)</span><span class="op" id="4771755">]</span>&nbsp;<span class="op" id="4771757">=</span>&nbsp;<span class="builtintype" id="4771759">string</span><span class="op" id="4771765">(</span><span class="ident" id="4771766">val</span><span class="op" id="4771769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771773">rest</span>&nbsp;<span class="op" id="4771778">=</span>&nbsp;<span class="ident" id="4771780">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771790">i</span>&nbsp;<span class="op" id="4771792">:=</span>&nbsp;<span class="ident" id="4771795">bytes</span><span class="op" id="4771800">.</span><span class="ident" id="4771801">Index</span><span class="op" id="4771806">(</span><span class="ident" id="4771807">rest</span><span class="op" id="4771811">,</span>&nbsp;<span class="ident" id="4771813">pemEnd</span><span class="op" id="4771819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771822">if</span>&nbsp;<span class="ident" id="4771825">i</span>&nbsp;<span class="op" id="4771827">&lt;</span>&nbsp;<span class="num" id="4771829">0</span>&nbsp;<span class="op" id="4771831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771835">return</span>&nbsp;<span class="ident" id="4771842">decodeError</span><span class="op" id="4771853">(</span><span class="ident" id="4771854">data</span><span class="op" id="4771858">,</span>&nbsp;<span class="ident" id="4771860">rest</span><span class="op" id="4771864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771870">base64Data</span>&nbsp;<span class="op" id="4771881">:=</span>&nbsp;<span class="ident" id="4771884">removeWhitespace</span><span class="op" id="4771900">(</span><span class="ident" id="4771901">rest</span><span class="op" id="4771905">[</span><span class="num" id="4771906">0</span><span class="op" id="4771907">:</span><span class="ident" id="4771908">i</span><span class="op" id="4771909">]</span><span class="op" id="4771910">)</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771914">p</span><span class="op" id="4771915">.</span><span class="ident" id="4771916">Bytes</span>&nbsp;<span class="op" id="4771922">=</span>&nbsp;<span class="builtinfunc" id="4771924">make</span><span class="op" id="4771928">(</span><span class="op" id="4771929">[</span><span class="op" id="4771930">]</span><span class="builtintype" id="4771931">byte</span><span class="op" id="4771935">,</span>&nbsp;<span class="ident" id="4771937">base64</span><span class="op" id="4771943">.</span><span class="ident" id="4771944">StdEncoding</span><span class="op" id="4771955">.</span><span class="ident" id="4771956">DecodedLen</span><span class="op" id="4771966">(</span><span class="builtinfunc" id="4771967">len</span><span class="op" id="4771970">(</span><span class="ident" id="4771971">base64Data</span><span class="op" id="4771981">)</span><span class="op" id="4771982">)</span><span class="op" id="4771983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771986">n</span><span class="op" id="4771987">,</span>&nbsp;<span class="ident" id="4771989">err</span>&nbsp;<span class="op" id="4771993">:=</span>&nbsp;<span class="ident" id="4771996">base64</span><span class="op" id="4772002">.</span><span class="ident" id="4772003">StdEncoding</span><span class="op" id="4772014">.</span><span class="ident" id="4772015">Decode</span><span class="op" id="4772021">(</span><span class="ident" id="4772022">p</span><span class="op" id="4772023">.</span><span class="ident" id="4772024">Bytes</span><span class="op" id="4772029">,</span>&nbsp;<span class="ident" id="4772031">base64Data</span><span class="op" id="4772041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772044">if</span>&nbsp;<span class="ident" id="4772047">err</span>&nbsp;<span class="op" id="4772051">!=</span>&nbsp;<span class="ident" id="4772054">nil</span>&nbsp;<span class="op" id="4772058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772062">return</span>&nbsp;<span class="ident" id="4772069">decodeError</span><span class="op" id="4772080">(</span><span class="ident" id="4772081">data</span><span class="op" id="4772085">,</span>&nbsp;<span class="ident" id="4772087">rest</span><span class="op" id="4772091">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772097">p</span><span class="op" id="4772098">.</span><span class="ident" id="4772099">Bytes</span>&nbsp;<span class="op" id="4772105">=</span>&nbsp;<span class="ident" id="4772107">p</span><span class="op" id="4772108">.</span><span class="ident" id="4772109">Bytes</span><span class="op" id="4772114">[</span><span class="num" id="4772115">0</span><span class="op" id="4772116">:</span><span class="ident" id="4772117">n</span><span class="op" id="4772118">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772122">_</span><span class="op" id="4772123">,</span>&nbsp;<span class="ident" id="4772125">rest</span>&nbsp;<span class="op" id="4772130">=</span>&nbsp;<span class="ident" id="4772132">getLine</span><span class="op" id="4772139">(</span><span class="ident" id="4772140">rest</span><span class="op" id="4772144">[</span><span class="ident" id="4772145">i</span><span class="op" id="4772146">+</span><span class="builtinfunc" id="4772147">len</span><span class="op" id="4772150">(</span><span class="ident" id="4772151">pemEnd</span><span class="op" id="4772157">)</span><span class="op" id="4772158">:</span><span class="op" id="4772159">]</span><span class="op" id="4772160">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772164">return</span><br>
<span class="lineno"></span><span class="op" id="4772171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4772174">func</span>&nbsp;<span class="ident" id="4772179">decodeError</span><span class="op" id="4772190">(</span><span class="ident" id="4772191">data</span><span class="op" id="4772195">,</span>&nbsp;<span class="ident" id="4772197">rest</span>&nbsp;<span class="op" id="4772202">[</span><span class="op" id="4772203">]</span><span class="builtintype" id="4772204">byte</span><span class="op" id="4772208">)</span>&nbsp;<span class="op" id="4772210">(</span><span class="op" id="4772211">*</span><span class="ident" id="4772212">Block</span><span class="op" id="4772217">,</span>&nbsp;<span class="op" id="4772219">[</span><span class="op" id="4772220">]</span><span class="builtintype" id="4772221">byte</span><span class="op" id="4772225">)</span>&nbsp;<span class="op" id="4772227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772230">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here&nbsp;then&nbsp;we&nbsp;have&nbsp;rejected&nbsp;a&nbsp;likely&nbsp;looking,&nbsp;but</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772293">//&nbsp;ultimately&nbsp;invalid&nbsp;PEM&nbsp;block.&nbsp;We&nbsp;need&nbsp;to&nbsp;start&nbsp;over&nbsp;from&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772360">//&nbsp;position.&nbsp;&nbsp;We&nbsp;have&nbsp;consumed&nbsp;the&nbsp;preamble&nbsp;line&nbsp;and&nbsp;will&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772433">//&nbsp;any&nbsp;lines&nbsp;which&nbsp;could&nbsp;be&nbsp;header&nbsp;lines.&nbsp;However,&nbsp;a&nbsp;valid&nbsp;preamble</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772502">//&nbsp;line&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;header&nbsp;line,&nbsp;therefore&nbsp;we&nbsp;cannot&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772573">//&nbsp;the&nbsp;preamble&nbsp;line&nbsp;for&nbsp;the&nbsp;any&nbsp;subsequent&nbsp;block.&nbsp;Thus,&nbsp;we&nbsp;will&nbsp;always</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772646">//&nbsp;find&nbsp;any&nbsp;valid&nbsp;block,&nbsp;no&nbsp;matter&nbsp;what&nbsp;bytes&nbsp;precede&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772705">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772709">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;the&nbsp;input&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772742">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772746">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;MALFORMED&nbsp;BLOCK-----</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772785">//&nbsp;&nbsp;&nbsp;&nbsp;junk&nbsp;that&nbsp;may&nbsp;look&nbsp;like&nbsp;header&nbsp;lines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772829">//&nbsp;&nbsp;&nbsp;or&nbsp;data&nbsp;lines,&nbsp;but&nbsp;no&nbsp;END&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772866">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772870">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772906">//&nbsp;&nbsp;&nbsp;&nbsp;realdata</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772922">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772956">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772960">//&nbsp;we&#39;ve&nbsp;failed&nbsp;to&nbsp;parse&nbsp;using&nbsp;the&nbsp;first&nbsp;BEGIN&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4773013">//&nbsp;and&nbsp;now&nbsp;will&nbsp;try&nbsp;again,&nbsp;using&nbsp;the&nbsp;second&nbsp;BEGIN&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773070">p</span><span class="op" id="4773071">,</span>&nbsp;<span class="ident" id="4773073">rest</span>&nbsp;<span class="op" id="4773078">:=</span>&nbsp;<span class="ident" id="4773081">Decode</span><span class="op" id="4773087">(</span><span class="ident" id="4773088">rest</span><span class="op" id="4773092">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773095">if</span>&nbsp;<span class="ident" id="4773098">p</span>&nbsp;<span class="op" id="4773100">==</span>&nbsp;<span class="ident" id="4773103">nil</span>&nbsp;<span class="op" id="4773107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773111">rest</span>&nbsp;<span class="op" id="4773116">=</span>&nbsp;<span class="ident" id="4773118">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773127">return</span>&nbsp;<span class="ident" id="4773134">p</span><span class="op" id="4773135">,</span>&nbsp;<span class="ident" id="4773137">rest</span><br>
<span class="lineno"></span><span class="op" id="4773142">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4773145">const</span>&nbsp;<span class="ident" id="4773151">pemLineLength</span>&nbsp;<span class="op" id="4773165">=</span>&nbsp;<span class="num" id="4773167">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4773171">type</span>&nbsp;<span class="ident" id="4773176">lineBreaker</span>&nbsp;<span class="keyword" id="4773188">struct</span>&nbsp;<span class="op" id="4773195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773198">line</span>&nbsp;<span class="op" id="4773203">[</span><span class="ident" id="4773204">pemLineLength</span><span class="op" id="4773217">]</span><span class="builtintype" id="4773218">byte</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773224">used</span>&nbsp;<span class="builtintype" id="4773229">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773234">out</span>&nbsp;&nbsp;<span class="ident" id="4773239">io</span><span class="op" id="4773241">.</span><span class="ident" id="4773242">Writer</span><br>
<span class="lineno"></span><span class="op" id="4773249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4773252">func</span>&nbsp;<span class="op" id="4773257">(</span><span class="ident" id="4773258">l</span>&nbsp;<span class="op" id="4773260">*</span><span class="ident" id="4773261">lineBreaker</span><span class="op" id="4773272">)</span>&nbsp;<span class="ident" id="4773274">Write</span><span class="op" id="4773279">(</span><span class="ident" id="4773280">b</span>&nbsp;<span class="op" id="4773282">[</span><span class="op" id="4773283">]</span><span class="builtintype" id="4773284">byte</span><span class="op" id="4773288">)</span>&nbsp;<span class="op" id="4773290">(</span><span class="ident" id="4773291">n</span>&nbsp;<span class="builtintype" id="4773293">int</span><span class="op" id="4773296">,</span>&nbsp;<span class="ident" id="4773298">err</span>&nbsp;<span class="builtintype" id="4773302">error</span><span class="op" id="4773307">)</span>&nbsp;<span class="op" id="4773309">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773312">if</span>&nbsp;<span class="ident" id="4773315">l</span><span class="op" id="4773316">.</span><span class="ident" id="4773317">used</span><span class="op" id="4773321">+</span><span class="builtinfunc" id="4773322">len</span><span class="op" id="4773325">(</span><span class="ident" id="4773326">b</span><span class="op" id="4773327">)</span>&nbsp;<span class="op" id="4773329">&lt;</span>&nbsp;<span class="ident" id="4773331">pemLineLength</span>&nbsp;<span class="op" id="4773345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4773349">copy</span><span class="op" id="4773353">(</span><span class="ident" id="4773354">l</span><span class="op" id="4773355">.</span><span class="ident" id="4773356">line</span><span class="op" id="4773360">[</span><span class="ident" id="4773361">l</span><span class="op" id="4773362">.</span><span class="ident" id="4773363">used</span><span class="op" id="4773367">:</span><span class="op" id="4773368">]</span><span class="op" id="4773369">,</span>&nbsp;<span class="ident" id="4773371">b</span><span class="op" id="4773372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773376">l</span><span class="op" id="4773377">.</span><span class="ident" id="4773378">used</span>&nbsp;<span class="op" id="4773383">+=</span>&nbsp;<span class="builtinfunc" id="4773386">len</span><span class="op" id="4773389">(</span><span class="ident" id="4773390">b</span><span class="op" id="4773391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773395">return</span>&nbsp;<span class="builtinfunc" id="4773402">len</span><span class="op" id="4773405">(</span><span class="ident" id="4773406">b</span><span class="op" id="4773407">)</span><span class="op" id="4773408">,</span>&nbsp;<span class="ident" id="4773410">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773415">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773419">n</span><span class="op" id="4773420">,</span>&nbsp;<span class="ident" id="4773422">err</span>&nbsp;<span class="op" id="4773426">=</span>&nbsp;<span class="ident" id="4773428">l</span><span class="op" id="4773429">.</span><span class="ident" id="4773430">out</span><span class="op" id="4773433">.</span><span class="ident" id="4773434">Write</span><span class="op" id="4773439">(</span><span class="ident" id="4773440">l</span><span class="op" id="4773441">.</span><span class="ident" id="4773442">line</span><span class="op" id="4773446">[</span><span class="num" id="4773447">0</span><span class="op" id="4773448">:</span><span class="ident" id="4773449">l</span><span class="op" id="4773450">.</span><span class="ident" id="4773451">used</span><span class="op" id="4773455">]</span><span class="op" id="4773456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773459">if</span>&nbsp;<span class="ident" id="4773462">err</span>&nbsp;<span class="op" id="4773466">!=</span>&nbsp;<span class="ident" id="4773469">nil</span>&nbsp;<span class="op" id="4773473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773477">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773485">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773488">excess</span>&nbsp;<span class="op" id="4773495">:=</span>&nbsp;<span class="ident" id="4773498">pemLineLength</span>&nbsp;<span class="op" id="4773512">-</span>&nbsp;<span class="ident" id="4773514">l</span><span class="op" id="4773515">.</span><span class="ident" id="4773516">used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773522">l</span><span class="op" id="4773523">.</span><span class="ident" id="4773524">used</span>&nbsp;<span class="op" id="4773529">=</span>&nbsp;<span class="num" id="4773531">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773535">n</span><span class="op" id="4773536">,</span>&nbsp;<span class="ident" id="4773538">err</span>&nbsp;<span class="op" id="4773542">=</span>&nbsp;<span class="ident" id="4773544">l</span><span class="op" id="4773545">.</span><span class="ident" id="4773546">out</span><span class="op" id="4773549">.</span><span class="ident" id="4773550">Write</span><span class="op" id="4773555">(</span><span class="ident" id="4773556">b</span><span class="op" id="4773557">[</span><span class="num" id="4773558">0</span><span class="op" id="4773559">:</span><span class="ident" id="4773560">excess</span><span class="op" id="4773566">]</span><span class="op" id="4773567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773570">if</span>&nbsp;<span class="ident" id="4773573">err</span>&nbsp;<span class="op" id="4773577">!=</span>&nbsp;<span class="ident" id="4773580">nil</span>&nbsp;<span class="op" id="4773584">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773588">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773600">n</span><span class="op" id="4773601">,</span>&nbsp;<span class="ident" id="4773603">err</span>&nbsp;<span class="op" id="4773607">=</span>&nbsp;<span class="ident" id="4773609">l</span><span class="op" id="4773610">.</span><span class="ident" id="4773611">out</span><span class="op" id="4773614">.</span><span class="ident" id="4773615">Write</span><span class="op" id="4773620">(</span><span class="op" id="4773621">[</span><span class="op" id="4773622">]</span><span class="builtintype" id="4773623">byte</span><span class="op" id="4773627">{</span><span class="string" id="4773628">&#39;\n&#39;</span><span class="op" id="4773632">}</span><span class="op" id="4773633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773636">if</span>&nbsp;<span class="ident" id="4773639">err</span>&nbsp;<span class="op" id="4773643">!=</span>&nbsp;<span class="ident" id="4773646">nil</span>&nbsp;<span class="op" id="4773650">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773654">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773666">return</span>&nbsp;<span class="ident" id="4773673">l</span><span class="op" id="4773674">.</span><span class="ident" id="4773675">Write</span><span class="op" id="4773680">(</span><span class="ident" id="4773681">b</span><span class="op" id="4773682">[</span><span class="ident" id="4773683">excess</span><span class="op" id="4773689">:</span><span class="op" id="4773690">]</span><span class="op" id="4773691">)</span><br>
<span class="lineno"></span><span class="op" id="4773693">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="4773696">func</span>&nbsp;<span class="op" id="4773701">(</span><span class="ident" id="4773702">l</span>&nbsp;<span class="op" id="4773704">*</span><span class="ident" id="4773705">lineBreaker</span><span class="op" id="4773716">)</span>&nbsp;<span class="ident" id="4773718">Close</span><span class="op" id="4773723">(</span><span class="op" id="4773724">)</span>&nbsp;<span class="op" id="4773726">(</span><span class="ident" id="4773727">err</span>&nbsp;<span class="builtintype" id="4773731">error</span><span class="op" id="4773736">)</span>&nbsp;<span class="op" id="4773738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773741">if</span>&nbsp;<span class="ident" id="4773744">l</span><span class="op" id="4773745">.</span><span class="ident" id="4773746">used</span>&nbsp;<span class="op" id="4773751">&gt;</span>&nbsp;<span class="num" id="4773753">0</span>&nbsp;<span class="op" id="4773755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773759">_</span><span class="op" id="4773760">,</span>&nbsp;<span class="ident" id="4773762">err</span>&nbsp;<span class="op" id="4773766">=</span>&nbsp;<span class="ident" id="4773768">l</span><span class="op" id="4773769">.</span><span class="ident" id="4773770">out</span><span class="op" id="4773773">.</span><span class="ident" id="4773774">Write</span><span class="op" id="4773779">(</span><span class="ident" id="4773780">l</span><span class="op" id="4773781">.</span><span class="ident" id="4773782">line</span><span class="op" id="4773786">[</span><span class="num" id="4773787">0</span><span class="op" id="4773788">:</span><span class="ident" id="4773789">l</span><span class="op" id="4773790">.</span><span class="ident" id="4773791">used</span><span class="op" id="4773795">]</span><span class="op" id="4773796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773800">if</span>&nbsp;<span class="ident" id="4773803">err</span>&nbsp;<span class="op" id="4773807">!=</span>&nbsp;<span class="ident" id="4773810">nil</span>&nbsp;<span class="op" id="4773814">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773819">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773832">_</span><span class="op" id="4773833">,</span>&nbsp;<span class="ident" id="4773835">err</span>&nbsp;<span class="op" id="4773839">=</span>&nbsp;<span class="ident" id="4773841">l</span><span class="op" id="4773842">.</span><span class="ident" id="4773843">out</span><span class="op" id="4773846">.</span><span class="ident" id="4773847">Write</span><span class="op" id="4773852">(</span><span class="op" id="4773853">[</span><span class="op" id="4773854">]</span><span class="builtintype" id="4773855">byte</span><span class="op" id="4773859">{</span><span class="string" id="4773860">&#39;\n&#39;</span><span class="op" id="4773864">}</span><span class="op" id="4773865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773872">return</span><br>
<span class="lineno"></span><span class="op" id="4773879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4773882">func</span>&nbsp;<span class="ident" id="4773887">writeHeader</span><span class="op" id="4773898">(</span><span class="ident" id="4773899">out</span>&nbsp;<span class="ident" id="4773903">io</span><span class="op" id="4773905">.</span><span class="ident" id="4773906">Writer</span><span class="op" id="4773912">,</span>&nbsp;<span class="ident" id="4773914">k</span><span class="op" id="4773915">,</span>&nbsp;<span class="ident" id="4773917">v</span>&nbsp;<span class="builtintype" id="4773919">string</span><span class="op" id="4773925">)</span>&nbsp;<span class="builtintype" id="4773927">error</span>&nbsp;<span class="op" id="4773933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773936">_</span><span class="op" id="4773937">,</span>&nbsp;<span class="ident" id="4773939">err</span>&nbsp;<span class="op" id="4773943">:=</span>&nbsp;<span class="ident" id="4773946">out</span><span class="op" id="4773949">.</span><span class="ident" id="4773950">Write</span><span class="op" id="4773955">(</span><span class="op" id="4773956">[</span><span class="op" id="4773957">]</span><span class="builtintype" id="4773958">byte</span><span class="op" id="4773962">(</span><span class="ident" id="4773963">k</span>&nbsp;<span class="op" id="4773965">+</span>&nbsp;<span class="string" id="4773967">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4773972">+</span>&nbsp;<span class="ident" id="4773974">v</span>&nbsp;<span class="op" id="4773976">+</span>&nbsp;<span class="string" id="4773978">&#34;\n&#34;</span><span class="op" id="4773982">)</span><span class="op" id="4773983">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773986">return</span>&nbsp;<span class="ident" id="4773993">err</span><br>
<span class="lineno"></span><span class="op" id="4773997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774000">func</span>&nbsp;<span class="ident" id="4774005">Encode</span><span class="op" id="4774011">(</span><span class="ident" id="4774012">out</span>&nbsp;<span class="ident" id="4774016">io</span><span class="op" id="4774018">.</span><span class="ident" id="4774019">Writer</span><span class="op" id="4774025">,</span>&nbsp;<span class="ident" id="4774027">b</span>&nbsp;<span class="op" id="4774029">*</span><span class="ident" id="4774030">Block</span><span class="op" id="4774035">)</span>&nbsp;<span class="builtintype" id="4774037">error</span>&nbsp;<span class="op" id="4774043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774046">if</span>&nbsp;<span class="ident" id="4774049">_</span><span class="op" id="4774050">,</span>&nbsp;<span class="ident" id="4774052">err</span>&nbsp;<span class="op" id="4774056">:=</span>&nbsp;<span class="ident" id="4774059">out</span><span class="op" id="4774062">.</span><span class="ident" id="4774063">Write</span><span class="op" id="4774068">(</span><span class="ident" id="4774069">pemStart</span><span class="op" id="4774077">[</span><span class="num" id="4774078">1</span><span class="op" id="4774079">:</span><span class="op" id="4774080">]</span><span class="op" id="4774081">)</span><span class="op" id="4774082">;</span>&nbsp;<span class="ident" id="4774084">err</span>&nbsp;<span class="op" id="4774088">!=</span>&nbsp;<span class="ident" id="4774091">nil</span>&nbsp;<span class="op" id="4774095">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774099">return</span>&nbsp;<span class="ident" id="4774106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774114">if</span>&nbsp;<span class="ident" id="4774117">_</span><span class="op" id="4774118">,</span>&nbsp;<span class="ident" id="4774120">err</span>&nbsp;<span class="op" id="4774124">:=</span>&nbsp;<span class="ident" id="4774127">out</span><span class="op" id="4774130">.</span><span class="ident" id="4774131">Write</span><span class="op" id="4774136">(</span><span class="op" id="4774137">[</span><span class="op" id="4774138">]</span><span class="builtintype" id="4774139">byte</span><span class="op" id="4774143">(</span><span class="ident" id="4774144">b</span><span class="op" id="4774145">.</span><span class="ident" id="4774146">Type</span>&nbsp;<span class="op" id="4774151">+</span>&nbsp;<span class="string" id="4774153">&#34;-----\n&#34;</span><span class="op" id="4774162">)</span><span class="op" id="4774163">)</span><span class="op" id="4774164">;</span>&nbsp;<span class="ident" id="4774166">err</span>&nbsp;<span class="op" id="4774170">!=</span>&nbsp;<span class="ident" id="4774173">nil</span>&nbsp;<span class="op" id="4774177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774181">return</span>&nbsp;<span class="ident" id="4774188">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774193">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774197">if</span>&nbsp;<span class="builtinfunc" id="4774200">len</span><span class="op" id="4774203">(</span><span class="ident" id="4774204">b</span><span class="op" id="4774205">.</span><span class="ident" id="4774206">Headers</span><span class="op" id="4774213">)</span>&nbsp;<span class="op" id="4774215">&gt;</span>&nbsp;<span class="num" id="4774217">0</span>&nbsp;<span class="op" id="4774219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774223">const</span>&nbsp;<span class="ident" id="4774229">procType</span>&nbsp;<span class="op" id="4774238">=</span>&nbsp;<span class="string" id="4774240">&#34;Proc-Type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774254">h</span>&nbsp;<span class="op" id="4774256">:=</span>&nbsp;<span class="builtinfunc" id="4774259">make</span><span class="op" id="4774263">(</span><span class="op" id="4774264">[</span><span class="op" id="4774265">]</span><span class="builtintype" id="4774266">string</span><span class="op" id="4774272">,</span>&nbsp;<span class="num" id="4774274">0</span><span class="op" id="4774275">,</span>&nbsp;<span class="builtinfunc" id="4774277">len</span><span class="op" id="4774280">(</span><span class="ident" id="4774281">b</span><span class="op" id="4774282">.</span><span class="ident" id="4774283">Headers</span><span class="op" id="4774290">)</span><span class="op" id="4774291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774295">hasProcType</span>&nbsp;<span class="op" id="4774307">:=</span>&nbsp;<span class="builtintype" id="4774310">false</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774318">for</span>&nbsp;<span class="ident" id="4774322">k</span>&nbsp;<span class="op" id="4774324">:=</span>&nbsp;<span class="keyword" id="4774327">range</span>&nbsp;<span class="ident" id="4774333">b</span><span class="op" id="4774334">.</span><span class="ident" id="4774335">Headers</span>&nbsp;<span class="op" id="4774343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774348">if</span>&nbsp;<span class="ident" id="4774351">k</span>&nbsp;<span class="op" id="4774353">==</span>&nbsp;<span class="ident" id="4774356">procType</span>&nbsp;<span class="op" id="4774365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774371">hasProcType</span>&nbsp;<span class="op" id="4774383">=</span>&nbsp;<span class="builtintype" id="4774385">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774394">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774406">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774411">h</span>&nbsp;<span class="op" id="4774413">=</span>&nbsp;<span class="builtinfunc" id="4774415">append</span><span class="op" id="4774421">(</span><span class="ident" id="4774422">h</span><span class="op" id="4774423">,</span>&nbsp;<span class="ident" id="4774425">k</span><span class="op" id="4774426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4774434">//&nbsp;The&nbsp;Proc-Type&nbsp;header&nbsp;must&nbsp;be&nbsp;written&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4774483">//&nbsp;See&nbsp;RFC&nbsp;1421,&nbsp;section&nbsp;4.6.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774518">if</span>&nbsp;<span class="ident" id="4774521">hasProcType</span>&nbsp;<span class="op" id="4774533">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774538">if</span>&nbsp;<span class="ident" id="4774541">err</span>&nbsp;<span class="op" id="4774545">:=</span>&nbsp;<span class="ident" id="4774548">writeHeader</span><span class="op" id="4774559">(</span><span class="ident" id="4774560">out</span><span class="op" id="4774563">,</span>&nbsp;<span class="ident" id="4774565">procType</span><span class="op" id="4774573">,</span>&nbsp;<span class="ident" id="4774575">b</span><span class="op" id="4774576">.</span><span class="ident" id="4774577">Headers</span><span class="op" id="4774584">[</span><span class="ident" id="4774585">procType</span><span class="op" id="4774593">]</span><span class="op" id="4774594">)</span><span class="op" id="4774595">;</span>&nbsp;<span class="ident" id="4774597">err</span>&nbsp;<span class="op" id="4774601">!=</span>&nbsp;<span class="ident" id="4774604">nil</span>&nbsp;<span class="op" id="4774608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774614">return</span>&nbsp;<span class="ident" id="4774621">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4774636">//&nbsp;For&nbsp;consistency&nbsp;of&nbsp;output,&nbsp;write&nbsp;other&nbsp;headers&nbsp;sorted&nbsp;by&nbsp;key.</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774703">sort</span><span class="op" id="4774707">.</span><span class="ident" id="4774708">Strings</span><span class="op" id="4774715">(</span><span class="ident" id="4774716">h</span><span class="op" id="4774717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774721">for</span>&nbsp;<span class="ident" id="4774725">_</span><span class="op" id="4774726">,</span>&nbsp;<span class="ident" id="4774728">k</span>&nbsp;<span class="op" id="4774730">:=</span>&nbsp;<span class="keyword" id="4774733">range</span>&nbsp;<span class="ident" id="4774739">h</span>&nbsp;<span class="op" id="4774741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774746">if</span>&nbsp;<span class="ident" id="4774749">err</span>&nbsp;<span class="op" id="4774753">:=</span>&nbsp;<span class="ident" id="4774756">writeHeader</span><span class="op" id="4774767">(</span><span class="ident" id="4774768">out</span><span class="op" id="4774771">,</span>&nbsp;<span class="ident" id="4774773">k</span><span class="op" id="4774774">,</span>&nbsp;<span class="ident" id="4774776">b</span><span class="op" id="4774777">.</span><span class="ident" id="4774778">Headers</span><span class="op" id="4774785">[</span><span class="ident" id="4774786">k</span><span class="op" id="4774787">]</span><span class="op" id="4774788">)</span><span class="op" id="4774789">;</span>&nbsp;<span class="ident" id="4774791">err</span>&nbsp;<span class="op" id="4774795">!=</span>&nbsp;<span class="ident" id="4774798">nil</span>&nbsp;<span class="op" id="4774802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774808">return</span>&nbsp;<span class="ident" id="4774815">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774822">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774830">if</span>&nbsp;<span class="ident" id="4774833">_</span><span class="op" id="4774834">,</span>&nbsp;<span class="ident" id="4774836">err</span>&nbsp;<span class="op" id="4774840">:=</span>&nbsp;<span class="ident" id="4774843">out</span><span class="op" id="4774846">.</span><span class="ident" id="4774847">Write</span><span class="op" id="4774852">(</span><span class="op" id="4774853">[</span><span class="op" id="4774854">]</span><span class="builtintype" id="4774855">byte</span><span class="op" id="4774859">{</span><span class="string" id="4774860">&#39;\n&#39;</span><span class="op" id="4774864">}</span><span class="op" id="4774865">)</span><span class="op" id="4774866">;</span>&nbsp;<span class="ident" id="4774868">err</span>&nbsp;<span class="op" id="4774872">!=</span>&nbsp;<span class="ident" id="4774875">nil</span>&nbsp;<span class="op" id="4774879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774884">return</span>&nbsp;<span class="ident" id="4774891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774900">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774904">var</span>&nbsp;<span class="ident" id="4774908">breaker</span>&nbsp;<span class="ident" id="4774916">lineBreaker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774929">breaker</span><span class="op" id="4774936">.</span><span class="ident" id="4774937">out</span>&nbsp;<span class="op" id="4774941">=</span>&nbsp;<span class="ident" id="4774943">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774949">b64</span>&nbsp;<span class="op" id="4774953">:=</span>&nbsp;<span class="ident" id="4774956">base64</span><span class="op" id="4774962">.</span><span class="ident" id="4774963">NewEncoder</span><span class="op" id="4774973">(</span><span class="ident" id="4774974">base64</span><span class="op" id="4774980">.</span><span class="ident" id="4774981">StdEncoding</span><span class="op" id="4774992">,</span>&nbsp;<span class="op" id="4774994">&amp;</span><span class="ident" id="4774995">breaker</span><span class="op" id="4775002">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775005">if</span>&nbsp;<span class="ident" id="4775008">_</span><span class="op" id="4775009">,</span>&nbsp;<span class="ident" id="4775011">err</span>&nbsp;<span class="op" id="4775015">:=</span>&nbsp;<span class="ident" id="4775018">b64</span><span class="op" id="4775021">.</span><span class="ident" id="4775022">Write</span><span class="op" id="4775027">(</span><span class="ident" id="4775028">b</span><span class="op" id="4775029">.</span><span class="ident" id="4775030">Bytes</span><span class="op" id="4775035">)</span><span class="op" id="4775036">;</span>&nbsp;<span class="ident" id="4775038">err</span>&nbsp;<span class="op" id="4775042">!=</span>&nbsp;<span class="ident" id="4775045">nil</span>&nbsp;<span class="op" id="4775049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775053">return</span>&nbsp;<span class="ident" id="4775060">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775068">b64</span><span class="op" id="4775071">.</span><span class="ident" id="4775072">Close</span><span class="op" id="4775077">(</span><span class="op" id="4775078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775081">breaker</span><span class="op" id="4775088">.</span><span class="ident" id="4775089">Close</span><span class="op" id="4775094">(</span><span class="op" id="4775095">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775099">if</span>&nbsp;<span class="ident" id="4775102">_</span><span class="op" id="4775103">,</span>&nbsp;<span class="ident" id="4775105">err</span>&nbsp;<span class="op" id="4775109">:=</span>&nbsp;<span class="ident" id="4775112">out</span><span class="op" id="4775115">.</span><span class="ident" id="4775116">Write</span><span class="op" id="4775121">(</span><span class="ident" id="4775122">pemEnd</span><span class="op" id="4775128">[</span><span class="num" id="4775129">1</span><span class="op" id="4775130">:</span><span class="op" id="4775131">]</span><span class="op" id="4775132">)</span><span class="op" id="4775133">;</span>&nbsp;<span class="ident" id="4775135">err</span>&nbsp;<span class="op" id="4775139">!=</span>&nbsp;<span class="ident" id="4775142">nil</span>&nbsp;<span class="op" id="4775146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775150">return</span>&nbsp;<span class="ident" id="4775157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775165">_</span><span class="op" id="4775166">,</span>&nbsp;<span class="ident" id="4775168">err</span>&nbsp;<span class="op" id="4775172">:=</span>&nbsp;<span class="ident" id="4775175">out</span><span class="op" id="4775178">.</span><span class="ident" id="4775179">Write</span><span class="op" id="4775184">(</span><span class="op" id="4775185">[</span><span class="op" id="4775186">]</span><span class="builtintype" id="4775187">byte</span><span class="op" id="4775191">(</span><span class="ident" id="4775192">b</span><span class="op" id="4775193">.</span><span class="ident" id="4775194">Type</span>&nbsp;<span class="op" id="4775199">+</span>&nbsp;<span class="string" id="4775201">&#34;-----\n&#34;</span><span class="op" id="4775210">)</span><span class="op" id="4775211">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775214">return</span>&nbsp;<span class="ident" id="4775221">err</span><br>
<span class="lineno"></span><span class="op" id="4775225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4775228">func</span>&nbsp;<span class="ident" id="4775233">EncodeToMemory</span><span class="op" id="4775247">(</span><span class="ident" id="4775248">b</span>&nbsp;<span class="op" id="4775250">*</span><span class="ident" id="4775251">Block</span><span class="op" id="4775256">)</span>&nbsp;<span class="op" id="4775258">[</span><span class="op" id="4775259">]</span><span class="builtintype" id="4775260">byte</span>&nbsp;<span class="op" id="4775265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775268">var</span>&nbsp;<span class="ident" id="4775272">buf</span>&nbsp;<span class="ident" id="4775276">bytes</span><span class="op" id="4775281">.</span><span class="ident" id="4775282">Buffer</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775290">Encode</span><span class="op" id="4775296">(</span><span class="op" id="4775297">&amp;</span><span class="ident" id="4775298">buf</span><span class="op" id="4775301">,</span>&nbsp;<span class="ident" id="4775303">b</span><span class="op" id="4775304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775307">return</span>&nbsp;<span class="ident" id="4775314">buf</span><span class="op" id="4775317">.</span><span class="ident" id="4775318">Bytes</span><span class="op" id="4775323">(</span><span class="op" id="4775324">)</span><br>
<span class="lineno"></span><span class="op" id="4775326">}</span>
</div>
</body>
</html>
