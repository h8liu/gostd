<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6004725">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6004780">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6004834">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6004885">package</span>&nbsp;<span class="ident" id="6004893">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6004898">import</span>&nbsp;<span class="op" id="6004905">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004908">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004917">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004933">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004943">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004952">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004967">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6004990">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6005004">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6005009">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6005012">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="6005049">const</span>&nbsp;<span class="op" id="6005055">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005058">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6005070">=</span>&nbsp;<span class="num" id="6005072">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005078">gcBlockSize</span>&nbsp;<span class="op" id="6005090">=</span>&nbsp;<span class="num" id="6005092">0x04</span><br>
<span class="lineno"></span><span class="op" id="6005097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6005100">var</span>&nbsp;<span class="ident" id="6005104">log2Lookup</span>&nbsp;<span class="op" id="6005115">=</span>&nbsp;<span class="op" id="6005117">[</span><span class="num" id="6005118">8</span><span class="op" id="6005119">]</span><span class="builtintype" id="6005120">int</span><span class="op" id="6005123">{</span><span class="num" id="6005124">2</span><span class="op" id="6005125">,</span>&nbsp;<span class="num" id="6005127">4</span><span class="op" id="6005128">,</span>&nbsp;<span class="num" id="6005130">8</span><span class="op" id="6005131">,</span>&nbsp;<span class="num" id="6005133">16</span><span class="op" id="6005135">,</span>&nbsp;<span class="num" id="6005137">32</span><span class="op" id="6005139">,</span>&nbsp;<span class="num" id="6005141">64</span><span class="op" id="6005143">,</span>&nbsp;<span class="num" id="6005145">128</span><span class="op" id="6005148">,</span>&nbsp;<span class="num" id="6005150">256</span><span class="op" id="6005153">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6005156">func</span>&nbsp;<span class="ident" id="6005161">log2</span><span class="op" id="6005165">(</span><span class="ident" id="6005166">x</span>&nbsp;<span class="builtintype" id="6005168">int</span><span class="op" id="6005171">)</span>&nbsp;<span class="builtintype" id="6005173">int</span>&nbsp;<span class="op" id="6005177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005180">for</span>&nbsp;<span class="ident" id="6005184">i</span><span class="op" id="6005185">,</span>&nbsp;<span class="ident" id="6005187">v</span>&nbsp;<span class="op" id="6005189">:=</span>&nbsp;<span class="keyword" id="6005192">range</span>&nbsp;<span class="ident" id="6005198">log2Lookup</span>&nbsp;<span class="op" id="6005209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005213">if</span>&nbsp;<span class="ident" id="6005216">x</span>&nbsp;<span class="op" id="6005218">&lt;=</span>&nbsp;<span class="ident" id="6005221">v</span>&nbsp;<span class="op" id="6005223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005228">return</span>&nbsp;<span class="ident" id="6005235">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6005239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6005242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005245">return</span>&nbsp;<span class="op" id="6005252">-</span><span class="num" id="6005253">1</span><br>
<span class="lineno"></span><span class="op" id="6005255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6005258">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6005276">func</span>&nbsp;<span class="ident" id="6005281">writeUint16</span><span class="op" id="6005292">(</span><span class="ident" id="6005293">b</span>&nbsp;<span class="op" id="6005295">[</span><span class="op" id="6005296">]</span><span class="builtintype" id="6005297">uint8</span><span class="op" id="6005302">,</span>&nbsp;<span class="ident" id="6005304">u</span>&nbsp;<span class="builtintype" id="6005306">uint16</span><span class="op" id="6005312">)</span>&nbsp;<span class="op" id="6005314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005317">b</span><span class="op" id="6005318">[</span><span class="num" id="6005319">0</span><span class="op" id="6005320">]</span>&nbsp;<span class="op" id="6005322">=</span>&nbsp;<span class="builtintype" id="6005324">uint8</span><span class="op" id="6005329">(</span><span class="ident" id="6005330">u</span><span class="op" id="6005331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005334">b</span><span class="op" id="6005335">[</span><span class="num" id="6005336">1</span><span class="op" id="6005337">]</span>&nbsp;<span class="op" id="6005339">=</span>&nbsp;<span class="builtintype" id="6005341">uint8</span><span class="op" id="6005346">(</span><span class="ident" id="6005347">u</span>&nbsp;<span class="op" id="6005349">&gt;&gt;</span>&nbsp;<span class="num" id="6005352">8</span><span class="op" id="6005353">)</span><br>
<span class="lineno"></span><span class="op" id="6005355">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6005358">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6005390">type</span>&nbsp;<span class="ident" id="6005395">writer</span>&nbsp;<span class="keyword" id="6005402">interface</span>&nbsp;<span class="op" id="6005412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005415">Flush</span><span class="op" id="6005420">(</span><span class="op" id="6005421">)</span>&nbsp;<span class="builtintype" id="6005423">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005430">io</span><span class="op" id="6005432">.</span><span class="ident" id="6005433">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005441">io</span><span class="op" id="6005443">.</span><span class="ident" id="6005444">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="6005455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6005458">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6005505">type</span>&nbsp;<span class="ident" id="6005510">encoder</span>&nbsp;<span class="keyword" id="6005518">struct</span>&nbsp;<span class="op" id="6005525">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005528">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005603">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005674">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6005678">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005686">err</span>&nbsp;<span class="builtintype" id="6005690">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005697">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005753">g</span>&nbsp;<span class="op" id="6005755">*</span><span class="ident" id="6005756">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005761">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005845">buf</span>&nbsp;<span class="op" id="6005849">[</span><span class="num" id="6005850">1024</span><span class="op" id="6005854">]</span><span class="builtintype" id="6005855">byte</span><br>
<span class="lineno"></span><span class="op" id="6005860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6005863">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6005930">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6005996">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6006060">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="6006073">type</span>&nbsp;<span class="ident" id="6006078">blockWriter</span>&nbsp;<span class="keyword" id="6006090">struct</span>&nbsp;<span class="op" id="6006097">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006100">e</span>&nbsp;<span class="op" id="6006102">*</span><span class="ident" id="6006103">encoder</span><br>
<span class="lineno"></span><span class="op" id="6006111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6006114">func</span>&nbsp;<span class="op" id="6006119">(</span><span class="ident" id="6006120">b</span>&nbsp;<span class="ident" id="6006122">blockWriter</span><span class="op" id="6006133">)</span>&nbsp;<span class="ident" id="6006135">Write</span><span class="op" id="6006140">(</span><span class="ident" id="6006141">data</span>&nbsp;<span class="op" id="6006146">[</span><span class="op" id="6006147">]</span><span class="builtintype" id="6006148">byte</span><span class="op" id="6006152">)</span>&nbsp;<span class="op" id="6006154">(</span><span class="builtintype" id="6006155">int</span><span class="op" id="6006158">,</span>&nbsp;<span class="builtintype" id="6006160">error</span><span class="op" id="6006165">)</span>&nbsp;<span class="op" id="6006167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006170">if</span>&nbsp;<span class="ident" id="6006173">b</span><span class="op" id="6006174">.</span><span class="ident" id="6006175">e</span><span class="op" id="6006176">.</span><span class="ident" id="6006177">err</span>&nbsp;<span class="op" id="6006181">!=</span>&nbsp;<span class="ident" id="6006184">nil</span>&nbsp;<span class="op" id="6006188">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006192">return</span>&nbsp;<span class="num" id="6006199">0</span><span class="op" id="6006200">,</span>&nbsp;<span class="ident" id="6006202">b</span><span class="op" id="6006203">.</span><span class="ident" id="6006204">e</span><span class="op" id="6006205">.</span><span class="ident" id="6006206">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006214">if</span>&nbsp;<span class="builtinfunc" id="6006217">len</span><span class="op" id="6006220">(</span><span class="ident" id="6006221">data</span><span class="op" id="6006225">)</span>&nbsp;<span class="op" id="6006227">==</span>&nbsp;<span class="num" id="6006230">0</span>&nbsp;<span class="op" id="6006232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006236">return</span>&nbsp;<span class="num" id="6006243">0</span><span class="op" id="6006244">,</span>&nbsp;<span class="ident" id="6006246">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006251">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006254">total</span>&nbsp;<span class="op" id="6006260">:=</span>&nbsp;<span class="num" id="6006263">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006266">for</span>&nbsp;<span class="ident" id="6006270">total</span>&nbsp;<span class="op" id="6006276">&lt;</span>&nbsp;<span class="builtinfunc" id="6006278">len</span><span class="op" id="6006281">(</span><span class="ident" id="6006282">data</span><span class="op" id="6006286">)</span>&nbsp;<span class="op" id="6006288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006292">n</span>&nbsp;<span class="op" id="6006294">:=</span>&nbsp;<span class="builtinfunc" id="6006297">copy</span><span class="op" id="6006301">(</span><span class="ident" id="6006302">b</span><span class="op" id="6006303">.</span><span class="ident" id="6006304">e</span><span class="op" id="6006305">.</span><span class="ident" id="6006306">buf</span><span class="op" id="6006309">[</span><span class="num" id="6006310">1</span><span class="op" id="6006311">:</span><span class="num" id="6006312">256</span><span class="op" id="6006315">]</span><span class="op" id="6006316">,</span>&nbsp;<span class="ident" id="6006318">data</span><span class="op" id="6006322">[</span><span class="ident" id="6006323">total</span><span class="op" id="6006328">:</span><span class="op" id="6006329">]</span><span class="op" id="6006330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006334">total</span>&nbsp;<span class="op" id="6006340">+=</span>&nbsp;<span class="ident" id="6006343">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006347">b</span><span class="op" id="6006348">.</span><span class="ident" id="6006349">e</span><span class="op" id="6006350">.</span><span class="ident" id="6006351">buf</span><span class="op" id="6006354">[</span><span class="num" id="6006355">0</span><span class="op" id="6006356">]</span>&nbsp;<span class="op" id="6006358">=</span>&nbsp;<span class="builtintype" id="6006360">uint8</span><span class="op" id="6006365">(</span><span class="ident" id="6006366">n</span><span class="op" id="6006367">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006372">n</span><span class="op" id="6006373">,</span>&nbsp;<span class="ident" id="6006375">b</span><span class="op" id="6006376">.</span><span class="ident" id="6006377">e</span><span class="op" id="6006378">.</span><span class="ident" id="6006379">err</span>&nbsp;<span class="op" id="6006383">=</span>&nbsp;<span class="ident" id="6006385">b</span><span class="op" id="6006386">.</span><span class="ident" id="6006387">e</span><span class="op" id="6006388">.</span><span class="ident" id="6006389">w</span><span class="op" id="6006390">.</span><span class="ident" id="6006391">Write</span><span class="op" id="6006396">(</span><span class="ident" id="6006397">b</span><span class="op" id="6006398">.</span><span class="ident" id="6006399">e</span><span class="op" id="6006400">.</span><span class="ident" id="6006401">buf</span><span class="op" id="6006404">[</span><span class="op" id="6006405">:</span><span class="ident" id="6006406">n</span><span class="op" id="6006407">+</span><span class="num" id="6006408">1</span><span class="op" id="6006409">]</span><span class="op" id="6006410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006414">if</span>&nbsp;<span class="ident" id="6006417">b</span><span class="op" id="6006418">.</span><span class="ident" id="6006419">e</span><span class="op" id="6006420">.</span><span class="ident" id="6006421">err</span>&nbsp;<span class="op" id="6006425">!=</span>&nbsp;<span class="ident" id="6006428">nil</span>&nbsp;<span class="op" id="6006432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006437">return</span>&nbsp;<span class="num" id="6006444">0</span><span class="op" id="6006445">,</span>&nbsp;<span class="ident" id="6006447">b</span><span class="op" id="6006448">.</span><span class="ident" id="6006449">e</span><span class="op" id="6006450">.</span><span class="ident" id="6006451">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006457">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006463">return</span>&nbsp;<span class="ident" id="6006470">total</span><span class="op" id="6006475">,</span>&nbsp;<span class="ident" id="6006477">b</span><span class="op" id="6006478">.</span><span class="ident" id="6006479">e</span><span class="op" id="6006480">.</span><span class="ident" id="6006481">err</span><br>
<span class="lineno"></span><span class="op" id="6006485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6006488">func</span>&nbsp;<span class="op" id="6006493">(</span><span class="ident" id="6006494">e</span>&nbsp;<span class="op" id="6006496">*</span><span class="ident" id="6006497">encoder</span><span class="op" id="6006504">)</span>&nbsp;<span class="ident" id="6006506">flush</span><span class="op" id="6006511">(</span><span class="op" id="6006512">)</span>&nbsp;<span class="op" id="6006514">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006517">if</span>&nbsp;<span class="ident" id="6006520">e</span><span class="op" id="6006521">.</span><span class="ident" id="6006522">err</span>&nbsp;<span class="op" id="6006526">!=</span>&nbsp;<span class="ident" id="6006529">nil</span>&nbsp;<span class="op" id="6006533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006537">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006548">e</span><span class="op" id="6006549">.</span><span class="ident" id="6006550">err</span>&nbsp;<span class="op" id="6006554">=</span>&nbsp;<span class="ident" id="6006556">e</span><span class="op" id="6006557">.</span><span class="ident" id="6006558">w</span><span class="op" id="6006559">.</span><span class="ident" id="6006560">Flush</span><span class="op" id="6006565">(</span><span class="op" id="6006566">)</span><br>
<span class="lineno"></span><span class="op" id="6006568">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="6006571">func</span>&nbsp;<span class="op" id="6006576">(</span><span class="ident" id="6006577">e</span>&nbsp;<span class="op" id="6006579">*</span><span class="ident" id="6006580">encoder</span><span class="op" id="6006587">)</span>&nbsp;<span class="ident" id="6006589">write</span><span class="op" id="6006594">(</span><span class="ident" id="6006595">p</span>&nbsp;<span class="op" id="6006597">[</span><span class="op" id="6006598">]</span><span class="builtintype" id="6006599">byte</span><span class="op" id="6006603">)</span>&nbsp;<span class="op" id="6006605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006608">if</span>&nbsp;<span class="ident" id="6006611">e</span><span class="op" id="6006612">.</span><span class="ident" id="6006613">err</span>&nbsp;<span class="op" id="6006617">!=</span>&nbsp;<span class="ident" id="6006620">nil</span>&nbsp;<span class="op" id="6006624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006628">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006636">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006639">_</span><span class="op" id="6006640">,</span>&nbsp;<span class="ident" id="6006642">e</span><span class="op" id="6006643">.</span><span class="ident" id="6006644">err</span>&nbsp;<span class="op" id="6006648">=</span>&nbsp;<span class="ident" id="6006650">e</span><span class="op" id="6006651">.</span><span class="ident" id="6006652">w</span><span class="op" id="6006653">.</span><span class="ident" id="6006654">Write</span><span class="op" id="6006659">(</span><span class="ident" id="6006660">p</span><span class="op" id="6006661">)</span><br>
<span class="lineno"></span><span class="op" id="6006663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6006666">func</span>&nbsp;<span class="op" id="6006671">(</span><span class="ident" id="6006672">e</span>&nbsp;<span class="op" id="6006674">*</span><span class="ident" id="6006675">encoder</span><span class="op" id="6006682">)</span>&nbsp;<span class="ident" id="6006684">writeByte</span><span class="op" id="6006693">(</span><span class="ident" id="6006694">b</span>&nbsp;<span class="builtintype" id="6006696">byte</span><span class="op" id="6006700">)</span>&nbsp;<span class="op" id="6006702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006705">if</span>&nbsp;<span class="ident" id="6006708">e</span><span class="op" id="6006709">.</span><span class="ident" id="6006710">err</span>&nbsp;<span class="op" id="6006714">!=</span>&nbsp;<span class="ident" id="6006717">nil</span>&nbsp;<span class="op" id="6006721">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006725">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006736">e</span><span class="op" id="6006737">.</span><span class="ident" id="6006738">err</span>&nbsp;<span class="op" id="6006742">=</span>&nbsp;<span class="ident" id="6006744">e</span><span class="op" id="6006745">.</span><span class="ident" id="6006746">w</span><span class="op" id="6006747">.</span><span class="ident" id="6006748">WriteByte</span><span class="op" id="6006757">(</span><span class="ident" id="6006758">b</span><span class="op" id="6006759">)</span><br>
<span class="lineno"></span><span class="op" id="6006761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6006764">func</span>&nbsp;<span class="op" id="6006769">(</span><span class="ident" id="6006770">e</span>&nbsp;<span class="op" id="6006772">*</span><span class="ident" id="6006773">encoder</span><span class="op" id="6006780">)</span>&nbsp;<span class="ident" id="6006782">writeHeader</span><span class="op" id="6006793">(</span><span class="op" id="6006794">)</span>&nbsp;<span class="op" id="6006796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006799">if</span>&nbsp;<span class="ident" id="6006802">e</span><span class="op" id="6006803">.</span><span class="ident" id="6006804">err</span>&nbsp;<span class="op" id="6006808">!=</span>&nbsp;<span class="ident" id="6006811">nil</span>&nbsp;<span class="op" id="6006815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006819">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006830">_</span><span class="op" id="6006831">,</span>&nbsp;<span class="ident" id="6006833">e</span><span class="op" id="6006834">.</span><span class="ident" id="6006835">err</span>&nbsp;<span class="op" id="6006839">=</span>&nbsp;<span class="ident" id="6006841">io</span><span class="op" id="6006843">.</span><span class="ident" id="6006844">WriteString</span><span class="op" id="6006855">(</span><span class="ident" id="6006856">e</span><span class="op" id="6006857">.</span><span class="ident" id="6006858">w</span><span class="op" id="6006859">,</span>&nbsp;<span class="string" id="6006861">&#34;GIF89a&#34;</span><span class="op" id="6006869">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006872">if</span>&nbsp;<span class="ident" id="6006875">e</span><span class="op" id="6006876">.</span><span class="ident" id="6006877">err</span>&nbsp;<span class="op" id="6006881">!=</span>&nbsp;<span class="ident" id="6006884">nil</span>&nbsp;<span class="op" id="6006888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006892">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006904">pm</span>&nbsp;<span class="op" id="6006907">:=</span>&nbsp;<span class="ident" id="6006910">e</span><span class="op" id="6006911">.</span><span class="ident" id="6006912">g</span><span class="op" id="6006913">.</span><span class="ident" id="6006914">Image</span><span class="op" id="6006919">[</span><span class="num" id="6006920">0</span><span class="op" id="6006921">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6006924">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006961">writeUint16</span><span class="op" id="6006972">(</span><span class="ident" id="6006973">e</span><span class="op" id="6006974">.</span><span class="ident" id="6006975">buf</span><span class="op" id="6006978">[</span><span class="num" id="6006979">0</span><span class="op" id="6006980">:</span><span class="num" id="6006981">2</span><span class="op" id="6006982">]</span><span class="op" id="6006983">,</span>&nbsp;<span class="builtintype" id="6006985">uint16</span><span class="op" id="6006991">(</span><span class="ident" id="6006992">pm</span><span class="op" id="6006994">.</span><span class="ident" id="6006995">Bounds</span><span class="op" id="6007001">(</span><span class="op" id="6007002">)</span><span class="op" id="6007003">.</span><span class="ident" id="6007004">Dx</span><span class="op" id="6007006">(</span><span class="op" id="6007007">)</span><span class="op" id="6007008">)</span><span class="op" id="6007009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007012">writeUint16</span><span class="op" id="6007023">(</span><span class="ident" id="6007024">e</span><span class="op" id="6007025">.</span><span class="ident" id="6007026">buf</span><span class="op" id="6007029">[</span><span class="num" id="6007030">2</span><span class="op" id="6007031">:</span><span class="num" id="6007032">4</span><span class="op" id="6007033">]</span><span class="op" id="6007034">,</span>&nbsp;<span class="builtintype" id="6007036">uint16</span><span class="op" id="6007042">(</span><span class="ident" id="6007043">pm</span><span class="op" id="6007045">.</span><span class="ident" id="6007046">Bounds</span><span class="op" id="6007052">(</span><span class="op" id="6007053">)</span><span class="op" id="6007054">.</span><span class="ident" id="6007055">Dy</span><span class="op" id="6007057">(</span><span class="op" id="6007058">)</span><span class="op" id="6007059">)</span><span class="op" id="6007060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007063">e</span><span class="op" id="6007064">.</span><span class="ident" id="6007065">write</span><span class="op" id="6007070">(</span><span class="ident" id="6007071">e</span><span class="op" id="6007072">.</span><span class="ident" id="6007073">buf</span><span class="op" id="6007076">[</span><span class="op" id="6007077">:</span><span class="num" id="6007078">4</span><span class="op" id="6007079">]</span><span class="op" id="6007080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6007084">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6007149">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007168">e</span><span class="op" id="6007169">.</span><span class="ident" id="6007170">buf</span><span class="op" id="6007173">[</span><span class="num" id="6007174">0</span><span class="op" id="6007175">]</span>&nbsp;<span class="op" id="6007177">=</span>&nbsp;<span class="num" id="6007179">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007185">e</span><span class="op" id="6007186">.</span><span class="ident" id="6007187">buf</span><span class="op" id="6007190">[</span><span class="num" id="6007191">1</span><span class="op" id="6007192">]</span>&nbsp;<span class="op" id="6007194">=</span>&nbsp;<span class="num" id="6007196">0x00</span>&nbsp;<span class="comment" id="6007201">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007229">e</span><span class="op" id="6007230">.</span><span class="ident" id="6007231">buf</span><span class="op" id="6007234">[</span><span class="num" id="6007235">2</span><span class="op" id="6007236">]</span>&nbsp;<span class="op" id="6007238">=</span>&nbsp;<span class="num" id="6007240">0x00</span>&nbsp;<span class="comment" id="6007245">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007269">e</span><span class="op" id="6007270">.</span><span class="ident" id="6007271">write</span><span class="op" id="6007276">(</span><span class="ident" id="6007277">e</span><span class="op" id="6007278">.</span><span class="ident" id="6007279">buf</span><span class="op" id="6007282">[</span><span class="op" id="6007283">:</span><span class="num" id="6007284">3</span><span class="op" id="6007285">]</span><span class="op" id="6007286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6007290">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007327">if</span>&nbsp;<span class="builtinfunc" id="6007330">len</span><span class="op" id="6007333">(</span><span class="ident" id="6007334">e</span><span class="op" id="6007335">.</span><span class="ident" id="6007336">g</span><span class="op" id="6007337">.</span><span class="ident" id="6007338">Image</span><span class="op" id="6007343">)</span>&nbsp;<span class="op" id="6007345">&gt;</span>&nbsp;<span class="num" id="6007347">1</span>&nbsp;<span class="op" id="6007349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007353">e</span><span class="op" id="6007354">.</span><span class="ident" id="6007355">buf</span><span class="op" id="6007358">[</span><span class="num" id="6007359">0</span><span class="op" id="6007360">]</span>&nbsp;<span class="op" id="6007362">=</span>&nbsp;<span class="num" id="6007364">0x21</span>&nbsp;<span class="comment" id="6007369">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007396">e</span><span class="op" id="6007397">.</span><span class="ident" id="6007398">buf</span><span class="op" id="6007401">[</span><span class="num" id="6007402">1</span><span class="op" id="6007403">]</span>&nbsp;<span class="op" id="6007405">=</span>&nbsp;<span class="num" id="6007407">0xff</span>&nbsp;<span class="comment" id="6007412">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007436">e</span><span class="op" id="6007437">.</span><span class="ident" id="6007438">buf</span><span class="op" id="6007441">[</span><span class="num" id="6007442">2</span><span class="op" id="6007443">]</span>&nbsp;<span class="op" id="6007445">=</span>&nbsp;<span class="num" id="6007447">0x0b</span>&nbsp;<span class="comment" id="6007452">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007469">e</span><span class="op" id="6007470">.</span><span class="ident" id="6007471">write</span><span class="op" id="6007476">(</span><span class="ident" id="6007477">e</span><span class="op" id="6007478">.</span><span class="ident" id="6007479">buf</span><span class="op" id="6007482">[</span><span class="op" id="6007483">:</span><span class="num" id="6007484">3</span><span class="op" id="6007485">]</span><span class="op" id="6007486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007490">_</span><span class="op" id="6007491">,</span>&nbsp;<span class="ident" id="6007493">e</span><span class="op" id="6007494">.</span><span class="ident" id="6007495">err</span>&nbsp;<span class="op" id="6007499">=</span>&nbsp;<span class="ident" id="6007501">io</span><span class="op" id="6007503">.</span><span class="ident" id="6007504">WriteString</span><span class="op" id="6007515">(</span><span class="ident" id="6007516">e</span><span class="op" id="6007517">.</span><span class="ident" id="6007518">w</span><span class="op" id="6007519">,</span>&nbsp;<span class="string" id="6007521">&#34;NETSCAPE2.0&#34;</span><span class="op" id="6007534">)</span>&nbsp;<span class="comment" id="6007536">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007565">if</span>&nbsp;<span class="ident" id="6007568">e</span><span class="op" id="6007569">.</span><span class="ident" id="6007570">err</span>&nbsp;<span class="op" id="6007574">!=</span>&nbsp;<span class="ident" id="6007577">nil</span>&nbsp;<span class="op" id="6007581">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007586">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007599">e</span><span class="op" id="6007600">.</span><span class="ident" id="6007601">buf</span><span class="op" id="6007604">[</span><span class="num" id="6007605">0</span><span class="op" id="6007606">]</span>&nbsp;<span class="op" id="6007608">=</span>&nbsp;<span class="num" id="6007610">0x03</span>&nbsp;<span class="comment" id="6007615">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007632">e</span><span class="op" id="6007633">.</span><span class="ident" id="6007634">buf</span><span class="op" id="6007637">[</span><span class="num" id="6007638">1</span><span class="op" id="6007639">]</span>&nbsp;<span class="op" id="6007641">=</span>&nbsp;<span class="num" id="6007643">0x01</span>&nbsp;<span class="comment" id="6007648">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007670">writeUint16</span><span class="op" id="6007681">(</span><span class="ident" id="6007682">e</span><span class="op" id="6007683">.</span><span class="ident" id="6007684">buf</span><span class="op" id="6007687">[</span><span class="num" id="6007688">2</span><span class="op" id="6007689">:</span><span class="num" id="6007690">4</span><span class="op" id="6007691">]</span><span class="op" id="6007692">,</span>&nbsp;<span class="builtintype" id="6007694">uint16</span><span class="op" id="6007700">(</span><span class="ident" id="6007701">e</span><span class="op" id="6007702">.</span><span class="ident" id="6007703">g</span><span class="op" id="6007704">.</span><span class="ident" id="6007705">LoopCount</span><span class="op" id="6007714">)</span><span class="op" id="6007715">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007719">e</span><span class="op" id="6007720">.</span><span class="ident" id="6007721">buf</span><span class="op" id="6007724">[</span><span class="num" id="6007725">4</span><span class="op" id="6007726">]</span>&nbsp;<span class="op" id="6007728">=</span>&nbsp;<span class="num" id="6007730">0x00</span>&nbsp;<span class="comment" id="6007735">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007758">e</span><span class="op" id="6007759">.</span><span class="ident" id="6007760">write</span><span class="op" id="6007765">(</span><span class="ident" id="6007766">e</span><span class="op" id="6007767">.</span><span class="ident" id="6007768">buf</span><span class="op" id="6007771">[</span><span class="op" id="6007772">:</span><span class="num" id="6007773">5</span><span class="op" id="6007774">]</span><span class="op" id="6007775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007778">}</span><br>
<span class="lineno"></span><span class="op" id="6007780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="6007783">func</span>&nbsp;<span class="op" id="6007788">(</span><span class="ident" id="6007789">e</span>&nbsp;<span class="op" id="6007791">*</span><span class="ident" id="6007792">encoder</span><span class="op" id="6007799">)</span>&nbsp;<span class="ident" id="6007801">writeColorTable</span><span class="op" id="6007816">(</span><span class="ident" id="6007817">p</span>&nbsp;<span class="ident" id="6007819">color</span><span class="op" id="6007824">.</span><span class="ident" id="6007825">Palette</span><span class="op" id="6007832">,</span>&nbsp;<span class="ident" id="6007834">size</span>&nbsp;<span class="builtintype" id="6007839">int</span><span class="op" id="6007842">)</span>&nbsp;<span class="op" id="6007844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007847">if</span>&nbsp;<span class="ident" id="6007850">e</span><span class="op" id="6007851">.</span><span class="ident" id="6007852">err</span>&nbsp;<span class="op" id="6007856">!=</span>&nbsp;<span class="ident" id="6007859">nil</span>&nbsp;<span class="op" id="6007863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007867">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007879">for</span>&nbsp;<span class="ident" id="6007883">i</span>&nbsp;<span class="op" id="6007885">:=</span>&nbsp;<span class="num" id="6007888">0</span><span class="op" id="6007889">;</span>&nbsp;<span class="ident" id="6007891">i</span>&nbsp;<span class="op" id="6007893">&lt;</span>&nbsp;<span class="ident" id="6007895">log2Lookup</span><span class="op" id="6007905">[</span><span class="ident" id="6007906">size</span><span class="op" id="6007910">]</span><span class="op" id="6007911">;</span>&nbsp;<span class="ident" id="6007913">i</span><span class="op" id="6007914">++</span>&nbsp;<span class="op" id="6007917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007921">if</span>&nbsp;<span class="ident" id="6007924">i</span>&nbsp;<span class="op" id="6007926">&lt;</span>&nbsp;<span class="builtinfunc" id="6007928">len</span><span class="op" id="6007931">(</span><span class="ident" id="6007932">p</span><span class="op" id="6007933">)</span>&nbsp;<span class="op" id="6007935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007940">r</span><span class="op" id="6007941">,</span>&nbsp;<span class="ident" id="6007943">g</span><span class="op" id="6007944">,</span>&nbsp;<span class="ident" id="6007946">b</span><span class="op" id="6007947">,</span>&nbsp;<span class="ident" id="6007949">_</span>&nbsp;<span class="op" id="6007951">:=</span>&nbsp;<span class="ident" id="6007954">p</span><span class="op" id="6007955">[</span><span class="ident" id="6007956">i</span><span class="op" id="6007957">]</span><span class="op" id="6007958">.</span><span class="ident" id="6007959">RGBA</span><span class="op" id="6007963">(</span><span class="op" id="6007964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007969">e</span><span class="op" id="6007970">.</span><span class="ident" id="6007971">buf</span><span class="op" id="6007974">[</span><span class="num" id="6007975">3</span><span class="op" id="6007976">*</span><span class="ident" id="6007977">i</span><span class="op" id="6007978">+</span><span class="num" id="6007979">0</span><span class="op" id="6007980">]</span>&nbsp;<span class="op" id="6007982">=</span>&nbsp;<span class="builtintype" id="6007984">uint8</span><span class="op" id="6007989">(</span><span class="ident" id="6007990">r</span>&nbsp;<span class="op" id="6007992">&gt;&gt;</span>&nbsp;<span class="num" id="6007995">8</span><span class="op" id="6007996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008001">e</span><span class="op" id="6008002">.</span><span class="ident" id="6008003">buf</span><span class="op" id="6008006">[</span><span class="num" id="6008007">3</span><span class="op" id="6008008">*</span><span class="ident" id="6008009">i</span><span class="op" id="6008010">+</span><span class="num" id="6008011">1</span><span class="op" id="6008012">]</span>&nbsp;<span class="op" id="6008014">=</span>&nbsp;<span class="builtintype" id="6008016">uint8</span><span class="op" id="6008021">(</span><span class="ident" id="6008022">g</span>&nbsp;<span class="op" id="6008024">&gt;&gt;</span>&nbsp;<span class="num" id="6008027">8</span><span class="op" id="6008028">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008033">e</span><span class="op" id="6008034">.</span><span class="ident" id="6008035">buf</span><span class="op" id="6008038">[</span><span class="num" id="6008039">3</span><span class="op" id="6008040">*</span><span class="ident" id="6008041">i</span><span class="op" id="6008042">+</span><span class="num" id="6008043">2</span><span class="op" id="6008044">]</span>&nbsp;<span class="op" id="6008046">=</span>&nbsp;<span class="builtintype" id="6008048">uint8</span><span class="op" id="6008053">(</span><span class="ident" id="6008054">b</span>&nbsp;<span class="op" id="6008056">&gt;&gt;</span>&nbsp;<span class="num" id="6008059">8</span><span class="op" id="6008060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008064">}</span>&nbsp;<span class="keyword" id="6008066">else</span>&nbsp;<span class="op" id="6008071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6008076">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008098">e</span><span class="op" id="6008099">.</span><span class="ident" id="6008100">buf</span><span class="op" id="6008103">[</span><span class="num" id="6008104">3</span><span class="op" id="6008105">*</span><span class="ident" id="6008106">i</span><span class="op" id="6008107">+</span><span class="num" id="6008108">0</span><span class="op" id="6008109">]</span>&nbsp;<span class="op" id="6008111">=</span>&nbsp;<span class="num" id="6008113">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008121">e</span><span class="op" id="6008122">.</span><span class="ident" id="6008123">buf</span><span class="op" id="6008126">[</span><span class="num" id="6008127">3</span><span class="op" id="6008128">*</span><span class="ident" id="6008129">i</span><span class="op" id="6008130">+</span><span class="num" id="6008131">1</span><span class="op" id="6008132">]</span>&nbsp;<span class="op" id="6008134">=</span>&nbsp;<span class="num" id="6008136">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008144">e</span><span class="op" id="6008145">.</span><span class="ident" id="6008146">buf</span><span class="op" id="6008149">[</span><span class="num" id="6008150">3</span><span class="op" id="6008151">*</span><span class="ident" id="6008152">i</span><span class="op" id="6008153">+</span><span class="num" id="6008154">2</span><span class="op" id="6008155">]</span>&nbsp;<span class="op" id="6008157">=</span>&nbsp;<span class="num" id="6008159">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008172">e</span><span class="op" id="6008173">.</span><span class="ident" id="6008174">write</span><span class="op" id="6008179">(</span><span class="ident" id="6008180">e</span><span class="op" id="6008181">.</span><span class="ident" id="6008182">buf</span><span class="op" id="6008185">[</span><span class="op" id="6008186">:</span><span class="num" id="6008187">3</span><span class="op" id="6008188">*</span><span class="ident" id="6008189">log2Lookup</span><span class="op" id="6008199">[</span><span class="ident" id="6008200">size</span><span class="op" id="6008204">]</span><span class="op" id="6008205">]</span><span class="op" id="6008206">)</span><br>
<span class="lineno"></span><span class="op" id="6008208">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6008211">func</span>&nbsp;<span class="op" id="6008216">(</span><span class="ident" id="6008217">e</span>&nbsp;<span class="op" id="6008219">*</span><span class="ident" id="6008220">encoder</span><span class="op" id="6008227">)</span>&nbsp;<span class="ident" id="6008229">writeImageBlock</span><span class="op" id="6008244">(</span><span class="ident" id="6008245">pm</span>&nbsp;<span class="op" id="6008248">*</span><span class="ident" id="6008249">image</span><span class="op" id="6008254">.</span><span class="ident" id="6008255">Paletted</span><span class="op" id="6008263">,</span>&nbsp;<span class="ident" id="6008265">delay</span>&nbsp;<span class="builtintype" id="6008271">int</span><span class="op" id="6008274">)</span>&nbsp;<span class="op" id="6008276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008279">if</span>&nbsp;<span class="ident" id="6008282">e</span><span class="op" id="6008283">.</span><span class="ident" id="6008284">err</span>&nbsp;<span class="op" id="6008288">!=</span>&nbsp;<span class="ident" id="6008291">nil</span>&nbsp;<span class="op" id="6008295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008299">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008307">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008311">if</span>&nbsp;<span class="builtinfunc" id="6008314">len</span><span class="op" id="6008317">(</span><span class="ident" id="6008318">pm</span><span class="op" id="6008320">.</span><span class="ident" id="6008321">Palette</span><span class="op" id="6008328">)</span>&nbsp;<span class="op" id="6008330">==</span>&nbsp;<span class="num" id="6008333">0</span>&nbsp;<span class="op" id="6008335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008339">e</span><span class="op" id="6008340">.</span><span class="ident" id="6008341">err</span>&nbsp;<span class="op" id="6008345">=</span>&nbsp;<span class="ident" id="6008347">errors</span><span class="op" id="6008353">.</span><span class="ident" id="6008354">New</span><span class="op" id="6008357">(</span><span class="string" id="6008358">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="6008409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008413">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008421">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008425">b</span>&nbsp;<span class="op" id="6008427">:=</span>&nbsp;<span class="ident" id="6008430">pm</span><span class="op" id="6008432">.</span><span class="ident" id="6008433">Bounds</span><span class="op" id="6008439">(</span><span class="op" id="6008440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008443">if</span>&nbsp;<span class="ident" id="6008446">b</span><span class="op" id="6008447">.</span><span class="ident" id="6008448">Dx</span><span class="op" id="6008450">(</span><span class="op" id="6008451">)</span>&nbsp;<span class="op" id="6008453">&gt;=</span>&nbsp;<span class="num" id="6008456">1</span><span class="op" id="6008457">&lt;&lt;</span><span class="num" id="6008459">16</span>&nbsp;<span class="op" id="6008462">||</span>&nbsp;<span class="ident" id="6008465">b</span><span class="op" id="6008466">.</span><span class="ident" id="6008467">Dy</span><span class="op" id="6008469">(</span><span class="op" id="6008470">)</span>&nbsp;<span class="op" id="6008472">&gt;=</span>&nbsp;<span class="num" id="6008475">1</span><span class="op" id="6008476">&lt;&lt;</span><span class="num" id="6008478">16</span>&nbsp;<span class="op" id="6008481">||</span>&nbsp;<span class="ident" id="6008484">b</span><span class="op" id="6008485">.</span><span class="ident" id="6008486">Min</span><span class="op" id="6008489">.</span><span class="ident" id="6008490">X</span>&nbsp;<span class="op" id="6008492">&lt;</span>&nbsp;<span class="num" id="6008494">0</span>&nbsp;<span class="op" id="6008496">||</span>&nbsp;<span class="ident" id="6008499">b</span><span class="op" id="6008500">.</span><span class="ident" id="6008501">Min</span><span class="op" id="6008504">.</span><span class="ident" id="6008505">X</span>&nbsp;<span class="op" id="6008507">&gt;=</span>&nbsp;<span class="num" id="6008510">1</span><span class="op" id="6008511">&lt;&lt;</span><span class="num" id="6008513">16</span>&nbsp;<span class="op" id="6008516">||</span>&nbsp;<span class="ident" id="6008519">b</span><span class="op" id="6008520">.</span><span class="ident" id="6008521">Min</span><span class="op" id="6008524">.</span><span class="ident" id="6008525">Y</span>&nbsp;<span class="op" id="6008527">&lt;</span>&nbsp;<span class="num" id="6008529">0</span>&nbsp;<span class="op" id="6008531">||</span>&nbsp;<span class="ident" id="6008534">b</span><span class="op" id="6008535">.</span><span class="ident" id="6008536">Min</span><span class="op" id="6008539">.</span><span class="ident" id="6008540">Y</span>&nbsp;<span class="op" id="6008542">&gt;=</span>&nbsp;<span class="num" id="6008545">1</span><span class="op" id="6008546">&lt;&lt;</span><span class="num" id="6008548">16</span>&nbsp;<span class="op" id="6008551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008555">e</span><span class="op" id="6008556">.</span><span class="ident" id="6008557">err</span>&nbsp;<span class="op" id="6008561">=</span>&nbsp;<span class="ident" id="6008563">errors</span><span class="op" id="6008569">.</span><span class="ident" id="6008570">New</span><span class="op" id="6008573">(</span><span class="string" id="6008574">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6008615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008619">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008631">transparentIndex</span>&nbsp;<span class="op" id="6008648">:=</span>&nbsp;<span class="op" id="6008651">-</span><span class="num" id="6008652">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008655">for</span>&nbsp;<span class="ident" id="6008659">i</span><span class="op" id="6008660">,</span>&nbsp;<span class="ident" id="6008662">c</span>&nbsp;<span class="op" id="6008664">:=</span>&nbsp;<span class="keyword" id="6008667">range</span>&nbsp;<span class="ident" id="6008673">pm</span><span class="op" id="6008675">.</span><span class="ident" id="6008676">Palette</span>&nbsp;<span class="op" id="6008684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008688">if</span>&nbsp;<span class="ident" id="6008691">_</span><span class="op" id="6008692">,</span>&nbsp;<span class="ident" id="6008694">_</span><span class="op" id="6008695">,</span>&nbsp;<span class="ident" id="6008697">_</span><span class="op" id="6008698">,</span>&nbsp;<span class="ident" id="6008700">a</span>&nbsp;<span class="op" id="6008702">:=</span>&nbsp;<span class="ident" id="6008705">c</span><span class="op" id="6008706">.</span><span class="ident" id="6008707">RGBA</span><span class="op" id="6008711">(</span><span class="op" id="6008712">)</span><span class="op" id="6008713">;</span>&nbsp;<span class="ident" id="6008715">a</span>&nbsp;<span class="op" id="6008717">==</span>&nbsp;<span class="num" id="6008720">0</span>&nbsp;<span class="op" id="6008722">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008727">transparentIndex</span>&nbsp;<span class="op" id="6008744">=</span>&nbsp;<span class="ident" id="6008746">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008751">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008766">if</span>&nbsp;<span class="ident" id="6008769">delay</span>&nbsp;<span class="op" id="6008775">&gt;</span>&nbsp;<span class="num" id="6008777">0</span>&nbsp;<span class="op" id="6008779">||</span>&nbsp;<span class="ident" id="6008782">transparentIndex</span>&nbsp;<span class="op" id="6008799">!=</span>&nbsp;<span class="op" id="6008802">-</span><span class="num" id="6008803">1</span>&nbsp;<span class="op" id="6008805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008809">e</span><span class="op" id="6008810">.</span><span class="ident" id="6008811">buf</span><span class="op" id="6008814">[</span><span class="num" id="6008815">0</span><span class="op" id="6008816">]</span>&nbsp;<span class="op" id="6008818">=</span>&nbsp;<span class="ident" id="6008820">sExtension</span>&nbsp;&nbsp;<span class="comment" id="6008832">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008859">e</span><span class="op" id="6008860">.</span><span class="ident" id="6008861">buf</span><span class="op" id="6008864">[</span><span class="num" id="6008865">1</span><span class="op" id="6008866">]</span>&nbsp;<span class="op" id="6008868">=</span>&nbsp;<span class="ident" id="6008870">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6008882">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008910">e</span><span class="op" id="6008911">.</span><span class="ident" id="6008912">buf</span><span class="op" id="6008915">[</span><span class="num" id="6008916">2</span><span class="op" id="6008917">]</span>&nbsp;<span class="op" id="6008919">=</span>&nbsp;<span class="ident" id="6008921">gcBlockSize</span>&nbsp;<span class="comment" id="6008933">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6008950">if</span>&nbsp;<span class="ident" id="6008953">transparentIndex</span>&nbsp;<span class="op" id="6008970">!=</span>&nbsp;<span class="op" id="6008973">-</span><span class="num" id="6008974">1</span>&nbsp;<span class="op" id="6008976">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6008981">e</span><span class="op" id="6008982">.</span><span class="ident" id="6008983">buf</span><span class="op" id="6008986">[</span><span class="num" id="6008987">3</span><span class="op" id="6008988">]</span>&nbsp;<span class="op" id="6008990">=</span>&nbsp;<span class="num" id="6008992">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6008999">}</span>&nbsp;<span class="keyword" id="6009001">else</span>&nbsp;<span class="op" id="6009006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009011">e</span><span class="op" id="6009012">.</span><span class="ident" id="6009013">buf</span><span class="op" id="6009016">[</span><span class="num" id="6009017">3</span><span class="op" id="6009018">]</span>&nbsp;<span class="op" id="6009020">=</span>&nbsp;<span class="num" id="6009022">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6009029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009033">writeUint16</span><span class="op" id="6009044">(</span><span class="ident" id="6009045">e</span><span class="op" id="6009046">.</span><span class="ident" id="6009047">buf</span><span class="op" id="6009050">[</span><span class="num" id="6009051">4</span><span class="op" id="6009052">:</span><span class="num" id="6009053">6</span><span class="op" id="6009054">]</span><span class="op" id="6009055">,</span>&nbsp;<span class="builtintype" id="6009057">uint16</span><span class="op" id="6009063">(</span><span class="ident" id="6009064">delay</span><span class="op" id="6009069">)</span><span class="op" id="6009070">)</span>&nbsp;<span class="comment" id="6009072">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6009112">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6009142">if</span>&nbsp;<span class="ident" id="6009145">transparentIndex</span>&nbsp;<span class="op" id="6009162">!=</span>&nbsp;<span class="op" id="6009165">-</span><span class="num" id="6009166">1</span>&nbsp;<span class="op" id="6009168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009173">e</span><span class="op" id="6009174">.</span><span class="ident" id="6009175">buf</span><span class="op" id="6009178">[</span><span class="num" id="6009179">6</span><span class="op" id="6009180">]</span>&nbsp;<span class="op" id="6009182">=</span>&nbsp;<span class="builtintype" id="6009184">uint8</span><span class="op" id="6009189">(</span><span class="ident" id="6009190">transparentIndex</span><span class="op" id="6009206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6009210">}</span>&nbsp;<span class="keyword" id="6009212">else</span>&nbsp;<span class="op" id="6009217">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009222">e</span><span class="op" id="6009223">.</span><span class="ident" id="6009224">buf</span><span class="op" id="6009227">[</span><span class="num" id="6009228">6</span><span class="op" id="6009229">]</span>&nbsp;<span class="op" id="6009231">=</span>&nbsp;<span class="num" id="6009233">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6009240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009244">e</span><span class="op" id="6009245">.</span><span class="ident" id="6009246">buf</span><span class="op" id="6009249">[</span><span class="num" id="6009250">7</span><span class="op" id="6009251">]</span>&nbsp;<span class="op" id="6009253">=</span>&nbsp;<span class="num" id="6009255">0x00</span>&nbsp;<span class="comment" id="6009260">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009283">e</span><span class="op" id="6009284">.</span><span class="ident" id="6009285">write</span><span class="op" id="6009290">(</span><span class="ident" id="6009291">e</span><span class="op" id="6009292">.</span><span class="ident" id="6009293">buf</span><span class="op" id="6009296">[</span><span class="op" id="6009297">:</span><span class="num" id="6009298">8</span><span class="op" id="6009299">]</span><span class="op" id="6009300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6009303">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009306">e</span><span class="op" id="6009307">.</span><span class="ident" id="6009308">buf</span><span class="op" id="6009311">[</span><span class="num" id="6009312">0</span><span class="op" id="6009313">]</span>&nbsp;<span class="op" id="6009315">=</span>&nbsp;<span class="ident" id="6009317">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009335">writeUint16</span><span class="op" id="6009346">(</span><span class="ident" id="6009347">e</span><span class="op" id="6009348">.</span><span class="ident" id="6009349">buf</span><span class="op" id="6009352">[</span><span class="num" id="6009353">1</span><span class="op" id="6009354">:</span><span class="num" id="6009355">3</span><span class="op" id="6009356">]</span><span class="op" id="6009357">,</span>&nbsp;<span class="builtintype" id="6009359">uint16</span><span class="op" id="6009365">(</span><span class="ident" id="6009366">b</span><span class="op" id="6009367">.</span><span class="ident" id="6009368">Min</span><span class="op" id="6009371">.</span><span class="ident" id="6009372">X</span><span class="op" id="6009373">)</span><span class="op" id="6009374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009377">writeUint16</span><span class="op" id="6009388">(</span><span class="ident" id="6009389">e</span><span class="op" id="6009390">.</span><span class="ident" id="6009391">buf</span><span class="op" id="6009394">[</span><span class="num" id="6009395">3</span><span class="op" id="6009396">:</span><span class="num" id="6009397">5</span><span class="op" id="6009398">]</span><span class="op" id="6009399">,</span>&nbsp;<span class="builtintype" id="6009401">uint16</span><span class="op" id="6009407">(</span><span class="ident" id="6009408">b</span><span class="op" id="6009409">.</span><span class="ident" id="6009410">Min</span><span class="op" id="6009413">.</span><span class="ident" id="6009414">Y</span><span class="op" id="6009415">)</span><span class="op" id="6009416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009419">writeUint16</span><span class="op" id="6009430">(</span><span class="ident" id="6009431">e</span><span class="op" id="6009432">.</span><span class="ident" id="6009433">buf</span><span class="op" id="6009436">[</span><span class="num" id="6009437">5</span><span class="op" id="6009438">:</span><span class="num" id="6009439">7</span><span class="op" id="6009440">]</span><span class="op" id="6009441">,</span>&nbsp;<span class="builtintype" id="6009443">uint16</span><span class="op" id="6009449">(</span><span class="ident" id="6009450">b</span><span class="op" id="6009451">.</span><span class="ident" id="6009452">Dx</span><span class="op" id="6009454">(</span><span class="op" id="6009455">)</span><span class="op" id="6009456">)</span><span class="op" id="6009457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009460">writeUint16</span><span class="op" id="6009471">(</span><span class="ident" id="6009472">e</span><span class="op" id="6009473">.</span><span class="ident" id="6009474">buf</span><span class="op" id="6009477">[</span><span class="num" id="6009478">7</span><span class="op" id="6009479">:</span><span class="num" id="6009480">9</span><span class="op" id="6009481">]</span><span class="op" id="6009482">,</span>&nbsp;<span class="builtintype" id="6009484">uint16</span><span class="op" id="6009490">(</span><span class="ident" id="6009491">b</span><span class="op" id="6009492">.</span><span class="ident" id="6009493">Dy</span><span class="op" id="6009495">(</span><span class="op" id="6009496">)</span><span class="op" id="6009497">)</span><span class="op" id="6009498">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009501">e</span><span class="op" id="6009502">.</span><span class="ident" id="6009503">write</span><span class="op" id="6009508">(</span><span class="ident" id="6009509">e</span><span class="op" id="6009510">.</span><span class="ident" id="6009511">buf</span><span class="op" id="6009514">[</span><span class="op" id="6009515">:</span><span class="num" id="6009516">9</span><span class="op" id="6009517">]</span><span class="op" id="6009518">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009522">paddedSize</span>&nbsp;<span class="op" id="6009533">:=</span>&nbsp;<span class="ident" id="6009536">log2</span><span class="op" id="6009540">(</span><span class="builtinfunc" id="6009541">len</span><span class="op" id="6009544">(</span><span class="ident" id="6009545">pm</span><span class="op" id="6009547">.</span><span class="ident" id="6009548">Palette</span><span class="op" id="6009555">)</span><span class="op" id="6009556">)</span>&nbsp;<span class="comment" id="6009558">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6009598">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009632">e</span><span class="op" id="6009633">.</span><span class="ident" id="6009634">writeByte</span><span class="op" id="6009643">(</span><span class="num" id="6009644">0x80</span>&nbsp;<span class="op" id="6009649">|</span>&nbsp;<span class="builtintype" id="6009651">uint8</span><span class="op" id="6009656">(</span><span class="ident" id="6009657">paddedSize</span><span class="op" id="6009667">)</span><span class="op" id="6009668">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6009672">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009695">e</span><span class="op" id="6009696">.</span><span class="ident" id="6009697">writeColorTable</span><span class="op" id="6009712">(</span><span class="ident" id="6009713">pm</span><span class="op" id="6009715">.</span><span class="ident" id="6009716">Palette</span><span class="op" id="6009723">,</span>&nbsp;<span class="ident" id="6009725">paddedSize</span><span class="op" id="6009735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009739">litWidth</span>&nbsp;<span class="op" id="6009748">:=</span>&nbsp;<span class="ident" id="6009751">paddedSize</span>&nbsp;<span class="op" id="6009762">+</span>&nbsp;<span class="num" id="6009764">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6009767">if</span>&nbsp;<span class="ident" id="6009770">litWidth</span>&nbsp;<span class="op" id="6009779">&lt;</span>&nbsp;<span class="num" id="6009781">2</span>&nbsp;<span class="op" id="6009783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009787">litWidth</span>&nbsp;<span class="op" id="6009796">=</span>&nbsp;<span class="num" id="6009798">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6009801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009804">e</span><span class="op" id="6009805">.</span><span class="ident" id="6009806">writeByte</span><span class="op" id="6009815">(</span><span class="builtintype" id="6009816">uint8</span><span class="op" id="6009821">(</span><span class="ident" id="6009822">litWidth</span><span class="op" id="6009830">)</span><span class="op" id="6009831">)</span>&nbsp;<span class="comment" id="6009833">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009861">lzww</span>&nbsp;<span class="op" id="6009866">:=</span>&nbsp;<span class="ident" id="6009869">lzw</span><span class="op" id="6009872">.</span><span class="ident" id="6009873">NewWriter</span><span class="op" id="6009882">(</span><span class="ident" id="6009883">blockWriter</span><span class="op" id="6009894">{</span><span class="ident" id="6009895">e</span><span class="op" id="6009896">:</span>&nbsp;<span class="ident" id="6009898">e</span><span class="op" id="6009899">}</span><span class="op" id="6009900">,</span>&nbsp;<span class="ident" id="6009902">lzw</span><span class="op" id="6009905">.</span><span class="ident" id="6009906">LSB</span><span class="op" id="6009909">,</span>&nbsp;<span class="ident" id="6009911">litWidth</span><span class="op" id="6009919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6009922">if</span>&nbsp;<span class="ident" id="6009925">dx</span>&nbsp;<span class="op" id="6009928">:=</span>&nbsp;<span class="ident" id="6009931">b</span><span class="op" id="6009932">.</span><span class="ident" id="6009933">Dx</span><span class="op" id="6009935">(</span><span class="op" id="6009936">)</span><span class="op" id="6009937">;</span>&nbsp;<span class="ident" id="6009939">dx</span>&nbsp;<span class="op" id="6009942">==</span>&nbsp;<span class="ident" id="6009945">pm</span><span class="op" id="6009947">.</span><span class="ident" id="6009948">Stride</span>&nbsp;<span class="op" id="6009955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6009959">_</span><span class="op" id="6009960">,</span>&nbsp;<span class="ident" id="6009962">e</span><span class="op" id="6009963">.</span><span class="ident" id="6009964">err</span>&nbsp;<span class="op" id="6009968">=</span>&nbsp;<span class="ident" id="6009970">lzww</span><span class="op" id="6009974">.</span><span class="ident" id="6009975">Write</span><span class="op" id="6009980">(</span><span class="ident" id="6009981">pm</span><span class="op" id="6009983">.</span><span class="ident" id="6009984">Pix</span><span class="op" id="6009987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6009991">if</span>&nbsp;<span class="ident" id="6009994">e</span><span class="op" id="6009995">.</span><span class="ident" id="6009996">err</span>&nbsp;<span class="op" id="6010000">!=</span>&nbsp;<span class="ident" id="6010003">nil</span>&nbsp;<span class="op" id="6010007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010012">lzww</span><span class="op" id="6010016">.</span><span class="ident" id="6010017">Close</span><span class="op" id="6010022">(</span><span class="op" id="6010023">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010028">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010040">}</span>&nbsp;<span class="keyword" id="6010042">else</span>&nbsp;<span class="op" id="6010047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010051">for</span>&nbsp;<span class="ident" id="6010055">i</span><span class="op" id="6010056">,</span>&nbsp;<span class="ident" id="6010058">y</span>&nbsp;<span class="op" id="6010060">:=</span>&nbsp;<span class="num" id="6010063">0</span><span class="op" id="6010064">,</span>&nbsp;<span class="ident" id="6010066">b</span><span class="op" id="6010067">.</span><span class="ident" id="6010068">Min</span><span class="op" id="6010071">.</span><span class="ident" id="6010072">Y</span><span class="op" id="6010073">;</span>&nbsp;<span class="ident" id="6010075">y</span>&nbsp;<span class="op" id="6010077">&lt;</span>&nbsp;<span class="ident" id="6010079">b</span><span class="op" id="6010080">.</span><span class="ident" id="6010081">Max</span><span class="op" id="6010084">.</span><span class="ident" id="6010085">Y</span><span class="op" id="6010086">;</span>&nbsp;<span class="ident" id="6010088">i</span><span class="op" id="6010089">,</span>&nbsp;<span class="ident" id="6010091">y</span>&nbsp;<span class="op" id="6010093">=</span>&nbsp;<span class="ident" id="6010095">i</span><span class="op" id="6010096">+</span><span class="ident" id="6010097">pm</span><span class="op" id="6010099">.</span><span class="ident" id="6010100">Stride</span><span class="op" id="6010106">,</span>&nbsp;<span class="ident" id="6010108">y</span><span class="op" id="6010109">+</span><span class="num" id="6010110">1</span>&nbsp;<span class="op" id="6010112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010117">_</span><span class="op" id="6010118">,</span>&nbsp;<span class="ident" id="6010120">e</span><span class="op" id="6010121">.</span><span class="ident" id="6010122">err</span>&nbsp;<span class="op" id="6010126">=</span>&nbsp;<span class="ident" id="6010128">lzww</span><span class="op" id="6010132">.</span><span class="ident" id="6010133">Write</span><span class="op" id="6010138">(</span><span class="ident" id="6010139">pm</span><span class="op" id="6010141">.</span><span class="ident" id="6010142">Pix</span><span class="op" id="6010145">[</span><span class="ident" id="6010146">i</span>&nbsp;<span class="op" id="6010148">:</span>&nbsp;<span class="ident" id="6010150">i</span><span class="op" id="6010151">+</span><span class="ident" id="6010152">dx</span><span class="op" id="6010154">]</span><span class="op" id="6010155">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010160">if</span>&nbsp;<span class="ident" id="6010163">e</span><span class="op" id="6010164">.</span><span class="ident" id="6010165">err</span>&nbsp;<span class="op" id="6010169">!=</span>&nbsp;<span class="ident" id="6010172">nil</span>&nbsp;<span class="op" id="6010176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010182">lzww</span><span class="op" id="6010186">.</span><span class="ident" id="6010187">Close</span><span class="op" id="6010192">(</span><span class="op" id="6010193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010199">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010213">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010219">lzww</span><span class="op" id="6010223">.</span><span class="ident" id="6010224">Close</span><span class="op" id="6010229">(</span><span class="op" id="6010230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010233">e</span><span class="op" id="6010234">.</span><span class="ident" id="6010235">writeByte</span><span class="op" id="6010244">(</span><span class="num" id="6010245">0x00</span><span class="op" id="6010249">)</span>&nbsp;<span class="comment" id="6010251">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="6010272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6010275">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="6010315">type</span>&nbsp;<span class="ident" id="6010320">Options</span>&nbsp;<span class="keyword" id="6010328">struct</span>&nbsp;<span class="op" id="6010335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010338">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010403">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010432">NumColors</span>&nbsp;<span class="builtintype" id="6010442">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010448">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010512">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010567">Quantizer</span>&nbsp;<span class="ident" id="6010577">draw</span><span class="op" id="6010581">.</span><span class="ident" id="6010582">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010594">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6010665">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6010723">Drawer</span>&nbsp;<span class="ident" id="6010730">draw</span><span class="op" id="6010734">.</span><span class="ident" id="6010735">Drawer</span><br>
<span class="lineno"></span><span class="op" id="6010742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6010745">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6010809">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="6010855">func</span>&nbsp;<span class="ident" id="6010860">EncodeAll</span><span class="op" id="6010869">(</span><span class="ident" id="6010870">w</span>&nbsp;<span class="ident" id="6010872">io</span><span class="op" id="6010874">.</span><span class="ident" id="6010875">Writer</span><span class="op" id="6010881">,</span>&nbsp;<span class="ident" id="6010883">g</span>&nbsp;<span class="op" id="6010885">*</span><span class="ident" id="6010886">GIF</span><span class="op" id="6010889">)</span>&nbsp;<span class="builtintype" id="6010891">error</span>&nbsp;<span class="op" id="6010897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010900">if</span>&nbsp;<span class="builtinfunc" id="6010903">len</span><span class="op" id="6010906">(</span><span class="ident" id="6010907">g</span><span class="op" id="6010908">.</span><span class="ident" id="6010909">Image</span><span class="op" id="6010914">)</span>&nbsp;<span class="op" id="6010916">==</span>&nbsp;<span class="num" id="6010919">0</span>&nbsp;<span class="op" id="6010921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010925">return</span>&nbsp;<span class="ident" id="6010932">errors</span><span class="op" id="6010938">.</span><span class="ident" id="6010939">New</span><span class="op" id="6010942">(</span><span class="string" id="6010943">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="6010981">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6010984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6010988">if</span>&nbsp;<span class="builtinfunc" id="6010991">len</span><span class="op" id="6010994">(</span><span class="ident" id="6010995">g</span><span class="op" id="6010996">.</span><span class="ident" id="6010997">Image</span><span class="op" id="6011002">)</span>&nbsp;<span class="op" id="6011004">!=</span>&nbsp;<span class="builtinfunc" id="6011007">len</span><span class="op" id="6011010">(</span><span class="ident" id="6011011">g</span><span class="op" id="6011012">.</span><span class="ident" id="6011013">Delay</span><span class="op" id="6011018">)</span>&nbsp;<span class="op" id="6011020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011024">return</span>&nbsp;<span class="ident" id="6011031">errors</span><span class="op" id="6011037">.</span><span class="ident" id="6011038">New</span><span class="op" id="6011041">(</span><span class="string" id="6011042">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="6011083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011086">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011089">if</span>&nbsp;<span class="ident" id="6011092">g</span><span class="op" id="6011093">.</span><span class="ident" id="6011094">LoopCount</span>&nbsp;<span class="op" id="6011104">&lt;</span>&nbsp;<span class="num" id="6011106">0</span>&nbsp;<span class="op" id="6011108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011112">g</span><span class="op" id="6011113">.</span><span class="ident" id="6011114">LoopCount</span>&nbsp;<span class="op" id="6011124">=</span>&nbsp;<span class="num" id="6011126">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011133">e</span>&nbsp;<span class="op" id="6011135">:=</span>&nbsp;<span class="ident" id="6011138">encoder</span><span class="op" id="6011145">{</span><span class="ident" id="6011146">g</span><span class="op" id="6011147">:</span>&nbsp;<span class="ident" id="6011149">g</span><span class="op" id="6011150">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011153">if</span>&nbsp;<span class="ident" id="6011156">ww</span><span class="op" id="6011158">,</span>&nbsp;<span class="ident" id="6011160">ok</span>&nbsp;<span class="op" id="6011163">:=</span>&nbsp;<span class="ident" id="6011166">w</span><span class="op" id="6011167">.</span><span class="op" id="6011168">(</span><span class="ident" id="6011169">writer</span><span class="op" id="6011175">)</span><span class="op" id="6011176">;</span>&nbsp;<span class="ident" id="6011178">ok</span>&nbsp;<span class="op" id="6011181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011185">e</span><span class="op" id="6011186">.</span><span class="ident" id="6011187">w</span>&nbsp;<span class="op" id="6011189">=</span>&nbsp;<span class="ident" id="6011191">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011195">}</span>&nbsp;<span class="keyword" id="6011197">else</span>&nbsp;<span class="op" id="6011202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011206">e</span><span class="op" id="6011207">.</span><span class="ident" id="6011208">w</span>&nbsp;<span class="op" id="6011210">=</span>&nbsp;<span class="ident" id="6011212">bufio</span><span class="op" id="6011217">.</span><span class="ident" id="6011218">NewWriter</span><span class="op" id="6011227">(</span><span class="ident" id="6011228">w</span><span class="op" id="6011229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011232">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011236">e</span><span class="op" id="6011237">.</span><span class="ident" id="6011238">writeHeader</span><span class="op" id="6011249">(</span><span class="op" id="6011250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011253">for</span>&nbsp;<span class="ident" id="6011257">i</span><span class="op" id="6011258">,</span>&nbsp;<span class="ident" id="6011260">pm</span>&nbsp;<span class="op" id="6011263">:=</span>&nbsp;<span class="keyword" id="6011266">range</span>&nbsp;<span class="ident" id="6011272">g</span><span class="op" id="6011273">.</span><span class="ident" id="6011274">Image</span>&nbsp;<span class="op" id="6011280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011284">e</span><span class="op" id="6011285">.</span><span class="ident" id="6011286">writeImageBlock</span><span class="op" id="6011301">(</span><span class="ident" id="6011302">pm</span><span class="op" id="6011304">,</span>&nbsp;<span class="ident" id="6011306">g</span><span class="op" id="6011307">.</span><span class="ident" id="6011308">Delay</span><span class="op" id="6011313">[</span><span class="ident" id="6011314">i</span><span class="op" id="6011315">]</span><span class="op" id="6011316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011319">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011322">e</span><span class="op" id="6011323">.</span><span class="ident" id="6011324">writeByte</span><span class="op" id="6011333">(</span><span class="ident" id="6011334">sTrailer</span><span class="op" id="6011342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011345">e</span><span class="op" id="6011346">.</span><span class="ident" id="6011347">flush</span><span class="op" id="6011352">(</span><span class="op" id="6011353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011356">return</span>&nbsp;<span class="ident" id="6011363">e</span><span class="op" id="6011364">.</span><span class="ident" id="6011365">err</span><br>
<span class="lineno"></span><span class="op" id="6011369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="6011372">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6011421">func</span>&nbsp;<span class="ident" id="6011426">Encode</span><span class="op" id="6011432">(</span><span class="ident" id="6011433">w</span>&nbsp;<span class="ident" id="6011435">io</span><span class="op" id="6011437">.</span><span class="ident" id="6011438">Writer</span><span class="op" id="6011444">,</span>&nbsp;<span class="ident" id="6011446">m</span>&nbsp;<span class="ident" id="6011448">image</span><span class="op" id="6011453">.</span><span class="ident" id="6011454">Image</span><span class="op" id="6011459">,</span>&nbsp;<span class="ident" id="6011461">o</span>&nbsp;<span class="op" id="6011463">*</span><span class="ident" id="6011464">Options</span><span class="op" id="6011471">)</span>&nbsp;<span class="builtintype" id="6011473">error</span>&nbsp;<span class="op" id="6011479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6011482">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011526">b</span>&nbsp;<span class="op" id="6011528">:=</span>&nbsp;<span class="ident" id="6011531">m</span><span class="op" id="6011532">.</span><span class="ident" id="6011533">Bounds</span><span class="op" id="6011539">(</span><span class="op" id="6011540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011543">if</span>&nbsp;<span class="ident" id="6011546">b</span><span class="op" id="6011547">.</span><span class="ident" id="6011548">Dx</span><span class="op" id="6011550">(</span><span class="op" id="6011551">)</span>&nbsp;<span class="op" id="6011553">&gt;=</span>&nbsp;<span class="num" id="6011556">1</span><span class="op" id="6011557">&lt;&lt;</span><span class="num" id="6011559">16</span>&nbsp;<span class="op" id="6011562">||</span>&nbsp;<span class="ident" id="6011565">b</span><span class="op" id="6011566">.</span><span class="ident" id="6011567">Dy</span><span class="op" id="6011569">(</span><span class="op" id="6011570">)</span>&nbsp;<span class="op" id="6011572">&gt;=</span>&nbsp;<span class="num" id="6011575">1</span><span class="op" id="6011576">&lt;&lt;</span><span class="num" id="6011578">16</span>&nbsp;<span class="op" id="6011581">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011585">return</span>&nbsp;<span class="ident" id="6011592">errors</span><span class="op" id="6011598">.</span><span class="ident" id="6011599">New</span><span class="op" id="6011602">(</span><span class="string" id="6011603">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6011638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011645">opts</span>&nbsp;<span class="op" id="6011650">:=</span>&nbsp;<span class="ident" id="6011653">Options</span><span class="op" id="6011660">{</span><span class="op" id="6011661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011664">if</span>&nbsp;<span class="ident" id="6011667">o</span>&nbsp;<span class="op" id="6011669">!=</span>&nbsp;<span class="ident" id="6011672">nil</span>&nbsp;<span class="op" id="6011676">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011680">opts</span>&nbsp;<span class="op" id="6011685">=</span>&nbsp;<span class="op" id="6011687">*</span><span class="ident" id="6011688">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011694">if</span>&nbsp;<span class="ident" id="6011697">opts</span><span class="op" id="6011701">.</span><span class="ident" id="6011702">NumColors</span>&nbsp;<span class="op" id="6011712">&lt;</span>&nbsp;<span class="num" id="6011714">1</span>&nbsp;<span class="op" id="6011716">||</span>&nbsp;<span class="num" id="6011719">256</span>&nbsp;<span class="op" id="6011723">&lt;</span>&nbsp;<span class="ident" id="6011725">opts</span><span class="op" id="6011729">.</span><span class="ident" id="6011730">NumColors</span>&nbsp;<span class="op" id="6011740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011744">opts</span><span class="op" id="6011748">.</span><span class="ident" id="6011749">NumColors</span>&nbsp;<span class="op" id="6011759">=</span>&nbsp;<span class="num" id="6011761">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011766">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011769">if</span>&nbsp;<span class="ident" id="6011772">opts</span><span class="op" id="6011776">.</span><span class="ident" id="6011777">Drawer</span>&nbsp;<span class="op" id="6011784">==</span>&nbsp;<span class="ident" id="6011787">nil</span>&nbsp;<span class="op" id="6011791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011795">opts</span><span class="op" id="6011799">.</span><span class="ident" id="6011800">Drawer</span>&nbsp;<span class="op" id="6011807">=</span>&nbsp;<span class="ident" id="6011809">draw</span><span class="op" id="6011813">.</span><span class="ident" id="6011814">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6011830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011834">pm</span><span class="op" id="6011836">,</span>&nbsp;<span class="ident" id="6011838">ok</span>&nbsp;<span class="op" id="6011841">:=</span>&nbsp;<span class="ident" id="6011844">m</span><span class="op" id="6011845">.</span><span class="op" id="6011846">(</span><span class="op" id="6011847">*</span><span class="ident" id="6011848">image</span><span class="op" id="6011853">.</span><span class="ident" id="6011854">Paletted</span><span class="op" id="6011862">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6011865">if</span>&nbsp;<span class="op" id="6011868">!</span><span class="ident" id="6011869">ok</span>&nbsp;<span class="op" id="6011872">||</span>&nbsp;<span class="builtinfunc" id="6011875">len</span><span class="op" id="6011878">(</span><span class="ident" id="6011879">pm</span><span class="op" id="6011881">.</span><span class="ident" id="6011882">Palette</span><span class="op" id="6011889">)</span>&nbsp;<span class="op" id="6011891">&gt;</span>&nbsp;<span class="ident" id="6011893">opts</span><span class="op" id="6011897">.</span><span class="ident" id="6011898">NumColors</span>&nbsp;<span class="op" id="6011908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6011912">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6011971">pm</span>&nbsp;<span class="op" id="6011974">=</span>&nbsp;<span class="ident" id="6011976">image</span><span class="op" id="6011981">.</span><span class="ident" id="6011982">NewPaletted</span><span class="op" id="6011993">(</span><span class="ident" id="6011994">b</span><span class="op" id="6011995">,</span>&nbsp;<span class="ident" id="6011997">palette</span><span class="op" id="6012004">.</span><span class="ident" id="6012005">Plan9</span><span class="op" id="6012010">[</span><span class="op" id="6012011">:</span><span class="ident" id="6012012">opts</span><span class="op" id="6012016">.</span><span class="ident" id="6012017">NumColors</span><span class="op" id="6012026">]</span><span class="op" id="6012027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012031">if</span>&nbsp;<span class="ident" id="6012034">opts</span><span class="op" id="6012038">.</span><span class="ident" id="6012039">Quantizer</span>&nbsp;<span class="op" id="6012049">!=</span>&nbsp;<span class="ident" id="6012052">nil</span>&nbsp;<span class="op" id="6012056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6012061">pm</span><span class="op" id="6012063">.</span><span class="ident" id="6012064">Palette</span>&nbsp;<span class="op" id="6012072">=</span>&nbsp;<span class="ident" id="6012074">opts</span><span class="op" id="6012078">.</span><span class="ident" id="6012079">Quantizer</span><span class="op" id="6012088">.</span><span class="ident" id="6012089">Quantize</span><span class="op" id="6012097">(</span><span class="builtinfunc" id="6012098">make</span><span class="op" id="6012102">(</span><span class="ident" id="6012103">color</span><span class="op" id="6012108">.</span><span class="ident" id="6012109">Palette</span><span class="op" id="6012116">,</span>&nbsp;<span class="num" id="6012118">0</span><span class="op" id="6012119">,</span>&nbsp;<span class="ident" id="6012121">opts</span><span class="op" id="6012125">.</span><span class="ident" id="6012126">NumColors</span><span class="op" id="6012135">)</span><span class="op" id="6012136">,</span>&nbsp;<span class="ident" id="6012138">m</span><span class="op" id="6012139">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6012143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6012147">opts</span><span class="op" id="6012151">.</span><span class="ident" id="6012152">Drawer</span><span class="op" id="6012158">.</span><span class="ident" id="6012159">Draw</span><span class="op" id="6012163">(</span><span class="ident" id="6012164">pm</span><span class="op" id="6012166">,</span>&nbsp;<span class="ident" id="6012168">b</span><span class="op" id="6012169">,</span>&nbsp;<span class="ident" id="6012171">m</span><span class="op" id="6012172">,</span>&nbsp;<span class="ident" id="6012174">image</span><span class="op" id="6012179">.</span><span class="ident" id="6012180">ZP</span><span class="op" id="6012182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6012185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6012189">return</span>&nbsp;<span class="ident" id="6012196">EncodeAll</span><span class="op" id="6012205">(</span><span class="ident" id="6012206">w</span><span class="op" id="6012207">,</span>&nbsp;<span class="op" id="6012209">&amp;</span><span class="ident" id="6012210">GIF</span><span class="op" id="6012213">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6012217">Image</span><span class="op" id="6012222">:</span>&nbsp;<span class="op" id="6012224">[</span><span class="op" id="6012225">]</span><span class="op" id="6012226">*</span><span class="ident" id="6012227">image</span><span class="op" id="6012232">.</span><span class="ident" id="6012233">Paletted</span><span class="op" id="6012241">{</span><span class="ident" id="6012242">pm</span><span class="op" id="6012244">}</span><span class="op" id="6012245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6012249">Delay</span><span class="op" id="6012254">:</span>&nbsp;<span class="op" id="6012256">[</span><span class="op" id="6012257">]</span><span class="builtintype" id="6012258">int</span><span class="op" id="6012261">{</span><span class="num" id="6012262">0</span><span class="op" id="6012263">}</span><span class="op" id="6012264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6012267">}</span><span class="op" id="6012268">)</span><br>
<span class="lineno"></span><span class="op" id="6012270">}</span>
</div>
</body>
</html>
