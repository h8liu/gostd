<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4714293">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4714348">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4714402">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4714453">package</span>&nbsp;<span class="ident" id="4714461">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4714466">import</span>&nbsp;<span class="op" id="4714473">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4714476">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4714486">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4714503">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4714513">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4714519">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4714530">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4714533">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4714611">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4714707">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4714794">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4714873">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4714921">func</span>&nbsp;<span class="ident" id="4714926">EncryptPKCS1v15</span><span class="op" id="4714941">(</span><span class="ident" id="4714942">rand</span>&nbsp;<span class="ident" id="4714947">io</span><span class="op" id="4714949">.</span><span class="ident" id="4714950">Reader</span><span class="op" id="4714956">,</span>&nbsp;<span class="ident" id="4714958">pub</span>&nbsp;<span class="op" id="4714962">*</span><span class="ident" id="4714963">PublicKey</span><span class="op" id="4714972">,</span>&nbsp;<span class="ident" id="4714974">msg</span>&nbsp;<span class="op" id="4714978">[</span><span class="op" id="4714979">]</span><span class="builtintype" id="4714980">byte</span><span class="op" id="4714984">)</span>&nbsp;<span class="op" id="4714986">(</span><span class="ident" id="4714987">out</span>&nbsp;<span class="op" id="4714991">[</span><span class="op" id="4714992">]</span><span class="builtintype" id="4714993">byte</span><span class="op" id="4714997">,</span>&nbsp;<span class="ident" id="4714999">err</span>&nbsp;<span class="builtintype" id="4715003">error</span><span class="op" id="4715008">)</span>&nbsp;<span class="op" id="4715010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715013">if</span>&nbsp;<span class="ident" id="4715016">err</span>&nbsp;<span class="op" id="4715020">:=</span>&nbsp;<span class="ident" id="4715023">checkPub</span><span class="op" id="4715031">(</span><span class="ident" id="4715032">pub</span><span class="op" id="4715035">)</span><span class="op" id="4715036">;</span>&nbsp;<span class="ident" id="4715038">err</span>&nbsp;<span class="op" id="4715042">!=</span>&nbsp;<span class="ident" id="4715045">nil</span>&nbsp;<span class="op" id="4715049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715053">return</span>&nbsp;<span class="ident" id="4715060">nil</span><span class="op" id="4715063">,</span>&nbsp;<span class="ident" id="4715065">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715070">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715073">k</span>&nbsp;<span class="op" id="4715075">:=</span>&nbsp;<span class="op" id="4715078">(</span><span class="ident" id="4715079">pub</span><span class="op" id="4715082">.</span><span class="ident" id="4715083">N</span><span class="op" id="4715084">.</span><span class="ident" id="4715085">BitLen</span><span class="op" id="4715091">(</span><span class="op" id="4715092">)</span>&nbsp;<span class="op" id="4715094">+</span>&nbsp;<span class="num" id="4715096">7</span><span class="op" id="4715097">)</span>&nbsp;<span class="op" id="4715099">/</span>&nbsp;<span class="num" id="4715101">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715104">if</span>&nbsp;<span class="builtinfunc" id="4715107">len</span><span class="op" id="4715110">(</span><span class="ident" id="4715111">msg</span><span class="op" id="4715114">)</span>&nbsp;<span class="op" id="4715116">&gt;</span>&nbsp;<span class="ident" id="4715118">k</span><span class="op" id="4715119">-</span><span class="num" id="4715120">11</span>&nbsp;<span class="op" id="4715123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715127">err</span>&nbsp;<span class="op" id="4715131">=</span>&nbsp;<span class="ident" id="4715133">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715153">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715161">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4715165">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715206">em</span>&nbsp;<span class="op" id="4715209">:=</span>&nbsp;<span class="builtinfunc" id="4715212">make</span><span class="op" id="4715216">(</span><span class="op" id="4715217">[</span><span class="op" id="4715218">]</span><span class="builtintype" id="4715219">byte</span><span class="op" id="4715223">,</span>&nbsp;<span class="ident" id="4715225">k</span><span class="op" id="4715226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715229">em</span><span class="op" id="4715231">[</span><span class="num" id="4715232">1</span><span class="op" id="4715233">]</span>&nbsp;<span class="op" id="4715235">=</span>&nbsp;<span class="num" id="4715237">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715240">ps</span><span class="op" id="4715242">,</span>&nbsp;<span class="ident" id="4715244">mm</span>&nbsp;<span class="op" id="4715247">:=</span>&nbsp;<span class="ident" id="4715250">em</span><span class="op" id="4715252">[</span><span class="num" id="4715253">2</span><span class="op" id="4715254">:</span><span class="builtinfunc" id="4715255">len</span><span class="op" id="4715258">(</span><span class="ident" id="4715259">em</span><span class="op" id="4715261">)</span><span class="op" id="4715262">-</span><span class="builtinfunc" id="4715263">len</span><span class="op" id="4715266">(</span><span class="ident" id="4715267">msg</span><span class="op" id="4715270">)</span><span class="op" id="4715271">-</span><span class="num" id="4715272">1</span><span class="op" id="4715273">]</span><span class="op" id="4715274">,</span>&nbsp;<span class="ident" id="4715276">em</span><span class="op" id="4715278">[</span><span class="builtinfunc" id="4715279">len</span><span class="op" id="4715282">(</span><span class="ident" id="4715283">em</span><span class="op" id="4715285">)</span><span class="op" id="4715286">-</span><span class="builtinfunc" id="4715287">len</span><span class="op" id="4715290">(</span><span class="ident" id="4715291">msg</span><span class="op" id="4715294">)</span><span class="op" id="4715295">:</span><span class="op" id="4715296">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715299">err</span>&nbsp;<span class="op" id="4715303">=</span>&nbsp;<span class="ident" id="4715305">nonZeroRandomBytes</span><span class="op" id="4715323">(</span><span class="ident" id="4715324">ps</span><span class="op" id="4715326">,</span>&nbsp;<span class="ident" id="4715328">rand</span><span class="op" id="4715332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715335">if</span>&nbsp;<span class="ident" id="4715338">err</span>&nbsp;<span class="op" id="4715342">!=</span>&nbsp;<span class="ident" id="4715345">nil</span>&nbsp;<span class="op" id="4715349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715353">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715364">em</span><span class="op" id="4715366">[</span><span class="builtinfunc" id="4715367">len</span><span class="op" id="4715370">(</span><span class="ident" id="4715371">em</span><span class="op" id="4715373">)</span><span class="op" id="4715374">-</span><span class="builtinfunc" id="4715375">len</span><span class="op" id="4715378">(</span><span class="ident" id="4715379">msg</span><span class="op" id="4715382">)</span><span class="op" id="4715383">-</span><span class="num" id="4715384">1</span><span class="op" id="4715385">]</span>&nbsp;<span class="op" id="4715387">=</span>&nbsp;<span class="num" id="4715389">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4715392">copy</span><span class="op" id="4715396">(</span><span class="ident" id="4715397">mm</span><span class="op" id="4715399">,</span>&nbsp;<span class="ident" id="4715401">msg</span><span class="op" id="4715404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715408">m</span>&nbsp;<span class="op" id="4715410">:=</span>&nbsp;<span class="builtinfunc" id="4715413">new</span><span class="op" id="4715416">(</span><span class="ident" id="4715417">big</span><span class="op" id="4715420">.</span><span class="ident" id="4715421">Int</span><span class="op" id="4715424">)</span><span class="op" id="4715425">.</span><span class="ident" id="4715426">SetBytes</span><span class="op" id="4715434">(</span><span class="ident" id="4715435">em</span><span class="op" id="4715437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715440">c</span>&nbsp;<span class="op" id="4715442">:=</span>&nbsp;<span class="ident" id="4715445">encrypt</span><span class="op" id="4715452">(</span><span class="builtinfunc" id="4715453">new</span><span class="op" id="4715456">(</span><span class="ident" id="4715457">big</span><span class="op" id="4715460">.</span><span class="ident" id="4715461">Int</span><span class="op" id="4715464">)</span><span class="op" id="4715465">,</span>&nbsp;<span class="ident" id="4715467">pub</span><span class="op" id="4715470">,</span>&nbsp;<span class="ident" id="4715472">m</span><span class="op" id="4715473">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715477">copyWithLeftPad</span><span class="op" id="4715492">(</span><span class="ident" id="4715493">em</span><span class="op" id="4715495">,</span>&nbsp;<span class="ident" id="4715497">c</span><span class="op" id="4715498">.</span><span class="ident" id="4715499">Bytes</span><span class="op" id="4715504">(</span><span class="op" id="4715505">)</span><span class="op" id="4715506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715509">out</span>&nbsp;<span class="op" id="4715513">=</span>&nbsp;<span class="ident" id="4715515">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715519">return</span><br>
<span class="lineno"></span><span class="op" id="4715526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4715529">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4715620">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4715698">func</span>&nbsp;<span class="ident" id="4715703">DecryptPKCS1v15</span><span class="op" id="4715718">(</span><span class="ident" id="4715719">rand</span>&nbsp;<span class="ident" id="4715724">io</span><span class="op" id="4715726">.</span><span class="ident" id="4715727">Reader</span><span class="op" id="4715733">,</span>&nbsp;<span class="ident" id="4715735">priv</span>&nbsp;<span class="op" id="4715740">*</span><span class="ident" id="4715741">PrivateKey</span><span class="op" id="4715751">,</span>&nbsp;<span class="ident" id="4715753">ciphertext</span>&nbsp;<span class="op" id="4715764">[</span><span class="op" id="4715765">]</span><span class="builtintype" id="4715766">byte</span><span class="op" id="4715770">)</span>&nbsp;<span class="op" id="4715772">(</span><span class="ident" id="4715773">out</span>&nbsp;<span class="op" id="4715777">[</span><span class="op" id="4715778">]</span><span class="builtintype" id="4715779">byte</span><span class="op" id="4715783">,</span>&nbsp;<span class="ident" id="4715785">err</span>&nbsp;<span class="builtintype" id="4715789">error</span><span class="op" id="4715794">)</span>&nbsp;<span class="op" id="4715796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715799">if</span>&nbsp;<span class="ident" id="4715802">err</span>&nbsp;<span class="op" id="4715806">:=</span>&nbsp;<span class="ident" id="4715809">checkPub</span><span class="op" id="4715817">(</span><span class="op" id="4715818">&amp;</span><span class="ident" id="4715819">priv</span><span class="op" id="4715823">.</span><span class="ident" id="4715824">PublicKey</span><span class="op" id="4715833">)</span><span class="op" id="4715834">;</span>&nbsp;<span class="ident" id="4715836">err</span>&nbsp;<span class="op" id="4715840">!=</span>&nbsp;<span class="ident" id="4715843">nil</span>&nbsp;<span class="op" id="4715847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715851">return</span>&nbsp;<span class="ident" id="4715858">nil</span><span class="op" id="4715861">,</span>&nbsp;<span class="ident" id="4715863">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715871">valid</span><span class="op" id="4715876">,</span>&nbsp;<span class="ident" id="4715878">out</span><span class="op" id="4715881">,</span>&nbsp;<span class="ident" id="4715883">index</span><span class="op" id="4715888">,</span>&nbsp;<span class="ident" id="4715890">err</span>&nbsp;<span class="op" id="4715894">:=</span>&nbsp;<span class="ident" id="4715897">decryptPKCS1v15</span><span class="op" id="4715912">(</span><span class="ident" id="4715913">rand</span><span class="op" id="4715917">,</span>&nbsp;<span class="ident" id="4715919">priv</span><span class="op" id="4715923">,</span>&nbsp;<span class="ident" id="4715925">ciphertext</span><span class="op" id="4715935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715938">if</span>&nbsp;<span class="ident" id="4715941">err</span>&nbsp;<span class="op" id="4715945">!=</span>&nbsp;<span class="ident" id="4715948">nil</span>&nbsp;<span class="op" id="4715952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715956">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715964">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715967">if</span>&nbsp;<span class="ident" id="4715970">valid</span>&nbsp;<span class="op" id="4715976">==</span>&nbsp;<span class="num" id="4715979">0</span>&nbsp;<span class="op" id="4715981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715985">return</span>&nbsp;<span class="ident" id="4715992">nil</span><span class="op" id="4715995">,</span>&nbsp;<span class="ident" id="4715997">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716015">out</span>&nbsp;<span class="op" id="4716019">=</span>&nbsp;<span class="ident" id="4716021">out</span><span class="op" id="4716024">[</span><span class="ident" id="4716025">index</span><span class="op" id="4716030">:</span><span class="op" id="4716031">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716034">return</span><br>
<span class="lineno">65</span><span class="op" id="4716041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4716044">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4716147">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4716225">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4716296">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4716369">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4716449">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4716528">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4716601">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4716679">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4716758">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4716782">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4716852">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4716932">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4716949">func</span>&nbsp;<span class="ident" id="4716954">DecryptPKCS1v15SessionKey</span><span class="op" id="4716979">(</span><span class="ident" id="4716980">rand</span>&nbsp;<span class="ident" id="4716985">io</span><span class="op" id="4716987">.</span><span class="ident" id="4716988">Reader</span><span class="op" id="4716994">,</span>&nbsp;<span class="ident" id="4716996">priv</span>&nbsp;<span class="op" id="4717001">*</span><span class="ident" id="4717002">PrivateKey</span><span class="op" id="4717012">,</span>&nbsp;<span class="ident" id="4717014">ciphertext</span>&nbsp;<span class="op" id="4717025">[</span><span class="op" id="4717026">]</span><span class="builtintype" id="4717027">byte</span><span class="op" id="4717031">,</span>&nbsp;<span class="ident" id="4717033">key</span>&nbsp;<span class="op" id="4717037">[</span><span class="op" id="4717038">]</span><span class="builtintype" id="4717039">byte</span><span class="op" id="4717043">)</span>&nbsp;<span class="op" id="4717045">(</span><span class="ident" id="4717046">err</span>&nbsp;<span class="builtintype" id="4717050">error</span><span class="op" id="4717055">)</span>&nbsp;<span class="op" id="4717057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717060">if</span>&nbsp;<span class="ident" id="4717063">err</span>&nbsp;<span class="op" id="4717067">:=</span>&nbsp;<span class="ident" id="4717070">checkPub</span><span class="op" id="4717078">(</span><span class="op" id="4717079">&amp;</span><span class="ident" id="4717080">priv</span><span class="op" id="4717084">.</span><span class="ident" id="4717085">PublicKey</span><span class="op" id="4717094">)</span><span class="op" id="4717095">;</span>&nbsp;<span class="ident" id="4717097">err</span>&nbsp;<span class="op" id="4717101">!=</span>&nbsp;<span class="ident" id="4717104">nil</span>&nbsp;<span class="op" id="4717108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717112">return</span>&nbsp;<span class="ident" id="4717119">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717127">k</span>&nbsp;<span class="op" id="4717129">:=</span>&nbsp;<span class="op" id="4717132">(</span><span class="ident" id="4717133">priv</span><span class="op" id="4717137">.</span><span class="ident" id="4717138">N</span><span class="op" id="4717139">.</span><span class="ident" id="4717140">BitLen</span><span class="op" id="4717146">(</span><span class="op" id="4717147">)</span>&nbsp;<span class="op" id="4717149">+</span>&nbsp;<span class="num" id="4717151">7</span><span class="op" id="4717152">)</span>&nbsp;<span class="op" id="4717154">/</span>&nbsp;<span class="num" id="4717156">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717159">if</span>&nbsp;<span class="ident" id="4717162">k</span><span class="op" id="4717163">-</span><span class="op" id="4717164">(</span><span class="builtinfunc" id="4717165">len</span><span class="op" id="4717168">(</span><span class="ident" id="4717169">key</span><span class="op" id="4717172">)</span><span class="op" id="4717173">+</span><span class="num" id="4717174">3</span><span class="op" id="4717175">+</span><span class="num" id="4717176">8</span><span class="op" id="4717177">)</span>&nbsp;<span class="op" id="4717179">&lt;</span>&nbsp;<span class="num" id="4717181">0</span>&nbsp;<span class="op" id="4717183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717187">return</span>&nbsp;<span class="ident" id="4717194">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717213">valid</span><span class="op" id="4717218">,</span>&nbsp;<span class="ident" id="4717220">em</span><span class="op" id="4717222">,</span>&nbsp;<span class="ident" id="4717224">index</span><span class="op" id="4717229">,</span>&nbsp;<span class="ident" id="4717231">err</span>&nbsp;<span class="op" id="4717235">:=</span>&nbsp;<span class="ident" id="4717238">decryptPKCS1v15</span><span class="op" id="4717253">(</span><span class="ident" id="4717254">rand</span><span class="op" id="4717258">,</span>&nbsp;<span class="ident" id="4717260">priv</span><span class="op" id="4717264">,</span>&nbsp;<span class="ident" id="4717266">ciphertext</span><span class="op" id="4717276">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717279">if</span>&nbsp;<span class="ident" id="4717282">err</span>&nbsp;<span class="op" id="4717286">!=</span>&nbsp;<span class="ident" id="4717289">nil</span>&nbsp;<span class="op" id="4717293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717297">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717309">if</span>&nbsp;<span class="builtinfunc" id="4717312">len</span><span class="op" id="4717315">(</span><span class="ident" id="4717316">em</span><span class="op" id="4717318">)</span>&nbsp;<span class="op" id="4717320">!=</span>&nbsp;<span class="ident" id="4717323">k</span>&nbsp;<span class="op" id="4717325">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717329">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717391">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717420">return</span>&nbsp;<span class="ident" id="4717427">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717446">valid</span>&nbsp;<span class="op" id="4717452">&amp;=</span>&nbsp;<span class="ident" id="4717455">subtle</span><span class="op" id="4717461">.</span><span class="ident" id="4717462">ConstantTimeEq</span><span class="op" id="4717476">(</span><span class="builtintype" id="4717477">int32</span><span class="op" id="4717482">(</span><span class="builtinfunc" id="4717483">len</span><span class="op" id="4717486">(</span><span class="ident" id="4717487">em</span><span class="op" id="4717489">)</span><span class="op" id="4717490">-</span><span class="ident" id="4717491">index</span><span class="op" id="4717496">)</span><span class="op" id="4717497">,</span>&nbsp;<span class="builtintype" id="4717499">int32</span><span class="op" id="4717504">(</span><span class="builtinfunc" id="4717505">len</span><span class="op" id="4717508">(</span><span class="ident" id="4717509">key</span><span class="op" id="4717512">)</span><span class="op" id="4717513">)</span><span class="op" id="4717514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717517">subtle</span><span class="op" id="4717523">.</span><span class="ident" id="4717524">ConstantTimeCopy</span><span class="op" id="4717540">(</span><span class="ident" id="4717541">valid</span><span class="op" id="4717546">,</span>&nbsp;<span class="ident" id="4717548">key</span><span class="op" id="4717551">,</span>&nbsp;<span class="ident" id="4717553">em</span><span class="op" id="4717555">[</span><span class="builtinfunc" id="4717556">len</span><span class="op" id="4717559">(</span><span class="ident" id="4717560">em</span><span class="op" id="4717562">)</span><span class="op" id="4717563">-</span><span class="builtinfunc" id="4717564">len</span><span class="op" id="4717567">(</span><span class="ident" id="4717568">key</span><span class="op" id="4717571">)</span><span class="op" id="4717572">:</span><span class="op" id="4717573">]</span><span class="op" id="4717574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717577">return</span><br>
<span class="lineno"></span><span class="op" id="4717584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4717587">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4717665">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4717744">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4717816">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4717895">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4717973">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4718043">func</span>&nbsp;<span class="ident" id="4718048">decryptPKCS1v15</span><span class="op" id="4718063">(</span><span class="ident" id="4718064">rand</span>&nbsp;<span class="ident" id="4718069">io</span><span class="op" id="4718071">.</span><span class="ident" id="4718072">Reader</span><span class="op" id="4718078">,</span>&nbsp;<span class="ident" id="4718080">priv</span>&nbsp;<span class="op" id="4718085">*</span><span class="ident" id="4718086">PrivateKey</span><span class="op" id="4718096">,</span>&nbsp;<span class="ident" id="4718098">ciphertext</span>&nbsp;<span class="op" id="4718109">[</span><span class="op" id="4718110">]</span><span class="builtintype" id="4718111">byte</span><span class="op" id="4718115">)</span>&nbsp;<span class="op" id="4718117">(</span><span class="ident" id="4718118">valid</span>&nbsp;<span class="builtintype" id="4718124">int</span><span class="op" id="4718127">,</span>&nbsp;<span class="ident" id="4718129">em</span>&nbsp;<span class="op" id="4718132">[</span><span class="op" id="4718133">]</span><span class="builtintype" id="4718134">byte</span><span class="op" id="4718138">,</span>&nbsp;<span class="ident" id="4718140">index</span>&nbsp;<span class="builtintype" id="4718146">int</span><span class="op" id="4718149">,</span>&nbsp;<span class="ident" id="4718151">err</span>&nbsp;<span class="builtintype" id="4718155">error</span><span class="op" id="4718160">)</span>&nbsp;<span class="op" id="4718162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718165">k</span>&nbsp;<span class="op" id="4718167">:=</span>&nbsp;<span class="op" id="4718170">(</span><span class="ident" id="4718171">priv</span><span class="op" id="4718175">.</span><span class="ident" id="4718176">N</span><span class="op" id="4718177">.</span><span class="ident" id="4718178">BitLen</span><span class="op" id="4718184">(</span><span class="op" id="4718185">)</span>&nbsp;<span class="op" id="4718187">+</span>&nbsp;<span class="num" id="4718189">7</span><span class="op" id="4718190">)</span>&nbsp;<span class="op" id="4718192">/</span>&nbsp;<span class="num" id="4718194">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718197">if</span>&nbsp;<span class="ident" id="4718200">k</span>&nbsp;<span class="op" id="4718202">&lt;</span>&nbsp;<span class="num" id="4718204">11</span>&nbsp;<span class="op" id="4718207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718211">err</span>&nbsp;<span class="op" id="4718215">=</span>&nbsp;<span class="ident" id="4718217">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718233">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718245">c</span>&nbsp;<span class="op" id="4718247">:=</span>&nbsp;<span class="builtinfunc" id="4718250">new</span><span class="op" id="4718253">(</span><span class="ident" id="4718254">big</span><span class="op" id="4718257">.</span><span class="ident" id="4718258">Int</span><span class="op" id="4718261">)</span><span class="op" id="4718262">.</span><span class="ident" id="4718263">SetBytes</span><span class="op" id="4718271">(</span><span class="ident" id="4718272">ciphertext</span><span class="op" id="4718282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718285">m</span><span class="op" id="4718286">,</span>&nbsp;<span class="ident" id="4718288">err</span>&nbsp;<span class="op" id="4718292">:=</span>&nbsp;<span class="ident" id="4718295">decrypt</span><span class="op" id="4718302">(</span><span class="ident" id="4718303">rand</span><span class="op" id="4718307">,</span>&nbsp;<span class="ident" id="4718309">priv</span><span class="op" id="4718313">,</span>&nbsp;<span class="ident" id="4718315">c</span><span class="op" id="4718316">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718319">if</span>&nbsp;<span class="ident" id="4718322">err</span>&nbsp;<span class="op" id="4718326">!=</span>&nbsp;<span class="ident" id="4718329">nil</span>&nbsp;<span class="op" id="4718333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718337">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718349">em</span>&nbsp;<span class="op" id="4718352">=</span>&nbsp;<span class="ident" id="4718354">leftPad</span><span class="op" id="4718361">(</span><span class="ident" id="4718362">m</span><span class="op" id="4718363">.</span><span class="ident" id="4718364">Bytes</span><span class="op" id="4718369">(</span><span class="op" id="4718370">)</span><span class="op" id="4718371">,</span>&nbsp;<span class="ident" id="4718373">k</span><span class="op" id="4718374">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718377">firstByteIsZero</span>&nbsp;<span class="op" id="4718393">:=</span>&nbsp;<span class="ident" id="4718396">subtle</span><span class="op" id="4718402">.</span><span class="ident" id="4718403">ConstantTimeByteEq</span><span class="op" id="4718421">(</span><span class="ident" id="4718422">em</span><span class="op" id="4718424">[</span><span class="num" id="4718425">0</span><span class="op" id="4718426">]</span><span class="op" id="4718427">,</span>&nbsp;<span class="num" id="4718429">0</span><span class="op" id="4718430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718433">secondByteIsTwo</span>&nbsp;<span class="op" id="4718449">:=</span>&nbsp;<span class="ident" id="4718452">subtle</span><span class="op" id="4718458">.</span><span class="ident" id="4718459">ConstantTimeByteEq</span><span class="op" id="4718477">(</span><span class="ident" id="4718478">em</span><span class="op" id="4718480">[</span><span class="num" id="4718481">1</span><span class="op" id="4718482">]</span><span class="op" id="4718483">,</span>&nbsp;<span class="num" id="4718485">2</span><span class="op" id="4718486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718490">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718561">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718615">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718679">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718727">lookingForIndex</span>&nbsp;<span class="op" id="4718743">:=</span>&nbsp;<span class="num" id="4718746">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718750">for</span>&nbsp;<span class="ident" id="4718754">i</span>&nbsp;<span class="op" id="4718756">:=</span>&nbsp;<span class="num" id="4718759">2</span><span class="op" id="4718760">;</span>&nbsp;<span class="ident" id="4718762">i</span>&nbsp;<span class="op" id="4718764">&lt;</span>&nbsp;<span class="builtinfunc" id="4718766">len</span><span class="op" id="4718769">(</span><span class="ident" id="4718770">em</span><span class="op" id="4718772">)</span><span class="op" id="4718773">;</span>&nbsp;<span class="ident" id="4718775">i</span><span class="op" id="4718776">++</span>&nbsp;<span class="op" id="4718779">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718783">equals0</span>&nbsp;<span class="op" id="4718791">:=</span>&nbsp;<span class="ident" id="4718794">subtle</span><span class="op" id="4718800">.</span><span class="ident" id="4718801">ConstantTimeByteEq</span><span class="op" id="4718819">(</span><span class="ident" id="4718820">em</span><span class="op" id="4718822">[</span><span class="ident" id="4718823">i</span><span class="op" id="4718824">]</span><span class="op" id="4718825">,</span>&nbsp;<span class="num" id="4718827">0</span><span class="op" id="4718828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718832">index</span>&nbsp;<span class="op" id="4718838">=</span>&nbsp;<span class="ident" id="4718840">subtle</span><span class="op" id="4718846">.</span><span class="ident" id="4718847">ConstantTimeSelect</span><span class="op" id="4718865">(</span><span class="ident" id="4718866">lookingForIndex</span><span class="op" id="4718881">&amp;</span><span class="ident" id="4718882">equals0</span><span class="op" id="4718889">,</span>&nbsp;<span class="ident" id="4718891">i</span><span class="op" id="4718892">,</span>&nbsp;<span class="ident" id="4718894">index</span><span class="op" id="4718899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718903">lookingForIndex</span>&nbsp;<span class="op" id="4718919">=</span>&nbsp;<span class="ident" id="4718921">subtle</span><span class="op" id="4718927">.</span><span class="ident" id="4718928">ConstantTimeSelect</span><span class="op" id="4718946">(</span><span class="ident" id="4718947">equals0</span><span class="op" id="4718954">,</span>&nbsp;<span class="num" id="4718956">0</span><span class="op" id="4718957">,</span>&nbsp;<span class="ident" id="4718959">lookingForIndex</span><span class="op" id="4718974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718981">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719049">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719068">validPS</span>&nbsp;<span class="op" id="4719076">:=</span>&nbsp;<span class="ident" id="4719079">subtle</span><span class="op" id="4719085">.</span><span class="ident" id="4719086">ConstantTimeLessOrEq</span><span class="op" id="4719106">(</span><span class="num" id="4719107">2</span><span class="op" id="4719108">+</span><span class="num" id="4719109">8</span><span class="op" id="4719110">,</span>&nbsp;<span class="ident" id="4719112">index</span><span class="op" id="4719117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719121">valid</span>&nbsp;<span class="op" id="4719127">=</span>&nbsp;<span class="ident" id="4719129">firstByteIsZero</span>&nbsp;<span class="op" id="4719145">&amp;</span>&nbsp;<span class="ident" id="4719147">secondByteIsTwo</span>&nbsp;<span class="op" id="4719163">&amp;</span>&nbsp;<span class="op" id="4719165">(</span><span class="op" id="4719166">^</span><span class="ident" id="4719167">lookingForIndex</span>&nbsp;<span class="op" id="4719183">&amp;</span>&nbsp;<span class="num" id="4719185">1</span><span class="op" id="4719186">)</span>&nbsp;<span class="op" id="4719188">&amp;</span>&nbsp;<span class="ident" id="4719190">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719199">index</span>&nbsp;<span class="op" id="4719205">=</span>&nbsp;<span class="ident" id="4719207">subtle</span><span class="op" id="4719213">.</span><span class="ident" id="4719214">ConstantTimeSelect</span><span class="op" id="4719232">(</span><span class="ident" id="4719233">valid</span><span class="op" id="4719238">,</span>&nbsp;<span class="ident" id="4719240">index</span><span class="op" id="4719245">+</span><span class="num" id="4719246">1</span><span class="op" id="4719247">,</span>&nbsp;<span class="num" id="4719249">0</span><span class="op" id="4719250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719253">return</span>&nbsp;<span class="ident" id="4719260">valid</span><span class="op" id="4719265">,</span>&nbsp;<span class="ident" id="4719267">em</span><span class="op" id="4719269">,</span>&nbsp;<span class="ident" id="4719271">index</span><span class="op" id="4719276">,</span>&nbsp;<span class="ident" id="4719278">nil</span><br>
<span class="lineno"></span><span class="op" id="4719282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4719285">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4719358">func</span>&nbsp;<span class="ident" id="4719363">nonZeroRandomBytes</span><span class="op" id="4719381">(</span><span class="ident" id="4719382">s</span>&nbsp;<span class="op" id="4719384">[</span><span class="op" id="4719385">]</span><span class="builtintype" id="4719386">byte</span><span class="op" id="4719390">,</span>&nbsp;<span class="ident" id="4719392">rand</span>&nbsp;<span class="ident" id="4719397">io</span><span class="op" id="4719399">.</span><span class="ident" id="4719400">Reader</span><span class="op" id="4719406">)</span>&nbsp;<span class="op" id="4719408">(</span><span class="ident" id="4719409">err</span>&nbsp;<span class="builtintype" id="4719413">error</span><span class="op" id="4719418">)</span>&nbsp;<span class="op" id="4719420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719423">_</span><span class="op" id="4719424">,</span>&nbsp;<span class="ident" id="4719426">err</span>&nbsp;<span class="op" id="4719430">=</span>&nbsp;<span class="ident" id="4719432">io</span><span class="op" id="4719434">.</span><span class="ident" id="4719435">ReadFull</span><span class="op" id="4719443">(</span><span class="ident" id="4719444">rand</span><span class="op" id="4719448">,</span>&nbsp;<span class="ident" id="4719450">s</span><span class="op" id="4719451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719454">if</span>&nbsp;<span class="ident" id="4719457">err</span>&nbsp;<span class="op" id="4719461">!=</span>&nbsp;<span class="ident" id="4719464">nil</span>&nbsp;<span class="op" id="4719468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719472">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719480">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719484">for</span>&nbsp;<span class="ident" id="4719488">i</span>&nbsp;<span class="op" id="4719490">:=</span>&nbsp;<span class="num" id="4719493">0</span><span class="op" id="4719494">;</span>&nbsp;<span class="ident" id="4719496">i</span>&nbsp;<span class="op" id="4719498">&lt;</span>&nbsp;<span class="builtinfunc" id="4719500">len</span><span class="op" id="4719503">(</span><span class="ident" id="4719504">s</span><span class="op" id="4719505">)</span><span class="op" id="4719506">;</span>&nbsp;<span class="ident" id="4719508">i</span><span class="op" id="4719509">++</span>&nbsp;<span class="op" id="4719512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719516">for</span>&nbsp;<span class="ident" id="4719520">s</span><span class="op" id="4719521">[</span><span class="ident" id="4719522">i</span><span class="op" id="4719523">]</span>&nbsp;<span class="op" id="4719525">==</span>&nbsp;<span class="num" id="4719528">0</span>&nbsp;<span class="op" id="4719530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719535">_</span><span class="op" id="4719536">,</span>&nbsp;<span class="ident" id="4719538">err</span>&nbsp;<span class="op" id="4719542">=</span>&nbsp;<span class="ident" id="4719544">io</span><span class="op" id="4719546">.</span><span class="ident" id="4719547">ReadFull</span><span class="op" id="4719555">(</span><span class="ident" id="4719556">rand</span><span class="op" id="4719560">,</span>&nbsp;<span class="ident" id="4719562">s</span><span class="op" id="4719563">[</span><span class="ident" id="4719564">i</span><span class="op" id="4719565">:</span><span class="ident" id="4719566">i</span><span class="op" id="4719567">+</span><span class="num" id="4719568">1</span><span class="op" id="4719569">]</span><span class="op" id="4719570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719575">if</span>&nbsp;<span class="ident" id="4719578">err</span>&nbsp;<span class="op" id="4719582">!=</span>&nbsp;<span class="ident" id="4719585">nil</span>&nbsp;<span class="op" id="4719589">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719595">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719610">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719665">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719695">s</span><span class="op" id="4719696">[</span><span class="ident" id="4719697">i</span><span class="op" id="4719698">]</span>&nbsp;<span class="op" id="4719700">^=</span>&nbsp;<span class="num" id="4719703">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719717">return</span><br>
<span class="lineno"></span><span class="op" id="4719724">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4719727">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4719761">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4719792">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4719836">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4719863">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4719870">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4719940">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4720018">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4720048">var</span>&nbsp;<span class="ident" id="4720052">hashPrefixes</span>&nbsp;<span class="op" id="4720065">=</span>&nbsp;<span class="keyword" id="4720067">map</span><span class="op" id="4720070">[</span><span class="ident" id="4720071">crypto</span><span class="op" id="4720077">.</span><span class="ident" id="4720078">Hash</span><span class="op" id="4720082">]</span><span class="op" id="4720083">[</span><span class="op" id="4720084">]</span><span class="builtintype" id="4720085">byte</span><span class="op" id="4720089">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720092">crypto</span><span class="op" id="4720098">.</span><span class="ident" id="4720099">MD5</span><span class="op" id="4720102">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4720110">{</span><span class="num" id="4720111">0x30</span><span class="op" id="4720115">,</span>&nbsp;<span class="num" id="4720117">0x20</span><span class="op" id="4720121">,</span>&nbsp;<span class="num" id="4720123">0x30</span><span class="op" id="4720127">,</span>&nbsp;<span class="num" id="4720129">0x0c</span><span class="op" id="4720133">,</span>&nbsp;<span class="num" id="4720135">0x06</span><span class="op" id="4720139">,</span>&nbsp;<span class="num" id="4720141">0x08</span><span class="op" id="4720145">,</span>&nbsp;<span class="num" id="4720147">0x2a</span><span class="op" id="4720151">,</span>&nbsp;<span class="num" id="4720153">0x86</span><span class="op" id="4720157">,</span>&nbsp;<span class="num" id="4720159">0x48</span><span class="op" id="4720163">,</span>&nbsp;<span class="num" id="4720165">0x86</span><span class="op" id="4720169">,</span>&nbsp;<span class="num" id="4720171">0xf7</span><span class="op" id="4720175">,</span>&nbsp;<span class="num" id="4720177">0x0d</span><span class="op" id="4720181">,</span>&nbsp;<span class="num" id="4720183">0x02</span><span class="op" id="4720187">,</span>&nbsp;<span class="num" id="4720189">0x05</span><span class="op" id="4720193">,</span>&nbsp;<span class="num" id="4720195">0x05</span><span class="op" id="4720199">,</span>&nbsp;<span class="num" id="4720201">0x00</span><span class="op" id="4720205">,</span>&nbsp;<span class="num" id="4720207">0x04</span><span class="op" id="4720211">,</span>&nbsp;<span class="num" id="4720213">0x10</span><span class="op" id="4720217">}</span><span class="op" id="4720218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720221">crypto</span><span class="op" id="4720227">.</span><span class="ident" id="4720228">SHA1</span><span class="op" id="4720232">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4720239">{</span><span class="num" id="4720240">0x30</span><span class="op" id="4720244">,</span>&nbsp;<span class="num" id="4720246">0x21</span><span class="op" id="4720250">,</span>&nbsp;<span class="num" id="4720252">0x30</span><span class="op" id="4720256">,</span>&nbsp;<span class="num" id="4720258">0x09</span><span class="op" id="4720262">,</span>&nbsp;<span class="num" id="4720264">0x06</span><span class="op" id="4720268">,</span>&nbsp;<span class="num" id="4720270">0x05</span><span class="op" id="4720274">,</span>&nbsp;<span class="num" id="4720276">0x2b</span><span class="op" id="4720280">,</span>&nbsp;<span class="num" id="4720282">0x0e</span><span class="op" id="4720286">,</span>&nbsp;<span class="num" id="4720288">0x03</span><span class="op" id="4720292">,</span>&nbsp;<span class="num" id="4720294">0x02</span><span class="op" id="4720298">,</span>&nbsp;<span class="num" id="4720300">0x1a</span><span class="op" id="4720304">,</span>&nbsp;<span class="num" id="4720306">0x05</span><span class="op" id="4720310">,</span>&nbsp;<span class="num" id="4720312">0x00</span><span class="op" id="4720316">,</span>&nbsp;<span class="num" id="4720318">0x04</span><span class="op" id="4720322">,</span>&nbsp;<span class="num" id="4720324">0x14</span><span class="op" id="4720328">}</span><span class="op" id="4720329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720332">crypto</span><span class="op" id="4720338">.</span><span class="ident" id="4720339">SHA224</span><span class="op" id="4720345">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4720350">{</span><span class="num" id="4720351">0x30</span><span class="op" id="4720355">,</span>&nbsp;<span class="num" id="4720357">0x2d</span><span class="op" id="4720361">,</span>&nbsp;<span class="num" id="4720363">0x30</span><span class="op" id="4720367">,</span>&nbsp;<span class="num" id="4720369">0x0d</span><span class="op" id="4720373">,</span>&nbsp;<span class="num" id="4720375">0x06</span><span class="op" id="4720379">,</span>&nbsp;<span class="num" id="4720381">0x09</span><span class="op" id="4720385">,</span>&nbsp;<span class="num" id="4720387">0x60</span><span class="op" id="4720391">,</span>&nbsp;<span class="num" id="4720393">0x86</span><span class="op" id="4720397">,</span>&nbsp;<span class="num" id="4720399">0x48</span><span class="op" id="4720403">,</span>&nbsp;<span class="num" id="4720405">0x01</span><span class="op" id="4720409">,</span>&nbsp;<span class="num" id="4720411">0x65</span><span class="op" id="4720415">,</span>&nbsp;<span class="num" id="4720417">0x03</span><span class="op" id="4720421">,</span>&nbsp;<span class="num" id="4720423">0x04</span><span class="op" id="4720427">,</span>&nbsp;<span class="num" id="4720429">0x02</span><span class="op" id="4720433">,</span>&nbsp;<span class="num" id="4720435">0x04</span><span class="op" id="4720439">,</span>&nbsp;<span class="num" id="4720441">0x05</span><span class="op" id="4720445">,</span>&nbsp;<span class="num" id="4720447">0x00</span><span class="op" id="4720451">,</span>&nbsp;<span class="num" id="4720453">0x04</span><span class="op" id="4720457">,</span>&nbsp;<span class="num" id="4720459">0x1c</span><span class="op" id="4720463">}</span><span class="op" id="4720464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720467">crypto</span><span class="op" id="4720473">.</span><span class="ident" id="4720474">SHA256</span><span class="op" id="4720480">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4720485">{</span><span class="num" id="4720486">0x30</span><span class="op" id="4720490">,</span>&nbsp;<span class="num" id="4720492">0x31</span><span class="op" id="4720496">,</span>&nbsp;<span class="num" id="4720498">0x30</span><span class="op" id="4720502">,</span>&nbsp;<span class="num" id="4720504">0x0d</span><span class="op" id="4720508">,</span>&nbsp;<span class="num" id="4720510">0x06</span><span class="op" id="4720514">,</span>&nbsp;<span class="num" id="4720516">0x09</span><span class="op" id="4720520">,</span>&nbsp;<span class="num" id="4720522">0x60</span><span class="op" id="4720526">,</span>&nbsp;<span class="num" id="4720528">0x86</span><span class="op" id="4720532">,</span>&nbsp;<span class="num" id="4720534">0x48</span><span class="op" id="4720538">,</span>&nbsp;<span class="num" id="4720540">0x01</span><span class="op" id="4720544">,</span>&nbsp;<span class="num" id="4720546">0x65</span><span class="op" id="4720550">,</span>&nbsp;<span class="num" id="4720552">0x03</span><span class="op" id="4720556">,</span>&nbsp;<span class="num" id="4720558">0x04</span><span class="op" id="4720562">,</span>&nbsp;<span class="num" id="4720564">0x02</span><span class="op" id="4720568">,</span>&nbsp;<span class="num" id="4720570">0x01</span><span class="op" id="4720574">,</span>&nbsp;<span class="num" id="4720576">0x05</span><span class="op" id="4720580">,</span>&nbsp;<span class="num" id="4720582">0x00</span><span class="op" id="4720586">,</span>&nbsp;<span class="num" id="4720588">0x04</span><span class="op" id="4720592">,</span>&nbsp;<span class="num" id="4720594">0x20</span><span class="op" id="4720598">}</span><span class="op" id="4720599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720602">crypto</span><span class="op" id="4720608">.</span><span class="ident" id="4720609">SHA384</span><span class="op" id="4720615">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4720620">{</span><span class="num" id="4720621">0x30</span><span class="op" id="4720625">,</span>&nbsp;<span class="num" id="4720627">0x41</span><span class="op" id="4720631">,</span>&nbsp;<span class="num" id="4720633">0x30</span><span class="op" id="4720637">,</span>&nbsp;<span class="num" id="4720639">0x0d</span><span class="op" id="4720643">,</span>&nbsp;<span class="num" id="4720645">0x06</span><span class="op" id="4720649">,</span>&nbsp;<span class="num" id="4720651">0x09</span><span class="op" id="4720655">,</span>&nbsp;<span class="num" id="4720657">0x60</span><span class="op" id="4720661">,</span>&nbsp;<span class="num" id="4720663">0x86</span><span class="op" id="4720667">,</span>&nbsp;<span class="num" id="4720669">0x48</span><span class="op" id="4720673">,</span>&nbsp;<span class="num" id="4720675">0x01</span><span class="op" id="4720679">,</span>&nbsp;<span class="num" id="4720681">0x65</span><span class="op" id="4720685">,</span>&nbsp;<span class="num" id="4720687">0x03</span><span class="op" id="4720691">,</span>&nbsp;<span class="num" id="4720693">0x04</span><span class="op" id="4720697">,</span>&nbsp;<span class="num" id="4720699">0x02</span><span class="op" id="4720703">,</span>&nbsp;<span class="num" id="4720705">0x02</span><span class="op" id="4720709">,</span>&nbsp;<span class="num" id="4720711">0x05</span><span class="op" id="4720715">,</span>&nbsp;<span class="num" id="4720717">0x00</span><span class="op" id="4720721">,</span>&nbsp;<span class="num" id="4720723">0x04</span><span class="op" id="4720727">,</span>&nbsp;<span class="num" id="4720729">0x30</span><span class="op" id="4720733">}</span><span class="op" id="4720734">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720737">crypto</span><span class="op" id="4720743">.</span><span class="ident" id="4720744">SHA512</span><span class="op" id="4720750">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4720755">{</span><span class="num" id="4720756">0x30</span><span class="op" id="4720760">,</span>&nbsp;<span class="num" id="4720762">0x51</span><span class="op" id="4720766">,</span>&nbsp;<span class="num" id="4720768">0x30</span><span class="op" id="4720772">,</span>&nbsp;<span class="num" id="4720774">0x0d</span><span class="op" id="4720778">,</span>&nbsp;<span class="num" id="4720780">0x06</span><span class="op" id="4720784">,</span>&nbsp;<span class="num" id="4720786">0x09</span><span class="op" id="4720790">,</span>&nbsp;<span class="num" id="4720792">0x60</span><span class="op" id="4720796">,</span>&nbsp;<span class="num" id="4720798">0x86</span><span class="op" id="4720802">,</span>&nbsp;<span class="num" id="4720804">0x48</span><span class="op" id="4720808">,</span>&nbsp;<span class="num" id="4720810">0x01</span><span class="op" id="4720814">,</span>&nbsp;<span class="num" id="4720816">0x65</span><span class="op" id="4720820">,</span>&nbsp;<span class="num" id="4720822">0x03</span><span class="op" id="4720826">,</span>&nbsp;<span class="num" id="4720828">0x04</span><span class="op" id="4720832">,</span>&nbsp;<span class="num" id="4720834">0x02</span><span class="op" id="4720838">,</span>&nbsp;<span class="num" id="4720840">0x03</span><span class="op" id="4720844">,</span>&nbsp;<span class="num" id="4720846">0x05</span><span class="op" id="4720850">,</span>&nbsp;<span class="num" id="4720852">0x00</span><span class="op" id="4720856">,</span>&nbsp;<span class="num" id="4720858">0x04</span><span class="op" id="4720862">,</span>&nbsp;<span class="num" id="4720864">0x40</span><span class="op" id="4720868">}</span><span class="op" id="4720869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720872">crypto</span><span class="op" id="4720878">.</span><span class="ident" id="4720879">MD5SHA1</span><span class="op" id="4720886">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4720890">{</span><span class="op" id="4720891">}</span><span class="op" id="4720892">,</span>&nbsp;<span class="comment" id="4720894">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720951">crypto</span><span class="op" id="4720957">.</span><span class="ident" id="4720958">RIPEMD160</span><span class="op" id="4720967">:</span>&nbsp;<span class="op" id="4720969">{</span><span class="num" id="4720970">0x30</span><span class="op" id="4720974">,</span>&nbsp;<span class="num" id="4720976">0x20</span><span class="op" id="4720980">,</span>&nbsp;<span class="num" id="4720982">0x30</span><span class="op" id="4720986">,</span>&nbsp;<span class="num" id="4720988">0x08</span><span class="op" id="4720992">,</span>&nbsp;<span class="num" id="4720994">0x06</span><span class="op" id="4720998">,</span>&nbsp;<span class="num" id="4721000">0x06</span><span class="op" id="4721004">,</span>&nbsp;<span class="num" id="4721006">0x28</span><span class="op" id="4721010">,</span>&nbsp;<span class="num" id="4721012">0xcf</span><span class="op" id="4721016">,</span>&nbsp;<span class="num" id="4721018">0x06</span><span class="op" id="4721022">,</span>&nbsp;<span class="num" id="4721024">0x03</span><span class="op" id="4721028">,</span>&nbsp;<span class="num" id="4721030">0x00</span><span class="op" id="4721034">,</span>&nbsp;<span class="num" id="4721036">0x31</span><span class="op" id="4721040">,</span>&nbsp;<span class="num" id="4721042">0x04</span><span class="op" id="4721046">,</span>&nbsp;<span class="num" id="4721048">0x14</span><span class="op" id="4721052">}</span><span class="op" id="4721053">,</span><br>
<span class="lineno"></span><span class="op" id="4721055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4721058">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4721160">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4721238">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4721317">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4721359">func</span>&nbsp;<span class="ident" id="4721364">SignPKCS1v15</span><span class="op" id="4721376">(</span><span class="ident" id="4721377">rand</span>&nbsp;<span class="ident" id="4721382">io</span><span class="op" id="4721384">.</span><span class="ident" id="4721385">Reader</span><span class="op" id="4721391">,</span>&nbsp;<span class="ident" id="4721393">priv</span>&nbsp;<span class="op" id="4721398">*</span><span class="ident" id="4721399">PrivateKey</span><span class="op" id="4721409">,</span>&nbsp;<span class="ident" id="4721411">hash</span>&nbsp;<span class="ident" id="4721416">crypto</span><span class="op" id="4721422">.</span><span class="ident" id="4721423">Hash</span><span class="op" id="4721427">,</span>&nbsp;<span class="ident" id="4721429">hashed</span>&nbsp;<span class="op" id="4721436">[</span><span class="op" id="4721437">]</span><span class="builtintype" id="4721438">byte</span><span class="op" id="4721442">)</span>&nbsp;<span class="op" id="4721444">(</span><span class="ident" id="4721445">s</span>&nbsp;<span class="op" id="4721447">[</span><span class="op" id="4721448">]</span><span class="builtintype" id="4721449">byte</span><span class="op" id="4721453">,</span>&nbsp;<span class="ident" id="4721455">err</span>&nbsp;<span class="builtintype" id="4721459">error</span><span class="op" id="4721464">)</span>&nbsp;<span class="op" id="4721466">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721469">hashLen</span><span class="op" id="4721476">,</span>&nbsp;<span class="ident" id="4721478">prefix</span><span class="op" id="4721484">,</span>&nbsp;<span class="ident" id="4721486">err</span>&nbsp;<span class="op" id="4721490">:=</span>&nbsp;<span class="ident" id="4721493">pkcs1v15HashInfo</span><span class="op" id="4721509">(</span><span class="ident" id="4721510">hash</span><span class="op" id="4721514">,</span>&nbsp;<span class="builtinfunc" id="4721516">len</span><span class="op" id="4721519">(</span><span class="ident" id="4721520">hashed</span><span class="op" id="4721526">)</span><span class="op" id="4721527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721530">if</span>&nbsp;<span class="ident" id="4721533">err</span>&nbsp;<span class="op" id="4721537">!=</span>&nbsp;<span class="ident" id="4721540">nil</span>&nbsp;<span class="op" id="4721544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721548">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721560">tLen</span>&nbsp;<span class="op" id="4721565">:=</span>&nbsp;<span class="builtinfunc" id="4721568">len</span><span class="op" id="4721571">(</span><span class="ident" id="4721572">prefix</span><span class="op" id="4721578">)</span>&nbsp;<span class="op" id="4721580">+</span>&nbsp;<span class="ident" id="4721582">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721591">k</span>&nbsp;<span class="op" id="4721593">:=</span>&nbsp;<span class="op" id="4721596">(</span><span class="ident" id="4721597">priv</span><span class="op" id="4721601">.</span><span class="ident" id="4721602">N</span><span class="op" id="4721603">.</span><span class="ident" id="4721604">BitLen</span><span class="op" id="4721610">(</span><span class="op" id="4721611">)</span>&nbsp;<span class="op" id="4721613">+</span>&nbsp;<span class="num" id="4721615">7</span><span class="op" id="4721616">)</span>&nbsp;<span class="op" id="4721618">/</span>&nbsp;<span class="num" id="4721620">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721623">if</span>&nbsp;<span class="ident" id="4721626">k</span>&nbsp;<span class="op" id="4721628">&lt;</span>&nbsp;<span class="ident" id="4721630">tLen</span><span class="op" id="4721634">+</span><span class="num" id="4721635">11</span>&nbsp;<span class="op" id="4721638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721642">return</span>&nbsp;<span class="ident" id="4721649">nil</span><span class="op" id="4721652">,</span>&nbsp;<span class="ident" id="4721654">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721673">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721677">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721718">em</span>&nbsp;<span class="op" id="4721721">:=</span>&nbsp;<span class="builtinfunc" id="4721724">make</span><span class="op" id="4721728">(</span><span class="op" id="4721729">[</span><span class="op" id="4721730">]</span><span class="builtintype" id="4721731">byte</span><span class="op" id="4721735">,</span>&nbsp;<span class="ident" id="4721737">k</span><span class="op" id="4721738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721741">em</span><span class="op" id="4721743">[</span><span class="num" id="4721744">1</span><span class="op" id="4721745">]</span>&nbsp;<span class="op" id="4721747">=</span>&nbsp;<span class="num" id="4721749">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721752">for</span>&nbsp;<span class="ident" id="4721756">i</span>&nbsp;<span class="op" id="4721758">:=</span>&nbsp;<span class="num" id="4721761">2</span><span class="op" id="4721762">;</span>&nbsp;<span class="ident" id="4721764">i</span>&nbsp;<span class="op" id="4721766">&lt;</span>&nbsp;<span class="ident" id="4721768">k</span><span class="op" id="4721769">-</span><span class="ident" id="4721770">tLen</span><span class="op" id="4721774">-</span><span class="num" id="4721775">1</span><span class="op" id="4721776">;</span>&nbsp;<span class="ident" id="4721778">i</span><span class="op" id="4721779">++</span>&nbsp;<span class="op" id="4721782">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721786">em</span><span class="op" id="4721788">[</span><span class="ident" id="4721789">i</span><span class="op" id="4721790">]</span>&nbsp;<span class="op" id="4721792">=</span>&nbsp;<span class="num" id="4721794">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4721803">copy</span><span class="op" id="4721807">(</span><span class="ident" id="4721808">em</span><span class="op" id="4721810">[</span><span class="ident" id="4721811">k</span><span class="op" id="4721812">-</span><span class="ident" id="4721813">tLen</span><span class="op" id="4721817">:</span><span class="ident" id="4721818">k</span><span class="op" id="4721819">-</span><span class="ident" id="4721820">hashLen</span><span class="op" id="4721827">]</span><span class="op" id="4721828">,</span>&nbsp;<span class="ident" id="4721830">prefix</span><span class="op" id="4721836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4721839">copy</span><span class="op" id="4721843">(</span><span class="ident" id="4721844">em</span><span class="op" id="4721846">[</span><span class="ident" id="4721847">k</span><span class="op" id="4721848">-</span><span class="ident" id="4721849">hashLen</span><span class="op" id="4721856">:</span><span class="ident" id="4721857">k</span><span class="op" id="4721858">]</span><span class="op" id="4721859">,</span>&nbsp;<span class="ident" id="4721861">hashed</span><span class="op" id="4721867">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721871">m</span>&nbsp;<span class="op" id="4721873">:=</span>&nbsp;<span class="builtinfunc" id="4721876">new</span><span class="op" id="4721879">(</span><span class="ident" id="4721880">big</span><span class="op" id="4721883">.</span><span class="ident" id="4721884">Int</span><span class="op" id="4721887">)</span><span class="op" id="4721888">.</span><span class="ident" id="4721889">SetBytes</span><span class="op" id="4721897">(</span><span class="ident" id="4721898">em</span><span class="op" id="4721900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721903">c</span><span class="op" id="4721904">,</span>&nbsp;<span class="ident" id="4721906">err</span>&nbsp;<span class="op" id="4721910">:=</span>&nbsp;<span class="ident" id="4721913">decrypt</span><span class="op" id="4721920">(</span><span class="ident" id="4721921">rand</span><span class="op" id="4721925">,</span>&nbsp;<span class="ident" id="4721927">priv</span><span class="op" id="4721931">,</span>&nbsp;<span class="ident" id="4721933">m</span><span class="op" id="4721934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721937">if</span>&nbsp;<span class="ident" id="4721940">err</span>&nbsp;<span class="op" id="4721944">!=</span>&nbsp;<span class="ident" id="4721947">nil</span>&nbsp;<span class="op" id="4721951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721955">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721963">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721967">copyWithLeftPad</span><span class="op" id="4721982">(</span><span class="ident" id="4721983">em</span><span class="op" id="4721985">,</span>&nbsp;<span class="ident" id="4721987">c</span><span class="op" id="4721988">.</span><span class="ident" id="4721989">Bytes</span><span class="op" id="4721994">(</span><span class="op" id="4721995">)</span><span class="op" id="4721996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721999">s</span>&nbsp;<span class="op" id="4722001">=</span>&nbsp;<span class="ident" id="4722003">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722007">return</span><br>
<span class="lineno"></span><span class="op" id="4722014">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4722017">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4722074">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4722148">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4722220">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4722297">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4722345">func</span>&nbsp;<span class="ident" id="4722350">VerifyPKCS1v15</span><span class="op" id="4722364">(</span><span class="ident" id="4722365">pub</span>&nbsp;<span class="op" id="4722369">*</span><span class="ident" id="4722370">PublicKey</span><span class="op" id="4722379">,</span>&nbsp;<span class="ident" id="4722381">hash</span>&nbsp;<span class="ident" id="4722386">crypto</span><span class="op" id="4722392">.</span><span class="ident" id="4722393">Hash</span><span class="op" id="4722397">,</span>&nbsp;<span class="ident" id="4722399">hashed</span>&nbsp;<span class="op" id="4722406">[</span><span class="op" id="4722407">]</span><span class="builtintype" id="4722408">byte</span><span class="op" id="4722412">,</span>&nbsp;<span class="ident" id="4722414">sig</span>&nbsp;<span class="op" id="4722418">[</span><span class="op" id="4722419">]</span><span class="builtintype" id="4722420">byte</span><span class="op" id="4722424">)</span>&nbsp;<span class="op" id="4722426">(</span><span class="ident" id="4722427">err</span>&nbsp;<span class="builtintype" id="4722431">error</span><span class="op" id="4722436">)</span>&nbsp;<span class="op" id="4722438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722441">hashLen</span><span class="op" id="4722448">,</span>&nbsp;<span class="ident" id="4722450">prefix</span><span class="op" id="4722456">,</span>&nbsp;<span class="ident" id="4722458">err</span>&nbsp;<span class="op" id="4722462">:=</span>&nbsp;<span class="ident" id="4722465">pkcs1v15HashInfo</span><span class="op" id="4722481">(</span><span class="ident" id="4722482">hash</span><span class="op" id="4722486">,</span>&nbsp;<span class="builtinfunc" id="4722488">len</span><span class="op" id="4722491">(</span><span class="ident" id="4722492">hashed</span><span class="op" id="4722498">)</span><span class="op" id="4722499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722502">if</span>&nbsp;<span class="ident" id="4722505">err</span>&nbsp;<span class="op" id="4722509">!=</span>&nbsp;<span class="ident" id="4722512">nil</span>&nbsp;<span class="op" id="4722516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722520">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722532">tLen</span>&nbsp;<span class="op" id="4722537">:=</span>&nbsp;<span class="builtinfunc" id="4722540">len</span><span class="op" id="4722543">(</span><span class="ident" id="4722544">prefix</span><span class="op" id="4722550">)</span>&nbsp;<span class="op" id="4722552">+</span>&nbsp;<span class="ident" id="4722554">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722563">k</span>&nbsp;<span class="op" id="4722565">:=</span>&nbsp;<span class="op" id="4722568">(</span><span class="ident" id="4722569">pub</span><span class="op" id="4722572">.</span><span class="ident" id="4722573">N</span><span class="op" id="4722574">.</span><span class="ident" id="4722575">BitLen</span><span class="op" id="4722581">(</span><span class="op" id="4722582">)</span>&nbsp;<span class="op" id="4722584">+</span>&nbsp;<span class="num" id="4722586">7</span><span class="op" id="4722587">)</span>&nbsp;<span class="op" id="4722589">/</span>&nbsp;<span class="num" id="4722591">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722594">if</span>&nbsp;<span class="ident" id="4722597">k</span>&nbsp;<span class="op" id="4722599">&lt;</span>&nbsp;<span class="ident" id="4722601">tLen</span><span class="op" id="4722605">+</span><span class="num" id="4722606">11</span>&nbsp;<span class="op" id="4722609">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722613">err</span>&nbsp;<span class="op" id="4722617">=</span>&nbsp;<span class="ident" id="4722619">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722637">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722649">c</span>&nbsp;<span class="op" id="4722651">:=</span>&nbsp;<span class="builtinfunc" id="4722654">new</span><span class="op" id="4722657">(</span><span class="ident" id="4722658">big</span><span class="op" id="4722661">.</span><span class="ident" id="4722662">Int</span><span class="op" id="4722665">)</span><span class="op" id="4722666">.</span><span class="ident" id="4722667">SetBytes</span><span class="op" id="4722675">(</span><span class="ident" id="4722676">sig</span><span class="op" id="4722679">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722682">m</span>&nbsp;<span class="op" id="4722684">:=</span>&nbsp;<span class="ident" id="4722687">encrypt</span><span class="op" id="4722694">(</span><span class="builtinfunc" id="4722695">new</span><span class="op" id="4722698">(</span><span class="ident" id="4722699">big</span><span class="op" id="4722702">.</span><span class="ident" id="4722703">Int</span><span class="op" id="4722706">)</span><span class="op" id="4722707">,</span>&nbsp;<span class="ident" id="4722709">pub</span><span class="op" id="4722712">,</span>&nbsp;<span class="ident" id="4722714">c</span><span class="op" id="4722715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722718">em</span>&nbsp;<span class="op" id="4722721">:=</span>&nbsp;<span class="ident" id="4722724">leftPad</span><span class="op" id="4722731">(</span><span class="ident" id="4722732">m</span><span class="op" id="4722733">.</span><span class="ident" id="4722734">Bytes</span><span class="op" id="4722739">(</span><span class="op" id="4722740">)</span><span class="op" id="4722741">,</span>&nbsp;<span class="ident" id="4722743">k</span><span class="op" id="4722744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722747">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722789">ok</span>&nbsp;<span class="op" id="4722792">:=</span>&nbsp;<span class="ident" id="4722795">subtle</span><span class="op" id="4722801">.</span><span class="ident" id="4722802">ConstantTimeByteEq</span><span class="op" id="4722820">(</span><span class="ident" id="4722821">em</span><span class="op" id="4722823">[</span><span class="num" id="4722824">0</span><span class="op" id="4722825">]</span><span class="op" id="4722826">,</span>&nbsp;<span class="num" id="4722828">0</span><span class="op" id="4722829">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722832">ok</span>&nbsp;<span class="op" id="4722835">&amp;=</span>&nbsp;<span class="ident" id="4722838">subtle</span><span class="op" id="4722844">.</span><span class="ident" id="4722845">ConstantTimeByteEq</span><span class="op" id="4722863">(</span><span class="ident" id="4722864">em</span><span class="op" id="4722866">[</span><span class="num" id="4722867">1</span><span class="op" id="4722868">]</span><span class="op" id="4722869">,</span>&nbsp;<span class="num" id="4722871">1</span><span class="op" id="4722872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722875">ok</span>&nbsp;<span class="op" id="4722878">&amp;=</span>&nbsp;<span class="ident" id="4722881">subtle</span><span class="op" id="4722887">.</span><span class="ident" id="4722888">ConstantTimeCompare</span><span class="op" id="4722907">(</span><span class="ident" id="4722908">em</span><span class="op" id="4722910">[</span><span class="ident" id="4722911">k</span><span class="op" id="4722912">-</span><span class="ident" id="4722913">hashLen</span><span class="op" id="4722920">:</span><span class="ident" id="4722921">k</span><span class="op" id="4722922">]</span><span class="op" id="4722923">,</span>&nbsp;<span class="ident" id="4722925">hashed</span><span class="op" id="4722931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722934">ok</span>&nbsp;<span class="op" id="4722937">&amp;=</span>&nbsp;<span class="ident" id="4722940">subtle</span><span class="op" id="4722946">.</span><span class="ident" id="4722947">ConstantTimeCompare</span><span class="op" id="4722966">(</span><span class="ident" id="4722967">em</span><span class="op" id="4722969">[</span><span class="ident" id="4722970">k</span><span class="op" id="4722971">-</span><span class="ident" id="4722972">tLen</span><span class="op" id="4722976">:</span><span class="ident" id="4722977">k</span><span class="op" id="4722978">-</span><span class="ident" id="4722979">hashLen</span><span class="op" id="4722986">]</span><span class="op" id="4722987">,</span>&nbsp;<span class="ident" id="4722989">prefix</span><span class="op" id="4722995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722998">ok</span>&nbsp;<span class="op" id="4723001">&amp;=</span>&nbsp;<span class="ident" id="4723004">subtle</span><span class="op" id="4723010">.</span><span class="ident" id="4723011">ConstantTimeByteEq</span><span class="op" id="4723029">(</span><span class="ident" id="4723030">em</span><span class="op" id="4723032">[</span><span class="ident" id="4723033">k</span><span class="op" id="4723034">-</span><span class="ident" id="4723035">tLen</span><span class="op" id="4723039">-</span><span class="num" id="4723040">1</span><span class="op" id="4723041">]</span><span class="op" id="4723042">,</span>&nbsp;<span class="num" id="4723044">0</span><span class="op" id="4723045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723049">for</span>&nbsp;<span class="ident" id="4723053">i</span>&nbsp;<span class="op" id="4723055">:=</span>&nbsp;<span class="num" id="4723058">2</span><span class="op" id="4723059">;</span>&nbsp;<span class="ident" id="4723061">i</span>&nbsp;<span class="op" id="4723063">&lt;</span>&nbsp;<span class="ident" id="4723065">k</span><span class="op" id="4723066">-</span><span class="ident" id="4723067">tLen</span><span class="op" id="4723071">-</span><span class="num" id="4723072">1</span><span class="op" id="4723073">;</span>&nbsp;<span class="ident" id="4723075">i</span><span class="op" id="4723076">++</span>&nbsp;<span class="op" id="4723079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723083">ok</span>&nbsp;<span class="op" id="4723086">&amp;=</span>&nbsp;<span class="ident" id="4723089">subtle</span><span class="op" id="4723095">.</span><span class="ident" id="4723096">ConstantTimeByteEq</span><span class="op" id="4723114">(</span><span class="ident" id="4723115">em</span><span class="op" id="4723117">[</span><span class="ident" id="4723118">i</span><span class="op" id="4723119">]</span><span class="op" id="4723120">,</span>&nbsp;<span class="num" id="4723122">0xff</span><span class="op" id="4723126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723133">if</span>&nbsp;<span class="ident" id="4723136">ok</span>&nbsp;<span class="op" id="4723139">!=</span>&nbsp;<span class="num" id="4723142">1</span>&nbsp;<span class="op" id="4723144">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723148">return</span>&nbsp;<span class="ident" id="4723155">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723176">return</span>&nbsp;<span class="ident" id="4723183">nil</span><br>
<span class="lineno"></span><span class="op" id="4723187">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4723190">func</span>&nbsp;<span class="ident" id="4723195">pkcs1v15HashInfo</span><span class="op" id="4723211">(</span><span class="ident" id="4723212">hash</span>&nbsp;<span class="ident" id="4723217">crypto</span><span class="op" id="4723223">.</span><span class="ident" id="4723224">Hash</span><span class="op" id="4723228">,</span>&nbsp;<span class="ident" id="4723230">inLen</span>&nbsp;<span class="builtintype" id="4723236">int</span><span class="op" id="4723239">)</span>&nbsp;<span class="op" id="4723241">(</span><span class="ident" id="4723242">hashLen</span>&nbsp;<span class="builtintype" id="4723250">int</span><span class="op" id="4723253">,</span>&nbsp;<span class="ident" id="4723255">prefix</span>&nbsp;<span class="op" id="4723262">[</span><span class="op" id="4723263">]</span><span class="builtintype" id="4723264">byte</span><span class="op" id="4723268">,</span>&nbsp;<span class="ident" id="4723270">err</span>&nbsp;<span class="builtintype" id="4723274">error</span><span class="op" id="4723279">)</span>&nbsp;<span class="op" id="4723281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723284">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723354">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723375">if</span>&nbsp;<span class="ident" id="4723378">hash</span>&nbsp;<span class="op" id="4723383">==</span>&nbsp;<span class="num" id="4723386">0</span>&nbsp;<span class="op" id="4723388">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723392">return</span>&nbsp;<span class="ident" id="4723399">inLen</span><span class="op" id="4723404">,</span>&nbsp;<span class="ident" id="4723406">nil</span><span class="op" id="4723409">,</span>&nbsp;<span class="ident" id="4723411">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723420">hashLen</span>&nbsp;<span class="op" id="4723428">=</span>&nbsp;<span class="ident" id="4723430">hash</span><span class="op" id="4723434">.</span><span class="ident" id="4723435">Size</span><span class="op" id="4723439">(</span><span class="op" id="4723440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723443">if</span>&nbsp;<span class="ident" id="4723446">inLen</span>&nbsp;<span class="op" id="4723452">!=</span>&nbsp;<span class="ident" id="4723455">hashLen</span>&nbsp;<span class="op" id="4723463">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723467">return</span>&nbsp;<span class="num" id="4723474">0</span><span class="op" id="4723475">,</span>&nbsp;<span class="ident" id="4723477">nil</span><span class="op" id="4723480">,</span>&nbsp;<span class="ident" id="4723482">errors</span><span class="op" id="4723488">.</span><span class="ident" id="4723489">New</span><span class="op" id="4723492">(</span><span class="string" id="4723493">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4723535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723541">prefix</span><span class="op" id="4723547">,</span>&nbsp;<span class="ident" id="4723549">ok</span>&nbsp;<span class="op" id="4723552">:=</span>&nbsp;<span class="ident" id="4723555">hashPrefixes</span><span class="op" id="4723567">[</span><span class="ident" id="4723568">hash</span><span class="op" id="4723572">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723575">if</span>&nbsp;<span class="op" id="4723578">!</span><span class="ident" id="4723579">ok</span>&nbsp;<span class="op" id="4723582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723586">return</span>&nbsp;<span class="num" id="4723593">0</span><span class="op" id="4723594">,</span>&nbsp;<span class="ident" id="4723596">nil</span><span class="op" id="4723599">,</span>&nbsp;<span class="ident" id="4723601">errors</span><span class="op" id="4723607">.</span><span class="ident" id="4723608">New</span><span class="op" id="4723611">(</span><span class="string" id="4723612">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4723651">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723657">return</span><br>
<span class="lineno"></span><span class="op" id="4723664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4723667">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4723744">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4723755">func</span>&nbsp;<span class="ident" id="4723760">copyWithLeftPad</span><span class="op" id="4723775">(</span><span class="ident" id="4723776">dest</span><span class="op" id="4723780">,</span>&nbsp;<span class="ident" id="4723782">src</span>&nbsp;<span class="op" id="4723786">[</span><span class="op" id="4723787">]</span><span class="builtintype" id="4723788">byte</span><span class="op" id="4723792">)</span>&nbsp;<span class="op" id="4723794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723797">numPaddingBytes</span>&nbsp;<span class="op" id="4723813">:=</span>&nbsp;<span class="builtinfunc" id="4723816">len</span><span class="op" id="4723819">(</span><span class="ident" id="4723820">dest</span><span class="op" id="4723824">)</span>&nbsp;<span class="op" id="4723826">-</span>&nbsp;<span class="builtinfunc" id="4723828">len</span><span class="op" id="4723831">(</span><span class="ident" id="4723832">src</span><span class="op" id="4723835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723838">for</span>&nbsp;<span class="ident" id="4723842">i</span>&nbsp;<span class="op" id="4723844">:=</span>&nbsp;<span class="num" id="4723847">0</span><span class="op" id="4723848">;</span>&nbsp;<span class="ident" id="4723850">i</span>&nbsp;<span class="op" id="4723852">&lt;</span>&nbsp;<span class="ident" id="4723854">numPaddingBytes</span><span class="op" id="4723869">;</span>&nbsp;<span class="ident" id="4723871">i</span><span class="op" id="4723872">++</span>&nbsp;<span class="op" id="4723875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723879">dest</span><span class="op" id="4723883">[</span><span class="ident" id="4723884">i</span><span class="op" id="4723885">]</span>&nbsp;<span class="op" id="4723887">=</span>&nbsp;<span class="num" id="4723889">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4723895">copy</span><span class="op" id="4723899">(</span><span class="ident" id="4723900">dest</span><span class="op" id="4723904">[</span><span class="ident" id="4723905">numPaddingBytes</span><span class="op" id="4723920">:</span><span class="op" id="4723921">]</span><span class="op" id="4723922">,</span>&nbsp;<span class="ident" id="4723924">src</span><span class="op" id="4723927">)</span><br>
<span class="lineno"></span><span class="op" id="4723929">}</span>
</div>
</body>
</html>
