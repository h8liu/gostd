<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html" class="current">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7720846">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7720901">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7720955">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7721006">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7721071">package</span>&nbsp;<span class="ident" id="7721079">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7721087">import</span>&nbsp;<span class="op" id="7721094">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721097">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721105">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721118">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721124">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721135">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721146">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721157">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721168">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7721179">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7721186">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7721189">func</span>&nbsp;<span class="ident" id="7721194">waitSig</span><span class="op" id="7721201">(</span><span class="ident" id="7721202">t</span>&nbsp;<span class="op" id="7721204">*</span><span class="ident" id="7721205">testing</span><span class="op" id="7721212">.</span><span class="ident" id="7721213">T</span><span class="op" id="7721214">,</span>&nbsp;<span class="ident" id="7721216">c</span>&nbsp;<span class="op" id="7721218">&lt;-</span><span class="keyword" id="7721220">chan</span>&nbsp;<span class="ident" id="7721225">os</span><span class="op" id="7721227">.</span><span class="ident" id="7721228">Signal</span><span class="op" id="7721234">,</span>&nbsp;<span class="ident" id="7721236">sig</span>&nbsp;<span class="ident" id="7721240">os</span><span class="op" id="7721242">.</span><span class="ident" id="7721243">Signal</span><span class="op" id="7721249">)</span>&nbsp;<span class="op" id="7721251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7721254">select</span>&nbsp;<span class="op" id="7721261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7721264">case</span>&nbsp;<span class="ident" id="7721269">s</span>&nbsp;<span class="op" id="7721271">:=</span>&nbsp;<span class="op" id="7721274">&lt;-</span><span class="ident" id="7721276">c</span><span class="op" id="7721277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7721281">if</span>&nbsp;<span class="ident" id="7721284">s</span>&nbsp;<span class="op" id="7721286">!=</span>&nbsp;<span class="ident" id="7721289">sig</span>&nbsp;<span class="op" id="7721293">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721298">t</span><span class="op" id="7721299">.</span><span class="ident" id="7721300">Fatalf</span><span class="op" id="7721306">(</span><span class="string" id="7721307">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7721331">,</span>&nbsp;<span class="ident" id="7721333">s</span><span class="op" id="7721334">,</span>&nbsp;<span class="ident" id="7721336">sig</span><span class="op" id="7721339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7721343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7721346">case</span>&nbsp;<span class="op" id="7721351">&lt;-</span><span class="ident" id="7721353">time</span><span class="op" id="7721357">.</span><span class="ident" id="7721358">After</span><span class="op" id="7721363">(</span><span class="num" id="7721364">1</span>&nbsp;<span class="op" id="7721366">*</span>&nbsp;<span class="ident" id="7721368">time</span><span class="op" id="7721372">.</span><span class="ident" id="7721373">Second</span><span class="op" id="7721379">)</span><span class="op" id="7721380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721384">t</span><span class="op" id="7721385">.</span><span class="ident" id="7721386">Fatalf</span><span class="op" id="7721392">(</span><span class="string" id="7721393">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7721417">,</span>&nbsp;<span class="ident" id="7721419">sig</span><span class="op" id="7721422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7721425">}</span><br>
<span class="lineno">30</span><span class="op" id="7721427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7721430">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7721472">func</span>&nbsp;<span class="ident" id="7721477">TestSignal</span><span class="op" id="7721487">(</span><span class="ident" id="7721488">t</span>&nbsp;<span class="op" id="7721490">*</span><span class="ident" id="7721491">testing</span><span class="op" id="7721498">.</span><span class="ident" id="7721499">T</span><span class="op" id="7721500">)</span>&nbsp;<span class="op" id="7721502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7721505">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721524">c</span>&nbsp;<span class="op" id="7721526">:=</span>&nbsp;<span class="builtinfunc" id="7721529">make</span><span class="op" id="7721533">(</span><span class="keyword" id="7721534">chan</span>&nbsp;<span class="ident" id="7721539">os</span><span class="op" id="7721541">.</span><span class="ident" id="7721542">Signal</span><span class="op" id="7721548">,</span>&nbsp;<span class="num" id="7721550">1</span><span class="op" id="7721551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721554">Notify</span><span class="op" id="7721560">(</span><span class="ident" id="7721561">c</span><span class="op" id="7721562">,</span>&nbsp;<span class="ident" id="7721564">syscall</span><span class="op" id="7721571">.</span><span class="ident" id="7721572">SIGHUP</span><span class="op" id="7721578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7721581">defer</span>&nbsp;<span class="ident" id="7721587">Stop</span><span class="op" id="7721591">(</span><span class="ident" id="7721592">c</span><span class="op" id="7721593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7721597">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721628">t</span><span class="op" id="7721629">.</span><span class="ident" id="7721630">Logf</span><span class="op" id="7721634">(</span><span class="string" id="7721635">&#34;sighup...&#34;</span><span class="op" id="7721646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721649">syscall</span><span class="op" id="7721656">.</span><span class="ident" id="7721657">Kill</span><span class="op" id="7721661">(</span><span class="ident" id="7721662">syscall</span><span class="op" id="7721669">.</span><span class="ident" id="7721670">Getpid</span><span class="op" id="7721676">(</span><span class="op" id="7721677">)</span><span class="op" id="7721678">,</span>&nbsp;<span class="ident" id="7721680">syscall</span><span class="op" id="7721687">.</span><span class="ident" id="7721688">SIGHUP</span><span class="op" id="7721694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721697">waitSig</span><span class="op" id="7721704">(</span><span class="ident" id="7721705">t</span><span class="op" id="7721706">,</span>&nbsp;<span class="ident" id="7721708">c</span><span class="op" id="7721709">,</span>&nbsp;<span class="ident" id="7721711">syscall</span><span class="op" id="7721718">.</span><span class="ident" id="7721719">SIGHUP</span><span class="op" id="7721725">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7721729">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721764">c1</span>&nbsp;<span class="op" id="7721767">:=</span>&nbsp;<span class="builtinfunc" id="7721770">make</span><span class="op" id="7721774">(</span><span class="keyword" id="7721775">chan</span>&nbsp;<span class="ident" id="7721780">os</span><span class="op" id="7721782">.</span><span class="ident" id="7721783">Signal</span><span class="op" id="7721789">,</span>&nbsp;<span class="num" id="7721791">1</span><span class="op" id="7721792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721795">Notify</span><span class="op" id="7721801">(</span><span class="ident" id="7721802">c1</span><span class="op" id="7721804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7721808">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721841">t</span><span class="op" id="7721842">.</span><span class="ident" id="7721843">Logf</span><span class="op" id="7721847">(</span><span class="string" id="7721848">&#34;sigwinch...&#34;</span><span class="op" id="7721861">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721864">syscall</span><span class="op" id="7721871">.</span><span class="ident" id="7721872">Kill</span><span class="op" id="7721876">(</span><span class="ident" id="7721877">syscall</span><span class="op" id="7721884">.</span><span class="ident" id="7721885">Getpid</span><span class="op" id="7721891">(</span><span class="op" id="7721892">)</span><span class="op" id="7721893">,</span>&nbsp;<span class="ident" id="7721895">syscall</span><span class="op" id="7721902">.</span><span class="ident" id="7721903">SIGWINCH</span><span class="op" id="7721911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7721914">waitSig</span><span class="op" id="7721921">(</span><span class="ident" id="7721922">t</span><span class="op" id="7721923">,</span>&nbsp;<span class="ident" id="7721925">c1</span><span class="op" id="7721927">,</span>&nbsp;<span class="ident" id="7721929">syscall</span><span class="op" id="7721936">.</span><span class="ident" id="7721937">SIGWINCH</span><span class="op" id="7721945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7721949">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7721994">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7722044">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722082">t</span><span class="op" id="7722083">.</span><span class="ident" id="7722084">Logf</span><span class="op" id="7722088">(</span><span class="string" id="7722089">&#34;sighup...&#34;</span><span class="op" id="7722100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722103">syscall</span><span class="op" id="7722110">.</span><span class="ident" id="7722111">Kill</span><span class="op" id="7722115">(</span><span class="ident" id="7722116">syscall</span><span class="op" id="7722123">.</span><span class="ident" id="7722124">Getpid</span><span class="op" id="7722130">(</span><span class="op" id="7722131">)</span><span class="op" id="7722132">,</span>&nbsp;<span class="ident" id="7722134">syscall</span><span class="op" id="7722141">.</span><span class="ident" id="7722142">SIGHUP</span><span class="op" id="7722148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722151">waitSig</span><span class="op" id="7722158">(</span><span class="ident" id="7722159">t</span><span class="op" id="7722160">,</span>&nbsp;<span class="ident" id="7722162">c1</span><span class="op" id="7722164">,</span>&nbsp;<span class="ident" id="7722166">syscall</span><span class="op" id="7722173">.</span><span class="ident" id="7722174">SIGHUP</span><span class="op" id="7722180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722183">t</span><span class="op" id="7722184">.</span><span class="ident" id="7722185">Logf</span><span class="op" id="7722189">(</span><span class="string" id="7722190">&#34;sighup...&#34;</span><span class="op" id="7722201">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722204">syscall</span><span class="op" id="7722211">.</span><span class="ident" id="7722212">Kill</span><span class="op" id="7722216">(</span><span class="ident" id="7722217">syscall</span><span class="op" id="7722224">.</span><span class="ident" id="7722225">Getpid</span><span class="op" id="7722231">(</span><span class="op" id="7722232">)</span><span class="op" id="7722233">,</span>&nbsp;<span class="ident" id="7722235">syscall</span><span class="op" id="7722242">.</span><span class="ident" id="7722243">SIGHUP</span><span class="op" id="7722249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722252">waitSig</span><span class="op" id="7722259">(</span><span class="ident" id="7722260">t</span><span class="op" id="7722261">,</span>&nbsp;<span class="ident" id="7722263">c1</span><span class="op" id="7722265">,</span>&nbsp;<span class="ident" id="7722267">syscall</span><span class="op" id="7722274">.</span><span class="ident" id="7722275">SIGHUP</span><span class="op" id="7722281">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7722285">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722337">waitSig</span><span class="op" id="7722344">(</span><span class="ident" id="7722345">t</span><span class="op" id="7722346">,</span>&nbsp;<span class="ident" id="7722348">c</span><span class="op" id="7722349">,</span>&nbsp;<span class="ident" id="7722351">syscall</span><span class="op" id="7722358">.</span><span class="ident" id="7722359">SIGHUP</span><span class="op" id="7722365">)</span><br>
<span class="lineno">65</span><span class="op" id="7722367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7722370">func</span>&nbsp;<span class="ident" id="7722375">TestStress</span><span class="op" id="7722385">(</span><span class="ident" id="7722386">t</span>&nbsp;<span class="op" id="7722388">*</span><span class="ident" id="7722389">testing</span><span class="op" id="7722396">.</span><span class="ident" id="7722397">T</span><span class="op" id="7722398">)</span>&nbsp;<span class="op" id="7722400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722403">dur</span>&nbsp;<span class="op" id="7722407">:=</span>&nbsp;<span class="num" id="7722410">3</span>&nbsp;<span class="op" id="7722412">*</span>&nbsp;<span class="ident" id="7722414">time</span><span class="op" id="7722418">.</span><span class="ident" id="7722419">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722427">if</span>&nbsp;<span class="ident" id="7722430">testing</span><span class="op" id="7722437">.</span><span class="ident" id="7722438">Short</span><span class="op" id="7722443">(</span><span class="op" id="7722444">)</span>&nbsp;<span class="op" id="7722446">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722450">dur</span>&nbsp;<span class="op" id="7722454">=</span>&nbsp;<span class="num" id="7722456">100</span>&nbsp;<span class="op" id="7722460">*</span>&nbsp;<span class="ident" id="7722462">time</span><span class="op" id="7722466">.</span><span class="ident" id="7722467">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722483">defer</span>&nbsp;<span class="ident" id="7722489">runtime</span><span class="op" id="7722496">.</span><span class="ident" id="7722497">GOMAXPROCS</span><span class="op" id="7722507">(</span><span class="ident" id="7722508">runtime</span><span class="op" id="7722515">.</span><span class="ident" id="7722516">GOMAXPROCS</span><span class="op" id="7722526">(</span><span class="num" id="7722527">4</span><span class="op" id="7722528">)</span><span class="op" id="7722529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722532">done</span>&nbsp;<span class="op" id="7722537">:=</span>&nbsp;<span class="builtinfunc" id="7722540">make</span><span class="op" id="7722544">(</span><span class="keyword" id="7722545">chan</span>&nbsp;<span class="builtintype" id="7722550">bool</span><span class="op" id="7722554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722557">finished</span>&nbsp;<span class="op" id="7722566">:=</span>&nbsp;<span class="builtinfunc" id="7722569">make</span><span class="op" id="7722573">(</span><span class="keyword" id="7722574">chan</span>&nbsp;<span class="builtintype" id="7722579">bool</span><span class="op" id="7722583">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722586">go</span>&nbsp;<span class="keyword" id="7722589">func</span><span class="op" id="7722593">(</span><span class="op" id="7722594">)</span>&nbsp;<span class="op" id="7722596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722600">sig</span>&nbsp;<span class="op" id="7722604">:=</span>&nbsp;<span class="builtinfunc" id="7722607">make</span><span class="op" id="7722611">(</span><span class="keyword" id="7722612">chan</span>&nbsp;<span class="ident" id="7722617">os</span><span class="op" id="7722619">.</span><span class="ident" id="7722620">Signal</span><span class="op" id="7722626">,</span>&nbsp;<span class="num" id="7722628">1</span><span class="op" id="7722629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722633">Notify</span><span class="op" id="7722639">(</span><span class="ident" id="7722640">sig</span><span class="op" id="7722643">,</span>&nbsp;<span class="ident" id="7722645">syscall</span><span class="op" id="7722652">.</span><span class="ident" id="7722653">SIGUSR1</span><span class="op" id="7722660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722664">defer</span>&nbsp;<span class="ident" id="7722670">Stop</span><span class="op" id="7722674">(</span><span class="ident" id="7722675">sig</span><span class="op" id="7722678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722681">Loop</span><span class="op" id="7722685">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722689">for</span>&nbsp;<span class="op" id="7722693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722698">select</span>&nbsp;<span class="op" id="7722705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722710">case</span>&nbsp;<span class="op" id="7722715">&lt;-</span><span class="ident" id="7722717">sig</span><span class="op" id="7722720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722725">case</span>&nbsp;<span class="op" id="7722730">&lt;-</span><span class="ident" id="7722732">done</span><span class="op" id="7722736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722742">break</span>&nbsp;<span class="ident" id="7722748">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722764">finished</span>&nbsp;<span class="op" id="7722773">&lt;-</span>&nbsp;<span class="builtintype" id="7722776">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722782">}</span><span class="op" id="7722783">(</span><span class="op" id="7722784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722787">go</span>&nbsp;<span class="keyword" id="7722790">func</span><span class="op" id="7722794">(</span><span class="op" id="7722795">)</span>&nbsp;<span class="op" id="7722797">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722800">Loop</span><span class="op" id="7722804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722808">for</span>&nbsp;<span class="op" id="7722812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722817">select</span>&nbsp;<span class="op" id="7722824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722829">case</span>&nbsp;<span class="op" id="7722834">&lt;-</span><span class="ident" id="7722836">done</span><span class="op" id="7722840">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722846">break</span>&nbsp;<span class="ident" id="7722852">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7722860">default</span><span class="op" id="7722867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722873">syscall</span><span class="op" id="7722880">.</span><span class="ident" id="7722881">Kill</span><span class="op" id="7722885">(</span><span class="ident" id="7722886">syscall</span><span class="op" id="7722893">.</span><span class="ident" id="7722894">Getpid</span><span class="op" id="7722900">(</span><span class="op" id="7722901">)</span><span class="op" id="7722902">,</span>&nbsp;<span class="ident" id="7722904">syscall</span><span class="op" id="7722911">.</span><span class="ident" id="7722912">SIGUSR1</span><span class="op" id="7722919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722925">runtime</span><span class="op" id="7722932">.</span><span class="ident" id="7722933">Gosched</span><span class="op" id="7722940">(</span><span class="op" id="7722941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722950">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722954">finished</span>&nbsp;<span class="op" id="7722963">&lt;-</span>&nbsp;<span class="builtintype" id="7722966">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7722972">}</span><span class="op" id="7722973">(</span><span class="op" id="7722974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7722977">time</span><span class="op" id="7722981">.</span><span class="ident" id="7722982">Sleep</span><span class="op" id="7722987">(</span><span class="ident" id="7722988">dur</span><span class="op" id="7722991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7722994">close</span><span class="op" id="7722999">(</span><span class="ident" id="7723000">done</span><span class="op" id="7723004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7723007">&lt;-</span><span class="ident" id="7723009">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7723019">&lt;-</span><span class="ident" id="7723021">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723031">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723102">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723152">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723216">time</span><span class="op" id="7723220">.</span><span class="ident" id="7723221">Sleep</span><span class="op" id="7723226">(</span><span class="num" id="7723227">10</span>&nbsp;<span class="op" id="7723230">*</span>&nbsp;<span class="ident" id="7723232">time</span><span class="op" id="7723236">.</span><span class="ident" id="7723237">Millisecond</span><span class="op" id="7723248">)</span><br>
<span class="lineno">110</span><span class="op" id="7723250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7723253">var</span>&nbsp;<span class="ident" id="7723257">sendUncaughtSighup</span>&nbsp;<span class="op" id="7723276">=</span>&nbsp;<span class="ident" id="7723278">flag</span><span class="op" id="7723282">.</span><span class="ident" id="7723283">Int</span><span class="op" id="7723286">(</span><span class="string" id="7723287">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7723309">,</span>&nbsp;<span class="num" id="7723311">0</span><span class="op" id="7723312">,</span>&nbsp;<span class="string" id="7723314">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7723352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7723355">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7723410">func</span>&nbsp;<span class="ident" id="7723415">TestStop</span><span class="op" id="7723423">(</span><span class="ident" id="7723424">t</span>&nbsp;<span class="op" id="7723426">*</span><span class="ident" id="7723427">testing</span><span class="op" id="7723434">.</span><span class="ident" id="7723435">T</span><span class="op" id="7723436">)</span>&nbsp;<span class="op" id="7723438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723441">sigs</span>&nbsp;<span class="op" id="7723446">:=</span>&nbsp;<span class="op" id="7723449">[</span><span class="op" id="7723450">]</span><span class="ident" id="7723451">syscall</span><span class="op" id="7723458">.</span><span class="ident" id="7723459">Signal</span><span class="op" id="7723465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723469">syscall</span><span class="op" id="7723476">.</span><span class="ident" id="7723477">SIGWINCH</span><span class="op" id="7723485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723489">syscall</span><span class="op" id="7723496">.</span><span class="ident" id="7723497">SIGHUP</span><span class="op" id="7723503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7723506">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7723510">for</span>&nbsp;<span class="ident" id="7723514">_</span><span class="op" id="7723515">,</span>&nbsp;<span class="ident" id="7723517">sig</span>&nbsp;<span class="op" id="7723521">:=</span>&nbsp;<span class="keyword" id="7723524">range</span>&nbsp;<span class="ident" id="7723530">sigs</span>&nbsp;<span class="op" id="7723535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723539">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723561">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723606">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7723677">if</span>&nbsp;<span class="ident" id="7723680">sig</span>&nbsp;<span class="op" id="7723684">!=</span>&nbsp;<span class="ident" id="7723687">syscall</span><span class="op" id="7723694">.</span><span class="ident" id="7723695">SIGHUP</span>&nbsp;<span class="op" id="7723702">||</span>&nbsp;<span class="op" id="7723705">*</span><span class="ident" id="7723706">sendUncaughtSighup</span>&nbsp;<span class="op" id="7723725">==</span>&nbsp;<span class="num" id="7723728">1</span>&nbsp;<span class="op" id="7723730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723735">syscall</span><span class="op" id="7723742">.</span><span class="ident" id="7723743">Kill</span><span class="op" id="7723747">(</span><span class="ident" id="7723748">syscall</span><span class="op" id="7723755">.</span><span class="ident" id="7723756">Getpid</span><span class="op" id="7723762">(</span><span class="op" id="7723763">)</span><span class="op" id="7723764">,</span>&nbsp;<span class="ident" id="7723766">sig</span><span class="op" id="7723769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7723773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723777">time</span><span class="op" id="7723781">.</span><span class="ident" id="7723782">Sleep</span><span class="op" id="7723787">(</span><span class="num" id="7723788">100</span>&nbsp;<span class="op" id="7723792">*</span>&nbsp;<span class="ident" id="7723794">time</span><span class="op" id="7723798">.</span><span class="ident" id="7723799">Millisecond</span><span class="op" id="7723810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723815">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723835">c</span>&nbsp;<span class="op" id="7723837">:=</span>&nbsp;<span class="builtinfunc" id="7723840">make</span><span class="op" id="7723844">(</span><span class="keyword" id="7723845">chan</span>&nbsp;<span class="ident" id="7723850">os</span><span class="op" id="7723852">.</span><span class="ident" id="7723853">Signal</span><span class="op" id="7723859">,</span>&nbsp;<span class="num" id="7723861">1</span><span class="op" id="7723862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723866">Notify</span><span class="op" id="7723872">(</span><span class="ident" id="7723873">c</span><span class="op" id="7723874">,</span>&nbsp;<span class="ident" id="7723876">sig</span><span class="op" id="7723879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7723883">defer</span>&nbsp;<span class="ident" id="7723889">Stop</span><span class="op" id="7723893">(</span><span class="ident" id="7723894">c</span><span class="op" id="7723895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7723900">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723935">syscall</span><span class="op" id="7723942">.</span><span class="ident" id="7723943">Kill</span><span class="op" id="7723947">(</span><span class="ident" id="7723948">syscall</span><span class="op" id="7723955">.</span><span class="ident" id="7723956">Getpid</span><span class="op" id="7723962">(</span><span class="op" id="7723963">)</span><span class="op" id="7723964">,</span>&nbsp;<span class="ident" id="7723966">sig</span><span class="op" id="7723969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723973">waitSig</span><span class="op" id="7723980">(</span><span class="ident" id="7723981">t</span><span class="op" id="7723982">,</span>&nbsp;<span class="ident" id="7723984">c</span><span class="op" id="7723985">,</span>&nbsp;<span class="ident" id="7723987">sig</span><span class="op" id="7723990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7723995">Stop</span><span class="op" id="7723999">(</span><span class="ident" id="7724000">c</span><span class="op" id="7724001">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724005">select</span>&nbsp;<span class="op" id="7724012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724016">case</span>&nbsp;<span class="ident" id="7724021">s</span>&nbsp;<span class="op" id="7724023">:=</span>&nbsp;<span class="op" id="7724026">&lt;-</span><span class="ident" id="7724028">c</span><span class="op" id="7724029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7724034">t</span><span class="op" id="7724035">.</span><span class="ident" id="7724036">Fatalf</span><span class="op" id="7724042">(</span><span class="string" id="7724043">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7724065">,</span>&nbsp;<span class="ident" id="7724067">s</span><span class="op" id="7724068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724072">case</span>&nbsp;<span class="op" id="7724077">&lt;-</span><span class="ident" id="7724079">time</span><span class="op" id="7724083">.</span><span class="ident" id="7724084">After</span><span class="op" id="7724089">(</span><span class="num" id="7724090">100</span>&nbsp;<span class="op" id="7724094">*</span>&nbsp;<span class="ident" id="7724096">time</span><span class="op" id="7724100">.</span><span class="ident" id="7724101">Millisecond</span><span class="op" id="7724112">)</span><span class="op" id="7724113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724118">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7724146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724151">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724173">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724218">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724289">if</span>&nbsp;<span class="ident" id="7724292">sig</span>&nbsp;<span class="op" id="7724296">!=</span>&nbsp;<span class="ident" id="7724299">syscall</span><span class="op" id="7724306">.</span><span class="ident" id="7724307">SIGHUP</span>&nbsp;<span class="op" id="7724314">||</span>&nbsp;<span class="op" id="7724317">*</span><span class="ident" id="7724318">sendUncaughtSighup</span>&nbsp;<span class="op" id="7724337">==</span>&nbsp;<span class="num" id="7724340">2</span>&nbsp;<span class="op" id="7724342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7724347">syscall</span><span class="op" id="7724354">.</span><span class="ident" id="7724355">Kill</span><span class="op" id="7724359">(</span><span class="ident" id="7724360">syscall</span><span class="op" id="7724367">.</span><span class="ident" id="7724368">Getpid</span><span class="op" id="7724374">(</span><span class="op" id="7724375">)</span><span class="op" id="7724376">,</span>&nbsp;<span class="ident" id="7724378">sig</span><span class="op" id="7724381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7724385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724390">select</span>&nbsp;<span class="op" id="7724397">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724401">case</span>&nbsp;<span class="ident" id="7724406">s</span>&nbsp;<span class="op" id="7724408">:=</span>&nbsp;<span class="op" id="7724411">&lt;-</span><span class="ident" id="7724413">c</span><span class="op" id="7724414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7724419">t</span><span class="op" id="7724420">.</span><span class="ident" id="7724421">Fatalf</span><span class="op" id="7724427">(</span><span class="string" id="7724428">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7724450">,</span>&nbsp;<span class="ident" id="7724452">s</span><span class="op" id="7724453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7724457">case</span>&nbsp;<span class="op" id="7724462">&lt;-</span><span class="ident" id="7724464">time</span><span class="op" id="7724468">.</span><span class="ident" id="7724469">After</span><span class="op" id="7724474">(</span><span class="num" id="7724475">100</span>&nbsp;<span class="op" id="7724479">*</span>&nbsp;<span class="ident" id="7724481">time</span><span class="op" id="7724485">.</span><span class="ident" id="7724486">Millisecond</span><span class="op" id="7724497">)</span><span class="op" id="7724498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724503">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7724531">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7724534">}</span><br>
<span class="lineno"></span><span class="op" id="7724536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7724539">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7724620">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7724629">func</span>&nbsp;<span class="ident" id="7724634">TestNohup</span><span class="op" id="7724643">(</span><span class="ident" id="7724644">t</span>&nbsp;<span class="op" id="7724646">*</span><span class="ident" id="7724647">testing</span><span class="op" id="7724654">.</span><span class="ident" id="7724655">T</span><span class="op" id="7724656">)</span>&nbsp;<span class="op" id="7724658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724661">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724725">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724778">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7724822">c</span>&nbsp;<span class="op" id="7724824">:=</span>&nbsp;<span class="builtinfunc" id="7724827">make</span><span class="op" id="7724831">(</span><span class="keyword" id="7724832">chan</span>&nbsp;<span class="ident" id="7724837">os</span><span class="op" id="7724839">.</span><span class="ident" id="7724840">Signal</span><span class="op" id="7724846">,</span>&nbsp;<span class="num" id="7724848">1</span><span class="op" id="7724849">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7724852">Notify</span><span class="op" id="7724858">(</span><span class="ident" id="7724859">c</span><span class="op" id="7724860">,</span>&nbsp;<span class="ident" id="7724862">syscall</span><span class="op" id="7724869">.</span><span class="ident" id="7724870">SIGHUP</span><span class="op" id="7724876">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724880">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7724953">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725020">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725086">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725165">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725243">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725247">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725330">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725413">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725417">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7725477">for</span>&nbsp;<span class="ident" id="7725481">i</span>&nbsp;<span class="op" id="7725483">:=</span>&nbsp;<span class="num" id="7725486">1</span><span class="op" id="7725487">;</span>&nbsp;<span class="ident" id="7725489">i</span>&nbsp;<span class="op" id="7725491">&lt;=</span>&nbsp;<span class="num" id="7725494">2</span><span class="op" id="7725495">;</span>&nbsp;<span class="ident" id="7725497">i</span><span class="op" id="7725498">++</span>&nbsp;<span class="op" id="7725501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7725505">out</span><span class="op" id="7725508">,</span>&nbsp;<span class="ident" id="7725510">err</span>&nbsp;<span class="op" id="7725514">:=</span>&nbsp;<span class="ident" id="7725517">exec</span><span class="op" id="7725521">.</span><span class="ident" id="7725522">Command</span><span class="op" id="7725529">(</span><span class="ident" id="7725530">os</span><span class="op" id="7725532">.</span><span class="ident" id="7725533">Args</span><span class="op" id="7725537">[</span><span class="num" id="7725538">0</span><span class="op" id="7725539">]</span><span class="op" id="7725540">,</span>&nbsp;<span class="string" id="7725542">&#34;-test.run=TestStop&#34;</span><span class="op" id="7725562">,</span>&nbsp;<span class="string" id="7725564">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7725588">+</span><span class="ident" id="7725589">strconv</span><span class="op" id="7725596">.</span><span class="ident" id="7725597">Itoa</span><span class="op" id="7725601">(</span><span class="ident" id="7725602">i</span><span class="op" id="7725603">)</span><span class="op" id="7725604">)</span><span class="op" id="7725605">.</span><span class="ident" id="7725606">CombinedOutput</span><span class="op" id="7725620">(</span><span class="op" id="7725621">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7725625">if</span>&nbsp;<span class="ident" id="7725628">err</span>&nbsp;<span class="op" id="7725632">==</span>&nbsp;<span class="builtintype" id="7725635">nil</span>&nbsp;<span class="op" id="7725639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7725644">t</span><span class="op" id="7725645">.</span><span class="ident" id="7725646">Fatalf</span><span class="op" id="7725652">(</span><span class="string" id="7725653">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7725742">,</span>&nbsp;<span class="ident" id="7725744">i</span><span class="op" id="7725745">,</span>&nbsp;<span class="ident" id="7725747">out</span><span class="op" id="7725750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7725754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7725757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7725761">Stop</span><span class="op" id="7725765">(</span><span class="ident" id="7725766">c</span><span class="op" id="7725767">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7725771">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7725829">_</span><span class="op" id="7725830">,</span>&nbsp;<span class="ident" id="7725832">err</span>&nbsp;<span class="op" id="7725836">:=</span>&nbsp;<span class="ident" id="7725839">os</span><span class="op" id="7725841">.</span><span class="ident" id="7725842">Stat</span><span class="op" id="7725846">(</span><span class="string" id="7725847">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7725863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7725866">if</span>&nbsp;<span class="ident" id="7725869">err</span>&nbsp;<span class="op" id="7725873">!=</span>&nbsp;<span class="builtintype" id="7725876">nil</span>&nbsp;<span class="op" id="7725880">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7725884">t</span><span class="op" id="7725885">.</span><span class="ident" id="7725886">Skip</span><span class="op" id="7725890">(</span><span class="string" id="7725891">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7725940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7725943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7725947">for</span>&nbsp;<span class="ident" id="7725951">i</span>&nbsp;<span class="op" id="7725953">:=</span>&nbsp;<span class="num" id="7725956">1</span><span class="op" id="7725957">;</span>&nbsp;<span class="ident" id="7725959">i</span>&nbsp;<span class="op" id="7725961">&lt;=</span>&nbsp;<span class="num" id="7725964">2</span><span class="op" id="7725965">;</span>&nbsp;<span class="ident" id="7725967">i</span><span class="op" id="7725968">++</span>&nbsp;<span class="op" id="7725971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7725975">os</span><span class="op" id="7725977">.</span><span class="ident" id="7725978">Remove</span><span class="op" id="7725984">(</span><span class="string" id="7725985">&#34;nohup.out&#34;</span><span class="op" id="7725996">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7726000">out</span><span class="op" id="7726003">,</span>&nbsp;<span class="ident" id="7726005">err</span>&nbsp;<span class="op" id="7726009">:=</span>&nbsp;<span class="ident" id="7726012">exec</span><span class="op" id="7726016">.</span><span class="ident" id="7726017">Command</span><span class="op" id="7726024">(</span><span class="string" id="7726025">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7726041">,</span>&nbsp;<span class="ident" id="7726043">os</span><span class="op" id="7726045">.</span><span class="ident" id="7726046">Args</span><span class="op" id="7726050">[</span><span class="num" id="7726051">0</span><span class="op" id="7726052">]</span><span class="op" id="7726053">,</span>&nbsp;<span class="string" id="7726055">&#34;-test.run=TestStop&#34;</span><span class="op" id="7726075">,</span>&nbsp;<span class="string" id="7726077">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7726101">+</span><span class="ident" id="7726102">strconv</span><span class="op" id="7726109">.</span><span class="ident" id="7726110">Itoa</span><span class="op" id="7726114">(</span><span class="ident" id="7726115">i</span><span class="op" id="7726116">)</span><span class="op" id="7726117">)</span><span class="op" id="7726118">.</span><span class="ident" id="7726119">CombinedOutput</span><span class="op" id="7726133">(</span><span class="op" id="7726134">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7726139">data</span><span class="op" id="7726143">,</span>&nbsp;<span class="ident" id="7726145">_</span>&nbsp;<span class="op" id="7726147">:=</span>&nbsp;<span class="ident" id="7726150">ioutil</span><span class="op" id="7726156">.</span><span class="ident" id="7726157">ReadFile</span><span class="op" id="7726165">(</span><span class="string" id="7726166">&#34;nohup.out&#34;</span><span class="op" id="7726177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7726181">os</span><span class="op" id="7726183">.</span><span class="ident" id="7726184">Remove</span><span class="op" id="7726190">(</span><span class="string" id="7726191">&#34;nohup.out&#34;</span><span class="op" id="7726202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7726206">if</span>&nbsp;<span class="ident" id="7726209">err</span>&nbsp;<span class="op" id="7726213">!=</span>&nbsp;<span class="builtintype" id="7726216">nil</span>&nbsp;<span class="op" id="7726220">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7726225">t</span><span class="op" id="7726226">.</span><span class="ident" id="7726227">Fatalf</span><span class="op" id="7726233">(</span><span class="string" id="7726234">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7726345">,</span>&nbsp;<span class="ident" id="7726347">i</span><span class="op" id="7726348">,</span>&nbsp;<span class="ident" id="7726350">err</span><span class="op" id="7726353">,</span>&nbsp;<span class="ident" id="7726355">out</span><span class="op" id="7726358">,</span>&nbsp;<span class="ident" id="7726360">data</span><span class="op" id="7726364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7726368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7726371">}</span><br>
<span class="lineno"></span><span class="op" id="7726373">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
