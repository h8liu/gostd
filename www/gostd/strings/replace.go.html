<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html" class="current">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2401975">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2402030">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2402084">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2402135">package</span>&nbsp;<span class="ident" id="2402143">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2402152">import</span>&nbsp;<span class="string" id="2402159">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2402165">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2402223">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2402280">type</span>&nbsp;<span class="ident" id="2402285">Replacer</span>&nbsp;<span class="keyword" id="2402294">struct</span>&nbsp;<span class="op" id="2402301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2402304">r</span>&nbsp;<span class="ident" id="2402306">replacer</span><br>
<span class="lineno"></span><span class="op" id="2402315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2402318">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2402396">type</span>&nbsp;<span class="ident" id="2402401">replacer</span>&nbsp;<span class="keyword" id="2402410">interface</span>&nbsp;<span class="op" id="2402420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2402423">Replace</span><span class="op" id="2402430">(</span><span class="ident" id="2402431">s</span>&nbsp;<span class="builtintype" id="2402433">string</span><span class="op" id="2402439">)</span>&nbsp;<span class="builtintype" id="2402441">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2402449">WriteString</span><span class="op" id="2402460">(</span><span class="ident" id="2402461">w</span>&nbsp;<span class="ident" id="2402463">io</span><span class="op" id="2402465">.</span><span class="ident" id="2402466">Writer</span><span class="op" id="2402472">,</span>&nbsp;<span class="ident" id="2402474">s</span>&nbsp;<span class="builtintype" id="2402476">string</span><span class="op" id="2402482">)</span>&nbsp;<span class="op" id="2402484">(</span><span class="ident" id="2402485">n</span>&nbsp;<span class="builtintype" id="2402487">int</span><span class="op" id="2402490">,</span>&nbsp;<span class="ident" id="2402492">err</span>&nbsp;<span class="builtintype" id="2402496">error</span><span class="op" id="2402501">)</span><br>
<span class="lineno"></span><span class="op" id="2402503">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2402506">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2402582">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2402651">func</span>&nbsp;<span class="ident" id="2402656">NewReplacer</span><span class="op" id="2402667">(</span><span class="ident" id="2402668">oldnew</span>&nbsp;<span class="op" id="2402675">...</span><span class="builtintype" id="2402678">string</span><span class="op" id="2402684">)</span>&nbsp;<span class="op" id="2402686">*</span><span class="ident" id="2402687">Replacer</span>&nbsp;<span class="op" id="2402696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2402699">if</span>&nbsp;<span class="builtinfunc" id="2402702">len</span><span class="op" id="2402705">(</span><span class="ident" id="2402706">oldnew</span><span class="op" id="2402712">)</span><span class="op" id="2402713">%</span><span class="num" id="2402714">2</span>&nbsp;<span class="op" id="2402716">==</span>&nbsp;<span class="num" id="2402719">1</span>&nbsp;<span class="op" id="2402721">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2402725">panic</span><span class="op" id="2402730">(</span><span class="string" id="2402731">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2402772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2402775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2402779">if</span>&nbsp;<span class="builtinfunc" id="2402782">len</span><span class="op" id="2402785">(</span><span class="ident" id="2402786">oldnew</span><span class="op" id="2402792">)</span>&nbsp;<span class="op" id="2402794">==</span>&nbsp;<span class="num" id="2402797">2</span>&nbsp;<span class="op" id="2402799">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2402802">len</span><span class="op" id="2402805">(</span><span class="ident" id="2402806">oldnew</span><span class="op" id="2402812">[</span><span class="num" id="2402813">0</span><span class="op" id="2402814">]</span><span class="op" id="2402815">)</span>&nbsp;<span class="op" id="2402817">&gt;</span>&nbsp;<span class="num" id="2402819">1</span>&nbsp;<span class="op" id="2402821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2402825">return</span>&nbsp;<span class="op" id="2402832">&amp;</span><span class="ident" id="2402833">Replacer</span><span class="op" id="2402841">{</span><span class="ident" id="2402842">r</span><span class="op" id="2402843">:</span>&nbsp;<span class="ident" id="2402845">makeSingleStringReplacer</span><span class="op" id="2402869">(</span><span class="ident" id="2402870">oldnew</span><span class="op" id="2402876">[</span><span class="num" id="2402877">0</span><span class="op" id="2402878">]</span><span class="op" id="2402879">,</span>&nbsp;<span class="ident" id="2402881">oldnew</span><span class="op" id="2402887">[</span><span class="num" id="2402888">1</span><span class="op" id="2402889">]</span><span class="op" id="2402890">)</span><span class="op" id="2402891">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2402894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2402898">allNewBytes</span>&nbsp;<span class="op" id="2402910">:=</span>&nbsp;<span class="builtintype" id="2402913">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2402919">for</span>&nbsp;<span class="ident" id="2402923">i</span>&nbsp;<span class="op" id="2402925">:=</span>&nbsp;<span class="num" id="2402928">0</span><span class="op" id="2402929">;</span>&nbsp;<span class="ident" id="2402931">i</span>&nbsp;<span class="op" id="2402933">&lt;</span>&nbsp;<span class="builtinfunc" id="2402935">len</span><span class="op" id="2402938">(</span><span class="ident" id="2402939">oldnew</span><span class="op" id="2402945">)</span><span class="op" id="2402946">;</span>&nbsp;<span class="ident" id="2402948">i</span>&nbsp;<span class="op" id="2402950">+=</span>&nbsp;<span class="num" id="2402953">2</span>&nbsp;<span class="op" id="2402955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2402959">if</span>&nbsp;<span class="builtinfunc" id="2402962">len</span><span class="op" id="2402965">(</span><span class="ident" id="2402966">oldnew</span><span class="op" id="2402972">[</span><span class="ident" id="2402973">i</span><span class="op" id="2402974">]</span><span class="op" id="2402975">)</span>&nbsp;<span class="op" id="2402977">!=</span>&nbsp;<span class="num" id="2402980">1</span>&nbsp;<span class="op" id="2402982">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2402987">return</span>&nbsp;<span class="op" id="2402994">&amp;</span><span class="ident" id="2402995">Replacer</span><span class="op" id="2403003">{</span><span class="ident" id="2403004">r</span><span class="op" id="2403005">:</span>&nbsp;<span class="ident" id="2403007">makeGenericReplacer</span><span class="op" id="2403026">(</span><span class="ident" id="2403027">oldnew</span><span class="op" id="2403033">)</span><span class="op" id="2403034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403042">if</span>&nbsp;<span class="builtinfunc" id="2403045">len</span><span class="op" id="2403048">(</span><span class="ident" id="2403049">oldnew</span><span class="op" id="2403055">[</span><span class="ident" id="2403056">i</span><span class="op" id="2403057">+</span><span class="num" id="2403058">1</span><span class="op" id="2403059">]</span><span class="op" id="2403060">)</span>&nbsp;<span class="op" id="2403062">!=</span>&nbsp;<span class="num" id="2403065">1</span>&nbsp;<span class="op" id="2403067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403072">allNewBytes</span>&nbsp;<span class="op" id="2403084">=</span>&nbsp;<span class="builtintype" id="2403086">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403094">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403101">if</span>&nbsp;<span class="ident" id="2403104">allNewBytes</span>&nbsp;<span class="op" id="2403116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403120">r</span>&nbsp;<span class="op" id="2403122">:=</span>&nbsp;<span class="ident" id="2403125">byteReplacer</span><span class="op" id="2403137">{</span><span class="op" id="2403138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403142">for</span>&nbsp;<span class="ident" id="2403146">i</span>&nbsp;<span class="op" id="2403148">:=</span>&nbsp;<span class="keyword" id="2403151">range</span>&nbsp;<span class="ident" id="2403157">r</span>&nbsp;<span class="op" id="2403159">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403164">r</span><span class="op" id="2403165">[</span><span class="ident" id="2403166">i</span><span class="op" id="2403167">]</span>&nbsp;<span class="op" id="2403169">=</span>&nbsp;<span class="builtintype" id="2403171">byte</span><span class="op" id="2403175">(</span><span class="ident" id="2403176">i</span><span class="op" id="2403177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2403185">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2403244">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403291">for</span>&nbsp;<span class="ident" id="2403295">i</span>&nbsp;<span class="op" id="2403297">:=</span>&nbsp;<span class="builtinfunc" id="2403300">len</span><span class="op" id="2403303">(</span><span class="ident" id="2403304">oldnew</span><span class="op" id="2403310">)</span>&nbsp;<span class="op" id="2403312">-</span>&nbsp;<span class="num" id="2403314">2</span><span class="op" id="2403315">;</span>&nbsp;<span class="ident" id="2403317">i</span>&nbsp;<span class="op" id="2403319">&gt;=</span>&nbsp;<span class="num" id="2403322">0</span><span class="op" id="2403323">;</span>&nbsp;<span class="ident" id="2403325">i</span>&nbsp;<span class="op" id="2403327">-=</span>&nbsp;<span class="num" id="2403330">2</span>&nbsp;<span class="op" id="2403332">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403337">o</span>&nbsp;<span class="op" id="2403339">:=</span>&nbsp;<span class="ident" id="2403342">oldnew</span><span class="op" id="2403348">[</span><span class="ident" id="2403349">i</span><span class="op" id="2403350">]</span><span class="op" id="2403351">[</span><span class="num" id="2403352">0</span><span class="op" id="2403353">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403358">n</span>&nbsp;<span class="op" id="2403360">:=</span>&nbsp;<span class="ident" id="2403363">oldnew</span><span class="op" id="2403369">[</span><span class="ident" id="2403370">i</span><span class="op" id="2403371">+</span><span class="num" id="2403372">1</span><span class="op" id="2403373">]</span><span class="op" id="2403374">[</span><span class="num" id="2403375">0</span><span class="op" id="2403376">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403381">r</span><span class="op" id="2403382">[</span><span class="ident" id="2403383">o</span><span class="op" id="2403384">]</span>&nbsp;<span class="op" id="2403386">=</span>&nbsp;<span class="ident" id="2403388">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403396">return</span>&nbsp;<span class="op" id="2403403">&amp;</span><span class="ident" id="2403404">Replacer</span><span class="op" id="2403412">{</span><span class="ident" id="2403413">r</span><span class="op" id="2403414">:</span>&nbsp;<span class="op" id="2403416">&amp;</span><span class="ident" id="2403417">r</span><span class="op" id="2403418">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403425">r</span>&nbsp;<span class="op" id="2403427">:=</span>&nbsp;<span class="ident" id="2403430">byteStringReplacer</span><span class="op" id="2403448">{</span><span class="op" id="2403449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2403452">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2403510">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403556">for</span>&nbsp;<span class="ident" id="2403560">i</span>&nbsp;<span class="op" id="2403562">:=</span>&nbsp;<span class="builtinfunc" id="2403565">len</span><span class="op" id="2403568">(</span><span class="ident" id="2403569">oldnew</span><span class="op" id="2403575">)</span>&nbsp;<span class="op" id="2403577">-</span>&nbsp;<span class="num" id="2403579">2</span><span class="op" id="2403580">;</span>&nbsp;<span class="ident" id="2403582">i</span>&nbsp;<span class="op" id="2403584">&gt;=</span>&nbsp;<span class="num" id="2403587">0</span><span class="op" id="2403588">;</span>&nbsp;<span class="ident" id="2403590">i</span>&nbsp;<span class="op" id="2403592">-=</span>&nbsp;<span class="num" id="2403595">2</span>&nbsp;<span class="op" id="2403597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403601">o</span>&nbsp;<span class="op" id="2403603">:=</span>&nbsp;<span class="ident" id="2403606">oldnew</span><span class="op" id="2403612">[</span><span class="ident" id="2403613">i</span><span class="op" id="2403614">]</span><span class="op" id="2403615">[</span><span class="num" id="2403616">0</span><span class="op" id="2403617">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403621">n</span>&nbsp;<span class="op" id="2403623">:=</span>&nbsp;<span class="ident" id="2403626">oldnew</span><span class="op" id="2403632">[</span><span class="ident" id="2403633">i</span><span class="op" id="2403634">+</span><span class="num" id="2403635">1</span><span class="op" id="2403636">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2403640">r</span><span class="op" id="2403641">[</span><span class="ident" id="2403642">o</span><span class="op" id="2403643">]</span>&nbsp;<span class="op" id="2403645">=</span>&nbsp;<span class="op" id="2403647">[</span><span class="op" id="2403648">]</span><span class="builtintype" id="2403649">byte</span><span class="op" id="2403653">(</span><span class="ident" id="2403654">n</span><span class="op" id="2403655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2403658">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403661">return</span>&nbsp;<span class="op" id="2403668">&amp;</span><span class="ident" id="2403669">Replacer</span><span class="op" id="2403677">{</span><span class="ident" id="2403678">r</span><span class="op" id="2403679">:</span>&nbsp;<span class="op" id="2403681">&amp;</span><span class="ident" id="2403682">r</span><span class="op" id="2403683">}</span><br>
<span class="lineno"></span><span class="op" id="2403685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2403688">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2403752">func</span>&nbsp;<span class="op" id="2403757">(</span><span class="ident" id="2403758">r</span>&nbsp;<span class="op" id="2403760">*</span><span class="ident" id="2403761">Replacer</span><span class="op" id="2403769">)</span>&nbsp;<span class="ident" id="2403771">Replace</span><span class="op" id="2403778">(</span><span class="ident" id="2403779">s</span>&nbsp;<span class="builtintype" id="2403781">string</span><span class="op" id="2403787">)</span>&nbsp;<span class="builtintype" id="2403789">string</span>&nbsp;<span class="op" id="2403796">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403799">return</span>&nbsp;<span class="ident" id="2403806">r</span><span class="op" id="2403807">.</span><span class="ident" id="2403808">r</span><span class="op" id="2403809">.</span><span class="ident" id="2403810">Replace</span><span class="op" id="2403817">(</span><span class="ident" id="2403818">s</span><span class="op" id="2403819">)</span><br>
<span class="lineno"></span><span class="op" id="2403821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2403824">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2403886">func</span>&nbsp;<span class="op" id="2403891">(</span><span class="ident" id="2403892">r</span>&nbsp;<span class="op" id="2403894">*</span><span class="ident" id="2403895">Replacer</span><span class="op" id="2403903">)</span>&nbsp;<span class="ident" id="2403905">WriteString</span><span class="op" id="2403916">(</span><span class="ident" id="2403917">w</span>&nbsp;<span class="ident" id="2403919">io</span><span class="op" id="2403921">.</span><span class="ident" id="2403922">Writer</span><span class="op" id="2403928">,</span>&nbsp;<span class="ident" id="2403930">s</span>&nbsp;<span class="builtintype" id="2403932">string</span><span class="op" id="2403938">)</span>&nbsp;<span class="op" id="2403940">(</span><span class="ident" id="2403941">n</span>&nbsp;<span class="builtintype" id="2403943">int</span><span class="op" id="2403946">,</span>&nbsp;<span class="ident" id="2403948">err</span>&nbsp;<span class="builtintype" id="2403952">error</span><span class="op" id="2403957">)</span>&nbsp;<span class="op" id="2403959">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2403962">return</span>&nbsp;<span class="ident" id="2403969">r</span><span class="op" id="2403970">.</span><span class="ident" id="2403971">r</span><span class="op" id="2403972">.</span><span class="ident" id="2403973">WriteString</span><span class="op" id="2403984">(</span><span class="ident" id="2403985">w</span><span class="op" id="2403986">,</span>&nbsp;<span class="ident" id="2403988">s</span><span class="op" id="2403989">)</span><br>
<span class="lineno"></span><span class="op" id="2403991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2403994">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2404071">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2404149">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2404197">//</span><br>
<span class="lineno"></span><span class="comment" id="2404200">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2404210">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2404221">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2404233">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2404245">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2404256">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2404270">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2404281">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2404293">//</span><br>
<span class="lineno"></span><span class="comment" id="2404296">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2404374">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2404452">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2404526">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2404577">type</span>&nbsp;<span class="ident" id="2404582">trieNode</span>&nbsp;<span class="keyword" id="2404591">struct</span>&nbsp;<span class="op" id="2404598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2404601">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2404674">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2404711">value</span>&nbsp;<span class="builtintype" id="2404717">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2404725">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2404800">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2404875">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2404948">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405021">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2405053">priority</span>&nbsp;<span class="builtintype" id="2405062">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405068">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405124">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405188">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405256">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405314">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405318">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405390">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405448">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405522">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405599">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2405674">prefix</span>&nbsp;<span class="builtintype" id="2405681">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2405689">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2405696">*</span><span class="ident" id="2405697">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405708">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405779">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405853">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2405927">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406001">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406066">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406141">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406163">table</span>&nbsp;<span class="op" id="2406169">[</span><span class="op" id="2406170">]</span><span class="op" id="2406171">*</span><span class="ident" id="2406172">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2406181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2406184">func</span>&nbsp;<span class="op" id="2406189">(</span><span class="ident" id="2406190">t</span>&nbsp;<span class="op" id="2406192">*</span><span class="ident" id="2406193">trieNode</span><span class="op" id="2406201">)</span>&nbsp;<span class="ident" id="2406203">add</span><span class="op" id="2406206">(</span><span class="ident" id="2406207">key</span><span class="op" id="2406210">,</span>&nbsp;<span class="ident" id="2406212">val</span>&nbsp;<span class="builtintype" id="2406216">string</span><span class="op" id="2406222">,</span>&nbsp;<span class="ident" id="2406224">priority</span>&nbsp;<span class="builtintype" id="2406233">int</span><span class="op" id="2406236">,</span>&nbsp;<span class="ident" id="2406238">r</span>&nbsp;<span class="op" id="2406240">*</span><span class="ident" id="2406241">genericReplacer</span><span class="op" id="2406256">)</span>&nbsp;<span class="op" id="2406258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406261">if</span>&nbsp;<span class="ident" id="2406264">key</span>&nbsp;<span class="op" id="2406268">==</span>&nbsp;<span class="string" id="2406271">&#34;&#34;</span>&nbsp;<span class="op" id="2406274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406278">if</span>&nbsp;<span class="ident" id="2406281">t</span><span class="op" id="2406282">.</span><span class="ident" id="2406283">priority</span>&nbsp;<span class="op" id="2406292">==</span>&nbsp;<span class="num" id="2406295">0</span>&nbsp;<span class="op" id="2406297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406302">t</span><span class="op" id="2406303">.</span><span class="ident" id="2406304">value</span>&nbsp;<span class="op" id="2406310">=</span>&nbsp;<span class="ident" id="2406312">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406319">t</span><span class="op" id="2406320">.</span><span class="ident" id="2406321">priority</span>&nbsp;<span class="op" id="2406330">=</span>&nbsp;<span class="ident" id="2406332">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2406343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406347">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2406355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406359">if</span>&nbsp;<span class="ident" id="2406362">t</span><span class="op" id="2406363">.</span><span class="ident" id="2406364">prefix</span>&nbsp;<span class="op" id="2406371">!=</span>&nbsp;<span class="string" id="2406374">&#34;&#34;</span>&nbsp;<span class="op" id="2406377">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406381">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406433">var</span>&nbsp;<span class="ident" id="2406437">n</span>&nbsp;<span class="builtintype" id="2406439">int</span>&nbsp;<span class="comment" id="2406443">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406484">for</span>&nbsp;<span class="op" id="2406488">;</span>&nbsp;<span class="ident" id="2406490">n</span>&nbsp;<span class="op" id="2406492">&lt;</span>&nbsp;<span class="builtinfunc" id="2406494">len</span><span class="op" id="2406497">(</span><span class="ident" id="2406498">t</span><span class="op" id="2406499">.</span><span class="ident" id="2406500">prefix</span><span class="op" id="2406506">)</span>&nbsp;<span class="op" id="2406508">&amp;&amp;</span>&nbsp;<span class="ident" id="2406511">n</span>&nbsp;<span class="op" id="2406513">&lt;</span>&nbsp;<span class="builtinfunc" id="2406515">len</span><span class="op" id="2406518">(</span><span class="ident" id="2406519">key</span><span class="op" id="2406522">)</span><span class="op" id="2406523">;</span>&nbsp;<span class="ident" id="2406525">n</span><span class="op" id="2406526">++</span>&nbsp;<span class="op" id="2406529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406534">if</span>&nbsp;<span class="ident" id="2406537">t</span><span class="op" id="2406538">.</span><span class="ident" id="2406539">prefix</span><span class="op" id="2406545">[</span><span class="ident" id="2406546">n</span><span class="op" id="2406547">]</span>&nbsp;<span class="op" id="2406549">!=</span>&nbsp;<span class="ident" id="2406552">key</span><span class="op" id="2406555">[</span><span class="ident" id="2406556">n</span><span class="op" id="2406557">]</span>&nbsp;<span class="op" id="2406559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406565">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2406574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2406578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406582">if</span>&nbsp;<span class="ident" id="2406585">n</span>&nbsp;<span class="op" id="2406587">==</span>&nbsp;<span class="builtinfunc" id="2406590">len</span><span class="op" id="2406593">(</span><span class="ident" id="2406594">t</span><span class="op" id="2406595">.</span><span class="ident" id="2406596">prefix</span><span class="op" id="2406602">)</span>&nbsp;<span class="op" id="2406604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406609">t</span><span class="op" id="2406610">.</span><span class="ident" id="2406611">next</span><span class="op" id="2406615">.</span><span class="ident" id="2406616">add</span><span class="op" id="2406619">(</span><span class="ident" id="2406620">key</span><span class="op" id="2406623">[</span><span class="ident" id="2406624">n</span><span class="op" id="2406625">:</span><span class="op" id="2406626">]</span><span class="op" id="2406627">,</span>&nbsp;<span class="ident" id="2406629">val</span><span class="op" id="2406632">,</span>&nbsp;<span class="ident" id="2406634">priority</span><span class="op" id="2406642">,</span>&nbsp;<span class="ident" id="2406644">r</span><span class="op" id="2406645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2406649">}</span>&nbsp;<span class="keyword" id="2406651">else</span>&nbsp;<span class="keyword" id="2406656">if</span>&nbsp;<span class="ident" id="2406659">n</span>&nbsp;<span class="op" id="2406661">==</span>&nbsp;<span class="num" id="2406664">0</span>&nbsp;<span class="op" id="2406666">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406671">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406739">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2406804">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406850">var</span>&nbsp;<span class="ident" id="2406854">prefixNode</span>&nbsp;<span class="op" id="2406865">*</span><span class="ident" id="2406866">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2406878">if</span>&nbsp;<span class="builtinfunc" id="2406881">len</span><span class="op" id="2406884">(</span><span class="ident" id="2406885">t</span><span class="op" id="2406886">.</span><span class="ident" id="2406887">prefix</span><span class="op" id="2406893">)</span>&nbsp;<span class="op" id="2406895">==</span>&nbsp;<span class="num" id="2406898">1</span>&nbsp;<span class="op" id="2406900">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406906">prefixNode</span>&nbsp;<span class="op" id="2406917">=</span>&nbsp;<span class="ident" id="2406919">t</span><span class="op" id="2406920">.</span><span class="ident" id="2406921">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2406929">}</span>&nbsp;<span class="keyword" id="2406931">else</span>&nbsp;<span class="op" id="2406936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406942">prefixNode</span>&nbsp;<span class="op" id="2406953">=</span>&nbsp;<span class="op" id="2406955">&amp;</span><span class="ident" id="2406956">trieNode</span><span class="op" id="2406964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406971">prefix</span><span class="op" id="2406977">:</span>&nbsp;<span class="ident" id="2406979">t</span><span class="op" id="2406980">.</span><span class="ident" id="2406981">prefix</span><span class="op" id="2406987">[</span><span class="num" id="2406988">1</span><span class="op" id="2406989">:</span><span class="op" id="2406990">]</span><span class="op" id="2406991">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2406998">next</span><span class="op" id="2407002">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2407006">t</span><span class="op" id="2407007">.</span><span class="ident" id="2407008">next</span><span class="op" id="2407012">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407028">keyNode</span>&nbsp;<span class="op" id="2407036">:=</span>&nbsp;<span class="builtinfunc" id="2407039">new</span><span class="op" id="2407042">(</span><span class="ident" id="2407043">trieNode</span><span class="op" id="2407051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407056">t</span><span class="op" id="2407057">.</span><span class="ident" id="2407058">table</span>&nbsp;<span class="op" id="2407064">=</span>&nbsp;<span class="builtinfunc" id="2407066">make</span><span class="op" id="2407070">(</span><span class="op" id="2407071">[</span><span class="op" id="2407072">]</span><span class="op" id="2407073">*</span><span class="ident" id="2407074">trieNode</span><span class="op" id="2407082">,</span>&nbsp;<span class="ident" id="2407084">r</span><span class="op" id="2407085">.</span><span class="ident" id="2407086">tableSize</span><span class="op" id="2407095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407100">t</span><span class="op" id="2407101">.</span><span class="ident" id="2407102">table</span><span class="op" id="2407107">[</span><span class="ident" id="2407108">r</span><span class="op" id="2407109">.</span><span class="ident" id="2407110">mapping</span><span class="op" id="2407117">[</span><span class="ident" id="2407118">t</span><span class="op" id="2407119">.</span><span class="ident" id="2407120">prefix</span><span class="op" id="2407126">[</span><span class="num" id="2407127">0</span><span class="op" id="2407128">]</span><span class="op" id="2407129">]</span><span class="op" id="2407130">]</span>&nbsp;<span class="op" id="2407132">=</span>&nbsp;<span class="ident" id="2407134">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407148">t</span><span class="op" id="2407149">.</span><span class="ident" id="2407150">table</span><span class="op" id="2407155">[</span><span class="ident" id="2407156">r</span><span class="op" id="2407157">.</span><span class="ident" id="2407158">mapping</span><span class="op" id="2407165">[</span><span class="ident" id="2407166">key</span><span class="op" id="2407169">[</span><span class="num" id="2407170">0</span><span class="op" id="2407171">]</span><span class="op" id="2407172">]</span><span class="op" id="2407173">]</span>&nbsp;<span class="op" id="2407175">=</span>&nbsp;<span class="ident" id="2407177">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407188">t</span><span class="op" id="2407189">.</span><span class="ident" id="2407190">prefix</span>&nbsp;<span class="op" id="2407197">=</span>&nbsp;<span class="string" id="2407199">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407205">t</span><span class="op" id="2407206">.</span><span class="ident" id="2407207">next</span>&nbsp;<span class="op" id="2407212">=</span>&nbsp;<span class="ident" id="2407214">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407221">keyNode</span><span class="op" id="2407228">.</span><span class="ident" id="2407229">add</span><span class="op" id="2407232">(</span><span class="ident" id="2407233">key</span><span class="op" id="2407236">[</span><span class="num" id="2407237">1</span><span class="op" id="2407238">:</span><span class="op" id="2407239">]</span><span class="op" id="2407240">,</span>&nbsp;<span class="ident" id="2407242">val</span><span class="op" id="2407245">,</span>&nbsp;<span class="ident" id="2407247">priority</span><span class="op" id="2407255">,</span>&nbsp;<span class="ident" id="2407257">r</span><span class="op" id="2407258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407262">}</span>&nbsp;<span class="keyword" id="2407264">else</span>&nbsp;<span class="op" id="2407269">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2407274">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407336">next</span>&nbsp;<span class="op" id="2407341">:=</span>&nbsp;<span class="op" id="2407344">&amp;</span><span class="ident" id="2407345">trieNode</span><span class="op" id="2407353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407359">prefix</span><span class="op" id="2407365">:</span>&nbsp;<span class="ident" id="2407367">t</span><span class="op" id="2407368">.</span><span class="ident" id="2407369">prefix</span><span class="op" id="2407375">[</span><span class="ident" id="2407376">n</span><span class="op" id="2407377">:</span><span class="op" id="2407378">]</span><span class="op" id="2407379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407385">next</span><span class="op" id="2407389">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2407393">t</span><span class="op" id="2407394">.</span><span class="ident" id="2407395">next</span><span class="op" id="2407399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407404">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407409">t</span><span class="op" id="2407410">.</span><span class="ident" id="2407411">prefix</span>&nbsp;<span class="op" id="2407418">=</span>&nbsp;<span class="ident" id="2407420">t</span><span class="op" id="2407421">.</span><span class="ident" id="2407422">prefix</span><span class="op" id="2407428">[</span><span class="op" id="2407429">:</span><span class="ident" id="2407430">n</span><span class="op" id="2407431">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407436">t</span><span class="op" id="2407437">.</span><span class="ident" id="2407438">next</span>&nbsp;<span class="op" id="2407443">=</span>&nbsp;<span class="ident" id="2407445">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407453">next</span><span class="op" id="2407457">.</span><span class="ident" id="2407458">add</span><span class="op" id="2407461">(</span><span class="ident" id="2407462">key</span><span class="op" id="2407465">[</span><span class="ident" id="2407466">n</span><span class="op" id="2407467">:</span><span class="op" id="2407468">]</span><span class="op" id="2407469">,</span>&nbsp;<span class="ident" id="2407471">val</span><span class="op" id="2407474">,</span>&nbsp;<span class="ident" id="2407476">priority</span><span class="op" id="2407484">,</span>&nbsp;<span class="ident" id="2407486">r</span><span class="op" id="2407487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407494">}</span>&nbsp;<span class="keyword" id="2407496">else</span>&nbsp;<span class="keyword" id="2407501">if</span>&nbsp;<span class="ident" id="2407504">t</span><span class="op" id="2407505">.</span><span class="ident" id="2407506">table</span>&nbsp;<span class="op" id="2407512">!=</span>&nbsp;<span class="ident" id="2407515">nil</span>&nbsp;<span class="op" id="2407519">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2407523">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407556">m</span>&nbsp;<span class="op" id="2407558">:=</span>&nbsp;<span class="ident" id="2407561">r</span><span class="op" id="2407562">.</span><span class="ident" id="2407563">mapping</span><span class="op" id="2407570">[</span><span class="ident" id="2407571">key</span><span class="op" id="2407574">[</span><span class="num" id="2407575">0</span><span class="op" id="2407576">]</span><span class="op" id="2407577">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2407581">if</span>&nbsp;<span class="ident" id="2407584">t</span><span class="op" id="2407585">.</span><span class="ident" id="2407586">table</span><span class="op" id="2407591">[</span><span class="ident" id="2407592">m</span><span class="op" id="2407593">]</span>&nbsp;<span class="op" id="2407595">==</span>&nbsp;<span class="ident" id="2407598">nil</span>&nbsp;<span class="op" id="2407602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407607">t</span><span class="op" id="2407608">.</span><span class="ident" id="2407609">table</span><span class="op" id="2407614">[</span><span class="ident" id="2407615">m</span><span class="op" id="2407616">]</span>&nbsp;<span class="op" id="2407618">=</span>&nbsp;<span class="builtinfunc" id="2407620">new</span><span class="op" id="2407623">(</span><span class="ident" id="2407624">trieNode</span><span class="op" id="2407632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407636">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407640">t</span><span class="op" id="2407641">.</span><span class="ident" id="2407642">table</span><span class="op" id="2407647">[</span><span class="ident" id="2407648">m</span><span class="op" id="2407649">]</span><span class="op" id="2407650">.</span><span class="ident" id="2407651">add</span><span class="op" id="2407654">(</span><span class="ident" id="2407655">key</span><span class="op" id="2407658">[</span><span class="num" id="2407659">1</span><span class="op" id="2407660">:</span><span class="op" id="2407661">]</span><span class="op" id="2407662">,</span>&nbsp;<span class="ident" id="2407664">val</span><span class="op" id="2407667">,</span>&nbsp;<span class="ident" id="2407669">priority</span><span class="op" id="2407677">,</span>&nbsp;<span class="ident" id="2407679">r</span><span class="op" id="2407680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407683">}</span>&nbsp;<span class="keyword" id="2407685">else</span>&nbsp;<span class="op" id="2407690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407694">t</span><span class="op" id="2407695">.</span><span class="ident" id="2407696">prefix</span>&nbsp;<span class="op" id="2407703">=</span>&nbsp;<span class="ident" id="2407705">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407711">t</span><span class="op" id="2407712">.</span><span class="ident" id="2407713">next</span>&nbsp;<span class="op" id="2407718">=</span>&nbsp;<span class="builtinfunc" id="2407720">new</span><span class="op" id="2407723">(</span><span class="ident" id="2407724">trieNode</span><span class="op" id="2407732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407736">t</span><span class="op" id="2407737">.</span><span class="ident" id="2407738">next</span><span class="op" id="2407742">.</span><span class="ident" id="2407743">add</span><span class="op" id="2407746">(</span><span class="string" id="2407747">&#34;&#34;</span><span class="op" id="2407749">,</span>&nbsp;<span class="ident" id="2407751">val</span><span class="op" id="2407754">,</span>&nbsp;<span class="ident" id="2407756">priority</span><span class="op" id="2407764">,</span>&nbsp;<span class="ident" id="2407766">r</span><span class="op" id="2407767">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2407770">}</span><br>
<span class="lineno"></span><span class="op" id="2407772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2407775">func</span>&nbsp;<span class="op" id="2407780">(</span><span class="ident" id="2407781">r</span>&nbsp;<span class="op" id="2407783">*</span><span class="ident" id="2407784">genericReplacer</span><span class="op" id="2407799">)</span>&nbsp;<span class="ident" id="2407801">lookup</span><span class="op" id="2407807">(</span><span class="ident" id="2407808">s</span>&nbsp;<span class="builtintype" id="2407810">string</span><span class="op" id="2407816">,</span>&nbsp;<span class="ident" id="2407818">ignoreRoot</span>&nbsp;<span class="builtintype" id="2407829">bool</span><span class="op" id="2407833">)</span>&nbsp;<span class="op" id="2407835">(</span><span class="ident" id="2407836">val</span>&nbsp;<span class="builtintype" id="2407840">string</span><span class="op" id="2407846">,</span>&nbsp;<span class="ident" id="2407848">keylen</span>&nbsp;<span class="builtintype" id="2407855">int</span><span class="op" id="2407858">,</span>&nbsp;<span class="ident" id="2407860">found</span>&nbsp;<span class="builtintype" id="2407866">bool</span><span class="op" id="2407870">)</span>&nbsp;<span class="op" id="2407872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2407875">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2407948">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407974">bestPriority</span>&nbsp;<span class="op" id="2407987">:=</span>&nbsp;<span class="num" id="2407990">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2407993">node</span>&nbsp;<span class="op" id="2407998">:=</span>&nbsp;<span class="op" id="2408001">&amp;</span><span class="ident" id="2408002">r</span><span class="op" id="2408003">.</span><span class="ident" id="2408004">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408010">n</span>&nbsp;<span class="op" id="2408012">:=</span>&nbsp;<span class="num" id="2408015">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408018">for</span>&nbsp;<span class="ident" id="2408022">node</span>&nbsp;<span class="op" id="2408027">!=</span>&nbsp;<span class="ident" id="2408030">nil</span>&nbsp;<span class="op" id="2408034">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408038">if</span>&nbsp;<span class="ident" id="2408041">node</span><span class="op" id="2408045">.</span><span class="ident" id="2408046">priority</span>&nbsp;<span class="op" id="2408055">&gt;</span>&nbsp;<span class="ident" id="2408057">bestPriority</span>&nbsp;<span class="op" id="2408070">&amp;&amp;</span>&nbsp;<span class="op" id="2408073">!</span><span class="op" id="2408074">(</span><span class="ident" id="2408075">ignoreRoot</span>&nbsp;<span class="op" id="2408086">&amp;&amp;</span>&nbsp;<span class="ident" id="2408089">node</span>&nbsp;<span class="op" id="2408094">==</span>&nbsp;<span class="op" id="2408097">&amp;</span><span class="ident" id="2408098">r</span><span class="op" id="2408099">.</span><span class="ident" id="2408100">root</span><span class="op" id="2408104">)</span>&nbsp;<span class="op" id="2408106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408111">bestPriority</span>&nbsp;<span class="op" id="2408124">=</span>&nbsp;<span class="ident" id="2408126">node</span><span class="op" id="2408130">.</span><span class="ident" id="2408131">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408143">val</span>&nbsp;<span class="op" id="2408147">=</span>&nbsp;<span class="ident" id="2408149">node</span><span class="op" id="2408153">.</span><span class="ident" id="2408154">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408163">keylen</span>&nbsp;<span class="op" id="2408170">=</span>&nbsp;<span class="ident" id="2408172">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408177">found</span>&nbsp;<span class="op" id="2408183">=</span>&nbsp;<span class="builtintype" id="2408185">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408197">if</span>&nbsp;<span class="ident" id="2408200">s</span>&nbsp;<span class="op" id="2408202">==</span>&nbsp;<span class="string" id="2408205">&#34;&#34;</span>&nbsp;<span class="op" id="2408208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408213">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408221">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408225">if</span>&nbsp;<span class="ident" id="2408228">node</span><span class="op" id="2408232">.</span><span class="ident" id="2408233">table</span>&nbsp;<span class="op" id="2408239">!=</span>&nbsp;<span class="ident" id="2408242">nil</span>&nbsp;<span class="op" id="2408246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408251">index</span>&nbsp;<span class="op" id="2408257">:=</span>&nbsp;<span class="ident" id="2408260">r</span><span class="op" id="2408261">.</span><span class="ident" id="2408262">mapping</span><span class="op" id="2408269">[</span><span class="ident" id="2408270">s</span><span class="op" id="2408271">[</span><span class="num" id="2408272">0</span><span class="op" id="2408273">]</span><span class="op" id="2408274">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408279">if</span>&nbsp;<span class="builtintype" id="2408282">int</span><span class="op" id="2408285">(</span><span class="ident" id="2408286">index</span><span class="op" id="2408291">)</span>&nbsp;<span class="op" id="2408293">==</span>&nbsp;<span class="ident" id="2408296">r</span><span class="op" id="2408297">.</span><span class="ident" id="2408298">tableSize</span>&nbsp;<span class="op" id="2408308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408314">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408323">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408328">node</span>&nbsp;<span class="op" id="2408333">=</span>&nbsp;<span class="ident" id="2408335">node</span><span class="op" id="2408339">.</span><span class="ident" id="2408340">table</span><span class="op" id="2408345">[</span><span class="ident" id="2408346">index</span><span class="op" id="2408351">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408356">s</span>&nbsp;<span class="op" id="2408358">=</span>&nbsp;<span class="ident" id="2408360">s</span><span class="op" id="2408361">[</span><span class="num" id="2408362">1</span><span class="op" id="2408363">:</span><span class="op" id="2408364">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408369">n</span><span class="op" id="2408370">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408375">}</span>&nbsp;<span class="keyword" id="2408377">else</span>&nbsp;<span class="keyword" id="2408382">if</span>&nbsp;<span class="ident" id="2408385">node</span><span class="op" id="2408389">.</span><span class="ident" id="2408390">prefix</span>&nbsp;<span class="op" id="2408397">!=</span>&nbsp;<span class="string" id="2408400">&#34;&#34;</span>&nbsp;<span class="op" id="2408403">&amp;&amp;</span>&nbsp;<span class="ident" id="2408406">HasPrefix</span><span class="op" id="2408415">(</span><span class="ident" id="2408416">s</span><span class="op" id="2408417">,</span>&nbsp;<span class="ident" id="2408419">node</span><span class="op" id="2408423">.</span><span class="ident" id="2408424">prefix</span><span class="op" id="2408430">)</span>&nbsp;<span class="op" id="2408432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408437">n</span>&nbsp;<span class="op" id="2408439">+=</span>&nbsp;<span class="builtinfunc" id="2408442">len</span><span class="op" id="2408445">(</span><span class="ident" id="2408446">node</span><span class="op" id="2408450">.</span><span class="ident" id="2408451">prefix</span><span class="op" id="2408457">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408462">s</span>&nbsp;<span class="op" id="2408464">=</span>&nbsp;<span class="ident" id="2408466">s</span><span class="op" id="2408467">[</span><span class="builtinfunc" id="2408468">len</span><span class="op" id="2408471">(</span><span class="ident" id="2408472">node</span><span class="op" id="2408476">.</span><span class="ident" id="2408477">prefix</span><span class="op" id="2408483">)</span><span class="op" id="2408484">:</span><span class="op" id="2408485">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408490">node</span>&nbsp;<span class="op" id="2408495">=</span>&nbsp;<span class="ident" id="2408497">node</span><span class="op" id="2408501">.</span><span class="ident" id="2408502">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408509">}</span>&nbsp;<span class="keyword" id="2408511">else</span>&nbsp;<span class="op" id="2408516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408521">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408529">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2408532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2408535">return</span><br>
<span class="lineno"></span><span class="op" id="2408542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2408545">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2408596">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2408656">type</span>&nbsp;<span class="ident" id="2408661">genericReplacer</span>&nbsp;<span class="keyword" id="2408677">struct</span>&nbsp;<span class="op" id="2408684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408687">root</span>&nbsp;<span class="ident" id="2408692">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2408702">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2408776">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408801">tableSize</span>&nbsp;<span class="builtintype" id="2408811">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2408816">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408885">mapping</span>&nbsp;<span class="op" id="2408893">[</span><span class="num" id="2408894">256</span><span class="op" id="2408897">]</span><span class="builtintype" id="2408898">byte</span><br>
<span class="lineno"></span><span class="op" id="2408903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2408906">func</span>&nbsp;<span class="ident" id="2408911">makeGenericReplacer</span><span class="op" id="2408930">(</span><span class="ident" id="2408931">oldnew</span>&nbsp;<span class="op" id="2408938">[</span><span class="op" id="2408939">]</span><span class="builtintype" id="2408940">string</span><span class="op" id="2408946">)</span>&nbsp;<span class="op" id="2408948">*</span><span class="ident" id="2408949">genericReplacer</span>&nbsp;<span class="op" id="2408965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2408968">r</span>&nbsp;<span class="op" id="2408970">:=</span>&nbsp;<span class="builtinfunc" id="2408973">new</span><span class="op" id="2408976">(</span><span class="ident" id="2408977">genericReplacer</span><span class="op" id="2408992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2408995">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409052">for</span>&nbsp;<span class="ident" id="2409056">i</span>&nbsp;<span class="op" id="2409058">:=</span>&nbsp;<span class="num" id="2409061">0</span><span class="op" id="2409062">;</span>&nbsp;<span class="ident" id="2409064">i</span>&nbsp;<span class="op" id="2409066">&lt;</span>&nbsp;<span class="builtinfunc" id="2409068">len</span><span class="op" id="2409071">(</span><span class="ident" id="2409072">oldnew</span><span class="op" id="2409078">)</span><span class="op" id="2409079">;</span>&nbsp;<span class="ident" id="2409081">i</span>&nbsp;<span class="op" id="2409083">+=</span>&nbsp;<span class="num" id="2409086">2</span>&nbsp;<span class="op" id="2409088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409092">key</span>&nbsp;<span class="op" id="2409096">:=</span>&nbsp;<span class="ident" id="2409099">oldnew</span><span class="op" id="2409105">[</span><span class="ident" id="2409106">i</span><span class="op" id="2409107">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409111">for</span>&nbsp;<span class="ident" id="2409115">j</span>&nbsp;<span class="op" id="2409117">:=</span>&nbsp;<span class="num" id="2409120">0</span><span class="op" id="2409121">;</span>&nbsp;<span class="ident" id="2409123">j</span>&nbsp;<span class="op" id="2409125">&lt;</span>&nbsp;<span class="builtinfunc" id="2409127">len</span><span class="op" id="2409130">(</span><span class="ident" id="2409131">key</span><span class="op" id="2409134">)</span><span class="op" id="2409135">;</span>&nbsp;<span class="ident" id="2409137">j</span><span class="op" id="2409138">++</span>&nbsp;<span class="op" id="2409141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409146">r</span><span class="op" id="2409147">.</span><span class="ident" id="2409148">mapping</span><span class="op" id="2409155">[</span><span class="ident" id="2409156">key</span><span class="op" id="2409159">[</span><span class="ident" id="2409160">j</span><span class="op" id="2409161">]</span><span class="op" id="2409162">]</span>&nbsp;<span class="op" id="2409164">=</span>&nbsp;<span class="num" id="2409166">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409177">for</span>&nbsp;<span class="ident" id="2409181">_</span><span class="op" id="2409182">,</span>&nbsp;<span class="ident" id="2409184">b</span>&nbsp;<span class="op" id="2409186">:=</span>&nbsp;<span class="keyword" id="2409189">range</span>&nbsp;<span class="ident" id="2409195">r</span><span class="op" id="2409196">.</span><span class="ident" id="2409197">mapping</span>&nbsp;<span class="op" id="2409205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409209">r</span><span class="op" id="2409210">.</span><span class="ident" id="2409211">tableSize</span>&nbsp;<span class="op" id="2409221">+=</span>&nbsp;<span class="builtintype" id="2409224">int</span><span class="op" id="2409227">(</span><span class="ident" id="2409228">b</span><span class="op" id="2409229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409236">var</span>&nbsp;<span class="ident" id="2409240">index</span>&nbsp;<span class="builtintype" id="2409246">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409252">for</span>&nbsp;<span class="ident" id="2409256">i</span><span class="op" id="2409257">,</span>&nbsp;<span class="ident" id="2409259">b</span>&nbsp;<span class="op" id="2409261">:=</span>&nbsp;<span class="keyword" id="2409264">range</span>&nbsp;<span class="ident" id="2409270">r</span><span class="op" id="2409271">.</span><span class="ident" id="2409272">mapping</span>&nbsp;<span class="op" id="2409280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409284">if</span>&nbsp;<span class="ident" id="2409287">b</span>&nbsp;<span class="op" id="2409289">==</span>&nbsp;<span class="num" id="2409292">0</span>&nbsp;<span class="op" id="2409294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409299">r</span><span class="op" id="2409300">.</span><span class="ident" id="2409301">mapping</span><span class="op" id="2409308">[</span><span class="ident" id="2409309">i</span><span class="op" id="2409310">]</span>&nbsp;<span class="op" id="2409312">=</span>&nbsp;<span class="builtintype" id="2409314">byte</span><span class="op" id="2409318">(</span><span class="ident" id="2409319">r</span><span class="op" id="2409320">.</span><span class="ident" id="2409321">tableSize</span><span class="op" id="2409330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409334">}</span>&nbsp;<span class="keyword" id="2409336">else</span>&nbsp;<span class="op" id="2409341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409346">r</span><span class="op" id="2409347">.</span><span class="ident" id="2409348">mapping</span><span class="op" id="2409355">[</span><span class="ident" id="2409356">i</span><span class="op" id="2409357">]</span>&nbsp;<span class="op" id="2409359">=</span>&nbsp;<span class="ident" id="2409361">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409370">index</span><span class="op" id="2409375">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2409386">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409446">r</span><span class="op" id="2409447">.</span><span class="ident" id="2409448">root</span><span class="op" id="2409452">.</span><span class="ident" id="2409453">table</span>&nbsp;<span class="op" id="2409459">=</span>&nbsp;<span class="builtinfunc" id="2409461">make</span><span class="op" id="2409465">(</span><span class="op" id="2409466">[</span><span class="op" id="2409467">]</span><span class="op" id="2409468">*</span><span class="ident" id="2409469">trieNode</span><span class="op" id="2409477">,</span>&nbsp;<span class="ident" id="2409479">r</span><span class="op" id="2409480">.</span><span class="ident" id="2409481">tableSize</span><span class="op" id="2409490">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409494">for</span>&nbsp;<span class="ident" id="2409498">i</span>&nbsp;<span class="op" id="2409500">:=</span>&nbsp;<span class="num" id="2409503">0</span><span class="op" id="2409504">;</span>&nbsp;<span class="ident" id="2409506">i</span>&nbsp;<span class="op" id="2409508">&lt;</span>&nbsp;<span class="builtinfunc" id="2409510">len</span><span class="op" id="2409513">(</span><span class="ident" id="2409514">oldnew</span><span class="op" id="2409520">)</span><span class="op" id="2409521">;</span>&nbsp;<span class="ident" id="2409523">i</span>&nbsp;<span class="op" id="2409525">+=</span>&nbsp;<span class="num" id="2409528">2</span>&nbsp;<span class="op" id="2409530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2409534">r</span><span class="op" id="2409535">.</span><span class="ident" id="2409536">root</span><span class="op" id="2409540">.</span><span class="ident" id="2409541">add</span><span class="op" id="2409544">(</span><span class="ident" id="2409545">oldnew</span><span class="op" id="2409551">[</span><span class="ident" id="2409552">i</span><span class="op" id="2409553">]</span><span class="op" id="2409554">,</span>&nbsp;<span class="ident" id="2409556">oldnew</span><span class="op" id="2409562">[</span><span class="ident" id="2409563">i</span><span class="op" id="2409564">+</span><span class="num" id="2409565">1</span><span class="op" id="2409566">]</span><span class="op" id="2409567">,</span>&nbsp;<span class="builtinfunc" id="2409569">len</span><span class="op" id="2409572">(</span><span class="ident" id="2409573">oldnew</span><span class="op" id="2409579">)</span><span class="op" id="2409580">-</span><span class="ident" id="2409581">i</span><span class="op" id="2409582">,</span>&nbsp;<span class="ident" id="2409584">r</span><span class="op" id="2409585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409591">return</span>&nbsp;<span class="ident" id="2409598">r</span><br>
<span class="lineno">270</span><span class="op" id="2409600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2409603">type</span>&nbsp;<span class="ident" id="2409608">appendSliceWriter</span>&nbsp;<span class="op" id="2409626">[</span><span class="op" id="2409627">]</span><span class="builtintype" id="2409628">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2409634">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2409686">func</span>&nbsp;<span class="op" id="2409691">(</span><span class="ident" id="2409692">w</span>&nbsp;<span class="op" id="2409694">*</span><span class="ident" id="2409695">appendSliceWriter</span><span class="op" id="2409712">)</span>&nbsp;<span class="ident" id="2409714">Write</span><span class="op" id="2409719">(</span><span class="ident" id="2409720">p</span>&nbsp;<span class="op" id="2409722">[</span><span class="op" id="2409723">]</span><span class="builtintype" id="2409724">byte</span><span class="op" id="2409728">)</span>&nbsp;<span class="op" id="2409730">(</span><span class="builtintype" id="2409731">int</span><span class="op" id="2409734">,</span>&nbsp;<span class="builtintype" id="2409736">error</span><span class="op" id="2409741">)</span>&nbsp;<span class="op" id="2409743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409746">*</span><span class="ident" id="2409747">w</span>&nbsp;<span class="op" id="2409749">=</span>&nbsp;<span class="builtinfunc" id="2409751">append</span><span class="op" id="2409757">(</span><span class="op" id="2409758">*</span><span class="ident" id="2409759">w</span><span class="op" id="2409760">,</span>&nbsp;<span class="ident" id="2409762">p</span><span class="op" id="2409763">...</span><span class="op" id="2409766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409769">return</span>&nbsp;<span class="builtinfunc" id="2409776">len</span><span class="op" id="2409779">(</span><span class="ident" id="2409780">p</span><span class="op" id="2409781">)</span><span class="op" id="2409782">,</span>&nbsp;<span class="ident" id="2409784">nil</span><br>
<span class="lineno"></span><span class="op" id="2409788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2409791">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2409871">func</span>&nbsp;<span class="op" id="2409876">(</span><span class="ident" id="2409877">w</span>&nbsp;<span class="op" id="2409879">*</span><span class="ident" id="2409880">appendSliceWriter</span><span class="op" id="2409897">)</span>&nbsp;<span class="ident" id="2409899">WriteString</span><span class="op" id="2409910">(</span><span class="ident" id="2409911">s</span>&nbsp;<span class="builtintype" id="2409913">string</span><span class="op" id="2409919">)</span>&nbsp;<span class="op" id="2409921">(</span><span class="builtintype" id="2409922">int</span><span class="op" id="2409925">,</span>&nbsp;<span class="builtintype" id="2409927">error</span><span class="op" id="2409932">)</span>&nbsp;<span class="op" id="2409934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2409937">*</span><span class="ident" id="2409938">w</span>&nbsp;<span class="op" id="2409940">=</span>&nbsp;<span class="builtinfunc" id="2409942">append</span><span class="op" id="2409948">(</span><span class="op" id="2409949">*</span><span class="ident" id="2409950">w</span><span class="op" id="2409951">,</span>&nbsp;<span class="ident" id="2409953">s</span><span class="op" id="2409954">...</span><span class="op" id="2409957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2409960">return</span>&nbsp;<span class="builtinfunc" id="2409967">len</span><span class="op" id="2409970">(</span><span class="ident" id="2409971">s</span><span class="op" id="2409972">)</span><span class="op" id="2409973">,</span>&nbsp;<span class="ident" id="2409975">nil</span><br>
<span class="lineno"></span><span class="op" id="2409979">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2409982">type</span>&nbsp;<span class="ident" id="2409987">stringWriterIface</span>&nbsp;<span class="keyword" id="2410005">interface</span>&nbsp;<span class="op" id="2410015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410018">WriteString</span><span class="op" id="2410029">(</span><span class="builtintype" id="2410030">string</span><span class="op" id="2410036">)</span>&nbsp;<span class="op" id="2410038">(</span><span class="builtintype" id="2410039">int</span><span class="op" id="2410042">,</span>&nbsp;<span class="builtintype" id="2410044">error</span><span class="op" id="2410049">)</span><br>
<span class="lineno"></span><span class="op" id="2410051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2410054">type</span>&nbsp;<span class="ident" id="2410059">stringWriter</span>&nbsp;<span class="keyword" id="2410072">struct</span>&nbsp;<span class="op" id="2410079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410082">w</span>&nbsp;<span class="ident" id="2410084">io</span><span class="op" id="2410086">.</span><span class="ident" id="2410087">Writer</span><br>
<span class="lineno"></span><span class="op" id="2410094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2410097">func</span>&nbsp;<span class="op" id="2410102">(</span><span class="ident" id="2410103">w</span>&nbsp;<span class="ident" id="2410105">stringWriter</span><span class="op" id="2410117">)</span>&nbsp;<span class="ident" id="2410119">WriteString</span><span class="op" id="2410130">(</span><span class="ident" id="2410131">s</span>&nbsp;<span class="builtintype" id="2410133">string</span><span class="op" id="2410139">)</span>&nbsp;<span class="op" id="2410141">(</span><span class="builtintype" id="2410142">int</span><span class="op" id="2410145">,</span>&nbsp;<span class="builtintype" id="2410147">error</span><span class="op" id="2410152">)</span>&nbsp;<span class="op" id="2410154">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410157">return</span>&nbsp;<span class="ident" id="2410164">w</span><span class="op" id="2410165">.</span><span class="ident" id="2410166">w</span><span class="op" id="2410167">.</span><span class="ident" id="2410168">Write</span><span class="op" id="2410173">(</span><span class="op" id="2410174">[</span><span class="op" id="2410175">]</span><span class="builtintype" id="2410176">byte</span><span class="op" id="2410180">(</span><span class="ident" id="2410181">s</span><span class="op" id="2410182">)</span><span class="op" id="2410183">)</span><br>
<span class="lineno"></span><span class="op" id="2410185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2410188">func</span>&nbsp;<span class="ident" id="2410193">getStringWriter</span><span class="op" id="2410208">(</span><span class="ident" id="2410209">w</span>&nbsp;<span class="ident" id="2410211">io</span><span class="op" id="2410213">.</span><span class="ident" id="2410214">Writer</span><span class="op" id="2410220">)</span>&nbsp;<span class="ident" id="2410222">stringWriterIface</span>&nbsp;<span class="op" id="2410240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410243">sw</span><span class="op" id="2410245">,</span>&nbsp;<span class="ident" id="2410247">ok</span>&nbsp;<span class="op" id="2410250">:=</span>&nbsp;<span class="ident" id="2410253">w</span><span class="op" id="2410254">.</span><span class="op" id="2410255">(</span><span class="ident" id="2410256">stringWriterIface</span><span class="op" id="2410273">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410276">if</span>&nbsp;<span class="op" id="2410279">!</span><span class="ident" id="2410280">ok</span>&nbsp;<span class="op" id="2410283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410287">sw</span>&nbsp;<span class="op" id="2410290">=</span>&nbsp;<span class="ident" id="2410292">stringWriter</span><span class="op" id="2410304">{</span><span class="ident" id="2410305">w</span><span class="op" id="2410306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2410309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410312">return</span>&nbsp;<span class="ident" id="2410319">sw</span><br>
<span class="lineno"></span><span class="op" id="2410322">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2410325">func</span>&nbsp;<span class="op" id="2410330">(</span><span class="ident" id="2410331">r</span>&nbsp;<span class="op" id="2410333">*</span><span class="ident" id="2410334">genericReplacer</span><span class="op" id="2410349">)</span>&nbsp;<span class="ident" id="2410351">Replace</span><span class="op" id="2410358">(</span><span class="ident" id="2410359">s</span>&nbsp;<span class="builtintype" id="2410361">string</span><span class="op" id="2410367">)</span>&nbsp;<span class="builtintype" id="2410369">string</span>&nbsp;<span class="op" id="2410376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410379">buf</span>&nbsp;<span class="op" id="2410383">:=</span>&nbsp;<span class="builtinfunc" id="2410386">make</span><span class="op" id="2410390">(</span><span class="ident" id="2410391">appendSliceWriter</span><span class="op" id="2410408">,</span>&nbsp;<span class="num" id="2410410">0</span><span class="op" id="2410411">,</span>&nbsp;<span class="builtinfunc" id="2410413">len</span><span class="op" id="2410416">(</span><span class="ident" id="2410417">s</span><span class="op" id="2410418">)</span><span class="op" id="2410419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410422">r</span><span class="op" id="2410423">.</span><span class="ident" id="2410424">WriteString</span><span class="op" id="2410435">(</span><span class="op" id="2410436">&amp;</span><span class="ident" id="2410437">buf</span><span class="op" id="2410440">,</span>&nbsp;<span class="ident" id="2410442">s</span><span class="op" id="2410443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410446">return</span>&nbsp;<span class="builtintype" id="2410453">string</span><span class="op" id="2410459">(</span><span class="ident" id="2410460">buf</span><span class="op" id="2410463">)</span><br>
<span class="lineno">310</span><span class="op" id="2410465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2410468">func</span>&nbsp;<span class="op" id="2410473">(</span><span class="ident" id="2410474">r</span>&nbsp;<span class="op" id="2410476">*</span><span class="ident" id="2410477">genericReplacer</span><span class="op" id="2410492">)</span>&nbsp;<span class="ident" id="2410494">WriteString</span><span class="op" id="2410505">(</span><span class="ident" id="2410506">w</span>&nbsp;<span class="ident" id="2410508">io</span><span class="op" id="2410510">.</span><span class="ident" id="2410511">Writer</span><span class="op" id="2410517">,</span>&nbsp;<span class="ident" id="2410519">s</span>&nbsp;<span class="builtintype" id="2410521">string</span><span class="op" id="2410527">)</span>&nbsp;<span class="op" id="2410529">(</span><span class="ident" id="2410530">n</span>&nbsp;<span class="builtintype" id="2410532">int</span><span class="op" id="2410535">,</span>&nbsp;<span class="ident" id="2410537">err</span>&nbsp;<span class="builtintype" id="2410541">error</span><span class="op" id="2410546">)</span>&nbsp;<span class="op" id="2410548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410551">sw</span>&nbsp;<span class="op" id="2410554">:=</span>&nbsp;<span class="ident" id="2410557">getStringWriter</span><span class="op" id="2410572">(</span><span class="ident" id="2410573">w</span><span class="op" id="2410574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410577">var</span>&nbsp;<span class="ident" id="2410581">last</span><span class="op" id="2410585">,</span>&nbsp;<span class="ident" id="2410587">wn</span>&nbsp;<span class="builtintype" id="2410590">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410595">var</span>&nbsp;<span class="ident" id="2410599">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2410614">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410620">for</span>&nbsp;<span class="ident" id="2410624">i</span>&nbsp;<span class="op" id="2410626">:=</span>&nbsp;<span class="num" id="2410629">0</span><span class="op" id="2410630">;</span>&nbsp;<span class="ident" id="2410632">i</span>&nbsp;<span class="op" id="2410634">&lt;=</span>&nbsp;<span class="builtinfunc" id="2410637">len</span><span class="op" id="2410640">(</span><span class="ident" id="2410641">s</span><span class="op" id="2410642">)</span><span class="op" id="2410643">;</span>&nbsp;<span class="op" id="2410645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2410649">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410702">if</span>&nbsp;<span class="ident" id="2410705">i</span>&nbsp;<span class="op" id="2410707">!=</span>&nbsp;<span class="builtinfunc" id="2410710">len</span><span class="op" id="2410713">(</span><span class="ident" id="2410714">s</span><span class="op" id="2410715">)</span>&nbsp;<span class="op" id="2410717">&amp;&amp;</span>&nbsp;<span class="ident" id="2410720">r</span><span class="op" id="2410721">.</span><span class="ident" id="2410722">root</span><span class="op" id="2410726">.</span><span class="ident" id="2410727">priority</span>&nbsp;<span class="op" id="2410736">==</span>&nbsp;<span class="num" id="2410739">0</span>&nbsp;<span class="op" id="2410741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410746">index</span>&nbsp;<span class="op" id="2410752">:=</span>&nbsp;<span class="builtintype" id="2410755">int</span><span class="op" id="2410758">(</span><span class="ident" id="2410759">r</span><span class="op" id="2410760">.</span><span class="ident" id="2410761">mapping</span><span class="op" id="2410768">[</span><span class="ident" id="2410769">s</span><span class="op" id="2410770">[</span><span class="ident" id="2410771">i</span><span class="op" id="2410772">]</span><span class="op" id="2410773">]</span><span class="op" id="2410774">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410779">if</span>&nbsp;<span class="ident" id="2410782">index</span>&nbsp;<span class="op" id="2410788">==</span>&nbsp;<span class="ident" id="2410791">r</span><span class="op" id="2410792">.</span><span class="ident" id="2410793">tableSize</span>&nbsp;<span class="op" id="2410803">||</span>&nbsp;<span class="ident" id="2410806">r</span><span class="op" id="2410807">.</span><span class="ident" id="2410808">root</span><span class="op" id="2410812">.</span><span class="ident" id="2410813">table</span><span class="op" id="2410818">[</span><span class="ident" id="2410819">index</span><span class="op" id="2410824">]</span>&nbsp;<span class="op" id="2410826">==</span>&nbsp;<span class="ident" id="2410829">nil</span>&nbsp;<span class="op" id="2410833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410839">i</span><span class="op" id="2410840">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2410847">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2410859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2410863">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2410868">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410941">val</span><span class="op" id="2410944">,</span>&nbsp;<span class="ident" id="2410946">keylen</span><span class="op" id="2410952">,</span>&nbsp;<span class="ident" id="2410954">match</span>&nbsp;<span class="op" id="2410960">:=</span>&nbsp;<span class="ident" id="2410963">r</span><span class="op" id="2410964">.</span><span class="ident" id="2410965">lookup</span><span class="op" id="2410971">(</span><span class="ident" id="2410972">s</span><span class="op" id="2410973">[</span><span class="ident" id="2410974">i</span><span class="op" id="2410975">:</span><span class="op" id="2410976">]</span><span class="op" id="2410977">,</span>&nbsp;<span class="ident" id="2410979">prevMatchEmpty</span><span class="op" id="2410993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2410997">prevMatchEmpty</span>&nbsp;<span class="op" id="2411012">=</span>&nbsp;<span class="ident" id="2411014">match</span>&nbsp;<span class="op" id="2411020">&amp;&amp;</span>&nbsp;<span class="ident" id="2411023">keylen</span>&nbsp;<span class="op" id="2411030">==</span>&nbsp;<span class="num" id="2411033">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411037">if</span>&nbsp;<span class="ident" id="2411040">match</span>&nbsp;<span class="op" id="2411046">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411051">wn</span><span class="op" id="2411053">,</span>&nbsp;<span class="ident" id="2411055">err</span>&nbsp;<span class="op" id="2411059">=</span>&nbsp;<span class="ident" id="2411061">sw</span><span class="op" id="2411063">.</span><span class="ident" id="2411064">WriteString</span><span class="op" id="2411075">(</span><span class="ident" id="2411076">s</span><span class="op" id="2411077">[</span><span class="ident" id="2411078">last</span><span class="op" id="2411082">:</span><span class="ident" id="2411083">i</span><span class="op" id="2411084">]</span><span class="op" id="2411085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411090">n</span>&nbsp;<span class="op" id="2411092">+=</span>&nbsp;<span class="ident" id="2411095">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411101">if</span>&nbsp;<span class="ident" id="2411104">err</span>&nbsp;<span class="op" id="2411108">!=</span>&nbsp;<span class="ident" id="2411111">nil</span>&nbsp;<span class="op" id="2411115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411121">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2411131">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411136">wn</span><span class="op" id="2411138">,</span>&nbsp;<span class="ident" id="2411140">err</span>&nbsp;<span class="op" id="2411144">=</span>&nbsp;<span class="ident" id="2411146">sw</span><span class="op" id="2411148">.</span><span class="ident" id="2411149">WriteString</span><span class="op" id="2411160">(</span><span class="ident" id="2411161">val</span><span class="op" id="2411164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411169">n</span>&nbsp;<span class="op" id="2411171">+=</span>&nbsp;<span class="ident" id="2411174">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411180">if</span>&nbsp;<span class="ident" id="2411183">err</span>&nbsp;<span class="op" id="2411187">!=</span>&nbsp;<span class="ident" id="2411190">nil</span>&nbsp;<span class="op" id="2411194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411200">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2411210">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411215">i</span>&nbsp;<span class="op" id="2411217">+=</span>&nbsp;<span class="ident" id="2411220">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411230">last</span>&nbsp;<span class="op" id="2411235">=</span>&nbsp;<span class="ident" id="2411237">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411242">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2411253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411257">i</span><span class="op" id="2411258">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2411262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411265">if</span>&nbsp;<span class="ident" id="2411268">last</span>&nbsp;<span class="op" id="2411273">!=</span>&nbsp;<span class="builtinfunc" id="2411276">len</span><span class="op" id="2411279">(</span><span class="ident" id="2411280">s</span><span class="op" id="2411281">)</span>&nbsp;<span class="op" id="2411283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411287">wn</span><span class="op" id="2411289">,</span>&nbsp;<span class="ident" id="2411291">err</span>&nbsp;<span class="op" id="2411295">=</span>&nbsp;<span class="ident" id="2411297">sw</span><span class="op" id="2411299">.</span><span class="ident" id="2411300">WriteString</span><span class="op" id="2411311">(</span><span class="ident" id="2411312">s</span><span class="op" id="2411313">[</span><span class="ident" id="2411314">last</span><span class="op" id="2411318">:</span><span class="op" id="2411319">]</span><span class="op" id="2411320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411324">n</span>&nbsp;<span class="op" id="2411326">+=</span>&nbsp;<span class="ident" id="2411329">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2411333">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411336">return</span><br>
<span class="lineno"></span><span class="op" id="2411343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2411346">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2411423">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2411490">type</span>&nbsp;<span class="ident" id="2411495">singleStringReplacer</span>&nbsp;<span class="keyword" id="2411516">struct</span>&nbsp;<span class="op" id="2411523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411526">finder</span>&nbsp;<span class="op" id="2411533">*</span><span class="ident" id="2411534">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2411548">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411620">value</span>&nbsp;<span class="builtintype" id="2411626">string</span><br>
<span class="lineno"></span><span class="op" id="2411633">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2411636">func</span>&nbsp;<span class="ident" id="2411641">makeSingleStringReplacer</span><span class="op" id="2411665">(</span><span class="ident" id="2411666">pattern</span>&nbsp;<span class="builtintype" id="2411674">string</span><span class="op" id="2411680">,</span>&nbsp;<span class="ident" id="2411682">value</span>&nbsp;<span class="builtintype" id="2411688">string</span><span class="op" id="2411694">)</span>&nbsp;<span class="op" id="2411696">*</span><span class="ident" id="2411697">singleStringReplacer</span>&nbsp;<span class="op" id="2411718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411721">return</span>&nbsp;<span class="op" id="2411728">&amp;</span><span class="ident" id="2411729">singleStringReplacer</span><span class="op" id="2411749">{</span><span class="ident" id="2411750">finder</span><span class="op" id="2411756">:</span>&nbsp;<span class="ident" id="2411758">makeStringFinder</span><span class="op" id="2411774">(</span><span class="ident" id="2411775">pattern</span><span class="op" id="2411782">)</span><span class="op" id="2411783">,</span>&nbsp;<span class="ident" id="2411785">value</span><span class="op" id="2411790">:</span>&nbsp;<span class="ident" id="2411792">value</span><span class="op" id="2411797">}</span><br>
<span class="lineno"></span><span class="op" id="2411799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2411802">func</span>&nbsp;<span class="op" id="2411807">(</span><span class="ident" id="2411808">r</span>&nbsp;<span class="op" id="2411810">*</span><span class="ident" id="2411811">singleStringReplacer</span><span class="op" id="2411831">)</span>&nbsp;<span class="ident" id="2411833">Replace</span><span class="op" id="2411840">(</span><span class="ident" id="2411841">s</span>&nbsp;<span class="builtintype" id="2411843">string</span><span class="op" id="2411849">)</span>&nbsp;<span class="builtintype" id="2411851">string</span>&nbsp;<span class="op" id="2411858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411861">var</span>&nbsp;<span class="ident" id="2411865">buf</span>&nbsp;<span class="op" id="2411869">[</span><span class="op" id="2411870">]</span><span class="builtintype" id="2411871">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411877">i</span><span class="op" id="2411878">,</span>&nbsp;<span class="ident" id="2411880">matched</span>&nbsp;<span class="op" id="2411888">:=</span>&nbsp;<span class="num" id="2411891">0</span><span class="op" id="2411892">,</span>&nbsp;<span class="builtintype" id="2411894">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411901">for</span>&nbsp;<span class="op" id="2411905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411909">match</span>&nbsp;<span class="op" id="2411915">:=</span>&nbsp;<span class="ident" id="2411918">r</span><span class="op" id="2411919">.</span><span class="ident" id="2411920">finder</span><span class="op" id="2411926">.</span><span class="ident" id="2411927">next</span><span class="op" id="2411931">(</span><span class="ident" id="2411932">s</span><span class="op" id="2411933">[</span><span class="ident" id="2411934">i</span><span class="op" id="2411935">:</span><span class="op" id="2411936">]</span><span class="op" id="2411937">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411941">if</span>&nbsp;<span class="ident" id="2411944">match</span>&nbsp;<span class="op" id="2411950">==</span>&nbsp;<span class="op" id="2411953">-</span><span class="num" id="2411954">1</span>&nbsp;<span class="op" id="2411956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2411961">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2411969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411973">matched</span>&nbsp;<span class="op" id="2411981">=</span>&nbsp;<span class="builtintype" id="2411983">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2411990">buf</span>&nbsp;<span class="op" id="2411994">=</span>&nbsp;<span class="builtinfunc" id="2411996">append</span><span class="op" id="2412002">(</span><span class="ident" id="2412003">buf</span><span class="op" id="2412006">,</span>&nbsp;<span class="ident" id="2412008">s</span><span class="op" id="2412009">[</span><span class="ident" id="2412010">i</span><span class="op" id="2412011">:</span><span class="ident" id="2412012">i</span><span class="op" id="2412013">+</span><span class="ident" id="2412014">match</span><span class="op" id="2412019">]</span><span class="op" id="2412020">...</span><span class="op" id="2412023">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412027">buf</span>&nbsp;<span class="op" id="2412031">=</span>&nbsp;<span class="builtinfunc" id="2412033">append</span><span class="op" id="2412039">(</span><span class="ident" id="2412040">buf</span><span class="op" id="2412043">,</span>&nbsp;<span class="ident" id="2412045">r</span><span class="op" id="2412046">.</span><span class="ident" id="2412047">value</span><span class="op" id="2412052">...</span><span class="op" id="2412055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412059">i</span>&nbsp;<span class="op" id="2412061">+=</span>&nbsp;<span class="ident" id="2412064">match</span>&nbsp;<span class="op" id="2412070">+</span>&nbsp;<span class="builtinfunc" id="2412072">len</span><span class="op" id="2412075">(</span><span class="ident" id="2412076">r</span><span class="op" id="2412077">.</span><span class="ident" id="2412078">finder</span><span class="op" id="2412084">.</span><span class="ident" id="2412085">pattern</span><span class="op" id="2412092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2412095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412098">if</span>&nbsp;<span class="op" id="2412101">!</span><span class="ident" id="2412102">matched</span>&nbsp;<span class="op" id="2412110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412114">return</span>&nbsp;<span class="ident" id="2412121">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2412124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412127">buf</span>&nbsp;<span class="op" id="2412131">=</span>&nbsp;<span class="builtinfunc" id="2412133">append</span><span class="op" id="2412139">(</span><span class="ident" id="2412140">buf</span><span class="op" id="2412143">,</span>&nbsp;<span class="ident" id="2412145">s</span><span class="op" id="2412146">[</span><span class="ident" id="2412147">i</span><span class="op" id="2412148">:</span><span class="op" id="2412149">]</span><span class="op" id="2412150">...</span><span class="op" id="2412153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412156">return</span>&nbsp;<span class="builtintype" id="2412163">string</span><span class="op" id="2412169">(</span><span class="ident" id="2412170">buf</span><span class="op" id="2412173">)</span><br>
<span class="lineno"></span><span class="op" id="2412175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2412178">func</span>&nbsp;<span class="op" id="2412183">(</span><span class="ident" id="2412184">r</span>&nbsp;<span class="op" id="2412186">*</span><span class="ident" id="2412187">singleStringReplacer</span><span class="op" id="2412207">)</span>&nbsp;<span class="ident" id="2412209">WriteString</span><span class="op" id="2412220">(</span><span class="ident" id="2412221">w</span>&nbsp;<span class="ident" id="2412223">io</span><span class="op" id="2412225">.</span><span class="ident" id="2412226">Writer</span><span class="op" id="2412232">,</span>&nbsp;<span class="ident" id="2412234">s</span>&nbsp;<span class="builtintype" id="2412236">string</span><span class="op" id="2412242">)</span>&nbsp;<span class="op" id="2412244">(</span><span class="ident" id="2412245">n</span>&nbsp;<span class="builtintype" id="2412247">int</span><span class="op" id="2412250">,</span>&nbsp;<span class="ident" id="2412252">err</span>&nbsp;<span class="builtintype" id="2412256">error</span><span class="op" id="2412261">)</span>&nbsp;<span class="op" id="2412263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412266">sw</span>&nbsp;<span class="op" id="2412269">:=</span>&nbsp;<span class="ident" id="2412272">getStringWriter</span><span class="op" id="2412287">(</span><span class="ident" id="2412288">w</span><span class="op" id="2412289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412292">var</span>&nbsp;<span class="ident" id="2412296">i</span><span class="op" id="2412297">,</span>&nbsp;<span class="ident" id="2412299">wn</span>&nbsp;<span class="builtintype" id="2412302">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412307">for</span>&nbsp;<span class="op" id="2412311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412315">match</span>&nbsp;<span class="op" id="2412321">:=</span>&nbsp;<span class="ident" id="2412324">r</span><span class="op" id="2412325">.</span><span class="ident" id="2412326">finder</span><span class="op" id="2412332">.</span><span class="ident" id="2412333">next</span><span class="op" id="2412337">(</span><span class="ident" id="2412338">s</span><span class="op" id="2412339">[</span><span class="ident" id="2412340">i</span><span class="op" id="2412341">:</span><span class="op" id="2412342">]</span><span class="op" id="2412343">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412347">if</span>&nbsp;<span class="ident" id="2412350">match</span>&nbsp;<span class="op" id="2412356">==</span>&nbsp;<span class="op" id="2412359">-</span><span class="num" id="2412360">1</span>&nbsp;<span class="op" id="2412362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412367">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2412375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412379">wn</span><span class="op" id="2412381">,</span>&nbsp;<span class="ident" id="2412383">err</span>&nbsp;<span class="op" id="2412387">=</span>&nbsp;<span class="ident" id="2412389">sw</span><span class="op" id="2412391">.</span><span class="ident" id="2412392">WriteString</span><span class="op" id="2412403">(</span><span class="ident" id="2412404">s</span><span class="op" id="2412405">[</span><span class="ident" id="2412406">i</span>&nbsp;<span class="op" id="2412408">:</span>&nbsp;<span class="ident" id="2412410">i</span><span class="op" id="2412411">+</span><span class="ident" id="2412412">match</span><span class="op" id="2412417">]</span><span class="op" id="2412418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412422">n</span>&nbsp;<span class="op" id="2412424">+=</span>&nbsp;<span class="ident" id="2412427">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412432">if</span>&nbsp;<span class="ident" id="2412435">err</span>&nbsp;<span class="op" id="2412439">!=</span>&nbsp;<span class="ident" id="2412442">nil</span>&nbsp;<span class="op" id="2412446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412451">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2412460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412464">wn</span><span class="op" id="2412466">,</span>&nbsp;<span class="ident" id="2412468">err</span>&nbsp;<span class="op" id="2412472">=</span>&nbsp;<span class="ident" id="2412474">sw</span><span class="op" id="2412476">.</span><span class="ident" id="2412477">WriteString</span><span class="op" id="2412488">(</span><span class="ident" id="2412489">r</span><span class="op" id="2412490">.</span><span class="ident" id="2412491">value</span><span class="op" id="2412496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412500">n</span>&nbsp;<span class="op" id="2412502">+=</span>&nbsp;<span class="ident" id="2412505">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412510">if</span>&nbsp;<span class="ident" id="2412513">err</span>&nbsp;<span class="op" id="2412517">!=</span>&nbsp;<span class="ident" id="2412520">nil</span>&nbsp;<span class="op" id="2412524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412529">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2412538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412542">i</span>&nbsp;<span class="op" id="2412544">+=</span>&nbsp;<span class="ident" id="2412547">match</span>&nbsp;<span class="op" id="2412553">+</span>&nbsp;<span class="builtinfunc" id="2412555">len</span><span class="op" id="2412558">(</span><span class="ident" id="2412559">r</span><span class="op" id="2412560">.</span><span class="ident" id="2412561">finder</span><span class="op" id="2412567">.</span><span class="ident" id="2412568">pattern</span><span class="op" id="2412575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2412578">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412581">wn</span><span class="op" id="2412583">,</span>&nbsp;<span class="ident" id="2412585">err</span>&nbsp;<span class="op" id="2412589">=</span>&nbsp;<span class="ident" id="2412591">sw</span><span class="op" id="2412593">.</span><span class="ident" id="2412594">WriteString</span><span class="op" id="2412605">(</span><span class="ident" id="2412606">s</span><span class="op" id="2412607">[</span><span class="ident" id="2412608">i</span><span class="op" id="2412609">:</span><span class="op" id="2412610">]</span><span class="op" id="2412611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412614">n</span>&nbsp;<span class="op" id="2412616">+=</span>&nbsp;<span class="ident" id="2412619">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412623">return</span><br>
<span class="lineno"></span><span class="op" id="2412630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2412633">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2412702">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2412746">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2412807">type</span>&nbsp;<span class="ident" id="2412812">byteReplacer</span>&nbsp;<span class="op" id="2412825">[</span><span class="num" id="2412826">256</span><span class="op" id="2412829">]</span><span class="builtintype" id="2412830">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2412836">func</span>&nbsp;<span class="op" id="2412841">(</span><span class="ident" id="2412842">r</span>&nbsp;<span class="op" id="2412844">*</span><span class="ident" id="2412845">byteReplacer</span><span class="op" id="2412857">)</span>&nbsp;<span class="ident" id="2412859">Replace</span><span class="op" id="2412866">(</span><span class="ident" id="2412867">s</span>&nbsp;<span class="builtintype" id="2412869">string</span><span class="op" id="2412875">)</span>&nbsp;<span class="builtintype" id="2412877">string</span>&nbsp;<span class="op" id="2412884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412887">var</span>&nbsp;<span class="ident" id="2412891">buf</span>&nbsp;<span class="op" id="2412895">[</span><span class="op" id="2412896">]</span><span class="builtintype" id="2412897">byte</span>&nbsp;<span class="comment" id="2412902">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412923">for</span>&nbsp;<span class="ident" id="2412927">i</span>&nbsp;<span class="op" id="2412929">:=</span>&nbsp;<span class="num" id="2412932">0</span><span class="op" id="2412933">;</span>&nbsp;<span class="ident" id="2412935">i</span>&nbsp;<span class="op" id="2412937">&lt;</span>&nbsp;<span class="builtinfunc" id="2412939">len</span><span class="op" id="2412942">(</span><span class="ident" id="2412943">s</span><span class="op" id="2412944">)</span><span class="op" id="2412945">;</span>&nbsp;<span class="ident" id="2412947">i</span><span class="op" id="2412948">++</span>&nbsp;<span class="op" id="2412951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2412955">b</span>&nbsp;<span class="op" id="2412957">:=</span>&nbsp;<span class="ident" id="2412960">s</span><span class="op" id="2412961">[</span><span class="ident" id="2412962">i</span><span class="op" id="2412963">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412967">if</span>&nbsp;<span class="ident" id="2412970">r</span><span class="op" id="2412971">[</span><span class="ident" id="2412972">b</span><span class="op" id="2412973">]</span>&nbsp;<span class="op" id="2412975">!=</span>&nbsp;<span class="ident" id="2412978">b</span>&nbsp;<span class="op" id="2412980">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2412985">if</span>&nbsp;<span class="ident" id="2412988">buf</span>&nbsp;<span class="op" id="2412992">==</span>&nbsp;<span class="ident" id="2412995">nil</span>&nbsp;<span class="op" id="2412999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413005">buf</span>&nbsp;<span class="op" id="2413009">=</span>&nbsp;<span class="op" id="2413011">[</span><span class="op" id="2413012">]</span><span class="builtintype" id="2413013">byte</span><span class="op" id="2413017">(</span><span class="ident" id="2413018">s</span><span class="op" id="2413019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413029">buf</span><span class="op" id="2413032">[</span><span class="ident" id="2413033">i</span><span class="op" id="2413034">]</span>&nbsp;<span class="op" id="2413036">=</span>&nbsp;<span class="ident" id="2413038">r</span><span class="op" id="2413039">[</span><span class="ident" id="2413040">b</span><span class="op" id="2413041">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413045">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413051">if</span>&nbsp;<span class="ident" id="2413054">buf</span>&nbsp;<span class="op" id="2413058">==</span>&nbsp;<span class="ident" id="2413061">nil</span>&nbsp;<span class="op" id="2413065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413069">return</span>&nbsp;<span class="ident" id="2413076">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413082">return</span>&nbsp;<span class="builtintype" id="2413089">string</span><span class="op" id="2413095">(</span><span class="ident" id="2413096">buf</span><span class="op" id="2413099">)</span><br>
<span class="lineno">430</span><span class="op" id="2413101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2413104">func</span>&nbsp;<span class="op" id="2413109">(</span><span class="ident" id="2413110">r</span>&nbsp;<span class="op" id="2413112">*</span><span class="ident" id="2413113">byteReplacer</span><span class="op" id="2413125">)</span>&nbsp;<span class="ident" id="2413127">WriteString</span><span class="op" id="2413138">(</span><span class="ident" id="2413139">w</span>&nbsp;<span class="ident" id="2413141">io</span><span class="op" id="2413143">.</span><span class="ident" id="2413144">Writer</span><span class="op" id="2413150">,</span>&nbsp;<span class="ident" id="2413152">s</span>&nbsp;<span class="builtintype" id="2413154">string</span><span class="op" id="2413160">)</span>&nbsp;<span class="op" id="2413162">(</span><span class="ident" id="2413163">n</span>&nbsp;<span class="builtintype" id="2413165">int</span><span class="op" id="2413168">,</span>&nbsp;<span class="ident" id="2413170">err</span>&nbsp;<span class="builtintype" id="2413174">error</span><span class="op" id="2413179">)</span>&nbsp;<span class="op" id="2413181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2413184">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413262">bufsize</span>&nbsp;<span class="op" id="2413270">:=</span>&nbsp;<span class="num" id="2413273">32</span>&nbsp;<span class="op" id="2413276">&lt;&lt;</span>&nbsp;<span class="num" id="2413279">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413283">if</span>&nbsp;<span class="builtinfunc" id="2413286">len</span><span class="op" id="2413289">(</span><span class="ident" id="2413290">s</span><span class="op" id="2413291">)</span>&nbsp;<span class="op" id="2413293">&lt;</span>&nbsp;<span class="ident" id="2413295">bufsize</span>&nbsp;<span class="op" id="2413303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413307">bufsize</span>&nbsp;<span class="op" id="2413315">=</span>&nbsp;<span class="builtinfunc" id="2413317">len</span><span class="op" id="2413320">(</span><span class="ident" id="2413321">s</span><span class="op" id="2413322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413328">buf</span>&nbsp;<span class="op" id="2413332">:=</span>&nbsp;<span class="builtinfunc" id="2413335">make</span><span class="op" id="2413339">(</span><span class="op" id="2413340">[</span><span class="op" id="2413341">]</span><span class="builtintype" id="2413342">byte</span><span class="op" id="2413346">,</span>&nbsp;<span class="ident" id="2413348">bufsize</span><span class="op" id="2413355">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413359">for</span>&nbsp;<span class="builtinfunc" id="2413363">len</span><span class="op" id="2413366">(</span><span class="ident" id="2413367">s</span><span class="op" id="2413368">)</span>&nbsp;<span class="op" id="2413370">&gt;</span>&nbsp;<span class="num" id="2413372">0</span>&nbsp;<span class="op" id="2413374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413378">ncopy</span>&nbsp;<span class="op" id="2413384">:=</span>&nbsp;<span class="builtinfunc" id="2413387">copy</span><span class="op" id="2413391">(</span><span class="ident" id="2413392">buf</span><span class="op" id="2413395">,</span>&nbsp;<span class="ident" id="2413397">s</span><span class="op" id="2413398">[</span><span class="op" id="2413399">:</span><span class="op" id="2413400">]</span><span class="op" id="2413401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413405">s</span>&nbsp;<span class="op" id="2413407">=</span>&nbsp;<span class="ident" id="2413409">s</span><span class="op" id="2413410">[</span><span class="ident" id="2413411">ncopy</span><span class="op" id="2413416">:</span><span class="op" id="2413417">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413421">for</span>&nbsp;<span class="ident" id="2413425">i</span><span class="op" id="2413426">,</span>&nbsp;<span class="ident" id="2413428">b</span>&nbsp;<span class="op" id="2413430">:=</span>&nbsp;<span class="keyword" id="2413433">range</span>&nbsp;<span class="ident" id="2413439">buf</span><span class="op" id="2413442">[</span><span class="op" id="2413443">:</span><span class="ident" id="2413444">ncopy</span><span class="op" id="2413449">]</span>&nbsp;<span class="op" id="2413451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413456">buf</span><span class="op" id="2413459">[</span><span class="ident" id="2413460">i</span><span class="op" id="2413461">]</span>&nbsp;<span class="op" id="2413463">=</span>&nbsp;<span class="ident" id="2413465">r</span><span class="op" id="2413466">[</span><span class="ident" id="2413467">b</span><span class="op" id="2413468">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413476">wn</span><span class="op" id="2413478">,</span>&nbsp;<span class="ident" id="2413480">err</span>&nbsp;<span class="op" id="2413484">:=</span>&nbsp;<span class="ident" id="2413487">w</span><span class="op" id="2413488">.</span><span class="ident" id="2413489">Write</span><span class="op" id="2413494">(</span><span class="ident" id="2413495">buf</span><span class="op" id="2413498">[</span><span class="op" id="2413499">:</span><span class="ident" id="2413500">ncopy</span><span class="op" id="2413505">]</span><span class="op" id="2413506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413510">n</span>&nbsp;<span class="op" id="2413512">+=</span>&nbsp;<span class="ident" id="2413515">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413520">if</span>&nbsp;<span class="ident" id="2413523">err</span>&nbsp;<span class="op" id="2413527">!=</span>&nbsp;<span class="ident" id="2413530">nil</span>&nbsp;<span class="op" id="2413534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413539">return</span>&nbsp;<span class="ident" id="2413546">n</span><span class="op" id="2413547">,</span>&nbsp;<span class="ident" id="2413549">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2413558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413561">return</span>&nbsp;<span class="ident" id="2413568">n</span><span class="op" id="2413569">,</span>&nbsp;<span class="ident" id="2413571">nil</span><br>
<span class="lineno"></span><span class="op" id="2413575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2413578">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2413647">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2413721">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2413788">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2413852">type</span>&nbsp;<span class="ident" id="2413857">byteStringReplacer</span>&nbsp;<span class="op" id="2413876">[</span><span class="num" id="2413877">256</span><span class="op" id="2413880">]</span><span class="op" id="2413881">[</span><span class="op" id="2413882">]</span><span class="builtintype" id="2413883">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2413889">func</span>&nbsp;<span class="op" id="2413894">(</span><span class="ident" id="2413895">r</span>&nbsp;<span class="op" id="2413897">*</span><span class="ident" id="2413898">byteStringReplacer</span><span class="op" id="2413916">)</span>&nbsp;<span class="ident" id="2413918">Replace</span><span class="op" id="2413925">(</span><span class="ident" id="2413926">s</span>&nbsp;<span class="builtintype" id="2413928">string</span><span class="op" id="2413934">)</span>&nbsp;<span class="builtintype" id="2413936">string</span>&nbsp;<span class="op" id="2413943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413946">newSize</span>&nbsp;<span class="op" id="2413954">:=</span>&nbsp;<span class="builtinfunc" id="2413957">len</span><span class="op" id="2413960">(</span><span class="ident" id="2413961">s</span><span class="op" id="2413962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2413965">anyChanges</span>&nbsp;<span class="op" id="2413976">:=</span>&nbsp;<span class="builtintype" id="2413979">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2413986">for</span>&nbsp;<span class="ident" id="2413990">i</span>&nbsp;<span class="op" id="2413992">:=</span>&nbsp;<span class="num" id="2413995">0</span><span class="op" id="2413996">;</span>&nbsp;<span class="ident" id="2413998">i</span>&nbsp;<span class="op" id="2414000">&lt;</span>&nbsp;<span class="builtinfunc" id="2414002">len</span><span class="op" id="2414005">(</span><span class="ident" id="2414006">s</span><span class="op" id="2414007">)</span><span class="op" id="2414008">;</span>&nbsp;<span class="ident" id="2414010">i</span><span class="op" id="2414011">++</span>&nbsp;<span class="op" id="2414014">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414018">b</span>&nbsp;<span class="op" id="2414020">:=</span>&nbsp;<span class="ident" id="2414023">s</span><span class="op" id="2414024">[</span><span class="ident" id="2414025">i</span><span class="op" id="2414026">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414030">if</span>&nbsp;<span class="ident" id="2414033">r</span><span class="op" id="2414034">[</span><span class="ident" id="2414035">b</span><span class="op" id="2414036">]</span>&nbsp;<span class="op" id="2414038">!=</span>&nbsp;<span class="ident" id="2414041">nil</span>&nbsp;<span class="op" id="2414045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414050">anyChanges</span>&nbsp;<span class="op" id="2414061">=</span>&nbsp;<span class="builtintype" id="2414063">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2414071">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414141">newSize</span>&nbsp;<span class="op" id="2414149">+=</span>&nbsp;<span class="builtinfunc" id="2414152">len</span><span class="op" id="2414155">(</span><span class="ident" id="2414156">r</span><span class="op" id="2414157">[</span><span class="ident" id="2414158">b</span><span class="op" id="2414159">]</span><span class="op" id="2414160">)</span>&nbsp;<span class="op" id="2414162">-</span>&nbsp;<span class="num" id="2414164">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414174">if</span>&nbsp;<span class="op" id="2414177">!</span><span class="ident" id="2414178">anyChanges</span>&nbsp;<span class="op" id="2414189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414193">return</span>&nbsp;<span class="ident" id="2414200">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414203">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414206">buf</span>&nbsp;<span class="op" id="2414210">:=</span>&nbsp;<span class="builtinfunc" id="2414213">make</span><span class="op" id="2414217">(</span><span class="op" id="2414218">[</span><span class="op" id="2414219">]</span><span class="builtintype" id="2414220">byte</span><span class="op" id="2414224">,</span>&nbsp;<span class="ident" id="2414226">newSize</span><span class="op" id="2414233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414236">bi</span>&nbsp;<span class="op" id="2414239">:=</span>&nbsp;<span class="ident" id="2414242">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414247">for</span>&nbsp;<span class="ident" id="2414251">i</span>&nbsp;<span class="op" id="2414253">:=</span>&nbsp;<span class="num" id="2414256">0</span><span class="op" id="2414257">;</span>&nbsp;<span class="ident" id="2414259">i</span>&nbsp;<span class="op" id="2414261">&lt;</span>&nbsp;<span class="builtinfunc" id="2414263">len</span><span class="op" id="2414266">(</span><span class="ident" id="2414267">s</span><span class="op" id="2414268">)</span><span class="op" id="2414269">;</span>&nbsp;<span class="ident" id="2414271">i</span><span class="op" id="2414272">++</span>&nbsp;<span class="op" id="2414275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414279">b</span>&nbsp;<span class="op" id="2414281">:=</span>&nbsp;<span class="ident" id="2414284">s</span><span class="op" id="2414285">[</span><span class="ident" id="2414286">i</span><span class="op" id="2414287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414291">if</span>&nbsp;<span class="ident" id="2414294">r</span><span class="op" id="2414295">[</span><span class="ident" id="2414296">b</span><span class="op" id="2414297">]</span>&nbsp;<span class="op" id="2414299">!=</span>&nbsp;<span class="ident" id="2414302">nil</span>&nbsp;<span class="op" id="2414306">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414311">n</span>&nbsp;<span class="op" id="2414313">:=</span>&nbsp;<span class="builtinfunc" id="2414316">copy</span><span class="op" id="2414320">(</span><span class="ident" id="2414321">bi</span><span class="op" id="2414323">,</span>&nbsp;<span class="ident" id="2414325">r</span><span class="op" id="2414326">[</span><span class="ident" id="2414327">b</span><span class="op" id="2414328">]</span><span class="op" id="2414329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414334">bi</span>&nbsp;<span class="op" id="2414337">=</span>&nbsp;<span class="ident" id="2414339">bi</span><span class="op" id="2414341">[</span><span class="ident" id="2414342">n</span><span class="op" id="2414343">:</span><span class="op" id="2414344">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414348">}</span>&nbsp;<span class="keyword" id="2414350">else</span>&nbsp;<span class="op" id="2414355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414360">bi</span><span class="op" id="2414362">[</span><span class="num" id="2414363">0</span><span class="op" id="2414364">]</span>&nbsp;<span class="op" id="2414366">=</span>&nbsp;<span class="ident" id="2414368">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414373">bi</span>&nbsp;<span class="op" id="2414376">=</span>&nbsp;<span class="ident" id="2414378">bi</span><span class="op" id="2414380">[</span><span class="num" id="2414381">1</span><span class="op" id="2414382">:</span><span class="op" id="2414383">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414393">return</span>&nbsp;<span class="builtintype" id="2414400">string</span><span class="op" id="2414406">(</span><span class="ident" id="2414407">buf</span><span class="op" id="2414410">)</span><br>
<span class="lineno"></span><span class="op" id="2414412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2414415">func</span>&nbsp;<span class="op" id="2414420">(</span><span class="ident" id="2414421">r</span>&nbsp;<span class="op" id="2414423">*</span><span class="ident" id="2414424">byteStringReplacer</span><span class="op" id="2414442">)</span>&nbsp;<span class="ident" id="2414444">WriteString</span><span class="op" id="2414455">(</span><span class="ident" id="2414456">w</span>&nbsp;<span class="ident" id="2414458">io</span><span class="op" id="2414460">.</span><span class="ident" id="2414461">Writer</span><span class="op" id="2414467">,</span>&nbsp;<span class="ident" id="2414469">s</span>&nbsp;<span class="builtintype" id="2414471">string</span><span class="op" id="2414477">)</span>&nbsp;<span class="op" id="2414479">(</span><span class="ident" id="2414480">n</span>&nbsp;<span class="builtintype" id="2414482">int</span><span class="op" id="2414485">,</span>&nbsp;<span class="ident" id="2414487">err</span>&nbsp;<span class="builtintype" id="2414491">error</span><span class="op" id="2414496">)</span>&nbsp;<span class="op" id="2414498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414501">sw</span>&nbsp;<span class="op" id="2414504">:=</span>&nbsp;<span class="ident" id="2414507">getStringWriter</span><span class="op" id="2414522">(</span><span class="ident" id="2414523">w</span><span class="op" id="2414524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414527">last</span>&nbsp;<span class="op" id="2414532">:=</span>&nbsp;<span class="num" id="2414535">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414538">for</span>&nbsp;<span class="ident" id="2414542">i</span>&nbsp;<span class="op" id="2414544">:=</span>&nbsp;<span class="num" id="2414547">0</span><span class="op" id="2414548">;</span>&nbsp;<span class="ident" id="2414550">i</span>&nbsp;<span class="op" id="2414552">&lt;</span>&nbsp;<span class="builtinfunc" id="2414554">len</span><span class="op" id="2414557">(</span><span class="ident" id="2414558">s</span><span class="op" id="2414559">)</span><span class="op" id="2414560">;</span>&nbsp;<span class="ident" id="2414562">i</span><span class="op" id="2414563">++</span>&nbsp;<span class="op" id="2414566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414570">b</span>&nbsp;<span class="op" id="2414572">:=</span>&nbsp;<span class="ident" id="2414575">s</span><span class="op" id="2414576">[</span><span class="ident" id="2414577">i</span><span class="op" id="2414578">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414582">if</span>&nbsp;<span class="ident" id="2414585">r</span><span class="op" id="2414586">[</span><span class="ident" id="2414587">b</span><span class="op" id="2414588">]</span>&nbsp;<span class="op" id="2414590">==</span>&nbsp;<span class="ident" id="2414593">nil</span>&nbsp;<span class="op" id="2414597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414602">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414617">if</span>&nbsp;<span class="ident" id="2414620">last</span>&nbsp;<span class="op" id="2414625">!=</span>&nbsp;<span class="ident" id="2414628">i</span>&nbsp;<span class="op" id="2414630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414635">nw</span><span class="op" id="2414637">,</span>&nbsp;<span class="ident" id="2414639">err</span>&nbsp;<span class="op" id="2414643">:=</span>&nbsp;<span class="ident" id="2414646">sw</span><span class="op" id="2414648">.</span><span class="ident" id="2414649">WriteString</span><span class="op" id="2414660">(</span><span class="ident" id="2414661">s</span><span class="op" id="2414662">[</span><span class="ident" id="2414663">last</span><span class="op" id="2414667">:</span><span class="ident" id="2414668">i</span><span class="op" id="2414669">]</span><span class="op" id="2414670">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414675">n</span>&nbsp;<span class="op" id="2414677">+=</span>&nbsp;<span class="ident" id="2414680">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414686">if</span>&nbsp;<span class="ident" id="2414689">err</span>&nbsp;<span class="op" id="2414693">!=</span>&nbsp;<span class="ident" id="2414696">nil</span>&nbsp;<span class="op" id="2414700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414706">return</span>&nbsp;<span class="ident" id="2414713">n</span><span class="op" id="2414714">,</span>&nbsp;<span class="ident" id="2414716">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414727">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414731">last</span>&nbsp;<span class="op" id="2414736">=</span>&nbsp;<span class="ident" id="2414738">i</span>&nbsp;<span class="op" id="2414740">+</span>&nbsp;<span class="num" id="2414742">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414746">nw</span><span class="op" id="2414748">,</span>&nbsp;<span class="ident" id="2414750">err</span>&nbsp;<span class="op" id="2414754">:=</span>&nbsp;<span class="ident" id="2414757">w</span><span class="op" id="2414758">.</span><span class="ident" id="2414759">Write</span><span class="op" id="2414764">(</span><span class="ident" id="2414765">r</span><span class="op" id="2414766">[</span><span class="ident" id="2414767">b</span><span class="op" id="2414768">]</span><span class="op" id="2414769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414773">n</span>&nbsp;<span class="op" id="2414775">+=</span>&nbsp;<span class="ident" id="2414778">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414783">if</span>&nbsp;<span class="ident" id="2414786">err</span>&nbsp;<span class="op" id="2414790">!=</span>&nbsp;<span class="ident" id="2414793">nil</span>&nbsp;<span class="op" id="2414797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414802">return</span>&nbsp;<span class="ident" id="2414809">n</span><span class="op" id="2414810">,</span>&nbsp;<span class="ident" id="2414812">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414824">if</span>&nbsp;<span class="ident" id="2414827">last</span>&nbsp;<span class="op" id="2414832">!=</span>&nbsp;<span class="builtinfunc" id="2414835">len</span><span class="op" id="2414838">(</span><span class="ident" id="2414839">s</span><span class="op" id="2414840">)</span>&nbsp;<span class="op" id="2414842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414846">var</span>&nbsp;<span class="ident" id="2414850">nw</span>&nbsp;<span class="builtintype" id="2414853">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414859">nw</span><span class="op" id="2414861">,</span>&nbsp;<span class="ident" id="2414863">err</span>&nbsp;<span class="op" id="2414867">=</span>&nbsp;<span class="ident" id="2414869">sw</span><span class="op" id="2414871">.</span><span class="ident" id="2414872">WriteString</span><span class="op" id="2414883">(</span><span class="ident" id="2414884">s</span><span class="op" id="2414885">[</span><span class="ident" id="2414886">last</span><span class="op" id="2414890">:</span><span class="op" id="2414891">]</span><span class="op" id="2414892">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2414896">n</span>&nbsp;<span class="op" id="2414898">+=</span>&nbsp;<span class="ident" id="2414901">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2414905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2414908">return</span><br>
<span class="lineno"></span><span class="op" id="2414915">}</span>
</div>
</body>
</html>
