<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3271079">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3271135">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3271189">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3271240">package</span>&nbsp;<span class="ident" id="3271248">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3271253">import</span>&nbsp;<span class="string" id="3271260">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3271268">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3271326">type</span>&nbsp;<span class="ident" id="3271331">call</span>&nbsp;<span class="keyword" id="3271336">struct</span>&nbsp;<span class="op" id="3271343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271346">wg</span>&nbsp;<span class="ident" id="3271349">sync</span><span class="op" id="3271353">.</span><span class="ident" id="3271354">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271366">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271429">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271480">val</span>&nbsp;<span class="keyword" id="3271484">interface</span><span class="op" id="3271493">{</span><span class="op" id="3271494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271497">err</span>&nbsp;<span class="builtintype" id="3271501">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271509">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271569">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271631">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271676">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3271682">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271687">chans</span>&nbsp;<span class="op" id="3271693">[</span><span class="op" id="3271694">]</span><span class="keyword" id="3271695">chan</span><span class="op" id="3271699">&lt;-</span>&nbsp;<span class="ident" id="3271702">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3271721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3271724">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3271792">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3271859">type</span>&nbsp;<span class="ident" id="3271864">singleflight</span>&nbsp;<span class="keyword" id="3271877">struct</span>&nbsp;<span class="op" id="3271884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271887">mu</span>&nbsp;<span class="ident" id="3271890">sync</span><span class="op" id="3271894">.</span><span class="ident" id="3271895">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3271907">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271922">m</span>&nbsp;&nbsp;<span class="keyword" id="3271925">map</span><span class="op" id="3271928">[</span><span class="builtintype" id="3271929">string</span><span class="op" id="3271935">]</span><span class="op" id="3271936">*</span><span class="ident" id="3271937">call</span>&nbsp;<span class="comment" id="3271942">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3271964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3271967">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3272036">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3272053">type</span>&nbsp;<span class="ident" id="3272058">singleflightResult</span>&nbsp;<span class="keyword" id="3272077">struct</span>&nbsp;<span class="op" id="3272084">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272087">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3272094">interface</span><span class="op" id="3272103">{</span><span class="op" id="3272104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272107">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3272114">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272121">shared</span>&nbsp;<span class="builtintype" id="3272128">bool</span><br>
<span class="lineno"></span><span class="op" id="3272133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3272136">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3272205">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3272271">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3272340">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3272395">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3272473">func</span>&nbsp;<span class="op" id="3272478">(</span><span class="ident" id="3272479">g</span>&nbsp;<span class="op" id="3272481">*</span><span class="ident" id="3272482">singleflight</span><span class="op" id="3272494">)</span>&nbsp;<span class="ident" id="3272496">Do</span><span class="op" id="3272498">(</span><span class="ident" id="3272499">key</span>&nbsp;<span class="builtintype" id="3272503">string</span><span class="op" id="3272509">,</span>&nbsp;<span class="ident" id="3272511">fn</span>&nbsp;<span class="keyword" id="3272514">func</span><span class="op" id="3272518">(</span><span class="op" id="3272519">)</span>&nbsp;<span class="op" id="3272521">(</span><span class="keyword" id="3272522">interface</span><span class="op" id="3272531">{</span><span class="op" id="3272532">}</span><span class="op" id="3272533">,</span>&nbsp;<span class="builtintype" id="3272535">error</span><span class="op" id="3272540">)</span><span class="op" id="3272541">)</span>&nbsp;<span class="op" id="3272543">(</span><span class="ident" id="3272544">v</span>&nbsp;<span class="keyword" id="3272546">interface</span><span class="op" id="3272555">{</span><span class="op" id="3272556">}</span><span class="op" id="3272557">,</span>&nbsp;<span class="ident" id="3272559">err</span>&nbsp;<span class="builtintype" id="3272563">error</span><span class="op" id="3272568">,</span>&nbsp;<span class="ident" id="3272570">shared</span>&nbsp;<span class="builtintype" id="3272577">bool</span><span class="op" id="3272581">)</span>&nbsp;<span class="op" id="3272583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272586">g</span><span class="op" id="3272587">.</span><span class="ident" id="3272588">mu</span><span class="op" id="3272590">.</span><span class="ident" id="3272591">Lock</span><span class="op" id="3272595">(</span><span class="op" id="3272596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272599">if</span>&nbsp;<span class="ident" id="3272602">g</span><span class="op" id="3272603">.</span><span class="ident" id="3272604">m</span>&nbsp;<span class="op" id="3272606">==</span>&nbsp;<span class="ident" id="3272609">nil</span>&nbsp;<span class="op" id="3272613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272617">g</span><span class="op" id="3272618">.</span><span class="ident" id="3272619">m</span>&nbsp;<span class="op" id="3272621">=</span>&nbsp;<span class="builtinfunc" id="3272623">make</span><span class="op" id="3272627">(</span><span class="keyword" id="3272628">map</span><span class="op" id="3272631">[</span><span class="builtintype" id="3272632">string</span><span class="op" id="3272638">]</span><span class="op" id="3272639">*</span><span class="ident" id="3272640">call</span><span class="op" id="3272644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272647">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272650">if</span>&nbsp;<span class="ident" id="3272653">c</span><span class="op" id="3272654">,</span>&nbsp;<span class="ident" id="3272656">ok</span>&nbsp;<span class="op" id="3272659">:=</span>&nbsp;<span class="ident" id="3272662">g</span><span class="op" id="3272663">.</span><span class="ident" id="3272664">m</span><span class="op" id="3272665">[</span><span class="ident" id="3272666">key</span><span class="op" id="3272669">]</span><span class="op" id="3272670">;</span>&nbsp;<span class="ident" id="3272672">ok</span>&nbsp;<span class="op" id="3272675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272679">c</span><span class="op" id="3272680">.</span><span class="ident" id="3272681">dups</span><span class="op" id="3272685">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272690">g</span><span class="op" id="3272691">.</span><span class="ident" id="3272692">mu</span><span class="op" id="3272694">.</span><span class="ident" id="3272695">Unlock</span><span class="op" id="3272701">(</span><span class="op" id="3272702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272706">c</span><span class="op" id="3272707">.</span><span class="ident" id="3272708">wg</span><span class="op" id="3272710">.</span><span class="ident" id="3272711">Wait</span><span class="op" id="3272715">(</span><span class="op" id="3272716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272720">return</span>&nbsp;<span class="ident" id="3272727">c</span><span class="op" id="3272728">.</span><span class="ident" id="3272729">val</span><span class="op" id="3272732">,</span>&nbsp;<span class="ident" id="3272734">c</span><span class="op" id="3272735">.</span><span class="ident" id="3272736">err</span><span class="op" id="3272739">,</span>&nbsp;<span class="builtintype" id="3272741">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272750">c</span>&nbsp;<span class="op" id="3272752">:=</span>&nbsp;<span class="builtinfunc" id="3272755">new</span><span class="op" id="3272758">(</span><span class="ident" id="3272759">call</span><span class="op" id="3272763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272766">c</span><span class="op" id="3272767">.</span><span class="ident" id="3272768">wg</span><span class="op" id="3272770">.</span><span class="ident" id="3272771">Add</span><span class="op" id="3272774">(</span><span class="num" id="3272775">1</span><span class="op" id="3272776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272779">g</span><span class="op" id="3272780">.</span><span class="ident" id="3272781">m</span><span class="op" id="3272782">[</span><span class="ident" id="3272783">key</span><span class="op" id="3272786">]</span>&nbsp;<span class="op" id="3272788">=</span>&nbsp;<span class="ident" id="3272790">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272793">g</span><span class="op" id="3272794">.</span><span class="ident" id="3272795">mu</span><span class="op" id="3272797">.</span><span class="ident" id="3272798">Unlock</span><span class="op" id="3272804">(</span><span class="op" id="3272805">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272809">g</span><span class="op" id="3272810">.</span><span class="ident" id="3272811">doCall</span><span class="op" id="3272817">(</span><span class="ident" id="3272818">c</span><span class="op" id="3272819">,</span>&nbsp;<span class="ident" id="3272821">key</span><span class="op" id="3272824">,</span>&nbsp;<span class="ident" id="3272826">fn</span><span class="op" id="3272828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272831">return</span>&nbsp;<span class="ident" id="3272838">c</span><span class="op" id="3272839">.</span><span class="ident" id="3272840">val</span><span class="op" id="3272843">,</span>&nbsp;<span class="ident" id="3272845">c</span><span class="op" id="3272846">.</span><span class="ident" id="3272847">err</span><span class="op" id="3272850">,</span>&nbsp;<span class="ident" id="3272852">c</span><span class="op" id="3272853">.</span><span class="ident" id="3272854">dups</span>&nbsp;<span class="op" id="3272859">&gt;</span>&nbsp;<span class="num" id="3272861">0</span><br>
<span class="lineno"></span><span class="op" id="3272863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3272866">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3272931">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3272963">func</span>&nbsp;<span class="op" id="3272968">(</span><span class="ident" id="3272969">g</span>&nbsp;<span class="op" id="3272971">*</span><span class="ident" id="3272972">singleflight</span><span class="op" id="3272984">)</span>&nbsp;<span class="ident" id="3272986">DoChan</span><span class="op" id="3272992">(</span><span class="ident" id="3272993">key</span>&nbsp;<span class="builtintype" id="3272997">string</span><span class="op" id="3273003">,</span>&nbsp;<span class="ident" id="3273005">fn</span>&nbsp;<span class="keyword" id="3273008">func</span><span class="op" id="3273012">(</span><span class="op" id="3273013">)</span>&nbsp;<span class="op" id="3273015">(</span><span class="keyword" id="3273016">interface</span><span class="op" id="3273025">{</span><span class="op" id="3273026">}</span><span class="op" id="3273027">,</span>&nbsp;<span class="builtintype" id="3273029">error</span><span class="op" id="3273034">)</span><span class="op" id="3273035">)</span>&nbsp;<span class="op" id="3273037">&lt;-</span><span class="keyword" id="3273039">chan</span>&nbsp;<span class="ident" id="3273044">singleflightResult</span>&nbsp;<span class="op" id="3273063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273066">ch</span>&nbsp;<span class="op" id="3273069">:=</span>&nbsp;<span class="builtinfunc" id="3273072">make</span><span class="op" id="3273076">(</span><span class="keyword" id="3273077">chan</span>&nbsp;<span class="ident" id="3273082">singleflightResult</span><span class="op" id="3273100">,</span>&nbsp;<span class="num" id="3273102">1</span><span class="op" id="3273103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273106">g</span><span class="op" id="3273107">.</span><span class="ident" id="3273108">mu</span><span class="op" id="3273110">.</span><span class="ident" id="3273111">Lock</span><span class="op" id="3273115">(</span><span class="op" id="3273116">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273119">if</span>&nbsp;<span class="ident" id="3273122">g</span><span class="op" id="3273123">.</span><span class="ident" id="3273124">m</span>&nbsp;<span class="op" id="3273126">==</span>&nbsp;<span class="ident" id="3273129">nil</span>&nbsp;<span class="op" id="3273133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273137">g</span><span class="op" id="3273138">.</span><span class="ident" id="3273139">m</span>&nbsp;<span class="op" id="3273141">=</span>&nbsp;<span class="builtinfunc" id="3273143">make</span><span class="op" id="3273147">(</span><span class="keyword" id="3273148">map</span><span class="op" id="3273151">[</span><span class="builtintype" id="3273152">string</span><span class="op" id="3273158">]</span><span class="op" id="3273159">*</span><span class="ident" id="3273160">call</span><span class="op" id="3273164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3273167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273170">if</span>&nbsp;<span class="ident" id="3273173">c</span><span class="op" id="3273174">,</span>&nbsp;<span class="ident" id="3273176">ok</span>&nbsp;<span class="op" id="3273179">:=</span>&nbsp;<span class="ident" id="3273182">g</span><span class="op" id="3273183">.</span><span class="ident" id="3273184">m</span><span class="op" id="3273185">[</span><span class="ident" id="3273186">key</span><span class="op" id="3273189">]</span><span class="op" id="3273190">;</span>&nbsp;<span class="ident" id="3273192">ok</span>&nbsp;<span class="op" id="3273195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273199">c</span><span class="op" id="3273200">.</span><span class="ident" id="3273201">dups</span><span class="op" id="3273205">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273210">c</span><span class="op" id="3273211">.</span><span class="ident" id="3273212">chans</span>&nbsp;<span class="op" id="3273218">=</span>&nbsp;<span class="builtinfunc" id="3273220">append</span><span class="op" id="3273226">(</span><span class="ident" id="3273227">c</span><span class="op" id="3273228">.</span><span class="ident" id="3273229">chans</span><span class="op" id="3273234">,</span>&nbsp;<span class="ident" id="3273236">ch</span><span class="op" id="3273238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273242">g</span><span class="op" id="3273243">.</span><span class="ident" id="3273244">mu</span><span class="op" id="3273246">.</span><span class="ident" id="3273247">Unlock</span><span class="op" id="3273253">(</span><span class="op" id="3273254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273258">return</span>&nbsp;<span class="ident" id="3273265">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3273269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273272">c</span>&nbsp;<span class="op" id="3273274">:=</span>&nbsp;<span class="op" id="3273277">&amp;</span><span class="ident" id="3273278">call</span><span class="op" id="3273282">{</span><span class="ident" id="3273283">chans</span><span class="op" id="3273288">:</span>&nbsp;<span class="op" id="3273290">[</span><span class="op" id="3273291">]</span><span class="keyword" id="3273292">chan</span><span class="op" id="3273296">&lt;-</span>&nbsp;<span class="ident" id="3273299">singleflightResult</span><span class="op" id="3273317">{</span><span class="ident" id="3273318">ch</span><span class="op" id="3273320">}</span><span class="op" id="3273321">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273324">c</span><span class="op" id="3273325">.</span><span class="ident" id="3273326">wg</span><span class="op" id="3273328">.</span><span class="ident" id="3273329">Add</span><span class="op" id="3273332">(</span><span class="num" id="3273333">1</span><span class="op" id="3273334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273337">g</span><span class="op" id="3273338">.</span><span class="ident" id="3273339">m</span><span class="op" id="3273340">[</span><span class="ident" id="3273341">key</span><span class="op" id="3273344">]</span>&nbsp;<span class="op" id="3273346">=</span>&nbsp;<span class="ident" id="3273348">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273351">g</span><span class="op" id="3273352">.</span><span class="ident" id="3273353">mu</span><span class="op" id="3273355">.</span><span class="ident" id="3273356">Unlock</span><span class="op" id="3273362">(</span><span class="op" id="3273363">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273367">go</span>&nbsp;<span class="ident" id="3273370">g</span><span class="op" id="3273371">.</span><span class="ident" id="3273372">doCall</span><span class="op" id="3273378">(</span><span class="ident" id="3273379">c</span><span class="op" id="3273380">,</span>&nbsp;<span class="ident" id="3273382">key</span><span class="op" id="3273385">,</span>&nbsp;<span class="ident" id="3273387">fn</span><span class="op" id="3273389">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273393">return</span>&nbsp;<span class="ident" id="3273400">ch</span><br>
<span class="lineno"></span><span class="op" id="3273403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3273406">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3273451">func</span>&nbsp;<span class="op" id="3273456">(</span><span class="ident" id="3273457">g</span>&nbsp;<span class="op" id="3273459">*</span><span class="ident" id="3273460">singleflight</span><span class="op" id="3273472">)</span>&nbsp;<span class="ident" id="3273474">doCall</span><span class="op" id="3273480">(</span><span class="ident" id="3273481">c</span>&nbsp;<span class="op" id="3273483">*</span><span class="ident" id="3273484">call</span><span class="op" id="3273488">,</span>&nbsp;<span class="ident" id="3273490">key</span>&nbsp;<span class="builtintype" id="3273494">string</span><span class="op" id="3273500">,</span>&nbsp;<span class="ident" id="3273502">fn</span>&nbsp;<span class="keyword" id="3273505">func</span><span class="op" id="3273509">(</span><span class="op" id="3273510">)</span>&nbsp;<span class="op" id="3273512">(</span><span class="keyword" id="3273513">interface</span><span class="op" id="3273522">{</span><span class="op" id="3273523">}</span><span class="op" id="3273524">,</span>&nbsp;<span class="builtintype" id="3273526">error</span><span class="op" id="3273531">)</span><span class="op" id="3273532">)</span>&nbsp;<span class="op" id="3273534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273537">c</span><span class="op" id="3273538">.</span><span class="ident" id="3273539">val</span><span class="op" id="3273542">,</span>&nbsp;<span class="ident" id="3273544">c</span><span class="op" id="3273545">.</span><span class="ident" id="3273546">err</span>&nbsp;<span class="op" id="3273550">=</span>&nbsp;<span class="ident" id="3273552">fn</span><span class="op" id="3273554">(</span><span class="op" id="3273555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273558">c</span><span class="op" id="3273559">.</span><span class="ident" id="3273560">wg</span><span class="op" id="3273562">.</span><span class="ident" id="3273563">Done</span><span class="op" id="3273567">(</span><span class="op" id="3273568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273572">g</span><span class="op" id="3273573">.</span><span class="ident" id="3273574">mu</span><span class="op" id="3273576">.</span><span class="ident" id="3273577">Lock</span><span class="op" id="3273581">(</span><span class="op" id="3273582">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3273585">delete</span><span class="op" id="3273591">(</span><span class="ident" id="3273592">g</span><span class="op" id="3273593">.</span><span class="ident" id="3273594">m</span><span class="op" id="3273595">,</span>&nbsp;<span class="ident" id="3273597">key</span><span class="op" id="3273600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273603">for</span>&nbsp;<span class="ident" id="3273607">_</span><span class="op" id="3273608">,</span>&nbsp;<span class="ident" id="3273610">ch</span>&nbsp;<span class="op" id="3273613">:=</span>&nbsp;<span class="keyword" id="3273616">range</span>&nbsp;<span class="ident" id="3273622">c</span><span class="op" id="3273623">.</span><span class="ident" id="3273624">chans</span>&nbsp;<span class="op" id="3273630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273634">ch</span>&nbsp;<span class="op" id="3273637">&lt;-</span>&nbsp;<span class="ident" id="3273640">singleflightResult</span><span class="op" id="3273658">{</span><span class="ident" id="3273659">c</span><span class="op" id="3273660">.</span><span class="ident" id="3273661">val</span><span class="op" id="3273664">,</span>&nbsp;<span class="ident" id="3273666">c</span><span class="op" id="3273667">.</span><span class="ident" id="3273668">err</span><span class="op" id="3273671">,</span>&nbsp;<span class="ident" id="3273673">c</span><span class="op" id="3273674">.</span><span class="ident" id="3273675">dups</span>&nbsp;<span class="op" id="3273680">&gt;</span>&nbsp;<span class="num" id="3273682">0</span><span class="op" id="3273683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3273686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273689">g</span><span class="op" id="3273690">.</span><span class="ident" id="3273691">mu</span><span class="op" id="3273693">.</span><span class="ident" id="3273694">Unlock</span><span class="op" id="3273700">(</span><span class="op" id="3273701">)</span><br>
<span class="lineno">100</span><span class="op" id="3273703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3273706">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3273776">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3273845">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3273877">func</span>&nbsp;<span class="op" id="3273882">(</span><span class="ident" id="3273883">g</span>&nbsp;<span class="op" id="3273885">*</span><span class="ident" id="3273886">singleflight</span><span class="op" id="3273898">)</span>&nbsp;<span class="ident" id="3273900">Forget</span><span class="op" id="3273906">(</span><span class="ident" id="3273907">key</span>&nbsp;<span class="builtintype" id="3273911">string</span><span class="op" id="3273917">)</span>&nbsp;<span class="op" id="3273919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273922">g</span><span class="op" id="3273923">.</span><span class="ident" id="3273924">mu</span><span class="op" id="3273926">.</span><span class="ident" id="3273927">Lock</span><span class="op" id="3273931">(</span><span class="op" id="3273932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3273935">delete</span><span class="op" id="3273941">(</span><span class="ident" id="3273942">g</span><span class="op" id="3273943">.</span><span class="ident" id="3273944">m</span><span class="op" id="3273945">,</span>&nbsp;<span class="ident" id="3273947">key</span><span class="op" id="3273950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273953">g</span><span class="op" id="3273954">.</span><span class="ident" id="3273955">mu</span><span class="op" id="3273957">.</span><span class="ident" id="3273958">Unlock</span><span class="op" id="3273964">(</span><span class="op" id="3273965">)</span><br>
<span class="lineno"></span><span class="op" id="3273967">}</span>
</div>
</body>
</html>
