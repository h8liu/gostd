<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html" class="current">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5989557">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5989612">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5989666">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5989717">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5990124">package</span>&nbsp;<span class="ident" id="5990132">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990138">import</span>&nbsp;<span class="op" id="5990145">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990148">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990157">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990166">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990185">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990195">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990202">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990208">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990221">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990228">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990245">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990256">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990267">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5990275">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5990285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990288">var</span>&nbsp;<span class="ident" id="5990292">debug</span>&nbsp;<span class="op" id="5990298">=</span>&nbsp;<span class="ident" id="5990300">debugT</span><span class="op" id="5990306">(</span><span class="builtintype" id="5990307">false</span><span class="op" id="5990312">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="5990315">type</span>&nbsp;<span class="ident" id="5990320">debugT</span>&nbsp;<span class="builtintype" id="5990327">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990333">func</span>&nbsp;<span class="op" id="5990338">(</span><span class="ident" id="5990339">d</span>&nbsp;<span class="ident" id="5990341">debugT</span><span class="op" id="5990347">)</span>&nbsp;<span class="ident" id="5990349">Printf</span><span class="op" id="5990355">(</span><span class="ident" id="5990356">format</span>&nbsp;<span class="builtintype" id="5990363">string</span><span class="op" id="5990369">,</span>&nbsp;<span class="ident" id="5990371">args</span>&nbsp;<span class="op" id="5990376">...</span><span class="keyword" id="5990379">interface</span><span class="op" id="5990388">{</span><span class="op" id="5990389">}</span><span class="op" id="5990390">)</span>&nbsp;<span class="op" id="5990392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5990395">if</span>&nbsp;<span class="ident" id="5990398">d</span>&nbsp;<span class="op" id="5990400">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990404">log</span><span class="op" id="5990407">.</span><span class="ident" id="5990408">Printf</span><span class="op" id="5990414">(</span><span class="ident" id="5990415">format</span><span class="op" id="5990421">,</span>&nbsp;<span class="ident" id="5990423">args</span><span class="op" id="5990427">...</span><span class="op" id="5990430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5990433">}</span><br>
<span class="lineno"></span><span class="op" id="5990435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5990438">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="5990485">type</span>&nbsp;<span class="ident" id="5990490">Message</span>&nbsp;<span class="keyword" id="5990498">struct</span>&nbsp;<span class="op" id="5990505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990508">Header</span>&nbsp;<span class="ident" id="5990515">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990523">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5990530">io</span><span class="op" id="5990532">.</span><span class="ident" id="5990533">Reader</span><br>
<span class="lineno"></span><span class="op" id="5990540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5990543">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5990582">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="5990655">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5990678">func</span>&nbsp;<span class="ident" id="5990683">ReadMessage</span><span class="op" id="5990694">(</span><span class="ident" id="5990695">r</span>&nbsp;<span class="ident" id="5990697">io</span><span class="op" id="5990699">.</span><span class="ident" id="5990700">Reader</span><span class="op" id="5990706">)</span>&nbsp;<span class="op" id="5990708">(</span><span class="ident" id="5990709">msg</span>&nbsp;<span class="op" id="5990713">*</span><span class="ident" id="5990714">Message</span><span class="op" id="5990721">,</span>&nbsp;<span class="ident" id="5990723">err</span>&nbsp;<span class="builtintype" id="5990727">error</span><span class="op" id="5990732">)</span>&nbsp;<span class="op" id="5990734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990737">tp</span>&nbsp;<span class="op" id="5990740">:=</span>&nbsp;<span class="ident" id="5990743">textproto</span><span class="op" id="5990752">.</span><span class="ident" id="5990753">NewReader</span><span class="op" id="5990762">(</span><span class="ident" id="5990763">bufio</span><span class="op" id="5990768">.</span><span class="ident" id="5990769">NewReader</span><span class="op" id="5990778">(</span><span class="ident" id="5990779">r</span><span class="op" id="5990780">)</span><span class="op" id="5990781">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990785">hdr</span><span class="op" id="5990788">,</span>&nbsp;<span class="ident" id="5990790">err</span>&nbsp;<span class="op" id="5990794">:=</span>&nbsp;<span class="ident" id="5990797">tp</span><span class="op" id="5990799">.</span><span class="ident" id="5990800">ReadMIMEHeader</span><span class="op" id="5990814">(</span><span class="op" id="5990815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5990818">if</span>&nbsp;<span class="ident" id="5990821">err</span>&nbsp;<span class="op" id="5990825">!=</span>&nbsp;<span class="builtintype" id="5990828">nil</span>&nbsp;<span class="op" id="5990832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5990836">return</span>&nbsp;<span class="builtintype" id="5990843">nil</span><span class="op" id="5990846">,</span>&nbsp;<span class="ident" id="5990848">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5990853">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5990857">return</span>&nbsp;<span class="op" id="5990864">&amp;</span><span class="ident" id="5990865">Message</span><span class="op" id="5990872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990876">Header</span><span class="op" id="5990882">:</span>&nbsp;<span class="ident" id="5990884">Header</span><span class="op" id="5990890">(</span><span class="ident" id="5990891">hdr</span><span class="op" id="5990894">)</span><span class="op" id="5990895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990899">Body</span><span class="op" id="5990903">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5990907">tp</span><span class="op" id="5990909">.</span><span class="ident" id="5990910">R</span><span class="op" id="5990911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5990914">}</span><span class="op" id="5990915">,</span>&nbsp;<span class="builtintype" id="5990917">nil</span><br>
<span class="lineno">65</span><span class="op" id="5990921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5990924">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="5990971">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="5991000">var</span>&nbsp;<span class="ident" id="5991004">dateLayouts</span>&nbsp;<span class="op" id="5991016">[</span><span class="op" id="5991017">]</span><span class="builtintype" id="5991018">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="5991026">func</span>&nbsp;<span class="ident" id="5991031">init</span><span class="op" id="5991035">(</span><span class="op" id="5991036">)</span>&nbsp;<span class="op" id="5991038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5991041">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991095">dows</span>&nbsp;<span class="op" id="5991100">:=</span>&nbsp;<span class="op" id="5991103">[</span><span class="op" id="5991104">...</span><span class="op" id="5991107">]</span><span class="builtintype" id="5991108">string</span><span class="op" id="5991114">{</span><span class="string" id="5991115">&#34;&#34;</span><span class="op" id="5991117">,</span>&nbsp;<span class="string" id="5991119">&#34;Mon,&nbsp;&#34;</span><span class="op" id="5991126">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5991130">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991146">days</span>&nbsp;<span class="op" id="5991151">:=</span>&nbsp;<span class="op" id="5991154">[</span><span class="op" id="5991155">...</span><span class="op" id="5991158">]</span><span class="builtintype" id="5991159">string</span><span class="op" id="5991165">{</span><span class="string" id="5991166">&#34;2&#34;</span><span class="op" id="5991169">,</span>&nbsp;<span class="string" id="5991171">&#34;02&#34;</span><span class="op" id="5991175">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5991181">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991200">years</span>&nbsp;<span class="op" id="5991206">:=</span>&nbsp;<span class="op" id="5991209">[</span><span class="op" id="5991210">...</span><span class="op" id="5991213">]</span><span class="builtintype" id="5991214">string</span><span class="op" id="5991220">{</span><span class="string" id="5991221">&#34;2006&#34;</span><span class="op" id="5991227">,</span>&nbsp;<span class="string" id="5991229">&#34;06&#34;</span><span class="op" id="5991233">}</span>&nbsp;<span class="comment" id="5991235">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991264">seconds</span>&nbsp;<span class="op" id="5991272">:=</span>&nbsp;<span class="op" id="5991275">[</span><span class="op" id="5991276">...</span><span class="op" id="5991279">]</span><span class="builtintype" id="5991280">string</span><span class="op" id="5991286">{</span><span class="string" id="5991287">&#34;:05&#34;</span><span class="op" id="5991292">,</span>&nbsp;<span class="string" id="5991294">&#34;&#34;</span><span class="op" id="5991296">}</span>&nbsp;&nbsp;<span class="comment" id="5991299">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5991310">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991363">zones</span>&nbsp;<span class="op" id="5991369">:=</span>&nbsp;<span class="op" id="5991372">[</span><span class="op" id="5991373">...</span><span class="op" id="5991376">]</span><span class="builtintype" id="5991377">string</span><span class="op" id="5991383">{</span><span class="string" id="5991384">&#34;-0700&#34;</span><span class="op" id="5991391">,</span>&nbsp;<span class="string" id="5991393">&#34;MST&#34;</span><span class="op" id="5991398">,</span>&nbsp;<span class="string" id="5991400">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="5991413">}</span>&nbsp;<span class="comment" id="5991415">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991462">for</span>&nbsp;<span class="ident" id="5991466">_</span><span class="op" id="5991467">,</span>&nbsp;<span class="ident" id="5991469">dow</span>&nbsp;<span class="op" id="5991473">:=</span>&nbsp;<span class="keyword" id="5991476">range</span>&nbsp;<span class="ident" id="5991482">dows</span>&nbsp;<span class="op" id="5991487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991491">for</span>&nbsp;<span class="ident" id="5991495">_</span><span class="op" id="5991496">,</span>&nbsp;<span class="ident" id="5991498">day</span>&nbsp;<span class="op" id="5991502">:=</span>&nbsp;<span class="keyword" id="5991505">range</span>&nbsp;<span class="ident" id="5991511">days</span>&nbsp;<span class="op" id="5991516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991521">for</span>&nbsp;<span class="ident" id="5991525">_</span><span class="op" id="5991526">,</span>&nbsp;<span class="ident" id="5991528">year</span>&nbsp;<span class="op" id="5991533">:=</span>&nbsp;<span class="keyword" id="5991536">range</span>&nbsp;<span class="ident" id="5991542">years</span>&nbsp;<span class="op" id="5991548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991554">for</span>&nbsp;<span class="ident" id="5991558">_</span><span class="op" id="5991559">,</span>&nbsp;<span class="ident" id="5991561">second</span>&nbsp;<span class="op" id="5991568">:=</span>&nbsp;<span class="keyword" id="5991571">range</span>&nbsp;<span class="ident" id="5991577">seconds</span>&nbsp;<span class="op" id="5991585">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991592">for</span>&nbsp;<span class="ident" id="5991596">_</span><span class="op" id="5991597">,</span>&nbsp;<span class="ident" id="5991599">zone</span>&nbsp;<span class="op" id="5991604">:=</span>&nbsp;<span class="keyword" id="5991607">range</span>&nbsp;<span class="ident" id="5991613">zones</span>&nbsp;<span class="op" id="5991619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991627">s</span>&nbsp;<span class="op" id="5991629">:=</span>&nbsp;<span class="ident" id="5991632">dow</span>&nbsp;<span class="op" id="5991636">+</span>&nbsp;<span class="ident" id="5991638">day</span>&nbsp;<span class="op" id="5991642">+</span>&nbsp;<span class="string" id="5991644">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="5991652">+</span>&nbsp;<span class="ident" id="5991654">year</span>&nbsp;<span class="op" id="5991659">+</span>&nbsp;<span class="string" id="5991661">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="5991670">+</span>&nbsp;<span class="ident" id="5991672">second</span>&nbsp;<span class="op" id="5991679">+</span>&nbsp;<span class="string" id="5991681">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5991685">+</span>&nbsp;<span class="ident" id="5991687">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991698">dateLayouts</span>&nbsp;<span class="op" id="5991710">=</span>&nbsp;<span class="builtinfunc" id="5991712">append</span><span class="op" id="5991718">(</span><span class="ident" id="5991719">dateLayouts</span><span class="op" id="5991730">,</span>&nbsp;<span class="ident" id="5991732">s</span><span class="op" id="5991733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991746">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991758">}</span><br>
<span class="lineno"></span><span class="op" id="5991760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="5991763">func</span>&nbsp;<span class="ident" id="5991768">parseDate</span><span class="op" id="5991777">(</span><span class="ident" id="5991778">date</span>&nbsp;<span class="builtintype" id="5991783">string</span><span class="op" id="5991789">)</span>&nbsp;<span class="op" id="5991791">(</span><span class="ident" id="5991792">time</span><span class="op" id="5991796">.</span><span class="ident" id="5991797">Time</span><span class="op" id="5991801">,</span>&nbsp;<span class="builtintype" id="5991803">error</span><span class="op" id="5991808">)</span>&nbsp;<span class="op" id="5991810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991813">for</span>&nbsp;<span class="ident" id="5991817">_</span><span class="op" id="5991818">,</span>&nbsp;<span class="ident" id="5991820">layout</span>&nbsp;<span class="op" id="5991827">:=</span>&nbsp;<span class="keyword" id="5991830">range</span>&nbsp;<span class="ident" id="5991836">dateLayouts</span>&nbsp;<span class="op" id="5991848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991852">t</span><span class="op" id="5991853">,</span>&nbsp;<span class="ident" id="5991855">err</span>&nbsp;<span class="op" id="5991859">:=</span>&nbsp;<span class="ident" id="5991862">time</span><span class="op" id="5991866">.</span><span class="ident" id="5991867">Parse</span><span class="op" id="5991872">(</span><span class="ident" id="5991873">layout</span><span class="op" id="5991879">,</span>&nbsp;<span class="ident" id="5991881">date</span><span class="op" id="5991885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991889">if</span>&nbsp;<span class="ident" id="5991892">err</span>&nbsp;<span class="op" id="5991896">==</span>&nbsp;<span class="builtintype" id="5991899">nil</span>&nbsp;<span class="op" id="5991903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991908">return</span>&nbsp;<span class="ident" id="5991915">t</span><span class="op" id="5991916">,</span>&nbsp;<span class="builtintype" id="5991918">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5991927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991930">return</span>&nbsp;<span class="ident" id="5991937">time</span><span class="op" id="5991941">.</span><span class="ident" id="5991942">Time</span><span class="op" id="5991946">{</span><span class="op" id="5991947">}</span><span class="op" id="5991948">,</span>&nbsp;<span class="ident" id="5991950">errors</span><span class="op" id="5991956">.</span><span class="ident" id="5991957">New</span><span class="op" id="5991960">(</span><span class="string" id="5991961">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="5991995">)</span><br>
<span class="lineno"></span><span class="op" id="5991997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5992000">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5992069">type</span>&nbsp;<span class="ident" id="5992074">Header</span>&nbsp;<span class="keyword" id="5992081">map</span><span class="op" id="5992084">[</span><span class="builtintype" id="5992085">string</span><span class="op" id="5992091">]</span><span class="op" id="5992092">[</span><span class="op" id="5992093">]</span><span class="builtintype" id="5992094">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5992102">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="5992161">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="5992228">func</span>&nbsp;<span class="op" id="5992233">(</span><span class="ident" id="5992234">h</span>&nbsp;<span class="ident" id="5992236">Header</span><span class="op" id="5992242">)</span>&nbsp;<span class="ident" id="5992244">Get</span><span class="op" id="5992247">(</span><span class="ident" id="5992248">key</span>&nbsp;<span class="builtintype" id="5992252">string</span><span class="op" id="5992258">)</span>&nbsp;<span class="builtintype" id="5992260">string</span>&nbsp;<span class="op" id="5992267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992270">return</span>&nbsp;<span class="ident" id="5992277">textproto</span><span class="op" id="5992286">.</span><span class="ident" id="5992287">MIMEHeader</span><span class="op" id="5992297">(</span><span class="ident" id="5992298">h</span><span class="op" id="5992299">)</span><span class="op" id="5992300">.</span><span class="ident" id="5992301">Get</span><span class="op" id="5992304">(</span><span class="ident" id="5992305">key</span><span class="op" id="5992308">)</span><br>
<span class="lineno"></span><span class="op" id="5992310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5992313">var</span>&nbsp;<span class="ident" id="5992317">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="5992337">=</span>&nbsp;<span class="ident" id="5992339">errors</span><span class="op" id="5992345">.</span><span class="ident" id="5992346">New</span><span class="op" id="5992349">(</span><span class="string" id="5992350">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="5992379">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5992382">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="5992420">func</span>&nbsp;<span class="op" id="5992425">(</span><span class="ident" id="5992426">h</span>&nbsp;<span class="ident" id="5992428">Header</span><span class="op" id="5992434">)</span>&nbsp;<span class="ident" id="5992436">Date</span><span class="op" id="5992440">(</span><span class="op" id="5992441">)</span>&nbsp;<span class="op" id="5992443">(</span><span class="ident" id="5992444">time</span><span class="op" id="5992448">.</span><span class="ident" id="5992449">Time</span><span class="op" id="5992453">,</span>&nbsp;<span class="builtintype" id="5992455">error</span><span class="op" id="5992460">)</span>&nbsp;<span class="op" id="5992462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5992465">hdr</span>&nbsp;<span class="op" id="5992469">:=</span>&nbsp;<span class="ident" id="5992472">h</span><span class="op" id="5992473">.</span><span class="ident" id="5992474">Get</span><span class="op" id="5992477">(</span><span class="string" id="5992478">&#34;Date&#34;</span><span class="op" id="5992484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992487">if</span>&nbsp;<span class="ident" id="5992490">hdr</span>&nbsp;<span class="op" id="5992494">==</span>&nbsp;<span class="string" id="5992497">&#34;&#34;</span>&nbsp;<span class="op" id="5992500">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992504">return</span>&nbsp;<span class="ident" id="5992511">time</span><span class="op" id="5992515">.</span><span class="ident" id="5992516">Time</span><span class="op" id="5992520">{</span><span class="op" id="5992521">}</span><span class="op" id="5992522">,</span>&nbsp;<span class="ident" id="5992524">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5992545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992548">return</span>&nbsp;<span class="ident" id="5992555">parseDate</span><span class="op" id="5992564">(</span><span class="ident" id="5992565">hdr</span><span class="op" id="5992568">)</span><br>
<span class="lineno"></span><span class="op" id="5992570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5992573">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5992642">func</span>&nbsp;<span class="op" id="5992647">(</span><span class="ident" id="5992648">h</span>&nbsp;<span class="ident" id="5992650">Header</span><span class="op" id="5992656">)</span>&nbsp;<span class="ident" id="5992658">AddressList</span><span class="op" id="5992669">(</span><span class="ident" id="5992670">key</span>&nbsp;<span class="builtintype" id="5992674">string</span><span class="op" id="5992680">)</span>&nbsp;<span class="op" id="5992682">(</span><span class="op" id="5992683">[</span><span class="op" id="5992684">]</span><span class="op" id="5992685">*</span><span class="ident" id="5992686">Address</span><span class="op" id="5992693">,</span>&nbsp;<span class="builtintype" id="5992695">error</span><span class="op" id="5992700">)</span>&nbsp;<span class="op" id="5992702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5992705">hdr</span>&nbsp;<span class="op" id="5992709">:=</span>&nbsp;<span class="ident" id="5992712">h</span><span class="op" id="5992713">.</span><span class="ident" id="5992714">Get</span><span class="op" id="5992717">(</span><span class="ident" id="5992718">key</span><span class="op" id="5992721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992724">if</span>&nbsp;<span class="ident" id="5992727">hdr</span>&nbsp;<span class="op" id="5992731">==</span>&nbsp;<span class="string" id="5992734">&#34;&#34;</span>&nbsp;<span class="op" id="5992737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992741">return</span>&nbsp;<span class="builtintype" id="5992748">nil</span><span class="op" id="5992751">,</span>&nbsp;<span class="ident" id="5992753">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5992774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5992777">return</span>&nbsp;<span class="ident" id="5992784">ParseAddressList</span><span class="op" id="5992800">(</span><span class="ident" id="5992801">hdr</span><span class="op" id="5992804">)</span><br>
<span class="lineno"></span><span class="op" id="5992806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5992809">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="5992854">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="5992922">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="5992985">type</span>&nbsp;<span class="ident" id="5992990">Address</span>&nbsp;<span class="keyword" id="5992998">struct</span>&nbsp;<span class="op" id="5993005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5993008">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5993016">string</span>&nbsp;<span class="comment" id="5993023">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5993054">Address</span>&nbsp;<span class="builtintype" id="5993062">string</span>&nbsp;<span class="comment" id="5993069">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="5993084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5993087">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5993160">func</span>&nbsp;<span class="ident" id="5993165">ParseAddress</span><span class="op" id="5993177">(</span><span class="ident" id="5993178">address</span>&nbsp;<span class="builtintype" id="5993186">string</span><span class="op" id="5993192">)</span>&nbsp;<span class="op" id="5993194">(</span><span class="op" id="5993195">*</span><span class="ident" id="5993196">Address</span><span class="op" id="5993203">,</span>&nbsp;<span class="builtintype" id="5993205">error</span><span class="op" id="5993210">)</span>&nbsp;<span class="op" id="5993212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993215">return</span>&nbsp;<span class="ident" id="5993222">newAddrParser</span><span class="op" id="5993235">(</span><span class="ident" id="5993236">address</span><span class="op" id="5993243">)</span><span class="op" id="5993244">.</span><span class="ident" id="5993245">parseAddress</span><span class="op" id="5993257">(</span><span class="op" id="5993258">)</span><br>
<span class="lineno">145</span><span class="op" id="5993260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5993263">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5993331">func</span>&nbsp;<span class="ident" id="5993336">ParseAddressList</span><span class="op" id="5993352">(</span><span class="ident" id="5993353">list</span>&nbsp;<span class="builtintype" id="5993358">string</span><span class="op" id="5993364">)</span>&nbsp;<span class="op" id="5993366">(</span><span class="op" id="5993367">[</span><span class="op" id="5993368">]</span><span class="op" id="5993369">*</span><span class="ident" id="5993370">Address</span><span class="op" id="5993377">,</span>&nbsp;<span class="builtintype" id="5993379">error</span><span class="op" id="5993384">)</span>&nbsp;<span class="op" id="5993386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993389">return</span>&nbsp;<span class="ident" id="5993396">newAddrParser</span><span class="op" id="5993409">(</span><span class="ident" id="5993410">list</span><span class="op" id="5993414">)</span><span class="op" id="5993415">.</span><span class="ident" id="5993416">parseAddressList</span><span class="op" id="5993432">(</span><span class="op" id="5993433">)</span><br>
<span class="lineno">150</span><span class="op" id="5993435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5993438">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="5993497">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="5993552">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="5993604">func</span>&nbsp;<span class="op" id="5993609">(</span><span class="ident" id="5993610">a</span>&nbsp;<span class="op" id="5993612">*</span><span class="ident" id="5993613">Address</span><span class="op" id="5993620">)</span>&nbsp;<span class="ident" id="5993622">String</span><span class="op" id="5993628">(</span><span class="op" id="5993629">)</span>&nbsp;<span class="builtintype" id="5993631">string</span>&nbsp;<span class="op" id="5993638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5993641">s</span>&nbsp;<span class="op" id="5993643">:=</span>&nbsp;<span class="string" id="5993646">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="5993650">+</span>&nbsp;<span class="ident" id="5993652">a</span><span class="op" id="5993653">.</span><span class="ident" id="5993654">Address</span>&nbsp;<span class="op" id="5993662">+</span>&nbsp;<span class="string" id="5993664">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993669">if</span>&nbsp;<span class="ident" id="5993672">a</span><span class="op" id="5993673">.</span><span class="ident" id="5993674">Name</span>&nbsp;<span class="op" id="5993679">==</span>&nbsp;<span class="string" id="5993682">&#34;&#34;</span>&nbsp;<span class="op" id="5993685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993689">return</span>&nbsp;<span class="ident" id="5993696">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5993699">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5993702">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5993764">allPrintable</span>&nbsp;<span class="op" id="5993777">:=</span>&nbsp;<span class="builtintype" id="5993780">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993786">for</span>&nbsp;<span class="ident" id="5993790">i</span>&nbsp;<span class="op" id="5993792">:=</span>&nbsp;<span class="num" id="5993795">0</span><span class="op" id="5993796">;</span>&nbsp;<span class="ident" id="5993798">i</span>&nbsp;<span class="op" id="5993800">&lt;</span>&nbsp;<span class="builtinfunc" id="5993802">len</span><span class="op" id="5993805">(</span><span class="ident" id="5993806">a</span><span class="op" id="5993807">.</span><span class="ident" id="5993808">Name</span><span class="op" id="5993812">)</span><span class="op" id="5993813">;</span>&nbsp;<span class="ident" id="5993815">i</span><span class="op" id="5993816">++</span>&nbsp;<span class="op" id="5993819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5993823">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5993865">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993904">if</span>&nbsp;<span class="op" id="5993907">!</span><span class="ident" id="5993908">isVchar</span><span class="op" id="5993915">(</span><span class="ident" id="5993916">a</span><span class="op" id="5993917">.</span><span class="ident" id="5993918">Name</span><span class="op" id="5993922">[</span><span class="ident" id="5993923">i</span><span class="op" id="5993924">]</span><span class="op" id="5993925">)</span>&nbsp;<span class="op" id="5993927">&amp;&amp;</span>&nbsp;<span class="op" id="5993930">!</span><span class="ident" id="5993931">isWSP</span><span class="op" id="5993936">(</span><span class="ident" id="5993937">a</span><span class="op" id="5993938">.</span><span class="ident" id="5993939">Name</span><span class="op" id="5993943">[</span><span class="ident" id="5993944">i</span><span class="op" id="5993945">]</span><span class="op" id="5993946">)</span>&nbsp;<span class="op" id="5993948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5993953">allPrintable</span>&nbsp;<span class="op" id="5993966">=</span>&nbsp;<span class="builtintype" id="5993968">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993977">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5993985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5993988">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5993991">if</span>&nbsp;<span class="ident" id="5993994">allPrintable</span>&nbsp;<span class="op" id="5994007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994011">b</span>&nbsp;<span class="op" id="5994013">:=</span>&nbsp;<span class="ident" id="5994016">bytes</span><span class="op" id="5994021">.</span><span class="ident" id="5994022">NewBufferString</span><span class="op" id="5994037">(</span><span class="string" id="5994038">`&#34;`</span><span class="op" id="5994041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994045">for</span>&nbsp;<span class="ident" id="5994049">i</span>&nbsp;<span class="op" id="5994051">:=</span>&nbsp;<span class="num" id="5994054">0</span><span class="op" id="5994055">;</span>&nbsp;<span class="ident" id="5994057">i</span>&nbsp;<span class="op" id="5994059">&lt;</span>&nbsp;<span class="builtinfunc" id="5994061">len</span><span class="op" id="5994064">(</span><span class="ident" id="5994065">a</span><span class="op" id="5994066">.</span><span class="ident" id="5994067">Name</span><span class="op" id="5994071">)</span><span class="op" id="5994072">;</span>&nbsp;<span class="ident" id="5994074">i</span><span class="op" id="5994075">++</span>&nbsp;<span class="op" id="5994078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994083">if</span>&nbsp;<span class="op" id="5994086">!</span><span class="ident" id="5994087">isQtext</span><span class="op" id="5994094">(</span><span class="ident" id="5994095">a</span><span class="op" id="5994096">.</span><span class="ident" id="5994097">Name</span><span class="op" id="5994101">[</span><span class="ident" id="5994102">i</span><span class="op" id="5994103">]</span><span class="op" id="5994104">)</span>&nbsp;<span class="op" id="5994106">&amp;&amp;</span>&nbsp;<span class="op" id="5994109">!</span><span class="ident" id="5994110">isWSP</span><span class="op" id="5994115">(</span><span class="ident" id="5994116">a</span><span class="op" id="5994117">.</span><span class="ident" id="5994118">Name</span><span class="op" id="5994122">[</span><span class="ident" id="5994123">i</span><span class="op" id="5994124">]</span><span class="op" id="5994125">)</span>&nbsp;<span class="op" id="5994127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994133">b</span><span class="op" id="5994134">.</span><span class="ident" id="5994135">WriteByte</span><span class="op" id="5994144">(</span><span class="string" id="5994145">&#39;\\&#39;</span><span class="op" id="5994149">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994159">b</span><span class="op" id="5994160">.</span><span class="ident" id="5994161">WriteByte</span><span class="op" id="5994170">(</span><span class="ident" id="5994171">a</span><span class="op" id="5994172">.</span><span class="ident" id="5994173">Name</span><span class="op" id="5994177">[</span><span class="ident" id="5994178">i</span><span class="op" id="5994179">]</span><span class="op" id="5994180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994188">b</span><span class="op" id="5994189">.</span><span class="ident" id="5994190">WriteString</span><span class="op" id="5994201">(</span><span class="string" id="5994202">`&#34;&nbsp;`</span><span class="op" id="5994206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994210">b</span><span class="op" id="5994211">.</span><span class="ident" id="5994212">WriteString</span><span class="op" id="5994223">(</span><span class="ident" id="5994224">s</span><span class="op" id="5994225">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994229">return</span>&nbsp;<span class="ident" id="5994236">b</span><span class="op" id="5994237">.</span><span class="ident" id="5994238">String</span><span class="op" id="5994244">(</span><span class="op" id="5994245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5994252">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994275">b</span>&nbsp;<span class="op" id="5994277">:=</span>&nbsp;<span class="ident" id="5994280">bytes</span><span class="op" id="5994285">.</span><span class="ident" id="5994286">NewBufferString</span><span class="op" id="5994301">(</span><span class="string" id="5994302">&#34;=?utf-8?q?&#34;</span><span class="op" id="5994314">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994317">for</span>&nbsp;<span class="ident" id="5994321">i</span>&nbsp;<span class="op" id="5994323">:=</span>&nbsp;<span class="num" id="5994326">0</span><span class="op" id="5994327">;</span>&nbsp;<span class="ident" id="5994329">i</span>&nbsp;<span class="op" id="5994331">&lt;</span>&nbsp;<span class="builtinfunc" id="5994333">len</span><span class="op" id="5994336">(</span><span class="ident" id="5994337">a</span><span class="op" id="5994338">.</span><span class="ident" id="5994339">Name</span><span class="op" id="5994343">)</span><span class="op" id="5994344">;</span>&nbsp;<span class="ident" id="5994346">i</span><span class="op" id="5994347">++</span>&nbsp;<span class="op" id="5994350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994354">switch</span>&nbsp;<span class="ident" id="5994361">c</span>&nbsp;<span class="op" id="5994363">:=</span>&nbsp;<span class="ident" id="5994366">a</span><span class="op" id="5994367">.</span><span class="ident" id="5994368">Name</span><span class="op" id="5994372">[</span><span class="ident" id="5994373">i</span><span class="op" id="5994374">]</span><span class="op" id="5994375">;</span>&nbsp;<span class="op" id="5994377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994381">case</span>&nbsp;<span class="ident" id="5994386">c</span>&nbsp;<span class="op" id="5994388">==</span>&nbsp;<span class="string" id="5994391">&#39;&nbsp;&#39;</span><span class="op" id="5994394">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994399">b</span><span class="op" id="5994400">.</span><span class="ident" id="5994401">WriteByte</span><span class="op" id="5994410">(</span><span class="string" id="5994411">&#39;_&#39;</span><span class="op" id="5994414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994418">case</span>&nbsp;<span class="ident" id="5994423">isVchar</span><span class="op" id="5994430">(</span><span class="ident" id="5994431">c</span><span class="op" id="5994432">)</span>&nbsp;<span class="op" id="5994434">&amp;&amp;</span>&nbsp;<span class="ident" id="5994437">c</span>&nbsp;<span class="op" id="5994439">!=</span>&nbsp;<span class="string" id="5994442">&#39;=&#39;</span>&nbsp;<span class="op" id="5994446">&amp;&amp;</span>&nbsp;<span class="ident" id="5994449">c</span>&nbsp;<span class="op" id="5994451">!=</span>&nbsp;<span class="string" id="5994454">&#39;?&#39;</span>&nbsp;<span class="op" id="5994458">&amp;&amp;</span>&nbsp;<span class="ident" id="5994461">c</span>&nbsp;<span class="op" id="5994463">!=</span>&nbsp;<span class="string" id="5994466">&#39;_&#39;</span><span class="op" id="5994469">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994474">b</span><span class="op" id="5994475">.</span><span class="ident" id="5994476">WriteByte</span><span class="op" id="5994485">(</span><span class="ident" id="5994486">c</span><span class="op" id="5994487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994491">default</span><span class="op" id="5994498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994503">fmt</span><span class="op" id="5994506">.</span><span class="ident" id="5994507">Fprintf</span><span class="op" id="5994514">(</span><span class="ident" id="5994515">b</span><span class="op" id="5994516">,</span>&nbsp;<span class="string" id="5994518">&#34;=%02X&#34;</span><span class="op" id="5994525">,</span>&nbsp;<span class="ident" id="5994527">c</span><span class="op" id="5994528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994535">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994538">b</span><span class="op" id="5994539">.</span><span class="ident" id="5994540">WriteString</span><span class="op" id="5994551">(</span><span class="string" id="5994552">&#34;?=&nbsp;&#34;</span><span class="op" id="5994557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994560">b</span><span class="op" id="5994561">.</span><span class="ident" id="5994562">WriteString</span><span class="op" id="5994573">(</span><span class="ident" id="5994574">s</span><span class="op" id="5994575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994578">return</span>&nbsp;<span class="ident" id="5994585">b</span><span class="op" id="5994586">.</span><span class="ident" id="5994587">String</span><span class="op" id="5994593">(</span><span class="op" id="5994594">)</span><br>
<span class="lineno"></span><span class="op" id="5994596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="5994599">type</span>&nbsp;<span class="ident" id="5994604">addrParser</span>&nbsp;<span class="op" id="5994615">[</span><span class="op" id="5994616">]</span><span class="builtintype" id="5994617">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5994623">func</span>&nbsp;<span class="ident" id="5994628">newAddrParser</span><span class="op" id="5994641">(</span><span class="ident" id="5994642">s</span>&nbsp;<span class="builtintype" id="5994644">string</span><span class="op" id="5994650">)</span>&nbsp;<span class="op" id="5994652">*</span><span class="ident" id="5994653">addrParser</span>&nbsp;<span class="op" id="5994664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994667">p</span>&nbsp;<span class="op" id="5994669">:=</span>&nbsp;<span class="ident" id="5994672">addrParser</span><span class="op" id="5994682">(</span><span class="ident" id="5994683">s</span><span class="op" id="5994684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994687">return</span>&nbsp;<span class="op" id="5994694">&amp;</span><span class="ident" id="5994695">p</span><br>
<span class="lineno">205</span><span class="op" id="5994697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5994700">func</span>&nbsp;<span class="op" id="5994705">(</span><span class="ident" id="5994706">p</span>&nbsp;<span class="op" id="5994708">*</span><span class="ident" id="5994709">addrParser</span><span class="op" id="5994719">)</span>&nbsp;<span class="ident" id="5994721">parseAddressList</span><span class="op" id="5994737">(</span><span class="op" id="5994738">)</span>&nbsp;<span class="op" id="5994740">(</span><span class="op" id="5994741">[</span><span class="op" id="5994742">]</span><span class="op" id="5994743">*</span><span class="ident" id="5994744">Address</span><span class="op" id="5994751">,</span>&nbsp;<span class="builtintype" id="5994753">error</span><span class="op" id="5994758">)</span>&nbsp;<span class="op" id="5994760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994763">var</span>&nbsp;<span class="ident" id="5994767">list</span>&nbsp;<span class="op" id="5994772">[</span><span class="op" id="5994773">]</span><span class="op" id="5994774">*</span><span class="ident" id="5994775">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994784">for</span>&nbsp;<span class="op" id="5994788">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994792">p</span><span class="op" id="5994793">.</span><span class="ident" id="5994794">skipSpace</span><span class="op" id="5994803">(</span><span class="op" id="5994804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994808">addr</span><span class="op" id="5994812">,</span>&nbsp;<span class="ident" id="5994814">err</span>&nbsp;<span class="op" id="5994818">:=</span>&nbsp;<span class="ident" id="5994821">p</span><span class="op" id="5994822">.</span><span class="ident" id="5994823">parseAddress</span><span class="op" id="5994835">(</span><span class="op" id="5994836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994840">if</span>&nbsp;<span class="ident" id="5994843">err</span>&nbsp;<span class="op" id="5994847">!=</span>&nbsp;<span class="builtintype" id="5994850">nil</span>&nbsp;<span class="op" id="5994854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994859">return</span>&nbsp;<span class="builtintype" id="5994866">nil</span><span class="op" id="5994869">,</span>&nbsp;<span class="ident" id="5994871">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994877">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994881">list</span>&nbsp;<span class="op" id="5994886">=</span>&nbsp;<span class="builtinfunc" id="5994888">append</span><span class="op" id="5994894">(</span><span class="ident" id="5994895">list</span><span class="op" id="5994899">,</span>&nbsp;<span class="ident" id="5994901">addr</span><span class="op" id="5994905">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5994910">p</span><span class="op" id="5994911">.</span><span class="ident" id="5994912">skipSpace</span><span class="op" id="5994921">(</span><span class="op" id="5994922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994926">if</span>&nbsp;<span class="ident" id="5994929">p</span><span class="op" id="5994930">.</span><span class="ident" id="5994931">empty</span><span class="op" id="5994936">(</span><span class="op" id="5994937">)</span>&nbsp;<span class="op" id="5994939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994944">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5994952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994956">if</span>&nbsp;<span class="op" id="5994959">!</span><span class="ident" id="5994960">p</span><span class="op" id="5994961">.</span><span class="ident" id="5994962">consume</span><span class="op" id="5994969">(</span><span class="string" id="5994970">&#39;,&#39;</span><span class="op" id="5994973">)</span>&nbsp;<span class="op" id="5994975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5994980">return</span>&nbsp;<span class="builtintype" id="5994987">nil</span><span class="op" id="5994990">,</span>&nbsp;<span class="ident" id="5994992">errors</span><span class="op" id="5994998">.</span><span class="ident" id="5994999">New</span><span class="op" id="5995002">(</span><span class="string" id="5995003">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="5995025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995032">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995035">return</span>&nbsp;<span class="ident" id="5995042">list</span><span class="op" id="5995046">,</span>&nbsp;<span class="builtintype" id="5995048">nil</span><br>
<span class="lineno"></span><span class="op" id="5995052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5995055">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5995123">func</span>&nbsp;<span class="op" id="5995128">(</span><span class="ident" id="5995129">p</span>&nbsp;<span class="op" id="5995131">*</span><span class="ident" id="5995132">addrParser</span><span class="op" id="5995142">)</span>&nbsp;<span class="ident" id="5995144">parseAddress</span><span class="op" id="5995156">(</span><span class="op" id="5995157">)</span>&nbsp;<span class="op" id="5995159">(</span><span class="ident" id="5995160">addr</span>&nbsp;<span class="op" id="5995165">*</span><span class="ident" id="5995166">Address</span><span class="op" id="5995173">,</span>&nbsp;<span class="ident" id="5995175">err</span>&nbsp;<span class="builtintype" id="5995179">error</span><span class="op" id="5995184">)</span>&nbsp;<span class="op" id="5995186">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995189">debug</span><span class="op" id="5995194">.</span><span class="ident" id="5995195">Printf</span><span class="op" id="5995201">(</span><span class="string" id="5995202">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="5995220">,</span>&nbsp;<span class="op" id="5995222">*</span><span class="ident" id="5995223">p</span><span class="op" id="5995224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995227">p</span><span class="op" id="5995228">.</span><span class="ident" id="5995229">skipSpace</span><span class="op" id="5995238">(</span><span class="op" id="5995239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995242">if</span>&nbsp;<span class="ident" id="5995245">p</span><span class="op" id="5995246">.</span><span class="ident" id="5995247">empty</span><span class="op" id="5995252">(</span><span class="op" id="5995253">)</span>&nbsp;<span class="op" id="5995255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995259">return</span>&nbsp;<span class="builtintype" id="5995266">nil</span><span class="op" id="5995269">,</span>&nbsp;<span class="ident" id="5995271">errors</span><span class="op" id="5995277">.</span><span class="ident" id="5995278">New</span><span class="op" id="5995281">(</span><span class="string" id="5995282">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="5995300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995303">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995307">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995343">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995395">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995455">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995511">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995555">spec</span><span class="op" id="5995559">,</span>&nbsp;<span class="ident" id="5995561">err</span>&nbsp;<span class="op" id="5995565">:=</span>&nbsp;<span class="ident" id="5995568">p</span><span class="op" id="5995569">.</span><span class="ident" id="5995570">consumeAddrSpec</span><span class="op" id="5995585">(</span><span class="op" id="5995586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995589">if</span>&nbsp;<span class="ident" id="5995592">err</span>&nbsp;<span class="op" id="5995596">==</span>&nbsp;<span class="builtintype" id="5995599">nil</span>&nbsp;<span class="op" id="5995603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995607">return</span>&nbsp;<span class="op" id="5995614">&amp;</span><span class="ident" id="5995615">Address</span><span class="op" id="5995622">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995627">Address</span><span class="op" id="5995634">:</span>&nbsp;<span class="ident" id="5995636">spec</span><span class="op" id="5995640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995644">}</span><span class="op" id="5995645">,</span>&nbsp;<span class="ident" id="5995647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995655">debug</span><span class="op" id="5995660">.</span><span class="ident" id="5995661">Printf</span><span class="op" id="5995667">(</span><span class="string" id="5995668">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="5995704">,</span>&nbsp;<span class="ident" id="5995706">err</span><span class="op" id="5995709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995712">debug</span><span class="op" id="5995717">.</span><span class="ident" id="5995718">Printf</span><span class="op" id="5995724">(</span><span class="string" id="5995725">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="5995756">,</span>&nbsp;<span class="op" id="5995758">*</span><span class="ident" id="5995759">p</span><span class="op" id="5995760">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995764">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995781">var</span>&nbsp;<span class="ident" id="5995785">displayName</span>&nbsp;<span class="builtintype" id="5995797">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995805">if</span>&nbsp;<span class="ident" id="5995808">p</span><span class="op" id="5995809">.</span><span class="ident" id="5995810">peek</span><span class="op" id="5995814">(</span><span class="op" id="5995815">)</span>&nbsp;<span class="op" id="5995817">!=</span>&nbsp;<span class="string" id="5995820">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5995824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995828">displayName</span><span class="op" id="5995839">,</span>&nbsp;<span class="ident" id="5995841">err</span>&nbsp;<span class="op" id="5995845">=</span>&nbsp;<span class="ident" id="5995847">p</span><span class="op" id="5995848">.</span><span class="ident" id="5995849">consumePhrase</span><span class="op" id="5995862">(</span><span class="op" id="5995863">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995867">if</span>&nbsp;<span class="ident" id="5995870">err</span>&nbsp;<span class="op" id="5995874">!=</span>&nbsp;<span class="builtintype" id="5995877">nil</span>&nbsp;<span class="op" id="5995881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5995886">return</span>&nbsp;<span class="builtintype" id="5995893">nil</span><span class="op" id="5995896">,</span>&nbsp;<span class="ident" id="5995898">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5995910">debug</span><span class="op" id="5995915">.</span><span class="ident" id="5995916">Printf</span><span class="op" id="5995922">(</span><span class="string" id="5995923">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="5995953">,</span>&nbsp;<span class="ident" id="5995955">displayName</span><span class="op" id="5995966">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5995970">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996005">p</span><span class="op" id="5996006">.</span><span class="ident" id="5996007">skipSpace</span><span class="op" id="5996016">(</span><span class="op" id="5996017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996020">if</span>&nbsp;<span class="op" id="5996023">!</span><span class="ident" id="5996024">p</span><span class="op" id="5996025">.</span><span class="ident" id="5996026">consume</span><span class="op" id="5996033">(</span><span class="string" id="5996034">&#39;&lt;&#39;</span><span class="op" id="5996037">)</span>&nbsp;<span class="op" id="5996039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996043">return</span>&nbsp;<span class="builtintype" id="5996050">nil</span><span class="op" id="5996053">,</span>&nbsp;<span class="ident" id="5996055">errors</span><span class="op" id="5996061">.</span><span class="ident" id="5996062">New</span><span class="op" id="5996065">(</span><span class="string" id="5996066">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="5996087">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996093">spec</span><span class="op" id="5996097">,</span>&nbsp;<span class="ident" id="5996099">err</span>&nbsp;<span class="op" id="5996103">=</span>&nbsp;<span class="ident" id="5996105">p</span><span class="op" id="5996106">.</span><span class="ident" id="5996107">consumeAddrSpec</span><span class="op" id="5996122">(</span><span class="op" id="5996123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996126">if</span>&nbsp;<span class="ident" id="5996129">err</span>&nbsp;<span class="op" id="5996133">!=</span>&nbsp;<span class="builtintype" id="5996136">nil</span>&nbsp;<span class="op" id="5996140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996144">return</span>&nbsp;<span class="builtintype" id="5996151">nil</span><span class="op" id="5996154">,</span>&nbsp;<span class="ident" id="5996156">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996161">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996164">if</span>&nbsp;<span class="op" id="5996167">!</span><span class="ident" id="5996168">p</span><span class="op" id="5996169">.</span><span class="ident" id="5996170">consume</span><span class="op" id="5996177">(</span><span class="string" id="5996178">&#39;&gt;&#39;</span><span class="op" id="5996181">)</span>&nbsp;<span class="op" id="5996183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996187">return</span>&nbsp;<span class="builtintype" id="5996194">nil</span><span class="op" id="5996197">,</span>&nbsp;<span class="ident" id="5996199">errors</span><span class="op" id="5996205">.</span><span class="ident" id="5996206">New</span><span class="op" id="5996209">(</span><span class="string" id="5996210">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="5996237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996243">debug</span><span class="op" id="5996248">.</span><span class="ident" id="5996249">Printf</span><span class="op" id="5996255">(</span><span class="string" id="5996256">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="5996279">,</span>&nbsp;<span class="ident" id="5996281">spec</span><span class="op" id="5996285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996289">return</span>&nbsp;<span class="op" id="5996296">&amp;</span><span class="ident" id="5996297">Address</span><span class="op" id="5996304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996308">Name</span><span class="op" id="5996312">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996317">displayName</span><span class="op" id="5996328">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996332">Address</span><span class="op" id="5996339">:</span>&nbsp;<span class="ident" id="5996341">spec</span><span class="op" id="5996345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996348">}</span><span class="op" id="5996349">,</span>&nbsp;<span class="builtintype" id="5996351">nil</span><br>
<span class="lineno"></span><span class="op" id="5996355">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5996358">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5996431">func</span>&nbsp;<span class="op" id="5996436">(</span><span class="ident" id="5996437">p</span>&nbsp;<span class="op" id="5996439">*</span><span class="ident" id="5996440">addrParser</span><span class="op" id="5996450">)</span>&nbsp;<span class="ident" id="5996452">consumeAddrSpec</span><span class="op" id="5996467">(</span><span class="op" id="5996468">)</span>&nbsp;<span class="op" id="5996470">(</span><span class="ident" id="5996471">spec</span>&nbsp;<span class="builtintype" id="5996476">string</span><span class="op" id="5996482">,</span>&nbsp;<span class="ident" id="5996484">err</span>&nbsp;<span class="builtintype" id="5996488">error</span><span class="op" id="5996493">)</span>&nbsp;<span class="op" id="5996495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996498">debug</span><span class="op" id="5996503">.</span><span class="ident" id="5996504">Printf</span><span class="op" id="5996510">(</span><span class="string" id="5996511">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="5996532">,</span>&nbsp;<span class="op" id="5996534">*</span><span class="ident" id="5996535">p</span><span class="op" id="5996536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996540">orig</span>&nbsp;<span class="op" id="5996545">:=</span>&nbsp;<span class="op" id="5996548">*</span><span class="ident" id="5996549">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996552">defer</span>&nbsp;<span class="keyword" id="5996558">func</span><span class="op" id="5996562">(</span><span class="op" id="5996563">)</span>&nbsp;<span class="op" id="5996565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996569">if</span>&nbsp;<span class="ident" id="5996572">err</span>&nbsp;<span class="op" id="5996576">!=</span>&nbsp;<span class="builtintype" id="5996579">nil</span>&nbsp;<span class="op" id="5996583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996588">*</span><span class="ident" id="5996589">p</span>&nbsp;<span class="op" id="5996591">=</span>&nbsp;<span class="ident" id="5996593">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996600">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996603">}</span><span class="op" id="5996604">(</span><span class="op" id="5996605">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5996609">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996651">var</span>&nbsp;<span class="ident" id="5996655">localPart</span>&nbsp;<span class="builtintype" id="5996665">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996673">p</span><span class="op" id="5996674">.</span><span class="ident" id="5996675">skipSpace</span><span class="op" id="5996684">(</span><span class="op" id="5996685">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996688">if</span>&nbsp;<span class="ident" id="5996691">p</span><span class="op" id="5996692">.</span><span class="ident" id="5996693">empty</span><span class="op" id="5996698">(</span><span class="op" id="5996699">)</span>&nbsp;<span class="op" id="5996701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996705">return</span>&nbsp;<span class="string" id="5996712">&#34;&#34;</span><span class="op" id="5996714">,</span>&nbsp;<span class="ident" id="5996716">errors</span><span class="op" id="5996722">.</span><span class="ident" id="5996723">New</span><span class="op" id="5996726">(</span><span class="string" id="5996727">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="5996747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5996753">if</span>&nbsp;<span class="ident" id="5996756">p</span><span class="op" id="5996757">.</span><span class="ident" id="5996758">peek</span><span class="op" id="5996762">(</span><span class="op" id="5996763">)</span>&nbsp;<span class="op" id="5996765">==</span>&nbsp;<span class="string" id="5996768">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5996772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5996776">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996795">debug</span><span class="op" id="5996800">.</span><span class="ident" id="5996801">Printf</span><span class="op" id="5996807">(</span><span class="string" id="5996808">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="5996848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996852">localPart</span><span class="op" id="5996861">,</span>&nbsp;<span class="ident" id="5996863">err</span>&nbsp;<span class="op" id="5996867">=</span>&nbsp;<span class="ident" id="5996869">p</span><span class="op" id="5996870">.</span><span class="ident" id="5996871">consumeQuotedString</span><span class="op" id="5996890">(</span><span class="op" id="5996891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5996894">}</span>&nbsp;<span class="keyword" id="5996896">else</span>&nbsp;<span class="op" id="5996901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5996905">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996919">debug</span><span class="op" id="5996924">.</span><span class="ident" id="5996925">Printf</span><span class="op" id="5996931">(</span><span class="string" id="5996932">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="5996967">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5996971">localPart</span><span class="op" id="5996980">,</span>&nbsp;<span class="ident" id="5996982">err</span>&nbsp;<span class="op" id="5996986">=</span>&nbsp;<span class="ident" id="5996988">p</span><span class="op" id="5996989">.</span><span class="ident" id="5996990">consumeAtom</span><span class="op" id="5997001">(</span><span class="builtintype" id="5997002">true</span><span class="op" id="5997006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997012">if</span>&nbsp;<span class="ident" id="5997015">err</span>&nbsp;<span class="op" id="5997019">!=</span>&nbsp;<span class="builtintype" id="5997022">nil</span>&nbsp;<span class="op" id="5997026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997030">debug</span><span class="op" id="5997035">.</span><span class="ident" id="5997036">Printf</span><span class="op" id="5997042">(</span><span class="string" id="5997043">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="5997072">,</span>&nbsp;<span class="ident" id="5997074">err</span><span class="op" id="5997077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997081">return</span>&nbsp;<span class="string" id="5997088">&#34;&#34;</span><span class="op" id="5997090">,</span>&nbsp;<span class="ident" id="5997092">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997101">if</span>&nbsp;<span class="op" id="5997104">!</span><span class="ident" id="5997105">p</span><span class="op" id="5997106">.</span><span class="ident" id="5997107">consume</span><span class="op" id="5997114">(</span><span class="string" id="5997115">&#39;@&#39;</span><span class="op" id="5997118">)</span>&nbsp;<span class="op" id="5997120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997124">return</span>&nbsp;<span class="string" id="5997131">&#34;&#34;</span><span class="op" id="5997133">,</span>&nbsp;<span class="ident" id="5997135">errors</span><span class="op" id="5997141">.</span><span class="ident" id="5997142">New</span><span class="op" id="5997145">(</span><span class="string" id="5997146">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5997176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997179">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997183">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997222">var</span>&nbsp;<span class="ident" id="5997226">domain</span>&nbsp;<span class="builtintype" id="5997233">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997241">p</span><span class="op" id="5997242">.</span><span class="ident" id="5997243">skipSpace</span><span class="op" id="5997252">(</span><span class="op" id="5997253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997256">if</span>&nbsp;<span class="ident" id="5997259">p</span><span class="op" id="5997260">.</span><span class="ident" id="5997261">empty</span><span class="op" id="5997266">(</span><span class="op" id="5997267">)</span>&nbsp;<span class="op" id="5997269">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997273">return</span>&nbsp;<span class="string" id="5997280">&#34;&#34;</span><span class="op" id="5997282">,</span>&nbsp;<span class="ident" id="5997284">errors</span><span class="op" id="5997290">.</span><span class="ident" id="5997291">New</span><span class="op" id="5997294">(</span><span class="string" id="5997295">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5997325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997331">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997373">domain</span><span class="op" id="5997379">,</span>&nbsp;<span class="ident" id="5997381">err</span>&nbsp;<span class="op" id="5997385">=</span>&nbsp;<span class="ident" id="5997387">p</span><span class="op" id="5997388">.</span><span class="ident" id="5997389">consumeAtom</span><span class="op" id="5997400">(</span><span class="builtintype" id="5997401">true</span><span class="op" id="5997405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997408">if</span>&nbsp;<span class="ident" id="5997411">err</span>&nbsp;<span class="op" id="5997415">!=</span>&nbsp;<span class="builtintype" id="5997418">nil</span>&nbsp;<span class="op" id="5997422">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997426">return</span>&nbsp;<span class="string" id="5997433">&#34;&#34;</span><span class="op" id="5997435">,</span>&nbsp;<span class="ident" id="5997437">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997446">return</span>&nbsp;<span class="ident" id="5997453">localPart</span>&nbsp;<span class="op" id="5997463">+</span>&nbsp;<span class="string" id="5997465">&#34;@&#34;</span>&nbsp;<span class="op" id="5997469">+</span>&nbsp;<span class="ident" id="5997471">domain</span><span class="op" id="5997477">,</span>&nbsp;<span class="builtintype" id="5997479">nil</span><br>
<span class="lineno"></span><span class="op" id="5997483">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="5997486">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5997549">func</span>&nbsp;<span class="op" id="5997554">(</span><span class="ident" id="5997555">p</span>&nbsp;<span class="op" id="5997557">*</span><span class="ident" id="5997558">addrParser</span><span class="op" id="5997568">)</span>&nbsp;<span class="ident" id="5997570">consumePhrase</span><span class="op" id="5997583">(</span><span class="op" id="5997584">)</span>&nbsp;<span class="op" id="5997586">(</span><span class="ident" id="5997587">phrase</span>&nbsp;<span class="builtintype" id="5997594">string</span><span class="op" id="5997600">,</span>&nbsp;<span class="ident" id="5997602">err</span>&nbsp;<span class="builtintype" id="5997606">error</span><span class="op" id="5997611">)</span>&nbsp;<span class="op" id="5997613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997616">debug</span><span class="op" id="5997621">.</span><span class="ident" id="5997622">Printf</span><span class="op" id="5997628">(</span><span class="string" id="5997629">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="5997650">,</span>&nbsp;<span class="op" id="5997652">*</span><span class="ident" id="5997653">p</span><span class="op" id="5997654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997657">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997677">var</span>&nbsp;<span class="ident" id="5997681">words</span>&nbsp;<span class="op" id="5997687">[</span><span class="op" id="5997688">]</span><span class="builtintype" id="5997689">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997697">for</span>&nbsp;<span class="op" id="5997701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997705">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997738">var</span>&nbsp;<span class="ident" id="5997742">word</span>&nbsp;<span class="builtintype" id="5997747">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997756">p</span><span class="op" id="5997757">.</span><span class="ident" id="5997758">skipSpace</span><span class="op" id="5997767">(</span><span class="op" id="5997768">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997772">if</span>&nbsp;<span class="ident" id="5997775">p</span><span class="op" id="5997776">.</span><span class="ident" id="5997777">empty</span><span class="op" id="5997782">(</span><span class="op" id="5997783">)</span>&nbsp;<span class="op" id="5997785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997790">return</span>&nbsp;<span class="string" id="5997797">&#34;&#34;</span><span class="op" id="5997799">,</span>&nbsp;<span class="ident" id="5997801">errors</span><span class="op" id="5997807">.</span><span class="ident" id="5997808">New</span><span class="op" id="5997811">(</span><span class="string" id="5997812">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="5997834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997842">if</span>&nbsp;<span class="ident" id="5997845">p</span><span class="op" id="5997846">.</span><span class="ident" id="5997847">peek</span><span class="op" id="5997851">(</span><span class="op" id="5997852">)</span>&nbsp;<span class="op" id="5997854">==</span>&nbsp;<span class="string" id="5997857">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5997861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997866">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997886">word</span><span class="op" id="5997890">,</span>&nbsp;<span class="ident" id="5997892">err</span>&nbsp;<span class="op" id="5997896">=</span>&nbsp;<span class="ident" id="5997898">p</span><span class="op" id="5997899">.</span><span class="ident" id="5997900">consumeQuotedString</span><span class="op" id="5997919">(</span><span class="op" id="5997920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997924">}</span>&nbsp;<span class="keyword" id="5997926">else</span>&nbsp;<span class="op" id="5997931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997936">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997947">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5998007">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998043">word</span><span class="op" id="5998047">,</span>&nbsp;<span class="ident" id="5998049">err</span>&nbsp;<span class="op" id="5998053">=</span>&nbsp;<span class="ident" id="5998055">p</span><span class="op" id="5998056">.</span><span class="ident" id="5998057">consumeAtom</span><span class="op" id="5998068">(</span><span class="builtintype" id="5998069">true</span><span class="op" id="5998073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5998082">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998161">if</span>&nbsp;<span class="ident" id="5998164">err</span>&nbsp;<span class="op" id="5998168">==</span>&nbsp;<span class="builtintype" id="5998171">nil</span>&nbsp;<span class="op" id="5998175">&amp;&amp;</span>&nbsp;<span class="ident" id="5998178">strings</span><span class="op" id="5998185">.</span><span class="ident" id="5998186">HasPrefix</span><span class="op" id="5998195">(</span><span class="ident" id="5998196">word</span><span class="op" id="5998200">,</span>&nbsp;<span class="string" id="5998202">&#34;=?&#34;</span><span class="op" id="5998206">)</span>&nbsp;<span class="op" id="5998208">&amp;&amp;</span>&nbsp;<span class="ident" id="5998211">strings</span><span class="op" id="5998218">.</span><span class="ident" id="5998219">HasSuffix</span><span class="op" id="5998228">(</span><span class="ident" id="5998229">word</span><span class="op" id="5998233">,</span>&nbsp;<span class="string" id="5998235">&#34;?=&#34;</span><span class="op" id="5998239">)</span>&nbsp;<span class="op" id="5998241">&amp;&amp;</span>&nbsp;<span class="ident" id="5998244">strings</span><span class="op" id="5998251">.</span><span class="ident" id="5998252">Count</span><span class="op" id="5998257">(</span><span class="ident" id="5998258">word</span><span class="op" id="5998262">,</span>&nbsp;<span class="string" id="5998264">&#34;?&#34;</span><span class="op" id="5998267">)</span>&nbsp;<span class="op" id="5998269">==</span>&nbsp;<span class="num" id="5998272">4</span>&nbsp;<span class="op" id="5998274">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998279">word</span><span class="op" id="5998283">,</span>&nbsp;<span class="ident" id="5998285">err</span>&nbsp;<span class="op" id="5998289">=</span>&nbsp;<span class="ident" id="5998291">decodeRFC2047Word</span><span class="op" id="5998308">(</span><span class="ident" id="5998309">word</span><span class="op" id="5998313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998322">if</span>&nbsp;<span class="ident" id="5998325">err</span>&nbsp;<span class="op" id="5998329">!=</span>&nbsp;<span class="builtintype" id="5998332">nil</span>&nbsp;<span class="op" id="5998336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998341">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998353">debug</span><span class="op" id="5998358">.</span><span class="ident" id="5998359">Printf</span><span class="op" id="5998365">(</span><span class="string" id="5998366">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="5998394">,</span>&nbsp;<span class="ident" id="5998396">word</span><span class="op" id="5998400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998404">words</span>&nbsp;<span class="op" id="5998410">=</span>&nbsp;<span class="builtinfunc" id="5998412">append</span><span class="op" id="5998418">(</span><span class="ident" id="5998419">words</span><span class="op" id="5998424">,</span>&nbsp;<span class="ident" id="5998426">word</span><span class="op" id="5998430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5998436">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998486">if</span>&nbsp;<span class="ident" id="5998489">err</span>&nbsp;<span class="op" id="5998493">!=</span>&nbsp;<span class="builtintype" id="5998496">nil</span>&nbsp;<span class="op" id="5998500">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5998503">len</span><span class="op" id="5998506">(</span><span class="ident" id="5998507">words</span><span class="op" id="5998512">)</span>&nbsp;<span class="op" id="5998514">==</span>&nbsp;<span class="num" id="5998517">0</span>&nbsp;<span class="op" id="5998519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998523">debug</span><span class="op" id="5998528">.</span><span class="ident" id="5998529">Printf</span><span class="op" id="5998535">(</span><span class="string" id="5998536">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="5998564">,</span>&nbsp;<span class="ident" id="5998566">err</span><span class="op" id="5998569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998573">return</span>&nbsp;<span class="string" id="5998580">&#34;&#34;</span><span class="op" id="5998582">,</span>&nbsp;<span class="ident" id="5998584">fmt</span><span class="op" id="5998587">.</span><span class="ident" id="5998588">Errorf</span><span class="op" id="5998594">(</span><span class="string" id="5998595">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="5998629">,</span>&nbsp;<span class="ident" id="5998631">err</span><span class="op" id="5998634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998640">phrase</span>&nbsp;<span class="op" id="5998647">=</span>&nbsp;<span class="ident" id="5998649">strings</span><span class="op" id="5998656">.</span><span class="ident" id="5998657">Join</span><span class="op" id="5998661">(</span><span class="ident" id="5998662">words</span><span class="op" id="5998667">,</span>&nbsp;<span class="string" id="5998669">&#34;&nbsp;&#34;</span><span class="op" id="5998672">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998675">return</span>&nbsp;<span class="ident" id="5998682">phrase</span><span class="op" id="5998688">,</span>&nbsp;<span class="builtintype" id="5998690">nil</span><br>
<span class="lineno"></span><span class="op" id="5998694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5998697">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5998764">func</span>&nbsp;<span class="op" id="5998769">(</span><span class="ident" id="5998770">p</span>&nbsp;<span class="op" id="5998772">*</span><span class="ident" id="5998773">addrParser</span><span class="op" id="5998783">)</span>&nbsp;<span class="ident" id="5998785">consumeQuotedString</span><span class="op" id="5998804">(</span><span class="op" id="5998805">)</span>&nbsp;<span class="op" id="5998807">(</span><span class="ident" id="5998808">qs</span>&nbsp;<span class="builtintype" id="5998811">string</span><span class="op" id="5998817">,</span>&nbsp;<span class="ident" id="5998819">err</span>&nbsp;<span class="builtintype" id="5998823">error</span><span class="op" id="5998828">)</span>&nbsp;<span class="op" id="5998830">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5998833">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998863">i</span>&nbsp;<span class="op" id="5998865">:=</span>&nbsp;<span class="num" id="5998868">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998871">qsb</span>&nbsp;<span class="op" id="5998875">:=</span>&nbsp;<span class="builtinfunc" id="5998878">make</span><span class="op" id="5998882">(</span><span class="op" id="5998883">[</span><span class="op" id="5998884">]</span><span class="builtintype" id="5998885">byte</span><span class="op" id="5998889">,</span>&nbsp;<span class="num" id="5998891">0</span><span class="op" id="5998892">,</span>&nbsp;<span class="num" id="5998894">10</span><span class="op" id="5998896">)</span><br>
<span class="lineno"></span><span class="ident" id="5998898">Loop</span><span class="op" id="5998902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998905">for</span>&nbsp;<span class="op" id="5998909">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998913">if</span>&nbsp;<span class="ident" id="5998916">i</span>&nbsp;<span class="op" id="5998918">&gt;=</span>&nbsp;<span class="ident" id="5998921">p</span><span class="op" id="5998922">.</span><span class="builtinfunc" id="5998923">len</span><span class="op" id="5998926">(</span><span class="op" id="5998927">)</span>&nbsp;<span class="op" id="5998929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998934">return</span>&nbsp;<span class="string" id="5998941">&#34;&#34;</span><span class="op" id="5998943">,</span>&nbsp;<span class="ident" id="5998945">errors</span><span class="op" id="5998951">.</span><span class="ident" id="5998952">New</span><span class="op" id="5998955">(</span><span class="string" id="5998956">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5998986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998994">switch</span>&nbsp;<span class="ident" id="5999001">c</span>&nbsp;<span class="op" id="5999003">:=</span>&nbsp;<span class="op" id="5999006">(</span><span class="op" id="5999007">*</span><span class="ident" id="5999008">p</span><span class="op" id="5999009">)</span><span class="op" id="5999010">[</span><span class="ident" id="5999011">i</span><span class="op" id="5999012">]</span><span class="op" id="5999013">;</span>&nbsp;<span class="op" id="5999015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999019">case</span>&nbsp;<span class="ident" id="5999024">c</span>&nbsp;<span class="op" id="5999026">==</span>&nbsp;<span class="string" id="5999029">&#39;&#34;&#39;</span><span class="op" id="5999032">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999037">break</span>&nbsp;<span class="ident" id="5999043">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999050">case</span>&nbsp;<span class="ident" id="5999055">c</span>&nbsp;<span class="op" id="5999057">==</span>&nbsp;<span class="string" id="5999060">&#39;\\&#39;</span><span class="op" id="5999064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999069">if</span>&nbsp;<span class="ident" id="5999072">i</span><span class="op" id="5999073">+</span><span class="num" id="5999074">1</span>&nbsp;<span class="op" id="5999076">==</span>&nbsp;<span class="ident" id="5999079">p</span><span class="op" id="5999080">.</span><span class="builtinfunc" id="5999081">len</span><span class="op" id="5999084">(</span><span class="op" id="5999085">)</span>&nbsp;<span class="op" id="5999087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999093">return</span>&nbsp;<span class="string" id="5999100">&#34;&#34;</span><span class="op" id="5999102">,</span>&nbsp;<span class="ident" id="5999104">errors</span><span class="op" id="5999110">.</span><span class="ident" id="5999111">New</span><span class="op" id="5999114">(</span><span class="string" id="5999115">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5999145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999150">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999155">qsb</span>&nbsp;<span class="op" id="5999159">=</span>&nbsp;<span class="builtinfunc" id="5999161">append</span><span class="op" id="5999167">(</span><span class="ident" id="5999168">qsb</span><span class="op" id="5999171">,</span>&nbsp;<span class="op" id="5999173">(</span><span class="op" id="5999174">*</span><span class="ident" id="5999175">p</span><span class="op" id="5999176">)</span><span class="op" id="5999177">[</span><span class="ident" id="5999178">i</span><span class="op" id="5999179">+</span><span class="num" id="5999180">1</span><span class="op" id="5999181">]</span><span class="op" id="5999182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999187">i</span>&nbsp;<span class="op" id="5999189">+=</span>&nbsp;<span class="num" id="5999192">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999196">case</span>&nbsp;<span class="ident" id="5999201">isQtext</span><span class="op" id="5999208">(</span><span class="ident" id="5999209">c</span><span class="op" id="5999210">)</span><span class="op" id="5999211">,</span>&nbsp;<span class="ident" id="5999213">c</span>&nbsp;<span class="op" id="5999215">==</span>&nbsp;<span class="string" id="5999218">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5999222">||</span>&nbsp;<span class="ident" id="5999225">c</span>&nbsp;<span class="op" id="5999227">==</span>&nbsp;<span class="string" id="5999230">&#39;\t&#39;</span><span class="op" id="5999234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5999239">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5999294">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999334">qsb</span>&nbsp;<span class="op" id="5999338">=</span>&nbsp;<span class="builtinfunc" id="5999340">append</span><span class="op" id="5999346">(</span><span class="ident" id="5999347">qsb</span><span class="op" id="5999350">,</span>&nbsp;<span class="ident" id="5999352">c</span><span class="op" id="5999353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999358">i</span><span class="op" id="5999359">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999364">default</span><span class="op" id="5999371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999376">return</span>&nbsp;<span class="string" id="5999383">&#34;&#34;</span><span class="op" id="5999385">,</span>&nbsp;<span class="ident" id="5999387">fmt</span><span class="op" id="5999390">.</span><span class="ident" id="5999391">Errorf</span><span class="op" id="5999397">(</span><span class="string" id="5999398">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="5999440">,</span>&nbsp;<span class="ident" id="5999442">c</span><span class="op" id="5999443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999447">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999453">*</span><span class="ident" id="5999454">p</span>&nbsp;<span class="op" id="5999456">=</span>&nbsp;<span class="op" id="5999458">(</span><span class="op" id="5999459">*</span><span class="ident" id="5999460">p</span><span class="op" id="5999461">)</span><span class="op" id="5999462">[</span><span class="ident" id="5999463">i</span><span class="op" id="5999464">+</span><span class="num" id="5999465">1</span><span class="op" id="5999466">:</span><span class="op" id="5999467">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999470">return</span>&nbsp;<span class="builtintype" id="5999477">string</span><span class="op" id="5999483">(</span><span class="ident" id="5999484">qsb</span><span class="op" id="5999487">)</span><span class="op" id="5999488">,</span>&nbsp;<span class="builtintype" id="5999490">nil</span><br>
<span class="lineno"></span><span class="op" id="5999494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="5999497">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="5999555">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5999623">func</span>&nbsp;<span class="op" id="5999628">(</span><span class="ident" id="5999629">p</span>&nbsp;<span class="op" id="5999631">*</span><span class="ident" id="5999632">addrParser</span><span class="op" id="5999642">)</span>&nbsp;<span class="ident" id="5999644">consumeAtom</span><span class="op" id="5999655">(</span><span class="ident" id="5999656">dot</span>&nbsp;<span class="builtintype" id="5999660">bool</span><span class="op" id="5999664">)</span>&nbsp;<span class="op" id="5999666">(</span><span class="ident" id="5999667">atom</span>&nbsp;<span class="builtintype" id="5999672">string</span><span class="op" id="5999678">,</span>&nbsp;<span class="ident" id="5999680">err</span>&nbsp;<span class="builtintype" id="5999684">error</span><span class="op" id="5999689">)</span>&nbsp;<span class="op" id="5999691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999694">if</span>&nbsp;<span class="op" id="5999697">!</span><span class="ident" id="5999698">isAtext</span><span class="op" id="5999705">(</span><span class="ident" id="5999706">p</span><span class="op" id="5999707">.</span><span class="ident" id="5999708">peek</span><span class="op" id="5999712">(</span><span class="op" id="5999713">)</span><span class="op" id="5999714">,</span>&nbsp;<span class="builtintype" id="5999716">false</span><span class="op" id="5999721">)</span>&nbsp;<span class="op" id="5999723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999727">return</span>&nbsp;<span class="string" id="5999734">&#34;&#34;</span><span class="op" id="5999736">,</span>&nbsp;<span class="ident" id="5999738">errors</span><span class="op" id="5999744">.</span><span class="ident" id="5999745">New</span><span class="op" id="5999748">(</span><span class="string" id="5999749">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="5999771">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999777">i</span>&nbsp;<span class="op" id="5999779">:=</span>&nbsp;<span class="num" id="5999782">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999785">for</span>&nbsp;<span class="op" id="5999789">;</span>&nbsp;<span class="ident" id="5999791">i</span>&nbsp;<span class="op" id="5999793">&lt;</span>&nbsp;<span class="ident" id="5999795">p</span><span class="op" id="5999796">.</span><span class="builtinfunc" id="5999797">len</span><span class="op" id="5999800">(</span><span class="op" id="5999801">)</span>&nbsp;<span class="op" id="5999803">&amp;&amp;</span>&nbsp;<span class="ident" id="5999806">isAtext</span><span class="op" id="5999813">(</span><span class="op" id="5999814">(</span><span class="op" id="5999815">*</span><span class="ident" id="5999816">p</span><span class="op" id="5999817">)</span><span class="op" id="5999818">[</span><span class="ident" id="5999819">i</span><span class="op" id="5999820">]</span><span class="op" id="5999821">,</span>&nbsp;<span class="ident" id="5999823">dot</span><span class="op" id="5999826">)</span><span class="op" id="5999827">;</span>&nbsp;<span class="ident" id="5999829">i</span><span class="op" id="5999830">++</span>&nbsp;<span class="op" id="5999833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999839">atom</span><span class="op" id="5999843">,</span>&nbsp;<span class="op" id="5999845">*</span><span class="ident" id="5999846">p</span>&nbsp;<span class="op" id="5999848">=</span>&nbsp;<span class="builtintype" id="5999850">string</span><span class="op" id="5999856">(</span><span class="op" id="5999857">(</span><span class="op" id="5999858">*</span><span class="ident" id="5999859">p</span><span class="op" id="5999860">)</span><span class="op" id="5999861">[</span><span class="op" id="5999862">:</span><span class="ident" id="5999863">i</span><span class="op" id="5999864">]</span><span class="op" id="5999865">)</span><span class="op" id="5999866">,</span>&nbsp;<span class="op" id="5999868">(</span><span class="op" id="5999869">*</span><span class="ident" id="5999870">p</span><span class="op" id="5999871">)</span><span class="op" id="5999872">[</span><span class="ident" id="5999873">i</span><span class="op" id="5999874">:</span><span class="op" id="5999875">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999878">return</span>&nbsp;<span class="ident" id="5999885">atom</span><span class="op" id="5999889">,</span>&nbsp;<span class="builtintype" id="5999891">nil</span><br>
<span class="lineno"></span><span class="op" id="5999895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5999898">func</span>&nbsp;<span class="op" id="5999903">(</span><span class="ident" id="5999904">p</span>&nbsp;<span class="op" id="5999906">*</span><span class="ident" id="5999907">addrParser</span><span class="op" id="5999917">)</span>&nbsp;<span class="ident" id="5999919">consume</span><span class="op" id="5999926">(</span><span class="ident" id="5999927">c</span>&nbsp;<span class="builtintype" id="5999929">byte</span><span class="op" id="5999933">)</span>&nbsp;<span class="builtintype" id="5999935">bool</span>&nbsp;<span class="op" id="5999940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999943">if</span>&nbsp;<span class="ident" id="5999946">p</span><span class="op" id="5999947">.</span><span class="ident" id="5999948">empty</span><span class="op" id="5999953">(</span><span class="op" id="5999954">)</span>&nbsp;<span class="op" id="5999956">||</span>&nbsp;<span class="ident" id="5999959">p</span><span class="op" id="5999960">.</span><span class="ident" id="5999961">peek</span><span class="op" id="5999965">(</span><span class="op" id="5999966">)</span>&nbsp;<span class="op" id="5999968">!=</span>&nbsp;<span class="ident" id="5999971">c</span>&nbsp;<span class="op" id="5999973">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999977">return</span>&nbsp;<span class="builtintype" id="5999984">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999994">*</span><span class="ident" id="5999995">p</span>&nbsp;<span class="op" id="5999997">=</span>&nbsp;<span class="op" id="5999999">(</span><span class="op" id="6000000">*</span><span class="ident" id="6000001">p</span><span class="op" id="6000002">)</span><span class="op" id="6000003">[</span><span class="num" id="6000004">1</span><span class="op" id="6000005">:</span><span class="op" id="6000006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000009">return</span>&nbsp;<span class="builtintype" id="6000016">true</span><br>
<span class="lineno"></span><span class="op" id="6000021">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="6000024">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="6000081">func</span>&nbsp;<span class="op" id="6000086">(</span><span class="ident" id="6000087">p</span>&nbsp;<span class="op" id="6000089">*</span><span class="ident" id="6000090">addrParser</span><span class="op" id="6000100">)</span>&nbsp;<span class="ident" id="6000102">skipSpace</span><span class="op" id="6000111">(</span><span class="op" id="6000112">)</span>&nbsp;<span class="op" id="6000114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000117">*</span><span class="ident" id="6000118">p</span>&nbsp;<span class="op" id="6000120">=</span>&nbsp;<span class="ident" id="6000122">bytes</span><span class="op" id="6000127">.</span><span class="ident" id="6000128">TrimLeft</span><span class="op" id="6000136">(</span><span class="op" id="6000137">*</span><span class="ident" id="6000138">p</span><span class="op" id="6000139">,</span>&nbsp;<span class="string" id="6000141">&#34;&nbsp;\t&#34;</span><span class="op" id="6000146">)</span><br>
<span class="lineno"></span><span class="op" id="6000148">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="6000151">func</span>&nbsp;<span class="op" id="6000156">(</span><span class="ident" id="6000157">p</span>&nbsp;<span class="op" id="6000159">*</span><span class="ident" id="6000160">addrParser</span><span class="op" id="6000170">)</span>&nbsp;<span class="ident" id="6000172">peek</span><span class="op" id="6000176">(</span><span class="op" id="6000177">)</span>&nbsp;<span class="builtintype" id="6000179">byte</span>&nbsp;<span class="op" id="6000184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000187">return</span>&nbsp;<span class="op" id="6000194">(</span><span class="op" id="6000195">*</span><span class="ident" id="6000196">p</span><span class="op" id="6000197">)</span><span class="op" id="6000198">[</span><span class="num" id="6000199">0</span><span class="op" id="6000200">]</span><br>
<span class="lineno"></span><span class="op" id="6000202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6000205">func</span>&nbsp;<span class="op" id="6000210">(</span><span class="ident" id="6000211">p</span>&nbsp;<span class="op" id="6000213">*</span><span class="ident" id="6000214">addrParser</span><span class="op" id="6000224">)</span>&nbsp;<span class="ident" id="6000226">empty</span><span class="op" id="6000231">(</span><span class="op" id="6000232">)</span>&nbsp;<span class="builtintype" id="6000234">bool</span>&nbsp;<span class="op" id="6000239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000242">return</span>&nbsp;<span class="ident" id="6000249">p</span><span class="op" id="6000250">.</span><span class="builtinfunc" id="6000251">len</span><span class="op" id="6000254">(</span><span class="op" id="6000255">)</span>&nbsp;<span class="op" id="6000257">==</span>&nbsp;<span class="num" id="6000260">0</span><br>
<span class="lineno"></span><span class="op" id="6000262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6000265">func</span>&nbsp;<span class="op" id="6000270">(</span><span class="ident" id="6000271">p</span>&nbsp;<span class="op" id="6000273">*</span><span class="ident" id="6000274">addrParser</span><span class="op" id="6000284">)</span>&nbsp;<span class="builtinfunc" id="6000286">len</span><span class="op" id="6000289">(</span><span class="op" id="6000290">)</span>&nbsp;<span class="builtintype" id="6000292">int</span>&nbsp;<span class="op" id="6000296">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000299">return</span>&nbsp;<span class="builtinfunc" id="6000306">len</span><span class="op" id="6000309">(</span><span class="op" id="6000310">*</span><span class="ident" id="6000311">p</span><span class="op" id="6000312">)</span><br>
<span class="lineno"></span><span class="op" id="6000314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6000317">func</span>&nbsp;<span class="ident" id="6000322">decodeRFC2047Word</span><span class="op" id="6000339">(</span><span class="ident" id="6000340">s</span>&nbsp;<span class="builtintype" id="6000342">string</span><span class="op" id="6000348">)</span>&nbsp;<span class="op" id="6000350">(</span><span class="builtintype" id="6000351">string</span><span class="op" id="6000357">,</span>&nbsp;<span class="builtintype" id="6000359">error</span><span class="op" id="6000364">)</span>&nbsp;<span class="op" id="6000366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000369">fields</span>&nbsp;<span class="op" id="6000376">:=</span>&nbsp;<span class="ident" id="6000379">strings</span><span class="op" id="6000386">.</span><span class="ident" id="6000387">Split</span><span class="op" id="6000392">(</span><span class="ident" id="6000393">s</span><span class="op" id="6000394">,</span>&nbsp;<span class="string" id="6000396">&#34;?&#34;</span><span class="op" id="6000399">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000402">if</span>&nbsp;<span class="builtinfunc" id="6000405">len</span><span class="op" id="6000408">(</span><span class="ident" id="6000409">fields</span><span class="op" id="6000415">)</span>&nbsp;<span class="op" id="6000417">!=</span>&nbsp;<span class="num" id="6000420">5</span>&nbsp;<span class="op" id="6000422">||</span>&nbsp;<span class="ident" id="6000425">fields</span><span class="op" id="6000431">[</span><span class="num" id="6000432">0</span><span class="op" id="6000433">]</span>&nbsp;<span class="op" id="6000435">!=</span>&nbsp;<span class="string" id="6000438">&#34;=&#34;</span>&nbsp;<span class="op" id="6000442">||</span>&nbsp;<span class="ident" id="6000445">fields</span><span class="op" id="6000451">[</span><span class="num" id="6000452">4</span><span class="op" id="6000453">]</span>&nbsp;<span class="op" id="6000455">!=</span>&nbsp;<span class="string" id="6000458">&#34;=&#34;</span>&nbsp;<span class="op" id="6000462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000466">return</span>&nbsp;<span class="string" id="6000473">&#34;&#34;</span><span class="op" id="6000475">,</span>&nbsp;<span class="ident" id="6000477">errors</span><span class="op" id="6000483">.</span><span class="ident" id="6000484">New</span><span class="op" id="6000487">(</span><span class="string" id="6000488">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="6000518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000524">charset</span><span class="op" id="6000531">,</span>&nbsp;<span class="ident" id="6000533">enc</span>&nbsp;<span class="op" id="6000537">:=</span>&nbsp;<span class="ident" id="6000540">strings</span><span class="op" id="6000547">.</span><span class="ident" id="6000548">ToLower</span><span class="op" id="6000555">(</span><span class="ident" id="6000556">fields</span><span class="op" id="6000562">[</span><span class="num" id="6000563">1</span><span class="op" id="6000564">]</span><span class="op" id="6000565">)</span><span class="op" id="6000566">,</span>&nbsp;<span class="ident" id="6000568">strings</span><span class="op" id="6000575">.</span><span class="ident" id="6000576">ToLower</span><span class="op" id="6000583">(</span><span class="ident" id="6000584">fields</span><span class="op" id="6000590">[</span><span class="num" id="6000591">2</span><span class="op" id="6000592">]</span><span class="op" id="6000593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000596">if</span>&nbsp;<span class="ident" id="6000599">charset</span>&nbsp;<span class="op" id="6000607">!=</span>&nbsp;<span class="string" id="6000610">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="6000621">&amp;&amp;</span>&nbsp;<span class="ident" id="6000624">charset</span>&nbsp;<span class="op" id="6000632">!=</span>&nbsp;<span class="string" id="6000635">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="6000648">&amp;&amp;</span>&nbsp;<span class="ident" id="6000651">charset</span>&nbsp;<span class="op" id="6000659">!=</span>&nbsp;<span class="string" id="6000662">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="6000670">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000674">return</span>&nbsp;<span class="string" id="6000681">&#34;&#34;</span><span class="op" id="6000683">,</span>&nbsp;<span class="ident" id="6000685">fmt</span><span class="op" id="6000688">.</span><span class="ident" id="6000689">Errorf</span><span class="op" id="6000695">(</span><span class="string" id="6000696">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6000723">,</span>&nbsp;<span class="ident" id="6000725">charset</span><span class="op" id="6000732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000739">in</span>&nbsp;<span class="op" id="6000742">:=</span>&nbsp;<span class="ident" id="6000745">bytes</span><span class="op" id="6000750">.</span><span class="ident" id="6000751">NewBufferString</span><span class="op" id="6000766">(</span><span class="ident" id="6000767">fields</span><span class="op" id="6000773">[</span><span class="num" id="6000774">3</span><span class="op" id="6000775">]</span><span class="op" id="6000776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000779">var</span>&nbsp;<span class="ident" id="6000783">r</span>&nbsp;<span class="ident" id="6000785">io</span><span class="op" id="6000787">.</span><span class="ident" id="6000788">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000796">switch</span>&nbsp;<span class="ident" id="6000803">enc</span>&nbsp;<span class="op" id="6000807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000810">case</span>&nbsp;<span class="string" id="6000815">&#34;b&#34;</span><span class="op" id="6000818">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000822">r</span>&nbsp;<span class="op" id="6000824">=</span>&nbsp;<span class="ident" id="6000826">base64</span><span class="op" id="6000832">.</span><span class="ident" id="6000833">NewDecoder</span><span class="op" id="6000843">(</span><span class="ident" id="6000844">base64</span><span class="op" id="6000850">.</span><span class="ident" id="6000851">StdEncoding</span><span class="op" id="6000862">,</span>&nbsp;<span class="ident" id="6000864">in</span><span class="op" id="6000866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000869">case</span>&nbsp;<span class="string" id="6000874">&#34;q&#34;</span><span class="op" id="6000877">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000881">r</span>&nbsp;<span class="op" id="6000883">=</span>&nbsp;<span class="ident" id="6000885">qDecoder</span><span class="op" id="6000893">{</span><span class="ident" id="6000894">r</span><span class="op" id="6000895">:</span>&nbsp;<span class="ident" id="6000897">in</span><span class="op" id="6000899">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000902">default</span><span class="op" id="6000909">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000913">return</span>&nbsp;<span class="string" id="6000920">&#34;&#34;</span><span class="op" id="6000922">,</span>&nbsp;<span class="ident" id="6000924">fmt</span><span class="op" id="6000927">.</span><span class="ident" id="6000928">Errorf</span><span class="op" id="6000934">(</span><span class="string" id="6000935">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6000972">,</span>&nbsp;<span class="ident" id="6000974">enc</span><span class="op" id="6000977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000984">dec</span><span class="op" id="6000987">,</span>&nbsp;<span class="ident" id="6000989">err</span>&nbsp;<span class="op" id="6000993">:=</span>&nbsp;<span class="ident" id="6000996">ioutil</span><span class="op" id="6001002">.</span><span class="ident" id="6001003">ReadAll</span><span class="op" id="6001010">(</span><span class="ident" id="6001011">r</span><span class="op" id="6001012">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001015">if</span>&nbsp;<span class="ident" id="6001018">err</span>&nbsp;<span class="op" id="6001022">!=</span>&nbsp;<span class="builtintype" id="6001025">nil</span>&nbsp;<span class="op" id="6001029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001033">return</span>&nbsp;<span class="string" id="6001040">&#34;&#34;</span><span class="op" id="6001042">,</span>&nbsp;<span class="ident" id="6001044">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001053">switch</span>&nbsp;<span class="ident" id="6001060">charset</span>&nbsp;<span class="op" id="6001068">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001071">case</span>&nbsp;<span class="string" id="6001076">&#34;us-ascii&#34;</span><span class="op" id="6001086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001090">b</span>&nbsp;<span class="op" id="6001092">:=</span>&nbsp;<span class="builtinfunc" id="6001095">new</span><span class="op" id="6001098">(</span><span class="ident" id="6001099">bytes</span><span class="op" id="6001104">.</span><span class="ident" id="6001105">Buffer</span><span class="op" id="6001111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001115">for</span>&nbsp;<span class="ident" id="6001119">_</span><span class="op" id="6001120">,</span>&nbsp;<span class="ident" id="6001122">c</span>&nbsp;<span class="op" id="6001124">:=</span>&nbsp;<span class="keyword" id="6001127">range</span>&nbsp;<span class="ident" id="6001133">dec</span>&nbsp;<span class="op" id="6001137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001142">if</span>&nbsp;<span class="ident" id="6001145">c</span>&nbsp;<span class="op" id="6001147">&gt;=</span>&nbsp;<span class="num" id="6001150">0x80</span>&nbsp;<span class="op" id="6001155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001161">b</span><span class="op" id="6001162">.</span><span class="ident" id="6001163">WriteRune</span><span class="op" id="6001172">(</span><span class="ident" id="6001173">unicode</span><span class="op" id="6001180">.</span><span class="ident" id="6001181">ReplacementChar</span><span class="op" id="6001196">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001201">}</span>&nbsp;<span class="keyword" id="6001203">else</span>&nbsp;<span class="op" id="6001208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001214">b</span><span class="op" id="6001215">.</span><span class="ident" id="6001216">WriteRune</span><span class="op" id="6001225">(</span><span class="builtintype" id="6001226">rune</span><span class="op" id="6001230">(</span><span class="ident" id="6001231">c</span><span class="op" id="6001232">)</span><span class="op" id="6001233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001246">return</span>&nbsp;<span class="ident" id="6001253">b</span><span class="op" id="6001254">.</span><span class="ident" id="6001255">String</span><span class="op" id="6001261">(</span><span class="op" id="6001262">)</span><span class="op" id="6001263">,</span>&nbsp;<span class="builtintype" id="6001265">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001270">case</span>&nbsp;<span class="string" id="6001275">&#34;iso-8859-1&#34;</span><span class="op" id="6001287">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001291">b</span>&nbsp;<span class="op" id="6001293">:=</span>&nbsp;<span class="builtinfunc" id="6001296">new</span><span class="op" id="6001299">(</span><span class="ident" id="6001300">bytes</span><span class="op" id="6001305">.</span><span class="ident" id="6001306">Buffer</span><span class="op" id="6001312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001316">for</span>&nbsp;<span class="ident" id="6001320">_</span><span class="op" id="6001321">,</span>&nbsp;<span class="ident" id="6001323">c</span>&nbsp;<span class="op" id="6001325">:=</span>&nbsp;<span class="keyword" id="6001328">range</span>&nbsp;<span class="ident" id="6001334">dec</span>&nbsp;<span class="op" id="6001338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001343">b</span><span class="op" id="6001344">.</span><span class="ident" id="6001345">WriteRune</span><span class="op" id="6001354">(</span><span class="builtintype" id="6001355">rune</span><span class="op" id="6001359">(</span><span class="ident" id="6001360">c</span><span class="op" id="6001361">)</span><span class="op" id="6001362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001366">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001370">return</span>&nbsp;<span class="ident" id="6001377">b</span><span class="op" id="6001378">.</span><span class="ident" id="6001379">String</span><span class="op" id="6001385">(</span><span class="op" id="6001386">)</span><span class="op" id="6001387">,</span>&nbsp;<span class="builtintype" id="6001389">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001394">case</span>&nbsp;<span class="string" id="6001399">&#34;utf-8&#34;</span><span class="op" id="6001406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001410">return</span>&nbsp;<span class="builtintype" id="6001417">string</span><span class="op" id="6001423">(</span><span class="ident" id="6001424">dec</span><span class="op" id="6001427">)</span><span class="op" id="6001428">,</span>&nbsp;<span class="builtintype" id="6001430">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6001438">panic</span><span class="op" id="6001443">(</span><span class="string" id="6001444">&#34;unreachable&#34;</span><span class="op" id="6001457">)</span><br>
<span class="lineno">490</span><span class="op" id="6001459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6001462">type</span>&nbsp;<span class="ident" id="6001467">qDecoder</span>&nbsp;<span class="keyword" id="6001476">struct</span>&nbsp;<span class="op" id="6001483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001486">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001494">io</span><span class="op" id="6001496">.</span><span class="ident" id="6001497">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001505">scratch</span>&nbsp;<span class="op" id="6001513">[</span><span class="num" id="6001514">2</span><span class="op" id="6001515">]</span><span class="builtintype" id="6001516">byte</span><br>
<span class="lineno">495</span><span class="op" id="6001521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6001524">func</span>&nbsp;<span class="op" id="6001529">(</span><span class="ident" id="6001530">qd</span>&nbsp;<span class="ident" id="6001533">qDecoder</span><span class="op" id="6001541">)</span>&nbsp;<span class="ident" id="6001543">Read</span><span class="op" id="6001547">(</span><span class="ident" id="6001548">p</span>&nbsp;<span class="op" id="6001550">[</span><span class="op" id="6001551">]</span><span class="builtintype" id="6001552">byte</span><span class="op" id="6001556">)</span>&nbsp;<span class="op" id="6001558">(</span><span class="ident" id="6001559">n</span>&nbsp;<span class="builtintype" id="6001561">int</span><span class="op" id="6001564">,</span>&nbsp;<span class="ident" id="6001566">err</span>&nbsp;<span class="builtintype" id="6001570">error</span><span class="op" id="6001575">)</span>&nbsp;<span class="op" id="6001577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001580">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001628">if</span>&nbsp;<span class="builtinfunc" id="6001631">len</span><span class="op" id="6001634">(</span><span class="ident" id="6001635">p</span><span class="op" id="6001636">)</span>&nbsp;<span class="op" id="6001638">==</span>&nbsp;<span class="num" id="6001641">0</span>&nbsp;<span class="op" id="6001643">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001647">return</span>&nbsp;<span class="num" id="6001654">0</span><span class="op" id="6001655">,</span>&nbsp;<span class="builtintype" id="6001657">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001665">if</span>&nbsp;<span class="ident" id="6001668">_</span><span class="op" id="6001669">,</span>&nbsp;<span class="ident" id="6001671">err</span>&nbsp;<span class="op" id="6001675">:=</span>&nbsp;<span class="ident" id="6001678">qd</span><span class="op" id="6001680">.</span><span class="ident" id="6001681">r</span><span class="op" id="6001682">.</span><span class="ident" id="6001683">Read</span><span class="op" id="6001687">(</span><span class="ident" id="6001688">qd</span><span class="op" id="6001690">.</span><span class="ident" id="6001691">scratch</span><span class="op" id="6001698">[</span><span class="op" id="6001699">:</span><span class="num" id="6001700">1</span><span class="op" id="6001701">]</span><span class="op" id="6001702">)</span><span class="op" id="6001703">;</span>&nbsp;<span class="ident" id="6001705">err</span>&nbsp;<span class="op" id="6001709">!=</span>&nbsp;<span class="builtintype" id="6001712">nil</span>&nbsp;<span class="op" id="6001716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001720">return</span>&nbsp;<span class="num" id="6001727">0</span><span class="op" id="6001728">,</span>&nbsp;<span class="ident" id="6001730">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001735">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001738">switch</span>&nbsp;<span class="ident" id="6001745">c</span>&nbsp;<span class="op" id="6001747">:=</span>&nbsp;<span class="ident" id="6001750">qd</span><span class="op" id="6001752">.</span><span class="ident" id="6001753">scratch</span><span class="op" id="6001760">[</span><span class="num" id="6001761">0</span><span class="op" id="6001762">]</span><span class="op" id="6001763">;</span>&nbsp;<span class="op" id="6001765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001768">case</span>&nbsp;<span class="ident" id="6001773">c</span>&nbsp;<span class="op" id="6001775">==</span>&nbsp;<span class="string" id="6001778">&#39;=&#39;</span><span class="op" id="6001781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001785">if</span>&nbsp;<span class="ident" id="6001788">_</span><span class="op" id="6001789">,</span>&nbsp;<span class="ident" id="6001791">err</span>&nbsp;<span class="op" id="6001795">:=</span>&nbsp;<span class="ident" id="6001798">io</span><span class="op" id="6001800">.</span><span class="ident" id="6001801">ReadFull</span><span class="op" id="6001809">(</span><span class="ident" id="6001810">qd</span><span class="op" id="6001812">.</span><span class="ident" id="6001813">r</span><span class="op" id="6001814">,</span>&nbsp;<span class="ident" id="6001816">qd</span><span class="op" id="6001818">.</span><span class="ident" id="6001819">scratch</span><span class="op" id="6001826">[</span><span class="op" id="6001827">:</span><span class="num" id="6001828">2</span><span class="op" id="6001829">]</span><span class="op" id="6001830">)</span><span class="op" id="6001831">;</span>&nbsp;<span class="ident" id="6001833">err</span>&nbsp;<span class="op" id="6001837">!=</span>&nbsp;<span class="builtintype" id="6001840">nil</span>&nbsp;<span class="op" id="6001844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001849">return</span>&nbsp;<span class="num" id="6001856">0</span><span class="op" id="6001857">,</span>&nbsp;<span class="ident" id="6001859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001865">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001869">x</span><span class="op" id="6001870">,</span>&nbsp;<span class="ident" id="6001872">err</span>&nbsp;<span class="op" id="6001876">:=</span>&nbsp;<span class="ident" id="6001879">strconv</span><span class="op" id="6001886">.</span><span class="ident" id="6001887">ParseInt</span><span class="op" id="6001895">(</span><span class="builtintype" id="6001896">string</span><span class="op" id="6001902">(</span><span class="ident" id="6001903">qd</span><span class="op" id="6001905">.</span><span class="ident" id="6001906">scratch</span><span class="op" id="6001913">[</span><span class="op" id="6001914">:</span><span class="num" id="6001915">2</span><span class="op" id="6001916">]</span><span class="op" id="6001917">)</span><span class="op" id="6001918">,</span>&nbsp;<span class="num" id="6001920">16</span><span class="op" id="6001922">,</span>&nbsp;<span class="num" id="6001924">64</span><span class="op" id="6001926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001930">if</span>&nbsp;<span class="ident" id="6001933">err</span>&nbsp;<span class="op" id="6001937">!=</span>&nbsp;<span class="builtintype" id="6001940">nil</span>&nbsp;<span class="op" id="6001944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001949">return</span>&nbsp;<span class="num" id="6001956">0</span><span class="op" id="6001957">,</span>&nbsp;<span class="ident" id="6001959">fmt</span><span class="op" id="6001962">.</span><span class="ident" id="6001963">Errorf</span><span class="op" id="6001969">(</span><span class="string" id="6001970">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="6002007">,</span>&nbsp;<span class="ident" id="6002009">qd</span><span class="op" id="6002011">.</span><span class="ident" id="6002012">scratch</span><span class="op" id="6002019">[</span><span class="op" id="6002020">:</span><span class="num" id="6002021">2</span><span class="op" id="6002022">]</span><span class="op" id="6002023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6002027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002031">p</span><span class="op" id="6002032">[</span><span class="num" id="6002033">0</span><span class="op" id="6002034">]</span>&nbsp;<span class="op" id="6002036">=</span>&nbsp;<span class="builtintype" id="6002038">byte</span><span class="op" id="6002042">(</span><span class="ident" id="6002043">x</span><span class="op" id="6002044">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002047">case</span>&nbsp;<span class="ident" id="6002052">c</span>&nbsp;<span class="op" id="6002054">==</span>&nbsp;<span class="string" id="6002057">&#39;_&#39;</span><span class="op" id="6002060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002064">p</span><span class="op" id="6002065">[</span><span class="num" id="6002066">0</span><span class="op" id="6002067">]</span>&nbsp;<span class="op" id="6002069">=</span>&nbsp;<span class="string" id="6002071">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002076">default</span><span class="op" id="6002083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002087">p</span><span class="op" id="6002088">[</span><span class="num" id="6002089">0</span><span class="op" id="6002090">]</span>&nbsp;<span class="op" id="6002092">=</span>&nbsp;<span class="ident" id="6002094">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6002097">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002100">return</span>&nbsp;<span class="num" id="6002107">1</span><span class="op" id="6002108">,</span>&nbsp;<span class="builtintype" id="6002110">nil</span><br>
<span class="lineno"></span><span class="op" id="6002114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6002117">var</span>&nbsp;<span class="ident" id="6002121">atextChars</span>&nbsp;<span class="op" id="6002132">=</span>&nbsp;<span class="op" id="6002134">[</span><span class="op" id="6002135">]</span><span class="builtintype" id="6002136">byte</span><span class="op" id="6002140">(</span><span class="string" id="6002141">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="6002170">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6002173">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="6002202">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6002205">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="6002218">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6002221">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="6002242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002245">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="6002306">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="6002345">func</span>&nbsp;<span class="ident" id="6002350">isAtext</span><span class="op" id="6002357">(</span><span class="ident" id="6002358">c</span>&nbsp;<span class="builtintype" id="6002360">byte</span><span class="op" id="6002364">,</span>&nbsp;<span class="ident" id="6002366">dot</span>&nbsp;<span class="builtintype" id="6002370">bool</span><span class="op" id="6002374">)</span>&nbsp;<span class="builtintype" id="6002376">bool</span>&nbsp;<span class="op" id="6002381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002384">if</span>&nbsp;<span class="ident" id="6002387">dot</span>&nbsp;<span class="op" id="6002391">&amp;&amp;</span>&nbsp;<span class="ident" id="6002394">c</span>&nbsp;<span class="op" id="6002396">==</span>&nbsp;<span class="string" id="6002399">&#39;.&#39;</span>&nbsp;<span class="op" id="6002403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002407">return</span>&nbsp;<span class="builtintype" id="6002414">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6002420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002423">return</span>&nbsp;<span class="ident" id="6002430">bytes</span><span class="op" id="6002435">.</span><span class="ident" id="6002436">IndexByte</span><span class="op" id="6002445">(</span><span class="ident" id="6002446">atextChars</span><span class="op" id="6002456">,</span>&nbsp;<span class="ident" id="6002458">c</span><span class="op" id="6002459">)</span>&nbsp;<span class="op" id="6002461">&gt;=</span>&nbsp;<span class="num" id="6002464">0</span><br>
<span class="lineno">535</span><span class="op" id="6002466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002469">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6002530">func</span>&nbsp;<span class="ident" id="6002535">isQtext</span><span class="op" id="6002542">(</span><span class="ident" id="6002543">c</span>&nbsp;<span class="builtintype" id="6002545">byte</span><span class="op" id="6002549">)</span>&nbsp;<span class="builtintype" id="6002551">bool</span>&nbsp;<span class="op" id="6002556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002559">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002613">if</span>&nbsp;<span class="ident" id="6002616">c</span>&nbsp;<span class="op" id="6002618">==</span>&nbsp;<span class="string" id="6002621">&#39;\\&#39;</span>&nbsp;<span class="op" id="6002626">||</span>&nbsp;<span class="ident" id="6002629">c</span>&nbsp;<span class="op" id="6002631">==</span>&nbsp;<span class="string" id="6002634">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6002638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002642">return</span>&nbsp;<span class="builtintype" id="6002649">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6002656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002659">return</span>&nbsp;<span class="string" id="6002666">&#39;!&#39;</span>&nbsp;<span class="op" id="6002670">&lt;=</span>&nbsp;<span class="ident" id="6002673">c</span>&nbsp;<span class="op" id="6002675">&amp;&amp;</span>&nbsp;<span class="ident" id="6002678">c</span>&nbsp;<span class="op" id="6002680">&lt;=</span>&nbsp;<span class="string" id="6002683">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="6002687">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="6002690">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6002751">func</span>&nbsp;<span class="ident" id="6002756">isVchar</span><span class="op" id="6002763">(</span><span class="ident" id="6002764">c</span>&nbsp;<span class="builtintype" id="6002766">byte</span><span class="op" id="6002770">)</span>&nbsp;<span class="builtintype" id="6002772">bool</span>&nbsp;<span class="op" id="6002777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002780">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002815">return</span>&nbsp;<span class="string" id="6002822">&#39;!&#39;</span>&nbsp;<span class="op" id="6002826">&lt;=</span>&nbsp;<span class="ident" id="6002829">c</span>&nbsp;<span class="op" id="6002831">&amp;&amp;</span>&nbsp;<span class="ident" id="6002834">c</span>&nbsp;<span class="op" id="6002836">&lt;=</span>&nbsp;<span class="string" id="6002839">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="6002843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002846">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="6002897">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="6002955">func</span>&nbsp;<span class="ident" id="6002960">isWSP</span><span class="op" id="6002965">(</span><span class="ident" id="6002966">c</span>&nbsp;<span class="builtintype" id="6002968">byte</span><span class="op" id="6002972">)</span>&nbsp;<span class="builtintype" id="6002974">bool</span>&nbsp;<span class="op" id="6002979">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002982">return</span>&nbsp;<span class="ident" id="6002989">c</span>&nbsp;<span class="op" id="6002991">==</span>&nbsp;<span class="string" id="6002994">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6002998">||</span>&nbsp;<span class="ident" id="6003001">c</span>&nbsp;<span class="op" id="6003003">==</span>&nbsp;<span class="string" id="6003006">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="6003011">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
