<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8152396">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8152451">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8152505">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8152556">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8152582">package</span>&nbsp;<span class="ident" id="8152590">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8152595">import</span>&nbsp;<span class="op" id="8152602">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152605">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152614">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152621">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152627">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152634">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152646">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152667">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152673">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152684">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152701">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152712">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152723">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152734">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8152745">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8152752">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="8152755">func</span>&nbsp;<span class="ident" id="8152760">newRequest</span><span class="op" id="8152770">(</span><span class="ident" id="8152771">httpreq</span>&nbsp;<span class="builtintype" id="8152779">string</span><span class="op" id="8152785">)</span>&nbsp;<span class="op" id="8152787">*</span><span class="ident" id="8152788">http</span><span class="op" id="8152792">.</span><span class="ident" id="8152793">Request</span>&nbsp;<span class="op" id="8152801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8152804">buf</span>&nbsp;<span class="op" id="8152808">:=</span>&nbsp;<span class="ident" id="8152811">bufio</span><span class="op" id="8152816">.</span><span class="ident" id="8152817">NewReader</span><span class="op" id="8152826">(</span><span class="ident" id="8152827">strings</span><span class="op" id="8152834">.</span><span class="ident" id="8152835">NewReader</span><span class="op" id="8152844">(</span><span class="ident" id="8152845">httpreq</span><span class="op" id="8152852">)</span><span class="op" id="8152853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8152856">req</span><span class="op" id="8152859">,</span>&nbsp;<span class="ident" id="8152861">err</span>&nbsp;<span class="op" id="8152865">:=</span>&nbsp;<span class="ident" id="8152868">http</span><span class="op" id="8152872">.</span><span class="ident" id="8152873">ReadRequest</span><span class="op" id="8152884">(</span><span class="ident" id="8152885">buf</span><span class="op" id="8152888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8152891">if</span>&nbsp;<span class="ident" id="8152894">err</span>&nbsp;<span class="op" id="8152898">!=</span>&nbsp;<span class="ident" id="8152901">nil</span>&nbsp;<span class="op" id="8152905">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8152909">panic</span><span class="op" id="8152914">(</span><span class="string" id="8152915">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="8152951">+</span>&nbsp;<span class="ident" id="8152953">httpreq</span><span class="op" id="8152960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8152963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8152966">req</span><span class="op" id="8152969">.</span><span class="ident" id="8152970">RemoteAddr</span>&nbsp;<span class="op" id="8152981">=</span>&nbsp;<span class="string" id="8152983">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8152994">return</span>&nbsp;<span class="ident" id="8153001">req</span><br>
<span class="lineno"></span><span class="op" id="8153005">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="8153008">func</span>&nbsp;<span class="ident" id="8153013">runCgiTest</span><span class="op" id="8153023">(</span><span class="ident" id="8153024">t</span>&nbsp;<span class="op" id="8153026">*</span><span class="ident" id="8153027">testing</span><span class="op" id="8153034">.</span><span class="ident" id="8153035">T</span><span class="op" id="8153036">,</span>&nbsp;<span class="ident" id="8153038">h</span>&nbsp;<span class="op" id="8153040">*</span><span class="ident" id="8153041">Handler</span><span class="op" id="8153048">,</span>&nbsp;<span class="ident" id="8153050">httpreq</span>&nbsp;<span class="builtintype" id="8153058">string</span><span class="op" id="8153064">,</span>&nbsp;<span class="ident" id="8153066">expectedMap</span>&nbsp;<span class="keyword" id="8153078">map</span><span class="op" id="8153081">[</span><span class="builtintype" id="8153082">string</span><span class="op" id="8153088">]</span><span class="builtintype" id="8153089">string</span><span class="op" id="8153095">)</span>&nbsp;<span class="op" id="8153097">*</span><span class="ident" id="8153098">httptest</span><span class="op" id="8153106">.</span><span class="ident" id="8153107">ResponseRecorder</span>&nbsp;<span class="op" id="8153124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153127">rw</span>&nbsp;<span class="op" id="8153130">:=</span>&nbsp;<span class="ident" id="8153133">httptest</span><span class="op" id="8153141">.</span><span class="ident" id="8153142">NewRecorder</span><span class="op" id="8153153">(</span><span class="op" id="8153154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153157">req</span>&nbsp;<span class="op" id="8153161">:=</span>&nbsp;<span class="ident" id="8153164">newRequest</span><span class="op" id="8153174">(</span><span class="ident" id="8153175">httpreq</span><span class="op" id="8153182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153185">h</span><span class="op" id="8153186">.</span><span class="ident" id="8153187">ServeHTTP</span><span class="op" id="8153196">(</span><span class="ident" id="8153197">rw</span><span class="op" id="8153199">,</span>&nbsp;<span class="ident" id="8153201">req</span><span class="op" id="8153204">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8153208">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153266">m</span>&nbsp;<span class="op" id="8153268">:=</span>&nbsp;<span class="builtinfunc" id="8153271">make</span><span class="op" id="8153275">(</span><span class="keyword" id="8153276">map</span><span class="op" id="8153279">[</span><span class="builtintype" id="8153280">string</span><span class="op" id="8153286">]</span><span class="builtintype" id="8153287">string</span><span class="op" id="8153293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153296">m</span><span class="op" id="8153297">[</span><span class="string" id="8153298">&#34;_body&#34;</span><span class="op" id="8153305">]</span>&nbsp;<span class="op" id="8153307">=</span>&nbsp;<span class="ident" id="8153309">rw</span><span class="op" id="8153311">.</span><span class="ident" id="8153312">Body</span><span class="op" id="8153316">.</span><span class="ident" id="8153317">String</span><span class="op" id="8153323">(</span><span class="op" id="8153324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153327">linesRead</span>&nbsp;<span class="op" id="8153337">:=</span>&nbsp;<span class="num" id="8153340">0</span><br>
<span class="lineno">45</span><span class="ident" id="8153342">readlines</span><span class="op" id="8153351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153354">for</span>&nbsp;<span class="op" id="8153358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153362">line</span><span class="op" id="8153366">,</span>&nbsp;<span class="ident" id="8153368">err</span>&nbsp;<span class="op" id="8153372">:=</span>&nbsp;<span class="ident" id="8153375">rw</span><span class="op" id="8153377">.</span><span class="ident" id="8153378">Body</span><span class="op" id="8153382">.</span><span class="ident" id="8153383">ReadString</span><span class="op" id="8153393">(</span><span class="string" id="8153394">&#39;\n&#39;</span><span class="op" id="8153398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153402">switch</span>&nbsp;<span class="op" id="8153409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153413">case</span>&nbsp;<span class="ident" id="8153418">err</span>&nbsp;<span class="op" id="8153422">==</span>&nbsp;<span class="ident" id="8153425">io</span><span class="op" id="8153427">.</span><span class="ident" id="8153428">EOF</span><span class="op" id="8153431">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153436">break</span>&nbsp;<span class="ident" id="8153442">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153454">case</span>&nbsp;<span class="ident" id="8153459">err</span>&nbsp;<span class="op" id="8153463">!=</span>&nbsp;<span class="ident" id="8153466">nil</span><span class="op" id="8153469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153474">t</span><span class="op" id="8153475">.</span><span class="ident" id="8153476">Fatalf</span><span class="op" id="8153482">(</span><span class="string" id="8153483">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="8153522">,</span>&nbsp;<span class="ident" id="8153524">err</span><span class="op" id="8153527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8153531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153535">linesRead</span><span class="op" id="8153544">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153549">trimmedLine</span>&nbsp;<span class="op" id="8153561">:=</span>&nbsp;<span class="ident" id="8153564">strings</span><span class="op" id="8153571">.</span><span class="ident" id="8153572">TrimRight</span><span class="op" id="8153581">(</span><span class="ident" id="8153582">line</span><span class="op" id="8153586">,</span>&nbsp;<span class="string" id="8153588">&#34;\r\n&#34;</span><span class="op" id="8153594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153598">split</span>&nbsp;<span class="op" id="8153604">:=</span>&nbsp;<span class="ident" id="8153607">strings</span><span class="op" id="8153614">.</span><span class="ident" id="8153615">SplitN</span><span class="op" id="8153621">(</span><span class="ident" id="8153622">trimmedLine</span><span class="op" id="8153633">,</span>&nbsp;<span class="string" id="8153635">&#34;=&#34;</span><span class="op" id="8153638">,</span>&nbsp;<span class="num" id="8153640">2</span><span class="op" id="8153641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153645">if</span>&nbsp;<span class="builtinfunc" id="8153648">len</span><span class="op" id="8153651">(</span><span class="ident" id="8153652">split</span><span class="op" id="8153657">)</span>&nbsp;<span class="op" id="8153659">!=</span>&nbsp;<span class="num" id="8153662">2</span>&nbsp;<span class="op" id="8153664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153669">t</span><span class="op" id="8153670">.</span><span class="ident" id="8153671">Fatalf</span><span class="op" id="8153677">(</span><span class="string" id="8153678">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="8153748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8153754">len</span><span class="op" id="8153757">(</span><span class="ident" id="8153758">split</span><span class="op" id="8153763">)</span><span class="op" id="8153764">,</span>&nbsp;<span class="ident" id="8153766">linesRead</span><span class="op" id="8153775">,</span>&nbsp;<span class="ident" id="8153777">line</span><span class="op" id="8153781">,</span>&nbsp;<span class="ident" id="8153783">m</span><span class="op" id="8153784">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8153788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153792">m</span><span class="op" id="8153793">[</span><span class="ident" id="8153794">split</span><span class="op" id="8153799">[</span><span class="num" id="8153800">0</span><span class="op" id="8153801">]</span><span class="op" id="8153802">]</span>&nbsp;<span class="op" id="8153804">=</span>&nbsp;<span class="ident" id="8153806">split</span><span class="op" id="8153811">[</span><span class="num" id="8153812">1</span><span class="op" id="8153813">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8153816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153820">for</span>&nbsp;<span class="ident" id="8153824">key</span><span class="op" id="8153827">,</span>&nbsp;<span class="ident" id="8153829">expected</span>&nbsp;<span class="op" id="8153838">:=</span>&nbsp;<span class="keyword" id="8153841">range</span>&nbsp;<span class="ident" id="8153847">expectedMap</span>&nbsp;<span class="op" id="8153859">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153863">got</span>&nbsp;<span class="op" id="8153867">:=</span>&nbsp;<span class="ident" id="8153870">m</span><span class="op" id="8153871">[</span><span class="ident" id="8153872">key</span><span class="op" id="8153875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153879">if</span>&nbsp;<span class="ident" id="8153882">key</span>&nbsp;<span class="op" id="8153886">==</span>&nbsp;<span class="string" id="8153889">&#34;cwd&#34;</span>&nbsp;<span class="op" id="8153895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8153900">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153942">fi1</span><span class="op" id="8153945">,</span>&nbsp;<span class="ident" id="8153947">_</span>&nbsp;<span class="op" id="8153949">:=</span>&nbsp;<span class="ident" id="8153952">os</span><span class="op" id="8153954">.</span><span class="ident" id="8153955">Stat</span><span class="op" id="8153959">(</span><span class="ident" id="8153960">got</span><span class="op" id="8153963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8153968">fi2</span><span class="op" id="8153971">,</span>&nbsp;<span class="ident" id="8153973">_</span>&nbsp;<span class="op" id="8153975">:=</span>&nbsp;<span class="ident" id="8153978">os</span><span class="op" id="8153980">.</span><span class="ident" id="8153981">Stat</span><span class="op" id="8153985">(</span><span class="ident" id="8153986">expected</span><span class="op" id="8153994">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8153999">if</span>&nbsp;<span class="ident" id="8154002">os</span><span class="op" id="8154004">.</span><span class="ident" id="8154005">SameFile</span><span class="op" id="8154013">(</span><span class="ident" id="8154014">fi1</span><span class="op" id="8154017">,</span>&nbsp;<span class="ident" id="8154019">fi2</span><span class="op" id="8154022">)</span>&nbsp;<span class="op" id="8154024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154030">got</span>&nbsp;<span class="op" id="8154034">=</span>&nbsp;<span class="ident" id="8154036">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8154056">if</span>&nbsp;<span class="ident" id="8154059">got</span>&nbsp;<span class="op" id="8154063">!=</span>&nbsp;<span class="ident" id="8154066">expected</span>&nbsp;<span class="op" id="8154075">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154080">t</span><span class="op" id="8154081">.</span><span class="ident" id="8154082">Errorf</span><span class="op" id="8154088">(</span><span class="string" id="8154089">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8154121">,</span>&nbsp;<span class="ident" id="8154123">key</span><span class="op" id="8154126">,</span>&nbsp;<span class="ident" id="8154128">got</span><span class="op" id="8154131">,</span>&nbsp;<span class="ident" id="8154133">expected</span><span class="op" id="8154141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8154151">return</span>&nbsp;<span class="ident" id="8154158">rw</span><br>
<span class="lineno"></span><span class="op" id="8154161">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="8154164">var</span>&nbsp;<span class="ident" id="8154168">cgiTested</span><span class="op" id="8154177">,</span>&nbsp;<span class="ident" id="8154179">cgiWorks</span>&nbsp;<span class="builtintype" id="8154188">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8154194">func</span>&nbsp;<span class="ident" id="8154199">check</span><span class="op" id="8154204">(</span><span class="ident" id="8154205">t</span>&nbsp;<span class="op" id="8154207">*</span><span class="ident" id="8154208">testing</span><span class="op" id="8154215">.</span><span class="ident" id="8154216">T</span><span class="op" id="8154217">)</span>&nbsp;<span class="op" id="8154219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8154222">if</span>&nbsp;<span class="op" id="8154225">!</span><span class="ident" id="8154226">cgiTested</span>&nbsp;<span class="op" id="8154236">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154240">cgiTested</span>&nbsp;<span class="op" id="8154250">=</span>&nbsp;<span class="builtintype" id="8154252">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154259">cgiWorks</span>&nbsp;<span class="op" id="8154268">=</span>&nbsp;<span class="ident" id="8154270">exec</span><span class="op" id="8154274">.</span><span class="ident" id="8154275">Command</span><span class="op" id="8154282">(</span><span class="string" id="8154283">&#34;./testdata/test.cgi&#34;</span><span class="op" id="8154304">)</span><span class="op" id="8154305">.</span><span class="ident" id="8154306">Run</span><span class="op" id="8154309">(</span><span class="op" id="8154310">)</span>&nbsp;<span class="op" id="8154312">==</span>&nbsp;<span class="ident" id="8154315">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8154323">if</span>&nbsp;<span class="op" id="8154326">!</span><span class="ident" id="8154327">cgiWorks</span>&nbsp;<span class="op" id="8154336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8154340">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8154384">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154435">t</span><span class="op" id="8154436">.</span><span class="ident" id="8154437">Skip</span><span class="op" id="8154441">(</span><span class="string" id="8154442">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="8154475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154478">}</span><br>
<span class="lineno"></span><span class="op" id="8154480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8154483">func</span>&nbsp;<span class="ident" id="8154488">TestCGIBasicGet</span><span class="op" id="8154503">(</span><span class="ident" id="8154504">t</span>&nbsp;<span class="op" id="8154506">*</span><span class="ident" id="8154507">testing</span><span class="op" id="8154514">.</span><span class="ident" id="8154515">T</span><span class="op" id="8154516">)</span>&nbsp;<span class="op" id="8154518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154521">check</span><span class="op" id="8154526">(</span><span class="ident" id="8154527">t</span><span class="op" id="8154528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154531">h</span>&nbsp;<span class="op" id="8154533">:=</span>&nbsp;<span class="op" id="8154536">&amp;</span><span class="ident" id="8154537">Handler</span><span class="op" id="8154544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154548">Path</span><span class="op" id="8154552">:</span>&nbsp;<span class="string" id="8154554">&#34;testdata/test.cgi&#34;</span><span class="op" id="8154573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154577">Root</span><span class="op" id="8154581">:</span>&nbsp;<span class="string" id="8154583">&#34;/test.cgi&#34;</span><span class="op" id="8154594">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8154597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8154600">expectedMap</span>&nbsp;<span class="op" id="8154612">:=</span>&nbsp;<span class="keyword" id="8154615">map</span><span class="op" id="8154618">[</span><span class="builtintype" id="8154619">string</span><span class="op" id="8154625">]</span><span class="builtintype" id="8154626">string</span><span class="op" id="8154632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154636">&#34;test&#34;</span><span class="op" id="8154642">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154661">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="8154672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154676">&#34;param-a&#34;</span><span class="op" id="8154685">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154701">&#34;b&#34;</span><span class="op" id="8154704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154708">&#34;param-foo&#34;</span><span class="op" id="8154719">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154733">&#34;bar&#34;</span><span class="op" id="8154738">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154742">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="8154765">:</span>&nbsp;<span class="string" id="8154767">&#34;CGI/1.1&#34;</span><span class="op" id="8154776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154780">&#34;env-HTTP_HOST&#34;</span><span class="op" id="8154795">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154805">&#34;example.com&#34;</span><span class="op" id="8154818">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154822">&#34;env-PATH_INFO&#34;</span><span class="op" id="8154837">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154847">&#34;&#34;</span><span class="op" id="8154849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154853">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8154871">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154878">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="8154891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154895">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="8154912">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154920">&#34;1.2.3.4&#34;</span><span class="op" id="8154929">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154933">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="8154950">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154958">&#34;1.2.3.4&#34;</span><span class="op" id="8154967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8154971">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8154991">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8154996">&#34;GET&#34;</span><span class="op" id="8155001">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155005">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8155022">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8155030">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="8155053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155057">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8155078">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8155082">&#34;testdata/test.cgi&#34;</span><span class="op" id="8155101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155105">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8155122">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8155130">&#34;/test.cgi&#34;</span><span class="op" id="8155141">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155145">&#34;env-SERVER_NAME&#34;</span><span class="op" id="8155162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8155170">&#34;example.com&#34;</span><span class="op" id="8155183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155187">&#34;env-SERVER_PORT&#34;</span><span class="op" id="8155204">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8155212">&#34;80&#34;</span><span class="op" id="8155216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155220">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="8155241">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8155245">&#34;go&#34;</span><span class="op" id="8155249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8155252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155255">replay</span>&nbsp;<span class="op" id="8155262">:=</span>&nbsp;<span class="ident" id="8155265">runCgiTest</span><span class="op" id="8155275">(</span><span class="ident" id="8155276">t</span><span class="op" id="8155277">,</span>&nbsp;<span class="ident" id="8155279">h</span><span class="op" id="8155280">,</span>&nbsp;<span class="string" id="8155282">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8155341">,</span>&nbsp;<span class="ident" id="8155343">expectedMap</span><span class="op" id="8155354">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8155358">if</span>&nbsp;<span class="ident" id="8155361">expected</span><span class="op" id="8155369">,</span>&nbsp;<span class="ident" id="8155371">got</span>&nbsp;<span class="op" id="8155375">:=</span>&nbsp;<span class="string" id="8155378">&#34;text/html&#34;</span><span class="op" id="8155389">,</span>&nbsp;<span class="ident" id="8155391">replay</span><span class="op" id="8155397">.</span><span class="ident" id="8155398">Header</span><span class="op" id="8155404">(</span><span class="op" id="8155405">)</span><span class="op" id="8155406">.</span><span class="ident" id="8155407">Get</span><span class="op" id="8155410">(</span><span class="string" id="8155411">&#34;Content-Type&#34;</span><span class="op" id="8155425">)</span><span class="op" id="8155426">;</span>&nbsp;<span class="ident" id="8155428">got</span>&nbsp;<span class="op" id="8155432">!=</span>&nbsp;<span class="ident" id="8155435">expected</span>&nbsp;<span class="op" id="8155444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155448">t</span><span class="op" id="8155449">.</span><span class="ident" id="8155450">Errorf</span><span class="op" id="8155456">(</span><span class="string" id="8155457">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8155496">,</span>&nbsp;<span class="ident" id="8155498">got</span><span class="op" id="8155501">,</span>&nbsp;<span class="ident" id="8155503">expected</span><span class="op" id="8155511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8155514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8155517">if</span>&nbsp;<span class="ident" id="8155520">expected</span><span class="op" id="8155528">,</span>&nbsp;<span class="ident" id="8155530">got</span>&nbsp;<span class="op" id="8155534">:=</span>&nbsp;<span class="string" id="8155537">&#34;X-Test-Value&#34;</span><span class="op" id="8155551">,</span>&nbsp;<span class="ident" id="8155553">replay</span><span class="op" id="8155559">.</span><span class="ident" id="8155560">Header</span><span class="op" id="8155566">(</span><span class="op" id="8155567">)</span><span class="op" id="8155568">.</span><span class="ident" id="8155569">Get</span><span class="op" id="8155572">(</span><span class="string" id="8155573">&#34;X-Test-Header&#34;</span><span class="op" id="8155588">)</span><span class="op" id="8155589">;</span>&nbsp;<span class="ident" id="8155591">got</span>&nbsp;<span class="op" id="8155595">!=</span>&nbsp;<span class="ident" id="8155598">expected</span>&nbsp;<span class="op" id="8155607">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155611">t</span><span class="op" id="8155612">.</span><span class="ident" id="8155613">Errorf</span><span class="op" id="8155619">(</span><span class="string" id="8155620">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8155660">,</span>&nbsp;<span class="ident" id="8155662">got</span><span class="op" id="8155665">,</span>&nbsp;<span class="ident" id="8155667">expected</span><span class="op" id="8155675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8155678">}</span><br>
<span class="lineno"></span><span class="op" id="8155680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8155683">func</span>&nbsp;<span class="ident" id="8155688">TestCGIBasicGetAbsPath</span><span class="op" id="8155710">(</span><span class="ident" id="8155711">t</span>&nbsp;<span class="op" id="8155713">*</span><span class="ident" id="8155714">testing</span><span class="op" id="8155721">.</span><span class="ident" id="8155722">T</span><span class="op" id="8155723">)</span>&nbsp;<span class="op" id="8155725">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155728">check</span><span class="op" id="8155733">(</span><span class="ident" id="8155734">t</span><span class="op" id="8155735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155738">pwd</span><span class="op" id="8155741">,</span>&nbsp;<span class="ident" id="8155743">err</span>&nbsp;<span class="op" id="8155747">:=</span>&nbsp;<span class="ident" id="8155750">os</span><span class="op" id="8155752">.</span><span class="ident" id="8155753">Getwd</span><span class="op" id="8155758">(</span><span class="op" id="8155759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8155762">if</span>&nbsp;<span class="ident" id="8155765">err</span>&nbsp;<span class="op" id="8155769">!=</span>&nbsp;<span class="ident" id="8155772">nil</span>&nbsp;<span class="op" id="8155776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155780">t</span><span class="op" id="8155781">.</span><span class="ident" id="8155782">Fatalf</span><span class="op" id="8155788">(</span><span class="string" id="8155789">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8155806">,</span>&nbsp;<span class="ident" id="8155808">err</span><span class="op" id="8155811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8155814">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155817">h</span>&nbsp;<span class="op" id="8155819">:=</span>&nbsp;<span class="op" id="8155822">&amp;</span><span class="ident" id="8155823">Handler</span><span class="op" id="8155830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155834">Path</span><span class="op" id="8155838">:</span>&nbsp;<span class="ident" id="8155840">pwd</span>&nbsp;<span class="op" id="8155844">+</span>&nbsp;<span class="string" id="8155846">&#34;/testdata/test.cgi&#34;</span><span class="op" id="8155866">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155870">Root</span><span class="op" id="8155874">:</span>&nbsp;<span class="string" id="8155876">&#34;/test.cgi&#34;</span><span class="op" id="8155887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8155890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8155893">expectedMap</span>&nbsp;<span class="op" id="8155905">:=</span>&nbsp;<span class="keyword" id="8155908">map</span><span class="op" id="8155911">[</span><span class="builtintype" id="8155912">string</span><span class="op" id="8155918">]</span><span class="builtintype" id="8155919">string</span><span class="op" id="8155925">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155929">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8155946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8155952">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="8155975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8155979">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8156000">:</span>&nbsp;<span class="ident" id="8156002">pwd</span>&nbsp;<span class="op" id="8156006">+</span>&nbsp;<span class="string" id="8156008">&#34;/testdata/test.cgi&#34;</span><span class="op" id="8156028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156032">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8156049">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156055">&#34;/test.cgi&#34;</span><span class="op" id="8156066">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8156069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156072">runCgiTest</span><span class="op" id="8156082">(</span><span class="ident" id="8156083">t</span><span class="op" id="8156084">,</span>&nbsp;<span class="ident" id="8156086">h</span><span class="op" id="8156087">,</span>&nbsp;<span class="string" id="8156089">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8156148">,</span>&nbsp;<span class="ident" id="8156150">expectedMap</span><span class="op" id="8156161">)</span><br>
<span class="lineno">145</span><span class="op" id="8156163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8156166">func</span>&nbsp;<span class="ident" id="8156171">TestPathInfo</span><span class="op" id="8156183">(</span><span class="ident" id="8156184">t</span>&nbsp;<span class="op" id="8156186">*</span><span class="ident" id="8156187">testing</span><span class="op" id="8156194">.</span><span class="ident" id="8156195">T</span><span class="op" id="8156196">)</span>&nbsp;<span class="op" id="8156198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156201">check</span><span class="op" id="8156206">(</span><span class="ident" id="8156207">t</span><span class="op" id="8156208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156211">h</span>&nbsp;<span class="op" id="8156213">:=</span>&nbsp;<span class="op" id="8156216">&amp;</span><span class="ident" id="8156217">Handler</span><span class="op" id="8156224">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156228">Path</span><span class="op" id="8156232">:</span>&nbsp;<span class="string" id="8156234">&#34;testdata/test.cgi&#34;</span><span class="op" id="8156253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156257">Root</span><span class="op" id="8156261">:</span>&nbsp;<span class="string" id="8156263">&#34;/test.cgi&#34;</span><span class="op" id="8156274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8156277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156280">expectedMap</span>&nbsp;<span class="op" id="8156292">:=</span>&nbsp;<span class="keyword" id="8156295">map</span><span class="op" id="8156298">[</span><span class="builtintype" id="8156299">string</span><span class="op" id="8156305">]</span><span class="builtintype" id="8156306">string</span><span class="op" id="8156312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156316">&#34;param-a&#34;</span><span class="op" id="8156325">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156339">&#34;b&#34;</span><span class="op" id="8156342">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156346">&#34;env-PATH_INFO&#34;</span><span class="op" id="8156361">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156369">&#34;/extrapath&#34;</span><span class="op" id="8156381">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156385">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8156403">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156408">&#34;a=b&#34;</span><span class="op" id="8156413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156417">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8156434">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156440">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="8156465">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156469">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8156490">:</span>&nbsp;<span class="string" id="8156492">&#34;testdata/test.cgi&#34;</span><span class="op" id="8156511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156515">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8156532">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156538">&#34;/test.cgi&#34;</span><span class="op" id="8156549">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8156552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156555">runCgiTest</span><span class="op" id="8156565">(</span><span class="ident" id="8156566">t</span><span class="op" id="8156567">,</span>&nbsp;<span class="ident" id="8156569">h</span><span class="op" id="8156570">,</span>&nbsp;<span class="string" id="8156572">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8156633">,</span>&nbsp;<span class="ident" id="8156635">expectedMap</span><span class="op" id="8156646">)</span><br>
<span class="lineno"></span><span class="op" id="8156648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8156651">func</span>&nbsp;<span class="ident" id="8156656">TestPathInfoDirRoot</span><span class="op" id="8156675">(</span><span class="ident" id="8156676">t</span>&nbsp;<span class="op" id="8156678">*</span><span class="ident" id="8156679">testing</span><span class="op" id="8156686">.</span><span class="ident" id="8156687">T</span><span class="op" id="8156688">)</span>&nbsp;<span class="op" id="8156690">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156693">check</span><span class="op" id="8156698">(</span><span class="ident" id="8156699">t</span><span class="op" id="8156700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156703">h</span>&nbsp;<span class="op" id="8156705">:=</span>&nbsp;<span class="op" id="8156708">&amp;</span><span class="ident" id="8156709">Handler</span><span class="op" id="8156716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156720">Path</span><span class="op" id="8156724">:</span>&nbsp;<span class="string" id="8156726">&#34;testdata/test.cgi&#34;</span><span class="op" id="8156745">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156749">Root</span><span class="op" id="8156753">:</span>&nbsp;<span class="string" id="8156755">&#34;/myscript/&#34;</span><span class="op" id="8156767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8156770">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156773">expectedMap</span>&nbsp;<span class="op" id="8156785">:=</span>&nbsp;<span class="keyword" id="8156788">map</span><span class="op" id="8156791">[</span><span class="builtintype" id="8156792">string</span><span class="op" id="8156798">]</span><span class="builtintype" id="8156799">string</span><span class="op" id="8156805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156809">&#34;env-PATH_INFO&#34;</span><span class="op" id="8156824">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156832">&#34;bar&#34;</span><span class="op" id="8156837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156841">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8156859">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156864">&#34;a=b&#34;</span><span class="op" id="8156869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156873">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8156890">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156896">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="8156915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156919">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8156940">:</span>&nbsp;<span class="string" id="8156942">&#34;testdata/test.cgi&#34;</span><span class="op" id="8156961">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156965">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8156982">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8156988">&#34;/myscript/&#34;</span><span class="op" id="8157000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157006">runCgiTest</span><span class="op" id="8157016">(</span><span class="ident" id="8157017">t</span><span class="op" id="8157018">,</span>&nbsp;<span class="ident" id="8157020">h</span><span class="op" id="8157021">,</span>&nbsp;<span class="string" id="8157023">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8157078">,</span>&nbsp;<span class="ident" id="8157080">expectedMap</span><span class="op" id="8157091">)</span><br>
<span class="lineno"></span><span class="op" id="8157093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="8157096">func</span>&nbsp;<span class="ident" id="8157101">TestDupHeaders</span><span class="op" id="8157115">(</span><span class="ident" id="8157116">t</span>&nbsp;<span class="op" id="8157118">*</span><span class="ident" id="8157119">testing</span><span class="op" id="8157126">.</span><span class="ident" id="8157127">T</span><span class="op" id="8157128">)</span>&nbsp;<span class="op" id="8157130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157133">check</span><span class="op" id="8157138">(</span><span class="ident" id="8157139">t</span><span class="op" id="8157140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157143">h</span>&nbsp;<span class="op" id="8157145">:=</span>&nbsp;<span class="op" id="8157148">&amp;</span><span class="ident" id="8157149">Handler</span><span class="op" id="8157156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157160">Path</span><span class="op" id="8157164">:</span>&nbsp;<span class="string" id="8157166">&#34;testdata/test.cgi&#34;</span><span class="op" id="8157185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157188">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157191">expectedMap</span>&nbsp;<span class="op" id="8157203">:=</span>&nbsp;<span class="keyword" id="8157206">map</span><span class="op" id="8157209">[</span><span class="builtintype" id="8157210">string</span><span class="op" id="8157216">]</span><span class="builtintype" id="8157217">string</span><span class="op" id="8157223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157227">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8157244">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157250">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="8157269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157273">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8157294">:</span>&nbsp;<span class="string" id="8157296">&#34;testdata/test.cgi&#34;</span><span class="op" id="8157315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157319">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="8157336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157342">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="8157360">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157364">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="8157380">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157387">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="8157399">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157405">runCgiTest</span><span class="op" id="8157415">(</span><span class="ident" id="8157416">t</span><span class="op" id="8157417">,</span>&nbsp;<span class="ident" id="8157419">h</span><span class="op" id="8157420">,</span>&nbsp;<span class="string" id="8157422">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="8157456">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157460">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="8157479">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157483">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="8157502">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157506">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="8157521">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157525">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="8157540">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157544">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="8157567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157571">expectedMap</span><span class="op" id="8157582">)</span><br>
<span class="lineno"></span><span class="op" id="8157584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="8157587">func</span>&nbsp;<span class="ident" id="8157592">TestPathInfoNoRoot</span><span class="op" id="8157610">(</span><span class="ident" id="8157611">t</span>&nbsp;<span class="op" id="8157613">*</span><span class="ident" id="8157614">testing</span><span class="op" id="8157621">.</span><span class="ident" id="8157622">T</span><span class="op" id="8157623">)</span>&nbsp;<span class="op" id="8157625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157628">check</span><span class="op" id="8157633">(</span><span class="ident" id="8157634">t</span><span class="op" id="8157635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157638">h</span>&nbsp;<span class="op" id="8157640">:=</span>&nbsp;<span class="op" id="8157643">&amp;</span><span class="ident" id="8157644">Handler</span><span class="op" id="8157651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157655">Path</span><span class="op" id="8157659">:</span>&nbsp;<span class="string" id="8157661">&#34;testdata/test.cgi&#34;</span><span class="op" id="8157680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157684">Root</span><span class="op" id="8157688">:</span>&nbsp;<span class="string" id="8157690">&#34;&#34;</span><span class="op" id="8157692">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157698">expectedMap</span>&nbsp;<span class="op" id="8157710">:=</span>&nbsp;<span class="keyword" id="8157713">map</span><span class="op" id="8157716">[</span><span class="builtintype" id="8157717">string</span><span class="op" id="8157723">]</span><span class="builtintype" id="8157724">string</span><span class="op" id="8157730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157734">&#34;env-PATH_INFO&#34;</span><span class="op" id="8157749">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157757">&#34;/bar&#34;</span><span class="op" id="8157763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157767">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8157785">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157790">&#34;a=b&#34;</span><span class="op" id="8157795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157799">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8157816">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157822">&#34;/bar?a=b&#34;</span><span class="op" id="8157832">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157836">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8157857">:</span>&nbsp;<span class="string" id="8157859">&#34;testdata/test.cgi&#34;</span><span class="op" id="8157878">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8157882">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8157899">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8157905">&#34;/&#34;</span><span class="op" id="8157908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157914">runCgiTest</span><span class="op" id="8157924">(</span><span class="ident" id="8157925">t</span><span class="op" id="8157926">,</span>&nbsp;<span class="ident" id="8157928">h</span><span class="op" id="8157929">,</span>&nbsp;<span class="string" id="8157931">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8157977">,</span>&nbsp;<span class="ident" id="8157979">expectedMap</span><span class="op" id="8157990">)</span><br>
<span class="lineno"></span><span class="op" id="8157992">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="8157995">func</span>&nbsp;<span class="ident" id="8158000">TestCGIBasicPost</span><span class="op" id="8158016">(</span><span class="ident" id="8158017">t</span>&nbsp;<span class="op" id="8158019">*</span><span class="ident" id="8158020">testing</span><span class="op" id="8158027">.</span><span class="ident" id="8158028">T</span><span class="op" id="8158029">)</span>&nbsp;<span class="op" id="8158031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158034">check</span><span class="op" id="8158039">(</span><span class="ident" id="8158040">t</span><span class="op" id="8158041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158044">postReq</span>&nbsp;<span class="op" id="8158052">:=</span>&nbsp;<span class="string" id="8158055">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158188">h</span>&nbsp;<span class="op" id="8158190">:=</span>&nbsp;<span class="op" id="8158193">&amp;</span><span class="ident" id="8158194">Handler</span><span class="op" id="8158201">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158205">Path</span><span class="op" id="8158209">:</span>&nbsp;<span class="string" id="8158211">&#34;testdata/test.cgi&#34;</span><span class="op" id="8158230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158234">Root</span><span class="op" id="8158238">:</span>&nbsp;<span class="string" id="8158240">&#34;/test.cgi&#34;</span><span class="op" id="8158251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158257">expectedMap</span>&nbsp;<span class="op" id="8158269">:=</span>&nbsp;<span class="keyword" id="8158272">map</span><span class="op" id="8158275">[</span><span class="builtintype" id="8158276">string</span><span class="op" id="8158282">]</span><span class="builtintype" id="8158283">string</span><span class="op" id="8158289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8158293">&#34;test&#34;</span><span class="op" id="8158299">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8158315">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="8158326">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8158330">&#34;param-postfoo&#34;</span><span class="op" id="8158345">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8158352">&#34;postbar&#34;</span><span class="op" id="8158361">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8158365">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8158385">:</span>&nbsp;<span class="string" id="8158387">&#34;POST&#34;</span><span class="op" id="8158393">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8158397">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="8158417">:</span>&nbsp;<span class="string" id="8158419">&#34;15&#34;</span><span class="op" id="8158423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8158427">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8158444">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8158449">&#34;/test.cgi?a=b&#34;</span><span class="op" id="8158464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158467">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158470">runCgiTest</span><span class="op" id="8158480">(</span><span class="ident" id="8158481">t</span><span class="op" id="8158482">,</span>&nbsp;<span class="ident" id="8158484">h</span><span class="op" id="8158485">,</span>&nbsp;<span class="ident" id="8158487">postReq</span><span class="op" id="8158494">,</span>&nbsp;<span class="ident" id="8158496">expectedMap</span><span class="op" id="8158507">)</span><br>
<span class="lineno"></span><span class="op" id="8158509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8158512">func</span>&nbsp;<span class="ident" id="8158517">chunk</span><span class="op" id="8158522">(</span><span class="ident" id="8158523">s</span>&nbsp;<span class="builtintype" id="8158525">string</span><span class="op" id="8158531">)</span>&nbsp;<span class="builtintype" id="8158533">string</span>&nbsp;<span class="op" id="8158540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158543">return</span>&nbsp;<span class="ident" id="8158550">fmt</span><span class="op" id="8158553">.</span><span class="ident" id="8158554">Sprintf</span><span class="op" id="8158561">(</span><span class="string" id="8158562">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="8158576">,</span>&nbsp;<span class="builtinfunc" id="8158578">len</span><span class="op" id="8158581">(</span><span class="ident" id="8158582">s</span><span class="op" id="8158583">)</span><span class="op" id="8158584">,</span>&nbsp;<span class="ident" id="8158586">s</span><span class="op" id="8158587">)</span><br>
<span class="lineno">240</span><span class="op" id="8158589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8158592">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="8158640">func</span>&nbsp;<span class="ident" id="8158645">TestCGIPostChunked</span><span class="op" id="8158663">(</span><span class="ident" id="8158664">t</span>&nbsp;<span class="op" id="8158666">*</span><span class="ident" id="8158667">testing</span><span class="op" id="8158674">.</span><span class="ident" id="8158675">T</span><span class="op" id="8158676">)</span>&nbsp;<span class="op" id="8158678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158681">check</span><span class="op" id="8158686">(</span><span class="ident" id="8158687">t</span><span class="op" id="8158688">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158691">postReq</span>&nbsp;<span class="op" id="8158699">:=</span>&nbsp;<span class="string" id="8158702">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="8158827">+</span>&nbsp;<span class="ident" id="8158829">chunk</span><span class="op" id="8158834">(</span><span class="string" id="8158835">&#34;postfoo&#34;</span><span class="op" id="8158844">)</span>&nbsp;<span class="op" id="8158846">+</span>&nbsp;<span class="ident" id="8158848">chunk</span><span class="op" id="8158853">(</span><span class="string" id="8158854">&#34;=&#34;</span><span class="op" id="8158857">)</span>&nbsp;<span class="op" id="8158859">+</span>&nbsp;<span class="ident" id="8158861">chunk</span><span class="op" id="8158866">(</span><span class="string" id="8158867">&#34;postbar&#34;</span><span class="op" id="8158876">)</span>&nbsp;<span class="op" id="8158878">+</span>&nbsp;<span class="ident" id="8158880">chunk</span><span class="op" id="8158885">(</span><span class="string" id="8158886">&#34;&#34;</span><span class="op" id="8158888">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158892">h</span>&nbsp;<span class="op" id="8158894">:=</span>&nbsp;<span class="op" id="8158897">&amp;</span><span class="ident" id="8158898">Handler</span><span class="op" id="8158905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158909">Path</span><span class="op" id="8158913">:</span>&nbsp;<span class="string" id="8158915">&#34;testdata/test.cgi&#34;</span><span class="op" id="8158934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158938">Root</span><span class="op" id="8158942">:</span>&nbsp;<span class="string" id="8158944">&#34;/test.cgi&#34;</span><span class="op" id="8158955">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158961">expectedMap</span>&nbsp;<span class="op" id="8158973">:=</span>&nbsp;<span class="keyword" id="8158976">map</span><span class="op" id="8158979">[</span><span class="builtintype" id="8158980">string</span><span class="op" id="8158986">]</span><span class="builtintype" id="8158987">string</span><span class="op" id="8158993">{</span><span class="op" id="8158994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158997">resp</span>&nbsp;<span class="op" id="8159002">:=</span>&nbsp;<span class="ident" id="8159005">runCgiTest</span><span class="op" id="8159015">(</span><span class="ident" id="8159016">t</span><span class="op" id="8159017">,</span>&nbsp;<span class="ident" id="8159019">h</span><span class="op" id="8159020">,</span>&nbsp;<span class="ident" id="8159022">postReq</span><span class="op" id="8159029">,</span>&nbsp;<span class="ident" id="8159031">expectedMap</span><span class="op" id="8159042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159045">if</span>&nbsp;<span class="ident" id="8159048">got</span><span class="op" id="8159051">,</span>&nbsp;<span class="ident" id="8159053">expected</span>&nbsp;<span class="op" id="8159062">:=</span>&nbsp;<span class="ident" id="8159065">resp</span><span class="op" id="8159069">.</span><span class="ident" id="8159070">Code</span><span class="op" id="8159074">,</span>&nbsp;<span class="ident" id="8159076">http</span><span class="op" id="8159080">.</span><span class="ident" id="8159081">StatusBadRequest</span><span class="op" id="8159097">;</span>&nbsp;<span class="ident" id="8159099">got</span>&nbsp;<span class="op" id="8159103">!=</span>&nbsp;<span class="ident" id="8159106">expected</span>&nbsp;<span class="op" id="8159115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159119">t</span><span class="op" id="8159120">.</span><span class="ident" id="8159121">Fatalf</span><span class="op" id="8159127">(</span><span class="string" id="8159128">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8159189">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159194">expected</span><span class="op" id="8159202">,</span>&nbsp;<span class="ident" id="8159204">got</span><span class="op" id="8159207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159210">}</span><br>
<span class="lineno"></span><span class="op" id="8159212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8159215">func</span>&nbsp;<span class="ident" id="8159220">TestRedirect</span><span class="op" id="8159232">(</span><span class="ident" id="8159233">t</span>&nbsp;<span class="op" id="8159235">*</span><span class="ident" id="8159236">testing</span><span class="op" id="8159243">.</span><span class="ident" id="8159244">T</span><span class="op" id="8159245">)</span>&nbsp;<span class="op" id="8159247">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159250">check</span><span class="op" id="8159255">(</span><span class="ident" id="8159256">t</span><span class="op" id="8159257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159260">h</span>&nbsp;<span class="op" id="8159262">:=</span>&nbsp;<span class="op" id="8159265">&amp;</span><span class="ident" id="8159266">Handler</span><span class="op" id="8159273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159277">Path</span><span class="op" id="8159281">:</span>&nbsp;<span class="string" id="8159283">&#34;testdata/test.cgi&#34;</span><span class="op" id="8159302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159306">Root</span><span class="op" id="8159310">:</span>&nbsp;<span class="string" id="8159312">&#34;/test.cgi&#34;</span><span class="op" id="8159323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159326">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159329">rec</span>&nbsp;<span class="op" id="8159333">:=</span>&nbsp;<span class="ident" id="8159336">runCgiTest</span><span class="op" id="8159346">(</span><span class="ident" id="8159347">t</span><span class="op" id="8159348">,</span>&nbsp;<span class="ident" id="8159350">h</span><span class="op" id="8159351">,</span>&nbsp;<span class="string" id="8159353">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8159420">,</span>&nbsp;<span class="ident" id="8159422">nil</span><span class="op" id="8159425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159428">if</span>&nbsp;<span class="ident" id="8159431">e</span><span class="op" id="8159432">,</span>&nbsp;<span class="ident" id="8159434">g</span>&nbsp;<span class="op" id="8159436">:=</span>&nbsp;<span class="num" id="8159439">302</span><span class="op" id="8159442">,</span>&nbsp;<span class="ident" id="8159444">rec</span><span class="op" id="8159447">.</span><span class="ident" id="8159448">Code</span><span class="op" id="8159452">;</span>&nbsp;<span class="ident" id="8159454">e</span>&nbsp;<span class="op" id="8159456">!=</span>&nbsp;<span class="ident" id="8159459">g</span>&nbsp;<span class="op" id="8159461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159465">t</span><span class="op" id="8159466">.</span><span class="ident" id="8159467">Errorf</span><span class="op" id="8159473">(</span><span class="string" id="8159474">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8159507">,</span>&nbsp;<span class="ident" id="8159509">e</span><span class="op" id="8159510">,</span>&nbsp;<span class="ident" id="8159512">g</span><span class="op" id="8159513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159519">if</span>&nbsp;<span class="ident" id="8159522">e</span><span class="op" id="8159523">,</span>&nbsp;<span class="ident" id="8159525">g</span>&nbsp;<span class="op" id="8159527">:=</span>&nbsp;<span class="string" id="8159530">&#34;http://foo.com/&#34;</span><span class="op" id="8159547">,</span>&nbsp;<span class="ident" id="8159549">rec</span><span class="op" id="8159552">.</span><span class="ident" id="8159553">Header</span><span class="op" id="8159559">(</span><span class="op" id="8159560">)</span><span class="op" id="8159561">.</span><span class="ident" id="8159562">Get</span><span class="op" id="8159565">(</span><span class="string" id="8159566">&#34;Location&#34;</span><span class="op" id="8159576">)</span><span class="op" id="8159577">;</span>&nbsp;<span class="ident" id="8159579">e</span>&nbsp;<span class="op" id="8159581">!=</span>&nbsp;<span class="ident" id="8159584">g</span>&nbsp;<span class="op" id="8159586">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159590">t</span><span class="op" id="8159591">.</span><span class="ident" id="8159592">Errorf</span><span class="op" id="8159598">(</span><span class="string" id="8159599">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8159639">,</span>&nbsp;<span class="ident" id="8159641">e</span><span class="op" id="8159642">,</span>&nbsp;<span class="ident" id="8159644">g</span><span class="op" id="8159645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159648">}</span><br>
<span class="lineno"></span><span class="op" id="8159650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8159653">func</span>&nbsp;<span class="ident" id="8159658">TestInternalRedirect</span><span class="op" id="8159678">(</span><span class="ident" id="8159679">t</span>&nbsp;<span class="op" id="8159681">*</span><span class="ident" id="8159682">testing</span><span class="op" id="8159689">.</span><span class="ident" id="8159690">T</span><span class="op" id="8159691">)</span>&nbsp;<span class="op" id="8159693">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159696">check</span><span class="op" id="8159701">(</span><span class="ident" id="8159702">t</span><span class="op" id="8159703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159706">baseHandler</span>&nbsp;<span class="op" id="8159718">:=</span>&nbsp;<span class="ident" id="8159721">http</span><span class="op" id="8159725">.</span><span class="ident" id="8159726">HandlerFunc</span><span class="op" id="8159737">(</span><span class="keyword" id="8159738">func</span><span class="op" id="8159742">(</span><span class="ident" id="8159743">rw</span>&nbsp;<span class="ident" id="8159746">http</span><span class="op" id="8159750">.</span><span class="ident" id="8159751">ResponseWriter</span><span class="op" id="8159765">,</span>&nbsp;<span class="ident" id="8159767">req</span>&nbsp;<span class="op" id="8159771">*</span><span class="ident" id="8159772">http</span><span class="op" id="8159776">.</span><span class="ident" id="8159777">Request</span><span class="op" id="8159784">)</span>&nbsp;<span class="op" id="8159786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159790">fmt</span><span class="op" id="8159793">.</span><span class="ident" id="8159794">Fprintf</span><span class="op" id="8159801">(</span><span class="ident" id="8159802">rw</span><span class="op" id="8159804">,</span>&nbsp;<span class="string" id="8159806">&#34;basepath=%s\n&#34;</span><span class="op" id="8159821">,</span>&nbsp;<span class="ident" id="8159823">req</span><span class="op" id="8159826">.</span><span class="ident" id="8159827">URL</span><span class="op" id="8159830">.</span><span class="ident" id="8159831">Path</span><span class="op" id="8159835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159839">fmt</span><span class="op" id="8159842">.</span><span class="ident" id="8159843">Fprintf</span><span class="op" id="8159850">(</span><span class="ident" id="8159851">rw</span><span class="op" id="8159853">,</span>&nbsp;<span class="string" id="8159855">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="8159872">,</span>&nbsp;<span class="ident" id="8159874">req</span><span class="op" id="8159877">.</span><span class="ident" id="8159878">RemoteAddr</span><span class="op" id="8159888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159891">}</span><span class="op" id="8159892">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159895">h</span>&nbsp;<span class="op" id="8159897">:=</span>&nbsp;<span class="op" id="8159900">&amp;</span><span class="ident" id="8159901">Handler</span><span class="op" id="8159908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159912">Path</span><span class="op" id="8159916">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8159933">&#34;testdata/test.cgi&#34;</span><span class="op" id="8159952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159956">Root</span><span class="op" id="8159960">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8159977">&#34;/test.cgi&#34;</span><span class="op" id="8159988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159992">PathLocationHandler</span><span class="op" id="8160011">:</span>&nbsp;<span class="ident" id="8160013">baseHandler</span><span class="op" id="8160024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160027">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160030">expectedMap</span>&nbsp;<span class="op" id="8160042">:=</span>&nbsp;<span class="keyword" id="8160045">map</span><span class="op" id="8160048">[</span><span class="builtintype" id="8160049">string</span><span class="op" id="8160055">]</span><span class="builtintype" id="8160056">string</span><span class="op" id="8160062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8160066">&#34;basepath&#34;</span><span class="op" id="8160076">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8160080">&#34;/foo&#34;</span><span class="op" id="8160086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8160090">&#34;remoteaddr&#34;</span><span class="op" id="8160102">:</span>&nbsp;<span class="string" id="8160104">&#34;1.2.3.4&#34;</span><span class="op" id="8160113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160119">runCgiTest</span><span class="op" id="8160129">(</span><span class="ident" id="8160130">t</span><span class="op" id="8160131">,</span>&nbsp;<span class="ident" id="8160133">h</span><span class="op" id="8160134">,</span>&nbsp;<span class="string" id="8160136">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8160192">,</span>&nbsp;<span class="ident" id="8160194">expectedMap</span><span class="op" id="8160205">)</span><br>
<span class="lineno">295</span><span class="op" id="8160207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8160210">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="8160286">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="8160349">func</span>&nbsp;<span class="ident" id="8160354">TestCopyError</span><span class="op" id="8160367">(</span><span class="ident" id="8160368">t</span>&nbsp;<span class="op" id="8160370">*</span><span class="ident" id="8160371">testing</span><span class="op" id="8160378">.</span><span class="ident" id="8160379">T</span><span class="op" id="8160380">)</span>&nbsp;<span class="op" id="8160382">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160385">check</span><span class="op" id="8160390">(</span><span class="ident" id="8160391">t</span><span class="op" id="8160392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160395">if</span>&nbsp;<span class="ident" id="8160398">runtime</span><span class="op" id="8160405">.</span><span class="ident" id="8160406">GOOS</span>&nbsp;<span class="op" id="8160411">==</span>&nbsp;<span class="string" id="8160414">&#34;windows&#34;</span>&nbsp;<span class="op" id="8160424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160428">t</span><span class="op" id="8160429">.</span><span class="ident" id="8160430">Skipf</span><span class="op" id="8160435">(</span><span class="string" id="8160436">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8160457">,</span>&nbsp;<span class="ident" id="8160459">runtime</span><span class="op" id="8160466">.</span><span class="ident" id="8160467">GOOS</span><span class="op" id="8160471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160477">h</span>&nbsp;<span class="op" id="8160479">:=</span>&nbsp;<span class="op" id="8160482">&amp;</span><span class="ident" id="8160483">Handler</span><span class="op" id="8160490">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160494">Path</span><span class="op" id="8160498">:</span>&nbsp;<span class="string" id="8160500">&#34;testdata/test.cgi&#34;</span><span class="op" id="8160519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160523">Root</span><span class="op" id="8160527">:</span>&nbsp;<span class="string" id="8160529">&#34;/test.cgi&#34;</span><span class="op" id="8160540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160546">ts</span>&nbsp;<span class="op" id="8160549">:=</span>&nbsp;<span class="ident" id="8160552">httptest</span><span class="op" id="8160560">.</span><span class="ident" id="8160561">NewServer</span><span class="op" id="8160570">(</span><span class="ident" id="8160571">h</span><span class="op" id="8160572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160575">defer</span>&nbsp;<span class="ident" id="8160581">ts</span><span class="op" id="8160583">.</span><span class="ident" id="8160584">Close</span><span class="op" id="8160589">(</span><span class="op" id="8160590">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160594">conn</span><span class="op" id="8160598">,</span>&nbsp;<span class="ident" id="8160600">err</span>&nbsp;<span class="op" id="8160604">:=</span>&nbsp;<span class="ident" id="8160607">net</span><span class="op" id="8160610">.</span><span class="ident" id="8160611">Dial</span><span class="op" id="8160615">(</span><span class="string" id="8160616">&#34;tcp&#34;</span><span class="op" id="8160621">,</span>&nbsp;<span class="ident" id="8160623">ts</span><span class="op" id="8160625">.</span><span class="ident" id="8160626">Listener</span><span class="op" id="8160634">.</span><span class="ident" id="8160635">Addr</span><span class="op" id="8160639">(</span><span class="op" id="8160640">)</span><span class="op" id="8160641">.</span><span class="ident" id="8160642">String</span><span class="op" id="8160648">(</span><span class="op" id="8160649">)</span><span class="op" id="8160650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160653">if</span>&nbsp;<span class="ident" id="8160656">err</span>&nbsp;<span class="op" id="8160660">!=</span>&nbsp;<span class="ident" id="8160663">nil</span>&nbsp;<span class="op" id="8160667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160671">t</span><span class="op" id="8160672">.</span><span class="ident" id="8160673">Fatal</span><span class="op" id="8160678">(</span><span class="ident" id="8160679">err</span><span class="op" id="8160682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160685">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160688">req</span><span class="op" id="8160691">,</span>&nbsp;<span class="ident" id="8160693">_</span>&nbsp;<span class="op" id="8160695">:=</span>&nbsp;<span class="ident" id="8160698">http</span><span class="op" id="8160702">.</span><span class="ident" id="8160703">NewRequest</span><span class="op" id="8160713">(</span><span class="string" id="8160714">&#34;GET&#34;</span><span class="op" id="8160719">,</span>&nbsp;<span class="string" id="8160721">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="8160764">,</span>&nbsp;<span class="ident" id="8160766">nil</span><span class="op" id="8160769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160772">err</span>&nbsp;<span class="op" id="8160776">=</span>&nbsp;<span class="ident" id="8160778">req</span><span class="op" id="8160781">.</span><span class="ident" id="8160782">Write</span><span class="op" id="8160787">(</span><span class="ident" id="8160788">conn</span><span class="op" id="8160792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160795">if</span>&nbsp;<span class="ident" id="8160798">err</span>&nbsp;<span class="op" id="8160802">!=</span>&nbsp;<span class="ident" id="8160805">nil</span>&nbsp;<span class="op" id="8160809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160813">t</span><span class="op" id="8160814">.</span><span class="ident" id="8160815">Fatalf</span><span class="op" id="8160821">(</span><span class="string" id="8160822">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="8160833">,</span>&nbsp;<span class="ident" id="8160835">err</span><span class="op" id="8160838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160841">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160845">res</span><span class="op" id="8160848">,</span>&nbsp;<span class="ident" id="8160850">err</span>&nbsp;<span class="op" id="8160854">:=</span>&nbsp;<span class="ident" id="8160857">http</span><span class="op" id="8160861">.</span><span class="ident" id="8160862">ReadResponse</span><span class="op" id="8160874">(</span><span class="ident" id="8160875">bufio</span><span class="op" id="8160880">.</span><span class="ident" id="8160881">NewReader</span><span class="op" id="8160890">(</span><span class="ident" id="8160891">conn</span><span class="op" id="8160895">)</span><span class="op" id="8160896">,</span>&nbsp;<span class="ident" id="8160898">req</span><span class="op" id="8160901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160904">if</span>&nbsp;<span class="ident" id="8160907">err</span>&nbsp;<span class="op" id="8160911">!=</span>&nbsp;<span class="ident" id="8160914">nil</span>&nbsp;<span class="op" id="8160918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160922">t</span><span class="op" id="8160923">.</span><span class="ident" id="8160924">Fatalf</span><span class="op" id="8160930">(</span><span class="string" id="8160931">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="8160949">,</span>&nbsp;<span class="ident" id="8160951">err</span><span class="op" id="8160954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160957">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160961">pidstr</span>&nbsp;<span class="op" id="8160968">:=</span>&nbsp;<span class="ident" id="8160971">res</span><span class="op" id="8160974">.</span><span class="ident" id="8160975">Header</span><span class="op" id="8160981">.</span><span class="ident" id="8160982">Get</span><span class="op" id="8160985">(</span><span class="string" id="8160986">&#34;X-CGI-Pid&#34;</span><span class="op" id="8160997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161000">if</span>&nbsp;<span class="ident" id="8161003">pidstr</span>&nbsp;<span class="op" id="8161010">==</span>&nbsp;<span class="string" id="8161013">&#34;&#34;</span>&nbsp;<span class="op" id="8161016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161020">t</span><span class="op" id="8161021">.</span><span class="ident" id="8161022">Fatalf</span><span class="op" id="8161028">(</span><span class="string" id="8161029">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="8161071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161074">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161077">pid</span><span class="op" id="8161080">,</span>&nbsp;<span class="ident" id="8161082">err</span>&nbsp;<span class="op" id="8161086">:=</span>&nbsp;<span class="ident" id="8161089">strconv</span><span class="op" id="8161096">.</span><span class="ident" id="8161097">Atoi</span><span class="op" id="8161101">(</span><span class="ident" id="8161102">pidstr</span><span class="op" id="8161108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161111">if</span>&nbsp;<span class="ident" id="8161114">err</span>&nbsp;<span class="op" id="8161118">!=</span>&nbsp;<span class="ident" id="8161121">nil</span>&nbsp;<span class="op" id="8161125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161129">t</span><span class="op" id="8161130">.</span><span class="ident" id="8161131">Fatalf</span><span class="op" id="8161137">(</span><span class="string" id="8161138">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="8161163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161170">var</span>&nbsp;<span class="ident" id="8161174">buf</span>&nbsp;<span class="op" id="8161178">[</span><span class="num" id="8161179">5000</span><span class="op" id="8161183">]</span><span class="builtintype" id="8161184">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161190">n</span><span class="op" id="8161191">,</span>&nbsp;<span class="ident" id="8161193">err</span>&nbsp;<span class="op" id="8161197">:=</span>&nbsp;<span class="ident" id="8161200">io</span><span class="op" id="8161202">.</span><span class="ident" id="8161203">ReadFull</span><span class="op" id="8161211">(</span><span class="ident" id="8161212">res</span><span class="op" id="8161215">.</span><span class="ident" id="8161216">Body</span><span class="op" id="8161220">,</span>&nbsp;<span class="ident" id="8161222">buf</span><span class="op" id="8161225">[</span><span class="op" id="8161226">:</span><span class="op" id="8161227">]</span><span class="op" id="8161228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161231">if</span>&nbsp;<span class="ident" id="8161234">err</span>&nbsp;<span class="op" id="8161238">!=</span>&nbsp;<span class="ident" id="8161241">nil</span>&nbsp;<span class="op" id="8161245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161249">t</span><span class="op" id="8161250">.</span><span class="ident" id="8161251">Fatalf</span><span class="op" id="8161257">(</span><span class="string" id="8161258">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="8161282">,</span>&nbsp;<span class="ident" id="8161284">n</span><span class="op" id="8161285">,</span>&nbsp;<span class="ident" id="8161287">err</span><span class="op" id="8161290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161293">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161297">childRunning</span>&nbsp;<span class="op" id="8161310">:=</span>&nbsp;<span class="keyword" id="8161313">func</span><span class="op" id="8161317">(</span><span class="op" id="8161318">)</span>&nbsp;<span class="builtintype" id="8161320">bool</span>&nbsp;<span class="op" id="8161325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161329">return</span>&nbsp;<span class="ident" id="8161336">isProcessRunning</span><span class="op" id="8161352">(</span><span class="ident" id="8161353">t</span><span class="op" id="8161354">,</span>&nbsp;<span class="ident" id="8161356">pid</span><span class="op" id="8161359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161366">if</span>&nbsp;<span class="op" id="8161369">!</span><span class="ident" id="8161370">childRunning</span><span class="op" id="8161382">(</span><span class="op" id="8161383">)</span>&nbsp;<span class="op" id="8161385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161389">t</span><span class="op" id="8161390">.</span><span class="ident" id="8161391">Fatalf</span><span class="op" id="8161397">(</span><span class="string" id="8161398">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="8161444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161450">conn</span><span class="op" id="8161454">.</span><span class="ident" id="8161455">Close</span><span class="op" id="8161460">(</span><span class="op" id="8161461">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161465">tries</span>&nbsp;<span class="op" id="8161471">:=</span>&nbsp;<span class="num" id="8161474">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161477">for</span>&nbsp;<span class="ident" id="8161481">tries</span>&nbsp;<span class="op" id="8161487">&lt;</span>&nbsp;<span class="num" id="8161489">25</span>&nbsp;<span class="op" id="8161492">&amp;&amp;</span>&nbsp;<span class="ident" id="8161495">childRunning</span><span class="op" id="8161507">(</span><span class="op" id="8161508">)</span>&nbsp;<span class="op" id="8161510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161514">time</span><span class="op" id="8161518">.</span><span class="ident" id="8161519">Sleep</span><span class="op" id="8161524">(</span><span class="num" id="8161525">50</span>&nbsp;<span class="op" id="8161528">*</span>&nbsp;<span class="ident" id="8161530">time</span><span class="op" id="8161534">.</span><span class="ident" id="8161535">Millisecond</span>&nbsp;<span class="op" id="8161547">*</span>&nbsp;<span class="ident" id="8161549">time</span><span class="op" id="8161553">.</span><span class="ident" id="8161554">Duration</span><span class="op" id="8161562">(</span><span class="ident" id="8161563">tries</span><span class="op" id="8161568">)</span><span class="op" id="8161569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161573">tries</span><span class="op" id="8161578">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161582">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161585">if</span>&nbsp;<span class="ident" id="8161588">childRunning</span><span class="op" id="8161600">(</span><span class="op" id="8161601">)</span>&nbsp;<span class="op" id="8161603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161607">t</span><span class="op" id="8161608">.</span><span class="ident" id="8161609">Fatalf</span><span class="op" id="8161615">(</span><span class="string" id="8161616">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="8161660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161663">}</span><br>
<span class="lineno"></span><span class="op" id="8161665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="8161668">func</span>&nbsp;<span class="ident" id="8161673">TestDirUnix</span><span class="op" id="8161684">(</span><span class="ident" id="8161685">t</span>&nbsp;<span class="op" id="8161687">*</span><span class="ident" id="8161688">testing</span><span class="op" id="8161695">.</span><span class="ident" id="8161696">T</span><span class="op" id="8161697">)</span>&nbsp;<span class="op" id="8161699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161702">check</span><span class="op" id="8161707">(</span><span class="ident" id="8161708">t</span><span class="op" id="8161709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8161712">if</span>&nbsp;<span class="ident" id="8161715">runtime</span><span class="op" id="8161722">.</span><span class="ident" id="8161723">GOOS</span>&nbsp;<span class="op" id="8161728">==</span>&nbsp;<span class="string" id="8161731">&#34;windows&#34;</span>&nbsp;<span class="op" id="8161741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161745">t</span><span class="op" id="8161746">.</span><span class="ident" id="8161747">Skipf</span><span class="op" id="8161752">(</span><span class="string" id="8161753">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8161774">,</span>&nbsp;<span class="ident" id="8161776">runtime</span><span class="op" id="8161783">.</span><span class="ident" id="8161784">GOOS</span><span class="op" id="8161788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161791">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161794">cwd</span><span class="op" id="8161797">,</span>&nbsp;<span class="ident" id="8161799">_</span>&nbsp;<span class="op" id="8161801">:=</span>&nbsp;<span class="ident" id="8161804">os</span><span class="op" id="8161806">.</span><span class="ident" id="8161807">Getwd</span><span class="op" id="8161812">(</span><span class="op" id="8161813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161816">h</span>&nbsp;<span class="op" id="8161818">:=</span>&nbsp;<span class="op" id="8161821">&amp;</span><span class="ident" id="8161822">Handler</span><span class="op" id="8161829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161833">Path</span><span class="op" id="8161837">:</span>&nbsp;<span class="string" id="8161839">&#34;testdata/test.cgi&#34;</span><span class="op" id="8161858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161862">Root</span><span class="op" id="8161866">:</span>&nbsp;<span class="string" id="8161868">&#34;/test.cgi&#34;</span><span class="op" id="8161879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161883">Dir</span><span class="op" id="8161886">:</span>&nbsp;&nbsp;<span class="ident" id="8161889">cwd</span><span class="op" id="8161892">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161898">expectedMap</span>&nbsp;<span class="op" id="8161910">:=</span>&nbsp;<span class="keyword" id="8161913">map</span><span class="op" id="8161916">[</span><span class="builtintype" id="8161917">string</span><span class="op" id="8161923">]</span><span class="builtintype" id="8161924">string</span><span class="op" id="8161930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8161934">&#34;cwd&#34;</span><span class="op" id="8161939">:</span>&nbsp;<span class="ident" id="8161941">cwd</span><span class="op" id="8161944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8161947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8161950">runCgiTest</span><span class="op" id="8161960">(</span><span class="ident" id="8161961">t</span><span class="op" id="8161962">,</span>&nbsp;<span class="ident" id="8161964">h</span><span class="op" id="8161965">,</span>&nbsp;<span class="string" id="8161967">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8162014">,</span>&nbsp;<span class="ident" id="8162016">expectedMap</span><span class="op" id="8162027">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162031">cwd</span><span class="op" id="8162034">,</span>&nbsp;<span class="ident" id="8162036">_</span>&nbsp;<span class="op" id="8162038">=</span>&nbsp;<span class="ident" id="8162040">os</span><span class="op" id="8162042">.</span><span class="ident" id="8162043">Getwd</span><span class="op" id="8162048">(</span><span class="op" id="8162049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162052">cwd</span>&nbsp;<span class="op" id="8162056">=</span>&nbsp;<span class="ident" id="8162058">filepath</span><span class="op" id="8162066">.</span><span class="ident" id="8162067">Join</span><span class="op" id="8162071">(</span><span class="ident" id="8162072">cwd</span><span class="op" id="8162075">,</span>&nbsp;<span class="string" id="8162077">&#34;testdata&#34;</span><span class="op" id="8162087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162090">h</span>&nbsp;<span class="op" id="8162092">=</span>&nbsp;<span class="op" id="8162094">&amp;</span><span class="ident" id="8162095">Handler</span><span class="op" id="8162102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162106">Path</span><span class="op" id="8162110">:</span>&nbsp;<span class="string" id="8162112">&#34;testdata/test.cgi&#34;</span><span class="op" id="8162131">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162135">Root</span><span class="op" id="8162139">:</span>&nbsp;<span class="string" id="8162141">&#34;/test.cgi&#34;</span><span class="op" id="8162152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8162155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162158">expectedMap</span>&nbsp;<span class="op" id="8162170">=</span>&nbsp;<span class="keyword" id="8162172">map</span><span class="op" id="8162175">[</span><span class="builtintype" id="8162176">string</span><span class="op" id="8162182">]</span><span class="builtintype" id="8162183">string</span><span class="op" id="8162189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8162193">&#34;cwd&#34;</span><span class="op" id="8162198">:</span>&nbsp;<span class="ident" id="8162200">cwd</span><span class="op" id="8162203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8162206">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162209">runCgiTest</span><span class="op" id="8162219">(</span><span class="ident" id="8162220">t</span><span class="op" id="8162221">,</span>&nbsp;<span class="ident" id="8162223">h</span><span class="op" id="8162224">,</span>&nbsp;<span class="string" id="8162226">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8162273">,</span>&nbsp;<span class="ident" id="8162275">expectedMap</span><span class="op" id="8162286">)</span><br>
<span class="lineno"></span><span class="op" id="8162288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8162291">func</span>&nbsp;<span class="ident" id="8162296">TestDirWindows</span><span class="op" id="8162310">(</span><span class="ident" id="8162311">t</span>&nbsp;<span class="op" id="8162313">*</span><span class="ident" id="8162314">testing</span><span class="op" id="8162321">.</span><span class="ident" id="8162322">T</span><span class="op" id="8162323">)</span>&nbsp;<span class="op" id="8162325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8162328">if</span>&nbsp;<span class="ident" id="8162331">runtime</span><span class="op" id="8162338">.</span><span class="ident" id="8162339">GOOS</span>&nbsp;<span class="op" id="8162344">!=</span>&nbsp;<span class="string" id="8162347">&#34;windows&#34;</span>&nbsp;<span class="op" id="8162357">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162361">t</span><span class="op" id="8162362">.</span><span class="ident" id="8162363">Skip</span><span class="op" id="8162367">(</span><span class="string" id="8162368">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="8162401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8162404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162408">cgifile</span><span class="op" id="8162415">,</span>&nbsp;<span class="ident" id="8162417">_</span>&nbsp;<span class="op" id="8162419">:=</span>&nbsp;<span class="ident" id="8162422">filepath</span><span class="op" id="8162430">.</span><span class="ident" id="8162431">Abs</span><span class="op" id="8162434">(</span><span class="string" id="8162435">&#34;testdata/test.cgi&#34;</span><span class="op" id="8162454">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8162458">var</span>&nbsp;<span class="ident" id="8162462">perl</span>&nbsp;<span class="builtintype" id="8162467">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8162475">var</span>&nbsp;<span class="ident" id="8162479">err</span>&nbsp;<span class="builtintype" id="8162483">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162490">perl</span><span class="op" id="8162494">,</span>&nbsp;<span class="ident" id="8162496">err</span>&nbsp;<span class="op" id="8162500">=</span>&nbsp;<span class="ident" id="8162502">exec</span><span class="op" id="8162506">.</span><span class="ident" id="8162507">LookPath</span><span class="op" id="8162515">(</span><span class="string" id="8162516">&#34;perl&#34;</span><span class="op" id="8162522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8162525">if</span>&nbsp;<span class="ident" id="8162528">err</span>&nbsp;<span class="op" id="8162532">!=</span>&nbsp;<span class="ident" id="8162535">nil</span>&nbsp;<span class="op" id="8162539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162543">t</span><span class="op" id="8162544">.</span><span class="ident" id="8162545">Skip</span><span class="op" id="8162549">(</span><span class="string" id="8162550">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="8162582">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8162585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162588">perl</span><span class="op" id="8162592">,</span>&nbsp;<span class="ident" id="8162594">_</span>&nbsp;<span class="op" id="8162596">=</span>&nbsp;<span class="ident" id="8162598">filepath</span><span class="op" id="8162606">.</span><span class="ident" id="8162607">Abs</span><span class="op" id="8162610">(</span><span class="ident" id="8162611">perl</span><span class="op" id="8162615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162619">cwd</span><span class="op" id="8162622">,</span>&nbsp;<span class="ident" id="8162624">_</span>&nbsp;<span class="op" id="8162626">:=</span>&nbsp;<span class="ident" id="8162629">os</span><span class="op" id="8162631">.</span><span class="ident" id="8162632">Getwd</span><span class="op" id="8162637">(</span><span class="op" id="8162638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162641">h</span>&nbsp;<span class="op" id="8162643">:=</span>&nbsp;<span class="op" id="8162646">&amp;</span><span class="ident" id="8162647">Handler</span><span class="op" id="8162654">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162658">Path</span><span class="op" id="8162662">:</span>&nbsp;<span class="ident" id="8162664">perl</span><span class="op" id="8162668">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162672">Root</span><span class="op" id="8162676">:</span>&nbsp;<span class="string" id="8162678">&#34;/test.cgi&#34;</span><span class="op" id="8162689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162693">Dir</span><span class="op" id="8162696">:</span>&nbsp;&nbsp;<span class="ident" id="8162699">cwd</span><span class="op" id="8162702">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162706">Args</span><span class="op" id="8162710">:</span>&nbsp;<span class="op" id="8162712">[</span><span class="op" id="8162713">]</span><span class="builtintype" id="8162714">string</span><span class="op" id="8162720">{</span><span class="ident" id="8162721">cgifile</span><span class="op" id="8162728">}</span><span class="op" id="8162729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162733">Env</span><span class="op" id="8162736">:</span>&nbsp;&nbsp;<span class="op" id="8162739">[</span><span class="op" id="8162740">]</span><span class="builtintype" id="8162741">string</span><span class="op" id="8162747">{</span><span class="string" id="8162748">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8162767">+</span>&nbsp;<span class="ident" id="8162769">cgifile</span><span class="op" id="8162776">}</span><span class="op" id="8162777">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8162780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162783">expectedMap</span>&nbsp;<span class="op" id="8162795">:=</span>&nbsp;<span class="keyword" id="8162798">map</span><span class="op" id="8162801">[</span><span class="builtintype" id="8162802">string</span><span class="op" id="8162808">]</span><span class="builtintype" id="8162809">string</span><span class="op" id="8162815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8162819">&#34;cwd&#34;</span><span class="op" id="8162824">:</span>&nbsp;<span class="ident" id="8162826">cwd</span><span class="op" id="8162829">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8162832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8162835">runCgiTest</span><span class="op" id="8162845">(</span><span class="ident" id="8162846">t</span><span class="op" id="8162847">,</span>&nbsp;<span class="ident" id="8162849">h</span><span class="op" id="8162850">,</span>&nbsp;<span class="string" id="8162852">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8162899">,</span>&nbsp;<span class="ident" id="8162901">expectedMap</span><span class="op" id="8162912">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8162916">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8162979">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163007">cwd</span><span class="op" id="8163010">,</span>&nbsp;<span class="ident" id="8163012">_</span>&nbsp;<span class="op" id="8163014">=</span>&nbsp;<span class="ident" id="8163016">filepath</span><span class="op" id="8163024">.</span><span class="ident" id="8163025">Split</span><span class="op" id="8163030">(</span><span class="ident" id="8163031">perl</span><span class="op" id="8163035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8163038">if</span>&nbsp;<span class="ident" id="8163041">cwd</span>&nbsp;<span class="op" id="8163045">!=</span>&nbsp;<span class="string" id="8163048">&#34;&#34;</span>&nbsp;<span class="op" id="8163051">&amp;&amp;</span>&nbsp;<span class="ident" id="8163054">cwd</span><span class="op" id="8163057">[</span><span class="builtinfunc" id="8163058">len</span><span class="op" id="8163061">(</span><span class="ident" id="8163062">cwd</span><span class="op" id="8163065">)</span><span class="op" id="8163066">-</span><span class="num" id="8163067">1</span><span class="op" id="8163068">]</span>&nbsp;<span class="op" id="8163070">==</span>&nbsp;<span class="ident" id="8163073">filepath</span><span class="op" id="8163081">.</span><span class="ident" id="8163082">Separator</span>&nbsp;<span class="op" id="8163092">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163096">cwd</span>&nbsp;<span class="op" id="8163100">=</span>&nbsp;<span class="ident" id="8163102">cwd</span><span class="op" id="8163105">[</span><span class="op" id="8163106">:</span><span class="builtinfunc" id="8163107">len</span><span class="op" id="8163110">(</span><span class="ident" id="8163111">cwd</span><span class="op" id="8163114">)</span><span class="op" id="8163115">-</span><span class="num" id="8163116">1</span><span class="op" id="8163117">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8163120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163123">h</span>&nbsp;<span class="op" id="8163125">=</span>&nbsp;<span class="op" id="8163127">&amp;</span><span class="ident" id="8163128">Handler</span><span class="op" id="8163135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163139">Path</span><span class="op" id="8163143">:</span>&nbsp;<span class="ident" id="8163145">perl</span><span class="op" id="8163149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163153">Root</span><span class="op" id="8163157">:</span>&nbsp;<span class="string" id="8163159">&#34;/test.cgi&#34;</span><span class="op" id="8163170">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163174">Args</span><span class="op" id="8163178">:</span>&nbsp;<span class="op" id="8163180">[</span><span class="op" id="8163181">]</span><span class="builtintype" id="8163182">string</span><span class="op" id="8163188">{</span><span class="ident" id="8163189">cgifile</span><span class="op" id="8163196">}</span><span class="op" id="8163197">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163201">Env</span><span class="op" id="8163204">:</span>&nbsp;&nbsp;<span class="op" id="8163207">[</span><span class="op" id="8163208">]</span><span class="builtintype" id="8163209">string</span><span class="op" id="8163215">{</span><span class="string" id="8163216">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8163235">+</span>&nbsp;<span class="ident" id="8163237">cgifile</span><span class="op" id="8163244">}</span><span class="op" id="8163245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8163248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163251">expectedMap</span>&nbsp;<span class="op" id="8163263">=</span>&nbsp;<span class="keyword" id="8163265">map</span><span class="op" id="8163268">[</span><span class="builtintype" id="8163269">string</span><span class="op" id="8163275">]</span><span class="builtintype" id="8163276">string</span><span class="op" id="8163282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8163286">&#34;cwd&#34;</span><span class="op" id="8163291">:</span>&nbsp;<span class="ident" id="8163293">cwd</span><span class="op" id="8163296">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8163299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163302">runCgiTest</span><span class="op" id="8163312">(</span><span class="ident" id="8163313">t</span><span class="op" id="8163314">,</span>&nbsp;<span class="ident" id="8163316">h</span><span class="op" id="8163317">,</span>&nbsp;<span class="string" id="8163319">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8163366">,</span>&nbsp;<span class="ident" id="8163368">expectedMap</span><span class="op" id="8163379">)</span><br>
<span class="lineno"></span><span class="op" id="8163381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8163384">func</span>&nbsp;<span class="ident" id="8163389">TestEnvOverride</span><span class="op" id="8163404">(</span><span class="ident" id="8163405">t</span>&nbsp;<span class="op" id="8163407">*</span><span class="ident" id="8163408">testing</span><span class="op" id="8163415">.</span><span class="ident" id="8163416">T</span><span class="op" id="8163417">)</span>&nbsp;<span class="op" id="8163419">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163422">cgifile</span><span class="op" id="8163429">,</span>&nbsp;<span class="ident" id="8163431">_</span>&nbsp;<span class="op" id="8163433">:=</span>&nbsp;<span class="ident" id="8163436">filepath</span><span class="op" id="8163444">.</span><span class="ident" id="8163445">Abs</span><span class="op" id="8163448">(</span><span class="string" id="8163449">&#34;testdata/test.cgi&#34;</span><span class="op" id="8163468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8163472">var</span>&nbsp;<span class="ident" id="8163476">perl</span>&nbsp;<span class="builtintype" id="8163481">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8163489">var</span>&nbsp;<span class="ident" id="8163493">err</span>&nbsp;<span class="builtintype" id="8163497">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163504">perl</span><span class="op" id="8163508">,</span>&nbsp;<span class="ident" id="8163510">err</span>&nbsp;<span class="op" id="8163514">=</span>&nbsp;<span class="ident" id="8163516">exec</span><span class="op" id="8163520">.</span><span class="ident" id="8163521">LookPath</span><span class="op" id="8163529">(</span><span class="string" id="8163530">&#34;perl&#34;</span><span class="op" id="8163536">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8163539">if</span>&nbsp;<span class="ident" id="8163542">err</span>&nbsp;<span class="op" id="8163546">!=</span>&nbsp;<span class="ident" id="8163549">nil</span>&nbsp;<span class="op" id="8163553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163557">t</span><span class="op" id="8163558">.</span><span class="ident" id="8163559">Skipf</span><span class="op" id="8163564">(</span><span class="string" id="8163565">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="8163597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8163600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163603">perl</span><span class="op" id="8163607">,</span>&nbsp;<span class="ident" id="8163609">_</span>&nbsp;<span class="op" id="8163611">=</span>&nbsp;<span class="ident" id="8163613">filepath</span><span class="op" id="8163621">.</span><span class="ident" id="8163622">Abs</span><span class="op" id="8163625">(</span><span class="ident" id="8163626">perl</span><span class="op" id="8163630">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163634">cwd</span><span class="op" id="8163637">,</span>&nbsp;<span class="ident" id="8163639">_</span>&nbsp;<span class="op" id="8163641">:=</span>&nbsp;<span class="ident" id="8163644">os</span><span class="op" id="8163646">.</span><span class="ident" id="8163647">Getwd</span><span class="op" id="8163652">(</span><span class="op" id="8163653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163656">h</span>&nbsp;<span class="op" id="8163658">:=</span>&nbsp;<span class="op" id="8163661">&amp;</span><span class="ident" id="8163662">Handler</span><span class="op" id="8163669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163673">Path</span><span class="op" id="8163677">:</span>&nbsp;<span class="ident" id="8163679">perl</span><span class="op" id="8163683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163687">Root</span><span class="op" id="8163691">:</span>&nbsp;<span class="string" id="8163693">&#34;/test.cgi&#34;</span><span class="op" id="8163704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163708">Dir</span><span class="op" id="8163711">:</span>&nbsp;&nbsp;<span class="ident" id="8163714">cwd</span><span class="op" id="8163717">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163721">Args</span><span class="op" id="8163725">:</span>&nbsp;<span class="op" id="8163727">[</span><span class="op" id="8163728">]</span><span class="builtintype" id="8163729">string</span><span class="op" id="8163735">{</span><span class="ident" id="8163736">cgifile</span><span class="op" id="8163743">}</span><span class="op" id="8163744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163748">Env</span><span class="op" id="8163751">:</span>&nbsp;<span class="op" id="8163753">[</span><span class="op" id="8163754">]</span><span class="builtintype" id="8163755">string</span><span class="op" id="8163761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8163766">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8163785">+</span>&nbsp;<span class="ident" id="8163787">cgifile</span><span class="op" id="8163794">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8163799">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="8163821">}</span><span class="op" id="8163822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8163825">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163828">expectedMap</span>&nbsp;<span class="op" id="8163840">:=</span>&nbsp;<span class="keyword" id="8163843">map</span><span class="op" id="8163846">[</span><span class="builtintype" id="8163847">string</span><span class="op" id="8163853">]</span><span class="builtintype" id="8163854">string</span><span class="op" id="8163860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8163864">&#34;cwd&#34;</span><span class="op" id="8163869">:</span>&nbsp;<span class="ident" id="8163871">cwd</span><span class="op" id="8163874">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8163878">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8163899">:</span>&nbsp;<span class="ident" id="8163901">cgifile</span><span class="op" id="8163908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8163912">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8163929">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8163935">&#34;/foo/bar&#34;</span><span class="op" id="8163945">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8163948">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8163951">runCgiTest</span><span class="op" id="8163961">(</span><span class="ident" id="8163962">t</span><span class="op" id="8163963">,</span>&nbsp;<span class="ident" id="8163965">h</span><span class="op" id="8163966">,</span>&nbsp;<span class="string" id="8163968">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8164015">,</span>&nbsp;<span class="ident" id="8164017">expectedMap</span><span class="op" id="8164028">)</span><br>
<span class="lineno"></span><span class="op" id="8164030">}</span>
</div>
</body>
</html>
