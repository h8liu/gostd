<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3903906">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3903961">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3904015">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3904066">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="3904137">package</span>&nbsp;<span class="ident" id="3904145">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3904150">import</span>&nbsp;<span class="op" id="3904157">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904160">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904170">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904186">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904200">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904215">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904231">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904241">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904254">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904261">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3904272">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3904279">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3904282">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3904333">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3904376">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3904434">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="3904463">func</span>&nbsp;<span class="ident" id="3904468">Server</span><span class="op" id="3904474">(</span><span class="ident" id="3904475">conn</span>&nbsp;<span class="ident" id="3904480">net</span><span class="op" id="3904483">.</span><span class="ident" id="3904484">Conn</span><span class="op" id="3904488">,</span>&nbsp;<span class="ident" id="3904490">config</span>&nbsp;<span class="op" id="3904497">*</span><span class="ident" id="3904498">Config</span><span class="op" id="3904504">)</span>&nbsp;<span class="op" id="3904506">*</span><span class="ident" id="3904507">Conn</span>&nbsp;<span class="op" id="3904512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3904515">return</span>&nbsp;<span class="op" id="3904522">&amp;</span><span class="ident" id="3904523">Conn</span><span class="op" id="3904527">{</span><span class="ident" id="3904528">conn</span><span class="op" id="3904532">:</span>&nbsp;<span class="ident" id="3904534">conn</span><span class="op" id="3904538">,</span>&nbsp;<span class="ident" id="3904540">config</span><span class="op" id="3904546">:</span>&nbsp;<span class="ident" id="3904548">config</span><span class="op" id="3904554">}</span><br>
<span class="lineno"></span><span class="op" id="3904556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3904559">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="3904610">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3904653">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3904718">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="3904755">func</span>&nbsp;<span class="ident" id="3904760">Client</span><span class="op" id="3904766">(</span><span class="ident" id="3904767">conn</span>&nbsp;<span class="ident" id="3904772">net</span><span class="op" id="3904775">.</span><span class="ident" id="3904776">Conn</span><span class="op" id="3904780">,</span>&nbsp;<span class="ident" id="3904782">config</span>&nbsp;<span class="op" id="3904789">*</span><span class="ident" id="3904790">Config</span><span class="op" id="3904796">)</span>&nbsp;<span class="op" id="3904798">*</span><span class="ident" id="3904799">Conn</span>&nbsp;<span class="op" id="3904804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3904807">return</span>&nbsp;<span class="op" id="3904814">&amp;</span><span class="ident" id="3904815">Conn</span><span class="op" id="3904819">{</span><span class="ident" id="3904820">conn</span><span class="op" id="3904824">:</span>&nbsp;<span class="ident" id="3904826">conn</span><span class="op" id="3904830">,</span>&nbsp;<span class="ident" id="3904832">config</span><span class="op" id="3904838">:</span>&nbsp;<span class="ident" id="3904840">config</span><span class="op" id="3904846">,</span>&nbsp;<span class="ident" id="3904848">isClient</span><span class="op" id="3904856">:</span>&nbsp;<span class="builtintype" id="3904858">true</span><span class="op" id="3904862">}</span><br>
<span class="lineno">35</span><span class="op" id="3904864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3904867">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3904947">type</span>&nbsp;<span class="ident" id="3904952">listener</span>&nbsp;<span class="keyword" id="3904961">struct</span>&nbsp;<span class="op" id="3904968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3904971">net</span><span class="op" id="3904974">.</span><span class="ident" id="3904975">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3904985">config</span>&nbsp;<span class="op" id="3904992">*</span><span class="ident" id="3904993">Config</span><br>
<span class="lineno"></span><span class="op" id="3905000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3905003">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3905069">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="3905114">func</span>&nbsp;<span class="op" id="3905119">(</span><span class="ident" id="3905120">l</span>&nbsp;<span class="op" id="3905122">*</span><span class="ident" id="3905123">listener</span><span class="op" id="3905131">)</span>&nbsp;<span class="ident" id="3905133">Accept</span><span class="op" id="3905139">(</span><span class="op" id="3905140">)</span>&nbsp;<span class="op" id="3905142">(</span><span class="ident" id="3905143">c</span>&nbsp;<span class="ident" id="3905145">net</span><span class="op" id="3905148">.</span><span class="ident" id="3905149">Conn</span><span class="op" id="3905153">,</span>&nbsp;<span class="ident" id="3905155">err</span>&nbsp;<span class="builtintype" id="3905159">error</span><span class="op" id="3905164">)</span>&nbsp;<span class="op" id="3905166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905169">c</span><span class="op" id="3905170">,</span>&nbsp;<span class="ident" id="3905172">err</span>&nbsp;<span class="op" id="3905176">=</span>&nbsp;<span class="ident" id="3905178">l</span><span class="op" id="3905179">.</span><span class="ident" id="3905180">Listener</span><span class="op" id="3905188">.</span><span class="ident" id="3905189">Accept</span><span class="op" id="3905195">(</span><span class="op" id="3905196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905199">if</span>&nbsp;<span class="ident" id="3905202">err</span>&nbsp;<span class="op" id="3905206">!=</span>&nbsp;<span class="ident" id="3905209">nil</span>&nbsp;<span class="op" id="3905213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905217">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3905225">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905228">c</span>&nbsp;<span class="op" id="3905230">=</span>&nbsp;<span class="ident" id="3905232">Server</span><span class="op" id="3905238">(</span><span class="ident" id="3905239">c</span><span class="op" id="3905240">,</span>&nbsp;<span class="ident" id="3905242">l</span><span class="op" id="3905243">.</span><span class="ident" id="3905244">config</span><span class="op" id="3905250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905253">return</span><br>
<span class="lineno"></span><span class="op" id="3905260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3905263">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="3905337">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="3905388">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3905446">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3905475">func</span>&nbsp;<span class="ident" id="3905480">NewListener</span><span class="op" id="3905491">(</span><span class="ident" id="3905492">inner</span>&nbsp;<span class="ident" id="3905498">net</span><span class="op" id="3905501">.</span><span class="ident" id="3905502">Listener</span><span class="op" id="3905510">,</span>&nbsp;<span class="ident" id="3905512">config</span>&nbsp;<span class="op" id="3905519">*</span><span class="ident" id="3905520">Config</span><span class="op" id="3905526">)</span>&nbsp;<span class="ident" id="3905528">net</span><span class="op" id="3905531">.</span><span class="ident" id="3905532">Listener</span>&nbsp;<span class="op" id="3905541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905544">l</span>&nbsp;<span class="op" id="3905546">:=</span>&nbsp;<span class="builtinfunc" id="3905549">new</span><span class="op" id="3905552">(</span><span class="ident" id="3905553">listener</span><span class="op" id="3905561">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905564">l</span><span class="op" id="3905565">.</span><span class="ident" id="3905566">Listener</span>&nbsp;<span class="op" id="3905575">=</span>&nbsp;<span class="ident" id="3905577">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905584">l</span><span class="op" id="3905585">.</span><span class="ident" id="3905586">config</span>&nbsp;<span class="op" id="3905593">=</span>&nbsp;<span class="ident" id="3905595">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905603">return</span>&nbsp;<span class="ident" id="3905610">l</span><br>
<span class="lineno"></span><span class="op" id="3905612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3905615">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3905677">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="3905720">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3905778">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3905807">func</span>&nbsp;<span class="ident" id="3905812">Listen</span><span class="op" id="3905818">(</span><span class="ident" id="3905819">network</span><span class="op" id="3905826">,</span>&nbsp;<span class="ident" id="3905828">laddr</span>&nbsp;<span class="builtintype" id="3905834">string</span><span class="op" id="3905840">,</span>&nbsp;<span class="ident" id="3905842">config</span>&nbsp;<span class="op" id="3905849">*</span><span class="ident" id="3905850">Config</span><span class="op" id="3905856">)</span>&nbsp;<span class="op" id="3905858">(</span><span class="ident" id="3905859">net</span><span class="op" id="3905862">.</span><span class="ident" id="3905863">Listener</span><span class="op" id="3905871">,</span>&nbsp;<span class="builtintype" id="3905873">error</span><span class="op" id="3905878">)</span>&nbsp;<span class="op" id="3905880">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905883">if</span>&nbsp;<span class="ident" id="3905886">config</span>&nbsp;<span class="op" id="3905893">==</span>&nbsp;<span class="ident" id="3905896">nil</span>&nbsp;<span class="op" id="3905900">||</span>&nbsp;<span class="builtinfunc" id="3905903">len</span><span class="op" id="3905906">(</span><span class="ident" id="3905907">config</span><span class="op" id="3905913">.</span><span class="ident" id="3905914">Certificates</span><span class="op" id="3905926">)</span>&nbsp;<span class="op" id="3905928">==</span>&nbsp;<span class="num" id="3905931">0</span>&nbsp;<span class="op" id="3905933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905937">return</span>&nbsp;<span class="ident" id="3905944">nil</span><span class="op" id="3905947">,</span>&nbsp;<span class="ident" id="3905949">errors</span><span class="op" id="3905955">.</span><span class="ident" id="3905956">New</span><span class="op" id="3905959">(</span><span class="string" id="3905960">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="3906006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906012">l</span><span class="op" id="3906013">,</span>&nbsp;<span class="ident" id="3906015">err</span>&nbsp;<span class="op" id="3906019">:=</span>&nbsp;<span class="ident" id="3906022">net</span><span class="op" id="3906025">.</span><span class="ident" id="3906026">Listen</span><span class="op" id="3906032">(</span><span class="ident" id="3906033">network</span><span class="op" id="3906040">,</span>&nbsp;<span class="ident" id="3906042">laddr</span><span class="op" id="3906047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906050">if</span>&nbsp;<span class="ident" id="3906053">err</span>&nbsp;<span class="op" id="3906057">!=</span>&nbsp;<span class="ident" id="3906060">nil</span>&nbsp;<span class="op" id="3906064">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906068">return</span>&nbsp;<span class="ident" id="3906075">nil</span><span class="op" id="3906078">,</span>&nbsp;<span class="ident" id="3906080">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906088">return</span>&nbsp;<span class="ident" id="3906095">NewListener</span><span class="op" id="3906106">(</span><span class="ident" id="3906107">l</span><span class="op" id="3906108">,</span>&nbsp;<span class="ident" id="3906110">config</span><span class="op" id="3906116">)</span><span class="op" id="3906117">,</span>&nbsp;<span class="ident" id="3906119">nil</span><br>
<span class="lineno"></span><span class="op" id="3906123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3906126">type</span>&nbsp;<span class="ident" id="3906131">timeoutError</span>&nbsp;<span class="keyword" id="3906144">struct</span><span class="op" id="3906150">{</span><span class="op" id="3906151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3906154">func</span>&nbsp;<span class="op" id="3906159">(</span><span class="ident" id="3906160">timeoutError</span><span class="op" id="3906172">)</span>&nbsp;<span class="ident" id="3906174">Error</span><span class="op" id="3906179">(</span><span class="op" id="3906180">)</span>&nbsp;<span class="builtintype" id="3906182">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3906191">{</span>&nbsp;<span class="keyword" id="3906193">return</span>&nbsp;<span class="string" id="3906200">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="3906232">}</span><br>
<span class="lineno"></span><span class="keyword" id="3906234">func</span>&nbsp;<span class="op" id="3906239">(</span><span class="ident" id="3906240">timeoutError</span><span class="op" id="3906252">)</span>&nbsp;<span class="ident" id="3906254">Timeout</span><span class="op" id="3906261">(</span><span class="op" id="3906262">)</span>&nbsp;<span class="builtintype" id="3906264">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3906271">{</span>&nbsp;<span class="keyword" id="3906273">return</span>&nbsp;<span class="builtintype" id="3906280">true</span>&nbsp;<span class="op" id="3906285">}</span><br>
<span class="lineno"></span><span class="keyword" id="3906287">func</span>&nbsp;<span class="op" id="3906292">(</span><span class="ident" id="3906293">timeoutError</span><span class="op" id="3906305">)</span>&nbsp;<span class="ident" id="3906307">Temporary</span><span class="op" id="3906316">(</span><span class="op" id="3906317">)</span>&nbsp;<span class="builtintype" id="3906319">bool</span>&nbsp;<span class="op" id="3906324">{</span>&nbsp;<span class="keyword" id="3906326">return</span>&nbsp;<span class="builtintype" id="3906333">true</span>&nbsp;<span class="op" id="3906338">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3906341">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3906419">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="3906498">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="3906569">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="3906594">//</span><br>
<span class="lineno"></span><span class="comment" id="3906597">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="3906672">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3906740">func</span>&nbsp;<span class="ident" id="3906745">DialWithDialer</span><span class="op" id="3906759">(</span><span class="ident" id="3906760">dialer</span>&nbsp;<span class="op" id="3906767">*</span><span class="ident" id="3906768">net</span><span class="op" id="3906771">.</span><span class="ident" id="3906772">Dialer</span><span class="op" id="3906778">,</span>&nbsp;<span class="ident" id="3906780">network</span><span class="op" id="3906787">,</span>&nbsp;<span class="ident" id="3906789">addr</span>&nbsp;<span class="builtintype" id="3906794">string</span><span class="op" id="3906800">,</span>&nbsp;<span class="ident" id="3906802">config</span>&nbsp;<span class="op" id="3906809">*</span><span class="ident" id="3906810">Config</span><span class="op" id="3906816">)</span>&nbsp;<span class="op" id="3906818">(</span><span class="op" id="3906819">*</span><span class="ident" id="3906820">Conn</span><span class="op" id="3906824">,</span>&nbsp;<span class="builtintype" id="3906826">error</span><span class="op" id="3906831">)</span>&nbsp;<span class="op" id="3906833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906836">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906905">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906977">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907020">timeout</span>&nbsp;<span class="op" id="3907028">:=</span>&nbsp;<span class="ident" id="3907031">dialer</span><span class="op" id="3907037">.</span><span class="ident" id="3907038">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907048">if</span>&nbsp;<span class="op" id="3907051">!</span><span class="ident" id="3907052">dialer</span><span class="op" id="3907058">.</span><span class="ident" id="3907059">Deadline</span><span class="op" id="3907067">.</span><span class="ident" id="3907068">IsZero</span><span class="op" id="3907074">(</span><span class="op" id="3907075">)</span>&nbsp;<span class="op" id="3907077">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907081">deadlineTimeout</span>&nbsp;<span class="op" id="3907097">:=</span>&nbsp;<span class="ident" id="3907100">dialer</span><span class="op" id="3907106">.</span><span class="ident" id="3907107">Deadline</span><span class="op" id="3907115">.</span><span class="ident" id="3907116">Sub</span><span class="op" id="3907119">(</span><span class="ident" id="3907120">time</span><span class="op" id="3907124">.</span><span class="ident" id="3907125">Now</span><span class="op" id="3907128">(</span><span class="op" id="3907129">)</span><span class="op" id="3907130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907134">if</span>&nbsp;<span class="ident" id="3907137">timeout</span>&nbsp;<span class="op" id="3907145">==</span>&nbsp;<span class="num" id="3907148">0</span>&nbsp;<span class="op" id="3907150">||</span>&nbsp;<span class="ident" id="3907153">deadlineTimeout</span>&nbsp;<span class="op" id="3907169">&lt;</span>&nbsp;<span class="ident" id="3907171">timeout</span>&nbsp;<span class="op" id="3907179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907184">timeout</span>&nbsp;<span class="op" id="3907192">=</span>&nbsp;<span class="ident" id="3907194">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907215">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907219">var</span>&nbsp;<span class="ident" id="3907223">errChannel</span>&nbsp;<span class="keyword" id="3907234">chan</span>&nbsp;<span class="builtintype" id="3907239">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907247">if</span>&nbsp;<span class="ident" id="3907250">timeout</span>&nbsp;<span class="op" id="3907258">!=</span>&nbsp;<span class="num" id="3907261">0</span>&nbsp;<span class="op" id="3907263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907267">errChannel</span>&nbsp;<span class="op" id="3907278">=</span>&nbsp;<span class="builtinfunc" id="3907280">make</span><span class="op" id="3907284">(</span><span class="keyword" id="3907285">chan</span>&nbsp;<span class="builtintype" id="3907290">error</span><span class="op" id="3907295">,</span>&nbsp;<span class="num" id="3907297">2</span><span class="op" id="3907298">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907302">time</span><span class="op" id="3907306">.</span><span class="ident" id="3907307">AfterFunc</span><span class="op" id="3907316">(</span><span class="ident" id="3907317">timeout</span><span class="op" id="3907324">,</span>&nbsp;<span class="keyword" id="3907326">func</span><span class="op" id="3907330">(</span><span class="op" id="3907331">)</span>&nbsp;<span class="op" id="3907333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907338">errChannel</span>&nbsp;<span class="op" id="3907349">&lt;-</span>&nbsp;<span class="ident" id="3907352">timeoutError</span><span class="op" id="3907364">{</span><span class="op" id="3907365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907369">}</span><span class="op" id="3907370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907377">rawConn</span><span class="op" id="3907384">,</span>&nbsp;<span class="ident" id="3907386">err</span>&nbsp;<span class="op" id="3907390">:=</span>&nbsp;<span class="ident" id="3907393">dialer</span><span class="op" id="3907399">.</span><span class="ident" id="3907400">Dial</span><span class="op" id="3907404">(</span><span class="ident" id="3907405">network</span><span class="op" id="3907412">,</span>&nbsp;<span class="ident" id="3907414">addr</span><span class="op" id="3907418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907421">if</span>&nbsp;<span class="ident" id="3907424">err</span>&nbsp;<span class="op" id="3907428">!=</span>&nbsp;<span class="ident" id="3907431">nil</span>&nbsp;<span class="op" id="3907435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907439">return</span>&nbsp;<span class="ident" id="3907446">nil</span><span class="op" id="3907449">,</span>&nbsp;<span class="ident" id="3907451">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907460">colonPos</span>&nbsp;<span class="op" id="3907469">:=</span>&nbsp;<span class="ident" id="3907472">strings</span><span class="op" id="3907479">.</span><span class="ident" id="3907480">LastIndex</span><span class="op" id="3907489">(</span><span class="ident" id="3907490">addr</span><span class="op" id="3907494">,</span>&nbsp;<span class="string" id="3907496">&#34;:&#34;</span><span class="op" id="3907499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907502">if</span>&nbsp;<span class="ident" id="3907505">colonPos</span>&nbsp;<span class="op" id="3907514">==</span>&nbsp;<span class="op" id="3907517">-</span><span class="num" id="3907518">1</span>&nbsp;<span class="op" id="3907520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907524">colonPos</span>&nbsp;<span class="op" id="3907533">=</span>&nbsp;<span class="builtinfunc" id="3907535">len</span><span class="op" id="3907538">(</span><span class="ident" id="3907539">addr</span><span class="op" id="3907543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907549">hostname</span>&nbsp;<span class="op" id="3907558">:=</span>&nbsp;<span class="ident" id="3907561">addr</span><span class="op" id="3907565">[</span><span class="op" id="3907566">:</span><span class="ident" id="3907567">colonPos</span><span class="op" id="3907575">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907579">if</span>&nbsp;<span class="ident" id="3907582">config</span>&nbsp;<span class="op" id="3907589">==</span>&nbsp;<span class="ident" id="3907592">nil</span>&nbsp;<span class="op" id="3907596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907600">config</span>&nbsp;<span class="op" id="3907607">=</span>&nbsp;<span class="ident" id="3907609">defaultConfig</span><span class="op" id="3907622">(</span><span class="op" id="3907623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907629">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907679">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907722">if</span>&nbsp;<span class="ident" id="3907725">config</span><span class="op" id="3907731">.</span><span class="ident" id="3907732">ServerName</span>&nbsp;<span class="op" id="3907743">==</span>&nbsp;<span class="string" id="3907746">&#34;&#34;</span>&nbsp;<span class="op" id="3907749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907753">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907810">c</span>&nbsp;<span class="op" id="3907812">:=</span>&nbsp;<span class="op" id="3907815">*</span><span class="ident" id="3907816">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907825">c</span><span class="op" id="3907826">.</span><span class="ident" id="3907827">ServerName</span>&nbsp;<span class="op" id="3907838">=</span>&nbsp;<span class="ident" id="3907840">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907851">config</span>&nbsp;<span class="op" id="3907858">=</span>&nbsp;<span class="op" id="3907860">&amp;</span><span class="ident" id="3907861">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907868">conn</span>&nbsp;<span class="op" id="3907873">:=</span>&nbsp;<span class="ident" id="3907876">Client</span><span class="op" id="3907882">(</span><span class="ident" id="3907883">rawConn</span><span class="op" id="3907890">,</span>&nbsp;<span class="ident" id="3907892">config</span><span class="op" id="3907898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907902">if</span>&nbsp;<span class="ident" id="3907905">timeout</span>&nbsp;<span class="op" id="3907913">==</span>&nbsp;<span class="num" id="3907916">0</span>&nbsp;<span class="op" id="3907918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907922">err</span>&nbsp;<span class="op" id="3907926">=</span>&nbsp;<span class="ident" id="3907928">conn</span><span class="op" id="3907932">.</span><span class="ident" id="3907933">Handshake</span><span class="op" id="3907942">(</span><span class="op" id="3907943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907946">}</span>&nbsp;<span class="keyword" id="3907948">else</span>&nbsp;<span class="op" id="3907953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907957">go</span>&nbsp;<span class="keyword" id="3907960">func</span><span class="op" id="3907964">(</span><span class="op" id="3907965">)</span>&nbsp;<span class="op" id="3907967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907972">errChannel</span>&nbsp;<span class="op" id="3907983">&lt;-</span>&nbsp;<span class="ident" id="3907986">conn</span><span class="op" id="3907990">.</span><span class="ident" id="3907991">Handshake</span><span class="op" id="3908000">(</span><span class="op" id="3908001">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908005">}</span><span class="op" id="3908006">(</span><span class="op" id="3908007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908012">err</span>&nbsp;<span class="op" id="3908016">=</span>&nbsp;<span class="op" id="3908018">&lt;-</span><span class="ident" id="3908020">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908036">if</span>&nbsp;<span class="ident" id="3908039">err</span>&nbsp;<span class="op" id="3908043">!=</span>&nbsp;<span class="ident" id="3908046">nil</span>&nbsp;<span class="op" id="3908050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908054">rawConn</span><span class="op" id="3908061">.</span><span class="ident" id="3908062">Close</span><span class="op" id="3908067">(</span><span class="op" id="3908068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908072">return</span>&nbsp;<span class="ident" id="3908079">nil</span><span class="op" id="3908082">,</span>&nbsp;<span class="ident" id="3908084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908093">return</span>&nbsp;<span class="ident" id="3908100">conn</span><span class="op" id="3908104">,</span>&nbsp;<span class="ident" id="3908106">nil</span><br>
<span class="lineno"></span><span class="op" id="3908110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3908113">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="3908174">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="3908237">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3908256">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3908312">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="3908371">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3908392">func</span>&nbsp;<span class="ident" id="3908397">Dial</span><span class="op" id="3908401">(</span><span class="ident" id="3908402">network</span><span class="op" id="3908409">,</span>&nbsp;<span class="ident" id="3908411">addr</span>&nbsp;<span class="builtintype" id="3908416">string</span><span class="op" id="3908422">,</span>&nbsp;<span class="ident" id="3908424">config</span>&nbsp;<span class="op" id="3908431">*</span><span class="ident" id="3908432">Config</span><span class="op" id="3908438">)</span>&nbsp;<span class="op" id="3908440">(</span><span class="op" id="3908441">*</span><span class="ident" id="3908442">Conn</span><span class="op" id="3908446">,</span>&nbsp;<span class="builtintype" id="3908448">error</span><span class="op" id="3908453">)</span>&nbsp;<span class="op" id="3908455">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908458">return</span>&nbsp;<span class="ident" id="3908465">DialWithDialer</span><span class="op" id="3908479">(</span><span class="builtinfunc" id="3908480">new</span><span class="op" id="3908483">(</span><span class="ident" id="3908484">net</span><span class="op" id="3908487">.</span><span class="ident" id="3908488">Dialer</span><span class="op" id="3908494">)</span><span class="op" id="3908495">,</span>&nbsp;<span class="ident" id="3908497">network</span><span class="op" id="3908504">,</span>&nbsp;<span class="ident" id="3908506">addr</span><span class="op" id="3908510">,</span>&nbsp;<span class="ident" id="3908512">config</span><span class="op" id="3908518">)</span><br>
<span class="lineno"></span><span class="op" id="3908520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3908523">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3908600">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="3908651">func</span>&nbsp;<span class="ident" id="3908656">LoadX509KeyPair</span><span class="op" id="3908671">(</span><span class="ident" id="3908672">certFile</span><span class="op" id="3908680">,</span>&nbsp;<span class="ident" id="3908682">keyFile</span>&nbsp;<span class="builtintype" id="3908690">string</span><span class="op" id="3908696">)</span>&nbsp;<span class="op" id="3908698">(</span><span class="ident" id="3908699">cert</span>&nbsp;<span class="ident" id="3908704">Certificate</span><span class="op" id="3908715">,</span>&nbsp;<span class="ident" id="3908717">err</span>&nbsp;<span class="builtintype" id="3908721">error</span><span class="op" id="3908726">)</span>&nbsp;<span class="op" id="3908728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908731">certPEMBlock</span><span class="op" id="3908743">,</span>&nbsp;<span class="ident" id="3908745">err</span>&nbsp;<span class="op" id="3908749">:=</span>&nbsp;<span class="ident" id="3908752">ioutil</span><span class="op" id="3908758">.</span><span class="ident" id="3908759">ReadFile</span><span class="op" id="3908767">(</span><span class="ident" id="3908768">certFile</span><span class="op" id="3908776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908779">if</span>&nbsp;<span class="ident" id="3908782">err</span>&nbsp;<span class="op" id="3908786">!=</span>&nbsp;<span class="ident" id="3908789">nil</span>&nbsp;<span class="op" id="3908793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908797">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908805">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908808">keyPEMBlock</span><span class="op" id="3908819">,</span>&nbsp;<span class="ident" id="3908821">err</span>&nbsp;<span class="op" id="3908825">:=</span>&nbsp;<span class="ident" id="3908828">ioutil</span><span class="op" id="3908834">.</span><span class="ident" id="3908835">ReadFile</span><span class="op" id="3908843">(</span><span class="ident" id="3908844">keyFile</span><span class="op" id="3908851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908854">if</span>&nbsp;<span class="ident" id="3908857">err</span>&nbsp;<span class="op" id="3908861">!=</span>&nbsp;<span class="ident" id="3908864">nil</span>&nbsp;<span class="op" id="3908868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908872">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908883">return</span>&nbsp;<span class="ident" id="3908890">X509KeyPair</span><span class="op" id="3908901">(</span><span class="ident" id="3908902">certPEMBlock</span><span class="op" id="3908914">,</span>&nbsp;<span class="ident" id="3908916">keyPEMBlock</span><span class="op" id="3908927">)</span><br>
<span class="lineno">180</span><span class="op" id="3908929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3908932">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3908995">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3909016">func</span>&nbsp;<span class="ident" id="3909021">X509KeyPair</span><span class="op" id="3909032">(</span><span class="ident" id="3909033">certPEMBlock</span><span class="op" id="3909045">,</span>&nbsp;<span class="ident" id="3909047">keyPEMBlock</span>&nbsp;<span class="op" id="3909059">[</span><span class="op" id="3909060">]</span><span class="builtintype" id="3909061">byte</span><span class="op" id="3909065">)</span>&nbsp;<span class="op" id="3909067">(</span><span class="ident" id="3909068">cert</span>&nbsp;<span class="ident" id="3909073">Certificate</span><span class="op" id="3909084">,</span>&nbsp;<span class="ident" id="3909086">err</span>&nbsp;<span class="builtintype" id="3909090">error</span><span class="op" id="3909095">)</span>&nbsp;<span class="op" id="3909097">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909100">var</span>&nbsp;<span class="ident" id="3909104">certDERBlock</span>&nbsp;<span class="op" id="3909117">*</span><span class="ident" id="3909118">pem</span><span class="op" id="3909121">.</span><span class="ident" id="3909122">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909129">for</span>&nbsp;<span class="op" id="3909133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909137">certDERBlock</span><span class="op" id="3909149">,</span>&nbsp;<span class="ident" id="3909151">certPEMBlock</span>&nbsp;<span class="op" id="3909164">=</span>&nbsp;<span class="ident" id="3909166">pem</span><span class="op" id="3909169">.</span><span class="ident" id="3909170">Decode</span><span class="op" id="3909176">(</span><span class="ident" id="3909177">certPEMBlock</span><span class="op" id="3909189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909193">if</span>&nbsp;<span class="ident" id="3909196">certDERBlock</span>&nbsp;<span class="op" id="3909209">==</span>&nbsp;<span class="ident" id="3909212">nil</span>&nbsp;<span class="op" id="3909216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909221">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909233">if</span>&nbsp;<span class="ident" id="3909236">certDERBlock</span><span class="op" id="3909248">.</span><span class="ident" id="3909249">Type</span>&nbsp;<span class="op" id="3909254">==</span>&nbsp;<span class="string" id="3909257">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="3909271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909276">cert</span><span class="op" id="3909280">.</span><span class="ident" id="3909281">Certificate</span>&nbsp;<span class="op" id="3909293">=</span>&nbsp;<span class="builtinfunc" id="3909295">append</span><span class="op" id="3909301">(</span><span class="ident" id="3909302">cert</span><span class="op" id="3909306">.</span><span class="ident" id="3909307">Certificate</span><span class="op" id="3909318">,</span>&nbsp;<span class="ident" id="3909320">certDERBlock</span><span class="op" id="3909332">.</span><span class="ident" id="3909333">Bytes</span><span class="op" id="3909338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909345">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909349">if</span>&nbsp;<span class="builtinfunc" id="3909352">len</span><span class="op" id="3909355">(</span><span class="ident" id="3909356">cert</span><span class="op" id="3909360">.</span><span class="ident" id="3909361">Certificate</span><span class="op" id="3909372">)</span>&nbsp;<span class="op" id="3909374">==</span>&nbsp;<span class="num" id="3909377">0</span>&nbsp;<span class="op" id="3909379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909383">err</span>&nbsp;<span class="op" id="3909387">=</span>&nbsp;<span class="ident" id="3909389">errors</span><span class="op" id="3909395">.</span><span class="ident" id="3909396">New</span><span class="op" id="3909399">(</span><span class="string" id="3909400">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3909450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909454">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909462">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909466">var</span>&nbsp;<span class="ident" id="3909470">keyDERBlock</span>&nbsp;<span class="op" id="3909482">*</span><span class="ident" id="3909483">pem</span><span class="op" id="3909486">.</span><span class="ident" id="3909487">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909494">for</span>&nbsp;<span class="op" id="3909498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909502">keyDERBlock</span><span class="op" id="3909513">,</span>&nbsp;<span class="ident" id="3909515">keyPEMBlock</span>&nbsp;<span class="op" id="3909527">=</span>&nbsp;<span class="ident" id="3909529">pem</span><span class="op" id="3909532">.</span><span class="ident" id="3909533">Decode</span><span class="op" id="3909539">(</span><span class="ident" id="3909540">keyPEMBlock</span><span class="op" id="3909551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909555">if</span>&nbsp;<span class="ident" id="3909558">keyDERBlock</span>&nbsp;<span class="op" id="3909570">==</span>&nbsp;<span class="ident" id="3909573">nil</span>&nbsp;<span class="op" id="3909577">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909582">err</span>&nbsp;<span class="op" id="3909586">=</span>&nbsp;<span class="ident" id="3909588">errors</span><span class="op" id="3909594">.</span><span class="ident" id="3909595">New</span><span class="op" id="3909598">(</span><span class="string" id="3909599">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3909641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909646">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909659">if</span>&nbsp;<span class="ident" id="3909662">keyDERBlock</span><span class="op" id="3909673">.</span><span class="ident" id="3909674">Type</span>&nbsp;<span class="op" id="3909679">==</span>&nbsp;<span class="string" id="3909682">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="3909696">||</span>&nbsp;<span class="ident" id="3909699">strings</span><span class="op" id="3909706">.</span><span class="ident" id="3909707">HasSuffix</span><span class="op" id="3909716">(</span><span class="ident" id="3909717">keyDERBlock</span><span class="op" id="3909728">.</span><span class="ident" id="3909729">Type</span><span class="op" id="3909733">,</span>&nbsp;<span class="string" id="3909735">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="3909749">)</span>&nbsp;<span class="op" id="3909751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909756">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909771">cert</span><span class="op" id="3909775">.</span><span class="ident" id="3909776">PrivateKey</span><span class="op" id="3909786">,</span>&nbsp;<span class="ident" id="3909788">err</span>&nbsp;<span class="op" id="3909792">=</span>&nbsp;<span class="ident" id="3909794">parsePrivateKey</span><span class="op" id="3909809">(</span><span class="ident" id="3909810">keyDERBlock</span><span class="op" id="3909821">.</span><span class="ident" id="3909822">Bytes</span><span class="op" id="3909827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909830">if</span>&nbsp;<span class="ident" id="3909833">err</span>&nbsp;<span class="op" id="3909837">!=</span>&nbsp;<span class="ident" id="3909840">nil</span>&nbsp;<span class="op" id="3909844">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909848">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909860">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909931">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909992">x509Cert</span><span class="op" id="3910000">,</span>&nbsp;<span class="ident" id="3910002">err</span>&nbsp;<span class="op" id="3910006">:=</span>&nbsp;<span class="ident" id="3910009">x509</span><span class="op" id="3910013">.</span><span class="ident" id="3910014">ParseCertificate</span><span class="op" id="3910030">(</span><span class="ident" id="3910031">cert</span><span class="op" id="3910035">.</span><span class="ident" id="3910036">Certificate</span><span class="op" id="3910047">[</span><span class="num" id="3910048">0</span><span class="op" id="3910049">]</span><span class="op" id="3910050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910053">if</span>&nbsp;<span class="ident" id="3910056">err</span>&nbsp;<span class="op" id="3910060">!=</span>&nbsp;<span class="ident" id="3910063">nil</span>&nbsp;<span class="op" id="3910067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910083">switch</span>&nbsp;<span class="ident" id="3910090">pub</span>&nbsp;<span class="op" id="3910094">:=</span>&nbsp;<span class="ident" id="3910097">x509Cert</span><span class="op" id="3910105">.</span><span class="ident" id="3910106">PublicKey</span><span class="op" id="3910115">.</span><span class="op" id="3910116">(</span><span class="keyword" id="3910117">type</span><span class="op" id="3910121">)</span>&nbsp;<span class="op" id="3910123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910126">case</span>&nbsp;<span class="op" id="3910131">*</span><span class="ident" id="3910132">rsa</span><span class="op" id="3910135">.</span><span class="ident" id="3910136">PublicKey</span><span class="op" id="3910145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910149">priv</span><span class="op" id="3910153">,</span>&nbsp;<span class="ident" id="3910155">ok</span>&nbsp;<span class="op" id="3910158">:=</span>&nbsp;<span class="ident" id="3910161">cert</span><span class="op" id="3910165">.</span><span class="ident" id="3910166">PrivateKey</span><span class="op" id="3910176">.</span><span class="op" id="3910177">(</span><span class="op" id="3910178">*</span><span class="ident" id="3910179">rsa</span><span class="op" id="3910182">.</span><span class="ident" id="3910183">PrivateKey</span><span class="op" id="3910193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910197">if</span>&nbsp;<span class="op" id="3910200">!</span><span class="ident" id="3910201">ok</span>&nbsp;<span class="op" id="3910204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910209">err</span>&nbsp;<span class="op" id="3910213">=</span>&nbsp;<span class="ident" id="3910215">errors</span><span class="op" id="3910221">.</span><span class="ident" id="3910222">New</span><span class="op" id="3910225">(</span><span class="string" id="3910226">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3910287">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910292">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910305">if</span>&nbsp;<span class="ident" id="3910308">pub</span><span class="op" id="3910311">.</span><span class="ident" id="3910312">N</span><span class="op" id="3910313">.</span><span class="ident" id="3910314">Cmp</span><span class="op" id="3910317">(</span><span class="ident" id="3910318">priv</span><span class="op" id="3910322">.</span><span class="ident" id="3910323">N</span><span class="op" id="3910324">)</span>&nbsp;<span class="op" id="3910326">!=</span>&nbsp;<span class="num" id="3910329">0</span>&nbsp;<span class="op" id="3910331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910336">err</span>&nbsp;<span class="op" id="3910340">=</span>&nbsp;<span class="ident" id="3910342">errors</span><span class="op" id="3910348">.</span><span class="ident" id="3910349">New</span><span class="op" id="3910352">(</span><span class="string" id="3910353">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3910404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910409">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910421">case</span>&nbsp;<span class="op" id="3910426">*</span><span class="ident" id="3910427">ecdsa</span><span class="op" id="3910432">.</span><span class="ident" id="3910433">PublicKey</span><span class="op" id="3910442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910446">priv</span><span class="op" id="3910450">,</span>&nbsp;<span class="ident" id="3910452">ok</span>&nbsp;<span class="op" id="3910455">:=</span>&nbsp;<span class="ident" id="3910458">cert</span><span class="op" id="3910462">.</span><span class="ident" id="3910463">PrivateKey</span><span class="op" id="3910473">.</span><span class="op" id="3910474">(</span><span class="op" id="3910475">*</span><span class="ident" id="3910476">ecdsa</span><span class="op" id="3910481">.</span><span class="ident" id="3910482">PrivateKey</span><span class="op" id="3910492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910496">if</span>&nbsp;<span class="op" id="3910499">!</span><span class="ident" id="3910500">ok</span>&nbsp;<span class="op" id="3910503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910508">err</span>&nbsp;<span class="op" id="3910512">=</span>&nbsp;<span class="ident" id="3910514">errors</span><span class="op" id="3910520">.</span><span class="ident" id="3910521">New</span><span class="op" id="3910524">(</span><span class="string" id="3910525">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3910586">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910591">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910605">if</span>&nbsp;<span class="ident" id="3910608">pub</span><span class="op" id="3910611">.</span><span class="ident" id="3910612">X</span><span class="op" id="3910613">.</span><span class="ident" id="3910614">Cmp</span><span class="op" id="3910617">(</span><span class="ident" id="3910618">priv</span><span class="op" id="3910622">.</span><span class="ident" id="3910623">X</span><span class="op" id="3910624">)</span>&nbsp;<span class="op" id="3910626">!=</span>&nbsp;<span class="num" id="3910629">0</span>&nbsp;<span class="op" id="3910631">||</span>&nbsp;<span class="ident" id="3910634">pub</span><span class="op" id="3910637">.</span><span class="ident" id="3910638">Y</span><span class="op" id="3910639">.</span><span class="ident" id="3910640">Cmp</span><span class="op" id="3910643">(</span><span class="ident" id="3910644">priv</span><span class="op" id="3910648">.</span><span class="ident" id="3910649">Y</span><span class="op" id="3910650">)</span>&nbsp;<span class="op" id="3910652">!=</span>&nbsp;<span class="num" id="3910655">0</span>&nbsp;<span class="op" id="3910657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910662">err</span>&nbsp;<span class="op" id="3910666">=</span>&nbsp;<span class="ident" id="3910668">errors</span><span class="op" id="3910674">.</span><span class="ident" id="3910675">New</span><span class="op" id="3910678">(</span><span class="string" id="3910679">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3910730">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910735">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910747">default</span><span class="op" id="3910754">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910758">err</span>&nbsp;<span class="op" id="3910762">=</span>&nbsp;<span class="ident" id="3910764">errors</span><span class="op" id="3910770">.</span><span class="ident" id="3910771">New</span><span class="op" id="3910774">(</span><span class="string" id="3910775">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="3910817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910821">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910833">return</span><br>
<span class="lineno"></span><span class="op" id="3910840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="3910843">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="3910920">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3910998">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="3911077">func</span>&nbsp;<span class="ident" id="3911082">parsePrivateKey</span><span class="op" id="3911097">(</span><span class="ident" id="3911098">der</span>&nbsp;<span class="op" id="3911102">[</span><span class="op" id="3911103">]</span><span class="builtintype" id="3911104">byte</span><span class="op" id="3911108">)</span>&nbsp;<span class="op" id="3911110">(</span><span class="ident" id="3911111">crypto</span><span class="op" id="3911117">.</span><span class="ident" id="3911118">PrivateKey</span><span class="op" id="3911128">,</span>&nbsp;<span class="builtintype" id="3911130">error</span><span class="op" id="3911135">)</span>&nbsp;<span class="op" id="3911137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911140">if</span>&nbsp;<span class="ident" id="3911143">key</span><span class="op" id="3911146">,</span>&nbsp;<span class="ident" id="3911148">err</span>&nbsp;<span class="op" id="3911152">:=</span>&nbsp;<span class="ident" id="3911155">x509</span><span class="op" id="3911159">.</span><span class="ident" id="3911160">ParsePKCS1PrivateKey</span><span class="op" id="3911180">(</span><span class="ident" id="3911181">der</span><span class="op" id="3911184">)</span><span class="op" id="3911185">;</span>&nbsp;<span class="ident" id="3911187">err</span>&nbsp;<span class="op" id="3911191">==</span>&nbsp;<span class="ident" id="3911194">nil</span>&nbsp;<span class="op" id="3911198">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911202">return</span>&nbsp;<span class="ident" id="3911209">key</span><span class="op" id="3911212">,</span>&nbsp;<span class="ident" id="3911214">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911222">if</span>&nbsp;<span class="ident" id="3911225">key</span><span class="op" id="3911228">,</span>&nbsp;<span class="ident" id="3911230">err</span>&nbsp;<span class="op" id="3911234">:=</span>&nbsp;<span class="ident" id="3911237">x509</span><span class="op" id="3911241">.</span><span class="ident" id="3911242">ParsePKCS8PrivateKey</span><span class="op" id="3911262">(</span><span class="ident" id="3911263">der</span><span class="op" id="3911266">)</span><span class="op" id="3911267">;</span>&nbsp;<span class="ident" id="3911269">err</span>&nbsp;<span class="op" id="3911273">==</span>&nbsp;<span class="ident" id="3911276">nil</span>&nbsp;<span class="op" id="3911280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911284">switch</span>&nbsp;<span class="ident" id="3911291">key</span>&nbsp;<span class="op" id="3911295">:=</span>&nbsp;<span class="ident" id="3911298">key</span><span class="op" id="3911301">.</span><span class="op" id="3911302">(</span><span class="keyword" id="3911303">type</span><span class="op" id="3911307">)</span>&nbsp;<span class="op" id="3911309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911313">case</span>&nbsp;<span class="op" id="3911318">*</span><span class="ident" id="3911319">rsa</span><span class="op" id="3911322">.</span><span class="ident" id="3911323">PrivateKey</span><span class="op" id="3911333">,</span>&nbsp;<span class="op" id="3911335">*</span><span class="ident" id="3911336">ecdsa</span><span class="op" id="3911341">.</span><span class="ident" id="3911342">PrivateKey</span><span class="op" id="3911352">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911357">return</span>&nbsp;<span class="ident" id="3911364">key</span><span class="op" id="3911367">,</span>&nbsp;<span class="ident" id="3911369">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911375">default</span><span class="op" id="3911382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911387">return</span>&nbsp;<span class="ident" id="3911394">nil</span><span class="op" id="3911397">,</span>&nbsp;<span class="ident" id="3911399">errors</span><span class="op" id="3911405">.</span><span class="ident" id="3911406">New</span><span class="op" id="3911409">(</span><span class="string" id="3911410">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="3911473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911480">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911483">if</span>&nbsp;<span class="ident" id="3911486">key</span><span class="op" id="3911489">,</span>&nbsp;<span class="ident" id="3911491">err</span>&nbsp;<span class="op" id="3911495">:=</span>&nbsp;<span class="ident" id="3911498">x509</span><span class="op" id="3911502">.</span><span class="ident" id="3911503">ParseECPrivateKey</span><span class="op" id="3911520">(</span><span class="ident" id="3911521">der</span><span class="op" id="3911524">)</span><span class="op" id="3911525">;</span>&nbsp;<span class="ident" id="3911527">err</span>&nbsp;<span class="op" id="3911531">==</span>&nbsp;<span class="ident" id="3911534">nil</span>&nbsp;<span class="op" id="3911538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911542">return</span>&nbsp;<span class="ident" id="3911549">key</span><span class="op" id="3911552">,</span>&nbsp;<span class="ident" id="3911554">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911563">return</span>&nbsp;<span class="ident" id="3911570">nil</span><span class="op" id="3911573">,</span>&nbsp;<span class="ident" id="3911575">errors</span><span class="op" id="3911581">.</span><span class="ident" id="3911582">New</span><span class="op" id="3911585">(</span><span class="string" id="3911586">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="3911627">)</span><br>
<span class="lineno">275</span><span class="op" id="3911629">}</span>
</div>
</body>
</html>
