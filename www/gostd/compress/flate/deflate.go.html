<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4251571">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4251626">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4251680">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4251731">package</span>&nbsp;<span class="ident" id="4251739">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4251746">import</span>&nbsp;<span class="op" id="4251753">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4251756">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4251763">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4251769">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4251776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4251779">const</span>&nbsp;<span class="op" id="4251785">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251788">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251807">=</span>&nbsp;<span class="num" id="4251809">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251812">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251831">=</span>&nbsp;<span class="num" id="4251833">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251836">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251855">=</span>&nbsp;<span class="num" id="4251857">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251860">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251879">=</span>&nbsp;<span class="num" id="4251881">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251884">DefaultCompression</span>&nbsp;<span class="op" id="4251903">=</span>&nbsp;<span class="op" id="4251905">-</span><span class="num" id="4251906">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251909">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251928">=</span>&nbsp;<span class="num" id="4251930">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251934">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251953">=</span>&nbsp;<span class="num" id="4251955">1</span>&nbsp;<span class="op" id="4251957">&lt;&lt;</span>&nbsp;<span class="ident" id="4251960">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4251975">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251994">=</span>&nbsp;<span class="ident" id="4251996">windowSize</span>&nbsp;<span class="op" id="4252007">-</span>&nbsp;<span class="num" id="4252009">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252012">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4252031">=</span>&nbsp;<span class="num" id="4252033">15</span>&nbsp;&nbsp;<span class="comment" id="4252037">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252058">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252077">=</span>&nbsp;<span class="num" id="4252079">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4252083">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252136">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252155">=</span>&nbsp;<span class="num" id="4252157">258</span>&nbsp;<span class="comment" id="4252161">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252202">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252221">=</span>&nbsp;<span class="num" id="4252223">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4252227">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4252273">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4252348">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252388">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4252408">=</span>&nbsp;<span class="num" id="4252410">1</span>&nbsp;<span class="op" id="4252412">&lt;&lt;</span>&nbsp;<span class="num" id="4252415">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252419">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4252439">=</span>&nbsp;<span class="num" id="4252441">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252448">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252468">=</span>&nbsp;<span class="num" id="4252470">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252474">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252494">=</span>&nbsp;<span class="num" id="4252496">1</span>&nbsp;<span class="op" id="4252498">&lt;&lt;</span>&nbsp;<span class="ident" id="4252501">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252511">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252531">=</span>&nbsp;<span class="op" id="4252533">(</span><span class="num" id="4252534">1</span>&nbsp;<span class="op" id="4252536">&lt;&lt;</span>&nbsp;<span class="ident" id="4252539">hashBits</span><span class="op" id="4252547">)</span>&nbsp;<span class="op" id="4252549">-</span>&nbsp;<span class="num" id="4252551">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252554">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252574">=</span>&nbsp;<span class="op" id="4252576">(</span><span class="ident" id="4252577">hashBits</span>&nbsp;<span class="op" id="4252586">+</span>&nbsp;<span class="ident" id="4252588">minMatchLength</span>&nbsp;<span class="op" id="4252603">-</span>&nbsp;<span class="num" id="4252605">1</span><span class="op" id="4252606">)</span>&nbsp;<span class="op" id="4252608">/</span>&nbsp;<span class="ident" id="4252610">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252626">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252646">=</span>&nbsp;<span class="num" id="4252648">1</span>&nbsp;<span class="op" id="4252650">&lt;&lt;</span>&nbsp;<span class="num" id="4252653">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252658">skipNever</span>&nbsp;<span class="op" id="4252668">=</span>&nbsp;<span class="ident" id="4252670">math</span><span class="op" id="4252674">.</span><span class="ident" id="4252675">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4252684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4252687">type</span>&nbsp;<span class="ident" id="4252692">compressionLevel</span>&nbsp;<span class="keyword" id="4252709">struct</span>&nbsp;<span class="op" id="4252716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4252719">good</span><span class="op" id="4252723">,</span>&nbsp;<span class="ident" id="4252725">lazy</span><span class="op" id="4252729">,</span>&nbsp;<span class="ident" id="4252731">nice</span><span class="op" id="4252735">,</span>&nbsp;<span class="ident" id="4252737">chain</span><span class="op" id="4252742">,</span>&nbsp;<span class="ident" id="4252744">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4252760">int</span><br>
<span class="lineno"></span><span class="op" id="4252764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4252767">var</span>&nbsp;<span class="ident" id="4252771">levels</span>&nbsp;<span class="op" id="4252778">=</span>&nbsp;<span class="op" id="4252780">[</span><span class="op" id="4252781">]</span><span class="ident" id="4252782">compressionLevel</span><span class="op" id="4252798">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252801">{</span><span class="op" id="4252802">}</span><span class="op" id="4252803">,</span>&nbsp;<span class="comment" id="4252805">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4252811">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252871">{</span><span class="num" id="4252872">3</span><span class="op" id="4252873">,</span>&nbsp;<span class="num" id="4252875">0</span><span class="op" id="4252876">,</span>&nbsp;<span class="num" id="4252878">8</span><span class="op" id="4252879">,</span>&nbsp;<span class="num" id="4252881">4</span><span class="op" id="4252882">,</span>&nbsp;<span class="num" id="4252884">4</span><span class="op" id="4252885">}</span><span class="op" id="4252886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252889">{</span><span class="num" id="4252890">3</span><span class="op" id="4252891">,</span>&nbsp;<span class="num" id="4252893">0</span><span class="op" id="4252894">,</span>&nbsp;<span class="num" id="4252896">16</span><span class="op" id="4252898">,</span>&nbsp;<span class="num" id="4252900">8</span><span class="op" id="4252901">,</span>&nbsp;<span class="num" id="4252903">5</span><span class="op" id="4252904">}</span><span class="op" id="4252905">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4252908">{</span><span class="num" id="4252909">3</span><span class="op" id="4252910">,</span>&nbsp;<span class="num" id="4252912">0</span><span class="op" id="4252913">,</span>&nbsp;<span class="num" id="4252915">32</span><span class="op" id="4252917">,</span>&nbsp;<span class="num" id="4252919">32</span><span class="op" id="4252921">,</span>&nbsp;<span class="num" id="4252923">6</span><span class="op" id="4252924">}</span><span class="op" id="4252925">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4252928">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4252979">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253040">{</span><span class="num" id="4253041">4</span><span class="op" id="4253042">,</span>&nbsp;<span class="num" id="4253044">4</span><span class="op" id="4253045">,</span>&nbsp;<span class="num" id="4253047">16</span><span class="op" id="4253049">,</span>&nbsp;<span class="num" id="4253051">16</span><span class="op" id="4253053">,</span>&nbsp;<span class="ident" id="4253055">skipNever</span><span class="op" id="4253064">}</span><span class="op" id="4253065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253068">{</span><span class="num" id="4253069">8</span><span class="op" id="4253070">,</span>&nbsp;<span class="num" id="4253072">16</span><span class="op" id="4253074">,</span>&nbsp;<span class="num" id="4253076">32</span><span class="op" id="4253078">,</span>&nbsp;<span class="num" id="4253080">32</span><span class="op" id="4253082">,</span>&nbsp;<span class="ident" id="4253084">skipNever</span><span class="op" id="4253093">}</span><span class="op" id="4253094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253097">{</span><span class="num" id="4253098">8</span><span class="op" id="4253099">,</span>&nbsp;<span class="num" id="4253101">16</span><span class="op" id="4253103">,</span>&nbsp;<span class="num" id="4253105">128</span><span class="op" id="4253108">,</span>&nbsp;<span class="num" id="4253110">128</span><span class="op" id="4253113">,</span>&nbsp;<span class="ident" id="4253115">skipNever</span><span class="op" id="4253124">}</span><span class="op" id="4253125">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253128">{</span><span class="num" id="4253129">8</span><span class="op" id="4253130">,</span>&nbsp;<span class="num" id="4253132">32</span><span class="op" id="4253134">,</span>&nbsp;<span class="num" id="4253136">128</span><span class="op" id="4253139">,</span>&nbsp;<span class="num" id="4253141">256</span><span class="op" id="4253144">,</span>&nbsp;<span class="ident" id="4253146">skipNever</span><span class="op" id="4253155">}</span><span class="op" id="4253156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253159">{</span><span class="num" id="4253160">32</span><span class="op" id="4253162">,</span>&nbsp;<span class="num" id="4253164">128</span><span class="op" id="4253167">,</span>&nbsp;<span class="num" id="4253169">258</span><span class="op" id="4253172">,</span>&nbsp;<span class="num" id="4253174">1024</span><span class="op" id="4253178">,</span>&nbsp;<span class="ident" id="4253180">skipNever</span><span class="op" id="4253189">}</span><span class="op" id="4253190">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4253193">{</span><span class="num" id="4253194">32</span><span class="op" id="4253196">,</span>&nbsp;<span class="num" id="4253198">258</span><span class="op" id="4253201">,</span>&nbsp;<span class="num" id="4253203">258</span><span class="op" id="4253206">,</span>&nbsp;<span class="num" id="4253208">4096</span><span class="op" id="4253212">,</span>&nbsp;<span class="ident" id="4253214">skipNever</span><span class="op" id="4253223">}</span><span class="op" id="4253224">,</span><br>
<span class="lineno"></span><span class="op" id="4253226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4253229">type</span>&nbsp;<span class="ident" id="4253234">compressor</span>&nbsp;<span class="keyword" id="4253245">struct</span>&nbsp;<span class="op" id="4253252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253255">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253274">w</span>&nbsp;<span class="op" id="4253276">*</span><span class="ident" id="4253277">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253296">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253322">fill</span>&nbsp;<span class="keyword" id="4253327">func</span><span class="op" id="4253331">(</span><span class="op" id="4253332">*</span><span class="ident" id="4253333">compressor</span><span class="op" id="4253343">,</span>&nbsp;<span class="op" id="4253345">[</span><span class="op" id="4253346">]</span><span class="builtintype" id="4253347">byte</span><span class="op" id="4253351">)</span>&nbsp;<span class="builtintype" id="4253353">int</span>&nbsp;<span class="comment" id="4253357">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253381">step</span>&nbsp;<span class="keyword" id="4253386">func</span><span class="op" id="4253390">(</span><span class="op" id="4253391">*</span><span class="ident" id="4253392">compressor</span><span class="op" id="4253402">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4253416">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253435">sync</span>&nbsp;<span class="builtintype" id="4253440">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4253470">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253492">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253514">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253600">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253662">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253737">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253767">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4253778">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253783">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4253794">[</span><span class="op" id="4253795">]</span><span class="builtintype" id="4253796">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253801">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4253812">[</span><span class="op" id="4253813">]</span><span class="builtintype" id="4253814">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253819">hashOffset</span>&nbsp;<span class="builtintype" id="4253830">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4253836">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253898">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4253912">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253917">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4253931">[</span><span class="op" id="4253932">]</span><span class="builtintype" id="4253933">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253939">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4253953">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4253958">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4253972">int</span>&nbsp;&nbsp;<span class="comment" id="4253977">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254021">byteAvailable</span>&nbsp;<span class="builtintype" id="4254035">bool</span>&nbsp;<span class="comment" id="4254040">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254093">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254118">tokens</span>&nbsp;<span class="op" id="4254125">[</span><span class="op" id="4254126">]</span><span class="ident" id="4254127">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254135">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254153">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4254168">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254173">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4254188">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254193">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4254208">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254213">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4254228">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254233">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4254248">error</span><br>
<span class="lineno"></span><span class="op" id="4254254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4254257">func</span>&nbsp;<span class="op" id="4254262">(</span><span class="ident" id="4254263">d</span>&nbsp;<span class="op" id="4254265">*</span><span class="ident" id="4254266">compressor</span><span class="op" id="4254276">)</span>&nbsp;<span class="ident" id="4254278">fillDeflate</span><span class="op" id="4254289">(</span><span class="ident" id="4254290">b</span>&nbsp;<span class="op" id="4254292">[</span><span class="op" id="4254293">]</span><span class="builtintype" id="4254294">byte</span><span class="op" id="4254298">)</span>&nbsp;<span class="builtintype" id="4254300">int</span>&nbsp;<span class="op" id="4254304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254307">if</span>&nbsp;<span class="ident" id="4254310">d</span><span class="op" id="4254311">.</span><span class="ident" id="4254312">index</span>&nbsp;<span class="op" id="4254318">&gt;=</span>&nbsp;<span class="num" id="4254321">2</span><span class="op" id="4254322">*</span><span class="ident" id="4254323">windowSize</span><span class="op" id="4254333">-</span><span class="op" id="4254334">(</span><span class="ident" id="4254335">minMatchLength</span><span class="op" id="4254349">+</span><span class="ident" id="4254350">maxMatchLength</span><span class="op" id="4254364">)</span>&nbsp;<span class="op" id="4254366">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4254370">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4254406">copy</span><span class="op" id="4254410">(</span><span class="ident" id="4254411">d</span><span class="op" id="4254412">.</span><span class="ident" id="4254413">window</span><span class="op" id="4254419">,</span>&nbsp;<span class="ident" id="4254421">d</span><span class="op" id="4254422">.</span><span class="ident" id="4254423">window</span><span class="op" id="4254429">[</span><span class="ident" id="4254430">windowSize</span><span class="op" id="4254440">:</span><span class="num" id="4254441">2</span><span class="op" id="4254442">*</span><span class="ident" id="4254443">windowSize</span><span class="op" id="4254453">]</span><span class="op" id="4254454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254458">d</span><span class="op" id="4254459">.</span><span class="ident" id="4254460">index</span>&nbsp;<span class="op" id="4254466">-=</span>&nbsp;<span class="ident" id="4254469">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254482">d</span><span class="op" id="4254483">.</span><span class="ident" id="4254484">windowEnd</span>&nbsp;<span class="op" id="4254494">-=</span>&nbsp;<span class="ident" id="4254497">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254510">if</span>&nbsp;<span class="ident" id="4254513">d</span><span class="op" id="4254514">.</span><span class="ident" id="4254515">blockStart</span>&nbsp;<span class="op" id="4254526">&gt;=</span>&nbsp;<span class="ident" id="4254529">windowSize</span>&nbsp;<span class="op" id="4254540">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254545">d</span><span class="op" id="4254546">.</span><span class="ident" id="4254547">blockStart</span>&nbsp;<span class="op" id="4254558">-=</span>&nbsp;<span class="ident" id="4254561">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254574">}</span>&nbsp;<span class="keyword" id="4254576">else</span>&nbsp;<span class="op" id="4254581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254586">d</span><span class="op" id="4254587">.</span><span class="ident" id="4254588">blockStart</span>&nbsp;<span class="op" id="4254599">=</span>&nbsp;<span class="ident" id="4254601">math</span><span class="op" id="4254605">.</span><span class="ident" id="4254606">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254621">d</span><span class="op" id="4254622">.</span><span class="ident" id="4254623">hashOffset</span>&nbsp;<span class="op" id="4254634">+=</span>&nbsp;<span class="ident" id="4254637">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254650">if</span>&nbsp;<span class="ident" id="4254653">d</span><span class="op" id="4254654">.</span><span class="ident" id="4254655">hashOffset</span>&nbsp;<span class="op" id="4254666">&gt;</span>&nbsp;<span class="ident" id="4254668">maxHashOffset</span>&nbsp;<span class="op" id="4254682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254687">delta</span>&nbsp;<span class="op" id="4254693">:=</span>&nbsp;<span class="ident" id="4254696">d</span><span class="op" id="4254697">.</span><span class="ident" id="4254698">hashOffset</span>&nbsp;<span class="op" id="4254709">-</span>&nbsp;<span class="num" id="4254711">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254716">d</span><span class="op" id="4254717">.</span><span class="ident" id="4254718">hashOffset</span>&nbsp;<span class="op" id="4254729">-=</span>&nbsp;<span class="ident" id="4254732">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254741">d</span><span class="op" id="4254742">.</span><span class="ident" id="4254743">chainHead</span>&nbsp;<span class="op" id="4254753">-=</span>&nbsp;<span class="ident" id="4254756">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254765">for</span>&nbsp;<span class="ident" id="4254769">i</span><span class="op" id="4254770">,</span>&nbsp;<span class="ident" id="4254772">v</span>&nbsp;<span class="op" id="4254774">:=</span>&nbsp;<span class="keyword" id="4254777">range</span>&nbsp;<span class="ident" id="4254783">d</span><span class="op" id="4254784">.</span><span class="ident" id="4254785">hashPrev</span>&nbsp;<span class="op" id="4254794">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254800">if</span>&nbsp;<span class="ident" id="4254803">v</span>&nbsp;<span class="op" id="4254805">&gt;</span>&nbsp;<span class="ident" id="4254807">delta</span>&nbsp;<span class="op" id="4254813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254820">d</span><span class="op" id="4254821">.</span><span class="ident" id="4254822">hashPrev</span><span class="op" id="4254830">[</span><span class="ident" id="4254831">i</span><span class="op" id="4254832">]</span>&nbsp;<span class="op" id="4254834">-=</span>&nbsp;<span class="ident" id="4254837">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254847">}</span>&nbsp;<span class="keyword" id="4254849">else</span>&nbsp;<span class="op" id="4254854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254861">d</span><span class="op" id="4254862">.</span><span class="ident" id="4254863">hashPrev</span><span class="op" id="4254871">[</span><span class="ident" id="4254872">i</span><span class="op" id="4254873">]</span>&nbsp;<span class="op" id="4254875">=</span>&nbsp;<span class="num" id="4254877">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254883">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254893">for</span>&nbsp;<span class="ident" id="4254897">i</span><span class="op" id="4254898">,</span>&nbsp;<span class="ident" id="4254900">v</span>&nbsp;<span class="op" id="4254902">:=</span>&nbsp;<span class="keyword" id="4254905">range</span>&nbsp;<span class="ident" id="4254911">d</span><span class="op" id="4254912">.</span><span class="ident" id="4254913">hashHead</span>&nbsp;<span class="op" id="4254922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4254928">if</span>&nbsp;<span class="ident" id="4254931">v</span>&nbsp;<span class="op" id="4254933">&gt;</span>&nbsp;<span class="ident" id="4254935">delta</span>&nbsp;<span class="op" id="4254941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254948">d</span><span class="op" id="4254949">.</span><span class="ident" id="4254950">hashHead</span><span class="op" id="4254958">[</span><span class="ident" id="4254959">i</span><span class="op" id="4254960">]</span>&nbsp;<span class="op" id="4254962">-=</span>&nbsp;<span class="ident" id="4254965">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4254975">}</span>&nbsp;<span class="keyword" id="4254977">else</span>&nbsp;<span class="op" id="4254982">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4254989">d</span><span class="op" id="4254990">.</span><span class="ident" id="4254991">hashHead</span><span class="op" id="4254999">[</span><span class="ident" id="4255000">i</span><span class="op" id="4255001">]</span>&nbsp;<span class="op" id="4255003">=</span>&nbsp;<span class="num" id="4255005">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255023">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255026">n</span>&nbsp;<span class="op" id="4255028">:=</span>&nbsp;<span class="builtinfunc" id="4255031">copy</span><span class="op" id="4255035">(</span><span class="ident" id="4255036">d</span><span class="op" id="4255037">.</span><span class="ident" id="4255038">window</span><span class="op" id="4255044">[</span><span class="ident" id="4255045">d</span><span class="op" id="4255046">.</span><span class="ident" id="4255047">windowEnd</span><span class="op" id="4255056">:</span><span class="op" id="4255057">]</span><span class="op" id="4255058">,</span>&nbsp;<span class="ident" id="4255060">b</span><span class="op" id="4255061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255064">d</span><span class="op" id="4255065">.</span><span class="ident" id="4255066">windowEnd</span>&nbsp;<span class="op" id="4255076">+=</span>&nbsp;<span class="ident" id="4255079">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255082">return</span>&nbsp;<span class="ident" id="4255089">n</span><br>
<span class="lineno"></span><span class="op" id="4255091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4255094">func</span>&nbsp;<span class="op" id="4255099">(</span><span class="ident" id="4255100">d</span>&nbsp;<span class="op" id="4255102">*</span><span class="ident" id="4255103">compressor</span><span class="op" id="4255113">)</span>&nbsp;<span class="ident" id="4255115">writeBlock</span><span class="op" id="4255125">(</span><span class="ident" id="4255126">tokens</span>&nbsp;<span class="op" id="4255133">[</span><span class="op" id="4255134">]</span><span class="ident" id="4255135">token</span><span class="op" id="4255140">,</span>&nbsp;<span class="ident" id="4255142">index</span>&nbsp;<span class="builtintype" id="4255148">int</span><span class="op" id="4255151">,</span>&nbsp;<span class="ident" id="4255153">eof</span>&nbsp;<span class="builtintype" id="4255157">bool</span><span class="op" id="4255161">)</span>&nbsp;<span class="builtintype" id="4255163">error</span>&nbsp;<span class="op" id="4255169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255172">if</span>&nbsp;<span class="ident" id="4255175">index</span>&nbsp;<span class="op" id="4255181">&gt;</span>&nbsp;<span class="num" id="4255183">0</span>&nbsp;<span class="op" id="4255185">||</span>&nbsp;<span class="ident" id="4255188">eof</span>&nbsp;<span class="op" id="4255192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255196">var</span>&nbsp;<span class="ident" id="4255200">window</span>&nbsp;<span class="op" id="4255207">[</span><span class="op" id="4255208">]</span><span class="builtintype" id="4255209">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255216">if</span>&nbsp;<span class="ident" id="4255219">d</span><span class="op" id="4255220">.</span><span class="ident" id="4255221">blockStart</span>&nbsp;<span class="op" id="4255232">&lt;=</span>&nbsp;<span class="ident" id="4255235">index</span>&nbsp;<span class="op" id="4255241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255246">window</span>&nbsp;<span class="op" id="4255253">=</span>&nbsp;<span class="ident" id="4255255">d</span><span class="op" id="4255256">.</span><span class="ident" id="4255257">window</span><span class="op" id="4255263">[</span><span class="ident" id="4255264">d</span><span class="op" id="4255265">.</span><span class="ident" id="4255266">blockStart</span><span class="op" id="4255276">:</span><span class="ident" id="4255277">index</span><span class="op" id="4255282">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255290">d</span><span class="op" id="4255291">.</span><span class="ident" id="4255292">blockStart</span>&nbsp;<span class="op" id="4255303">=</span>&nbsp;<span class="ident" id="4255305">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255313">d</span><span class="op" id="4255314">.</span><span class="ident" id="4255315">w</span><span class="op" id="4255316">.</span><span class="ident" id="4255317">writeBlock</span><span class="op" id="4255327">(</span><span class="ident" id="4255328">tokens</span><span class="op" id="4255334">,</span>&nbsp;<span class="ident" id="4255336">eof</span><span class="op" id="4255339">,</span>&nbsp;<span class="ident" id="4255341">window</span><span class="op" id="4255347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255351">return</span>&nbsp;<span class="ident" id="4255358">d</span><span class="op" id="4255359">.</span><span class="ident" id="4255360">w</span><span class="op" id="4255361">.</span><span class="ident" id="4255362">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255367">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255370">return</span>&nbsp;<span class="ident" id="4255377">nil</span><br>
<span class="lineno"></span><span class="op" id="4255381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4255384">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4255464">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4255526">func</span>&nbsp;<span class="op" id="4255531">(</span><span class="ident" id="4255532">d</span>&nbsp;<span class="op" id="4255534">*</span><span class="ident" id="4255535">compressor</span><span class="op" id="4255545">)</span>&nbsp;<span class="ident" id="4255547">findMatch</span><span class="op" id="4255556">(</span><span class="ident" id="4255557">pos</span>&nbsp;<span class="builtintype" id="4255561">int</span><span class="op" id="4255564">,</span>&nbsp;<span class="ident" id="4255566">prevHead</span>&nbsp;<span class="builtintype" id="4255575">int</span><span class="op" id="4255578">,</span>&nbsp;<span class="ident" id="4255580">prevLength</span>&nbsp;<span class="builtintype" id="4255591">int</span><span class="op" id="4255594">,</span>&nbsp;<span class="ident" id="4255596">lookahead</span>&nbsp;<span class="builtintype" id="4255606">int</span><span class="op" id="4255609">)</span>&nbsp;<span class="op" id="4255611">(</span><span class="ident" id="4255612">length</span><span class="op" id="4255618">,</span>&nbsp;<span class="ident" id="4255620">offset</span>&nbsp;<span class="builtintype" id="4255627">int</span><span class="op" id="4255630">,</span>&nbsp;<span class="ident" id="4255632">ok</span>&nbsp;<span class="builtintype" id="4255635">bool</span><span class="op" id="4255639">)</span>&nbsp;<span class="op" id="4255641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255644">minMatchLook</span>&nbsp;<span class="op" id="4255657">:=</span>&nbsp;<span class="ident" id="4255660">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255676">if</span>&nbsp;<span class="ident" id="4255679">lookahead</span>&nbsp;<span class="op" id="4255689">&lt;</span>&nbsp;<span class="ident" id="4255691">minMatchLook</span>&nbsp;<span class="op" id="4255704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255708">minMatchLook</span>&nbsp;<span class="op" id="4255721">=</span>&nbsp;<span class="ident" id="4255723">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255734">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255738">win</span>&nbsp;<span class="op" id="4255742">:=</span>&nbsp;<span class="ident" id="4255745">d</span><span class="op" id="4255746">.</span><span class="ident" id="4255747">window</span><span class="op" id="4255753">[</span><span class="num" id="4255754">0</span>&nbsp;<span class="op" id="4255756">:</span>&nbsp;<span class="ident" id="4255758">pos</span><span class="op" id="4255761">+</span><span class="ident" id="4255762">minMatchLook</span><span class="op" id="4255774">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4255778">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255836">nice</span>&nbsp;<span class="op" id="4255841">:=</span>&nbsp;<span class="builtinfunc" id="4255844">len</span><span class="op" id="4255847">(</span><span class="ident" id="4255848">win</span><span class="op" id="4255851">)</span>&nbsp;<span class="op" id="4255853">-</span>&nbsp;<span class="ident" id="4255855">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4255860">if</span>&nbsp;<span class="ident" id="4255863">d</span><span class="op" id="4255864">.</span><span class="ident" id="4255865">nice</span>&nbsp;<span class="op" id="4255870">&lt;</span>&nbsp;<span class="ident" id="4255872">nice</span>&nbsp;<span class="op" id="4255877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255881">nice</span>&nbsp;<span class="op" id="4255886">=</span>&nbsp;<span class="ident" id="4255888">d</span><span class="op" id="4255889">.</span><span class="ident" id="4255890">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4255896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4255900">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255973">tries</span>&nbsp;<span class="op" id="4255979">:=</span>&nbsp;<span class="ident" id="4255982">d</span><span class="op" id="4255983">.</span><span class="ident" id="4255984">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4255991">length</span>&nbsp;<span class="op" id="4255998">=</span>&nbsp;<span class="ident" id="4256000">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256012">if</span>&nbsp;<span class="ident" id="4256015">length</span>&nbsp;<span class="op" id="4256022">&gt;=</span>&nbsp;<span class="ident" id="4256025">d</span><span class="op" id="4256026">.</span><span class="ident" id="4256027">good</span>&nbsp;<span class="op" id="4256032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256036">tries</span>&nbsp;<span class="op" id="4256042">&gt;&gt;=</span>&nbsp;<span class="num" id="4256046">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256049">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256053">w0</span>&nbsp;<span class="op" id="4256056">:=</span>&nbsp;<span class="ident" id="4256059">win</span><span class="op" id="4256062">[</span><span class="ident" id="4256063">pos</span><span class="op" id="4256066">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256069">w1</span>&nbsp;<span class="op" id="4256072">:=</span>&nbsp;<span class="ident" id="4256075">win</span><span class="op" id="4256078">[</span><span class="ident" id="4256079">pos</span><span class="op" id="4256082">+</span><span class="num" id="4256083">1</span><span class="op" id="4256084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256087">wEnd</span>&nbsp;<span class="op" id="4256092">:=</span>&nbsp;<span class="ident" id="4256095">win</span><span class="op" id="4256098">[</span><span class="ident" id="4256099">pos</span><span class="op" id="4256102">+</span><span class="ident" id="4256103">length</span><span class="op" id="4256109">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256112">minIndex</span>&nbsp;<span class="op" id="4256121">:=</span>&nbsp;<span class="ident" id="4256124">pos</span>&nbsp;<span class="op" id="4256128">-</span>&nbsp;<span class="ident" id="4256130">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256143">for</span>&nbsp;<span class="ident" id="4256147">i</span>&nbsp;<span class="op" id="4256149">:=</span>&nbsp;<span class="ident" id="4256152">prevHead</span><span class="op" id="4256160">;</span>&nbsp;<span class="ident" id="4256162">tries</span>&nbsp;<span class="op" id="4256168">&gt;</span>&nbsp;<span class="num" id="4256170">0</span><span class="op" id="4256171">;</span>&nbsp;<span class="ident" id="4256173">tries</span><span class="op" id="4256178">--</span>&nbsp;<span class="op" id="4256181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256185">if</span>&nbsp;<span class="ident" id="4256188">w0</span>&nbsp;<span class="op" id="4256191">==</span>&nbsp;<span class="ident" id="4256194">win</span><span class="op" id="4256197">[</span><span class="ident" id="4256198">i</span><span class="op" id="4256199">]</span>&nbsp;<span class="op" id="4256201">&amp;&amp;</span>&nbsp;<span class="ident" id="4256204">w1</span>&nbsp;<span class="op" id="4256207">==</span>&nbsp;<span class="ident" id="4256210">win</span><span class="op" id="4256213">[</span><span class="ident" id="4256214">i</span><span class="op" id="4256215">+</span><span class="num" id="4256216">1</span><span class="op" id="4256217">]</span>&nbsp;<span class="op" id="4256219">&amp;&amp;</span>&nbsp;<span class="ident" id="4256222">wEnd</span>&nbsp;<span class="op" id="4256227">==</span>&nbsp;<span class="ident" id="4256230">win</span><span class="op" id="4256233">[</span><span class="ident" id="4256234">i</span><span class="op" id="4256235">+</span><span class="ident" id="4256236">length</span><span class="op" id="4256242">]</span>&nbsp;<span class="op" id="4256244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4256249">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256334">n</span>&nbsp;<span class="op" id="4256336">:=</span>&nbsp;<span class="num" id="4256339">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256344">for</span>&nbsp;<span class="ident" id="4256348">pos</span><span class="op" id="4256351">+</span><span class="ident" id="4256352">n</span>&nbsp;<span class="op" id="4256354">&lt;</span>&nbsp;<span class="builtinfunc" id="4256356">len</span><span class="op" id="4256359">(</span><span class="ident" id="4256360">win</span><span class="op" id="4256363">)</span>&nbsp;<span class="op" id="4256365">&amp;&amp;</span>&nbsp;<span class="ident" id="4256368">win</span><span class="op" id="4256371">[</span><span class="ident" id="4256372">i</span><span class="op" id="4256373">+</span><span class="ident" id="4256374">n</span><span class="op" id="4256375">]</span>&nbsp;<span class="op" id="4256377">==</span>&nbsp;<span class="ident" id="4256380">win</span><span class="op" id="4256383">[</span><span class="ident" id="4256384">pos</span><span class="op" id="4256387">+</span><span class="ident" id="4256388">n</span><span class="op" id="4256389">]</span>&nbsp;<span class="op" id="4256391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256397">n</span><span class="op" id="4256398">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256409">if</span>&nbsp;<span class="ident" id="4256412">n</span>&nbsp;<span class="op" id="4256414">&gt;</span>&nbsp;<span class="ident" id="4256416">length</span>&nbsp;<span class="op" id="4256423">&amp;&amp;</span>&nbsp;<span class="op" id="4256426">(</span><span class="ident" id="4256427">n</span>&nbsp;<span class="op" id="4256429">&gt;</span>&nbsp;<span class="num" id="4256431">3</span>&nbsp;<span class="op" id="4256433">||</span>&nbsp;<span class="ident" id="4256436">pos</span><span class="op" id="4256439">-</span><span class="ident" id="4256440">i</span>&nbsp;<span class="op" id="4256442">&lt;=</span>&nbsp;<span class="num" id="4256445">4096</span><span class="op" id="4256449">)</span>&nbsp;<span class="op" id="4256451">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256457">length</span>&nbsp;<span class="op" id="4256464">=</span>&nbsp;<span class="ident" id="4256466">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256472">offset</span>&nbsp;<span class="op" id="4256479">=</span>&nbsp;<span class="ident" id="4256481">pos</span>&nbsp;<span class="op" id="4256485">-</span>&nbsp;<span class="ident" id="4256487">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256493">ok</span>&nbsp;<span class="op" id="4256496">=</span>&nbsp;<span class="builtintype" id="4256498">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256507">if</span>&nbsp;<span class="ident" id="4256510">n</span>&nbsp;<span class="op" id="4256512">&gt;=</span>&nbsp;<span class="ident" id="4256515">nice</span>&nbsp;<span class="op" id="4256520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4256527">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256600">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256616">wEnd</span>&nbsp;<span class="op" id="4256621">=</span>&nbsp;<span class="ident" id="4256623">win</span><span class="op" id="4256626">[</span><span class="ident" id="4256627">pos</span><span class="op" id="4256630">+</span><span class="ident" id="4256631">n</span><span class="op" id="4256632">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256641">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256645">if</span>&nbsp;<span class="ident" id="4256648">i</span>&nbsp;<span class="op" id="4256650">==</span>&nbsp;<span class="ident" id="4256653">minIndex</span>&nbsp;<span class="op" id="4256662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4256667">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256741">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256753">if</span>&nbsp;<span class="ident" id="4256756">i</span>&nbsp;<span class="op" id="4256758">=</span>&nbsp;<span class="ident" id="4256760">d</span><span class="op" id="4256761">.</span><span class="ident" id="4256762">hashPrev</span><span class="op" id="4256770">[</span><span class="ident" id="4256771">i</span><span class="op" id="4256772">&amp;</span><span class="ident" id="4256773">windowMask</span><span class="op" id="4256783">]</span>&nbsp;<span class="op" id="4256785">-</span>&nbsp;<span class="ident" id="4256787">d</span><span class="op" id="4256788">.</span><span class="ident" id="4256789">hashOffset</span><span class="op" id="4256799">;</span>&nbsp;<span class="ident" id="4256801">i</span>&nbsp;<span class="op" id="4256803">&lt;</span>&nbsp;<span class="ident" id="4256805">minIndex</span>&nbsp;<span class="op" id="4256814">||</span>&nbsp;<span class="ident" id="4256817">i</span>&nbsp;<span class="op" id="4256819">&lt;</span>&nbsp;<span class="num" id="4256821">0</span>&nbsp;<span class="op" id="4256823">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256828">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256842">return</span><br>
<span class="lineno"></span><span class="op" id="4256849">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4256852">func</span>&nbsp;<span class="op" id="4256857">(</span><span class="ident" id="4256858">d</span>&nbsp;<span class="op" id="4256860">*</span><span class="ident" id="4256861">compressor</span><span class="op" id="4256871">)</span>&nbsp;<span class="ident" id="4256873">writeStoredBlock</span><span class="op" id="4256889">(</span><span class="ident" id="4256890">buf</span>&nbsp;<span class="op" id="4256894">[</span><span class="op" id="4256895">]</span><span class="builtintype" id="4256896">byte</span><span class="op" id="4256900">)</span>&nbsp;<span class="builtintype" id="4256902">error</span>&nbsp;<span class="op" id="4256908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256911">if</span>&nbsp;<span class="ident" id="4256914">d</span><span class="op" id="4256915">.</span><span class="ident" id="4256916">w</span><span class="op" id="4256917">.</span><span class="ident" id="4256918">writeStoredHeader</span><span class="op" id="4256935">(</span><span class="builtinfunc" id="4256936">len</span><span class="op" id="4256939">(</span><span class="ident" id="4256940">buf</span><span class="op" id="4256943">)</span><span class="op" id="4256944">,</span>&nbsp;<span class="builtintype" id="4256946">false</span><span class="op" id="4256951">)</span><span class="op" id="4256952">;</span>&nbsp;<span class="ident" id="4256954">d</span><span class="op" id="4256955">.</span><span class="ident" id="4256956">w</span><span class="op" id="4256957">.</span><span class="ident" id="4256958">err</span>&nbsp;<span class="op" id="4256962">!=</span>&nbsp;<span class="ident" id="4256965">nil</span>&nbsp;<span class="op" id="4256969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4256973">return</span>&nbsp;<span class="ident" id="4256980">d</span><span class="op" id="4256981">.</span><span class="ident" id="4256982">w</span><span class="op" id="4256983">.</span><span class="ident" id="4256984">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4256989">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4256992">d</span><span class="op" id="4256993">.</span><span class="ident" id="4256994">w</span><span class="op" id="4256995">.</span><span class="ident" id="4256996">writeBytes</span><span class="op" id="4257006">(</span><span class="ident" id="4257007">buf</span><span class="op" id="4257010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257013">return</span>&nbsp;<span class="ident" id="4257020">d</span><span class="op" id="4257021">.</span><span class="ident" id="4257022">w</span><span class="op" id="4257023">.</span><span class="ident" id="4257024">err</span><br>
<span class="lineno"></span><span class="op" id="4257028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4257031">func</span>&nbsp;<span class="op" id="4257036">(</span><span class="ident" id="4257037">d</span>&nbsp;<span class="op" id="4257039">*</span><span class="ident" id="4257040">compressor</span><span class="op" id="4257050">)</span>&nbsp;<span class="ident" id="4257052">initDeflate</span><span class="op" id="4257063">(</span><span class="op" id="4257064">)</span>&nbsp;<span class="op" id="4257066">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257069">d</span><span class="op" id="4257070">.</span><span class="ident" id="4257071">hashHead</span>&nbsp;<span class="op" id="4257080">=</span>&nbsp;<span class="builtinfunc" id="4257082">make</span><span class="op" id="4257086">(</span><span class="op" id="4257087">[</span><span class="op" id="4257088">]</span><span class="builtintype" id="4257089">int</span><span class="op" id="4257092">,</span>&nbsp;<span class="ident" id="4257094">hashSize</span><span class="op" id="4257102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257105">d</span><span class="op" id="4257106">.</span><span class="ident" id="4257107">hashPrev</span>&nbsp;<span class="op" id="4257116">=</span>&nbsp;<span class="builtinfunc" id="4257118">make</span><span class="op" id="4257122">(</span><span class="op" id="4257123">[</span><span class="op" id="4257124">]</span><span class="builtintype" id="4257125">int</span><span class="op" id="4257128">,</span>&nbsp;<span class="ident" id="4257130">windowSize</span><span class="op" id="4257140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257143">d</span><span class="op" id="4257144">.</span><span class="ident" id="4257145">window</span>&nbsp;<span class="op" id="4257152">=</span>&nbsp;<span class="builtinfunc" id="4257154">make</span><span class="op" id="4257158">(</span><span class="op" id="4257159">[</span><span class="op" id="4257160">]</span><span class="builtintype" id="4257161">byte</span><span class="op" id="4257165">,</span>&nbsp;<span class="num" id="4257167">2</span><span class="op" id="4257168">*</span><span class="ident" id="4257169">windowSize</span><span class="op" id="4257179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257182">d</span><span class="op" id="4257183">.</span><span class="ident" id="4257184">hashOffset</span>&nbsp;<span class="op" id="4257195">=</span>&nbsp;<span class="num" id="4257197">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257200">d</span><span class="op" id="4257201">.</span><span class="ident" id="4257202">tokens</span>&nbsp;<span class="op" id="4257209">=</span>&nbsp;<span class="builtinfunc" id="4257211">make</span><span class="op" id="4257215">(</span><span class="op" id="4257216">[</span><span class="op" id="4257217">]</span><span class="ident" id="4257218">token</span><span class="op" id="4257223">,</span>&nbsp;<span class="num" id="4257225">0</span><span class="op" id="4257226">,</span>&nbsp;<span class="ident" id="4257228">maxFlateBlockTokens</span><span class="op" id="4257247">+</span><span class="num" id="4257248">1</span><span class="op" id="4257249">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257252">d</span><span class="op" id="4257253">.</span><span class="ident" id="4257254">length</span>&nbsp;<span class="op" id="4257261">=</span>&nbsp;<span class="ident" id="4257263">minMatchLength</span>&nbsp;<span class="op" id="4257278">-</span>&nbsp;<span class="num" id="4257280">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257283">d</span><span class="op" id="4257284">.</span><span class="ident" id="4257285">offset</span>&nbsp;<span class="op" id="4257292">=</span>&nbsp;<span class="num" id="4257294">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257297">d</span><span class="op" id="4257298">.</span><span class="ident" id="4257299">byteAvailable</span>&nbsp;<span class="op" id="4257313">=</span>&nbsp;<span class="builtintype" id="4257315">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257322">d</span><span class="op" id="4257323">.</span><span class="ident" id="4257324">index</span>&nbsp;<span class="op" id="4257330">=</span>&nbsp;<span class="num" id="4257332">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257335">d</span><span class="op" id="4257336">.</span><span class="ident" id="4257337">hash</span>&nbsp;<span class="op" id="4257342">=</span>&nbsp;<span class="num" id="4257344">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257347">d</span><span class="op" id="4257348">.</span><span class="ident" id="4257349">chainHead</span>&nbsp;<span class="op" id="4257359">=</span>&nbsp;<span class="op" id="4257361">-</span><span class="num" id="4257362">1</span><br>
<span class="lineno"></span><span class="op" id="4257364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4257367">func</span>&nbsp;<span class="op" id="4257372">(</span><span class="ident" id="4257373">d</span>&nbsp;<span class="op" id="4257375">*</span><span class="ident" id="4257376">compressor</span><span class="op" id="4257386">)</span>&nbsp;<span class="ident" id="4257388">deflate</span><span class="op" id="4257395">(</span><span class="op" id="4257396">)</span>&nbsp;<span class="op" id="4257398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257401">if</span>&nbsp;<span class="ident" id="4257404">d</span><span class="op" id="4257405">.</span><span class="ident" id="4257406">windowEnd</span><span class="op" id="4257415">-</span><span class="ident" id="4257416">d</span><span class="op" id="4257417">.</span><span class="ident" id="4257418">index</span>&nbsp;<span class="op" id="4257424">&lt;</span>&nbsp;<span class="ident" id="4257426">minMatchLength</span><span class="op" id="4257440">+</span><span class="ident" id="4257441">maxMatchLength</span>&nbsp;<span class="op" id="4257456">&amp;&amp;</span>&nbsp;<span class="op" id="4257459">!</span><span class="ident" id="4257460">d</span><span class="op" id="4257461">.</span><span class="ident" id="4257462">sync</span>&nbsp;<span class="op" id="4257467">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257483">d</span><span class="op" id="4257484">.</span><span class="ident" id="4257485">maxInsertIndex</span>&nbsp;<span class="op" id="4257500">=</span>&nbsp;<span class="ident" id="4257502">d</span><span class="op" id="4257503">.</span><span class="ident" id="4257504">windowEnd</span>&nbsp;<span class="op" id="4257514">-</span>&nbsp;<span class="op" id="4257516">(</span><span class="ident" id="4257517">minMatchLength</span>&nbsp;<span class="op" id="4257532">-</span>&nbsp;<span class="num" id="4257534">1</span><span class="op" id="4257535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257538">if</span>&nbsp;<span class="ident" id="4257541">d</span><span class="op" id="4257542">.</span><span class="ident" id="4257543">index</span>&nbsp;<span class="op" id="4257549">&lt;</span>&nbsp;<span class="ident" id="4257551">d</span><span class="op" id="4257552">.</span><span class="ident" id="4257553">maxInsertIndex</span>&nbsp;<span class="op" id="4257568">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257572">d</span><span class="op" id="4257573">.</span><span class="ident" id="4257574">hash</span>&nbsp;<span class="op" id="4257579">=</span>&nbsp;<span class="builtintype" id="4257581">int</span><span class="op" id="4257584">(</span><span class="ident" id="4257585">d</span><span class="op" id="4257586">.</span><span class="ident" id="4257587">window</span><span class="op" id="4257593">[</span><span class="ident" id="4257594">d</span><span class="op" id="4257595">.</span><span class="ident" id="4257596">index</span><span class="op" id="4257601">]</span><span class="op" id="4257602">)</span><span class="op" id="4257603">&lt;&lt;</span><span class="ident" id="4257605">hashShift</span>&nbsp;<span class="op" id="4257615">+</span>&nbsp;<span class="builtintype" id="4257617">int</span><span class="op" id="4257620">(</span><span class="ident" id="4257621">d</span><span class="op" id="4257622">.</span><span class="ident" id="4257623">window</span><span class="op" id="4257629">[</span><span class="ident" id="4257630">d</span><span class="op" id="4257631">.</span><span class="ident" id="4257632">index</span><span class="op" id="4257637">+</span><span class="num" id="4257638">1</span><span class="op" id="4257639">]</span><span class="op" id="4257640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4257646">Loop</span><span class="op" id="4257650">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257653">for</span>&nbsp;<span class="op" id="4257657">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257661">if</span>&nbsp;<span class="ident" id="4257664">d</span><span class="op" id="4257665">.</span><span class="ident" id="4257666">index</span>&nbsp;<span class="op" id="4257672">&gt;</span>&nbsp;<span class="ident" id="4257674">d</span><span class="op" id="4257675">.</span><span class="ident" id="4257676">windowEnd</span>&nbsp;<span class="op" id="4257686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4257691">panic</span><span class="op" id="4257696">(</span><span class="string" id="4257697">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4257716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4257724">lookahead</span>&nbsp;<span class="op" id="4257734">:=</span>&nbsp;<span class="ident" id="4257737">d</span><span class="op" id="4257738">.</span><span class="ident" id="4257739">windowEnd</span>&nbsp;<span class="op" id="4257749">-</span>&nbsp;<span class="ident" id="4257751">d</span><span class="op" id="4257752">.</span><span class="ident" id="4257753">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257761">if</span>&nbsp;<span class="ident" id="4257764">lookahead</span>&nbsp;<span class="op" id="4257774">&lt;</span>&nbsp;<span class="ident" id="4257776">minMatchLength</span><span class="op" id="4257790">+</span><span class="ident" id="4257791">maxMatchLength</span>&nbsp;<span class="op" id="4257806">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257811">if</span>&nbsp;<span class="op" id="4257814">!</span><span class="ident" id="4257815">d</span><span class="op" id="4257816">.</span><span class="ident" id="4257817">sync</span>&nbsp;<span class="op" id="4257822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257828">break</span>&nbsp;<span class="ident" id="4257834">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257847">if</span>&nbsp;<span class="ident" id="4257850">d</span><span class="op" id="4257851">.</span><span class="ident" id="4257852">index</span>&nbsp;<span class="op" id="4257858">&gt;</span>&nbsp;<span class="ident" id="4257860">d</span><span class="op" id="4257861">.</span><span class="ident" id="4257862">windowEnd</span>&nbsp;<span class="op" id="4257872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4257878">panic</span><span class="op" id="4257883">(</span><span class="string" id="4257884">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4257903">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4257908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257913">if</span>&nbsp;<span class="ident" id="4257916">lookahead</span>&nbsp;<span class="op" id="4257926">==</span>&nbsp;<span class="num" id="4257929">0</span>&nbsp;<span class="op" id="4257931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4257937">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4257979">if</span>&nbsp;<span class="ident" id="4257982">d</span><span class="op" id="4257983">.</span><span class="ident" id="4257984">byteAvailable</span>&nbsp;<span class="op" id="4257998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4258005">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258071">d</span><span class="op" id="4258072">.</span><span class="ident" id="4258073">tokens</span>&nbsp;<span class="op" id="4258080">=</span>&nbsp;<span class="builtinfunc" id="4258082">append</span><span class="op" id="4258088">(</span><span class="ident" id="4258089">d</span><span class="op" id="4258090">.</span><span class="ident" id="4258091">tokens</span><span class="op" id="4258097">,</span>&nbsp;<span class="ident" id="4258099">literalToken</span><span class="op" id="4258111">(</span><span class="builtintype" id="4258112">uint32</span><span class="op" id="4258118">(</span><span class="ident" id="4258119">d</span><span class="op" id="4258120">.</span><span class="ident" id="4258121">window</span><span class="op" id="4258127">[</span><span class="ident" id="4258128">d</span><span class="op" id="4258129">.</span><span class="ident" id="4258130">index</span><span class="op" id="4258135">-</span><span class="num" id="4258136">1</span><span class="op" id="4258137">]</span><span class="op" id="4258138">)</span><span class="op" id="4258139">)</span><span class="op" id="4258140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258147">d</span><span class="op" id="4258148">.</span><span class="ident" id="4258149">byteAvailable</span>&nbsp;<span class="op" id="4258163">=</span>&nbsp;<span class="builtintype" id="4258165">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258181">if</span>&nbsp;<span class="builtinfunc" id="4258184">len</span><span class="op" id="4258187">(</span><span class="ident" id="4258188">d</span><span class="op" id="4258189">.</span><span class="ident" id="4258190">tokens</span><span class="op" id="4258196">)</span>&nbsp;<span class="op" id="4258198">&gt;</span>&nbsp;<span class="num" id="4258200">0</span>&nbsp;<span class="op" id="4258202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258209">if</span>&nbsp;<span class="ident" id="4258212">d</span><span class="op" id="4258213">.</span><span class="ident" id="4258214">err</span>&nbsp;<span class="op" id="4258218">=</span>&nbsp;<span class="ident" id="4258220">d</span><span class="op" id="4258221">.</span><span class="ident" id="4258222">writeBlock</span><span class="op" id="4258232">(</span><span class="ident" id="4258233">d</span><span class="op" id="4258234">.</span><span class="ident" id="4258235">tokens</span><span class="op" id="4258241">,</span>&nbsp;<span class="ident" id="4258243">d</span><span class="op" id="4258244">.</span><span class="ident" id="4258245">index</span><span class="op" id="4258250">,</span>&nbsp;<span class="builtintype" id="4258252">false</span><span class="op" id="4258257">)</span><span class="op" id="4258258">;</span>&nbsp;<span class="ident" id="4258260">d</span><span class="op" id="4258261">.</span><span class="ident" id="4258262">err</span>&nbsp;<span class="op" id="4258266">!=</span>&nbsp;<span class="ident" id="4258269">nil</span>&nbsp;<span class="op" id="4258273">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258300">d</span><span class="op" id="4258301">.</span><span class="ident" id="4258302">tokens</span>&nbsp;<span class="op" id="4258309">=</span>&nbsp;<span class="ident" id="4258311">d</span><span class="op" id="4258312">.</span><span class="ident" id="4258313">tokens</span><span class="op" id="4258319">[</span><span class="op" id="4258320">:</span><span class="num" id="4258321">0</span><span class="op" id="4258322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258334">break</span>&nbsp;<span class="ident" id="4258340">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258356">if</span>&nbsp;<span class="ident" id="4258359">d</span><span class="op" id="4258360">.</span><span class="ident" id="4258361">index</span>&nbsp;<span class="op" id="4258367">&lt;</span>&nbsp;<span class="ident" id="4258369">d</span><span class="op" id="4258370">.</span><span class="ident" id="4258371">maxInsertIndex</span>&nbsp;<span class="op" id="4258386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4258391">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258413">d</span><span class="op" id="4258414">.</span><span class="ident" id="4258415">hash</span>&nbsp;<span class="op" id="4258420">=</span>&nbsp;<span class="op" id="4258422">(</span><span class="ident" id="4258423">d</span><span class="op" id="4258424">.</span><span class="ident" id="4258425">hash</span><span class="op" id="4258429">&lt;&lt;</span><span class="ident" id="4258431">hashShift</span>&nbsp;<span class="op" id="4258441">+</span>&nbsp;<span class="builtintype" id="4258443">int</span><span class="op" id="4258446">(</span><span class="ident" id="4258447">d</span><span class="op" id="4258448">.</span><span class="ident" id="4258449">window</span><span class="op" id="4258455">[</span><span class="ident" id="4258456">d</span><span class="op" id="4258457">.</span><span class="ident" id="4258458">index</span><span class="op" id="4258463">+</span><span class="num" id="4258464">2</span><span class="op" id="4258465">]</span><span class="op" id="4258466">)</span><span class="op" id="4258467">)</span>&nbsp;<span class="op" id="4258469">&amp;</span>&nbsp;<span class="ident" id="4258471">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258483">d</span><span class="op" id="4258484">.</span><span class="ident" id="4258485">chainHead</span>&nbsp;<span class="op" id="4258495">=</span>&nbsp;<span class="ident" id="4258497">d</span><span class="op" id="4258498">.</span><span class="ident" id="4258499">hashHead</span><span class="op" id="4258507">[</span><span class="ident" id="4258508">d</span><span class="op" id="4258509">.</span><span class="ident" id="4258510">hash</span><span class="op" id="4258514">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258519">d</span><span class="op" id="4258520">.</span><span class="ident" id="4258521">hashPrev</span><span class="op" id="4258529">[</span><span class="ident" id="4258530">d</span><span class="op" id="4258531">.</span><span class="ident" id="4258532">index</span><span class="op" id="4258537">&amp;</span><span class="ident" id="4258538">windowMask</span><span class="op" id="4258548">]</span>&nbsp;<span class="op" id="4258550">=</span>&nbsp;<span class="ident" id="4258552">d</span><span class="op" id="4258553">.</span><span class="ident" id="4258554">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258567">d</span><span class="op" id="4258568">.</span><span class="ident" id="4258569">hashHead</span><span class="op" id="4258577">[</span><span class="ident" id="4258578">d</span><span class="op" id="4258579">.</span><span class="ident" id="4258580">hash</span><span class="op" id="4258584">]</span>&nbsp;<span class="op" id="4258586">=</span>&nbsp;<span class="ident" id="4258588">d</span><span class="op" id="4258589">.</span><span class="ident" id="4258590">index</span>&nbsp;<span class="op" id="4258596">+</span>&nbsp;<span class="ident" id="4258598">d</span><span class="op" id="4258599">.</span><span class="ident" id="4258600">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258617">prevLength</span>&nbsp;<span class="op" id="4258628">:=</span>&nbsp;<span class="ident" id="4258631">d</span><span class="op" id="4258632">.</span><span class="ident" id="4258633">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258642">prevOffset</span>&nbsp;<span class="op" id="4258653">:=</span>&nbsp;<span class="ident" id="4258656">d</span><span class="op" id="4258657">.</span><span class="ident" id="4258658">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258667">d</span><span class="op" id="4258668">.</span><span class="ident" id="4258669">length</span>&nbsp;<span class="op" id="4258676">=</span>&nbsp;<span class="ident" id="4258678">minMatchLength</span>&nbsp;<span class="op" id="4258693">-</span>&nbsp;<span class="num" id="4258695">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258699">d</span><span class="op" id="4258700">.</span><span class="ident" id="4258701">offset</span>&nbsp;<span class="op" id="4258708">=</span>&nbsp;<span class="num" id="4258710">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258714">minIndex</span>&nbsp;<span class="op" id="4258723">:=</span>&nbsp;<span class="ident" id="4258726">d</span><span class="op" id="4258727">.</span><span class="ident" id="4258728">index</span>&nbsp;<span class="op" id="4258734">-</span>&nbsp;<span class="ident" id="4258736">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258749">if</span>&nbsp;<span class="ident" id="4258752">minIndex</span>&nbsp;<span class="op" id="4258761">&lt;</span>&nbsp;<span class="num" id="4258763">0</span>&nbsp;<span class="op" id="4258765">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258770">minIndex</span>&nbsp;<span class="op" id="4258779">=</span>&nbsp;<span class="num" id="4258781">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258790">if</span>&nbsp;<span class="ident" id="4258793">d</span><span class="op" id="4258794">.</span><span class="ident" id="4258795">chainHead</span><span class="op" id="4258804">-</span><span class="ident" id="4258805">d</span><span class="op" id="4258806">.</span><span class="ident" id="4258807">hashOffset</span>&nbsp;<span class="op" id="4258818">&gt;=</span>&nbsp;<span class="ident" id="4258821">minIndex</span>&nbsp;<span class="op" id="4258830">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4258836">(</span><span class="ident" id="4258837">d</span><span class="op" id="4258838">.</span><span class="ident" id="4258839">fastSkipHashing</span>&nbsp;<span class="op" id="4258855">!=</span>&nbsp;<span class="ident" id="4258858">skipNever</span>&nbsp;<span class="op" id="4258868">&amp;&amp;</span>&nbsp;<span class="ident" id="4258871">lookahead</span>&nbsp;<span class="op" id="4258881">&gt;</span>&nbsp;<span class="ident" id="4258883">minMatchLength</span><span class="op" id="4258897">-</span><span class="num" id="4258898">1</span>&nbsp;<span class="op" id="4258900">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4258907">d</span><span class="op" id="4258908">.</span><span class="ident" id="4258909">fastSkipHashing</span>&nbsp;<span class="op" id="4258925">==</span>&nbsp;<span class="ident" id="4258928">skipNever</span>&nbsp;<span class="op" id="4258938">&amp;&amp;</span>&nbsp;<span class="ident" id="4258941">lookahead</span>&nbsp;<span class="op" id="4258951">&gt;</span>&nbsp;<span class="ident" id="4258953">prevLength</span>&nbsp;<span class="op" id="4258964">&amp;&amp;</span>&nbsp;<span class="ident" id="4258967">prevLength</span>&nbsp;<span class="op" id="4258978">&lt;</span>&nbsp;<span class="ident" id="4258980">d</span><span class="op" id="4258981">.</span><span class="ident" id="4258982">lazy</span><span class="op" id="4258986">)</span>&nbsp;<span class="op" id="4258988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4258993">if</span>&nbsp;<span class="ident" id="4258996">newLength</span><span class="op" id="4259005">,</span>&nbsp;<span class="ident" id="4259007">newOffset</span><span class="op" id="4259016">,</span>&nbsp;<span class="ident" id="4259018">ok</span>&nbsp;<span class="op" id="4259021">:=</span>&nbsp;<span class="ident" id="4259024">d</span><span class="op" id="4259025">.</span><span class="ident" id="4259026">findMatch</span><span class="op" id="4259035">(</span><span class="ident" id="4259036">d</span><span class="op" id="4259037">.</span><span class="ident" id="4259038">index</span><span class="op" id="4259043">,</span>&nbsp;<span class="ident" id="4259045">d</span><span class="op" id="4259046">.</span><span class="ident" id="4259047">chainHead</span><span class="op" id="4259056">-</span><span class="ident" id="4259057">d</span><span class="op" id="4259058">.</span><span class="ident" id="4259059">hashOffset</span><span class="op" id="4259069">,</span>&nbsp;<span class="ident" id="4259071">minMatchLength</span><span class="op" id="4259085">-</span><span class="num" id="4259086">1</span><span class="op" id="4259087">,</span>&nbsp;<span class="ident" id="4259089">lookahead</span><span class="op" id="4259098">)</span><span class="op" id="4259099">;</span>&nbsp;<span class="ident" id="4259101">ok</span>&nbsp;<span class="op" id="4259104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259110">d</span><span class="op" id="4259111">.</span><span class="ident" id="4259112">length</span>&nbsp;<span class="op" id="4259119">=</span>&nbsp;<span class="ident" id="4259121">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259135">d</span><span class="op" id="4259136">.</span><span class="ident" id="4259137">offset</span>&nbsp;<span class="op" id="4259144">=</span>&nbsp;<span class="ident" id="4259146">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259159">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259167">if</span>&nbsp;<span class="ident" id="4259170">d</span><span class="op" id="4259171">.</span><span class="ident" id="4259172">fastSkipHashing</span>&nbsp;<span class="op" id="4259188">!=</span>&nbsp;<span class="ident" id="4259191">skipNever</span>&nbsp;<span class="op" id="4259201">&amp;&amp;</span>&nbsp;<span class="ident" id="4259204">d</span><span class="op" id="4259205">.</span><span class="ident" id="4259206">length</span>&nbsp;<span class="op" id="4259213">&gt;=</span>&nbsp;<span class="ident" id="4259216">minMatchLength</span>&nbsp;<span class="op" id="4259231">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259237">d</span><span class="op" id="4259238">.</span><span class="ident" id="4259239">fastSkipHashing</span>&nbsp;<span class="op" id="4259255">==</span>&nbsp;<span class="ident" id="4259258">skipNever</span>&nbsp;<span class="op" id="4259268">&amp;&amp;</span>&nbsp;<span class="ident" id="4259271">prevLength</span>&nbsp;<span class="op" id="4259282">&gt;=</span>&nbsp;<span class="ident" id="4259285">minMatchLength</span>&nbsp;<span class="op" id="4259300">&amp;&amp;</span>&nbsp;<span class="ident" id="4259303">d</span><span class="op" id="4259304">.</span><span class="ident" id="4259305">length</span>&nbsp;<span class="op" id="4259312">&lt;=</span>&nbsp;<span class="ident" id="4259315">prevLength</span>&nbsp;<span class="op" id="4259326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259331">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259402">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259447">if</span>&nbsp;<span class="ident" id="4259450">d</span><span class="op" id="4259451">.</span><span class="ident" id="4259452">fastSkipHashing</span>&nbsp;<span class="op" id="4259468">!=</span>&nbsp;<span class="ident" id="4259471">skipNever</span>&nbsp;<span class="op" id="4259481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259487">d</span><span class="op" id="4259488">.</span><span class="ident" id="4259489">tokens</span>&nbsp;<span class="op" id="4259496">=</span>&nbsp;<span class="builtinfunc" id="4259498">append</span><span class="op" id="4259504">(</span><span class="ident" id="4259505">d</span><span class="op" id="4259506">.</span><span class="ident" id="4259507">tokens</span><span class="op" id="4259513">,</span>&nbsp;<span class="ident" id="4259515">matchToken</span><span class="op" id="4259525">(</span><span class="builtintype" id="4259526">uint32</span><span class="op" id="4259532">(</span><span class="ident" id="4259533">d</span><span class="op" id="4259534">.</span><span class="ident" id="4259535">length</span><span class="op" id="4259541">-</span><span class="ident" id="4259542">minMatchLength</span><span class="op" id="4259556">)</span><span class="op" id="4259557">,</span>&nbsp;<span class="builtintype" id="4259559">uint32</span><span class="op" id="4259565">(</span><span class="ident" id="4259566">d</span><span class="op" id="4259567">.</span><span class="ident" id="4259568">offset</span><span class="op" id="4259574">-</span><span class="ident" id="4259575">minOffsetSize</span><span class="op" id="4259588">)</span><span class="op" id="4259589">)</span><span class="op" id="4259590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259595">}</span>&nbsp;<span class="keyword" id="4259597">else</span>&nbsp;<span class="op" id="4259602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4259608">d</span><span class="op" id="4259609">.</span><span class="ident" id="4259610">tokens</span>&nbsp;<span class="op" id="4259617">=</span>&nbsp;<span class="builtinfunc" id="4259619">append</span><span class="op" id="4259625">(</span><span class="ident" id="4259626">d</span><span class="op" id="4259627">.</span><span class="ident" id="4259628">tokens</span><span class="op" id="4259634">,</span>&nbsp;<span class="ident" id="4259636">matchToken</span><span class="op" id="4259646">(</span><span class="builtintype" id="4259647">uint32</span><span class="op" id="4259653">(</span><span class="ident" id="4259654">prevLength</span><span class="op" id="4259664">-</span><span class="ident" id="4259665">minMatchLength</span><span class="op" id="4259679">)</span><span class="op" id="4259680">,</span>&nbsp;<span class="builtintype" id="4259682">uint32</span><span class="op" id="4259688">(</span><span class="ident" id="4259689">prevOffset</span><span class="op" id="4259699">-</span><span class="ident" id="4259700">minOffsetSize</span><span class="op" id="4259713">)</span><span class="op" id="4259714">)</span><span class="op" id="4259715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4259720">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259725">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259796">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259865">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4259934">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259947">if</span>&nbsp;<span class="ident" id="4259950">d</span><span class="op" id="4259951">.</span><span class="ident" id="4259952">length</span>&nbsp;<span class="op" id="4259959">&lt;=</span>&nbsp;<span class="ident" id="4259962">d</span><span class="op" id="4259963">.</span><span class="ident" id="4259964">fastSkipHashing</span>&nbsp;<span class="op" id="4259980">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4259986">var</span>&nbsp;<span class="ident" id="4259990">newIndex</span>&nbsp;<span class="builtintype" id="4259999">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260007">if</span>&nbsp;<span class="ident" id="4260010">d</span><span class="op" id="4260011">.</span><span class="ident" id="4260012">fastSkipHashing</span>&nbsp;<span class="op" id="4260028">!=</span>&nbsp;<span class="ident" id="4260031">skipNever</span>&nbsp;<span class="op" id="4260041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260048">newIndex</span>&nbsp;<span class="op" id="4260057">=</span>&nbsp;<span class="ident" id="4260059">d</span><span class="op" id="4260060">.</span><span class="ident" id="4260061">index</span>&nbsp;<span class="op" id="4260067">+</span>&nbsp;<span class="ident" id="4260069">d</span><span class="op" id="4260070">.</span><span class="ident" id="4260071">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260082">}</span>&nbsp;<span class="keyword" id="4260084">else</span>&nbsp;<span class="op" id="4260089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260096">newIndex</span>&nbsp;<span class="op" id="4260105">=</span>&nbsp;<span class="ident" id="4260107">d</span><span class="op" id="4260108">.</span><span class="ident" id="4260109">index</span>&nbsp;<span class="op" id="4260115">+</span>&nbsp;<span class="ident" id="4260117">prevLength</span>&nbsp;<span class="op" id="4260128">-</span>&nbsp;<span class="num" id="4260130">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260142">for</span>&nbsp;<span class="ident" id="4260146">d</span><span class="op" id="4260147">.</span><span class="ident" id="4260148">index</span><span class="op" id="4260153">++</span><span class="op" id="4260155">;</span>&nbsp;<span class="ident" id="4260157">d</span><span class="op" id="4260158">.</span><span class="ident" id="4260159">index</span>&nbsp;<span class="op" id="4260165">&lt;</span>&nbsp;<span class="ident" id="4260167">newIndex</span><span class="op" id="4260175">;</span>&nbsp;<span class="ident" id="4260177">d</span><span class="op" id="4260178">.</span><span class="ident" id="4260179">index</span><span class="op" id="4260184">++</span>&nbsp;<span class="op" id="4260187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260194">if</span>&nbsp;<span class="ident" id="4260197">d</span><span class="op" id="4260198">.</span><span class="ident" id="4260199">index</span>&nbsp;<span class="op" id="4260205">&lt;</span>&nbsp;<span class="ident" id="4260207">d</span><span class="op" id="4260208">.</span><span class="ident" id="4260209">maxInsertIndex</span>&nbsp;<span class="op" id="4260224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260232">d</span><span class="op" id="4260233">.</span><span class="ident" id="4260234">hash</span>&nbsp;<span class="op" id="4260239">=</span>&nbsp;<span class="op" id="4260241">(</span><span class="ident" id="4260242">d</span><span class="op" id="4260243">.</span><span class="ident" id="4260244">hash</span><span class="op" id="4260248">&lt;&lt;</span><span class="ident" id="4260250">hashShift</span>&nbsp;<span class="op" id="4260260">+</span>&nbsp;<span class="builtintype" id="4260262">int</span><span class="op" id="4260265">(</span><span class="ident" id="4260266">d</span><span class="op" id="4260267">.</span><span class="ident" id="4260268">window</span><span class="op" id="4260274">[</span><span class="ident" id="4260275">d</span><span class="op" id="4260276">.</span><span class="ident" id="4260277">index</span><span class="op" id="4260282">+</span><span class="num" id="4260283">2</span><span class="op" id="4260284">]</span><span class="op" id="4260285">)</span><span class="op" id="4260286">)</span>&nbsp;<span class="op" id="4260288">&amp;</span>&nbsp;<span class="ident" id="4260290">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260305">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260353">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260408">d</span><span class="op" id="4260409">.</span><span class="ident" id="4260410">hashPrev</span><span class="op" id="4260418">[</span><span class="ident" id="4260419">d</span><span class="op" id="4260420">.</span><span class="ident" id="4260421">index</span><span class="op" id="4260426">&amp;</span><span class="ident" id="4260427">windowMask</span><span class="op" id="4260437">]</span>&nbsp;<span class="op" id="4260439">=</span>&nbsp;<span class="ident" id="4260441">d</span><span class="op" id="4260442">.</span><span class="ident" id="4260443">hashHead</span><span class="op" id="4260451">[</span><span class="ident" id="4260452">d</span><span class="op" id="4260453">.</span><span class="ident" id="4260454">hash</span><span class="op" id="4260458">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260466">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260513">d</span><span class="op" id="4260514">.</span><span class="ident" id="4260515">hashHead</span><span class="op" id="4260523">[</span><span class="ident" id="4260524">d</span><span class="op" id="4260525">.</span><span class="ident" id="4260526">hash</span><span class="op" id="4260530">]</span>&nbsp;<span class="op" id="4260532">=</span>&nbsp;<span class="ident" id="4260534">d</span><span class="op" id="4260535">.</span><span class="ident" id="4260536">index</span>&nbsp;<span class="op" id="4260542">+</span>&nbsp;<span class="ident" id="4260544">d</span><span class="op" id="4260545">.</span><span class="ident" id="4260546">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260562">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260574">if</span>&nbsp;<span class="ident" id="4260577">d</span><span class="op" id="4260578">.</span><span class="ident" id="4260579">fastSkipHashing</span>&nbsp;<span class="op" id="4260595">==</span>&nbsp;<span class="ident" id="4260598">skipNever</span>&nbsp;<span class="op" id="4260608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260615">d</span><span class="op" id="4260616">.</span><span class="ident" id="4260617">byteAvailable</span>&nbsp;<span class="op" id="4260631">=</span>&nbsp;<span class="builtintype" id="4260633">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260644">d</span><span class="op" id="4260645">.</span><span class="ident" id="4260646">length</span>&nbsp;<span class="op" id="4260653">=</span>&nbsp;<span class="ident" id="4260655">minMatchLength</span>&nbsp;<span class="op" id="4260670">-</span>&nbsp;<span class="num" id="4260672">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260678">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260683">}</span>&nbsp;<span class="keyword" id="4260685">else</span>&nbsp;<span class="op" id="4260690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260696">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260768">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260796">d</span><span class="op" id="4260797">.</span><span class="ident" id="4260798">index</span>&nbsp;<span class="op" id="4260804">+=</span>&nbsp;<span class="ident" id="4260807">d</span><span class="op" id="4260808">.</span><span class="ident" id="4260809">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260820">if</span>&nbsp;<span class="ident" id="4260823">d</span><span class="op" id="4260824">.</span><span class="ident" id="4260825">index</span>&nbsp;<span class="op" id="4260831">&lt;</span>&nbsp;<span class="ident" id="4260833">d</span><span class="op" id="4260834">.</span><span class="ident" id="4260835">maxInsertIndex</span>&nbsp;<span class="op" id="4260850">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4260857">d</span><span class="op" id="4260858">.</span><span class="ident" id="4260859">hash</span>&nbsp;<span class="op" id="4260864">=</span>&nbsp;<span class="op" id="4260866">(</span><span class="builtintype" id="4260867">int</span><span class="op" id="4260870">(</span><span class="ident" id="4260871">d</span><span class="op" id="4260872">.</span><span class="ident" id="4260873">window</span><span class="op" id="4260879">[</span><span class="ident" id="4260880">d</span><span class="op" id="4260881">.</span><span class="ident" id="4260882">index</span><span class="op" id="4260887">]</span><span class="op" id="4260888">)</span><span class="op" id="4260889">&lt;&lt;</span><span class="ident" id="4260891">hashShift</span>&nbsp;<span class="op" id="4260901">+</span>&nbsp;<span class="builtintype" id="4260903">int</span><span class="op" id="4260906">(</span><span class="ident" id="4260907">d</span><span class="op" id="4260908">.</span><span class="ident" id="4260909">window</span><span class="op" id="4260915">[</span><span class="ident" id="4260916">d</span><span class="op" id="4260917">.</span><span class="ident" id="4260918">index</span><span class="op" id="4260923">+</span><span class="num" id="4260924">1</span><span class="op" id="4260925">]</span><span class="op" id="4260926">)</span><span class="op" id="4260927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4260938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4260943">if</span>&nbsp;<span class="builtinfunc" id="4260946">len</span><span class="op" id="4260949">(</span><span class="ident" id="4260950">d</span><span class="op" id="4260951">.</span><span class="ident" id="4260952">tokens</span><span class="op" id="4260958">)</span>&nbsp;<span class="op" id="4260960">==</span>&nbsp;<span class="ident" id="4260963">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4260983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4260989">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261037">if</span>&nbsp;<span class="ident" id="4261040">d</span><span class="op" id="4261041">.</span><span class="ident" id="4261042">err</span>&nbsp;<span class="op" id="4261046">=</span>&nbsp;<span class="ident" id="4261048">d</span><span class="op" id="4261049">.</span><span class="ident" id="4261050">writeBlock</span><span class="op" id="4261060">(</span><span class="ident" id="4261061">d</span><span class="op" id="4261062">.</span><span class="ident" id="4261063">tokens</span><span class="op" id="4261069">,</span>&nbsp;<span class="ident" id="4261071">d</span><span class="op" id="4261072">.</span><span class="ident" id="4261073">index</span><span class="op" id="4261078">,</span>&nbsp;<span class="builtintype" id="4261080">false</span><span class="op" id="4261085">)</span><span class="op" id="4261086">;</span>&nbsp;<span class="ident" id="4261088">d</span><span class="op" id="4261089">.</span><span class="ident" id="4261090">err</span>&nbsp;<span class="op" id="4261094">!=</span>&nbsp;<span class="ident" id="4261097">nil</span>&nbsp;<span class="op" id="4261101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261108">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261125">d</span><span class="op" id="4261126">.</span><span class="ident" id="4261127">tokens</span>&nbsp;<span class="op" id="4261134">=</span>&nbsp;<span class="ident" id="4261136">d</span><span class="op" id="4261137">.</span><span class="ident" id="4261138">tokens</span><span class="op" id="4261144">[</span><span class="op" id="4261145">:</span><span class="num" id="4261146">0</span><span class="op" id="4261147">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261152">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261156">}</span>&nbsp;<span class="keyword" id="4261158">else</span>&nbsp;<span class="op" id="4261163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261168">if</span>&nbsp;<span class="ident" id="4261171">d</span><span class="op" id="4261172">.</span><span class="ident" id="4261173">fastSkipHashing</span>&nbsp;<span class="op" id="4261189">!=</span>&nbsp;<span class="ident" id="4261192">skipNever</span>&nbsp;<span class="op" id="4261202">||</span>&nbsp;<span class="ident" id="4261205">d</span><span class="op" id="4261206">.</span><span class="ident" id="4261207">byteAvailable</span>&nbsp;<span class="op" id="4261221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261227">i</span>&nbsp;<span class="op" id="4261229">:=</span>&nbsp;<span class="ident" id="4261232">d</span><span class="op" id="4261233">.</span><span class="ident" id="4261234">index</span>&nbsp;<span class="op" id="4261240">-</span>&nbsp;<span class="num" id="4261242">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261248">if</span>&nbsp;<span class="ident" id="4261251">d</span><span class="op" id="4261252">.</span><span class="ident" id="4261253">fastSkipHashing</span>&nbsp;<span class="op" id="4261269">!=</span>&nbsp;<span class="ident" id="4261272">skipNever</span>&nbsp;<span class="op" id="4261282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261289">i</span>&nbsp;<span class="op" id="4261291">=</span>&nbsp;<span class="ident" id="4261293">d</span><span class="op" id="4261294">.</span><span class="ident" id="4261295">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261311">d</span><span class="op" id="4261312">.</span><span class="ident" id="4261313">tokens</span>&nbsp;<span class="op" id="4261320">=</span>&nbsp;<span class="builtinfunc" id="4261322">append</span><span class="op" id="4261328">(</span><span class="ident" id="4261329">d</span><span class="op" id="4261330">.</span><span class="ident" id="4261331">tokens</span><span class="op" id="4261337">,</span>&nbsp;<span class="ident" id="4261339">literalToken</span><span class="op" id="4261351">(</span><span class="builtintype" id="4261352">uint32</span><span class="op" id="4261358">(</span><span class="ident" id="4261359">d</span><span class="op" id="4261360">.</span><span class="ident" id="4261361">window</span><span class="op" id="4261367">[</span><span class="ident" id="4261368">i</span><span class="op" id="4261369">]</span><span class="op" id="4261370">)</span><span class="op" id="4261371">)</span><span class="op" id="4261372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261378">if</span>&nbsp;<span class="builtinfunc" id="4261381">len</span><span class="op" id="4261384">(</span><span class="ident" id="4261385">d</span><span class="op" id="4261386">.</span><span class="ident" id="4261387">tokens</span><span class="op" id="4261393">)</span>&nbsp;<span class="op" id="4261395">==</span>&nbsp;<span class="ident" id="4261398">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4261418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261425">if</span>&nbsp;<span class="ident" id="4261428">d</span><span class="op" id="4261429">.</span><span class="ident" id="4261430">err</span>&nbsp;<span class="op" id="4261434">=</span>&nbsp;<span class="ident" id="4261436">d</span><span class="op" id="4261437">.</span><span class="ident" id="4261438">writeBlock</span><span class="op" id="4261448">(</span><span class="ident" id="4261449">d</span><span class="op" id="4261450">.</span><span class="ident" id="4261451">tokens</span><span class="op" id="4261457">,</span>&nbsp;<span class="ident" id="4261459">i</span><span class="op" id="4261460">+</span><span class="num" id="4261461">1</span><span class="op" id="4261462">,</span>&nbsp;<span class="builtintype" id="4261464">false</span><span class="op" id="4261469">)</span><span class="op" id="4261470">;</span>&nbsp;<span class="ident" id="4261472">d</span><span class="op" id="4261473">.</span><span class="ident" id="4261474">err</span>&nbsp;<span class="op" id="4261478">!=</span>&nbsp;<span class="ident" id="4261481">nil</span>&nbsp;<span class="op" id="4261485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261493">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261512">d</span><span class="op" id="4261513">.</span><span class="ident" id="4261514">tokens</span>&nbsp;<span class="op" id="4261521">=</span>&nbsp;<span class="ident" id="4261523">d</span><span class="op" id="4261524">.</span><span class="ident" id="4261525">tokens</span><span class="op" id="4261531">[</span><span class="op" id="4261532">:</span><span class="num" id="4261533">0</span><span class="op" id="4261534">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261550">d</span><span class="op" id="4261551">.</span><span class="ident" id="4261552">index</span><span class="op" id="4261557">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261563">if</span>&nbsp;<span class="ident" id="4261566">d</span><span class="op" id="4261567">.</span><span class="ident" id="4261568">fastSkipHashing</span>&nbsp;<span class="op" id="4261584">==</span>&nbsp;<span class="ident" id="4261587">skipNever</span>&nbsp;<span class="op" id="4261597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261603">d</span><span class="op" id="4261604">.</span><span class="ident" id="4261605">byteAvailable</span>&nbsp;<span class="op" id="4261619">=</span>&nbsp;<span class="builtintype" id="4261621">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261636">}</span><br>
<span class="lineno">360</span><span class="op" id="4261638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4261641">func</span>&nbsp;<span class="op" id="4261646">(</span><span class="ident" id="4261647">d</span>&nbsp;<span class="op" id="4261649">*</span><span class="ident" id="4261650">compressor</span><span class="op" id="4261660">)</span>&nbsp;<span class="ident" id="4261662">fillStore</span><span class="op" id="4261671">(</span><span class="ident" id="4261672">b</span>&nbsp;<span class="op" id="4261674">[</span><span class="op" id="4261675">]</span><span class="builtintype" id="4261676">byte</span><span class="op" id="4261680">)</span>&nbsp;<span class="builtintype" id="4261682">int</span>&nbsp;<span class="op" id="4261686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261689">n</span>&nbsp;<span class="op" id="4261691">:=</span>&nbsp;<span class="builtinfunc" id="4261694">copy</span><span class="op" id="4261698">(</span><span class="ident" id="4261699">d</span><span class="op" id="4261700">.</span><span class="ident" id="4261701">window</span><span class="op" id="4261707">[</span><span class="ident" id="4261708">d</span><span class="op" id="4261709">.</span><span class="ident" id="4261710">windowEnd</span><span class="op" id="4261719">:</span><span class="op" id="4261720">]</span><span class="op" id="4261721">,</span>&nbsp;<span class="ident" id="4261723">b</span><span class="op" id="4261724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261727">d</span><span class="op" id="4261728">.</span><span class="ident" id="4261729">windowEnd</span>&nbsp;<span class="op" id="4261739">+=</span>&nbsp;<span class="ident" id="4261742">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261745">return</span>&nbsp;<span class="ident" id="4261752">n</span><br>
<span class="lineno"></span><span class="op" id="4261754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4261757">func</span>&nbsp;<span class="op" id="4261762">(</span><span class="ident" id="4261763">d</span>&nbsp;<span class="op" id="4261765">*</span><span class="ident" id="4261766">compressor</span><span class="op" id="4261776">)</span>&nbsp;<span class="ident" id="4261778">store</span><span class="op" id="4261783">(</span><span class="op" id="4261784">)</span>&nbsp;<span class="op" id="4261786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261789">if</span>&nbsp;<span class="ident" id="4261792">d</span><span class="op" id="4261793">.</span><span class="ident" id="4261794">windowEnd</span>&nbsp;<span class="op" id="4261804">&gt;</span>&nbsp;<span class="num" id="4261806">0</span>&nbsp;<span class="op" id="4261808">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261812">d</span><span class="op" id="4261813">.</span><span class="ident" id="4261814">err</span>&nbsp;<span class="op" id="4261818">=</span>&nbsp;<span class="ident" id="4261820">d</span><span class="op" id="4261821">.</span><span class="ident" id="4261822">writeStoredBlock</span><span class="op" id="4261838">(</span><span class="ident" id="4261839">d</span><span class="op" id="4261840">.</span><span class="ident" id="4261841">window</span><span class="op" id="4261847">[</span><span class="op" id="4261848">:</span><span class="ident" id="4261849">d</span><span class="op" id="4261850">.</span><span class="ident" id="4261851">windowEnd</span><span class="op" id="4261860">]</span><span class="op" id="4261861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4261864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261867">d</span><span class="op" id="4261868">.</span><span class="ident" id="4261869">windowEnd</span>&nbsp;<span class="op" id="4261879">=</span>&nbsp;<span class="num" id="4261881">0</span><br>
<span class="lineno"></span><span class="op" id="4261883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4261886">func</span>&nbsp;<span class="op" id="4261891">(</span><span class="ident" id="4261892">d</span>&nbsp;<span class="op" id="4261894">*</span><span class="ident" id="4261895">compressor</span><span class="op" id="4261905">)</span>&nbsp;<span class="ident" id="4261907">write</span><span class="op" id="4261912">(</span><span class="ident" id="4261913">b</span>&nbsp;<span class="op" id="4261915">[</span><span class="op" id="4261916">]</span><span class="builtintype" id="4261917">byte</span><span class="op" id="4261921">)</span>&nbsp;<span class="op" id="4261923">(</span><span class="ident" id="4261924">n</span>&nbsp;<span class="builtintype" id="4261926">int</span><span class="op" id="4261929">,</span>&nbsp;<span class="ident" id="4261931">err</span>&nbsp;<span class="builtintype" id="4261935">error</span><span class="op" id="4261940">)</span>&nbsp;<span class="op" id="4261942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261945">n</span>&nbsp;<span class="op" id="4261947">=</span>&nbsp;<span class="builtinfunc" id="4261949">len</span><span class="op" id="4261952">(</span><span class="ident" id="4261953">b</span><span class="op" id="4261954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261957">b</span>&nbsp;<span class="op" id="4261959">=</span>&nbsp;<span class="ident" id="4261961">b</span><span class="op" id="4261962">[</span><span class="ident" id="4261963">d</span><span class="op" id="4261964">.</span><span class="ident" id="4261965">fill</span><span class="op" id="4261969">(</span><span class="ident" id="4261970">d</span><span class="op" id="4261971">,</span>&nbsp;<span class="ident" id="4261973">b</span><span class="op" id="4261974">)</span><span class="op" id="4261975">:</span><span class="op" id="4261976">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4261979">for</span>&nbsp;<span class="builtinfunc" id="4261983">len</span><span class="op" id="4261986">(</span><span class="ident" id="4261987">b</span><span class="op" id="4261988">)</span>&nbsp;<span class="op" id="4261990">&gt;</span>&nbsp;<span class="num" id="4261992">0</span>&nbsp;<span class="op" id="4261994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4261998">d</span><span class="op" id="4261999">.</span><span class="ident" id="4262000">step</span><span class="op" id="4262004">(</span><span class="ident" id="4262005">d</span><span class="op" id="4262006">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262010">b</span>&nbsp;<span class="op" id="4262012">=</span>&nbsp;<span class="ident" id="4262014">b</span><span class="op" id="4262015">[</span><span class="ident" id="4262016">d</span><span class="op" id="4262017">.</span><span class="ident" id="4262018">fill</span><span class="op" id="4262022">(</span><span class="ident" id="4262023">d</span><span class="op" id="4262024">,</span>&nbsp;<span class="ident" id="4262026">b</span><span class="op" id="4262027">)</span><span class="op" id="4262028">:</span><span class="op" id="4262029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4262032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262035">return</span>&nbsp;<span class="ident" id="4262042">n</span><span class="op" id="4262043">,</span>&nbsp;<span class="ident" id="4262045">d</span><span class="op" id="4262046">.</span><span class="ident" id="4262047">err</span><br>
<span class="lineno"></span><span class="op" id="4262051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4262054">func</span>&nbsp;<span class="op" id="4262059">(</span><span class="ident" id="4262060">d</span>&nbsp;<span class="op" id="4262062">*</span><span class="ident" id="4262063">compressor</span><span class="op" id="4262073">)</span>&nbsp;<span class="ident" id="4262075">syncFlush</span><span class="op" id="4262084">(</span><span class="op" id="4262085">)</span>&nbsp;<span class="builtintype" id="4262087">error</span>&nbsp;<span class="op" id="4262093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262096">d</span><span class="op" id="4262097">.</span><span class="ident" id="4262098">sync</span>&nbsp;<span class="op" id="4262103">=</span>&nbsp;<span class="builtintype" id="4262105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262111">d</span><span class="op" id="4262112">.</span><span class="ident" id="4262113">step</span><span class="op" id="4262117">(</span><span class="ident" id="4262118">d</span><span class="op" id="4262119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262122">if</span>&nbsp;<span class="ident" id="4262125">d</span><span class="op" id="4262126">.</span><span class="ident" id="4262127">err</span>&nbsp;<span class="op" id="4262131">==</span>&nbsp;<span class="ident" id="4262134">nil</span>&nbsp;<span class="op" id="4262138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262142">d</span><span class="op" id="4262143">.</span><span class="ident" id="4262144">w</span><span class="op" id="4262145">.</span><span class="ident" id="4262146">writeStoredHeader</span><span class="op" id="4262163">(</span><span class="num" id="4262164">0</span><span class="op" id="4262165">,</span>&nbsp;<span class="builtintype" id="4262167">false</span><span class="op" id="4262172">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262176">d</span><span class="op" id="4262177">.</span><span class="ident" id="4262178">w</span><span class="op" id="4262179">.</span><span class="ident" id="4262180">flush</span><span class="op" id="4262185">(</span><span class="op" id="4262186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262190">d</span><span class="op" id="4262191">.</span><span class="ident" id="4262192">err</span>&nbsp;<span class="op" id="4262196">=</span>&nbsp;<span class="ident" id="4262198">d</span><span class="op" id="4262199">.</span><span class="ident" id="4262200">w</span><span class="op" id="4262201">.</span><span class="ident" id="4262202">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4262207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262210">d</span><span class="op" id="4262211">.</span><span class="ident" id="4262212">sync</span>&nbsp;<span class="op" id="4262217">=</span>&nbsp;<span class="builtintype" id="4262219">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262226">return</span>&nbsp;<span class="ident" id="4262233">d</span><span class="op" id="4262234">.</span><span class="ident" id="4262235">err</span><br>
<span class="lineno">395</span><span class="op" id="4262239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4262242">func</span>&nbsp;<span class="op" id="4262247">(</span><span class="ident" id="4262248">d</span>&nbsp;<span class="op" id="4262250">*</span><span class="ident" id="4262251">compressor</span><span class="op" id="4262261">)</span>&nbsp;<span class="ident" id="4262263">init</span><span class="op" id="4262267">(</span><span class="ident" id="4262268">w</span>&nbsp;<span class="ident" id="4262270">io</span><span class="op" id="4262272">.</span><span class="ident" id="4262273">Writer</span><span class="op" id="4262279">,</span>&nbsp;<span class="ident" id="4262281">level</span>&nbsp;<span class="builtintype" id="4262287">int</span><span class="op" id="4262290">)</span>&nbsp;<span class="op" id="4262292">(</span><span class="ident" id="4262293">err</span>&nbsp;<span class="builtintype" id="4262297">error</span><span class="op" id="4262302">)</span>&nbsp;<span class="op" id="4262304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262307">d</span><span class="op" id="4262308">.</span><span class="ident" id="4262309">w</span>&nbsp;<span class="op" id="4262311">=</span>&nbsp;<span class="ident" id="4262313">newHuffmanBitWriter</span><span class="op" id="4262332">(</span><span class="ident" id="4262333">w</span><span class="op" id="4262334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262338">switch</span>&nbsp;<span class="op" id="4262345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262348">case</span>&nbsp;<span class="ident" id="4262353">level</span>&nbsp;<span class="op" id="4262359">==</span>&nbsp;<span class="ident" id="4262362">NoCompression</span><span class="op" id="4262375">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262379">d</span><span class="op" id="4262380">.</span><span class="ident" id="4262381">window</span>&nbsp;<span class="op" id="4262388">=</span>&nbsp;<span class="builtinfunc" id="4262390">make</span><span class="op" id="4262394">(</span><span class="op" id="4262395">[</span><span class="op" id="4262396">]</span><span class="builtintype" id="4262397">byte</span><span class="op" id="4262401">,</span>&nbsp;<span class="ident" id="4262403">maxStoreBlockSize</span><span class="op" id="4262420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262424">d</span><span class="op" id="4262425">.</span><span class="ident" id="4262426">fill</span>&nbsp;<span class="op" id="4262431">=</span>&nbsp;<span class="op" id="4262433">(</span><span class="op" id="4262434">*</span><span class="ident" id="4262435">compressor</span><span class="op" id="4262445">)</span><span class="op" id="4262446">.</span><span class="ident" id="4262447">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262459">d</span><span class="op" id="4262460">.</span><span class="ident" id="4262461">step</span>&nbsp;<span class="op" id="4262466">=</span>&nbsp;<span class="op" id="4262468">(</span><span class="op" id="4262469">*</span><span class="ident" id="4262470">compressor</span><span class="op" id="4262480">)</span><span class="op" id="4262481">.</span><span class="ident" id="4262482">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262489">case</span>&nbsp;<span class="ident" id="4262494">level</span>&nbsp;<span class="op" id="4262500">==</span>&nbsp;<span class="ident" id="4262503">DefaultCompression</span><span class="op" id="4262521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262525">level</span>&nbsp;<span class="op" id="4262531">=</span>&nbsp;<span class="num" id="4262533">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262537">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262550">case</span>&nbsp;<span class="num" id="4262555">1</span>&nbsp;<span class="op" id="4262557">&lt;=</span>&nbsp;<span class="ident" id="4262560">level</span>&nbsp;<span class="op" id="4262566">&amp;&amp;</span>&nbsp;<span class="ident" id="4262569">level</span>&nbsp;<span class="op" id="4262575">&lt;=</span>&nbsp;<span class="num" id="4262578">9</span><span class="op" id="4262579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262583">d</span><span class="op" id="4262584">.</span><span class="ident" id="4262585">compressionLevel</span>&nbsp;<span class="op" id="4262602">=</span>&nbsp;<span class="ident" id="4262604">levels</span><span class="op" id="4262610">[</span><span class="ident" id="4262611">level</span><span class="op" id="4262616">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262620">d</span><span class="op" id="4262621">.</span><span class="ident" id="4262622">initDeflate</span><span class="op" id="4262633">(</span><span class="op" id="4262634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262638">d</span><span class="op" id="4262639">.</span><span class="ident" id="4262640">fill</span>&nbsp;<span class="op" id="4262645">=</span>&nbsp;<span class="op" id="4262647">(</span><span class="op" id="4262648">*</span><span class="ident" id="4262649">compressor</span><span class="op" id="4262659">)</span><span class="op" id="4262660">.</span><span class="ident" id="4262661">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262675">d</span><span class="op" id="4262676">.</span><span class="ident" id="4262677">step</span>&nbsp;<span class="op" id="4262682">=</span>&nbsp;<span class="op" id="4262684">(</span><span class="op" id="4262685">*</span><span class="ident" id="4262686">compressor</span><span class="op" id="4262696">)</span><span class="op" id="4262697">.</span><span class="ident" id="4262698">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262707">default</span><span class="op" id="4262714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262718">return</span>&nbsp;<span class="ident" id="4262725">fmt</span><span class="op" id="4262728">.</span><span class="ident" id="4262729">Errorf</span><span class="op" id="4262735">(</span><span class="string" id="4262736">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4262802">,</span>&nbsp;<span class="ident" id="4262804">level</span><span class="op" id="4262809">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4262812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262815">return</span>&nbsp;<span class="ident" id="4262822">nil</span><br>
<span class="lineno"></span><span class="op" id="4262826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4262829">var</span>&nbsp;<span class="ident" id="4262833">zeroes</span>&nbsp;<span class="op" id="4262840">[</span><span class="num" id="4262841">32</span><span class="op" id="4262843">]</span><span class="builtintype" id="4262844">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4262848">var</span>&nbsp;<span class="ident" id="4262852">bzeroes</span>&nbsp;<span class="op" id="4262860">[</span><span class="num" id="4262861">256</span><span class="op" id="4262864">]</span><span class="builtintype" id="4262865">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4262871">func</span>&nbsp;<span class="op" id="4262876">(</span><span class="ident" id="4262877">d</span>&nbsp;<span class="op" id="4262879">*</span><span class="ident" id="4262880">compressor</span><span class="op" id="4262890">)</span>&nbsp;<span class="ident" id="4262892">reset</span><span class="op" id="4262897">(</span><span class="ident" id="4262898">w</span>&nbsp;<span class="ident" id="4262900">io</span><span class="op" id="4262902">.</span><span class="ident" id="4262903">Writer</span><span class="op" id="4262909">)</span>&nbsp;<span class="op" id="4262911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262914">d</span><span class="op" id="4262915">.</span><span class="ident" id="4262916">w</span><span class="op" id="4262917">.</span><span class="ident" id="4262918">reset</span><span class="op" id="4262923">(</span><span class="ident" id="4262924">w</span><span class="op" id="4262925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262928">d</span><span class="op" id="4262929">.</span><span class="ident" id="4262930">sync</span>&nbsp;<span class="op" id="4262935">=</span>&nbsp;<span class="builtintype" id="4262937">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4262944">d</span><span class="op" id="4262945">.</span><span class="ident" id="4262946">err</span>&nbsp;<span class="op" id="4262950">=</span>&nbsp;<span class="ident" id="4262952">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262957">switch</span>&nbsp;<span class="ident" id="4262964">d</span><span class="op" id="4262965">.</span><span class="ident" id="4262966">compressionLevel</span><span class="op" id="4262982">.</span><span class="ident" id="4262983">chain</span>&nbsp;<span class="op" id="4262989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4262992">case</span>&nbsp;<span class="num" id="4262997">0</span><span class="op" id="4262998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4263002">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263032">for</span>&nbsp;<span class="ident" id="4263036">i</span>&nbsp;<span class="op" id="4263038">:=</span>&nbsp;<span class="keyword" id="4263041">range</span>&nbsp;<span class="ident" id="4263047">d</span><span class="op" id="4263048">.</span><span class="ident" id="4263049">window</span>&nbsp;<span class="op" id="4263056">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263061">d</span><span class="op" id="4263062">.</span><span class="ident" id="4263063">window</span><span class="op" id="4263069">[</span><span class="ident" id="4263070">i</span><span class="op" id="4263071">]</span>&nbsp;<span class="op" id="4263073">=</span>&nbsp;<span class="num" id="4263075">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263083">d</span><span class="op" id="4263084">.</span><span class="ident" id="4263085">windowEnd</span>&nbsp;<span class="op" id="4263095">=</span>&nbsp;<span class="num" id="4263097">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263100">default</span><span class="op" id="4263107">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263111">d</span><span class="op" id="4263112">.</span><span class="ident" id="4263113">chainHead</span>&nbsp;<span class="op" id="4263123">=</span>&nbsp;<span class="op" id="4263125">-</span><span class="num" id="4263126">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263130">for</span>&nbsp;<span class="ident" id="4263134">s</span>&nbsp;<span class="op" id="4263136">:=</span>&nbsp;<span class="ident" id="4263139">d</span><span class="op" id="4263140">.</span><span class="ident" id="4263141">hashHead</span><span class="op" id="4263149">;</span>&nbsp;<span class="builtinfunc" id="4263151">len</span><span class="op" id="4263154">(</span><span class="ident" id="4263155">s</span><span class="op" id="4263156">)</span>&nbsp;<span class="op" id="4263158">&gt;</span>&nbsp;<span class="num" id="4263160">0</span><span class="op" id="4263161">;</span>&nbsp;<span class="op" id="4263163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263168">n</span>&nbsp;<span class="op" id="4263170">:=</span>&nbsp;<span class="builtinfunc" id="4263173">copy</span><span class="op" id="4263177">(</span><span class="ident" id="4263178">s</span><span class="op" id="4263179">,</span>&nbsp;<span class="ident" id="4263181">zeroes</span><span class="op" id="4263187">[</span><span class="op" id="4263188">:</span><span class="op" id="4263189">]</span><span class="op" id="4263190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263195">s</span>&nbsp;<span class="op" id="4263197">=</span>&nbsp;<span class="ident" id="4263199">s</span><span class="op" id="4263200">[</span><span class="ident" id="4263201">n</span><span class="op" id="4263202">:</span><span class="op" id="4263203">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263211">for</span>&nbsp;<span class="ident" id="4263215">s</span>&nbsp;<span class="op" id="4263217">:=</span>&nbsp;<span class="ident" id="4263220">d</span><span class="op" id="4263221">.</span><span class="ident" id="4263222">hashPrev</span><span class="op" id="4263230">;</span>&nbsp;<span class="builtinfunc" id="4263232">len</span><span class="op" id="4263235">(</span><span class="ident" id="4263236">s</span><span class="op" id="4263237">)</span>&nbsp;<span class="op" id="4263239">&gt;</span>&nbsp;<span class="num" id="4263241">0</span><span class="op" id="4263242">;</span>&nbsp;<span class="ident" id="4263244">s</span>&nbsp;<span class="op" id="4263246">=</span>&nbsp;<span class="ident" id="4263248">s</span><span class="op" id="4263249">[</span><span class="builtinfunc" id="4263250">len</span><span class="op" id="4263253">(</span><span class="ident" id="4263254">zeroes</span><span class="op" id="4263260">)</span><span class="op" id="4263261">:</span><span class="op" id="4263262">]</span>&nbsp;<span class="op" id="4263264">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4263269">copy</span><span class="op" id="4263273">(</span><span class="ident" id="4263274">s</span><span class="op" id="4263275">,</span>&nbsp;<span class="ident" id="4263277">zeroes</span><span class="op" id="4263283">[</span><span class="op" id="4263284">:</span><span class="op" id="4263285">]</span><span class="op" id="4263286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263294">d</span><span class="op" id="4263295">.</span><span class="ident" id="4263296">hashOffset</span>&nbsp;<span class="op" id="4263307">=</span>&nbsp;<span class="num" id="4263309">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263314">d</span><span class="op" id="4263315">.</span><span class="ident" id="4263316">index</span><span class="op" id="4263321">,</span>&nbsp;<span class="ident" id="4263323">d</span><span class="op" id="4263324">.</span><span class="ident" id="4263325">windowEnd</span>&nbsp;<span class="op" id="4263335">=</span>&nbsp;<span class="num" id="4263337">0</span><span class="op" id="4263338">,</span>&nbsp;<span class="num" id="4263340">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263344">for</span>&nbsp;<span class="ident" id="4263348">s</span>&nbsp;<span class="op" id="4263350">:=</span>&nbsp;<span class="ident" id="4263353">d</span><span class="op" id="4263354">.</span><span class="ident" id="4263355">window</span><span class="op" id="4263361">;</span>&nbsp;<span class="builtinfunc" id="4263363">len</span><span class="op" id="4263366">(</span><span class="ident" id="4263367">s</span><span class="op" id="4263368">)</span>&nbsp;<span class="op" id="4263370">&gt;</span>&nbsp;<span class="num" id="4263372">0</span><span class="op" id="4263373">;</span>&nbsp;<span class="op" id="4263375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263380">n</span>&nbsp;<span class="op" id="4263382">:=</span>&nbsp;<span class="builtinfunc" id="4263385">copy</span><span class="op" id="4263389">(</span><span class="ident" id="4263390">s</span><span class="op" id="4263391">,</span>&nbsp;<span class="ident" id="4263393">bzeroes</span><span class="op" id="4263400">[</span><span class="op" id="4263401">:</span><span class="op" id="4263402">]</span><span class="op" id="4263403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263408">s</span>&nbsp;<span class="op" id="4263410">=</span>&nbsp;<span class="ident" id="4263412">s</span><span class="op" id="4263413">[</span><span class="ident" id="4263414">n</span><span class="op" id="4263415">:</span><span class="op" id="4263416">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263424">d</span><span class="op" id="4263425">.</span><span class="ident" id="4263426">blockStart</span><span class="op" id="4263436">,</span>&nbsp;<span class="ident" id="4263438">d</span><span class="op" id="4263439">.</span><span class="ident" id="4263440">byteAvailable</span>&nbsp;<span class="op" id="4263454">=</span>&nbsp;<span class="num" id="4263456">0</span><span class="op" id="4263457">,</span>&nbsp;<span class="builtintype" id="4263459">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263468">d</span><span class="op" id="4263469">.</span><span class="ident" id="4263470">tokens</span>&nbsp;<span class="op" id="4263477">=</span>&nbsp;<span class="ident" id="4263479">d</span><span class="op" id="4263480">.</span><span class="ident" id="4263481">tokens</span><span class="op" id="4263487">[</span><span class="op" id="4263488">:</span><span class="ident" id="4263489">maxFlateBlockTokens</span><span class="op" id="4263508">+</span><span class="num" id="4263509">1</span><span class="op" id="4263510">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263514">for</span>&nbsp;<span class="ident" id="4263518">i</span>&nbsp;<span class="op" id="4263520">:=</span>&nbsp;<span class="num" id="4263523">0</span><span class="op" id="4263524">;</span>&nbsp;<span class="ident" id="4263526">i</span>&nbsp;<span class="op" id="4263528">&lt;=</span>&nbsp;<span class="ident" id="4263531">maxFlateBlockTokens</span><span class="op" id="4263550">;</span>&nbsp;<span class="ident" id="4263552">i</span><span class="op" id="4263553">++</span>&nbsp;<span class="op" id="4263556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263561">d</span><span class="op" id="4263562">.</span><span class="ident" id="4263563">tokens</span><span class="op" id="4263569">[</span><span class="ident" id="4263570">i</span><span class="op" id="4263571">]</span>&nbsp;<span class="op" id="4263573">=</span>&nbsp;<span class="num" id="4263575">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263579">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263583">d</span><span class="op" id="4263584">.</span><span class="ident" id="4263585">tokens</span>&nbsp;<span class="op" id="4263592">=</span>&nbsp;<span class="ident" id="4263594">d</span><span class="op" id="4263595">.</span><span class="ident" id="4263596">tokens</span><span class="op" id="4263602">[</span><span class="op" id="4263603">:</span><span class="num" id="4263604">0</span><span class="op" id="4263605">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263609">d</span><span class="op" id="4263610">.</span><span class="ident" id="4263611">length</span>&nbsp;<span class="op" id="4263618">=</span>&nbsp;<span class="ident" id="4263620">minMatchLength</span>&nbsp;<span class="op" id="4263635">-</span>&nbsp;<span class="num" id="4263637">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263641">d</span><span class="op" id="4263642">.</span><span class="ident" id="4263643">offset</span>&nbsp;<span class="op" id="4263650">=</span>&nbsp;<span class="num" id="4263652">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263656">d</span><span class="op" id="4263657">.</span><span class="ident" id="4263658">hash</span>&nbsp;<span class="op" id="4263663">=</span>&nbsp;<span class="num" id="4263665">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263669">d</span><span class="op" id="4263670">.</span><span class="ident" id="4263671">maxInsertIndex</span>&nbsp;<span class="op" id="4263686">=</span>&nbsp;<span class="num" id="4263688">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263691">}</span><br>
<span class="lineno"></span><span class="op" id="4263693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4263696">func</span>&nbsp;<span class="op" id="4263701">(</span><span class="ident" id="4263702">d</span>&nbsp;<span class="op" id="4263704">*</span><span class="ident" id="4263705">compressor</span><span class="op" id="4263715">)</span>&nbsp;<span class="builtinfunc" id="4263717">close</span><span class="op" id="4263722">(</span><span class="op" id="4263723">)</span>&nbsp;<span class="builtintype" id="4263725">error</span>&nbsp;<span class="op" id="4263731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263734">d</span><span class="op" id="4263735">.</span><span class="ident" id="4263736">sync</span>&nbsp;<span class="op" id="4263741">=</span>&nbsp;<span class="builtintype" id="4263743">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263749">d</span><span class="op" id="4263750">.</span><span class="ident" id="4263751">step</span><span class="op" id="4263755">(</span><span class="ident" id="4263756">d</span><span class="op" id="4263757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263760">if</span>&nbsp;<span class="ident" id="4263763">d</span><span class="op" id="4263764">.</span><span class="ident" id="4263765">err</span>&nbsp;<span class="op" id="4263769">!=</span>&nbsp;<span class="ident" id="4263772">nil</span>&nbsp;<span class="op" id="4263776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263780">return</span>&nbsp;<span class="ident" id="4263787">d</span><span class="op" id="4263788">.</span><span class="ident" id="4263789">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263797">if</span>&nbsp;<span class="ident" id="4263800">d</span><span class="op" id="4263801">.</span><span class="ident" id="4263802">w</span><span class="op" id="4263803">.</span><span class="ident" id="4263804">writeStoredHeader</span><span class="op" id="4263821">(</span><span class="num" id="4263822">0</span><span class="op" id="4263823">,</span>&nbsp;<span class="builtintype" id="4263825">true</span><span class="op" id="4263829">)</span><span class="op" id="4263830">;</span>&nbsp;<span class="ident" id="4263832">d</span><span class="op" id="4263833">.</span><span class="ident" id="4263834">w</span><span class="op" id="4263835">.</span><span class="ident" id="4263836">err</span>&nbsp;<span class="op" id="4263840">!=</span>&nbsp;<span class="ident" id="4263843">nil</span>&nbsp;<span class="op" id="4263847">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263851">return</span>&nbsp;<span class="ident" id="4263858">d</span><span class="op" id="4263859">.</span><span class="ident" id="4263860">w</span><span class="op" id="4263861">.</span><span class="ident" id="4263862">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4263867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4263870">d</span><span class="op" id="4263871">.</span><span class="ident" id="4263872">w</span><span class="op" id="4263873">.</span><span class="ident" id="4263874">flush</span><span class="op" id="4263879">(</span><span class="op" id="4263880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4263883">return</span>&nbsp;<span class="ident" id="4263890">d</span><span class="op" id="4263891">.</span><span class="ident" id="4263892">w</span><span class="op" id="4263893">.</span><span class="ident" id="4263894">err</span><br>
<span class="lineno"></span><span class="op" id="4263898">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4263901">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4263972">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4264047">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4264112">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4264182">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4264259">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4264281">//</span><br>
<span class="lineno"></span><span class="comment" id="4264284">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4264357">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4264406">func</span>&nbsp;<span class="ident" id="4264411">NewWriter</span><span class="op" id="4264420">(</span><span class="ident" id="4264421">w</span>&nbsp;<span class="ident" id="4264423">io</span><span class="op" id="4264425">.</span><span class="ident" id="4264426">Writer</span><span class="op" id="4264432">,</span>&nbsp;<span class="ident" id="4264434">level</span>&nbsp;<span class="builtintype" id="4264440">int</span><span class="op" id="4264443">)</span>&nbsp;<span class="op" id="4264445">(</span><span class="op" id="4264446">*</span><span class="ident" id="4264447">Writer</span><span class="op" id="4264453">,</span>&nbsp;<span class="builtintype" id="4264455">error</span><span class="op" id="4264460">)</span>&nbsp;<span class="op" id="4264462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4264465">var</span>&nbsp;<span class="ident" id="4264469">dw</span>&nbsp;<span class="ident" id="4264472">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4264480">if</span>&nbsp;<span class="ident" id="4264483">err</span>&nbsp;<span class="op" id="4264487">:=</span>&nbsp;<span class="ident" id="4264490">dw</span><span class="op" id="4264492">.</span><span class="ident" id="4264493">d</span><span class="op" id="4264494">.</span><span class="ident" id="4264495">init</span><span class="op" id="4264499">(</span><span class="ident" id="4264500">w</span><span class="op" id="4264501">,</span>&nbsp;<span class="ident" id="4264503">level</span><span class="op" id="4264508">)</span><span class="op" id="4264509">;</span>&nbsp;<span class="ident" id="4264511">err</span>&nbsp;<span class="op" id="4264515">!=</span>&nbsp;<span class="ident" id="4264518">nil</span>&nbsp;<span class="op" id="4264522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4264526">return</span>&nbsp;<span class="ident" id="4264533">nil</span><span class="op" id="4264536">,</span>&nbsp;<span class="ident" id="4264538">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4264543">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4264546">return</span>&nbsp;<span class="op" id="4264553">&amp;</span><span class="ident" id="4264554">dw</span><span class="op" id="4264556">,</span>&nbsp;<span class="ident" id="4264558">nil</span><br>
<span class="lineno"></span><span class="op" id="4264562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4264565">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4264624">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4264689">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4264754">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4264814">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4264875">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4264895">func</span>&nbsp;<span class="ident" id="4264900">NewWriterDict</span><span class="op" id="4264913">(</span><span class="ident" id="4264914">w</span>&nbsp;<span class="ident" id="4264916">io</span><span class="op" id="4264918">.</span><span class="ident" id="4264919">Writer</span><span class="op" id="4264925">,</span>&nbsp;<span class="ident" id="4264927">level</span>&nbsp;<span class="builtintype" id="4264933">int</span><span class="op" id="4264936">,</span>&nbsp;<span class="ident" id="4264938">dict</span>&nbsp;<span class="op" id="4264943">[</span><span class="op" id="4264944">]</span><span class="builtintype" id="4264945">byte</span><span class="op" id="4264949">)</span>&nbsp;<span class="op" id="4264951">(</span><span class="op" id="4264952">*</span><span class="ident" id="4264953">Writer</span><span class="op" id="4264959">,</span>&nbsp;<span class="builtintype" id="4264961">error</span><span class="op" id="4264966">)</span>&nbsp;<span class="op" id="4264968">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4264971">dw</span>&nbsp;<span class="op" id="4264974">:=</span>&nbsp;<span class="op" id="4264977">&amp;</span><span class="ident" id="4264978">dictWriter</span><span class="op" id="4264988">{</span><span class="ident" id="4264989">w</span><span class="op" id="4264990">,</span>&nbsp;<span class="builtintype" id="4264992">false</span><span class="op" id="4264997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265000">zw</span><span class="op" id="4265002">,</span>&nbsp;<span class="ident" id="4265004">err</span>&nbsp;<span class="op" id="4265008">:=</span>&nbsp;<span class="ident" id="4265011">NewWriter</span><span class="op" id="4265020">(</span><span class="ident" id="4265021">dw</span><span class="op" id="4265023">,</span>&nbsp;<span class="ident" id="4265025">level</span><span class="op" id="4265030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265033">if</span>&nbsp;<span class="ident" id="4265036">err</span>&nbsp;<span class="op" id="4265040">!=</span>&nbsp;<span class="ident" id="4265043">nil</span>&nbsp;<span class="op" id="4265047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265051">return</span>&nbsp;<span class="ident" id="4265058">nil</span><span class="op" id="4265061">,</span>&nbsp;<span class="ident" id="4265063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4265068">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265071">zw</span><span class="op" id="4265073">.</span><span class="ident" id="4265074">Write</span><span class="op" id="4265079">(</span><span class="ident" id="4265080">dict</span><span class="op" id="4265084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265087">zw</span><span class="op" id="4265089">.</span><span class="ident" id="4265090">Flush</span><span class="op" id="4265095">(</span><span class="op" id="4265096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265099">dw</span><span class="op" id="4265101">.</span><span class="ident" id="4265102">enabled</span>&nbsp;<span class="op" id="4265110">=</span>&nbsp;<span class="builtintype" id="4265112">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265118">zw</span><span class="op" id="4265120">.</span><span class="ident" id="4265121">dict</span>&nbsp;<span class="op" id="4265126">=</span>&nbsp;<span class="builtinfunc" id="4265128">append</span><span class="op" id="4265134">(</span><span class="ident" id="4265135">zw</span><span class="op" id="4265137">.</span><span class="ident" id="4265138">dict</span><span class="op" id="4265142">,</span>&nbsp;<span class="ident" id="4265144">dict</span><span class="op" id="4265148">...</span><span class="op" id="4265151">)</span>&nbsp;<span class="comment" id="4265153">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265196">return</span>&nbsp;<span class="ident" id="4265203">zw</span><span class="op" id="4265205">,</span>&nbsp;<span class="ident" id="4265207">err</span><br>
<span class="lineno">510</span><span class="op" id="4265211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4265214">type</span>&nbsp;<span class="ident" id="4265219">dictWriter</span>&nbsp;<span class="keyword" id="4265230">struct</span>&nbsp;<span class="op" id="4265237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265240">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4265248">io</span><span class="op" id="4265250">.</span><span class="ident" id="4265251">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265259">enabled</span>&nbsp;<span class="builtintype" id="4265267">bool</span><br>
<span class="lineno">515</span><span class="op" id="4265272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4265275">func</span>&nbsp;<span class="op" id="4265280">(</span><span class="ident" id="4265281">w</span>&nbsp;<span class="op" id="4265283">*</span><span class="ident" id="4265284">dictWriter</span><span class="op" id="4265294">)</span>&nbsp;<span class="ident" id="4265296">Write</span><span class="op" id="4265301">(</span><span class="ident" id="4265302">b</span>&nbsp;<span class="op" id="4265304">[</span><span class="op" id="4265305">]</span><span class="builtintype" id="4265306">byte</span><span class="op" id="4265310">)</span>&nbsp;<span class="op" id="4265312">(</span><span class="ident" id="4265313">n</span>&nbsp;<span class="builtintype" id="4265315">int</span><span class="op" id="4265318">,</span>&nbsp;<span class="ident" id="4265320">err</span>&nbsp;<span class="builtintype" id="4265324">error</span><span class="op" id="4265329">)</span>&nbsp;<span class="op" id="4265331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265334">if</span>&nbsp;<span class="ident" id="4265337">w</span><span class="op" id="4265338">.</span><span class="ident" id="4265339">enabled</span>&nbsp;<span class="op" id="4265347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265351">return</span>&nbsp;<span class="ident" id="4265358">w</span><span class="op" id="4265359">.</span><span class="ident" id="4265360">w</span><span class="op" id="4265361">.</span><span class="ident" id="4265362">Write</span><span class="op" id="4265367">(</span><span class="ident" id="4265368">b</span><span class="op" id="4265369">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4265372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265375">return</span>&nbsp;<span class="builtinfunc" id="4265382">len</span><span class="op" id="4265385">(</span><span class="ident" id="4265386">b</span><span class="op" id="4265387">)</span><span class="op" id="4265388">,</span>&nbsp;<span class="ident" id="4265390">nil</span><br>
<span class="lineno"></span><span class="op" id="4265394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4265397">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4265460">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4265522">type</span>&nbsp;<span class="ident" id="4265527">Writer</span>&nbsp;<span class="keyword" id="4265534">struct</span>&nbsp;<span class="op" id="4265541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265544">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4265549">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4265561">dict</span>&nbsp;<span class="op" id="4265566">[</span><span class="op" id="4265567">]</span><span class="builtintype" id="4265568">byte</span><br>
<span class="lineno"></span><span class="op" id="4265573">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4265576">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4265635">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4265688">func</span>&nbsp;<span class="op" id="4265693">(</span><span class="ident" id="4265694">w</span>&nbsp;<span class="op" id="4265696">*</span><span class="ident" id="4265697">Writer</span><span class="op" id="4265703">)</span>&nbsp;<span class="ident" id="4265705">Write</span><span class="op" id="4265710">(</span><span class="ident" id="4265711">data</span>&nbsp;<span class="op" id="4265716">[</span><span class="op" id="4265717">]</span><span class="builtintype" id="4265718">byte</span><span class="op" id="4265722">)</span>&nbsp;<span class="op" id="4265724">(</span><span class="ident" id="4265725">n</span>&nbsp;<span class="builtintype" id="4265727">int</span><span class="op" id="4265730">,</span>&nbsp;<span class="ident" id="4265732">err</span>&nbsp;<span class="builtintype" id="4265736">error</span><span class="op" id="4265741">)</span>&nbsp;<span class="op" id="4265743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4265746">return</span>&nbsp;<span class="ident" id="4265753">w</span><span class="op" id="4265754">.</span><span class="ident" id="4265755">d</span><span class="op" id="4265756">.</span><span class="ident" id="4265757">write</span><span class="op" id="4265762">(</span><span class="ident" id="4265763">data</span><span class="op" id="4265767">)</span><br>
<span class="lineno">535</span><span class="op" id="4265769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4265772">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4265843">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4265914">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4265974">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4266032">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4266104">//</span><br>
<span class="lineno"></span><span class="comment" id="4266107">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4266187">func</span>&nbsp;<span class="op" id="4266192">(</span><span class="ident" id="4266193">w</span>&nbsp;<span class="op" id="4266195">*</span><span class="ident" id="4266196">Writer</span><span class="op" id="4266202">)</span>&nbsp;<span class="ident" id="4266204">Flush</span><span class="op" id="4266209">(</span><span class="op" id="4266210">)</span>&nbsp;<span class="builtintype" id="4266212">error</span>&nbsp;<span class="op" id="4266218">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4266221">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4266250">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4266302">return</span>&nbsp;<span class="ident" id="4266309">w</span><span class="op" id="4266310">.</span><span class="ident" id="4266311">d</span><span class="op" id="4266312">.</span><span class="ident" id="4266313">syncFlush</span><span class="op" id="4266322">(</span><span class="op" id="4266323">)</span><br>
<span class="lineno"></span><span class="op" id="4266325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4266328">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4266368">func</span>&nbsp;<span class="op" id="4266373">(</span><span class="ident" id="4266374">w</span>&nbsp;<span class="op" id="4266376">*</span><span class="ident" id="4266377">Writer</span><span class="op" id="4266383">)</span>&nbsp;<span class="ident" id="4266385">Close</span><span class="op" id="4266390">(</span><span class="op" id="4266391">)</span>&nbsp;<span class="builtintype" id="4266393">error</span>&nbsp;<span class="op" id="4266399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4266402">return</span>&nbsp;<span class="ident" id="4266409">w</span><span class="op" id="4266410">.</span><span class="ident" id="4266411">d</span><span class="op" id="4266412">.</span><span class="builtinfunc" id="4266413">close</span><span class="op" id="4266418">(</span><span class="op" id="4266419">)</span><br>
<span class="lineno"></span><span class="op" id="4266421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4266424">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4266488">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4266548">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4266581">func</span>&nbsp;<span class="op" id="4266586">(</span><span class="ident" id="4266587">w</span>&nbsp;<span class="op" id="4266589">*</span><span class="ident" id="4266590">Writer</span><span class="op" id="4266596">)</span>&nbsp;<span class="ident" id="4266598">Reset</span><span class="op" id="4266603">(</span><span class="ident" id="4266604">dst</span>&nbsp;<span class="ident" id="4266608">io</span><span class="op" id="4266610">.</span><span class="ident" id="4266611">Writer</span><span class="op" id="4266617">)</span>&nbsp;<span class="op" id="4266619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4266622">if</span>&nbsp;<span class="ident" id="4266625">dw</span><span class="op" id="4266627">,</span>&nbsp;<span class="ident" id="4266629">ok</span>&nbsp;<span class="op" id="4266632">:=</span>&nbsp;<span class="ident" id="4266635">w</span><span class="op" id="4266636">.</span><span class="ident" id="4266637">d</span><span class="op" id="4266638">.</span><span class="ident" id="4266639">w</span><span class="op" id="4266640">.</span><span class="ident" id="4266641">w</span><span class="op" id="4266642">.</span><span class="op" id="4266643">(</span><span class="op" id="4266644">*</span><span class="ident" id="4266645">dictWriter</span><span class="op" id="4266655">)</span><span class="op" id="4266656">;</span>&nbsp;<span class="ident" id="4266658">ok</span>&nbsp;<span class="op" id="4266661">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4266665">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266703">dw</span><span class="op" id="4266705">.</span><span class="ident" id="4266706">w</span>&nbsp;<span class="op" id="4266708">=</span>&nbsp;<span class="ident" id="4266710">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266716">w</span><span class="op" id="4266717">.</span><span class="ident" id="4266718">d</span><span class="op" id="4266719">.</span><span class="ident" id="4266720">reset</span><span class="op" id="4266725">(</span><span class="ident" id="4266726">dw</span><span class="op" id="4266728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266732">dw</span><span class="op" id="4266734">.</span><span class="ident" id="4266735">enabled</span>&nbsp;<span class="op" id="4266743">=</span>&nbsp;<span class="builtintype" id="4266745">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266753">w</span><span class="op" id="4266754">.</span><span class="ident" id="4266755">Write</span><span class="op" id="4266760">(</span><span class="ident" id="4266761">w</span><span class="op" id="4266762">.</span><span class="ident" id="4266763">dict</span><span class="op" id="4266767">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266771">w</span><span class="op" id="4266772">.</span><span class="ident" id="4266773">Flush</span><span class="op" id="4266778">(</span><span class="op" id="4266779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266783">dw</span><span class="op" id="4266785">.</span><span class="ident" id="4266786">enabled</span>&nbsp;<span class="op" id="4266794">=</span>&nbsp;<span class="builtintype" id="4266796">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4266802">}</span>&nbsp;<span class="keyword" id="4266804">else</span>&nbsp;<span class="op" id="4266809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4266813">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4266847">w</span><span class="op" id="4266848">.</span><span class="ident" id="4266849">d</span><span class="op" id="4266850">.</span><span class="ident" id="4266851">reset</span><span class="op" id="4266856">(</span><span class="ident" id="4266857">dst</span><span class="op" id="4266860">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4266863">}</span><br>
<span class="lineno"></span><span class="op" id="4266865">}</span>
</div>
</body>
</html>
