<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html" class="current">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5760348">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5760404">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5760458">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5760509">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="5760579">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="5760615">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="5760656">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="5760703">package</span>&nbsp;<span class="ident" id="5760711">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5760718">import</span>&nbsp;<span class="op" id="5760725">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760728">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760737">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760746">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760753">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760759">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760770">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760778">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760789">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5760797">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="5760814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5760817">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="5760889">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5760939">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="5761011">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="5761079">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="5761151">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="5761230">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5761257">//</span><br>
<span class="lineno"></span><span class="comment" id="5761260">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="5761338">//</span><br>
<span class="lineno"></span><span class="comment" id="5761341">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="5761408">//</span><br>
<span class="lineno"></span><span class="comment" id="5761411">//&nbsp;&nbsp;&nbsp;&nbspgoroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5761468">//&nbsp;&nbsp;&nbsp;&nbspheap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="5761521">//&nbsp;&nbsp;&nbsp;&nbspthreadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="5761595">//&nbsp;&nbsp;&nbsp;&nbspblock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="5761677">//</span><br>
<span class="lineno"></span><span class="comment" id="5761680">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="5761754">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="5761784">//</span><br>
<span class="lineno"></span><span class="comment" id="5761787">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="5761860">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="5761932">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="5761972">//</span><br>
<span class="lineno"></span><span class="keyword" id="5761975">type</span>&nbsp;<span class="ident" id="5761980">Profile</span>&nbsp;<span class="keyword" id="5761988">struct</span>&nbsp;<span class="op" id="5761995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5761998">name</span>&nbsp;&nbsp;<span class="builtintype" id="5762004">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762012">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762018">sync</span><span class="op" id="5762022">.</span><span class="ident" id="5762023">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762030">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5762036">map</span><span class="op" id="5762039">[</span><span class="keyword" id="5762040">interface</span><span class="op" id="5762049">{</span><span class="op" id="5762050">}</span><span class="op" id="5762051">]</span><span class="op" id="5762052">[</span><span class="op" id="5762053">]</span><span class="builtintype" id="5762054">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762063">count</span>&nbsp;<span class="keyword" id="5762069">func</span><span class="op" id="5762073">(</span><span class="op" id="5762074">)</span>&nbsp;<span class="builtintype" id="5762076">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762081">write</span>&nbsp;<span class="keyword" id="5762087">func</span><span class="op" id="5762091">(</span><span class="ident" id="5762092">io</span><span class="op" id="5762094">.</span><span class="ident" id="5762095">Writer</span><span class="op" id="5762101">,</span>&nbsp;<span class="builtintype" id="5762103">int</span><span class="op" id="5762106">)</span>&nbsp;<span class="builtintype" id="5762108">error</span><br>
<span class="lineno"></span><span class="op" id="5762114">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="5762117">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="5762162">var</span>&nbsp;<span class="ident" id="5762166">profiles</span>&nbsp;<span class="keyword" id="5762175">struct</span>&nbsp;<span class="op" id="5762182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762185">mu</span>&nbsp;<span class="ident" id="5762188">sync</span><span class="op" id="5762192">.</span><span class="ident" id="5762193">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762200">m</span>&nbsp;&nbsp;<span class="keyword" id="5762203">map</span><span class="op" id="5762206">[</span><span class="builtintype" id="5762207">string</span><span class="op" id="5762213">]</span><span class="op" id="5762214">*</span><span class="ident" id="5762215">Profile</span><br>
<span class="lineno">60</span><span class="op" id="5762223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5762226">var</span>&nbsp;<span class="ident" id="5762230">goroutineProfile</span>&nbsp;<span class="op" id="5762247">=</span>&nbsp;<span class="op" id="5762249">&amp;</span><span class="ident" id="5762250">Profile</span><span class="op" id="5762257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762260">name</span><span class="op" id="5762264">:</span>&nbsp;&nbsp;<span class="string" id="5762267">&#34;goroutine&#34;</span><span class="op" id="5762278">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762281">count</span><span class="op" id="5762286">:</span>&nbsp;<span class="ident" id="5762288">countGoroutine</span><span class="op" id="5762302">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762305">write</span><span class="op" id="5762310">:</span>&nbsp;<span class="ident" id="5762312">writeGoroutine</span><span class="op" id="5762326">,</span><br>
<span class="lineno"></span><span class="op" id="5762328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5762331">var</span>&nbsp;<span class="ident" id="5762335">threadcreateProfile</span>&nbsp;<span class="op" id="5762355">=</span>&nbsp;<span class="op" id="5762357">&amp;</span><span class="ident" id="5762358">Profile</span><span class="op" id="5762365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762368">name</span><span class="op" id="5762372">:</span>&nbsp;&nbsp;<span class="string" id="5762375">&#34;threadcreate&#34;</span><span class="op" id="5762389">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762392">count</span><span class="op" id="5762397">:</span>&nbsp;<span class="ident" id="5762399">countThreadCreate</span><span class="op" id="5762416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762419">write</span><span class="op" id="5762424">:</span>&nbsp;<span class="ident" id="5762426">writeThreadCreate</span><span class="op" id="5762443">,</span><br>
<span class="lineno"></span><span class="op" id="5762445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5762448">var</span>&nbsp;<span class="ident" id="5762452">heapProfile</span>&nbsp;<span class="op" id="5762464">=</span>&nbsp;<span class="op" id="5762466">&amp;</span><span class="ident" id="5762467">Profile</span><span class="op" id="5762474">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762477">name</span><span class="op" id="5762481">:</span>&nbsp;&nbsp;<span class="string" id="5762484">&#34;heap&#34;</span><span class="op" id="5762490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762493">count</span><span class="op" id="5762498">:</span>&nbsp;<span class="ident" id="5762500">countHeap</span><span class="op" id="5762509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762512">write</span><span class="op" id="5762517">:</span>&nbsp;<span class="ident" id="5762519">writeHeap</span><span class="op" id="5762528">,</span><br>
<span class="lineno"></span><span class="op" id="5762530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5762533">var</span>&nbsp;<span class="ident" id="5762537">blockProfile</span>&nbsp;<span class="op" id="5762550">=</span>&nbsp;<span class="op" id="5762552">&amp;</span><span class="ident" id="5762553">Profile</span><span class="op" id="5762560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762563">name</span><span class="op" id="5762567">:</span>&nbsp;&nbsp;<span class="string" id="5762570">&#34;block&#34;</span><span class="op" id="5762577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762580">count</span><span class="op" id="5762585">:</span>&nbsp;<span class="ident" id="5762587">countBlock</span><span class="op" id="5762597">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762600">write</span><span class="op" id="5762605">:</span>&nbsp;<span class="ident" id="5762607">writeBlock</span><span class="op" id="5762617">,</span><br>
<span class="lineno"></span><span class="op" id="5762619">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5762622">func</span>&nbsp;<span class="ident" id="5762627">lockProfiles</span><span class="op" id="5762639">(</span><span class="op" id="5762640">)</span>&nbsp;<span class="op" id="5762642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762645">profiles</span><span class="op" id="5762653">.</span><span class="ident" id="5762654">mu</span><span class="op" id="5762656">.</span><span class="ident" id="5762657">Lock</span><span class="op" id="5762661">(</span><span class="op" id="5762662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5762665">if</span>&nbsp;<span class="ident" id="5762668">profiles</span><span class="op" id="5762676">.</span><span class="ident" id="5762677">m</span>&nbsp;<span class="op" id="5762679">==</span>&nbsp;<span class="ident" id="5762682">nil</span>&nbsp;<span class="op" id="5762686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5762690">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762722">profiles</span><span class="op" id="5762730">.</span><span class="ident" id="5762731">m</span>&nbsp;<span class="op" id="5762733">=</span>&nbsp;<span class="keyword" id="5762735">map</span><span class="op" id="5762738">[</span><span class="builtintype" id="5762739">string</span><span class="op" id="5762745">]</span><span class="op" id="5762746">*</span><span class="ident" id="5762747">Profile</span><span class="op" id="5762754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5762759">&#34;goroutine&#34;</span><span class="op" id="5762770">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762775">goroutineProfile</span><span class="op" id="5762791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5762796">&#34;threadcreate&#34;</span><span class="op" id="5762810">:</span>&nbsp;<span class="ident" id="5762812">threadcreateProfile</span><span class="op" id="5762831">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5762836">&#34;heap&#34;</span><span class="op" id="5762842">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762852">heapProfile</span><span class="op" id="5762863">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5762868">&#34;block&#34;</span><span class="op" id="5762875">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762884">blockProfile</span><span class="op" id="5762896">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5762900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5762903">}</span><br>
<span class="lineno"></span><span class="op" id="5762905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5762908">func</span>&nbsp;<span class="ident" id="5762913">unlockProfiles</span><span class="op" id="5762927">(</span><span class="op" id="5762928">)</span>&nbsp;<span class="op" id="5762930">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5762933">profiles</span><span class="op" id="5762941">.</span><span class="ident" id="5762942">mu</span><span class="op" id="5762944">.</span><span class="ident" id="5762945">Unlock</span><span class="op" id="5762951">(</span><span class="op" id="5762952">)</span><br>
<span class="lineno"></span><span class="op" id="5762954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5762957">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5763014">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="5763080">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5763142">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5763184">func</span>&nbsp;<span class="ident" id="5763189">NewProfile</span><span class="op" id="5763199">(</span><span class="ident" id="5763200">name</span>&nbsp;<span class="builtintype" id="5763205">string</span><span class="op" id="5763211">)</span>&nbsp;<span class="op" id="5763213">*</span><span class="ident" id="5763214">Profile</span>&nbsp;<span class="op" id="5763222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763225">lockProfiles</span><span class="op" id="5763237">(</span><span class="op" id="5763238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763241">defer</span>&nbsp;<span class="ident" id="5763247">unlockProfiles</span><span class="op" id="5763261">(</span><span class="op" id="5763262">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763265">if</span>&nbsp;<span class="ident" id="5763268">name</span>&nbsp;<span class="op" id="5763273">==</span>&nbsp;<span class="string" id="5763276">&#34;&#34;</span>&nbsp;<span class="op" id="5763279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5763283">panic</span><span class="op" id="5763288">(</span><span class="string" id="5763289">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="5763324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5763327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763330">if</span>&nbsp;<span class="ident" id="5763333">profiles</span><span class="op" id="5763341">.</span><span class="ident" id="5763342">m</span><span class="op" id="5763343">[</span><span class="ident" id="5763344">name</span><span class="op" id="5763348">]</span>&nbsp;<span class="op" id="5763350">!=</span>&nbsp;<span class="ident" id="5763353">nil</span>&nbsp;<span class="op" id="5763357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5763361">panic</span><span class="op" id="5763366">(</span><span class="string" id="5763367">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="5763409">+</span>&nbsp;<span class="ident" id="5763411">name</span><span class="op" id="5763415">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5763418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763421">p</span>&nbsp;<span class="op" id="5763423">:=</span>&nbsp;<span class="op" id="5763426">&amp;</span><span class="ident" id="5763427">Profile</span><span class="op" id="5763434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763438">name</span><span class="op" id="5763442">:</span>&nbsp;<span class="ident" id="5763444">name</span><span class="op" id="5763448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763452">m</span><span class="op" id="5763453">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5763458">map</span><span class="op" id="5763461">[</span><span class="keyword" id="5763462">interface</span><span class="op" id="5763471">{</span><span class="op" id="5763472">}</span><span class="op" id="5763473">]</span><span class="op" id="5763474">[</span><span class="op" id="5763475">]</span><span class="builtintype" id="5763476">uintptr</span><span class="op" id="5763483">{</span><span class="op" id="5763484">}</span><span class="op" id="5763485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5763488">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763491">profiles</span><span class="op" id="5763499">.</span><span class="ident" id="5763500">m</span><span class="op" id="5763501">[</span><span class="ident" id="5763502">name</span><span class="op" id="5763506">]</span>&nbsp;<span class="op" id="5763508">=</span>&nbsp;<span class="ident" id="5763510">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763513">return</span>&nbsp;<span class="ident" id="5763520">p</span><br>
<span class="lineno"></span><span class="op" id="5763522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5763525">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="5763610">func</span>&nbsp;<span class="ident" id="5763615">Lookup</span><span class="op" id="5763621">(</span><span class="ident" id="5763622">name</span>&nbsp;<span class="builtintype" id="5763627">string</span><span class="op" id="5763633">)</span>&nbsp;<span class="op" id="5763635">*</span><span class="ident" id="5763636">Profile</span>&nbsp;<span class="op" id="5763644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763647">lockProfiles</span><span class="op" id="5763659">(</span><span class="op" id="5763660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763663">defer</span>&nbsp;<span class="ident" id="5763669">unlockProfiles</span><span class="op" id="5763683">(</span><span class="op" id="5763684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763687">return</span>&nbsp;<span class="ident" id="5763694">profiles</span><span class="op" id="5763702">.</span><span class="ident" id="5763703">m</span><span class="op" id="5763704">[</span><span class="ident" id="5763705">name</span><span class="op" id="5763709">]</span><br>
<span class="lineno"></span><span class="op" id="5763711">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5763714">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5763785">func</span>&nbsp;<span class="ident" id="5763790">Profiles</span><span class="op" id="5763798">(</span><span class="op" id="5763799">)</span>&nbsp;<span class="op" id="5763801">[</span><span class="op" id="5763802">]</span><span class="op" id="5763803">*</span><span class="ident" id="5763804">Profile</span>&nbsp;<span class="op" id="5763812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763815">lockProfiles</span><span class="op" id="5763827">(</span><span class="op" id="5763828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763831">defer</span>&nbsp;<span class="ident" id="5763837">unlockProfiles</span><span class="op" id="5763851">(</span><span class="op" id="5763852">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763856">var</span>&nbsp;<span class="ident" id="5763860">all</span>&nbsp;<span class="op" id="5763864">[</span><span class="op" id="5763865">]</span><span class="op" id="5763866">*</span><span class="ident" id="5763867">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763876">for</span>&nbsp;<span class="ident" id="5763880">_</span><span class="op" id="5763881">,</span>&nbsp;<span class="ident" id="5763883">p</span>&nbsp;<span class="op" id="5763885">:=</span>&nbsp;<span class="keyword" id="5763888">range</span>&nbsp;<span class="ident" id="5763894">profiles</span><span class="op" id="5763902">.</span><span class="ident" id="5763903">m</span>&nbsp;<span class="op" id="5763905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763909">all</span>&nbsp;<span class="op" id="5763913">=</span>&nbsp;<span class="builtinfunc" id="5763915">append</span><span class="op" id="5763921">(</span><span class="ident" id="5763922">all</span><span class="op" id="5763925">,</span>&nbsp;<span class="ident" id="5763927">p</span><span class="op" id="5763928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5763931">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5763935">sort</span><span class="op" id="5763939">.</span><span class="ident" id="5763940">Sort</span><span class="op" id="5763944">(</span><span class="ident" id="5763945">byName</span><span class="op" id="5763951">(</span><span class="ident" id="5763952">all</span><span class="op" id="5763955">)</span><span class="op" id="5763956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5763959">return</span>&nbsp;<span class="ident" id="5763966">all</span><br>
<span class="lineno"></span><span class="op" id="5763970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5763973">type</span>&nbsp;<span class="ident" id="5763978">byName</span>&nbsp;<span class="op" id="5763985">[</span><span class="op" id="5763986">]</span><span class="op" id="5763987">*</span><span class="ident" id="5763988">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5763997">func</span>&nbsp;<span class="op" id="5764002">(</span><span class="ident" id="5764003">x</span>&nbsp;<span class="ident" id="5764005">byName</span><span class="op" id="5764011">)</span>&nbsp;<span class="ident" id="5764013">Len</span><span class="op" id="5764016">(</span><span class="op" id="5764017">)</span>&nbsp;<span class="builtintype" id="5764019">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764033">{</span>&nbsp;<span class="keyword" id="5764035">return</span>&nbsp;<span class="builtinfunc" id="5764042">len</span><span class="op" id="5764045">(</span><span class="ident" id="5764046">x</span><span class="op" id="5764047">)</span>&nbsp;<span class="op" id="5764049">}</span><br>
<span class="lineno"></span><span class="keyword" id="5764051">func</span>&nbsp;<span class="op" id="5764056">(</span><span class="ident" id="5764057">x</span>&nbsp;<span class="ident" id="5764059">byName</span><span class="op" id="5764065">)</span>&nbsp;<span class="ident" id="5764067">Swap</span><span class="op" id="5764071">(</span><span class="ident" id="5764072">i</span><span class="op" id="5764073">,</span>&nbsp;<span class="ident" id="5764075">j</span>&nbsp;<span class="builtintype" id="5764077">int</span><span class="op" id="5764080">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764087">{</span>&nbsp;<span class="ident" id="5764089">x</span><span class="op" id="5764090">[</span><span class="ident" id="5764091">i</span><span class="op" id="5764092">]</span><span class="op" id="5764093">,</span>&nbsp;<span class="ident" id="5764095">x</span><span class="op" id="5764096">[</span><span class="ident" id="5764097">j</span><span class="op" id="5764098">]</span>&nbsp;<span class="op" id="5764100">=</span>&nbsp;<span class="ident" id="5764102">x</span><span class="op" id="5764103">[</span><span class="ident" id="5764104">j</span><span class="op" id="5764105">]</span><span class="op" id="5764106">,</span>&nbsp;<span class="ident" id="5764108">x</span><span class="op" id="5764109">[</span><span class="ident" id="5764110">i</span><span class="op" id="5764111">]</span>&nbsp;<span class="op" id="5764113">}</span><br>
<span class="lineno"></span><span class="keyword" id="5764115">func</span>&nbsp;<span class="op" id="5764120">(</span><span class="ident" id="5764121">x</span>&nbsp;<span class="ident" id="5764123">byName</span><span class="op" id="5764129">)</span>&nbsp;<span class="ident" id="5764131">Less</span><span class="op" id="5764135">(</span><span class="ident" id="5764136">i</span><span class="op" id="5764137">,</span>&nbsp;<span class="ident" id="5764139">j</span>&nbsp;<span class="builtintype" id="5764141">int</span><span class="op" id="5764144">)</span>&nbsp;<span class="builtintype" id="5764146">bool</span>&nbsp;<span class="op" id="5764151">{</span>&nbsp;<span class="keyword" id="5764153">return</span>&nbsp;<span class="ident" id="5764160">x</span><span class="op" id="5764161">[</span><span class="ident" id="5764162">i</span><span class="op" id="5764163">]</span><span class="op" id="5764164">.</span><span class="ident" id="5764165">name</span>&nbsp;<span class="op" id="5764170">&lt;</span>&nbsp;<span class="ident" id="5764172">x</span><span class="op" id="5764173">[</span><span class="ident" id="5764174">j</span><span class="op" id="5764175">]</span><span class="op" id="5764176">.</span><span class="ident" id="5764177">name</span>&nbsp;<span class="op" id="5764182">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="5764185">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5764277">func</span>&nbsp;<span class="op" id="5764282">(</span><span class="ident" id="5764283">p</span>&nbsp;<span class="op" id="5764285">*</span><span class="ident" id="5764286">Profile</span><span class="op" id="5764293">)</span>&nbsp;<span class="ident" id="5764295">Name</span><span class="op" id="5764299">(</span><span class="op" id="5764300">)</span>&nbsp;<span class="builtintype" id="5764302">string</span>&nbsp;<span class="op" id="5764309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5764312">return</span>&nbsp;<span class="ident" id="5764319">p</span><span class="op" id="5764320">.</span><span class="ident" id="5764321">name</span><br>
<span class="lineno"></span><span class="op" id="5764326">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5764329">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5764403">func</span>&nbsp;<span class="op" id="5764408">(</span><span class="ident" id="5764409">p</span>&nbsp;<span class="op" id="5764411">*</span><span class="ident" id="5764412">Profile</span><span class="op" id="5764419">)</span>&nbsp;<span class="ident" id="5764421">Count</span><span class="op" id="5764426">(</span><span class="op" id="5764427">)</span>&nbsp;<span class="builtintype" id="5764429">int</span>&nbsp;<span class="op" id="5764433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5764436">p</span><span class="op" id="5764437">.</span><span class="ident" id="5764438">mu</span><span class="op" id="5764440">.</span><span class="ident" id="5764441">Lock</span><span class="op" id="5764445">(</span><span class="op" id="5764446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5764449">defer</span>&nbsp;<span class="ident" id="5764455">p</span><span class="op" id="5764456">.</span><span class="ident" id="5764457">mu</span><span class="op" id="5764459">.</span><span class="ident" id="5764460">Unlock</span><span class="op" id="5764466">(</span><span class="op" id="5764467">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5764470">if</span>&nbsp;<span class="ident" id="5764473">p</span><span class="op" id="5764474">.</span><span class="ident" id="5764475">count</span>&nbsp;<span class="op" id="5764481">!=</span>&nbsp;<span class="ident" id="5764484">nil</span>&nbsp;<span class="op" id="5764488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5764492">return</span>&nbsp;<span class="ident" id="5764499">p</span><span class="op" id="5764500">.</span><span class="ident" id="5764501">count</span><span class="op" id="5764506">(</span><span class="op" id="5764507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5764510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5764513">return</span>&nbsp;<span class="builtinfunc" id="5764520">len</span><span class="op" id="5764523">(</span><span class="ident" id="5764524">p</span><span class="op" id="5764525">.</span><span class="ident" id="5764526">m</span><span class="op" id="5764527">)</span><br>
<span class="lineno"></span><span class="op" id="5764529">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5764532">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="5764611">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5764688">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="5764759">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="5764841">//</span><br>
<span class="lineno"></span><span class="comment" id="5764844">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="5764912">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5764985">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5765048">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="5765068">//</span><br>
<span class="lineno"></span><span class="comment" id="5765071">//&nbsp;&nbsp;&nbsp;&nbspAdd</span><br>
<span class="lineno"></span><span class="comment" id="5765078">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="5765107">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="5765132">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="5765157">//</span><br>
<span class="lineno"></span><span class="comment" id="5765160">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="5765242">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="5765326">//</span><br>
<span class="lineno"></span><span class="keyword" id="5765329">func</span>&nbsp;<span class="op" id="5765334">(</span><span class="ident" id="5765335">p</span>&nbsp;<span class="op" id="5765337">*</span><span class="ident" id="5765338">Profile</span><span class="op" id="5765345">)</span>&nbsp;<span class="ident" id="5765347">Add</span><span class="op" id="5765350">(</span><span class="ident" id="5765351">value</span>&nbsp;<span class="keyword" id="5765357">interface</span><span class="op" id="5765366">{</span><span class="op" id="5765367">}</span><span class="op" id="5765368">,</span>&nbsp;<span class="ident" id="5765370">skip</span>&nbsp;<span class="builtintype" id="5765375">int</span><span class="op" id="5765378">)</span>&nbsp;<span class="op" id="5765380">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5765383">if</span>&nbsp;<span class="ident" id="5765386">p</span><span class="op" id="5765387">.</span><span class="ident" id="5765388">name</span>&nbsp;<span class="op" id="5765393">==</span>&nbsp;<span class="string" id="5765396">&#34;&#34;</span>&nbsp;<span class="op" id="5765399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5765403">panic</span><span class="op" id="5765408">(</span><span class="string" id="5765409">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="5765446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5765449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5765452">if</span>&nbsp;<span class="ident" id="5765455">p</span><span class="op" id="5765456">.</span><span class="ident" id="5765457">write</span>&nbsp;<span class="op" id="5765463">!=</span>&nbsp;<span class="ident" id="5765466">nil</span>&nbsp;<span class="op" id="5765470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5765474">panic</span><span class="op" id="5765479">(</span><span class="string" id="5765480">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="5765521">+</span>&nbsp;<span class="ident" id="5765523">p</span><span class="op" id="5765524">.</span><span class="ident" id="5765525">name</span><span class="op" id="5765529">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5765532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5765536">stk</span>&nbsp;<span class="op" id="5765540">:=</span>&nbsp;<span class="builtinfunc" id="5765543">make</span><span class="op" id="5765547">(</span><span class="op" id="5765548">[</span><span class="op" id="5765549">]</span><span class="builtintype" id="5765550">uintptr</span><span class="op" id="5765557">,</span>&nbsp;<span class="num" id="5765559">32</span><span class="op" id="5765561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5765564">n</span>&nbsp;<span class="op" id="5765566">:=</span>&nbsp;<span class="ident" id="5765569">runtime</span><span class="op" id="5765576">.</span><span class="ident" id="5765577">Callers</span><span class="op" id="5765584">(</span><span class="ident" id="5765585">skip</span><span class="op" id="5765589">+</span><span class="num" id="5765590">1</span><span class="op" id="5765591">,</span>&nbsp;<span class="ident" id="5765593">stk</span><span class="op" id="5765596">[</span><span class="op" id="5765597">:</span><span class="op" id="5765598">]</span><span class="op" id="5765599">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5765603">p</span><span class="op" id="5765604">.</span><span class="ident" id="5765605">mu</span><span class="op" id="5765607">.</span><span class="ident" id="5765608">Lock</span><span class="op" id="5765612">(</span><span class="op" id="5765613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5765616">defer</span>&nbsp;<span class="ident" id="5765622">p</span><span class="op" id="5765623">.</span><span class="ident" id="5765624">mu</span><span class="op" id="5765626">.</span><span class="ident" id="5765627">Unlock</span><span class="op" id="5765633">(</span><span class="op" id="5765634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5765637">if</span>&nbsp;<span class="ident" id="5765640">p</span><span class="op" id="5765641">.</span><span class="ident" id="5765642">m</span><span class="op" id="5765643">[</span><span class="ident" id="5765644">value</span><span class="op" id="5765649">]</span>&nbsp;<span class="op" id="5765651">!=</span>&nbsp;<span class="ident" id="5765654">nil</span>&nbsp;<span class="op" id="5765658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5765662">panic</span><span class="op" id="5765667">(</span><span class="string" id="5765668">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="5765707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5765710">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5765713">p</span><span class="op" id="5765714">.</span><span class="ident" id="5765715">m</span><span class="op" id="5765716">[</span><span class="ident" id="5765717">value</span><span class="op" id="5765722">]</span>&nbsp;<span class="op" id="5765724">=</span>&nbsp;<span class="ident" id="5765726">stk</span><span class="op" id="5765729">[</span><span class="op" id="5765730">:</span><span class="ident" id="5765731">n</span><span class="op" id="5765732">]</span><br>
<span class="lineno"></span><span class="op" id="5765734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5765737">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="5765815">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="5765868">func</span>&nbsp;<span class="op" id="5765873">(</span><span class="ident" id="5765874">p</span>&nbsp;<span class="op" id="5765876">*</span><span class="ident" id="5765877">Profile</span><span class="op" id="5765884">)</span>&nbsp;<span class="ident" id="5765886">Remove</span><span class="op" id="5765892">(</span><span class="ident" id="5765893">value</span>&nbsp;<span class="keyword" id="5765899">interface</span><span class="op" id="5765908">{</span><span class="op" id="5765909">}</span><span class="op" id="5765910">)</span>&nbsp;<span class="op" id="5765912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5765915">p</span><span class="op" id="5765916">.</span><span class="ident" id="5765917">mu</span><span class="op" id="5765919">.</span><span class="ident" id="5765920">Lock</span><span class="op" id="5765924">(</span><span class="op" id="5765925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5765928">defer</span>&nbsp;<span class="ident" id="5765934">p</span><span class="op" id="5765935">.</span><span class="ident" id="5765936">mu</span><span class="op" id="5765938">.</span><span class="ident" id="5765939">Unlock</span><span class="op" id="5765945">(</span><span class="op" id="5765946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5765949">delete</span><span class="op" id="5765955">(</span><span class="ident" id="5765956">p</span><span class="op" id="5765957">.</span><span class="ident" id="5765958">m</span><span class="op" id="5765959">,</span>&nbsp;<span class="ident" id="5765961">value</span><span class="op" id="5765966">)</span><br>
<span class="lineno"></span><span class="op" id="5765968">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="5765971">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5766037">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5766102">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5766137">//</span><br>
<span class="lineno">215</span><span class="comment" id="5766140">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="5766190">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="5766265">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="5766338">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="5766416">//</span><br>
<span class="lineno">220</span><span class="comment" id="5766419">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="5766488">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5766560">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5766630">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5766673">func</span>&nbsp;<span class="op" id="5766678">(</span><span class="ident" id="5766679">p</span>&nbsp;<span class="op" id="5766681">*</span><span class="ident" id="5766682">Profile</span><span class="op" id="5766689">)</span>&nbsp;<span class="ident" id="5766691">WriteTo</span><span class="op" id="5766698">(</span><span class="ident" id="5766699">w</span>&nbsp;<span class="ident" id="5766701">io</span><span class="op" id="5766703">.</span><span class="ident" id="5766704">Writer</span><span class="op" id="5766710">,</span>&nbsp;<span class="ident" id="5766712">debug</span>&nbsp;<span class="builtintype" id="5766718">int</span><span class="op" id="5766721">)</span>&nbsp;<span class="builtintype" id="5766723">error</span>&nbsp;<span class="op" id="5766729">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5766732">if</span>&nbsp;<span class="ident" id="5766735">p</span><span class="op" id="5766736">.</span><span class="ident" id="5766737">name</span>&nbsp;<span class="op" id="5766742">==</span>&nbsp;<span class="string" id="5766745">&#34;&#34;</span>&nbsp;<span class="op" id="5766748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5766752">panic</span><span class="op" id="5766757">(</span><span class="string" id="5766758">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="5766786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5766789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5766792">if</span>&nbsp;<span class="ident" id="5766795">p</span><span class="op" id="5766796">.</span><span class="ident" id="5766797">write</span>&nbsp;<span class="op" id="5766803">!=</span>&nbsp;<span class="ident" id="5766806">nil</span>&nbsp;<span class="op" id="5766810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5766814">return</span>&nbsp;<span class="ident" id="5766821">p</span><span class="op" id="5766822">.</span><span class="ident" id="5766823">write</span><span class="op" id="5766828">(</span><span class="ident" id="5766829">w</span><span class="op" id="5766830">,</span>&nbsp;<span class="ident" id="5766832">debug</span><span class="op" id="5766837">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5766840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5766844">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5766914">var</span>&nbsp;<span class="ident" id="5766918">all</span>&nbsp;<span class="op" id="5766922">[</span><span class="op" id="5766923">]</span><span class="op" id="5766924">[</span><span class="op" id="5766925">]</span><span class="builtintype" id="5766926">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5766935">p</span><span class="op" id="5766936">.</span><span class="ident" id="5766937">mu</span><span class="op" id="5766939">.</span><span class="ident" id="5766940">Lock</span><span class="op" id="5766944">(</span><span class="op" id="5766945">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5766948">for</span>&nbsp;<span class="ident" id="5766952">_</span><span class="op" id="5766953">,</span>&nbsp;<span class="ident" id="5766955">stk</span>&nbsp;<span class="op" id="5766959">:=</span>&nbsp;<span class="keyword" id="5766962">range</span>&nbsp;<span class="ident" id="5766968">p</span><span class="op" id="5766969">.</span><span class="ident" id="5766970">m</span>&nbsp;<span class="op" id="5766972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5766976">all</span>&nbsp;<span class="op" id="5766980">=</span>&nbsp;<span class="builtinfunc" id="5766982">append</span><span class="op" id="5766988">(</span><span class="ident" id="5766989">all</span><span class="op" id="5766992">,</span>&nbsp;<span class="ident" id="5766994">stk</span><span class="op" id="5766997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5767000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5767003">p</span><span class="op" id="5767004">.</span><span class="ident" id="5767005">mu</span><span class="op" id="5767007">.</span><span class="ident" id="5767008">Unlock</span><span class="op" id="5767014">(</span><span class="op" id="5767015">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5767019">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5767082">sort</span><span class="op" id="5767086">.</span><span class="ident" id="5767087">Sort</span><span class="op" id="5767091">(</span><span class="ident" id="5767092">stackProfile</span><span class="op" id="5767104">(</span><span class="ident" id="5767105">all</span><span class="op" id="5767108">)</span><span class="op" id="5767109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5767113">return</span>&nbsp;<span class="ident" id="5767120">printCountProfile</span><span class="op" id="5767137">(</span><span class="ident" id="5767138">w</span><span class="op" id="5767139">,</span>&nbsp;<span class="ident" id="5767141">debug</span><span class="op" id="5767146">,</span>&nbsp;<span class="ident" id="5767148">p</span><span class="op" id="5767149">.</span><span class="ident" id="5767150">name</span><span class="op" id="5767154">,</span>&nbsp;<span class="ident" id="5767156">stackProfile</span><span class="op" id="5767168">(</span><span class="ident" id="5767169">all</span><span class="op" id="5767172">)</span><span class="op" id="5767173">)</span><br>
<span class="lineno"></span><span class="op" id="5767175">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="5767178">type</span>&nbsp;<span class="ident" id="5767183">stackProfile</span>&nbsp;<span class="op" id="5767196">[</span><span class="op" id="5767197">]</span><span class="op" id="5767198">[</span><span class="op" id="5767199">]</span><span class="builtintype" id="5767200">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5767209">func</span>&nbsp;<span class="op" id="5767214">(</span><span class="ident" id="5767215">x</span>&nbsp;<span class="ident" id="5767217">stackProfile</span><span class="op" id="5767229">)</span>&nbsp;<span class="ident" id="5767231">Len</span><span class="op" id="5767234">(</span><span class="op" id="5767235">)</span>&nbsp;<span class="builtintype" id="5767237">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767254">{</span>&nbsp;<span class="keyword" id="5767256">return</span>&nbsp;<span class="builtinfunc" id="5767263">len</span><span class="op" id="5767266">(</span><span class="ident" id="5767267">x</span><span class="op" id="5767268">)</span>&nbsp;<span class="op" id="5767270">}</span><br>
<span class="lineno"></span><span class="keyword" id="5767272">func</span>&nbsp;<span class="op" id="5767277">(</span><span class="ident" id="5767278">x</span>&nbsp;<span class="ident" id="5767280">stackProfile</span><span class="op" id="5767292">)</span>&nbsp;<span class="ident" id="5767294">Stack</span><span class="op" id="5767299">(</span><span class="ident" id="5767300">i</span>&nbsp;<span class="builtintype" id="5767302">int</span><span class="op" id="5767305">)</span>&nbsp;<span class="op" id="5767307">[</span><span class="op" id="5767308">]</span><span class="builtintype" id="5767309">uintptr</span>&nbsp;<span class="op" id="5767317">{</span>&nbsp;<span class="keyword" id="5767319">return</span>&nbsp;<span class="ident" id="5767326">x</span><span class="op" id="5767327">[</span><span class="ident" id="5767328">i</span><span class="op" id="5767329">]</span>&nbsp;<span class="op" id="5767331">}</span><br>
<span class="lineno">250</span><span class="keyword" id="5767333">func</span>&nbsp;<span class="op" id="5767338">(</span><span class="ident" id="5767339">x</span>&nbsp;<span class="ident" id="5767341">stackProfile</span><span class="op" id="5767353">)</span>&nbsp;<span class="ident" id="5767355">Swap</span><span class="op" id="5767359">(</span><span class="ident" id="5767360">i</span><span class="op" id="5767361">,</span>&nbsp;<span class="ident" id="5767363">j</span>&nbsp;<span class="builtintype" id="5767365">int</span><span class="op" id="5767368">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767378">{</span>&nbsp;<span class="ident" id="5767380">x</span><span class="op" id="5767381">[</span><span class="ident" id="5767382">i</span><span class="op" id="5767383">]</span><span class="op" id="5767384">,</span>&nbsp;<span class="ident" id="5767386">x</span><span class="op" id="5767387">[</span><span class="ident" id="5767388">j</span><span class="op" id="5767389">]</span>&nbsp;<span class="op" id="5767391">=</span>&nbsp;<span class="ident" id="5767393">x</span><span class="op" id="5767394">[</span><span class="ident" id="5767395">j</span><span class="op" id="5767396">]</span><span class="op" id="5767397">,</span>&nbsp;<span class="ident" id="5767399">x</span><span class="op" id="5767400">[</span><span class="ident" id="5767401">i</span><span class="op" id="5767402">]</span>&nbsp;<span class="op" id="5767404">}</span><br>
<span class="lineno"></span><span class="keyword" id="5767406">func</span>&nbsp;<span class="op" id="5767411">(</span><span class="ident" id="5767412">x</span>&nbsp;<span class="ident" id="5767414">stackProfile</span><span class="op" id="5767426">)</span>&nbsp;<span class="ident" id="5767428">Less</span><span class="op" id="5767432">(</span><span class="ident" id="5767433">i</span><span class="op" id="5767434">,</span>&nbsp;<span class="ident" id="5767436">j</span>&nbsp;<span class="builtintype" id="5767438">int</span><span class="op" id="5767441">)</span>&nbsp;<span class="builtintype" id="5767443">bool</span>&nbsp;<span class="op" id="5767448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5767451">t</span><span class="op" id="5767452">,</span>&nbsp;<span class="ident" id="5767454">u</span>&nbsp;<span class="op" id="5767456">:=</span>&nbsp;<span class="ident" id="5767459">x</span><span class="op" id="5767460">[</span><span class="ident" id="5767461">i</span><span class="op" id="5767462">]</span><span class="op" id="5767463">,</span>&nbsp;<span class="ident" id="5767465">x</span><span class="op" id="5767466">[</span><span class="ident" id="5767467">j</span><span class="op" id="5767468">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5767471">for</span>&nbsp;<span class="ident" id="5767475">k</span>&nbsp;<span class="op" id="5767477">:=</span>&nbsp;<span class="num" id="5767480">0</span><span class="op" id="5767481">;</span>&nbsp;<span class="ident" id="5767483">k</span>&nbsp;<span class="op" id="5767485">&lt;</span>&nbsp;<span class="builtinfunc" id="5767487">len</span><span class="op" id="5767490">(</span><span class="ident" id="5767491">t</span><span class="op" id="5767492">)</span>&nbsp;<span class="op" id="5767494">&amp;&amp;</span>&nbsp;<span class="ident" id="5767497">k</span>&nbsp;<span class="op" id="5767499">&lt;</span>&nbsp;<span class="builtinfunc" id="5767501">len</span><span class="op" id="5767504">(</span><span class="ident" id="5767505">u</span><span class="op" id="5767506">)</span><span class="op" id="5767507">;</span>&nbsp;<span class="ident" id="5767509">k</span><span class="op" id="5767510">++</span>&nbsp;<span class="op" id="5767513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5767517">if</span>&nbsp;<span class="ident" id="5767520">t</span><span class="op" id="5767521">[</span><span class="ident" id="5767522">k</span><span class="op" id="5767523">]</span>&nbsp;<span class="op" id="5767525">!=</span>&nbsp;<span class="ident" id="5767528">u</span><span class="op" id="5767529">[</span><span class="ident" id="5767530">k</span><span class="op" id="5767531">]</span>&nbsp;<span class="op" id="5767533">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5767538">return</span>&nbsp;<span class="ident" id="5767545">t</span><span class="op" id="5767546">[</span><span class="ident" id="5767547">k</span><span class="op" id="5767548">]</span>&nbsp;<span class="op" id="5767550">&lt;</span>&nbsp;<span class="ident" id="5767552">u</span><span class="op" id="5767553">[</span><span class="ident" id="5767554">k</span><span class="op" id="5767555">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5767559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5767562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5767565">return</span>&nbsp;<span class="builtinfunc" id="5767572">len</span><span class="op" id="5767575">(</span><span class="ident" id="5767576">t</span><span class="op" id="5767577">)</span>&nbsp;<span class="op" id="5767579">&lt;</span>&nbsp;<span class="builtinfunc" id="5767581">len</span><span class="op" id="5767584">(</span><span class="ident" id="5767585">u</span><span class="op" id="5767586">)</span><br>
<span class="lineno"></span><span class="op" id="5767588">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5767591">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="5767658">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="5767722">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5767792">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="5767826">type</span>&nbsp;<span class="ident" id="5767831">countProfile</span>&nbsp;<span class="keyword" id="5767844">interface</span>&nbsp;<span class="op" id="5767854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5767857">Len</span><span class="op" id="5767860">(</span><span class="op" id="5767861">)</span>&nbsp;<span class="builtintype" id="5767863">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5767868">Stack</span><span class="op" id="5767873">(</span><span class="ident" id="5767874">i</span>&nbsp;<span class="builtintype" id="5767876">int</span><span class="op" id="5767879">)</span>&nbsp;<span class="op" id="5767881">[</span><span class="op" id="5767882">]</span><span class="builtintype" id="5767883">uintptr</span><br>
<span class="lineno"></span><span class="op" id="5767891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5767894">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="5767967">func</span>&nbsp;<span class="ident" id="5767972">printCountProfile</span><span class="op" id="5767989">(</span><span class="ident" id="5767990">w</span>&nbsp;<span class="ident" id="5767992">io</span><span class="op" id="5767994">.</span><span class="ident" id="5767995">Writer</span><span class="op" id="5768001">,</span>&nbsp;<span class="ident" id="5768003">debug</span>&nbsp;<span class="builtintype" id="5768009">int</span><span class="op" id="5768012">,</span>&nbsp;<span class="ident" id="5768014">name</span>&nbsp;<span class="builtintype" id="5768019">string</span><span class="op" id="5768025">,</span>&nbsp;<span class="ident" id="5768027">p</span>&nbsp;<span class="ident" id="5768029">countProfile</span><span class="op" id="5768041">)</span>&nbsp;<span class="builtintype" id="5768043">error</span>&nbsp;<span class="op" id="5768049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768052">b</span>&nbsp;<span class="op" id="5768054">:=</span>&nbsp;<span class="ident" id="5768057">bufio</span><span class="op" id="5768062">.</span><span class="ident" id="5768063">NewWriter</span><span class="op" id="5768072">(</span><span class="ident" id="5768073">w</span><span class="op" id="5768074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768077">var</span>&nbsp;<span class="ident" id="5768081">tw</span>&nbsp;<span class="op" id="5768084">*</span><span class="ident" id="5768085">tabwriter</span><span class="op" id="5768094">.</span><span class="ident" id="5768095">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768103">w</span>&nbsp;<span class="op" id="5768105">=</span>&nbsp;<span class="ident" id="5768107">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768110">if</span>&nbsp;<span class="ident" id="5768113">debug</span>&nbsp;<span class="op" id="5768119">&gt;</span>&nbsp;<span class="num" id="5768121">0</span>&nbsp;<span class="op" id="5768123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768127">tw</span>&nbsp;<span class="op" id="5768130">=</span>&nbsp;<span class="ident" id="5768132">tabwriter</span><span class="op" id="5768141">.</span><span class="ident" id="5768142">NewWriter</span><span class="op" id="5768151">(</span><span class="ident" id="5768152">w</span><span class="op" id="5768153">,</span>&nbsp;<span class="num" id="5768155">1</span><span class="op" id="5768156">,</span>&nbsp;<span class="num" id="5768158">8</span><span class="op" id="5768159">,</span>&nbsp;<span class="num" id="5768161">1</span><span class="op" id="5768162">,</span>&nbsp;<span class="string" id="5768164">&#39;\t&#39;</span><span class="op" id="5768168">,</span>&nbsp;<span class="num" id="5768170">0</span><span class="op" id="5768171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768175">w</span>&nbsp;<span class="op" id="5768177">=</span>&nbsp;<span class="ident" id="5768179">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768187">fmt</span><span class="op" id="5768190">.</span><span class="ident" id="5768191">Fprintf</span><span class="op" id="5768198">(</span><span class="ident" id="5768199">w</span><span class="op" id="5768200">,</span>&nbsp;<span class="string" id="5768202">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="5768226">,</span>&nbsp;<span class="ident" id="5768228">name</span><span class="op" id="5768232">,</span>&nbsp;<span class="ident" id="5768234">p</span><span class="op" id="5768235">.</span><span class="ident" id="5768236">Len</span><span class="op" id="5768239">(</span><span class="op" id="5768240">)</span><span class="op" id="5768241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5768245">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768276">var</span>&nbsp;<span class="ident" id="5768280">buf</span>&nbsp;<span class="ident" id="5768284">bytes</span><span class="op" id="5768289">.</span><span class="ident" id="5768290">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768298">key</span>&nbsp;<span class="op" id="5768302">:=</span>&nbsp;<span class="keyword" id="5768305">func</span><span class="op" id="5768309">(</span><span class="ident" id="5768310">stk</span>&nbsp;<span class="op" id="5768314">[</span><span class="op" id="5768315">]</span><span class="builtintype" id="5768316">uintptr</span><span class="op" id="5768323">)</span>&nbsp;<span class="builtintype" id="5768325">string</span>&nbsp;<span class="op" id="5768332">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768336">buf</span><span class="op" id="5768339">.</span><span class="ident" id="5768340">Reset</span><span class="op" id="5768345">(</span><span class="op" id="5768346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768350">fmt</span><span class="op" id="5768353">.</span><span class="ident" id="5768354">Fprintf</span><span class="op" id="5768361">(</span><span class="op" id="5768362">&amp;</span><span class="ident" id="5768363">buf</span><span class="op" id="5768366">,</span>&nbsp;<span class="string" id="5768368">&#34;@&#34;</span><span class="op" id="5768371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768375">for</span>&nbsp;<span class="ident" id="5768379">_</span><span class="op" id="5768380">,</span>&nbsp;<span class="ident" id="5768382">pc</span>&nbsp;<span class="op" id="5768385">:=</span>&nbsp;<span class="keyword" id="5768388">range</span>&nbsp;<span class="ident" id="5768394">stk</span>&nbsp;<span class="op" id="5768398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768403">fmt</span><span class="op" id="5768406">.</span><span class="ident" id="5768407">Fprintf</span><span class="op" id="5768414">(</span><span class="op" id="5768415">&amp;</span><span class="ident" id="5768416">buf</span><span class="op" id="5768419">,</span>&nbsp;<span class="string" id="5768421">&#34;&nbsp;%#x&#34;</span><span class="op" id="5768427">,</span>&nbsp;<span class="ident" id="5768429">pc</span><span class="op" id="5768431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768435">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768439">return</span>&nbsp;<span class="ident" id="5768446">buf</span><span class="op" id="5768449">.</span><span class="ident" id="5768450">String</span><span class="op" id="5768456">(</span><span class="op" id="5768457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768463">m</span>&nbsp;<span class="op" id="5768465">:=</span>&nbsp;<span class="keyword" id="5768468">map</span><span class="op" id="5768471">[</span><span class="builtintype" id="5768472">string</span><span class="op" id="5768478">]</span><span class="builtintype" id="5768479">int</span><span class="op" id="5768482">{</span><span class="op" id="5768483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768486">n</span>&nbsp;<span class="op" id="5768488">:=</span>&nbsp;<span class="ident" id="5768491">p</span><span class="op" id="5768492">.</span><span class="ident" id="5768493">Len</span><span class="op" id="5768496">(</span><span class="op" id="5768497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768500">for</span>&nbsp;<span class="ident" id="5768504">i</span>&nbsp;<span class="op" id="5768506">:=</span>&nbsp;<span class="num" id="5768509">0</span><span class="op" id="5768510">;</span>&nbsp;<span class="ident" id="5768512">i</span>&nbsp;<span class="op" id="5768514">&lt;</span>&nbsp;<span class="ident" id="5768516">n</span><span class="op" id="5768517">;</span>&nbsp;<span class="ident" id="5768519">i</span><span class="op" id="5768520">++</span>&nbsp;<span class="op" id="5768523">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768527">m</span><span class="op" id="5768528">[</span><span class="ident" id="5768529">key</span><span class="op" id="5768532">(</span><span class="ident" id="5768533">p</span><span class="op" id="5768534">.</span><span class="ident" id="5768535">Stack</span><span class="op" id="5768540">(</span><span class="ident" id="5768541">i</span><span class="op" id="5768542">)</span><span class="op" id="5768543">)</span><span class="op" id="5768544">]</span><span class="op" id="5768545">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5768553">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768624">for</span>&nbsp;<span class="ident" id="5768628">i</span>&nbsp;<span class="op" id="5768630">:=</span>&nbsp;<span class="num" id="5768633">0</span><span class="op" id="5768634">;</span>&nbsp;<span class="ident" id="5768636">i</span>&nbsp;<span class="op" id="5768638">&lt;</span>&nbsp;<span class="ident" id="5768640">n</span><span class="op" id="5768641">;</span>&nbsp;<span class="ident" id="5768643">i</span><span class="op" id="5768644">++</span>&nbsp;<span class="op" id="5768647">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768651">stk</span>&nbsp;<span class="op" id="5768655">:=</span>&nbsp;<span class="ident" id="5768658">p</span><span class="op" id="5768659">.</span><span class="ident" id="5768660">Stack</span><span class="op" id="5768665">(</span><span class="ident" id="5768666">i</span><span class="op" id="5768667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768671">s</span>&nbsp;<span class="op" id="5768673">:=</span>&nbsp;<span class="ident" id="5768676">key</span><span class="op" id="5768679">(</span><span class="ident" id="5768680">stk</span><span class="op" id="5768683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768687">if</span>&nbsp;<span class="ident" id="5768690">count</span>&nbsp;<span class="op" id="5768696">:=</span>&nbsp;<span class="ident" id="5768699">m</span><span class="op" id="5768700">[</span><span class="ident" id="5768701">s</span><span class="op" id="5768702">]</span><span class="op" id="5768703">;</span>&nbsp;<span class="ident" id="5768705">count</span>&nbsp;<span class="op" id="5768711">!=</span>&nbsp;<span class="num" id="5768714">0</span>&nbsp;<span class="op" id="5768716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768721">fmt</span><span class="op" id="5768724">.</span><span class="ident" id="5768725">Fprintf</span><span class="op" id="5768732">(</span><span class="ident" id="5768733">w</span><span class="op" id="5768734">,</span>&nbsp;<span class="string" id="5768736">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5768745">,</span>&nbsp;<span class="ident" id="5768747">count</span><span class="op" id="5768752">,</span>&nbsp;<span class="ident" id="5768754">s</span><span class="op" id="5768755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768760">if</span>&nbsp;<span class="ident" id="5768763">debug</span>&nbsp;<span class="op" id="5768769">&gt;</span>&nbsp;<span class="num" id="5768771">0</span>&nbsp;<span class="op" id="5768773">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768779">printStackRecord</span><span class="op" id="5768795">(</span><span class="ident" id="5768796">w</span><span class="op" id="5768797">,</span>&nbsp;<span class="ident" id="5768799">stk</span><span class="op" id="5768802">,</span>&nbsp;<span class="builtintype" id="5768804">false</span><span class="op" id="5768809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5768819">delete</span><span class="op" id="5768825">(</span><span class="ident" id="5768826">m</span><span class="op" id="5768827">,</span>&nbsp;<span class="ident" id="5768829">s</span><span class="op" id="5768830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768837">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768841">if</span>&nbsp;<span class="ident" id="5768844">tw</span>&nbsp;<span class="op" id="5768847">!=</span>&nbsp;<span class="ident" id="5768850">nil</span>&nbsp;<span class="op" id="5768854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5768858">tw</span><span class="op" id="5768860">.</span><span class="ident" id="5768861">Flush</span><span class="op" id="5768866">(</span><span class="op" id="5768867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5768870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5768873">return</span>&nbsp;<span class="ident" id="5768880">b</span><span class="op" id="5768881">.</span><span class="ident" id="5768882">Flush</span><span class="op" id="5768887">(</span><span class="op" id="5768888">)</span><br>
<span class="lineno">315</span><span class="op" id="5768890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5768893">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="5768959">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="5768988">func</span>&nbsp;<span class="ident" id="5768993">printStackRecord</span><span class="op" id="5769009">(</span><span class="ident" id="5769010">w</span>&nbsp;<span class="ident" id="5769012">io</span><span class="op" id="5769014">.</span><span class="ident" id="5769015">Writer</span><span class="op" id="5769021">,</span>&nbsp;<span class="ident" id="5769023">stk</span>&nbsp;<span class="op" id="5769027">[</span><span class="op" id="5769028">]</span><span class="builtintype" id="5769029">uintptr</span><span class="op" id="5769036">,</span>&nbsp;<span class="ident" id="5769038">allFrames</span>&nbsp;<span class="builtintype" id="5769048">bool</span><span class="op" id="5769052">)</span>&nbsp;<span class="op" id="5769054">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769057">show</span>&nbsp;<span class="op" id="5769062">:=</span>&nbsp;<span class="ident" id="5769065">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769076">wasPanic</span>&nbsp;<span class="op" id="5769085">:=</span>&nbsp;<span class="builtintype" id="5769088">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769095">for</span>&nbsp;<span class="ident" id="5769099">i</span><span class="op" id="5769100">,</span>&nbsp;<span class="ident" id="5769102">pc</span>&nbsp;<span class="op" id="5769105">:=</span>&nbsp;<span class="keyword" id="5769108">range</span>&nbsp;<span class="ident" id="5769114">stk</span>&nbsp;<span class="op" id="5769118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769122">f</span>&nbsp;<span class="op" id="5769124">:=</span>&nbsp;<span class="ident" id="5769127">runtime</span><span class="op" id="5769134">.</span><span class="ident" id="5769135">FuncForPC</span><span class="op" id="5769144">(</span><span class="ident" id="5769145">pc</span><span class="op" id="5769147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769151">if</span>&nbsp;<span class="ident" id="5769154">f</span>&nbsp;<span class="op" id="5769156">==</span>&nbsp;<span class="ident" id="5769159">nil</span>&nbsp;<span class="op" id="5769163">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769168">show</span>&nbsp;<span class="op" id="5769173">=</span>&nbsp;<span class="builtintype" id="5769175">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769183">fmt</span><span class="op" id="5769186">.</span><span class="ident" id="5769187">Fprintf</span><span class="op" id="5769194">(</span><span class="ident" id="5769195">w</span><span class="op" id="5769196">,</span>&nbsp;<span class="string" id="5769198">&#34;#\t%#x\n&#34;</span><span class="op" id="5769208">,</span>&nbsp;<span class="ident" id="5769210">pc</span><span class="op" id="5769212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769217">wasPanic</span>&nbsp;<span class="op" id="5769226">=</span>&nbsp;<span class="builtintype" id="5769228">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769236">}</span>&nbsp;<span class="keyword" id="5769238">else</span>&nbsp;<span class="op" id="5769243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769248">tracepc</span>&nbsp;<span class="op" id="5769256">:=</span>&nbsp;<span class="ident" id="5769259">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5769265">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769300">if</span>&nbsp;<span class="ident" id="5769303">i</span>&nbsp;<span class="op" id="5769305">&gt;</span>&nbsp;<span class="num" id="5769307">0</span>&nbsp;<span class="op" id="5769309">&amp;&amp;</span>&nbsp;<span class="ident" id="5769312">pc</span>&nbsp;<span class="op" id="5769315">&gt;</span>&nbsp;<span class="ident" id="5769317">f</span><span class="op" id="5769318">.</span><span class="ident" id="5769319">Entry</span><span class="op" id="5769324">(</span><span class="op" id="5769325">)</span>&nbsp;<span class="op" id="5769327">&amp;&amp;</span>&nbsp;<span class="op" id="5769330">!</span><span class="ident" id="5769331">wasPanic</span>&nbsp;<span class="op" id="5769340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769346">if</span>&nbsp;<span class="ident" id="5769349">runtime</span><span class="op" id="5769356">.</span><span class="ident" id="5769357">GOARCH</span>&nbsp;<span class="op" id="5769364">==</span>&nbsp;<span class="string" id="5769367">&#34;386&#34;</span>&nbsp;<span class="op" id="5769373">||</span>&nbsp;<span class="ident" id="5769376">runtime</span><span class="op" id="5769383">.</span><span class="ident" id="5769384">GOARCH</span>&nbsp;<span class="op" id="5769391">==</span>&nbsp;<span class="string" id="5769394">&#34;amd64&#34;</span>&nbsp;<span class="op" id="5769402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769409">tracepc</span><span class="op" id="5769416">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769423">}</span>&nbsp;<span class="keyword" id="5769425">else</span>&nbsp;<span class="op" id="5769430">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769437">tracepc</span>&nbsp;<span class="op" id="5769445">-=</span>&nbsp;<span class="num" id="5769448">4</span>&nbsp;<span class="comment" id="5769450">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769476">file</span><span class="op" id="5769480">,</span>&nbsp;<span class="ident" id="5769482">line</span>&nbsp;<span class="op" id="5769487">:=</span>&nbsp;<span class="ident" id="5769490">f</span><span class="op" id="5769491">.</span><span class="ident" id="5769492">FileLine</span><span class="op" id="5769500">(</span><span class="ident" id="5769501">tracepc</span><span class="op" id="5769508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769513">name</span>&nbsp;<span class="op" id="5769518">:=</span>&nbsp;<span class="ident" id="5769521">f</span><span class="op" id="5769522">.</span><span class="ident" id="5769523">Name</span><span class="op" id="5769527">(</span><span class="op" id="5769528">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5769533">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5769603">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769654">wasPanic</span>&nbsp;<span class="op" id="5769663">=</span>&nbsp;<span class="ident" id="5769665">name</span>&nbsp;<span class="op" id="5769670">==</span>&nbsp;<span class="string" id="5769673">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769692">if</span>&nbsp;<span class="ident" id="5769695">name</span>&nbsp;<span class="op" id="5769700">==</span>&nbsp;<span class="string" id="5769703">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="5769720">||</span>&nbsp;<span class="op" id="5769723">!</span><span class="ident" id="5769724">show</span>&nbsp;<span class="op" id="5769729">&amp;&amp;</span>&nbsp;<span class="ident" id="5769732">strings</span><span class="op" id="5769739">.</span><span class="ident" id="5769740">HasPrefix</span><span class="op" id="5769749">(</span><span class="ident" id="5769750">name</span><span class="op" id="5769754">,</span>&nbsp;<span class="string" id="5769756">&#34;runtime.&#34;</span><span class="op" id="5769766">)</span>&nbsp;<span class="op" id="5769768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769774">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769791">show</span>&nbsp;<span class="op" id="5769796">=</span>&nbsp;<span class="builtintype" id="5769798">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769806">fmt</span><span class="op" id="5769809">.</span><span class="ident" id="5769810">Fprintf</span><span class="op" id="5769817">(</span><span class="ident" id="5769818">w</span><span class="op" id="5769819">,</span>&nbsp;<span class="string" id="5769821">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="5769846">,</span>&nbsp;<span class="ident" id="5769848">pc</span><span class="op" id="5769850">,</span>&nbsp;<span class="ident" id="5769852">name</span><span class="op" id="5769856">,</span>&nbsp;<span class="ident" id="5769858">pc</span><span class="op" id="5769860">-</span><span class="ident" id="5769861">f</span><span class="op" id="5769862">.</span><span class="ident" id="5769863">Entry</span><span class="op" id="5769868">(</span><span class="op" id="5769869">)</span><span class="op" id="5769870">,</span>&nbsp;<span class="ident" id="5769872">file</span><span class="op" id="5769876">,</span>&nbsp;<span class="ident" id="5769878">line</span><span class="op" id="5769882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5769889">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5769892">if</span>&nbsp;<span class="op" id="5769895">!</span><span class="ident" id="5769896">show</span>&nbsp;<span class="op" id="5769901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5769905">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5769949">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5769995">printStackRecord</span><span class="op" id="5770011">(</span><span class="ident" id="5770012">w</span><span class="op" id="5770013">,</span>&nbsp;<span class="ident" id="5770015">stk</span><span class="op" id="5770018">,</span>&nbsp;<span class="builtintype" id="5770020">true</span><span class="op" id="5770024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5770028">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5770036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5770039">fmt</span><span class="op" id="5770042">.</span><span class="ident" id="5770043">Fprintf</span><span class="op" id="5770050">(</span><span class="ident" id="5770051">w</span><span class="op" id="5770052">,</span>&nbsp;<span class="string" id="5770054">&#34;\n&#34;</span><span class="op" id="5770058">)</span><br>
<span class="lineno"></span><span class="op" id="5770060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5770063">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5770097">type</span>&nbsp;<span class="ident" id="5770102">byInUseBytes</span>&nbsp;<span class="op" id="5770115">[</span><span class="op" id="5770116">]</span><span class="ident" id="5770117">runtime</span><span class="op" id="5770124">.</span><span class="ident" id="5770125">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5770143">func</span>&nbsp;<span class="op" id="5770148">(</span><span class="ident" id="5770149">x</span>&nbsp;<span class="ident" id="5770151">byInUseBytes</span><span class="op" id="5770163">)</span>&nbsp;<span class="ident" id="5770165">Len</span><span class="op" id="5770168">(</span><span class="op" id="5770169">)</span>&nbsp;<span class="builtintype" id="5770171">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770185">{</span>&nbsp;<span class="keyword" id="5770187">return</span>&nbsp;<span class="builtinfunc" id="5770194">len</span><span class="op" id="5770197">(</span><span class="ident" id="5770198">x</span><span class="op" id="5770199">)</span>&nbsp;<span class="op" id="5770201">}</span><br>
<span class="lineno"></span><span class="keyword" id="5770203">func</span>&nbsp;<span class="op" id="5770208">(</span><span class="ident" id="5770209">x</span>&nbsp;<span class="ident" id="5770211">byInUseBytes</span><span class="op" id="5770223">)</span>&nbsp;<span class="ident" id="5770225">Swap</span><span class="op" id="5770229">(</span><span class="ident" id="5770230">i</span><span class="op" id="5770231">,</span>&nbsp;<span class="ident" id="5770233">j</span>&nbsp;<span class="builtintype" id="5770235">int</span><span class="op" id="5770238">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770245">{</span>&nbsp;<span class="ident" id="5770247">x</span><span class="op" id="5770248">[</span><span class="ident" id="5770249">i</span><span class="op" id="5770250">]</span><span class="op" id="5770251">,</span>&nbsp;<span class="ident" id="5770253">x</span><span class="op" id="5770254">[</span><span class="ident" id="5770255">j</span><span class="op" id="5770256">]</span>&nbsp;<span class="op" id="5770258">=</span>&nbsp;<span class="ident" id="5770260">x</span><span class="op" id="5770261">[</span><span class="ident" id="5770262">j</span><span class="op" id="5770263">]</span><span class="op" id="5770264">,</span>&nbsp;<span class="ident" id="5770266">x</span><span class="op" id="5770267">[</span><span class="ident" id="5770268">i</span><span class="op" id="5770269">]</span>&nbsp;<span class="op" id="5770271">}</span><br>
<span class="lineno">365</span><span class="keyword" id="5770273">func</span>&nbsp;<span class="op" id="5770278">(</span><span class="ident" id="5770279">x</span>&nbsp;<span class="ident" id="5770281">byInUseBytes</span><span class="op" id="5770293">)</span>&nbsp;<span class="ident" id="5770295">Less</span><span class="op" id="5770299">(</span><span class="ident" id="5770300">i</span><span class="op" id="5770301">,</span>&nbsp;<span class="ident" id="5770303">j</span>&nbsp;<span class="builtintype" id="5770305">int</span><span class="op" id="5770308">)</span>&nbsp;<span class="builtintype" id="5770310">bool</span>&nbsp;<span class="op" id="5770315">{</span>&nbsp;<span class="keyword" id="5770317">return</span>&nbsp;<span class="ident" id="5770324">x</span><span class="op" id="5770325">[</span><span class="ident" id="5770326">i</span><span class="op" id="5770327">]</span><span class="op" id="5770328">.</span><span class="ident" id="5770329">InUseBytes</span><span class="op" id="5770339">(</span><span class="op" id="5770340">)</span>&nbsp;<span class="op" id="5770342">&gt;</span>&nbsp;<span class="ident" id="5770344">x</span><span class="op" id="5770345">[</span><span class="ident" id="5770346">j</span><span class="op" id="5770347">]</span><span class="op" id="5770348">.</span><span class="ident" id="5770349">InUseBytes</span><span class="op" id="5770359">(</span><span class="op" id="5770360">)</span>&nbsp;<span class="op" id="5770362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5770365">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="5770432">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="5770480">func</span>&nbsp;<span class="ident" id="5770485">WriteHeapProfile</span><span class="op" id="5770501">(</span><span class="ident" id="5770502">w</span>&nbsp;<span class="ident" id="5770504">io</span><span class="op" id="5770506">.</span><span class="ident" id="5770507">Writer</span><span class="op" id="5770513">)</span>&nbsp;<span class="builtintype" id="5770515">error</span>&nbsp;<span class="op" id="5770521">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5770524">return</span>&nbsp;<span class="ident" id="5770531">writeHeap</span><span class="op" id="5770540">(</span><span class="ident" id="5770541">w</span><span class="op" id="5770542">,</span>&nbsp;<span class="num" id="5770544">0</span><span class="op" id="5770545">)</span><br>
<span class="lineno"></span><span class="op" id="5770547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5770550">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5770614">func</span>&nbsp;<span class="ident" id="5770619">countHeap</span><span class="op" id="5770628">(</span><span class="op" id="5770629">)</span>&nbsp;<span class="builtintype" id="5770631">int</span>&nbsp;<span class="op" id="5770635">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5770638">n</span><span class="op" id="5770639">,</span>&nbsp;<span class="ident" id="5770641">_</span>&nbsp;<span class="op" id="5770643">:=</span>&nbsp;<span class="ident" id="5770646">runtime</span><span class="op" id="5770653">.</span><span class="ident" id="5770654">MemProfile</span><span class="op" id="5770664">(</span><span class="ident" id="5770665">nil</span><span class="op" id="5770668">,</span>&nbsp;<span class="builtintype" id="5770670">true</span><span class="op" id="5770674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5770677">return</span>&nbsp;<span class="ident" id="5770684">n</span><br>
<span class="lineno"></span><span class="op" id="5770686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5770689">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="5770748">func</span>&nbsp;<span class="ident" id="5770753">writeHeap</span><span class="op" id="5770762">(</span><span class="ident" id="5770763">w</span>&nbsp;<span class="ident" id="5770765">io</span><span class="op" id="5770767">.</span><span class="ident" id="5770768">Writer</span><span class="op" id="5770774">,</span>&nbsp;<span class="ident" id="5770776">debug</span>&nbsp;<span class="builtintype" id="5770782">int</span><span class="op" id="5770785">)</span>&nbsp;<span class="builtintype" id="5770787">error</span>&nbsp;<span class="op" id="5770793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5770796">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5770861">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5770911">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5770968">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771031">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771077">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771144">var</span>&nbsp;<span class="ident" id="5771148">p</span>&nbsp;<span class="op" id="5771150">[</span><span class="op" id="5771151">]</span><span class="ident" id="5771152">runtime</span><span class="op" id="5771159">.</span><span class="ident" id="5771160">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771178">n</span><span class="op" id="5771179">,</span>&nbsp;<span class="ident" id="5771181">ok</span>&nbsp;<span class="op" id="5771184">:=</span>&nbsp;<span class="ident" id="5771187">runtime</span><span class="op" id="5771194">.</span><span class="ident" id="5771195">MemProfile</span><span class="op" id="5771205">(</span><span class="ident" id="5771206">nil</span><span class="op" id="5771209">,</span>&nbsp;<span class="builtintype" id="5771211">true</span><span class="op" id="5771215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771218">for</span>&nbsp;<span class="op" id="5771222">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771226">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771276">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771324">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771359">p</span>&nbsp;<span class="op" id="5771361">=</span>&nbsp;<span class="builtinfunc" id="5771363">make</span><span class="op" id="5771367">(</span><span class="op" id="5771368">[</span><span class="op" id="5771369">]</span><span class="ident" id="5771370">runtime</span><span class="op" id="5771377">.</span><span class="ident" id="5771378">MemProfileRecord</span><span class="op" id="5771394">,</span>&nbsp;<span class="ident" id="5771396">n</span><span class="op" id="5771397">+</span><span class="num" id="5771398">50</span><span class="op" id="5771400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771404">n</span><span class="op" id="5771405">,</span>&nbsp;<span class="ident" id="5771407">ok</span>&nbsp;<span class="op" id="5771410">=</span>&nbsp;<span class="ident" id="5771412">runtime</span><span class="op" id="5771419">.</span><span class="ident" id="5771420">MemProfile</span><span class="op" id="5771430">(</span><span class="ident" id="5771431">p</span><span class="op" id="5771432">,</span>&nbsp;<span class="builtintype" id="5771434">true</span><span class="op" id="5771438">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771442">if</span>&nbsp;<span class="ident" id="5771445">ok</span>&nbsp;<span class="op" id="5771448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771453">p</span>&nbsp;<span class="op" id="5771455">=</span>&nbsp;<span class="ident" id="5771457">p</span><span class="op" id="5771458">[</span><span class="num" id="5771459">0</span><span class="op" id="5771460">:</span><span class="ident" id="5771461">n</span><span class="op" id="5771462">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771467">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5771475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771479">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5771508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771512">sort</span><span class="op" id="5771516">.</span><span class="ident" id="5771517">Sort</span><span class="op" id="5771521">(</span><span class="ident" id="5771522">byInUseBytes</span><span class="op" id="5771534">(</span><span class="ident" id="5771535">p</span><span class="op" id="5771536">)</span><span class="op" id="5771537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771541">b</span>&nbsp;<span class="op" id="5771543">:=</span>&nbsp;<span class="ident" id="5771546">bufio</span><span class="op" id="5771551">.</span><span class="ident" id="5771552">NewWriter</span><span class="op" id="5771561">(</span><span class="ident" id="5771562">w</span><span class="op" id="5771563">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771566">var</span>&nbsp;<span class="ident" id="5771570">tw</span>&nbsp;<span class="op" id="5771573">*</span><span class="ident" id="5771574">tabwriter</span><span class="op" id="5771583">.</span><span class="ident" id="5771584">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771592">w</span>&nbsp;<span class="op" id="5771594">=</span>&nbsp;<span class="ident" id="5771596">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771599">if</span>&nbsp;<span class="ident" id="5771602">debug</span>&nbsp;<span class="op" id="5771608">&gt;</span>&nbsp;<span class="num" id="5771610">0</span>&nbsp;<span class="op" id="5771612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771616">tw</span>&nbsp;<span class="op" id="5771619">=</span>&nbsp;<span class="ident" id="5771621">tabwriter</span><span class="op" id="5771630">.</span><span class="ident" id="5771631">NewWriter</span><span class="op" id="5771640">(</span><span class="ident" id="5771641">w</span><span class="op" id="5771642">,</span>&nbsp;<span class="num" id="5771644">1</span><span class="op" id="5771645">,</span>&nbsp;<span class="num" id="5771647">8</span><span class="op" id="5771648">,</span>&nbsp;<span class="num" id="5771650">1</span><span class="op" id="5771651">,</span>&nbsp;<span class="string" id="5771653">&#39;\t&#39;</span><span class="op" id="5771657">,</span>&nbsp;<span class="num" id="5771659">0</span><span class="op" id="5771660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771664">w</span>&nbsp;<span class="op" id="5771666">=</span>&nbsp;<span class="ident" id="5771668">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5771672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771676">var</span>&nbsp;<span class="ident" id="5771680">total</span>&nbsp;<span class="ident" id="5771686">runtime</span><span class="op" id="5771693">.</span><span class="ident" id="5771694">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5771712">for</span>&nbsp;<span class="ident" id="5771716">i</span>&nbsp;<span class="op" id="5771718">:=</span>&nbsp;<span class="keyword" id="5771721">range</span>&nbsp;<span class="ident" id="5771727">p</span>&nbsp;<span class="op" id="5771729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771733">r</span>&nbsp;<span class="op" id="5771735">:=</span>&nbsp;<span class="op" id="5771738">&amp;</span><span class="ident" id="5771739">p</span><span class="op" id="5771740">[</span><span class="ident" id="5771741">i</span><span class="op" id="5771742">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771746">total</span><span class="op" id="5771751">.</span><span class="ident" id="5771752">AllocBytes</span>&nbsp;<span class="op" id="5771763">+=</span>&nbsp;<span class="ident" id="5771766">r</span><span class="op" id="5771767">.</span><span class="ident" id="5771768">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771781">total</span><span class="op" id="5771786">.</span><span class="ident" id="5771787">AllocObjects</span>&nbsp;<span class="op" id="5771800">+=</span>&nbsp;<span class="ident" id="5771803">r</span><span class="op" id="5771804">.</span><span class="ident" id="5771805">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771820">total</span><span class="op" id="5771825">.</span><span class="ident" id="5771826">FreeBytes</span>&nbsp;<span class="op" id="5771836">+=</span>&nbsp;<span class="ident" id="5771839">r</span><span class="op" id="5771840">.</span><span class="ident" id="5771841">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5771853">total</span><span class="op" id="5771858">.</span><span class="ident" id="5771859">FreeObjects</span>&nbsp;<span class="op" id="5771871">+=</span>&nbsp;<span class="ident" id="5771874">r</span><span class="op" id="5771875">.</span><span class="ident" id="5771876">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5771889">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771893">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5771958">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5772033">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772078">fmt</span><span class="op" id="5772081">.</span><span class="ident" id="5772082">Fprintf</span><span class="op" id="5772089">(</span><span class="ident" id="5772090">w</span><span class="op" id="5772091">,</span>&nbsp;<span class="string" id="5772093">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="5772136">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772140">total</span><span class="op" id="5772145">.</span><span class="ident" id="5772146">InUseObjects</span><span class="op" id="5772158">(</span><span class="op" id="5772159">)</span><span class="op" id="5772160">,</span>&nbsp;<span class="ident" id="5772162">total</span><span class="op" id="5772167">.</span><span class="ident" id="5772168">InUseBytes</span><span class="op" id="5772178">(</span><span class="op" id="5772179">)</span><span class="op" id="5772180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772184">total</span><span class="op" id="5772189">.</span><span class="ident" id="5772190">AllocObjects</span><span class="op" id="5772202">,</span>&nbsp;<span class="ident" id="5772204">total</span><span class="op" id="5772209">.</span><span class="ident" id="5772210">AllocBytes</span><span class="op" id="5772220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5772224">2</span><span class="op" id="5772225">*</span><span class="ident" id="5772226">runtime</span><span class="op" id="5772233">.</span><span class="ident" id="5772234">MemProfileRate</span><span class="op" id="5772248">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5772252">for</span>&nbsp;<span class="ident" id="5772256">i</span>&nbsp;<span class="op" id="5772258">:=</span>&nbsp;<span class="keyword" id="5772261">range</span>&nbsp;<span class="ident" id="5772267">p</span>&nbsp;<span class="op" id="5772269">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772273">r</span>&nbsp;<span class="op" id="5772275">:=</span>&nbsp;<span class="op" id="5772278">&amp;</span><span class="ident" id="5772279">p</span><span class="op" id="5772280">[</span><span class="ident" id="5772281">i</span><span class="op" id="5772282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772286">fmt</span><span class="op" id="5772289">.</span><span class="ident" id="5772290">Fprintf</span><span class="op" id="5772297">(</span><span class="ident" id="5772298">w</span><span class="op" id="5772299">,</span>&nbsp;<span class="string" id="5772301">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="5772320">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772325">r</span><span class="op" id="5772326">.</span><span class="ident" id="5772327">InUseObjects</span><span class="op" id="5772339">(</span><span class="op" id="5772340">)</span><span class="op" id="5772341">,</span>&nbsp;<span class="ident" id="5772343">r</span><span class="op" id="5772344">.</span><span class="ident" id="5772345">InUseBytes</span><span class="op" id="5772355">(</span><span class="op" id="5772356">)</span><span class="op" id="5772357">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772362">r</span><span class="op" id="5772363">.</span><span class="ident" id="5772364">AllocObjects</span><span class="op" id="5772376">,</span>&nbsp;<span class="ident" id="5772378">r</span><span class="op" id="5772379">.</span><span class="ident" id="5772380">AllocBytes</span><span class="op" id="5772390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5772394">for</span>&nbsp;<span class="ident" id="5772398">_</span><span class="op" id="5772399">,</span>&nbsp;<span class="ident" id="5772401">pc</span>&nbsp;<span class="op" id="5772404">:=</span>&nbsp;<span class="keyword" id="5772407">range</span>&nbsp;<span class="ident" id="5772413">r</span><span class="op" id="5772414">.</span><span class="ident" id="5772415">Stack</span><span class="op" id="5772420">(</span><span class="op" id="5772421">)</span>&nbsp;<span class="op" id="5772423">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772428">fmt</span><span class="op" id="5772431">.</span><span class="ident" id="5772432">Fprintf</span><span class="op" id="5772439">(</span><span class="ident" id="5772440">w</span><span class="op" id="5772441">,</span>&nbsp;<span class="string" id="5772443">&#34;&nbsp;%#x&#34;</span><span class="op" id="5772449">,</span>&nbsp;<span class="ident" id="5772451">pc</span><span class="op" id="5772453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5772457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772461">fmt</span><span class="op" id="5772464">.</span><span class="ident" id="5772465">Fprintf</span><span class="op" id="5772472">(</span><span class="ident" id="5772473">w</span><span class="op" id="5772474">,</span>&nbsp;<span class="string" id="5772476">&#34;\n&#34;</span><span class="op" id="5772480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5772484">if</span>&nbsp;<span class="ident" id="5772487">debug</span>&nbsp;<span class="op" id="5772493">&gt;</span>&nbsp;<span class="num" id="5772495">0</span>&nbsp;<span class="op" id="5772497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772502">printStackRecord</span><span class="op" id="5772518">(</span><span class="ident" id="5772519">w</span><span class="op" id="5772520">,</span>&nbsp;<span class="ident" id="5772522">r</span><span class="op" id="5772523">.</span><span class="ident" id="5772524">Stack</span><span class="op" id="5772529">(</span><span class="op" id="5772530">)</span><span class="op" id="5772531">,</span>&nbsp;<span class="builtintype" id="5772533">false</span><span class="op" id="5772538">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5772542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5772545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5772549">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5772585">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5772630">if</span>&nbsp;<span class="ident" id="5772633">debug</span>&nbsp;<span class="op" id="5772639">&gt;</span>&nbsp;<span class="num" id="5772641">0</span>&nbsp;<span class="op" id="5772643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772647">s</span>&nbsp;<span class="op" id="5772649">:=</span>&nbsp;<span class="builtinfunc" id="5772652">new</span><span class="op" id="5772655">(</span><span class="ident" id="5772656">runtime</span><span class="op" id="5772663">.</span><span class="ident" id="5772664">MemStats</span><span class="op" id="5772672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772676">runtime</span><span class="op" id="5772683">.</span><span class="ident" id="5772684">ReadMemStats</span><span class="op" id="5772696">(</span><span class="ident" id="5772697">s</span><span class="op" id="5772698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772702">fmt</span><span class="op" id="5772705">.</span><span class="ident" id="5772706">Fprintf</span><span class="op" id="5772713">(</span><span class="ident" id="5772714">w</span><span class="op" id="5772715">,</span>&nbsp;<span class="string" id="5772717">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="5772741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772745">fmt</span><span class="op" id="5772748">.</span><span class="ident" id="5772749">Fprintf</span><span class="op" id="5772756">(</span><span class="ident" id="5772757">w</span><span class="op" id="5772758">,</span>&nbsp;<span class="string" id="5772760">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5772776">,</span>&nbsp;<span class="ident" id="5772778">s</span><span class="op" id="5772779">.</span><span class="ident" id="5772780">Alloc</span><span class="op" id="5772785">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772789">fmt</span><span class="op" id="5772792">.</span><span class="ident" id="5772793">Fprintf</span><span class="op" id="5772800">(</span><span class="ident" id="5772801">w</span><span class="op" id="5772802">,</span>&nbsp;<span class="string" id="5772804">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5772825">,</span>&nbsp;<span class="ident" id="5772827">s</span><span class="op" id="5772828">.</span><span class="ident" id="5772829">TotalAlloc</span><span class="op" id="5772839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772843">fmt</span><span class="op" id="5772846">.</span><span class="ident" id="5772847">Fprintf</span><span class="op" id="5772854">(</span><span class="ident" id="5772855">w</span><span class="op" id="5772856">,</span>&nbsp;<span class="string" id="5772858">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5772872">,</span>&nbsp;<span class="ident" id="5772874">s</span><span class="op" id="5772875">.</span><span class="ident" id="5772876">Sys</span><span class="op" id="5772879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772883">fmt</span><span class="op" id="5772886">.</span><span class="ident" id="5772887">Fprintf</span><span class="op" id="5772894">(</span><span class="ident" id="5772895">w</span><span class="op" id="5772896">,</span>&nbsp;<span class="string" id="5772898">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5772916">,</span>&nbsp;<span class="ident" id="5772918">s</span><span class="op" id="5772919">.</span><span class="ident" id="5772920">Lookups</span><span class="op" id="5772927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772931">fmt</span><span class="op" id="5772934">.</span><span class="ident" id="5772935">Fprintf</span><span class="op" id="5772942">(</span><span class="ident" id="5772943">w</span><span class="op" id="5772944">,</span>&nbsp;<span class="string" id="5772946">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5772964">,</span>&nbsp;<span class="ident" id="5772966">s</span><span class="op" id="5772967">.</span><span class="ident" id="5772968">Mallocs</span><span class="op" id="5772975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5772979">fmt</span><span class="op" id="5772982">.</span><span class="ident" id="5772983">Fprintf</span><span class="op" id="5772990">(</span><span class="ident" id="5772991">w</span><span class="op" id="5772992">,</span>&nbsp;<span class="string" id="5772994">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773010">,</span>&nbsp;<span class="ident" id="5773012">s</span><span class="op" id="5773013">.</span><span class="ident" id="5773014">Frees</span><span class="op" id="5773019">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773024">fmt</span><span class="op" id="5773027">.</span><span class="ident" id="5773028">Fprintf</span><span class="op" id="5773035">(</span><span class="ident" id="5773036">w</span><span class="op" id="5773037">,</span>&nbsp;<span class="string" id="5773039">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773059">,</span>&nbsp;<span class="ident" id="5773061">s</span><span class="op" id="5773062">.</span><span class="ident" id="5773063">HeapAlloc</span><span class="op" id="5773072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773076">fmt</span><span class="op" id="5773079">.</span><span class="ident" id="5773080">Fprintf</span><span class="op" id="5773087">(</span><span class="ident" id="5773088">w</span><span class="op" id="5773089">,</span>&nbsp;<span class="string" id="5773091">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773109">,</span>&nbsp;<span class="ident" id="5773111">s</span><span class="op" id="5773112">.</span><span class="ident" id="5773113">HeapSys</span><span class="op" id="5773120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773124">fmt</span><span class="op" id="5773127">.</span><span class="ident" id="5773128">Fprintf</span><span class="op" id="5773135">(</span><span class="ident" id="5773136">w</span><span class="op" id="5773137">,</span>&nbsp;<span class="string" id="5773139">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773158">,</span>&nbsp;<span class="ident" id="5773160">s</span><span class="op" id="5773161">.</span><span class="ident" id="5773162">HeapIdle</span><span class="op" id="5773170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773174">fmt</span><span class="op" id="5773177">.</span><span class="ident" id="5773178">Fprintf</span><span class="op" id="5773185">(</span><span class="ident" id="5773186">w</span><span class="op" id="5773187">,</span>&nbsp;<span class="string" id="5773189">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773209">,</span>&nbsp;<span class="ident" id="5773211">s</span><span class="op" id="5773212">.</span><span class="ident" id="5773213">HeapInuse</span><span class="op" id="5773222">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773226">fmt</span><span class="op" id="5773229">.</span><span class="ident" id="5773230">Fprintf</span><span class="op" id="5773237">(</span><span class="ident" id="5773238">w</span><span class="op" id="5773239">,</span>&nbsp;<span class="string" id="5773241">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773264">,</span>&nbsp;<span class="ident" id="5773266">s</span><span class="op" id="5773267">.</span><span class="ident" id="5773268">HeapReleased</span><span class="op" id="5773280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773284">fmt</span><span class="op" id="5773287">.</span><span class="ident" id="5773288">Fprintf</span><span class="op" id="5773295">(</span><span class="ident" id="5773296">w</span><span class="op" id="5773297">,</span>&nbsp;<span class="string" id="5773299">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773321">,</span>&nbsp;<span class="ident" id="5773323">s</span><span class="op" id="5773324">.</span><span class="ident" id="5773325">HeapObjects</span><span class="op" id="5773336">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773341">fmt</span><span class="op" id="5773344">.</span><span class="ident" id="5773345">Fprintf</span><span class="op" id="5773352">(</span><span class="ident" id="5773353">w</span><span class="op" id="5773354">,</span>&nbsp;<span class="string" id="5773356">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5773377">,</span>&nbsp;<span class="ident" id="5773379">s</span><span class="op" id="5773380">.</span><span class="ident" id="5773381">StackInuse</span><span class="op" id="5773391">,</span>&nbsp;<span class="ident" id="5773393">s</span><span class="op" id="5773394">.</span><span class="ident" id="5773395">StackSys</span><span class="op" id="5773403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773407">fmt</span><span class="op" id="5773410">.</span><span class="ident" id="5773411">Fprintf</span><span class="op" id="5773418">(</span><span class="ident" id="5773419">w</span><span class="op" id="5773420">,</span>&nbsp;<span class="string" id="5773422">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5773443">,</span>&nbsp;<span class="ident" id="5773445">s</span><span class="op" id="5773446">.</span><span class="ident" id="5773447">MSpanInuse</span><span class="op" id="5773457">,</span>&nbsp;<span class="ident" id="5773459">s</span><span class="op" id="5773460">.</span><span class="ident" id="5773461">MSpanSys</span><span class="op" id="5773469">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773473">fmt</span><span class="op" id="5773476">.</span><span class="ident" id="5773477">Fprintf</span><span class="op" id="5773484">(</span><span class="ident" id="5773485">w</span><span class="op" id="5773486">,</span>&nbsp;<span class="string" id="5773488">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5773510">,</span>&nbsp;<span class="ident" id="5773512">s</span><span class="op" id="5773513">.</span><span class="ident" id="5773514">MCacheInuse</span><span class="op" id="5773525">,</span>&nbsp;<span class="ident" id="5773527">s</span><span class="op" id="5773528">.</span><span class="ident" id="5773529">MCacheSys</span><span class="op" id="5773538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773542">fmt</span><span class="op" id="5773545">.</span><span class="ident" id="5773546">Fprintf</span><span class="op" id="5773553">(</span><span class="ident" id="5773554">w</span><span class="op" id="5773555">,</span>&nbsp;<span class="string" id="5773557">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773579">,</span>&nbsp;<span class="ident" id="5773581">s</span><span class="op" id="5773582">.</span><span class="ident" id="5773583">BuckHashSys</span><span class="op" id="5773594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773599">fmt</span><span class="op" id="5773602">.</span><span class="ident" id="5773603">Fprintf</span><span class="op" id="5773610">(</span><span class="ident" id="5773611">w</span><span class="op" id="5773612">,</span>&nbsp;<span class="string" id="5773614">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773631">,</span>&nbsp;<span class="ident" id="5773633">s</span><span class="op" id="5773634">.</span><span class="ident" id="5773635">NextGC</span><span class="op" id="5773641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773645">fmt</span><span class="op" id="5773648">.</span><span class="ident" id="5773649">Fprintf</span><span class="op" id="5773656">(</span><span class="ident" id="5773657">w</span><span class="op" id="5773658">,</span>&nbsp;<span class="string" id="5773660">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773678">,</span>&nbsp;<span class="ident" id="5773680">s</span><span class="op" id="5773681">.</span><span class="ident" id="5773682">PauseNs</span><span class="op" id="5773689">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773693">fmt</span><span class="op" id="5773696">.</span><span class="ident" id="5773697">Fprintf</span><span class="op" id="5773704">(</span><span class="ident" id="5773705">w</span><span class="op" id="5773706">,</span>&nbsp;<span class="string" id="5773708">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5773724">,</span>&nbsp;<span class="ident" id="5773726">s</span><span class="op" id="5773727">.</span><span class="ident" id="5773728">NumGC</span><span class="op" id="5773733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773737">fmt</span><span class="op" id="5773740">.</span><span class="ident" id="5773741">Fprintf</span><span class="op" id="5773748">(</span><span class="ident" id="5773749">w</span><span class="op" id="5773750">,</span>&nbsp;<span class="string" id="5773752">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5773771">,</span>&nbsp;<span class="ident" id="5773773">s</span><span class="op" id="5773774">.</span><span class="ident" id="5773775">EnableGC</span><span class="op" id="5773783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773787">fmt</span><span class="op" id="5773790">.</span><span class="ident" id="5773791">Fprintf</span><span class="op" id="5773798">(</span><span class="ident" id="5773799">w</span><span class="op" id="5773800">,</span>&nbsp;<span class="string" id="5773802">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5773820">,</span>&nbsp;<span class="ident" id="5773822">s</span><span class="op" id="5773823">.</span><span class="ident" id="5773824">DebugGC</span><span class="op" id="5773831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5773834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5773838">if</span>&nbsp;<span class="ident" id="5773841">tw</span>&nbsp;<span class="op" id="5773844">!=</span>&nbsp;<span class="ident" id="5773847">nil</span>&nbsp;<span class="op" id="5773851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773855">tw</span><span class="op" id="5773857">.</span><span class="ident" id="5773858">Flush</span><span class="op" id="5773863">(</span><span class="op" id="5773864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5773867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5773870">return</span>&nbsp;<span class="ident" id="5773877">b</span><span class="op" id="5773878">.</span><span class="ident" id="5773879">Flush</span><span class="op" id="5773884">(</span><span class="op" id="5773885">)</span><br>
<span class="lineno"></span><span class="op" id="5773887">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5773890">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="5773964">func</span>&nbsp;<span class="ident" id="5773969">countThreadCreate</span><span class="op" id="5773986">(</span><span class="op" id="5773987">)</span>&nbsp;<span class="builtintype" id="5773989">int</span>&nbsp;<span class="op" id="5773993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5773996">n</span><span class="op" id="5773997">,</span>&nbsp;<span class="ident" id="5773999">_</span>&nbsp;<span class="op" id="5774001">:=</span>&nbsp;<span class="ident" id="5774004">runtime</span><span class="op" id="5774011">.</span><span class="ident" id="5774012">ThreadCreateProfile</span><span class="op" id="5774031">(</span><span class="ident" id="5774032">nil</span><span class="op" id="5774035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774038">return</span>&nbsp;<span class="ident" id="5774045">n</span><br>
<span class="lineno">485</span><span class="op" id="5774047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5774050">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5774124">func</span>&nbsp;<span class="ident" id="5774129">writeThreadCreate</span><span class="op" id="5774146">(</span><span class="ident" id="5774147">w</span>&nbsp;<span class="ident" id="5774149">io</span><span class="op" id="5774151">.</span><span class="ident" id="5774152">Writer</span><span class="op" id="5774158">,</span>&nbsp;<span class="ident" id="5774160">debug</span>&nbsp;<span class="builtintype" id="5774166">int</span><span class="op" id="5774169">)</span>&nbsp;<span class="builtintype" id="5774171">error</span>&nbsp;<span class="op" id="5774177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774180">return</span>&nbsp;<span class="ident" id="5774187">writeRuntimeProfile</span><span class="op" id="5774206">(</span><span class="ident" id="5774207">w</span><span class="op" id="5774208">,</span>&nbsp;<span class="ident" id="5774210">debug</span><span class="op" id="5774215">,</span>&nbsp;<span class="string" id="5774217">&#34;threadcreate&#34;</span><span class="op" id="5774231">,</span>&nbsp;<span class="ident" id="5774233">runtime</span><span class="op" id="5774240">.</span><span class="ident" id="5774241">ThreadCreateProfile</span><span class="op" id="5774260">)</span><br>
<span class="lineno">490</span><span class="op" id="5774262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5774265">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5774317">func</span>&nbsp;<span class="ident" id="5774322">countGoroutine</span><span class="op" id="5774336">(</span><span class="op" id="5774337">)</span>&nbsp;<span class="builtintype" id="5774339">int</span>&nbsp;<span class="op" id="5774343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774346">return</span>&nbsp;<span class="ident" id="5774353">runtime</span><span class="op" id="5774360">.</span><span class="ident" id="5774361">NumGoroutine</span><span class="op" id="5774373">(</span><span class="op" id="5774374">)</span><br>
<span class="lineno">495</span><span class="op" id="5774376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5774379">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5774447">func</span>&nbsp;<span class="ident" id="5774452">writeGoroutine</span><span class="op" id="5774466">(</span><span class="ident" id="5774467">w</span>&nbsp;<span class="ident" id="5774469">io</span><span class="op" id="5774471">.</span><span class="ident" id="5774472">Writer</span><span class="op" id="5774478">,</span>&nbsp;<span class="ident" id="5774480">debug</span>&nbsp;<span class="builtintype" id="5774486">int</span><span class="op" id="5774489">)</span>&nbsp;<span class="builtintype" id="5774491">error</span>&nbsp;<span class="op" id="5774497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774500">if</span>&nbsp;<span class="ident" id="5774503">debug</span>&nbsp;<span class="op" id="5774509">&gt;=</span>&nbsp;<span class="num" id="5774512">2</span>&nbsp;<span class="op" id="5774514">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774518">return</span>&nbsp;<span class="ident" id="5774525">writeGoroutineStacks</span><span class="op" id="5774545">(</span><span class="ident" id="5774546">w</span><span class="op" id="5774547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5774550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774553">return</span>&nbsp;<span class="ident" id="5774560">writeRuntimeProfile</span><span class="op" id="5774579">(</span><span class="ident" id="5774580">w</span><span class="op" id="5774581">,</span>&nbsp;<span class="ident" id="5774583">debug</span><span class="op" id="5774588">,</span>&nbsp;<span class="string" id="5774590">&#34;goroutine&#34;</span><span class="op" id="5774601">,</span>&nbsp;<span class="ident" id="5774603">runtime</span><span class="op" id="5774610">.</span><span class="ident" id="5774611">GoroutineProfile</span><span class="op" id="5774627">)</span><br>
<span class="lineno"></span><span class="op" id="5774629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="5774632">func</span>&nbsp;<span class="ident" id="5774637">writeGoroutineStacks</span><span class="op" id="5774657">(</span><span class="ident" id="5774658">w</span>&nbsp;<span class="ident" id="5774660">io</span><span class="op" id="5774662">.</span><span class="ident" id="5774663">Writer</span><span class="op" id="5774669">)</span>&nbsp;<span class="builtintype" id="5774671">error</span>&nbsp;<span class="op" id="5774677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5774680">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5774740">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5774822">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5774884">buf</span>&nbsp;<span class="op" id="5774888">:=</span>&nbsp;<span class="builtinfunc" id="5774891">make</span><span class="op" id="5774895">(</span><span class="op" id="5774896">[</span><span class="op" id="5774897">]</span><span class="builtintype" id="5774898">byte</span><span class="op" id="5774902">,</span>&nbsp;<span class="num" id="5774904">1</span><span class="op" id="5774905">&lt;&lt;</span><span class="num" id="5774907">20</span><span class="op" id="5774909">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774912">for</span>&nbsp;<span class="ident" id="5774916">i</span>&nbsp;<span class="op" id="5774918">:=</span>&nbsp;<span class="num" id="5774921">0</span><span class="op" id="5774922">;</span>&nbsp;<span class="op" id="5774924">;</span>&nbsp;<span class="ident" id="5774926">i</span><span class="op" id="5774927">++</span>&nbsp;<span class="op" id="5774930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5774934">n</span>&nbsp;<span class="op" id="5774936">:=</span>&nbsp;<span class="ident" id="5774939">runtime</span><span class="op" id="5774946">.</span><span class="ident" id="5774947">Stack</span><span class="op" id="5774952">(</span><span class="ident" id="5774953">buf</span><span class="op" id="5774956">,</span>&nbsp;<span class="builtintype" id="5774958">true</span><span class="op" id="5774962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5774966">if</span>&nbsp;<span class="ident" id="5774969">n</span>&nbsp;<span class="op" id="5774971">&lt;</span>&nbsp;<span class="builtinfunc" id="5774973">len</span><span class="op" id="5774976">(</span><span class="ident" id="5774977">buf</span><span class="op" id="5774980">)</span>&nbsp;<span class="op" id="5774982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5774987">buf</span>&nbsp;<span class="op" id="5774991">=</span>&nbsp;<span class="ident" id="5774993">buf</span><span class="op" id="5774996">[</span><span class="op" id="5774997">:</span><span class="ident" id="5774998">n</span><span class="op" id="5774999">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775004">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5775012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775016">if</span>&nbsp;<span class="builtinfunc" id="5775019">len</span><span class="op" id="5775022">(</span><span class="ident" id="5775023">buf</span><span class="op" id="5775026">)</span>&nbsp;<span class="op" id="5775028">&gt;=</span>&nbsp;<span class="num" id="5775031">64</span><span class="op" id="5775033">&lt;&lt;</span><span class="num" id="5775035">20</span>&nbsp;<span class="op" id="5775038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775043">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775076">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5775084">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775088">buf</span>&nbsp;<span class="op" id="5775092">=</span>&nbsp;<span class="builtinfunc" id="5775094">make</span><span class="op" id="5775098">(</span><span class="op" id="5775099">[</span><span class="op" id="5775100">]</span><span class="builtintype" id="5775101">byte</span><span class="op" id="5775105">,</span>&nbsp;<span class="num" id="5775107">2</span><span class="op" id="5775108">*</span><span class="builtinfunc" id="5775109">len</span><span class="op" id="5775112">(</span><span class="ident" id="5775113">buf</span><span class="op" id="5775116">)</span><span class="op" id="5775117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5775120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775123">_</span><span class="op" id="5775124">,</span>&nbsp;<span class="ident" id="5775126">err</span>&nbsp;<span class="op" id="5775130">:=</span>&nbsp;<span class="ident" id="5775133">w</span><span class="op" id="5775134">.</span><span class="ident" id="5775135">Write</span><span class="op" id="5775140">(</span><span class="ident" id="5775141">buf</span><span class="op" id="5775144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775147">return</span>&nbsp;<span class="ident" id="5775154">err</span><br>
<span class="lineno"></span><span class="op" id="5775158">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="5775161">func</span>&nbsp;<span class="ident" id="5775166">writeRuntimeProfile</span><span class="op" id="5775185">(</span><span class="ident" id="5775186">w</span>&nbsp;<span class="ident" id="5775188">io</span><span class="op" id="5775190">.</span><span class="ident" id="5775191">Writer</span><span class="op" id="5775197">,</span>&nbsp;<span class="ident" id="5775199">debug</span>&nbsp;<span class="builtintype" id="5775205">int</span><span class="op" id="5775208">,</span>&nbsp;<span class="ident" id="5775210">name</span>&nbsp;<span class="builtintype" id="5775215">string</span><span class="op" id="5775221">,</span>&nbsp;<span class="ident" id="5775223">fetch</span>&nbsp;<span class="keyword" id="5775229">func</span><span class="op" id="5775233">(</span><span class="op" id="5775234">[</span><span class="op" id="5775235">]</span><span class="ident" id="5775236">runtime</span><span class="op" id="5775243">.</span><span class="ident" id="5775244">StackRecord</span><span class="op" id="5775255">)</span>&nbsp;<span class="op" id="5775257">(</span><span class="builtintype" id="5775258">int</span><span class="op" id="5775261">,</span>&nbsp;<span class="builtintype" id="5775263">bool</span><span class="op" id="5775267">)</span><span class="op" id="5775268">)</span>&nbsp;<span class="builtintype" id="5775270">error</span>&nbsp;<span class="op" id="5775276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775279">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775333">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775383">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775440">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775503">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775549">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775616">var</span>&nbsp;<span class="ident" id="5775620">p</span>&nbsp;<span class="op" id="5775622">[</span><span class="op" id="5775623">]</span><span class="ident" id="5775624">runtime</span><span class="op" id="5775631">.</span><span class="ident" id="5775632">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775645">n</span><span class="op" id="5775646">,</span>&nbsp;<span class="ident" id="5775648">ok</span>&nbsp;<span class="op" id="5775651">:=</span>&nbsp;<span class="ident" id="5775654">fetch</span><span class="op" id="5775659">(</span><span class="ident" id="5775660">nil</span><span class="op" id="5775663">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775666">for</span>&nbsp;<span class="op" id="5775670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775674">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775724">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775772">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775810">p</span>&nbsp;<span class="op" id="5775812">=</span>&nbsp;<span class="builtinfunc" id="5775814">make</span><span class="op" id="5775818">(</span><span class="op" id="5775819">[</span><span class="op" id="5775820">]</span><span class="ident" id="5775821">runtime</span><span class="op" id="5775828">.</span><span class="ident" id="5775829">StackRecord</span><span class="op" id="5775840">,</span>&nbsp;<span class="ident" id="5775842">n</span><span class="op" id="5775843">+</span><span class="num" id="5775844">10</span><span class="op" id="5775846">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775850">n</span><span class="op" id="5775851">,</span>&nbsp;<span class="ident" id="5775853">ok</span>&nbsp;<span class="op" id="5775856">=</span>&nbsp;<span class="ident" id="5775858">fetch</span><span class="op" id="5775863">(</span><span class="ident" id="5775864">p</span><span class="op" id="5775865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775869">if</span>&nbsp;<span class="ident" id="5775872">ok</span>&nbsp;<span class="op" id="5775875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775880">p</span>&nbsp;<span class="op" id="5775882">=</span>&nbsp;<span class="ident" id="5775884">p</span><span class="op" id="5775885">[</span><span class="num" id="5775886">0</span><span class="op" id="5775887">:</span><span class="ident" id="5775888">n</span><span class="op" id="5775889">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775894">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5775902">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775906">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5775935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775939">return</span>&nbsp;<span class="ident" id="5775946">printCountProfile</span><span class="op" id="5775963">(</span><span class="ident" id="5775964">w</span><span class="op" id="5775965">,</span>&nbsp;<span class="ident" id="5775967">debug</span><span class="op" id="5775972">,</span>&nbsp;<span class="ident" id="5775974">name</span><span class="op" id="5775978">,</span>&nbsp;<span class="ident" id="5775980">runtimeProfile</span><span class="op" id="5775994">(</span><span class="ident" id="5775995">p</span><span class="op" id="5775996">)</span><span class="op" id="5775997">)</span><br>
<span class="lineno"></span><span class="op" id="5775999">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="5776002">type</span>&nbsp;<span class="ident" id="5776007">runtimeProfile</span>&nbsp;<span class="op" id="5776022">[</span><span class="op" id="5776023">]</span><span class="ident" id="5776024">runtime</span><span class="op" id="5776031">.</span><span class="ident" id="5776032">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5776045">func</span>&nbsp;<span class="op" id="5776050">(</span><span class="ident" id="5776051">p</span>&nbsp;<span class="ident" id="5776053">runtimeProfile</span><span class="op" id="5776067">)</span>&nbsp;<span class="ident" id="5776069">Len</span><span class="op" id="5776072">(</span><span class="op" id="5776073">)</span>&nbsp;<span class="builtintype" id="5776075">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776092">{</span>&nbsp;<span class="keyword" id="5776094">return</span>&nbsp;<span class="builtinfunc" id="5776101">len</span><span class="op" id="5776104">(</span><span class="ident" id="5776105">p</span><span class="op" id="5776106">)</span>&nbsp;<span class="op" id="5776108">}</span><br>
<span class="lineno"></span><span class="keyword" id="5776110">func</span>&nbsp;<span class="op" id="5776115">(</span><span class="ident" id="5776116">p</span>&nbsp;<span class="ident" id="5776118">runtimeProfile</span><span class="op" id="5776132">)</span>&nbsp;<span class="ident" id="5776134">Stack</span><span class="op" id="5776139">(</span><span class="ident" id="5776140">i</span>&nbsp;<span class="builtintype" id="5776142">int</span><span class="op" id="5776145">)</span>&nbsp;<span class="op" id="5776147">[</span><span class="op" id="5776148">]</span><span class="builtintype" id="5776149">uintptr</span>&nbsp;<span class="op" id="5776157">{</span>&nbsp;<span class="keyword" id="5776159">return</span>&nbsp;<span class="ident" id="5776166">p</span><span class="op" id="5776167">[</span><span class="ident" id="5776168">i</span><span class="op" id="5776169">]</span><span class="op" id="5776170">.</span><span class="ident" id="5776171">Stack</span><span class="op" id="5776176">(</span><span class="op" id="5776177">)</span>&nbsp;<span class="op" id="5776179">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="5776182">var</span>&nbsp;<span class="ident" id="5776186">cpu</span>&nbsp;<span class="keyword" id="5776190">struct</span>&nbsp;<span class="op" id="5776197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776200">sync</span><span class="op" id="5776204">.</span><span class="ident" id="5776205">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776212">profiling</span>&nbsp;<span class="builtintype" id="5776222">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776228">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776238">chan</span>&nbsp;<span class="builtintype" id="5776243">bool</span><br>
<span class="lineno">560</span><span class="op" id="5776248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5776251">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="5776317">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5776384">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="5776453">func</span>&nbsp;<span class="ident" id="5776458">StartCPUProfile</span><span class="op" id="5776473">(</span><span class="ident" id="5776474">w</span>&nbsp;<span class="ident" id="5776476">io</span><span class="op" id="5776478">.</span><span class="ident" id="5776479">Writer</span><span class="op" id="5776485">)</span>&nbsp;<span class="builtintype" id="5776487">error</span>&nbsp;<span class="op" id="5776493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776496">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776554">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776615">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776672">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776730">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776790">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776847">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776902">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776962">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777021">const</span>&nbsp;<span class="ident" id="5777027">hz</span>&nbsp;<span class="op" id="5777030">=</span>&nbsp;<span class="num" id="5777032">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777038">cpu</span><span class="op" id="5777041">.</span><span class="ident" id="5777042">Lock</span><span class="op" id="5777046">(</span><span class="op" id="5777047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777050">defer</span>&nbsp;<span class="ident" id="5777056">cpu</span><span class="op" id="5777059">.</span><span class="ident" id="5777060">Unlock</span><span class="op" id="5777066">(</span><span class="op" id="5777067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777070">if</span>&nbsp;<span class="ident" id="5777073">cpu</span><span class="op" id="5777076">.</span><span class="ident" id="5777077">done</span>&nbsp;<span class="op" id="5777082">==</span>&nbsp;<span class="ident" id="5777085">nil</span>&nbsp;<span class="op" id="5777089">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777093">cpu</span><span class="op" id="5777096">.</span><span class="ident" id="5777097">done</span>&nbsp;<span class="op" id="5777102">=</span>&nbsp;<span class="builtinfunc" id="5777104">make</span><span class="op" id="5777108">(</span><span class="keyword" id="5777109">chan</span>&nbsp;<span class="builtintype" id="5777114">bool</span><span class="op" id="5777118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777124">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777142">if</span>&nbsp;<span class="ident" id="5777145">cpu</span><span class="op" id="5777148">.</span><span class="ident" id="5777149">profiling</span>&nbsp;<span class="op" id="5777159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777163">return</span>&nbsp;<span class="ident" id="5777170">fmt</span><span class="op" id="5777173">.</span><span class="ident" id="5777174">Errorf</span><span class="op" id="5777180">(</span><span class="string" id="5777181">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="5777211">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777217">cpu</span><span class="op" id="5777220">.</span><span class="ident" id="5777221">profiling</span>&nbsp;<span class="op" id="5777231">=</span>&nbsp;<span class="builtintype" id="5777233">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777239">runtime</span><span class="op" id="5777246">.</span><span class="ident" id="5777247">SetCPUProfileRate</span><span class="op" id="5777264">(</span><span class="ident" id="5777265">hz</span><span class="op" id="5777267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777270">go</span>&nbsp;<span class="ident" id="5777273">profileWriter</span><span class="op" id="5777286">(</span><span class="ident" id="5777287">w</span><span class="op" id="5777288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777291">return</span>&nbsp;<span class="ident" id="5777298">nil</span><br>
<span class="lineno">590</span><span class="op" id="5777302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5777305">func</span>&nbsp;<span class="ident" id="5777310">profileWriter</span><span class="op" id="5777323">(</span><span class="ident" id="5777324">w</span>&nbsp;<span class="ident" id="5777326">io</span><span class="op" id="5777328">.</span><span class="ident" id="5777329">Writer</span><span class="op" id="5777335">)</span>&nbsp;<span class="op" id="5777337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777340">for</span>&nbsp;<span class="op" id="5777344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777348">data</span>&nbsp;<span class="op" id="5777353">:=</span>&nbsp;<span class="ident" id="5777356">runtime</span><span class="op" id="5777363">.</span><span class="ident" id="5777364">CPUProfile</span><span class="op" id="5777374">(</span><span class="op" id="5777375">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777379">if</span>&nbsp;<span class="ident" id="5777382">data</span>&nbsp;<span class="op" id="5777387">==</span>&nbsp;<span class="ident" id="5777390">nil</span>&nbsp;<span class="op" id="5777394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777399">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777411">w</span><span class="op" id="5777412">.</span><span class="ident" id="5777413">Write</span><span class="op" id="5777418">(</span><span class="ident" id="5777419">data</span><span class="op" id="5777423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777426">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777429">cpu</span><span class="op" id="5777432">.</span><span class="ident" id="5777433">done</span>&nbsp;<span class="op" id="5777438">&lt;-</span>&nbsp;<span class="builtintype" id="5777441">true</span><br>
<span class="lineno"></span><span class="op" id="5777446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777449">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="5777506">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="5777566">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5777593">func</span>&nbsp;<span class="ident" id="5777598">StopCPUProfile</span><span class="op" id="5777612">(</span><span class="op" id="5777613">)</span>&nbsp;<span class="op" id="5777615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777618">cpu</span><span class="op" id="5777621">.</span><span class="ident" id="5777622">Lock</span><span class="op" id="5777626">(</span><span class="op" id="5777627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777630">defer</span>&nbsp;<span class="ident" id="5777636">cpu</span><span class="op" id="5777639">.</span><span class="ident" id="5777640">Unlock</span><span class="op" id="5777646">(</span><span class="op" id="5777647">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777651">if</span>&nbsp;<span class="op" id="5777654">!</span><span class="ident" id="5777655">cpu</span><span class="op" id="5777658">.</span><span class="ident" id="5777659">profiling</span>&nbsp;<span class="op" id="5777669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777673">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777684">cpu</span><span class="op" id="5777687">.</span><span class="ident" id="5777688">profiling</span>&nbsp;<span class="op" id="5777698">=</span>&nbsp;<span class="builtintype" id="5777700">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777707">runtime</span><span class="op" id="5777714">.</span><span class="ident" id="5777715">SetCPUProfileRate</span><span class="op" id="5777732">(</span><span class="num" id="5777733">0</span><span class="op" id="5777734">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777737">&lt;-</span><span class="ident" id="5777739">cpu</span><span class="op" id="5777742">.</span><span class="ident" id="5777743">done</span><br>
<span class="lineno"></span><span class="op" id="5777748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5777751">type</span>&nbsp;<span class="ident" id="5777756">byCycles</span>&nbsp;<span class="op" id="5777765">[</span><span class="op" id="5777766">]</span><span class="ident" id="5777767">runtime</span><span class="op" id="5777774">.</span><span class="ident" id="5777775">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="5777795">func</span>&nbsp;<span class="op" id="5777800">(</span><span class="ident" id="5777801">x</span>&nbsp;<span class="ident" id="5777803">byCycles</span><span class="op" id="5777811">)</span>&nbsp;<span class="ident" id="5777813">Len</span><span class="op" id="5777816">(</span><span class="op" id="5777817">)</span>&nbsp;<span class="builtintype" id="5777819">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5777833">{</span>&nbsp;<span class="keyword" id="5777835">return</span>&nbsp;<span class="builtinfunc" id="5777842">len</span><span class="op" id="5777845">(</span><span class="ident" id="5777846">x</span><span class="op" id="5777847">)</span>&nbsp;<span class="op" id="5777849">}</span><br>
<span class="lineno"></span><span class="keyword" id="5777851">func</span>&nbsp;<span class="op" id="5777856">(</span><span class="ident" id="5777857">x</span>&nbsp;<span class="ident" id="5777859">byCycles</span><span class="op" id="5777867">)</span>&nbsp;<span class="ident" id="5777869">Swap</span><span class="op" id="5777873">(</span><span class="ident" id="5777874">i</span><span class="op" id="5777875">,</span>&nbsp;<span class="ident" id="5777877">j</span>&nbsp;<span class="builtintype" id="5777879">int</span><span class="op" id="5777882">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5777889">{</span>&nbsp;<span class="ident" id="5777891">x</span><span class="op" id="5777892">[</span><span class="ident" id="5777893">i</span><span class="op" id="5777894">]</span><span class="op" id="5777895">,</span>&nbsp;<span class="ident" id="5777897">x</span><span class="op" id="5777898">[</span><span class="ident" id="5777899">j</span><span class="op" id="5777900">]</span>&nbsp;<span class="op" id="5777902">=</span>&nbsp;<span class="ident" id="5777904">x</span><span class="op" id="5777905">[</span><span class="ident" id="5777906">j</span><span class="op" id="5777907">]</span><span class="op" id="5777908">,</span>&nbsp;<span class="ident" id="5777910">x</span><span class="op" id="5777911">[</span><span class="ident" id="5777912">i</span><span class="op" id="5777913">]</span>&nbsp;<span class="op" id="5777915">}</span><br>
<span class="lineno"></span><span class="keyword" id="5777917">func</span>&nbsp;<span class="op" id="5777922">(</span><span class="ident" id="5777923">x</span>&nbsp;<span class="ident" id="5777925">byCycles</span><span class="op" id="5777933">)</span>&nbsp;<span class="ident" id="5777935">Less</span><span class="op" id="5777939">(</span><span class="ident" id="5777940">i</span><span class="op" id="5777941">,</span>&nbsp;<span class="ident" id="5777943">j</span>&nbsp;<span class="builtintype" id="5777945">int</span><span class="op" id="5777948">)</span>&nbsp;<span class="builtintype" id="5777950">bool</span>&nbsp;<span class="op" id="5777955">{</span>&nbsp;<span class="keyword" id="5777957">return</span>&nbsp;<span class="ident" id="5777964">x</span><span class="op" id="5777965">[</span><span class="ident" id="5777966">i</span><span class="op" id="5777967">]</span><span class="op" id="5777968">.</span><span class="ident" id="5777969">Cycles</span>&nbsp;<span class="op" id="5777976">&gt;</span>&nbsp;<span class="ident" id="5777978">x</span><span class="op" id="5777979">[</span><span class="ident" id="5777980">j</span><span class="op" id="5777981">]</span><span class="op" id="5777982">.</span><span class="ident" id="5777983">Cycles</span>&nbsp;<span class="op" id="5777990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777993">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="5778062">func</span>&nbsp;<span class="ident" id="5778067">countBlock</span><span class="op" id="5778077">(</span><span class="op" id="5778078">)</span>&nbsp;<span class="builtintype" id="5778080">int</span>&nbsp;<span class="op" id="5778084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778087">n</span><span class="op" id="5778088">,</span>&nbsp;<span class="ident" id="5778090">_</span>&nbsp;<span class="op" id="5778092">:=</span>&nbsp;<span class="ident" id="5778095">runtime</span><span class="op" id="5778102">.</span><span class="ident" id="5778103">BlockProfile</span><span class="op" id="5778115">(</span><span class="ident" id="5778116">nil</span><span class="op" id="5778119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778122">return</span>&nbsp;<span class="ident" id="5778129">n</span><br>
<span class="lineno"></span><span class="op" id="5778131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="5778134">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5778190">func</span>&nbsp;<span class="ident" id="5778195">writeBlock</span><span class="op" id="5778205">(</span><span class="ident" id="5778206">w</span>&nbsp;<span class="ident" id="5778208">io</span><span class="op" id="5778210">.</span><span class="ident" id="5778211">Writer</span><span class="op" id="5778217">,</span>&nbsp;<span class="ident" id="5778219">debug</span>&nbsp;<span class="builtintype" id="5778225">int</span><span class="op" id="5778228">)</span>&nbsp;<span class="builtintype" id="5778230">error</span>&nbsp;<span class="op" id="5778236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778239">var</span>&nbsp;<span class="ident" id="5778243">p</span>&nbsp;<span class="op" id="5778245">[</span><span class="op" id="5778246">]</span><span class="ident" id="5778247">runtime</span><span class="op" id="5778254">.</span><span class="ident" id="5778255">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778275">n</span><span class="op" id="5778276">,</span>&nbsp;<span class="ident" id="5778278">ok</span>&nbsp;<span class="op" id="5778281">:=</span>&nbsp;<span class="ident" id="5778284">runtime</span><span class="op" id="5778291">.</span><span class="ident" id="5778292">BlockProfile</span><span class="op" id="5778304">(</span><span class="ident" id="5778305">nil</span><span class="op" id="5778308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778311">for</span>&nbsp;<span class="op" id="5778315">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778319">p</span>&nbsp;<span class="op" id="5778321">=</span>&nbsp;<span class="builtinfunc" id="5778323">make</span><span class="op" id="5778327">(</span><span class="op" id="5778328">[</span><span class="op" id="5778329">]</span><span class="ident" id="5778330">runtime</span><span class="op" id="5778337">.</span><span class="ident" id="5778338">BlockProfileRecord</span><span class="op" id="5778356">,</span>&nbsp;<span class="ident" id="5778358">n</span><span class="op" id="5778359">+</span><span class="num" id="5778360">50</span><span class="op" id="5778362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778366">n</span><span class="op" id="5778367">,</span>&nbsp;<span class="ident" id="5778369">ok</span>&nbsp;<span class="op" id="5778372">=</span>&nbsp;<span class="ident" id="5778374">runtime</span><span class="op" id="5778381">.</span><span class="ident" id="5778382">BlockProfile</span><span class="op" id="5778394">(</span><span class="ident" id="5778395">p</span><span class="op" id="5778396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778400">if</span>&nbsp;<span class="ident" id="5778403">ok</span>&nbsp;<span class="op" id="5778406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778411">p</span>&nbsp;<span class="op" id="5778413">=</span>&nbsp;<span class="ident" id="5778415">p</span><span class="op" id="5778416">[</span><span class="op" id="5778417">:</span><span class="ident" id="5778418">n</span><span class="op" id="5778419">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778424">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778439">sort</span><span class="op" id="5778443">.</span><span class="ident" id="5778444">Sort</span><span class="op" id="5778448">(</span><span class="ident" id="5778449">byCycles</span><span class="op" id="5778457">(</span><span class="ident" id="5778458">p</span><span class="op" id="5778459">)</span><span class="op" id="5778460">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778464">b</span>&nbsp;<span class="op" id="5778466">:=</span>&nbsp;<span class="ident" id="5778469">bufio</span><span class="op" id="5778474">.</span><span class="ident" id="5778475">NewWriter</span><span class="op" id="5778484">(</span><span class="ident" id="5778485">w</span><span class="op" id="5778486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778489">var</span>&nbsp;<span class="ident" id="5778493">tw</span>&nbsp;<span class="op" id="5778496">*</span><span class="ident" id="5778497">tabwriter</span><span class="op" id="5778506">.</span><span class="ident" id="5778507">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778515">w</span>&nbsp;<span class="op" id="5778517">=</span>&nbsp;<span class="ident" id="5778519">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778522">if</span>&nbsp;<span class="ident" id="5778525">debug</span>&nbsp;<span class="op" id="5778531">&gt;</span>&nbsp;<span class="num" id="5778533">0</span>&nbsp;<span class="op" id="5778535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778539">tw</span>&nbsp;<span class="op" id="5778542">=</span>&nbsp;<span class="ident" id="5778544">tabwriter</span><span class="op" id="5778553">.</span><span class="ident" id="5778554">NewWriter</span><span class="op" id="5778563">(</span><span class="ident" id="5778564">w</span><span class="op" id="5778565">,</span>&nbsp;<span class="num" id="5778567">1</span><span class="op" id="5778568">,</span>&nbsp;<span class="num" id="5778570">8</span><span class="op" id="5778571">,</span>&nbsp;<span class="num" id="5778573">1</span><span class="op" id="5778574">,</span>&nbsp;<span class="string" id="5778576">&#39;\t&#39;</span><span class="op" id="5778580">,</span>&nbsp;<span class="num" id="5778582">0</span><span class="op" id="5778583">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778587">w</span>&nbsp;<span class="op" id="5778589">=</span>&nbsp;<span class="ident" id="5778591">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778599">fmt</span><span class="op" id="5778602">.</span><span class="ident" id="5778603">Fprintf</span><span class="op" id="5778610">(</span><span class="ident" id="5778611">w</span><span class="op" id="5778612">,</span>&nbsp;<span class="string" id="5778614">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="5778633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778636">fmt</span><span class="op" id="5778639">.</span><span class="ident" id="5778640">Fprintf</span><span class="op" id="5778647">(</span><span class="ident" id="5778648">w</span><span class="op" id="5778649">,</span>&nbsp;<span class="string" id="5778651">&#34;cycles/second=%v\n&#34;</span><span class="op" id="5778671">,</span>&nbsp;<span class="ident" id="5778673">runtime_cyclesPerSecond</span><span class="op" id="5778696">(</span><span class="op" id="5778697">)</span><span class="op" id="5778698">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778701">for</span>&nbsp;<span class="ident" id="5778705">i</span>&nbsp;<span class="op" id="5778707">:=</span>&nbsp;<span class="keyword" id="5778710">range</span>&nbsp;<span class="ident" id="5778716">p</span>&nbsp;<span class="op" id="5778718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778722">r</span>&nbsp;<span class="op" id="5778724">:=</span>&nbsp;<span class="op" id="5778727">&amp;</span><span class="ident" id="5778728">p</span><span class="op" id="5778729">[</span><span class="ident" id="5778730">i</span><span class="op" id="5778731">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778735">fmt</span><span class="op" id="5778738">.</span><span class="ident" id="5778739">Fprintf</span><span class="op" id="5778746">(</span><span class="ident" id="5778747">w</span><span class="op" id="5778748">,</span>&nbsp;<span class="string" id="5778750">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="5778759">,</span>&nbsp;<span class="ident" id="5778761">r</span><span class="op" id="5778762">.</span><span class="ident" id="5778763">Cycles</span><span class="op" id="5778769">,</span>&nbsp;<span class="ident" id="5778771">r</span><span class="op" id="5778772">.</span><span class="ident" id="5778773">Count</span><span class="op" id="5778778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778782">for</span>&nbsp;<span class="ident" id="5778786">_</span><span class="op" id="5778787">,</span>&nbsp;<span class="ident" id="5778789">pc</span>&nbsp;<span class="op" id="5778792">:=</span>&nbsp;<span class="keyword" id="5778795">range</span>&nbsp;<span class="ident" id="5778801">r</span><span class="op" id="5778802">.</span><span class="ident" id="5778803">Stack</span><span class="op" id="5778808">(</span><span class="op" id="5778809">)</span>&nbsp;<span class="op" id="5778811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778816">fmt</span><span class="op" id="5778819">.</span><span class="ident" id="5778820">Fprintf</span><span class="op" id="5778827">(</span><span class="ident" id="5778828">w</span><span class="op" id="5778829">,</span>&nbsp;<span class="string" id="5778831">&#34;&nbsp;%#x&#34;</span><span class="op" id="5778837">,</span>&nbsp;<span class="ident" id="5778839">pc</span><span class="op" id="5778841">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778849">fmt</span><span class="op" id="5778852">.</span><span class="ident" id="5778853">Fprint</span><span class="op" id="5778859">(</span><span class="ident" id="5778860">w</span><span class="op" id="5778861">,</span>&nbsp;<span class="string" id="5778863">&#34;\n&#34;</span><span class="op" id="5778867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778871">if</span>&nbsp;<span class="ident" id="5778874">debug</span>&nbsp;<span class="op" id="5778880">&gt;</span>&nbsp;<span class="num" id="5778882">0</span>&nbsp;<span class="op" id="5778884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778889">printStackRecord</span><span class="op" id="5778905">(</span><span class="ident" id="5778906">w</span><span class="op" id="5778907">,</span>&nbsp;<span class="ident" id="5778909">r</span><span class="op" id="5778910">.</span><span class="ident" id="5778911">Stack</span><span class="op" id="5778916">(</span><span class="op" id="5778917">)</span><span class="op" id="5778918">,</span>&nbsp;<span class="builtintype" id="5778920">true</span><span class="op" id="5778924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778928">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778935">if</span>&nbsp;<span class="ident" id="5778938">tw</span>&nbsp;<span class="op" id="5778941">!=</span>&nbsp;<span class="ident" id="5778944">nil</span>&nbsp;<span class="op" id="5778948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778952">tw</span><span class="op" id="5778954">.</span><span class="ident" id="5778955">Flush</span><span class="op" id="5778960">(</span><span class="op" id="5778961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5778964">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5778967">return</span>&nbsp;<span class="ident" id="5778974">b</span><span class="op" id="5778975">.</span><span class="ident" id="5778976">Flush</span><span class="op" id="5778981">(</span><span class="op" id="5778982">)</span><br>
<span class="lineno"></span><span class="op" id="5778984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5778987">func</span>&nbsp;<span class="ident" id="5778992">runtime_cyclesPerSecond</span><span class="op" id="5779015">(</span><span class="op" id="5779016">)</span>&nbsp;<span class="ident" id="5779018">int64</span>
</div>
</body>
</html>
