<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5273979">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5274034">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5274088">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5274139">package</span>&nbsp;<span class="ident" id="5274147">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5274152">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="5274171">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5274219">import</span>&nbsp;<span class="op" id="5274226">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274229">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274238">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274248">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274255">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274261">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274267">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274275">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274286">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5274297">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5274304">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5274307">var</span>&nbsp;<span class="op" id="5274311">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274314">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5274333">=</span>&nbsp;<span class="ident" id="5274335">errors</span><span class="op" id="5274341">.</span><span class="ident" id="5274342">New</span><span class="op" id="5274345">(</span><span class="string" id="5274346">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="5274375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274378">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5274397">=</span>&nbsp;<span class="ident" id="5274399">errors</span><span class="op" id="5274405">.</span><span class="ident" id="5274406">New</span><span class="op" id="5274409">(</span><span class="string" id="5274410">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="5274446">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274449">ErrWriteAfterClose</span>&nbsp;<span class="op" id="5274468">=</span>&nbsp;<span class="ident" id="5274470">errors</span><span class="op" id="5274476">.</span><span class="ident" id="5274477">New</span><span class="op" id="5274480">(</span><span class="string" id="5274481">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="5274513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274516">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5274535">=</span>&nbsp;<span class="ident" id="5274537">errors</span><span class="op" id="5274543">.</span><span class="ident" id="5274544">New</span><span class="op" id="5274547">(</span><span class="string" id="5274548">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="5274576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274579">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5274598">=</span>&nbsp;<span class="ident" id="5274600">errors</span><span class="op" id="5274606">.</span><span class="ident" id="5274607">New</span><span class="op" id="5274610">(</span><span class="string" id="5274611">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="5274674">)</span><br>
<span class="lineno"></span><span class="op" id="5274676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="5274679">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5274755">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5274805">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="5274894">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="5274938">type</span>&nbsp;<span class="ident" id="5274943">Writer</span>&nbsp;<span class="keyword" id="5274950">struct</span>&nbsp;<span class="op" id="5274957">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274960">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5274971">io</span><span class="op" id="5274973">.</span><span class="ident" id="5274974">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274982">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5274993">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275000">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5275011">int64</span>&nbsp;<span class="comment" id="5275017">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275070">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5275081">int64</span>&nbsp;<span class="comment" id="5275087">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275143">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5275154">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275160">usedBinary</span>&nbsp;<span class="builtintype" id="5275171">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5275187">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275243">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="5275254">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5275270">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275322">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5275333">[</span><span class="ident" id="5275334">blockSize</span><span class="op" id="5275343">]</span><span class="builtintype" id="5275344">byte</span>&nbsp;<span class="comment" id="5275349">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275412">paxHdrBuff</span>&nbsp;<span class="op" id="5275423">[</span><span class="ident" id="5275424">blockSize</span><span class="op" id="5275433">]</span><span class="builtintype" id="5275434">byte</span>&nbsp;<span class="comment" id="5275439">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="5275497">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5275500">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5275548">func</span>&nbsp;<span class="ident" id="5275553">NewWriter</span><span class="op" id="5275562">(</span><span class="ident" id="5275563">w</span>&nbsp;<span class="ident" id="5275565">io</span><span class="op" id="5275567">.</span><span class="ident" id="5275568">Writer</span><span class="op" id="5275574">)</span>&nbsp;<span class="op" id="5275576">*</span><span class="ident" id="5275577">Writer</span>&nbsp;<span class="op" id="5275584">{</span>&nbsp;<span class="keyword" id="5275586">return</span>&nbsp;<span class="op" id="5275593">&amp;</span><span class="ident" id="5275594">Writer</span><span class="op" id="5275600">{</span><span class="ident" id="5275601">w</span><span class="op" id="5275602">:</span>&nbsp;<span class="ident" id="5275604">w</span><span class="op" id="5275605">}</span>&nbsp;<span class="op" id="5275607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275610">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="5275665">func</span>&nbsp;<span class="op" id="5275670">(</span><span class="ident" id="5275671">tw</span>&nbsp;<span class="op" id="5275674">*</span><span class="ident" id="5275675">Writer</span><span class="op" id="5275681">)</span>&nbsp;<span class="ident" id="5275683">Flush</span><span class="op" id="5275688">(</span><span class="op" id="5275689">)</span>&nbsp;<span class="builtintype" id="5275691">error</span>&nbsp;<span class="op" id="5275697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275700">if</span>&nbsp;<span class="ident" id="5275703">tw</span><span class="op" id="5275705">.</span><span class="ident" id="5275706">nb</span>&nbsp;<span class="op" id="5275709">&gt;</span>&nbsp;<span class="num" id="5275711">0</span>&nbsp;<span class="op" id="5275713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275717">tw</span><span class="op" id="5275719">.</span><span class="ident" id="5275720">err</span>&nbsp;<span class="op" id="5275724">=</span>&nbsp;<span class="ident" id="5275726">fmt</span><span class="op" id="5275729">.</span><span class="ident" id="5275730">Errorf</span><span class="op" id="5275736">(</span><span class="string" id="5275737">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="5275775">,</span>&nbsp;<span class="ident" id="5275777">tw</span><span class="op" id="5275779">.</span><span class="ident" id="5275780">nb</span><span class="op" id="5275782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275786">return</span>&nbsp;<span class="ident" id="5275793">tw</span><span class="op" id="5275795">.</span><span class="ident" id="5275796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275801">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275805">n</span>&nbsp;<span class="op" id="5275807">:=</span>&nbsp;<span class="ident" id="5275810">tw</span><span class="op" id="5275812">.</span><span class="ident" id="5275813">nb</span>&nbsp;<span class="op" id="5275816">+</span>&nbsp;<span class="ident" id="5275818">tw</span><span class="op" id="5275820">.</span><span class="ident" id="5275821">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275826">for</span>&nbsp;<span class="ident" id="5275830">n</span>&nbsp;<span class="op" id="5275832">&gt;</span>&nbsp;<span class="num" id="5275834">0</span>&nbsp;<span class="op" id="5275836">&amp;&amp;</span>&nbsp;<span class="ident" id="5275839">tw</span><span class="op" id="5275841">.</span><span class="ident" id="5275842">err</span>&nbsp;<span class="op" id="5275846">==</span>&nbsp;<span class="ident" id="5275849">nil</span>&nbsp;<span class="op" id="5275853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275857">nr</span>&nbsp;<span class="op" id="5275860">:=</span>&nbsp;<span class="ident" id="5275863">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275867">if</span>&nbsp;<span class="ident" id="5275870">nr</span>&nbsp;<span class="op" id="5275873">&gt;</span>&nbsp;<span class="ident" id="5275875">blockSize</span>&nbsp;<span class="op" id="5275885">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275890">nr</span>&nbsp;<span class="op" id="5275893">=</span>&nbsp;<span class="ident" id="5275895">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275911">var</span>&nbsp;<span class="ident" id="5275915">nw</span>&nbsp;<span class="builtintype" id="5275918">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275924">nw</span><span class="op" id="5275926">,</span>&nbsp;<span class="ident" id="5275928">tw</span><span class="op" id="5275930">.</span><span class="ident" id="5275931">err</span>&nbsp;<span class="op" id="5275935">=</span>&nbsp;<span class="ident" id="5275937">tw</span><span class="op" id="5275939">.</span><span class="ident" id="5275940">w</span><span class="op" id="5275941">.</span><span class="ident" id="5275942">Write</span><span class="op" id="5275947">(</span><span class="ident" id="5275948">zeroBlock</span><span class="op" id="5275957">[</span><span class="num" id="5275958">0</span><span class="op" id="5275959">:</span><span class="ident" id="5275960">nr</span><span class="op" id="5275962">]</span><span class="op" id="5275963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275967">n</span>&nbsp;<span class="op" id="5275969">-=</span>&nbsp;<span class="ident" id="5275972">int64</span><span class="op" id="5275977">(</span><span class="ident" id="5275978">nw</span><span class="op" id="5275980">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275986">tw</span><span class="op" id="5275988">.</span><span class="ident" id="5275989">nb</span>&nbsp;<span class="op" id="5275992">=</span>&nbsp;<span class="num" id="5275994">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275997">tw</span><span class="op" id="5275999">.</span><span class="ident" id="5276000">pad</span>&nbsp;<span class="op" id="5276004">=</span>&nbsp;<span class="num" id="5276006">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276009">return</span>&nbsp;<span class="ident" id="5276016">tw</span><span class="op" id="5276018">.</span><span class="ident" id="5276019">err</span><br>
<span class="lineno"></span><span class="op" id="5276023">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5276026">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="5276089">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="5276183">func</span>&nbsp;<span class="op" id="5276188">(</span><span class="ident" id="5276189">tw</span>&nbsp;<span class="op" id="5276192">*</span><span class="ident" id="5276193">Writer</span><span class="op" id="5276199">)</span>&nbsp;<span class="ident" id="5276201">cString</span><span class="op" id="5276208">(</span><span class="ident" id="5276209">b</span>&nbsp;<span class="op" id="5276211">[</span><span class="op" id="5276212">]</span><span class="builtintype" id="5276213">byte</span><span class="op" id="5276217">,</span>&nbsp;<span class="ident" id="5276219">s</span>&nbsp;<span class="builtintype" id="5276221">string</span><span class="op" id="5276227">,</span>&nbsp;<span class="ident" id="5276229">allowPax</span>&nbsp;<span class="builtintype" id="5276238">bool</span><span class="op" id="5276242">,</span>&nbsp;<span class="ident" id="5276244">paxKeyword</span>&nbsp;<span class="builtintype" id="5276255">string</span><span class="op" id="5276261">,</span>&nbsp;<span class="ident" id="5276263">paxHeaders</span>&nbsp;<span class="keyword" id="5276274">map</span><span class="op" id="5276277">[</span><span class="builtintype" id="5276278">string</span><span class="op" id="5276284">]</span><span class="builtintype" id="5276285">string</span><span class="op" id="5276291">)</span>&nbsp;<span class="op" id="5276293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276296">needsPaxHeader</span>&nbsp;<span class="op" id="5276311">:=</span>&nbsp;<span class="ident" id="5276314">allowPax</span>&nbsp;<span class="op" id="5276323">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5276326">len</span><span class="op" id="5276329">(</span><span class="ident" id="5276330">s</span><span class="op" id="5276331">)</span>&nbsp;<span class="op" id="5276333">&gt;</span>&nbsp;<span class="builtinfunc" id="5276335">len</span><span class="op" id="5276338">(</span><span class="ident" id="5276339">b</span><span class="op" id="5276340">)</span>&nbsp;<span class="op" id="5276342">||</span>&nbsp;<span class="op" id="5276345">!</span><span class="ident" id="5276346">isASCII</span><span class="op" id="5276353">(</span><span class="ident" id="5276354">s</span><span class="op" id="5276355">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276358">if</span>&nbsp;<span class="ident" id="5276361">needsPaxHeader</span>&nbsp;<span class="op" id="5276376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276380">paxHeaders</span><span class="op" id="5276390">[</span><span class="ident" id="5276391">paxKeyword</span><span class="op" id="5276401">]</span>&nbsp;<span class="op" id="5276403">=</span>&nbsp;<span class="ident" id="5276405">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276420">if</span>&nbsp;<span class="builtinfunc" id="5276423">len</span><span class="op" id="5276426">(</span><span class="ident" id="5276427">s</span><span class="op" id="5276428">)</span>&nbsp;<span class="op" id="5276430">&gt;</span>&nbsp;<span class="builtinfunc" id="5276432">len</span><span class="op" id="5276435">(</span><span class="ident" id="5276436">b</span><span class="op" id="5276437">)</span>&nbsp;<span class="op" id="5276439">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276443">if</span>&nbsp;<span class="ident" id="5276446">tw</span><span class="op" id="5276448">.</span><span class="ident" id="5276449">err</span>&nbsp;<span class="op" id="5276453">==</span>&nbsp;<span class="ident" id="5276456">nil</span>&nbsp;<span class="op" id="5276460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276465">tw</span><span class="op" id="5276467">.</span><span class="ident" id="5276468">err</span>&nbsp;<span class="op" id="5276472">=</span>&nbsp;<span class="ident" id="5276474">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276496">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276504">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276507">ascii</span>&nbsp;<span class="op" id="5276513">:=</span>&nbsp;<span class="ident" id="5276516">toASCII</span><span class="op" id="5276523">(</span><span class="ident" id="5276524">s</span><span class="op" id="5276525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5276528">copy</span><span class="op" id="5276532">(</span><span class="ident" id="5276533">b</span><span class="op" id="5276534">,</span>&nbsp;<span class="ident" id="5276536">ascii</span><span class="op" id="5276541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276544">if</span>&nbsp;<span class="builtinfunc" id="5276547">len</span><span class="op" id="5276550">(</span><span class="ident" id="5276551">ascii</span><span class="op" id="5276556">)</span>&nbsp;<span class="op" id="5276558">&lt;</span>&nbsp;<span class="builtinfunc" id="5276560">len</span><span class="op" id="5276563">(</span><span class="ident" id="5276564">b</span><span class="op" id="5276565">)</span>&nbsp;<span class="op" id="5276567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276571">b</span><span class="op" id="5276572">[</span><span class="builtinfunc" id="5276573">len</span><span class="op" id="5276576">(</span><span class="ident" id="5276577">ascii</span><span class="op" id="5276582">)</span><span class="op" id="5276583">]</span>&nbsp;<span class="op" id="5276585">=</span>&nbsp;<span class="num" id="5276587">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276590">}</span><br>
<span class="lineno">90</span><span class="op" id="5276592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5276595">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="5276672">func</span>&nbsp;<span class="op" id="5276677">(</span><span class="ident" id="5276678">tw</span>&nbsp;<span class="op" id="5276681">*</span><span class="ident" id="5276682">Writer</span><span class="op" id="5276688">)</span>&nbsp;<span class="ident" id="5276690">octal</span><span class="op" id="5276695">(</span><span class="ident" id="5276696">b</span>&nbsp;<span class="op" id="5276698">[</span><span class="op" id="5276699">]</span><span class="builtintype" id="5276700">byte</span><span class="op" id="5276704">,</span>&nbsp;<span class="ident" id="5276706">x</span>&nbsp;<span class="ident" id="5276708">int64</span><span class="op" id="5276713">)</span>&nbsp;<span class="op" id="5276715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276718">s</span>&nbsp;<span class="op" id="5276720">:=</span>&nbsp;<span class="ident" id="5276723">strconv</span><span class="op" id="5276730">.</span><span class="ident" id="5276731">FormatInt</span><span class="op" id="5276740">(</span><span class="ident" id="5276741">x</span><span class="op" id="5276742">,</span>&nbsp;<span class="num" id="5276744">8</span><span class="op" id="5276745">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276748">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276793">for</span>&nbsp;<span class="builtinfunc" id="5276797">len</span><span class="op" id="5276800">(</span><span class="ident" id="5276801">s</span><span class="op" id="5276802">)</span><span class="op" id="5276803">+</span><span class="num" id="5276804">1</span>&nbsp;<span class="op" id="5276806">&lt;</span>&nbsp;<span class="builtinfunc" id="5276808">len</span><span class="op" id="5276811">(</span><span class="ident" id="5276812">b</span><span class="op" id="5276813">)</span>&nbsp;<span class="op" id="5276815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276819">s</span>&nbsp;<span class="op" id="5276821">=</span>&nbsp;<span class="string" id="5276823">&#34;0&#34;</span>&nbsp;<span class="op" id="5276827">+</span>&nbsp;<span class="ident" id="5276829">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276835">tw</span><span class="op" id="5276837">.</span><span class="ident" id="5276838">cString</span><span class="op" id="5276845">(</span><span class="ident" id="5276846">b</span><span class="op" id="5276847">,</span>&nbsp;<span class="ident" id="5276849">s</span><span class="op" id="5276850">,</span>&nbsp;<span class="builtintype" id="5276852">false</span><span class="op" id="5276857">,</span>&nbsp;<span class="ident" id="5276859">paxNone</span><span class="op" id="5276866">,</span>&nbsp;<span class="ident" id="5276868">nil</span><span class="op" id="5276871">)</span><br>
<span class="lineno">100</span><span class="op" id="5276873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5276876">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="5276949">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="5277075">func</span>&nbsp;<span class="op" id="5277080">(</span><span class="ident" id="5277081">tw</span>&nbsp;<span class="op" id="5277084">*</span><span class="ident" id="5277085">Writer</span><span class="op" id="5277091">)</span>&nbsp;<span class="ident" id="5277093">numeric</span><span class="op" id="5277100">(</span><span class="ident" id="5277101">b</span>&nbsp;<span class="op" id="5277103">[</span><span class="op" id="5277104">]</span><span class="builtintype" id="5277105">byte</span><span class="op" id="5277109">,</span>&nbsp;<span class="ident" id="5277111">x</span>&nbsp;<span class="ident" id="5277113">int64</span><span class="op" id="5277118">,</span>&nbsp;<span class="ident" id="5277120">allowPax</span>&nbsp;<span class="builtintype" id="5277129">bool</span><span class="op" id="5277133">,</span>&nbsp;<span class="ident" id="5277135">paxKeyword</span>&nbsp;<span class="builtintype" id="5277146">string</span><span class="op" id="5277152">,</span>&nbsp;<span class="ident" id="5277154">paxHeaders</span>&nbsp;<span class="keyword" id="5277165">map</span><span class="op" id="5277168">[</span><span class="builtintype" id="5277169">string</span><span class="op" id="5277175">]</span><span class="builtintype" id="5277176">string</span><span class="op" id="5277182">)</span>&nbsp;<span class="op" id="5277184">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277187">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277208">s</span>&nbsp;<span class="op" id="5277210">:=</span>&nbsp;<span class="ident" id="5277213">strconv</span><span class="op" id="5277220">.</span><span class="ident" id="5277221">FormatInt</span><span class="op" id="5277230">(</span><span class="ident" id="5277231">x</span><span class="op" id="5277232">,</span>&nbsp;<span class="num" id="5277234">8</span><span class="op" id="5277235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277238">if</span>&nbsp;<span class="builtinfunc" id="5277241">len</span><span class="op" id="5277244">(</span><span class="ident" id="5277245">s</span><span class="op" id="5277246">)</span>&nbsp;<span class="op" id="5277248">&lt;</span>&nbsp;<span class="builtinfunc" id="5277250">len</span><span class="op" id="5277253">(</span><span class="ident" id="5277254">b</span><span class="op" id="5277255">)</span>&nbsp;<span class="op" id="5277257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277261">tw</span><span class="op" id="5277263">.</span><span class="ident" id="5277264">octal</span><span class="op" id="5277269">(</span><span class="ident" id="5277270">b</span><span class="op" id="5277271">,</span>&nbsp;<span class="ident" id="5277273">x</span><span class="op" id="5277274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277278">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277290">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277362">if</span>&nbsp;<span class="ident" id="5277365">allowPax</span>&nbsp;<span class="op" id="5277374">&amp;&amp;</span>&nbsp;<span class="ident" id="5277377">tw</span><span class="op" id="5277379">.</span><span class="ident" id="5277380">preferPax</span>&nbsp;<span class="op" id="5277390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277394">tw</span><span class="op" id="5277396">.</span><span class="ident" id="5277397">octal</span><span class="op" id="5277402">(</span><span class="ident" id="5277403">b</span><span class="op" id="5277404">,</span>&nbsp;<span class="num" id="5277406">0</span><span class="op" id="5277407">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277411">s</span>&nbsp;<span class="op" id="5277413">:=</span>&nbsp;<span class="ident" id="5277416">strconv</span><span class="op" id="5277423">.</span><span class="ident" id="5277424">FormatInt</span><span class="op" id="5277433">(</span><span class="ident" id="5277434">x</span><span class="op" id="5277435">,</span>&nbsp;<span class="num" id="5277437">10</span><span class="op" id="5277439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277443">paxHeaders</span><span class="op" id="5277453">[</span><span class="ident" id="5277454">paxKeyword</span><span class="op" id="5277464">]</span>&nbsp;<span class="op" id="5277466">=</span>&nbsp;<span class="ident" id="5277468">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277472">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277484">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277522">tw</span><span class="op" id="5277524">.</span><span class="ident" id="5277525">usedBinary</span>&nbsp;<span class="op" id="5277536">=</span>&nbsp;<span class="builtintype" id="5277538">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277544">for</span>&nbsp;<span class="ident" id="5277548">i</span>&nbsp;<span class="op" id="5277550">:=</span>&nbsp;<span class="builtinfunc" id="5277553">len</span><span class="op" id="5277556">(</span><span class="ident" id="5277557">b</span><span class="op" id="5277558">)</span>&nbsp;<span class="op" id="5277560">-</span>&nbsp;<span class="num" id="5277562">1</span><span class="op" id="5277563">;</span>&nbsp;<span class="ident" id="5277565">x</span>&nbsp;<span class="op" id="5277567">&gt;</span>&nbsp;<span class="num" id="5277569">0</span>&nbsp;<span class="op" id="5277571">&amp;&amp;</span>&nbsp;<span class="ident" id="5277574">i</span>&nbsp;<span class="op" id="5277576">&gt;=</span>&nbsp;<span class="num" id="5277579">0</span><span class="op" id="5277580">;</span>&nbsp;<span class="ident" id="5277582">i</span><span class="op" id="5277583">--</span>&nbsp;<span class="op" id="5277586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277590">b</span><span class="op" id="5277591">[</span><span class="ident" id="5277592">i</span><span class="op" id="5277593">]</span>&nbsp;<span class="op" id="5277595">=</span>&nbsp;<span class="builtintype" id="5277597">byte</span><span class="op" id="5277601">(</span><span class="ident" id="5277602">x</span><span class="op" id="5277603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277607">x</span>&nbsp;<span class="op" id="5277609">&gt;&gt;=</span>&nbsp;<span class="num" id="5277613">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277619">b</span><span class="op" id="5277620">[</span><span class="num" id="5277621">0</span><span class="op" id="5277622">]</span>&nbsp;<span class="op" id="5277624">|=</span>&nbsp;<span class="num" id="5277627">0x80</span>&nbsp;<span class="comment" id="5277632">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="5277671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5277674">var</span>&nbsp;<span class="op" id="5277678">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277681">minTime</span>&nbsp;<span class="op" id="5277689">=</span>&nbsp;<span class="ident" id="5277691">time</span><span class="op" id="5277695">.</span><span class="ident" id="5277696">Unix</span><span class="op" id="5277700">(</span><span class="num" id="5277701">0</span><span class="op" id="5277702">,</span>&nbsp;<span class="num" id="5277704">0</span><span class="op" id="5277705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277708">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277766">maxTime</span>&nbsp;<span class="op" id="5277774">=</span>&nbsp;<span class="ident" id="5277776">minTime</span><span class="op" id="5277783">.</span><span class="ident" id="5277784">Add</span><span class="op" id="5277787">(</span><span class="op" id="5277788">(</span><span class="num" id="5277789">1</span><span class="op" id="5277790">&lt;&lt;</span><span class="num" id="5277792">33</span>&nbsp;<span class="op" id="5277795">-</span>&nbsp;<span class="num" id="5277797">1</span><span class="op" id="5277798">)</span>&nbsp;<span class="op" id="5277800">*</span>&nbsp;<span class="ident" id="5277802">time</span><span class="op" id="5277806">.</span><span class="ident" id="5277807">Second</span><span class="op" id="5277813">)</span><br>
<span class="lineno"></span><span class="op" id="5277815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="5277818">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="5277888">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5277946">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="5278003">func</span>&nbsp;<span class="op" id="5278008">(</span><span class="ident" id="5278009">tw</span>&nbsp;<span class="op" id="5278012">*</span><span class="ident" id="5278013">Writer</span><span class="op" id="5278019">)</span>&nbsp;<span class="ident" id="5278021">WriteHeader</span><span class="op" id="5278032">(</span><span class="ident" id="5278033">hdr</span>&nbsp;<span class="op" id="5278037">*</span><span class="ident" id="5278038">Header</span><span class="op" id="5278044">)</span>&nbsp;<span class="builtintype" id="5278046">error</span>&nbsp;<span class="op" id="5278052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278055">return</span>&nbsp;<span class="ident" id="5278062">tw</span><span class="op" id="5278064">.</span><span class="ident" id="5278065">writeHeader</span><span class="op" id="5278076">(</span><span class="ident" id="5278077">hdr</span><span class="op" id="5278080">,</span>&nbsp;<span class="builtintype" id="5278082">true</span><span class="op" id="5278086">)</span><br>
<span class="lineno">140</span><span class="op" id="5278088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5278091">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="5278161">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5278219">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="5278276">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5278349">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5278385">func</span>&nbsp;<span class="op" id="5278390">(</span><span class="ident" id="5278391">tw</span>&nbsp;<span class="op" id="5278394">*</span><span class="ident" id="5278395">Writer</span><span class="op" id="5278401">)</span>&nbsp;<span class="ident" id="5278403">writeHeader</span><span class="op" id="5278414">(</span><span class="ident" id="5278415">hdr</span>&nbsp;<span class="op" id="5278419">*</span><span class="ident" id="5278420">Header</span><span class="op" id="5278426">,</span>&nbsp;<span class="ident" id="5278428">allowPax</span>&nbsp;<span class="builtintype" id="5278437">bool</span><span class="op" id="5278441">)</span>&nbsp;<span class="builtintype" id="5278443">error</span>&nbsp;<span class="op" id="5278449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278452">if</span>&nbsp;<span class="ident" id="5278455">tw</span><span class="op" id="5278457">.</span><span class="ident" id="5278458">closed</span>&nbsp;<span class="op" id="5278465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278469">return</span>&nbsp;<span class="ident" id="5278476">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278499">if</span>&nbsp;<span class="ident" id="5278502">tw</span><span class="op" id="5278504">.</span><span class="ident" id="5278505">err</span>&nbsp;<span class="op" id="5278509">==</span>&nbsp;<span class="ident" id="5278512">nil</span>&nbsp;<span class="op" id="5278516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278520">tw</span><span class="op" id="5278522">.</span><span class="ident" id="5278523">Flush</span><span class="op" id="5278528">(</span><span class="op" id="5278529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278535">if</span>&nbsp;<span class="ident" id="5278538">tw</span><span class="op" id="5278540">.</span><span class="ident" id="5278541">err</span>&nbsp;<span class="op" id="5278545">!=</span>&nbsp;<span class="ident" id="5278548">nil</span>&nbsp;<span class="op" id="5278552">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278556">return</span>&nbsp;<span class="ident" id="5278563">tw</span><span class="op" id="5278565">.</span><span class="ident" id="5278566">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278575">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278631">paxHeaders</span>&nbsp;<span class="op" id="5278642">:=</span>&nbsp;<span class="builtinfunc" id="5278645">make</span><span class="op" id="5278649">(</span><span class="keyword" id="5278650">map</span><span class="op" id="5278653">[</span><span class="builtintype" id="5278654">string</span><span class="op" id="5278660">]</span><span class="builtintype" id="5278661">string</span><span class="op" id="5278667">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278671">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278732">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278794">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278839">var</span>&nbsp;<span class="ident" id="5278843">header</span>&nbsp;<span class="op" id="5278850">[</span><span class="op" id="5278851">]</span><span class="builtintype" id="5278852">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278859">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278920">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278986">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279068">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279148">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279225">header</span>&nbsp;<span class="op" id="5279232">=</span>&nbsp;<span class="ident" id="5279234">tw</span><span class="op" id="5279236">.</span><span class="ident" id="5279237">hdrBuff</span><span class="op" id="5279244">[</span><span class="op" id="5279245">:</span><span class="op" id="5279246">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279249">if</span>&nbsp;<span class="op" id="5279252">!</span><span class="ident" id="5279253">allowPax</span>&nbsp;<span class="op" id="5279262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279266">header</span>&nbsp;<span class="op" id="5279273">=</span>&nbsp;<span class="ident" id="5279275">tw</span><span class="op" id="5279277">.</span><span class="ident" id="5279278">paxHdrBuff</span><span class="op" id="5279288">[</span><span class="op" id="5279289">:</span><span class="op" id="5279290">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5279296">copy</span><span class="op" id="5279300">(</span><span class="ident" id="5279301">header</span><span class="op" id="5279307">,</span>&nbsp;<span class="ident" id="5279309">zeroBlock</span><span class="op" id="5279318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279321">s</span>&nbsp;<span class="op" id="5279323">:=</span>&nbsp;<span class="ident" id="5279326">slicer</span><span class="op" id="5279332">(</span><span class="ident" id="5279333">header</span><span class="op" id="5279339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279343">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279471">pathHeaderBytes</span>&nbsp;<span class="op" id="5279487">:=</span>&nbsp;<span class="ident" id="5279490">s</span><span class="op" id="5279491">.</span><span class="ident" id="5279492">next</span><span class="op" id="5279496">(</span><span class="ident" id="5279497">fileNameSize</span><span class="op" id="5279509">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279513">tw</span><span class="op" id="5279515">.</span><span class="ident" id="5279516">cString</span><span class="op" id="5279523">(</span><span class="ident" id="5279524">pathHeaderBytes</span><span class="op" id="5279539">,</span>&nbsp;<span class="ident" id="5279541">hdr</span><span class="op" id="5279544">.</span><span class="ident" id="5279545">Name</span><span class="op" id="5279549">,</span>&nbsp;<span class="builtintype" id="5279551">true</span><span class="op" id="5279555">,</span>&nbsp;<span class="ident" id="5279557">paxPath</span><span class="op" id="5279564">,</span>&nbsp;<span class="ident" id="5279566">paxHeaders</span><span class="op" id="5279576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279580">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279623">var</span>&nbsp;<span class="ident" id="5279627">modTime</span>&nbsp;<span class="ident" id="5279635">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279642">if</span>&nbsp;<span class="op" id="5279645">!</span><span class="ident" id="5279646">hdr</span><span class="op" id="5279649">.</span><span class="ident" id="5279650">ModTime</span><span class="op" id="5279657">.</span><span class="ident" id="5279658">Before</span><span class="op" id="5279664">(</span><span class="ident" id="5279665">minTime</span><span class="op" id="5279672">)</span>&nbsp;<span class="op" id="5279674">&amp;&amp;</span>&nbsp;<span class="op" id="5279677">!</span><span class="ident" id="5279678">hdr</span><span class="op" id="5279681">.</span><span class="ident" id="5279682">ModTime</span><span class="op" id="5279689">.</span><span class="ident" id="5279690">After</span><span class="op" id="5279695">(</span><span class="ident" id="5279696">maxTime</span><span class="op" id="5279703">)</span>&nbsp;<span class="op" id="5279705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279709">modTime</span>&nbsp;<span class="op" id="5279717">=</span>&nbsp;<span class="ident" id="5279719">hdr</span><span class="op" id="5279722">.</span><span class="ident" id="5279723">ModTime</span><span class="op" id="5279730">.</span><span class="ident" id="5279731">Unix</span><span class="op" id="5279735">(</span><span class="op" id="5279736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279743">tw</span><span class="op" id="5279745">.</span><span class="ident" id="5279746">octal</span><span class="op" id="5279751">(</span><span class="ident" id="5279752">s</span><span class="op" id="5279753">.</span><span class="ident" id="5279754">next</span><span class="op" id="5279758">(</span><span class="num" id="5279759">8</span><span class="op" id="5279760">)</span><span class="op" id="5279761">,</span>&nbsp;<span class="ident" id="5279763">hdr</span><span class="op" id="5279766">.</span><span class="ident" id="5279767">Mode</span><span class="op" id="5279771">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5279807">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279819">tw</span><span class="op" id="5279821">.</span><span class="ident" id="5279822">numeric</span><span class="op" id="5279829">(</span><span class="ident" id="5279830">s</span><span class="op" id="5279831">.</span><span class="ident" id="5279832">next</span><span class="op" id="5279836">(</span><span class="num" id="5279837">8</span><span class="op" id="5279838">)</span><span class="op" id="5279839">,</span>&nbsp;<span class="ident" id="5279841">int64</span><span class="op" id="5279846">(</span><span class="ident" id="5279847">hdr</span><span class="op" id="5279850">.</span><span class="ident" id="5279851">Uid</span><span class="op" id="5279854">)</span><span class="op" id="5279855">,</span>&nbsp;<span class="builtintype" id="5279857">true</span><span class="op" id="5279861">,</span>&nbsp;<span class="ident" id="5279863">paxUid</span><span class="op" id="5279869">,</span>&nbsp;<span class="ident" id="5279871">paxHeaders</span><span class="op" id="5279881">)</span>&nbsp;<span class="comment" id="5279883">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279895">tw</span><span class="op" id="5279897">.</span><span class="ident" id="5279898">numeric</span><span class="op" id="5279905">(</span><span class="ident" id="5279906">s</span><span class="op" id="5279907">.</span><span class="ident" id="5279908">next</span><span class="op" id="5279912">(</span><span class="num" id="5279913">8</span><span class="op" id="5279914">)</span><span class="op" id="5279915">,</span>&nbsp;<span class="ident" id="5279917">int64</span><span class="op" id="5279922">(</span><span class="ident" id="5279923">hdr</span><span class="op" id="5279926">.</span><span class="ident" id="5279927">Gid</span><span class="op" id="5279930">)</span><span class="op" id="5279931">,</span>&nbsp;<span class="builtintype" id="5279933">true</span><span class="op" id="5279937">,</span>&nbsp;<span class="ident" id="5279939">paxGid</span><span class="op" id="5279945">,</span>&nbsp;<span class="ident" id="5279947">paxHeaders</span><span class="op" id="5279957">)</span>&nbsp;<span class="comment" id="5279959">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279971">tw</span><span class="op" id="5279973">.</span><span class="ident" id="5279974">numeric</span><span class="op" id="5279981">(</span><span class="ident" id="5279982">s</span><span class="op" id="5279983">.</span><span class="ident" id="5279984">next</span><span class="op" id="5279988">(</span><span class="num" id="5279989">12</span><span class="op" id="5279991">)</span><span class="op" id="5279992">,</span>&nbsp;<span class="ident" id="5279994">hdr</span><span class="op" id="5279997">.</span><span class="ident" id="5279998">Size</span><span class="op" id="5280002">,</span>&nbsp;<span class="builtintype" id="5280004">true</span><span class="op" id="5280008">,</span>&nbsp;<span class="ident" id="5280010">paxSize</span><span class="op" id="5280017">,</span>&nbsp;<span class="ident" id="5280019">paxHeaders</span><span class="op" id="5280029">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280035">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280047">tw</span><span class="op" id="5280049">.</span><span class="ident" id="5280050">numeric</span><span class="op" id="5280057">(</span><span class="ident" id="5280058">s</span><span class="op" id="5280059">.</span><span class="ident" id="5280060">next</span><span class="op" id="5280064">(</span><span class="num" id="5280065">12</span><span class="op" id="5280067">)</span><span class="op" id="5280068">,</span>&nbsp;<span class="ident" id="5280070">modTime</span><span class="op" id="5280077">,</span>&nbsp;<span class="builtintype" id="5280079">false</span><span class="op" id="5280084">,</span>&nbsp;<span class="ident" id="5280086">paxNone</span><span class="op" id="5280093">,</span>&nbsp;<span class="ident" id="5280095">nil</span><span class="op" id="5280098">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280111">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280168">s</span><span class="op" id="5280169">.</span><span class="ident" id="5280170">next</span><span class="op" id="5280174">(</span><span class="num" id="5280175">8</span><span class="op" id="5280176">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280232">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280253">s</span><span class="op" id="5280254">.</span><span class="ident" id="5280255">next</span><span class="op" id="5280259">(</span><span class="num" id="5280260">1</span><span class="op" id="5280261">)</span><span class="op" id="5280262">[</span><span class="num" id="5280263">0</span><span class="op" id="5280264">]</span>&nbsp;<span class="op" id="5280266">=</span>&nbsp;<span class="ident" id="5280268">hdr</span><span class="op" id="5280271">.</span><span class="ident" id="5280272">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280317">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280330">tw</span><span class="op" id="5280332">.</span><span class="ident" id="5280333">cString</span><span class="op" id="5280340">(</span><span class="ident" id="5280341">s</span><span class="op" id="5280342">.</span><span class="ident" id="5280343">next</span><span class="op" id="5280347">(</span><span class="num" id="5280348">100</span><span class="op" id="5280351">)</span><span class="op" id="5280352">,</span>&nbsp;<span class="ident" id="5280354">hdr</span><span class="op" id="5280357">.</span><span class="ident" id="5280358">Linkname</span><span class="op" id="5280366">,</span>&nbsp;<span class="builtintype" id="5280368">true</span><span class="op" id="5280372">,</span>&nbsp;<span class="ident" id="5280374">paxLinkpath</span><span class="op" id="5280385">,</span>&nbsp;<span class="ident" id="5280387">paxHeaders</span><span class="op" id="5280397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5280401">copy</span><span class="op" id="5280405">(</span><span class="ident" id="5280406">s</span><span class="op" id="5280407">.</span><span class="ident" id="5280408">next</span><span class="op" id="5280412">(</span><span class="num" id="5280413">8</span><span class="op" id="5280414">)</span><span class="op" id="5280415">,</span>&nbsp;<span class="op" id="5280417">[</span><span class="op" id="5280418">]</span><span class="builtintype" id="5280419">byte</span><span class="op" id="5280423">(</span><span class="string" id="5280424">&#34;ustar\x0000&#34;</span><span class="op" id="5280437">)</span><span class="op" id="5280438">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280463">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280475">tw</span><span class="op" id="5280477">.</span><span class="ident" id="5280478">cString</span><span class="op" id="5280485">(</span><span class="ident" id="5280486">s</span><span class="op" id="5280487">.</span><span class="ident" id="5280488">next</span><span class="op" id="5280492">(</span><span class="num" id="5280493">32</span><span class="op" id="5280495">)</span><span class="op" id="5280496">,</span>&nbsp;<span class="ident" id="5280498">hdr</span><span class="op" id="5280501">.</span><span class="ident" id="5280502">Uname</span><span class="op" id="5280507">,</span>&nbsp;<span class="builtintype" id="5280509">true</span><span class="op" id="5280513">,</span>&nbsp;<span class="ident" id="5280515">paxUname</span><span class="op" id="5280523">,</span>&nbsp;<span class="ident" id="5280525">paxHeaders</span><span class="op" id="5280535">)</span>&nbsp;<span class="comment" id="5280537">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280549">tw</span><span class="op" id="5280551">.</span><span class="ident" id="5280552">cString</span><span class="op" id="5280559">(</span><span class="ident" id="5280560">s</span><span class="op" id="5280561">.</span><span class="ident" id="5280562">next</span><span class="op" id="5280566">(</span><span class="num" id="5280567">32</span><span class="op" id="5280569">)</span><span class="op" id="5280570">,</span>&nbsp;<span class="ident" id="5280572">hdr</span><span class="op" id="5280575">.</span><span class="ident" id="5280576">Gname</span><span class="op" id="5280581">,</span>&nbsp;<span class="builtintype" id="5280583">true</span><span class="op" id="5280587">,</span>&nbsp;<span class="ident" id="5280589">paxGname</span><span class="op" id="5280597">,</span>&nbsp;<span class="ident" id="5280599">paxHeaders</span><span class="op" id="5280609">)</span>&nbsp;<span class="comment" id="5280611">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280623">tw</span><span class="op" id="5280625">.</span><span class="ident" id="5280626">numeric</span><span class="op" id="5280633">(</span><span class="ident" id="5280634">s</span><span class="op" id="5280635">.</span><span class="ident" id="5280636">next</span><span class="op" id="5280640">(</span><span class="num" id="5280641">8</span><span class="op" id="5280642">)</span><span class="op" id="5280643">,</span>&nbsp;<span class="ident" id="5280645">hdr</span><span class="op" id="5280648">.</span><span class="ident" id="5280649">Devmajor</span><span class="op" id="5280657">,</span>&nbsp;<span class="builtintype" id="5280659">false</span><span class="op" id="5280664">,</span>&nbsp;<span class="ident" id="5280666">paxNone</span><span class="op" id="5280673">,</span>&nbsp;<span class="ident" id="5280675">nil</span><span class="op" id="5280678">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280685">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280697">tw</span><span class="op" id="5280699">.</span><span class="ident" id="5280700">numeric</span><span class="op" id="5280707">(</span><span class="ident" id="5280708">s</span><span class="op" id="5280709">.</span><span class="ident" id="5280710">next</span><span class="op" id="5280714">(</span><span class="num" id="5280715">8</span><span class="op" id="5280716">)</span><span class="op" id="5280717">,</span>&nbsp;<span class="ident" id="5280719">hdr</span><span class="op" id="5280722">.</span><span class="ident" id="5280723">Devminor</span><span class="op" id="5280731">,</span>&nbsp;<span class="builtintype" id="5280733">false</span><span class="op" id="5280738">,</span>&nbsp;<span class="ident" id="5280740">paxNone</span><span class="op" id="5280747">,</span>&nbsp;<span class="ident" id="5280749">nil</span><span class="op" id="5280752">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5280759">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5280772">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280898">prefixHeaderBytes</span>&nbsp;<span class="op" id="5280916">:=</span>&nbsp;<span class="ident" id="5280919">s</span><span class="op" id="5280920">.</span><span class="ident" id="5280921">next</span><span class="op" id="5280925">(</span><span class="num" id="5280926">155</span><span class="op" id="5280929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280932">tw</span><span class="op" id="5280934">.</span><span class="ident" id="5280935">cString</span><span class="op" id="5280942">(</span><span class="ident" id="5280943">prefixHeaderBytes</span><span class="op" id="5280960">,</span>&nbsp;<span class="string" id="5280962">&#34;&#34;</span><span class="op" id="5280964">,</span>&nbsp;<span class="builtintype" id="5280966">false</span><span class="op" id="5280971">,</span>&nbsp;<span class="ident" id="5280973">paxNone</span><span class="op" id="5280980">,</span>&nbsp;<span class="ident" id="5280982">nil</span><span class="op" id="5280985">)</span>&nbsp;<span class="comment" id="5280987">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281008">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281084">if</span>&nbsp;<span class="ident" id="5281087">tw</span><span class="op" id="5281089">.</span><span class="ident" id="5281090">usedBinary</span>&nbsp;<span class="op" id="5281101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5281105">copy</span><span class="op" id="5281109">(</span><span class="ident" id="5281110">header</span><span class="op" id="5281116">[</span><span class="num" id="5281117">257</span><span class="op" id="5281120">:</span><span class="num" id="5281121">265</span><span class="op" id="5281124">]</span><span class="op" id="5281125">,</span>&nbsp;<span class="op" id="5281127">[</span><span class="op" id="5281128">]</span><span class="builtintype" id="5281129">byte</span><span class="op" id="5281133">(</span><span class="string" id="5281134">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="5281147">)</span><span class="op" id="5281148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281155">_</span><span class="op" id="5281156">,</span>&nbsp;<span class="ident" id="5281158">paxPathUsed</span>&nbsp;<span class="op" id="5281170">:=</span>&nbsp;<span class="ident" id="5281173">paxHeaders</span><span class="op" id="5281183">[</span><span class="ident" id="5281184">paxPath</span><span class="op" id="5281191">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281194">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281255">if</span>&nbsp;<span class="op" id="5281258">!</span><span class="ident" id="5281259">tw</span><span class="op" id="5281261">.</span><span class="ident" id="5281262">preferPax</span>&nbsp;<span class="op" id="5281272">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5281275">len</span><span class="op" id="5281278">(</span><span class="ident" id="5281279">paxHeaders</span><span class="op" id="5281289">)</span>&nbsp;<span class="op" id="5281291">==</span>&nbsp;<span class="num" id="5281294">1</span>&nbsp;<span class="op" id="5281296">&amp;&amp;</span>&nbsp;<span class="ident" id="5281299">paxPathUsed</span>&nbsp;<span class="op" id="5281311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281315">suffix</span>&nbsp;<span class="op" id="5281322">:=</span>&nbsp;<span class="ident" id="5281325">hdr</span><span class="op" id="5281328">.</span><span class="ident" id="5281329">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281336">prefix</span>&nbsp;<span class="op" id="5281343">:=</span>&nbsp;<span class="string" id="5281346">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281351">if</span>&nbsp;<span class="builtinfunc" id="5281354">len</span><span class="op" id="5281357">(</span><span class="ident" id="5281358">hdr</span><span class="op" id="5281361">.</span><span class="ident" id="5281362">Name</span><span class="op" id="5281366">)</span>&nbsp;<span class="op" id="5281368">&gt;</span>&nbsp;<span class="ident" id="5281370">fileNameSize</span>&nbsp;<span class="op" id="5281383">&amp;&amp;</span>&nbsp;<span class="ident" id="5281386">isASCII</span><span class="op" id="5281393">(</span><span class="ident" id="5281394">hdr</span><span class="op" id="5281397">.</span><span class="ident" id="5281398">Name</span><span class="op" id="5281402">)</span>&nbsp;<span class="op" id="5281404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281409">var</span>&nbsp;<span class="ident" id="5281413">err</span>&nbsp;<span class="builtintype" id="5281417">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281426">prefix</span><span class="op" id="5281432">,</span>&nbsp;<span class="ident" id="5281434">suffix</span><span class="op" id="5281440">,</span>&nbsp;<span class="ident" id="5281442">err</span>&nbsp;<span class="op" id="5281446">=</span>&nbsp;<span class="ident" id="5281448">tw</span><span class="op" id="5281450">.</span><span class="ident" id="5281451">splitUSTARLongName</span><span class="op" id="5281469">(</span><span class="ident" id="5281470">hdr</span><span class="op" id="5281473">.</span><span class="ident" id="5281474">Name</span><span class="op" id="5281478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281483">if</span>&nbsp;<span class="ident" id="5281486">err</span>&nbsp;<span class="op" id="5281490">==</span>&nbsp;<span class="ident" id="5281493">nil</span>&nbsp;<span class="op" id="5281497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281503">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281582">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5281666">delete</span><span class="op" id="5281672">(</span><span class="ident" id="5281673">paxHeaders</span><span class="op" id="5281683">,</span>&nbsp;<span class="ident" id="5281685">paxPath</span><span class="op" id="5281692">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281699">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281729">tw</span><span class="op" id="5281731">.</span><span class="ident" id="5281732">cString</span><span class="op" id="5281739">(</span><span class="ident" id="5281740">pathHeaderBytes</span><span class="op" id="5281755">,</span>&nbsp;<span class="ident" id="5281757">suffix</span><span class="op" id="5281763">,</span>&nbsp;<span class="builtintype" id="5281765">false</span><span class="op" id="5281770">,</span>&nbsp;<span class="ident" id="5281772">paxNone</span><span class="op" id="5281779">,</span>&nbsp;<span class="ident" id="5281781">nil</span><span class="op" id="5281784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281790">tw</span><span class="op" id="5281792">.</span><span class="ident" id="5281793">cString</span><span class="op" id="5281800">(</span><span class="ident" id="5281801">prefixHeaderBytes</span><span class="op" id="5281818">,</span>&nbsp;<span class="ident" id="5281820">prefix</span><span class="op" id="5281826">,</span>&nbsp;<span class="builtintype" id="5281828">false</span><span class="op" id="5281833">,</span>&nbsp;<span class="ident" id="5281835">paxNone</span><span class="op" id="5281842">,</span>&nbsp;<span class="ident" id="5281844">nil</span><span class="op" id="5281847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281854">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281910">if</span>&nbsp;<span class="builtinfunc" id="5281913">len</span><span class="op" id="5281916">(</span><span class="ident" id="5281917">prefix</span><span class="op" id="5281923">)</span>&nbsp;<span class="op" id="5281925">&gt;</span>&nbsp;<span class="num" id="5281927">0</span>&nbsp;<span class="op" id="5281929">&amp;&amp;</span>&nbsp;<span class="op" id="5281932">!</span><span class="ident" id="5281933">tw</span><span class="op" id="5281935">.</span><span class="ident" id="5281936">usedBinary</span>&nbsp;<span class="op" id="5281947">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5281954">copy</span><span class="op" id="5281958">(</span><span class="ident" id="5281959">header</span><span class="op" id="5281965">[</span><span class="num" id="5281966">257</span><span class="op" id="5281969">:</span><span class="num" id="5281970">265</span><span class="op" id="5281973">]</span><span class="op" id="5281974">,</span>&nbsp;<span class="op" id="5281976">[</span><span class="op" id="5281977">]</span><span class="builtintype" id="5281978">byte</span><span class="op" id="5281982">(</span><span class="string" id="5281983">&#34;ustar\x00&#34;</span><span class="op" id="5281994">)</span><span class="op" id="5281995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282013">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282017">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282074">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282125">chksum</span><span class="op" id="5282131">,</span>&nbsp;<span class="ident" id="5282133">_</span>&nbsp;<span class="op" id="5282135">:=</span>&nbsp;<span class="ident" id="5282138">checksum</span><span class="op" id="5282146">(</span><span class="ident" id="5282147">header</span><span class="op" id="5282153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282156">tw</span><span class="op" id="5282158">.</span><span class="ident" id="5282159">octal</span><span class="op" id="5282164">(</span><span class="ident" id="5282165">header</span><span class="op" id="5282171">[</span><span class="num" id="5282172">148</span><span class="op" id="5282175">:</span><span class="num" id="5282176">155</span><span class="op" id="5282179">]</span><span class="op" id="5282180">,</span>&nbsp;<span class="ident" id="5282182">chksum</span><span class="op" id="5282188">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282191">header</span><span class="op" id="5282197">[</span><span class="num" id="5282198">155</span><span class="op" id="5282201">]</span>&nbsp;<span class="op" id="5282203">=</span>&nbsp;<span class="string" id="5282205">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282211">if</span>&nbsp;<span class="ident" id="5282214">tw</span><span class="op" id="5282216">.</span><span class="ident" id="5282217">err</span>&nbsp;<span class="op" id="5282221">!=</span>&nbsp;<span class="ident" id="5282224">nil</span>&nbsp;<span class="op" id="5282228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282232">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282296">return</span>&nbsp;<span class="ident" id="5282303">tw</span><span class="op" id="5282305">.</span><span class="ident" id="5282306">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282315">if</span>&nbsp;<span class="ident" id="5282318">allowPax</span>&nbsp;<span class="op" id="5282327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282331">for</span>&nbsp;<span class="ident" id="5282335">k</span><span class="op" id="5282336">,</span>&nbsp;<span class="ident" id="5282338">v</span>&nbsp;<span class="op" id="5282340">:=</span>&nbsp;<span class="keyword" id="5282343">range</span>&nbsp;<span class="ident" id="5282349">hdr</span><span class="op" id="5282352">.</span><span class="ident" id="5282353">Xattrs</span>&nbsp;<span class="op" id="5282360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282365">paxHeaders</span><span class="op" id="5282375">[</span><span class="ident" id="5282376">paxXattr</span><span class="op" id="5282384">+</span><span class="ident" id="5282385">k</span><span class="op" id="5282386">]</span>&nbsp;<span class="op" id="5282388">=</span>&nbsp;<span class="ident" id="5282390">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282401">if</span>&nbsp;<span class="builtinfunc" id="5282404">len</span><span class="op" id="5282407">(</span><span class="ident" id="5282408">paxHeaders</span><span class="op" id="5282418">)</span>&nbsp;<span class="op" id="5282420">&gt;</span>&nbsp;<span class="num" id="5282422">0</span>&nbsp;<span class="op" id="5282424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282428">if</span>&nbsp;<span class="op" id="5282431">!</span><span class="ident" id="5282432">allowPax</span>&nbsp;<span class="op" id="5282441">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282446">return</span>&nbsp;<span class="ident" id="5282453">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282476">if</span>&nbsp;<span class="ident" id="5282479">err</span>&nbsp;<span class="op" id="5282483">:=</span>&nbsp;<span class="ident" id="5282486">tw</span><span class="op" id="5282488">.</span><span class="ident" id="5282489">writePAXHeader</span><span class="op" id="5282503">(</span><span class="ident" id="5282504">hdr</span><span class="op" id="5282507">,</span>&nbsp;<span class="ident" id="5282509">paxHeaders</span><span class="op" id="5282519">)</span><span class="op" id="5282520">;</span>&nbsp;<span class="ident" id="5282522">err</span>&nbsp;<span class="op" id="5282526">!=</span>&nbsp;<span class="ident" id="5282529">nil</span>&nbsp;<span class="op" id="5282533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282538">return</span>&nbsp;<span class="ident" id="5282545">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282551">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282557">tw</span><span class="op" id="5282559">.</span><span class="ident" id="5282560">nb</span>&nbsp;<span class="op" id="5282563">=</span>&nbsp;<span class="ident" id="5282565">int64</span><span class="op" id="5282570">(</span><span class="ident" id="5282571">hdr</span><span class="op" id="5282574">.</span><span class="ident" id="5282575">Size</span><span class="op" id="5282579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282582">tw</span><span class="op" id="5282584">.</span><span class="ident" id="5282585">pad</span>&nbsp;<span class="op" id="5282589">=</span>&nbsp;<span class="op" id="5282591">(</span><span class="ident" id="5282592">blockSize</span>&nbsp;<span class="op" id="5282602">-</span>&nbsp;<span class="op" id="5282604">(</span><span class="ident" id="5282605">tw</span><span class="op" id="5282607">.</span><span class="ident" id="5282608">nb</span>&nbsp;<span class="op" id="5282611">%</span>&nbsp;<span class="ident" id="5282613">blockSize</span><span class="op" id="5282622">)</span><span class="op" id="5282623">)</span>&nbsp;<span class="op" id="5282625">%</span>&nbsp;<span class="ident" id="5282627">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282639">_</span><span class="op" id="5282640">,</span>&nbsp;<span class="ident" id="5282642">tw</span><span class="op" id="5282644">.</span><span class="ident" id="5282645">err</span>&nbsp;<span class="op" id="5282649">=</span>&nbsp;<span class="ident" id="5282651">tw</span><span class="op" id="5282653">.</span><span class="ident" id="5282654">w</span><span class="op" id="5282655">.</span><span class="ident" id="5282656">Write</span><span class="op" id="5282661">(</span><span class="ident" id="5282662">header</span><span class="op" id="5282668">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282671">return</span>&nbsp;<span class="ident" id="5282678">tw</span><span class="op" id="5282680">.</span><span class="ident" id="5282681">err</span><br>
<span class="lineno"></span><span class="op" id="5282685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5282688">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="5282745">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="5282806">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="5282861">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="5282892">func</span>&nbsp;<span class="op" id="5282897">(</span><span class="ident" id="5282898">tw</span>&nbsp;<span class="op" id="5282901">*</span><span class="ident" id="5282902">Writer</span><span class="op" id="5282908">)</span>&nbsp;<span class="ident" id="5282910">splitUSTARLongName</span><span class="op" id="5282928">(</span><span class="ident" id="5282929">name</span>&nbsp;<span class="builtintype" id="5282934">string</span><span class="op" id="5282940">)</span>&nbsp;<span class="op" id="5282942">(</span><span class="ident" id="5282943">prefix</span><span class="op" id="5282949">,</span>&nbsp;<span class="ident" id="5282951">suffix</span>&nbsp;<span class="builtintype" id="5282958">string</span><span class="op" id="5282964">,</span>&nbsp;<span class="ident" id="5282966">err</span>&nbsp;<span class="builtintype" id="5282970">error</span><span class="op" id="5282975">)</span>&nbsp;<span class="op" id="5282977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282980">length</span>&nbsp;<span class="op" id="5282987">:=</span>&nbsp;<span class="builtinfunc" id="5282990">len</span><span class="op" id="5282993">(</span><span class="ident" id="5282994">name</span><span class="op" id="5282998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283001">if</span>&nbsp;<span class="ident" id="5283004">length</span>&nbsp;<span class="op" id="5283011">&gt;</span>&nbsp;<span class="ident" id="5283013">fileNamePrefixSize</span><span class="op" id="5283031">+</span><span class="num" id="5283032">1</span>&nbsp;<span class="op" id="5283034">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283038">length</span>&nbsp;<span class="op" id="5283045">=</span>&nbsp;<span class="ident" id="5283047">fileNamePrefixSize</span>&nbsp;<span class="op" id="5283066">+</span>&nbsp;<span class="num" id="5283068">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283071">}</span>&nbsp;<span class="keyword" id="5283073">else</span>&nbsp;<span class="keyword" id="5283078">if</span>&nbsp;<span class="ident" id="5283081">name</span><span class="op" id="5283085">[</span><span class="ident" id="5283086">length</span><span class="op" id="5283092">-</span><span class="num" id="5283093">1</span><span class="op" id="5283094">]</span>&nbsp;<span class="op" id="5283096">==</span>&nbsp;<span class="string" id="5283099">&#39;/&#39;</span>&nbsp;<span class="op" id="5283103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283107">length</span><span class="op" id="5283113">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283120">i</span>&nbsp;<span class="op" id="5283122">:=</span>&nbsp;<span class="ident" id="5283125">strings</span><span class="op" id="5283132">.</span><span class="ident" id="5283133">LastIndex</span><span class="op" id="5283142">(</span><span class="ident" id="5283143">name</span><span class="op" id="5283147">[</span><span class="op" id="5283148">:</span><span class="ident" id="5283149">length</span><span class="op" id="5283155">]</span><span class="op" id="5283156">,</span>&nbsp;<span class="string" id="5283158">&#34;/&#34;</span><span class="op" id="5283161">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283164">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283222">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283282">nlen</span>&nbsp;<span class="op" id="5283287">:=</span>&nbsp;<span class="builtinfunc" id="5283290">len</span><span class="op" id="5283293">(</span><span class="ident" id="5283294">name</span><span class="op" id="5283298">)</span>&nbsp;<span class="op" id="5283300">-</span>&nbsp;<span class="ident" id="5283302">i</span>&nbsp;<span class="op" id="5283304">-</span>&nbsp;<span class="num" id="5283306">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283309">plen</span>&nbsp;<span class="op" id="5283314">:=</span>&nbsp;<span class="ident" id="5283317">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283320">if</span>&nbsp;<span class="ident" id="5283323">i</span>&nbsp;<span class="op" id="5283325">&lt;=</span>&nbsp;<span class="num" id="5283328">0</span>&nbsp;<span class="op" id="5283330">||</span>&nbsp;<span class="ident" id="5283333">nlen</span>&nbsp;<span class="op" id="5283338">&gt;</span>&nbsp;<span class="ident" id="5283340">fileNameSize</span>&nbsp;<span class="op" id="5283353">||</span>&nbsp;<span class="ident" id="5283356">nlen</span>&nbsp;<span class="op" id="5283361">==</span>&nbsp;<span class="num" id="5283364">0</span>&nbsp;<span class="op" id="5283366">||</span>&nbsp;<span class="ident" id="5283369">plen</span>&nbsp;<span class="op" id="5283374">&gt;</span>&nbsp;<span class="ident" id="5283376">fileNamePrefixSize</span>&nbsp;<span class="op" id="5283395">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283399">err</span>&nbsp;<span class="op" id="5283403">=</span>&nbsp;<span class="ident" id="5283405">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283422">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283433">prefix</span><span class="op" id="5283439">,</span>&nbsp;<span class="ident" id="5283441">suffix</span>&nbsp;<span class="op" id="5283448">=</span>&nbsp;<span class="ident" id="5283450">name</span><span class="op" id="5283454">[</span><span class="op" id="5283455">:</span><span class="ident" id="5283456">i</span><span class="op" id="5283457">]</span><span class="op" id="5283458">,</span>&nbsp;<span class="ident" id="5283460">name</span><span class="op" id="5283464">[</span><span class="ident" id="5283465">i</span><span class="op" id="5283466">+</span><span class="num" id="5283467">1</span><span class="op" id="5283468">:</span><span class="op" id="5283469">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283472">return</span><br>
<span class="lineno">295</span><span class="op" id="5283479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5283482">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5283537">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="5283549">func</span>&nbsp;<span class="op" id="5283554">(</span><span class="ident" id="5283555">tw</span>&nbsp;<span class="op" id="5283558">*</span><span class="ident" id="5283559">Writer</span><span class="op" id="5283565">)</span>&nbsp;<span class="ident" id="5283567">writePAXHeader</span><span class="op" id="5283581">(</span><span class="ident" id="5283582">hdr</span>&nbsp;<span class="op" id="5283586">*</span><span class="ident" id="5283587">Header</span><span class="op" id="5283593">,</span>&nbsp;<span class="ident" id="5283595">paxHeaders</span>&nbsp;<span class="keyword" id="5283606">map</span><span class="op" id="5283609">[</span><span class="builtintype" id="5283610">string</span><span class="op" id="5283616">]</span><span class="builtintype" id="5283617">string</span><span class="op" id="5283623">)</span>&nbsp;<span class="builtintype" id="5283625">error</span>&nbsp;<span class="op" id="5283631">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283634">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283662">ext</span>&nbsp;<span class="op" id="5283666">:=</span>&nbsp;<span class="builtinfunc" id="5283669">new</span><span class="op" id="5283672">(</span><span class="ident" id="5283673">Header</span><span class="op" id="5283679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283682">ext</span><span class="op" id="5283685">.</span><span class="ident" id="5283686">Typeflag</span>&nbsp;<span class="op" id="5283695">=</span>&nbsp;<span class="ident" id="5283697">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283710">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283764">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283804">ext</span><span class="op" id="5283807">.</span><span class="ident" id="5283808">ModTime</span>&nbsp;<span class="op" id="5283816">=</span>&nbsp;<span class="ident" id="5283818">hdr</span><span class="op" id="5283821">.</span><span class="ident" id="5283822">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283831">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283884">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283910">pid</span>&nbsp;<span class="op" id="5283914">:=</span>&nbsp;<span class="ident" id="5283917">os</span><span class="op" id="5283919">.</span><span class="ident" id="5283920">Getpid</span><span class="op" id="5283926">(</span><span class="op" id="5283927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283930">dir</span><span class="op" id="5283933">,</span>&nbsp;<span class="ident" id="5283935">file</span>&nbsp;<span class="op" id="5283940">:=</span>&nbsp;<span class="ident" id="5283943">path</span><span class="op" id="5283947">.</span><span class="ident" id="5283948">Split</span><span class="op" id="5283953">(</span><span class="ident" id="5283954">hdr</span><span class="op" id="5283957">.</span><span class="ident" id="5283958">Name</span><span class="op" id="5283962">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283965">fullName</span>&nbsp;<span class="op" id="5283974">:=</span>&nbsp;<span class="ident" id="5283977">path</span><span class="op" id="5283981">.</span><span class="ident" id="5283982">Join</span><span class="op" id="5283986">(</span><span class="ident" id="5283987">dir</span><span class="op" id="5283990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283994">fmt</span><span class="op" id="5283997">.</span><span class="ident" id="5283998">Sprintf</span><span class="op" id="5284005">(</span><span class="string" id="5284006">&#34;PaxHeaders.%d&#34;</span><span class="op" id="5284021">,</span>&nbsp;<span class="ident" id="5284023">pid</span><span class="op" id="5284026">)</span><span class="op" id="5284027">,</span>&nbsp;<span class="ident" id="5284029">file</span><span class="op" id="5284033">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284037">ascii</span>&nbsp;<span class="op" id="5284043">:=</span>&nbsp;<span class="ident" id="5284046">toASCII</span><span class="op" id="5284053">(</span><span class="ident" id="5284054">fullName</span><span class="op" id="5284062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284065">if</span>&nbsp;<span class="builtinfunc" id="5284068">len</span><span class="op" id="5284071">(</span><span class="ident" id="5284072">ascii</span><span class="op" id="5284077">)</span>&nbsp;<span class="op" id="5284079">&gt;</span>&nbsp;<span class="num" id="5284081">100</span>&nbsp;<span class="op" id="5284085">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284089">ascii</span>&nbsp;<span class="op" id="5284095">=</span>&nbsp;<span class="ident" id="5284097">ascii</span><span class="op" id="5284102">[</span><span class="op" id="5284103">:</span><span class="num" id="5284104">100</span><span class="op" id="5284107">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284113">ext</span><span class="op" id="5284116">.</span><span class="ident" id="5284117">Name</span>&nbsp;<span class="op" id="5284122">=</span>&nbsp;<span class="ident" id="5284124">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284131">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284154">var</span>&nbsp;<span class="ident" id="5284158">buf</span>&nbsp;<span class="ident" id="5284162">bytes</span><span class="op" id="5284167">.</span><span class="ident" id="5284168">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284177">for</span>&nbsp;<span class="ident" id="5284181">k</span><span class="op" id="5284182">,</span>&nbsp;<span class="ident" id="5284184">v</span>&nbsp;<span class="op" id="5284186">:=</span>&nbsp;<span class="keyword" id="5284189">range</span>&nbsp;<span class="ident" id="5284195">paxHeaders</span>&nbsp;<span class="op" id="5284206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284210">fmt</span><span class="op" id="5284213">.</span><span class="ident" id="5284214">Fprint</span><span class="op" id="5284220">(</span><span class="op" id="5284221">&amp;</span><span class="ident" id="5284222">buf</span><span class="op" id="5284225">,</span>&nbsp;<span class="ident" id="5284227">paxHeader</span><span class="op" id="5284236">(</span><span class="ident" id="5284237">k</span><span class="op" id="5284238">+</span><span class="string" id="5284239">&#34;=&#34;</span><span class="op" id="5284242">+</span><span class="ident" id="5284243">v</span><span class="op" id="5284244">)</span><span class="op" id="5284245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284252">ext</span><span class="op" id="5284255">.</span><span class="ident" id="5284256">Size</span>&nbsp;<span class="op" id="5284261">=</span>&nbsp;<span class="ident" id="5284263">int64</span><span class="op" id="5284268">(</span><span class="builtinfunc" id="5284269">len</span><span class="op" id="5284272">(</span><span class="ident" id="5284273">buf</span><span class="op" id="5284276">.</span><span class="ident" id="5284277">Bytes</span><span class="op" id="5284282">(</span><span class="op" id="5284283">)</span><span class="op" id="5284284">)</span><span class="op" id="5284285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284288">if</span>&nbsp;<span class="ident" id="5284291">err</span>&nbsp;<span class="op" id="5284295">:=</span>&nbsp;<span class="ident" id="5284298">tw</span><span class="op" id="5284300">.</span><span class="ident" id="5284301">writeHeader</span><span class="op" id="5284312">(</span><span class="ident" id="5284313">ext</span><span class="op" id="5284316">,</span>&nbsp;<span class="builtintype" id="5284318">false</span><span class="op" id="5284323">)</span><span class="op" id="5284324">;</span>&nbsp;<span class="ident" id="5284326">err</span>&nbsp;<span class="op" id="5284330">!=</span>&nbsp;<span class="ident" id="5284333">nil</span>&nbsp;<span class="op" id="5284337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284341">return</span>&nbsp;<span class="ident" id="5284348">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284356">if</span>&nbsp;<span class="ident" id="5284359">_</span><span class="op" id="5284360">,</span>&nbsp;<span class="ident" id="5284362">err</span>&nbsp;<span class="op" id="5284366">:=</span>&nbsp;<span class="ident" id="5284369">tw</span><span class="op" id="5284371">.</span><span class="ident" id="5284372">Write</span><span class="op" id="5284377">(</span><span class="ident" id="5284378">buf</span><span class="op" id="5284381">.</span><span class="ident" id="5284382">Bytes</span><span class="op" id="5284387">(</span><span class="op" id="5284388">)</span><span class="op" id="5284389">)</span><span class="op" id="5284390">;</span>&nbsp;<span class="ident" id="5284392">err</span>&nbsp;<span class="op" id="5284396">!=</span>&nbsp;<span class="ident" id="5284399">nil</span>&nbsp;<span class="op" id="5284403">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284407">return</span>&nbsp;<span class="ident" id="5284414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284422">if</span>&nbsp;<span class="ident" id="5284425">err</span>&nbsp;<span class="op" id="5284429">:=</span>&nbsp;<span class="ident" id="5284432">tw</span><span class="op" id="5284434">.</span><span class="ident" id="5284435">Flush</span><span class="op" id="5284440">(</span><span class="op" id="5284441">)</span><span class="op" id="5284442">;</span>&nbsp;<span class="ident" id="5284444">err</span>&nbsp;<span class="op" id="5284448">!=</span>&nbsp;<span class="ident" id="5284451">nil</span>&nbsp;<span class="op" id="5284455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284459">return</span>&nbsp;<span class="ident" id="5284466">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284471">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284474">return</span>&nbsp;<span class="ident" id="5284481">nil</span><br>
<span class="lineno"></span><span class="op" id="5284485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5284488">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="5284571">func</span>&nbsp;<span class="ident" id="5284576">paxHeader</span><span class="op" id="5284585">(</span><span class="ident" id="5284586">msg</span>&nbsp;<span class="builtintype" id="5284590">string</span><span class="op" id="5284596">)</span>&nbsp;<span class="builtintype" id="5284598">string</span>&nbsp;<span class="op" id="5284605">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284608">const</span>&nbsp;<span class="ident" id="5284614">padding</span>&nbsp;<span class="op" id="5284622">=</span>&nbsp;<span class="num" id="5284624">2</span>&nbsp;<span class="comment" id="5284626">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284666">size</span>&nbsp;<span class="op" id="5284671">:=</span>&nbsp;<span class="builtinfunc" id="5284674">len</span><span class="op" id="5284677">(</span><span class="ident" id="5284678">msg</span><span class="op" id="5284681">)</span>&nbsp;<span class="op" id="5284683">+</span>&nbsp;<span class="ident" id="5284685">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284694">size</span>&nbsp;<span class="op" id="5284699">+=</span>&nbsp;<span class="builtinfunc" id="5284702">len</span><span class="op" id="5284705">(</span><span class="ident" id="5284706">strconv</span><span class="op" id="5284713">.</span><span class="ident" id="5284714">Itoa</span><span class="op" id="5284718">(</span><span class="ident" id="5284719">size</span><span class="op" id="5284723">)</span><span class="op" id="5284724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284727">record</span>&nbsp;<span class="op" id="5284734">:=</span>&nbsp;<span class="ident" id="5284737">fmt</span><span class="op" id="5284740">.</span><span class="ident" id="5284741">Sprintf</span><span class="op" id="5284748">(</span><span class="string" id="5284749">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5284758">,</span>&nbsp;<span class="ident" id="5284760">size</span><span class="op" id="5284764">,</span>&nbsp;<span class="ident" id="5284766">msg</span><span class="op" id="5284769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284772">if</span>&nbsp;<span class="builtinfunc" id="5284775">len</span><span class="op" id="5284778">(</span><span class="ident" id="5284779">record</span><span class="op" id="5284785">)</span>&nbsp;<span class="op" id="5284787">!=</span>&nbsp;<span class="ident" id="5284790">size</span>&nbsp;<span class="op" id="5284795">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284799">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284846">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284880">size</span>&nbsp;<span class="op" id="5284885">=</span>&nbsp;<span class="builtinfunc" id="5284887">len</span><span class="op" id="5284890">(</span><span class="ident" id="5284891">record</span><span class="op" id="5284897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284901">record</span>&nbsp;<span class="op" id="5284908">=</span>&nbsp;<span class="ident" id="5284910">fmt</span><span class="op" id="5284913">.</span><span class="ident" id="5284914">Sprintf</span><span class="op" id="5284921">(</span><span class="string" id="5284922">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5284931">,</span>&nbsp;<span class="ident" id="5284933">size</span><span class="op" id="5284937">,</span>&nbsp;<span class="ident" id="5284939">msg</span><span class="op" id="5284942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284945">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284948">return</span>&nbsp;<span class="ident" id="5284955">record</span><br>
<span class="lineno"></span><span class="op" id="5284962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5284965">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="5285022">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="5285078">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="5285127">func</span>&nbsp;<span class="op" id="5285132">(</span><span class="ident" id="5285133">tw</span>&nbsp;<span class="op" id="5285136">*</span><span class="ident" id="5285137">Writer</span><span class="op" id="5285143">)</span>&nbsp;<span class="ident" id="5285145">Write</span><span class="op" id="5285150">(</span><span class="ident" id="5285151">b</span>&nbsp;<span class="op" id="5285153">[</span><span class="op" id="5285154">]</span><span class="builtintype" id="5285155">byte</span><span class="op" id="5285159">)</span>&nbsp;<span class="op" id="5285161">(</span><span class="ident" id="5285162">n</span>&nbsp;<span class="builtintype" id="5285164">int</span><span class="op" id="5285167">,</span>&nbsp;<span class="ident" id="5285169">err</span>&nbsp;<span class="builtintype" id="5285173">error</span><span class="op" id="5285178">)</span>&nbsp;<span class="op" id="5285180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285183">if</span>&nbsp;<span class="ident" id="5285186">tw</span><span class="op" id="5285188">.</span><span class="ident" id="5285189">closed</span>&nbsp;<span class="op" id="5285196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285200">err</span>&nbsp;<span class="op" id="5285204">=</span>&nbsp;<span class="ident" id="5285206">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285224">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285235">overwrite</span>&nbsp;<span class="op" id="5285245">:=</span>&nbsp;<span class="builtintype" id="5285248">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285255">if</span>&nbsp;<span class="ident" id="5285258">int64</span><span class="op" id="5285263">(</span><span class="builtinfunc" id="5285264">len</span><span class="op" id="5285267">(</span><span class="ident" id="5285268">b</span><span class="op" id="5285269">)</span><span class="op" id="5285270">)</span>&nbsp;<span class="op" id="5285272">&gt;</span>&nbsp;<span class="ident" id="5285274">tw</span><span class="op" id="5285276">.</span><span class="ident" id="5285277">nb</span>&nbsp;<span class="op" id="5285280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285284">b</span>&nbsp;<span class="op" id="5285286">=</span>&nbsp;<span class="ident" id="5285288">b</span><span class="op" id="5285289">[</span><span class="num" id="5285290">0</span><span class="op" id="5285291">:</span><span class="ident" id="5285292">tw</span><span class="op" id="5285294">.</span><span class="ident" id="5285295">nb</span><span class="op" id="5285297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285301">overwrite</span>&nbsp;<span class="op" id="5285311">=</span>&nbsp;<span class="builtintype" id="5285313">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285322">n</span><span class="op" id="5285323">,</span>&nbsp;<span class="ident" id="5285325">err</span>&nbsp;<span class="op" id="5285329">=</span>&nbsp;<span class="ident" id="5285331">tw</span><span class="op" id="5285333">.</span><span class="ident" id="5285334">w</span><span class="op" id="5285335">.</span><span class="ident" id="5285336">Write</span><span class="op" id="5285341">(</span><span class="ident" id="5285342">b</span><span class="op" id="5285343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285346">tw</span><span class="op" id="5285348">.</span><span class="ident" id="5285349">nb</span>&nbsp;<span class="op" id="5285352">-=</span>&nbsp;<span class="ident" id="5285355">int64</span><span class="op" id="5285360">(</span><span class="ident" id="5285361">n</span><span class="op" id="5285362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285365">if</span>&nbsp;<span class="ident" id="5285368">err</span>&nbsp;<span class="op" id="5285372">==</span>&nbsp;<span class="ident" id="5285375">nil</span>&nbsp;<span class="op" id="5285379">&amp;&amp;</span>&nbsp;<span class="ident" id="5285382">overwrite</span>&nbsp;<span class="op" id="5285392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285396">err</span>&nbsp;<span class="op" id="5285400">=</span>&nbsp;<span class="ident" id="5285402">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285420">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285431">tw</span><span class="op" id="5285433">.</span><span class="ident" id="5285434">err</span>&nbsp;<span class="op" id="5285438">=</span>&nbsp;<span class="ident" id="5285440">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285445">return</span><br>
<span class="lineno"></span><span class="op" id="5285452">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="5285455">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="5285511">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5285545">func</span>&nbsp;<span class="op" id="5285550">(</span><span class="ident" id="5285551">tw</span>&nbsp;<span class="op" id="5285554">*</span><span class="ident" id="5285555">Writer</span><span class="op" id="5285561">)</span>&nbsp;<span class="ident" id="5285563">Close</span><span class="op" id="5285568">(</span><span class="op" id="5285569">)</span>&nbsp;<span class="builtintype" id="5285571">error</span>&nbsp;<span class="op" id="5285577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285580">if</span>&nbsp;<span class="ident" id="5285583">tw</span><span class="op" id="5285585">.</span><span class="ident" id="5285586">err</span>&nbsp;<span class="op" id="5285590">!=</span>&nbsp;<span class="ident" id="5285593">nil</span>&nbsp;<span class="op" id="5285597">||</span>&nbsp;<span class="ident" id="5285600">tw</span><span class="op" id="5285602">.</span><span class="ident" id="5285603">closed</span>&nbsp;<span class="op" id="5285610">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285614">return</span>&nbsp;<span class="ident" id="5285621">tw</span><span class="op" id="5285623">.</span><span class="ident" id="5285624">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285632">tw</span><span class="op" id="5285634">.</span><span class="ident" id="5285635">Flush</span><span class="op" id="5285640">(</span><span class="op" id="5285641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285644">tw</span><span class="op" id="5285646">.</span><span class="ident" id="5285647">closed</span>&nbsp;<span class="op" id="5285654">=</span>&nbsp;<span class="builtintype" id="5285656">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285662">if</span>&nbsp;<span class="ident" id="5285665">tw</span><span class="op" id="5285667">.</span><span class="ident" id="5285668">err</span>&nbsp;<span class="op" id="5285672">!=</span>&nbsp;<span class="ident" id="5285675">nil</span>&nbsp;<span class="op" id="5285679">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285683">return</span>&nbsp;<span class="ident" id="5285690">tw</span><span class="op" id="5285692">.</span><span class="ident" id="5285693">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285702">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285731">for</span>&nbsp;<span class="ident" id="5285735">i</span>&nbsp;<span class="op" id="5285737">:=</span>&nbsp;<span class="num" id="5285740">0</span><span class="op" id="5285741">;</span>&nbsp;<span class="ident" id="5285743">i</span>&nbsp;<span class="op" id="5285745">&lt;</span>&nbsp;<span class="num" id="5285747">2</span><span class="op" id="5285748">;</span>&nbsp;<span class="ident" id="5285750">i</span><span class="op" id="5285751">++</span>&nbsp;<span class="op" id="5285754">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285758">_</span><span class="op" id="5285759">,</span>&nbsp;<span class="ident" id="5285761">tw</span><span class="op" id="5285763">.</span><span class="ident" id="5285764">err</span>&nbsp;<span class="op" id="5285768">=</span>&nbsp;<span class="ident" id="5285770">tw</span><span class="op" id="5285772">.</span><span class="ident" id="5285773">w</span><span class="op" id="5285774">.</span><span class="ident" id="5285775">Write</span><span class="op" id="5285780">(</span><span class="ident" id="5285781">zeroBlock</span><span class="op" id="5285790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285794">if</span>&nbsp;<span class="ident" id="5285797">tw</span><span class="op" id="5285799">.</span><span class="ident" id="5285800">err</span>&nbsp;<span class="op" id="5285804">!=</span>&nbsp;<span class="ident" id="5285807">nil</span>&nbsp;<span class="op" id="5285811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285816">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285827">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285830">return</span>&nbsp;<span class="ident" id="5285837">tw</span><span class="op" id="5285839">.</span><span class="ident" id="5285840">err</span><br>
<span class="lineno"></span><span class="op" id="5285844">}</span>
</div>
</body>
</html>
