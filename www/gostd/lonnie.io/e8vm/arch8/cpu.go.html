<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="4777843">package</span>&nbsp;<span class="ident" id="4777851">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4777858">//&nbsp;Inst&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;executing&nbsp;one&nbsp;single&nbsp;instruction</span><br>
<span class="lineno"></span><span class="keyword" id="4777919">type</span>&nbsp;<span class="ident" id="4777924">inst</span>&nbsp;<span class="keyword" id="4777929">interface</span>&nbsp;<span class="op" id="4777939">{</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777942">I</span><span class="op" id="4777943">(</span><span class="ident" id="4777944">cpu</span>&nbsp;<span class="op" id="4777948">*</span><span class="ident" id="4777949">cpu</span><span class="op" id="4777952">,</span>&nbsp;<span class="ident" id="4777954">in</span>&nbsp;<span class="builtintype" id="4777957">uint32</span><span class="op" id="4777963">)</span>&nbsp;<span class="op" id="4777965">*</span><span class="ident" id="4777966">Excep</span><br>
<span class="lineno"></span><span class="op" id="4777972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4777975">//&nbsp;CPU&nbsp;defines&nbsp;the&nbsp;structure&nbsp;of&nbsp;a&nbsp;processing&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="4778026">type</span>&nbsp;<span class="ident" id="4778031">cpu</span>&nbsp;<span class="keyword" id="4778035">struct</span>&nbsp;<span class="op" id="4778042">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778045">regs</span>&nbsp;<span class="op" id="4778050">[</span><span class="op" id="4778051">]</span><span class="builtintype" id="4778052">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778060">ring</span>&nbsp;<span class="builtintype" id="4778065">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778072">phyMem</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778082">*</span><span class="ident" id="4778083">phyMemory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778094">virtMem</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4778104">*</span><span class="ident" id="4778105">virtMemory</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778117">interrupt</span>&nbsp;<span class="op" id="4778127">*</span><span class="ident" id="4778128">interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778140">inst</span>&nbsp;&nbsp;<span class="ident" id="4778146">inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778152">index</span>&nbsp;<span class="builtintype" id="4778158">byte</span><br>
<span class="lineno"></span><span class="op" id="4778163">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4778166">//&nbsp;InitPC&nbsp;points&nbsp;the&nbsp;default&nbsp;starting&nbsp;value&nbsp;of&nbsp;the&nbsp;program&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="4778234">const</span>&nbsp;<span class="ident" id="4778240">InitPC</span>&nbsp;<span class="op" id="4778247">=</span>&nbsp;<span class="num" id="4778249">0x8000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4778257">//&nbsp;NewCPU&nbsp;creates&nbsp;a&nbsp;CPU&nbsp;with&nbsp;memroy&nbsp;and&nbsp;instruction&nbsp;binding</span><br>
<span class="lineno">25</span><span class="keyword" id="4778317">func</span>&nbsp;<span class="ident" id="4778322">newCPU</span><span class="op" id="4778328">(</span><span class="ident" id="4778329">mem</span>&nbsp;<span class="op" id="4778333">*</span><span class="ident" id="4778334">phyMemory</span><span class="op" id="4778343">,</span>&nbsp;<span class="ident" id="4778345">i</span>&nbsp;<span class="ident" id="4778347">inst</span><span class="op" id="4778351">,</span>&nbsp;<span class="ident" id="4778353">index</span>&nbsp;<span class="builtintype" id="4778359">byte</span><span class="op" id="4778363">)</span>&nbsp;<span class="op" id="4778365">*</span><span class="ident" id="4778366">cpu</span>&nbsp;<span class="op" id="4778370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778373">if</span>&nbsp;<span class="ident" id="4778376">index</span>&nbsp;<span class="op" id="4778382">&gt;=</span>&nbsp;<span class="num" id="4778385">32</span>&nbsp;<span class="op" id="4778388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4778392">panic</span><span class="op" id="4778397">(</span><span class="string" id="4778398">&#34;too&nbsp;many&nbsp;cores&#34;</span><span class="op" id="4778414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778421">ret</span>&nbsp;<span class="op" id="4778425">:=</span>&nbsp;<span class="builtinfunc" id="4778428">new</span><span class="op" id="4778431">(</span><span class="ident" id="4778432">cpu</span><span class="op" id="4778435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778438">ret</span><span class="op" id="4778441">.</span><span class="ident" id="4778442">regs</span>&nbsp;<span class="op" id="4778447">=</span>&nbsp;<span class="ident" id="4778449">makeRegs</span><span class="op" id="4778457">(</span><span class="op" id="4778458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778461">ret</span><span class="op" id="4778464">.</span><span class="ident" id="4778465">phyMem</span>&nbsp;<span class="op" id="4778472">=</span>&nbsp;<span class="ident" id="4778474">mem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778479">ret</span><span class="op" id="4778482">.</span><span class="ident" id="4778483">virtMem</span>&nbsp;<span class="op" id="4778491">=</span>&nbsp;<span class="ident" id="4778493">newVirtMemory</span><span class="op" id="4778506">(</span><span class="ident" id="4778507">ret</span><span class="op" id="4778510">.</span><span class="ident" id="4778511">phyMem</span><span class="op" id="4778517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778520">ret</span><span class="op" id="4778523">.</span><span class="ident" id="4778524">index</span>&nbsp;<span class="op" id="4778530">=</span>&nbsp;<span class="ident" id="4778532">index</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778540">intPage</span>&nbsp;<span class="op" id="4778548">:=</span>&nbsp;<span class="ident" id="4778551">ret</span><span class="op" id="4778554">.</span><span class="ident" id="4778555">phyMem</span><span class="op" id="4778561">.</span><span class="ident" id="4778562">Page</span><span class="op" id="4778566">(</span><span class="ident" id="4778567">pageInterrupt</span><span class="op" id="4778580">)</span>&nbsp;<span class="comment" id="4778582">//&nbsp;page&nbsp;1&nbsp;is&nbsp;the&nbsp;interrupt&nbsp;page</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778615">if</span>&nbsp;<span class="ident" id="4778618">intPage</span>&nbsp;<span class="op" id="4778626">==</span>&nbsp;<span class="ident" id="4778629">nil</span>&nbsp;<span class="op" id="4778633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4778637">panic</span><span class="op" id="4778642">(</span><span class="string" id="4778643">&#34;memory&nbsp;too&nbsp;small&#34;</span><span class="op" id="4778661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778664">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778667">ret</span><span class="op" id="4778670">.</span><span class="ident" id="4778671">interrupt</span>&nbsp;<span class="op" id="4778681">=</span>&nbsp;<span class="ident" id="4778683">newInterrupt</span><span class="op" id="4778695">(</span><span class="ident" id="4778696">intPage</span><span class="op" id="4778703">,</span>&nbsp;<span class="ident" id="4778705">index</span><span class="op" id="4778710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778713">ret</span><span class="op" id="4778716">.</span><span class="ident" id="4778717">inst</span>&nbsp;<span class="op" id="4778722">=</span>&nbsp;<span class="ident" id="4778724">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778728">ret</span><span class="op" id="4778731">.</span><span class="ident" id="4778732">regs</span><span class="op" id="4778736">[</span><span class="ident" id="4778737">PC</span><span class="op" id="4778739">]</span>&nbsp;<span class="op" id="4778741">=</span>&nbsp;<span class="ident" id="4778743">InitPC</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778752">return</span>&nbsp;<span class="ident" id="4778759">ret</span><br>
<span class="lineno"></span><span class="op" id="4778763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4778766">//&nbsp;UserMode&nbsp;returns&nbsp;trun&nbsp;when&nbsp;the&nbsp;CPU&nbsp;is&nbsp;in&nbsp;user&nbsp;mode.</span><br>
<span class="lineno"></span><span class="keyword" id="4778821">func</span>&nbsp;<span class="op" id="4778826">(</span><span class="ident" id="4778827">c</span>&nbsp;<span class="op" id="4778829">*</span><span class="ident" id="4778830">cpu</span><span class="op" id="4778833">)</span>&nbsp;<span class="ident" id="4778835">UserMode</span><span class="op" id="4778843">(</span><span class="op" id="4778844">)</span>&nbsp;<span class="builtintype" id="4778846">bool</span>&nbsp;<span class="op" id="4778851">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778854">return</span>&nbsp;<span class="ident" id="4778861">c</span><span class="op" id="4778862">.</span><span class="ident" id="4778863">ring</span>&nbsp;<span class="op" id="4778868">&gt;</span>&nbsp;<span class="num" id="4778870">0</span><br>
<span class="lineno"></span><span class="op" id="4778872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4778875">//&nbsp;Reset&nbsp;resets&nbsp;the&nbsp;CPU&#39;s&nbsp;internal&nbsp;states,&nbsp;i.e.,&nbsp;registers,</span><br>
<span class="lineno"></span><span class="comment" id="4778935">//&nbsp;the&nbsp;page&nbsp;table,&nbsp;and&nbsp;disables&nbsp;interrupt</span><br>
<span class="lineno">55</span><span class="keyword" id="4778977">func</span>&nbsp;<span class="op" id="4778982">(</span><span class="ident" id="4778983">c</span>&nbsp;<span class="op" id="4778985">*</span><span class="ident" id="4778986">cpu</span><span class="op" id="4778989">)</span>&nbsp;<span class="ident" id="4778991">Reset</span><span class="op" id="4778996">(</span><span class="op" id="4778997">)</span>&nbsp;<span class="op" id="4778999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779002">for</span>&nbsp;<span class="ident" id="4779006">i</span>&nbsp;<span class="op" id="4779008">:=</span>&nbsp;<span class="num" id="4779011">0</span><span class="op" id="4779012">;</span>&nbsp;<span class="ident" id="4779014">i</span>&nbsp;<span class="op" id="4779016">&lt;</span>&nbsp;<span class="ident" id="4779018">Nreg</span><span class="op" id="4779022">;</span>&nbsp;<span class="ident" id="4779024">i</span><span class="op" id="4779025">++</span>&nbsp;<span class="op" id="4779028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779032">c</span><span class="op" id="4779033">.</span><span class="ident" id="4779034">regs</span><span class="op" id="4779038">[</span><span class="ident" id="4779039">i</span><span class="op" id="4779040">]</span>&nbsp;<span class="op" id="4779042">=</span>&nbsp;<span class="num" id="4779044">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779050">c</span><span class="op" id="4779051">.</span><span class="ident" id="4779052">regs</span><span class="op" id="4779056">[</span><span class="ident" id="4779057">PC</span><span class="op" id="4779059">]</span>&nbsp;<span class="op" id="4779061">=</span>&nbsp;<span class="ident" id="4779063">InitPC</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779071">c</span><span class="op" id="4779072">.</span><span class="ident" id="4779073">virtMem</span><span class="op" id="4779080">.</span><span class="ident" id="4779081">SetTable</span><span class="op" id="4779089">(</span><span class="num" id="4779090">0</span><span class="op" id="4779091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779094">c</span><span class="op" id="4779095">.</span><span class="ident" id="4779096">ring</span>&nbsp;<span class="op" id="4779101">=</span>&nbsp;<span class="num" id="4779103">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779106">c</span><span class="op" id="4779107">.</span><span class="ident" id="4779108">interrupt</span><span class="op" id="4779117">.</span><span class="ident" id="4779118">Disable</span><span class="op" id="4779125">(</span><span class="op" id="4779126">)</span><br>
<span class="lineno"></span><span class="op" id="4779128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="4779131">func</span>&nbsp;<span class="op" id="4779136">(</span><span class="ident" id="4779137">c</span>&nbsp;<span class="op" id="4779139">*</span><span class="ident" id="4779140">cpu</span><span class="op" id="4779143">)</span>&nbsp;<span class="ident" id="4779145">tick</span><span class="op" id="4779149">(</span><span class="op" id="4779150">)</span>&nbsp;<span class="op" id="4779152">*</span><span class="ident" id="4779153">Excep</span>&nbsp;<span class="op" id="4779159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779162">pc</span>&nbsp;<span class="op" id="4779165">:=</span>&nbsp;<span class="ident" id="4779168">c</span><span class="op" id="4779169">.</span><span class="ident" id="4779170">regs</span><span class="op" id="4779174">[</span><span class="ident" id="4779175">PC</span><span class="op" id="4779177">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779180">inst</span><span class="op" id="4779184">,</span>&nbsp;<span class="ident" id="4779186">e</span>&nbsp;<span class="op" id="4779188">:=</span>&nbsp;<span class="ident" id="4779191">c</span><span class="op" id="4779192">.</span><span class="ident" id="4779193">readWord</span><span class="op" id="4779201">(</span><span class="ident" id="4779202">pc</span><span class="op" id="4779204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779207">if</span>&nbsp;<span class="ident" id="4779210">e</span>&nbsp;<span class="op" id="4779212">!=</span>&nbsp;<span class="ident" id="4779215">nil</span>&nbsp;<span class="op" id="4779219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779223">return</span>&nbsp;<span class="ident" id="4779230">e</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779237">c</span><span class="op" id="4779238">.</span><span class="ident" id="4779239">regs</span><span class="op" id="4779243">[</span><span class="ident" id="4779244">PC</span><span class="op" id="4779246">]</span>&nbsp;<span class="op" id="4779248">=</span>&nbsp;<span class="ident" id="4779250">pc</span>&nbsp;<span class="op" id="4779253">+</span>&nbsp;<span class="num" id="4779255">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779258">if</span>&nbsp;<span class="ident" id="4779261">c</span><span class="op" id="4779262">.</span><span class="ident" id="4779263">inst</span>&nbsp;<span class="op" id="4779268">!=</span>&nbsp;<span class="ident" id="4779271">nil</span>&nbsp;<span class="op" id="4779275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779279">e</span>&nbsp;<span class="op" id="4779281">=</span>&nbsp;<span class="ident" id="4779283">c</span><span class="op" id="4779284">.</span><span class="ident" id="4779285">inst</span><span class="op" id="4779289">.</span><span class="ident" id="4779290">I</span><span class="op" id="4779291">(</span><span class="ident" id="4779292">c</span><span class="op" id="4779293">,</span>&nbsp;<span class="ident" id="4779295">inst</span><span class="op" id="4779299">)</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779304">if</span>&nbsp;<span class="ident" id="4779307">e</span>&nbsp;<span class="op" id="4779309">!=</span>&nbsp;<span class="ident" id="4779312">nil</span>&nbsp;<span class="op" id="4779316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779321">c</span><span class="op" id="4779322">.</span><span class="ident" id="4779323">regs</span><span class="op" id="4779327">[</span><span class="ident" id="4779328">PC</span><span class="op" id="4779330">]</span>&nbsp;<span class="op" id="4779332">=</span>&nbsp;<span class="ident" id="4779334">pc</span>&nbsp;<span class="comment" id="4779337">//&nbsp;restore&nbsp;saved&nbsp;original&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779369">return</span>&nbsp;<span class="ident" id="4779376">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779380">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779387">return</span>&nbsp;<span class="ident" id="4779394">nil</span><br>
<span class="lineno"></span><span class="op" id="4779398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="4779401">const</span>&nbsp;<span class="op" id="4779407">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779410">intFrameSP</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4779423">=</span>&nbsp;<span class="num" id="4779425">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779428">intFrameRET</span>&nbsp;&nbsp;<span class="op" id="4779441">=</span>&nbsp;<span class="num" id="4779443">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779446">intFrameArg</span>&nbsp;&nbsp;<span class="op" id="4779459">=</span>&nbsp;<span class="num" id="4779461">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779464">intFrameCode</span>&nbsp;<span class="op" id="4779477">=</span>&nbsp;<span class="num" id="4779479">12</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779483">intFrameRing</span>&nbsp;<span class="op" id="4779496">=</span>&nbsp;<span class="num" id="4779498">13</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779503">intFrameSize</span>&nbsp;<span class="op" id="4779516">=</span>&nbsp;<span class="num" id="4779518">16</span><br>
<span class="lineno"></span><span class="op" id="4779521">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4779524">//&nbsp;Interrupt&nbsp;issues&nbsp;an&nbsp;interrupt&nbsp;to&nbsp;the&nbsp;core</span><br>
<span class="lineno"></span><span class="keyword" id="4779569">func</span>&nbsp;<span class="op" id="4779574">(</span><span class="ident" id="4779575">c</span>&nbsp;<span class="op" id="4779577">*</span><span class="ident" id="4779578">cpu</span><span class="op" id="4779581">)</span>&nbsp;<span class="ident" id="4779583">Interrupt</span><span class="op" id="4779592">(</span><span class="ident" id="4779593">code</span>&nbsp;<span class="builtintype" id="4779598">byte</span><span class="op" id="4779602">)</span>&nbsp;<span class="op" id="4779604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779607">c</span><span class="op" id="4779608">.</span><span class="ident" id="4779609">interrupt</span><span class="op" id="4779618">.</span><span class="ident" id="4779619">Issue</span><span class="op" id="4779624">(</span><span class="ident" id="4779625">code</span><span class="op" id="4779629">)</span><br>
<span class="lineno"></span><span class="op" id="4779631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4779634">func</span>&nbsp;<span class="op" id="4779639">(</span><span class="ident" id="4779640">c</span>&nbsp;<span class="op" id="4779642">*</span><span class="ident" id="4779643">cpu</span><span class="op" id="4779646">)</span>&nbsp;<span class="ident" id="4779648">readWord</span><span class="op" id="4779656">(</span><span class="ident" id="4779657">addr</span>&nbsp;<span class="builtintype" id="4779662">uint32</span><span class="op" id="4779668">)</span>&nbsp;<span class="op" id="4779670">(</span><span class="builtintype" id="4779671">uint32</span><span class="op" id="4779677">,</span>&nbsp;<span class="op" id="4779679">*</span><span class="ident" id="4779680">Excep</span><span class="op" id="4779685">)</span>&nbsp;<span class="op" id="4779687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779690">return</span>&nbsp;<span class="ident" id="4779697">c</span><span class="op" id="4779698">.</span><span class="ident" id="4779699">virtMem</span><span class="op" id="4779706">.</span><span class="ident" id="4779707">ReadWord</span><span class="op" id="4779715">(</span><span class="ident" id="4779716">addr</span><span class="op" id="4779720">,</span>&nbsp;<span class="ident" id="4779722">c</span><span class="op" id="4779723">.</span><span class="ident" id="4779724">ring</span><span class="op" id="4779728">)</span><br>
<span class="lineno"></span><span class="op" id="4779730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779733">func</span>&nbsp;<span class="op" id="4779738">(</span><span class="ident" id="4779739">c</span>&nbsp;<span class="op" id="4779741">*</span><span class="ident" id="4779742">cpu</span><span class="op" id="4779745">)</span>&nbsp;<span class="ident" id="4779747">readByte</span><span class="op" id="4779755">(</span><span class="ident" id="4779756">addr</span>&nbsp;<span class="builtintype" id="4779761">uint32</span><span class="op" id="4779767">)</span>&nbsp;<span class="op" id="4779769">(</span><span class="builtintype" id="4779770">uint8</span><span class="op" id="4779775">,</span>&nbsp;<span class="op" id="4779777">*</span><span class="ident" id="4779778">Excep</span><span class="op" id="4779783">)</span>&nbsp;<span class="op" id="4779785">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779788">return</span>&nbsp;<span class="ident" id="4779795">c</span><span class="op" id="4779796">.</span><span class="ident" id="4779797">virtMem</span><span class="op" id="4779804">.</span><span class="ident" id="4779805">ReadByte</span><span class="op" id="4779813">(</span><span class="ident" id="4779814">addr</span><span class="op" id="4779818">,</span>&nbsp;<span class="ident" id="4779820">c</span><span class="op" id="4779821">.</span><span class="ident" id="4779822">ring</span><span class="op" id="4779826">)</span><br>
<span class="lineno"></span><span class="op" id="4779828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779831">func</span>&nbsp;<span class="op" id="4779836">(</span><span class="ident" id="4779837">c</span>&nbsp;<span class="op" id="4779839">*</span><span class="ident" id="4779840">cpu</span><span class="op" id="4779843">)</span>&nbsp;<span class="ident" id="4779845">writeWord</span><span class="op" id="4779854">(</span><span class="ident" id="4779855">addr</span>&nbsp;<span class="builtintype" id="4779860">uint32</span><span class="op" id="4779866">,</span>&nbsp;<span class="ident" id="4779868">v</span>&nbsp;<span class="builtintype" id="4779870">uint32</span><span class="op" id="4779876">)</span>&nbsp;<span class="op" id="4779878">*</span><span class="ident" id="4779879">Excep</span>&nbsp;<span class="op" id="4779885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779888">return</span>&nbsp;<span class="ident" id="4779895">c</span><span class="op" id="4779896">.</span><span class="ident" id="4779897">virtMem</span><span class="op" id="4779904">.</span><span class="ident" id="4779905">WriteWord</span><span class="op" id="4779914">(</span><span class="ident" id="4779915">addr</span><span class="op" id="4779919">,</span>&nbsp;<span class="ident" id="4779921">c</span><span class="op" id="4779922">.</span><span class="ident" id="4779923">ring</span><span class="op" id="4779927">,</span>&nbsp;<span class="ident" id="4779929">v</span><span class="op" id="4779930">)</span><br>
<span class="lineno">110</span><span class="op" id="4779932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779935">func</span>&nbsp;<span class="op" id="4779940">(</span><span class="ident" id="4779941">c</span>&nbsp;<span class="op" id="4779943">*</span><span class="ident" id="4779944">cpu</span><span class="op" id="4779947">)</span>&nbsp;<span class="ident" id="4779949">writeByte</span><span class="op" id="4779958">(</span><span class="ident" id="4779959">addr</span>&nbsp;<span class="builtintype" id="4779964">uint32</span><span class="op" id="4779970">,</span>&nbsp;<span class="ident" id="4779972">v</span>&nbsp;<span class="builtintype" id="4779974">uint8</span><span class="op" id="4779979">)</span>&nbsp;<span class="op" id="4779981">*</span><span class="ident" id="4779982">Excep</span>&nbsp;<span class="op" id="4779988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779991">return</span>&nbsp;<span class="ident" id="4779998">c</span><span class="op" id="4779999">.</span><span class="ident" id="4780000">virtMem</span><span class="op" id="4780007">.</span><span class="ident" id="4780008">WriteByte</span><span class="op" id="4780017">(</span><span class="ident" id="4780018">addr</span><span class="op" id="4780022">,</span>&nbsp;<span class="ident" id="4780024">c</span><span class="op" id="4780025">.</span><span class="ident" id="4780026">ring</span><span class="op" id="4780030">,</span>&nbsp;<span class="ident" id="4780032">v</span><span class="op" id="4780033">)</span><br>
<span class="lineno"></span><span class="op" id="4780035">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4780038">//&nbsp;Ienter&nbsp;enters&nbsp;a&nbsp;interrupt&nbsp;routine.</span><br>
<span class="lineno"></span><span class="keyword" id="4780076">func</span>&nbsp;<span class="op" id="4780081">(</span><span class="ident" id="4780082">c</span>&nbsp;<span class="op" id="4780084">*</span><span class="ident" id="4780085">cpu</span><span class="op" id="4780088">)</span>&nbsp;<span class="ident" id="4780090">Ienter</span><span class="op" id="4780096">(</span><span class="ident" id="4780097">code</span>&nbsp;<span class="builtintype" id="4780102">byte</span><span class="op" id="4780106">,</span>&nbsp;<span class="ident" id="4780108">arg</span>&nbsp;<span class="builtintype" id="4780112">uint32</span><span class="op" id="4780118">)</span>&nbsp;<span class="op" id="4780120">*</span><span class="ident" id="4780121">Excep</span>&nbsp;<span class="op" id="4780127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780130">ksp</span>&nbsp;<span class="op" id="4780134">:=</span>&nbsp;<span class="ident" id="4780137">c</span><span class="op" id="4780138">.</span><span class="ident" id="4780139">interrupt</span><span class="op" id="4780148">.</span><span class="ident" id="4780149">kernelSP</span><span class="op" id="4780157">(</span><span class="op" id="4780158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780161">base</span>&nbsp;<span class="op" id="4780166">:=</span>&nbsp;<span class="ident" id="4780169">ksp</span>&nbsp;<span class="op" id="4780173">-</span>&nbsp;<span class="ident" id="4780175">intFrameSize</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780190">writeWord</span>&nbsp;<span class="op" id="4780200">:=</span>&nbsp;<span class="keyword" id="4780203">func</span><span class="op" id="4780207">(</span><span class="ident" id="4780208">off</span>&nbsp;<span class="builtintype" id="4780212">uint32</span><span class="op" id="4780218">,</span>&nbsp;<span class="ident" id="4780220">v</span>&nbsp;<span class="builtintype" id="4780222">uint32</span><span class="op" id="4780228">)</span>&nbsp;<span class="op" id="4780230">*</span><span class="ident" id="4780231">Excep</span>&nbsp;<span class="op" id="4780237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780241">return</span>&nbsp;<span class="ident" id="4780248">c</span><span class="op" id="4780249">.</span><span class="ident" id="4780250">virtMem</span><span class="op" id="4780257">.</span><span class="ident" id="4780258">WriteWord</span><span class="op" id="4780267">(</span><span class="ident" id="4780268">base</span><span class="op" id="4780272">+</span><span class="ident" id="4780273">off</span><span class="op" id="4780276">,</span>&nbsp;<span class="num" id="4780278">0</span><span class="op" id="4780279">,</span>&nbsp;<span class="ident" id="4780281">v</span><span class="op" id="4780282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780288">writeByte</span>&nbsp;<span class="op" id="4780298">:=</span>&nbsp;<span class="keyword" id="4780301">func</span><span class="op" id="4780305">(</span><span class="ident" id="4780306">off</span>&nbsp;<span class="builtintype" id="4780310">uint32</span><span class="op" id="4780316">,</span>&nbsp;<span class="ident" id="4780318">b</span>&nbsp;<span class="builtintype" id="4780320">uint8</span><span class="op" id="4780325">)</span>&nbsp;<span class="op" id="4780327">*</span><span class="ident" id="4780328">Excep</span>&nbsp;<span class="op" id="4780334">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780338">return</span>&nbsp;<span class="ident" id="4780345">c</span><span class="op" id="4780346">.</span><span class="ident" id="4780347">virtMem</span><span class="op" id="4780354">.</span><span class="ident" id="4780355">WriteByte</span><span class="op" id="4780364">(</span><span class="ident" id="4780365">base</span><span class="op" id="4780369">+</span><span class="ident" id="4780370">off</span><span class="op" id="4780373">,</span>&nbsp;<span class="num" id="4780375">0</span><span class="op" id="4780376">,</span>&nbsp;<span class="ident" id="4780378">b</span><span class="op" id="4780379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780385">if</span>&nbsp;<span class="ident" id="4780388">e</span>&nbsp;<span class="op" id="4780390">:=</span>&nbsp;<span class="ident" id="4780393">writeWord</span><span class="op" id="4780402">(</span><span class="ident" id="4780403">intFrameSP</span><span class="op" id="4780413">,</span>&nbsp;<span class="ident" id="4780415">c</span><span class="op" id="4780416">.</span><span class="ident" id="4780417">regs</span><span class="op" id="4780421">[</span><span class="ident" id="4780422">SP</span><span class="op" id="4780424">]</span><span class="op" id="4780425">)</span><span class="op" id="4780426">;</span>&nbsp;<span class="ident" id="4780428">e</span>&nbsp;<span class="op" id="4780430">!=</span>&nbsp;<span class="ident" id="4780433">nil</span>&nbsp;<span class="op" id="4780437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780441">return</span>&nbsp;<span class="ident" id="4780448">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780451">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780454">if</span>&nbsp;<span class="ident" id="4780457">e</span>&nbsp;<span class="op" id="4780459">:=</span>&nbsp;<span class="ident" id="4780462">writeWord</span><span class="op" id="4780471">(</span><span class="ident" id="4780472">intFrameRET</span><span class="op" id="4780483">,</span>&nbsp;<span class="ident" id="4780485">c</span><span class="op" id="4780486">.</span><span class="ident" id="4780487">regs</span><span class="op" id="4780491">[</span><span class="ident" id="4780492">RET</span><span class="op" id="4780495">]</span><span class="op" id="4780496">)</span><span class="op" id="4780497">;</span>&nbsp;<span class="ident" id="4780499">e</span>&nbsp;<span class="op" id="4780501">!=</span>&nbsp;<span class="ident" id="4780504">nil</span>&nbsp;<span class="op" id="4780508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780512">return</span>&nbsp;<span class="ident" id="4780519">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780525">if</span>&nbsp;<span class="ident" id="4780528">e</span>&nbsp;<span class="op" id="4780530">:=</span>&nbsp;<span class="ident" id="4780533">writeWord</span><span class="op" id="4780542">(</span><span class="ident" id="4780543">intFrameArg</span><span class="op" id="4780554">,</span>&nbsp;<span class="ident" id="4780556">arg</span><span class="op" id="4780559">)</span><span class="op" id="4780560">;</span>&nbsp;<span class="ident" id="4780562">e</span>&nbsp;<span class="op" id="4780564">!=</span>&nbsp;<span class="ident" id="4780567">nil</span>&nbsp;<span class="op" id="4780571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780575">return</span>&nbsp;<span class="ident" id="4780582">e</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780588">if</span>&nbsp;<span class="ident" id="4780591">e</span>&nbsp;<span class="op" id="4780593">:=</span>&nbsp;<span class="ident" id="4780596">writeByte</span><span class="op" id="4780605">(</span><span class="ident" id="4780606">intFrameCode</span><span class="op" id="4780618">,</span>&nbsp;<span class="ident" id="4780620">code</span><span class="op" id="4780624">)</span><span class="op" id="4780625">;</span>&nbsp;<span class="ident" id="4780627">e</span>&nbsp;<span class="op" id="4780629">!=</span>&nbsp;<span class="ident" id="4780632">nil</span>&nbsp;<span class="op" id="4780636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780640">return</span>&nbsp;<span class="ident" id="4780647">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780653">if</span>&nbsp;<span class="ident" id="4780656">e</span>&nbsp;<span class="op" id="4780658">:=</span>&nbsp;<span class="ident" id="4780661">writeByte</span><span class="op" id="4780670">(</span><span class="ident" id="4780671">intFrameRing</span><span class="op" id="4780683">,</span>&nbsp;<span class="ident" id="4780685">c</span><span class="op" id="4780686">.</span><span class="ident" id="4780687">ring</span><span class="op" id="4780691">)</span><span class="op" id="4780692">;</span>&nbsp;<span class="ident" id="4780694">e</span>&nbsp;<span class="op" id="4780696">!=</span>&nbsp;<span class="ident" id="4780699">nil</span>&nbsp;<span class="op" id="4780703">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780707">return</span>&nbsp;<span class="ident" id="4780714">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780721">c</span><span class="op" id="4780722">.</span><span class="ident" id="4780723">interrupt</span><span class="op" id="4780732">.</span><span class="ident" id="4780733">Disable</span><span class="op" id="4780740">(</span><span class="op" id="4780741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780744">c</span><span class="op" id="4780745">.</span><span class="ident" id="4780746">regs</span><span class="op" id="4780750">[</span><span class="ident" id="4780751">SP</span><span class="op" id="4780753">]</span>&nbsp;<span class="op" id="4780755">=</span>&nbsp;<span class="ident" id="4780757">ksp</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780762">c</span><span class="op" id="4780763">.</span><span class="ident" id="4780764">regs</span><span class="op" id="4780768">[</span><span class="ident" id="4780769">RET</span><span class="op" id="4780772">]</span>&nbsp;<span class="op" id="4780774">=</span>&nbsp;<span class="ident" id="4780776">c</span><span class="op" id="4780777">.</span><span class="ident" id="4780778">regs</span><span class="op" id="4780782">[</span><span class="ident" id="4780783">PC</span><span class="op" id="4780785">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780788">c</span><span class="op" id="4780789">.</span><span class="ident" id="4780790">regs</span><span class="op" id="4780794">[</span><span class="ident" id="4780795">PC</span><span class="op" id="4780797">]</span>&nbsp;<span class="op" id="4780799">=</span>&nbsp;<span class="ident" id="4780801">c</span><span class="op" id="4780802">.</span><span class="ident" id="4780803">interrupt</span><span class="op" id="4780812">.</span><span class="ident" id="4780813">handlerPC</span><span class="op" id="4780822">(</span><span class="op" id="4780823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780826">c</span><span class="op" id="4780827">.</span><span class="ident" id="4780828">ring</span>&nbsp;<span class="op" id="4780833">=</span>&nbsp;<span class="num" id="4780835">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780839">return</span>&nbsp;<span class="ident" id="4780846">nil</span><br>
<span class="lineno">150</span><span class="op" id="4780850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4780853">//&nbsp;Syscall&nbsp;jumps&nbsp;to&nbsp;the&nbsp;system&nbsp;call&nbsp;handler&nbsp;and&nbsp;switches&nbsp;to&nbsp;ring&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4780921">func</span>&nbsp;<span class="op" id="4780926">(</span><span class="ident" id="4780927">c</span>&nbsp;<span class="op" id="4780929">*</span><span class="ident" id="4780930">cpu</span><span class="op" id="4780933">)</span>&nbsp;<span class="ident" id="4780935">Syscall</span><span class="op" id="4780942">(</span><span class="op" id="4780943">)</span>&nbsp;<span class="op" id="4780945">*</span><span class="ident" id="4780946">Excep</span>&nbsp;<span class="op" id="4780952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780955">c</span><span class="op" id="4780956">.</span><span class="ident" id="4780957">regs</span><span class="op" id="4780961">[</span><span class="ident" id="4780962">PC</span><span class="op" id="4780964">]</span>&nbsp;<span class="op" id="4780966">=</span>&nbsp;<span class="ident" id="4780968">c</span><span class="op" id="4780969">.</span><span class="ident" id="4780970">interrupt</span><span class="op" id="4780979">.</span><span class="ident" id="4780980">syscallPC</span><span class="op" id="4780989">(</span><span class="op" id="4780990">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780993">c</span><span class="op" id="4780994">.</span><span class="ident" id="4780995">ring</span>&nbsp;<span class="op" id="4781000">=</span>&nbsp;<span class="num" id="4781002">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781005">return</span>&nbsp;<span class="ident" id="4781012">nil</span><br>
<span class="lineno"></span><span class="op" id="4781016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4781019">//&nbsp;Iret&nbsp;restores&nbsp;from&nbsp;an&nbsp;interrupt.</span><br>
<span class="lineno">160</span><span class="comment" id="4781055">//&nbsp;It&nbsp;restores&nbsp;the&nbsp;SP,&nbsp;RET,&nbsp;PC&nbsp;registers,&nbsp;restores&nbsp;the&nbsp;ring&nbsp;level,</span><br>
<span class="lineno"></span><span class="comment" id="4781122">//&nbsp;clears&nbsp;the&nbsp;served&nbsp;interrupt&nbsp;bit&nbsp;and&nbsp;enables&nbsp;interrupt&nbsp;again.</span><br>
<span class="lineno"></span><span class="keyword" id="4781186">func</span>&nbsp;<span class="op" id="4781191">(</span><span class="ident" id="4781192">c</span>&nbsp;<span class="op" id="4781194">*</span><span class="ident" id="4781195">cpu</span><span class="op" id="4781198">)</span>&nbsp;<span class="ident" id="4781200">Iret</span><span class="op" id="4781204">(</span><span class="op" id="4781205">)</span>&nbsp;<span class="op" id="4781207">*</span><span class="ident" id="4781208">Excep</span>&nbsp;<span class="op" id="4781214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781217">if</span>&nbsp;<span class="ident" id="4781220">c</span><span class="op" id="4781221">.</span><span class="ident" id="4781222">ring</span>&nbsp;<span class="op" id="4781227">!=</span>&nbsp;<span class="num" id="4781230">0</span>&nbsp;<span class="op" id="4781232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4781236">panic</span><span class="op" id="4781241">(</span><span class="string" id="4781242">&#34;iret&nbsp;in&nbsp;userland&#34;</span><span class="op" id="4781260">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781267">ksp</span>&nbsp;<span class="op" id="4781271">:=</span>&nbsp;<span class="ident" id="4781274">c</span><span class="op" id="4781275">.</span><span class="ident" id="4781276">interrupt</span><span class="op" id="4781285">.</span><span class="ident" id="4781286">kernelSP</span><span class="op" id="4781294">(</span><span class="op" id="4781295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781298">base</span>&nbsp;<span class="op" id="4781303">:=</span>&nbsp;<span class="ident" id="4781306">ksp</span>&nbsp;<span class="op" id="4781310">-</span>&nbsp;<span class="ident" id="4781312">intFrameSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781326">sp</span><span class="op" id="4781328">,</span>&nbsp;<span class="ident" id="4781330">e</span>&nbsp;<span class="op" id="4781332">:=</span>&nbsp;<span class="ident" id="4781335">c</span><span class="op" id="4781336">.</span><span class="ident" id="4781337">readWord</span><span class="op" id="4781345">(</span><span class="ident" id="4781346">base</span>&nbsp;<span class="op" id="4781351">+</span>&nbsp;<span class="ident" id="4781353">intFrameSP</span><span class="op" id="4781363">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781366">if</span>&nbsp;<span class="ident" id="4781369">e</span>&nbsp;<span class="op" id="4781371">!=</span>&nbsp;<span class="ident" id="4781374">nil</span>&nbsp;<span class="op" id="4781378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781382">return</span>&nbsp;<span class="ident" id="4781389">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781395">ret</span><span class="op" id="4781398">,</span>&nbsp;<span class="ident" id="4781400">e</span>&nbsp;<span class="op" id="4781402">:=</span>&nbsp;<span class="ident" id="4781405">c</span><span class="op" id="4781406">.</span><span class="ident" id="4781407">readWord</span><span class="op" id="4781415">(</span><span class="ident" id="4781416">base</span>&nbsp;<span class="op" id="4781421">+</span>&nbsp;<span class="ident" id="4781423">intFrameRET</span><span class="op" id="4781434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781437">if</span>&nbsp;<span class="ident" id="4781440">e</span>&nbsp;<span class="op" id="4781442">!=</span>&nbsp;<span class="ident" id="4781445">nil</span>&nbsp;<span class="op" id="4781449">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781453">return</span>&nbsp;<span class="ident" id="4781460">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781466">code</span><span class="op" id="4781470">,</span>&nbsp;<span class="ident" id="4781472">e</span>&nbsp;<span class="op" id="4781474">:=</span>&nbsp;<span class="ident" id="4781477">c</span><span class="op" id="4781478">.</span><span class="ident" id="4781479">readByte</span><span class="op" id="4781487">(</span><span class="ident" id="4781488">base</span>&nbsp;<span class="op" id="4781493">+</span>&nbsp;<span class="ident" id="4781495">intFrameCode</span><span class="op" id="4781507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781510">if</span>&nbsp;<span class="ident" id="4781513">e</span>&nbsp;<span class="op" id="4781515">!=</span>&nbsp;<span class="ident" id="4781518">nil</span>&nbsp;<span class="op" id="4781522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781526">return</span>&nbsp;<span class="ident" id="4781533">e</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781539">ring</span><span class="op" id="4781543">,</span>&nbsp;<span class="ident" id="4781545">e</span>&nbsp;<span class="op" id="4781547">:=</span>&nbsp;<span class="ident" id="4781550">c</span><span class="op" id="4781551">.</span><span class="ident" id="4781552">readByte</span><span class="op" id="4781560">(</span><span class="ident" id="4781561">base</span>&nbsp;<span class="op" id="4781566">+</span>&nbsp;<span class="ident" id="4781568">intFrameRing</span><span class="op" id="4781580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781583">if</span>&nbsp;<span class="ident" id="4781586">e</span>&nbsp;<span class="op" id="4781588">!=</span>&nbsp;<span class="ident" id="4781591">nil</span>&nbsp;<span class="op" id="4781595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781599">return</span>&nbsp;<span class="ident" id="4781606">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781609">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781613">c</span><span class="op" id="4781614">.</span><span class="ident" id="4781615">regs</span><span class="op" id="4781619">[</span><span class="ident" id="4781620">PC</span><span class="op" id="4781622">]</span>&nbsp;<span class="op" id="4781624">=</span>&nbsp;<span class="ident" id="4781626">c</span><span class="op" id="4781627">.</span><span class="ident" id="4781628">regs</span><span class="op" id="4781632">[</span><span class="ident" id="4781633">RET</span><span class="op" id="4781636">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781639">c</span><span class="op" id="4781640">.</span><span class="ident" id="4781641">regs</span><span class="op" id="4781645">[</span><span class="ident" id="4781646">RET</span><span class="op" id="4781649">]</span>&nbsp;<span class="op" id="4781651">=</span>&nbsp;<span class="ident" id="4781653">ret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781658">c</span><span class="op" id="4781659">.</span><span class="ident" id="4781660">regs</span><span class="op" id="4781664">[</span><span class="ident" id="4781665">SP</span><span class="op" id="4781667">]</span>&nbsp;<span class="op" id="4781669">=</span>&nbsp;<span class="ident" id="4781671">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781675">c</span><span class="op" id="4781676">.</span><span class="ident" id="4781677">ring</span>&nbsp;<span class="op" id="4781682">=</span>&nbsp;<span class="ident" id="4781684">ring</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781690">c</span><span class="op" id="4781691">.</span><span class="ident" id="4781692">interrupt</span><span class="op" id="4781701">.</span><span class="ident" id="4781702">Clear</span><span class="op" id="4781707">(</span><span class="ident" id="4781708">code</span><span class="op" id="4781712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781715">c</span><span class="op" id="4781716">.</span><span class="ident" id="4781717">interrupt</span><span class="op" id="4781726">.</span><span class="ident" id="4781727">Enable</span><span class="op" id="4781733">(</span><span class="op" id="4781734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781738">return</span>&nbsp;<span class="ident" id="4781745">nil</span><br>
<span class="lineno"></span><span class="op" id="4781749">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="comment" id="4781752">//&nbsp;Tick&nbsp;executes&nbsp;one&nbsp;instruction,&nbsp;and&nbsp;increases&nbsp;the&nbsp;program&nbsp;counter</span><br>
<span class="lineno"></span><span class="comment" id="4781820">//&nbsp;by&nbsp;4&nbsp;by&nbsp;default.&nbsp;If&nbsp;an&nbsp;exception&nbsp;is&nbsp;met,&nbsp;it&nbsp;will&nbsp;handle&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4781883">func</span>&nbsp;<span class="op" id="4781888">(</span><span class="ident" id="4781889">c</span>&nbsp;<span class="op" id="4781891">*</span><span class="ident" id="4781892">cpu</span><span class="op" id="4781895">)</span>&nbsp;<span class="ident" id="4781897">Tick</span><span class="op" id="4781901">(</span><span class="op" id="4781902">)</span>&nbsp;<span class="op" id="4781904">*</span><span class="ident" id="4781905">Excep</span>&nbsp;<span class="op" id="4781911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781914">poll</span><span class="op" id="4781918">,</span>&nbsp;<span class="ident" id="4781920">code</span>&nbsp;<span class="op" id="4781925">:=</span>&nbsp;<span class="ident" id="4781928">c</span><span class="op" id="4781929">.</span><span class="ident" id="4781930">interrupt</span><span class="op" id="4781939">.</span><span class="ident" id="4781940">Poll</span><span class="op" id="4781944">(</span><span class="op" id="4781945">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781948">if</span>&nbsp;<span class="ident" id="4781951">poll</span>&nbsp;<span class="op" id="4781956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781960">return</span>&nbsp;<span class="ident" id="4781967">c</span><span class="op" id="4781968">.</span><span class="ident" id="4781969">Ienter</span><span class="op" id="4781975">(</span><span class="ident" id="4781976">code</span><span class="op" id="4781980">,</span>&nbsp;<span class="num" id="4781982">0</span><span class="op" id="4781983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781990">//&nbsp;no&nbsp;interrupt&nbsp;to&nbsp;dispatch,&nbsp;let&#39;s&nbsp;proceed</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782034">e</span>&nbsp;<span class="op" id="4782036">:=</span>&nbsp;<span class="ident" id="4782039">c</span><span class="op" id="4782040">.</span><span class="ident" id="4782041">tick</span><span class="op" id="4782045">(</span><span class="op" id="4782046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782049">if</span>&nbsp;<span class="ident" id="4782052">e</span>&nbsp;<span class="op" id="4782054">!=</span>&nbsp;<span class="ident" id="4782057">nil</span>&nbsp;<span class="op" id="4782061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4782065">//&nbsp;proceed&nbsp;attempt&nbsp;failed,&nbsp;handle&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782111">c</span><span class="op" id="4782112">.</span><span class="ident" id="4782113">interrupt</span><span class="op" id="4782122">.</span><span class="ident" id="4782123">Issue</span><span class="op" id="4782128">(</span><span class="ident" id="4782129">e</span><span class="op" id="4782130">.</span><span class="ident" id="4782131">Code</span><span class="op" id="4782135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4782139">poll</span><span class="op" id="4782143">,</span>&nbsp;<span class="ident" id="4782145">code</span>&nbsp;<span class="op" id="4782150">:=</span>&nbsp;<span class="ident" id="4782153">c</span><span class="op" id="4782154">.</span><span class="ident" id="4782155">interrupt</span><span class="op" id="4782164">.</span><span class="ident" id="4782165">Poll</span><span class="op" id="4782169">(</span><span class="op" id="4782170">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782174">if</span>&nbsp;<span class="ident" id="4782177">poll</span>&nbsp;<span class="op" id="4782182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782187">if</span>&nbsp;<span class="ident" id="4782190">code</span>&nbsp;<span class="op" id="4782195">!=</span>&nbsp;<span class="ident" id="4782198">e</span><span class="op" id="4782199">.</span><span class="ident" id="4782200">Code</span>&nbsp;<span class="op" id="4782205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4782211">panic</span><span class="op" id="4782216">(</span><span class="string" id="4782217">&#34;interrupt&nbsp;code&nbsp;is&nbsp;different&#34;</span><span class="op" id="4782246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782256">return</span>&nbsp;<span class="ident" id="4782263">c</span><span class="op" id="4782264">.</span><span class="ident" id="4782265">Ienter</span><span class="op" id="4782271">(</span><span class="ident" id="4782272">code</span><span class="op" id="4782276">,</span>&nbsp;<span class="ident" id="4782278">e</span><span class="op" id="4782279">.</span><span class="ident" id="4782280">Arg</span><span class="op" id="4782283">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4782290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4782294">return</span>&nbsp;<span class="ident" id="4782301">e</span><br>
<span class="lineno"></span><span class="op" id="4782303">}</span>
</div>
</body>
</html>
