<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/subtle</h2>
<ul>
<li><a href="/gostd/crypto/subtle/constant_time.go.html">constant_time.go</a></li>
<li><a href="/gostd/crypto/subtle/constant_time_test.go.html">constant_time_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3544991">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3545046">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3545100">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3545151">//&nbsp;Package&nbsp;subtle&nbsp;implements&nbsp;functions&nbsp;that&nbsp;are&nbsp;often&nbsp;useful&nbsp;in&nbsp;cryptographic</span><br>
<span class="lineno"></span><span class="comment" id="3545229">//&nbsp;code&nbsp;but&nbsp;require&nbsp;careful&nbsp;thought&nbsp;to&nbsp;use&nbsp;correctly.</span><br>
<span class="lineno"></span><span class="keyword" id="3545283">package</span>&nbsp;<span class="ident" id="3545291">subtle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3545299">//&nbsp;ConstantTimeCompare&nbsp;returns&nbsp;1&nbsp;iff&nbsp;the&nbsp;two&nbsp;slices,&nbsp;x</span><br>
<span class="lineno">10</span><span class="comment" id="3545354">//&nbsp;and&nbsp;y,&nbsp;have&nbsp;equal&nbsp;contents.&nbsp;The&nbsp;time&nbsp;taken&nbsp;is&nbsp;a&nbsp;function&nbsp;of&nbsp;the&nbsp;length&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3545431">//&nbsp;the&nbsp;slices&nbsp;and&nbsp;is&nbsp;independent&nbsp;of&nbsp;the&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="3545481">func</span>&nbsp;<span class="ident" id="3545486">ConstantTimeCompare</span><span class="op" id="3545505">(</span><span class="ident" id="3545506">x</span><span class="op" id="3545507">,</span>&nbsp;<span class="ident" id="3545509">y</span>&nbsp;<span class="op" id="3545511">[</span><span class="op" id="3545512">]</span><span class="builtintype" id="3545513">byte</span><span class="op" id="3545517">)</span>&nbsp;<span class="builtintype" id="3545519">int</span>&nbsp;<span class="op" id="3545523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545526">if</span>&nbsp;<span class="builtinfunc" id="3545529">len</span><span class="op" id="3545532">(</span><span class="ident" id="3545533">x</span><span class="op" id="3545534">)</span>&nbsp;<span class="op" id="3545536">!=</span>&nbsp;<span class="builtinfunc" id="3545539">len</span><span class="op" id="3545542">(</span><span class="ident" id="3545543">y</span><span class="op" id="3545544">)</span>&nbsp;<span class="op" id="3545546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545550">return</span>&nbsp;<span class="num" id="3545557">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3545560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545564">var</span>&nbsp;<span class="ident" id="3545568">v</span>&nbsp;<span class="builtintype" id="3545570">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545577">for</span>&nbsp;<span class="ident" id="3545581">i</span>&nbsp;<span class="op" id="3545583">:=</span>&nbsp;<span class="num" id="3545586">0</span><span class="op" id="3545587">;</span>&nbsp;<span class="ident" id="3545589">i</span>&nbsp;<span class="op" id="3545591">&lt;</span>&nbsp;<span class="builtinfunc" id="3545593">len</span><span class="op" id="3545596">(</span><span class="ident" id="3545597">x</span><span class="op" id="3545598">)</span><span class="op" id="3545599">;</span>&nbsp;<span class="ident" id="3545601">i</span><span class="op" id="3545602">++</span>&nbsp;<span class="op" id="3545605">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545609">v</span>&nbsp;<span class="op" id="3545611">|=</span>&nbsp;<span class="ident" id="3545614">x</span><span class="op" id="3545615">[</span><span class="ident" id="3545616">i</span><span class="op" id="3545617">]</span>&nbsp;<span class="op" id="3545619">^</span>&nbsp;<span class="ident" id="3545621">y</span><span class="op" id="3545622">[</span><span class="ident" id="3545623">i</span><span class="op" id="3545624">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3545627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545631">return</span>&nbsp;<span class="ident" id="3545638">ConstantTimeByteEq</span><span class="op" id="3545656">(</span><span class="ident" id="3545657">v</span><span class="op" id="3545658">,</span>&nbsp;<span class="num" id="3545660">0</span><span class="op" id="3545661">)</span><br>
<span class="lineno"></span><span class="op" id="3545663">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="3545666">//&nbsp;ConstantTimeSelect&nbsp;returns&nbsp;x&nbsp;if&nbsp;v&nbsp;is&nbsp;1&nbsp;and&nbsp;y&nbsp;if&nbsp;v&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="3545725">//&nbsp;Its&nbsp;behavior&nbsp;is&nbsp;undefined&nbsp;if&nbsp;v&nbsp;takes&nbsp;any&nbsp;other&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3545782">func</span>&nbsp;<span class="ident" id="3545787">ConstantTimeSelect</span><span class="op" id="3545805">(</span><span class="ident" id="3545806">v</span><span class="op" id="3545807">,</span>&nbsp;<span class="ident" id="3545809">x</span><span class="op" id="3545810">,</span>&nbsp;<span class="ident" id="3545812">y</span>&nbsp;<span class="builtintype" id="3545814">int</span><span class="op" id="3545817">)</span>&nbsp;<span class="builtintype" id="3545819">int</span>&nbsp;<span class="op" id="3545823">{</span>&nbsp;<span class="keyword" id="3545825">return</span>&nbsp;<span class="op" id="3545832">^</span><span class="op" id="3545833">(</span><span class="ident" id="3545834">v</span><span class="op" id="3545835">-</span><span class="num" id="3545836">1</span><span class="op" id="3545837">)</span><span class="op" id="3545838">&amp;</span><span class="ident" id="3545839">x</span>&nbsp;<span class="op" id="3545841">|</span>&nbsp;<span class="op" id="3545843">(</span><span class="ident" id="3545844">v</span><span class="op" id="3545845">-</span><span class="num" id="3545846">1</span><span class="op" id="3545847">)</span><span class="op" id="3545848">&amp;</span><span class="ident" id="3545849">y</span>&nbsp;<span class="op" id="3545851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="3545854">//&nbsp;ConstantTimeByteEq&nbsp;returns&nbsp;1&nbsp;if&nbsp;x&nbsp;==&nbsp;y&nbsp;and&nbsp;0&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="3545913">func</span>&nbsp;<span class="ident" id="3545918">ConstantTimeByteEq</span><span class="op" id="3545936">(</span><span class="ident" id="3545937">x</span><span class="op" id="3545938">,</span>&nbsp;<span class="ident" id="3545940">y</span>&nbsp;<span class="builtintype" id="3545942">uint8</span><span class="op" id="3545947">)</span>&nbsp;<span class="builtintype" id="3545949">int</span>&nbsp;<span class="op" id="3545953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545956">z</span>&nbsp;<span class="op" id="3545958">:=</span>&nbsp;<span class="op" id="3545961">^</span><span class="op" id="3545962">(</span><span class="ident" id="3545963">x</span>&nbsp;<span class="op" id="3545965">^</span>&nbsp;<span class="ident" id="3545967">y</span><span class="op" id="3545968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545971">z</span>&nbsp;<span class="op" id="3545973">&amp;=</span>&nbsp;<span class="ident" id="3545976">z</span>&nbsp;<span class="op" id="3545978">&gt;&gt;</span>&nbsp;<span class="num" id="3545981">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545984">z</span>&nbsp;<span class="op" id="3545986">&amp;=</span>&nbsp;<span class="ident" id="3545989">z</span>&nbsp;<span class="op" id="3545991">&gt;&gt;</span>&nbsp;<span class="num" id="3545994">2</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545997">z</span>&nbsp;<span class="op" id="3545999">&amp;=</span>&nbsp;<span class="ident" id="3546002">z</span>&nbsp;<span class="op" id="3546004">&gt;&gt;</span>&nbsp;<span class="num" id="3546007">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546011">return</span>&nbsp;<span class="builtintype" id="3546018">int</span><span class="op" id="3546021">(</span><span class="ident" id="3546022">z</span><span class="op" id="3546023">)</span><br>
<span class="lineno"></span><span class="op" id="3546025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3546028">//&nbsp;ConstantTimeEq&nbsp;returns&nbsp;1&nbsp;if&nbsp;x&nbsp;==&nbsp;y&nbsp;and&nbsp;0&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="3546083">func</span>&nbsp;<span class="ident" id="3546088">ConstantTimeEq</span><span class="op" id="3546102">(</span><span class="ident" id="3546103">x</span><span class="op" id="3546104">,</span>&nbsp;<span class="ident" id="3546106">y</span>&nbsp;<span class="builtintype" id="3546108">int32</span><span class="op" id="3546113">)</span>&nbsp;<span class="builtintype" id="3546115">int</span>&nbsp;<span class="op" id="3546119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546122">z</span>&nbsp;<span class="op" id="3546124">:=</span>&nbsp;<span class="op" id="3546127">^</span><span class="op" id="3546128">(</span><span class="ident" id="3546129">x</span>&nbsp;<span class="op" id="3546131">^</span>&nbsp;<span class="ident" id="3546133">y</span><span class="op" id="3546134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546137">z</span>&nbsp;<span class="op" id="3546139">&amp;=</span>&nbsp;<span class="ident" id="3546142">z</span>&nbsp;<span class="op" id="3546144">&gt;&gt;</span>&nbsp;<span class="num" id="3546147">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546151">z</span>&nbsp;<span class="op" id="3546153">&amp;=</span>&nbsp;<span class="ident" id="3546156">z</span>&nbsp;<span class="op" id="3546158">&gt;&gt;</span>&nbsp;<span class="num" id="3546161">8</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546164">z</span>&nbsp;<span class="op" id="3546166">&amp;=</span>&nbsp;<span class="ident" id="3546169">z</span>&nbsp;<span class="op" id="3546171">&gt;&gt;</span>&nbsp;<span class="num" id="3546174">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546177">z</span>&nbsp;<span class="op" id="3546179">&amp;=</span>&nbsp;<span class="ident" id="3546182">z</span>&nbsp;<span class="op" id="3546184">&gt;&gt;</span>&nbsp;<span class="num" id="3546187">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546190">z</span>&nbsp;<span class="op" id="3546192">&amp;=</span>&nbsp;<span class="ident" id="3546195">z</span>&nbsp;<span class="op" id="3546197">&gt;&gt;</span>&nbsp;<span class="num" id="3546200">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546204">return</span>&nbsp;<span class="builtintype" id="3546211">int</span><span class="op" id="3546214">(</span><span class="ident" id="3546215">z</span>&nbsp;<span class="op" id="3546217">&amp;</span>&nbsp;<span class="num" id="3546219">1</span><span class="op" id="3546220">)</span><br>
<span class="lineno">50</span><span class="op" id="3546222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546225">//&nbsp;ConstantTimeCopy&nbsp;copies&nbsp;the&nbsp;contents&nbsp;of&nbsp;y&nbsp;into&nbsp;x&nbsp;(a&nbsp;slice&nbsp;of&nbsp;equal&nbsp;length)</span><br>
<span class="lineno"></span><span class="comment" id="3546303">//&nbsp;if&nbsp;v&nbsp;==&nbsp;1.&nbsp;If&nbsp;v&nbsp;==&nbsp;0,&nbsp;x&nbsp;is&nbsp;left&nbsp;unchanged.&nbsp;Its&nbsp;behavior&nbsp;is&nbsp;undefined&nbsp;if&nbsp;v</span><br>
<span class="lineno"></span><span class="comment" id="3546380">//&nbsp;takes&nbsp;any&nbsp;other&nbsp;value.</span><br>
<span class="lineno">55</span><span class="keyword" id="3546406">func</span>&nbsp;<span class="ident" id="3546411">ConstantTimeCopy</span><span class="op" id="3546427">(</span><span class="ident" id="3546428">v</span>&nbsp;<span class="builtintype" id="3546430">int</span><span class="op" id="3546433">,</span>&nbsp;<span class="ident" id="3546435">x</span><span class="op" id="3546436">,</span>&nbsp;<span class="ident" id="3546438">y</span>&nbsp;<span class="op" id="3546440">[</span><span class="op" id="3546441">]</span><span class="builtintype" id="3546442">byte</span><span class="op" id="3546446">)</span>&nbsp;<span class="op" id="3546448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546451">if</span>&nbsp;<span class="builtinfunc" id="3546454">len</span><span class="op" id="3546457">(</span><span class="ident" id="3546458">x</span><span class="op" id="3546459">)</span>&nbsp;<span class="op" id="3546461">!=</span>&nbsp;<span class="builtinfunc" id="3546464">len</span><span class="op" id="3546467">(</span><span class="ident" id="3546468">y</span><span class="op" id="3546469">)</span>&nbsp;<span class="op" id="3546471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3546475">panic</span><span class="op" id="3546480">(</span><span class="string" id="3546481">&#34;subtle:&nbsp;slices&nbsp;have&nbsp;different&nbsp;lengths&#34;</span><span class="op" id="3546520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3546523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546527">xmask</span>&nbsp;<span class="op" id="3546533">:=</span>&nbsp;<span class="builtintype" id="3546536">byte</span><span class="op" id="3546540">(</span><span class="ident" id="3546541">v</span>&nbsp;<span class="op" id="3546543">-</span>&nbsp;<span class="num" id="3546545">1</span><span class="op" id="3546546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546549">ymask</span>&nbsp;<span class="op" id="3546555">:=</span>&nbsp;<span class="builtintype" id="3546558">byte</span><span class="op" id="3546562">(</span><span class="op" id="3546563">^</span><span class="op" id="3546564">(</span><span class="ident" id="3546565">v</span>&nbsp;<span class="op" id="3546567">-</span>&nbsp;<span class="num" id="3546569">1</span><span class="op" id="3546570">)</span><span class="op" id="3546571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546574">for</span>&nbsp;<span class="ident" id="3546578">i</span>&nbsp;<span class="op" id="3546580">:=</span>&nbsp;<span class="num" id="3546583">0</span><span class="op" id="3546584">;</span>&nbsp;<span class="ident" id="3546586">i</span>&nbsp;<span class="op" id="3546588">&lt;</span>&nbsp;<span class="builtinfunc" id="3546590">len</span><span class="op" id="3546593">(</span><span class="ident" id="3546594">x</span><span class="op" id="3546595">)</span><span class="op" id="3546596">;</span>&nbsp;<span class="ident" id="3546598">i</span><span class="op" id="3546599">++</span>&nbsp;<span class="op" id="3546602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546606">x</span><span class="op" id="3546607">[</span><span class="ident" id="3546608">i</span><span class="op" id="3546609">]</span>&nbsp;<span class="op" id="3546611">=</span>&nbsp;<span class="ident" id="3546613">x</span><span class="op" id="3546614">[</span><span class="ident" id="3546615">i</span><span class="op" id="3546616">]</span><span class="op" id="3546617">&amp;</span><span class="ident" id="3546618">xmask</span>&nbsp;<span class="op" id="3546624">|</span>&nbsp;<span class="ident" id="3546626">y</span><span class="op" id="3546627">[</span><span class="ident" id="3546628">i</span><span class="op" id="3546629">]</span><span class="op" id="3546630">&amp;</span><span class="ident" id="3546631">ymask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3546638">}</span><br>
<span class="lineno">65</span><span class="op" id="3546640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546643">//&nbsp;ConstantTimeLessOrEq&nbsp;returns&nbsp;1&nbsp;if&nbsp;x&nbsp;&lt;=&nbsp;y&nbsp;and&nbsp;0&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="comment" id="3546704">//&nbsp;Its&nbsp;behavior&nbsp;is&nbsp;undefined&nbsp;if&nbsp;x&nbsp;or&nbsp;y&nbsp;are&nbsp;negative&nbsp;or&nbsp;&gt;&nbsp;2**31&nbsp;-&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3546772">func</span>&nbsp;<span class="ident" id="3546777">ConstantTimeLessOrEq</span><span class="op" id="3546797">(</span><span class="ident" id="3546798">x</span><span class="op" id="3546799">,</span>&nbsp;<span class="ident" id="3546801">y</span>&nbsp;<span class="builtintype" id="3546803">int</span><span class="op" id="3546806">)</span>&nbsp;<span class="builtintype" id="3546808">int</span>&nbsp;<span class="op" id="3546812">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546815">x32</span>&nbsp;<span class="op" id="3546819">:=</span>&nbsp;<span class="builtintype" id="3546822">int32</span><span class="op" id="3546827">(</span><span class="ident" id="3546828">x</span><span class="op" id="3546829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546832">y32</span>&nbsp;<span class="op" id="3546836">:=</span>&nbsp;<span class="builtintype" id="3546839">int32</span><span class="op" id="3546844">(</span><span class="ident" id="3546845">y</span><span class="op" id="3546846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546849">return</span>&nbsp;<span class="builtintype" id="3546856">int</span><span class="op" id="3546859">(</span><span class="op" id="3546860">(</span><span class="op" id="3546861">(</span><span class="ident" id="3546862">x32</span>&nbsp;<span class="op" id="3546866">-</span>&nbsp;<span class="ident" id="3546868">y32</span>&nbsp;<span class="op" id="3546872">-</span>&nbsp;<span class="num" id="3546874">1</span><span class="op" id="3546875">)</span>&nbsp;<span class="op" id="3546877">&gt;&gt;</span>&nbsp;<span class="num" id="3546880">31</span><span class="op" id="3546882">)</span>&nbsp;<span class="op" id="3546884">&amp;</span>&nbsp;<span class="num" id="3546886">1</span><span class="op" id="3546887">)</span><br>
<span class="lineno"></span><span class="op" id="3546889">}</span>
</div>
</body>
</html>
