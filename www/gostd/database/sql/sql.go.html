<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html" class="current">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6206590">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6206645">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6206699">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6206750">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="6206819">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="6206833">//</span><br>
<span class="lineno"></span><span class="comment" id="6206836">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6206907">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="6206968">//</span><br>
<span class="lineno"></span><span class="comment" id="6206971">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6207020">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="6207052">package</span>&nbsp;<span class="ident" id="6207060">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6207065">import</span>&nbsp;<span class="op" id="6207072">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207075">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207098">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207108">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207115">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207121">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207132">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6207140">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6207147">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6207150">var</span>&nbsp;<span class="ident" id="6207154">drivers</span>&nbsp;<span class="op" id="6207162">=</span>&nbsp;<span class="builtinfunc" id="6207164">make</span><span class="op" id="6207168">(</span><span class="keyword" id="6207169">map</span><span class="op" id="6207172">[</span><span class="builtintype" id="6207173">string</span><span class="op" id="6207179">]</span><span class="ident" id="6207180">driver</span><span class="op" id="6207186">.</span><span class="ident" id="6207187">Driver</span><span class="op" id="6207193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6207196">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="6207264">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="6207335">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="6207349">func</span>&nbsp;<span class="ident" id="6207354">Register</span><span class="op" id="6207362">(</span><span class="ident" id="6207363">name</span>&nbsp;<span class="builtintype" id="6207368">string</span><span class="op" id="6207374">,</span>&nbsp;<span class="ident" id="6207376">driver</span>&nbsp;<span class="ident" id="6207383">driver</span><span class="op" id="6207389">.</span><span class="ident" id="6207390">Driver</span><span class="op" id="6207396">)</span>&nbsp;<span class="op" id="6207398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6207401">if</span>&nbsp;<span class="ident" id="6207404">driver</span>&nbsp;<span class="op" id="6207411">==</span>&nbsp;<span class="ident" id="6207414">nil</span>&nbsp;<span class="op" id="6207418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6207422">panic</span><span class="op" id="6207427">(</span><span class="string" id="6207428">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="6207457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6207460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6207463">if</span>&nbsp;<span class="ident" id="6207466">_</span><span class="op" id="6207467">,</span>&nbsp;<span class="ident" id="6207469">dup</span>&nbsp;<span class="op" id="6207473">:=</span>&nbsp;<span class="ident" id="6207476">drivers</span><span class="op" id="6207483">[</span><span class="ident" id="6207484">name</span><span class="op" id="6207488">]</span><span class="op" id="6207489">;</span>&nbsp;<span class="ident" id="6207491">dup</span>&nbsp;<span class="op" id="6207495">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6207499">panic</span><span class="op" id="6207504">(</span><span class="string" id="6207505">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="6207546">+</span>&nbsp;<span class="ident" id="6207548">name</span><span class="op" id="6207552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6207555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6207558">drivers</span><span class="op" id="6207565">[</span><span class="ident" id="6207566">name</span><span class="op" id="6207570">]</span>&nbsp;<span class="op" id="6207572">=</span>&nbsp;<span class="ident" id="6207574">driver</span><br>
<span class="lineno"></span><span class="op" id="6207581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6207584">func</span>&nbsp;<span class="ident" id="6207589">unregisterAllDrivers</span><span class="op" id="6207609">(</span><span class="op" id="6207610">)</span>&nbsp;<span class="op" id="6207612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6207615">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6207630">drivers</span>&nbsp;<span class="op" id="6207638">=</span>&nbsp;<span class="builtinfunc" id="6207640">make</span><span class="op" id="6207644">(</span><span class="keyword" id="6207645">map</span><span class="op" id="6207648">[</span><span class="builtintype" id="6207649">string</span><span class="op" id="6207655">]</span><span class="ident" id="6207656">driver</span><span class="op" id="6207662">.</span><span class="ident" id="6207663">Driver</span><span class="op" id="6207669">)</span><br>
<span class="lineno"></span><span class="op" id="6207671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6207674">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="6207747">func</span>&nbsp;<span class="ident" id="6207752">Drivers</span><span class="op" id="6207759">(</span><span class="op" id="6207760">)</span>&nbsp;<span class="op" id="6207762">[</span><span class="op" id="6207763">]</span><span class="builtintype" id="6207764">string</span>&nbsp;<span class="op" id="6207771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6207774">var</span>&nbsp;<span class="ident" id="6207778">list</span>&nbsp;<span class="op" id="6207783">[</span><span class="op" id="6207784">]</span><span class="builtintype" id="6207785">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6207793">for</span>&nbsp;<span class="ident" id="6207797">name</span>&nbsp;<span class="op" id="6207802">:=</span>&nbsp;<span class="keyword" id="6207805">range</span>&nbsp;<span class="ident" id="6207811">drivers</span>&nbsp;<span class="op" id="6207819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6207823">list</span>&nbsp;<span class="op" id="6207828">=</span>&nbsp;<span class="builtinfunc" id="6207830">append</span><span class="op" id="6207836">(</span><span class="ident" id="6207837">list</span><span class="op" id="6207841">,</span>&nbsp;<span class="ident" id="6207843">name</span><span class="op" id="6207847">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6207850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6207853">sort</span><span class="op" id="6207857">.</span><span class="ident" id="6207858">Strings</span><span class="op" id="6207865">(</span><span class="ident" id="6207866">list</span><span class="op" id="6207870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6207873">return</span>&nbsp;<span class="ident" id="6207880">list</span><br>
<span class="lineno"></span><span class="op" id="6207885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="6207888">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6207958">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="6208030">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6208084">type</span>&nbsp;<span class="ident" id="6208089">RawBytes</span>&nbsp;<span class="op" id="6208098">[</span><span class="op" id="6208099">]</span><span class="builtintype" id="6208100">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6208106">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6208158">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6208208">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="6208249">//</span><br>
<span class="lineno"></span><span class="comment" id="6208252">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="6208273">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="6208344">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6208352">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6208369">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="6208392">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="6208405">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6208426">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6208432">//</span><br>
<span class="lineno"></span><span class="keyword" id="6208435">type</span>&nbsp;<span class="ident" id="6208440">NullString</span>&nbsp;<span class="keyword" id="6208451">struct</span>&nbsp;<span class="op" id="6208458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6208461">String</span>&nbsp;<span class="builtintype" id="6208468">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6208476">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="6208483">bool</span>&nbsp;<span class="comment" id="6208488">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6208527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6208530">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6208572">func</span>&nbsp;<span class="op" id="6208577">(</span><span class="ident" id="6208578">ns</span>&nbsp;<span class="op" id="6208581">*</span><span class="ident" id="6208582">NullString</span><span class="op" id="6208592">)</span>&nbsp;<span class="ident" id="6208594">Scan</span><span class="op" id="6208598">(</span><span class="ident" id="6208599">value</span>&nbsp;<span class="keyword" id="6208605">interface</span><span class="op" id="6208614">{</span><span class="op" id="6208615">}</span><span class="op" id="6208616">)</span>&nbsp;<span class="builtintype" id="6208618">error</span>&nbsp;<span class="op" id="6208624">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6208627">if</span>&nbsp;<span class="ident" id="6208630">value</span>&nbsp;<span class="op" id="6208636">==</span>&nbsp;<span class="ident" id="6208639">nil</span>&nbsp;<span class="op" id="6208643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6208647">ns</span><span class="op" id="6208649">.</span><span class="ident" id="6208650">String</span><span class="op" id="6208656">,</span>&nbsp;<span class="ident" id="6208658">ns</span><span class="op" id="6208660">.</span><span class="ident" id="6208661">Valid</span>&nbsp;<span class="op" id="6208667">=</span>&nbsp;<span class="string" id="6208669">&#34;&#34;</span><span class="op" id="6208671">,</span>&nbsp;<span class="builtintype" id="6208673">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6208681">return</span>&nbsp;<span class="ident" id="6208688">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6208693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6208696">ns</span><span class="op" id="6208698">.</span><span class="ident" id="6208699">Valid</span>&nbsp;<span class="op" id="6208705">=</span>&nbsp;<span class="builtintype" id="6208707">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6208713">return</span>&nbsp;<span class="ident" id="6208720">convertAssign</span><span class="op" id="6208733">(</span><span class="op" id="6208734">&amp;</span><span class="ident" id="6208735">ns</span><span class="op" id="6208737">.</span><span class="ident" id="6208738">String</span><span class="op" id="6208744">,</span>&nbsp;<span class="ident" id="6208746">value</span><span class="op" id="6208751">)</span><br>
<span class="lineno"></span><span class="op" id="6208753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6208756">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6208805">func</span>&nbsp;<span class="op" id="6208810">(</span><span class="ident" id="6208811">ns</span>&nbsp;<span class="ident" id="6208814">NullString</span><span class="op" id="6208824">)</span>&nbsp;<span class="ident" id="6208826">Value</span><span class="op" id="6208831">(</span><span class="op" id="6208832">)</span>&nbsp;<span class="op" id="6208834">(</span><span class="ident" id="6208835">driver</span><span class="op" id="6208841">.</span><span class="ident" id="6208842">Value</span><span class="op" id="6208847">,</span>&nbsp;<span class="builtintype" id="6208849">error</span><span class="op" id="6208854">)</span>&nbsp;<span class="op" id="6208856">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6208859">if</span>&nbsp;<span class="op" id="6208862">!</span><span class="ident" id="6208863">ns</span><span class="op" id="6208865">.</span><span class="ident" id="6208866">Valid</span>&nbsp;<span class="op" id="6208872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6208876">return</span>&nbsp;<span class="ident" id="6208883">nil</span><span class="op" id="6208886">,</span>&nbsp;<span class="ident" id="6208888">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6208893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6208896">return</span>&nbsp;<span class="ident" id="6208903">ns</span><span class="op" id="6208905">.</span><span class="ident" id="6208906">String</span><span class="op" id="6208912">,</span>&nbsp;<span class="ident" id="6208914">nil</span><br>
<span class="lineno"></span><span class="op" id="6208918">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="6208921">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6208972">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6209021">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6209085">type</span>&nbsp;<span class="ident" id="6209090">NullInt64</span>&nbsp;<span class="keyword" id="6209100">struct</span>&nbsp;<span class="op" id="6209107">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209110">Int64</span>&nbsp;<span class="ident" id="6209116">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209123">Valid</span>&nbsp;<span class="builtintype" id="6209129">bool</span>&nbsp;<span class="comment" id="6209134">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6209172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6209175">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="6209217">func</span>&nbsp;<span class="op" id="6209222">(</span><span class="ident" id="6209223">n</span>&nbsp;<span class="op" id="6209225">*</span><span class="ident" id="6209226">NullInt64</span><span class="op" id="6209235">)</span>&nbsp;<span class="ident" id="6209237">Scan</span><span class="op" id="6209241">(</span><span class="ident" id="6209242">value</span>&nbsp;<span class="keyword" id="6209248">interface</span><span class="op" id="6209257">{</span><span class="op" id="6209258">}</span><span class="op" id="6209259">)</span>&nbsp;<span class="builtintype" id="6209261">error</span>&nbsp;<span class="op" id="6209267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209270">if</span>&nbsp;<span class="ident" id="6209273">value</span>&nbsp;<span class="op" id="6209279">==</span>&nbsp;<span class="ident" id="6209282">nil</span>&nbsp;<span class="op" id="6209286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209290">n</span><span class="op" id="6209291">.</span><span class="ident" id="6209292">Int64</span><span class="op" id="6209297">,</span>&nbsp;<span class="ident" id="6209299">n</span><span class="op" id="6209300">.</span><span class="ident" id="6209301">Valid</span>&nbsp;<span class="op" id="6209307">=</span>&nbsp;<span class="num" id="6209309">0</span><span class="op" id="6209310">,</span>&nbsp;<span class="builtintype" id="6209312">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209320">return</span>&nbsp;<span class="ident" id="6209327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6209332">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209335">n</span><span class="op" id="6209336">.</span><span class="ident" id="6209337">Valid</span>&nbsp;<span class="op" id="6209343">=</span>&nbsp;<span class="builtintype" id="6209345">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209351">return</span>&nbsp;<span class="ident" id="6209358">convertAssign</span><span class="op" id="6209371">(</span><span class="op" id="6209372">&amp;</span><span class="ident" id="6209373">n</span><span class="op" id="6209374">.</span><span class="ident" id="6209375">Int64</span><span class="op" id="6209380">,</span>&nbsp;<span class="ident" id="6209382">value</span><span class="op" id="6209387">)</span><br>
<span class="lineno"></span><span class="op" id="6209389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6209392">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="6209441">func</span>&nbsp;<span class="op" id="6209446">(</span><span class="ident" id="6209447">n</span>&nbsp;<span class="ident" id="6209449">NullInt64</span><span class="op" id="6209458">)</span>&nbsp;<span class="ident" id="6209460">Value</span><span class="op" id="6209465">(</span><span class="op" id="6209466">)</span>&nbsp;<span class="op" id="6209468">(</span><span class="ident" id="6209469">driver</span><span class="op" id="6209475">.</span><span class="ident" id="6209476">Value</span><span class="op" id="6209481">,</span>&nbsp;<span class="builtintype" id="6209483">error</span><span class="op" id="6209488">)</span>&nbsp;<span class="op" id="6209490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209493">if</span>&nbsp;<span class="op" id="6209496">!</span><span class="ident" id="6209497">n</span><span class="op" id="6209498">.</span><span class="ident" id="6209499">Valid</span>&nbsp;<span class="op" id="6209505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209509">return</span>&nbsp;<span class="ident" id="6209516">nil</span><span class="op" id="6209519">,</span>&nbsp;<span class="ident" id="6209521">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6209526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209529">return</span>&nbsp;<span class="ident" id="6209536">n</span><span class="op" id="6209537">.</span><span class="ident" id="6209538">Int64</span><span class="op" id="6209543">,</span>&nbsp;<span class="ident" id="6209545">nil</span><br>
<span class="lineno">120</span><span class="op" id="6209549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6209552">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6209606">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6209657">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="6209721">type</span>&nbsp;<span class="ident" id="6209726">NullFloat64</span>&nbsp;<span class="keyword" id="6209738">struct</span>&nbsp;<span class="op" id="6209745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209748">Float64</span>&nbsp;<span class="builtintype" id="6209756">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209765">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6209773">bool</span>&nbsp;<span class="comment" id="6209778">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6209818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6209821">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6209863">func</span>&nbsp;<span class="op" id="6209868">(</span><span class="ident" id="6209869">n</span>&nbsp;<span class="op" id="6209871">*</span><span class="ident" id="6209872">NullFloat64</span><span class="op" id="6209883">)</span>&nbsp;<span class="ident" id="6209885">Scan</span><span class="op" id="6209889">(</span><span class="ident" id="6209890">value</span>&nbsp;<span class="keyword" id="6209896">interface</span><span class="op" id="6209905">{</span><span class="op" id="6209906">}</span><span class="op" id="6209907">)</span>&nbsp;<span class="builtintype" id="6209909">error</span>&nbsp;<span class="op" id="6209915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209918">if</span>&nbsp;<span class="ident" id="6209921">value</span>&nbsp;<span class="op" id="6209927">==</span>&nbsp;<span class="ident" id="6209930">nil</span>&nbsp;<span class="op" id="6209934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209938">n</span><span class="op" id="6209939">.</span><span class="ident" id="6209940">Float64</span><span class="op" id="6209947">,</span>&nbsp;<span class="ident" id="6209949">n</span><span class="op" id="6209950">.</span><span class="ident" id="6209951">Valid</span>&nbsp;<span class="op" id="6209957">=</span>&nbsp;<span class="num" id="6209959">0</span><span class="op" id="6209960">,</span>&nbsp;<span class="builtintype" id="6209962">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6209970">return</span>&nbsp;<span class="ident" id="6209977">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6209982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6209985">n</span><span class="op" id="6209986">.</span><span class="ident" id="6209987">Valid</span>&nbsp;<span class="op" id="6209993">=</span>&nbsp;<span class="builtintype" id="6209995">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210001">return</span>&nbsp;<span class="ident" id="6210008">convertAssign</span><span class="op" id="6210021">(</span><span class="op" id="6210022">&amp;</span><span class="ident" id="6210023">n</span><span class="op" id="6210024">.</span><span class="ident" id="6210025">Float64</span><span class="op" id="6210032">,</span>&nbsp;<span class="ident" id="6210034">value</span><span class="op" id="6210039">)</span><br>
<span class="lineno"></span><span class="op" id="6210041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="6210044">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6210093">func</span>&nbsp;<span class="op" id="6210098">(</span><span class="ident" id="6210099">n</span>&nbsp;<span class="ident" id="6210101">NullFloat64</span><span class="op" id="6210112">)</span>&nbsp;<span class="ident" id="6210114">Value</span><span class="op" id="6210119">(</span><span class="op" id="6210120">)</span>&nbsp;<span class="op" id="6210122">(</span><span class="ident" id="6210123">driver</span><span class="op" id="6210129">.</span><span class="ident" id="6210130">Value</span><span class="op" id="6210135">,</span>&nbsp;<span class="builtintype" id="6210137">error</span><span class="op" id="6210142">)</span>&nbsp;<span class="op" id="6210144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210147">if</span>&nbsp;<span class="op" id="6210150">!</span><span class="ident" id="6210151">n</span><span class="op" id="6210152">.</span><span class="ident" id="6210153">Valid</span>&nbsp;<span class="op" id="6210159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210163">return</span>&nbsp;<span class="ident" id="6210170">nil</span><span class="op" id="6210173">,</span>&nbsp;<span class="ident" id="6210175">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6210180">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210183">return</span>&nbsp;<span class="ident" id="6210190">n</span><span class="op" id="6210191">.</span><span class="ident" id="6210192">Float64</span><span class="op" id="6210199">,</span>&nbsp;<span class="ident" id="6210201">nil</span><br>
<span class="lineno"></span><span class="op" id="6210205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6210208">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6210256">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="6210304">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6210368">type</span>&nbsp;<span class="ident" id="6210373">NullBool</span>&nbsp;<span class="keyword" id="6210382">struct</span>&nbsp;<span class="op" id="6210389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6210392">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="6210398">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6210404">Valid</span>&nbsp;<span class="builtintype" id="6210410">bool</span>&nbsp;<span class="comment" id="6210415">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6210452">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6210455">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6210497">func</span>&nbsp;<span class="op" id="6210502">(</span><span class="ident" id="6210503">n</span>&nbsp;<span class="op" id="6210505">*</span><span class="ident" id="6210506">NullBool</span><span class="op" id="6210514">)</span>&nbsp;<span class="ident" id="6210516">Scan</span><span class="op" id="6210520">(</span><span class="ident" id="6210521">value</span>&nbsp;<span class="keyword" id="6210527">interface</span><span class="op" id="6210536">{</span><span class="op" id="6210537">}</span><span class="op" id="6210538">)</span>&nbsp;<span class="builtintype" id="6210540">error</span>&nbsp;<span class="op" id="6210546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210549">if</span>&nbsp;<span class="ident" id="6210552">value</span>&nbsp;<span class="op" id="6210558">==</span>&nbsp;<span class="ident" id="6210561">nil</span>&nbsp;<span class="op" id="6210565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6210569">n</span><span class="op" id="6210570">.</span><span class="ident" id="6210571">Bool</span><span class="op" id="6210575">,</span>&nbsp;<span class="ident" id="6210577">n</span><span class="op" id="6210578">.</span><span class="ident" id="6210579">Valid</span>&nbsp;<span class="op" id="6210585">=</span>&nbsp;<span class="builtintype" id="6210587">false</span><span class="op" id="6210592">,</span>&nbsp;<span class="builtintype" id="6210594">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210602">return</span>&nbsp;<span class="ident" id="6210609">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6210614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6210617">n</span><span class="op" id="6210618">.</span><span class="ident" id="6210619">Valid</span>&nbsp;<span class="op" id="6210625">=</span>&nbsp;<span class="builtintype" id="6210627">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210633">return</span>&nbsp;<span class="ident" id="6210640">convertAssign</span><span class="op" id="6210653">(</span><span class="op" id="6210654">&amp;</span><span class="ident" id="6210655">n</span><span class="op" id="6210656">.</span><span class="ident" id="6210657">Bool</span><span class="op" id="6210661">,</span>&nbsp;<span class="ident" id="6210663">value</span><span class="op" id="6210668">)</span><br>
<span class="lineno"></span><span class="op" id="6210670">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="6210673">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6210722">func</span>&nbsp;<span class="op" id="6210727">(</span><span class="ident" id="6210728">n</span>&nbsp;<span class="ident" id="6210730">NullBool</span><span class="op" id="6210738">)</span>&nbsp;<span class="ident" id="6210740">Value</span><span class="op" id="6210745">(</span><span class="op" id="6210746">)</span>&nbsp;<span class="op" id="6210748">(</span><span class="ident" id="6210749">driver</span><span class="op" id="6210755">.</span><span class="ident" id="6210756">Value</span><span class="op" id="6210761">,</span>&nbsp;<span class="builtintype" id="6210763">error</span><span class="op" id="6210768">)</span>&nbsp;<span class="op" id="6210770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210773">if</span>&nbsp;<span class="op" id="6210776">!</span><span class="ident" id="6210777">n</span><span class="op" id="6210778">.</span><span class="ident" id="6210779">Valid</span>&nbsp;<span class="op" id="6210785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210789">return</span>&nbsp;<span class="ident" id="6210796">nil</span><span class="op" id="6210799">,</span>&nbsp;<span class="ident" id="6210801">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6210806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6210809">return</span>&nbsp;<span class="ident" id="6210816">n</span><span class="op" id="6210817">.</span><span class="ident" id="6210818">Bool</span><span class="op" id="6210822">,</span>&nbsp;<span class="ident" id="6210824">nil</span><br>
<span class="lineno"></span><span class="op" id="6210828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6210831">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="6210872">type</span>&nbsp;<span class="ident" id="6210877">Scanner</span>&nbsp;<span class="keyword" id="6210885">interface</span>&nbsp;<span class="op" id="6210895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6210898">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6210947">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6210951">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211012">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211030">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211034">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211047">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211062">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211074">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211088">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211102">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211119">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211148">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211152">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6211215">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6211248">Scan</span><span class="op" id="6211252">(</span><span class="ident" id="6211253">src</span>&nbsp;<span class="keyword" id="6211257">interface</span><span class="op" id="6211266">{</span><span class="op" id="6211267">}</span><span class="op" id="6211268">)</span>&nbsp;<span class="builtintype" id="6211270">error</span><br>
<span class="lineno"></span><span class="op" id="6211276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6211279">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="6211343">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="6211414">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="6211449">var</span>&nbsp;<span class="ident" id="6211453">ErrNoRows</span>&nbsp;<span class="op" id="6211463">=</span>&nbsp;<span class="ident" id="6211465">errors</span><span class="op" id="6211471">.</span><span class="ident" id="6211472">New</span><span class="op" id="6211475">(</span><span class="string" id="6211476">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="6211504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6211507">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="6211570">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="6211638">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="6211653">//</span><br>
<span class="lineno"></span><span class="comment" id="6211656">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6211723">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="6211794">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="6211864">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6211927">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6211990">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="6212051">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="6212121">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="6212164">type</span>&nbsp;<span class="ident" id="6212169">DB</span>&nbsp;<span class="keyword" id="6212172">struct</span>&nbsp;<span class="op" id="6212179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212182">driver</span>&nbsp;<span class="ident" id="6212189">driver</span><span class="op" id="6212195">.</span><span class="ident" id="6212196">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212204">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6212211">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212220">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212233">sync</span><span class="op" id="6212237">.</span><span class="ident" id="6212238">Mutex</span>&nbsp;<span class="comment" id="6212244">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212274">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6212287">[</span><span class="op" id="6212288">]</span><span class="op" id="6212289">*</span><span class="ident" id="6212290">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212302">connRequests</span>&nbsp;<span class="op" id="6212315">[</span><span class="op" id="6212316">]</span><span class="keyword" id="6212317">chan</span>&nbsp;<span class="ident" id="6212322">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212335">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6212348">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212353">pendingOpens</span>&nbsp;<span class="builtintype" id="6212366">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212371">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212419">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212485">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212564">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212637">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212660">openerCh</span>&nbsp;<span class="keyword" id="6212669">chan</span>&nbsp;<span class="keyword" id="6212674">struct</span><span class="op" id="6212680">{</span><span class="op" id="6212681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212684">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6212693">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212699">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6212708">map</span><span class="op" id="6212711">[</span><span class="ident" id="6212712">finalCloser</span><span class="op" id="6212723">]</span><span class="ident" id="6212724">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212732">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="6212741">map</span><span class="op" id="6212744">[</span><span class="op" id="6212745">*</span><span class="ident" id="6212746">driverConn</span><span class="op" id="6212756">]</span><span class="builtintype" id="6212757">string</span>&nbsp;<span class="comment" id="6212764">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212810">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="6212819">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212842">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6212895">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="6212904">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6212927">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="6212951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6212954">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6213005">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="6213074">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="6213139">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="6213156">type</span>&nbsp;<span class="ident" id="6213161">driverConn</span>&nbsp;<span class="keyword" id="6213172">struct</span>&nbsp;<span class="op" id="6213179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213182">db</span>&nbsp;<span class="op" id="6213185">*</span><span class="ident" id="6213186">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213191">sync</span><span class="op" id="6213195">.</span><span class="ident" id="6213196">Mutex</span>&nbsp;&nbsp;<span class="comment" id="6213203">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213224">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213236">driver</span><span class="op" id="6213242">.</span><span class="ident" id="6213243">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213249">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6213261">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213267">finalClosed</span>&nbsp;<span class="builtintype" id="6213279">bool</span>&nbsp;<span class="comment" id="6213284">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213313">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6213325">map</span><span class="op" id="6213328">[</span><span class="ident" id="6213329">driver</span><span class="op" id="6213335">.</span><span class="ident" id="6213336">Stmt</span><span class="op" id="6213340">]</span><span class="builtintype" id="6213341">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6213348">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213369">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6213380">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213386">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6213397">[</span><span class="op" id="6213398">]</span><span class="keyword" id="6213399">func</span><span class="op" id="6213403">(</span><span class="op" id="6213404">)</span>&nbsp;<span class="comment" id="6213406">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213464">dbmuClosed</span>&nbsp;<span class="builtintype" id="6213475">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6213484">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="6213540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6213543">func</span>&nbsp;<span class="op" id="6213548">(</span><span class="ident" id="6213549">dc</span>&nbsp;<span class="op" id="6213552">*</span><span class="ident" id="6213553">driverConn</span><span class="op" id="6213563">)</span>&nbsp;<span class="ident" id="6213565">releaseConn</span><span class="op" id="6213576">(</span><span class="ident" id="6213577">err</span>&nbsp;<span class="builtintype" id="6213581">error</span><span class="op" id="6213586">)</span>&nbsp;<span class="op" id="6213588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213591">dc</span><span class="op" id="6213593">.</span><span class="ident" id="6213594">db</span><span class="op" id="6213596">.</span><span class="ident" id="6213597">putConn</span><span class="op" id="6213604">(</span><span class="ident" id="6213605">dc</span><span class="op" id="6213607">,</span>&nbsp;<span class="ident" id="6213609">err</span><span class="op" id="6213612">)</span><br>
<span class="lineno"></span><span class="op" id="6213614">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6213617">func</span>&nbsp;<span class="op" id="6213622">(</span><span class="ident" id="6213623">dc</span>&nbsp;<span class="op" id="6213626">*</span><span class="ident" id="6213627">driverConn</span><span class="op" id="6213637">)</span>&nbsp;<span class="ident" id="6213639">removeOpenStmt</span><span class="op" id="6213653">(</span><span class="ident" id="6213654">si</span>&nbsp;<span class="ident" id="6213657">driver</span><span class="op" id="6213663">.</span><span class="ident" id="6213664">Stmt</span><span class="op" id="6213668">)</span>&nbsp;<span class="op" id="6213670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213673">dc</span><span class="op" id="6213675">.</span><span class="ident" id="6213676">Lock</span><span class="op" id="6213680">(</span><span class="op" id="6213681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6213684">defer</span>&nbsp;<span class="ident" id="6213690">dc</span><span class="op" id="6213692">.</span><span class="ident" id="6213693">Unlock</span><span class="op" id="6213699">(</span><span class="op" id="6213700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6213703">delete</span><span class="op" id="6213709">(</span><span class="ident" id="6213710">dc</span><span class="op" id="6213712">.</span><span class="ident" id="6213713">openStmt</span><span class="op" id="6213721">,</span>&nbsp;<span class="ident" id="6213723">si</span><span class="op" id="6213725">)</span><br>
<span class="lineno">260</span><span class="op" id="6213727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6213730">func</span>&nbsp;<span class="op" id="6213735">(</span><span class="ident" id="6213736">dc</span>&nbsp;<span class="op" id="6213739">*</span><span class="ident" id="6213740">driverConn</span><span class="op" id="6213750">)</span>&nbsp;<span class="ident" id="6213752">prepareLocked</span><span class="op" id="6213765">(</span><span class="ident" id="6213766">query</span>&nbsp;<span class="builtintype" id="6213772">string</span><span class="op" id="6213778">)</span>&nbsp;<span class="op" id="6213780">(</span><span class="ident" id="6213781">driver</span><span class="op" id="6213787">.</span><span class="ident" id="6213788">Stmt</span><span class="op" id="6213792">,</span>&nbsp;<span class="builtintype" id="6213794">error</span><span class="op" id="6213799">)</span>&nbsp;<span class="op" id="6213801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6213804">si</span><span class="op" id="6213806">,</span>&nbsp;<span class="ident" id="6213808">err</span>&nbsp;<span class="op" id="6213812">:=</span>&nbsp;<span class="ident" id="6213815">dc</span><span class="op" id="6213817">.</span><span class="ident" id="6213818">ci</span><span class="op" id="6213820">.</span><span class="ident" id="6213821">Prepare</span><span class="op" id="6213828">(</span><span class="ident" id="6213829">query</span><span class="op" id="6213834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6213837">if</span>&nbsp;<span class="ident" id="6213840">err</span>&nbsp;<span class="op" id="6213844">==</span>&nbsp;<span class="ident" id="6213847">nil</span>&nbsp;<span class="op" id="6213851">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6213855">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6213922">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6213952">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6213957">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214014">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214077">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214134">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214139">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214195">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214244">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214289">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214333">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6214382">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214428">if</span>&nbsp;<span class="ident" id="6214431">dc</span><span class="op" id="6214433">.</span><span class="ident" id="6214434">openStmt</span>&nbsp;<span class="op" id="6214443">==</span>&nbsp;<span class="ident" id="6214446">nil</span>&nbsp;<span class="op" id="6214450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214455">dc</span><span class="op" id="6214457">.</span><span class="ident" id="6214458">openStmt</span>&nbsp;<span class="op" id="6214467">=</span>&nbsp;<span class="builtinfunc" id="6214469">make</span><span class="op" id="6214473">(</span><span class="keyword" id="6214474">map</span><span class="op" id="6214477">[</span><span class="ident" id="6214478">driver</span><span class="op" id="6214484">.</span><span class="ident" id="6214485">Stmt</span><span class="op" id="6214489">]</span><span class="builtintype" id="6214490">bool</span><span class="op" id="6214494">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6214498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214502">dc</span><span class="op" id="6214504">.</span><span class="ident" id="6214505">openStmt</span><span class="op" id="6214513">[</span><span class="ident" id="6214514">si</span><span class="op" id="6214516">]</span>&nbsp;<span class="op" id="6214518">=</span>&nbsp;<span class="builtintype" id="6214520">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6214526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214529">return</span>&nbsp;<span class="ident" id="6214536">si</span><span class="op" id="6214538">,</span>&nbsp;<span class="ident" id="6214540">err</span><br>
<span class="lineno"></span><span class="op" id="6214544">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="6214547">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6214577">func</span>&nbsp;<span class="op" id="6214582">(</span><span class="ident" id="6214583">dc</span>&nbsp;<span class="op" id="6214586">*</span><span class="ident" id="6214587">driverConn</span><span class="op" id="6214597">)</span>&nbsp;<span class="ident" id="6214599">closeDBLocked</span><span class="op" id="6214612">(</span><span class="op" id="6214613">)</span>&nbsp;<span class="keyword" id="6214615">func</span><span class="op" id="6214619">(</span><span class="op" id="6214620">)</span>&nbsp;<span class="builtintype" id="6214622">error</span>&nbsp;<span class="op" id="6214628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214631">dc</span><span class="op" id="6214633">.</span><span class="ident" id="6214634">Lock</span><span class="op" id="6214638">(</span><span class="op" id="6214639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214642">defer</span>&nbsp;<span class="ident" id="6214648">dc</span><span class="op" id="6214650">.</span><span class="ident" id="6214651">Unlock</span><span class="op" id="6214657">(</span><span class="op" id="6214658">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214661">if</span>&nbsp;<span class="ident" id="6214664">dc</span><span class="op" id="6214666">.</span><span class="ident" id="6214667">closed</span>&nbsp;<span class="op" id="6214674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214678">return</span>&nbsp;<span class="keyword" id="6214685">func</span><span class="op" id="6214689">(</span><span class="op" id="6214690">)</span>&nbsp;<span class="builtintype" id="6214692">error</span>&nbsp;<span class="op" id="6214698">{</span>&nbsp;<span class="keyword" id="6214700">return</span>&nbsp;<span class="ident" id="6214707">errors</span><span class="op" id="6214713">.</span><span class="ident" id="6214714">New</span><span class="op" id="6214717">(</span><span class="string" id="6214718">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6214751">)</span>&nbsp;<span class="op" id="6214753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6214756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214759">dc</span><span class="op" id="6214761">.</span><span class="ident" id="6214762">closed</span>&nbsp;<span class="op" id="6214769">=</span>&nbsp;<span class="builtintype" id="6214771">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214777">return</span>&nbsp;<span class="ident" id="6214784">dc</span><span class="op" id="6214786">.</span><span class="ident" id="6214787">db</span><span class="op" id="6214789">.</span><span class="ident" id="6214790">removeDepLocked</span><span class="op" id="6214805">(</span><span class="ident" id="6214806">dc</span><span class="op" id="6214808">,</span>&nbsp;<span class="ident" id="6214810">dc</span><span class="op" id="6214812">)</span><br>
<span class="lineno">295</span><span class="op" id="6214814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6214817">func</span>&nbsp;<span class="op" id="6214822">(</span><span class="ident" id="6214823">dc</span>&nbsp;<span class="op" id="6214826">*</span><span class="ident" id="6214827">driverConn</span><span class="op" id="6214837">)</span>&nbsp;<span class="ident" id="6214839">Close</span><span class="op" id="6214844">(</span><span class="op" id="6214845">)</span>&nbsp;<span class="builtintype" id="6214847">error</span>&nbsp;<span class="op" id="6214853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214856">dc</span><span class="op" id="6214858">.</span><span class="ident" id="6214859">Lock</span><span class="op" id="6214863">(</span><span class="op" id="6214864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214867">if</span>&nbsp;<span class="ident" id="6214870">dc</span><span class="op" id="6214872">.</span><span class="ident" id="6214873">closed</span>&nbsp;<span class="op" id="6214880">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214884">dc</span><span class="op" id="6214886">.</span><span class="ident" id="6214887">Unlock</span><span class="op" id="6214893">(</span><span class="op" id="6214894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6214898">return</span>&nbsp;<span class="ident" id="6214905">errors</span><span class="op" id="6214911">.</span><span class="ident" id="6214912">New</span><span class="op" id="6214915">(</span><span class="string" id="6214916">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6214949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6214952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214955">dc</span><span class="op" id="6214957">.</span><span class="ident" id="6214958">closed</span>&nbsp;<span class="op" id="6214965">=</span>&nbsp;<span class="builtintype" id="6214967">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6214973">dc</span><span class="op" id="6214975">.</span><span class="ident" id="6214976">Unlock</span><span class="op" id="6214982">(</span><span class="op" id="6214983">)</span>&nbsp;<span class="comment" id="6214985">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6215045">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215098">dc</span><span class="op" id="6215100">.</span><span class="ident" id="6215101">db</span><span class="op" id="6215103">.</span><span class="ident" id="6215104">mu</span><span class="op" id="6215106">.</span><span class="ident" id="6215107">Lock</span><span class="op" id="6215111">(</span><span class="op" id="6215112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215115">dc</span><span class="op" id="6215117">.</span><span class="ident" id="6215118">dbmuClosed</span>&nbsp;<span class="op" id="6215129">=</span>&nbsp;<span class="builtintype" id="6215131">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215137">fn</span>&nbsp;<span class="op" id="6215140">:=</span>&nbsp;<span class="ident" id="6215143">dc</span><span class="op" id="6215145">.</span><span class="ident" id="6215146">db</span><span class="op" id="6215148">.</span><span class="ident" id="6215149">removeDepLocked</span><span class="op" id="6215164">(</span><span class="ident" id="6215165">dc</span><span class="op" id="6215167">,</span>&nbsp;<span class="ident" id="6215169">dc</span><span class="op" id="6215171">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215174">dc</span><span class="op" id="6215176">.</span><span class="ident" id="6215177">db</span><span class="op" id="6215179">.</span><span class="ident" id="6215180">mu</span><span class="op" id="6215182">.</span><span class="ident" id="6215183">Unlock</span><span class="op" id="6215189">(</span><span class="op" id="6215190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6215193">return</span>&nbsp;<span class="ident" id="6215200">fn</span><span class="op" id="6215202">(</span><span class="op" id="6215203">)</span><br>
<span class="lineno"></span><span class="op" id="6215205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6215208">func</span>&nbsp;<span class="op" id="6215213">(</span><span class="ident" id="6215214">dc</span>&nbsp;<span class="op" id="6215217">*</span><span class="ident" id="6215218">driverConn</span><span class="op" id="6215228">)</span>&nbsp;<span class="ident" id="6215230">finalClose</span><span class="op" id="6215240">(</span><span class="op" id="6215241">)</span>&nbsp;<span class="builtintype" id="6215243">error</span>&nbsp;<span class="op" id="6215249">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215252">dc</span><span class="op" id="6215254">.</span><span class="ident" id="6215255">Lock</span><span class="op" id="6215259">(</span><span class="op" id="6215260">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6215264">for</span>&nbsp;<span class="ident" id="6215268">si</span>&nbsp;<span class="op" id="6215271">:=</span>&nbsp;<span class="keyword" id="6215274">range</span>&nbsp;<span class="ident" id="6215280">dc</span><span class="op" id="6215282">.</span><span class="ident" id="6215283">openStmt</span>&nbsp;<span class="op" id="6215292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215296">si</span><span class="op" id="6215298">.</span><span class="ident" id="6215299">Close</span><span class="op" id="6215304">(</span><span class="op" id="6215305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6215308">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215311">dc</span><span class="op" id="6215313">.</span><span class="ident" id="6215314">openStmt</span>&nbsp;<span class="op" id="6215323">=</span>&nbsp;<span class="ident" id="6215325">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215331">err</span>&nbsp;<span class="op" id="6215335">:=</span>&nbsp;<span class="ident" id="6215338">dc</span><span class="op" id="6215340">.</span><span class="ident" id="6215341">ci</span><span class="op" id="6215343">.</span><span class="ident" id="6215344">Close</span><span class="op" id="6215349">(</span><span class="op" id="6215350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215353">dc</span><span class="op" id="6215355">.</span><span class="ident" id="6215356">ci</span>&nbsp;<span class="op" id="6215359">=</span>&nbsp;<span class="ident" id="6215361">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215366">dc</span><span class="op" id="6215368">.</span><span class="ident" id="6215369">finalClosed</span>&nbsp;<span class="op" id="6215381">=</span>&nbsp;<span class="builtintype" id="6215383">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215389">dc</span><span class="op" id="6215391">.</span><span class="ident" id="6215392">Unlock</span><span class="op" id="6215398">(</span><span class="op" id="6215399">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215403">dc</span><span class="op" id="6215405">.</span><span class="ident" id="6215406">db</span><span class="op" id="6215408">.</span><span class="ident" id="6215409">mu</span><span class="op" id="6215411">.</span><span class="ident" id="6215412">Lock</span><span class="op" id="6215416">(</span><span class="op" id="6215417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215420">dc</span><span class="op" id="6215422">.</span><span class="ident" id="6215423">db</span><span class="op" id="6215425">.</span><span class="ident" id="6215426">numOpen</span><span class="op" id="6215433">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215437">dc</span><span class="op" id="6215439">.</span><span class="ident" id="6215440">db</span><span class="op" id="6215442">.</span><span class="ident" id="6215443">maybeOpenNewConnections</span><span class="op" id="6215466">(</span><span class="op" id="6215467">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215470">dc</span><span class="op" id="6215472">.</span><span class="ident" id="6215473">db</span><span class="op" id="6215475">.</span><span class="ident" id="6215476">mu</span><span class="op" id="6215478">.</span><span class="ident" id="6215479">Unlock</span><span class="op" id="6215485">(</span><span class="op" id="6215486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6215490">return</span>&nbsp;<span class="ident" id="6215497">err</span><br>
<span class="lineno"></span><span class="op" id="6215501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="6215504">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6215552">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6215619">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="6215641">type</span>&nbsp;<span class="ident" id="6215646">driverStmt</span>&nbsp;<span class="keyword" id="6215657">struct</span>&nbsp;<span class="op" id="6215664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215667">sync</span><span class="op" id="6215671">.</span><span class="ident" id="6215672">Locker</span>&nbsp;<span class="comment" id="6215679">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215699">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215711">driver</span><span class="op" id="6215717">.</span><span class="ident" id="6215718">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6215723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6215726">func</span>&nbsp;<span class="op" id="6215731">(</span><span class="ident" id="6215732">ds</span>&nbsp;<span class="op" id="6215735">*</span><span class="ident" id="6215736">driverStmt</span><span class="op" id="6215746">)</span>&nbsp;<span class="ident" id="6215748">Close</span><span class="op" id="6215753">(</span><span class="op" id="6215754">)</span>&nbsp;<span class="builtintype" id="6215756">error</span>&nbsp;<span class="op" id="6215762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6215765">ds</span><span class="op" id="6215767">.</span><span class="ident" id="6215768">Lock</span><span class="op" id="6215772">(</span><span class="op" id="6215773">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6215776">defer</span>&nbsp;<span class="ident" id="6215782">ds</span><span class="op" id="6215784">.</span><span class="ident" id="6215785">Unlock</span><span class="op" id="6215791">(</span><span class="op" id="6215792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6215795">return</span>&nbsp;<span class="ident" id="6215802">ds</span><span class="op" id="6215804">.</span><span class="ident" id="6215805">si</span><span class="op" id="6215807">.</span><span class="ident" id="6215808">Close</span><span class="op" id="6215813">(</span><span class="op" id="6215814">)</span><br>
<span class="lineno"></span><span class="op" id="6215816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6215819">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="6215873">type</span>&nbsp;<span class="ident" id="6215878">depSet</span>&nbsp;<span class="keyword" id="6215885">map</span><span class="op" id="6215888">[</span><span class="keyword" id="6215889">interface</span><span class="op" id="6215898">{</span><span class="op" id="6215899">}</span><span class="op" id="6215900">]</span><span class="builtintype" id="6215901">bool</span>&nbsp;<span class="comment" id="6215906">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6215928">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="6215993">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="6216027">type</span>&nbsp;<span class="ident" id="6216032">finalCloser</span>&nbsp;<span class="keyword" id="6216044">interface</span>&nbsp;<span class="op" id="6216054">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6216057">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6216120">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216177">finalClose</span><span class="op" id="6216187">(</span><span class="op" id="6216188">)</span>&nbsp;<span class="builtintype" id="6216190">error</span><br>
<span class="lineno"></span><span class="op" id="6216196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="6216199">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6216270">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="6216338">func</span>&nbsp;<span class="op" id="6216343">(</span><span class="ident" id="6216344">db</span>&nbsp;<span class="op" id="6216347">*</span><span class="ident" id="6216348">DB</span><span class="op" id="6216350">)</span>&nbsp;<span class="ident" id="6216352">addDep</span><span class="op" id="6216358">(</span><span class="ident" id="6216359">x</span>&nbsp;<span class="ident" id="6216361">finalCloser</span><span class="op" id="6216372">,</span>&nbsp;<span class="ident" id="6216374">dep</span>&nbsp;<span class="keyword" id="6216378">interface</span><span class="op" id="6216387">{</span><span class="op" id="6216388">}</span><span class="op" id="6216389">)</span>&nbsp;<span class="op" id="6216391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6216394">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216458">db</span><span class="op" id="6216460">.</span><span class="ident" id="6216461">mu</span><span class="op" id="6216463">.</span><span class="ident" id="6216464">Lock</span><span class="op" id="6216468">(</span><span class="op" id="6216469">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6216472">defer</span>&nbsp;<span class="ident" id="6216478">db</span><span class="op" id="6216480">.</span><span class="ident" id="6216481">mu</span><span class="op" id="6216483">.</span><span class="ident" id="6216484">Unlock</span><span class="op" id="6216490">(</span><span class="op" id="6216491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216494">db</span><span class="op" id="6216496">.</span><span class="ident" id="6216497">addDepLocked</span><span class="op" id="6216509">(</span><span class="ident" id="6216510">x</span><span class="op" id="6216511">,</span>&nbsp;<span class="ident" id="6216513">dep</span><span class="op" id="6216516">)</span><br>
<span class="lineno"></span><span class="op" id="6216518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6216521">func</span>&nbsp;<span class="op" id="6216526">(</span><span class="ident" id="6216527">db</span>&nbsp;<span class="op" id="6216530">*</span><span class="ident" id="6216531">DB</span><span class="op" id="6216533">)</span>&nbsp;<span class="ident" id="6216535">addDepLocked</span><span class="op" id="6216547">(</span><span class="ident" id="6216548">x</span>&nbsp;<span class="ident" id="6216550">finalCloser</span><span class="op" id="6216561">,</span>&nbsp;<span class="ident" id="6216563">dep</span>&nbsp;<span class="keyword" id="6216567">interface</span><span class="op" id="6216576">{</span><span class="op" id="6216577">}</span><span class="op" id="6216578">)</span>&nbsp;<span class="op" id="6216580">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6216583">if</span>&nbsp;<span class="ident" id="6216586">db</span><span class="op" id="6216588">.</span><span class="ident" id="6216589">dep</span>&nbsp;<span class="op" id="6216593">==</span>&nbsp;<span class="ident" id="6216596">nil</span>&nbsp;<span class="op" id="6216600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216604">db</span><span class="op" id="6216606">.</span><span class="ident" id="6216607">dep</span>&nbsp;<span class="op" id="6216611">=</span>&nbsp;<span class="builtinfunc" id="6216613">make</span><span class="op" id="6216617">(</span><span class="keyword" id="6216618">map</span><span class="op" id="6216621">[</span><span class="ident" id="6216622">finalCloser</span><span class="op" id="6216633">]</span><span class="ident" id="6216634">depSet</span><span class="op" id="6216640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6216643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216646">xdep</span>&nbsp;<span class="op" id="6216651">:=</span>&nbsp;<span class="ident" id="6216654">db</span><span class="op" id="6216656">.</span><span class="ident" id="6216657">dep</span><span class="op" id="6216660">[</span><span class="ident" id="6216661">x</span><span class="op" id="6216662">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6216665">if</span>&nbsp;<span class="ident" id="6216668">xdep</span>&nbsp;<span class="op" id="6216673">==</span>&nbsp;<span class="ident" id="6216676">nil</span>&nbsp;<span class="op" id="6216680">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216684">xdep</span>&nbsp;<span class="op" id="6216689">=</span>&nbsp;<span class="builtinfunc" id="6216691">make</span><span class="op" id="6216695">(</span><span class="ident" id="6216696">depSet</span><span class="op" id="6216702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216706">db</span><span class="op" id="6216708">.</span><span class="ident" id="6216709">dep</span><span class="op" id="6216712">[</span><span class="ident" id="6216713">x</span><span class="op" id="6216714">]</span>&nbsp;<span class="op" id="6216716">=</span>&nbsp;<span class="ident" id="6216718">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6216724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216727">xdep</span><span class="op" id="6216731">[</span><span class="ident" id="6216732">dep</span><span class="op" id="6216735">]</span>&nbsp;<span class="op" id="6216737">=</span>&nbsp;<span class="builtintype" id="6216739">true</span><br>
<span class="lineno"></span><span class="op" id="6216744">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6216747">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="6216799">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="6216848">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6216918">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="6216966">func</span>&nbsp;<span class="op" id="6216971">(</span><span class="ident" id="6216972">db</span>&nbsp;<span class="op" id="6216975">*</span><span class="ident" id="6216976">DB</span><span class="op" id="6216978">)</span>&nbsp;<span class="ident" id="6216980">removeDep</span><span class="op" id="6216989">(</span><span class="ident" id="6216990">x</span>&nbsp;<span class="ident" id="6216992">finalCloser</span><span class="op" id="6217003">,</span>&nbsp;<span class="ident" id="6217005">dep</span>&nbsp;<span class="keyword" id="6217009">interface</span><span class="op" id="6217018">{</span><span class="op" id="6217019">}</span><span class="op" id="6217020">)</span>&nbsp;<span class="builtintype" id="6217022">error</span>&nbsp;<span class="op" id="6217028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6217031">db</span><span class="op" id="6217033">.</span><span class="ident" id="6217034">mu</span><span class="op" id="6217036">.</span><span class="ident" id="6217037">Lock</span><span class="op" id="6217041">(</span><span class="op" id="6217042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6217045">fn</span>&nbsp;<span class="op" id="6217048">:=</span>&nbsp;<span class="ident" id="6217051">db</span><span class="op" id="6217053">.</span><span class="ident" id="6217054">removeDepLocked</span><span class="op" id="6217069">(</span><span class="ident" id="6217070">x</span><span class="op" id="6217071">,</span>&nbsp;<span class="ident" id="6217073">dep</span><span class="op" id="6217076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6217079">db</span><span class="op" id="6217081">.</span><span class="ident" id="6217082">mu</span><span class="op" id="6217084">.</span><span class="ident" id="6217085">Unlock</span><span class="op" id="6217091">(</span><span class="op" id="6217092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217095">return</span>&nbsp;<span class="ident" id="6217102">fn</span><span class="op" id="6217104">(</span><span class="op" id="6217105">)</span><br>
<span class="lineno">390</span><span class="op" id="6217107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6217110">func</span>&nbsp;<span class="op" id="6217115">(</span><span class="ident" id="6217116">db</span>&nbsp;<span class="op" id="6217119">*</span><span class="ident" id="6217120">DB</span><span class="op" id="6217122">)</span>&nbsp;<span class="ident" id="6217124">removeDepLocked</span><span class="op" id="6217139">(</span><span class="ident" id="6217140">x</span>&nbsp;<span class="ident" id="6217142">finalCloser</span><span class="op" id="6217153">,</span>&nbsp;<span class="ident" id="6217155">dep</span>&nbsp;<span class="keyword" id="6217159">interface</span><span class="op" id="6217168">{</span><span class="op" id="6217169">}</span><span class="op" id="6217170">)</span>&nbsp;<span class="keyword" id="6217172">func</span><span class="op" id="6217176">(</span><span class="op" id="6217177">)</span>&nbsp;<span class="builtintype" id="6217179">error</span>&nbsp;<span class="op" id="6217185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6217188">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6217256">xdep</span><span class="op" id="6217260">,</span>&nbsp;<span class="ident" id="6217262">ok</span>&nbsp;<span class="op" id="6217265">:=</span>&nbsp;<span class="ident" id="6217268">db</span><span class="op" id="6217270">.</span><span class="ident" id="6217271">dep</span><span class="op" id="6217274">[</span><span class="ident" id="6217275">x</span><span class="op" id="6217276">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217279">if</span>&nbsp;<span class="op" id="6217282">!</span><span class="ident" id="6217283">ok</span>&nbsp;<span class="op" id="6217286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6217290">panic</span><span class="op" id="6217295">(</span><span class="ident" id="6217296">fmt</span><span class="op" id="6217299">.</span><span class="ident" id="6217300">Sprintf</span><span class="op" id="6217307">(</span><span class="string" id="6217308">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="6217344">,</span>&nbsp;<span class="ident" id="6217346">x</span><span class="op" id="6217347">)</span><span class="op" id="6217348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6217351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6217355">l0</span>&nbsp;<span class="op" id="6217358">:=</span>&nbsp;<span class="builtinfunc" id="6217361">len</span><span class="op" id="6217364">(</span><span class="ident" id="6217365">xdep</span><span class="op" id="6217369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6217372">delete</span><span class="op" id="6217378">(</span><span class="ident" id="6217379">xdep</span><span class="op" id="6217383">,</span>&nbsp;<span class="ident" id="6217385">dep</span><span class="op" id="6217388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217392">switch</span>&nbsp;<span class="builtinfunc" id="6217399">len</span><span class="op" id="6217402">(</span><span class="ident" id="6217403">xdep</span><span class="op" id="6217407">)</span>&nbsp;<span class="op" id="6217409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217412">case</span>&nbsp;<span class="ident" id="6217417">l0</span><span class="op" id="6217419">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6217423">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6217463">panic</span><span class="op" id="6217468">(</span><span class="ident" id="6217469">fmt</span><span class="op" id="6217472">.</span><span class="ident" id="6217473">Sprintf</span><span class="op" id="6217480">(</span><span class="string" id="6217481">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="6217518">,</span>&nbsp;<span class="ident" id="6217520">dep</span><span class="op" id="6217523">,</span>&nbsp;<span class="ident" id="6217525">x</span><span class="op" id="6217526">)</span><span class="op" id="6217527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217530">case</span>&nbsp;<span class="num" id="6217535">0</span><span class="op" id="6217536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6217540">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6217567">delete</span><span class="op" id="6217573">(</span><span class="ident" id="6217574">db</span><span class="op" id="6217576">.</span><span class="ident" id="6217577">dep</span><span class="op" id="6217580">,</span>&nbsp;<span class="ident" id="6217582">x</span><span class="op" id="6217583">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217587">return</span>&nbsp;<span class="ident" id="6217594">x</span><span class="op" id="6217595">.</span><span class="ident" id="6217596">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217608">default</span><span class="op" id="6217615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6217619">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6217645">return</span>&nbsp;<span class="keyword" id="6217652">func</span><span class="op" id="6217656">(</span><span class="op" id="6217657">)</span>&nbsp;<span class="builtintype" id="6217659">error</span>&nbsp;<span class="op" id="6217665">{</span>&nbsp;<span class="keyword" id="6217667">return</span>&nbsp;<span class="ident" id="6217674">nil</span>&nbsp;<span class="op" id="6217678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6217681">}</span><br>
<span class="lineno">415</span><span class="op" id="6217683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6217686">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="6217758">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6217820">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="6217884">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="6217961">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6218037">var</span>&nbsp;<span class="ident" id="6218041">connectionRequestQueueSize</span>&nbsp;<span class="op" id="6218068">=</span>&nbsp;<span class="num" id="6218070">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6218079">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="6218148">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6218218">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="6218263">//</span><br>
<span class="lineno"></span><span class="comment" id="6218266">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6218334">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="6218406">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6218476">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="6218510">//</span><br>
<span class="lineno"></span><span class="comment" id="6218513">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6218583">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="6218654">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="6218663">//</span><br>
<span class="lineno"></span><span class="comment" id="6218666">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="6218735">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="6218801">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="6218867">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="6218882">func</span>&nbsp;<span class="ident" id="6218887">Open</span><span class="op" id="6218891">(</span><span class="ident" id="6218892">driverName</span><span class="op" id="6218902">,</span>&nbsp;<span class="ident" id="6218904">dataSourceName</span>&nbsp;<span class="builtintype" id="6218919">string</span><span class="op" id="6218925">)</span>&nbsp;<span class="op" id="6218927">(</span><span class="op" id="6218928">*</span><span class="ident" id="6218929">DB</span><span class="op" id="6218931">,</span>&nbsp;<span class="builtintype" id="6218933">error</span><span class="op" id="6218938">)</span>&nbsp;<span class="op" id="6218940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6218943">driveri</span><span class="op" id="6218950">,</span>&nbsp;<span class="ident" id="6218952">ok</span>&nbsp;<span class="op" id="6218955">:=</span>&nbsp;<span class="ident" id="6218958">drivers</span><span class="op" id="6218965">[</span><span class="ident" id="6218966">driverName</span><span class="op" id="6218976">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6218979">if</span>&nbsp;<span class="op" id="6218982">!</span><span class="ident" id="6218983">ok</span>&nbsp;<span class="op" id="6218986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6218990">return</span>&nbsp;<span class="ident" id="6218997">nil</span><span class="op" id="6219000">,</span>&nbsp;<span class="ident" id="6219002">fmt</span><span class="op" id="6219005">.</span><span class="ident" id="6219006">Errorf</span><span class="op" id="6219012">(</span><span class="string" id="6219013">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="6219057">,</span>&nbsp;<span class="ident" id="6219059">driverName</span><span class="op" id="6219069">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6219072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219075">db</span>&nbsp;<span class="op" id="6219078">:=</span>&nbsp;<span class="op" id="6219081">&amp;</span><span class="ident" id="6219082">DB</span><span class="op" id="6219084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219088">driver</span><span class="op" id="6219094">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6219098">driveri</span><span class="op" id="6219105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219109">dsn</span><span class="op" id="6219112">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219119">dataSourceName</span><span class="op" id="6219133">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219137">openerCh</span><span class="op" id="6219145">:</span>&nbsp;<span class="builtinfunc" id="6219147">make</span><span class="op" id="6219151">(</span><span class="keyword" id="6219152">chan</span>&nbsp;<span class="keyword" id="6219157">struct</span><span class="op" id="6219163">{</span><span class="op" id="6219164">}</span><span class="op" id="6219165">,</span>&nbsp;<span class="ident" id="6219167">connectionRequestQueueSize</span><span class="op" id="6219193">)</span><span class="op" id="6219194">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219198">lastPut</span><span class="op" id="6219205">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6219208">make</span><span class="op" id="6219212">(</span><span class="keyword" id="6219213">map</span><span class="op" id="6219216">[</span><span class="op" id="6219217">*</span><span class="ident" id="6219218">driverConn</span><span class="op" id="6219228">]</span><span class="builtintype" id="6219229">string</span><span class="op" id="6219235">)</span><span class="op" id="6219236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6219239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219242">go</span>&nbsp;<span class="ident" id="6219245">db</span><span class="op" id="6219247">.</span><span class="ident" id="6219248">connectionOpener</span><span class="op" id="6219264">(</span><span class="op" id="6219265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219268">return</span>&nbsp;<span class="ident" id="6219275">db</span><span class="op" id="6219277">,</span>&nbsp;<span class="ident" id="6219279">nil</span><br>
<span class="lineno"></span><span class="op" id="6219283">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="6219286">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="6219348">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="6219391">func</span>&nbsp;<span class="op" id="6219396">(</span><span class="ident" id="6219397">db</span>&nbsp;<span class="op" id="6219400">*</span><span class="ident" id="6219401">DB</span><span class="op" id="6219403">)</span>&nbsp;<span class="ident" id="6219405">Ping</span><span class="op" id="6219409">(</span><span class="op" id="6219410">)</span>&nbsp;<span class="builtintype" id="6219412">error</span>&nbsp;<span class="op" id="6219418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6219421">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6219484">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6219543">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219557">dc</span><span class="op" id="6219559">,</span>&nbsp;<span class="ident" id="6219561">err</span>&nbsp;<span class="op" id="6219565">:=</span>&nbsp;<span class="ident" id="6219568">db</span><span class="op" id="6219570">.</span><span class="ident" id="6219571">conn</span><span class="op" id="6219575">(</span><span class="op" id="6219576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219579">if</span>&nbsp;<span class="ident" id="6219582">err</span>&nbsp;<span class="op" id="6219586">!=</span>&nbsp;<span class="ident" id="6219589">nil</span>&nbsp;<span class="op" id="6219593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219597">return</span>&nbsp;<span class="ident" id="6219604">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6219609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219612">db</span><span class="op" id="6219614">.</span><span class="ident" id="6219615">putConn</span><span class="op" id="6219622">(</span><span class="ident" id="6219623">dc</span><span class="op" id="6219625">,</span>&nbsp;<span class="ident" id="6219627">nil</span><span class="op" id="6219630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219633">return</span>&nbsp;<span class="ident" id="6219640">nil</span><br>
<span class="lineno"></span><span class="op" id="6219644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="6219647">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="6219707">//</span><br>
<span class="lineno"></span><span class="comment" id="6219710">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6219771">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6219821">func</span>&nbsp;<span class="op" id="6219826">(</span><span class="ident" id="6219827">db</span>&nbsp;<span class="op" id="6219830">*</span><span class="ident" id="6219831">DB</span><span class="op" id="6219833">)</span>&nbsp;<span class="ident" id="6219835">Close</span><span class="op" id="6219840">(</span><span class="op" id="6219841">)</span>&nbsp;<span class="builtintype" id="6219843">error</span>&nbsp;<span class="op" id="6219849">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219852">db</span><span class="op" id="6219854">.</span><span class="ident" id="6219855">mu</span><span class="op" id="6219857">.</span><span class="ident" id="6219858">Lock</span><span class="op" id="6219862">(</span><span class="op" id="6219863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219866">if</span>&nbsp;<span class="ident" id="6219869">db</span><span class="op" id="6219871">.</span><span class="ident" id="6219872">closed</span>&nbsp;<span class="op" id="6219879">{</span>&nbsp;<span class="comment" id="6219881">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219911">db</span><span class="op" id="6219913">.</span><span class="ident" id="6219914">mu</span><span class="op" id="6219916">.</span><span class="ident" id="6219917">Unlock</span><span class="op" id="6219923">(</span><span class="op" id="6219924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219928">return</span>&nbsp;<span class="ident" id="6219935">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6219940">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6219943">close</span><span class="op" id="6219948">(</span><span class="ident" id="6219949">db</span><span class="op" id="6219951">.</span><span class="ident" id="6219952">openerCh</span><span class="op" id="6219960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6219963">var</span>&nbsp;<span class="ident" id="6219967">err</span>&nbsp;<span class="builtintype" id="6219971">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6219978">fns</span>&nbsp;<span class="op" id="6219982">:=</span>&nbsp;<span class="builtinfunc" id="6219985">make</span><span class="op" id="6219989">(</span><span class="op" id="6219990">[</span><span class="op" id="6219991">]</span><span class="keyword" id="6219992">func</span><span class="op" id="6219996">(</span><span class="op" id="6219997">)</span>&nbsp;<span class="builtintype" id="6219999">error</span><span class="op" id="6220004">,</span>&nbsp;<span class="num" id="6220006">0</span><span class="op" id="6220007">,</span>&nbsp;<span class="builtinfunc" id="6220009">len</span><span class="op" id="6220012">(</span><span class="ident" id="6220013">db</span><span class="op" id="6220015">.</span><span class="ident" id="6220016">freeConn</span><span class="op" id="6220024">)</span><span class="op" id="6220025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220028">for</span>&nbsp;<span class="ident" id="6220032">_</span><span class="op" id="6220033">,</span>&nbsp;<span class="ident" id="6220035">dc</span>&nbsp;<span class="op" id="6220038">:=</span>&nbsp;<span class="keyword" id="6220041">range</span>&nbsp;<span class="ident" id="6220047">db</span><span class="op" id="6220049">.</span><span class="ident" id="6220050">freeConn</span>&nbsp;<span class="op" id="6220059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220063">fns</span>&nbsp;<span class="op" id="6220067">=</span>&nbsp;<span class="builtinfunc" id="6220069">append</span><span class="op" id="6220075">(</span><span class="ident" id="6220076">fns</span><span class="op" id="6220079">,</span>&nbsp;<span class="ident" id="6220081">dc</span><span class="op" id="6220083">.</span><span class="ident" id="6220084">closeDBLocked</span><span class="op" id="6220097">(</span><span class="op" id="6220098">)</span><span class="op" id="6220099">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6220102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220105">db</span><span class="op" id="6220107">.</span><span class="ident" id="6220108">freeConn</span>&nbsp;<span class="op" id="6220117">=</span>&nbsp;<span class="ident" id="6220119">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220124">db</span><span class="op" id="6220126">.</span><span class="ident" id="6220127">closed</span>&nbsp;<span class="op" id="6220134">=</span>&nbsp;<span class="builtintype" id="6220136">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220142">for</span>&nbsp;<span class="ident" id="6220146">_</span><span class="op" id="6220147">,</span>&nbsp;<span class="ident" id="6220149">req</span>&nbsp;<span class="op" id="6220153">:=</span>&nbsp;<span class="keyword" id="6220156">range</span>&nbsp;<span class="ident" id="6220162">db</span><span class="op" id="6220164">.</span><span class="ident" id="6220165">connRequests</span>&nbsp;<span class="op" id="6220178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6220182">close</span><span class="op" id="6220187">(</span><span class="ident" id="6220188">req</span><span class="op" id="6220191">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6220194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220197">db</span><span class="op" id="6220199">.</span><span class="ident" id="6220200">mu</span><span class="op" id="6220202">.</span><span class="ident" id="6220203">Unlock</span><span class="op" id="6220209">(</span><span class="op" id="6220210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220213">for</span>&nbsp;<span class="ident" id="6220217">_</span><span class="op" id="6220218">,</span>&nbsp;<span class="ident" id="6220220">fn</span>&nbsp;<span class="op" id="6220223">:=</span>&nbsp;<span class="keyword" id="6220226">range</span>&nbsp;<span class="ident" id="6220232">fns</span>&nbsp;<span class="op" id="6220236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220240">err1</span>&nbsp;<span class="op" id="6220245">:=</span>&nbsp;<span class="ident" id="6220248">fn</span><span class="op" id="6220250">(</span><span class="op" id="6220251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220255">if</span>&nbsp;<span class="ident" id="6220258">err1</span>&nbsp;<span class="op" id="6220263">!=</span>&nbsp;<span class="ident" id="6220266">nil</span>&nbsp;<span class="op" id="6220270">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220275">err</span>&nbsp;<span class="op" id="6220279">=</span>&nbsp;<span class="ident" id="6220281">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6220288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6220291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220294">return</span>&nbsp;<span class="ident" id="6220301">err</span><br>
<span class="lineno"></span><span class="op" id="6220305">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6220308">const</span>&nbsp;<span class="ident" id="6220314">defaultMaxIdleConns</span>&nbsp;<span class="op" id="6220334">=</span>&nbsp;<span class="num" id="6220336">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6220339">func</span>&nbsp;<span class="op" id="6220344">(</span><span class="ident" id="6220345">db</span>&nbsp;<span class="op" id="6220348">*</span><span class="ident" id="6220349">DB</span><span class="op" id="6220351">)</span>&nbsp;<span class="ident" id="6220353">maxIdleConnsLocked</span><span class="op" id="6220371">(</span><span class="op" id="6220372">)</span>&nbsp;<span class="builtintype" id="6220374">int</span>&nbsp;<span class="op" id="6220378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220381">n</span>&nbsp;<span class="op" id="6220383">:=</span>&nbsp;<span class="ident" id="6220386">db</span><span class="op" id="6220388">.</span><span class="ident" id="6220389">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220398">switch</span>&nbsp;<span class="op" id="6220405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220408">case</span>&nbsp;<span class="ident" id="6220413">n</span>&nbsp;<span class="op" id="6220415">==</span>&nbsp;<span class="num" id="6220418">0</span><span class="op" id="6220419">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6220423">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220497">return</span>&nbsp;<span class="ident" id="6220504">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220525">case</span>&nbsp;<span class="ident" id="6220530">n</span>&nbsp;<span class="op" id="6220532">&lt;</span>&nbsp;<span class="num" id="6220534">0</span><span class="op" id="6220535">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220539">return</span>&nbsp;<span class="num" id="6220546">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220549">default</span><span class="op" id="6220556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220560">return</span>&nbsp;<span class="ident" id="6220567">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6220570">}</span><br>
<span class="lineno"></span><span class="op" id="6220572">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="6220575">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6220645">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="6220665">//</span><br>
<span class="lineno"></span><span class="comment" id="6220668">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="6220740">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6220817">//</span><br>
<span class="lineno"></span><span class="comment" id="6220820">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="6220868">func</span>&nbsp;<span class="op" id="6220873">(</span><span class="ident" id="6220874">db</span>&nbsp;<span class="op" id="6220877">*</span><span class="ident" id="6220878">DB</span><span class="op" id="6220880">)</span>&nbsp;<span class="ident" id="6220882">SetMaxIdleConns</span><span class="op" id="6220897">(</span><span class="ident" id="6220898">n</span>&nbsp;<span class="builtintype" id="6220900">int</span><span class="op" id="6220903">)</span>&nbsp;<span class="op" id="6220905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220908">db</span><span class="op" id="6220910">.</span><span class="ident" id="6220911">mu</span><span class="op" id="6220913">.</span><span class="ident" id="6220914">Lock</span><span class="op" id="6220918">(</span><span class="op" id="6220919">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6220922">if</span>&nbsp;<span class="ident" id="6220925">n</span>&nbsp;<span class="op" id="6220927">&gt;</span>&nbsp;<span class="num" id="6220929">0</span>&nbsp;<span class="op" id="6220931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220935">db</span><span class="op" id="6220937">.</span><span class="ident" id="6220938">maxIdle</span>&nbsp;<span class="op" id="6220946">=</span>&nbsp;<span class="ident" id="6220948">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6220951">}</span>&nbsp;<span class="keyword" id="6220953">else</span>&nbsp;<span class="op" id="6220958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6220962">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6220988">db</span><span class="op" id="6220990">.</span><span class="ident" id="6220991">maxIdle</span>&nbsp;<span class="op" id="6220999">=</span>&nbsp;<span class="op" id="6221001">-</span><span class="num" id="6221002">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221008">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6221053">if</span>&nbsp;<span class="ident" id="6221056">db</span><span class="op" id="6221058">.</span><span class="ident" id="6221059">maxOpen</span>&nbsp;<span class="op" id="6221067">&gt;</span>&nbsp;<span class="num" id="6221069">0</span>&nbsp;<span class="op" id="6221071">&amp;&amp;</span>&nbsp;<span class="ident" id="6221074">db</span><span class="op" id="6221076">.</span><span class="ident" id="6221077">maxIdleConnsLocked</span><span class="op" id="6221095">(</span><span class="op" id="6221096">)</span>&nbsp;<span class="op" id="6221098">&gt;</span>&nbsp;<span class="ident" id="6221100">db</span><span class="op" id="6221102">.</span><span class="ident" id="6221103">maxOpen</span>&nbsp;<span class="op" id="6221111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221115">db</span><span class="op" id="6221117">.</span><span class="ident" id="6221118">maxIdle</span>&nbsp;<span class="op" id="6221126">=</span>&nbsp;<span class="ident" id="6221128">db</span><span class="op" id="6221130">.</span><span class="ident" id="6221131">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221140">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6221143">var</span>&nbsp;<span class="ident" id="6221147">closing</span>&nbsp;<span class="op" id="6221155">[</span><span class="op" id="6221156">]</span><span class="op" id="6221157">*</span><span class="ident" id="6221158">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221170">idleCount</span>&nbsp;<span class="op" id="6221180">:=</span>&nbsp;<span class="builtinfunc" id="6221183">len</span><span class="op" id="6221186">(</span><span class="ident" id="6221187">db</span><span class="op" id="6221189">.</span><span class="ident" id="6221190">freeConn</span><span class="op" id="6221198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221201">maxIdle</span>&nbsp;<span class="op" id="6221209">:=</span>&nbsp;<span class="ident" id="6221212">db</span><span class="op" id="6221214">.</span><span class="ident" id="6221215">maxIdleConnsLocked</span><span class="op" id="6221233">(</span><span class="op" id="6221234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6221237">if</span>&nbsp;<span class="ident" id="6221240">idleCount</span>&nbsp;<span class="op" id="6221250">&gt;</span>&nbsp;<span class="ident" id="6221252">maxIdle</span>&nbsp;<span class="op" id="6221260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221264">closing</span>&nbsp;<span class="op" id="6221272">=</span>&nbsp;<span class="ident" id="6221274">db</span><span class="op" id="6221276">.</span><span class="ident" id="6221277">freeConn</span><span class="op" id="6221285">[</span><span class="ident" id="6221286">maxIdle</span><span class="op" id="6221293">:</span><span class="op" id="6221294">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221298">db</span><span class="op" id="6221300">.</span><span class="ident" id="6221301">freeConn</span>&nbsp;<span class="op" id="6221310">=</span>&nbsp;<span class="ident" id="6221312">db</span><span class="op" id="6221314">.</span><span class="ident" id="6221315">freeConn</span><span class="op" id="6221323">[</span><span class="op" id="6221324">:</span><span class="ident" id="6221325">maxIdle</span><span class="op" id="6221332">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221338">db</span><span class="op" id="6221340">.</span><span class="ident" id="6221341">mu</span><span class="op" id="6221343">.</span><span class="ident" id="6221344">Unlock</span><span class="op" id="6221350">(</span><span class="op" id="6221351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6221354">for</span>&nbsp;<span class="ident" id="6221358">_</span><span class="op" id="6221359">,</span>&nbsp;<span class="ident" id="6221361">c</span>&nbsp;<span class="op" id="6221363">:=</span>&nbsp;<span class="keyword" id="6221366">range</span>&nbsp;<span class="ident" id="6221372">closing</span>&nbsp;<span class="op" id="6221380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221384">c</span><span class="op" id="6221385">.</span><span class="ident" id="6221386">Close</span><span class="op" id="6221391">(</span><span class="op" id="6221392">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221395">}</span><br>
<span class="lineno"></span><span class="op" id="6221397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6221400">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="6221480">//</span><br>
<span class="lineno">550</span><span class="comment" id="6221483">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="6221558">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6221626">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6221648">//</span><br>
<span class="lineno"></span><span class="comment" id="6221651">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="6221723">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="6221756">func</span>&nbsp;<span class="op" id="6221761">(</span><span class="ident" id="6221762">db</span>&nbsp;<span class="op" id="6221765">*</span><span class="ident" id="6221766">DB</span><span class="op" id="6221768">)</span>&nbsp;<span class="ident" id="6221770">SetMaxOpenConns</span><span class="op" id="6221785">(</span><span class="ident" id="6221786">n</span>&nbsp;<span class="builtintype" id="6221788">int</span><span class="op" id="6221791">)</span>&nbsp;<span class="op" id="6221793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221796">db</span><span class="op" id="6221798">.</span><span class="ident" id="6221799">mu</span><span class="op" id="6221801">.</span><span class="ident" id="6221802">Lock</span><span class="op" id="6221806">(</span><span class="op" id="6221807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221810">db</span><span class="op" id="6221812">.</span><span class="ident" id="6221813">maxOpen</span>&nbsp;<span class="op" id="6221821">=</span>&nbsp;<span class="ident" id="6221823">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6221826">if</span>&nbsp;<span class="ident" id="6221829">n</span>&nbsp;<span class="op" id="6221831">&lt;</span>&nbsp;<span class="num" id="6221833">0</span>&nbsp;<span class="op" id="6221835">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221839">db</span><span class="op" id="6221841">.</span><span class="ident" id="6221842">maxOpen</span>&nbsp;<span class="op" id="6221850">=</span>&nbsp;<span class="num" id="6221852">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221858">syncMaxIdle</span>&nbsp;<span class="op" id="6221870">:=</span>&nbsp;<span class="ident" id="6221873">db</span><span class="op" id="6221875">.</span><span class="ident" id="6221876">maxOpen</span>&nbsp;<span class="op" id="6221884">&gt;</span>&nbsp;<span class="num" id="6221886">0</span>&nbsp;<span class="op" id="6221888">&amp;&amp;</span>&nbsp;<span class="ident" id="6221891">db</span><span class="op" id="6221893">.</span><span class="ident" id="6221894">maxIdleConnsLocked</span><span class="op" id="6221912">(</span><span class="op" id="6221913">)</span>&nbsp;<span class="op" id="6221915">&gt;</span>&nbsp;<span class="ident" id="6221917">db</span><span class="op" id="6221919">.</span><span class="ident" id="6221920">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221929">db</span><span class="op" id="6221931">.</span><span class="ident" id="6221932">mu</span><span class="op" id="6221934">.</span><span class="ident" id="6221935">Unlock</span><span class="op" id="6221941">(</span><span class="op" id="6221942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6221945">if</span>&nbsp;<span class="ident" id="6221948">syncMaxIdle</span>&nbsp;<span class="op" id="6221960">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221964">db</span><span class="op" id="6221966">.</span><span class="ident" id="6221967">SetMaxIdleConns</span><span class="op" id="6221982">(</span><span class="ident" id="6221983">n</span><span class="op" id="6221984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221987">}</span><br>
<span class="lineno"></span><span class="op" id="6221989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6221992">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="6222020">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="6222095">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="6222154">func</span>&nbsp;<span class="op" id="6222159">(</span><span class="ident" id="6222160">db</span>&nbsp;<span class="op" id="6222163">*</span><span class="ident" id="6222164">DB</span><span class="op" id="6222166">)</span>&nbsp;<span class="ident" id="6222168">maybeOpenNewConnections</span><span class="op" id="6222191">(</span><span class="op" id="6222192">)</span>&nbsp;<span class="op" id="6222194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222197">numRequests</span>&nbsp;<span class="op" id="6222209">:=</span>&nbsp;<span class="builtinfunc" id="6222212">len</span><span class="op" id="6222215">(</span><span class="ident" id="6222216">db</span><span class="op" id="6222218">.</span><span class="ident" id="6222219">connRequests</span><span class="op" id="6222231">)</span>&nbsp;<span class="op" id="6222233">-</span>&nbsp;<span class="ident" id="6222235">db</span><span class="op" id="6222237">.</span><span class="ident" id="6222238">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222252">if</span>&nbsp;<span class="ident" id="6222255">db</span><span class="op" id="6222257">.</span><span class="ident" id="6222258">maxOpen</span>&nbsp;<span class="op" id="6222266">&gt;</span>&nbsp;<span class="num" id="6222268">0</span>&nbsp;<span class="op" id="6222270">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222274">numCanOpen</span>&nbsp;<span class="op" id="6222285">:=</span>&nbsp;<span class="ident" id="6222288">db</span><span class="op" id="6222290">.</span><span class="ident" id="6222291">maxOpen</span>&nbsp;<span class="op" id="6222299">-</span>&nbsp;<span class="op" id="6222301">(</span><span class="ident" id="6222302">db</span><span class="op" id="6222304">.</span><span class="ident" id="6222305">numOpen</span>&nbsp;<span class="op" id="6222313">+</span>&nbsp;<span class="ident" id="6222315">db</span><span class="op" id="6222317">.</span><span class="ident" id="6222318">pendingOpens</span><span class="op" id="6222330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222334">if</span>&nbsp;<span class="ident" id="6222337">numRequests</span>&nbsp;<span class="op" id="6222349">&gt;</span>&nbsp;<span class="ident" id="6222351">numCanOpen</span>&nbsp;<span class="op" id="6222362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222367">numRequests</span>&nbsp;<span class="op" id="6222379">=</span>&nbsp;<span class="ident" id="6222381">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222397">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222400">for</span>&nbsp;<span class="ident" id="6222404">numRequests</span>&nbsp;<span class="op" id="6222416">&gt;</span>&nbsp;<span class="num" id="6222418">0</span>&nbsp;<span class="op" id="6222420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222424">db</span><span class="op" id="6222426">.</span><span class="ident" id="6222427">pendingOpens</span><span class="op" id="6222439">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222444">numRequests</span><span class="op" id="6222455">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222460">db</span><span class="op" id="6222462">.</span><span class="ident" id="6222463">openerCh</span>&nbsp;<span class="op" id="6222472">&lt;-</span>&nbsp;<span class="keyword" id="6222475">struct</span><span class="op" id="6222481">{</span><span class="op" id="6222482">}</span><span class="op" id="6222483">{</span><span class="op" id="6222484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222487">}</span><br>
<span class="lineno">585</span><span class="op" id="6222489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6222492">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="6222563">func</span>&nbsp;<span class="op" id="6222568">(</span><span class="ident" id="6222569">db</span>&nbsp;<span class="op" id="6222572">*</span><span class="ident" id="6222573">DB</span><span class="op" id="6222575">)</span>&nbsp;<span class="ident" id="6222577">connectionOpener</span><span class="op" id="6222593">(</span><span class="op" id="6222594">)</span>&nbsp;<span class="op" id="6222596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222599">for</span>&nbsp;<span class="keyword" id="6222603">range</span>&nbsp;<span class="ident" id="6222609">db</span><span class="op" id="6222611">.</span><span class="ident" id="6222612">openerCh</span>&nbsp;<span class="op" id="6222621">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222625">db</span><span class="op" id="6222627">.</span><span class="ident" id="6222628">openNewConnection</span><span class="op" id="6222645">(</span><span class="op" id="6222646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222649">}</span><br>
<span class="lineno"></span><span class="op" id="6222651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6222654">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="6222681">func</span>&nbsp;<span class="op" id="6222686">(</span><span class="ident" id="6222687">db</span>&nbsp;<span class="op" id="6222690">*</span><span class="ident" id="6222691">DB</span><span class="op" id="6222693">)</span>&nbsp;<span class="ident" id="6222695">openNewConnection</span><span class="op" id="6222712">(</span><span class="op" id="6222713">)</span>&nbsp;<span class="op" id="6222715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222718">ci</span><span class="op" id="6222720">,</span>&nbsp;<span class="ident" id="6222722">err</span>&nbsp;<span class="op" id="6222726">:=</span>&nbsp;<span class="ident" id="6222729">db</span><span class="op" id="6222731">.</span><span class="ident" id="6222732">driver</span><span class="op" id="6222738">.</span><span class="ident" id="6222739">Open</span><span class="op" id="6222743">(</span><span class="ident" id="6222744">db</span><span class="op" id="6222746">.</span><span class="ident" id="6222747">dsn</span><span class="op" id="6222750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222753">db</span><span class="op" id="6222755">.</span><span class="ident" id="6222756">mu</span><span class="op" id="6222758">.</span><span class="ident" id="6222759">Lock</span><span class="op" id="6222763">(</span><span class="op" id="6222764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222767">defer</span>&nbsp;<span class="ident" id="6222773">db</span><span class="op" id="6222775">.</span><span class="ident" id="6222776">mu</span><span class="op" id="6222778">.</span><span class="ident" id="6222779">Unlock</span><span class="op" id="6222785">(</span><span class="op" id="6222786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222789">if</span>&nbsp;<span class="ident" id="6222792">db</span><span class="op" id="6222794">.</span><span class="ident" id="6222795">closed</span>&nbsp;<span class="op" id="6222802">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222806">if</span>&nbsp;<span class="ident" id="6222809">err</span>&nbsp;<span class="op" id="6222813">==</span>&nbsp;<span class="ident" id="6222816">nil</span>&nbsp;<span class="op" id="6222820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222825">ci</span><span class="op" id="6222827">.</span><span class="ident" id="6222828">Close</span><span class="op" id="6222833">(</span><span class="op" id="6222834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222842">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222850">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222853">db</span><span class="op" id="6222855">.</span><span class="ident" id="6222856">pendingOpens</span><span class="op" id="6222868">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222872">if</span>&nbsp;<span class="ident" id="6222875">err</span>&nbsp;<span class="op" id="6222879">!=</span>&nbsp;<span class="ident" id="6222882">nil</span>&nbsp;<span class="op" id="6222886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222890">db</span><span class="op" id="6222892">.</span><span class="ident" id="6222893">putConnDBLocked</span><span class="op" id="6222908">(</span><span class="ident" id="6222909">nil</span><span class="op" id="6222912">,</span>&nbsp;<span class="ident" id="6222914">err</span><span class="op" id="6222917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222921">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222929">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222932">dc</span>&nbsp;<span class="op" id="6222935">:=</span>&nbsp;<span class="op" id="6222938">&amp;</span><span class="ident" id="6222939">driverConn</span><span class="op" id="6222949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222953">db</span><span class="op" id="6222955">:</span>&nbsp;<span class="ident" id="6222957">db</span><span class="op" id="6222959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6222963">ci</span><span class="op" id="6222965">:</span>&nbsp;<span class="ident" id="6222967">ci</span><span class="op" id="6222969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6222972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6222975">if</span>&nbsp;<span class="ident" id="6222978">db</span><span class="op" id="6222980">.</span><span class="ident" id="6222981">putConnDBLocked</span><span class="op" id="6222996">(</span><span class="ident" id="6222997">dc</span><span class="op" id="6222999">,</span>&nbsp;<span class="ident" id="6223001">err</span><span class="op" id="6223004">)</span>&nbsp;<span class="op" id="6223006">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223010">db</span><span class="op" id="6223012">.</span><span class="ident" id="6223013">addDepLocked</span><span class="op" id="6223025">(</span><span class="ident" id="6223026">dc</span><span class="op" id="6223028">,</span>&nbsp;<span class="ident" id="6223030">dc</span><span class="op" id="6223032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223036">db</span><span class="op" id="6223038">.</span><span class="ident" id="6223039">numOpen</span><span class="op" id="6223046">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6223050">}</span>&nbsp;<span class="keyword" id="6223052">else</span>&nbsp;<span class="op" id="6223057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223061">ci</span><span class="op" id="6223063">.</span><span class="ident" id="6223064">Close</span><span class="op" id="6223069">(</span><span class="op" id="6223070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6223073">}</span><br>
<span class="lineno">620</span><span class="op" id="6223075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6223078">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6223137">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="6223206">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="6223267">type</span>&nbsp;<span class="ident" id="6223272">connRequest</span>&nbsp;<span class="keyword" id="6223284">struct</span>&nbsp;<span class="op" id="6223291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223294">conn</span>&nbsp;<span class="op" id="6223299">*</span><span class="ident" id="6223300">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223312">err</span>&nbsp;&nbsp;<span class="builtintype" id="6223317">error</span><br>
<span class="lineno"></span><span class="op" id="6223323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="6223326">var</span>&nbsp;<span class="ident" id="6223330">errDBClosed</span>&nbsp;<span class="op" id="6223342">=</span>&nbsp;<span class="ident" id="6223344">errors</span><span class="op" id="6223350">.</span><span class="ident" id="6223351">New</span><span class="op" id="6223354">(</span><span class="string" id="6223355">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6223380">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6223383">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="6223436">func</span>&nbsp;<span class="op" id="6223441">(</span><span class="ident" id="6223442">db</span>&nbsp;<span class="op" id="6223445">*</span><span class="ident" id="6223446">DB</span><span class="op" id="6223448">)</span>&nbsp;<span class="ident" id="6223450">conn</span><span class="op" id="6223454">(</span><span class="op" id="6223455">)</span>&nbsp;<span class="op" id="6223457">(</span><span class="op" id="6223458">*</span><span class="ident" id="6223459">driverConn</span><span class="op" id="6223469">,</span>&nbsp;<span class="builtintype" id="6223471">error</span><span class="op" id="6223476">)</span>&nbsp;<span class="op" id="6223478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223481">db</span><span class="op" id="6223483">.</span><span class="ident" id="6223484">mu</span><span class="op" id="6223486">.</span><span class="ident" id="6223487">Lock</span><span class="op" id="6223491">(</span><span class="op" id="6223492">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6223495">if</span>&nbsp;<span class="ident" id="6223498">db</span><span class="op" id="6223500">.</span><span class="ident" id="6223501">closed</span>&nbsp;<span class="op" id="6223508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223512">db</span><span class="op" id="6223514">.</span><span class="ident" id="6223515">mu</span><span class="op" id="6223517">.</span><span class="ident" id="6223518">Unlock</span><span class="op" id="6223524">(</span><span class="op" id="6223525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6223529">return</span>&nbsp;<span class="ident" id="6223536">nil</span><span class="op" id="6223539">,</span>&nbsp;<span class="ident" id="6223541">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6223554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6223558">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6223633">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6223696">if</span>&nbsp;<span class="ident" id="6223699">db</span><span class="op" id="6223701">.</span><span class="ident" id="6223702">maxOpen</span>&nbsp;<span class="op" id="6223710">&gt;</span>&nbsp;<span class="num" id="6223712">0</span>&nbsp;<span class="op" id="6223714">&amp;&amp;</span>&nbsp;<span class="ident" id="6223717">db</span><span class="op" id="6223719">.</span><span class="ident" id="6223720">numOpen</span>&nbsp;<span class="op" id="6223728">&gt;=</span>&nbsp;<span class="ident" id="6223731">db</span><span class="op" id="6223733">.</span><span class="ident" id="6223734">maxOpen</span>&nbsp;<span class="op" id="6223742">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6223745">len</span><span class="op" id="6223748">(</span><span class="ident" id="6223749">db</span><span class="op" id="6223751">.</span><span class="ident" id="6223752">freeConn</span><span class="op" id="6223760">)</span>&nbsp;<span class="op" id="6223762">==</span>&nbsp;<span class="num" id="6223765">0</span>&nbsp;<span class="op" id="6223767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6223771">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6223832">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223906">req</span>&nbsp;<span class="op" id="6223910">:=</span>&nbsp;<span class="builtinfunc" id="6223913">make</span><span class="op" id="6223917">(</span><span class="keyword" id="6223918">chan</span>&nbsp;<span class="ident" id="6223923">connRequest</span><span class="op" id="6223934">,</span>&nbsp;<span class="num" id="6223936">1</span><span class="op" id="6223937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223941">db</span><span class="op" id="6223943">.</span><span class="ident" id="6223944">connRequests</span>&nbsp;<span class="op" id="6223957">=</span>&nbsp;<span class="builtinfunc" id="6223959">append</span><span class="op" id="6223965">(</span><span class="ident" id="6223966">db</span><span class="op" id="6223968">.</span><span class="ident" id="6223969">connRequests</span><span class="op" id="6223981">,</span>&nbsp;<span class="ident" id="6223983">req</span><span class="op" id="6223986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6223990">db</span><span class="op" id="6223992">.</span><span class="ident" id="6223993">maybeOpenNewConnections</span><span class="op" id="6224016">(</span><span class="op" id="6224017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224021">db</span><span class="op" id="6224023">.</span><span class="ident" id="6224024">mu</span><span class="op" id="6224026">.</span><span class="ident" id="6224027">Unlock</span><span class="op" id="6224033">(</span><span class="op" id="6224034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224038">ret</span>&nbsp;<span class="op" id="6224042">:=</span>&nbsp;<span class="op" id="6224045">&lt;-</span><span class="ident" id="6224047">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6224053">return</span>&nbsp;<span class="ident" id="6224060">ret</span><span class="op" id="6224063">.</span><span class="ident" id="6224064">conn</span><span class="op" id="6224068">,</span>&nbsp;<span class="ident" id="6224070">ret</span><span class="op" id="6224073">.</span><span class="ident" id="6224074">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6224079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6224083">if</span>&nbsp;<span class="ident" id="6224086">c</span>&nbsp;<span class="op" id="6224088">:=</span>&nbsp;<span class="builtinfunc" id="6224091">len</span><span class="op" id="6224094">(</span><span class="ident" id="6224095">db</span><span class="op" id="6224097">.</span><span class="ident" id="6224098">freeConn</span><span class="op" id="6224106">)</span><span class="op" id="6224107">;</span>&nbsp;<span class="ident" id="6224109">c</span>&nbsp;<span class="op" id="6224111">&gt;</span>&nbsp;<span class="num" id="6224113">0</span>&nbsp;<span class="op" id="6224115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224119">conn</span>&nbsp;<span class="op" id="6224124">:=</span>&nbsp;<span class="ident" id="6224127">db</span><span class="op" id="6224129">.</span><span class="ident" id="6224130">freeConn</span><span class="op" id="6224138">[</span><span class="num" id="6224139">0</span><span class="op" id="6224140">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6224144">copy</span><span class="op" id="6224148">(</span><span class="ident" id="6224149">db</span><span class="op" id="6224151">.</span><span class="ident" id="6224152">freeConn</span><span class="op" id="6224160">,</span>&nbsp;<span class="ident" id="6224162">db</span><span class="op" id="6224164">.</span><span class="ident" id="6224165">freeConn</span><span class="op" id="6224173">[</span><span class="num" id="6224174">1</span><span class="op" id="6224175">:</span><span class="op" id="6224176">]</span><span class="op" id="6224177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224181">db</span><span class="op" id="6224183">.</span><span class="ident" id="6224184">freeConn</span>&nbsp;<span class="op" id="6224193">=</span>&nbsp;<span class="ident" id="6224195">db</span><span class="op" id="6224197">.</span><span class="ident" id="6224198">freeConn</span><span class="op" id="6224206">[</span><span class="op" id="6224207">:</span><span class="ident" id="6224208">c</span><span class="op" id="6224209">-</span><span class="num" id="6224210">1</span><span class="op" id="6224211">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224215">conn</span><span class="op" id="6224219">.</span><span class="ident" id="6224220">inUse</span>&nbsp;<span class="op" id="6224226">=</span>&nbsp;<span class="builtintype" id="6224228">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224235">db</span><span class="op" id="6224237">.</span><span class="ident" id="6224238">mu</span><span class="op" id="6224240">.</span><span class="ident" id="6224241">Unlock</span><span class="op" id="6224247">(</span><span class="op" id="6224248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6224252">return</span>&nbsp;<span class="ident" id="6224259">conn</span><span class="op" id="6224263">,</span>&nbsp;<span class="ident" id="6224265">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6224270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224274">db</span><span class="op" id="6224276">.</span><span class="ident" id="6224277">numOpen</span><span class="op" id="6224284">++</span>&nbsp;<span class="comment" id="6224287">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224306">db</span><span class="op" id="6224308">.</span><span class="ident" id="6224309">mu</span><span class="op" id="6224311">.</span><span class="ident" id="6224312">Unlock</span><span class="op" id="6224318">(</span><span class="op" id="6224319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224322">ci</span><span class="op" id="6224324">,</span>&nbsp;<span class="ident" id="6224326">err</span>&nbsp;<span class="op" id="6224330">:=</span>&nbsp;<span class="ident" id="6224333">db</span><span class="op" id="6224335">.</span><span class="ident" id="6224336">driver</span><span class="op" id="6224342">.</span><span class="ident" id="6224343">Open</span><span class="op" id="6224347">(</span><span class="ident" id="6224348">db</span><span class="op" id="6224350">.</span><span class="ident" id="6224351">dsn</span><span class="op" id="6224354">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6224357">if</span>&nbsp;<span class="ident" id="6224360">err</span>&nbsp;<span class="op" id="6224364">!=</span>&nbsp;<span class="ident" id="6224367">nil</span>&nbsp;<span class="op" id="6224371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224375">db</span><span class="op" id="6224377">.</span><span class="ident" id="6224378">mu</span><span class="op" id="6224380">.</span><span class="ident" id="6224381">Lock</span><span class="op" id="6224385">(</span><span class="op" id="6224386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224390">db</span><span class="op" id="6224392">.</span><span class="ident" id="6224393">numOpen</span><span class="op" id="6224400">--</span>&nbsp;<span class="comment" id="6224403">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224437">db</span><span class="op" id="6224439">.</span><span class="ident" id="6224440">mu</span><span class="op" id="6224442">.</span><span class="ident" id="6224443">Unlock</span><span class="op" id="6224449">(</span><span class="op" id="6224450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6224454">return</span>&nbsp;<span class="ident" id="6224461">nil</span><span class="op" id="6224464">,</span>&nbsp;<span class="ident" id="6224466">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6224471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224474">db</span><span class="op" id="6224476">.</span><span class="ident" id="6224477">mu</span><span class="op" id="6224479">.</span><span class="ident" id="6224480">Lock</span><span class="op" id="6224484">(</span><span class="op" id="6224485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224488">dc</span>&nbsp;<span class="op" id="6224491">:=</span>&nbsp;<span class="op" id="6224494">&amp;</span><span class="ident" id="6224495">driverConn</span><span class="op" id="6224505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224509">db</span><span class="op" id="6224511">:</span>&nbsp;<span class="ident" id="6224513">db</span><span class="op" id="6224515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224519">ci</span><span class="op" id="6224521">:</span>&nbsp;<span class="ident" id="6224523">ci</span><span class="op" id="6224525">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6224528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224531">db</span><span class="op" id="6224533">.</span><span class="ident" id="6224534">addDepLocked</span><span class="op" id="6224546">(</span><span class="ident" id="6224547">dc</span><span class="op" id="6224549">,</span>&nbsp;<span class="ident" id="6224551">dc</span><span class="op" id="6224553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224556">dc</span><span class="op" id="6224558">.</span><span class="ident" id="6224559">inUse</span>&nbsp;<span class="op" id="6224565">=</span>&nbsp;<span class="builtintype" id="6224567">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224573">db</span><span class="op" id="6224575">.</span><span class="ident" id="6224576">mu</span><span class="op" id="6224578">.</span><span class="ident" id="6224579">Unlock</span><span class="op" id="6224585">(</span><span class="op" id="6224586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6224589">return</span>&nbsp;<span class="ident" id="6224596">dc</span><span class="op" id="6224598">,</span>&nbsp;<span class="ident" id="6224600">nil</span><br>
<span class="lineno">680</span><span class="op" id="6224604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6224607">var</span>&nbsp;<span class="op" id="6224611">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224614">errConnClosed</span>&nbsp;<span class="op" id="6224628">=</span>&nbsp;<span class="ident" id="6224630">errors</span><span class="op" id="6224636">.</span><span class="ident" id="6224637">New</span><span class="op" id="6224640">(</span><span class="string" id="6224641">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6224696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6224699">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6224713">=</span>&nbsp;<span class="ident" id="6224715">errors</span><span class="op" id="6224721">.</span><span class="ident" id="6224722">New</span><span class="op" id="6224725">(</span><span class="string" id="6224726">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="6224779">)</span><br>
<span class="lineno">685</span><span class="op" id="6224781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6224784">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6224856">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="6224873">//</span><br>
<span class="lineno">690</span><span class="comment" id="6224876">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6224952">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6224992">//</span><br>
<span class="lineno"></span><span class="comment" id="6224995">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="6225052">func</span>&nbsp;<span class="op" id="6225057">(</span><span class="ident" id="6225058">db</span>&nbsp;<span class="op" id="6225061">*</span><span class="ident" id="6225062">DB</span><span class="op" id="6225064">)</span>&nbsp;<span class="ident" id="6225066">connIfFree</span><span class="op" id="6225076">(</span><span class="ident" id="6225077">wanted</span>&nbsp;<span class="op" id="6225084">*</span><span class="ident" id="6225085">driverConn</span><span class="op" id="6225095">)</span>&nbsp;<span class="op" id="6225097">(</span><span class="op" id="6225098">*</span><span class="ident" id="6225099">driverConn</span><span class="op" id="6225109">,</span>&nbsp;<span class="builtintype" id="6225111">error</span><span class="op" id="6225116">)</span>&nbsp;<span class="op" id="6225118">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6225121">db</span><span class="op" id="6225123">.</span><span class="ident" id="6225124">mu</span><span class="op" id="6225126">.</span><span class="ident" id="6225127">Lock</span><span class="op" id="6225131">(</span><span class="op" id="6225132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225135">defer</span>&nbsp;<span class="ident" id="6225141">db</span><span class="op" id="6225143">.</span><span class="ident" id="6225144">mu</span><span class="op" id="6225146">.</span><span class="ident" id="6225147">Unlock</span><span class="op" id="6225153">(</span><span class="op" id="6225154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225157">if</span>&nbsp;<span class="ident" id="6225160">wanted</span><span class="op" id="6225166">.</span><span class="ident" id="6225167">dbmuClosed</span>&nbsp;<span class="op" id="6225178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225182">return</span>&nbsp;<span class="ident" id="6225189">nil</span><span class="op" id="6225192">,</span>&nbsp;<span class="ident" id="6225194">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6225209">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225212">if</span>&nbsp;<span class="ident" id="6225215">wanted</span><span class="op" id="6225221">.</span><span class="ident" id="6225222">inUse</span>&nbsp;<span class="op" id="6225228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225232">return</span>&nbsp;<span class="ident" id="6225239">nil</span><span class="op" id="6225242">,</span>&nbsp;<span class="ident" id="6225244">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6225257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6225260">idx</span>&nbsp;<span class="op" id="6225264">:=</span>&nbsp;<span class="op" id="6225267">-</span><span class="num" id="6225268">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225271">for</span>&nbsp;<span class="ident" id="6225275">ii</span><span class="op" id="6225277">,</span>&nbsp;<span class="ident" id="6225279">v</span>&nbsp;<span class="op" id="6225281">:=</span>&nbsp;<span class="keyword" id="6225284">range</span>&nbsp;<span class="ident" id="6225290">db</span><span class="op" id="6225292">.</span><span class="ident" id="6225293">freeConn</span>&nbsp;<span class="op" id="6225302">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225306">if</span>&nbsp;<span class="ident" id="6225309">v</span>&nbsp;<span class="op" id="6225311">==</span>&nbsp;<span class="ident" id="6225314">wanted</span>&nbsp;<span class="op" id="6225321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6225326">idx</span>&nbsp;<span class="op" id="6225330">=</span>&nbsp;<span class="ident" id="6225332">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225338">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6225346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6225349">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225352">if</span>&nbsp;<span class="ident" id="6225355">idx</span>&nbsp;<span class="op" id="6225359">&gt;=</span>&nbsp;<span class="num" id="6225362">0</span>&nbsp;<span class="op" id="6225364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6225368">db</span><span class="op" id="6225370">.</span><span class="ident" id="6225371">freeConn</span>&nbsp;<span class="op" id="6225380">=</span>&nbsp;<span class="builtinfunc" id="6225382">append</span><span class="op" id="6225388">(</span><span class="ident" id="6225389">db</span><span class="op" id="6225391">.</span><span class="ident" id="6225392">freeConn</span><span class="op" id="6225400">[</span><span class="op" id="6225401">:</span><span class="ident" id="6225402">idx</span><span class="op" id="6225405">]</span><span class="op" id="6225406">,</span>&nbsp;<span class="ident" id="6225408">db</span><span class="op" id="6225410">.</span><span class="ident" id="6225411">freeConn</span><span class="op" id="6225419">[</span><span class="ident" id="6225420">idx</span><span class="op" id="6225423">+</span><span class="num" id="6225424">1</span><span class="op" id="6225425">:</span><span class="op" id="6225426">]</span><span class="op" id="6225427">...</span><span class="op" id="6225430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6225434">wanted</span><span class="op" id="6225440">.</span><span class="ident" id="6225441">inUse</span>&nbsp;<span class="op" id="6225447">=</span>&nbsp;<span class="builtintype" id="6225449">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225456">return</span>&nbsp;<span class="ident" id="6225463">wanted</span><span class="op" id="6225469">,</span>&nbsp;<span class="ident" id="6225471">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6225476">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6225479">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6225549">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6225626">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6225695">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6225715">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6225761">return</span>&nbsp;<span class="ident" id="6225768">nil</span><span class="op" id="6225771">,</span>&nbsp;<span class="ident" id="6225773">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="6225785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6225788">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="6225826">var</span>&nbsp;<span class="ident" id="6225830">putConnHook</span>&nbsp;<span class="keyword" id="6225842">func</span><span class="op" id="6225846">(</span><span class="op" id="6225847">*</span><span class="ident" id="6225848">DB</span><span class="op" id="6225850">,</span>&nbsp;<span class="op" id="6225852">*</span><span class="ident" id="6225853">driverConn</span><span class="op" id="6225863">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="6225866">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="6225938">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6226010">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6226029">func</span>&nbsp;<span class="op" id="6226034">(</span><span class="ident" id="6226035">db</span>&nbsp;<span class="op" id="6226038">*</span><span class="ident" id="6226039">DB</span><span class="op" id="6226041">)</span>&nbsp;<span class="ident" id="6226043">noteUnusedDriverStatement</span><span class="op" id="6226068">(</span><span class="ident" id="6226069">c</span>&nbsp;<span class="op" id="6226071">*</span><span class="ident" id="6226072">driverConn</span><span class="op" id="6226082">,</span>&nbsp;<span class="ident" id="6226084">si</span>&nbsp;<span class="ident" id="6226087">driver</span><span class="op" id="6226093">.</span><span class="ident" id="6226094">Stmt</span><span class="op" id="6226098">)</span>&nbsp;<span class="op" id="6226100">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226103">db</span><span class="op" id="6226105">.</span><span class="ident" id="6226106">mu</span><span class="op" id="6226108">.</span><span class="ident" id="6226109">Lock</span><span class="op" id="6226113">(</span><span class="op" id="6226114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226117">defer</span>&nbsp;<span class="ident" id="6226123">db</span><span class="op" id="6226125">.</span><span class="ident" id="6226126">mu</span><span class="op" id="6226128">.</span><span class="ident" id="6226129">Unlock</span><span class="op" id="6226135">(</span><span class="op" id="6226136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226139">if</span>&nbsp;<span class="ident" id="6226142">c</span><span class="op" id="6226143">.</span><span class="ident" id="6226144">inUse</span>&nbsp;<span class="op" id="6226150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226154">c</span><span class="op" id="6226155">.</span><span class="ident" id="6226156">onPut</span>&nbsp;<span class="op" id="6226162">=</span>&nbsp;<span class="builtinfunc" id="6226164">append</span><span class="op" id="6226170">(</span><span class="ident" id="6226171">c</span><span class="op" id="6226172">.</span><span class="ident" id="6226173">onPut</span><span class="op" id="6226178">,</span>&nbsp;<span class="keyword" id="6226180">func</span><span class="op" id="6226184">(</span><span class="op" id="6226185">)</span>&nbsp;<span class="op" id="6226187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226192">si</span><span class="op" id="6226194">.</span><span class="ident" id="6226195">Close</span><span class="op" id="6226200">(</span><span class="op" id="6226201">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226205">}</span><span class="op" id="6226206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226209">}</span>&nbsp;<span class="keyword" id="6226211">else</span>&nbsp;<span class="op" id="6226216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226220">c</span><span class="op" id="6226221">.</span><span class="ident" id="6226222">Lock</span><span class="op" id="6226226">(</span><span class="op" id="6226227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226231">defer</span>&nbsp;<span class="ident" id="6226237">c</span><span class="op" id="6226238">.</span><span class="ident" id="6226239">Unlock</span><span class="op" id="6226245">(</span><span class="op" id="6226246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226250">if</span>&nbsp;<span class="op" id="6226253">!</span><span class="ident" id="6226254">c</span><span class="op" id="6226255">.</span><span class="ident" id="6226256">finalClosed</span>&nbsp;<span class="op" id="6226268">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226273">si</span><span class="op" id="6226275">.</span><span class="ident" id="6226276">Close</span><span class="op" id="6226281">(</span><span class="op" id="6226282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226289">}</span><br>
<span class="lineno"></span><span class="op" id="6226291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="6226294">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="6226366">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="6226408">const</span>&nbsp;<span class="ident" id="6226414">debugGetPut</span>&nbsp;<span class="op" id="6226426">=</span>&nbsp;<span class="builtintype" id="6226428">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6226435">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="6226487">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6226557">func</span>&nbsp;<span class="op" id="6226562">(</span><span class="ident" id="6226563">db</span>&nbsp;<span class="op" id="6226566">*</span><span class="ident" id="6226567">DB</span><span class="op" id="6226569">)</span>&nbsp;<span class="ident" id="6226571">putConn</span><span class="op" id="6226578">(</span><span class="ident" id="6226579">dc</span>&nbsp;<span class="op" id="6226582">*</span><span class="ident" id="6226583">driverConn</span><span class="op" id="6226593">,</span>&nbsp;<span class="ident" id="6226595">err</span>&nbsp;<span class="builtintype" id="6226599">error</span><span class="op" id="6226604">)</span>&nbsp;<span class="op" id="6226606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226609">db</span><span class="op" id="6226611">.</span><span class="ident" id="6226612">mu</span><span class="op" id="6226614">.</span><span class="ident" id="6226615">Lock</span><span class="op" id="6226619">(</span><span class="op" id="6226620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226623">if</span>&nbsp;<span class="op" id="6226626">!</span><span class="ident" id="6226627">dc</span><span class="op" id="6226629">.</span><span class="ident" id="6226630">inUse</span>&nbsp;<span class="op" id="6226636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226640">if</span>&nbsp;<span class="ident" id="6226643">debugGetPut</span>&nbsp;<span class="op" id="6226655">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226660">fmt</span><span class="op" id="6226663">.</span><span class="ident" id="6226664">Printf</span><span class="op" id="6226670">(</span><span class="string" id="6226671">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="6226722">,</span>&nbsp;<span class="ident" id="6226724">dc</span><span class="op" id="6226726">,</span>&nbsp;<span class="ident" id="6226728">stack</span><span class="op" id="6226733">(</span><span class="op" id="6226734">)</span><span class="op" id="6226735">,</span>&nbsp;<span class="ident" id="6226737">db</span><span class="op" id="6226739">.</span><span class="ident" id="6226740">lastPut</span><span class="op" id="6226747">[</span><span class="ident" id="6226748">dc</span><span class="op" id="6226750">]</span><span class="op" id="6226751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6226759">panic</span><span class="op" id="6226764">(</span><span class="string" id="6226765">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="6226810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226816">if</span>&nbsp;<span class="ident" id="6226819">debugGetPut</span>&nbsp;<span class="op" id="6226831">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226835">db</span><span class="op" id="6226837">.</span><span class="ident" id="6226838">lastPut</span><span class="op" id="6226845">[</span><span class="ident" id="6226846">dc</span><span class="op" id="6226848">]</span>&nbsp;<span class="op" id="6226850">=</span>&nbsp;<span class="ident" id="6226852">stack</span><span class="op" id="6226857">(</span><span class="op" id="6226858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226864">dc</span><span class="op" id="6226866">.</span><span class="ident" id="6226867">inUse</span>&nbsp;<span class="op" id="6226873">=</span>&nbsp;<span class="builtintype" id="6226875">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226883">for</span>&nbsp;<span class="ident" id="6226887">_</span><span class="op" id="6226888">,</span>&nbsp;<span class="ident" id="6226890">fn</span>&nbsp;<span class="op" id="6226893">:=</span>&nbsp;<span class="keyword" id="6226896">range</span>&nbsp;<span class="ident" id="6226902">dc</span><span class="op" id="6226904">.</span><span class="ident" id="6226905">onPut</span>&nbsp;<span class="op" id="6226911">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226915">fn</span><span class="op" id="6226917">(</span><span class="op" id="6226918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6226921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6226924">dc</span><span class="op" id="6226926">.</span><span class="ident" id="6226927">onPut</span>&nbsp;<span class="op" id="6226933">=</span>&nbsp;<span class="ident" id="6226935">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6226941">if</span>&nbsp;<span class="ident" id="6226944">err</span>&nbsp;<span class="op" id="6226948">==</span>&nbsp;<span class="ident" id="6226951">driver</span><span class="op" id="6226957">.</span><span class="ident" id="6226958">ErrBadConn</span>&nbsp;<span class="op" id="6226969">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6226973">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6227007">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6227078">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6227147">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227171">db</span><span class="op" id="6227173">.</span><span class="ident" id="6227174">maybeOpenNewConnections</span><span class="op" id="6227197">(</span><span class="op" id="6227198">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227202">db</span><span class="op" id="6227204">.</span><span class="ident" id="6227205">mu</span><span class="op" id="6227207">.</span><span class="ident" id="6227208">Unlock</span><span class="op" id="6227214">(</span><span class="op" id="6227215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227219">dc</span><span class="op" id="6227221">.</span><span class="ident" id="6227222">Close</span><span class="op" id="6227227">(</span><span class="op" id="6227228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6227232">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6227240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6227243">if</span>&nbsp;<span class="ident" id="6227246">putConnHook</span>&nbsp;<span class="op" id="6227258">!=</span>&nbsp;<span class="ident" id="6227261">nil</span>&nbsp;<span class="op" id="6227265">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227269">putConnHook</span><span class="op" id="6227280">(</span><span class="ident" id="6227281">db</span><span class="op" id="6227283">,</span>&nbsp;<span class="ident" id="6227285">dc</span><span class="op" id="6227287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6227290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227293">added</span>&nbsp;<span class="op" id="6227299">:=</span>&nbsp;<span class="ident" id="6227302">db</span><span class="op" id="6227304">.</span><span class="ident" id="6227305">putConnDBLocked</span><span class="op" id="6227320">(</span><span class="ident" id="6227321">dc</span><span class="op" id="6227323">,</span>&nbsp;<span class="ident" id="6227325">nil</span><span class="op" id="6227328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227331">db</span><span class="op" id="6227333">.</span><span class="ident" id="6227334">mu</span><span class="op" id="6227336">.</span><span class="ident" id="6227337">Unlock</span><span class="op" id="6227343">(</span><span class="op" id="6227344">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6227348">if</span>&nbsp;<span class="op" id="6227351">!</span><span class="ident" id="6227352">added</span>&nbsp;<span class="op" id="6227358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6227362">dc</span><span class="op" id="6227364">.</span><span class="ident" id="6227365">Close</span><span class="op" id="6227370">(</span><span class="op" id="6227371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6227374">}</span><br>
<span class="lineno"></span><span class="op" id="6227376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="6227379">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="6227459">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="6227479">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6227553">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6227627">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="6227669">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="6227715">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="6227761">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6227832">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6227902">func</span>&nbsp;<span class="op" id="6227907">(</span><span class="ident" id="6227908">db</span>&nbsp;<span class="op" id="6227911">*</span><span class="ident" id="6227912">DB</span><span class="op" id="6227914">)</span>&nbsp;<span class="ident" id="6227916">putConnDBLocked</span><span class="op" id="6227931">(</span><span class="ident" id="6227932">dc</span>&nbsp;<span class="op" id="6227935">*</span><span class="ident" id="6227936">driverConn</span><span class="op" id="6227946">,</span>&nbsp;<span class="ident" id="6227948">err</span>&nbsp;<span class="builtintype" id="6227952">error</span><span class="op" id="6227957">)</span>&nbsp;<span class="builtintype" id="6227959">bool</span>&nbsp;<span class="op" id="6227964">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6227967">if</span>&nbsp;<span class="ident" id="6227970">c</span>&nbsp;<span class="op" id="6227972">:=</span>&nbsp;<span class="builtinfunc" id="6227975">len</span><span class="op" id="6227978">(</span><span class="ident" id="6227979">db</span><span class="op" id="6227981">.</span><span class="ident" id="6227982">connRequests</span><span class="op" id="6227994">)</span><span class="op" id="6227995">;</span>&nbsp;<span class="ident" id="6227997">c</span>&nbsp;<span class="op" id="6227999">&gt;</span>&nbsp;<span class="num" id="6228001">0</span>&nbsp;<span class="op" id="6228003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228007">req</span>&nbsp;<span class="op" id="6228011">:=</span>&nbsp;<span class="ident" id="6228014">db</span><span class="op" id="6228016">.</span><span class="ident" id="6228017">connRequests</span><span class="op" id="6228029">[</span><span class="num" id="6228030">0</span><span class="op" id="6228031">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6228035">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6228101">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6228155">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6228185">copy</span><span class="op" id="6228189">(</span><span class="ident" id="6228190">db</span><span class="op" id="6228192">.</span><span class="ident" id="6228193">connRequests</span><span class="op" id="6228205">,</span>&nbsp;<span class="ident" id="6228207">db</span><span class="op" id="6228209">.</span><span class="ident" id="6228210">connRequests</span><span class="op" id="6228222">[</span><span class="num" id="6228223">1</span><span class="op" id="6228224">:</span><span class="op" id="6228225">]</span><span class="op" id="6228226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228230">db</span><span class="op" id="6228232">.</span><span class="ident" id="6228233">connRequests</span>&nbsp;<span class="op" id="6228246">=</span>&nbsp;<span class="ident" id="6228248">db</span><span class="op" id="6228250">.</span><span class="ident" id="6228251">connRequests</span><span class="op" id="6228263">[</span><span class="op" id="6228264">:</span><span class="ident" id="6228265">c</span><span class="op" id="6228266">-</span><span class="num" id="6228267">1</span><span class="op" id="6228268">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228272">if</span>&nbsp;<span class="ident" id="6228275">err</span>&nbsp;<span class="op" id="6228279">==</span>&nbsp;<span class="ident" id="6228282">nil</span>&nbsp;<span class="op" id="6228286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228291">dc</span><span class="op" id="6228293">.</span><span class="ident" id="6228294">inUse</span>&nbsp;<span class="op" id="6228300">=</span>&nbsp;<span class="builtintype" id="6228302">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6228309">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228313">req</span>&nbsp;<span class="op" id="6228317">&lt;-</span>&nbsp;<span class="ident" id="6228320">connRequest</span><span class="op" id="6228331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228336">conn</span><span class="op" id="6228340">:</span>&nbsp;<span class="ident" id="6228342">dc</span><span class="op" id="6228344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228349">err</span><span class="op" id="6228352">:</span>&nbsp;&nbsp;<span class="ident" id="6228355">err</span><span class="op" id="6228358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6228362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228366">return</span>&nbsp;<span class="builtintype" id="6228373">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6228379">}</span>&nbsp;<span class="keyword" id="6228381">else</span>&nbsp;<span class="keyword" id="6228386">if</span>&nbsp;<span class="ident" id="6228389">err</span>&nbsp;<span class="op" id="6228393">==</span>&nbsp;<span class="ident" id="6228396">nil</span>&nbsp;<span class="op" id="6228400">&amp;&amp;</span>&nbsp;<span class="op" id="6228403">!</span><span class="ident" id="6228404">db</span><span class="op" id="6228406">.</span><span class="ident" id="6228407">closed</span>&nbsp;<span class="op" id="6228414">&amp;&amp;</span>&nbsp;<span class="ident" id="6228417">db</span><span class="op" id="6228419">.</span><span class="ident" id="6228420">maxIdleConnsLocked</span><span class="op" id="6228438">(</span><span class="op" id="6228439">)</span>&nbsp;<span class="op" id="6228441">&gt;</span>&nbsp;<span class="builtinfunc" id="6228443">len</span><span class="op" id="6228446">(</span><span class="ident" id="6228447">db</span><span class="op" id="6228449">.</span><span class="ident" id="6228450">freeConn</span><span class="op" id="6228458">)</span>&nbsp;<span class="op" id="6228460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228464">db</span><span class="op" id="6228466">.</span><span class="ident" id="6228467">freeConn</span>&nbsp;<span class="op" id="6228476">=</span>&nbsp;<span class="builtinfunc" id="6228478">append</span><span class="op" id="6228484">(</span><span class="ident" id="6228485">db</span><span class="op" id="6228487">.</span><span class="ident" id="6228488">freeConn</span><span class="op" id="6228496">,</span>&nbsp;<span class="ident" id="6228498">dc</span><span class="op" id="6228500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228504">return</span>&nbsp;<span class="builtintype" id="6228511">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6228517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228520">return</span>&nbsp;<span class="builtintype" id="6228527">false</span><br>
<span class="lineno">820</span><span class="op" id="6228533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6228536">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6228612">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6228664">const</span>&nbsp;<span class="ident" id="6228670">maxBadConnRetries</span>&nbsp;<span class="op" id="6228688">=</span>&nbsp;<span class="num" id="6228690">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="6228694">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="6228767">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6228834">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6228857">func</span>&nbsp;<span class="op" id="6228862">(</span><span class="ident" id="6228863">db</span>&nbsp;<span class="op" id="6228866">*</span><span class="ident" id="6228867">DB</span><span class="op" id="6228869">)</span>&nbsp;<span class="ident" id="6228871">Prepare</span><span class="op" id="6228878">(</span><span class="ident" id="6228879">query</span>&nbsp;<span class="builtintype" id="6228885">string</span><span class="op" id="6228891">)</span>&nbsp;<span class="op" id="6228893">(</span><span class="op" id="6228894">*</span><span class="ident" id="6228895">Stmt</span><span class="op" id="6228899">,</span>&nbsp;<span class="builtintype" id="6228901">error</span><span class="op" id="6228906">)</span>&nbsp;<span class="op" id="6228908">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228911">var</span>&nbsp;<span class="ident" id="6228915">stmt</span>&nbsp;<span class="op" id="6228920">*</span><span class="ident" id="6228921">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228927">var</span>&nbsp;<span class="ident" id="6228931">err</span>&nbsp;<span class="builtintype" id="6228935">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6228942">for</span>&nbsp;<span class="ident" id="6228946">i</span>&nbsp;<span class="op" id="6228948">:=</span>&nbsp;<span class="num" id="6228951">0</span><span class="op" id="6228952">;</span>&nbsp;<span class="ident" id="6228954">i</span>&nbsp;<span class="op" id="6228956">&lt;</span>&nbsp;<span class="ident" id="6228958">maxBadConnRetries</span><span class="op" id="6228975">;</span>&nbsp;<span class="ident" id="6228977">i</span><span class="op" id="6228978">++</span>&nbsp;<span class="op" id="6228981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6228985">stmt</span><span class="op" id="6228989">,</span>&nbsp;<span class="ident" id="6228991">err</span>&nbsp;<span class="op" id="6228995">=</span>&nbsp;<span class="ident" id="6228997">db</span><span class="op" id="6228999">.</span><span class="ident" id="6229000">prepare</span><span class="op" id="6229007">(</span><span class="ident" id="6229008">query</span><span class="op" id="6229013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229017">if</span>&nbsp;<span class="ident" id="6229020">err</span>&nbsp;<span class="op" id="6229024">!=</span>&nbsp;<span class="ident" id="6229027">driver</span><span class="op" id="6229033">.</span><span class="ident" id="6229034">ErrBadConn</span>&nbsp;<span class="op" id="6229045">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229050">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6229058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6229061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229064">return</span>&nbsp;<span class="ident" id="6229071">stmt</span><span class="op" id="6229075">,</span>&nbsp;<span class="ident" id="6229077">err</span><br>
<span class="lineno"></span><span class="op" id="6229081">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="6229084">func</span>&nbsp;<span class="op" id="6229089">(</span><span class="ident" id="6229090">db</span>&nbsp;<span class="op" id="6229093">*</span><span class="ident" id="6229094">DB</span><span class="op" id="6229096">)</span>&nbsp;<span class="ident" id="6229098">prepare</span><span class="op" id="6229105">(</span><span class="ident" id="6229106">query</span>&nbsp;<span class="builtintype" id="6229112">string</span><span class="op" id="6229118">)</span>&nbsp;<span class="op" id="6229120">(</span><span class="op" id="6229121">*</span><span class="ident" id="6229122">Stmt</span><span class="op" id="6229126">,</span>&nbsp;<span class="builtintype" id="6229128">error</span><span class="op" id="6229133">)</span>&nbsp;<span class="op" id="6229135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6229138">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6229188">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6229248">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6229304">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6229364">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6229427">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229488">dc</span><span class="op" id="6229490">,</span>&nbsp;<span class="ident" id="6229492">err</span>&nbsp;<span class="op" id="6229496">:=</span>&nbsp;<span class="ident" id="6229499">db</span><span class="op" id="6229501">.</span><span class="ident" id="6229502">conn</span><span class="op" id="6229506">(</span><span class="op" id="6229507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229510">if</span>&nbsp;<span class="ident" id="6229513">err</span>&nbsp;<span class="op" id="6229517">!=</span>&nbsp;<span class="ident" id="6229520">nil</span>&nbsp;<span class="op" id="6229524">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229528">return</span>&nbsp;<span class="ident" id="6229535">nil</span><span class="op" id="6229538">,</span>&nbsp;<span class="ident" id="6229540">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6229545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229548">dc</span><span class="op" id="6229550">.</span><span class="ident" id="6229551">Lock</span><span class="op" id="6229555">(</span><span class="op" id="6229556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229559">si</span><span class="op" id="6229561">,</span>&nbsp;<span class="ident" id="6229563">err</span>&nbsp;<span class="op" id="6229567">:=</span>&nbsp;<span class="ident" id="6229570">dc</span><span class="op" id="6229572">.</span><span class="ident" id="6229573">prepareLocked</span><span class="op" id="6229586">(</span><span class="ident" id="6229587">query</span><span class="op" id="6229592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229595">dc</span><span class="op" id="6229597">.</span><span class="ident" id="6229598">Unlock</span><span class="op" id="6229604">(</span><span class="op" id="6229605">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229608">if</span>&nbsp;<span class="ident" id="6229611">err</span>&nbsp;<span class="op" id="6229615">!=</span>&nbsp;<span class="ident" id="6229618">nil</span>&nbsp;<span class="op" id="6229622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229626">db</span><span class="op" id="6229628">.</span><span class="ident" id="6229629">putConn</span><span class="op" id="6229636">(</span><span class="ident" id="6229637">dc</span><span class="op" id="6229639">,</span>&nbsp;<span class="ident" id="6229641">err</span><span class="op" id="6229644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229648">return</span>&nbsp;<span class="ident" id="6229655">nil</span><span class="op" id="6229658">,</span>&nbsp;<span class="ident" id="6229660">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6229665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229668">stmt</span>&nbsp;<span class="op" id="6229673">:=</span>&nbsp;<span class="op" id="6229676">&amp;</span><span class="ident" id="6229677">Stmt</span><span class="op" id="6229681">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229685">db</span><span class="op" id="6229687">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229692">db</span><span class="op" id="6229694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229698">query</span><span class="op" id="6229703">:</span>&nbsp;<span class="ident" id="6229705">query</span><span class="op" id="6229710">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229714">css</span><span class="op" id="6229717">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6229721">[</span><span class="op" id="6229722">]</span><span class="ident" id="6229723">connStmt</span><span class="op" id="6229731">{</span><span class="op" id="6229732">{</span><span class="ident" id="6229733">dc</span><span class="op" id="6229735">,</span>&nbsp;<span class="ident" id="6229737">si</span><span class="op" id="6229739">}</span><span class="op" id="6229740">}</span><span class="op" id="6229741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6229744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229747">db</span><span class="op" id="6229749">.</span><span class="ident" id="6229750">addDep</span><span class="op" id="6229756">(</span><span class="ident" id="6229757">stmt</span><span class="op" id="6229761">,</span>&nbsp;<span class="ident" id="6229763">stmt</span><span class="op" id="6229767">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6229770">db</span><span class="op" id="6229772">.</span><span class="ident" id="6229773">putConn</span><span class="op" id="6229780">(</span><span class="ident" id="6229781">dc</span><span class="op" id="6229783">,</span>&nbsp;<span class="ident" id="6229785">nil</span><span class="op" id="6229788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229791">return</span>&nbsp;<span class="ident" id="6229798">stmt</span><span class="op" id="6229802">,</span>&nbsp;<span class="ident" id="6229804">nil</span><br>
<span class="lineno"></span><span class="op" id="6229808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6229811">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="6229864">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="6229925">func</span>&nbsp;<span class="op" id="6229930">(</span><span class="ident" id="6229931">db</span>&nbsp;<span class="op" id="6229934">*</span><span class="ident" id="6229935">DB</span><span class="op" id="6229937">)</span>&nbsp;<span class="ident" id="6229939">Exec</span><span class="op" id="6229943">(</span><span class="ident" id="6229944">query</span>&nbsp;<span class="builtintype" id="6229950">string</span><span class="op" id="6229956">,</span>&nbsp;<span class="ident" id="6229958">args</span>&nbsp;<span class="op" id="6229963">...</span><span class="keyword" id="6229966">interface</span><span class="op" id="6229975">{</span><span class="op" id="6229976">}</span><span class="op" id="6229977">)</span>&nbsp;<span class="op" id="6229979">(</span><span class="ident" id="6229980">Result</span><span class="op" id="6229986">,</span>&nbsp;<span class="builtintype" id="6229988">error</span><span class="op" id="6229993">)</span>&nbsp;<span class="op" id="6229995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6229998">var</span>&nbsp;<span class="ident" id="6230002">res</span>&nbsp;<span class="ident" id="6230006">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230014">var</span>&nbsp;<span class="ident" id="6230018">err</span>&nbsp;<span class="builtintype" id="6230022">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230029">for</span>&nbsp;<span class="ident" id="6230033">i</span>&nbsp;<span class="op" id="6230035">:=</span>&nbsp;<span class="num" id="6230038">0</span><span class="op" id="6230039">;</span>&nbsp;<span class="ident" id="6230041">i</span>&nbsp;<span class="op" id="6230043">&lt;</span>&nbsp;<span class="ident" id="6230045">maxBadConnRetries</span><span class="op" id="6230062">;</span>&nbsp;<span class="ident" id="6230064">i</span><span class="op" id="6230065">++</span>&nbsp;<span class="op" id="6230068">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230072">res</span><span class="op" id="6230075">,</span>&nbsp;<span class="ident" id="6230077">err</span>&nbsp;<span class="op" id="6230081">=</span>&nbsp;<span class="ident" id="6230083">db</span><span class="op" id="6230085">.</span><span class="ident" id="6230086">exec</span><span class="op" id="6230090">(</span><span class="ident" id="6230091">query</span><span class="op" id="6230096">,</span>&nbsp;<span class="ident" id="6230098">args</span><span class="op" id="6230102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230106">if</span>&nbsp;<span class="ident" id="6230109">err</span>&nbsp;<span class="op" id="6230113">!=</span>&nbsp;<span class="ident" id="6230116">driver</span><span class="op" id="6230122">.</span><span class="ident" id="6230123">ErrBadConn</span>&nbsp;<span class="op" id="6230134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230139">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230150">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230153">return</span>&nbsp;<span class="ident" id="6230160">res</span><span class="op" id="6230163">,</span>&nbsp;<span class="ident" id="6230165">err</span><br>
<span class="lineno"></span><span class="op" id="6230169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6230172">func</span>&nbsp;<span class="op" id="6230177">(</span><span class="ident" id="6230178">db</span>&nbsp;<span class="op" id="6230181">*</span><span class="ident" id="6230182">DB</span><span class="op" id="6230184">)</span>&nbsp;<span class="ident" id="6230186">exec</span><span class="op" id="6230190">(</span><span class="ident" id="6230191">query</span>&nbsp;<span class="builtintype" id="6230197">string</span><span class="op" id="6230203">,</span>&nbsp;<span class="ident" id="6230205">args</span>&nbsp;<span class="op" id="6230210">[</span><span class="op" id="6230211">]</span><span class="keyword" id="6230212">interface</span><span class="op" id="6230221">{</span><span class="op" id="6230222">}</span><span class="op" id="6230223">)</span>&nbsp;<span class="op" id="6230225">(</span><span class="ident" id="6230226">res</span>&nbsp;<span class="ident" id="6230230">Result</span><span class="op" id="6230236">,</span>&nbsp;<span class="ident" id="6230238">err</span>&nbsp;<span class="builtintype" id="6230242">error</span><span class="op" id="6230247">)</span>&nbsp;<span class="op" id="6230249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230252">dc</span><span class="op" id="6230254">,</span>&nbsp;<span class="ident" id="6230256">err</span>&nbsp;<span class="op" id="6230260">:=</span>&nbsp;<span class="ident" id="6230263">db</span><span class="op" id="6230265">.</span><span class="ident" id="6230266">conn</span><span class="op" id="6230270">(</span><span class="op" id="6230271">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230274">if</span>&nbsp;<span class="ident" id="6230277">err</span>&nbsp;<span class="op" id="6230281">!=</span>&nbsp;<span class="ident" id="6230284">nil</span>&nbsp;<span class="op" id="6230288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230292">return</span>&nbsp;<span class="ident" id="6230299">nil</span><span class="op" id="6230302">,</span>&nbsp;<span class="ident" id="6230304">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230312">defer</span>&nbsp;<span class="keyword" id="6230318">func</span><span class="op" id="6230322">(</span><span class="op" id="6230323">)</span>&nbsp;<span class="op" id="6230325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230329">db</span><span class="op" id="6230331">.</span><span class="ident" id="6230332">putConn</span><span class="op" id="6230339">(</span><span class="ident" id="6230340">dc</span><span class="op" id="6230342">,</span>&nbsp;<span class="ident" id="6230344">err</span><span class="op" id="6230347">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230350">}</span><span class="op" id="6230351">(</span><span class="op" id="6230352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230356">if</span>&nbsp;<span class="ident" id="6230359">execer</span><span class="op" id="6230365">,</span>&nbsp;<span class="ident" id="6230367">ok</span>&nbsp;<span class="op" id="6230370">:=</span>&nbsp;<span class="ident" id="6230373">dc</span><span class="op" id="6230375">.</span><span class="ident" id="6230376">ci</span><span class="op" id="6230378">.</span><span class="op" id="6230379">(</span><span class="ident" id="6230380">driver</span><span class="op" id="6230386">.</span><span class="ident" id="6230387">Execer</span><span class="op" id="6230393">)</span><span class="op" id="6230394">;</span>&nbsp;<span class="ident" id="6230396">ok</span>&nbsp;<span class="op" id="6230399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230403">dargs</span><span class="op" id="6230408">,</span>&nbsp;<span class="ident" id="6230410">err</span>&nbsp;<span class="op" id="6230414">:=</span>&nbsp;<span class="ident" id="6230417">driverArgs</span><span class="op" id="6230427">(</span><span class="ident" id="6230428">nil</span><span class="op" id="6230431">,</span>&nbsp;<span class="ident" id="6230433">args</span><span class="op" id="6230437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230441">if</span>&nbsp;<span class="ident" id="6230444">err</span>&nbsp;<span class="op" id="6230448">!=</span>&nbsp;<span class="ident" id="6230451">nil</span>&nbsp;<span class="op" id="6230455">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230460">return</span>&nbsp;<span class="ident" id="6230467">nil</span><span class="op" id="6230470">,</span>&nbsp;<span class="ident" id="6230472">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230482">dc</span><span class="op" id="6230484">.</span><span class="ident" id="6230485">Lock</span><span class="op" id="6230489">(</span><span class="op" id="6230490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230494">resi</span><span class="op" id="6230498">,</span>&nbsp;<span class="ident" id="6230500">err</span>&nbsp;<span class="op" id="6230504">:=</span>&nbsp;<span class="ident" id="6230507">execer</span><span class="op" id="6230513">.</span><span class="ident" id="6230514">Exec</span><span class="op" id="6230518">(</span><span class="ident" id="6230519">query</span><span class="op" id="6230524">,</span>&nbsp;<span class="ident" id="6230526">dargs</span><span class="op" id="6230531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230535">dc</span><span class="op" id="6230537">.</span><span class="ident" id="6230538">Unlock</span><span class="op" id="6230544">(</span><span class="op" id="6230545">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230549">if</span>&nbsp;<span class="ident" id="6230552">err</span>&nbsp;<span class="op" id="6230556">!=</span>&nbsp;<span class="ident" id="6230559">driver</span><span class="op" id="6230565">.</span><span class="ident" id="6230566">ErrSkip</span>&nbsp;<span class="op" id="6230574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230579">if</span>&nbsp;<span class="ident" id="6230582">err</span>&nbsp;<span class="op" id="6230586">!=</span>&nbsp;<span class="ident" id="6230589">nil</span>&nbsp;<span class="op" id="6230593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230599">return</span>&nbsp;<span class="ident" id="6230606">nil</span><span class="op" id="6230609">,</span>&nbsp;<span class="ident" id="6230611">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230623">return</span>&nbsp;<span class="ident" id="6230630">driverResult</span><span class="op" id="6230642">{</span><span class="ident" id="6230643">dc</span><span class="op" id="6230645">,</span>&nbsp;<span class="ident" id="6230647">resi</span><span class="op" id="6230651">}</span><span class="op" id="6230652">,</span>&nbsp;<span class="ident" id="6230654">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230667">dc</span><span class="op" id="6230669">.</span><span class="ident" id="6230670">Lock</span><span class="op" id="6230674">(</span><span class="op" id="6230675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230678">si</span><span class="op" id="6230680">,</span>&nbsp;<span class="ident" id="6230682">err</span>&nbsp;<span class="op" id="6230686">:=</span>&nbsp;<span class="ident" id="6230689">dc</span><span class="op" id="6230691">.</span><span class="ident" id="6230692">ci</span><span class="op" id="6230694">.</span><span class="ident" id="6230695">Prepare</span><span class="op" id="6230702">(</span><span class="ident" id="6230703">query</span><span class="op" id="6230708">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6230711">dc</span><span class="op" id="6230713">.</span><span class="ident" id="6230714">Unlock</span><span class="op" id="6230720">(</span><span class="op" id="6230721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230724">if</span>&nbsp;<span class="ident" id="6230727">err</span>&nbsp;<span class="op" id="6230731">!=</span>&nbsp;<span class="ident" id="6230734">nil</span>&nbsp;<span class="op" id="6230738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230742">return</span>&nbsp;<span class="ident" id="6230749">nil</span><span class="op" id="6230752">,</span>&nbsp;<span class="ident" id="6230754">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6230759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230762">defer</span>&nbsp;<span class="ident" id="6230768">withLock</span><span class="op" id="6230776">(</span><span class="ident" id="6230777">dc</span><span class="op" id="6230779">,</span>&nbsp;<span class="keyword" id="6230781">func</span><span class="op" id="6230785">(</span><span class="op" id="6230786">)</span>&nbsp;<span class="op" id="6230788">{</span>&nbsp;<span class="ident" id="6230790">si</span><span class="op" id="6230792">.</span><span class="ident" id="6230793">Close</span><span class="op" id="6230798">(</span><span class="op" id="6230799">)</span>&nbsp;<span class="op" id="6230801">}</span><span class="op" id="6230802">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6230805">return</span>&nbsp;<span class="ident" id="6230812">resultFromStatement</span><span class="op" id="6230831">(</span><span class="ident" id="6230832">driverStmt</span><span class="op" id="6230842">{</span><span class="ident" id="6230843">dc</span><span class="op" id="6230845">,</span>&nbsp;<span class="ident" id="6230847">si</span><span class="op" id="6230849">}</span><span class="op" id="6230850">,</span>&nbsp;<span class="ident" id="6230852">args</span><span class="op" id="6230856">...</span><span class="op" id="6230859">)</span><br>
<span class="lineno"></span><span class="op" id="6230861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6230864">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="6230929">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="6230990">func</span>&nbsp;<span class="op" id="6230995">(</span><span class="ident" id="6230996">db</span>&nbsp;<span class="op" id="6230999">*</span><span class="ident" id="6231000">DB</span><span class="op" id="6231002">)</span>&nbsp;<span class="ident" id="6231004">Query</span><span class="op" id="6231009">(</span><span class="ident" id="6231010">query</span>&nbsp;<span class="builtintype" id="6231016">string</span><span class="op" id="6231022">,</span>&nbsp;<span class="ident" id="6231024">args</span>&nbsp;<span class="op" id="6231029">...</span><span class="keyword" id="6231032">interface</span><span class="op" id="6231041">{</span><span class="op" id="6231042">}</span><span class="op" id="6231043">)</span>&nbsp;<span class="op" id="6231045">(</span><span class="op" id="6231046">*</span><span class="ident" id="6231047">Rows</span><span class="op" id="6231051">,</span>&nbsp;<span class="builtintype" id="6231053">error</span><span class="op" id="6231058">)</span>&nbsp;<span class="op" id="6231060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231063">var</span>&nbsp;<span class="ident" id="6231067">rows</span>&nbsp;<span class="op" id="6231072">*</span><span class="ident" id="6231073">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231079">var</span>&nbsp;<span class="ident" id="6231083">err</span>&nbsp;<span class="builtintype" id="6231087">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231094">for</span>&nbsp;<span class="ident" id="6231098">i</span>&nbsp;<span class="op" id="6231100">:=</span>&nbsp;<span class="num" id="6231103">0</span><span class="op" id="6231104">;</span>&nbsp;<span class="ident" id="6231106">i</span>&nbsp;<span class="op" id="6231108">&lt;</span>&nbsp;<span class="ident" id="6231110">maxBadConnRetries</span><span class="op" id="6231127">;</span>&nbsp;<span class="ident" id="6231129">i</span><span class="op" id="6231130">++</span>&nbsp;<span class="op" id="6231133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231137">rows</span><span class="op" id="6231141">,</span>&nbsp;<span class="ident" id="6231143">err</span>&nbsp;<span class="op" id="6231147">=</span>&nbsp;<span class="ident" id="6231149">db</span><span class="op" id="6231151">.</span><span class="ident" id="6231152">query</span><span class="op" id="6231157">(</span><span class="ident" id="6231158">query</span><span class="op" id="6231163">,</span>&nbsp;<span class="ident" id="6231165">args</span><span class="op" id="6231169">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231173">if</span>&nbsp;<span class="ident" id="6231176">err</span>&nbsp;<span class="op" id="6231180">!=</span>&nbsp;<span class="ident" id="6231183">driver</span><span class="op" id="6231189">.</span><span class="ident" id="6231190">ErrBadConn</span>&nbsp;<span class="op" id="6231201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231206">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6231214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6231217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231220">return</span>&nbsp;<span class="ident" id="6231227">rows</span><span class="op" id="6231231">,</span>&nbsp;<span class="ident" id="6231233">err</span><br>
<span class="lineno">930</span><span class="op" id="6231237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6231240">func</span>&nbsp;<span class="op" id="6231245">(</span><span class="ident" id="6231246">db</span>&nbsp;<span class="op" id="6231249">*</span><span class="ident" id="6231250">DB</span><span class="op" id="6231252">)</span>&nbsp;<span class="ident" id="6231254">query</span><span class="op" id="6231259">(</span><span class="ident" id="6231260">query</span>&nbsp;<span class="builtintype" id="6231266">string</span><span class="op" id="6231272">,</span>&nbsp;<span class="ident" id="6231274">args</span>&nbsp;<span class="op" id="6231279">[</span><span class="op" id="6231280">]</span><span class="keyword" id="6231281">interface</span><span class="op" id="6231290">{</span><span class="op" id="6231291">}</span><span class="op" id="6231292">)</span>&nbsp;<span class="op" id="6231294">(</span><span class="op" id="6231295">*</span><span class="ident" id="6231296">Rows</span><span class="op" id="6231300">,</span>&nbsp;<span class="builtintype" id="6231302">error</span><span class="op" id="6231307">)</span>&nbsp;<span class="op" id="6231309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231312">ci</span><span class="op" id="6231314">,</span>&nbsp;<span class="ident" id="6231316">err</span>&nbsp;<span class="op" id="6231320">:=</span>&nbsp;<span class="ident" id="6231323">db</span><span class="op" id="6231325">.</span><span class="ident" id="6231326">conn</span><span class="op" id="6231330">(</span><span class="op" id="6231331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231334">if</span>&nbsp;<span class="ident" id="6231337">err</span>&nbsp;<span class="op" id="6231341">!=</span>&nbsp;<span class="ident" id="6231344">nil</span>&nbsp;<span class="op" id="6231348">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231352">return</span>&nbsp;<span class="ident" id="6231359">nil</span><span class="op" id="6231362">,</span>&nbsp;<span class="ident" id="6231364">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6231369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231373">return</span>&nbsp;<span class="ident" id="6231380">db</span><span class="op" id="6231382">.</span><span class="ident" id="6231383">queryConn</span><span class="op" id="6231392">(</span><span class="ident" id="6231393">ci</span><span class="op" id="6231395">,</span>&nbsp;<span class="ident" id="6231397">ci</span><span class="op" id="6231399">.</span><span class="ident" id="6231400">releaseConn</span><span class="op" id="6231411">,</span>&nbsp;<span class="ident" id="6231413">query</span><span class="op" id="6231418">,</span>&nbsp;<span class="ident" id="6231420">args</span><span class="op" id="6231424">)</span><br>
<span class="lineno"></span><span class="op" id="6231426">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="6231429">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="6231484">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="6231545">func</span>&nbsp;<span class="op" id="6231550">(</span><span class="ident" id="6231551">db</span>&nbsp;<span class="op" id="6231554">*</span><span class="ident" id="6231555">DB</span><span class="op" id="6231557">)</span>&nbsp;<span class="ident" id="6231559">queryConn</span><span class="op" id="6231568">(</span><span class="ident" id="6231569">dc</span>&nbsp;<span class="op" id="6231572">*</span><span class="ident" id="6231573">driverConn</span><span class="op" id="6231583">,</span>&nbsp;<span class="ident" id="6231585">releaseConn</span>&nbsp;<span class="keyword" id="6231597">func</span><span class="op" id="6231601">(</span><span class="builtintype" id="6231602">error</span><span class="op" id="6231607">)</span><span class="op" id="6231608">,</span>&nbsp;<span class="ident" id="6231610">query</span>&nbsp;<span class="builtintype" id="6231616">string</span><span class="op" id="6231622">,</span>&nbsp;<span class="ident" id="6231624">args</span>&nbsp;<span class="op" id="6231629">[</span><span class="op" id="6231630">]</span><span class="keyword" id="6231631">interface</span><span class="op" id="6231640">{</span><span class="op" id="6231641">}</span><span class="op" id="6231642">)</span>&nbsp;<span class="op" id="6231644">(</span><span class="op" id="6231645">*</span><span class="ident" id="6231646">Rows</span><span class="op" id="6231650">,</span>&nbsp;<span class="builtintype" id="6231652">error</span><span class="op" id="6231657">)</span>&nbsp;<span class="op" id="6231659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231662">if</span>&nbsp;<span class="ident" id="6231665">queryer</span><span class="op" id="6231672">,</span>&nbsp;<span class="ident" id="6231674">ok</span>&nbsp;<span class="op" id="6231677">:=</span>&nbsp;<span class="ident" id="6231680">dc</span><span class="op" id="6231682">.</span><span class="ident" id="6231683">ci</span><span class="op" id="6231685">.</span><span class="op" id="6231686">(</span><span class="ident" id="6231687">driver</span><span class="op" id="6231693">.</span><span class="ident" id="6231694">Queryer</span><span class="op" id="6231701">)</span><span class="op" id="6231702">;</span>&nbsp;<span class="ident" id="6231704">ok</span>&nbsp;<span class="op" id="6231707">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231711">dargs</span><span class="op" id="6231716">,</span>&nbsp;<span class="ident" id="6231718">err</span>&nbsp;<span class="op" id="6231722">:=</span>&nbsp;<span class="ident" id="6231725">driverArgs</span><span class="op" id="6231735">(</span><span class="ident" id="6231736">nil</span><span class="op" id="6231739">,</span>&nbsp;<span class="ident" id="6231741">args</span><span class="op" id="6231745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231749">if</span>&nbsp;<span class="ident" id="6231752">err</span>&nbsp;<span class="op" id="6231756">!=</span>&nbsp;<span class="ident" id="6231759">nil</span>&nbsp;<span class="op" id="6231763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231768">releaseConn</span><span class="op" id="6231779">(</span><span class="ident" id="6231780">err</span><span class="op" id="6231783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231788">return</span>&nbsp;<span class="ident" id="6231795">nil</span><span class="op" id="6231798">,</span>&nbsp;<span class="ident" id="6231800">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6231806">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231810">dc</span><span class="op" id="6231812">.</span><span class="ident" id="6231813">Lock</span><span class="op" id="6231817">(</span><span class="op" id="6231818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231822">rowsi</span><span class="op" id="6231827">,</span>&nbsp;<span class="ident" id="6231829">err</span>&nbsp;<span class="op" id="6231833">:=</span>&nbsp;<span class="ident" id="6231836">queryer</span><span class="op" id="6231843">.</span><span class="ident" id="6231844">Query</span><span class="op" id="6231849">(</span><span class="ident" id="6231850">query</span><span class="op" id="6231855">,</span>&nbsp;<span class="ident" id="6231857">dargs</span><span class="op" id="6231862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231866">dc</span><span class="op" id="6231868">.</span><span class="ident" id="6231869">Unlock</span><span class="op" id="6231875">(</span><span class="op" id="6231876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231880">if</span>&nbsp;<span class="ident" id="6231883">err</span>&nbsp;<span class="op" id="6231887">!=</span>&nbsp;<span class="ident" id="6231890">driver</span><span class="op" id="6231896">.</span><span class="ident" id="6231897">ErrSkip</span>&nbsp;<span class="op" id="6231905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231910">if</span>&nbsp;<span class="ident" id="6231913">err</span>&nbsp;<span class="op" id="6231917">!=</span>&nbsp;<span class="ident" id="6231920">nil</span>&nbsp;<span class="op" id="6231924">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6231930">releaseConn</span><span class="op" id="6231941">(</span><span class="ident" id="6231942">err</span><span class="op" id="6231945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6231951">return</span>&nbsp;<span class="ident" id="6231958">nil</span><span class="op" id="6231961">,</span>&nbsp;<span class="ident" id="6231963">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6231970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6231975">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6232036">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232060">rows</span>&nbsp;<span class="op" id="6232065">:=</span>&nbsp;<span class="op" id="6232068">&amp;</span><span class="ident" id="6232069">Rows</span><span class="op" id="6232073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232079">dc</span><span class="op" id="6232081">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232092">dc</span><span class="op" id="6232094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232100">releaseConn</span><span class="op" id="6232111">:</span>&nbsp;<span class="ident" id="6232113">releaseConn</span><span class="op" id="6232124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232130">rowsi</span><span class="op" id="6232135">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232143">rowsi</span><span class="op" id="6232148">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6232153">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232158">return</span>&nbsp;<span class="ident" id="6232165">rows</span><span class="op" id="6232169">,</span>&nbsp;<span class="ident" id="6232171">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6232177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6232180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232184">dc</span><span class="op" id="6232186">.</span><span class="ident" id="6232187">Lock</span><span class="op" id="6232191">(</span><span class="op" id="6232192">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232195">si</span><span class="op" id="6232197">,</span>&nbsp;<span class="ident" id="6232199">err</span>&nbsp;<span class="op" id="6232203">:=</span>&nbsp;<span class="ident" id="6232206">dc</span><span class="op" id="6232208">.</span><span class="ident" id="6232209">ci</span><span class="op" id="6232211">.</span><span class="ident" id="6232212">Prepare</span><span class="op" id="6232219">(</span><span class="ident" id="6232220">query</span><span class="op" id="6232225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232228">dc</span><span class="op" id="6232230">.</span><span class="ident" id="6232231">Unlock</span><span class="op" id="6232237">(</span><span class="op" id="6232238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232241">if</span>&nbsp;<span class="ident" id="6232244">err</span>&nbsp;<span class="op" id="6232248">!=</span>&nbsp;<span class="ident" id="6232251">nil</span>&nbsp;<span class="op" id="6232255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232259">releaseConn</span><span class="op" id="6232270">(</span><span class="ident" id="6232271">err</span><span class="op" id="6232274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232278">return</span>&nbsp;<span class="ident" id="6232285">nil</span><span class="op" id="6232288">,</span>&nbsp;<span class="ident" id="6232290">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6232295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232299">ds</span>&nbsp;<span class="op" id="6232302">:=</span>&nbsp;<span class="ident" id="6232305">driverStmt</span><span class="op" id="6232315">{</span><span class="ident" id="6232316">dc</span><span class="op" id="6232318">,</span>&nbsp;<span class="ident" id="6232320">si</span><span class="op" id="6232322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232325">rowsi</span><span class="op" id="6232330">,</span>&nbsp;<span class="ident" id="6232332">err</span>&nbsp;<span class="op" id="6232336">:=</span>&nbsp;<span class="ident" id="6232339">rowsiFromStatement</span><span class="op" id="6232357">(</span><span class="ident" id="6232358">ds</span><span class="op" id="6232360">,</span>&nbsp;<span class="ident" id="6232362">args</span><span class="op" id="6232366">...</span><span class="op" id="6232369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232372">if</span>&nbsp;<span class="ident" id="6232375">err</span>&nbsp;<span class="op" id="6232379">!=</span>&nbsp;<span class="ident" id="6232382">nil</span>&nbsp;<span class="op" id="6232386">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232390">dc</span><span class="op" id="6232392">.</span><span class="ident" id="6232393">Lock</span><span class="op" id="6232397">(</span><span class="op" id="6232398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232402">si</span><span class="op" id="6232404">.</span><span class="ident" id="6232405">Close</span><span class="op" id="6232410">(</span><span class="op" id="6232411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232415">dc</span><span class="op" id="6232417">.</span><span class="ident" id="6232418">Unlock</span><span class="op" id="6232424">(</span><span class="op" id="6232425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232429">releaseConn</span><span class="op" id="6232440">(</span><span class="ident" id="6232441">err</span><span class="op" id="6232444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232448">return</span>&nbsp;<span class="ident" id="6232455">nil</span><span class="op" id="6232458">,</span>&nbsp;<span class="ident" id="6232460">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6232465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6232469">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6232528">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232550">rows</span>&nbsp;<span class="op" id="6232555">:=</span>&nbsp;<span class="op" id="6232558">&amp;</span><span class="ident" id="6232559">Rows</span><span class="op" id="6232563">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232567">dc</span><span class="op" id="6232569">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232580">dc</span><span class="op" id="6232582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232586">releaseConn</span><span class="op" id="6232597">:</span>&nbsp;<span class="ident" id="6232599">releaseConn</span><span class="op" id="6232610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232614">rowsi</span><span class="op" id="6232619">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232627">rowsi</span><span class="op" id="6232632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232636">closeStmt</span><span class="op" id="6232645">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6232649">si</span><span class="op" id="6232651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6232654">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232657">return</span>&nbsp;<span class="ident" id="6232664">rows</span><span class="op" id="6232668">,</span>&nbsp;<span class="ident" id="6232670">nil</span><br>
<span class="lineno"></span><span class="op" id="6232674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6232677">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6232750">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="6232819">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="6232851">func</span>&nbsp;<span class="op" id="6232856">(</span><span class="ident" id="6232857">db</span>&nbsp;<span class="op" id="6232860">*</span><span class="ident" id="6232861">DB</span><span class="op" id="6232863">)</span>&nbsp;<span class="ident" id="6232865">QueryRow</span><span class="op" id="6232873">(</span><span class="ident" id="6232874">query</span>&nbsp;<span class="builtintype" id="6232880">string</span><span class="op" id="6232886">,</span>&nbsp;<span class="ident" id="6232888">args</span>&nbsp;<span class="op" id="6232893">...</span><span class="keyword" id="6232896">interface</span><span class="op" id="6232905">{</span><span class="op" id="6232906">}</span><span class="op" id="6232907">)</span>&nbsp;<span class="op" id="6232909">*</span><span class="ident" id="6232910">Row</span>&nbsp;<span class="op" id="6232914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6232917">rows</span><span class="op" id="6232921">,</span>&nbsp;<span class="ident" id="6232923">err</span>&nbsp;<span class="op" id="6232927">:=</span>&nbsp;<span class="ident" id="6232930">db</span><span class="op" id="6232932">.</span><span class="ident" id="6232933">Query</span><span class="op" id="6232938">(</span><span class="ident" id="6232939">query</span><span class="op" id="6232944">,</span>&nbsp;<span class="ident" id="6232946">args</span><span class="op" id="6232950">...</span><span class="op" id="6232953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6232956">return</span>&nbsp;<span class="op" id="6232963">&amp;</span><span class="ident" id="6232964">Row</span><span class="op" id="6232967">{</span><span class="ident" id="6232968">rows</span><span class="op" id="6232972">:</span>&nbsp;<span class="ident" id="6232974">rows</span><span class="op" id="6232978">,</span>&nbsp;<span class="ident" id="6232980">err</span><span class="op" id="6232983">:</span>&nbsp;<span class="ident" id="6232985">err</span><span class="op" id="6232988">}</span><br>
<span class="lineno"></span><span class="op" id="6232990">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="6232993">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6233060">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="6233075">func</span>&nbsp;<span class="op" id="6233080">(</span><span class="ident" id="6233081">db</span>&nbsp;<span class="op" id="6233084">*</span><span class="ident" id="6233085">DB</span><span class="op" id="6233087">)</span>&nbsp;<span class="ident" id="6233089">Begin</span><span class="op" id="6233094">(</span><span class="op" id="6233095">)</span>&nbsp;<span class="op" id="6233097">(</span><span class="op" id="6233098">*</span><span class="ident" id="6233099">Tx</span><span class="op" id="6233101">,</span>&nbsp;<span class="builtintype" id="6233103">error</span><span class="op" id="6233108">)</span>&nbsp;<span class="op" id="6233110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233113">var</span>&nbsp;<span class="ident" id="6233117">tx</span>&nbsp;<span class="op" id="6233120">*</span><span class="ident" id="6233121">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233125">var</span>&nbsp;<span class="ident" id="6233129">err</span>&nbsp;<span class="builtintype" id="6233133">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233140">for</span>&nbsp;<span class="ident" id="6233144">i</span>&nbsp;<span class="op" id="6233146">:=</span>&nbsp;<span class="num" id="6233149">0</span><span class="op" id="6233150">;</span>&nbsp;<span class="ident" id="6233152">i</span>&nbsp;<span class="op" id="6233154">&lt;</span>&nbsp;<span class="ident" id="6233156">maxBadConnRetries</span><span class="op" id="6233173">;</span>&nbsp;<span class="ident" id="6233175">i</span><span class="op" id="6233176">++</span>&nbsp;<span class="op" id="6233179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233183">tx</span><span class="op" id="6233185">,</span>&nbsp;<span class="ident" id="6233187">err</span>&nbsp;<span class="op" id="6233191">=</span>&nbsp;<span class="ident" id="6233193">db</span><span class="op" id="6233195">.</span><span class="ident" id="6233196">begin</span><span class="op" id="6233201">(</span><span class="op" id="6233202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233206">if</span>&nbsp;<span class="ident" id="6233209">err</span>&nbsp;<span class="op" id="6233213">!=</span>&nbsp;<span class="ident" id="6233216">driver</span><span class="op" id="6233222">.</span><span class="ident" id="6233223">ErrBadConn</span>&nbsp;<span class="op" id="6233234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233239">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6233247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6233250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233253">return</span>&nbsp;<span class="ident" id="6233260">tx</span><span class="op" id="6233262">,</span>&nbsp;<span class="ident" id="6233264">err</span><br>
<span class="lineno"></span><span class="op" id="6233268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="6233271">func</span>&nbsp;<span class="op" id="6233276">(</span><span class="ident" id="6233277">db</span>&nbsp;<span class="op" id="6233280">*</span><span class="ident" id="6233281">DB</span><span class="op" id="6233283">)</span>&nbsp;<span class="ident" id="6233285">begin</span><span class="op" id="6233290">(</span><span class="op" id="6233291">)</span>&nbsp;<span class="op" id="6233293">(</span><span class="ident" id="6233294">tx</span>&nbsp;<span class="op" id="6233297">*</span><span class="ident" id="6233298">Tx</span><span class="op" id="6233300">,</span>&nbsp;<span class="ident" id="6233302">err</span>&nbsp;<span class="builtintype" id="6233306">error</span><span class="op" id="6233311">)</span>&nbsp;<span class="op" id="6233313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233316">dc</span><span class="op" id="6233318">,</span>&nbsp;<span class="ident" id="6233320">err</span>&nbsp;<span class="op" id="6233324">:=</span>&nbsp;<span class="ident" id="6233327">db</span><span class="op" id="6233329">.</span><span class="ident" id="6233330">conn</span><span class="op" id="6233334">(</span><span class="op" id="6233335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233338">if</span>&nbsp;<span class="ident" id="6233341">err</span>&nbsp;<span class="op" id="6233345">!=</span>&nbsp;<span class="ident" id="6233348">nil</span>&nbsp;<span class="op" id="6233352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233356">return</span>&nbsp;<span class="ident" id="6233363">nil</span><span class="op" id="6233366">,</span>&nbsp;<span class="ident" id="6233368">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6233373">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233376">dc</span><span class="op" id="6233378">.</span><span class="ident" id="6233379">Lock</span><span class="op" id="6233383">(</span><span class="op" id="6233384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233387">txi</span><span class="op" id="6233390">,</span>&nbsp;<span class="ident" id="6233392">err</span>&nbsp;<span class="op" id="6233396">:=</span>&nbsp;<span class="ident" id="6233399">dc</span><span class="op" id="6233401">.</span><span class="ident" id="6233402">ci</span><span class="op" id="6233404">.</span><span class="ident" id="6233405">Begin</span><span class="op" id="6233410">(</span><span class="op" id="6233411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233414">dc</span><span class="op" id="6233416">.</span><span class="ident" id="6233417">Unlock</span><span class="op" id="6233423">(</span><span class="op" id="6233424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233427">if</span>&nbsp;<span class="ident" id="6233430">err</span>&nbsp;<span class="op" id="6233434">!=</span>&nbsp;<span class="ident" id="6233437">nil</span>&nbsp;<span class="op" id="6233441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233445">db</span><span class="op" id="6233447">.</span><span class="ident" id="6233448">putConn</span><span class="op" id="6233455">(</span><span class="ident" id="6233456">dc</span><span class="op" id="6233458">,</span>&nbsp;<span class="ident" id="6233460">err</span><span class="op" id="6233463">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233467">return</span>&nbsp;<span class="ident" id="6233474">nil</span><span class="op" id="6233477">,</span>&nbsp;<span class="ident" id="6233479">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6233484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233487">return</span>&nbsp;<span class="op" id="6233494">&amp;</span><span class="ident" id="6233495">Tx</span><span class="op" id="6233497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233501">db</span><span class="op" id="6233503">:</span>&nbsp;&nbsp;<span class="ident" id="6233506">db</span><span class="op" id="6233508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233512">dc</span><span class="op" id="6233514">:</span>&nbsp;&nbsp;<span class="ident" id="6233517">dc</span><span class="op" id="6233519">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233523">txi</span><span class="op" id="6233526">:</span>&nbsp;<span class="ident" id="6233528">txi</span><span class="op" id="6233531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6233534">}</span><span class="op" id="6233535">,</span>&nbsp;<span class="ident" id="6233537">nil</span><br>
<span class="lineno"></span><span class="op" id="6233541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6233544">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="6233596">func</span>&nbsp;<span class="op" id="6233601">(</span><span class="ident" id="6233602">db</span>&nbsp;<span class="op" id="6233605">*</span><span class="ident" id="6233606">DB</span><span class="op" id="6233608">)</span>&nbsp;<span class="ident" id="6233610">Driver</span><span class="op" id="6233616">(</span><span class="op" id="6233617">)</span>&nbsp;<span class="ident" id="6233619">driver</span><span class="op" id="6233625">.</span><span class="ident" id="6233626">Driver</span>&nbsp;<span class="op" id="6233633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6233636">return</span>&nbsp;<span class="ident" id="6233643">db</span><span class="op" id="6233645">.</span><span class="ident" id="6233646">driver</span><br>
<span class="lineno"></span><span class="op" id="6233653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6233656">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="6233702">//</span><br>
<span class="lineno"></span><span class="comment" id="6233705">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="6233766">//</span><br>
<span class="lineno"></span><span class="comment" id="6233769">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6233830">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="6233866">type</span>&nbsp;<span class="ident" id="6233871">Tx</span>&nbsp;<span class="keyword" id="6233874">struct</span>&nbsp;<span class="op" id="6233881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233884">db</span>&nbsp;<span class="op" id="6233887">*</span><span class="ident" id="6233888">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6233893">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6233962">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6233994">dc</span>&nbsp;&nbsp;<span class="op" id="6233998">*</span><span class="ident" id="6233999">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234011">txi</span>&nbsp;<span class="ident" id="6234015">driver</span><span class="op" id="6234021">.</span><span class="ident" id="6234022">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6234027">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6234091">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6234144">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234159">done</span>&nbsp;<span class="builtintype" id="6234164">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6234171">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6234248">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234299">stmts</span>&nbsp;<span class="keyword" id="6234305">struct</span>&nbsp;<span class="op" id="6234312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234316">sync</span><span class="op" id="6234320">.</span><span class="ident" id="6234321">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234329">v</span>&nbsp;<span class="op" id="6234331">[</span><span class="op" id="6234332">]</span><span class="op" id="6234333">*</span><span class="ident" id="6234334">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6234340">}</span><br>
<span class="lineno"></span><span class="op" id="6234342">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="6234345">var</span>&nbsp;<span class="ident" id="6234349">ErrTxDone</span>&nbsp;<span class="op" id="6234359">=</span>&nbsp;<span class="ident" id="6234361">errors</span><span class="op" id="6234367">.</span><span class="ident" id="6234368">New</span><span class="op" id="6234371">(</span><span class="string" id="6234372">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="6234432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6234435">func</span>&nbsp;<span class="op" id="6234440">(</span><span class="ident" id="6234441">tx</span>&nbsp;<span class="op" id="6234444">*</span><span class="ident" id="6234445">Tx</span><span class="op" id="6234447">)</span>&nbsp;<span class="builtinfunc" id="6234449">close</span><span class="op" id="6234454">(</span><span class="op" id="6234455">)</span>&nbsp;<span class="op" id="6234457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234460">if</span>&nbsp;<span class="ident" id="6234463">tx</span><span class="op" id="6234465">.</span><span class="ident" id="6234466">done</span>&nbsp;<span class="op" id="6234471">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6234475">panic</span><span class="op" id="6234480">(</span><span class="string" id="6234481">&#34;double&nbsp;close&#34;</span><span class="op" id="6234495">)</span>&nbsp;<span class="comment" id="6234497">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6234516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234519">tx</span><span class="op" id="6234521">.</span><span class="ident" id="6234522">done</span>&nbsp;<span class="op" id="6234527">=</span>&nbsp;<span class="builtintype" id="6234529">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234535">tx</span><span class="op" id="6234537">.</span><span class="ident" id="6234538">db</span><span class="op" id="6234540">.</span><span class="ident" id="6234541">putConn</span><span class="op" id="6234548">(</span><span class="ident" id="6234549">tx</span><span class="op" id="6234551">.</span><span class="ident" id="6234552">dc</span><span class="op" id="6234554">,</span>&nbsp;<span class="ident" id="6234556">nil</span><span class="op" id="6234559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234562">tx</span><span class="op" id="6234564">.</span><span class="ident" id="6234565">dc</span>&nbsp;<span class="op" id="6234568">=</span>&nbsp;<span class="ident" id="6234570">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234575">tx</span><span class="op" id="6234577">.</span><span class="ident" id="6234578">txi</span>&nbsp;<span class="op" id="6234582">=</span>&nbsp;<span class="ident" id="6234584">nil</span><br>
<span class="lineno"></span><span class="op" id="6234588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6234591">func</span>&nbsp;<span class="op" id="6234596">(</span><span class="ident" id="6234597">tx</span>&nbsp;<span class="op" id="6234600">*</span><span class="ident" id="6234601">Tx</span><span class="op" id="6234603">)</span>&nbsp;<span class="ident" id="6234605">grabConn</span><span class="op" id="6234613">(</span><span class="op" id="6234614">)</span>&nbsp;<span class="op" id="6234616">(</span><span class="op" id="6234617">*</span><span class="ident" id="6234618">driverConn</span><span class="op" id="6234628">,</span>&nbsp;<span class="builtintype" id="6234630">error</span><span class="op" id="6234635">)</span>&nbsp;<span class="op" id="6234637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234640">if</span>&nbsp;<span class="ident" id="6234643">tx</span><span class="op" id="6234645">.</span><span class="ident" id="6234646">done</span>&nbsp;<span class="op" id="6234651">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234655">return</span>&nbsp;<span class="ident" id="6234662">nil</span><span class="op" id="6234665">,</span>&nbsp;<span class="ident" id="6234667">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6234678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234681">return</span>&nbsp;<span class="ident" id="6234688">tx</span><span class="op" id="6234690">.</span><span class="ident" id="6234691">dc</span><span class="op" id="6234693">,</span>&nbsp;<span class="ident" id="6234695">nil</span><br>
<span class="lineno"></span><span class="op" id="6234699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="6234702">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="6234753">func</span>&nbsp;<span class="op" id="6234758">(</span><span class="ident" id="6234759">tx</span>&nbsp;<span class="op" id="6234762">*</span><span class="ident" id="6234763">Tx</span><span class="op" id="6234765">)</span>&nbsp;<span class="ident" id="6234767">closePrepared</span><span class="op" id="6234780">(</span><span class="op" id="6234781">)</span>&nbsp;<span class="op" id="6234783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234786">tx</span><span class="op" id="6234788">.</span><span class="ident" id="6234789">stmts</span><span class="op" id="6234794">.</span><span class="ident" id="6234795">Lock</span><span class="op" id="6234799">(</span><span class="op" id="6234800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234803">for</span>&nbsp;<span class="ident" id="6234807">_</span><span class="op" id="6234808">,</span>&nbsp;<span class="ident" id="6234810">stmt</span>&nbsp;<span class="op" id="6234815">:=</span>&nbsp;<span class="keyword" id="6234818">range</span>&nbsp;<span class="ident" id="6234824">tx</span><span class="op" id="6234826">.</span><span class="ident" id="6234827">stmts</span><span class="op" id="6234832">.</span><span class="ident" id="6234833">v</span>&nbsp;<span class="op" id="6234835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234839">stmt</span><span class="op" id="6234843">.</span><span class="ident" id="6234844">Close</span><span class="op" id="6234849">(</span><span class="op" id="6234850">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6234853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234856">tx</span><span class="op" id="6234858">.</span><span class="ident" id="6234859">stmts</span><span class="op" id="6234864">.</span><span class="ident" id="6234865">Unlock</span><span class="op" id="6234871">(</span><span class="op" id="6234872">)</span><br>
<span class="lineno"></span><span class="op" id="6234874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6234877">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="6234912">func</span>&nbsp;<span class="op" id="6234917">(</span><span class="ident" id="6234918">tx</span>&nbsp;<span class="op" id="6234921">*</span><span class="ident" id="6234922">Tx</span><span class="op" id="6234924">)</span>&nbsp;<span class="ident" id="6234926">Commit</span><span class="op" id="6234932">(</span><span class="op" id="6234933">)</span>&nbsp;<span class="builtintype" id="6234935">error</span>&nbsp;<span class="op" id="6234941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234944">if</span>&nbsp;<span class="ident" id="6234947">tx</span><span class="op" id="6234949">.</span><span class="ident" id="6234950">done</span>&nbsp;<span class="op" id="6234955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234959">return</span>&nbsp;<span class="ident" id="6234966">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6234977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6234980">defer</span>&nbsp;<span class="ident" id="6234986">tx</span><span class="op" id="6234988">.</span><span class="builtinfunc" id="6234989">close</span><span class="op" id="6234994">(</span><span class="op" id="6234995">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6234998">tx</span><span class="op" id="6235000">.</span><span class="ident" id="6235001">dc</span><span class="op" id="6235003">.</span><span class="ident" id="6235004">Lock</span><span class="op" id="6235008">(</span><span class="op" id="6235009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235012">err</span>&nbsp;<span class="op" id="6235016">:=</span>&nbsp;<span class="ident" id="6235019">tx</span><span class="op" id="6235021">.</span><span class="ident" id="6235022">txi</span><span class="op" id="6235025">.</span><span class="ident" id="6235026">Commit</span><span class="op" id="6235032">(</span><span class="op" id="6235033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235036">tx</span><span class="op" id="6235038">.</span><span class="ident" id="6235039">dc</span><span class="op" id="6235041">.</span><span class="ident" id="6235042">Unlock</span><span class="op" id="6235048">(</span><span class="op" id="6235049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235052">if</span>&nbsp;<span class="ident" id="6235055">err</span>&nbsp;<span class="op" id="6235059">!=</span>&nbsp;<span class="ident" id="6235062">driver</span><span class="op" id="6235068">.</span><span class="ident" id="6235069">ErrBadConn</span>&nbsp;<span class="op" id="6235080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235084">tx</span><span class="op" id="6235086">.</span><span class="ident" id="6235087">closePrepared</span><span class="op" id="6235100">(</span><span class="op" id="6235101">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6235104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235107">return</span>&nbsp;<span class="ident" id="6235114">err</span><br>
<span class="lineno"></span><span class="op" id="6235118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6235121">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="6235157">func</span>&nbsp;<span class="op" id="6235162">(</span><span class="ident" id="6235163">tx</span>&nbsp;<span class="op" id="6235166">*</span><span class="ident" id="6235167">Tx</span><span class="op" id="6235169">)</span>&nbsp;<span class="ident" id="6235171">Rollback</span><span class="op" id="6235179">(</span><span class="op" id="6235180">)</span>&nbsp;<span class="builtintype" id="6235182">error</span>&nbsp;<span class="op" id="6235188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235191">if</span>&nbsp;<span class="ident" id="6235194">tx</span><span class="op" id="6235196">.</span><span class="ident" id="6235197">done</span>&nbsp;<span class="op" id="6235202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235206">return</span>&nbsp;<span class="ident" id="6235213">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6235224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235227">defer</span>&nbsp;<span class="ident" id="6235233">tx</span><span class="op" id="6235235">.</span><span class="builtinfunc" id="6235236">close</span><span class="op" id="6235241">(</span><span class="op" id="6235242">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235245">tx</span><span class="op" id="6235247">.</span><span class="ident" id="6235248">dc</span><span class="op" id="6235250">.</span><span class="ident" id="6235251">Lock</span><span class="op" id="6235255">(</span><span class="op" id="6235256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235259">err</span>&nbsp;<span class="op" id="6235263">:=</span>&nbsp;<span class="ident" id="6235266">tx</span><span class="op" id="6235268">.</span><span class="ident" id="6235269">txi</span><span class="op" id="6235272">.</span><span class="ident" id="6235273">Rollback</span><span class="op" id="6235281">(</span><span class="op" id="6235282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235285">tx</span><span class="op" id="6235287">.</span><span class="ident" id="6235288">dc</span><span class="op" id="6235290">.</span><span class="ident" id="6235291">Unlock</span><span class="op" id="6235297">(</span><span class="op" id="6235298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235301">if</span>&nbsp;<span class="ident" id="6235304">err</span>&nbsp;<span class="op" id="6235308">!=</span>&nbsp;<span class="ident" id="6235311">driver</span><span class="op" id="6235317">.</span><span class="ident" id="6235318">ErrBadConn</span>&nbsp;<span class="op" id="6235329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6235333">tx</span><span class="op" id="6235335">.</span><span class="ident" id="6235336">closePrepared</span><span class="op" id="6235349">(</span><span class="op" id="6235350">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6235353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6235356">return</span>&nbsp;<span class="ident" id="6235363">err</span><br>
<span class="lineno"></span><span class="op" id="6235367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6235370">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="6235440">//</span><br>
<span class="lineno"></span><span class="comment" id="6235443">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="6235519">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="6235586">//</span><br>
<span class="lineno"></span><span class="comment" id="6235589">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="6235664">func</span>&nbsp;<span class="op" id="6235669">(</span><span class="ident" id="6235670">tx</span>&nbsp;<span class="op" id="6235673">*</span><span class="ident" id="6235674">Tx</span><span class="op" id="6235676">)</span>&nbsp;<span class="ident" id="6235678">Prepare</span><span class="op" id="6235685">(</span><span class="ident" id="6235686">query</span>&nbsp;<span class="builtintype" id="6235692">string</span><span class="op" id="6235698">)</span>&nbsp;<span class="op" id="6235700">(</span><span class="op" id="6235701">*</span><span class="ident" id="6235702">Stmt</span><span class="op" id="6235706">,</span>&nbsp;<span class="builtintype" id="6235708">error</span><span class="op" id="6235713">)</span>&nbsp;<span class="op" id="6235715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6235718">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6235781">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6235839">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6235903">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6235966">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236022">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236083">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236145">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236204">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236264">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236324">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236383">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6236447">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236488">dc</span><span class="op" id="6236490">,</span>&nbsp;<span class="ident" id="6236492">err</span>&nbsp;<span class="op" id="6236496">:=</span>&nbsp;<span class="ident" id="6236499">tx</span><span class="op" id="6236501">.</span><span class="ident" id="6236502">grabConn</span><span class="op" id="6236510">(</span><span class="op" id="6236511">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6236514">if</span>&nbsp;<span class="ident" id="6236517">err</span>&nbsp;<span class="op" id="6236521">!=</span>&nbsp;<span class="ident" id="6236524">nil</span>&nbsp;<span class="op" id="6236528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6236532">return</span>&nbsp;<span class="ident" id="6236539">nil</span><span class="op" id="6236542">,</span>&nbsp;<span class="ident" id="6236544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6236549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236553">dc</span><span class="op" id="6236555">.</span><span class="ident" id="6236556">Lock</span><span class="op" id="6236560">(</span><span class="op" id="6236561">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236564">si</span><span class="op" id="6236566">,</span>&nbsp;<span class="ident" id="6236568">err</span>&nbsp;<span class="op" id="6236572">:=</span>&nbsp;<span class="ident" id="6236575">dc</span><span class="op" id="6236577">.</span><span class="ident" id="6236578">ci</span><span class="op" id="6236580">.</span><span class="ident" id="6236581">Prepare</span><span class="op" id="6236588">(</span><span class="ident" id="6236589">query</span><span class="op" id="6236594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236597">dc</span><span class="op" id="6236599">.</span><span class="ident" id="6236600">Unlock</span><span class="op" id="6236606">(</span><span class="op" id="6236607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6236610">if</span>&nbsp;<span class="ident" id="6236613">err</span>&nbsp;<span class="op" id="6236617">!=</span>&nbsp;<span class="ident" id="6236620">nil</span>&nbsp;<span class="op" id="6236624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6236628">return</span>&nbsp;<span class="ident" id="6236635">nil</span><span class="op" id="6236638">,</span>&nbsp;<span class="ident" id="6236640">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6236645">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236649">stmt</span>&nbsp;<span class="op" id="6236654">:=</span>&nbsp;<span class="op" id="6236657">&amp;</span><span class="ident" id="6236658">Stmt</span><span class="op" id="6236662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236666">db</span><span class="op" id="6236668">:</span>&nbsp;<span class="ident" id="6236670">tx</span><span class="op" id="6236672">.</span><span class="ident" id="6236673">db</span><span class="op" id="6236675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236679">tx</span><span class="op" id="6236681">:</span>&nbsp;<span class="ident" id="6236683">tx</span><span class="op" id="6236685">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236689">txsi</span><span class="op" id="6236693">:</span>&nbsp;<span class="op" id="6236695">&amp;</span><span class="ident" id="6236696">driverStmt</span><span class="op" id="6236706">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236711">Locker</span><span class="op" id="6236717">:</span>&nbsp;<span class="ident" id="6236719">dc</span><span class="op" id="6236721">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236726">si</span><span class="op" id="6236728">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236734">si</span><span class="op" id="6236736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6236740">}</span><span class="op" id="6236741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236745">query</span><span class="op" id="6236750">:</span>&nbsp;<span class="ident" id="6236752">query</span><span class="op" id="6236757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6236760">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236763">tx</span><span class="op" id="6236765">.</span><span class="ident" id="6236766">stmts</span><span class="op" id="6236771">.</span><span class="ident" id="6236772">Lock</span><span class="op" id="6236776">(</span><span class="op" id="6236777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236780">tx</span><span class="op" id="6236782">.</span><span class="ident" id="6236783">stmts</span><span class="op" id="6236788">.</span><span class="ident" id="6236789">v</span>&nbsp;<span class="op" id="6236791">=</span>&nbsp;<span class="builtinfunc" id="6236793">append</span><span class="op" id="6236799">(</span><span class="ident" id="6236800">tx</span><span class="op" id="6236802">.</span><span class="ident" id="6236803">stmts</span><span class="op" id="6236808">.</span><span class="ident" id="6236809">v</span><span class="op" id="6236810">,</span>&nbsp;<span class="ident" id="6236812">stmt</span><span class="op" id="6236816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6236819">tx</span><span class="op" id="6236821">.</span><span class="ident" id="6236822">stmts</span><span class="op" id="6236827">.</span><span class="ident" id="6236828">Unlock</span><span class="op" id="6236834">(</span><span class="op" id="6236835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6236838">return</span>&nbsp;<span class="ident" id="6236845">stmt</span><span class="op" id="6236849">,</span>&nbsp;<span class="ident" id="6236851">nil</span><br>
<span class="lineno"></span><span class="op" id="6236855">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="6236858">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="6236921">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="6236947">//</span><br>
<span class="lineno"></span><span class="comment" id="6236950">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="6236962">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6237044">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6237052">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="6237078">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6237086">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="6237146">func</span>&nbsp;<span class="op" id="6237151">(</span><span class="ident" id="6237152">tx</span>&nbsp;<span class="op" id="6237155">*</span><span class="ident" id="6237156">Tx</span><span class="op" id="6237158">)</span>&nbsp;<span class="ident" id="6237160">Stmt</span><span class="op" id="6237164">(</span><span class="ident" id="6237165">stmt</span>&nbsp;<span class="op" id="6237170">*</span><span class="ident" id="6237171">Stmt</span><span class="op" id="6237175">)</span>&nbsp;<span class="op" id="6237177">*</span><span class="ident" id="6237178">Stmt</span>&nbsp;<span class="op" id="6237183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6237186">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6237248">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6237311">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6237366">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6237421">if</span>&nbsp;<span class="ident" id="6237424">tx</span><span class="op" id="6237426">.</span><span class="ident" id="6237427">db</span>&nbsp;<span class="op" id="6237430">!=</span>&nbsp;<span class="ident" id="6237433">stmt</span><span class="op" id="6237437">.</span><span class="ident" id="6237438">db</span>&nbsp;<span class="op" id="6237441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6237445">return</span>&nbsp;<span class="op" id="6237452">&amp;</span><span class="ident" id="6237453">Stmt</span><span class="op" id="6237457">{</span><span class="ident" id="6237458">stickyErr</span><span class="op" id="6237467">:</span>&nbsp;<span class="ident" id="6237469">errors</span><span class="op" id="6237475">.</span><span class="ident" id="6237476">New</span><span class="op" id="6237479">(</span><span class="string" id="6237480">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="6237534">)</span><span class="op" id="6237535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6237538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237541">dc</span><span class="op" id="6237543">,</span>&nbsp;<span class="ident" id="6237545">err</span>&nbsp;<span class="op" id="6237549">:=</span>&nbsp;<span class="ident" id="6237552">tx</span><span class="op" id="6237554">.</span><span class="ident" id="6237555">grabConn</span><span class="op" id="6237563">(</span><span class="op" id="6237564">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6237567">if</span>&nbsp;<span class="ident" id="6237570">err</span>&nbsp;<span class="op" id="6237574">!=</span>&nbsp;<span class="ident" id="6237577">nil</span>&nbsp;<span class="op" id="6237581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6237585">return</span>&nbsp;<span class="op" id="6237592">&amp;</span><span class="ident" id="6237593">Stmt</span><span class="op" id="6237597">{</span><span class="ident" id="6237598">stickyErr</span><span class="op" id="6237607">:</span>&nbsp;<span class="ident" id="6237609">err</span><span class="op" id="6237612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6237615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237618">dc</span><span class="op" id="6237620">.</span><span class="ident" id="6237621">Lock</span><span class="op" id="6237625">(</span><span class="op" id="6237626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237629">si</span><span class="op" id="6237631">,</span>&nbsp;<span class="ident" id="6237633">err</span>&nbsp;<span class="op" id="6237637">:=</span>&nbsp;<span class="ident" id="6237640">dc</span><span class="op" id="6237642">.</span><span class="ident" id="6237643">ci</span><span class="op" id="6237645">.</span><span class="ident" id="6237646">Prepare</span><span class="op" id="6237653">(</span><span class="ident" id="6237654">stmt</span><span class="op" id="6237658">.</span><span class="ident" id="6237659">query</span><span class="op" id="6237664">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237667">dc</span><span class="op" id="6237669">.</span><span class="ident" id="6237670">Unlock</span><span class="op" id="6237676">(</span><span class="op" id="6237677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237680">txs</span>&nbsp;<span class="op" id="6237684">:=</span>&nbsp;<span class="op" id="6237687">&amp;</span><span class="ident" id="6237688">Stmt</span><span class="op" id="6237692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237696">db</span><span class="op" id="6237698">:</span>&nbsp;<span class="ident" id="6237700">tx</span><span class="op" id="6237702">.</span><span class="ident" id="6237703">db</span><span class="op" id="6237705">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237709">tx</span><span class="op" id="6237711">:</span>&nbsp;<span class="ident" id="6237713">tx</span><span class="op" id="6237715">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237719">txsi</span><span class="op" id="6237723">:</span>&nbsp;<span class="op" id="6237725">&amp;</span><span class="ident" id="6237726">driverStmt</span><span class="op" id="6237736">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237741">Locker</span><span class="op" id="6237747">:</span>&nbsp;<span class="ident" id="6237749">dc</span><span class="op" id="6237751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237756">si</span><span class="op" id="6237758">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237764">si</span><span class="op" id="6237766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6237770">}</span><span class="op" id="6237771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237775">query</span><span class="op" id="6237780">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237786">stmt</span><span class="op" id="6237790">.</span><span class="ident" id="6237791">query</span><span class="op" id="6237796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237800">stickyErr</span><span class="op" id="6237809">:</span>&nbsp;<span class="ident" id="6237811">err</span><span class="op" id="6237814">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6237817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237820">tx</span><span class="op" id="6237822">.</span><span class="ident" id="6237823">stmts</span><span class="op" id="6237828">.</span><span class="ident" id="6237829">Lock</span><span class="op" id="6237833">(</span><span class="op" id="6237834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237837">tx</span><span class="op" id="6237839">.</span><span class="ident" id="6237840">stmts</span><span class="op" id="6237845">.</span><span class="ident" id="6237846">v</span>&nbsp;<span class="op" id="6237848">=</span>&nbsp;<span class="builtinfunc" id="6237850">append</span><span class="op" id="6237856">(</span><span class="ident" id="6237857">tx</span><span class="op" id="6237859">.</span><span class="ident" id="6237860">stmts</span><span class="op" id="6237865">.</span><span class="ident" id="6237866">v</span><span class="op" id="6237867">,</span>&nbsp;<span class="ident" id="6237869">txs</span><span class="op" id="6237872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6237875">tx</span><span class="op" id="6237877">.</span><span class="ident" id="6237878">stmts</span><span class="op" id="6237883">.</span><span class="ident" id="6237884">Unlock</span><span class="op" id="6237890">(</span><span class="op" id="6237891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6237894">return</span>&nbsp;<span class="ident" id="6237901">txs</span><br>
<span class="lineno">1215</span><span class="op" id="6237905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6237908">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="6237959">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="6237997">func</span>&nbsp;<span class="op" id="6238002">(</span><span class="ident" id="6238003">tx</span>&nbsp;<span class="op" id="6238006">*</span><span class="ident" id="6238007">Tx</span><span class="op" id="6238009">)</span>&nbsp;<span class="ident" id="6238011">Exec</span><span class="op" id="6238015">(</span><span class="ident" id="6238016">query</span>&nbsp;<span class="builtintype" id="6238022">string</span><span class="op" id="6238028">,</span>&nbsp;<span class="ident" id="6238030">args</span>&nbsp;<span class="op" id="6238035">...</span><span class="keyword" id="6238038">interface</span><span class="op" id="6238047">{</span><span class="op" id="6238048">}</span><span class="op" id="6238049">)</span>&nbsp;<span class="op" id="6238051">(</span><span class="ident" id="6238052">Result</span><span class="op" id="6238058">,</span>&nbsp;<span class="builtintype" id="6238060">error</span><span class="op" id="6238065">)</span>&nbsp;<span class="op" id="6238067">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238070">dc</span><span class="op" id="6238072">,</span>&nbsp;<span class="ident" id="6238074">err</span>&nbsp;<span class="op" id="6238078">:=</span>&nbsp;<span class="ident" id="6238081">tx</span><span class="op" id="6238083">.</span><span class="ident" id="6238084">grabConn</span><span class="op" id="6238092">(</span><span class="op" id="6238093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238096">if</span>&nbsp;<span class="ident" id="6238099">err</span>&nbsp;<span class="op" id="6238103">!=</span>&nbsp;<span class="ident" id="6238106">nil</span>&nbsp;<span class="op" id="6238110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238114">return</span>&nbsp;<span class="ident" id="6238121">nil</span><span class="op" id="6238124">,</span>&nbsp;<span class="ident" id="6238126">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238135">if</span>&nbsp;<span class="ident" id="6238138">execer</span><span class="op" id="6238144">,</span>&nbsp;<span class="ident" id="6238146">ok</span>&nbsp;<span class="op" id="6238149">:=</span>&nbsp;<span class="ident" id="6238152">dc</span><span class="op" id="6238154">.</span><span class="ident" id="6238155">ci</span><span class="op" id="6238157">.</span><span class="op" id="6238158">(</span><span class="ident" id="6238159">driver</span><span class="op" id="6238165">.</span><span class="ident" id="6238166">Execer</span><span class="op" id="6238172">)</span><span class="op" id="6238173">;</span>&nbsp;<span class="ident" id="6238175">ok</span>&nbsp;<span class="op" id="6238178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238182">dargs</span><span class="op" id="6238187">,</span>&nbsp;<span class="ident" id="6238189">err</span>&nbsp;<span class="op" id="6238193">:=</span>&nbsp;<span class="ident" id="6238196">driverArgs</span><span class="op" id="6238206">(</span><span class="ident" id="6238207">nil</span><span class="op" id="6238210">,</span>&nbsp;<span class="ident" id="6238212">args</span><span class="op" id="6238216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238220">if</span>&nbsp;<span class="ident" id="6238223">err</span>&nbsp;<span class="op" id="6238227">!=</span>&nbsp;<span class="ident" id="6238230">nil</span>&nbsp;<span class="op" id="6238234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238239">return</span>&nbsp;<span class="ident" id="6238246">nil</span><span class="op" id="6238249">,</span>&nbsp;<span class="ident" id="6238251">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238257">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238261">dc</span><span class="op" id="6238263">.</span><span class="ident" id="6238264">Lock</span><span class="op" id="6238268">(</span><span class="op" id="6238269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238273">resi</span><span class="op" id="6238277">,</span>&nbsp;<span class="ident" id="6238279">err</span>&nbsp;<span class="op" id="6238283">:=</span>&nbsp;<span class="ident" id="6238286">execer</span><span class="op" id="6238292">.</span><span class="ident" id="6238293">Exec</span><span class="op" id="6238297">(</span><span class="ident" id="6238298">query</span><span class="op" id="6238303">,</span>&nbsp;<span class="ident" id="6238305">dargs</span><span class="op" id="6238310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238314">dc</span><span class="op" id="6238316">.</span><span class="ident" id="6238317">Unlock</span><span class="op" id="6238323">(</span><span class="op" id="6238324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238328">if</span>&nbsp;<span class="ident" id="6238331">err</span>&nbsp;<span class="op" id="6238335">==</span>&nbsp;<span class="ident" id="6238338">nil</span>&nbsp;<span class="op" id="6238342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238347">return</span>&nbsp;<span class="ident" id="6238354">driverResult</span><span class="op" id="6238366">{</span><span class="ident" id="6238367">dc</span><span class="op" id="6238369">,</span>&nbsp;<span class="ident" id="6238371">resi</span><span class="op" id="6238375">}</span><span class="op" id="6238376">,</span>&nbsp;<span class="ident" id="6238378">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238388">if</span>&nbsp;<span class="ident" id="6238391">err</span>&nbsp;<span class="op" id="6238395">!=</span>&nbsp;<span class="ident" id="6238398">driver</span><span class="op" id="6238404">.</span><span class="ident" id="6238405">ErrSkip</span>&nbsp;<span class="op" id="6238413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238418">return</span>&nbsp;<span class="ident" id="6238425">nil</span><span class="op" id="6238428">,</span>&nbsp;<span class="ident" id="6238430">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238439">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238443">dc</span><span class="op" id="6238445">.</span><span class="ident" id="6238446">Lock</span><span class="op" id="6238450">(</span><span class="op" id="6238451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238454">si</span><span class="op" id="6238456">,</span>&nbsp;<span class="ident" id="6238458">err</span>&nbsp;<span class="op" id="6238462">:=</span>&nbsp;<span class="ident" id="6238465">dc</span><span class="op" id="6238467">.</span><span class="ident" id="6238468">ci</span><span class="op" id="6238470">.</span><span class="ident" id="6238471">Prepare</span><span class="op" id="6238478">(</span><span class="ident" id="6238479">query</span><span class="op" id="6238484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238487">dc</span><span class="op" id="6238489">.</span><span class="ident" id="6238490">Unlock</span><span class="op" id="6238496">(</span><span class="op" id="6238497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238500">if</span>&nbsp;<span class="ident" id="6238503">err</span>&nbsp;<span class="op" id="6238507">!=</span>&nbsp;<span class="ident" id="6238510">nil</span>&nbsp;<span class="op" id="6238514">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238518">return</span>&nbsp;<span class="ident" id="6238525">nil</span><span class="op" id="6238528">,</span>&nbsp;<span class="ident" id="6238530">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238538">defer</span>&nbsp;<span class="ident" id="6238544">withLock</span><span class="op" id="6238552">(</span><span class="ident" id="6238553">dc</span><span class="op" id="6238555">,</span>&nbsp;<span class="keyword" id="6238557">func</span><span class="op" id="6238561">(</span><span class="op" id="6238562">)</span>&nbsp;<span class="op" id="6238564">{</span>&nbsp;<span class="ident" id="6238566">si</span><span class="op" id="6238568">.</span><span class="ident" id="6238569">Close</span><span class="op" id="6238574">(</span><span class="op" id="6238575">)</span>&nbsp;<span class="op" id="6238577">}</span><span class="op" id="6238578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238582">return</span>&nbsp;<span class="ident" id="6238589">resultFromStatement</span><span class="op" id="6238608">(</span><span class="ident" id="6238609">driverStmt</span><span class="op" id="6238619">{</span><span class="ident" id="6238620">dc</span><span class="op" id="6238622">,</span>&nbsp;<span class="ident" id="6238624">si</span><span class="op" id="6238626">}</span><span class="op" id="6238627">,</span>&nbsp;<span class="ident" id="6238629">args</span><span class="op" id="6238633">...</span><span class="op" id="6238636">)</span><br>
<span class="lineno">1250</span><span class="op" id="6238638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6238641">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="6238706">func</span>&nbsp;<span class="op" id="6238711">(</span><span class="ident" id="6238712">tx</span>&nbsp;<span class="op" id="6238715">*</span><span class="ident" id="6238716">Tx</span><span class="op" id="6238718">)</span>&nbsp;<span class="ident" id="6238720">Query</span><span class="op" id="6238725">(</span><span class="ident" id="6238726">query</span>&nbsp;<span class="builtintype" id="6238732">string</span><span class="op" id="6238738">,</span>&nbsp;<span class="ident" id="6238740">args</span>&nbsp;<span class="op" id="6238745">...</span><span class="keyword" id="6238748">interface</span><span class="op" id="6238757">{</span><span class="op" id="6238758">}</span><span class="op" id="6238759">)</span>&nbsp;<span class="op" id="6238761">(</span><span class="op" id="6238762">*</span><span class="ident" id="6238763">Rows</span><span class="op" id="6238767">,</span>&nbsp;<span class="builtintype" id="6238769">error</span><span class="op" id="6238774">)</span>&nbsp;<span class="op" id="6238776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238779">dc</span><span class="op" id="6238781">,</span>&nbsp;<span class="ident" id="6238783">err</span>&nbsp;<span class="op" id="6238787">:=</span>&nbsp;<span class="ident" id="6238790">tx</span><span class="op" id="6238792">.</span><span class="ident" id="6238793">grabConn</span><span class="op" id="6238801">(</span><span class="op" id="6238802">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238805">if</span>&nbsp;<span class="ident" id="6238808">err</span>&nbsp;<span class="op" id="6238812">!=</span>&nbsp;<span class="ident" id="6238815">nil</span>&nbsp;<span class="op" id="6238819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238823">return</span>&nbsp;<span class="ident" id="6238830">nil</span><span class="op" id="6238833">,</span>&nbsp;<span class="ident" id="6238835">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6238840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6238843">releaseConn</span>&nbsp;<span class="op" id="6238855">:=</span>&nbsp;<span class="keyword" id="6238858">func</span><span class="op" id="6238862">(</span><span class="builtintype" id="6238863">error</span><span class="op" id="6238868">)</span>&nbsp;<span class="op" id="6238870">{</span><span class="op" id="6238871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6238874">return</span>&nbsp;<span class="ident" id="6238881">tx</span><span class="op" id="6238883">.</span><span class="ident" id="6238884">db</span><span class="op" id="6238886">.</span><span class="ident" id="6238887">queryConn</span><span class="op" id="6238896">(</span><span class="ident" id="6238897">dc</span><span class="op" id="6238899">,</span>&nbsp;<span class="ident" id="6238901">releaseConn</span><span class="op" id="6238912">,</span>&nbsp;<span class="ident" id="6238914">query</span><span class="op" id="6238919">,</span>&nbsp;<span class="ident" id="6238921">args</span><span class="op" id="6238925">)</span><br>
<span class="lineno">1260</span><span class="op" id="6238927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6238930">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6239003">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6239072">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="6239104">func</span>&nbsp;<span class="op" id="6239109">(</span><span class="ident" id="6239110">tx</span>&nbsp;<span class="op" id="6239113">*</span><span class="ident" id="6239114">Tx</span><span class="op" id="6239116">)</span>&nbsp;<span class="ident" id="6239118">QueryRow</span><span class="op" id="6239126">(</span><span class="ident" id="6239127">query</span>&nbsp;<span class="builtintype" id="6239133">string</span><span class="op" id="6239139">,</span>&nbsp;<span class="ident" id="6239141">args</span>&nbsp;<span class="op" id="6239146">...</span><span class="keyword" id="6239149">interface</span><span class="op" id="6239158">{</span><span class="op" id="6239159">}</span><span class="op" id="6239160">)</span>&nbsp;<span class="op" id="6239162">*</span><span class="ident" id="6239163">Row</span>&nbsp;<span class="op" id="6239167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239170">rows</span><span class="op" id="6239174">,</span>&nbsp;<span class="ident" id="6239176">err</span>&nbsp;<span class="op" id="6239180">:=</span>&nbsp;<span class="ident" id="6239183">tx</span><span class="op" id="6239185">.</span><span class="ident" id="6239186">Query</span><span class="op" id="6239191">(</span><span class="ident" id="6239192">query</span><span class="op" id="6239197">,</span>&nbsp;<span class="ident" id="6239199">args</span><span class="op" id="6239203">...</span><span class="op" id="6239206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6239209">return</span>&nbsp;<span class="op" id="6239216">&amp;</span><span class="ident" id="6239217">Row</span><span class="op" id="6239220">{</span><span class="ident" id="6239221">rows</span><span class="op" id="6239225">:</span>&nbsp;<span class="ident" id="6239227">rows</span><span class="op" id="6239231">,</span>&nbsp;<span class="ident" id="6239233">err</span><span class="op" id="6239236">:</span>&nbsp;<span class="ident" id="6239238">err</span><span class="op" id="6239241">}</span><br>
<span class="lineno"></span><span class="op" id="6239243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="6239246">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6239310">type</span>&nbsp;<span class="ident" id="6239315">connStmt</span>&nbsp;<span class="keyword" id="6239324">struct</span>&nbsp;<span class="op" id="6239331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239334">dc</span>&nbsp;<span class="op" id="6239337">*</span><span class="ident" id="6239338">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239350">si</span>&nbsp;<span class="ident" id="6239353">driver</span><span class="op" id="6239359">.</span><span class="ident" id="6239360">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6239365">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="6239368">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6239457">type</span>&nbsp;<span class="ident" id="6239462">Stmt</span>&nbsp;<span class="keyword" id="6239467">struct</span>&nbsp;<span class="op" id="6239474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6239477">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239492">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6239502">*</span><span class="ident" id="6239503">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6239509">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239532">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6239542">string</span>&nbsp;<span class="comment" id="6239549">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239575">stickyErr</span>&nbsp;<span class="builtintype" id="6239585">error</span>&nbsp;&nbsp;<span class="comment" id="6239592">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239651">closemu</span>&nbsp;<span class="ident" id="6239659">sync</span><span class="op" id="6239663">.</span><span class="ident" id="6239664">RWMutex</span>&nbsp;<span class="comment" id="6239672">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6239728">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239768">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6239773">*</span><span class="ident" id="6239774">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239778">txsi</span>&nbsp;<span class="op" id="6239783">*</span><span class="ident" id="6239784">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239797">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239804">sync</span><span class="op" id="6239808">.</span><span class="ident" id="6239809">Mutex</span>&nbsp;<span class="comment" id="6239815">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6239851">closed</span>&nbsp;<span class="builtintype" id="6239858">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6239865">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6239925">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6239985">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6240038">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240091">css</span>&nbsp;<span class="op" id="6240095">[</span><span class="op" id="6240096">]</span><span class="ident" id="6240097">connStmt</span><br>
<span class="lineno"></span><span class="op" id="6240106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6240109">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="6240176">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6240237">func</span>&nbsp;<span class="op" id="6240242">(</span><span class="ident" id="6240243">s</span>&nbsp;<span class="op" id="6240245">*</span><span class="ident" id="6240246">Stmt</span><span class="op" id="6240250">)</span>&nbsp;<span class="ident" id="6240252">Exec</span><span class="op" id="6240256">(</span><span class="ident" id="6240257">args</span>&nbsp;<span class="op" id="6240262">...</span><span class="keyword" id="6240265">interface</span><span class="op" id="6240274">{</span><span class="op" id="6240275">}</span><span class="op" id="6240276">)</span>&nbsp;<span class="op" id="6240278">(</span><span class="ident" id="6240279">Result</span><span class="op" id="6240285">,</span>&nbsp;<span class="builtintype" id="6240287">error</span><span class="op" id="6240292">)</span>&nbsp;<span class="op" id="6240294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240297">s</span><span class="op" id="6240298">.</span><span class="ident" id="6240299">closemu</span><span class="op" id="6240306">.</span><span class="ident" id="6240307">RLock</span><span class="op" id="6240312">(</span><span class="op" id="6240313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240316">defer</span>&nbsp;<span class="ident" id="6240322">s</span><span class="op" id="6240323">.</span><span class="ident" id="6240324">closemu</span><span class="op" id="6240331">.</span><span class="ident" id="6240332">RUnlock</span><span class="op" id="6240339">(</span><span class="op" id="6240340">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240344">var</span>&nbsp;<span class="ident" id="6240348">res</span>&nbsp;<span class="ident" id="6240352">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240360">for</span>&nbsp;<span class="ident" id="6240364">i</span>&nbsp;<span class="op" id="6240366">:=</span>&nbsp;<span class="num" id="6240369">0</span><span class="op" id="6240370">;</span>&nbsp;<span class="ident" id="6240372">i</span>&nbsp;<span class="op" id="6240374">&lt;</span>&nbsp;<span class="ident" id="6240376">maxBadConnRetries</span><span class="op" id="6240393">;</span>&nbsp;<span class="ident" id="6240395">i</span><span class="op" id="6240396">++</span>&nbsp;<span class="op" id="6240399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240403">dc</span><span class="op" id="6240405">,</span>&nbsp;<span class="ident" id="6240407">releaseConn</span><span class="op" id="6240418">,</span>&nbsp;<span class="ident" id="6240420">si</span><span class="op" id="6240422">,</span>&nbsp;<span class="ident" id="6240424">err</span>&nbsp;<span class="op" id="6240428">:=</span>&nbsp;<span class="ident" id="6240431">s</span><span class="op" id="6240432">.</span><span class="ident" id="6240433">connStmt</span><span class="op" id="6240441">(</span><span class="op" id="6240442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240446">if</span>&nbsp;<span class="ident" id="6240449">err</span>&nbsp;<span class="op" id="6240453">!=</span>&nbsp;<span class="ident" id="6240456">nil</span>&nbsp;<span class="op" id="6240460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240465">if</span>&nbsp;<span class="ident" id="6240468">err</span>&nbsp;<span class="op" id="6240472">==</span>&nbsp;<span class="ident" id="6240475">driver</span><span class="op" id="6240481">.</span><span class="ident" id="6240482">ErrBadConn</span>&nbsp;<span class="op" id="6240493">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240499">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6240511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240516">return</span>&nbsp;<span class="ident" id="6240523">nil</span><span class="op" id="6240526">,</span>&nbsp;<span class="ident" id="6240528">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6240534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240539">res</span><span class="op" id="6240542">,</span>&nbsp;<span class="ident" id="6240544">err</span>&nbsp;<span class="op" id="6240548">=</span>&nbsp;<span class="ident" id="6240550">resultFromStatement</span><span class="op" id="6240569">(</span><span class="ident" id="6240570">driverStmt</span><span class="op" id="6240580">{</span><span class="ident" id="6240581">dc</span><span class="op" id="6240583">,</span>&nbsp;<span class="ident" id="6240585">si</span><span class="op" id="6240587">}</span><span class="op" id="6240588">,</span>&nbsp;<span class="ident" id="6240590">args</span><span class="op" id="6240594">...</span><span class="op" id="6240597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240601">releaseConn</span><span class="op" id="6240612">(</span><span class="ident" id="6240613">err</span><span class="op" id="6240616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240620">if</span>&nbsp;<span class="ident" id="6240623">err</span>&nbsp;<span class="op" id="6240627">!=</span>&nbsp;<span class="ident" id="6240630">driver</span><span class="op" id="6240636">.</span><span class="ident" id="6240637">ErrBadConn</span>&nbsp;<span class="op" id="6240648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240653">return</span>&nbsp;<span class="ident" id="6240660">res</span><span class="op" id="6240663">,</span>&nbsp;<span class="ident" id="6240665">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6240671">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6240674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6240677">return</span>&nbsp;<span class="ident" id="6240684">nil</span><span class="op" id="6240687">,</span>&nbsp;<span class="ident" id="6240689">driver</span><span class="op" id="6240695">.</span><span class="ident" id="6240696">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6240707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6240710">func</span>&nbsp;<span class="ident" id="6240715">resultFromStatement</span><span class="op" id="6240734">(</span><span class="ident" id="6240735">ds</span>&nbsp;<span class="ident" id="6240738">driverStmt</span><span class="op" id="6240748">,</span>&nbsp;<span class="ident" id="6240750">args</span>&nbsp;<span class="op" id="6240755">...</span><span class="keyword" id="6240758">interface</span><span class="op" id="6240767">{</span><span class="op" id="6240768">}</span><span class="op" id="6240769">)</span>&nbsp;<span class="op" id="6240771">(</span><span class="ident" id="6240772">Result</span><span class="op" id="6240778">,</span>&nbsp;<span class="builtintype" id="6240780">error</span><span class="op" id="6240785">)</span>&nbsp;<span class="op" id="6240787">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240790">ds</span><span class="op" id="6240792">.</span><span class="ident" id="6240793">Lock</span><span class="op" id="6240797">(</span><span class="op" id="6240798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240801">want</span>&nbsp;<span class="op" id="6240806">:=</span>&nbsp;<span class="ident" id="6240809">ds</span><span class="op" id="6240811">.</span><span class="ident" id="6240812">si</span><span class="op" id="6240814">.</span><span class="ident" id="6240815">NumInput</span><span class="op" id="6240823">(</span><span class="op" id="6240824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6240827">ds</span><span class="op" id="6240829">.</span><span class="ident" id="6240830">Unlock</span><span class="op" id="6240836">(</span><span class="op" id="6240837">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6240841">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6240905">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6240979">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241008">if</span>&nbsp;<span class="ident" id="6241011">want</span>&nbsp;<span class="op" id="6241016">!=</span>&nbsp;<span class="op" id="6241019">-</span><span class="num" id="6241020">1</span>&nbsp;<span class="op" id="6241022">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6241025">len</span><span class="op" id="6241028">(</span><span class="ident" id="6241029">args</span><span class="op" id="6241033">)</span>&nbsp;<span class="op" id="6241035">!=</span>&nbsp;<span class="ident" id="6241038">want</span>&nbsp;<span class="op" id="6241043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241047">return</span>&nbsp;<span class="ident" id="6241054">nil</span><span class="op" id="6241057">,</span>&nbsp;<span class="ident" id="6241059">fmt</span><span class="op" id="6241062">.</span><span class="ident" id="6241063">Errorf</span><span class="op" id="6241069">(</span><span class="string" id="6241070">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6241106">,</span>&nbsp;<span class="ident" id="6241108">want</span><span class="op" id="6241112">,</span>&nbsp;<span class="builtinfunc" id="6241114">len</span><span class="op" id="6241117">(</span><span class="ident" id="6241118">args</span><span class="op" id="6241122">)</span><span class="op" id="6241123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6241126">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241130">dargs</span><span class="op" id="6241135">,</span>&nbsp;<span class="ident" id="6241137">err</span>&nbsp;<span class="op" id="6241141">:=</span>&nbsp;<span class="ident" id="6241144">driverArgs</span><span class="op" id="6241154">(</span><span class="op" id="6241155">&amp;</span><span class="ident" id="6241156">ds</span><span class="op" id="6241158">,</span>&nbsp;<span class="ident" id="6241160">args</span><span class="op" id="6241164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241167">if</span>&nbsp;<span class="ident" id="6241170">err</span>&nbsp;<span class="op" id="6241174">!=</span>&nbsp;<span class="ident" id="6241177">nil</span>&nbsp;<span class="op" id="6241181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241185">return</span>&nbsp;<span class="ident" id="6241192">nil</span><span class="op" id="6241195">,</span>&nbsp;<span class="ident" id="6241197">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6241202">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241206">ds</span><span class="op" id="6241208">.</span><span class="ident" id="6241209">Lock</span><span class="op" id="6241213">(</span><span class="op" id="6241214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241217">resi</span><span class="op" id="6241221">,</span>&nbsp;<span class="ident" id="6241223">err</span>&nbsp;<span class="op" id="6241227">:=</span>&nbsp;<span class="ident" id="6241230">ds</span><span class="op" id="6241232">.</span><span class="ident" id="6241233">si</span><span class="op" id="6241235">.</span><span class="ident" id="6241236">Exec</span><span class="op" id="6241240">(</span><span class="ident" id="6241241">dargs</span><span class="op" id="6241246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241249">ds</span><span class="op" id="6241251">.</span><span class="ident" id="6241252">Unlock</span><span class="op" id="6241258">(</span><span class="op" id="6241259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241262">if</span>&nbsp;<span class="ident" id="6241265">err</span>&nbsp;<span class="op" id="6241269">!=</span>&nbsp;<span class="ident" id="6241272">nil</span>&nbsp;<span class="op" id="6241276">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241280">return</span>&nbsp;<span class="ident" id="6241287">nil</span><span class="op" id="6241290">,</span>&nbsp;<span class="ident" id="6241292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6241297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241300">return</span>&nbsp;<span class="ident" id="6241307">driverResult</span><span class="op" id="6241319">{</span><span class="ident" id="6241320">ds</span><span class="op" id="6241322">.</span><span class="ident" id="6241323">Locker</span><span class="op" id="6241329">,</span>&nbsp;<span class="ident" id="6241331">resi</span><span class="op" id="6241335">}</span><span class="op" id="6241336">,</span>&nbsp;<span class="ident" id="6241338">nil</span><br>
<span class="lineno"></span><span class="op" id="6241342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="6241345">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6241414">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6241480">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6241519">func</span>&nbsp;<span class="op" id="6241524">(</span><span class="ident" id="6241525">s</span>&nbsp;<span class="op" id="6241527">*</span><span class="ident" id="6241528">Stmt</span><span class="op" id="6241532">)</span>&nbsp;<span class="ident" id="6241534">connStmt</span><span class="op" id="6241542">(</span><span class="op" id="6241543">)</span>&nbsp;<span class="op" id="6241545">(</span><span class="ident" id="6241546">ci</span>&nbsp;<span class="op" id="6241549">*</span><span class="ident" id="6241550">driverConn</span><span class="op" id="6241560">,</span>&nbsp;<span class="ident" id="6241562">releaseConn</span>&nbsp;<span class="keyword" id="6241574">func</span><span class="op" id="6241578">(</span><span class="builtintype" id="6241579">error</span><span class="op" id="6241584">)</span><span class="op" id="6241585">,</span>&nbsp;<span class="ident" id="6241587">si</span>&nbsp;<span class="ident" id="6241590">driver</span><span class="op" id="6241596">.</span><span class="ident" id="6241597">Stmt</span><span class="op" id="6241601">,</span>&nbsp;<span class="ident" id="6241603">err</span>&nbsp;<span class="builtintype" id="6241607">error</span><span class="op" id="6241612">)</span>&nbsp;<span class="op" id="6241614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241617">if</span>&nbsp;<span class="ident" id="6241620">err</span>&nbsp;<span class="op" id="6241624">=</span>&nbsp;<span class="ident" id="6241626">s</span><span class="op" id="6241627">.</span><span class="ident" id="6241628">stickyErr</span><span class="op" id="6241637">;</span>&nbsp;<span class="ident" id="6241639">err</span>&nbsp;<span class="op" id="6241643">!=</span>&nbsp;<span class="ident" id="6241646">nil</span>&nbsp;<span class="op" id="6241650">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241654">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6241662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241665">s</span><span class="op" id="6241666">.</span><span class="ident" id="6241667">mu</span><span class="op" id="6241669">.</span><span class="ident" id="6241670">Lock</span><span class="op" id="6241674">(</span><span class="op" id="6241675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241678">if</span>&nbsp;<span class="ident" id="6241681">s</span><span class="op" id="6241682">.</span><span class="ident" id="6241683">closed</span>&nbsp;<span class="op" id="6241690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241694">s</span><span class="op" id="6241695">.</span><span class="ident" id="6241696">mu</span><span class="op" id="6241698">.</span><span class="ident" id="6241699">Unlock</span><span class="op" id="6241705">(</span><span class="op" id="6241706">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241710">err</span>&nbsp;<span class="op" id="6241714">=</span>&nbsp;<span class="ident" id="6241716">errors</span><span class="op" id="6241722">.</span><span class="ident" id="6241723">New</span><span class="op" id="6241726">(</span><span class="string" id="6241727">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6241753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241757">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6241765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6241769">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6241829">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241861">if</span>&nbsp;<span class="ident" id="6241864">s</span><span class="op" id="6241865">.</span><span class="ident" id="6241866">tx</span>&nbsp;<span class="op" id="6241869">!=</span>&nbsp;<span class="ident" id="6241872">nil</span>&nbsp;<span class="op" id="6241876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241880">s</span><span class="op" id="6241881">.</span><span class="ident" id="6241882">mu</span><span class="op" id="6241884">.</span><span class="ident" id="6241885">Unlock</span><span class="op" id="6241891">(</span><span class="op" id="6241892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241896">ci</span><span class="op" id="6241898">,</span>&nbsp;<span class="ident" id="6241900">err</span>&nbsp;<span class="op" id="6241904">=</span>&nbsp;<span class="ident" id="6241906">s</span><span class="op" id="6241907">.</span><span class="ident" id="6241908">tx</span><span class="op" id="6241910">.</span><span class="ident" id="6241911">grabConn</span><span class="op" id="6241919">(</span><span class="op" id="6241920">)</span>&nbsp;<span class="comment" id="6241922">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241963">if</span>&nbsp;<span class="ident" id="6241966">err</span>&nbsp;<span class="op" id="6241970">!=</span>&nbsp;<span class="ident" id="6241973">nil</span>&nbsp;<span class="op" id="6241977">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6241982">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6241991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6241995">releaseConn</span>&nbsp;<span class="op" id="6242007">=</span>&nbsp;<span class="keyword" id="6242009">func</span><span class="op" id="6242013">(</span><span class="builtintype" id="6242014">error</span><span class="op" id="6242019">)</span>&nbsp;<span class="op" id="6242021">{</span><span class="op" id="6242022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242026">return</span>&nbsp;<span class="ident" id="6242033">ci</span><span class="op" id="6242035">,</span>&nbsp;<span class="ident" id="6242037">releaseConn</span><span class="op" id="6242048">,</span>&nbsp;<span class="ident" id="6242050">s</span><span class="op" id="6242051">.</span><span class="ident" id="6242052">txsi</span><span class="op" id="6242056">.</span><span class="ident" id="6242057">si</span><span class="op" id="6242059">,</span>&nbsp;<span class="ident" id="6242061">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242066">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242070">for</span>&nbsp;<span class="ident" id="6242074">i</span>&nbsp;<span class="op" id="6242076">:=</span>&nbsp;<span class="num" id="6242079">0</span><span class="op" id="6242080">;</span>&nbsp;<span class="ident" id="6242082">i</span>&nbsp;<span class="op" id="6242084">&lt;</span>&nbsp;<span class="builtinfunc" id="6242086">len</span><span class="op" id="6242089">(</span><span class="ident" id="6242090">s</span><span class="op" id="6242091">.</span><span class="ident" id="6242092">css</span><span class="op" id="6242095">)</span><span class="op" id="6242096">;</span>&nbsp;<span class="ident" id="6242098">i</span><span class="op" id="6242099">++</span>&nbsp;<span class="op" id="6242102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242106">v</span>&nbsp;<span class="op" id="6242108">:=</span>&nbsp;<span class="ident" id="6242111">s</span><span class="op" id="6242112">.</span><span class="ident" id="6242113">css</span><span class="op" id="6242116">[</span><span class="ident" id="6242117">i</span><span class="op" id="6242118">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242122">_</span><span class="op" id="6242123">,</span>&nbsp;<span class="ident" id="6242125">err</span>&nbsp;<span class="op" id="6242129">:=</span>&nbsp;<span class="ident" id="6242132">s</span><span class="op" id="6242133">.</span><span class="ident" id="6242134">db</span><span class="op" id="6242136">.</span><span class="ident" id="6242137">connIfFree</span><span class="op" id="6242147">(</span><span class="ident" id="6242148">v</span><span class="op" id="6242149">.</span><span class="ident" id="6242150">dc</span><span class="op" id="6242152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242156">if</span>&nbsp;<span class="ident" id="6242159">err</span>&nbsp;<span class="op" id="6242163">==</span>&nbsp;<span class="ident" id="6242166">nil</span>&nbsp;<span class="op" id="6242170">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242175">s</span><span class="op" id="6242176">.</span><span class="ident" id="6242177">mu</span><span class="op" id="6242179">.</span><span class="ident" id="6242180">Unlock</span><span class="op" id="6242186">(</span><span class="op" id="6242187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242192">return</span>&nbsp;<span class="ident" id="6242199">v</span><span class="op" id="6242200">.</span><span class="ident" id="6242201">dc</span><span class="op" id="6242203">,</span>&nbsp;<span class="ident" id="6242205">v</span><span class="op" id="6242206">.</span><span class="ident" id="6242207">dc</span><span class="op" id="6242209">.</span><span class="ident" id="6242210">releaseConn</span><span class="op" id="6242221">,</span>&nbsp;<span class="ident" id="6242223">v</span><span class="op" id="6242224">.</span><span class="ident" id="6242225">si</span><span class="op" id="6242227">,</span>&nbsp;<span class="ident" id="6242229">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242239">if</span>&nbsp;<span class="ident" id="6242242">err</span>&nbsp;<span class="op" id="6242246">==</span>&nbsp;<span class="ident" id="6242249">errConnClosed</span>&nbsp;<span class="op" id="6242263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242268">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242317">s</span><span class="op" id="6242318">.</span><span class="ident" id="6242319">css</span><span class="op" id="6242322">[</span><span class="ident" id="6242323">i</span><span class="op" id="6242324">]</span>&nbsp;<span class="op" id="6242326">=</span>&nbsp;<span class="ident" id="6242328">s</span><span class="op" id="6242329">.</span><span class="ident" id="6242330">css</span><span class="op" id="6242333">[</span><span class="builtinfunc" id="6242334">len</span><span class="op" id="6242337">(</span><span class="ident" id="6242338">s</span><span class="op" id="6242339">.</span><span class="ident" id="6242340">css</span><span class="op" id="6242343">)</span><span class="op" id="6242344">-</span><span class="num" id="6242345">1</span><span class="op" id="6242346">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242351">s</span><span class="op" id="6242352">.</span><span class="ident" id="6242353">css</span>&nbsp;<span class="op" id="6242357">=</span>&nbsp;<span class="ident" id="6242359">s</span><span class="op" id="6242360">.</span><span class="ident" id="6242361">css</span><span class="op" id="6242364">[</span><span class="op" id="6242365">:</span><span class="builtinfunc" id="6242366">len</span><span class="op" id="6242369">(</span><span class="ident" id="6242370">s</span><span class="op" id="6242371">.</span><span class="ident" id="6242372">css</span><span class="op" id="6242375">)</span><span class="op" id="6242376">-</span><span class="num" id="6242377">1</span><span class="op" id="6242378">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242383">i</span><span class="op" id="6242384">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242396">s</span><span class="op" id="6242397">.</span><span class="ident" id="6242398">mu</span><span class="op" id="6242400">.</span><span class="ident" id="6242401">Unlock</span><span class="op" id="6242407">(</span><span class="op" id="6242408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242412">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242489">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242563">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242576">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242580">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242649">dc</span><span class="op" id="6242651">,</span>&nbsp;<span class="ident" id="6242653">err</span>&nbsp;<span class="op" id="6242657">:=</span>&nbsp;<span class="ident" id="6242660">s</span><span class="op" id="6242661">.</span><span class="ident" id="6242662">db</span><span class="op" id="6242664">.</span><span class="ident" id="6242665">conn</span><span class="op" id="6242669">(</span><span class="op" id="6242670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242673">if</span>&nbsp;<span class="ident" id="6242676">err</span>&nbsp;<span class="op" id="6242680">!=</span>&nbsp;<span class="ident" id="6242683">nil</span>&nbsp;<span class="op" id="6242687">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242691">return</span>&nbsp;<span class="ident" id="6242698">nil</span><span class="op" id="6242701">,</span>&nbsp;<span class="ident" id="6242703">nil</span><span class="op" id="6242706">,</span>&nbsp;<span class="ident" id="6242708">nil</span><span class="op" id="6242711">,</span>&nbsp;<span class="ident" id="6242713">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242722">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242790">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242850">s</span><span class="op" id="6242851">.</span><span class="ident" id="6242852">mu</span><span class="op" id="6242854">.</span><span class="ident" id="6242855">Lock</span><span class="op" id="6242859">(</span><span class="op" id="6242860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242863">for</span>&nbsp;<span class="ident" id="6242867">_</span><span class="op" id="6242868">,</span>&nbsp;<span class="ident" id="6242870">v</span>&nbsp;<span class="op" id="6242872">:=</span>&nbsp;<span class="keyword" id="6242875">range</span>&nbsp;<span class="ident" id="6242881">s</span><span class="op" id="6242882">.</span><span class="ident" id="6242883">css</span>&nbsp;<span class="op" id="6242887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242891">if</span>&nbsp;<span class="ident" id="6242894">v</span><span class="op" id="6242895">.</span><span class="ident" id="6242896">dc</span>&nbsp;<span class="op" id="6242899">==</span>&nbsp;<span class="ident" id="6242902">dc</span>&nbsp;<span class="op" id="6242905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242910">s</span><span class="op" id="6242911">.</span><span class="ident" id="6242912">mu</span><span class="op" id="6242914">.</span><span class="ident" id="6242915">Unlock</span><span class="op" id="6242921">(</span><span class="op" id="6242922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242927">return</span>&nbsp;<span class="ident" id="6242934">dc</span><span class="op" id="6242936">,</span>&nbsp;<span class="ident" id="6242938">dc</span><span class="op" id="6242940">.</span><span class="ident" id="6242941">releaseConn</span><span class="op" id="6242952">,</span>&nbsp;<span class="ident" id="6242954">v</span><span class="op" id="6242955">.</span><span class="ident" id="6242956">si</span><span class="op" id="6242958">,</span>&nbsp;<span class="ident" id="6242960">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242972">s</span><span class="op" id="6242973">.</span><span class="ident" id="6242974">mu</span><span class="op" id="6242976">.</span><span class="ident" id="6242977">Unlock</span><span class="op" id="6242983">(</span><span class="op" id="6242984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6242988">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243053">dc</span><span class="op" id="6243055">.</span><span class="ident" id="6243056">Lock</span><span class="op" id="6243060">(</span><span class="op" id="6243061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243064">si</span><span class="op" id="6243066">,</span>&nbsp;<span class="ident" id="6243068">err</span>&nbsp;<span class="op" id="6243072">=</span>&nbsp;<span class="ident" id="6243074">dc</span><span class="op" id="6243076">.</span><span class="ident" id="6243077">prepareLocked</span><span class="op" id="6243090">(</span><span class="ident" id="6243091">s</span><span class="op" id="6243092">.</span><span class="ident" id="6243093">query</span><span class="op" id="6243098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243101">dc</span><span class="op" id="6243103">.</span><span class="ident" id="6243104">Unlock</span><span class="op" id="6243110">(</span><span class="op" id="6243111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243114">if</span>&nbsp;<span class="ident" id="6243117">err</span>&nbsp;<span class="op" id="6243121">!=</span>&nbsp;<span class="ident" id="6243124">nil</span>&nbsp;<span class="op" id="6243128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243132">s</span><span class="op" id="6243133">.</span><span class="ident" id="6243134">db</span><span class="op" id="6243136">.</span><span class="ident" id="6243137">putConn</span><span class="op" id="6243144">(</span><span class="ident" id="6243145">dc</span><span class="op" id="6243147">,</span>&nbsp;<span class="ident" id="6243149">err</span><span class="op" id="6243152">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243156">return</span>&nbsp;<span class="ident" id="6243163">nil</span><span class="op" id="6243166">,</span>&nbsp;<span class="ident" id="6243168">nil</span><span class="op" id="6243171">,</span>&nbsp;<span class="ident" id="6243173">nil</span><span class="op" id="6243176">,</span>&nbsp;<span class="ident" id="6243178">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6243183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243186">s</span><span class="op" id="6243187">.</span><span class="ident" id="6243188">mu</span><span class="op" id="6243190">.</span><span class="ident" id="6243191">Lock</span><span class="op" id="6243195">(</span><span class="op" id="6243196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243199">cs</span>&nbsp;<span class="op" id="6243202">:=</span>&nbsp;<span class="ident" id="6243205">connStmt</span><span class="op" id="6243213">{</span><span class="ident" id="6243214">dc</span><span class="op" id="6243216">,</span>&nbsp;<span class="ident" id="6243218">si</span><span class="op" id="6243220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243223">s</span><span class="op" id="6243224">.</span><span class="ident" id="6243225">css</span>&nbsp;<span class="op" id="6243229">=</span>&nbsp;<span class="builtinfunc" id="6243231">append</span><span class="op" id="6243237">(</span><span class="ident" id="6243238">s</span><span class="op" id="6243239">.</span><span class="ident" id="6243240">css</span><span class="op" id="6243243">,</span>&nbsp;<span class="ident" id="6243245">cs</span><span class="op" id="6243247">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243250">s</span><span class="op" id="6243251">.</span><span class="ident" id="6243252">mu</span><span class="op" id="6243254">.</span><span class="ident" id="6243255">Unlock</span><span class="op" id="6243261">(</span><span class="op" id="6243262">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243266">return</span>&nbsp;<span class="ident" id="6243273">dc</span><span class="op" id="6243275">,</span>&nbsp;<span class="ident" id="6243277">dc</span><span class="op" id="6243279">.</span><span class="ident" id="6243280">releaseConn</span><span class="op" id="6243291">,</span>&nbsp;<span class="ident" id="6243293">si</span><span class="op" id="6243295">,</span>&nbsp;<span class="ident" id="6243297">nil</span><br>
<span class="lineno"></span><span class="op" id="6243301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="6243304">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="6243374">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="6243419">func</span>&nbsp;<span class="op" id="6243424">(</span><span class="ident" id="6243425">s</span>&nbsp;<span class="op" id="6243427">*</span><span class="ident" id="6243428">Stmt</span><span class="op" id="6243432">)</span>&nbsp;<span class="ident" id="6243434">Query</span><span class="op" id="6243439">(</span><span class="ident" id="6243440">args</span>&nbsp;<span class="op" id="6243445">...</span><span class="keyword" id="6243448">interface</span><span class="op" id="6243457">{</span><span class="op" id="6243458">}</span><span class="op" id="6243459">)</span>&nbsp;<span class="op" id="6243461">(</span><span class="op" id="6243462">*</span><span class="ident" id="6243463">Rows</span><span class="op" id="6243467">,</span>&nbsp;<span class="builtintype" id="6243469">error</span><span class="op" id="6243474">)</span>&nbsp;<span class="op" id="6243476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243479">s</span><span class="op" id="6243480">.</span><span class="ident" id="6243481">closemu</span><span class="op" id="6243488">.</span><span class="ident" id="6243489">RLock</span><span class="op" id="6243494">(</span><span class="op" id="6243495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243498">defer</span>&nbsp;<span class="ident" id="6243504">s</span><span class="op" id="6243505">.</span><span class="ident" id="6243506">closemu</span><span class="op" id="6243513">.</span><span class="ident" id="6243514">RUnlock</span><span class="op" id="6243521">(</span><span class="op" id="6243522">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243526">var</span>&nbsp;<span class="ident" id="6243530">rowsi</span>&nbsp;<span class="ident" id="6243536">driver</span><span class="op" id="6243542">.</span><span class="ident" id="6243543">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243549">for</span>&nbsp;<span class="ident" id="6243553">i</span>&nbsp;<span class="op" id="6243555">:=</span>&nbsp;<span class="num" id="6243558">0</span><span class="op" id="6243559">;</span>&nbsp;<span class="ident" id="6243561">i</span>&nbsp;<span class="op" id="6243563">&lt;</span>&nbsp;<span class="ident" id="6243565">maxBadConnRetries</span><span class="op" id="6243582">;</span>&nbsp;<span class="ident" id="6243584">i</span><span class="op" id="6243585">++</span>&nbsp;<span class="op" id="6243588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243592">dc</span><span class="op" id="6243594">,</span>&nbsp;<span class="ident" id="6243596">releaseConn</span><span class="op" id="6243607">,</span>&nbsp;<span class="ident" id="6243609">si</span><span class="op" id="6243611">,</span>&nbsp;<span class="ident" id="6243613">err</span>&nbsp;<span class="op" id="6243617">:=</span>&nbsp;<span class="ident" id="6243620">s</span><span class="op" id="6243621">.</span><span class="ident" id="6243622">connStmt</span><span class="op" id="6243630">(</span><span class="op" id="6243631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243635">if</span>&nbsp;<span class="ident" id="6243638">err</span>&nbsp;<span class="op" id="6243642">!=</span>&nbsp;<span class="ident" id="6243645">nil</span>&nbsp;<span class="op" id="6243649">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243654">if</span>&nbsp;<span class="ident" id="6243657">err</span>&nbsp;<span class="op" id="6243661">==</span>&nbsp;<span class="ident" id="6243664">driver</span><span class="op" id="6243670">.</span><span class="ident" id="6243671">ErrBadConn</span>&nbsp;<span class="op" id="6243682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243688">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6243700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243705">return</span>&nbsp;<span class="ident" id="6243712">nil</span><span class="op" id="6243715">,</span>&nbsp;<span class="ident" id="6243717">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6243723">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243728">rowsi</span><span class="op" id="6243733">,</span>&nbsp;<span class="ident" id="6243735">err</span>&nbsp;<span class="op" id="6243739">=</span>&nbsp;<span class="ident" id="6243741">rowsiFromStatement</span><span class="op" id="6243759">(</span><span class="ident" id="6243760">driverStmt</span><span class="op" id="6243770">{</span><span class="ident" id="6243771">dc</span><span class="op" id="6243773">,</span>&nbsp;<span class="ident" id="6243775">si</span><span class="op" id="6243777">}</span><span class="op" id="6243778">,</span>&nbsp;<span class="ident" id="6243780">args</span><span class="op" id="6243784">...</span><span class="op" id="6243787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6243791">if</span>&nbsp;<span class="ident" id="6243794">err</span>&nbsp;<span class="op" id="6243798">==</span>&nbsp;<span class="ident" id="6243801">nil</span>&nbsp;<span class="op" id="6243805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6243810">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6243871">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243895">rows</span>&nbsp;<span class="op" id="6243900">:=</span>&nbsp;<span class="op" id="6243903">&amp;</span><span class="ident" id="6243904">Rows</span><span class="op" id="6243908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243914">dc</span><span class="op" id="6243916">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243921">dc</span><span class="op" id="6243923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243929">rowsi</span><span class="op" id="6243934">:</span>&nbsp;<span class="ident" id="6243936">rowsi</span><span class="op" id="6243941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6243947">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6243975">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243980">s</span><span class="op" id="6243981">.</span><span class="ident" id="6243982">db</span><span class="op" id="6243984">.</span><span class="ident" id="6243985">addDep</span><span class="op" id="6243991">(</span><span class="ident" id="6243992">s</span><span class="op" id="6243993">,</span>&nbsp;<span class="ident" id="6243995">rows</span><span class="op" id="6243999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244004">rows</span><span class="op" id="6244008">.</span><span class="ident" id="6244009">releaseConn</span>&nbsp;<span class="op" id="6244021">=</span>&nbsp;<span class="keyword" id="6244023">func</span><span class="op" id="6244027">(</span><span class="ident" id="6244028">err</span>&nbsp;<span class="builtintype" id="6244032">error</span><span class="op" id="6244037">)</span>&nbsp;<span class="op" id="6244039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244045">releaseConn</span><span class="op" id="6244056">(</span><span class="ident" id="6244057">err</span><span class="op" id="6244060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244066">s</span><span class="op" id="6244067">.</span><span class="ident" id="6244068">db</span><span class="op" id="6244070">.</span><span class="ident" id="6244071">removeDep</span><span class="op" id="6244080">(</span><span class="ident" id="6244081">s</span><span class="op" id="6244082">,</span>&nbsp;<span class="ident" id="6244084">rows</span><span class="op" id="6244088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244093">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244098">return</span>&nbsp;<span class="ident" id="6244105">rows</span><span class="op" id="6244109">,</span>&nbsp;<span class="ident" id="6244111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244122">releaseConn</span><span class="op" id="6244133">(</span><span class="ident" id="6244134">err</span><span class="op" id="6244137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244141">if</span>&nbsp;<span class="ident" id="6244144">err</span>&nbsp;<span class="op" id="6244148">!=</span>&nbsp;<span class="ident" id="6244151">driver</span><span class="op" id="6244157">.</span><span class="ident" id="6244158">ErrBadConn</span>&nbsp;<span class="op" id="6244169">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244174">return</span>&nbsp;<span class="ident" id="6244181">nil</span><span class="op" id="6244184">,</span>&nbsp;<span class="ident" id="6244186">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244198">return</span>&nbsp;<span class="ident" id="6244205">nil</span><span class="op" id="6244208">,</span>&nbsp;<span class="ident" id="6244210">driver</span><span class="op" id="6244216">.</span><span class="ident" id="6244217">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6244228">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="6244231">func</span>&nbsp;<span class="ident" id="6244236">rowsiFromStatement</span><span class="op" id="6244254">(</span><span class="ident" id="6244255">ds</span>&nbsp;<span class="ident" id="6244258">driverStmt</span><span class="op" id="6244268">,</span>&nbsp;<span class="ident" id="6244270">args</span>&nbsp;<span class="op" id="6244275">...</span><span class="keyword" id="6244278">interface</span><span class="op" id="6244287">{</span><span class="op" id="6244288">}</span><span class="op" id="6244289">)</span>&nbsp;<span class="op" id="6244291">(</span><span class="ident" id="6244292">driver</span><span class="op" id="6244298">.</span><span class="ident" id="6244299">Rows</span><span class="op" id="6244303">,</span>&nbsp;<span class="builtintype" id="6244305">error</span><span class="op" id="6244310">)</span>&nbsp;<span class="op" id="6244312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244315">ds</span><span class="op" id="6244317">.</span><span class="ident" id="6244318">Lock</span><span class="op" id="6244322">(</span><span class="op" id="6244323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244326">want</span>&nbsp;<span class="op" id="6244331">:=</span>&nbsp;<span class="ident" id="6244334">ds</span><span class="op" id="6244336">.</span><span class="ident" id="6244337">si</span><span class="op" id="6244339">.</span><span class="ident" id="6244340">NumInput</span><span class="op" id="6244348">(</span><span class="op" id="6244349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244352">ds</span><span class="op" id="6244354">.</span><span class="ident" id="6244355">Unlock</span><span class="op" id="6244361">(</span><span class="op" id="6244362">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6244366">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6244430">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6244504">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244533">if</span>&nbsp;<span class="ident" id="6244536">want</span>&nbsp;<span class="op" id="6244541">!=</span>&nbsp;<span class="op" id="6244544">-</span><span class="num" id="6244545">1</span>&nbsp;<span class="op" id="6244547">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6244550">len</span><span class="op" id="6244553">(</span><span class="ident" id="6244554">args</span><span class="op" id="6244558">)</span>&nbsp;<span class="op" id="6244560">!=</span>&nbsp;<span class="ident" id="6244563">want</span>&nbsp;<span class="op" id="6244568">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244572">return</span>&nbsp;<span class="ident" id="6244579">nil</span><span class="op" id="6244582">,</span>&nbsp;<span class="ident" id="6244584">fmt</span><span class="op" id="6244587">.</span><span class="ident" id="6244588">Errorf</span><span class="op" id="6244594">(</span><span class="string" id="6244595">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6244637">,</span>&nbsp;<span class="ident" id="6244639">want</span><span class="op" id="6244643">,</span>&nbsp;<span class="builtinfunc" id="6244645">len</span><span class="op" id="6244648">(</span><span class="ident" id="6244649">args</span><span class="op" id="6244653">)</span><span class="op" id="6244654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244661">dargs</span><span class="op" id="6244666">,</span>&nbsp;<span class="ident" id="6244668">err</span>&nbsp;<span class="op" id="6244672">:=</span>&nbsp;<span class="ident" id="6244675">driverArgs</span><span class="op" id="6244685">(</span><span class="op" id="6244686">&amp;</span><span class="ident" id="6244687">ds</span><span class="op" id="6244689">,</span>&nbsp;<span class="ident" id="6244691">args</span><span class="op" id="6244695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244698">if</span>&nbsp;<span class="ident" id="6244701">err</span>&nbsp;<span class="op" id="6244705">!=</span>&nbsp;<span class="ident" id="6244708">nil</span>&nbsp;<span class="op" id="6244712">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244716">return</span>&nbsp;<span class="ident" id="6244723">nil</span><span class="op" id="6244726">,</span>&nbsp;<span class="ident" id="6244728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244737">ds</span><span class="op" id="6244739">.</span><span class="ident" id="6244740">Lock</span><span class="op" id="6244744">(</span><span class="op" id="6244745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244748">rowsi</span><span class="op" id="6244753">,</span>&nbsp;<span class="ident" id="6244755">err</span>&nbsp;<span class="op" id="6244759">:=</span>&nbsp;<span class="ident" id="6244762">ds</span><span class="op" id="6244764">.</span><span class="ident" id="6244765">si</span><span class="op" id="6244767">.</span><span class="ident" id="6244768">Query</span><span class="op" id="6244773">(</span><span class="ident" id="6244774">dargs</span><span class="op" id="6244779">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244782">ds</span><span class="op" id="6244784">.</span><span class="ident" id="6244785">Unlock</span><span class="op" id="6244791">(</span><span class="op" id="6244792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244795">if</span>&nbsp;<span class="ident" id="6244798">err</span>&nbsp;<span class="op" id="6244802">!=</span>&nbsp;<span class="ident" id="6244805">nil</span>&nbsp;<span class="op" id="6244809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244813">return</span>&nbsp;<span class="ident" id="6244820">nil</span><span class="op" id="6244823">,</span>&nbsp;<span class="ident" id="6244825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6244833">return</span>&nbsp;<span class="ident" id="6244840">rowsi</span><span class="op" id="6244845">,</span>&nbsp;<span class="ident" id="6244847">nil</span><br>
<span class="lineno">1495</span><span class="op" id="6244851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6244854">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="6244928">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6245005">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="6245085">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="6245157">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="6245229">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="6245242">//</span><br>
<span class="lineno"></span><span class="comment" id="6245245">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="6245263">//</span><br>
<span class="lineno"></span><span class="comment" id="6245266">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6245286">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="6245339">func</span>&nbsp;<span class="op" id="6245344">(</span><span class="ident" id="6245345">s</span>&nbsp;<span class="op" id="6245347">*</span><span class="ident" id="6245348">Stmt</span><span class="op" id="6245352">)</span>&nbsp;<span class="ident" id="6245354">QueryRow</span><span class="op" id="6245362">(</span><span class="ident" id="6245363">args</span>&nbsp;<span class="op" id="6245368">...</span><span class="keyword" id="6245371">interface</span><span class="op" id="6245380">{</span><span class="op" id="6245381">}</span><span class="op" id="6245382">)</span>&nbsp;<span class="op" id="6245384">*</span><span class="ident" id="6245385">Row</span>&nbsp;<span class="op" id="6245389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245392">rows</span><span class="op" id="6245396">,</span>&nbsp;<span class="ident" id="6245398">err</span>&nbsp;<span class="op" id="6245402">:=</span>&nbsp;<span class="ident" id="6245405">s</span><span class="op" id="6245406">.</span><span class="ident" id="6245407">Query</span><span class="op" id="6245412">(</span><span class="ident" id="6245413">args</span><span class="op" id="6245417">...</span><span class="op" id="6245420">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245423">if</span>&nbsp;<span class="ident" id="6245426">err</span>&nbsp;<span class="op" id="6245430">!=</span>&nbsp;<span class="ident" id="6245433">nil</span>&nbsp;<span class="op" id="6245437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245441">return</span>&nbsp;<span class="op" id="6245448">&amp;</span><span class="ident" id="6245449">Row</span><span class="op" id="6245452">{</span><span class="ident" id="6245453">err</span><span class="op" id="6245456">:</span>&nbsp;<span class="ident" id="6245458">err</span><span class="op" id="6245461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6245464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245467">return</span>&nbsp;<span class="op" id="6245474">&amp;</span><span class="ident" id="6245475">Row</span><span class="op" id="6245478">{</span><span class="ident" id="6245479">rows</span><span class="op" id="6245483">:</span>&nbsp;<span class="ident" id="6245485">rows</span><span class="op" id="6245489">}</span><br>
<span class="lineno"></span><span class="op" id="6245491">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="6245494">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6245525">func</span>&nbsp;<span class="op" id="6245530">(</span><span class="ident" id="6245531">s</span>&nbsp;<span class="op" id="6245533">*</span><span class="ident" id="6245534">Stmt</span><span class="op" id="6245538">)</span>&nbsp;<span class="ident" id="6245540">Close</span><span class="op" id="6245545">(</span><span class="op" id="6245546">)</span>&nbsp;<span class="builtintype" id="6245548">error</span>&nbsp;<span class="op" id="6245554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245557">s</span><span class="op" id="6245558">.</span><span class="ident" id="6245559">closemu</span><span class="op" id="6245566">.</span><span class="ident" id="6245567">Lock</span><span class="op" id="6245571">(</span><span class="op" id="6245572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245575">defer</span>&nbsp;<span class="ident" id="6245581">s</span><span class="op" id="6245582">.</span><span class="ident" id="6245583">closemu</span><span class="op" id="6245590">.</span><span class="ident" id="6245591">Unlock</span><span class="op" id="6245597">(</span><span class="op" id="6245598">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245602">if</span>&nbsp;<span class="ident" id="6245605">s</span><span class="op" id="6245606">.</span><span class="ident" id="6245607">stickyErr</span>&nbsp;<span class="op" id="6245617">!=</span>&nbsp;<span class="ident" id="6245620">nil</span>&nbsp;<span class="op" id="6245624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245628">return</span>&nbsp;<span class="ident" id="6245635">s</span><span class="op" id="6245636">.</span><span class="ident" id="6245637">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6245648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245651">s</span><span class="op" id="6245652">.</span><span class="ident" id="6245653">mu</span><span class="op" id="6245655">.</span><span class="ident" id="6245656">Lock</span><span class="op" id="6245660">(</span><span class="op" id="6245661">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245664">if</span>&nbsp;<span class="ident" id="6245667">s</span><span class="op" id="6245668">.</span><span class="ident" id="6245669">closed</span>&nbsp;<span class="op" id="6245676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245680">s</span><span class="op" id="6245681">.</span><span class="ident" id="6245682">mu</span><span class="op" id="6245684">.</span><span class="ident" id="6245685">Unlock</span><span class="op" id="6245691">(</span><span class="op" id="6245692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245696">return</span>&nbsp;<span class="ident" id="6245703">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6245708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245711">s</span><span class="op" id="6245712">.</span><span class="ident" id="6245713">closed</span>&nbsp;<span class="op" id="6245720">=</span>&nbsp;<span class="builtintype" id="6245722">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245729">if</span>&nbsp;<span class="ident" id="6245732">s</span><span class="op" id="6245733">.</span><span class="ident" id="6245734">tx</span>&nbsp;<span class="op" id="6245737">!=</span>&nbsp;<span class="ident" id="6245740">nil</span>&nbsp;<span class="op" id="6245744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245748">s</span><span class="op" id="6245749">.</span><span class="ident" id="6245750">txsi</span><span class="op" id="6245754">.</span><span class="ident" id="6245755">Close</span><span class="op" id="6245760">(</span><span class="op" id="6245761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245765">s</span><span class="op" id="6245766">.</span><span class="ident" id="6245767">mu</span><span class="op" id="6245769">.</span><span class="ident" id="6245770">Unlock</span><span class="op" id="6245776">(</span><span class="op" id="6245777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245781">return</span>&nbsp;<span class="ident" id="6245788">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6245793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245796">s</span><span class="op" id="6245797">.</span><span class="ident" id="6245798">mu</span><span class="op" id="6245800">.</span><span class="ident" id="6245801">Unlock</span><span class="op" id="6245807">(</span><span class="op" id="6245808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245812">return</span>&nbsp;<span class="ident" id="6245819">s</span><span class="op" id="6245820">.</span><span class="ident" id="6245821">db</span><span class="op" id="6245823">.</span><span class="ident" id="6245824">removeDep</span><span class="op" id="6245833">(</span><span class="ident" id="6245834">s</span><span class="op" id="6245835">,</span>&nbsp;<span class="ident" id="6245837">s</span><span class="op" id="6245838">)</span><br>
<span class="lineno"></span><span class="op" id="6245840">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="6245843">func</span>&nbsp;<span class="op" id="6245848">(</span><span class="ident" id="6245849">s</span>&nbsp;<span class="op" id="6245851">*</span><span class="ident" id="6245852">Stmt</span><span class="op" id="6245856">)</span>&nbsp;<span class="ident" id="6245858">finalClose</span><span class="op" id="6245868">(</span><span class="op" id="6245869">)</span>&nbsp;<span class="builtintype" id="6245871">error</span>&nbsp;<span class="op" id="6245877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245880">s</span><span class="op" id="6245881">.</span><span class="ident" id="6245882">mu</span><span class="op" id="6245884">.</span><span class="ident" id="6245885">Lock</span><span class="op" id="6245889">(</span><span class="op" id="6245890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245893">defer</span>&nbsp;<span class="ident" id="6245899">s</span><span class="op" id="6245900">.</span><span class="ident" id="6245901">mu</span><span class="op" id="6245903">.</span><span class="ident" id="6245904">Unlock</span><span class="op" id="6245910">(</span><span class="op" id="6245911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245914">if</span>&nbsp;<span class="ident" id="6245917">s</span><span class="op" id="6245918">.</span><span class="ident" id="6245919">css</span>&nbsp;<span class="op" id="6245923">!=</span>&nbsp;<span class="ident" id="6245926">nil</span>&nbsp;<span class="op" id="6245930">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6245934">for</span>&nbsp;<span class="ident" id="6245938">_</span><span class="op" id="6245939">,</span>&nbsp;<span class="ident" id="6245941">v</span>&nbsp;<span class="op" id="6245943">:=</span>&nbsp;<span class="keyword" id="6245946">range</span>&nbsp;<span class="ident" id="6245952">s</span><span class="op" id="6245953">.</span><span class="ident" id="6245954">css</span>&nbsp;<span class="op" id="6245958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6245963">s</span><span class="op" id="6245964">.</span><span class="ident" id="6245965">db</span><span class="op" id="6245967">.</span><span class="ident" id="6245968">noteUnusedDriverStatement</span><span class="op" id="6245993">(</span><span class="ident" id="6245994">v</span><span class="op" id="6245995">.</span><span class="ident" id="6245996">dc</span><span class="op" id="6245998">,</span>&nbsp;<span class="ident" id="6246000">v</span><span class="op" id="6246001">.</span><span class="ident" id="6246002">si</span><span class="op" id="6246004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246009">v</span><span class="op" id="6246010">.</span><span class="ident" id="6246011">dc</span><span class="op" id="6246013">.</span><span class="ident" id="6246014">removeOpenStmt</span><span class="op" id="6246028">(</span><span class="ident" id="6246029">v</span><span class="op" id="6246030">.</span><span class="ident" id="6246031">si</span><span class="op" id="6246033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6246037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246041">s</span><span class="op" id="6246042">.</span><span class="ident" id="6246043">css</span>&nbsp;<span class="op" id="6246047">=</span>&nbsp;<span class="ident" id="6246049">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6246054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6246057">return</span>&nbsp;<span class="ident" id="6246064">nil</span><br>
<span class="lineno"></span><span class="op" id="6246068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6246071">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="6246144">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="6246204">//</span><br>
<span class="lineno"></span><span class="comment" id="6246207">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6246250">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6246261">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="6246287">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6246312">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="6246334">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6246361">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="6246400">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="6246415">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6246424">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="6246494">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="6246505">type</span>&nbsp;<span class="ident" id="6246510">Rows</span>&nbsp;<span class="keyword" id="6246515">struct</span>&nbsp;<span class="op" id="6246522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246525">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6246537">*</span><span class="ident" id="6246538">driverConn</span>&nbsp;<span class="comment" id="6246549">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246605">releaseConn</span>&nbsp;<span class="keyword" id="6246617">func</span><span class="op" id="6246621">(</span><span class="builtintype" id="6246622">error</span><span class="op" id="6246627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246630">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246642">driver</span><span class="op" id="6246648">.</span><span class="ident" id="6246649">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246656">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6246666">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246672">lastcols</span>&nbsp;&nbsp;<span class="op" id="6246682">[</span><span class="op" id="6246683">]</span><span class="ident" id="6246684">driver</span><span class="op" id="6246690">.</span><span class="ident" id="6246691">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246698">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6246708">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6246720">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6246755">closeStmt</span>&nbsp;<span class="ident" id="6246765">driver</span><span class="op" id="6246771">.</span><span class="ident" id="6246772">Stmt</span>&nbsp;<span class="comment" id="6246777">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="6246820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6246823">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="6246898">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6246978">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="6247058">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="6247076">//</span><br>
<span class="lineno"></span><span class="comment" id="6247079">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="6247158">func</span>&nbsp;<span class="op" id="6247163">(</span><span class="ident" id="6247164">rs</span>&nbsp;<span class="op" id="6247167">*</span><span class="ident" id="6247168">Rows</span><span class="op" id="6247172">)</span>&nbsp;<span class="ident" id="6247174">Next</span><span class="op" id="6247178">(</span><span class="op" id="6247179">)</span>&nbsp;<span class="builtintype" id="6247181">bool</span>&nbsp;<span class="op" id="6247186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247189">if</span>&nbsp;<span class="ident" id="6247192">rs</span><span class="op" id="6247194">.</span><span class="ident" id="6247195">closed</span>&nbsp;<span class="op" id="6247202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247206">return</span>&nbsp;<span class="builtintype" id="6247213">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6247220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247223">if</span>&nbsp;<span class="ident" id="6247226">rs</span><span class="op" id="6247228">.</span><span class="ident" id="6247229">lastcols</span>&nbsp;<span class="op" id="6247238">==</span>&nbsp;<span class="ident" id="6247241">nil</span>&nbsp;<span class="op" id="6247245">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6247249">rs</span><span class="op" id="6247251">.</span><span class="ident" id="6247252">lastcols</span>&nbsp;<span class="op" id="6247261">=</span>&nbsp;<span class="builtinfunc" id="6247263">make</span><span class="op" id="6247267">(</span><span class="op" id="6247268">[</span><span class="op" id="6247269">]</span><span class="ident" id="6247270">driver</span><span class="op" id="6247276">.</span><span class="ident" id="6247277">Value</span><span class="op" id="6247282">,</span>&nbsp;<span class="builtinfunc" id="6247284">len</span><span class="op" id="6247287">(</span><span class="ident" id="6247288">rs</span><span class="op" id="6247290">.</span><span class="ident" id="6247291">rowsi</span><span class="op" id="6247296">.</span><span class="ident" id="6247297">Columns</span><span class="op" id="6247304">(</span><span class="op" id="6247305">)</span><span class="op" id="6247306">)</span><span class="op" id="6247307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6247310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6247313">rs</span><span class="op" id="6247315">.</span><span class="ident" id="6247316">lasterr</span>&nbsp;<span class="op" id="6247324">=</span>&nbsp;<span class="ident" id="6247326">rs</span><span class="op" id="6247328">.</span><span class="ident" id="6247329">rowsi</span><span class="op" id="6247334">.</span><span class="ident" id="6247335">Next</span><span class="op" id="6247339">(</span><span class="ident" id="6247340">rs</span><span class="op" id="6247342">.</span><span class="ident" id="6247343">lastcols</span><span class="op" id="6247351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247354">if</span>&nbsp;<span class="ident" id="6247357">rs</span><span class="op" id="6247359">.</span><span class="ident" id="6247360">lasterr</span>&nbsp;<span class="op" id="6247368">!=</span>&nbsp;<span class="ident" id="6247371">nil</span>&nbsp;<span class="op" id="6247375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6247379">rs</span><span class="op" id="6247381">.</span><span class="ident" id="6247382">Close</span><span class="op" id="6247387">(</span><span class="op" id="6247388">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247392">return</span>&nbsp;<span class="builtintype" id="6247399">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6247406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247409">return</span>&nbsp;<span class="builtintype" id="6247416">true</span><br>
<span class="lineno"></span><span class="op" id="6247421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="6247424">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="6247497">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6247555">func</span>&nbsp;<span class="op" id="6247560">(</span><span class="ident" id="6247561">rs</span>&nbsp;<span class="op" id="6247564">*</span><span class="ident" id="6247565">Rows</span><span class="op" id="6247569">)</span>&nbsp;<span class="ident" id="6247571">Err</span><span class="op" id="6247574">(</span><span class="op" id="6247575">)</span>&nbsp;<span class="builtintype" id="6247577">error</span>&nbsp;<span class="op" id="6247583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247586">if</span>&nbsp;<span class="ident" id="6247589">rs</span><span class="op" id="6247591">.</span><span class="ident" id="6247592">lasterr</span>&nbsp;<span class="op" id="6247600">==</span>&nbsp;<span class="ident" id="6247603">io</span><span class="op" id="6247605">.</span><span class="ident" id="6247606">EOF</span>&nbsp;<span class="op" id="6247610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247614">return</span>&nbsp;<span class="ident" id="6247621">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6247626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247629">return</span>&nbsp;<span class="ident" id="6247636">rs</span><span class="op" id="6247638">.</span><span class="ident" id="6247639">lasterr</span><br>
<span class="lineno"></span><span class="op" id="6247647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6247650">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="6247687">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="6247754">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6247807">func</span>&nbsp;<span class="op" id="6247812">(</span><span class="ident" id="6247813">rs</span>&nbsp;<span class="op" id="6247816">*</span><span class="ident" id="6247817">Rows</span><span class="op" id="6247821">)</span>&nbsp;<span class="ident" id="6247823">Columns</span><span class="op" id="6247830">(</span><span class="op" id="6247831">)</span>&nbsp;<span class="op" id="6247833">(</span><span class="op" id="6247834">[</span><span class="op" id="6247835">]</span><span class="builtintype" id="6247836">string</span><span class="op" id="6247842">,</span>&nbsp;<span class="builtintype" id="6247844">error</span><span class="op" id="6247849">)</span>&nbsp;<span class="op" id="6247851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247854">if</span>&nbsp;<span class="ident" id="6247857">rs</span><span class="op" id="6247859">.</span><span class="ident" id="6247860">closed</span>&nbsp;<span class="op" id="6247867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247871">return</span>&nbsp;<span class="ident" id="6247878">nil</span><span class="op" id="6247881">,</span>&nbsp;<span class="ident" id="6247883">errors</span><span class="op" id="6247889">.</span><span class="ident" id="6247890">New</span><span class="op" id="6247893">(</span><span class="string" id="6247894">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6247916">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6247919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247922">if</span>&nbsp;<span class="ident" id="6247925">rs</span><span class="op" id="6247927">.</span><span class="ident" id="6247928">rowsi</span>&nbsp;<span class="op" id="6247934">==</span>&nbsp;<span class="ident" id="6247937">nil</span>&nbsp;<span class="op" id="6247941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247945">return</span>&nbsp;<span class="ident" id="6247952">nil</span><span class="op" id="6247955">,</span>&nbsp;<span class="ident" id="6247957">errors</span><span class="op" id="6247963">.</span><span class="ident" id="6247964">New</span><span class="op" id="6247967">(</span><span class="string" id="6247968">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="6247992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6247995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6247998">return</span>&nbsp;<span class="ident" id="6248005">rs</span><span class="op" id="6248007">.</span><span class="ident" id="6248008">rowsi</span><span class="op" id="6248013">.</span><span class="ident" id="6248014">Columns</span><span class="op" id="6248021">(</span><span class="op" id="6248022">)</span><span class="op" id="6248023">,</span>&nbsp;<span class="ident" id="6248025">nil</span><br>
<span class="lineno">1620</span><span class="op" id="6248029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6248032">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="6248102">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="6248117">//</span><br>
<span class="lineno">1625</span><span class="comment" id="6248120">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="6248191">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="6248261">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="6248332">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6248400">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="6248441">//</span><br>
<span class="lineno"></span><span class="comment" id="6248444">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6248507">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6248577">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="6248646">func</span>&nbsp;<span class="op" id="6248651">(</span><span class="ident" id="6248652">rs</span>&nbsp;<span class="op" id="6248655">*</span><span class="ident" id="6248656">Rows</span><span class="op" id="6248660">)</span>&nbsp;<span class="ident" id="6248662">Scan</span><span class="op" id="6248666">(</span><span class="ident" id="6248667">dest</span>&nbsp;<span class="op" id="6248672">...</span><span class="keyword" id="6248675">interface</span><span class="op" id="6248684">{</span><span class="op" id="6248685">}</span><span class="op" id="6248686">)</span>&nbsp;<span class="builtintype" id="6248688">error</span>&nbsp;<span class="op" id="6248694">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248697">if</span>&nbsp;<span class="ident" id="6248700">rs</span><span class="op" id="6248702">.</span><span class="ident" id="6248703">closed</span>&nbsp;<span class="op" id="6248710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248714">return</span>&nbsp;<span class="ident" id="6248721">errors</span><span class="op" id="6248727">.</span><span class="ident" id="6248728">New</span><span class="op" id="6248731">(</span><span class="string" id="6248732">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6248754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6248757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248760">if</span>&nbsp;<span class="ident" id="6248763">rs</span><span class="op" id="6248765">.</span><span class="ident" id="6248766">lastcols</span>&nbsp;<span class="op" id="6248775">==</span>&nbsp;<span class="ident" id="6248778">nil</span>&nbsp;<span class="op" id="6248782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248786">return</span>&nbsp;<span class="ident" id="6248793">errors</span><span class="op" id="6248799">.</span><span class="ident" id="6248800">New</span><span class="op" id="6248803">(</span><span class="string" id="6248804">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="6248843">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6248846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248849">if</span>&nbsp;<span class="builtinfunc" id="6248852">len</span><span class="op" id="6248855">(</span><span class="ident" id="6248856">dest</span><span class="op" id="6248860">)</span>&nbsp;<span class="op" id="6248862">!=</span>&nbsp;<span class="builtinfunc" id="6248865">len</span><span class="op" id="6248868">(</span><span class="ident" id="6248869">rs</span><span class="op" id="6248871">.</span><span class="ident" id="6248872">lastcols</span><span class="op" id="6248880">)</span>&nbsp;<span class="op" id="6248882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248886">return</span>&nbsp;<span class="ident" id="6248893">fmt</span><span class="op" id="6248896">.</span><span class="ident" id="6248897">Errorf</span><span class="op" id="6248903">(</span><span class="string" id="6248904">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="6248960">,</span>&nbsp;<span class="builtinfunc" id="6248962">len</span><span class="op" id="6248965">(</span><span class="ident" id="6248966">rs</span><span class="op" id="6248968">.</span><span class="ident" id="6248969">lastcols</span><span class="op" id="6248977">)</span><span class="op" id="6248978">,</span>&nbsp;<span class="builtinfunc" id="6248980">len</span><span class="op" id="6248983">(</span><span class="ident" id="6248984">dest</span><span class="op" id="6248988">)</span><span class="op" id="6248989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6248992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6248995">for</span>&nbsp;<span class="ident" id="6248999">i</span><span class="op" id="6249000">,</span>&nbsp;<span class="ident" id="6249002">sv</span>&nbsp;<span class="op" id="6249005">:=</span>&nbsp;<span class="keyword" id="6249008">range</span>&nbsp;<span class="ident" id="6249014">rs</span><span class="op" id="6249016">.</span><span class="ident" id="6249017">lastcols</span>&nbsp;<span class="op" id="6249026">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249030">err</span>&nbsp;<span class="op" id="6249034">:=</span>&nbsp;<span class="ident" id="6249037">convertAssign</span><span class="op" id="6249050">(</span><span class="ident" id="6249051">dest</span><span class="op" id="6249055">[</span><span class="ident" id="6249056">i</span><span class="op" id="6249057">]</span><span class="op" id="6249058">,</span>&nbsp;<span class="ident" id="6249060">sv</span><span class="op" id="6249062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249066">if</span>&nbsp;<span class="ident" id="6249069">err</span>&nbsp;<span class="op" id="6249073">!=</span>&nbsp;<span class="ident" id="6249076">nil</span>&nbsp;<span class="op" id="6249080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249085">return</span>&nbsp;<span class="ident" id="6249092">fmt</span><span class="op" id="6249095">.</span><span class="ident" id="6249096">Errorf</span><span class="op" id="6249102">(</span><span class="string" id="6249103">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6249143">,</span>&nbsp;<span class="ident" id="6249145">i</span><span class="op" id="6249146">,</span>&nbsp;<span class="ident" id="6249148">err</span><span class="op" id="6249151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6249155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6249158">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249161">return</span>&nbsp;<span class="ident" id="6249168">nil</span><br>
<span class="lineno"></span><span class="op" id="6249172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6249175">var</span>&nbsp;<span class="ident" id="6249179">rowsCloseHook</span>&nbsp;<span class="keyword" id="6249193">func</span><span class="op" id="6249197">(</span><span class="op" id="6249198">*</span><span class="ident" id="6249199">Rows</span><span class="op" id="6249203">,</span>&nbsp;<span class="op" id="6249205">*</span><span class="builtintype" id="6249206">error</span><span class="op" id="6249211">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="6249214">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6249288">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6249365">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="6249442">func</span>&nbsp;<span class="op" id="6249447">(</span><span class="ident" id="6249448">rs</span>&nbsp;<span class="op" id="6249451">*</span><span class="ident" id="6249452">Rows</span><span class="op" id="6249456">)</span>&nbsp;<span class="ident" id="6249458">Close</span><span class="op" id="6249463">(</span><span class="op" id="6249464">)</span>&nbsp;<span class="builtintype" id="6249466">error</span>&nbsp;<span class="op" id="6249472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249475">if</span>&nbsp;<span class="ident" id="6249478">rs</span><span class="op" id="6249480">.</span><span class="ident" id="6249481">closed</span>&nbsp;<span class="op" id="6249488">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249492">return</span>&nbsp;<span class="ident" id="6249499">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6249504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249507">rs</span><span class="op" id="6249509">.</span><span class="ident" id="6249510">closed</span>&nbsp;<span class="op" id="6249517">=</span>&nbsp;<span class="builtintype" id="6249519">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249525">err</span>&nbsp;<span class="op" id="6249529">:=</span>&nbsp;<span class="ident" id="6249532">rs</span><span class="op" id="6249534">.</span><span class="ident" id="6249535">rowsi</span><span class="op" id="6249540">.</span><span class="ident" id="6249541">Close</span><span class="op" id="6249546">(</span><span class="op" id="6249547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249550">if</span>&nbsp;<span class="ident" id="6249553">fn</span>&nbsp;<span class="op" id="6249556">:=</span>&nbsp;<span class="ident" id="6249559">rowsCloseHook</span><span class="op" id="6249572">;</span>&nbsp;<span class="ident" id="6249574">fn</span>&nbsp;<span class="op" id="6249577">!=</span>&nbsp;<span class="ident" id="6249580">nil</span>&nbsp;<span class="op" id="6249584">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249588">fn</span><span class="op" id="6249590">(</span><span class="ident" id="6249591">rs</span><span class="op" id="6249593">,</span>&nbsp;<span class="op" id="6249595">&amp;</span><span class="ident" id="6249596">err</span><span class="op" id="6249599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6249602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249605">if</span>&nbsp;<span class="ident" id="6249608">rs</span><span class="op" id="6249610">.</span><span class="ident" id="6249611">closeStmt</span>&nbsp;<span class="op" id="6249621">!=</span>&nbsp;<span class="ident" id="6249624">nil</span>&nbsp;<span class="op" id="6249628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249632">rs</span><span class="op" id="6249634">.</span><span class="ident" id="6249635">closeStmt</span><span class="op" id="6249644">.</span><span class="ident" id="6249645">Close</span><span class="op" id="6249650">(</span><span class="op" id="6249651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6249654">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249657">rs</span><span class="op" id="6249659">.</span><span class="ident" id="6249660">releaseConn</span><span class="op" id="6249671">(</span><span class="ident" id="6249672">err</span><span class="op" id="6249675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6249678">return</span>&nbsp;<span class="ident" id="6249685">err</span><br>
<span class="lineno"></span><span class="op" id="6249689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6249692">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="6249757">type</span>&nbsp;<span class="ident" id="6249762">Row</span>&nbsp;<span class="keyword" id="6249766">struct</span>&nbsp;<span class="op" id="6249773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6249776">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249814">err</span>&nbsp;&nbsp;<span class="builtintype" id="6249819">error</span>&nbsp;<span class="comment" id="6249825">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249862">rows</span>&nbsp;<span class="op" id="6249867">*</span><span class="ident" id="6249868">Rows</span><br>
<span class="lineno"></span><span class="op" id="6249873">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="6249876">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="6249940">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="6250004">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="6250073">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="6250111">func</span>&nbsp;<span class="op" id="6250116">(</span><span class="ident" id="6250117">r</span>&nbsp;<span class="op" id="6250119">*</span><span class="ident" id="6250120">Row</span><span class="op" id="6250123">)</span>&nbsp;<span class="ident" id="6250125">Scan</span><span class="op" id="6250129">(</span><span class="ident" id="6250130">dest</span>&nbsp;<span class="op" id="6250135">...</span><span class="keyword" id="6250138">interface</span><span class="op" id="6250147">{</span><span class="op" id="6250148">}</span><span class="op" id="6250149">)</span>&nbsp;<span class="builtintype" id="6250151">error</span>&nbsp;<span class="op" id="6250157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6250160">if</span>&nbsp;<span class="ident" id="6250163">r</span><span class="op" id="6250164">.</span><span class="ident" id="6250165">err</span>&nbsp;<span class="op" id="6250169">!=</span>&nbsp;<span class="ident" id="6250172">nil</span>&nbsp;<span class="op" id="6250176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6250180">return</span>&nbsp;<span class="ident" id="6250187">r</span><span class="op" id="6250188">.</span><span class="ident" id="6250189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6250194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250198">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250259">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250311">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250367">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250429">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250493">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250554">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250618">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250679">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250735">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250797">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250858">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6250921">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6250937">defer</span>&nbsp;<span class="ident" id="6250943">r</span><span class="op" id="6250944">.</span><span class="ident" id="6250945">rows</span><span class="op" id="6250949">.</span><span class="ident" id="6250950">Close</span><span class="op" id="6250955">(</span><span class="op" id="6250956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6250959">for</span>&nbsp;<span class="ident" id="6250963">_</span><span class="op" id="6250964">,</span>&nbsp;<span class="ident" id="6250966">dp</span>&nbsp;<span class="op" id="6250969">:=</span>&nbsp;<span class="keyword" id="6250972">range</span>&nbsp;<span class="ident" id="6250978">dest</span>&nbsp;<span class="op" id="6250983">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6250987">if</span>&nbsp;<span class="ident" id="6250990">_</span><span class="op" id="6250991">,</span>&nbsp;<span class="ident" id="6250993">ok</span>&nbsp;<span class="op" id="6250996">:=</span>&nbsp;<span class="ident" id="6250999">dp</span><span class="op" id="6251001">.</span><span class="op" id="6251002">(</span><span class="op" id="6251003">*</span><span class="ident" id="6251004">RawBytes</span><span class="op" id="6251012">)</span><span class="op" id="6251013">;</span>&nbsp;<span class="ident" id="6251015">ok</span>&nbsp;<span class="op" id="6251018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251023">return</span>&nbsp;<span class="ident" id="6251030">errors</span><span class="op" id="6251036">.</span><span class="ident" id="6251037">New</span><span class="op" id="6251040">(</span><span class="string" id="6251041">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="6251082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6251086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6251089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251093">if</span>&nbsp;<span class="op" id="6251096">!</span><span class="ident" id="6251097">r</span><span class="op" id="6251098">.</span><span class="ident" id="6251099">rows</span><span class="op" id="6251103">.</span><span class="ident" id="6251104">Next</span><span class="op" id="6251108">(</span><span class="op" id="6251109">)</span>&nbsp;<span class="op" id="6251111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251115">if</span>&nbsp;<span class="ident" id="6251118">err</span>&nbsp;<span class="op" id="6251122">:=</span>&nbsp;<span class="ident" id="6251125">r</span><span class="op" id="6251126">.</span><span class="ident" id="6251127">rows</span><span class="op" id="6251131">.</span><span class="ident" id="6251132">Err</span><span class="op" id="6251135">(</span><span class="op" id="6251136">)</span><span class="op" id="6251137">;</span>&nbsp;<span class="ident" id="6251139">err</span>&nbsp;<span class="op" id="6251143">!=</span>&nbsp;<span class="ident" id="6251146">nil</span>&nbsp;<span class="op" id="6251150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251155">return</span>&nbsp;<span class="ident" id="6251162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6251168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251172">return</span>&nbsp;<span class="ident" id="6251179">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6251190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6251193">err</span>&nbsp;<span class="op" id="6251197">:=</span>&nbsp;<span class="ident" id="6251200">r</span><span class="op" id="6251201">.</span><span class="ident" id="6251202">rows</span><span class="op" id="6251206">.</span><span class="ident" id="6251207">Scan</span><span class="op" id="6251211">(</span><span class="ident" id="6251212">dest</span><span class="op" id="6251216">...</span><span class="op" id="6251219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251222">if</span>&nbsp;<span class="ident" id="6251225">err</span>&nbsp;<span class="op" id="6251229">!=</span>&nbsp;<span class="ident" id="6251232">nil</span>&nbsp;<span class="op" id="6251236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251240">return</span>&nbsp;<span class="ident" id="6251247">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6251252">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251255">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251326">if</span>&nbsp;<span class="ident" id="6251329">err</span>&nbsp;<span class="op" id="6251333">:=</span>&nbsp;<span class="ident" id="6251336">r</span><span class="op" id="6251337">.</span><span class="ident" id="6251338">rows</span><span class="op" id="6251342">.</span><span class="ident" id="6251343">Close</span><span class="op" id="6251348">(</span><span class="op" id="6251349">)</span><span class="op" id="6251350">;</span>&nbsp;<span class="ident" id="6251352">err</span>&nbsp;<span class="op" id="6251356">!=</span>&nbsp;<span class="ident" id="6251359">nil</span>&nbsp;<span class="op" id="6251363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251367">return</span>&nbsp;<span class="ident" id="6251374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6251379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6251383">return</span>&nbsp;<span class="ident" id="6251390">nil</span><br>
<span class="lineno"></span><span class="op" id="6251394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6251397">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="6251445">type</span>&nbsp;<span class="ident" id="6251450">Result</span>&nbsp;<span class="keyword" id="6251457">interface</span>&nbsp;<span class="op" id="6251467">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251470">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251533">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251594">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251656">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251715">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6251738">LastInsertId</span><span class="op" id="6251750">(</span><span class="op" id="6251751">)</span>&nbsp;<span class="op" id="6251753">(</span><span class="ident" id="6251754">int64</span><span class="op" id="6251759">,</span>&nbsp;<span class="builtintype" id="6251761">error</span><span class="op" id="6251766">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251770">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251829">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6251891">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6251920">RowsAffected</span><span class="op" id="6251932">(</span><span class="op" id="6251933">)</span>&nbsp;<span class="op" id="6251935">(</span><span class="ident" id="6251936">int64</span><span class="op" id="6251941">,</span>&nbsp;<span class="builtintype" id="6251943">error</span><span class="op" id="6251948">)</span><br>
<span class="lineno"></span><span class="op" id="6251950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6251953">type</span>&nbsp;<span class="ident" id="6251958">driverResult</span>&nbsp;<span class="keyword" id="6251971">struct</span>&nbsp;<span class="op" id="6251978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6251981">sync</span><span class="op" id="6251985">.</span><span class="ident" id="6251986">Locker</span>&nbsp;<span class="comment" id="6251993">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252013">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252025">driver</span><span class="op" id="6252031">.</span><span class="ident" id="6252032">Result</span><br>
<span class="lineno"></span><span class="op" id="6252039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6252042">func</span>&nbsp;<span class="op" id="6252047">(</span><span class="ident" id="6252048">dr</span>&nbsp;<span class="ident" id="6252051">driverResult</span><span class="op" id="6252063">)</span>&nbsp;<span class="ident" id="6252065">LastInsertId</span><span class="op" id="6252077">(</span><span class="op" id="6252078">)</span>&nbsp;<span class="op" id="6252080">(</span><span class="ident" id="6252081">int64</span><span class="op" id="6252086">,</span>&nbsp;<span class="builtintype" id="6252088">error</span><span class="op" id="6252093">)</span>&nbsp;<span class="op" id="6252095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252098">dr</span><span class="op" id="6252100">.</span><span class="ident" id="6252101">Lock</span><span class="op" id="6252105">(</span><span class="op" id="6252106">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6252109">defer</span>&nbsp;<span class="ident" id="6252115">dr</span><span class="op" id="6252117">.</span><span class="ident" id="6252118">Unlock</span><span class="op" id="6252124">(</span><span class="op" id="6252125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6252128">return</span>&nbsp;<span class="ident" id="6252135">dr</span><span class="op" id="6252137">.</span><span class="ident" id="6252138">resi</span><span class="op" id="6252142">.</span><span class="ident" id="6252143">LastInsertId</span><span class="op" id="6252155">(</span><span class="op" id="6252156">)</span><br>
<span class="lineno"></span><span class="op" id="6252158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6252161">func</span>&nbsp;<span class="op" id="6252166">(</span><span class="ident" id="6252167">dr</span>&nbsp;<span class="ident" id="6252170">driverResult</span><span class="op" id="6252182">)</span>&nbsp;<span class="ident" id="6252184">RowsAffected</span><span class="op" id="6252196">(</span><span class="op" id="6252197">)</span>&nbsp;<span class="op" id="6252199">(</span><span class="ident" id="6252200">int64</span><span class="op" id="6252205">,</span>&nbsp;<span class="builtintype" id="6252207">error</span><span class="op" id="6252212">)</span>&nbsp;<span class="op" id="6252214">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252217">dr</span><span class="op" id="6252219">.</span><span class="ident" id="6252220">Lock</span><span class="op" id="6252224">(</span><span class="op" id="6252225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6252228">defer</span>&nbsp;<span class="ident" id="6252234">dr</span><span class="op" id="6252236">.</span><span class="ident" id="6252237">Unlock</span><span class="op" id="6252243">(</span><span class="op" id="6252244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6252247">return</span>&nbsp;<span class="ident" id="6252254">dr</span><span class="op" id="6252256">.</span><span class="ident" id="6252257">resi</span><span class="op" id="6252261">.</span><span class="ident" id="6252262">RowsAffected</span><span class="op" id="6252274">(</span><span class="op" id="6252275">)</span><br>
<span class="lineno"></span><span class="op" id="6252277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="6252280">func</span>&nbsp;<span class="ident" id="6252285">stack</span><span class="op" id="6252290">(</span><span class="op" id="6252291">)</span>&nbsp;<span class="builtintype" id="6252293">string</span>&nbsp;<span class="op" id="6252300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6252303">var</span>&nbsp;<span class="ident" id="6252307">buf</span>&nbsp;<span class="op" id="6252311">[</span><span class="num" id="6252312">2</span>&nbsp;<span class="op" id="6252314">&lt;&lt;</span>&nbsp;<span class="num" id="6252317">10</span><span class="op" id="6252319">]</span><span class="builtintype" id="6252320">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6252326">return</span>&nbsp;<span class="builtintype" id="6252333">string</span><span class="op" id="6252339">(</span><span class="ident" id="6252340">buf</span><span class="op" id="6252343">[</span><span class="op" id="6252344">:</span><span class="ident" id="6252345">runtime</span><span class="op" id="6252352">.</span><span class="ident" id="6252353">Stack</span><span class="op" id="6252358">(</span><span class="ident" id="6252359">buf</span><span class="op" id="6252362">[</span><span class="op" id="6252363">:</span><span class="op" id="6252364">]</span><span class="op" id="6252365">,</span>&nbsp;<span class="builtintype" id="6252367">false</span><span class="op" id="6252372">)</span><span class="op" id="6252373">]</span><span class="op" id="6252374">)</span><br>
<span class="lineno"></span><span class="op" id="6252376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="6252379">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="6252414">func</span>&nbsp;<span class="ident" id="6252419">withLock</span><span class="op" id="6252427">(</span><span class="ident" id="6252428">lk</span>&nbsp;<span class="ident" id="6252431">sync</span><span class="op" id="6252435">.</span><span class="ident" id="6252436">Locker</span><span class="op" id="6252442">,</span>&nbsp;<span class="ident" id="6252444">fn</span>&nbsp;<span class="keyword" id="6252447">func</span><span class="op" id="6252451">(</span><span class="op" id="6252452">)</span><span class="op" id="6252453">)</span>&nbsp;<span class="op" id="6252455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252458">lk</span><span class="op" id="6252460">.</span><span class="ident" id="6252461">Lock</span><span class="op" id="6252465">(</span><span class="op" id="6252466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252469">fn</span><span class="op" id="6252471">(</span><span class="op" id="6252472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6252475">lk</span><span class="op" id="6252477">.</span><span class="ident" id="6252478">Unlock</span><span class="op" id="6252484">(</span><span class="op" id="6252485">)</span><br>
<span class="lineno">1770</span><span class="op" id="6252487">}</span>
</div>
</body>
</html>
