<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html" class="current">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8210324">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8210379">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8210433">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8210484">package</span>&nbsp;<span class="ident" id="8210492">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8210502">import</span>&nbsp;<span class="op" id="8210509">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210512">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210521">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210530">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210537">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210543">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210556">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8210567">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="8210577">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8210580">func</span>&nbsp;<span class="ident" id="8210585">TestChunk</span><span class="op" id="8210594">(</span><span class="ident" id="8210595">t</span>&nbsp;<span class="op" id="8210597">*</span><span class="ident" id="8210598">testing</span><span class="op" id="8210605">.</span><span class="ident" id="8210606">T</span><span class="op" id="8210607">)</span>&nbsp;<span class="op" id="8210609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8210612">var</span>&nbsp;<span class="ident" id="8210616">b</span>&nbsp;<span class="ident" id="8210618">bytes</span><span class="op" id="8210623">.</span><span class="ident" id="8210624">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210633">w</span>&nbsp;<span class="op" id="8210635">:=</span>&nbsp;<span class="ident" id="8210638">NewChunkedWriter</span><span class="op" id="8210654">(</span><span class="op" id="8210655">&amp;</span><span class="ident" id="8210656">b</span><span class="op" id="8210657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8210660">const</span>&nbsp;<span class="ident" id="8210666">chunk1</span>&nbsp;<span class="op" id="8210673">=</span>&nbsp;<span class="string" id="8210675">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8210686">const</span>&nbsp;<span class="ident" id="8210692">chunk2</span>&nbsp;<span class="op" id="8210699">=</span>&nbsp;<span class="string" id="8210701">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210728">w</span><span class="op" id="8210729">.</span><span class="ident" id="8210730">Write</span><span class="op" id="8210735">(</span><span class="op" id="8210736">[</span><span class="op" id="8210737">]</span><span class="builtintype" id="8210738">byte</span><span class="op" id="8210742">(</span><span class="ident" id="8210743">chunk1</span><span class="op" id="8210749">)</span><span class="op" id="8210750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210753">w</span><span class="op" id="8210754">.</span><span class="ident" id="8210755">Write</span><span class="op" id="8210760">(</span><span class="op" id="8210761">[</span><span class="op" id="8210762">]</span><span class="builtintype" id="8210763">byte</span><span class="op" id="8210767">(</span><span class="ident" id="8210768">chunk2</span><span class="op" id="8210774">)</span><span class="op" id="8210775">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210778">w</span><span class="op" id="8210779">.</span><span class="ident" id="8210780">Close</span><span class="op" id="8210785">(</span><span class="op" id="8210786">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8210790">if</span>&nbsp;<span class="ident" id="8210793">g</span><span class="op" id="8210794">,</span>&nbsp;<span class="ident" id="8210796">e</span>&nbsp;<span class="op" id="8210798">:=</span>&nbsp;<span class="ident" id="8210801">b</span><span class="op" id="8210802">.</span><span class="ident" id="8210803">String</span><span class="op" id="8210809">(</span><span class="op" id="8210810">)</span><span class="op" id="8210811">,</span>&nbsp;<span class="string" id="8210813">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="8210869">;</span>&nbsp;<span class="ident" id="8210871">g</span>&nbsp;<span class="op" id="8210873">!=</span>&nbsp;<span class="ident" id="8210876">e</span>&nbsp;<span class="op" id="8210878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210882">t</span><span class="op" id="8210883">.</span><span class="ident" id="8210884">Fatalf</span><span class="op" id="8210890">(</span><span class="string" id="8210891">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8210923">,</span>&nbsp;<span class="ident" id="8210925">g</span><span class="op" id="8210926">,</span>&nbsp;<span class="ident" id="8210928">e</span><span class="op" id="8210929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8210932">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210936">r</span>&nbsp;<span class="op" id="8210938">:=</span>&nbsp;<span class="ident" id="8210941">NewChunkedReader</span><span class="op" id="8210957">(</span><span class="op" id="8210958">&amp;</span><span class="ident" id="8210959">b</span><span class="op" id="8210960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8210963">data</span><span class="op" id="8210967">,</span>&nbsp;<span class="ident" id="8210969">err</span>&nbsp;<span class="op" id="8210973">:=</span>&nbsp;<span class="ident" id="8210976">ioutil</span><span class="op" id="8210982">.</span><span class="ident" id="8210983">ReadAll</span><span class="op" id="8210990">(</span><span class="ident" id="8210991">r</span><span class="op" id="8210992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8210995">if</span>&nbsp;<span class="ident" id="8210998">err</span>&nbsp;<span class="op" id="8211002">!=</span>&nbsp;<span class="ident" id="8211005">nil</span>&nbsp;<span class="op" id="8211009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211013">t</span><span class="op" id="8211014">.</span><span class="ident" id="8211015">Logf</span><span class="op" id="8211019">(</span><span class="string" id="8211020">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="8211032">,</span>&nbsp;<span class="ident" id="8211034">data</span><span class="op" id="8211038">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211042">t</span><span class="op" id="8211043">.</span><span class="ident" id="8211044">Fatalf</span><span class="op" id="8211050">(</span><span class="string" id="8211051">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="8211076">,</span>&nbsp;<span class="ident" id="8211078">err</span><span class="op" id="8211081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8211087">if</span>&nbsp;<span class="ident" id="8211090">g</span><span class="op" id="8211091">,</span>&nbsp;<span class="ident" id="8211093">e</span>&nbsp;<span class="op" id="8211095">:=</span>&nbsp;<span class="builtintype" id="8211098">string</span><span class="op" id="8211104">(</span><span class="ident" id="8211105">data</span><span class="op" id="8211109">)</span><span class="op" id="8211110">,</span>&nbsp;<span class="ident" id="8211112">chunk1</span><span class="op" id="8211118">+</span><span class="ident" id="8211119">chunk2</span><span class="op" id="8211125">;</span>&nbsp;<span class="ident" id="8211127">g</span>&nbsp;<span class="op" id="8211129">!=</span>&nbsp;<span class="ident" id="8211132">e</span>&nbsp;<span class="op" id="8211134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211138">t</span><span class="op" id="8211139">.</span><span class="ident" id="8211140">Errorf</span><span class="op" id="8211146">(</span><span class="string" id="8211147">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8211178">,</span>&nbsp;<span class="ident" id="8211180">g</span><span class="op" id="8211181">,</span>&nbsp;<span class="ident" id="8211183">e</span><span class="op" id="8211184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211187">}</span><br>
<span class="lineno">40</span><span class="op" id="8211189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8211192">func</span>&nbsp;<span class="ident" id="8211197">TestChunkReadMultiple</span><span class="op" id="8211218">(</span><span class="ident" id="8211219">t</span>&nbsp;<span class="op" id="8211221">*</span><span class="ident" id="8211222">testing</span><span class="op" id="8211229">.</span><span class="ident" id="8211230">T</span><span class="op" id="8211231">)</span>&nbsp;<span class="op" id="8211233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8211236">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211282">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8211286">var</span>&nbsp;<span class="ident" id="8211290">b</span>&nbsp;<span class="ident" id="8211292">bytes</span><span class="op" id="8211297">.</span><span class="ident" id="8211298">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211307">w</span>&nbsp;<span class="op" id="8211309">:=</span>&nbsp;<span class="ident" id="8211312">NewChunkedWriter</span><span class="op" id="8211328">(</span><span class="op" id="8211329">&amp;</span><span class="ident" id="8211330">b</span><span class="op" id="8211331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211335">w</span><span class="op" id="8211336">.</span><span class="ident" id="8211337">Write</span><span class="op" id="8211342">(</span><span class="op" id="8211343">[</span><span class="op" id="8211344">]</span><span class="builtintype" id="8211345">byte</span><span class="op" id="8211349">(</span><span class="string" id="8211350">&#34;foo&#34;</span><span class="op" id="8211355">)</span><span class="op" id="8211356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211360">w</span><span class="op" id="8211361">.</span><span class="ident" id="8211362">Write</span><span class="op" id="8211367">(</span><span class="op" id="8211368">[</span><span class="op" id="8211369">]</span><span class="builtintype" id="8211370">byte</span><span class="op" id="8211374">(</span><span class="string" id="8211375">&#34;bar&#34;</span><span class="op" id="8211380">)</span><span class="op" id="8211381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211385">w</span><span class="op" id="8211386">.</span><span class="ident" id="8211387">Close</span><span class="op" id="8211392">(</span><span class="op" id="8211393">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211398">r</span>&nbsp;<span class="op" id="8211400">:=</span>&nbsp;<span class="ident" id="8211403">NewChunkedReader</span><span class="op" id="8211419">(</span><span class="op" id="8211420">&amp;</span><span class="ident" id="8211421">b</span><span class="op" id="8211422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211426">buf</span>&nbsp;<span class="op" id="8211430">:=</span>&nbsp;<span class="builtinfunc" id="8211433">make</span><span class="op" id="8211437">(</span><span class="op" id="8211438">[</span><span class="op" id="8211439">]</span><span class="builtintype" id="8211440">byte</span><span class="op" id="8211444">,</span>&nbsp;<span class="num" id="8211446">10</span><span class="op" id="8211448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211452">n</span><span class="op" id="8211453">,</span>&nbsp;<span class="ident" id="8211455">err</span>&nbsp;<span class="op" id="8211459">:=</span>&nbsp;<span class="ident" id="8211462">r</span><span class="op" id="8211463">.</span><span class="ident" id="8211464">Read</span><span class="op" id="8211468">(</span><span class="ident" id="8211469">buf</span><span class="op" id="8211472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8211476">if</span>&nbsp;<span class="ident" id="8211479">n</span>&nbsp;<span class="op" id="8211481">!=</span>&nbsp;<span class="num" id="8211484">6</span>&nbsp;<span class="op" id="8211486">||</span>&nbsp;<span class="ident" id="8211489">err</span>&nbsp;<span class="op" id="8211493">!=</span>&nbsp;<span class="ident" id="8211496">io</span><span class="op" id="8211498">.</span><span class="ident" id="8211499">EOF</span>&nbsp;<span class="op" id="8211503">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211508">t</span><span class="op" id="8211509">.</span><span class="ident" id="8211510">Errorf</span><span class="op" id="8211516">(</span><span class="string" id="8211517">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="8211545">,</span>&nbsp;<span class="ident" id="8211547">n</span><span class="op" id="8211548">,</span>&nbsp;<span class="ident" id="8211550">err</span><span class="op" id="8211553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211561">buf</span>&nbsp;<span class="op" id="8211565">=</span>&nbsp;<span class="ident" id="8211567">buf</span><span class="op" id="8211570">[</span><span class="op" id="8211571">:</span><span class="ident" id="8211572">n</span><span class="op" id="8211573">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8211577">if</span>&nbsp;<span class="builtintype" id="8211580">string</span><span class="op" id="8211586">(</span><span class="ident" id="8211587">buf</span><span class="op" id="8211590">)</span>&nbsp;<span class="op" id="8211592">!=</span>&nbsp;<span class="string" id="8211595">&#34;foobar&#34;</span>&nbsp;<span class="op" id="8211604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211609">t</span><span class="op" id="8211610">.</span><span class="ident" id="8211611">Errorf</span><span class="op" id="8211617">(</span><span class="string" id="8211618">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8211638">,</span>&nbsp;<span class="ident" id="8211640">buf</span><span class="op" id="8211643">,</span>&nbsp;<span class="string" id="8211645">&#34;foobar&#34;</span><span class="op" id="8211653">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8211664">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8211742">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8211802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8211806">var</span>&nbsp;<span class="ident" id="8211810">b</span>&nbsp;<span class="ident" id="8211812">bytes</span><span class="op" id="8211817">.</span><span class="ident" id="8211818">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8211827">w</span>&nbsp;<span class="op" id="8211829">:=</span>&nbsp;<span class="ident" id="8211832">NewChunkedWriter</span><span class="op" id="8211848">(</span><span class="op" id="8211849">&amp;</span><span class="ident" id="8211850">b</span><span class="op" id="8211851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8211855">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8211931">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8211998">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8212073">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8212136">const</span>&nbsp;<span class="ident" id="8212142">fillBufChunk</span>&nbsp;<span class="op" id="8212155">=</span>&nbsp;<span class="string" id="8212157">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8212173">const</span>&nbsp;<span class="ident" id="8212179">shortChunk</span>&nbsp;<span class="op" id="8212190">=</span>&nbsp;<span class="string" id="8212192">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212200">w</span><span class="op" id="8212201">.</span><span class="ident" id="8212202">Write</span><span class="op" id="8212207">(</span><span class="op" id="8212208">[</span><span class="op" id="8212209">]</span><span class="builtintype" id="8212210">byte</span><span class="op" id="8212214">(</span><span class="ident" id="8212215">fillBufChunk</span><span class="op" id="8212227">)</span><span class="op" id="8212228">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212232">w</span><span class="op" id="8212233">.</span><span class="ident" id="8212234">Write</span><span class="op" id="8212239">(</span><span class="op" id="8212240">[</span><span class="op" id="8212241">]</span><span class="builtintype" id="8212242">byte</span><span class="op" id="8212246">(</span><span class="ident" id="8212247">shortChunk</span><span class="op" id="8212257">)</span><span class="op" id="8212258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212262">w</span><span class="op" id="8212263">.</span><span class="ident" id="8212264">Close</span><span class="op" id="8212269">(</span><span class="op" id="8212270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212275">r</span>&nbsp;<span class="op" id="8212277">:=</span>&nbsp;<span class="ident" id="8212280">NewChunkedReader</span><span class="op" id="8212296">(</span><span class="ident" id="8212297">bufio</span><span class="op" id="8212302">.</span><span class="ident" id="8212303">NewReaderSize</span><span class="op" id="8212316">(</span><span class="op" id="8212317">&amp;</span><span class="ident" id="8212318">b</span><span class="op" id="8212319">,</span>&nbsp;<span class="num" id="8212321">16</span><span class="op" id="8212323">)</span><span class="op" id="8212324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212328">buf</span>&nbsp;<span class="op" id="8212332">:=</span>&nbsp;<span class="builtinfunc" id="8212335">make</span><span class="op" id="8212339">(</span><span class="op" id="8212340">[</span><span class="op" id="8212341">]</span><span class="builtintype" id="8212342">byte</span><span class="op" id="8212346">,</span>&nbsp;<span class="builtinfunc" id="8212348">len</span><span class="op" id="8212351">(</span><span class="ident" id="8212352">fillBufChunk</span><span class="op" id="8212364">)</span><span class="op" id="8212365">+</span><span class="builtinfunc" id="8212366">len</span><span class="op" id="8212369">(</span><span class="ident" id="8212370">shortChunk</span><span class="op" id="8212380">)</span><span class="op" id="8212381">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212385">n</span><span class="op" id="8212386">,</span>&nbsp;<span class="ident" id="8212388">err</span>&nbsp;<span class="op" id="8212392">:=</span>&nbsp;<span class="ident" id="8212395">r</span><span class="op" id="8212396">.</span><span class="ident" id="8212397">Read</span><span class="op" id="8212401">(</span><span class="ident" id="8212402">buf</span><span class="op" id="8212405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8212409">if</span>&nbsp;<span class="ident" id="8212412">n</span>&nbsp;<span class="op" id="8212414">!=</span>&nbsp;<span class="builtinfunc" id="8212417">len</span><span class="op" id="8212420">(</span><span class="ident" id="8212421">fillBufChunk</span><span class="op" id="8212433">)</span>&nbsp;<span class="op" id="8212435">||</span>&nbsp;<span class="ident" id="8212438">err</span>&nbsp;<span class="op" id="8212442">!=</span>&nbsp;<span class="ident" id="8212445">nil</span>&nbsp;<span class="op" id="8212449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212454">t</span><span class="op" id="8212455">.</span><span class="ident" id="8212456">Errorf</span><span class="op" id="8212462">(</span><span class="string" id="8212463">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="8212492">,</span>&nbsp;<span class="ident" id="8212494">n</span><span class="op" id="8212495">,</span>&nbsp;<span class="ident" id="8212497">err</span><span class="op" id="8212500">,</span>&nbsp;<span class="builtinfunc" id="8212502">len</span><span class="op" id="8212505">(</span><span class="ident" id="8212506">fillBufChunk</span><span class="op" id="8212518">)</span><span class="op" id="8212519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8212523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212527">buf</span>&nbsp;<span class="op" id="8212531">=</span>&nbsp;<span class="ident" id="8212533">buf</span><span class="op" id="8212536">[</span><span class="op" id="8212537">:</span><span class="ident" id="8212538">n</span><span class="op" id="8212539">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8212543">if</span>&nbsp;<span class="builtintype" id="8212546">string</span><span class="op" id="8212552">(</span><span class="ident" id="8212553">buf</span><span class="op" id="8212556">)</span>&nbsp;<span class="op" id="8212558">!=</span>&nbsp;<span class="ident" id="8212561">fillBufChunk</span>&nbsp;<span class="op" id="8212574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212579">t</span><span class="op" id="8212580">.</span><span class="ident" id="8212581">Errorf</span><span class="op" id="8212587">(</span><span class="string" id="8212588">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8212608">,</span>&nbsp;<span class="ident" id="8212610">buf</span><span class="op" id="8212613">,</span>&nbsp;<span class="ident" id="8212615">fillBufChunk</span><span class="op" id="8212627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8212631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212636">n</span><span class="op" id="8212637">,</span>&nbsp;<span class="ident" id="8212639">err</span>&nbsp;<span class="op" id="8212643">=</span>&nbsp;<span class="ident" id="8212645">r</span><span class="op" id="8212646">.</span><span class="ident" id="8212647">Read</span><span class="op" id="8212651">(</span><span class="ident" id="8212652">buf</span><span class="op" id="8212655">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8212659">if</span>&nbsp;<span class="ident" id="8212662">n</span>&nbsp;<span class="op" id="8212664">!=</span>&nbsp;<span class="builtinfunc" id="8212667">len</span><span class="op" id="8212670">(</span><span class="ident" id="8212671">shortChunk</span><span class="op" id="8212681">)</span>&nbsp;<span class="op" id="8212683">||</span>&nbsp;<span class="ident" id="8212686">err</span>&nbsp;<span class="op" id="8212690">!=</span>&nbsp;<span class="ident" id="8212693">io</span><span class="op" id="8212695">.</span><span class="ident" id="8212696">EOF</span>&nbsp;<span class="op" id="8212700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212705">t</span><span class="op" id="8212706">.</span><span class="ident" id="8212707">Errorf</span><span class="op" id="8212713">(</span><span class="string" id="8212714">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="8212743">,</span>&nbsp;<span class="ident" id="8212745">n</span><span class="op" id="8212746">,</span>&nbsp;<span class="ident" id="8212748">err</span><span class="op" id="8212751">,</span>&nbsp;<span class="builtinfunc" id="8212753">len</span><span class="op" id="8212756">(</span><span class="ident" id="8212757">shortChunk</span><span class="op" id="8212767">)</span><span class="op" id="8212768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8212772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8212775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8212779">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8212858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212862">r</span>&nbsp;<span class="op" id="8212864">:=</span>&nbsp;<span class="ident" id="8212867">NewChunkedReader</span><span class="op" id="8212883">(</span><span class="ident" id="8212884">bufio</span><span class="op" id="8212889">.</span><span class="ident" id="8212890">NewReader</span><span class="op" id="8212899">(</span><span class="ident" id="8212900">strings</span><span class="op" id="8212907">.</span><span class="ident" id="8212908">NewReader</span><span class="op" id="8212917">(</span><span class="string" id="8212918">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="8212937">)</span><span class="op" id="8212938">)</span><span class="op" id="8212939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212943">buf</span>&nbsp;<span class="op" id="8212947">:=</span>&nbsp;<span class="builtinfunc" id="8212950">make</span><span class="op" id="8212954">(</span><span class="op" id="8212955">[</span><span class="op" id="8212956">]</span><span class="builtintype" id="8212957">byte</span><span class="op" id="8212961">,</span>&nbsp;<span class="num" id="8212963">3</span><span class="op" id="8212964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8212968">n</span><span class="op" id="8212969">,</span>&nbsp;<span class="ident" id="8212971">err</span>&nbsp;<span class="op" id="8212975">:=</span>&nbsp;<span class="ident" id="8212978">r</span><span class="op" id="8212979">.</span><span class="ident" id="8212980">Read</span><span class="op" id="8212984">(</span><span class="ident" id="8212985">buf</span><span class="op" id="8212988">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8212992">if</span>&nbsp;<span class="ident" id="8212995">n</span>&nbsp;<span class="op" id="8212997">!=</span>&nbsp;<span class="num" id="8213000">3</span>&nbsp;<span class="op" id="8213002">||</span>&nbsp;<span class="ident" id="8213005">err</span>&nbsp;<span class="op" id="8213009">!=</span>&nbsp;<span class="ident" id="8213012">io</span><span class="op" id="8213014">.</span><span class="ident" id="8213015">EOF</span>&nbsp;<span class="op" id="8213019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213024">t</span><span class="op" id="8213025">.</span><span class="ident" id="8213026">Errorf</span><span class="op" id="8213032">(</span><span class="string" id="8213033">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="8213061">,</span>&nbsp;<span class="ident" id="8213063">n</span><span class="op" id="8213064">,</span>&nbsp;<span class="ident" id="8213066">err</span><span class="op" id="8213069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8213077">if</span>&nbsp;<span class="builtintype" id="8213080">string</span><span class="op" id="8213086">(</span><span class="ident" id="8213087">buf</span><span class="op" id="8213090">)</span>&nbsp;<span class="op" id="8213092">!=</span>&nbsp;<span class="string" id="8213095">&#34;foo&#34;</span>&nbsp;<span class="op" id="8213101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213106">t</span><span class="op" id="8213107">.</span><span class="ident" id="8213108">Errorf</span><span class="op" id="8213114">(</span><span class="string" id="8213115">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="8213135">,</span>&nbsp;<span class="ident" id="8213137">buf</span><span class="op" id="8213140">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213147">}</span><br>
<span class="lineno"></span><span class="op" id="8213149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8213152">func</span>&nbsp;<span class="ident" id="8213157">TestChunkReaderAllocs</span><span class="op" id="8213178">(</span><span class="ident" id="8213179">t</span>&nbsp;<span class="op" id="8213181">*</span><span class="ident" id="8213182">testing</span><span class="op" id="8213189">.</span><span class="ident" id="8213190">T</span><span class="op" id="8213191">)</span>&nbsp;<span class="op" id="8213193">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8213196">if</span>&nbsp;<span class="ident" id="8213199">testing</span><span class="op" id="8213206">.</span><span class="ident" id="8213207">Short</span><span class="op" id="8213212">(</span><span class="op" id="8213213">)</span>&nbsp;<span class="op" id="8213215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213219">t</span><span class="op" id="8213220">.</span><span class="ident" id="8213221">Skip</span><span class="op" id="8213225">(</span><span class="string" id="8213226">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8213250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8213256">var</span>&nbsp;<span class="ident" id="8213260">buf</span>&nbsp;<span class="ident" id="8213264">bytes</span><span class="op" id="8213269">.</span><span class="ident" id="8213270">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213278">w</span>&nbsp;<span class="op" id="8213280">:=</span>&nbsp;<span class="ident" id="8213283">NewChunkedWriter</span><span class="op" id="8213299">(</span><span class="op" id="8213300">&amp;</span><span class="ident" id="8213301">buf</span><span class="op" id="8213304">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213307">a</span><span class="op" id="8213308">,</span>&nbsp;<span class="ident" id="8213310">b</span><span class="op" id="8213311">,</span>&nbsp;<span class="ident" id="8213313">c</span>&nbsp;<span class="op" id="8213315">:=</span>&nbsp;<span class="op" id="8213318">[</span><span class="op" id="8213319">]</span><span class="builtintype" id="8213320">byte</span><span class="op" id="8213324">(</span><span class="string" id="8213325">&#34;aaaaaa&#34;</span><span class="op" id="8213333">)</span><span class="op" id="8213334">,</span>&nbsp;<span class="op" id="8213336">[</span><span class="op" id="8213337">]</span><span class="builtintype" id="8213338">byte</span><span class="op" id="8213342">(</span><span class="string" id="8213343">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="8213357">)</span><span class="op" id="8213358">,</span>&nbsp;<span class="op" id="8213360">[</span><span class="op" id="8213361">]</span><span class="builtintype" id="8213362">byte</span><span class="op" id="8213366">(</span><span class="string" id="8213367">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="8213393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213396">w</span><span class="op" id="8213397">.</span><span class="ident" id="8213398">Write</span><span class="op" id="8213403">(</span><span class="ident" id="8213404">a</span><span class="op" id="8213405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213408">w</span><span class="op" id="8213409">.</span><span class="ident" id="8213410">Write</span><span class="op" id="8213415">(</span><span class="ident" id="8213416">b</span><span class="op" id="8213417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213420">w</span><span class="op" id="8213421">.</span><span class="ident" id="8213422">Write</span><span class="op" id="8213427">(</span><span class="ident" id="8213428">c</span><span class="op" id="8213429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213432">w</span><span class="op" id="8213433">.</span><span class="ident" id="8213434">Close</span><span class="op" id="8213439">(</span><span class="op" id="8213440">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213444">readBuf</span>&nbsp;<span class="op" id="8213452">:=</span>&nbsp;<span class="builtinfunc" id="8213455">make</span><span class="op" id="8213459">(</span><span class="op" id="8213460">[</span><span class="op" id="8213461">]</span><span class="builtintype" id="8213462">byte</span><span class="op" id="8213466">,</span>&nbsp;<span class="builtinfunc" id="8213468">len</span><span class="op" id="8213471">(</span><span class="ident" id="8213472">a</span><span class="op" id="8213473">)</span><span class="op" id="8213474">+</span><span class="builtinfunc" id="8213475">len</span><span class="op" id="8213478">(</span><span class="ident" id="8213479">b</span><span class="op" id="8213480">)</span><span class="op" id="8213481">+</span><span class="builtinfunc" id="8213482">len</span><span class="op" id="8213485">(</span><span class="ident" id="8213486">c</span><span class="op" id="8213487">)</span><span class="op" id="8213488">+</span><span class="num" id="8213489">1</span><span class="op" id="8213490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213493">byter</span>&nbsp;<span class="op" id="8213499">:=</span>&nbsp;<span class="ident" id="8213502">bytes</span><span class="op" id="8213507">.</span><span class="ident" id="8213508">NewReader</span><span class="op" id="8213517">(</span><span class="ident" id="8213518">buf</span><span class="op" id="8213521">.</span><span class="ident" id="8213522">Bytes</span><span class="op" id="8213527">(</span><span class="op" id="8213528">)</span><span class="op" id="8213529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213532">bufr</span>&nbsp;<span class="op" id="8213537">:=</span>&nbsp;<span class="ident" id="8213540">bufio</span><span class="op" id="8213545">.</span><span class="ident" id="8213546">NewReader</span><span class="op" id="8213555">(</span><span class="ident" id="8213556">byter</span><span class="op" id="8213561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213564">mallocs</span>&nbsp;<span class="op" id="8213572">:=</span>&nbsp;<span class="ident" id="8213575">testing</span><span class="op" id="8213582">.</span><span class="ident" id="8213583">AllocsPerRun</span><span class="op" id="8213595">(</span><span class="num" id="8213596">100</span><span class="op" id="8213599">,</span>&nbsp;<span class="keyword" id="8213601">func</span><span class="op" id="8213605">(</span><span class="op" id="8213606">)</span>&nbsp;<span class="op" id="8213608">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213612">byter</span><span class="op" id="8213617">.</span><span class="ident" id="8213618">Seek</span><span class="op" id="8213622">(</span><span class="num" id="8213623">0</span><span class="op" id="8213624">,</span>&nbsp;<span class="num" id="8213626">0</span><span class="op" id="8213627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213631">bufr</span><span class="op" id="8213635">.</span><span class="ident" id="8213636">Reset</span><span class="op" id="8213641">(</span><span class="ident" id="8213642">byter</span><span class="op" id="8213647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213651">r</span>&nbsp;<span class="op" id="8213653">:=</span>&nbsp;<span class="ident" id="8213656">NewChunkedReader</span><span class="op" id="8213672">(</span><span class="ident" id="8213673">bufr</span><span class="op" id="8213677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213681">n</span><span class="op" id="8213682">,</span>&nbsp;<span class="ident" id="8213684">err</span>&nbsp;<span class="op" id="8213688">:=</span>&nbsp;<span class="ident" id="8213691">io</span><span class="op" id="8213693">.</span><span class="ident" id="8213694">ReadFull</span><span class="op" id="8213702">(</span><span class="ident" id="8213703">r</span><span class="op" id="8213704">,</span>&nbsp;<span class="ident" id="8213706">readBuf</span><span class="op" id="8213713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8213717">if</span>&nbsp;<span class="ident" id="8213720">n</span>&nbsp;<span class="op" id="8213722">!=</span>&nbsp;<span class="builtinfunc" id="8213725">len</span><span class="op" id="8213728">(</span><span class="ident" id="8213729">readBuf</span><span class="op" id="8213736">)</span><span class="op" id="8213737">-</span><span class="num" id="8213738">1</span>&nbsp;<span class="op" id="8213740">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213745">t</span><span class="op" id="8213746">.</span><span class="ident" id="8213747">Fatalf</span><span class="op" id="8213753">(</span><span class="string" id="8213754">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8213778">,</span>&nbsp;<span class="ident" id="8213780">n</span><span class="op" id="8213781">,</span>&nbsp;<span class="builtinfunc" id="8213783">len</span><span class="op" id="8213786">(</span><span class="ident" id="8213787">readBuf</span><span class="op" id="8213794">)</span><span class="op" id="8213795">-</span><span class="num" id="8213796">1</span><span class="op" id="8213797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8213805">if</span>&nbsp;<span class="ident" id="8213808">err</span>&nbsp;<span class="op" id="8213812">!=</span>&nbsp;<span class="ident" id="8213815">io</span><span class="op" id="8213817">.</span><span class="ident" id="8213818">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="8213835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213840">t</span><span class="op" id="8213841">.</span><span class="ident" id="8213842">Fatalf</span><span class="op" id="8213848">(</span><span class="string" id="8213849">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="8213889">,</span>&nbsp;<span class="ident" id="8213891">err</span><span class="op" id="8213894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213898">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213901">}</span><span class="op" id="8213902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8213905">if</span>&nbsp;<span class="ident" id="8213908">mallocs</span>&nbsp;<span class="op" id="8213916">&gt;</span>&nbsp;<span class="num" id="8213918">1.5</span>&nbsp;<span class="op" id="8213922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8213926">t</span><span class="op" id="8213927">.</span><span class="ident" id="8213928">Errorf</span><span class="op" id="8213934">(</span><span class="string" id="8213935">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8213957">,</span>&nbsp;<span class="ident" id="8213959">mallocs</span><span class="op" id="8213966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8213969">}</span><br>
<span class="lineno"></span><span class="op" id="8213971">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="8213974">func</span>&nbsp;<span class="ident" id="8213979">TestParseHexUint</span><span class="op" id="8213995">(</span><span class="ident" id="8213996">t</span>&nbsp;<span class="op" id="8213998">*</span><span class="ident" id="8213999">testing</span><span class="op" id="8214006">.</span><span class="ident" id="8214007">T</span><span class="op" id="8214008">)</span>&nbsp;<span class="op" id="8214010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8214013">for</span>&nbsp;<span class="ident" id="8214017">i</span>&nbsp;<span class="op" id="8214019">:=</span>&nbsp;<span class="ident" id="8214022">uint64</span><span class="op" id="8214028">(</span><span class="num" id="8214029">0</span><span class="op" id="8214030">)</span><span class="op" id="8214031">;</span>&nbsp;<span class="ident" id="8214033">i</span>&nbsp;<span class="op" id="8214035">&lt;=</span>&nbsp;<span class="num" id="8214038">1234</span><span class="op" id="8214042">;</span>&nbsp;<span class="ident" id="8214044">i</span><span class="op" id="8214045">++</span>&nbsp;<span class="op" id="8214048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8214052">line</span>&nbsp;<span class="op" id="8214057">:=</span>&nbsp;<span class="op" id="8214060">[</span><span class="op" id="8214061">]</span><span class="builtintype" id="8214062">byte</span><span class="op" id="8214066">(</span><span class="ident" id="8214067">fmt</span><span class="op" id="8214070">.</span><span class="ident" id="8214071">Sprintf</span><span class="op" id="8214078">(</span><span class="string" id="8214079">&#34;%x&#34;</span><span class="op" id="8214083">,</span>&nbsp;<span class="ident" id="8214085">i</span><span class="op" id="8214086">)</span><span class="op" id="8214087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8214091">got</span><span class="op" id="8214094">,</span>&nbsp;<span class="ident" id="8214096">err</span>&nbsp;<span class="op" id="8214100">:=</span>&nbsp;<span class="ident" id="8214103">parseHexUint</span><span class="op" id="8214115">(</span><span class="ident" id="8214116">line</span><span class="op" id="8214120">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8214124">if</span>&nbsp;<span class="ident" id="8214127">err</span>&nbsp;<span class="op" id="8214131">!=</span>&nbsp;<span class="ident" id="8214134">nil</span>&nbsp;<span class="op" id="8214138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8214143">t</span><span class="op" id="8214144">.</span><span class="ident" id="8214145">Fatalf</span><span class="op" id="8214151">(</span><span class="string" id="8214152">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="8214163">,</span>&nbsp;<span class="ident" id="8214165">i</span><span class="op" id="8214166">,</span>&nbsp;<span class="ident" id="8214168">err</span><span class="op" id="8214171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8214175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8214179">if</span>&nbsp;<span class="ident" id="8214182">got</span>&nbsp;<span class="op" id="8214186">!=</span>&nbsp;<span class="ident" id="8214189">i</span>&nbsp;<span class="op" id="8214191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8214196">t</span><span class="op" id="8214197">.</span><span class="ident" id="8214198">Errorf</span><span class="op" id="8214204">(</span><span class="string" id="8214205">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8214233">,</span>&nbsp;<span class="ident" id="8214235">line</span><span class="op" id="8214239">,</span>&nbsp;<span class="ident" id="8214241">got</span><span class="op" id="8214244">,</span>&nbsp;<span class="ident" id="8214246">i</span><span class="op" id="8214247">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8214251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8214254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8214257">_</span><span class="op" id="8214258">,</span>&nbsp;<span class="ident" id="8214260">err</span>&nbsp;<span class="op" id="8214264">:=</span>&nbsp;<span class="ident" id="8214267">parseHexUint</span><span class="op" id="8214279">(</span><span class="op" id="8214280">[</span><span class="op" id="8214281">]</span><span class="builtintype" id="8214282">byte</span><span class="op" id="8214286">(</span><span class="string" id="8214287">&#34;bogus&#34;</span><span class="op" id="8214294">)</span><span class="op" id="8214295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8214298">if</span>&nbsp;<span class="ident" id="8214301">err</span>&nbsp;<span class="op" id="8214305">==</span>&nbsp;<span class="ident" id="8214308">nil</span>&nbsp;<span class="op" id="8214312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8214316">t</span><span class="op" id="8214317">.</span><span class="ident" id="8214318">Error</span><span class="op" id="8214323">(</span><span class="string" id="8214324">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="8214355">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8214358">}</span><br>
<span class="lineno"></span><span class="op" id="8214360">}</span>
</div>
</body>
</html>
