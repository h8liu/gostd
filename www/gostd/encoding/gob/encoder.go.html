<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html" class="current">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4977679">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4977734">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4977788">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4977839">package</span>&nbsp;<span class="ident" id="4977847">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4977852">import</span>&nbsp;<span class="op" id="4977859">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4977862">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4977868">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4977879">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4977886">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4977889">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4977964">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="4977995">type</span>&nbsp;<span class="ident" id="4978000">Encoder</span>&nbsp;<span class="keyword" id="4978008">struct</span>&nbsp;<span class="op" id="4978015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978018">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978029">sync</span><span class="op" id="4978033">.</span><span class="ident" id="4978034">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4978053">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978091">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4978102">[</span><span class="op" id="4978103">]</span><span class="ident" id="4978104">io</span><span class="op" id="4978106">.</span><span class="ident" id="4978107">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4978126">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978153">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4978164">map</span><span class="op" id="4978167">[</span><span class="ident" id="4978168">reflect</span><span class="op" id="4978175">.</span><span class="ident" id="4978176">Type</span><span class="op" id="4978180">]</span><span class="ident" id="4978181">typeId</span>&nbsp;<span class="comment" id="4978188">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978223">countState</span>&nbsp;<span class="op" id="4978234">*</span><span class="ident" id="4978235">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4978258">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978287">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4978298">*</span><span class="ident" id="4978299">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4978322">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978374">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978385">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4978409">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978447">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4978458">error</span><br>
<span class="lineno"></span><span class="op" id="4978464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4978467">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4978534">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4978601">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4978663">const</span>&nbsp;<span class="ident" id="4978669">maxLength</span>&nbsp;<span class="op" id="4978679">=</span>&nbsp;<span class="num" id="4978681">9</span>&nbsp;<span class="comment" id="4978683">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4978721">var</span>&nbsp;<span class="ident" id="4978725">spaceForLength</span>&nbsp;<span class="op" id="4978740">=</span>&nbsp;<span class="builtinfunc" id="4978742">make</span><span class="op" id="4978746">(</span><span class="op" id="4978747">[</span><span class="op" id="4978748">]</span><span class="builtintype" id="4978749">byte</span><span class="op" id="4978753">,</span>&nbsp;<span class="ident" id="4978755">maxLength</span><span class="op" id="4978764">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4978767">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4978840">func</span>&nbsp;<span class="ident" id="4978845">NewEncoder</span><span class="op" id="4978855">(</span><span class="ident" id="4978856">w</span>&nbsp;<span class="ident" id="4978858">io</span><span class="op" id="4978860">.</span><span class="ident" id="4978861">Writer</span><span class="op" id="4978867">)</span>&nbsp;<span class="op" id="4978869">*</span><span class="ident" id="4978870">Encoder</span>&nbsp;<span class="op" id="4978878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978881">enc</span>&nbsp;<span class="op" id="4978885">:=</span>&nbsp;<span class="builtinfunc" id="4978888">new</span><span class="op" id="4978891">(</span><span class="ident" id="4978892">Encoder</span><span class="op" id="4978899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978902">enc</span><span class="op" id="4978905">.</span><span class="ident" id="4978906">w</span>&nbsp;<span class="op" id="4978908">=</span>&nbsp;<span class="op" id="4978910">[</span><span class="op" id="4978911">]</span><span class="ident" id="4978912">io</span><span class="op" id="4978914">.</span><span class="ident" id="4978915">Writer</span><span class="op" id="4978921">{</span><span class="ident" id="4978922">w</span><span class="op" id="4978923">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978926">enc</span><span class="op" id="4978929">.</span><span class="ident" id="4978930">sent</span>&nbsp;<span class="op" id="4978935">=</span>&nbsp;<span class="builtinfunc" id="4978937">make</span><span class="op" id="4978941">(</span><span class="keyword" id="4978942">map</span><span class="op" id="4978945">[</span><span class="ident" id="4978946">reflect</span><span class="op" id="4978953">.</span><span class="ident" id="4978954">Type</span><span class="op" id="4978958">]</span><span class="ident" id="4978959">typeId</span><span class="op" id="4978965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978968">enc</span><span class="op" id="4978971">.</span><span class="ident" id="4978972">countState</span>&nbsp;<span class="op" id="4978983">=</span>&nbsp;<span class="ident" id="4978985">enc</span><span class="op" id="4978988">.</span><span class="ident" id="4978989">newEncoderState</span><span class="op" id="4979004">(</span><span class="builtinfunc" id="4979005">new</span><span class="op" id="4979008">(</span><span class="ident" id="4979009">encBuffer</span><span class="op" id="4979018">)</span><span class="op" id="4979019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979022">return</span>&nbsp;<span class="ident" id="4979029">enc</span><br>
<span class="lineno"></span><span class="op" id="4979033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4979036">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="4979098">func</span>&nbsp;<span class="op" id="4979103">(</span><span class="ident" id="4979104">enc</span>&nbsp;<span class="op" id="4979108">*</span><span class="ident" id="4979109">Encoder</span><span class="op" id="4979116">)</span>&nbsp;<span class="ident" id="4979118">writer</span><span class="op" id="4979124">(</span><span class="op" id="4979125">)</span>&nbsp;<span class="ident" id="4979127">io</span><span class="op" id="4979129">.</span><span class="ident" id="4979130">Writer</span>&nbsp;<span class="op" id="4979137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979140">return</span>&nbsp;<span class="ident" id="4979147">enc</span><span class="op" id="4979150">.</span><span class="ident" id="4979151">w</span><span class="op" id="4979152">[</span><span class="builtinfunc" id="4979153">len</span><span class="op" id="4979156">(</span><span class="ident" id="4979157">enc</span><span class="op" id="4979160">.</span><span class="ident" id="4979161">w</span><span class="op" id="4979162">)</span><span class="op" id="4979163">-</span><span class="num" id="4979164">1</span><span class="op" id="4979165">]</span><br>
<span class="lineno"></span><span class="op" id="4979167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4979170">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4979214">func</span>&nbsp;<span class="op" id="4979219">(</span><span class="ident" id="4979220">enc</span>&nbsp;<span class="op" id="4979224">*</span><span class="ident" id="4979225">Encoder</span><span class="op" id="4979232">)</span>&nbsp;<span class="ident" id="4979234">pushWriter</span><span class="op" id="4979244">(</span><span class="ident" id="4979245">w</span>&nbsp;<span class="ident" id="4979247">io</span><span class="op" id="4979249">.</span><span class="ident" id="4979250">Writer</span><span class="op" id="4979256">)</span>&nbsp;<span class="op" id="4979258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979261">enc</span><span class="op" id="4979264">.</span><span class="ident" id="4979265">w</span>&nbsp;<span class="op" id="4979267">=</span>&nbsp;<span class="builtinfunc" id="4979269">append</span><span class="op" id="4979275">(</span><span class="ident" id="4979276">enc</span><span class="op" id="4979279">.</span><span class="ident" id="4979280">w</span><span class="op" id="4979281">,</span>&nbsp;<span class="ident" id="4979283">w</span><span class="op" id="4979284">)</span><br>
<span class="lineno"></span><span class="op" id="4979286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4979289">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4979329">func</span>&nbsp;<span class="op" id="4979334">(</span><span class="ident" id="4979335">enc</span>&nbsp;<span class="op" id="4979339">*</span><span class="ident" id="4979340">Encoder</span><span class="op" id="4979347">)</span>&nbsp;<span class="ident" id="4979349">popWriter</span><span class="op" id="4979358">(</span><span class="op" id="4979359">)</span>&nbsp;<span class="op" id="4979361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979364">enc</span><span class="op" id="4979367">.</span><span class="ident" id="4979368">w</span>&nbsp;<span class="op" id="4979370">=</span>&nbsp;<span class="ident" id="4979372">enc</span><span class="op" id="4979375">.</span><span class="ident" id="4979376">w</span><span class="op" id="4979377">[</span><span class="num" id="4979378">0</span>&nbsp;<span class="op" id="4979380">:</span>&nbsp;<span class="builtinfunc" id="4979382">len</span><span class="op" id="4979385">(</span><span class="ident" id="4979386">enc</span><span class="op" id="4979389">.</span><span class="ident" id="4979390">w</span><span class="op" id="4979391">)</span><span class="op" id="4979392">-</span><span class="num" id="4979393">1</span><span class="op" id="4979394">]</span><br>
<span class="lineno"></span><span class="op" id="4979396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4979399">func</span>&nbsp;<span class="op" id="4979404">(</span><span class="ident" id="4979405">enc</span>&nbsp;<span class="op" id="4979409">*</span><span class="ident" id="4979410">Encoder</span><span class="op" id="4979417">)</span>&nbsp;<span class="ident" id="4979419">setError</span><span class="op" id="4979427">(</span><span class="ident" id="4979428">err</span>&nbsp;<span class="builtintype" id="4979432">error</span><span class="op" id="4979437">)</span>&nbsp;<span class="op" id="4979439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979442">if</span>&nbsp;<span class="ident" id="4979445">enc</span><span class="op" id="4979448">.</span><span class="ident" id="4979449">err</span>&nbsp;<span class="op" id="4979453">==</span>&nbsp;<span class="ident" id="4979456">nil</span>&nbsp;<span class="op" id="4979460">{</span>&nbsp;<span class="comment" id="4979462">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979487">enc</span><span class="op" id="4979490">.</span><span class="ident" id="4979491">err</span>&nbsp;<span class="op" id="4979495">=</span>&nbsp;<span class="ident" id="4979497">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979502">}</span><br>
<span class="lineno"></span><span class="op" id="4979504">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4979507">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4979587">func</span>&nbsp;<span class="op" id="4979592">(</span><span class="ident" id="4979593">enc</span>&nbsp;<span class="op" id="4979597">*</span><span class="ident" id="4979598">Encoder</span><span class="op" id="4979605">)</span>&nbsp;<span class="ident" id="4979607">writeMessage</span><span class="op" id="4979619">(</span><span class="ident" id="4979620">w</span>&nbsp;<span class="ident" id="4979622">io</span><span class="op" id="4979624">.</span><span class="ident" id="4979625">Writer</span><span class="op" id="4979631">,</span>&nbsp;<span class="ident" id="4979633">b</span>&nbsp;<span class="op" id="4979635">*</span><span class="ident" id="4979636">encBuffer</span><span class="op" id="4979645">)</span>&nbsp;<span class="op" id="4979647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4979650">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4979721">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4979801">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979817">message</span>&nbsp;<span class="op" id="4979825">:=</span>&nbsp;<span class="ident" id="4979828">b</span><span class="op" id="4979829">.</span><span class="ident" id="4979830">Bytes</span><span class="op" id="4979835">(</span><span class="op" id="4979836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979839">messageLen</span>&nbsp;<span class="op" id="4979850">:=</span>&nbsp;<span class="builtinfunc" id="4979853">len</span><span class="op" id="4979856">(</span><span class="ident" id="4979857">message</span><span class="op" id="4979864">)</span>&nbsp;<span class="op" id="4979866">-</span>&nbsp;<span class="ident" id="4979868">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4979879">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979902">enc</span><span class="op" id="4979905">.</span><span class="ident" id="4979906">countState</span><span class="op" id="4979916">.</span><span class="ident" id="4979917">b</span><span class="op" id="4979918">.</span><span class="ident" id="4979919">Reset</span><span class="op" id="4979924">(</span><span class="op" id="4979925">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979928">enc</span><span class="op" id="4979931">.</span><span class="ident" id="4979932">countState</span><span class="op" id="4979942">.</span><span class="ident" id="4979943">encodeUint</span><span class="op" id="4979953">(</span><span class="ident" id="4979954">uint64</span><span class="op" id="4979960">(</span><span class="ident" id="4979961">messageLen</span><span class="op" id="4979971">)</span><span class="op" id="4979972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4979975">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980026">offset</span>&nbsp;<span class="op" id="4980033">:=</span>&nbsp;<span class="ident" id="4980036">maxLength</span>&nbsp;<span class="op" id="4980046">-</span>&nbsp;<span class="ident" id="4980048">enc</span><span class="op" id="4980051">.</span><span class="ident" id="4980052">countState</span><span class="op" id="4980062">.</span><span class="ident" id="4980063">b</span><span class="op" id="4980064">.</span><span class="ident" id="4980065">Len</span><span class="op" id="4980068">(</span><span class="op" id="4980069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4980072">copy</span><span class="op" id="4980076">(</span><span class="ident" id="4980077">message</span><span class="op" id="4980084">[</span><span class="ident" id="4980085">offset</span><span class="op" id="4980091">:</span><span class="op" id="4980092">]</span><span class="op" id="4980093">,</span>&nbsp;<span class="ident" id="4980095">enc</span><span class="op" id="4980098">.</span><span class="ident" id="4980099">countState</span><span class="op" id="4980109">.</span><span class="ident" id="4980110">b</span><span class="op" id="4980111">.</span><span class="ident" id="4980112">Bytes</span><span class="op" id="4980117">(</span><span class="op" id="4980118">)</span><span class="op" id="4980119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4980122">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980142">_</span><span class="op" id="4980143">,</span>&nbsp;<span class="ident" id="4980145">err</span>&nbsp;<span class="op" id="4980149">:=</span>&nbsp;<span class="ident" id="4980152">w</span><span class="op" id="4980153">.</span><span class="ident" id="4980154">Write</span><span class="op" id="4980159">(</span><span class="ident" id="4980160">message</span><span class="op" id="4980167">[</span><span class="ident" id="4980168">offset</span><span class="op" id="4980174">:</span><span class="op" id="4980175">]</span><span class="op" id="4980176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4980179">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980270">b</span><span class="op" id="4980271">.</span><span class="ident" id="4980272">Reset</span><span class="op" id="4980277">(</span><span class="op" id="4980278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980281">b</span><span class="op" id="4980282">.</span><span class="ident" id="4980283">Write</span><span class="op" id="4980288">(</span><span class="ident" id="4980289">spaceForLength</span><span class="op" id="4980303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980306">if</span>&nbsp;<span class="ident" id="4980309">err</span>&nbsp;<span class="op" id="4980313">!=</span>&nbsp;<span class="ident" id="4980316">nil</span>&nbsp;<span class="op" id="4980320">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980324">enc</span><span class="op" id="4980327">.</span><span class="ident" id="4980328">setError</span><span class="op" id="4980336">(</span><span class="ident" id="4980337">err</span><span class="op" id="4980340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980343">}</span><br>
<span class="lineno"></span><span class="op" id="4980345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4980348">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="4980430">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="4980456">func</span>&nbsp;<span class="op" id="4980461">(</span><span class="ident" id="4980462">enc</span>&nbsp;<span class="op" id="4980466">*</span><span class="ident" id="4980467">Encoder</span><span class="op" id="4980474">)</span>&nbsp;<span class="ident" id="4980476">sendActualType</span><span class="op" id="4980490">(</span><span class="ident" id="4980491">w</span>&nbsp;<span class="ident" id="4980493">io</span><span class="op" id="4980495">.</span><span class="ident" id="4980496">Writer</span><span class="op" id="4980502">,</span>&nbsp;<span class="ident" id="4980504">state</span>&nbsp;<span class="op" id="4980510">*</span><span class="ident" id="4980511">encoderState</span><span class="op" id="4980523">,</span>&nbsp;<span class="ident" id="4980525">ut</span>&nbsp;<span class="op" id="4980528">*</span><span class="ident" id="4980529">userTypeInfo</span><span class="op" id="4980541">,</span>&nbsp;<span class="ident" id="4980543">actual</span>&nbsp;<span class="ident" id="4980550">reflect</span><span class="op" id="4980557">.</span><span class="ident" id="4980558">Type</span><span class="op" id="4980562">)</span>&nbsp;<span class="op" id="4980564">(</span><span class="ident" id="4980565">sent</span>&nbsp;<span class="builtintype" id="4980570">bool</span><span class="op" id="4980574">)</span>&nbsp;<span class="op" id="4980576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980579">if</span>&nbsp;<span class="ident" id="4980582">_</span><span class="op" id="4980583">,</span>&nbsp;<span class="ident" id="4980585">alreadySent</span>&nbsp;<span class="op" id="4980597">:=</span>&nbsp;<span class="ident" id="4980600">enc</span><span class="op" id="4980603">.</span><span class="ident" id="4980604">sent</span><span class="op" id="4980608">[</span><span class="ident" id="4980609">actual</span><span class="op" id="4980615">]</span><span class="op" id="4980616">;</span>&nbsp;<span class="ident" id="4980618">alreadySent</span>&nbsp;<span class="op" id="4980630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980634">return</span>&nbsp;<span class="builtintype" id="4980641">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980648">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980651">info</span><span class="op" id="4980655">,</span>&nbsp;<span class="ident" id="4980657">err</span>&nbsp;<span class="op" id="4980661">:=</span>&nbsp;<span class="ident" id="4980664">getTypeInfo</span><span class="op" id="4980675">(</span><span class="ident" id="4980676">ut</span><span class="op" id="4980678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980681">if</span>&nbsp;<span class="ident" id="4980684">err</span>&nbsp;<span class="op" id="4980688">!=</span>&nbsp;<span class="ident" id="4980691">nil</span>&nbsp;<span class="op" id="4980695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980699">enc</span><span class="op" id="4980702">.</span><span class="ident" id="4980703">setError</span><span class="op" id="4980711">(</span><span class="ident" id="4980712">err</span><span class="op" id="4980715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980719">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980727">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4980730">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4980760">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980768">state</span><span class="op" id="4980773">.</span><span class="ident" id="4980774">encodeInt</span><span class="op" id="4980783">(</span><span class="op" id="4980784">-</span><span class="ident" id="4980785">int64</span><span class="op" id="4980790">(</span><span class="ident" id="4980791">info</span><span class="op" id="4980795">.</span><span class="ident" id="4980796">id</span><span class="op" id="4980798">)</span><span class="op" id="4980799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4980802">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980812">enc</span><span class="op" id="4980815">.</span><span class="ident" id="4980816">encode</span><span class="op" id="4980822">(</span><span class="ident" id="4980823">state</span><span class="op" id="4980828">.</span><span class="ident" id="4980829">b</span><span class="op" id="4980830">,</span>&nbsp;<span class="ident" id="4980832">reflect</span><span class="op" id="4980839">.</span><span class="ident" id="4980840">ValueOf</span><span class="op" id="4980847">(</span><span class="ident" id="4980848">info</span><span class="op" id="4980852">.</span><span class="ident" id="4980853">wire</span><span class="op" id="4980857">)</span><span class="op" id="4980858">,</span>&nbsp;<span class="ident" id="4980860">wireTypeUserInfo</span><span class="op" id="4980876">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980879">enc</span><span class="op" id="4980882">.</span><span class="ident" id="4980883">writeMessage</span><span class="op" id="4980895">(</span><span class="ident" id="4980896">w</span><span class="op" id="4980897">,</span>&nbsp;<span class="ident" id="4980899">state</span><span class="op" id="4980904">.</span><span class="ident" id="4980905">b</span><span class="op" id="4980906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980909">if</span>&nbsp;<span class="ident" id="4980912">enc</span><span class="op" id="4980915">.</span><span class="ident" id="4980916">err</span>&nbsp;<span class="op" id="4980920">!=</span>&nbsp;<span class="ident" id="4980923">nil</span>&nbsp;<span class="op" id="4980927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980931">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4980943">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981024">enc</span><span class="op" id="4981027">.</span><span class="ident" id="4981028">sent</span><span class="op" id="4981032">[</span><span class="ident" id="4981033">ut</span><span class="op" id="4981035">.</span><span class="ident" id="4981036">base</span><span class="op" id="4981040">]</span>&nbsp;<span class="op" id="4981042">=</span>&nbsp;<span class="ident" id="4981044">info</span><span class="op" id="4981048">.</span><span class="ident" id="4981049">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981053">if</span>&nbsp;<span class="ident" id="4981056">ut</span><span class="op" id="4981058">.</span><span class="ident" id="4981059">user</span>&nbsp;<span class="op" id="4981064">!=</span>&nbsp;<span class="ident" id="4981067">ut</span><span class="op" id="4981069">.</span><span class="ident" id="4981070">base</span>&nbsp;<span class="op" id="4981075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981079">enc</span><span class="op" id="4981082">.</span><span class="ident" id="4981083">sent</span><span class="op" id="4981087">[</span><span class="ident" id="4981088">ut</span><span class="op" id="4981090">.</span><span class="ident" id="4981091">user</span><span class="op" id="4981095">]</span>&nbsp;<span class="op" id="4981097">=</span>&nbsp;<span class="ident" id="4981099">info</span><span class="op" id="4981103">.</span><span class="ident" id="4981104">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981108">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4981111">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981140">switch</span>&nbsp;<span class="ident" id="4981147">st</span>&nbsp;<span class="op" id="4981150">:=</span>&nbsp;<span class="ident" id="4981153">actual</span><span class="op" id="4981159">;</span>&nbsp;<span class="ident" id="4981161">st</span><span class="op" id="4981163">.</span><span class="ident" id="4981164">Kind</span><span class="op" id="4981168">(</span><span class="op" id="4981169">)</span>&nbsp;<span class="op" id="4981171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981174">case</span>&nbsp;<span class="ident" id="4981179">reflect</span><span class="op" id="4981186">.</span><span class="ident" id="4981187">Struct</span><span class="op" id="4981193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981197">for</span>&nbsp;<span class="ident" id="4981201">i</span>&nbsp;<span class="op" id="4981203">:=</span>&nbsp;<span class="num" id="4981206">0</span><span class="op" id="4981207">;</span>&nbsp;<span class="ident" id="4981209">i</span>&nbsp;<span class="op" id="4981211">&lt;</span>&nbsp;<span class="ident" id="4981213">st</span><span class="op" id="4981215">.</span><span class="ident" id="4981216">NumField</span><span class="op" id="4981224">(</span><span class="op" id="4981225">)</span><span class="op" id="4981226">;</span>&nbsp;<span class="ident" id="4981228">i</span><span class="op" id="4981229">++</span>&nbsp;<span class="op" id="4981232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981237">if</span>&nbsp;<span class="ident" id="4981240">isExported</span><span class="op" id="4981250">(</span><span class="ident" id="4981251">st</span><span class="op" id="4981253">.</span><span class="ident" id="4981254">Field</span><span class="op" id="4981259">(</span><span class="ident" id="4981260">i</span><span class="op" id="4981261">)</span><span class="op" id="4981262">.</span><span class="ident" id="4981263">Name</span><span class="op" id="4981267">)</span>&nbsp;<span class="op" id="4981269">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981275">enc</span><span class="op" id="4981278">.</span><span class="ident" id="4981279">sendType</span><span class="op" id="4981287">(</span><span class="ident" id="4981288">w</span><span class="op" id="4981289">,</span>&nbsp;<span class="ident" id="4981291">state</span><span class="op" id="4981296">,</span>&nbsp;<span class="ident" id="4981298">st</span><span class="op" id="4981300">.</span><span class="ident" id="4981301">Field</span><span class="op" id="4981306">(</span><span class="ident" id="4981307">i</span><span class="op" id="4981308">)</span><span class="op" id="4981309">.</span><span class="ident" id="4981310">Type</span><span class="op" id="4981314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981326">case</span>&nbsp;<span class="ident" id="4981331">reflect</span><span class="op" id="4981338">.</span><span class="ident" id="4981339">Array</span><span class="op" id="4981344">,</span>&nbsp;<span class="ident" id="4981346">reflect</span><span class="op" id="4981353">.</span><span class="ident" id="4981354">Slice</span><span class="op" id="4981359">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981363">enc</span><span class="op" id="4981366">.</span><span class="ident" id="4981367">sendType</span><span class="op" id="4981375">(</span><span class="ident" id="4981376">w</span><span class="op" id="4981377">,</span>&nbsp;<span class="ident" id="4981379">state</span><span class="op" id="4981384">,</span>&nbsp;<span class="ident" id="4981386">st</span><span class="op" id="4981388">.</span><span class="ident" id="4981389">Elem</span><span class="op" id="4981393">(</span><span class="op" id="4981394">)</span><span class="op" id="4981395">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981398">case</span>&nbsp;<span class="ident" id="4981403">reflect</span><span class="op" id="4981410">.</span><span class="ident" id="4981411">Map</span><span class="op" id="4981414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981418">enc</span><span class="op" id="4981421">.</span><span class="ident" id="4981422">sendType</span><span class="op" id="4981430">(</span><span class="ident" id="4981431">w</span><span class="op" id="4981432">,</span>&nbsp;<span class="ident" id="4981434">state</span><span class="op" id="4981439">,</span>&nbsp;<span class="ident" id="4981441">st</span><span class="op" id="4981443">.</span><span class="ident" id="4981444">Key</span><span class="op" id="4981447">(</span><span class="op" id="4981448">)</span><span class="op" id="4981449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981453">enc</span><span class="op" id="4981456">.</span><span class="ident" id="4981457">sendType</span><span class="op" id="4981465">(</span><span class="ident" id="4981466">w</span><span class="op" id="4981467">,</span>&nbsp;<span class="ident" id="4981469">state</span><span class="op" id="4981474">,</span>&nbsp;<span class="ident" id="4981476">st</span><span class="op" id="4981478">.</span><span class="ident" id="4981479">Elem</span><span class="op" id="4981483">(</span><span class="op" id="4981484">)</span><span class="op" id="4981485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981491">return</span>&nbsp;<span class="builtintype" id="4981498">true</span><br>
<span class="lineno">125</span><span class="op" id="4981503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4981506">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4981571">func</span>&nbsp;<span class="op" id="4981576">(</span><span class="ident" id="4981577">enc</span>&nbsp;<span class="op" id="4981581">*</span><span class="ident" id="4981582">Encoder</span><span class="op" id="4981589">)</span>&nbsp;<span class="ident" id="4981591">sendType</span><span class="op" id="4981599">(</span><span class="ident" id="4981600">w</span>&nbsp;<span class="ident" id="4981602">io</span><span class="op" id="4981604">.</span><span class="ident" id="4981605">Writer</span><span class="op" id="4981611">,</span>&nbsp;<span class="ident" id="4981613">state</span>&nbsp;<span class="op" id="4981619">*</span><span class="ident" id="4981620">encoderState</span><span class="op" id="4981632">,</span>&nbsp;<span class="ident" id="4981634">origt</span>&nbsp;<span class="ident" id="4981640">reflect</span><span class="op" id="4981647">.</span><span class="ident" id="4981648">Type</span><span class="op" id="4981652">)</span>&nbsp;<span class="op" id="4981654">(</span><span class="ident" id="4981655">sent</span>&nbsp;<span class="builtintype" id="4981660">bool</span><span class="op" id="4981664">)</span>&nbsp;<span class="op" id="4981666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981669">ut</span>&nbsp;<span class="op" id="4981672">:=</span>&nbsp;<span class="ident" id="4981675">userType</span><span class="op" id="4981683">(</span><span class="ident" id="4981684">origt</span><span class="op" id="4981689">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981692">if</span>&nbsp;<span class="ident" id="4981695">ut</span><span class="op" id="4981697">.</span><span class="ident" id="4981698">externalEnc</span>&nbsp;<span class="op" id="4981710">!=</span>&nbsp;<span class="num" id="4981713">0</span>&nbsp;<span class="op" id="4981715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4981719">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4981801">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981873">return</span>&nbsp;<span class="ident" id="4981880">enc</span><span class="op" id="4981883">.</span><span class="ident" id="4981884">sendActualType</span><span class="op" id="4981898">(</span><span class="ident" id="4981899">w</span><span class="op" id="4981900">,</span>&nbsp;<span class="ident" id="4981902">state</span><span class="op" id="4981907">,</span>&nbsp;<span class="ident" id="4981909">ut</span><span class="op" id="4981911">,</span>&nbsp;<span class="ident" id="4981913">ut</span><span class="op" id="4981915">.</span><span class="ident" id="4981916">base</span><span class="op" id="4981920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981923">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4981927">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981986">switch</span>&nbsp;<span class="ident" id="4981993">rt</span>&nbsp;<span class="op" id="4981996">:=</span>&nbsp;<span class="ident" id="4981999">ut</span><span class="op" id="4982001">.</span><span class="ident" id="4982002">base</span><span class="op" id="4982006">;</span>&nbsp;<span class="ident" id="4982008">rt</span><span class="op" id="4982010">.</span><span class="ident" id="4982011">Kind</span><span class="op" id="4982015">(</span><span class="op" id="4982016">)</span>&nbsp;<span class="op" id="4982018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982021">default</span><span class="op" id="4982028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982032">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982093">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982101">case</span>&nbsp;<span class="ident" id="4982106">reflect</span><span class="op" id="4982113">.</span><span class="ident" id="4982114">Slice</span><span class="op" id="4982119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982123">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982180">if</span>&nbsp;<span class="ident" id="4982183">rt</span><span class="op" id="4982185">.</span><span class="ident" id="4982186">Elem</span><span class="op" id="4982190">(</span><span class="op" id="4982191">)</span><span class="op" id="4982192">.</span><span class="ident" id="4982193">Kind</span><span class="op" id="4982197">(</span><span class="op" id="4982198">)</span>&nbsp;<span class="op" id="4982200">==</span>&nbsp;<span class="ident" id="4982203">reflect</span><span class="op" id="4982210">.</span><span class="ident" id="4982211">Uint8</span>&nbsp;<span class="op" id="4982217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982222">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4982231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982235">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982262">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982269">case</span>&nbsp;<span class="ident" id="4982274">reflect</span><span class="op" id="4982281">.</span><span class="ident" id="4982282">Array</span><span class="op" id="4982287">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982291">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982360">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982367">case</span>&nbsp;<span class="ident" id="4982372">reflect</span><span class="op" id="4982379">.</span><span class="ident" id="4982380">Map</span><span class="op" id="4982383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982387">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982456">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982463">case</span>&nbsp;<span class="ident" id="4982468">reflect</span><span class="op" id="4982475">.</span><span class="ident" id="4982476">Struct</span><span class="op" id="4982482">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982486">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982537">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982544">case</span>&nbsp;<span class="ident" id="4982549">reflect</span><span class="op" id="4982556">.</span><span class="ident" id="4982557">Chan</span><span class="op" id="4982561">,</span>&nbsp;<span class="ident" id="4982563">reflect</span><span class="op" id="4982570">.</span><span class="ident" id="4982571">Func</span><span class="op" id="4982575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4982579">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982637">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4982645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982649">return</span>&nbsp;<span class="ident" id="4982656">enc</span><span class="op" id="4982659">.</span><span class="ident" id="4982660">sendActualType</span><span class="op" id="4982674">(</span><span class="ident" id="4982675">w</span><span class="op" id="4982676">,</span>&nbsp;<span class="ident" id="4982678">state</span><span class="op" id="4982683">,</span>&nbsp;<span class="ident" id="4982685">ut</span><span class="op" id="4982687">,</span>&nbsp;<span class="ident" id="4982689">ut</span><span class="op" id="4982691">.</span><span class="ident" id="4982692">base</span><span class="op" id="4982696">)</span><br>
<span class="lineno"></span><span class="op" id="4982698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4982701">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4982777">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4982857">func</span>&nbsp;<span class="op" id="4982862">(</span><span class="ident" id="4982863">enc</span>&nbsp;<span class="op" id="4982867">*</span><span class="ident" id="4982868">Encoder</span><span class="op" id="4982875">)</span>&nbsp;<span class="ident" id="4982877">Encode</span><span class="op" id="4982883">(</span><span class="ident" id="4982884">e</span>&nbsp;<span class="keyword" id="4982886">interface</span><span class="op" id="4982895">{</span><span class="op" id="4982896">}</span><span class="op" id="4982897">)</span>&nbsp;<span class="builtintype" id="4982899">error</span>&nbsp;<span class="op" id="4982905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4982908">return</span>&nbsp;<span class="ident" id="4982915">enc</span><span class="op" id="4982918">.</span><span class="ident" id="4982919">EncodeValue</span><span class="op" id="4982930">(</span><span class="ident" id="4982931">reflect</span><span class="op" id="4982938">.</span><span class="ident" id="4982939">ValueOf</span><span class="op" id="4982946">(</span><span class="ident" id="4982947">e</span><span class="op" id="4982948">)</span><span class="op" id="4982949">)</span><br>
<span class="lineno"></span><span class="op" id="4982951">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4982954">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4983026">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="4983099">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4983108">func</span>&nbsp;<span class="op" id="4983113">(</span><span class="ident" id="4983114">enc</span>&nbsp;<span class="op" id="4983118">*</span><span class="ident" id="4983119">Encoder</span><span class="op" id="4983126">)</span>&nbsp;<span class="ident" id="4983128">sendTypeDescriptor</span><span class="op" id="4983146">(</span><span class="ident" id="4983147">w</span>&nbsp;<span class="ident" id="4983149">io</span><span class="op" id="4983151">.</span><span class="ident" id="4983152">Writer</span><span class="op" id="4983158">,</span>&nbsp;<span class="ident" id="4983160">state</span>&nbsp;<span class="op" id="4983166">*</span><span class="ident" id="4983167">encoderState</span><span class="op" id="4983179">,</span>&nbsp;<span class="ident" id="4983181">ut</span>&nbsp;<span class="op" id="4983184">*</span><span class="ident" id="4983185">userTypeInfo</span><span class="op" id="4983197">)</span>&nbsp;<span class="op" id="4983199">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983202">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983253">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983296">rt</span>&nbsp;<span class="op" id="4983299">:=</span>&nbsp;<span class="ident" id="4983302">ut</span><span class="op" id="4983304">.</span><span class="ident" id="4983305">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983311">if</span>&nbsp;<span class="ident" id="4983314">ut</span><span class="op" id="4983316">.</span><span class="ident" id="4983317">externalEnc</span>&nbsp;<span class="op" id="4983329">!=</span>&nbsp;<span class="num" id="4983332">0</span>&nbsp;<span class="op" id="4983334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983338">rt</span>&nbsp;<span class="op" id="4983341">=</span>&nbsp;<span class="ident" id="4983343">ut</span><span class="op" id="4983345">.</span><span class="ident" id="4983346">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4983352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983355">if</span>&nbsp;<span class="ident" id="4983358">_</span><span class="op" id="4983359">,</span>&nbsp;<span class="ident" id="4983361">alreadySent</span>&nbsp;<span class="op" id="4983373">:=</span>&nbsp;<span class="ident" id="4983376">enc</span><span class="op" id="4983379">.</span><span class="ident" id="4983380">sent</span><span class="op" id="4983384">[</span><span class="ident" id="4983385">rt</span><span class="op" id="4983387">]</span><span class="op" id="4983388">;</span>&nbsp;<span class="op" id="4983390">!</span><span class="ident" id="4983391">alreadySent</span>&nbsp;<span class="op" id="4983403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983407">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983428">sent</span>&nbsp;<span class="op" id="4983433">:=</span>&nbsp;<span class="ident" id="4983436">enc</span><span class="op" id="4983439">.</span><span class="ident" id="4983440">sendType</span><span class="op" id="4983448">(</span><span class="ident" id="4983449">w</span><span class="op" id="4983450">,</span>&nbsp;<span class="ident" id="4983452">state</span><span class="op" id="4983457">,</span>&nbsp;<span class="ident" id="4983459">rt</span><span class="op" id="4983461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983465">if</span>&nbsp;<span class="ident" id="4983468">enc</span><span class="op" id="4983471">.</span><span class="ident" id="4983472">err</span>&nbsp;<span class="op" id="4983476">!=</span>&nbsp;<span class="ident" id="4983479">nil</span>&nbsp;<span class="op" id="4983483">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983488">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4983497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983501">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983572">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983643">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983710">if</span>&nbsp;<span class="op" id="4983713">!</span><span class="ident" id="4983714">sent</span>&nbsp;<span class="op" id="4983719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983724">info</span><span class="op" id="4983728">,</span>&nbsp;<span class="ident" id="4983730">err</span>&nbsp;<span class="op" id="4983734">:=</span>&nbsp;<span class="ident" id="4983737">getTypeInfo</span><span class="op" id="4983748">(</span><span class="ident" id="4983749">ut</span><span class="op" id="4983751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983756">if</span>&nbsp;<span class="ident" id="4983759">err</span>&nbsp;<span class="op" id="4983763">!=</span>&nbsp;<span class="ident" id="4983766">nil</span>&nbsp;<span class="op" id="4983770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983776">enc</span><span class="op" id="4983779">.</span><span class="ident" id="4983780">setError</span><span class="op" id="4983788">(</span><span class="ident" id="4983789">err</span><span class="op" id="4983792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4983798">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4983808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983813">enc</span><span class="op" id="4983816">.</span><span class="ident" id="4983817">sent</span><span class="op" id="4983821">[</span><span class="ident" id="4983822">rt</span><span class="op" id="4983824">]</span>&nbsp;<span class="op" id="4983826">=</span>&nbsp;<span class="ident" id="4983828">info</span><span class="op" id="4983832">.</span><span class="ident" id="4983833">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4983838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4983841">}</span><br>
<span class="lineno"></span><span class="op" id="4983843">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4983846">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4983912">func</span>&nbsp;<span class="op" id="4983917">(</span><span class="ident" id="4983918">enc</span>&nbsp;<span class="op" id="4983922">*</span><span class="ident" id="4983923">Encoder</span><span class="op" id="4983930">)</span>&nbsp;<span class="ident" id="4983932">sendTypeId</span><span class="op" id="4983942">(</span><span class="ident" id="4983943">state</span>&nbsp;<span class="op" id="4983949">*</span><span class="ident" id="4983950">encoderState</span><span class="op" id="4983962">,</span>&nbsp;<span class="ident" id="4983964">ut</span>&nbsp;<span class="op" id="4983967">*</span><span class="ident" id="4983968">userTypeInfo</span><span class="op" id="4983980">)</span>&nbsp;<span class="op" id="4983982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4983985">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984032">state</span><span class="op" id="4984037">.</span><span class="ident" id="4984038">encodeInt</span><span class="op" id="4984047">(</span><span class="ident" id="4984048">int64</span><span class="op" id="4984053">(</span><span class="ident" id="4984054">enc</span><span class="op" id="4984057">.</span><span class="ident" id="4984058">sent</span><span class="op" id="4984062">[</span><span class="ident" id="4984063">ut</span><span class="op" id="4984065">.</span><span class="ident" id="4984066">base</span><span class="op" id="4984070">]</span><span class="op" id="4984071">)</span><span class="op" id="4984072">)</span><br>
<span class="lineno">205</span><span class="op" id="4984074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4984077">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4984153">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4984233">func</span>&nbsp;<span class="op" id="4984238">(</span><span class="ident" id="4984239">enc</span>&nbsp;<span class="op" id="4984243">*</span><span class="ident" id="4984244">Encoder</span><span class="op" id="4984251">)</span>&nbsp;<span class="ident" id="4984253">EncodeValue</span><span class="op" id="4984264">(</span><span class="ident" id="4984265">value</span>&nbsp;<span class="ident" id="4984271">reflect</span><span class="op" id="4984278">.</span><span class="ident" id="4984279">Value</span><span class="op" id="4984284">)</span>&nbsp;<span class="builtintype" id="4984286">error</span>&nbsp;<span class="op" id="4984292">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4984295">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4984362">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984391">if</span>&nbsp;<span class="ident" id="4984394">value</span><span class="op" id="4984399">.</span><span class="ident" id="4984400">Kind</span><span class="op" id="4984404">(</span><span class="op" id="4984405">)</span>&nbsp;<span class="op" id="4984407">==</span>&nbsp;<span class="ident" id="4984410">reflect</span><span class="op" id="4984417">.</span><span class="ident" id="4984418">Ptr</span>&nbsp;<span class="op" id="4984422">&amp;&amp;</span>&nbsp;<span class="ident" id="4984425">value</span><span class="op" id="4984430">.</span><span class="ident" id="4984431">IsNil</span><span class="op" id="4984436">(</span><span class="op" id="4984437">)</span>&nbsp;<span class="op" id="4984439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4984443">panic</span><span class="op" id="4984448">(</span><span class="string" id="4984449">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4984491">+</span>&nbsp;<span class="ident" id="4984493">value</span><span class="op" id="4984498">.</span><span class="ident" id="4984499">Type</span><span class="op" id="4984503">(</span><span class="op" id="4984504">)</span><span class="op" id="4984505">.</span><span class="ident" id="4984506">String</span><span class="op" id="4984512">(</span><span class="op" id="4984513">)</span><span class="op" id="4984514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4984517">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4984521">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4984583">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984620">enc</span><span class="op" id="4984623">.</span><span class="ident" id="4984624">mutex</span><span class="op" id="4984629">.</span><span class="ident" id="4984630">Lock</span><span class="op" id="4984634">(</span><span class="op" id="4984635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984638">defer</span>&nbsp;<span class="ident" id="4984644">enc</span><span class="op" id="4984647">.</span><span class="ident" id="4984648">mutex</span><span class="op" id="4984653">.</span><span class="ident" id="4984654">Unlock</span><span class="op" id="4984660">(</span><span class="op" id="4984661">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4984665">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984729">enc</span><span class="op" id="4984732">.</span><span class="ident" id="4984733">w</span>&nbsp;<span class="op" id="4984735">=</span>&nbsp;<span class="ident" id="4984737">enc</span><span class="op" id="4984740">.</span><span class="ident" id="4984741">w</span><span class="op" id="4984742">[</span><span class="num" id="4984743">0</span><span class="op" id="4984744">:</span><span class="num" id="4984745">1</span><span class="op" id="4984746">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984750">ut</span><span class="op" id="4984752">,</span>&nbsp;<span class="ident" id="4984754">err</span>&nbsp;<span class="op" id="4984758">:=</span>&nbsp;<span class="ident" id="4984761">validUserType</span><span class="op" id="4984774">(</span><span class="ident" id="4984775">value</span><span class="op" id="4984780">.</span><span class="ident" id="4984781">Type</span><span class="op" id="4984785">(</span><span class="op" id="4984786">)</span><span class="op" id="4984787">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984790">if</span>&nbsp;<span class="ident" id="4984793">err</span>&nbsp;<span class="op" id="4984797">!=</span>&nbsp;<span class="ident" id="4984800">nil</span>&nbsp;<span class="op" id="4984804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984808">return</span>&nbsp;<span class="ident" id="4984815">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4984820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984824">enc</span><span class="op" id="4984827">.</span><span class="ident" id="4984828">err</span>&nbsp;<span class="op" id="4984832">=</span>&nbsp;<span class="ident" id="4984834">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984839">enc</span><span class="op" id="4984842">.</span><span class="ident" id="4984843">byteBuf</span><span class="op" id="4984850">.</span><span class="ident" id="4984851">Reset</span><span class="op" id="4984856">(</span><span class="op" id="4984857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984860">enc</span><span class="op" id="4984863">.</span><span class="ident" id="4984864">byteBuf</span><span class="op" id="4984871">.</span><span class="ident" id="4984872">Write</span><span class="op" id="4984877">(</span><span class="ident" id="4984878">spaceForLength</span><span class="op" id="4984892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984895">state</span>&nbsp;<span class="op" id="4984901">:=</span>&nbsp;<span class="ident" id="4984904">enc</span><span class="op" id="4984907">.</span><span class="ident" id="4984908">newEncoderState</span><span class="op" id="4984923">(</span><span class="op" id="4984924">&amp;</span><span class="ident" id="4984925">enc</span><span class="op" id="4984928">.</span><span class="ident" id="4984929">byteBuf</span><span class="op" id="4984936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984940">enc</span><span class="op" id="4984943">.</span><span class="ident" id="4984944">sendTypeDescriptor</span><span class="op" id="4984962">(</span><span class="ident" id="4984963">enc</span><span class="op" id="4984966">.</span><span class="ident" id="4984967">writer</span><span class="op" id="4984973">(</span><span class="op" id="4984974">)</span><span class="op" id="4984975">,</span>&nbsp;<span class="ident" id="4984977">state</span><span class="op" id="4984982">,</span>&nbsp;<span class="ident" id="4984984">ut</span><span class="op" id="4984986">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984989">enc</span><span class="op" id="4984992">.</span><span class="ident" id="4984993">sendTypeId</span><span class="op" id="4985003">(</span><span class="ident" id="4985004">state</span><span class="op" id="4985009">,</span>&nbsp;<span class="ident" id="4985011">ut</span><span class="op" id="4985013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985016">if</span>&nbsp;<span class="ident" id="4985019">enc</span><span class="op" id="4985022">.</span><span class="ident" id="4985023">err</span>&nbsp;<span class="op" id="4985027">!=</span>&nbsp;<span class="ident" id="4985030">nil</span>&nbsp;<span class="op" id="4985034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985038">return</span>&nbsp;<span class="ident" id="4985045">enc</span><span class="op" id="4985048">.</span><span class="ident" id="4985049">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4985054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4985058">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985081">enc</span><span class="op" id="4985084">.</span><span class="ident" id="4985085">encode</span><span class="op" id="4985091">(</span><span class="ident" id="4985092">state</span><span class="op" id="4985097">.</span><span class="ident" id="4985098">b</span><span class="op" id="4985099">,</span>&nbsp;<span class="ident" id="4985101">value</span><span class="op" id="4985106">,</span>&nbsp;<span class="ident" id="4985108">ut</span><span class="op" id="4985110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985113">if</span>&nbsp;<span class="ident" id="4985116">enc</span><span class="op" id="4985119">.</span><span class="ident" id="4985120">err</span>&nbsp;<span class="op" id="4985124">==</span>&nbsp;<span class="ident" id="4985127">nil</span>&nbsp;<span class="op" id="4985131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985135">enc</span><span class="op" id="4985138">.</span><span class="ident" id="4985139">writeMessage</span><span class="op" id="4985151">(</span><span class="ident" id="4985152">enc</span><span class="op" id="4985155">.</span><span class="ident" id="4985156">writer</span><span class="op" id="4985162">(</span><span class="op" id="4985163">)</span><span class="op" id="4985164">,</span>&nbsp;<span class="ident" id="4985166">state</span><span class="op" id="4985171">.</span><span class="ident" id="4985172">b</span><span class="op" id="4985173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4985176">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985180">enc</span><span class="op" id="4985183">.</span><span class="ident" id="4985184">freeEncoderState</span><span class="op" id="4985200">(</span><span class="ident" id="4985201">state</span><span class="op" id="4985206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985209">return</span>&nbsp;<span class="ident" id="4985216">enc</span><span class="op" id="4985219">.</span><span class="ident" id="4985220">err</span><br>
<span class="lineno"></span><span class="op" id="4985224">}</span>
</div>
</body>
</html>
