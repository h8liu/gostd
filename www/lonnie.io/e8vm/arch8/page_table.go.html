<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="4877724">package</span>&nbsp;<span class="ident" id="4877732">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4877739">//&nbsp;PageTable&nbsp;describes&nbsp;a&nbsp;page&nbsp;table&nbsp;in&nbsp;a&nbsp;physical&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="4877797">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;translate&nbsp;a&nbsp;virtual&nbsp;memory&nbsp;address&nbsp;into&nbsp;a&nbsp;physical</span><br>
<span class="lineno">5</span><span class="comment" id="4877869">//&nbsp;memory&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4877888">type</span>&nbsp;<span class="ident" id="4877893">pageTable</span>&nbsp;<span class="keyword" id="4877903">struct</span>&nbsp;<span class="op" id="4877910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877913">mem</span>&nbsp;&nbsp;<span class="op" id="4877918">*</span><span class="ident" id="4877919">phyMemory</span>&nbsp;<span class="comment" id="4877929">//&nbsp;the&nbsp;physical&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877953">root</span>&nbsp;<span class="builtintype" id="4877958">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4877969">//&nbsp;root&nbsp;address</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4877987">//&nbsp;last&nbsp;translation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878008">pte1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4878017">ptEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878026">pte2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4878035">ptEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878044">pte1Addr</span>&nbsp;<span class="builtintype" id="4878053">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878061">pte2Addr</span>&nbsp;<span class="builtintype" id="4878070">uint32</span><br>
<span class="lineno">15</span><span class="op" id="4878077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4878080">//&nbsp;NewPageTable&nbsp;creates&nbsp;a&nbsp;new&nbsp;page&nbsp;table&nbsp;pointer.</span><br>
<span class="lineno"></span><span class="comment" id="4878130">//&nbsp;The&nbsp;page&nbsp;table&nbsp;is&nbsp;saved&nbsp;at&nbsp;addr.</span><br>
<span class="lineno"></span><span class="comment" id="4878166">//&nbsp;If&nbsp;addr&nbsp;is&nbsp;not&nbsp;page&nbsp;size&nbsp;aligned,&nbsp;it&nbsp;is&nbsp;aligned&nbsp;down.</span><br>
<span class="lineno">20</span><span class="keyword" id="4878223">func</span>&nbsp;<span class="ident" id="4878228">newPageTable</span><span class="op" id="4878240">(</span><span class="ident" id="4878241">m</span>&nbsp;<span class="op" id="4878243">*</span><span class="ident" id="4878244">phyMemory</span><span class="op" id="4878253">,</span>&nbsp;<span class="ident" id="4878255">addr</span>&nbsp;<span class="builtintype" id="4878260">uint32</span><span class="op" id="4878266">)</span>&nbsp;<span class="op" id="4878268">*</span><span class="ident" id="4878269">pageTable</span>&nbsp;<span class="op" id="4878279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878282">addr</span>&nbsp;<span class="op" id="4878287">-=</span>&nbsp;<span class="ident" id="4878290">addr</span>&nbsp;<span class="op" id="4878295">%</span>&nbsp;<span class="ident" id="4878297">PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878307">ret</span>&nbsp;<span class="op" id="4878311">:=</span>&nbsp;<span class="builtinfunc" id="4878314">new</span><span class="op" id="4878317">(</span><span class="ident" id="4878318">pageTable</span><span class="op" id="4878327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878330">ret</span><span class="op" id="4878333">.</span><span class="ident" id="4878334">mem</span>&nbsp;<span class="op" id="4878338">=</span>&nbsp;<span class="ident" id="4878340">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878343">ret</span><span class="op" id="4878346">.</span><span class="ident" id="4878347">root</span>&nbsp;<span class="op" id="4878352">=</span>&nbsp;<span class="ident" id="4878354">addr</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878361">return</span>&nbsp;<span class="ident" id="4878368">ret</span><br>
<span class="lineno"></span><span class="op" id="4878372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4878375">//&nbsp;bit&nbsp;[31:12]&nbsp;-&gt;&nbsp;a&nbsp;page&nbsp;pointer</span><br>
<span class="lineno">30</span><span class="comment" id="4878408">//</span><br>
<span class="lineno"></span><span class="comment" id="4878411">//&nbsp;bit&nbsp;3:&nbsp;dirty&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment" id="4878431">//&nbsp;bit&nbsp;2:&nbsp;use&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment" id="4878449">//&nbsp;bit&nbsp;1:&nbsp;readonly&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment" id="4878472">//&nbsp;bit&nbsp;0:&nbsp;valid&nbsp;bit</span><br>
<span class="lineno">35</span><span class="keyword" id="4878492">type</span>&nbsp;<span class="ident" id="4878497">ptEntry</span>&nbsp;<span class="builtintype" id="4878505">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4878513">const</span>&nbsp;<span class="op" id="4878519">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878522">pteValid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4878534">=</span>&nbsp;<span class="num" id="4878536">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878539">pteReadonly</span>&nbsp;<span class="op" id="4878551">=</span>&nbsp;<span class="num" id="4878553">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878556">pteUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4878568">=</span>&nbsp;<span class="num" id="4878570">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878573">pteDirty</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4878585">=</span>&nbsp;<span class="num" id="4878587">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878590">pteUser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4878602">=</span>&nbsp;<span class="num" id="4878604">4</span><br>
<span class="lineno"></span><span class="op" id="4878606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="4878609">const</span>&nbsp;<span class="ident" id="4878615">u32one</span>&nbsp;<span class="builtintype" id="4878622">uint32</span>&nbsp;<span class="op" id="4878629">=</span>&nbsp;<span class="num" id="4878631">0x1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4878636">func</span>&nbsp;<span class="op" id="4878641">(</span><span class="ident" id="4878642">pte</span>&nbsp;<span class="ident" id="4878646">ptEntry</span><span class="op" id="4878653">)</span>&nbsp;<span class="ident" id="4878655">testBit</span><span class="op" id="4878662">(</span><span class="ident" id="4878663">n</span>&nbsp;<span class="builtintype" id="4878665">uint</span><span class="op" id="4878669">)</span>&nbsp;<span class="builtintype" id="4878671">bool</span>&nbsp;<span class="op" id="4878676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878679">return</span>&nbsp;<span class="op" id="4878686">(</span><span class="builtintype" id="4878687">uint32</span><span class="op" id="4878693">(</span><span class="ident" id="4878694">pte</span><span class="op" id="4878697">)</span>&nbsp;<span class="op" id="4878699">&amp;</span>&nbsp;<span class="op" id="4878701">(</span><span class="ident" id="4878702">u32one</span>&nbsp;<span class="op" id="4878709">&lt;&lt;</span>&nbsp;<span class="ident" id="4878712">n</span><span class="op" id="4878713">)</span><span class="op" id="4878714">)</span>&nbsp;<span class="op" id="4878716">!=</span>&nbsp;<span class="num" id="4878719">0</span><br>
<span class="lineno"></span><span class="op" id="4878721">}</span><br>
<span class="lineno">50</span><span class="keyword" id="4878723">func</span>&nbsp;<span class="op" id="4878728">(</span><span class="ident" id="4878729">pte</span>&nbsp;<span class="op" id="4878733">*</span><span class="ident" id="4878734">ptEntry</span><span class="op" id="4878741">)</span>&nbsp;<span class="ident" id="4878743">setBit</span><span class="op" id="4878749">(</span><span class="ident" id="4878750">n</span>&nbsp;<span class="builtintype" id="4878752">uint</span><span class="op" id="4878756">)</span>&nbsp;<span class="op" id="4878758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4878761">*</span><span class="ident" id="4878762">pte</span>&nbsp;<span class="op" id="4878766">=</span>&nbsp;<span class="ident" id="4878768">ptEntry</span><span class="op" id="4878775">(</span><span class="builtintype" id="4878776">uint32</span><span class="op" id="4878782">(</span><span class="op" id="4878783">*</span><span class="ident" id="4878784">pte</span><span class="op" id="4878787">)</span>&nbsp;<span class="op" id="4878789">|</span>&nbsp;<span class="op" id="4878791">(</span><span class="ident" id="4878792">u32one</span>&nbsp;<span class="op" id="4878799">&lt;&lt;</span>&nbsp;<span class="ident" id="4878802">n</span><span class="op" id="4878803">)</span><span class="op" id="4878804">)</span><br>
<span class="lineno"></span><span class="op" id="4878806">}</span><br>
<span class="lineno"></span><span class="keyword" id="4878808">func</span>&nbsp;<span class="op" id="4878813">(</span><span class="ident" id="4878814">pte</span>&nbsp;<span class="ident" id="4878818">ptEntry</span><span class="op" id="4878825">)</span>&nbsp;<span class="ident" id="4878827">pn</span><span class="op" id="4878829">(</span><span class="op" id="4878830">)</span>&nbsp;<span class="builtintype" id="4878832">uint32</span>&nbsp;<span class="op" id="4878839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878842">return</span>&nbsp;<span class="builtintype" id="4878849">uint32</span><span class="op" id="4878855">(</span><span class="ident" id="4878856">pte</span>&nbsp;<span class="op" id="4878860">/</span>&nbsp;<span class="ident" id="4878862">PageSize</span><span class="op" id="4878870">)</span><br>
<span class="lineno">55</span><span class="op" id="4878872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4878875">func</span>&nbsp;<span class="op" id="4878880">(</span><span class="ident" id="4878881">pte</span>&nbsp;<span class="ident" id="4878885">ptEntry</span><span class="op" id="4878892">)</span>&nbsp;<span class="ident" id="4878894">test</span><span class="op" id="4878898">(</span><span class="ident" id="4878899">addr</span>&nbsp;<span class="builtintype" id="4878904">uint32</span><span class="op" id="4878910">,</span>&nbsp;<span class="ident" id="4878912">ring</span>&nbsp;<span class="builtintype" id="4878917">byte</span><span class="op" id="4878921">)</span>&nbsp;<span class="op" id="4878923">*</span><span class="ident" id="4878924">Excep</span>&nbsp;<span class="op" id="4878930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878933">if</span>&nbsp;<span class="op" id="4878936">!</span><span class="ident" id="4878937">pte</span><span class="op" id="4878940">.</span><span class="ident" id="4878941">testBit</span><span class="op" id="4878948">(</span><span class="ident" id="4878949">pteValid</span><span class="op" id="4878957">)</span>&nbsp;<span class="op" id="4878959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878963">return</span>&nbsp;<span class="ident" id="4878970">newPageFault</span><span class="op" id="4878982">(</span><span class="ident" id="4878983">addr</span><span class="op" id="4878987">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4878990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878993">if</span>&nbsp;<span class="ident" id="4878996">ring</span>&nbsp;<span class="op" id="4879001">&gt;</span>&nbsp;<span class="num" id="4879003">0</span>&nbsp;<span class="op" id="4879005">&amp;&amp;</span>&nbsp;<span class="op" id="4879008">!</span><span class="ident" id="4879009">pte</span><span class="op" id="4879012">.</span><span class="ident" id="4879013">testBit</span><span class="op" id="4879020">(</span><span class="ident" id="4879021">pteUser</span><span class="op" id="4879028">)</span>&nbsp;<span class="op" id="4879030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879034">return</span>&nbsp;<span class="ident" id="4879041">newPageFault</span><span class="op" id="4879053">(</span><span class="ident" id="4879054">addr</span><span class="op" id="4879058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879064">return</span>&nbsp;<span class="ident" id="4879071">nil</span><br>
<span class="lineno">65</span><span class="op" id="4879075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4879078">//&nbsp;Translate&nbsp;transalate&nbsp;a&nbsp;virutal&nbsp;address&nbsp;into&nbsp;physical&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="4879143">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;translation&nbsp;fails</span><br>
<span class="lineno"></span><span class="keyword" id="4879191">func</span>&nbsp;<span class="op" id="4879196">(</span><span class="ident" id="4879197">pt</span>&nbsp;<span class="op" id="4879200">*</span><span class="ident" id="4879201">pageTable</span><span class="op" id="4879210">)</span>&nbsp;<span class="ident" id="4879212">Translate</span><span class="op" id="4879221">(</span><span class="ident" id="4879222">addr</span>&nbsp;<span class="builtintype" id="4879227">uint32</span><span class="op" id="4879233">,</span>&nbsp;<span class="ident" id="4879235">ring</span>&nbsp;<span class="builtintype" id="4879240">byte</span><span class="op" id="4879244">)</span>&nbsp;<span class="op" id="4879246">(</span><span class="builtintype" id="4879247">uint32</span><span class="op" id="4879253">,</span>&nbsp;<span class="op" id="4879255">*</span><span class="ident" id="4879256">Excep</span><span class="op" id="4879261">)</span>&nbsp;<span class="op" id="4879263">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879266">vpn</span>&nbsp;<span class="op" id="4879270">:=</span>&nbsp;<span class="ident" id="4879273">addr</span>&nbsp;<span class="op" id="4879278">/</span>&nbsp;<span class="ident" id="4879280">PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879290">off</span>&nbsp;<span class="op" id="4879294">:=</span>&nbsp;<span class="ident" id="4879297">addr</span>&nbsp;<span class="op" id="4879302">%</span>&nbsp;<span class="ident" id="4879304">PageSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879315">index1</span>&nbsp;<span class="op" id="4879322">:=</span>&nbsp;<span class="ident" id="4879325">vpn</span>&nbsp;<span class="op" id="4879329">/</span>&nbsp;<span class="num" id="4879331">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879337">index2</span>&nbsp;<span class="op" id="4879344">:=</span>&nbsp;<span class="ident" id="4879347">vpn</span>&nbsp;<span class="op" id="4879351">%</span>&nbsp;<span class="num" id="4879353">1024</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4879360">//&nbsp;first&nbsp;level&nbsp;page&nbsp;table&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879393">pt</span><span class="op" id="4879395">.</span><span class="ident" id="4879396">pte1Addr</span>&nbsp;<span class="op" id="4879405">=</span>&nbsp;<span class="ident" id="4879407">pt</span><span class="op" id="4879409">.</span><span class="ident" id="4879410">root</span>&nbsp;<span class="op" id="4879415">+</span>&nbsp;<span class="ident" id="4879417">index1</span><span class="op" id="4879423">*</span><span class="num" id="4879424">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879427">w</span><span class="op" id="4879428">,</span>&nbsp;<span class="ident" id="4879430">e</span>&nbsp;<span class="op" id="4879432">:=</span>&nbsp;<span class="ident" id="4879435">pt</span><span class="op" id="4879437">.</span><span class="ident" id="4879438">mem</span><span class="op" id="4879441">.</span><span class="ident" id="4879442">ReadWord</span><span class="op" id="4879450">(</span><span class="ident" id="4879451">pt</span><span class="op" id="4879453">.</span><span class="ident" id="4879454">pte1Addr</span><span class="op" id="4879462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879465">if</span>&nbsp;<span class="ident" id="4879468">e</span>&nbsp;<span class="op" id="4879470">!=</span>&nbsp;<span class="ident" id="4879473">nil</span>&nbsp;<span class="op" id="4879477">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879481">return</span>&nbsp;<span class="num" id="4879488">0</span><span class="op" id="4879489">,</span>&nbsp;<span class="ident" id="4879491">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879497">pt</span><span class="op" id="4879499">.</span><span class="ident" id="4879500">pte1</span>&nbsp;<span class="op" id="4879505">=</span>&nbsp;<span class="ident" id="4879507">ptEntry</span><span class="op" id="4879514">(</span><span class="ident" id="4879515">w</span><span class="op" id="4879516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879519">e</span>&nbsp;<span class="op" id="4879521">=</span>&nbsp;<span class="ident" id="4879523">pt</span><span class="op" id="4879525">.</span><span class="ident" id="4879526">pte1</span><span class="op" id="4879530">.</span><span class="ident" id="4879531">test</span><span class="op" id="4879535">(</span><span class="ident" id="4879536">addr</span><span class="op" id="4879540">,</span>&nbsp;<span class="ident" id="4879542">ring</span><span class="op" id="4879546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879549">if</span>&nbsp;<span class="ident" id="4879552">e</span>&nbsp;<span class="op" id="4879554">!=</span>&nbsp;<span class="ident" id="4879557">nil</span>&nbsp;<span class="op" id="4879561">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879565">return</span>&nbsp;<span class="num" id="4879572">0</span><span class="op" id="4879573">,</span>&nbsp;<span class="ident" id="4879575">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879582">pn1</span>&nbsp;<span class="op" id="4879586">:=</span>&nbsp;<span class="ident" id="4879589">pt</span><span class="op" id="4879591">.</span><span class="ident" id="4879592">pte1</span><span class="op" id="4879596">.</span><span class="ident" id="4879597">pn</span><span class="op" id="4879599">(</span><span class="op" id="4879600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879604">pt</span><span class="op" id="4879606">.</span><span class="ident" id="4879607">pte2Addr</span>&nbsp;<span class="op" id="4879616">=</span>&nbsp;<span class="ident" id="4879618">pn1</span><span class="op" id="4879621">*</span><span class="ident" id="4879622">PageSize</span>&nbsp;<span class="op" id="4879631">+</span>&nbsp;<span class="ident" id="4879633">index2</span><span class="op" id="4879639">*</span><span class="num" id="4879640">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879643">w</span><span class="op" id="4879644">,</span>&nbsp;<span class="ident" id="4879646">e</span>&nbsp;<span class="op" id="4879648">=</span>&nbsp;<span class="ident" id="4879650">pt</span><span class="op" id="4879652">.</span><span class="ident" id="4879653">mem</span><span class="op" id="4879656">.</span><span class="ident" id="4879657">ReadWord</span><span class="op" id="4879665">(</span><span class="ident" id="4879666">pt</span><span class="op" id="4879668">.</span><span class="ident" id="4879669">pte2Addr</span><span class="op" id="4879677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879680">if</span>&nbsp;<span class="ident" id="4879683">e</span>&nbsp;<span class="op" id="4879685">!=</span>&nbsp;<span class="ident" id="4879688">nil</span>&nbsp;<span class="op" id="4879692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879696">return</span>&nbsp;<span class="num" id="4879703">0</span><span class="op" id="4879704">,</span>&nbsp;<span class="ident" id="4879706">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879709">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879712">pt</span><span class="op" id="4879714">.</span><span class="ident" id="4879715">pte2</span>&nbsp;<span class="op" id="4879720">=</span>&nbsp;<span class="ident" id="4879722">ptEntry</span><span class="op" id="4879729">(</span><span class="ident" id="4879730">w</span><span class="op" id="4879731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879734">e</span>&nbsp;<span class="op" id="4879736">=</span>&nbsp;<span class="ident" id="4879738">pt</span><span class="op" id="4879740">.</span><span class="ident" id="4879741">pte2</span><span class="op" id="4879745">.</span><span class="ident" id="4879746">test</span><span class="op" id="4879750">(</span><span class="ident" id="4879751">addr</span><span class="op" id="4879755">,</span>&nbsp;<span class="ident" id="4879757">ring</span><span class="op" id="4879761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879764">if</span>&nbsp;<span class="ident" id="4879767">e</span>&nbsp;<span class="op" id="4879769">!=</span>&nbsp;<span class="ident" id="4879772">nil</span>&nbsp;<span class="op" id="4879776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879780">return</span>&nbsp;<span class="num" id="4879787">0</span><span class="op" id="4879788">,</span>&nbsp;<span class="ident" id="4879790">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879793">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879797">ppn</span>&nbsp;<span class="op" id="4879801">:=</span>&nbsp;<span class="ident" id="4879804">pt</span><span class="op" id="4879806">.</span><span class="ident" id="4879807">pte2</span><span class="op" id="4879811">.</span><span class="ident" id="4879812">pn</span><span class="op" id="4879814">(</span><span class="op" id="4879815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879819">return</span>&nbsp;<span class="ident" id="4879826">ppn</span><span class="op" id="4879829">*</span><span class="ident" id="4879830">PageSize</span>&nbsp;<span class="op" id="4879839">+</span>&nbsp;<span class="ident" id="4879841">off</span><span class="op" id="4879844">,</span>&nbsp;<span class="ident" id="4879846">nil</span><br>
<span class="lineno"></span><span class="op" id="4879850">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="4879853">func</span>&nbsp;<span class="op" id="4879858">(</span><span class="ident" id="4879859">pt</span>&nbsp;<span class="op" id="4879862">*</span><span class="ident" id="4879863">pageTable</span><span class="op" id="4879872">)</span>&nbsp;<span class="ident" id="4879874">updatePte</span><span class="op" id="4879883">(</span><span class="op" id="4879884">)</span>&nbsp;<span class="op" id="4879886">*</span><span class="ident" id="4879887">Excep</span>&nbsp;<span class="op" id="4879893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879896">e</span>&nbsp;<span class="op" id="4879898">:=</span>&nbsp;<span class="ident" id="4879901">pt</span><span class="op" id="4879903">.</span><span class="ident" id="4879904">mem</span><span class="op" id="4879907">.</span><span class="ident" id="4879908">WriteWord</span><span class="op" id="4879917">(</span><span class="ident" id="4879918">pt</span><span class="op" id="4879920">.</span><span class="ident" id="4879921">pte1Addr</span><span class="op" id="4879929">,</span>&nbsp;<span class="builtintype" id="4879931">uint32</span><span class="op" id="4879937">(</span><span class="ident" id="4879938">pt</span><span class="op" id="4879940">.</span><span class="ident" id="4879941">pte1</span><span class="op" id="4879945">)</span><span class="op" id="4879946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879949">if</span>&nbsp;<span class="ident" id="4879952">e</span>&nbsp;<span class="op" id="4879954">!=</span>&nbsp;<span class="ident" id="4879957">nil</span>&nbsp;<span class="op" id="4879961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879965">return</span>&nbsp;<span class="ident" id="4879972">e</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879979">e</span>&nbsp;<span class="op" id="4879981">=</span>&nbsp;<span class="ident" id="4879983">pt</span><span class="op" id="4879985">.</span><span class="ident" id="4879986">mem</span><span class="op" id="4879989">.</span><span class="ident" id="4879990">WriteWord</span><span class="op" id="4879999">(</span><span class="ident" id="4880000">pt</span><span class="op" id="4880002">.</span><span class="ident" id="4880003">pte2Addr</span><span class="op" id="4880011">,</span>&nbsp;<span class="builtintype" id="4880013">uint32</span><span class="op" id="4880019">(</span><span class="ident" id="4880020">pt</span><span class="op" id="4880022">.</span><span class="ident" id="4880023">pte2</span><span class="op" id="4880027">)</span><span class="op" id="4880028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880031">if</span>&nbsp;<span class="ident" id="4880034">e</span>&nbsp;<span class="op" id="4880036">!=</span>&nbsp;<span class="ident" id="4880039">nil</span>&nbsp;<span class="op" id="4880043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880047">return</span>&nbsp;<span class="ident" id="4880054">e</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880061">return</span>&nbsp;<span class="ident" id="4880068">nil</span><br>
<span class="lineno"></span><span class="op" id="4880072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4880075">//&nbsp;TranslateRead&nbsp;translates&nbsp;the&nbsp;address&nbsp;and&nbsp;sets&nbsp;the&nbsp;use&nbsp;bit.</span><br>
<span class="lineno"></span><span class="keyword" id="4880137">func</span>&nbsp;<span class="op" id="4880142">(</span><span class="ident" id="4880143">pt</span>&nbsp;<span class="op" id="4880146">*</span><span class="ident" id="4880147">pageTable</span><span class="op" id="4880156">)</span>&nbsp;<span class="ident" id="4880158">TranslateRead</span><span class="op" id="4880171">(</span><span class="ident" id="4880172">addr</span>&nbsp;<span class="builtintype" id="4880177">uint32</span><span class="op" id="4880183">,</span>&nbsp;<span class="ident" id="4880185">ring</span>&nbsp;<span class="builtintype" id="4880190">byte</span><span class="op" id="4880194">)</span>&nbsp;<span class="op" id="4880196">(</span><span class="builtintype" id="4880197">uint32</span><span class="op" id="4880203">,</span>&nbsp;<span class="op" id="4880205">*</span><span class="ident" id="4880206">Excep</span><span class="op" id="4880211">)</span>&nbsp;<span class="op" id="4880213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880216">ret</span><span class="op" id="4880219">,</span>&nbsp;<span class="ident" id="4880221">e</span>&nbsp;<span class="op" id="4880223">:=</span>&nbsp;<span class="ident" id="4880226">pt</span><span class="op" id="4880228">.</span><span class="ident" id="4880229">Translate</span><span class="op" id="4880238">(</span><span class="ident" id="4880239">addr</span><span class="op" id="4880243">,</span>&nbsp;<span class="ident" id="4880245">ring</span><span class="op" id="4880249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880252">if</span>&nbsp;<span class="ident" id="4880255">e</span>&nbsp;<span class="op" id="4880257">!=</span>&nbsp;<span class="ident" id="4880260">nil</span>&nbsp;<span class="op" id="4880264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880268">return</span>&nbsp;<span class="num" id="4880275">0</span><span class="op" id="4880276">,</span>&nbsp;<span class="ident" id="4880278">e</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880285">pt</span><span class="op" id="4880287">.</span><span class="ident" id="4880288">pte1</span><span class="op" id="4880292">.</span><span class="ident" id="4880293">setBit</span><span class="op" id="4880299">(</span><span class="ident" id="4880300">pteUse</span><span class="op" id="4880306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880309">pt</span><span class="op" id="4880311">.</span><span class="ident" id="4880312">pte2</span><span class="op" id="4880316">.</span><span class="ident" id="4880317">setBit</span><span class="op" id="4880323">(</span><span class="ident" id="4880324">pteUse</span><span class="op" id="4880330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880334">e</span>&nbsp;<span class="op" id="4880336">=</span>&nbsp;<span class="ident" id="4880338">pt</span><span class="op" id="4880340">.</span><span class="ident" id="4880341">updatePte</span><span class="op" id="4880350">(</span><span class="op" id="4880351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880354">if</span>&nbsp;<span class="ident" id="4880357">e</span>&nbsp;<span class="op" id="4880359">!=</span>&nbsp;<span class="ident" id="4880362">nil</span>&nbsp;<span class="op" id="4880366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880370">return</span>&nbsp;<span class="num" id="4880377">0</span><span class="op" id="4880378">,</span>&nbsp;<span class="ident" id="4880380">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880387">return</span>&nbsp;<span class="ident" id="4880394">ret</span><span class="op" id="4880397">,</span>&nbsp;<span class="ident" id="4880399">nil</span><br>
<span class="lineno"></span><span class="op" id="4880403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4880406">//&nbsp;TranslateWrite&nbsp;translates&nbsp;the&nbsp;address&nbsp;and&nbsp;sets&nbsp;the&nbsp;use&nbsp;and&nbsp;dirty&nbsp;bit</span><br>
<span class="lineno"></span><span class="keyword" id="4880478">func</span>&nbsp;<span class="op" id="4880483">(</span><span class="ident" id="4880484">pt</span>&nbsp;<span class="op" id="4880487">*</span><span class="ident" id="4880488">pageTable</span><span class="op" id="4880497">)</span>&nbsp;<span class="ident" id="4880499">TranslateWrite</span><span class="op" id="4880513">(</span><span class="ident" id="4880514">addr</span>&nbsp;<span class="builtintype" id="4880519">uint32</span><span class="op" id="4880525">,</span>&nbsp;<span class="ident" id="4880527">ring</span>&nbsp;<span class="builtintype" id="4880532">byte</span><span class="op" id="4880536">)</span>&nbsp;<span class="op" id="4880538">(</span><span class="builtintype" id="4880539">uint32</span><span class="op" id="4880545">,</span>&nbsp;<span class="op" id="4880547">*</span><span class="ident" id="4880548">Excep</span><span class="op" id="4880553">)</span>&nbsp;<span class="op" id="4880555">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880558">ret</span><span class="op" id="4880561">,</span>&nbsp;<span class="ident" id="4880563">e</span>&nbsp;<span class="op" id="4880565">:=</span>&nbsp;<span class="ident" id="4880568">pt</span><span class="op" id="4880570">.</span><span class="ident" id="4880571">Translate</span><span class="op" id="4880580">(</span><span class="ident" id="4880581">addr</span><span class="op" id="4880585">,</span>&nbsp;<span class="ident" id="4880587">ring</span><span class="op" id="4880591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880594">if</span>&nbsp;<span class="ident" id="4880597">e</span>&nbsp;<span class="op" id="4880599">!=</span>&nbsp;<span class="ident" id="4880602">nil</span>&nbsp;<span class="op" id="4880606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880610">return</span>&nbsp;<span class="num" id="4880617">0</span><span class="op" id="4880618">,</span>&nbsp;<span class="ident" id="4880620">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880627">if</span>&nbsp;<span class="ident" id="4880630">pt</span><span class="op" id="4880632">.</span><span class="ident" id="4880633">pte1</span><span class="op" id="4880637">.</span><span class="ident" id="4880638">testBit</span><span class="op" id="4880645">(</span><span class="ident" id="4880646">pteReadonly</span><span class="op" id="4880657">)</span>&nbsp;<span class="op" id="4880659">||</span>&nbsp;<span class="ident" id="4880662">pt</span><span class="op" id="4880664">.</span><span class="ident" id="4880665">pte2</span><span class="op" id="4880669">.</span><span class="ident" id="4880670">testBit</span><span class="op" id="4880677">(</span><span class="ident" id="4880678">pteReadonly</span><span class="op" id="4880689">)</span>&nbsp;<span class="op" id="4880691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880695">return</span>&nbsp;<span class="num" id="4880702">0</span><span class="op" id="4880703">,</span>&nbsp;<span class="ident" id="4880705">newPageReadonly</span><span class="op" id="4880720">(</span><span class="ident" id="4880721">addr</span><span class="op" id="4880725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880732">pt</span><span class="op" id="4880734">.</span><span class="ident" id="4880735">pte1</span><span class="op" id="4880739">.</span><span class="ident" id="4880740">setBit</span><span class="op" id="4880746">(</span><span class="ident" id="4880747">pteUse</span><span class="op" id="4880753">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880756">pt</span><span class="op" id="4880758">.</span><span class="ident" id="4880759">pte1</span><span class="op" id="4880763">.</span><span class="ident" id="4880764">setBit</span><span class="op" id="4880770">(</span><span class="ident" id="4880771">pteDirty</span><span class="op" id="4880779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880782">pt</span><span class="op" id="4880784">.</span><span class="ident" id="4880785">pte2</span><span class="op" id="4880789">.</span><span class="ident" id="4880790">setBit</span><span class="op" id="4880796">(</span><span class="ident" id="4880797">pteUse</span><span class="op" id="4880803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880806">pt</span><span class="op" id="4880808">.</span><span class="ident" id="4880809">pte2</span><span class="op" id="4880813">.</span><span class="ident" id="4880814">setBit</span><span class="op" id="4880820">(</span><span class="ident" id="4880821">pteDirty</span><span class="op" id="4880829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880833">e</span>&nbsp;<span class="op" id="4880835">=</span>&nbsp;<span class="ident" id="4880837">pt</span><span class="op" id="4880839">.</span><span class="ident" id="4880840">updatePte</span><span class="op" id="4880849">(</span><span class="op" id="4880850">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880853">if</span>&nbsp;<span class="ident" id="4880856">e</span>&nbsp;<span class="op" id="4880858">!=</span>&nbsp;<span class="ident" id="4880861">nil</span>&nbsp;<span class="op" id="4880865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880869">return</span>&nbsp;<span class="num" id="4880876">0</span><span class="op" id="4880877">,</span>&nbsp;<span class="ident" id="4880879">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880886">return</span>&nbsp;<span class="ident" id="4880893">ret</span><span class="op" id="4880896">,</span>&nbsp;<span class="ident" id="4880898">nil</span><br>
<span class="lineno">160</span><span class="op" id="4880902">}</span>
</div>
</body>
</html>
