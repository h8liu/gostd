<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3959891">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3959947">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3960001">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3960052">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3960131">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="3960204">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="3960269">//</span><br>
<span class="lineno"></span><span class="comment" id="3960272">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="3960330">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="3960381">package</span>&nbsp;<span class="ident" id="3960389">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3960395">import</span>&nbsp;<span class="op" id="3960402">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960405">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960414">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960426">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960445">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960453">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960464">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960475">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960483">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960494">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960505">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960513">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3960524">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3960539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3960542">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3960585">//</span><br>
<span class="lineno">30</span><span class="comment" id="3960588">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="3960634">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="3960696">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3960762">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="3960835">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="3960899">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="3960917">//</span><br>
<span class="lineno"></span><span class="comment" id="3960920">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="3960995">//</span><br>
<span class="lineno"></span><span class="comment" id="3960998">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="3961041">//</span><br>
<span class="lineno"></span><span class="comment" id="3961044">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="3961114">//</span><br>
<span class="lineno"></span><span class="comment" id="3961117">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="3961181">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="3961243">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3961314">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="3961381">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="3961447">//</span><br>
<span class="lineno"></span><span class="comment" id="3961450">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="3961511">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="3961573">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3961609">//</span><br>
<span class="lineno"></span><span class="comment" id="3961612">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3961680">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="3961721">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3961755">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="3961827">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3961865">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3961940">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="3962013">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3962088">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="3962167">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="3962193">//</span><br>
<span class="lineno"></span><span class="comment" id="3962196">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="3962238">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3962264">//</span><br>
<span class="lineno"></span><span class="comment" id="3962267">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3962314">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3962345">//</span><br>
<span class="lineno">70</span><span class="comment" id="3962348">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3962398">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="3962466">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="3962492">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3962533">//</span><br>
<span class="lineno">75</span><span class="comment" id="3962536">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="3962600">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="3962639">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="3962671">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3962706">//</span><br>
<span class="lineno">80</span><span class="comment" id="3962709">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3962780">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="3962857">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3962930">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="3962973">//</span><br>
<span class="lineno">85</span><span class="comment" id="3962976">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3963017">//</span><br>
<span class="lineno"></span><span class="comment" id="3963020">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3963090">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="3963161">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="3963189">//</span><br>
<span class="lineno"></span><span class="comment" id="3963192">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="3963275">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="3963360">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="3963399">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="3963476">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="3963526">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="3963603">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="3963658">//</span><br>
<span class="lineno"></span><span class="comment" id="3963661">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="3963732">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3963794">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="3963860">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3963928">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="3963981">//</span><br>
<span class="lineno">105</span><span class="comment" id="3963984">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="3964066">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="3964143">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="3964242">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="3964323">//</span><br>
<span class="lineno">110</span><span class="comment" id="3964326">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="3964383">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3964462">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3964544">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3964566">//</span><br>
<span class="lineno">115</span><span class="comment" id="3964569">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="3964607">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3964679">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3964695">//</span><br>
<span class="lineno"></span><span class="comment" id="3964698">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="3964748">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3964798">//</span><br>
<span class="lineno"></span><span class="comment" id="3964801">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3964869">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3964927">//</span><br>
<span class="lineno">125</span><span class="comment" id="3964930">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="3964998">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3965060">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="3965088">//</span><br>
<span class="lineno"></span><span class="comment" id="3965091">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="3965160">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3965229">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="3965255">//</span><br>
<span class="lineno"></span><span class="keyword" id="3965258">func</span>&nbsp;<span class="ident" id="3965263">Marshal</span><span class="op" id="3965270">(</span><span class="ident" id="3965271">v</span>&nbsp;<span class="keyword" id="3965273">interface</span><span class="op" id="3965282">{</span><span class="op" id="3965283">}</span><span class="op" id="3965284">)</span>&nbsp;<span class="op" id="3965286">(</span><span class="op" id="3965287">[</span><span class="op" id="3965288">]</span><span class="builtintype" id="3965289">byte</span><span class="op" id="3965293">,</span>&nbsp;<span class="builtintype" id="3965295">error</span><span class="op" id="3965300">)</span>&nbsp;<span class="op" id="3965302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965305">e</span>&nbsp;<span class="op" id="3965307">:=</span>&nbsp;<span class="op" id="3965310">&amp;</span><span class="ident" id="3965311">encodeState</span><span class="op" id="3965322">{</span><span class="op" id="3965323">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965326">err</span>&nbsp;<span class="op" id="3965330">:=</span>&nbsp;<span class="ident" id="3965333">e</span><span class="op" id="3965334">.</span><span class="ident" id="3965335">marshal</span><span class="op" id="3965342">(</span><span class="ident" id="3965343">v</span><span class="op" id="3965344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965347">if</span>&nbsp;<span class="ident" id="3965350">err</span>&nbsp;<span class="op" id="3965354">!=</span>&nbsp;<span class="ident" id="3965357">nil</span>&nbsp;<span class="op" id="3965361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965365">return</span>&nbsp;<span class="ident" id="3965372">nil</span><span class="op" id="3965375">,</span>&nbsp;<span class="ident" id="3965377">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965385">return</span>&nbsp;<span class="ident" id="3965392">e</span><span class="op" id="3965393">.</span><span class="ident" id="3965394">Bytes</span><span class="op" id="3965399">(</span><span class="op" id="3965400">)</span><span class="op" id="3965401">,</span>&nbsp;<span class="ident" id="3965403">nil</span><br>
<span class="lineno">140</span><span class="op" id="3965407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3965410">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="3965484">func</span>&nbsp;<span class="ident" id="3965489">MarshalIndent</span><span class="op" id="3965502">(</span><span class="ident" id="3965503">v</span>&nbsp;<span class="keyword" id="3965505">interface</span><span class="op" id="3965514">{</span><span class="op" id="3965515">}</span><span class="op" id="3965516">,</span>&nbsp;<span class="ident" id="3965518">prefix</span><span class="op" id="3965524">,</span>&nbsp;<span class="ident" id="3965526">indent</span>&nbsp;<span class="builtintype" id="3965533">string</span><span class="op" id="3965539">)</span>&nbsp;<span class="op" id="3965541">(</span><span class="op" id="3965542">[</span><span class="op" id="3965543">]</span><span class="builtintype" id="3965544">byte</span><span class="op" id="3965548">,</span>&nbsp;<span class="builtintype" id="3965550">error</span><span class="op" id="3965555">)</span>&nbsp;<span class="op" id="3965557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965560">b</span><span class="op" id="3965561">,</span>&nbsp;<span class="ident" id="3965563">err</span>&nbsp;<span class="op" id="3965567">:=</span>&nbsp;<span class="ident" id="3965570">Marshal</span><span class="op" id="3965577">(</span><span class="ident" id="3965578">v</span><span class="op" id="3965579">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965582">if</span>&nbsp;<span class="ident" id="3965585">err</span>&nbsp;<span class="op" id="3965589">!=</span>&nbsp;<span class="ident" id="3965592">nil</span>&nbsp;<span class="op" id="3965596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965600">return</span>&nbsp;<span class="ident" id="3965607">nil</span><span class="op" id="3965610">,</span>&nbsp;<span class="ident" id="3965612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965620">var</span>&nbsp;<span class="ident" id="3965624">buf</span>&nbsp;<span class="ident" id="3965628">bytes</span><span class="op" id="3965633">.</span><span class="ident" id="3965634">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965642">err</span>&nbsp;<span class="op" id="3965646">=</span>&nbsp;<span class="ident" id="3965648">Indent</span><span class="op" id="3965654">(</span><span class="op" id="3965655">&amp;</span><span class="ident" id="3965656">buf</span><span class="op" id="3965659">,</span>&nbsp;<span class="ident" id="3965661">b</span><span class="op" id="3965662">,</span>&nbsp;<span class="ident" id="3965664">prefix</span><span class="op" id="3965670">,</span>&nbsp;<span class="ident" id="3965672">indent</span><span class="op" id="3965678">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965681">if</span>&nbsp;<span class="ident" id="3965684">err</span>&nbsp;<span class="op" id="3965688">!=</span>&nbsp;<span class="ident" id="3965691">nil</span>&nbsp;<span class="op" id="3965695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965699">return</span>&nbsp;<span class="ident" id="3965706">nil</span><span class="op" id="3965709">,</span>&nbsp;<span class="ident" id="3965711">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965719">return</span>&nbsp;<span class="ident" id="3965726">buf</span><span class="op" id="3965729">.</span><span class="ident" id="3965730">Bytes</span><span class="op" id="3965735">(</span><span class="op" id="3965736">)</span><span class="op" id="3965737">,</span>&nbsp;<span class="ident" id="3965739">nil</span><br>
<span class="lineno"></span><span class="op" id="3965743">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3965746">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="3965828">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="3965915">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="3965984">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="3966050">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3966121">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3966133">func</span>&nbsp;<span class="ident" id="3966138">HTMLEscape</span><span class="op" id="3966148">(</span><span class="ident" id="3966149">dst</span>&nbsp;<span class="op" id="3966153">*</span><span class="ident" id="3966154">bytes</span><span class="op" id="3966159">.</span><span class="ident" id="3966160">Buffer</span><span class="op" id="3966166">,</span>&nbsp;<span class="ident" id="3966168">src</span>&nbsp;<span class="op" id="3966172">[</span><span class="op" id="3966173">]</span><span class="builtintype" id="3966174">byte</span><span class="op" id="3966178">)</span>&nbsp;<span class="op" id="3966180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966183">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966238">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966286">start</span>&nbsp;<span class="op" id="3966292">:=</span>&nbsp;<span class="num" id="3966295">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966298">for</span>&nbsp;<span class="ident" id="3966302">i</span><span class="op" id="3966303">,</span>&nbsp;<span class="ident" id="3966305">c</span>&nbsp;<span class="op" id="3966307">:=</span>&nbsp;<span class="keyword" id="3966310">range</span>&nbsp;<span class="ident" id="3966316">src</span>&nbsp;<span class="op" id="3966320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966324">if</span>&nbsp;<span class="ident" id="3966327">c</span>&nbsp;<span class="op" id="3966329">==</span>&nbsp;<span class="string" id="3966332">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3966336">||</span>&nbsp;<span class="ident" id="3966339">c</span>&nbsp;<span class="op" id="3966341">==</span>&nbsp;<span class="string" id="3966344">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3966348">||</span>&nbsp;<span class="ident" id="3966351">c</span>&nbsp;<span class="op" id="3966353">==</span>&nbsp;<span class="string" id="3966356">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3966360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966365">if</span>&nbsp;<span class="ident" id="3966368">start</span>&nbsp;<span class="op" id="3966374">&lt;</span>&nbsp;<span class="ident" id="3966376">i</span>&nbsp;<span class="op" id="3966378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966384">dst</span><span class="op" id="3966387">.</span><span class="ident" id="3966388">Write</span><span class="op" id="3966393">(</span><span class="ident" id="3966394">src</span><span class="op" id="3966397">[</span><span class="ident" id="3966398">start</span><span class="op" id="3966403">:</span><span class="ident" id="3966404">i</span><span class="op" id="3966405">]</span><span class="op" id="3966406">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966416">dst</span><span class="op" id="3966419">.</span><span class="ident" id="3966420">WriteString</span><span class="op" id="3966431">(</span><span class="string" id="3966432">`\u00`</span><span class="op" id="3966438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966443">dst</span><span class="op" id="3966446">.</span><span class="ident" id="3966447">WriteByte</span><span class="op" id="3966456">(</span><span class="ident" id="3966457">hex</span><span class="op" id="3966460">[</span><span class="ident" id="3966461">c</span><span class="op" id="3966462">&gt;&gt;</span><span class="num" id="3966464">4</span><span class="op" id="3966465">]</span><span class="op" id="3966466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966471">dst</span><span class="op" id="3966474">.</span><span class="ident" id="3966475">WriteByte</span><span class="op" id="3966484">(</span><span class="ident" id="3966485">hex</span><span class="op" id="3966488">[</span><span class="ident" id="3966489">c</span><span class="op" id="3966490">&amp;</span><span class="num" id="3966491">0xF</span><span class="op" id="3966494">]</span><span class="op" id="3966495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966500">start</span>&nbsp;<span class="op" id="3966506">=</span>&nbsp;<span class="ident" id="3966508">i</span>&nbsp;<span class="op" id="3966510">+</span>&nbsp;<span class="num" id="3966512">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966520">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966576">if</span>&nbsp;<span class="ident" id="3966579">c</span>&nbsp;<span class="op" id="3966581">==</span>&nbsp;<span class="num" id="3966584">0xE2</span>&nbsp;<span class="op" id="3966589">&amp;&amp;</span>&nbsp;<span class="ident" id="3966592">i</span><span class="op" id="3966593">+</span><span class="num" id="3966594">2</span>&nbsp;<span class="op" id="3966596">&lt;</span>&nbsp;<span class="builtinfunc" id="3966598">len</span><span class="op" id="3966601">(</span><span class="ident" id="3966602">src</span><span class="op" id="3966605">)</span>&nbsp;<span class="op" id="3966607">&amp;&amp;</span>&nbsp;<span class="ident" id="3966610">src</span><span class="op" id="3966613">[</span><span class="ident" id="3966614">i</span><span class="op" id="3966615">+</span><span class="num" id="3966616">1</span><span class="op" id="3966617">]</span>&nbsp;<span class="op" id="3966619">==</span>&nbsp;<span class="num" id="3966622">0x80</span>&nbsp;<span class="op" id="3966627">&amp;&amp;</span>&nbsp;<span class="ident" id="3966630">src</span><span class="op" id="3966633">[</span><span class="ident" id="3966634">i</span><span class="op" id="3966635">+</span><span class="num" id="3966636">2</span><span class="op" id="3966637">]</span><span class="op" id="3966638">&amp;^</span><span class="num" id="3966640">1</span>&nbsp;<span class="op" id="3966642">==</span>&nbsp;<span class="num" id="3966645">0xA8</span>&nbsp;<span class="op" id="3966650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966655">if</span>&nbsp;<span class="ident" id="3966658">start</span>&nbsp;<span class="op" id="3966664">&lt;</span>&nbsp;<span class="ident" id="3966666">i</span>&nbsp;<span class="op" id="3966668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966674">dst</span><span class="op" id="3966677">.</span><span class="ident" id="3966678">Write</span><span class="op" id="3966683">(</span><span class="ident" id="3966684">src</span><span class="op" id="3966687">[</span><span class="ident" id="3966688">start</span><span class="op" id="3966693">:</span><span class="ident" id="3966694">i</span><span class="op" id="3966695">]</span><span class="op" id="3966696">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966706">dst</span><span class="op" id="3966709">.</span><span class="ident" id="3966710">WriteString</span><span class="op" id="3966721">(</span><span class="string" id="3966722">`\u202`</span><span class="op" id="3966729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966734">dst</span><span class="op" id="3966737">.</span><span class="ident" id="3966738">WriteByte</span><span class="op" id="3966747">(</span><span class="ident" id="3966748">hex</span><span class="op" id="3966751">[</span><span class="ident" id="3966752">src</span><span class="op" id="3966755">[</span><span class="ident" id="3966756">i</span><span class="op" id="3966757">+</span><span class="num" id="3966758">2</span><span class="op" id="3966759">]</span><span class="op" id="3966760">&amp;</span><span class="num" id="3966761">0xF</span><span class="op" id="3966764">]</span><span class="op" id="3966765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966770">start</span>&nbsp;<span class="op" id="3966776">=</span>&nbsp;<span class="ident" id="3966778">i</span>&nbsp;<span class="op" id="3966780">+</span>&nbsp;<span class="num" id="3966782">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966786">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966792">if</span>&nbsp;<span class="ident" id="3966795">start</span>&nbsp;<span class="op" id="3966801">&lt;</span>&nbsp;<span class="builtinfunc" id="3966803">len</span><span class="op" id="3966806">(</span><span class="ident" id="3966807">src</span><span class="op" id="3966810">)</span>&nbsp;<span class="op" id="3966812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966816">dst</span><span class="op" id="3966819">.</span><span class="ident" id="3966820">Write</span><span class="op" id="3966825">(</span><span class="ident" id="3966826">src</span><span class="op" id="3966829">[</span><span class="ident" id="3966830">start</span><span class="op" id="3966835">:</span><span class="op" id="3966836">]</span><span class="op" id="3966837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966840">}</span><br>
<span class="lineno"></span><span class="op" id="3966842">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3966845">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3966903">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="3966946">type</span>&nbsp;<span class="ident" id="3966951">Marshaler</span>&nbsp;<span class="keyword" id="3966961">interface</span>&nbsp;<span class="op" id="3966971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966974">MarshalJSON</span><span class="op" id="3966985">(</span><span class="op" id="3966986">)</span>&nbsp;<span class="op" id="3966988">(</span><span class="op" id="3966989">[</span><span class="op" id="3966990">]</span><span class="builtintype" id="3966991">byte</span><span class="op" id="3966995">,</span>&nbsp;<span class="builtintype" id="3966997">error</span><span class="op" id="3967002">)</span><br>
<span class="lineno">195</span><span class="op" id="3967004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3967007">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="3967073">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3967113">type</span>&nbsp;<span class="ident" id="3967118">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="3967139">struct</span>&nbsp;<span class="op" id="3967146">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967149">Type</span>&nbsp;<span class="ident" id="3967154">reflect</span><span class="op" id="3967161">.</span><span class="ident" id="3967162">Type</span><br>
<span class="lineno"></span><span class="op" id="3967167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3967170">func</span>&nbsp;<span class="op" id="3967175">(</span><span class="ident" id="3967176">e</span>&nbsp;<span class="op" id="3967178">*</span><span class="ident" id="3967179">UnsupportedTypeError</span><span class="op" id="3967199">)</span>&nbsp;<span class="ident" id="3967201">Error</span><span class="op" id="3967206">(</span><span class="op" id="3967207">)</span>&nbsp;<span class="builtintype" id="3967209">string</span>&nbsp;<span class="op" id="3967216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967219">return</span>&nbsp;<span class="string" id="3967226">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="3967253">+</span>&nbsp;<span class="ident" id="3967255">e</span><span class="op" id="3967256">.</span><span class="ident" id="3967257">Type</span><span class="op" id="3967261">.</span><span class="ident" id="3967262">String</span><span class="op" id="3967268">(</span><span class="op" id="3967269">)</span><br>
<span class="lineno">205</span><span class="op" id="3967271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3967274">type</span>&nbsp;<span class="ident" id="3967279">UnsupportedValueError</span>&nbsp;<span class="keyword" id="3967301">struct</span>&nbsp;<span class="op" id="3967308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967311">Value</span>&nbsp;<span class="ident" id="3967317">reflect</span><span class="op" id="3967324">.</span><span class="ident" id="3967325">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967332">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3967338">string</span><br>
<span class="lineno">210</span><span class="op" id="3967345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3967348">func</span>&nbsp;<span class="op" id="3967353">(</span><span class="ident" id="3967354">e</span>&nbsp;<span class="op" id="3967356">*</span><span class="ident" id="3967357">UnsupportedValueError</span><span class="op" id="3967378">)</span>&nbsp;<span class="ident" id="3967380">Error</span><span class="op" id="3967385">(</span><span class="op" id="3967386">)</span>&nbsp;<span class="builtintype" id="3967388">string</span>&nbsp;<span class="op" id="3967395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967398">return</span>&nbsp;<span class="string" id="3967405">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="3967433">+</span>&nbsp;<span class="ident" id="3967435">e</span><span class="op" id="3967436">.</span><span class="ident" id="3967437">Str</span><br>
<span class="lineno"></span><span class="op" id="3967441">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="3967444">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3967511">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="3967580">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3967650">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="3967719">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="3967796">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3967836">type</span>&nbsp;<span class="ident" id="3967841">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="3967858">struct</span>&nbsp;<span class="op" id="3967865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967868">S</span>&nbsp;<span class="builtintype" id="3967870">string</span>&nbsp;<span class="comment" id="3967877">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="3967925">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3967928">func</span>&nbsp;<span class="op" id="3967933">(</span><span class="ident" id="3967934">e</span>&nbsp;<span class="op" id="3967936">*</span><span class="ident" id="3967937">InvalidUTF8Error</span><span class="op" id="3967953">)</span>&nbsp;<span class="ident" id="3967955">Error</span><span class="op" id="3967960">(</span><span class="op" id="3967961">)</span>&nbsp;<span class="builtintype" id="3967963">string</span>&nbsp;<span class="op" id="3967970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967973">return</span>&nbsp;<span class="string" id="3967980">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="3968014">+</span>&nbsp;<span class="ident" id="3968016">strconv</span><span class="op" id="3968023">.</span><span class="ident" id="3968024">Quote</span><span class="op" id="3968029">(</span><span class="ident" id="3968030">e</span><span class="op" id="3968031">.</span><span class="ident" id="3968032">S</span><span class="op" id="3968033">)</span><br>
<span class="lineno"></span><span class="op" id="3968035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="3968038">type</span>&nbsp;<span class="ident" id="3968043">MarshalerError</span>&nbsp;<span class="keyword" id="3968058">struct</span>&nbsp;<span class="op" id="3968065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968068">Type</span>&nbsp;<span class="ident" id="3968073">reflect</span><span class="op" id="3968080">.</span><span class="ident" id="3968081">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968087">Err</span>&nbsp;&nbsp;<span class="builtintype" id="3968092">error</span><br>
<span class="lineno"></span><span class="op" id="3968098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="3968101">func</span>&nbsp;<span class="op" id="3968106">(</span><span class="ident" id="3968107">e</span>&nbsp;<span class="op" id="3968109">*</span><span class="ident" id="3968110">MarshalerError</span><span class="op" id="3968124">)</span>&nbsp;<span class="ident" id="3968126">Error</span><span class="op" id="3968131">(</span><span class="op" id="3968132">)</span>&nbsp;<span class="builtintype" id="3968134">string</span>&nbsp;<span class="op" id="3968141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968144">return</span>&nbsp;<span class="string" id="3968151">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3968195">+</span>&nbsp;<span class="ident" id="3968197">e</span><span class="op" id="3968198">.</span><span class="ident" id="3968199">Type</span><span class="op" id="3968203">.</span><span class="ident" id="3968204">String</span><span class="op" id="3968210">(</span><span class="op" id="3968211">)</span>&nbsp;<span class="op" id="3968213">+</span>&nbsp;<span class="string" id="3968215">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3968220">+</span>&nbsp;<span class="ident" id="3968222">e</span><span class="op" id="3968223">.</span><span class="ident" id="3968224">Err</span><span class="op" id="3968227">.</span><span class="ident" id="3968228">Error</span><span class="op" id="3968233">(</span><span class="op" id="3968234">)</span><br>
<span class="lineno"></span><span class="op" id="3968236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3968239">var</span>&nbsp;<span class="ident" id="3968243">hex</span>&nbsp;<span class="op" id="3968247">=</span>&nbsp;<span class="string" id="3968249">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3968269">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3968321">type</span>&nbsp;<span class="ident" id="3968326">encodeState</span>&nbsp;<span class="keyword" id="3968338">struct</span>&nbsp;<span class="op" id="3968345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968348">bytes</span><span class="op" id="3968353">.</span><span class="ident" id="3968354">Buffer</span>&nbsp;<span class="comment" id="3968361">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968384">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3968397">[</span><span class="num" id="3968398">64</span><span class="op" id="3968400">]</span><span class="builtintype" id="3968401">byte</span><br>
<span class="lineno">245</span><span class="op" id="3968406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3968409">var</span>&nbsp;<span class="ident" id="3968413">encodeStatePool</span>&nbsp;<span class="ident" id="3968429">sync</span><span class="op" id="3968433">.</span><span class="ident" id="3968434">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3968440">func</span>&nbsp;<span class="ident" id="3968445">newEncodeState</span><span class="op" id="3968459">(</span><span class="op" id="3968460">)</span>&nbsp;<span class="op" id="3968462">*</span><span class="ident" id="3968463">encodeState</span>&nbsp;<span class="op" id="3968475">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968478">if</span>&nbsp;<span class="ident" id="3968481">v</span>&nbsp;<span class="op" id="3968483">:=</span>&nbsp;<span class="ident" id="3968486">encodeStatePool</span><span class="op" id="3968501">.</span><span class="ident" id="3968502">Get</span><span class="op" id="3968505">(</span><span class="op" id="3968506">)</span><span class="op" id="3968507">;</span>&nbsp;<span class="ident" id="3968509">v</span>&nbsp;<span class="op" id="3968511">!=</span>&nbsp;<span class="ident" id="3968514">nil</span>&nbsp;<span class="op" id="3968518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968522">e</span>&nbsp;<span class="op" id="3968524">:=</span>&nbsp;<span class="ident" id="3968527">v</span><span class="op" id="3968528">.</span><span class="op" id="3968529">(</span><span class="op" id="3968530">*</span><span class="ident" id="3968531">encodeState</span><span class="op" id="3968542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968546">e</span><span class="op" id="3968547">.</span><span class="ident" id="3968548">Reset</span><span class="op" id="3968553">(</span><span class="op" id="3968554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968558">return</span>&nbsp;<span class="ident" id="3968565">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968568">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968571">return</span>&nbsp;<span class="builtinfunc" id="3968578">new</span><span class="op" id="3968581">(</span><span class="ident" id="3968582">encodeState</span><span class="op" id="3968593">)</span><br>
<span class="lineno"></span><span class="op" id="3968595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3968598">func</span>&nbsp;<span class="op" id="3968603">(</span><span class="ident" id="3968604">e</span>&nbsp;<span class="op" id="3968606">*</span><span class="ident" id="3968607">encodeState</span><span class="op" id="3968618">)</span>&nbsp;<span class="ident" id="3968620">marshal</span><span class="op" id="3968627">(</span><span class="ident" id="3968628">v</span>&nbsp;<span class="keyword" id="3968630">interface</span><span class="op" id="3968639">{</span><span class="op" id="3968640">}</span><span class="op" id="3968641">)</span>&nbsp;<span class="op" id="3968643">(</span><span class="ident" id="3968644">err</span>&nbsp;<span class="builtintype" id="3968648">error</span><span class="op" id="3968653">)</span>&nbsp;<span class="op" id="3968655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968658">defer</span>&nbsp;<span class="keyword" id="3968664">func</span><span class="op" id="3968668">(</span><span class="op" id="3968669">)</span>&nbsp;<span class="op" id="3968671">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968675">if</span>&nbsp;<span class="ident" id="3968678">r</span>&nbsp;<span class="op" id="3968680">:=</span>&nbsp;<span class="builtinfunc" id="3968683">recover</span><span class="op" id="3968690">(</span><span class="op" id="3968691">)</span><span class="op" id="3968692">;</span>&nbsp;<span class="ident" id="3968694">r</span>&nbsp;<span class="op" id="3968696">!=</span>&nbsp;<span class="ident" id="3968699">nil</span>&nbsp;<span class="op" id="3968703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968708">if</span>&nbsp;<span class="ident" id="3968711">_</span><span class="op" id="3968712">,</span>&nbsp;<span class="ident" id="3968714">ok</span>&nbsp;<span class="op" id="3968717">:=</span>&nbsp;<span class="ident" id="3968720">r</span><span class="op" id="3968721">.</span><span class="op" id="3968722">(</span><span class="ident" id="3968723">runtime</span><span class="op" id="3968730">.</span><span class="ident" id="3968731">Error</span><span class="op" id="3968736">)</span><span class="op" id="3968737">;</span>&nbsp;<span class="ident" id="3968739">ok</span>&nbsp;<span class="op" id="3968742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3968748">panic</span><span class="op" id="3968753">(</span><span class="ident" id="3968754">r</span><span class="op" id="3968755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968765">if</span>&nbsp;<span class="ident" id="3968768">s</span><span class="op" id="3968769">,</span>&nbsp;<span class="ident" id="3968771">ok</span>&nbsp;<span class="op" id="3968774">:=</span>&nbsp;<span class="ident" id="3968777">r</span><span class="op" id="3968778">.</span><span class="op" id="3968779">(</span><span class="builtintype" id="3968780">string</span><span class="op" id="3968786">)</span><span class="op" id="3968787">;</span>&nbsp;<span class="ident" id="3968789">ok</span>&nbsp;<span class="op" id="3968792">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3968798">panic</span><span class="op" id="3968803">(</span><span class="ident" id="3968804">s</span><span class="op" id="3968805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968815">err</span>&nbsp;<span class="op" id="3968819">=</span>&nbsp;<span class="ident" id="3968821">r</span><span class="op" id="3968822">.</span><span class="op" id="3968823">(</span><span class="builtintype" id="3968824">error</span><span class="op" id="3968829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968836">}</span><span class="op" id="3968837">(</span><span class="op" id="3968838">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968841">e</span><span class="op" id="3968842">.</span><span class="ident" id="3968843">reflectValue</span><span class="op" id="3968855">(</span><span class="ident" id="3968856">reflect</span><span class="op" id="3968863">.</span><span class="ident" id="3968864">ValueOf</span><span class="op" id="3968871">(</span><span class="ident" id="3968872">v</span><span class="op" id="3968873">)</span><span class="op" id="3968874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3968877">return</span>&nbsp;<span class="ident" id="3968884">nil</span><br>
<span class="lineno"></span><span class="op" id="3968888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3968891">func</span>&nbsp;<span class="op" id="3968896">(</span><span class="ident" id="3968897">e</span>&nbsp;<span class="op" id="3968899">*</span><span class="ident" id="3968900">encodeState</span><span class="op" id="3968911">)</span>&nbsp;<span class="builtintype" id="3968913">error</span><span class="op" id="3968918">(</span><span class="ident" id="3968919">err</span>&nbsp;<span class="builtintype" id="3968923">error</span><span class="op" id="3968928">)</span>&nbsp;<span class="op" id="3968930">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3968933">panic</span><span class="op" id="3968938">(</span><span class="ident" id="3968939">err</span><span class="op" id="3968942">)</span><br>
<span class="lineno"></span><span class="op" id="3968944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3968947">var</span>&nbsp;<span class="ident" id="3968951">byteSliceType</span>&nbsp;<span class="op" id="3968965">=</span>&nbsp;<span class="ident" id="3968967">reflect</span><span class="op" id="3968974">.</span><span class="ident" id="3968975">TypeOf</span><span class="op" id="3968981">(</span><span class="op" id="3968982">[</span><span class="op" id="3968983">]</span><span class="builtintype" id="3968984">byte</span><span class="op" id="3968988">(</span><span class="ident" id="3968989">nil</span><span class="op" id="3968992">)</span><span class="op" id="3968993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="3968996">func</span>&nbsp;<span class="ident" id="3969001">isEmptyValue</span><span class="op" id="3969013">(</span><span class="ident" id="3969014">v</span>&nbsp;<span class="ident" id="3969016">reflect</span><span class="op" id="3969023">.</span><span class="ident" id="3969024">Value</span><span class="op" id="3969029">)</span>&nbsp;<span class="builtintype" id="3969031">bool</span>&nbsp;<span class="op" id="3969036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969039">switch</span>&nbsp;<span class="ident" id="3969046">v</span><span class="op" id="3969047">.</span><span class="ident" id="3969048">Kind</span><span class="op" id="3969052">(</span><span class="op" id="3969053">)</span>&nbsp;<span class="op" id="3969055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969058">case</span>&nbsp;<span class="ident" id="3969063">reflect</span><span class="op" id="3969070">.</span><span class="ident" id="3969071">Array</span><span class="op" id="3969076">,</span>&nbsp;<span class="ident" id="3969078">reflect</span><span class="op" id="3969085">.</span><span class="ident" id="3969086">Map</span><span class="op" id="3969089">,</span>&nbsp;<span class="ident" id="3969091">reflect</span><span class="op" id="3969098">.</span><span class="ident" id="3969099">Slice</span><span class="op" id="3969104">,</span>&nbsp;<span class="ident" id="3969106">reflect</span><span class="op" id="3969113">.</span><span class="ident" id="3969114">String</span><span class="op" id="3969120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969124">return</span>&nbsp;<span class="ident" id="3969131">v</span><span class="op" id="3969132">.</span><span class="ident" id="3969133">Len</span><span class="op" id="3969136">(</span><span class="op" id="3969137">)</span>&nbsp;<span class="op" id="3969139">==</span>&nbsp;<span class="num" id="3969142">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969145">case</span>&nbsp;<span class="ident" id="3969150">reflect</span><span class="op" id="3969157">.</span><span class="ident" id="3969158">Bool</span><span class="op" id="3969162">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969166">return</span>&nbsp;<span class="op" id="3969173">!</span><span class="ident" id="3969174">v</span><span class="op" id="3969175">.</span><span class="ident" id="3969176">Bool</span><span class="op" id="3969180">(</span><span class="op" id="3969181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969184">case</span>&nbsp;<span class="ident" id="3969189">reflect</span><span class="op" id="3969196">.</span><span class="ident" id="3969197">Int</span><span class="op" id="3969200">,</span>&nbsp;<span class="ident" id="3969202">reflect</span><span class="op" id="3969209">.</span><span class="ident" id="3969210">Int8</span><span class="op" id="3969214">,</span>&nbsp;<span class="ident" id="3969216">reflect</span><span class="op" id="3969223">.</span><span class="ident" id="3969224">Int16</span><span class="op" id="3969229">,</span>&nbsp;<span class="ident" id="3969231">reflect</span><span class="op" id="3969238">.</span><span class="ident" id="3969239">Int32</span><span class="op" id="3969244">,</span>&nbsp;<span class="ident" id="3969246">reflect</span><span class="op" id="3969253">.</span><span class="ident" id="3969254">Int64</span><span class="op" id="3969259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969263">return</span>&nbsp;<span class="ident" id="3969270">v</span><span class="op" id="3969271">.</span><span class="ident" id="3969272">Int</span><span class="op" id="3969275">(</span><span class="op" id="3969276">)</span>&nbsp;<span class="op" id="3969278">==</span>&nbsp;<span class="num" id="3969281">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969284">case</span>&nbsp;<span class="ident" id="3969289">reflect</span><span class="op" id="3969296">.</span><span class="ident" id="3969297">Uint</span><span class="op" id="3969301">,</span>&nbsp;<span class="ident" id="3969303">reflect</span><span class="op" id="3969310">.</span><span class="ident" id="3969311">Uint8</span><span class="op" id="3969316">,</span>&nbsp;<span class="ident" id="3969318">reflect</span><span class="op" id="3969325">.</span><span class="ident" id="3969326">Uint16</span><span class="op" id="3969332">,</span>&nbsp;<span class="ident" id="3969334">reflect</span><span class="op" id="3969341">.</span><span class="ident" id="3969342">Uint32</span><span class="op" id="3969348">,</span>&nbsp;<span class="ident" id="3969350">reflect</span><span class="op" id="3969357">.</span><span class="ident" id="3969358">Uint64</span><span class="op" id="3969364">,</span>&nbsp;<span class="ident" id="3969366">reflect</span><span class="op" id="3969373">.</span><span class="ident" id="3969374">Uintptr</span><span class="op" id="3969381">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969385">return</span>&nbsp;<span class="ident" id="3969392">v</span><span class="op" id="3969393">.</span><span class="ident" id="3969394">Uint</span><span class="op" id="3969398">(</span><span class="op" id="3969399">)</span>&nbsp;<span class="op" id="3969401">==</span>&nbsp;<span class="num" id="3969404">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969407">case</span>&nbsp;<span class="ident" id="3969412">reflect</span><span class="op" id="3969419">.</span><span class="ident" id="3969420">Float32</span><span class="op" id="3969427">,</span>&nbsp;<span class="ident" id="3969429">reflect</span><span class="op" id="3969436">.</span><span class="ident" id="3969437">Float64</span><span class="op" id="3969444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969448">return</span>&nbsp;<span class="ident" id="3969455">v</span><span class="op" id="3969456">.</span><span class="ident" id="3969457">Float</span><span class="op" id="3969462">(</span><span class="op" id="3969463">)</span>&nbsp;<span class="op" id="3969465">==</span>&nbsp;<span class="num" id="3969468">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969471">case</span>&nbsp;<span class="ident" id="3969476">reflect</span><span class="op" id="3969483">.</span><span class="ident" id="3969484">Interface</span><span class="op" id="3969493">,</span>&nbsp;<span class="ident" id="3969495">reflect</span><span class="op" id="3969502">.</span><span class="ident" id="3969503">Ptr</span><span class="op" id="3969506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969510">return</span>&nbsp;<span class="ident" id="3969517">v</span><span class="op" id="3969518">.</span><span class="ident" id="3969519">IsNil</span><span class="op" id="3969524">(</span><span class="op" id="3969525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969528">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969531">return</span>&nbsp;<span class="builtintype" id="3969538">false</span><br>
<span class="lineno"></span><span class="op" id="3969544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3969547">func</span>&nbsp;<span class="op" id="3969552">(</span><span class="ident" id="3969553">e</span>&nbsp;<span class="op" id="3969555">*</span><span class="ident" id="3969556">encodeState</span><span class="op" id="3969567">)</span>&nbsp;<span class="ident" id="3969569">reflectValue</span><span class="op" id="3969581">(</span><span class="ident" id="3969582">v</span>&nbsp;<span class="ident" id="3969584">reflect</span><span class="op" id="3969591">.</span><span class="ident" id="3969592">Value</span><span class="op" id="3969597">)</span>&nbsp;<span class="op" id="3969599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969602">valueEncoder</span><span class="op" id="3969614">(</span><span class="ident" id="3969615">v</span><span class="op" id="3969616">)</span><span class="op" id="3969617">(</span><span class="ident" id="3969618">e</span><span class="op" id="3969619">,</span>&nbsp;<span class="ident" id="3969621">v</span><span class="op" id="3969622">,</span>&nbsp;<span class="builtintype" id="3969624">false</span><span class="op" id="3969629">)</span><br>
<span class="lineno">300</span><span class="op" id="3969631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3969634">type</span>&nbsp;<span class="ident" id="3969639">encoderFunc</span>&nbsp;<span class="keyword" id="3969651">func</span><span class="op" id="3969655">(</span><span class="ident" id="3969656">e</span>&nbsp;<span class="op" id="3969658">*</span><span class="ident" id="3969659">encodeState</span><span class="op" id="3969670">,</span>&nbsp;<span class="ident" id="3969672">v</span>&nbsp;<span class="ident" id="3969674">reflect</span><span class="op" id="3969681">.</span><span class="ident" id="3969682">Value</span><span class="op" id="3969687">,</span>&nbsp;<span class="ident" id="3969689">quoted</span>&nbsp;<span class="builtintype" id="3969696">bool</span><span class="op" id="3969700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3969703">var</span>&nbsp;<span class="ident" id="3969707">encoderCache</span>&nbsp;<span class="keyword" id="3969720">struct</span>&nbsp;<span class="op" id="3969727">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969730">sync</span><span class="op" id="3969734">.</span><span class="ident" id="3969735">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969744">m</span>&nbsp;<span class="keyword" id="3969746">map</span><span class="op" id="3969749">[</span><span class="ident" id="3969750">reflect</span><span class="op" id="3969757">.</span><span class="ident" id="3969758">Type</span><span class="op" id="3969762">]</span><span class="ident" id="3969763">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3969775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3969778">func</span>&nbsp;<span class="ident" id="3969783">valueEncoder</span><span class="op" id="3969795">(</span><span class="ident" id="3969796">v</span>&nbsp;<span class="ident" id="3969798">reflect</span><span class="op" id="3969805">.</span><span class="ident" id="3969806">Value</span><span class="op" id="3969811">)</span>&nbsp;<span class="ident" id="3969813">encoderFunc</span>&nbsp;<span class="op" id="3969825">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969828">if</span>&nbsp;<span class="op" id="3969831">!</span><span class="ident" id="3969832">v</span><span class="op" id="3969833">.</span><span class="ident" id="3969834">IsValid</span><span class="op" id="3969841">(</span><span class="op" id="3969842">)</span>&nbsp;<span class="op" id="3969844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969848">return</span>&nbsp;<span class="ident" id="3969855">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3969876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3969879">return</span>&nbsp;<span class="ident" id="3969886">typeEncoder</span><span class="op" id="3969897">(</span><span class="ident" id="3969898">v</span><span class="op" id="3969899">.</span><span class="ident" id="3969900">Type</span><span class="op" id="3969904">(</span><span class="op" id="3969905">)</span><span class="op" id="3969906">)</span><br>
<span class="lineno"></span><span class="op" id="3969908">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="3969911">func</span>&nbsp;<span class="ident" id="3969916">typeEncoder</span><span class="op" id="3969927">(</span><span class="ident" id="3969928">t</span>&nbsp;<span class="ident" id="3969930">reflect</span><span class="op" id="3969937">.</span><span class="ident" id="3969938">Type</span><span class="op" id="3969942">)</span>&nbsp;<span class="ident" id="3969944">encoderFunc</span>&nbsp;<span class="op" id="3969956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969959">encoderCache</span><span class="op" id="3969971">.</span><span class="ident" id="3969972">RLock</span><span class="op" id="3969977">(</span><span class="op" id="3969978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969981">f</span>&nbsp;<span class="op" id="3969983">:=</span>&nbsp;<span class="ident" id="3969986">encoderCache</span><span class="op" id="3969998">.</span><span class="ident" id="3969999">m</span><span class="op" id="3970000">[</span><span class="ident" id="3970001">t</span><span class="op" id="3970002">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970005">encoderCache</span><span class="op" id="3970017">.</span><span class="ident" id="3970018">RUnlock</span><span class="op" id="3970025">(</span><span class="op" id="3970026">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970029">if</span>&nbsp;<span class="ident" id="3970032">f</span>&nbsp;<span class="op" id="3970034">!=</span>&nbsp;<span class="ident" id="3970037">nil</span>&nbsp;<span class="op" id="3970041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970045">return</span>&nbsp;<span class="ident" id="3970052">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970059">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970118">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970179">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970243">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970286">encoderCache</span><span class="op" id="3970298">.</span><span class="ident" id="3970299">Lock</span><span class="op" id="3970303">(</span><span class="op" id="3970304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970307">if</span>&nbsp;<span class="ident" id="3970310">encoderCache</span><span class="op" id="3970322">.</span><span class="ident" id="3970323">m</span>&nbsp;<span class="op" id="3970325">==</span>&nbsp;<span class="ident" id="3970328">nil</span>&nbsp;<span class="op" id="3970332">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970336">encoderCache</span><span class="op" id="3970348">.</span><span class="ident" id="3970349">m</span>&nbsp;<span class="op" id="3970351">=</span>&nbsp;<span class="builtinfunc" id="3970353">make</span><span class="op" id="3970357">(</span><span class="keyword" id="3970358">map</span><span class="op" id="3970361">[</span><span class="ident" id="3970362">reflect</span><span class="op" id="3970369">.</span><span class="ident" id="3970370">Type</span><span class="op" id="3970374">]</span><span class="ident" id="3970375">encoderFunc</span><span class="op" id="3970386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970392">var</span>&nbsp;<span class="ident" id="3970396">wg</span>&nbsp;<span class="ident" id="3970399">sync</span><span class="op" id="3970403">.</span><span class="ident" id="3970404">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970415">wg</span><span class="op" id="3970417">.</span><span class="ident" id="3970418">Add</span><span class="op" id="3970421">(</span><span class="num" id="3970422">1</span><span class="op" id="3970423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970426">encoderCache</span><span class="op" id="3970438">.</span><span class="ident" id="3970439">m</span><span class="op" id="3970440">[</span><span class="ident" id="3970441">t</span><span class="op" id="3970442">]</span>&nbsp;<span class="op" id="3970444">=</span>&nbsp;<span class="keyword" id="3970446">func</span><span class="op" id="3970450">(</span><span class="ident" id="3970451">e</span>&nbsp;<span class="op" id="3970453">*</span><span class="ident" id="3970454">encodeState</span><span class="op" id="3970465">,</span>&nbsp;<span class="ident" id="3970467">v</span>&nbsp;<span class="ident" id="3970469">reflect</span><span class="op" id="3970476">.</span><span class="ident" id="3970477">Value</span><span class="op" id="3970482">,</span>&nbsp;<span class="ident" id="3970484">quoted</span>&nbsp;<span class="builtintype" id="3970491">bool</span><span class="op" id="3970495">)</span>&nbsp;<span class="op" id="3970497">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970501">wg</span><span class="op" id="3970503">.</span><span class="ident" id="3970504">Wait</span><span class="op" id="3970508">(</span><span class="op" id="3970509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970513">f</span><span class="op" id="3970514">(</span><span class="ident" id="3970515">e</span><span class="op" id="3970516">,</span>&nbsp;<span class="ident" id="3970518">v</span><span class="op" id="3970519">,</span>&nbsp;<span class="ident" id="3970521">quoted</span><span class="op" id="3970527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3970530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970533">encoderCache</span><span class="op" id="3970545">.</span><span class="ident" id="3970546">Unlock</span><span class="op" id="3970552">(</span><span class="op" id="3970553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970557">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970590">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970657">f</span>&nbsp;<span class="op" id="3970659">=</span>&nbsp;<span class="ident" id="3970661">newTypeEncoder</span><span class="op" id="3970675">(</span><span class="ident" id="3970676">t</span><span class="op" id="3970677">,</span>&nbsp;<span class="builtintype" id="3970679">true</span><span class="op" id="3970683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970686">wg</span><span class="op" id="3970688">.</span><span class="ident" id="3970689">Done</span><span class="op" id="3970693">(</span><span class="op" id="3970694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970697">encoderCache</span><span class="op" id="3970709">.</span><span class="ident" id="3970710">Lock</span><span class="op" id="3970714">(</span><span class="op" id="3970715">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970718">encoderCache</span><span class="op" id="3970730">.</span><span class="ident" id="3970731">m</span><span class="op" id="3970732">[</span><span class="ident" id="3970733">t</span><span class="op" id="3970734">]</span>&nbsp;<span class="op" id="3970736">=</span>&nbsp;<span class="ident" id="3970738">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970741">encoderCache</span><span class="op" id="3970753">.</span><span class="ident" id="3970754">Unlock</span><span class="op" id="3970760">(</span><span class="op" id="3970761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3970764">return</span>&nbsp;<span class="ident" id="3970771">f</span><br>
<span class="lineno"></span><span class="op" id="3970773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="3970776">var</span>&nbsp;<span class="op" id="3970780">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970783">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3970801">=</span>&nbsp;<span class="ident" id="3970803">reflect</span><span class="op" id="3970810">.</span><span class="ident" id="3970811">TypeOf</span><span class="op" id="3970817">(</span><span class="builtinfunc" id="3970818">new</span><span class="op" id="3970821">(</span><span class="ident" id="3970822">Marshaler</span><span class="op" id="3970831">)</span><span class="op" id="3970832">)</span><span class="op" id="3970833">.</span><span class="ident" id="3970834">Elem</span><span class="op" id="3970838">(</span><span class="op" id="3970839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970842">textMarshalerType</span>&nbsp;<span class="op" id="3970860">=</span>&nbsp;<span class="ident" id="3970862">reflect</span><span class="op" id="3970869">.</span><span class="ident" id="3970870">TypeOf</span><span class="op" id="3970876">(</span><span class="builtinfunc" id="3970877">new</span><span class="op" id="3970880">(</span><span class="ident" id="3970881">encoding</span><span class="op" id="3970889">.</span><span class="ident" id="3970890">TextMarshaler</span><span class="op" id="3970903">)</span><span class="op" id="3970904">)</span><span class="op" id="3970905">.</span><span class="ident" id="3970906">Elem</span><span class="op" id="3970910">(</span><span class="op" id="3970911">)</span><br>
<span class="lineno"></span><span class="op" id="3970913">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="3970916">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3970972">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="3971040">func</span>&nbsp;<span class="ident" id="3971045">newTypeEncoder</span><span class="op" id="3971059">(</span><span class="ident" id="3971060">t</span>&nbsp;<span class="ident" id="3971062">reflect</span><span class="op" id="3971069">.</span><span class="ident" id="3971070">Type</span><span class="op" id="3971074">,</span>&nbsp;<span class="ident" id="3971076">allowAddr</span>&nbsp;<span class="builtintype" id="3971086">bool</span><span class="op" id="3971090">)</span>&nbsp;<span class="ident" id="3971092">encoderFunc</span>&nbsp;<span class="op" id="3971104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971107">if</span>&nbsp;<span class="ident" id="3971110">t</span><span class="op" id="3971111">.</span><span class="ident" id="3971112">Implements</span><span class="op" id="3971122">(</span><span class="ident" id="3971123">marshalerType</span><span class="op" id="3971136">)</span>&nbsp;<span class="op" id="3971138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971142">return</span>&nbsp;<span class="ident" id="3971149">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971170">if</span>&nbsp;<span class="ident" id="3971173">t</span><span class="op" id="3971174">.</span><span class="ident" id="3971175">Kind</span><span class="op" id="3971179">(</span><span class="op" id="3971180">)</span>&nbsp;<span class="op" id="3971182">!=</span>&nbsp;<span class="ident" id="3971185">reflect</span><span class="op" id="3971192">.</span><span class="ident" id="3971193">Ptr</span>&nbsp;<span class="op" id="3971197">&amp;&amp;</span>&nbsp;<span class="ident" id="3971200">allowAddr</span>&nbsp;<span class="op" id="3971210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971214">if</span>&nbsp;<span class="ident" id="3971217">reflect</span><span class="op" id="3971224">.</span><span class="ident" id="3971225">PtrTo</span><span class="op" id="3971230">(</span><span class="ident" id="3971231">t</span><span class="op" id="3971232">)</span><span class="op" id="3971233">.</span><span class="ident" id="3971234">Implements</span><span class="op" id="3971244">(</span><span class="ident" id="3971245">marshalerType</span><span class="op" id="3971258">)</span>&nbsp;<span class="op" id="3971260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971265">return</span>&nbsp;<span class="ident" id="3971272">newCondAddrEncoder</span><span class="op" id="3971290">(</span><span class="ident" id="3971291">addrMarshalerEncoder</span><span class="op" id="3971311">,</span>&nbsp;<span class="ident" id="3971313">newTypeEncoder</span><span class="op" id="3971327">(</span><span class="ident" id="3971328">t</span><span class="op" id="3971329">,</span>&nbsp;<span class="builtintype" id="3971331">false</span><span class="op" id="3971336">)</span><span class="op" id="3971337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971341">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971348">if</span>&nbsp;<span class="ident" id="3971351">t</span><span class="op" id="3971352">.</span><span class="ident" id="3971353">Implements</span><span class="op" id="3971363">(</span><span class="ident" id="3971364">textMarshalerType</span><span class="op" id="3971381">)</span>&nbsp;<span class="op" id="3971383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971387">return</span>&nbsp;<span class="ident" id="3971394">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971416">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971419">if</span>&nbsp;<span class="ident" id="3971422">t</span><span class="op" id="3971423">.</span><span class="ident" id="3971424">Kind</span><span class="op" id="3971428">(</span><span class="op" id="3971429">)</span>&nbsp;<span class="op" id="3971431">!=</span>&nbsp;<span class="ident" id="3971434">reflect</span><span class="op" id="3971441">.</span><span class="ident" id="3971442">Ptr</span>&nbsp;<span class="op" id="3971446">&amp;&amp;</span>&nbsp;<span class="ident" id="3971449">allowAddr</span>&nbsp;<span class="op" id="3971459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971463">if</span>&nbsp;<span class="ident" id="3971466">reflect</span><span class="op" id="3971473">.</span><span class="ident" id="3971474">PtrTo</span><span class="op" id="3971479">(</span><span class="ident" id="3971480">t</span><span class="op" id="3971481">)</span><span class="op" id="3971482">.</span><span class="ident" id="3971483">Implements</span><span class="op" id="3971493">(</span><span class="ident" id="3971494">textMarshalerType</span><span class="op" id="3971511">)</span>&nbsp;<span class="op" id="3971513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971518">return</span>&nbsp;<span class="ident" id="3971525">newCondAddrEncoder</span><span class="op" id="3971543">(</span><span class="ident" id="3971544">addrTextMarshalerEncoder</span><span class="op" id="3971568">,</span>&nbsp;<span class="ident" id="3971570">newTypeEncoder</span><span class="op" id="3971584">(</span><span class="ident" id="3971585">t</span><span class="op" id="3971586">,</span>&nbsp;<span class="builtintype" id="3971588">false</span><span class="op" id="3971593">)</span><span class="op" id="3971594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3971601">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971605">switch</span>&nbsp;<span class="ident" id="3971612">t</span><span class="op" id="3971613">.</span><span class="ident" id="3971614">Kind</span><span class="op" id="3971618">(</span><span class="op" id="3971619">)</span>&nbsp;<span class="op" id="3971621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971624">case</span>&nbsp;<span class="ident" id="3971629">reflect</span><span class="op" id="3971636">.</span><span class="ident" id="3971637">Bool</span><span class="op" id="3971641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971645">return</span>&nbsp;<span class="ident" id="3971652">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971665">case</span>&nbsp;<span class="ident" id="3971670">reflect</span><span class="op" id="3971677">.</span><span class="ident" id="3971678">Int</span><span class="op" id="3971681">,</span>&nbsp;<span class="ident" id="3971683">reflect</span><span class="op" id="3971690">.</span><span class="ident" id="3971691">Int8</span><span class="op" id="3971695">,</span>&nbsp;<span class="ident" id="3971697">reflect</span><span class="op" id="3971704">.</span><span class="ident" id="3971705">Int16</span><span class="op" id="3971710">,</span>&nbsp;<span class="ident" id="3971712">reflect</span><span class="op" id="3971719">.</span><span class="ident" id="3971720">Int32</span><span class="op" id="3971725">,</span>&nbsp;<span class="ident" id="3971727">reflect</span><span class="op" id="3971734">.</span><span class="ident" id="3971735">Int64</span><span class="op" id="3971740">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971744">return</span>&nbsp;<span class="ident" id="3971751">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971763">case</span>&nbsp;<span class="ident" id="3971768">reflect</span><span class="op" id="3971775">.</span><span class="ident" id="3971776">Uint</span><span class="op" id="3971780">,</span>&nbsp;<span class="ident" id="3971782">reflect</span><span class="op" id="3971789">.</span><span class="ident" id="3971790">Uint8</span><span class="op" id="3971795">,</span>&nbsp;<span class="ident" id="3971797">reflect</span><span class="op" id="3971804">.</span><span class="ident" id="3971805">Uint16</span><span class="op" id="3971811">,</span>&nbsp;<span class="ident" id="3971813">reflect</span><span class="op" id="3971820">.</span><span class="ident" id="3971821">Uint32</span><span class="op" id="3971827">,</span>&nbsp;<span class="ident" id="3971829">reflect</span><span class="op" id="3971836">.</span><span class="ident" id="3971837">Uint64</span><span class="op" id="3971843">,</span>&nbsp;<span class="ident" id="3971845">reflect</span><span class="op" id="3971852">.</span><span class="ident" id="3971853">Uintptr</span><span class="op" id="3971860">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971864">return</span>&nbsp;<span class="ident" id="3971871">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971884">case</span>&nbsp;<span class="ident" id="3971889">reflect</span><span class="op" id="3971896">.</span><span class="ident" id="3971897">Float32</span><span class="op" id="3971904">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971908">return</span>&nbsp;<span class="ident" id="3971915">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971931">case</span>&nbsp;<span class="ident" id="3971936">reflect</span><span class="op" id="3971943">.</span><span class="ident" id="3971944">Float64</span><span class="op" id="3971951">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971955">return</span>&nbsp;<span class="ident" id="3971962">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3971978">case</span>&nbsp;<span class="ident" id="3971983">reflect</span><span class="op" id="3971990">.</span><span class="ident" id="3971991">String</span><span class="op" id="3971997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972001">return</span>&nbsp;<span class="ident" id="3972008">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972023">case</span>&nbsp;<span class="ident" id="3972028">reflect</span><span class="op" id="3972035">.</span><span class="ident" id="3972036">Interface</span><span class="op" id="3972045">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972049">return</span>&nbsp;<span class="ident" id="3972056">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972074">case</span>&nbsp;<span class="ident" id="3972079">reflect</span><span class="op" id="3972086">.</span><span class="ident" id="3972087">Struct</span><span class="op" id="3972093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972097">return</span>&nbsp;<span class="ident" id="3972104">newStructEncoder</span><span class="op" id="3972120">(</span><span class="ident" id="3972121">t</span><span class="op" id="3972122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972125">case</span>&nbsp;<span class="ident" id="3972130">reflect</span><span class="op" id="3972137">.</span><span class="ident" id="3972138">Map</span><span class="op" id="3972141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972145">return</span>&nbsp;<span class="ident" id="3972152">newMapEncoder</span><span class="op" id="3972165">(</span><span class="ident" id="3972166">t</span><span class="op" id="3972167">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972170">case</span>&nbsp;<span class="ident" id="3972175">reflect</span><span class="op" id="3972182">.</span><span class="ident" id="3972183">Slice</span><span class="op" id="3972188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972192">return</span>&nbsp;<span class="ident" id="3972199">newSliceEncoder</span><span class="op" id="3972214">(</span><span class="ident" id="3972215">t</span><span class="op" id="3972216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972219">case</span>&nbsp;<span class="ident" id="3972224">reflect</span><span class="op" id="3972231">.</span><span class="ident" id="3972232">Array</span><span class="op" id="3972237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972241">return</span>&nbsp;<span class="ident" id="3972248">newArrayEncoder</span><span class="op" id="3972263">(</span><span class="ident" id="3972264">t</span><span class="op" id="3972265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972268">case</span>&nbsp;<span class="ident" id="3972273">reflect</span><span class="op" id="3972280">.</span><span class="ident" id="3972281">Ptr</span><span class="op" id="3972284">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972288">return</span>&nbsp;<span class="ident" id="3972295">newPtrEncoder</span><span class="op" id="3972308">(</span><span class="ident" id="3972309">t</span><span class="op" id="3972310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972313">default</span><span class="op" id="3972320">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972324">return</span>&nbsp;<span class="ident" id="3972331">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972355">}</span><br>
<span class="lineno"></span><span class="op" id="3972357">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="3972360">func</span>&nbsp;<span class="ident" id="3972365">invalidValueEncoder</span><span class="op" id="3972384">(</span><span class="ident" id="3972385">e</span>&nbsp;<span class="op" id="3972387">*</span><span class="ident" id="3972388">encodeState</span><span class="op" id="3972399">,</span>&nbsp;<span class="ident" id="3972401">v</span>&nbsp;<span class="ident" id="3972403">reflect</span><span class="op" id="3972410">.</span><span class="ident" id="3972411">Value</span><span class="op" id="3972416">,</span>&nbsp;<span class="ident" id="3972418">quoted</span>&nbsp;<span class="builtintype" id="3972425">bool</span><span class="op" id="3972429">)</span>&nbsp;<span class="op" id="3972431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972434">e</span><span class="op" id="3972435">.</span><span class="ident" id="3972436">WriteString</span><span class="op" id="3972447">(</span><span class="string" id="3972448">&#34;null&#34;</span><span class="op" id="3972454">)</span><br>
<span class="lineno"></span><span class="op" id="3972456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="3972459">func</span>&nbsp;<span class="ident" id="3972464">marshalerEncoder</span><span class="op" id="3972480">(</span><span class="ident" id="3972481">e</span>&nbsp;<span class="op" id="3972483">*</span><span class="ident" id="3972484">encodeState</span><span class="op" id="3972495">,</span>&nbsp;<span class="ident" id="3972497">v</span>&nbsp;<span class="ident" id="3972499">reflect</span><span class="op" id="3972506">.</span><span class="ident" id="3972507">Value</span><span class="op" id="3972512">,</span>&nbsp;<span class="ident" id="3972514">quoted</span>&nbsp;<span class="builtintype" id="3972521">bool</span><span class="op" id="3972525">)</span>&nbsp;<span class="op" id="3972527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972530">if</span>&nbsp;<span class="ident" id="3972533">v</span><span class="op" id="3972534">.</span><span class="ident" id="3972535">Kind</span><span class="op" id="3972539">(</span><span class="op" id="3972540">)</span>&nbsp;<span class="op" id="3972542">==</span>&nbsp;<span class="ident" id="3972545">reflect</span><span class="op" id="3972552">.</span><span class="ident" id="3972553">Ptr</span>&nbsp;<span class="op" id="3972557">&amp;&amp;</span>&nbsp;<span class="ident" id="3972560">v</span><span class="op" id="3972561">.</span><span class="ident" id="3972562">IsNil</span><span class="op" id="3972567">(</span><span class="op" id="3972568">)</span>&nbsp;<span class="op" id="3972570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972574">e</span><span class="op" id="3972575">.</span><span class="ident" id="3972576">WriteString</span><span class="op" id="3972587">(</span><span class="string" id="3972588">&#34;null&#34;</span><span class="op" id="3972594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972598">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972606">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972609">m</span>&nbsp;<span class="op" id="3972611">:=</span>&nbsp;<span class="ident" id="3972614">v</span><span class="op" id="3972615">.</span><span class="ident" id="3972616">Interface</span><span class="op" id="3972625">(</span><span class="op" id="3972626">)</span><span class="op" id="3972627">.</span><span class="op" id="3972628">(</span><span class="ident" id="3972629">Marshaler</span><span class="op" id="3972638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972641">b</span><span class="op" id="3972642">,</span>&nbsp;<span class="ident" id="3972644">err</span>&nbsp;<span class="op" id="3972648">:=</span>&nbsp;<span class="ident" id="3972651">m</span><span class="op" id="3972652">.</span><span class="ident" id="3972653">MarshalJSON</span><span class="op" id="3972664">(</span><span class="op" id="3972665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972668">if</span>&nbsp;<span class="ident" id="3972671">err</span>&nbsp;<span class="op" id="3972675">==</span>&nbsp;<span class="ident" id="3972678">nil</span>&nbsp;<span class="op" id="3972682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3972686">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972733">err</span>&nbsp;<span class="op" id="3972737">=</span>&nbsp;<span class="ident" id="3972739">compact</span><span class="op" id="3972746">(</span><span class="op" id="3972747">&amp;</span><span class="ident" id="3972748">e</span><span class="op" id="3972749">.</span><span class="ident" id="3972750">Buffer</span><span class="op" id="3972756">,</span>&nbsp;<span class="ident" id="3972758">b</span><span class="op" id="3972759">,</span>&nbsp;<span class="builtintype" id="3972761">true</span><span class="op" id="3972765">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972771">if</span>&nbsp;<span class="ident" id="3972774">err</span>&nbsp;<span class="op" id="3972778">!=</span>&nbsp;<span class="ident" id="3972781">nil</span>&nbsp;<span class="op" id="3972785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972789">e</span><span class="op" id="3972790">.</span><span class="builtintype" id="3972791">error</span><span class="op" id="3972796">(</span><span class="op" id="3972797">&amp;</span><span class="ident" id="3972798">MarshalerError</span><span class="op" id="3972812">{</span><span class="ident" id="3972813">v</span><span class="op" id="3972814">.</span><span class="ident" id="3972815">Type</span><span class="op" id="3972819">(</span><span class="op" id="3972820">)</span><span class="op" id="3972821">,</span>&nbsp;<span class="ident" id="3972823">err</span><span class="op" id="3972826">}</span><span class="op" id="3972827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972830">}</span><br>
<span class="lineno"></span><span class="op" id="3972832">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="3972835">func</span>&nbsp;<span class="ident" id="3972840">addrMarshalerEncoder</span><span class="op" id="3972860">(</span><span class="ident" id="3972861">e</span>&nbsp;<span class="op" id="3972863">*</span><span class="ident" id="3972864">encodeState</span><span class="op" id="3972875">,</span>&nbsp;<span class="ident" id="3972877">v</span>&nbsp;<span class="ident" id="3972879">reflect</span><span class="op" id="3972886">.</span><span class="ident" id="3972887">Value</span><span class="op" id="3972892">,</span>&nbsp;<span class="ident" id="3972894">quoted</span>&nbsp;<span class="builtintype" id="3972901">bool</span><span class="op" id="3972905">)</span>&nbsp;<span class="op" id="3972907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972910">va</span>&nbsp;<span class="op" id="3972913">:=</span>&nbsp;<span class="ident" id="3972916">v</span><span class="op" id="3972917">.</span><span class="ident" id="3972918">Addr</span><span class="op" id="3972922">(</span><span class="op" id="3972923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972926">if</span>&nbsp;<span class="ident" id="3972929">va</span><span class="op" id="3972931">.</span><span class="ident" id="3972932">IsNil</span><span class="op" id="3972937">(</span><span class="op" id="3972938">)</span>&nbsp;<span class="op" id="3972940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972944">e</span><span class="op" id="3972945">.</span><span class="ident" id="3972946">WriteString</span><span class="op" id="3972957">(</span><span class="string" id="3972958">&#34;null&#34;</span><span class="op" id="3972964">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972968">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972979">m</span>&nbsp;<span class="op" id="3972981">:=</span>&nbsp;<span class="ident" id="3972984">va</span><span class="op" id="3972986">.</span><span class="ident" id="3972987">Interface</span><span class="op" id="3972996">(</span><span class="op" id="3972997">)</span><span class="op" id="3972998">.</span><span class="op" id="3972999">(</span><span class="ident" id="3973000">Marshaler</span><span class="op" id="3973009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973012">b</span><span class="op" id="3973013">,</span>&nbsp;<span class="ident" id="3973015">err</span>&nbsp;<span class="op" id="3973019">:=</span>&nbsp;<span class="ident" id="3973022">m</span><span class="op" id="3973023">.</span><span class="ident" id="3973024">MarshalJSON</span><span class="op" id="3973035">(</span><span class="op" id="3973036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973039">if</span>&nbsp;<span class="ident" id="3973042">err</span>&nbsp;<span class="op" id="3973046">==</span>&nbsp;<span class="ident" id="3973049">nil</span>&nbsp;<span class="op" id="3973053">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3973057">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973104">err</span>&nbsp;<span class="op" id="3973108">=</span>&nbsp;<span class="ident" id="3973110">compact</span><span class="op" id="3973117">(</span><span class="op" id="3973118">&amp;</span><span class="ident" id="3973119">e</span><span class="op" id="3973120">.</span><span class="ident" id="3973121">Buffer</span><span class="op" id="3973127">,</span>&nbsp;<span class="ident" id="3973129">b</span><span class="op" id="3973130">,</span>&nbsp;<span class="builtintype" id="3973132">true</span><span class="op" id="3973136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973142">if</span>&nbsp;<span class="ident" id="3973145">err</span>&nbsp;<span class="op" id="3973149">!=</span>&nbsp;<span class="ident" id="3973152">nil</span>&nbsp;<span class="op" id="3973156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973160">e</span><span class="op" id="3973161">.</span><span class="builtintype" id="3973162">error</span><span class="op" id="3973167">(</span><span class="op" id="3973168">&amp;</span><span class="ident" id="3973169">MarshalerError</span><span class="op" id="3973183">{</span><span class="ident" id="3973184">v</span><span class="op" id="3973185">.</span><span class="ident" id="3973186">Type</span><span class="op" id="3973190">(</span><span class="op" id="3973191">)</span><span class="op" id="3973192">,</span>&nbsp;<span class="ident" id="3973194">err</span><span class="op" id="3973197">}</span><span class="op" id="3973198">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973201">}</span><br>
<span class="lineno"></span><span class="op" id="3973203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3973206">func</span>&nbsp;<span class="ident" id="3973211">textMarshalerEncoder</span><span class="op" id="3973231">(</span><span class="ident" id="3973232">e</span>&nbsp;<span class="op" id="3973234">*</span><span class="ident" id="3973235">encodeState</span><span class="op" id="3973246">,</span>&nbsp;<span class="ident" id="3973248">v</span>&nbsp;<span class="ident" id="3973250">reflect</span><span class="op" id="3973257">.</span><span class="ident" id="3973258">Value</span><span class="op" id="3973263">,</span>&nbsp;<span class="ident" id="3973265">quoted</span>&nbsp;<span class="builtintype" id="3973272">bool</span><span class="op" id="3973276">)</span>&nbsp;<span class="op" id="3973278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973281">if</span>&nbsp;<span class="ident" id="3973284">v</span><span class="op" id="3973285">.</span><span class="ident" id="3973286">Kind</span><span class="op" id="3973290">(</span><span class="op" id="3973291">)</span>&nbsp;<span class="op" id="3973293">==</span>&nbsp;<span class="ident" id="3973296">reflect</span><span class="op" id="3973303">.</span><span class="ident" id="3973304">Ptr</span>&nbsp;<span class="op" id="3973308">&amp;&amp;</span>&nbsp;<span class="ident" id="3973311">v</span><span class="op" id="3973312">.</span><span class="ident" id="3973313">IsNil</span><span class="op" id="3973318">(</span><span class="op" id="3973319">)</span>&nbsp;<span class="op" id="3973321">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973325">e</span><span class="op" id="3973326">.</span><span class="ident" id="3973327">WriteString</span><span class="op" id="3973338">(</span><span class="string" id="3973339">&#34;null&#34;</span><span class="op" id="3973345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973349">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973360">m</span>&nbsp;<span class="op" id="3973362">:=</span>&nbsp;<span class="ident" id="3973365">v</span><span class="op" id="3973366">.</span><span class="ident" id="3973367">Interface</span><span class="op" id="3973376">(</span><span class="op" id="3973377">)</span><span class="op" id="3973378">.</span><span class="op" id="3973379">(</span><span class="ident" id="3973380">encoding</span><span class="op" id="3973388">.</span><span class="ident" id="3973389">TextMarshaler</span><span class="op" id="3973402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973405">b</span><span class="op" id="3973406">,</span>&nbsp;<span class="ident" id="3973408">err</span>&nbsp;<span class="op" id="3973412">:=</span>&nbsp;<span class="ident" id="3973415">m</span><span class="op" id="3973416">.</span><span class="ident" id="3973417">MarshalText</span><span class="op" id="3973428">(</span><span class="op" id="3973429">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973432">if</span>&nbsp;<span class="ident" id="3973435">err</span>&nbsp;<span class="op" id="3973439">==</span>&nbsp;<span class="ident" id="3973442">nil</span>&nbsp;<span class="op" id="3973446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973450">_</span><span class="op" id="3973451">,</span>&nbsp;<span class="ident" id="3973453">err</span>&nbsp;<span class="op" id="3973457">=</span>&nbsp;<span class="ident" id="3973459">e</span><span class="op" id="3973460">.</span><span class="ident" id="3973461">stringBytes</span><span class="op" id="3973472">(</span><span class="ident" id="3973473">b</span><span class="op" id="3973474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973480">if</span>&nbsp;<span class="ident" id="3973483">err</span>&nbsp;<span class="op" id="3973487">!=</span>&nbsp;<span class="ident" id="3973490">nil</span>&nbsp;<span class="op" id="3973494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973498">e</span><span class="op" id="3973499">.</span><span class="builtintype" id="3973500">error</span><span class="op" id="3973505">(</span><span class="op" id="3973506">&amp;</span><span class="ident" id="3973507">MarshalerError</span><span class="op" id="3973521">{</span><span class="ident" id="3973522">v</span><span class="op" id="3973523">.</span><span class="ident" id="3973524">Type</span><span class="op" id="3973528">(</span><span class="op" id="3973529">)</span><span class="op" id="3973530">,</span>&nbsp;<span class="ident" id="3973532">err</span><span class="op" id="3973535">}</span><span class="op" id="3973536">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973539">}</span><br>
<span class="lineno"></span><span class="op" id="3973541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3973544">func</span>&nbsp;<span class="ident" id="3973549">addrTextMarshalerEncoder</span><span class="op" id="3973573">(</span><span class="ident" id="3973574">e</span>&nbsp;<span class="op" id="3973576">*</span><span class="ident" id="3973577">encodeState</span><span class="op" id="3973588">,</span>&nbsp;<span class="ident" id="3973590">v</span>&nbsp;<span class="ident" id="3973592">reflect</span><span class="op" id="3973599">.</span><span class="ident" id="3973600">Value</span><span class="op" id="3973605">,</span>&nbsp;<span class="ident" id="3973607">quoted</span>&nbsp;<span class="builtintype" id="3973614">bool</span><span class="op" id="3973618">)</span>&nbsp;<span class="op" id="3973620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973623">va</span>&nbsp;<span class="op" id="3973626">:=</span>&nbsp;<span class="ident" id="3973629">v</span><span class="op" id="3973630">.</span><span class="ident" id="3973631">Addr</span><span class="op" id="3973635">(</span><span class="op" id="3973636">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973639">if</span>&nbsp;<span class="ident" id="3973642">va</span><span class="op" id="3973644">.</span><span class="ident" id="3973645">IsNil</span><span class="op" id="3973650">(</span><span class="op" id="3973651">)</span>&nbsp;<span class="op" id="3973653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973657">e</span><span class="op" id="3973658">.</span><span class="ident" id="3973659">WriteString</span><span class="op" id="3973670">(</span><span class="string" id="3973671">&#34;null&#34;</span><span class="op" id="3973677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973681">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973692">m</span>&nbsp;<span class="op" id="3973694">:=</span>&nbsp;<span class="ident" id="3973697">va</span><span class="op" id="3973699">.</span><span class="ident" id="3973700">Interface</span><span class="op" id="3973709">(</span><span class="op" id="3973710">)</span><span class="op" id="3973711">.</span><span class="op" id="3973712">(</span><span class="ident" id="3973713">encoding</span><span class="op" id="3973721">.</span><span class="ident" id="3973722">TextMarshaler</span><span class="op" id="3973735">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973738">b</span><span class="op" id="3973739">,</span>&nbsp;<span class="ident" id="3973741">err</span>&nbsp;<span class="op" id="3973745">:=</span>&nbsp;<span class="ident" id="3973748">m</span><span class="op" id="3973749">.</span><span class="ident" id="3973750">MarshalText</span><span class="op" id="3973761">(</span><span class="op" id="3973762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973765">if</span>&nbsp;<span class="ident" id="3973768">err</span>&nbsp;<span class="op" id="3973772">==</span>&nbsp;<span class="ident" id="3973775">nil</span>&nbsp;<span class="op" id="3973779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973783">_</span><span class="op" id="3973784">,</span>&nbsp;<span class="ident" id="3973786">err</span>&nbsp;<span class="op" id="3973790">=</span>&nbsp;<span class="ident" id="3973792">e</span><span class="op" id="3973793">.</span><span class="ident" id="3973794">stringBytes</span><span class="op" id="3973805">(</span><span class="ident" id="3973806">b</span><span class="op" id="3973807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973813">if</span>&nbsp;<span class="ident" id="3973816">err</span>&nbsp;<span class="op" id="3973820">!=</span>&nbsp;<span class="ident" id="3973823">nil</span>&nbsp;<span class="op" id="3973827">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973831">e</span><span class="op" id="3973832">.</span><span class="builtintype" id="3973833">error</span><span class="op" id="3973838">(</span><span class="op" id="3973839">&amp;</span><span class="ident" id="3973840">MarshalerError</span><span class="op" id="3973854">{</span><span class="ident" id="3973855">v</span><span class="op" id="3973856">.</span><span class="ident" id="3973857">Type</span><span class="op" id="3973861">(</span><span class="op" id="3973862">)</span><span class="op" id="3973863">,</span>&nbsp;<span class="ident" id="3973865">err</span><span class="op" id="3973868">}</span><span class="op" id="3973869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973872">}</span><br>
<span class="lineno"></span><span class="op" id="3973874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3973877">func</span>&nbsp;<span class="ident" id="3973882">boolEncoder</span><span class="op" id="3973893">(</span><span class="ident" id="3973894">e</span>&nbsp;<span class="op" id="3973896">*</span><span class="ident" id="3973897">encodeState</span><span class="op" id="3973908">,</span>&nbsp;<span class="ident" id="3973910">v</span>&nbsp;<span class="ident" id="3973912">reflect</span><span class="op" id="3973919">.</span><span class="ident" id="3973920">Value</span><span class="op" id="3973925">,</span>&nbsp;<span class="ident" id="3973927">quoted</span>&nbsp;<span class="builtintype" id="3973934">bool</span><span class="op" id="3973938">)</span>&nbsp;<span class="op" id="3973940">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973943">if</span>&nbsp;<span class="ident" id="3973946">quoted</span>&nbsp;<span class="op" id="3973953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973957">e</span><span class="op" id="3973958">.</span><span class="ident" id="3973959">WriteByte</span><span class="op" id="3973968">(</span><span class="string" id="3973969">&#39;&#34;&#39;</span><span class="op" id="3973972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973978">if</span>&nbsp;<span class="ident" id="3973981">v</span><span class="op" id="3973982">.</span><span class="ident" id="3973983">Bool</span><span class="op" id="3973987">(</span><span class="op" id="3973988">)</span>&nbsp;<span class="op" id="3973990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973994">e</span><span class="op" id="3973995">.</span><span class="ident" id="3973996">WriteString</span><span class="op" id="3974007">(</span><span class="string" id="3974008">&#34;true&#34;</span><span class="op" id="3974014">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974017">}</span>&nbsp;<span class="keyword" id="3974019">else</span>&nbsp;<span class="op" id="3974024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974028">e</span><span class="op" id="3974029">.</span><span class="ident" id="3974030">WriteString</span><span class="op" id="3974041">(</span><span class="string" id="3974042">&#34;false&#34;</span><span class="op" id="3974049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974055">if</span>&nbsp;<span class="ident" id="3974058">quoted</span>&nbsp;<span class="op" id="3974065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974069">e</span><span class="op" id="3974070">.</span><span class="ident" id="3974071">WriteByte</span><span class="op" id="3974080">(</span><span class="string" id="3974081">&#39;&#34;&#39;</span><span class="op" id="3974084">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974087">}</span><br>
<span class="lineno"></span><span class="op" id="3974089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3974092">func</span>&nbsp;<span class="ident" id="3974097">intEncoder</span><span class="op" id="3974107">(</span><span class="ident" id="3974108">e</span>&nbsp;<span class="op" id="3974110">*</span><span class="ident" id="3974111">encodeState</span><span class="op" id="3974122">,</span>&nbsp;<span class="ident" id="3974124">v</span>&nbsp;<span class="ident" id="3974126">reflect</span><span class="op" id="3974133">.</span><span class="ident" id="3974134">Value</span><span class="op" id="3974139">,</span>&nbsp;<span class="ident" id="3974141">quoted</span>&nbsp;<span class="builtintype" id="3974148">bool</span><span class="op" id="3974152">)</span>&nbsp;<span class="op" id="3974154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974157">b</span>&nbsp;<span class="op" id="3974159">:=</span>&nbsp;<span class="ident" id="3974162">strconv</span><span class="op" id="3974169">.</span><span class="ident" id="3974170">AppendInt</span><span class="op" id="3974179">(</span><span class="ident" id="3974180">e</span><span class="op" id="3974181">.</span><span class="ident" id="3974182">scratch</span><span class="op" id="3974189">[</span><span class="op" id="3974190">:</span><span class="num" id="3974191">0</span><span class="op" id="3974192">]</span><span class="op" id="3974193">,</span>&nbsp;<span class="ident" id="3974195">v</span><span class="op" id="3974196">.</span><span class="ident" id="3974197">Int</span><span class="op" id="3974200">(</span><span class="op" id="3974201">)</span><span class="op" id="3974202">,</span>&nbsp;<span class="num" id="3974204">10</span><span class="op" id="3974206">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974209">if</span>&nbsp;<span class="ident" id="3974212">quoted</span>&nbsp;<span class="op" id="3974219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974223">e</span><span class="op" id="3974224">.</span><span class="ident" id="3974225">WriteByte</span><span class="op" id="3974234">(</span><span class="string" id="3974235">&#39;&#34;&#39;</span><span class="op" id="3974238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974244">e</span><span class="op" id="3974245">.</span><span class="ident" id="3974246">Write</span><span class="op" id="3974251">(</span><span class="ident" id="3974252">b</span><span class="op" id="3974253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974256">if</span>&nbsp;<span class="ident" id="3974259">quoted</span>&nbsp;<span class="op" id="3974266">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974270">e</span><span class="op" id="3974271">.</span><span class="ident" id="3974272">WriteByte</span><span class="op" id="3974281">(</span><span class="string" id="3974282">&#39;&#34;&#39;</span><span class="op" id="3974285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974288">}</span><br>
<span class="lineno"></span><span class="op" id="3974290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3974293">func</span>&nbsp;<span class="ident" id="3974298">uintEncoder</span><span class="op" id="3974309">(</span><span class="ident" id="3974310">e</span>&nbsp;<span class="op" id="3974312">*</span><span class="ident" id="3974313">encodeState</span><span class="op" id="3974324">,</span>&nbsp;<span class="ident" id="3974326">v</span>&nbsp;<span class="ident" id="3974328">reflect</span><span class="op" id="3974335">.</span><span class="ident" id="3974336">Value</span><span class="op" id="3974341">,</span>&nbsp;<span class="ident" id="3974343">quoted</span>&nbsp;<span class="builtintype" id="3974350">bool</span><span class="op" id="3974354">)</span>&nbsp;<span class="op" id="3974356">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974359">b</span>&nbsp;<span class="op" id="3974361">:=</span>&nbsp;<span class="ident" id="3974364">strconv</span><span class="op" id="3974371">.</span><span class="ident" id="3974372">AppendUint</span><span class="op" id="3974382">(</span><span class="ident" id="3974383">e</span><span class="op" id="3974384">.</span><span class="ident" id="3974385">scratch</span><span class="op" id="3974392">[</span><span class="op" id="3974393">:</span><span class="num" id="3974394">0</span><span class="op" id="3974395">]</span><span class="op" id="3974396">,</span>&nbsp;<span class="ident" id="3974398">v</span><span class="op" id="3974399">.</span><span class="ident" id="3974400">Uint</span><span class="op" id="3974404">(</span><span class="op" id="3974405">)</span><span class="op" id="3974406">,</span>&nbsp;<span class="num" id="3974408">10</span><span class="op" id="3974410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974413">if</span>&nbsp;<span class="ident" id="3974416">quoted</span>&nbsp;<span class="op" id="3974423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974427">e</span><span class="op" id="3974428">.</span><span class="ident" id="3974429">WriteByte</span><span class="op" id="3974438">(</span><span class="string" id="3974439">&#39;&#34;&#39;</span><span class="op" id="3974442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974448">e</span><span class="op" id="3974449">.</span><span class="ident" id="3974450">Write</span><span class="op" id="3974455">(</span><span class="ident" id="3974456">b</span><span class="op" id="3974457">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974460">if</span>&nbsp;<span class="ident" id="3974463">quoted</span>&nbsp;<span class="op" id="3974470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974474">e</span><span class="op" id="3974475">.</span><span class="ident" id="3974476">WriteByte</span><span class="op" id="3974485">(</span><span class="string" id="3974486">&#39;&#34;&#39;</span><span class="op" id="3974489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974492">}</span><br>
<span class="lineno"></span><span class="op" id="3974494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3974497">type</span>&nbsp;<span class="ident" id="3974502">floatEncoder</span>&nbsp;<span class="builtintype" id="3974515">int</span>&nbsp;<span class="comment" id="3974519">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3974538">func</span>&nbsp;<span class="op" id="3974543">(</span><span class="ident" id="3974544">bits</span>&nbsp;<span class="ident" id="3974549">floatEncoder</span><span class="op" id="3974561">)</span>&nbsp;<span class="ident" id="3974563">encode</span><span class="op" id="3974569">(</span><span class="ident" id="3974570">e</span>&nbsp;<span class="op" id="3974572">*</span><span class="ident" id="3974573">encodeState</span><span class="op" id="3974584">,</span>&nbsp;<span class="ident" id="3974586">v</span>&nbsp;<span class="ident" id="3974588">reflect</span><span class="op" id="3974595">.</span><span class="ident" id="3974596">Value</span><span class="op" id="3974601">,</span>&nbsp;<span class="ident" id="3974603">quoted</span>&nbsp;<span class="builtintype" id="3974610">bool</span><span class="op" id="3974614">)</span>&nbsp;<span class="op" id="3974616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974619">f</span>&nbsp;<span class="op" id="3974621">:=</span>&nbsp;<span class="ident" id="3974624">v</span><span class="op" id="3974625">.</span><span class="ident" id="3974626">Float</span><span class="op" id="3974631">(</span><span class="op" id="3974632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974635">if</span>&nbsp;<span class="ident" id="3974638">math</span><span class="op" id="3974642">.</span><span class="ident" id="3974643">IsInf</span><span class="op" id="3974648">(</span><span class="ident" id="3974649">f</span><span class="op" id="3974650">,</span>&nbsp;<span class="num" id="3974652">0</span><span class="op" id="3974653">)</span>&nbsp;<span class="op" id="3974655">||</span>&nbsp;<span class="ident" id="3974658">math</span><span class="op" id="3974662">.</span><span class="ident" id="3974663">IsNaN</span><span class="op" id="3974668">(</span><span class="ident" id="3974669">f</span><span class="op" id="3974670">)</span>&nbsp;<span class="op" id="3974672">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974676">e</span><span class="op" id="3974677">.</span><span class="builtintype" id="3974678">error</span><span class="op" id="3974683">(</span><span class="op" id="3974684">&amp;</span><span class="ident" id="3974685">UnsupportedValueError</span><span class="op" id="3974706">{</span><span class="ident" id="3974707">v</span><span class="op" id="3974708">,</span>&nbsp;<span class="ident" id="3974710">strconv</span><span class="op" id="3974717">.</span><span class="ident" id="3974718">FormatFloat</span><span class="op" id="3974729">(</span><span class="ident" id="3974730">f</span><span class="op" id="3974731">,</span>&nbsp;<span class="string" id="3974733">&#39;g&#39;</span><span class="op" id="3974736">,</span>&nbsp;<span class="op" id="3974738">-</span><span class="num" id="3974739">1</span><span class="op" id="3974740">,</span>&nbsp;<span class="builtintype" id="3974742">int</span><span class="op" id="3974745">(</span><span class="ident" id="3974746">bits</span><span class="op" id="3974750">)</span><span class="op" id="3974751">)</span><span class="op" id="3974752">}</span><span class="op" id="3974753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974759">b</span>&nbsp;<span class="op" id="3974761">:=</span>&nbsp;<span class="ident" id="3974764">strconv</span><span class="op" id="3974771">.</span><span class="ident" id="3974772">AppendFloat</span><span class="op" id="3974783">(</span><span class="ident" id="3974784">e</span><span class="op" id="3974785">.</span><span class="ident" id="3974786">scratch</span><span class="op" id="3974793">[</span><span class="op" id="3974794">:</span><span class="num" id="3974795">0</span><span class="op" id="3974796">]</span><span class="op" id="3974797">,</span>&nbsp;<span class="ident" id="3974799">f</span><span class="op" id="3974800">,</span>&nbsp;<span class="string" id="3974802">&#39;g&#39;</span><span class="op" id="3974805">,</span>&nbsp;<span class="op" id="3974807">-</span><span class="num" id="3974808">1</span><span class="op" id="3974809">,</span>&nbsp;<span class="builtintype" id="3974811">int</span><span class="op" id="3974814">(</span><span class="ident" id="3974815">bits</span><span class="op" id="3974819">)</span><span class="op" id="3974820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974823">if</span>&nbsp;<span class="ident" id="3974826">quoted</span>&nbsp;<span class="op" id="3974833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974837">e</span><span class="op" id="3974838">.</span><span class="ident" id="3974839">WriteByte</span><span class="op" id="3974848">(</span><span class="string" id="3974849">&#39;&#34;&#39;</span><span class="op" id="3974852">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974858">e</span><span class="op" id="3974859">.</span><span class="ident" id="3974860">Write</span><span class="op" id="3974865">(</span><span class="ident" id="3974866">b</span><span class="op" id="3974867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974870">if</span>&nbsp;<span class="ident" id="3974873">quoted</span>&nbsp;<span class="op" id="3974880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974884">e</span><span class="op" id="3974885">.</span><span class="ident" id="3974886">WriteByte</span><span class="op" id="3974895">(</span><span class="string" id="3974896">&#39;&#34;&#39;</span><span class="op" id="3974899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974902">}</span><br>
<span class="lineno">525</span><span class="op" id="3974904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3974907">var</span>&nbsp;<span class="op" id="3974911">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974914">float32Encoder</span>&nbsp;<span class="op" id="3974929">=</span>&nbsp;<span class="op" id="3974931">(</span><span class="ident" id="3974932">floatEncoder</span><span class="op" id="3974944">(</span><span class="num" id="3974945">32</span><span class="op" id="3974947">)</span><span class="op" id="3974948">)</span><span class="op" id="3974949">.</span><span class="ident" id="3974950">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974958">float64Encoder</span>&nbsp;<span class="op" id="3974973">=</span>&nbsp;<span class="op" id="3974975">(</span><span class="ident" id="3974976">floatEncoder</span><span class="op" id="3974988">(</span><span class="num" id="3974989">64</span><span class="op" id="3974991">)</span><span class="op" id="3974992">)</span><span class="op" id="3974993">.</span><span class="ident" id="3974994">encode</span><br>
<span class="lineno">530</span><span class="op" id="3975001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3975004">func</span>&nbsp;<span class="ident" id="3975009">stringEncoder</span><span class="op" id="3975022">(</span><span class="ident" id="3975023">e</span>&nbsp;<span class="op" id="3975025">*</span><span class="ident" id="3975026">encodeState</span><span class="op" id="3975037">,</span>&nbsp;<span class="ident" id="3975039">v</span>&nbsp;<span class="ident" id="3975041">reflect</span><span class="op" id="3975048">.</span><span class="ident" id="3975049">Value</span><span class="op" id="3975054">,</span>&nbsp;<span class="ident" id="3975056">quoted</span>&nbsp;<span class="builtintype" id="3975063">bool</span><span class="op" id="3975067">)</span>&nbsp;<span class="op" id="3975069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975072">if</span>&nbsp;<span class="ident" id="3975075">v</span><span class="op" id="3975076">.</span><span class="ident" id="3975077">Type</span><span class="op" id="3975081">(</span><span class="op" id="3975082">)</span>&nbsp;<span class="op" id="3975084">==</span>&nbsp;<span class="ident" id="3975087">numberType</span>&nbsp;<span class="op" id="3975098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975102">numStr</span>&nbsp;<span class="op" id="3975109">:=</span>&nbsp;<span class="ident" id="3975112">v</span><span class="op" id="3975113">.</span><span class="ident" id="3975114">String</span><span class="op" id="3975120">(</span><span class="op" id="3975121">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975125">if</span>&nbsp;<span class="ident" id="3975128">numStr</span>&nbsp;<span class="op" id="3975135">==</span>&nbsp;<span class="string" id="3975138">&#34;&#34;</span>&nbsp;<span class="op" id="3975141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975146">numStr</span>&nbsp;<span class="op" id="3975153">=</span>&nbsp;<span class="string" id="3975155">&#34;0&#34;</span>&nbsp;<span class="comment" id="3975159">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975186">e</span><span class="op" id="3975187">.</span><span class="ident" id="3975188">WriteString</span><span class="op" id="3975199">(</span><span class="ident" id="3975200">numStr</span><span class="op" id="3975206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975210">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975221">if</span>&nbsp;<span class="ident" id="3975224">quoted</span>&nbsp;<span class="op" id="3975231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975235">sb</span><span class="op" id="3975237">,</span>&nbsp;<span class="ident" id="3975239">err</span>&nbsp;<span class="op" id="3975243">:=</span>&nbsp;<span class="ident" id="3975246">Marshal</span><span class="op" id="3975253">(</span><span class="ident" id="3975254">v</span><span class="op" id="3975255">.</span><span class="ident" id="3975256">String</span><span class="op" id="3975262">(</span><span class="op" id="3975263">)</span><span class="op" id="3975264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975268">if</span>&nbsp;<span class="ident" id="3975271">err</span>&nbsp;<span class="op" id="3975275">!=</span>&nbsp;<span class="ident" id="3975278">nil</span>&nbsp;<span class="op" id="3975282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975287">e</span><span class="op" id="3975288">.</span><span class="builtintype" id="3975289">error</span><span class="op" id="3975294">(</span><span class="ident" id="3975295">err</span><span class="op" id="3975298">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975306">e</span><span class="op" id="3975307">.</span><span class="builtintype" id="3975308">string</span><span class="op" id="3975314">(</span><span class="builtintype" id="3975315">string</span><span class="op" id="3975321">(</span><span class="ident" id="3975322">sb</span><span class="op" id="3975324">)</span><span class="op" id="3975325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975328">}</span>&nbsp;<span class="keyword" id="3975330">else</span>&nbsp;<span class="op" id="3975335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975339">e</span><span class="op" id="3975340">.</span><span class="builtintype" id="3975341">string</span><span class="op" id="3975347">(</span><span class="ident" id="3975348">v</span><span class="op" id="3975349">.</span><span class="ident" id="3975350">String</span><span class="op" id="3975356">(</span><span class="op" id="3975357">)</span><span class="op" id="3975358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975361">}</span><br>
<span class="lineno">550</span><span class="op" id="3975363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3975366">func</span>&nbsp;<span class="ident" id="3975371">interfaceEncoder</span><span class="op" id="3975387">(</span><span class="ident" id="3975388">e</span>&nbsp;<span class="op" id="3975390">*</span><span class="ident" id="3975391">encodeState</span><span class="op" id="3975402">,</span>&nbsp;<span class="ident" id="3975404">v</span>&nbsp;<span class="ident" id="3975406">reflect</span><span class="op" id="3975413">.</span><span class="ident" id="3975414">Value</span><span class="op" id="3975419">,</span>&nbsp;<span class="ident" id="3975421">quoted</span>&nbsp;<span class="builtintype" id="3975428">bool</span><span class="op" id="3975432">)</span>&nbsp;<span class="op" id="3975434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975437">if</span>&nbsp;<span class="ident" id="3975440">v</span><span class="op" id="3975441">.</span><span class="ident" id="3975442">IsNil</span><span class="op" id="3975447">(</span><span class="op" id="3975448">)</span>&nbsp;<span class="op" id="3975450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975454">e</span><span class="op" id="3975455">.</span><span class="ident" id="3975456">WriteString</span><span class="op" id="3975467">(</span><span class="string" id="3975468">&#34;null&#34;</span><span class="op" id="3975474">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975478">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975489">e</span><span class="op" id="3975490">.</span><span class="ident" id="3975491">reflectValue</span><span class="op" id="3975503">(</span><span class="ident" id="3975504">v</span><span class="op" id="3975505">.</span><span class="ident" id="3975506">Elem</span><span class="op" id="3975510">(</span><span class="op" id="3975511">)</span><span class="op" id="3975512">)</span><br>
<span class="lineno"></span><span class="op" id="3975514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="3975517">func</span>&nbsp;<span class="ident" id="3975522">unsupportedTypeEncoder</span><span class="op" id="3975544">(</span><span class="ident" id="3975545">e</span>&nbsp;<span class="op" id="3975547">*</span><span class="ident" id="3975548">encodeState</span><span class="op" id="3975559">,</span>&nbsp;<span class="ident" id="3975561">v</span>&nbsp;<span class="ident" id="3975563">reflect</span><span class="op" id="3975570">.</span><span class="ident" id="3975571">Value</span><span class="op" id="3975576">,</span>&nbsp;<span class="ident" id="3975578">quoted</span>&nbsp;<span class="builtintype" id="3975585">bool</span><span class="op" id="3975589">)</span>&nbsp;<span class="op" id="3975591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975594">e</span><span class="op" id="3975595">.</span><span class="builtintype" id="3975596">error</span><span class="op" id="3975601">(</span><span class="op" id="3975602">&amp;</span><span class="ident" id="3975603">UnsupportedTypeError</span><span class="op" id="3975623">{</span><span class="ident" id="3975624">v</span><span class="op" id="3975625">.</span><span class="ident" id="3975626">Type</span><span class="op" id="3975630">(</span><span class="op" id="3975631">)</span><span class="op" id="3975632">}</span><span class="op" id="3975633">)</span><br>
<span class="lineno"></span><span class="op" id="3975635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3975638">type</span>&nbsp;<span class="ident" id="3975643">structEncoder</span>&nbsp;<span class="keyword" id="3975657">struct</span>&nbsp;<span class="op" id="3975664">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975667">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3975677">[</span><span class="op" id="3975678">]</span><span class="ident" id="3975679">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975686">fieldEncs</span>&nbsp;<span class="op" id="3975696">[</span><span class="op" id="3975697">]</span><span class="ident" id="3975698">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3975710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3975713">func</span>&nbsp;<span class="op" id="3975718">(</span><span class="ident" id="3975719">se</span>&nbsp;<span class="op" id="3975722">*</span><span class="ident" id="3975723">structEncoder</span><span class="op" id="3975736">)</span>&nbsp;<span class="ident" id="3975738">encode</span><span class="op" id="3975744">(</span><span class="ident" id="3975745">e</span>&nbsp;<span class="op" id="3975747">*</span><span class="ident" id="3975748">encodeState</span><span class="op" id="3975759">,</span>&nbsp;<span class="ident" id="3975761">v</span>&nbsp;<span class="ident" id="3975763">reflect</span><span class="op" id="3975770">.</span><span class="ident" id="3975771">Value</span><span class="op" id="3975776">,</span>&nbsp;<span class="ident" id="3975778">quoted</span>&nbsp;<span class="builtintype" id="3975785">bool</span><span class="op" id="3975789">)</span>&nbsp;<span class="op" id="3975791">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975794">e</span><span class="op" id="3975795">.</span><span class="ident" id="3975796">WriteByte</span><span class="op" id="3975805">(</span><span class="string" id="3975806">&#39;{&#39;</span><span class="op" id="3975809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975812">first</span>&nbsp;<span class="op" id="3975818">:=</span>&nbsp;<span class="builtintype" id="3975821">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975827">for</span>&nbsp;<span class="ident" id="3975831">i</span><span class="op" id="3975832">,</span>&nbsp;<span class="ident" id="3975834">f</span>&nbsp;<span class="op" id="3975836">:=</span>&nbsp;<span class="keyword" id="3975839">range</span>&nbsp;<span class="ident" id="3975845">se</span><span class="op" id="3975847">.</span><span class="ident" id="3975848">fields</span>&nbsp;<span class="op" id="3975855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975859">fv</span>&nbsp;<span class="op" id="3975862">:=</span>&nbsp;<span class="ident" id="3975865">fieldByIndex</span><span class="op" id="3975877">(</span><span class="ident" id="3975878">v</span><span class="op" id="3975879">,</span>&nbsp;<span class="ident" id="3975881">f</span><span class="op" id="3975882">.</span><span class="ident" id="3975883">index</span><span class="op" id="3975888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975892">if</span>&nbsp;<span class="op" id="3975895">!</span><span class="ident" id="3975896">fv</span><span class="op" id="3975898">.</span><span class="ident" id="3975899">IsValid</span><span class="op" id="3975906">(</span><span class="op" id="3975907">)</span>&nbsp;<span class="op" id="3975909">||</span>&nbsp;<span class="ident" id="3975912">f</span><span class="op" id="3975913">.</span><span class="ident" id="3975914">omitEmpty</span>&nbsp;<span class="op" id="3975924">&amp;&amp;</span>&nbsp;<span class="ident" id="3975927">isEmptyValue</span><span class="op" id="3975939">(</span><span class="ident" id="3975940">fv</span><span class="op" id="3975942">)</span>&nbsp;<span class="op" id="3975944">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975949">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975964">if</span>&nbsp;<span class="ident" id="3975967">first</span>&nbsp;<span class="op" id="3975973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975978">first</span>&nbsp;<span class="op" id="3975984">=</span>&nbsp;<span class="builtintype" id="3975986">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975994">}</span>&nbsp;<span class="keyword" id="3975996">else</span>&nbsp;<span class="op" id="3976001">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976006">e</span><span class="op" id="3976007">.</span><span class="ident" id="3976008">WriteByte</span><span class="op" id="3976017">(</span><span class="string" id="3976018">&#39;,&#39;</span><span class="op" id="3976021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976029">e</span><span class="op" id="3976030">.</span><span class="builtintype" id="3976031">string</span><span class="op" id="3976037">(</span><span class="ident" id="3976038">f</span><span class="op" id="3976039">.</span><span class="ident" id="3976040">name</span><span class="op" id="3976044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976048">e</span><span class="op" id="3976049">.</span><span class="ident" id="3976050">WriteByte</span><span class="op" id="3976059">(</span><span class="string" id="3976060">&#39;:&#39;</span><span class="op" id="3976063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976067">se</span><span class="op" id="3976069">.</span><span class="ident" id="3976070">fieldEncs</span><span class="op" id="3976079">[</span><span class="ident" id="3976080">i</span><span class="op" id="3976081">]</span><span class="op" id="3976082">(</span><span class="ident" id="3976083">e</span><span class="op" id="3976084">,</span>&nbsp;<span class="ident" id="3976086">fv</span><span class="op" id="3976088">,</span>&nbsp;<span class="ident" id="3976090">f</span><span class="op" id="3976091">.</span><span class="ident" id="3976092">quoted</span><span class="op" id="3976098">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976104">e</span><span class="op" id="3976105">.</span><span class="ident" id="3976106">WriteByte</span><span class="op" id="3976115">(</span><span class="string" id="3976116">&#39;}&#39;</span><span class="op" id="3976119">)</span><br>
<span class="lineno"></span><span class="op" id="3976121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3976124">func</span>&nbsp;<span class="ident" id="3976129">newStructEncoder</span><span class="op" id="3976145">(</span><span class="ident" id="3976146">t</span>&nbsp;<span class="ident" id="3976148">reflect</span><span class="op" id="3976155">.</span><span class="ident" id="3976156">Type</span><span class="op" id="3976160">)</span>&nbsp;<span class="ident" id="3976162">encoderFunc</span>&nbsp;<span class="op" id="3976174">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976177">fields</span>&nbsp;<span class="op" id="3976184">:=</span>&nbsp;<span class="ident" id="3976187">cachedTypeFields</span><span class="op" id="3976203">(</span><span class="ident" id="3976204">t</span><span class="op" id="3976205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976208">se</span>&nbsp;<span class="op" id="3976211">:=</span>&nbsp;<span class="op" id="3976214">&amp;</span><span class="ident" id="3976215">structEncoder</span><span class="op" id="3976228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976232">fields</span><span class="op" id="3976238">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3976243">fields</span><span class="op" id="3976249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976253">fieldEncs</span><span class="op" id="3976262">:</span>&nbsp;<span class="builtinfunc" id="3976264">make</span><span class="op" id="3976268">(</span><span class="op" id="3976269">[</span><span class="op" id="3976270">]</span><span class="ident" id="3976271">encoderFunc</span><span class="op" id="3976282">,</span>&nbsp;<span class="builtinfunc" id="3976284">len</span><span class="op" id="3976287">(</span><span class="ident" id="3976288">fields</span><span class="op" id="3976294">)</span><span class="op" id="3976295">)</span><span class="op" id="3976296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976299">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976302">for</span>&nbsp;<span class="ident" id="3976306">i</span><span class="op" id="3976307">,</span>&nbsp;<span class="ident" id="3976309">f</span>&nbsp;<span class="op" id="3976311">:=</span>&nbsp;<span class="keyword" id="3976314">range</span>&nbsp;<span class="ident" id="3976320">fields</span>&nbsp;<span class="op" id="3976327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976331">se</span><span class="op" id="3976333">.</span><span class="ident" id="3976334">fieldEncs</span><span class="op" id="3976343">[</span><span class="ident" id="3976344">i</span><span class="op" id="3976345">]</span>&nbsp;<span class="op" id="3976347">=</span>&nbsp;<span class="ident" id="3976349">typeEncoder</span><span class="op" id="3976360">(</span><span class="ident" id="3976361">typeByIndex</span><span class="op" id="3976372">(</span><span class="ident" id="3976373">t</span><span class="op" id="3976374">,</span>&nbsp;<span class="ident" id="3976376">f</span><span class="op" id="3976377">.</span><span class="ident" id="3976378">index</span><span class="op" id="3976383">)</span><span class="op" id="3976384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976390">return</span>&nbsp;<span class="ident" id="3976397">se</span><span class="op" id="3976399">.</span><span class="ident" id="3976400">encode</span><br>
<span class="lineno"></span><span class="op" id="3976407">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="3976410">type</span>&nbsp;<span class="ident" id="3976415">mapEncoder</span>&nbsp;<span class="keyword" id="3976426">struct</span>&nbsp;<span class="op" id="3976433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976436">elemEnc</span>&nbsp;<span class="ident" id="3976444">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3976456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="3976459">func</span>&nbsp;<span class="op" id="3976464">(</span><span class="ident" id="3976465">me</span>&nbsp;<span class="op" id="3976468">*</span><span class="ident" id="3976469">mapEncoder</span><span class="op" id="3976479">)</span>&nbsp;<span class="ident" id="3976481">encode</span><span class="op" id="3976487">(</span><span class="ident" id="3976488">e</span>&nbsp;<span class="op" id="3976490">*</span><span class="ident" id="3976491">encodeState</span><span class="op" id="3976502">,</span>&nbsp;<span class="ident" id="3976504">v</span>&nbsp;<span class="ident" id="3976506">reflect</span><span class="op" id="3976513">.</span><span class="ident" id="3976514">Value</span><span class="op" id="3976519">,</span>&nbsp;<span class="ident" id="3976521">_</span>&nbsp;<span class="builtintype" id="3976523">bool</span><span class="op" id="3976527">)</span>&nbsp;<span class="op" id="3976529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976532">if</span>&nbsp;<span class="ident" id="3976535">v</span><span class="op" id="3976536">.</span><span class="ident" id="3976537">IsNil</span><span class="op" id="3976542">(</span><span class="op" id="3976543">)</span>&nbsp;<span class="op" id="3976545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976549">e</span><span class="op" id="3976550">.</span><span class="ident" id="3976551">WriteString</span><span class="op" id="3976562">(</span><span class="string" id="3976563">&#34;null&#34;</span><span class="op" id="3976569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976573">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976581">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976584">e</span><span class="op" id="3976585">.</span><span class="ident" id="3976586">WriteByte</span><span class="op" id="3976595">(</span><span class="string" id="3976596">&#39;{&#39;</span><span class="op" id="3976599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976602">var</span>&nbsp;<span class="ident" id="3976606">sv</span>&nbsp;<span class="ident" id="3976609">stringValues</span>&nbsp;<span class="op" id="3976622">=</span>&nbsp;<span class="ident" id="3976624">v</span><span class="op" id="3976625">.</span><span class="ident" id="3976626">MapKeys</span><span class="op" id="3976633">(</span><span class="op" id="3976634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976637">sort</span><span class="op" id="3976641">.</span><span class="ident" id="3976642">Sort</span><span class="op" id="3976646">(</span><span class="ident" id="3976647">sv</span><span class="op" id="3976649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976652">for</span>&nbsp;<span class="ident" id="3976656">i</span><span class="op" id="3976657">,</span>&nbsp;<span class="ident" id="3976659">k</span>&nbsp;<span class="op" id="3976661">:=</span>&nbsp;<span class="keyword" id="3976664">range</span>&nbsp;<span class="ident" id="3976670">sv</span>&nbsp;<span class="op" id="3976673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976677">if</span>&nbsp;<span class="ident" id="3976680">i</span>&nbsp;<span class="op" id="3976682">&gt;</span>&nbsp;<span class="num" id="3976684">0</span>&nbsp;<span class="op" id="3976686">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976691">e</span><span class="op" id="3976692">.</span><span class="ident" id="3976693">WriteByte</span><span class="op" id="3976702">(</span><span class="string" id="3976703">&#39;,&#39;</span><span class="op" id="3976706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976714">e</span><span class="op" id="3976715">.</span><span class="builtintype" id="3976716">string</span><span class="op" id="3976722">(</span><span class="ident" id="3976723">k</span><span class="op" id="3976724">.</span><span class="ident" id="3976725">String</span><span class="op" id="3976731">(</span><span class="op" id="3976732">)</span><span class="op" id="3976733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976737">e</span><span class="op" id="3976738">.</span><span class="ident" id="3976739">WriteByte</span><span class="op" id="3976748">(</span><span class="string" id="3976749">&#39;:&#39;</span><span class="op" id="3976752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976756">me</span><span class="op" id="3976758">.</span><span class="ident" id="3976759">elemEnc</span><span class="op" id="3976766">(</span><span class="ident" id="3976767">e</span><span class="op" id="3976768">,</span>&nbsp;<span class="ident" id="3976770">v</span><span class="op" id="3976771">.</span><span class="ident" id="3976772">MapIndex</span><span class="op" id="3976780">(</span><span class="ident" id="3976781">k</span><span class="op" id="3976782">)</span><span class="op" id="3976783">,</span>&nbsp;<span class="builtintype" id="3976785">false</span><span class="op" id="3976790">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976796">e</span><span class="op" id="3976797">.</span><span class="ident" id="3976798">WriteByte</span><span class="op" id="3976807">(</span><span class="string" id="3976808">&#39;}&#39;</span><span class="op" id="3976811">)</span><br>
<span class="lineno"></span><span class="op" id="3976813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3976816">func</span>&nbsp;<span class="ident" id="3976821">newMapEncoder</span><span class="op" id="3976834">(</span><span class="ident" id="3976835">t</span>&nbsp;<span class="ident" id="3976837">reflect</span><span class="op" id="3976844">.</span><span class="ident" id="3976845">Type</span><span class="op" id="3976849">)</span>&nbsp;<span class="ident" id="3976851">encoderFunc</span>&nbsp;<span class="op" id="3976863">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976866">if</span>&nbsp;<span class="ident" id="3976869">t</span><span class="op" id="3976870">.</span><span class="ident" id="3976871">Key</span><span class="op" id="3976874">(</span><span class="op" id="3976875">)</span><span class="op" id="3976876">.</span><span class="ident" id="3976877">Kind</span><span class="op" id="3976881">(</span><span class="op" id="3976882">)</span>&nbsp;<span class="op" id="3976884">!=</span>&nbsp;<span class="ident" id="3976887">reflect</span><span class="op" id="3976894">.</span><span class="ident" id="3976895">String</span>&nbsp;<span class="op" id="3976902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976906">return</span>&nbsp;<span class="ident" id="3976913">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976940">me</span>&nbsp;<span class="op" id="3976943">:=</span>&nbsp;<span class="op" id="3976946">&amp;</span><span class="ident" id="3976947">mapEncoder</span><span class="op" id="3976957">{</span><span class="ident" id="3976958">typeEncoder</span><span class="op" id="3976969">(</span><span class="ident" id="3976970">t</span><span class="op" id="3976971">.</span><span class="ident" id="3976972">Elem</span><span class="op" id="3976976">(</span><span class="op" id="3976977">)</span><span class="op" id="3976978">)</span><span class="op" id="3976979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976982">return</span>&nbsp;<span class="ident" id="3976989">me</span><span class="op" id="3976991">.</span><span class="ident" id="3976992">encode</span><br>
<span class="lineno">630</span><span class="op" id="3976999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3977002">func</span>&nbsp;<span class="ident" id="3977007">encodeByteSlice</span><span class="op" id="3977022">(</span><span class="ident" id="3977023">e</span>&nbsp;<span class="op" id="3977025">*</span><span class="ident" id="3977026">encodeState</span><span class="op" id="3977037">,</span>&nbsp;<span class="ident" id="3977039">v</span>&nbsp;<span class="ident" id="3977041">reflect</span><span class="op" id="3977048">.</span><span class="ident" id="3977049">Value</span><span class="op" id="3977054">,</span>&nbsp;<span class="ident" id="3977056">_</span>&nbsp;<span class="builtintype" id="3977058">bool</span><span class="op" id="3977062">)</span>&nbsp;<span class="op" id="3977064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977067">if</span>&nbsp;<span class="ident" id="3977070">v</span><span class="op" id="3977071">.</span><span class="ident" id="3977072">IsNil</span><span class="op" id="3977077">(</span><span class="op" id="3977078">)</span>&nbsp;<span class="op" id="3977080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977084">e</span><span class="op" id="3977085">.</span><span class="ident" id="3977086">WriteString</span><span class="op" id="3977097">(</span><span class="string" id="3977098">&#34;null&#34;</span><span class="op" id="3977104">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977108">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977119">s</span>&nbsp;<span class="op" id="3977121">:=</span>&nbsp;<span class="ident" id="3977124">v</span><span class="op" id="3977125">.</span><span class="ident" id="3977126">Bytes</span><span class="op" id="3977131">(</span><span class="op" id="3977132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977135">e</span><span class="op" id="3977136">.</span><span class="ident" id="3977137">WriteByte</span><span class="op" id="3977146">(</span><span class="string" id="3977147">&#39;&#34;&#39;</span><span class="op" id="3977150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977153">if</span>&nbsp;<span class="builtinfunc" id="3977156">len</span><span class="op" id="3977159">(</span><span class="ident" id="3977160">s</span><span class="op" id="3977161">)</span>&nbsp;<span class="op" id="3977163">&lt;</span>&nbsp;<span class="num" id="3977165">1024</span>&nbsp;<span class="op" id="3977170">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3977174">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977236">dst</span>&nbsp;<span class="op" id="3977240">:=</span>&nbsp;<span class="builtinfunc" id="3977243">make</span><span class="op" id="3977247">(</span><span class="op" id="3977248">[</span><span class="op" id="3977249">]</span><span class="builtintype" id="3977250">byte</span><span class="op" id="3977254">,</span>&nbsp;<span class="ident" id="3977256">base64</span><span class="op" id="3977262">.</span><span class="ident" id="3977263">StdEncoding</span><span class="op" id="3977274">.</span><span class="ident" id="3977275">EncodedLen</span><span class="op" id="3977285">(</span><span class="builtinfunc" id="3977286">len</span><span class="op" id="3977289">(</span><span class="ident" id="3977290">s</span><span class="op" id="3977291">)</span><span class="op" id="3977292">)</span><span class="op" id="3977293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977297">base64</span><span class="op" id="3977303">.</span><span class="ident" id="3977304">StdEncoding</span><span class="op" id="3977315">.</span><span class="ident" id="3977316">Encode</span><span class="op" id="3977322">(</span><span class="ident" id="3977323">dst</span><span class="op" id="3977326">,</span>&nbsp;<span class="ident" id="3977328">s</span><span class="op" id="3977329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977333">e</span><span class="op" id="3977334">.</span><span class="ident" id="3977335">Write</span><span class="op" id="3977340">(</span><span class="ident" id="3977341">dst</span><span class="op" id="3977344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977347">}</span>&nbsp;<span class="keyword" id="3977349">else</span>&nbsp;<span class="op" id="3977354">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3977358">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3977416">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977435">enc</span>&nbsp;<span class="op" id="3977439">:=</span>&nbsp;<span class="ident" id="3977442">base64</span><span class="op" id="3977448">.</span><span class="ident" id="3977449">NewEncoder</span><span class="op" id="3977459">(</span><span class="ident" id="3977460">base64</span><span class="op" id="3977466">.</span><span class="ident" id="3977467">StdEncoding</span><span class="op" id="3977478">,</span>&nbsp;<span class="ident" id="3977480">e</span><span class="op" id="3977481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977485">enc</span><span class="op" id="3977488">.</span><span class="ident" id="3977489">Write</span><span class="op" id="3977494">(</span><span class="ident" id="3977495">s</span><span class="op" id="3977496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977500">enc</span><span class="op" id="3977503">.</span><span class="ident" id="3977504">Close</span><span class="op" id="3977509">(</span><span class="op" id="3977510">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977516">e</span><span class="op" id="3977517">.</span><span class="ident" id="3977518">WriteByte</span><span class="op" id="3977527">(</span><span class="string" id="3977528">&#39;&#34;&#39;</span><span class="op" id="3977531">)</span><br>
<span class="lineno"></span><span class="op" id="3977533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3977536">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="3977623">type</span>&nbsp;<span class="ident" id="3977628">sliceEncoder</span>&nbsp;<span class="keyword" id="3977641">struct</span>&nbsp;<span class="op" id="3977648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977651">arrayEnc</span>&nbsp;<span class="ident" id="3977660">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3977672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3977675">func</span>&nbsp;<span class="op" id="3977680">(</span><span class="ident" id="3977681">se</span>&nbsp;<span class="op" id="3977684">*</span><span class="ident" id="3977685">sliceEncoder</span><span class="op" id="3977697">)</span>&nbsp;<span class="ident" id="3977699">encode</span><span class="op" id="3977705">(</span><span class="ident" id="3977706">e</span>&nbsp;<span class="op" id="3977708">*</span><span class="ident" id="3977709">encodeState</span><span class="op" id="3977720">,</span>&nbsp;<span class="ident" id="3977722">v</span>&nbsp;<span class="ident" id="3977724">reflect</span><span class="op" id="3977731">.</span><span class="ident" id="3977732">Value</span><span class="op" id="3977737">,</span>&nbsp;<span class="ident" id="3977739">_</span>&nbsp;<span class="builtintype" id="3977741">bool</span><span class="op" id="3977745">)</span>&nbsp;<span class="op" id="3977747">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977750">if</span>&nbsp;<span class="ident" id="3977753">v</span><span class="op" id="3977754">.</span><span class="ident" id="3977755">IsNil</span><span class="op" id="3977760">(</span><span class="op" id="3977761">)</span>&nbsp;<span class="op" id="3977763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977767">e</span><span class="op" id="3977768">.</span><span class="ident" id="3977769">WriteString</span><span class="op" id="3977780">(</span><span class="string" id="3977781">&#34;null&#34;</span><span class="op" id="3977787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977791">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977802">se</span><span class="op" id="3977804">.</span><span class="ident" id="3977805">arrayEnc</span><span class="op" id="3977813">(</span><span class="ident" id="3977814">e</span><span class="op" id="3977815">,</span>&nbsp;<span class="ident" id="3977817">v</span><span class="op" id="3977818">,</span>&nbsp;<span class="builtintype" id="3977820">false</span><span class="op" id="3977825">)</span><br>
<span class="lineno">665</span><span class="op" id="3977827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3977830">func</span>&nbsp;<span class="ident" id="3977835">newSliceEncoder</span><span class="op" id="3977850">(</span><span class="ident" id="3977851">t</span>&nbsp;<span class="ident" id="3977853">reflect</span><span class="op" id="3977860">.</span><span class="ident" id="3977861">Type</span><span class="op" id="3977865">)</span>&nbsp;<span class="ident" id="3977867">encoderFunc</span>&nbsp;<span class="op" id="3977879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3977882">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977935">if</span>&nbsp;<span class="ident" id="3977938">t</span><span class="op" id="3977939">.</span><span class="ident" id="3977940">Elem</span><span class="op" id="3977944">(</span><span class="op" id="3977945">)</span><span class="op" id="3977946">.</span><span class="ident" id="3977947">Kind</span><span class="op" id="3977951">(</span><span class="op" id="3977952">)</span>&nbsp;<span class="op" id="3977954">==</span>&nbsp;<span class="ident" id="3977957">reflect</span><span class="op" id="3977964">.</span><span class="ident" id="3977965">Uint8</span>&nbsp;<span class="op" id="3977971">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977975">return</span>&nbsp;<span class="ident" id="3977982">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978002">enc</span>&nbsp;<span class="op" id="3978006">:=</span>&nbsp;<span class="op" id="3978009">&amp;</span><span class="ident" id="3978010">sliceEncoder</span><span class="op" id="3978022">{</span><span class="ident" id="3978023">newArrayEncoder</span><span class="op" id="3978038">(</span><span class="ident" id="3978039">t</span><span class="op" id="3978040">)</span><span class="op" id="3978041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978044">return</span>&nbsp;<span class="ident" id="3978051">enc</span><span class="op" id="3978054">.</span><span class="ident" id="3978055">encode</span><br>
<span class="lineno"></span><span class="op" id="3978062">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="3978065">type</span>&nbsp;<span class="ident" id="3978070">arrayEncoder</span>&nbsp;<span class="keyword" id="3978083">struct</span>&nbsp;<span class="op" id="3978090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978093">elemEnc</span>&nbsp;<span class="ident" id="3978101">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3978113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="3978116">func</span>&nbsp;<span class="op" id="3978121">(</span><span class="ident" id="3978122">ae</span>&nbsp;<span class="op" id="3978125">*</span><span class="ident" id="3978126">arrayEncoder</span><span class="op" id="3978138">)</span>&nbsp;<span class="ident" id="3978140">encode</span><span class="op" id="3978146">(</span><span class="ident" id="3978147">e</span>&nbsp;<span class="op" id="3978149">*</span><span class="ident" id="3978150">encodeState</span><span class="op" id="3978161">,</span>&nbsp;<span class="ident" id="3978163">v</span>&nbsp;<span class="ident" id="3978165">reflect</span><span class="op" id="3978172">.</span><span class="ident" id="3978173">Value</span><span class="op" id="3978178">,</span>&nbsp;<span class="ident" id="3978180">_</span>&nbsp;<span class="builtintype" id="3978182">bool</span><span class="op" id="3978186">)</span>&nbsp;<span class="op" id="3978188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978191">e</span><span class="op" id="3978192">.</span><span class="ident" id="3978193">WriteByte</span><span class="op" id="3978202">(</span><span class="string" id="3978203">&#39;[&#39;</span><span class="op" id="3978206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978209">n</span>&nbsp;<span class="op" id="3978211">:=</span>&nbsp;<span class="ident" id="3978214">v</span><span class="op" id="3978215">.</span><span class="ident" id="3978216">Len</span><span class="op" id="3978219">(</span><span class="op" id="3978220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978223">for</span>&nbsp;<span class="ident" id="3978227">i</span>&nbsp;<span class="op" id="3978229">:=</span>&nbsp;<span class="num" id="3978232">0</span><span class="op" id="3978233">;</span>&nbsp;<span class="ident" id="3978235">i</span>&nbsp;<span class="op" id="3978237">&lt;</span>&nbsp;<span class="ident" id="3978239">n</span><span class="op" id="3978240">;</span>&nbsp;<span class="ident" id="3978242">i</span><span class="op" id="3978243">++</span>&nbsp;<span class="op" id="3978246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978250">if</span>&nbsp;<span class="ident" id="3978253">i</span>&nbsp;<span class="op" id="3978255">&gt;</span>&nbsp;<span class="num" id="3978257">0</span>&nbsp;<span class="op" id="3978259">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978264">e</span><span class="op" id="3978265">.</span><span class="ident" id="3978266">WriteByte</span><span class="op" id="3978275">(</span><span class="string" id="3978276">&#39;,&#39;</span><span class="op" id="3978279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978287">ae</span><span class="op" id="3978289">.</span><span class="ident" id="3978290">elemEnc</span><span class="op" id="3978297">(</span><span class="ident" id="3978298">e</span><span class="op" id="3978299">,</span>&nbsp;<span class="ident" id="3978301">v</span><span class="op" id="3978302">.</span><span class="ident" id="3978303">Index</span><span class="op" id="3978308">(</span><span class="ident" id="3978309">i</span><span class="op" id="3978310">)</span><span class="op" id="3978311">,</span>&nbsp;<span class="builtintype" id="3978313">false</span><span class="op" id="3978318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978324">e</span><span class="op" id="3978325">.</span><span class="ident" id="3978326">WriteByte</span><span class="op" id="3978335">(</span><span class="string" id="3978336">&#39;]&#39;</span><span class="op" id="3978339">)</span><br>
<span class="lineno">690</span><span class="op" id="3978341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978344">func</span>&nbsp;<span class="ident" id="3978349">newArrayEncoder</span><span class="op" id="3978364">(</span><span class="ident" id="3978365">t</span>&nbsp;<span class="ident" id="3978367">reflect</span><span class="op" id="3978374">.</span><span class="ident" id="3978375">Type</span><span class="op" id="3978379">)</span>&nbsp;<span class="ident" id="3978381">encoderFunc</span>&nbsp;<span class="op" id="3978393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978396">enc</span>&nbsp;<span class="op" id="3978400">:=</span>&nbsp;<span class="op" id="3978403">&amp;</span><span class="ident" id="3978404">arrayEncoder</span><span class="op" id="3978416">{</span><span class="ident" id="3978417">typeEncoder</span><span class="op" id="3978428">(</span><span class="ident" id="3978429">t</span><span class="op" id="3978430">.</span><span class="ident" id="3978431">Elem</span><span class="op" id="3978435">(</span><span class="op" id="3978436">)</span><span class="op" id="3978437">)</span><span class="op" id="3978438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978441">return</span>&nbsp;<span class="ident" id="3978448">enc</span><span class="op" id="3978451">.</span><span class="ident" id="3978452">encode</span><br>
<span class="lineno">695</span><span class="op" id="3978459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978462">type</span>&nbsp;<span class="ident" id="3978467">ptrEncoder</span>&nbsp;<span class="keyword" id="3978478">struct</span>&nbsp;<span class="op" id="3978485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978488">elemEnc</span>&nbsp;<span class="ident" id="3978496">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3978508">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="3978511">func</span>&nbsp;<span class="op" id="3978516">(</span><span class="ident" id="3978517">pe</span>&nbsp;<span class="op" id="3978520">*</span><span class="ident" id="3978521">ptrEncoder</span><span class="op" id="3978531">)</span>&nbsp;<span class="ident" id="3978533">encode</span><span class="op" id="3978539">(</span><span class="ident" id="3978540">e</span>&nbsp;<span class="op" id="3978542">*</span><span class="ident" id="3978543">encodeState</span><span class="op" id="3978554">,</span>&nbsp;<span class="ident" id="3978556">v</span>&nbsp;<span class="ident" id="3978558">reflect</span><span class="op" id="3978565">.</span><span class="ident" id="3978566">Value</span><span class="op" id="3978571">,</span>&nbsp;<span class="ident" id="3978573">quoted</span>&nbsp;<span class="builtintype" id="3978580">bool</span><span class="op" id="3978584">)</span>&nbsp;<span class="op" id="3978586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978589">if</span>&nbsp;<span class="ident" id="3978592">v</span><span class="op" id="3978593">.</span><span class="ident" id="3978594">IsNil</span><span class="op" id="3978599">(</span><span class="op" id="3978600">)</span>&nbsp;<span class="op" id="3978602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978606">e</span><span class="op" id="3978607">.</span><span class="ident" id="3978608">WriteString</span><span class="op" id="3978619">(</span><span class="string" id="3978620">&#34;null&#34;</span><span class="op" id="3978626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978630">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978641">pe</span><span class="op" id="3978643">.</span><span class="ident" id="3978644">elemEnc</span><span class="op" id="3978651">(</span><span class="ident" id="3978652">e</span><span class="op" id="3978653">,</span>&nbsp;<span class="ident" id="3978655">v</span><span class="op" id="3978656">.</span><span class="ident" id="3978657">Elem</span><span class="op" id="3978661">(</span><span class="op" id="3978662">)</span><span class="op" id="3978663">,</span>&nbsp;<span class="ident" id="3978665">quoted</span><span class="op" id="3978671">)</span><br>
<span class="lineno"></span><span class="op" id="3978673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978676">func</span>&nbsp;<span class="ident" id="3978681">newPtrEncoder</span><span class="op" id="3978694">(</span><span class="ident" id="3978695">t</span>&nbsp;<span class="ident" id="3978697">reflect</span><span class="op" id="3978704">.</span><span class="ident" id="3978705">Type</span><span class="op" id="3978709">)</span>&nbsp;<span class="ident" id="3978711">encoderFunc</span>&nbsp;<span class="op" id="3978723">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978726">enc</span>&nbsp;<span class="op" id="3978730">:=</span>&nbsp;<span class="op" id="3978733">&amp;</span><span class="ident" id="3978734">ptrEncoder</span><span class="op" id="3978744">{</span><span class="ident" id="3978745">typeEncoder</span><span class="op" id="3978756">(</span><span class="ident" id="3978757">t</span><span class="op" id="3978758">.</span><span class="ident" id="3978759">Elem</span><span class="op" id="3978763">(</span><span class="op" id="3978764">)</span><span class="op" id="3978765">)</span><span class="op" id="3978766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978769">return</span>&nbsp;<span class="ident" id="3978776">enc</span><span class="op" id="3978779">.</span><span class="ident" id="3978780">encode</span><br>
<span class="lineno"></span><span class="op" id="3978787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978790">type</span>&nbsp;<span class="ident" id="3978795">condAddrEncoder</span>&nbsp;<span class="keyword" id="3978811">struct</span>&nbsp;<span class="op" id="3978818">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978821">canAddrEnc</span><span class="op" id="3978831">,</span>&nbsp;<span class="ident" id="3978833">elseEnc</span>&nbsp;<span class="ident" id="3978841">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3978853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978856">func</span>&nbsp;<span class="op" id="3978861">(</span><span class="ident" id="3978862">ce</span>&nbsp;<span class="op" id="3978865">*</span><span class="ident" id="3978866">condAddrEncoder</span><span class="op" id="3978881">)</span>&nbsp;<span class="ident" id="3978883">encode</span><span class="op" id="3978889">(</span><span class="ident" id="3978890">e</span>&nbsp;<span class="op" id="3978892">*</span><span class="ident" id="3978893">encodeState</span><span class="op" id="3978904">,</span>&nbsp;<span class="ident" id="3978906">v</span>&nbsp;<span class="ident" id="3978908">reflect</span><span class="op" id="3978915">.</span><span class="ident" id="3978916">Value</span><span class="op" id="3978921">,</span>&nbsp;<span class="ident" id="3978923">quoted</span>&nbsp;<span class="builtintype" id="3978930">bool</span><span class="op" id="3978934">)</span>&nbsp;<span class="op" id="3978936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978939">if</span>&nbsp;<span class="ident" id="3978942">v</span><span class="op" id="3978943">.</span><span class="ident" id="3978944">CanAddr</span><span class="op" id="3978951">(</span><span class="op" id="3978952">)</span>&nbsp;<span class="op" id="3978954">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978958">ce</span><span class="op" id="3978960">.</span><span class="ident" id="3978961">canAddrEnc</span><span class="op" id="3978971">(</span><span class="ident" id="3978972">e</span><span class="op" id="3978973">,</span>&nbsp;<span class="ident" id="3978975">v</span><span class="op" id="3978976">,</span>&nbsp;<span class="ident" id="3978978">quoted</span><span class="op" id="3978984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978987">}</span>&nbsp;<span class="keyword" id="3978989">else</span>&nbsp;<span class="op" id="3978994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978998">ce</span><span class="op" id="3979000">.</span><span class="ident" id="3979001">elseEnc</span><span class="op" id="3979008">(</span><span class="ident" id="3979009">e</span><span class="op" id="3979010">,</span>&nbsp;<span class="ident" id="3979012">v</span><span class="op" id="3979013">,</span>&nbsp;<span class="ident" id="3979015">quoted</span><span class="op" id="3979021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979024">}</span><br>
<span class="lineno"></span><span class="op" id="3979026">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="3979029">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3979100">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="3979163">func</span>&nbsp;<span class="ident" id="3979168">newCondAddrEncoder</span><span class="op" id="3979186">(</span><span class="ident" id="3979187">canAddrEnc</span><span class="op" id="3979197">,</span>&nbsp;<span class="ident" id="3979199">elseEnc</span>&nbsp;<span class="ident" id="3979207">encoderFunc</span><span class="op" id="3979218">)</span>&nbsp;<span class="ident" id="3979220">encoderFunc</span>&nbsp;<span class="op" id="3979232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979235">enc</span>&nbsp;<span class="op" id="3979239">:=</span>&nbsp;<span class="op" id="3979242">&amp;</span><span class="ident" id="3979243">condAddrEncoder</span><span class="op" id="3979258">{</span><span class="ident" id="3979259">canAddrEnc</span><span class="op" id="3979269">:</span>&nbsp;<span class="ident" id="3979271">canAddrEnc</span><span class="op" id="3979281">,</span>&nbsp;<span class="ident" id="3979283">elseEnc</span><span class="op" id="3979290">:</span>&nbsp;<span class="ident" id="3979292">elseEnc</span><span class="op" id="3979299">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979302">return</span>&nbsp;<span class="ident" id="3979309">enc</span><span class="op" id="3979312">.</span><span class="ident" id="3979313">encode</span><br>
<span class="lineno"></span><span class="op" id="3979320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3979323">func</span>&nbsp;<span class="ident" id="3979328">isValidTag</span><span class="op" id="3979338">(</span><span class="ident" id="3979339">s</span>&nbsp;<span class="builtintype" id="3979341">string</span><span class="op" id="3979347">)</span>&nbsp;<span class="builtintype" id="3979349">bool</span>&nbsp;<span class="op" id="3979354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979357">if</span>&nbsp;<span class="ident" id="3979360">s</span>&nbsp;<span class="op" id="3979362">==</span>&nbsp;<span class="string" id="3979365">&#34;&#34;</span>&nbsp;<span class="op" id="3979368">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979372">return</span>&nbsp;<span class="builtintype" id="3979379">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979389">for</span>&nbsp;<span class="ident" id="3979393">_</span><span class="op" id="3979394">,</span>&nbsp;<span class="ident" id="3979396">c</span>&nbsp;<span class="op" id="3979398">:=</span>&nbsp;<span class="keyword" id="3979401">range</span>&nbsp;<span class="ident" id="3979407">s</span>&nbsp;<span class="op" id="3979409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979413">switch</span>&nbsp;<span class="op" id="3979420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979424">case</span>&nbsp;<span class="ident" id="3979429">strings</span><span class="op" id="3979436">.</span><span class="ident" id="3979437">ContainsRune</span><span class="op" id="3979449">(</span><span class="string" id="3979450">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="3979479">,</span>&nbsp;<span class="ident" id="3979481">c</span><span class="op" id="3979482">)</span><span class="op" id="3979483">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3979488">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3979538">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3979588">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979608">default</span><span class="op" id="3979615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979620">if</span>&nbsp;<span class="op" id="3979623">!</span><span class="ident" id="3979624">unicode</span><span class="op" id="3979631">.</span><span class="ident" id="3979632">IsLetter</span><span class="op" id="3979640">(</span><span class="ident" id="3979641">c</span><span class="op" id="3979642">)</span>&nbsp;<span class="op" id="3979644">&amp;&amp;</span>&nbsp;<span class="op" id="3979647">!</span><span class="ident" id="3979648">unicode</span><span class="op" id="3979655">.</span><span class="ident" id="3979656">IsDigit</span><span class="op" id="3979663">(</span><span class="ident" id="3979664">c</span><span class="op" id="3979665">)</span>&nbsp;<span class="op" id="3979667">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979673">return</span>&nbsp;<span class="builtintype" id="3979680">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979699">return</span>&nbsp;<span class="builtintype" id="3979706">true</span><br>
<span class="lineno">750</span><span class="op" id="3979711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3979714">func</span>&nbsp;<span class="ident" id="3979719">fieldByIndex</span><span class="op" id="3979731">(</span><span class="ident" id="3979732">v</span>&nbsp;<span class="ident" id="3979734">reflect</span><span class="op" id="3979741">.</span><span class="ident" id="3979742">Value</span><span class="op" id="3979747">,</span>&nbsp;<span class="ident" id="3979749">index</span>&nbsp;<span class="op" id="3979755">[</span><span class="op" id="3979756">]</span><span class="builtintype" id="3979757">int</span><span class="op" id="3979760">)</span>&nbsp;<span class="ident" id="3979762">reflect</span><span class="op" id="3979769">.</span><span class="ident" id="3979770">Value</span>&nbsp;<span class="op" id="3979776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979779">for</span>&nbsp;<span class="ident" id="3979783">_</span><span class="op" id="3979784">,</span>&nbsp;<span class="ident" id="3979786">i</span>&nbsp;<span class="op" id="3979788">:=</span>&nbsp;<span class="keyword" id="3979791">range</span>&nbsp;<span class="ident" id="3979797">index</span>&nbsp;<span class="op" id="3979803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979807">if</span>&nbsp;<span class="ident" id="3979810">v</span><span class="op" id="3979811">.</span><span class="ident" id="3979812">Kind</span><span class="op" id="3979816">(</span><span class="op" id="3979817">)</span>&nbsp;<span class="op" id="3979819">==</span>&nbsp;<span class="ident" id="3979822">reflect</span><span class="op" id="3979829">.</span><span class="ident" id="3979830">Ptr</span>&nbsp;<span class="op" id="3979834">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979839">if</span>&nbsp;<span class="ident" id="3979842">v</span><span class="op" id="3979843">.</span><span class="ident" id="3979844">IsNil</span><span class="op" id="3979849">(</span><span class="op" id="3979850">)</span>&nbsp;<span class="op" id="3979852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979858">return</span>&nbsp;<span class="ident" id="3979865">reflect</span><span class="op" id="3979872">.</span><span class="ident" id="3979873">Value</span><span class="op" id="3979878">{</span><span class="op" id="3979879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979889">v</span>&nbsp;<span class="op" id="3979891">=</span>&nbsp;<span class="ident" id="3979893">v</span><span class="op" id="3979894">.</span><span class="ident" id="3979895">Elem</span><span class="op" id="3979899">(</span><span class="op" id="3979900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979904">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979908">v</span>&nbsp;<span class="op" id="3979910">=</span>&nbsp;<span class="ident" id="3979912">v</span><span class="op" id="3979913">.</span><span class="ident" id="3979914">Field</span><span class="op" id="3979919">(</span><span class="ident" id="3979920">i</span><span class="op" id="3979921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979927">return</span>&nbsp;<span class="ident" id="3979934">v</span><br>
<span class="lineno"></span><span class="op" id="3979936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="3979939">func</span>&nbsp;<span class="ident" id="3979944">typeByIndex</span><span class="op" id="3979955">(</span><span class="ident" id="3979956">t</span>&nbsp;<span class="ident" id="3979958">reflect</span><span class="op" id="3979965">.</span><span class="ident" id="3979966">Type</span><span class="op" id="3979970">,</span>&nbsp;<span class="ident" id="3979972">index</span>&nbsp;<span class="op" id="3979978">[</span><span class="op" id="3979979">]</span><span class="builtintype" id="3979980">int</span><span class="op" id="3979983">)</span>&nbsp;<span class="ident" id="3979985">reflect</span><span class="op" id="3979992">.</span><span class="ident" id="3979993">Type</span>&nbsp;<span class="op" id="3979998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980001">for</span>&nbsp;<span class="ident" id="3980005">_</span><span class="op" id="3980006">,</span>&nbsp;<span class="ident" id="3980008">i</span>&nbsp;<span class="op" id="3980010">:=</span>&nbsp;<span class="keyword" id="3980013">range</span>&nbsp;<span class="ident" id="3980019">index</span>&nbsp;<span class="op" id="3980025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980029">if</span>&nbsp;<span class="ident" id="3980032">t</span><span class="op" id="3980033">.</span><span class="ident" id="3980034">Kind</span><span class="op" id="3980038">(</span><span class="op" id="3980039">)</span>&nbsp;<span class="op" id="3980041">==</span>&nbsp;<span class="ident" id="3980044">reflect</span><span class="op" id="3980051">.</span><span class="ident" id="3980052">Ptr</span>&nbsp;<span class="op" id="3980056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980061">t</span>&nbsp;<span class="op" id="3980063">=</span>&nbsp;<span class="ident" id="3980065">t</span><span class="op" id="3980066">.</span><span class="ident" id="3980067">Elem</span><span class="op" id="3980071">(</span><span class="op" id="3980072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980076">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980080">t</span>&nbsp;<span class="op" id="3980082">=</span>&nbsp;<span class="ident" id="3980084">t</span><span class="op" id="3980085">.</span><span class="ident" id="3980086">Field</span><span class="op" id="3980091">(</span><span class="ident" id="3980092">i</span><span class="op" id="3980093">)</span><span class="op" id="3980094">.</span><span class="ident" id="3980095">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980104">return</span>&nbsp;<span class="ident" id="3980111">t</span><br>
<span class="lineno"></span><span class="op" id="3980113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="3980116">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="3980190">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3980238">type</span>&nbsp;<span class="ident" id="3980243">stringValues</span>&nbsp;<span class="op" id="3980256">[</span><span class="op" id="3980257">]</span><span class="ident" id="3980258">reflect</span><span class="op" id="3980265">.</span><span class="ident" id="3980266">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3980273">func</span>&nbsp;<span class="op" id="3980278">(</span><span class="ident" id="3980279">sv</span>&nbsp;<span class="ident" id="3980282">stringValues</span><span class="op" id="3980294">)</span>&nbsp;<span class="ident" id="3980296">Len</span><span class="op" id="3980299">(</span><span class="op" id="3980300">)</span>&nbsp;<span class="builtintype" id="3980302">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980316">{</span>&nbsp;<span class="keyword" id="3980318">return</span>&nbsp;<span class="builtinfunc" id="3980325">len</span><span class="op" id="3980328">(</span><span class="ident" id="3980329">sv</span><span class="op" id="3980331">)</span>&nbsp;<span class="op" id="3980333">}</span><br>
<span class="lineno">780</span><span class="keyword" id="3980335">func</span>&nbsp;<span class="op" id="3980340">(</span><span class="ident" id="3980341">sv</span>&nbsp;<span class="ident" id="3980344">stringValues</span><span class="op" id="3980356">)</span>&nbsp;<span class="ident" id="3980358">Swap</span><span class="op" id="3980362">(</span><span class="ident" id="3980363">i</span><span class="op" id="3980364">,</span>&nbsp;<span class="ident" id="3980366">j</span>&nbsp;<span class="builtintype" id="3980368">int</span><span class="op" id="3980371">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980378">{</span>&nbsp;<span class="ident" id="3980380">sv</span><span class="op" id="3980382">[</span><span class="ident" id="3980383">i</span><span class="op" id="3980384">]</span><span class="op" id="3980385">,</span>&nbsp;<span class="ident" id="3980387">sv</span><span class="op" id="3980389">[</span><span class="ident" id="3980390">j</span><span class="op" id="3980391">]</span>&nbsp;<span class="op" id="3980393">=</span>&nbsp;<span class="ident" id="3980395">sv</span><span class="op" id="3980397">[</span><span class="ident" id="3980398">j</span><span class="op" id="3980399">]</span><span class="op" id="3980400">,</span>&nbsp;<span class="ident" id="3980402">sv</span><span class="op" id="3980404">[</span><span class="ident" id="3980405">i</span><span class="op" id="3980406">]</span>&nbsp;<span class="op" id="3980408">}</span><br>
<span class="lineno"></span><span class="keyword" id="3980410">func</span>&nbsp;<span class="op" id="3980415">(</span><span class="ident" id="3980416">sv</span>&nbsp;<span class="ident" id="3980419">stringValues</span><span class="op" id="3980431">)</span>&nbsp;<span class="ident" id="3980433">Less</span><span class="op" id="3980437">(</span><span class="ident" id="3980438">i</span><span class="op" id="3980439">,</span>&nbsp;<span class="ident" id="3980441">j</span>&nbsp;<span class="builtintype" id="3980443">int</span><span class="op" id="3980446">)</span>&nbsp;<span class="builtintype" id="3980448">bool</span>&nbsp;<span class="op" id="3980453">{</span>&nbsp;<span class="keyword" id="3980455">return</span>&nbsp;<span class="ident" id="3980462">sv</span><span class="op" id="3980464">.</span><span class="ident" id="3980465">get</span><span class="op" id="3980468">(</span><span class="ident" id="3980469">i</span><span class="op" id="3980470">)</span>&nbsp;<span class="op" id="3980472">&lt;</span>&nbsp;<span class="ident" id="3980474">sv</span><span class="op" id="3980476">.</span><span class="ident" id="3980477">get</span><span class="op" id="3980480">(</span><span class="ident" id="3980481">j</span><span class="op" id="3980482">)</span>&nbsp;<span class="op" id="3980484">}</span><br>
<span class="lineno"></span><span class="keyword" id="3980486">func</span>&nbsp;<span class="op" id="3980491">(</span><span class="ident" id="3980492">sv</span>&nbsp;<span class="ident" id="3980495">stringValues</span><span class="op" id="3980507">)</span>&nbsp;<span class="ident" id="3980509">get</span><span class="op" id="3980512">(</span><span class="ident" id="3980513">i</span>&nbsp;<span class="builtintype" id="3980515">int</span><span class="op" id="3980518">)</span>&nbsp;<span class="builtintype" id="3980520">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3980529">{</span>&nbsp;<span class="keyword" id="3980531">return</span>&nbsp;<span class="ident" id="3980538">sv</span><span class="op" id="3980540">[</span><span class="ident" id="3980541">i</span><span class="op" id="3980542">]</span><span class="op" id="3980543">.</span><span class="ident" id="3980544">String</span><span class="op" id="3980550">(</span><span class="op" id="3980551">)</span>&nbsp;<span class="op" id="3980553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3980556">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="3980602">func</span>&nbsp;<span class="op" id="3980607">(</span><span class="ident" id="3980608">e</span>&nbsp;<span class="op" id="3980610">*</span><span class="ident" id="3980611">encodeState</span><span class="op" id="3980622">)</span>&nbsp;<span class="builtintype" id="3980624">string</span><span class="op" id="3980630">(</span><span class="ident" id="3980631">s</span>&nbsp;<span class="builtintype" id="3980633">string</span><span class="op" id="3980639">)</span>&nbsp;<span class="op" id="3980641">(</span><span class="builtintype" id="3980642">int</span><span class="op" id="3980645">,</span>&nbsp;<span class="builtintype" id="3980647">error</span><span class="op" id="3980652">)</span>&nbsp;<span class="op" id="3980654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980657">len0</span>&nbsp;<span class="op" id="3980662">:=</span>&nbsp;<span class="ident" id="3980665">e</span><span class="op" id="3980666">.</span><span class="ident" id="3980667">Len</span><span class="op" id="3980670">(</span><span class="op" id="3980671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980674">e</span><span class="op" id="3980675">.</span><span class="ident" id="3980676">WriteByte</span><span class="op" id="3980685">(</span><span class="string" id="3980686">&#39;&#34;&#39;</span><span class="op" id="3980689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980692">start</span>&nbsp;<span class="op" id="3980698">:=</span>&nbsp;<span class="num" id="3980701">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980704">for</span>&nbsp;<span class="ident" id="3980708">i</span>&nbsp;<span class="op" id="3980710">:=</span>&nbsp;<span class="num" id="3980713">0</span><span class="op" id="3980714">;</span>&nbsp;<span class="ident" id="3980716">i</span>&nbsp;<span class="op" id="3980718">&lt;</span>&nbsp;<span class="builtinfunc" id="3980720">len</span><span class="op" id="3980723">(</span><span class="ident" id="3980724">s</span><span class="op" id="3980725">)</span><span class="op" id="3980726">;</span>&nbsp;<span class="op" id="3980728">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980732">if</span>&nbsp;<span class="ident" id="3980735">b</span>&nbsp;<span class="op" id="3980737">:=</span>&nbsp;<span class="ident" id="3980740">s</span><span class="op" id="3980741">[</span><span class="ident" id="3980742">i</span><span class="op" id="3980743">]</span><span class="op" id="3980744">;</span>&nbsp;<span class="ident" id="3980746">b</span>&nbsp;<span class="op" id="3980748">&lt;</span>&nbsp;<span class="ident" id="3980750">utf8</span><span class="op" id="3980754">.</span><span class="ident" id="3980755">RuneSelf</span>&nbsp;<span class="op" id="3980764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980769">if</span>&nbsp;<span class="num" id="3980772">0x20</span>&nbsp;<span class="op" id="3980777">&lt;=</span>&nbsp;<span class="ident" id="3980780">b</span>&nbsp;<span class="op" id="3980782">&amp;&amp;</span>&nbsp;<span class="ident" id="3980785">b</span>&nbsp;<span class="op" id="3980787">!=</span>&nbsp;<span class="string" id="3980790">&#39;\\&#39;</span>&nbsp;<span class="op" id="3980795">&amp;&amp;</span>&nbsp;<span class="ident" id="3980798">b</span>&nbsp;<span class="op" id="3980800">!=</span>&nbsp;<span class="string" id="3980803">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="3980807">&amp;&amp;</span>&nbsp;<span class="ident" id="3980810">b</span>&nbsp;<span class="op" id="3980812">!=</span>&nbsp;<span class="string" id="3980815">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3980819">&amp;&amp;</span>&nbsp;<span class="ident" id="3980822">b</span>&nbsp;<span class="op" id="3980824">!=</span>&nbsp;<span class="string" id="3980827">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3980831">&amp;&amp;</span>&nbsp;<span class="ident" id="3980834">b</span>&nbsp;<span class="op" id="3980836">!=</span>&nbsp;<span class="string" id="3980839">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3980843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980849">i</span><span class="op" id="3980850">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980857">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980869">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980874">if</span>&nbsp;<span class="ident" id="3980877">start</span>&nbsp;<span class="op" id="3980883">&lt;</span>&nbsp;<span class="ident" id="3980885">i</span>&nbsp;<span class="op" id="3980887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980893">e</span><span class="op" id="3980894">.</span><span class="ident" id="3980895">WriteString</span><span class="op" id="3980906">(</span><span class="ident" id="3980907">s</span><span class="op" id="3980908">[</span><span class="ident" id="3980909">start</span><span class="op" id="3980914">:</span><span class="ident" id="3980915">i</span><span class="op" id="3980916">]</span><span class="op" id="3980917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980927">switch</span>&nbsp;<span class="ident" id="3980934">b</span>&nbsp;<span class="op" id="3980936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980941">case</span>&nbsp;<span class="string" id="3980946">&#39;\\&#39;</span><span class="op" id="3980950">,</span>&nbsp;<span class="string" id="3980952">&#39;&#34;&#39;</span><span class="op" id="3980955">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980961">e</span><span class="op" id="3980962">.</span><span class="ident" id="3980963">WriteByte</span><span class="op" id="3980972">(</span><span class="string" id="3980973">&#39;\\&#39;</span><span class="op" id="3980977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980983">e</span><span class="op" id="3980984">.</span><span class="ident" id="3980985">WriteByte</span><span class="op" id="3980994">(</span><span class="ident" id="3980995">b</span><span class="op" id="3980996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981001">case</span>&nbsp;<span class="string" id="3981006">&#39;\n&#39;</span><span class="op" id="3981010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981016">e</span><span class="op" id="3981017">.</span><span class="ident" id="3981018">WriteByte</span><span class="op" id="3981027">(</span><span class="string" id="3981028">&#39;\\&#39;</span><span class="op" id="3981032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981038">e</span><span class="op" id="3981039">.</span><span class="ident" id="3981040">WriteByte</span><span class="op" id="3981049">(</span><span class="string" id="3981050">&#39;n&#39;</span><span class="op" id="3981053">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981058">case</span>&nbsp;<span class="string" id="3981063">&#39;\r&#39;</span><span class="op" id="3981067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981073">e</span><span class="op" id="3981074">.</span><span class="ident" id="3981075">WriteByte</span><span class="op" id="3981084">(</span><span class="string" id="3981085">&#39;\\&#39;</span><span class="op" id="3981089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981095">e</span><span class="op" id="3981096">.</span><span class="ident" id="3981097">WriteByte</span><span class="op" id="3981106">(</span><span class="string" id="3981107">&#39;r&#39;</span><span class="op" id="3981110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981115">case</span>&nbsp;<span class="string" id="3981120">&#39;\t&#39;</span><span class="op" id="3981124">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981130">e</span><span class="op" id="3981131">.</span><span class="ident" id="3981132">WriteByte</span><span class="op" id="3981141">(</span><span class="string" id="3981142">&#39;\\&#39;</span><span class="op" id="3981146">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981152">e</span><span class="op" id="3981153">.</span><span class="ident" id="3981154">WriteByte</span><span class="op" id="3981163">(</span><span class="string" id="3981164">&#39;t&#39;</span><span class="op" id="3981167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981172">default</span><span class="op" id="3981179">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981185">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981240">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981306">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981369">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981428">e</span><span class="op" id="3981429">.</span><span class="ident" id="3981430">WriteString</span><span class="op" id="3981441">(</span><span class="string" id="3981442">`\u00`</span><span class="op" id="3981448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981454">e</span><span class="op" id="3981455">.</span><span class="ident" id="3981456">WriteByte</span><span class="op" id="3981465">(</span><span class="ident" id="3981466">hex</span><span class="op" id="3981469">[</span><span class="ident" id="3981470">b</span><span class="op" id="3981471">&gt;&gt;</span><span class="num" id="3981473">4</span><span class="op" id="3981474">]</span><span class="op" id="3981475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981481">e</span><span class="op" id="3981482">.</span><span class="ident" id="3981483">WriteByte</span><span class="op" id="3981492">(</span><span class="ident" id="3981493">hex</span><span class="op" id="3981496">[</span><span class="ident" id="3981497">b</span><span class="op" id="3981498">&amp;</span><span class="num" id="3981499">0xF</span><span class="op" id="3981502">]</span><span class="op" id="3981503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981508">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981513">i</span><span class="op" id="3981514">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981520">start</span>&nbsp;<span class="op" id="3981526">=</span>&nbsp;<span class="ident" id="3981528">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981533">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981548">c</span><span class="op" id="3981549">,</span>&nbsp;<span class="ident" id="3981551">size</span>&nbsp;<span class="op" id="3981556">:=</span>&nbsp;<span class="ident" id="3981559">utf8</span><span class="op" id="3981563">.</span><span class="ident" id="3981564">DecodeRuneInString</span><span class="op" id="3981582">(</span><span class="ident" id="3981583">s</span><span class="op" id="3981584">[</span><span class="ident" id="3981585">i</span><span class="op" id="3981586">:</span><span class="op" id="3981587">]</span><span class="op" id="3981588">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981592">if</span>&nbsp;<span class="ident" id="3981595">c</span>&nbsp;<span class="op" id="3981597">==</span>&nbsp;<span class="ident" id="3981600">utf8</span><span class="op" id="3981604">.</span><span class="ident" id="3981605">RuneError</span>&nbsp;<span class="op" id="3981615">&amp;&amp;</span>&nbsp;<span class="ident" id="3981618">size</span>&nbsp;<span class="op" id="3981623">==</span>&nbsp;<span class="num" id="3981626">1</span>&nbsp;<span class="op" id="3981628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981633">if</span>&nbsp;<span class="ident" id="3981636">start</span>&nbsp;<span class="op" id="3981642">&lt;</span>&nbsp;<span class="ident" id="3981644">i</span>&nbsp;<span class="op" id="3981646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981652">e</span><span class="op" id="3981653">.</span><span class="ident" id="3981654">WriteString</span><span class="op" id="3981665">(</span><span class="ident" id="3981666">s</span><span class="op" id="3981667">[</span><span class="ident" id="3981668">start</span><span class="op" id="3981673">:</span><span class="ident" id="3981674">i</span><span class="op" id="3981675">]</span><span class="op" id="3981676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981686">e</span><span class="op" id="3981687">.</span><span class="ident" id="3981688">WriteString</span><span class="op" id="3981699">(</span><span class="string" id="3981700">`\ufffd`</span><span class="op" id="3981708">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981713">i</span>&nbsp;<span class="op" id="3981715">+=</span>&nbsp;<span class="ident" id="3981718">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981726">start</span>&nbsp;<span class="op" id="3981732">=</span>&nbsp;<span class="ident" id="3981734">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981739">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981754">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981785">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981821">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981886">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981957">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3982020">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3982067">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982146">if</span>&nbsp;<span class="ident" id="3982149">c</span>&nbsp;<span class="op" id="3982151">==</span>&nbsp;<span class="string" id="3982154">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="3982163">||</span>&nbsp;<span class="ident" id="3982166">c</span>&nbsp;<span class="op" id="3982168">==</span>&nbsp;<span class="string" id="3982171">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="3982180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982185">if</span>&nbsp;<span class="ident" id="3982188">start</span>&nbsp;<span class="op" id="3982194">&lt;</span>&nbsp;<span class="ident" id="3982196">i</span>&nbsp;<span class="op" id="3982198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982204">e</span><span class="op" id="3982205">.</span><span class="ident" id="3982206">WriteString</span><span class="op" id="3982217">(</span><span class="ident" id="3982218">s</span><span class="op" id="3982219">[</span><span class="ident" id="3982220">start</span><span class="op" id="3982225">:</span><span class="ident" id="3982226">i</span><span class="op" id="3982227">]</span><span class="op" id="3982228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982233">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982238">e</span><span class="op" id="3982239">.</span><span class="ident" id="3982240">WriteString</span><span class="op" id="3982251">(</span><span class="string" id="3982252">`\u202`</span><span class="op" id="3982259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982264">e</span><span class="op" id="3982265">.</span><span class="ident" id="3982266">WriteByte</span><span class="op" id="3982275">(</span><span class="ident" id="3982276">hex</span><span class="op" id="3982279">[</span><span class="ident" id="3982280">c</span><span class="op" id="3982281">&amp;</span><span class="num" id="3982282">0xF</span><span class="op" id="3982285">]</span><span class="op" id="3982286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982291">i</span>&nbsp;<span class="op" id="3982293">+=</span>&nbsp;<span class="ident" id="3982296">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982304">start</span>&nbsp;<span class="op" id="3982310">=</span>&nbsp;<span class="ident" id="3982312">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982317">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982332">i</span>&nbsp;<span class="op" id="3982334">+=</span>&nbsp;<span class="ident" id="3982337">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982346">if</span>&nbsp;<span class="ident" id="3982349">start</span>&nbsp;<span class="op" id="3982355">&lt;</span>&nbsp;<span class="builtinfunc" id="3982357">len</span><span class="op" id="3982360">(</span><span class="ident" id="3982361">s</span><span class="op" id="3982362">)</span>&nbsp;<span class="op" id="3982364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982368">e</span><span class="op" id="3982369">.</span><span class="ident" id="3982370">WriteString</span><span class="op" id="3982381">(</span><span class="ident" id="3982382">s</span><span class="op" id="3982383">[</span><span class="ident" id="3982384">start</span><span class="op" id="3982389">:</span><span class="op" id="3982390">]</span><span class="op" id="3982391">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982397">e</span><span class="op" id="3982398">.</span><span class="ident" id="3982399">WriteByte</span><span class="op" id="3982408">(</span><span class="string" id="3982409">&#39;&#34;&#39;</span><span class="op" id="3982412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982415">return</span>&nbsp;<span class="ident" id="3982422">e</span><span class="op" id="3982423">.</span><span class="ident" id="3982424">Len</span><span class="op" id="3982427">(</span><span class="op" id="3982428">)</span>&nbsp;<span class="op" id="3982430">-</span>&nbsp;<span class="ident" id="3982432">len0</span><span class="op" id="3982436">,</span>&nbsp;<span class="ident" id="3982438">nil</span><br>
<span class="lineno"></span><span class="op" id="3982442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="3982445">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="3982486">func</span>&nbsp;<span class="op" id="3982491">(</span><span class="ident" id="3982492">e</span>&nbsp;<span class="op" id="3982494">*</span><span class="ident" id="3982495">encodeState</span><span class="op" id="3982506">)</span>&nbsp;<span class="ident" id="3982508">stringBytes</span><span class="op" id="3982519">(</span><span class="ident" id="3982520">s</span>&nbsp;<span class="op" id="3982522">[</span><span class="op" id="3982523">]</span><span class="builtintype" id="3982524">byte</span><span class="op" id="3982528">)</span>&nbsp;<span class="op" id="3982530">(</span><span class="builtintype" id="3982531">int</span><span class="op" id="3982534">,</span>&nbsp;<span class="builtintype" id="3982536">error</span><span class="op" id="3982541">)</span>&nbsp;<span class="op" id="3982543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982546">len0</span>&nbsp;<span class="op" id="3982551">:=</span>&nbsp;<span class="ident" id="3982554">e</span><span class="op" id="3982555">.</span><span class="ident" id="3982556">Len</span><span class="op" id="3982559">(</span><span class="op" id="3982560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982563">e</span><span class="op" id="3982564">.</span><span class="ident" id="3982565">WriteByte</span><span class="op" id="3982574">(</span><span class="string" id="3982575">&#39;&#34;&#39;</span><span class="op" id="3982578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982581">start</span>&nbsp;<span class="op" id="3982587">:=</span>&nbsp;<span class="num" id="3982590">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982593">for</span>&nbsp;<span class="ident" id="3982597">i</span>&nbsp;<span class="op" id="3982599">:=</span>&nbsp;<span class="num" id="3982602">0</span><span class="op" id="3982603">;</span>&nbsp;<span class="ident" id="3982605">i</span>&nbsp;<span class="op" id="3982607">&lt;</span>&nbsp;<span class="builtinfunc" id="3982609">len</span><span class="op" id="3982612">(</span><span class="ident" id="3982613">s</span><span class="op" id="3982614">)</span><span class="op" id="3982615">;</span>&nbsp;<span class="op" id="3982617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982621">if</span>&nbsp;<span class="ident" id="3982624">b</span>&nbsp;<span class="op" id="3982626">:=</span>&nbsp;<span class="ident" id="3982629">s</span><span class="op" id="3982630">[</span><span class="ident" id="3982631">i</span><span class="op" id="3982632">]</span><span class="op" id="3982633">;</span>&nbsp;<span class="ident" id="3982635">b</span>&nbsp;<span class="op" id="3982637">&lt;</span>&nbsp;<span class="ident" id="3982639">utf8</span><span class="op" id="3982643">.</span><span class="ident" id="3982644">RuneSelf</span>&nbsp;<span class="op" id="3982653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982658">if</span>&nbsp;<span class="num" id="3982661">0x20</span>&nbsp;<span class="op" id="3982666">&lt;=</span>&nbsp;<span class="ident" id="3982669">b</span>&nbsp;<span class="op" id="3982671">&amp;&amp;</span>&nbsp;<span class="ident" id="3982674">b</span>&nbsp;<span class="op" id="3982676">!=</span>&nbsp;<span class="string" id="3982679">&#39;\\&#39;</span>&nbsp;<span class="op" id="3982684">&amp;&amp;</span>&nbsp;<span class="ident" id="3982687">b</span>&nbsp;<span class="op" id="3982689">!=</span>&nbsp;<span class="string" id="3982692">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="3982696">&amp;&amp;</span>&nbsp;<span class="ident" id="3982699">b</span>&nbsp;<span class="op" id="3982701">!=</span>&nbsp;<span class="string" id="3982704">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3982708">&amp;&amp;</span>&nbsp;<span class="ident" id="3982711">b</span>&nbsp;<span class="op" id="3982713">!=</span>&nbsp;<span class="string" id="3982716">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3982720">&amp;&amp;</span>&nbsp;<span class="ident" id="3982723">b</span>&nbsp;<span class="op" id="3982725">!=</span>&nbsp;<span class="string" id="3982728">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3982732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982738">i</span><span class="op" id="3982739">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982746">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982763">if</span>&nbsp;<span class="ident" id="3982766">start</span>&nbsp;<span class="op" id="3982772">&lt;</span>&nbsp;<span class="ident" id="3982774">i</span>&nbsp;<span class="op" id="3982776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982782">e</span><span class="op" id="3982783">.</span><span class="ident" id="3982784">Write</span><span class="op" id="3982789">(</span><span class="ident" id="3982790">s</span><span class="op" id="3982791">[</span><span class="ident" id="3982792">start</span><span class="op" id="3982797">:</span><span class="ident" id="3982798">i</span><span class="op" id="3982799">]</span><span class="op" id="3982800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982810">switch</span>&nbsp;<span class="ident" id="3982817">b</span>&nbsp;<span class="op" id="3982819">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982824">case</span>&nbsp;<span class="string" id="3982829">&#39;\\&#39;</span><span class="op" id="3982833">,</span>&nbsp;<span class="string" id="3982835">&#39;&#34;&#39;</span><span class="op" id="3982838">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982844">e</span><span class="op" id="3982845">.</span><span class="ident" id="3982846">WriteByte</span><span class="op" id="3982855">(</span><span class="string" id="3982856">&#39;\\&#39;</span><span class="op" id="3982860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982866">e</span><span class="op" id="3982867">.</span><span class="ident" id="3982868">WriteByte</span><span class="op" id="3982877">(</span><span class="ident" id="3982878">b</span><span class="op" id="3982879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982884">case</span>&nbsp;<span class="string" id="3982889">&#39;\n&#39;</span><span class="op" id="3982893">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982899">e</span><span class="op" id="3982900">.</span><span class="ident" id="3982901">WriteByte</span><span class="op" id="3982910">(</span><span class="string" id="3982911">&#39;\\&#39;</span><span class="op" id="3982915">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982921">e</span><span class="op" id="3982922">.</span><span class="ident" id="3982923">WriteByte</span><span class="op" id="3982932">(</span><span class="string" id="3982933">&#39;n&#39;</span><span class="op" id="3982936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982941">case</span>&nbsp;<span class="string" id="3982946">&#39;\r&#39;</span><span class="op" id="3982950">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982956">e</span><span class="op" id="3982957">.</span><span class="ident" id="3982958">WriteByte</span><span class="op" id="3982967">(</span><span class="string" id="3982968">&#39;\\&#39;</span><span class="op" id="3982972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982978">e</span><span class="op" id="3982979">.</span><span class="ident" id="3982980">WriteByte</span><span class="op" id="3982989">(</span><span class="string" id="3982990">&#39;r&#39;</span><span class="op" id="3982993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982998">case</span>&nbsp;<span class="string" id="3983003">&#39;\t&#39;</span><span class="op" id="3983007">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983013">e</span><span class="op" id="3983014">.</span><span class="ident" id="3983015">WriteByte</span><span class="op" id="3983024">(</span><span class="string" id="3983025">&#39;\\&#39;</span><span class="op" id="3983029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983035">e</span><span class="op" id="3983036">.</span><span class="ident" id="3983037">WriteByte</span><span class="op" id="3983046">(</span><span class="string" id="3983047">&#39;t&#39;</span><span class="op" id="3983050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983055">default</span><span class="op" id="3983062">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983068">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983123">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983190">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983253">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983312">e</span><span class="op" id="3983313">.</span><span class="ident" id="3983314">WriteString</span><span class="op" id="3983325">(</span><span class="string" id="3983326">`\u00`</span><span class="op" id="3983332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983338">e</span><span class="op" id="3983339">.</span><span class="ident" id="3983340">WriteByte</span><span class="op" id="3983349">(</span><span class="ident" id="3983350">hex</span><span class="op" id="3983353">[</span><span class="ident" id="3983354">b</span><span class="op" id="3983355">&gt;&gt;</span><span class="num" id="3983357">4</span><span class="op" id="3983358">]</span><span class="op" id="3983359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983365">e</span><span class="op" id="3983366">.</span><span class="ident" id="3983367">WriteByte</span><span class="op" id="3983376">(</span><span class="ident" id="3983377">hex</span><span class="op" id="3983380">[</span><span class="ident" id="3983381">b</span><span class="op" id="3983382">&amp;</span><span class="num" id="3983383">0xF</span><span class="op" id="3983386">]</span><span class="op" id="3983387">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983397">i</span><span class="op" id="3983398">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983404">start</span>&nbsp;<span class="op" id="3983410">=</span>&nbsp;<span class="ident" id="3983412">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983417">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983428">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983432">c</span><span class="op" id="3983433">,</span>&nbsp;<span class="ident" id="3983435">size</span>&nbsp;<span class="op" id="3983440">:=</span>&nbsp;<span class="ident" id="3983443">utf8</span><span class="op" id="3983447">.</span><span class="ident" id="3983448">DecodeRune</span><span class="op" id="3983458">(</span><span class="ident" id="3983459">s</span><span class="op" id="3983460">[</span><span class="ident" id="3983461">i</span><span class="op" id="3983462">:</span><span class="op" id="3983463">]</span><span class="op" id="3983464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983468">if</span>&nbsp;<span class="ident" id="3983471">c</span>&nbsp;<span class="op" id="3983473">==</span>&nbsp;<span class="ident" id="3983476">utf8</span><span class="op" id="3983480">.</span><span class="ident" id="3983481">RuneError</span>&nbsp;<span class="op" id="3983491">&amp;&amp;</span>&nbsp;<span class="ident" id="3983494">size</span>&nbsp;<span class="op" id="3983499">==</span>&nbsp;<span class="num" id="3983502">1</span>&nbsp;<span class="op" id="3983504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983509">if</span>&nbsp;<span class="ident" id="3983512">start</span>&nbsp;<span class="op" id="3983518">&lt;</span>&nbsp;<span class="ident" id="3983520">i</span>&nbsp;<span class="op" id="3983522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983528">e</span><span class="op" id="3983529">.</span><span class="ident" id="3983530">Write</span><span class="op" id="3983535">(</span><span class="ident" id="3983536">s</span><span class="op" id="3983537">[</span><span class="ident" id="3983538">start</span><span class="op" id="3983543">:</span><span class="ident" id="3983544">i</span><span class="op" id="3983545">]</span><span class="op" id="3983546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983551">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983556">e</span><span class="op" id="3983557">.</span><span class="ident" id="3983558">WriteString</span><span class="op" id="3983569">(</span><span class="string" id="3983570">`\ufffd`</span><span class="op" id="3983578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983583">i</span>&nbsp;<span class="op" id="3983585">+=</span>&nbsp;<span class="ident" id="3983588">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983596">start</span>&nbsp;<span class="op" id="3983602">=</span>&nbsp;<span class="ident" id="3983604">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983609">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983620">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983624">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983655">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983691">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983756">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983827">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983890">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983937">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984016">if</span>&nbsp;<span class="ident" id="3984019">c</span>&nbsp;<span class="op" id="3984021">==</span>&nbsp;<span class="string" id="3984024">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="3984033">||</span>&nbsp;<span class="ident" id="3984036">c</span>&nbsp;<span class="op" id="3984038">==</span>&nbsp;<span class="string" id="3984041">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="3984050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984055">if</span>&nbsp;<span class="ident" id="3984058">start</span>&nbsp;<span class="op" id="3984064">&lt;</span>&nbsp;<span class="ident" id="3984066">i</span>&nbsp;<span class="op" id="3984068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984074">e</span><span class="op" id="3984075">.</span><span class="ident" id="3984076">Write</span><span class="op" id="3984081">(</span><span class="ident" id="3984082">s</span><span class="op" id="3984083">[</span><span class="ident" id="3984084">start</span><span class="op" id="3984089">:</span><span class="ident" id="3984090">i</span><span class="op" id="3984091">]</span><span class="op" id="3984092">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984102">e</span><span class="op" id="3984103">.</span><span class="ident" id="3984104">WriteString</span><span class="op" id="3984115">(</span><span class="string" id="3984116">`\u202`</span><span class="op" id="3984123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984128">e</span><span class="op" id="3984129">.</span><span class="ident" id="3984130">WriteByte</span><span class="op" id="3984139">(</span><span class="ident" id="3984140">hex</span><span class="op" id="3984143">[</span><span class="ident" id="3984144">c</span><span class="op" id="3984145">&amp;</span><span class="num" id="3984146">0xF</span><span class="op" id="3984149">]</span><span class="op" id="3984150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984155">i</span>&nbsp;<span class="op" id="3984157">+=</span>&nbsp;<span class="ident" id="3984160">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984168">start</span>&nbsp;<span class="op" id="3984174">=</span>&nbsp;<span class="ident" id="3984176">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984181">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984196">i</span>&nbsp;<span class="op" id="3984198">+=</span>&nbsp;<span class="ident" id="3984201">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984210">if</span>&nbsp;<span class="ident" id="3984213">start</span>&nbsp;<span class="op" id="3984219">&lt;</span>&nbsp;<span class="builtinfunc" id="3984221">len</span><span class="op" id="3984224">(</span><span class="ident" id="3984225">s</span><span class="op" id="3984226">)</span>&nbsp;<span class="op" id="3984228">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984232">e</span><span class="op" id="3984233">.</span><span class="ident" id="3984234">Write</span><span class="op" id="3984239">(</span><span class="ident" id="3984240">s</span><span class="op" id="3984241">[</span><span class="ident" id="3984242">start</span><span class="op" id="3984247">:</span><span class="op" id="3984248">]</span><span class="op" id="3984249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984255">e</span><span class="op" id="3984256">.</span><span class="ident" id="3984257">WriteByte</span><span class="op" id="3984266">(</span><span class="string" id="3984267">&#39;&#34;&#39;</span><span class="op" id="3984270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984273">return</span>&nbsp;<span class="ident" id="3984280">e</span><span class="op" id="3984281">.</span><span class="ident" id="3984282">Len</span><span class="op" id="3984285">(</span><span class="op" id="3984286">)</span>&nbsp;<span class="op" id="3984288">-</span>&nbsp;<span class="ident" id="3984290">len0</span><span class="op" id="3984294">,</span>&nbsp;<span class="ident" id="3984296">nil</span><br>
<span class="lineno"></span><span class="op" id="3984300">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="3984303">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="3984359">type</span>&nbsp;<span class="ident" id="3984364">field</span>&nbsp;<span class="keyword" id="3984370">struct</span>&nbsp;<span class="op" id="3984377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984380">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3984390">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984398">nameBytes</span>&nbsp;<span class="op" id="3984408">[</span><span class="op" id="3984409">]</span><span class="builtintype" id="3984410">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3984431">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984448">equalFold</span>&nbsp;<span class="keyword" id="3984458">func</span><span class="op" id="3984462">(</span><span class="ident" id="3984463">s</span><span class="op" id="3984464">,</span>&nbsp;<span class="ident" id="3984466">t</span>&nbsp;<span class="op" id="3984468">[</span><span class="op" id="3984469">]</span><span class="builtintype" id="3984470">byte</span><span class="op" id="3984474">)</span>&nbsp;<span class="builtintype" id="3984476">bool</span>&nbsp;<span class="comment" id="3984481">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984516">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3984526">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984532">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984542">[</span><span class="op" id="3984543">]</span><span class="builtintype" id="3984544">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984549">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984559">reflect</span><span class="op" id="3984566">.</span><span class="ident" id="3984567">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984573">omitEmpty</span>&nbsp;<span class="builtintype" id="3984583">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984589">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3984599">bool</span><br>
<span class="lineno"></span><span class="op" id="3984604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3984607">func</span>&nbsp;<span class="ident" id="3984612">fillField</span><span class="op" id="3984621">(</span><span class="ident" id="3984622">f</span>&nbsp;<span class="ident" id="3984624">field</span><span class="op" id="3984629">)</span>&nbsp;<span class="ident" id="3984631">field</span>&nbsp;<span class="op" id="3984637">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984640">f</span><span class="op" id="3984641">.</span><span class="ident" id="3984642">nameBytes</span>&nbsp;<span class="op" id="3984652">=</span>&nbsp;<span class="op" id="3984654">[</span><span class="op" id="3984655">]</span><span class="builtintype" id="3984656">byte</span><span class="op" id="3984660">(</span><span class="ident" id="3984661">f</span><span class="op" id="3984662">.</span><span class="ident" id="3984663">name</span><span class="op" id="3984667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984670">f</span><span class="op" id="3984671">.</span><span class="ident" id="3984672">equalFold</span>&nbsp;<span class="op" id="3984682">=</span>&nbsp;<span class="ident" id="3984684">foldFunc</span><span class="op" id="3984692">(</span><span class="ident" id="3984693">f</span><span class="op" id="3984694">.</span><span class="ident" id="3984695">nameBytes</span><span class="op" id="3984704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984707">return</span>&nbsp;<span class="ident" id="3984714">f</span><br>
<span class="lineno"></span><span class="op" id="3984716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="3984719">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="3984776">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3984835">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="3984873">type</span>&nbsp;<span class="ident" id="3984878">byName</span>&nbsp;<span class="op" id="3984885">[</span><span class="op" id="3984886">]</span><span class="ident" id="3984887">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="3984894">func</span>&nbsp;<span class="op" id="3984899">(</span><span class="ident" id="3984900">x</span>&nbsp;<span class="ident" id="3984902">byName</span><span class="op" id="3984908">)</span>&nbsp;<span class="ident" id="3984910">Len</span><span class="op" id="3984913">(</span><span class="op" id="3984914">)</span>&nbsp;<span class="builtintype" id="3984916">int</span>&nbsp;<span class="op" id="3984920">{</span>&nbsp;<span class="keyword" id="3984922">return</span>&nbsp;<span class="builtinfunc" id="3984929">len</span><span class="op" id="3984932">(</span><span class="ident" id="3984933">x</span><span class="op" id="3984934">)</span>&nbsp;<span class="op" id="3984936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3984939">func</span>&nbsp;<span class="op" id="3984944">(</span><span class="ident" id="3984945">x</span>&nbsp;<span class="ident" id="3984947">byName</span><span class="op" id="3984953">)</span>&nbsp;<span class="ident" id="3984955">Swap</span><span class="op" id="3984959">(</span><span class="ident" id="3984960">i</span><span class="op" id="3984961">,</span>&nbsp;<span class="ident" id="3984963">j</span>&nbsp;<span class="builtintype" id="3984965">int</span><span class="op" id="3984968">)</span>&nbsp;<span class="op" id="3984970">{</span>&nbsp;<span class="ident" id="3984972">x</span><span class="op" id="3984973">[</span><span class="ident" id="3984974">i</span><span class="op" id="3984975">]</span><span class="op" id="3984976">,</span>&nbsp;<span class="ident" id="3984978">x</span><span class="op" id="3984979">[</span><span class="ident" id="3984980">j</span><span class="op" id="3984981">]</span>&nbsp;<span class="op" id="3984983">=</span>&nbsp;<span class="ident" id="3984985">x</span><span class="op" id="3984986">[</span><span class="ident" id="3984987">j</span><span class="op" id="3984988">]</span><span class="op" id="3984989">,</span>&nbsp;<span class="ident" id="3984991">x</span><span class="op" id="3984992">[</span><span class="ident" id="3984993">i</span><span class="op" id="3984994">]</span>&nbsp;<span class="op" id="3984996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3984999">func</span>&nbsp;<span class="op" id="3985004">(</span><span class="ident" id="3985005">x</span>&nbsp;<span class="ident" id="3985007">byName</span><span class="op" id="3985013">)</span>&nbsp;<span class="ident" id="3985015">Less</span><span class="op" id="3985019">(</span><span class="ident" id="3985020">i</span><span class="op" id="3985021">,</span>&nbsp;<span class="ident" id="3985023">j</span>&nbsp;<span class="builtintype" id="3985025">int</span><span class="op" id="3985028">)</span>&nbsp;<span class="builtintype" id="3985030">bool</span>&nbsp;<span class="op" id="3985035">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985038">if</span>&nbsp;<span class="ident" id="3985041">x</span><span class="op" id="3985042">[</span><span class="ident" id="3985043">i</span><span class="op" id="3985044">]</span><span class="op" id="3985045">.</span><span class="ident" id="3985046">name</span>&nbsp;<span class="op" id="3985051">!=</span>&nbsp;<span class="ident" id="3985054">x</span><span class="op" id="3985055">[</span><span class="ident" id="3985056">j</span><span class="op" id="3985057">]</span><span class="op" id="3985058">.</span><span class="ident" id="3985059">name</span>&nbsp;<span class="op" id="3985064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985068">return</span>&nbsp;<span class="ident" id="3985075">x</span><span class="op" id="3985076">[</span><span class="ident" id="3985077">i</span><span class="op" id="3985078">]</span><span class="op" id="3985079">.</span><span class="ident" id="3985080">name</span>&nbsp;<span class="op" id="3985085">&lt;</span>&nbsp;<span class="ident" id="3985087">x</span><span class="op" id="3985088">[</span><span class="ident" id="3985089">j</span><span class="op" id="3985090">]</span><span class="op" id="3985091">.</span><span class="ident" id="3985092">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985101">if</span>&nbsp;<span class="builtinfunc" id="3985104">len</span><span class="op" id="3985107">(</span><span class="ident" id="3985108">x</span><span class="op" id="3985109">[</span><span class="ident" id="3985110">i</span><span class="op" id="3985111">]</span><span class="op" id="3985112">.</span><span class="ident" id="3985113">index</span><span class="op" id="3985118">)</span>&nbsp;<span class="op" id="3985120">!=</span>&nbsp;<span class="builtinfunc" id="3985123">len</span><span class="op" id="3985126">(</span><span class="ident" id="3985127">x</span><span class="op" id="3985128">[</span><span class="ident" id="3985129">j</span><span class="op" id="3985130">]</span><span class="op" id="3985131">.</span><span class="ident" id="3985132">index</span><span class="op" id="3985137">)</span>&nbsp;<span class="op" id="3985139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985143">return</span>&nbsp;<span class="builtinfunc" id="3985150">len</span><span class="op" id="3985153">(</span><span class="ident" id="3985154">x</span><span class="op" id="3985155">[</span><span class="ident" id="3985156">i</span><span class="op" id="3985157">]</span><span class="op" id="3985158">.</span><span class="ident" id="3985159">index</span><span class="op" id="3985164">)</span>&nbsp;<span class="op" id="3985166">&lt;</span>&nbsp;<span class="builtinfunc" id="3985168">len</span><span class="op" id="3985171">(</span><span class="ident" id="3985172">x</span><span class="op" id="3985173">[</span><span class="ident" id="3985174">j</span><span class="op" id="3985175">]</span><span class="op" id="3985176">.</span><span class="ident" id="3985177">index</span><span class="op" id="3985182">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985188">if</span>&nbsp;<span class="ident" id="3985191">x</span><span class="op" id="3985192">[</span><span class="ident" id="3985193">i</span><span class="op" id="3985194">]</span><span class="op" id="3985195">.</span><span class="ident" id="3985196">tag</span>&nbsp;<span class="op" id="3985200">!=</span>&nbsp;<span class="ident" id="3985203">x</span><span class="op" id="3985204">[</span><span class="ident" id="3985205">j</span><span class="op" id="3985206">]</span><span class="op" id="3985207">.</span><span class="ident" id="3985208">tag</span>&nbsp;<span class="op" id="3985212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985216">return</span>&nbsp;<span class="ident" id="3985223">x</span><span class="op" id="3985224">[</span><span class="ident" id="3985225">i</span><span class="op" id="3985226">]</span><span class="op" id="3985227">.</span><span class="ident" id="3985228">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985236">return</span>&nbsp;<span class="ident" id="3985243">byIndex</span><span class="op" id="3985250">(</span><span class="ident" id="3985251">x</span><span class="op" id="3985252">)</span><span class="op" id="3985253">.</span><span class="ident" id="3985254">Less</span><span class="op" id="3985258">(</span><span class="ident" id="3985259">i</span><span class="op" id="3985260">,</span>&nbsp;<span class="ident" id="3985262">j</span><span class="op" id="3985263">)</span><br>
<span class="lineno">975</span><span class="op" id="3985265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3985268">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="3985310">type</span>&nbsp;<span class="ident" id="3985315">byIndex</span>&nbsp;<span class="op" id="3985323">[</span><span class="op" id="3985324">]</span><span class="ident" id="3985325">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3985332">func</span>&nbsp;<span class="op" id="3985337">(</span><span class="ident" id="3985338">x</span>&nbsp;<span class="ident" id="3985340">byIndex</span><span class="op" id="3985347">)</span>&nbsp;<span class="ident" id="3985349">Len</span><span class="op" id="3985352">(</span><span class="op" id="3985353">)</span>&nbsp;<span class="builtintype" id="3985355">int</span>&nbsp;<span class="op" id="3985359">{</span>&nbsp;<span class="keyword" id="3985361">return</span>&nbsp;<span class="builtinfunc" id="3985368">len</span><span class="op" id="3985371">(</span><span class="ident" id="3985372">x</span><span class="op" id="3985373">)</span>&nbsp;<span class="op" id="3985375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3985378">func</span>&nbsp;<span class="op" id="3985383">(</span><span class="ident" id="3985384">x</span>&nbsp;<span class="ident" id="3985386">byIndex</span><span class="op" id="3985393">)</span>&nbsp;<span class="ident" id="3985395">Swap</span><span class="op" id="3985399">(</span><span class="ident" id="3985400">i</span><span class="op" id="3985401">,</span>&nbsp;<span class="ident" id="3985403">j</span>&nbsp;<span class="builtintype" id="3985405">int</span><span class="op" id="3985408">)</span>&nbsp;<span class="op" id="3985410">{</span>&nbsp;<span class="ident" id="3985412">x</span><span class="op" id="3985413">[</span><span class="ident" id="3985414">i</span><span class="op" id="3985415">]</span><span class="op" id="3985416">,</span>&nbsp;<span class="ident" id="3985418">x</span><span class="op" id="3985419">[</span><span class="ident" id="3985420">j</span><span class="op" id="3985421">]</span>&nbsp;<span class="op" id="3985423">=</span>&nbsp;<span class="ident" id="3985425">x</span><span class="op" id="3985426">[</span><span class="ident" id="3985427">j</span><span class="op" id="3985428">]</span><span class="op" id="3985429">,</span>&nbsp;<span class="ident" id="3985431">x</span><span class="op" id="3985432">[</span><span class="ident" id="3985433">i</span><span class="op" id="3985434">]</span>&nbsp;<span class="op" id="3985436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3985439">func</span>&nbsp;<span class="op" id="3985444">(</span><span class="ident" id="3985445">x</span>&nbsp;<span class="ident" id="3985447">byIndex</span><span class="op" id="3985454">)</span>&nbsp;<span class="ident" id="3985456">Less</span><span class="op" id="3985460">(</span><span class="ident" id="3985461">i</span><span class="op" id="3985462">,</span>&nbsp;<span class="ident" id="3985464">j</span>&nbsp;<span class="builtintype" id="3985466">int</span><span class="op" id="3985469">)</span>&nbsp;<span class="builtintype" id="3985471">bool</span>&nbsp;<span class="op" id="3985476">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985479">for</span>&nbsp;<span class="ident" id="3985483">k</span><span class="op" id="3985484">,</span>&nbsp;<span class="ident" id="3985486">xik</span>&nbsp;<span class="op" id="3985490">:=</span>&nbsp;<span class="keyword" id="3985493">range</span>&nbsp;<span class="ident" id="3985499">x</span><span class="op" id="3985500">[</span><span class="ident" id="3985501">i</span><span class="op" id="3985502">]</span><span class="op" id="3985503">.</span><span class="ident" id="3985504">index</span>&nbsp;<span class="op" id="3985510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985514">if</span>&nbsp;<span class="ident" id="3985517">k</span>&nbsp;<span class="op" id="3985519">&gt;=</span>&nbsp;<span class="builtinfunc" id="3985522">len</span><span class="op" id="3985525">(</span><span class="ident" id="3985526">x</span><span class="op" id="3985527">[</span><span class="ident" id="3985528">j</span><span class="op" id="3985529">]</span><span class="op" id="3985530">.</span><span class="ident" id="3985531">index</span><span class="op" id="3985536">)</span>&nbsp;<span class="op" id="3985538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985543">return</span>&nbsp;<span class="builtintype" id="3985550">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985562">if</span>&nbsp;<span class="ident" id="3985565">xik</span>&nbsp;<span class="op" id="3985569">!=</span>&nbsp;<span class="ident" id="3985572">x</span><span class="op" id="3985573">[</span><span class="ident" id="3985574">j</span><span class="op" id="3985575">]</span><span class="op" id="3985576">.</span><span class="ident" id="3985577">index</span><span class="op" id="3985582">[</span><span class="ident" id="3985583">k</span><span class="op" id="3985584">]</span>&nbsp;<span class="op" id="3985586">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985591">return</span>&nbsp;<span class="ident" id="3985598">xik</span>&nbsp;<span class="op" id="3985602">&lt;</span>&nbsp;<span class="ident" id="3985604">x</span><span class="op" id="3985605">[</span><span class="ident" id="3985606">j</span><span class="op" id="3985607">]</span><span class="op" id="3985608">.</span><span class="ident" id="3985609">index</span><span class="op" id="3985614">[</span><span class="ident" id="3985615">k</span><span class="op" id="3985616">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985626">return</span>&nbsp;<span class="builtinfunc" id="3985633">len</span><span class="op" id="3985636">(</span><span class="ident" id="3985637">x</span><span class="op" id="3985638">[</span><span class="ident" id="3985639">i</span><span class="op" id="3985640">]</span><span class="op" id="3985641">.</span><span class="ident" id="3985642">index</span><span class="op" id="3985647">)</span>&nbsp;<span class="op" id="3985649">&lt;</span>&nbsp;<span class="builtinfunc" id="3985651">len</span><span class="op" id="3985654">(</span><span class="ident" id="3985655">x</span><span class="op" id="3985656">[</span><span class="ident" id="3985657">j</span><span class="op" id="3985658">]</span><span class="op" id="3985659">.</span><span class="ident" id="3985660">index</span><span class="op" id="3985665">)</span><br>
<span class="lineno"></span><span class="op" id="3985667">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="3985670">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3985756">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="3985849">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="3985894">func</span>&nbsp;<span class="ident" id="3985899">typeFields</span><span class="op" id="3985909">(</span><span class="ident" id="3985910">t</span>&nbsp;<span class="ident" id="3985912">reflect</span><span class="op" id="3985919">.</span><span class="ident" id="3985920">Type</span><span class="op" id="3985924">)</span>&nbsp;<span class="op" id="3985926">[</span><span class="op" id="3985927">]</span><span class="ident" id="3985928">field</span>&nbsp;<span class="op" id="3985934">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3985937">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986004">current</span>&nbsp;<span class="op" id="3986012">:=</span>&nbsp;<span class="op" id="3986015">[</span><span class="op" id="3986016">]</span><span class="ident" id="3986017">field</span><span class="op" id="3986022">{</span><span class="op" id="3986023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986026">next</span>&nbsp;<span class="op" id="3986031">:=</span>&nbsp;<span class="op" id="3986034">[</span><span class="op" id="3986035">]</span><span class="ident" id="3986036">field</span><span class="op" id="3986041">{</span><span class="op" id="3986042">{</span><span class="ident" id="3986043">typ</span><span class="op" id="3986046">:</span>&nbsp;<span class="ident" id="3986048">t</span><span class="op" id="3986049">}</span><span class="op" id="3986050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986054">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986112">count</span>&nbsp;<span class="op" id="3986118">:=</span>&nbsp;<span class="keyword" id="3986121">map</span><span class="op" id="3986124">[</span><span class="ident" id="3986125">reflect</span><span class="op" id="3986132">.</span><span class="ident" id="3986133">Type</span><span class="op" id="3986137">]</span><span class="builtintype" id="3986138">int</span><span class="op" id="3986141">{</span><span class="op" id="3986142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986145">nextCount</span>&nbsp;<span class="op" id="3986155">:=</span>&nbsp;<span class="keyword" id="3986158">map</span><span class="op" id="3986161">[</span><span class="ident" id="3986162">reflect</span><span class="op" id="3986169">.</span><span class="ident" id="3986170">Type</span><span class="op" id="3986174">]</span><span class="builtintype" id="3986175">int</span><span class="op" id="3986178">{</span><span class="op" id="3986179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986183">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986230">visited</span>&nbsp;<span class="op" id="3986238">:=</span>&nbsp;<span class="keyword" id="3986241">map</span><span class="op" id="3986244">[</span><span class="ident" id="3986245">reflect</span><span class="op" id="3986252">.</span><span class="ident" id="3986253">Type</span><span class="op" id="3986257">]</span><span class="builtintype" id="3986258">bool</span><span class="op" id="3986262">{</span><span class="op" id="3986263">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986267">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986285">var</span>&nbsp;<span class="ident" id="3986289">fields</span>&nbsp;<span class="op" id="3986296">[</span><span class="op" id="3986297">]</span><span class="ident" id="3986298">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986306">for</span>&nbsp;<span class="builtinfunc" id="3986310">len</span><span class="op" id="3986313">(</span><span class="ident" id="3986314">next</span><span class="op" id="3986318">)</span>&nbsp;<span class="op" id="3986320">&gt;</span>&nbsp;<span class="num" id="3986322">0</span>&nbsp;<span class="op" id="3986324">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986328">current</span><span class="op" id="3986335">,</span>&nbsp;<span class="ident" id="3986337">next</span>&nbsp;<span class="op" id="3986342">=</span>&nbsp;<span class="ident" id="3986344">next</span><span class="op" id="3986348">,</span>&nbsp;<span class="ident" id="3986350">current</span><span class="op" id="3986357">[</span><span class="op" id="3986358">:</span><span class="num" id="3986359">0</span><span class="op" id="3986360">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986364">count</span><span class="op" id="3986369">,</span>&nbsp;<span class="ident" id="3986371">nextCount</span>&nbsp;<span class="op" id="3986381">=</span>&nbsp;<span class="ident" id="3986383">nextCount</span><span class="op" id="3986392">,</span>&nbsp;<span class="keyword" id="3986394">map</span><span class="op" id="3986397">[</span><span class="ident" id="3986398">reflect</span><span class="op" id="3986405">.</span><span class="ident" id="3986406">Type</span><span class="op" id="3986410">]</span><span class="builtintype" id="3986411">int</span><span class="op" id="3986414">{</span><span class="op" id="3986415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986420">for</span>&nbsp;<span class="ident" id="3986424">_</span><span class="op" id="3986425">,</span>&nbsp;<span class="ident" id="3986427">f</span>&nbsp;<span class="op" id="3986429">:=</span>&nbsp;<span class="keyword" id="3986432">range</span>&nbsp;<span class="ident" id="3986438">current</span>&nbsp;<span class="op" id="3986446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986451">if</span>&nbsp;<span class="ident" id="3986454">visited</span><span class="op" id="3986461">[</span><span class="ident" id="3986462">f</span><span class="op" id="3986463">.</span><span class="ident" id="3986464">typ</span><span class="op" id="3986467">]</span>&nbsp;<span class="op" id="3986469">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986475">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986492">visited</span><span class="op" id="3986499">[</span><span class="ident" id="3986500">f</span><span class="op" id="3986501">.</span><span class="ident" id="3986502">typ</span><span class="op" id="3986505">]</span>&nbsp;<span class="op" id="3986507">=</span>&nbsp;<span class="builtintype" id="3986509">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986518">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986558">for</span>&nbsp;<span class="ident" id="3986562">i</span>&nbsp;<span class="op" id="3986564">:=</span>&nbsp;<span class="num" id="3986567">0</span><span class="op" id="3986568">;</span>&nbsp;<span class="ident" id="3986570">i</span>&nbsp;<span class="op" id="3986572">&lt;</span>&nbsp;<span class="ident" id="3986574">f</span><span class="op" id="3986575">.</span><span class="ident" id="3986576">typ</span><span class="op" id="3986579">.</span><span class="ident" id="3986580">NumField</span><span class="op" id="3986588">(</span><span class="op" id="3986589">)</span><span class="op" id="3986590">;</span>&nbsp;<span class="ident" id="3986592">i</span><span class="op" id="3986593">++</span>&nbsp;<span class="op" id="3986596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986602">sf</span>&nbsp;<span class="op" id="3986605">:=</span>&nbsp;<span class="ident" id="3986608">f</span><span class="op" id="3986609">.</span><span class="ident" id="3986610">typ</span><span class="op" id="3986613">.</span><span class="ident" id="3986614">Field</span><span class="op" id="3986619">(</span><span class="ident" id="3986620">i</span><span class="op" id="3986621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986627">if</span>&nbsp;<span class="ident" id="3986630">sf</span><span class="op" id="3986632">.</span><span class="ident" id="3986633">PkgPath</span>&nbsp;<span class="op" id="3986641">!=</span>&nbsp;<span class="string" id="3986644">&#34;&#34;</span>&nbsp;<span class="op" id="3986647">{</span>&nbsp;<span class="comment" id="3986649">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986668">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986681">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986687">tag</span>&nbsp;<span class="op" id="3986691">:=</span>&nbsp;<span class="ident" id="3986694">sf</span><span class="op" id="3986696">.</span><span class="ident" id="3986697">Tag</span><span class="op" id="3986700">.</span><span class="ident" id="3986701">Get</span><span class="op" id="3986704">(</span><span class="string" id="3986705">&#34;json&#34;</span><span class="op" id="3986711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986717">if</span>&nbsp;<span class="ident" id="3986720">tag</span>&nbsp;<span class="op" id="3986724">==</span>&nbsp;<span class="string" id="3986727">&#34;-&#34;</span>&nbsp;<span class="op" id="3986731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986738">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986757">name</span><span class="op" id="3986761">,</span>&nbsp;<span class="ident" id="3986763">opts</span>&nbsp;<span class="op" id="3986768">:=</span>&nbsp;<span class="ident" id="3986771">parseTag</span><span class="op" id="3986779">(</span><span class="ident" id="3986780">tag</span><span class="op" id="3986783">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986789">if</span>&nbsp;<span class="op" id="3986792">!</span><span class="ident" id="3986793">isValidTag</span><span class="op" id="3986803">(</span><span class="ident" id="3986804">name</span><span class="op" id="3986808">)</span>&nbsp;<span class="op" id="3986810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986817">name</span>&nbsp;<span class="op" id="3986822">=</span>&nbsp;<span class="string" id="3986824">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986837">index</span>&nbsp;<span class="op" id="3986843">:=</span>&nbsp;<span class="builtinfunc" id="3986846">make</span><span class="op" id="3986850">(</span><span class="op" id="3986851">[</span><span class="op" id="3986852">]</span><span class="builtintype" id="3986853">int</span><span class="op" id="3986856">,</span>&nbsp;<span class="builtinfunc" id="3986858">len</span><span class="op" id="3986861">(</span><span class="ident" id="3986862">f</span><span class="op" id="3986863">.</span><span class="ident" id="3986864">index</span><span class="op" id="3986869">)</span><span class="op" id="3986870">+</span><span class="num" id="3986871">1</span><span class="op" id="3986872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3986878">copy</span><span class="op" id="3986882">(</span><span class="ident" id="3986883">index</span><span class="op" id="3986888">,</span>&nbsp;<span class="ident" id="3986890">f</span><span class="op" id="3986891">.</span><span class="ident" id="3986892">index</span><span class="op" id="3986897">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986903">index</span><span class="op" id="3986908">[</span><span class="builtinfunc" id="3986909">len</span><span class="op" id="3986912">(</span><span class="ident" id="3986913">f</span><span class="op" id="3986914">.</span><span class="ident" id="3986915">index</span><span class="op" id="3986920">)</span><span class="op" id="3986921">]</span>&nbsp;<span class="op" id="3986923">=</span>&nbsp;<span class="ident" id="3986925">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986932">ft</span>&nbsp;<span class="op" id="3986935">:=</span>&nbsp;<span class="ident" id="3986938">sf</span><span class="op" id="3986940">.</span><span class="ident" id="3986941">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986950">if</span>&nbsp;<span class="ident" id="3986953">ft</span><span class="op" id="3986955">.</span><span class="ident" id="3986956">Name</span><span class="op" id="3986960">(</span><span class="op" id="3986961">)</span>&nbsp;<span class="op" id="3986963">==</span>&nbsp;<span class="string" id="3986966">&#34;&#34;</span>&nbsp;<span class="op" id="3986969">&amp;&amp;</span>&nbsp;<span class="ident" id="3986972">ft</span><span class="op" id="3986974">.</span><span class="ident" id="3986975">Kind</span><span class="op" id="3986979">(</span><span class="op" id="3986980">)</span>&nbsp;<span class="op" id="3986982">==</span>&nbsp;<span class="ident" id="3986985">reflect</span><span class="op" id="3986992">.</span><span class="ident" id="3986993">Ptr</span>&nbsp;<span class="op" id="3986997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987004">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987028">ft</span>&nbsp;<span class="op" id="3987031">=</span>&nbsp;<span class="ident" id="3987033">ft</span><span class="op" id="3987035">.</span><span class="ident" id="3987036">Elem</span><span class="op" id="3987040">(</span><span class="op" id="3987041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987054">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987100">if</span>&nbsp;<span class="ident" id="3987103">name</span>&nbsp;<span class="op" id="3987108">!=</span>&nbsp;<span class="string" id="3987111">&#34;&#34;</span>&nbsp;<span class="op" id="3987114">||</span>&nbsp;<span class="op" id="3987117">!</span><span class="ident" id="3987118">sf</span><span class="op" id="3987120">.</span><span class="ident" id="3987121">Anonymous</span>&nbsp;<span class="op" id="3987131">||</span>&nbsp;<span class="ident" id="3987134">ft</span><span class="op" id="3987136">.</span><span class="ident" id="3987137">Kind</span><span class="op" id="3987141">(</span><span class="op" id="3987142">)</span>&nbsp;<span class="op" id="3987144">!=</span>&nbsp;<span class="ident" id="3987147">reflect</span><span class="op" id="3987154">.</span><span class="ident" id="3987155">Struct</span>&nbsp;<span class="op" id="3987162">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987169">tagged</span>&nbsp;<span class="op" id="3987176">:=</span>&nbsp;<span class="ident" id="3987179">name</span>&nbsp;<span class="op" id="3987184">!=</span>&nbsp;<span class="string" id="3987187">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987195">if</span>&nbsp;<span class="ident" id="3987198">name</span>&nbsp;<span class="op" id="3987203">==</span>&nbsp;<span class="string" id="3987206">&#34;&#34;</span>&nbsp;<span class="op" id="3987209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987217">name</span>&nbsp;<span class="op" id="3987222">=</span>&nbsp;<span class="ident" id="3987224">sf</span><span class="op" id="3987226">.</span><span class="ident" id="3987227">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987244">fields</span>&nbsp;<span class="op" id="3987251">=</span>&nbsp;<span class="builtinfunc" id="3987253">append</span><span class="op" id="3987259">(</span><span class="ident" id="3987260">fields</span><span class="op" id="3987266">,</span>&nbsp;<span class="ident" id="3987268">fillField</span><span class="op" id="3987277">(</span><span class="ident" id="3987278">field</span><span class="op" id="3987283">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987291">name</span><span class="op" id="3987295">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987302">name</span><span class="op" id="3987306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987314">tag</span><span class="op" id="3987317">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987325">tagged</span><span class="op" id="3987331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987339">index</span><span class="op" id="3987344">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987350">index</span><span class="op" id="3987355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987363">typ</span><span class="op" id="3987366">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987374">ft</span><span class="op" id="3987376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987384">omitEmpty</span><span class="op" id="3987393">:</span>&nbsp;<span class="ident" id="3987395">opts</span><span class="op" id="3987399">.</span><span class="ident" id="3987400">Contains</span><span class="op" id="3987408">(</span><span class="string" id="3987409">&#34;omitempty&#34;</span><span class="op" id="3987420">)</span><span class="op" id="3987421">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987429">quoted</span><span class="op" id="3987435">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987440">opts</span><span class="op" id="3987444">.</span><span class="ident" id="3987445">Contains</span><span class="op" id="3987453">(</span><span class="string" id="3987454">&#34;string&#34;</span><span class="op" id="3987462">)</span><span class="op" id="3987463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987470">}</span><span class="op" id="3987471">)</span><span class="op" id="3987472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987479">if</span>&nbsp;<span class="ident" id="3987482">count</span><span class="op" id="3987487">[</span><span class="ident" id="3987488">f</span><span class="op" id="3987489">.</span><span class="ident" id="3987490">typ</span><span class="op" id="3987493">]</span>&nbsp;<span class="op" id="3987495">&gt;</span>&nbsp;<span class="num" id="3987497">1</span>&nbsp;<span class="op" id="3987499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987507">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987564">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987625">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987686">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987739">fields</span>&nbsp;<span class="op" id="3987746">=</span>&nbsp;<span class="builtinfunc" id="3987748">append</span><span class="op" id="3987754">(</span><span class="ident" id="3987755">fields</span><span class="op" id="3987761">,</span>&nbsp;<span class="ident" id="3987763">fields</span><span class="op" id="3987769">[</span><span class="builtinfunc" id="3987770">len</span><span class="op" id="3987773">(</span><span class="ident" id="3987774">fields</span><span class="op" id="3987780">)</span><span class="op" id="3987781">-</span><span class="num" id="3987782">1</span><span class="op" id="3987783">]</span><span class="op" id="3987784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987798">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987818">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987879">nextCount</span><span class="op" id="3987888">[</span><span class="ident" id="3987889">ft</span><span class="op" id="3987891">]</span><span class="op" id="3987892">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987899">if</span>&nbsp;<span class="ident" id="3987902">nextCount</span><span class="op" id="3987911">[</span><span class="ident" id="3987912">ft</span><span class="op" id="3987914">]</span>&nbsp;<span class="op" id="3987916">==</span>&nbsp;<span class="num" id="3987919">1</span>&nbsp;<span class="op" id="3987921">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987928">next</span>&nbsp;<span class="op" id="3987933">=</span>&nbsp;<span class="builtinfunc" id="3987935">append</span><span class="op" id="3987941">(</span><span class="ident" id="3987942">next</span><span class="op" id="3987946">,</span>&nbsp;<span class="ident" id="3987948">fillField</span><span class="op" id="3987957">(</span><span class="ident" id="3987958">field</span><span class="op" id="3987963">{</span><span class="ident" id="3987964">name</span><span class="op" id="3987968">:</span>&nbsp;<span class="ident" id="3987970">ft</span><span class="op" id="3987972">.</span><span class="ident" id="3987973">Name</span><span class="op" id="3987977">(</span><span class="op" id="3987978">)</span><span class="op" id="3987979">,</span>&nbsp;<span class="ident" id="3987981">index</span><span class="op" id="3987986">:</span>&nbsp;<span class="ident" id="3987988">index</span><span class="op" id="3987993">,</span>&nbsp;<span class="ident" id="3987995">typ</span><span class="op" id="3987998">:</span>&nbsp;<span class="ident" id="3988000">ft</span><span class="op" id="3988002">}</span><span class="op" id="3988003">)</span><span class="op" id="3988004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988022">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988026">sort</span><span class="op" id="3988030">.</span><span class="ident" id="3988031">Sort</span><span class="op" id="3988035">(</span><span class="ident" id="3988036">byName</span><span class="op" id="3988042">(</span><span class="ident" id="3988043">fields</span><span class="op" id="3988049">)</span><span class="op" id="3988050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988054">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988129">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988182">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988250">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988316">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988384">out</span>&nbsp;<span class="op" id="3988388">:=</span>&nbsp;<span class="ident" id="3988391">fields</span><span class="op" id="3988397">[</span><span class="op" id="3988398">:</span><span class="num" id="3988399">0</span><span class="op" id="3988400">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988403">for</span>&nbsp;<span class="ident" id="3988407">advance</span><span class="op" id="3988414">,</span>&nbsp;<span class="ident" id="3988416">i</span>&nbsp;<span class="op" id="3988418">:=</span>&nbsp;<span class="num" id="3988421">0</span><span class="op" id="3988422">,</span>&nbsp;<span class="num" id="3988424">0</span><span class="op" id="3988425">;</span>&nbsp;<span class="ident" id="3988427">i</span>&nbsp;<span class="op" id="3988429">&lt;</span>&nbsp;<span class="builtinfunc" id="3988431">len</span><span class="op" id="3988434">(</span><span class="ident" id="3988435">fields</span><span class="op" id="3988441">)</span><span class="op" id="3988442">;</span>&nbsp;<span class="ident" id="3988444">i</span>&nbsp;<span class="op" id="3988446">+=</span>&nbsp;<span class="ident" id="3988449">advance</span>&nbsp;<span class="op" id="3988457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988461">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988490">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988558">fi</span>&nbsp;<span class="op" id="3988561">:=</span>&nbsp;<span class="ident" id="3988564">fields</span><span class="op" id="3988570">[</span><span class="ident" id="3988571">i</span><span class="op" id="3988572">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988576">name</span>&nbsp;<span class="op" id="3988581">:=</span>&nbsp;<span class="ident" id="3988584">fi</span><span class="op" id="3988586">.</span><span class="ident" id="3988587">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988594">for</span>&nbsp;<span class="ident" id="3988598">advance</span>&nbsp;<span class="op" id="3988606">=</span>&nbsp;<span class="num" id="3988608">1</span><span class="op" id="3988609">;</span>&nbsp;<span class="ident" id="3988611">i</span><span class="op" id="3988612">+</span><span class="ident" id="3988613">advance</span>&nbsp;<span class="op" id="3988621">&lt;</span>&nbsp;<span class="builtinfunc" id="3988623">len</span><span class="op" id="3988626">(</span><span class="ident" id="3988627">fields</span><span class="op" id="3988633">)</span><span class="op" id="3988634">;</span>&nbsp;<span class="ident" id="3988636">advance</span><span class="op" id="3988643">++</span>&nbsp;<span class="op" id="3988646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988651">fj</span>&nbsp;<span class="op" id="3988654">:=</span>&nbsp;<span class="ident" id="3988657">fields</span><span class="op" id="3988663">[</span><span class="ident" id="3988664">i</span><span class="op" id="3988665">+</span><span class="ident" id="3988666">advance</span><span class="op" id="3988673">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988678">if</span>&nbsp;<span class="ident" id="3988681">fj</span><span class="op" id="3988683">.</span><span class="ident" id="3988684">name</span>&nbsp;<span class="op" id="3988689">!=</span>&nbsp;<span class="ident" id="3988692">name</span>&nbsp;<span class="op" id="3988697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988703">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988712">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988720">if</span>&nbsp;<span class="ident" id="3988723">advance</span>&nbsp;<span class="op" id="3988731">==</span>&nbsp;<span class="num" id="3988734">1</span>&nbsp;<span class="op" id="3988736">{</span>&nbsp;<span class="comment" id="3988738">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988774">out</span>&nbsp;<span class="op" id="3988778">=</span>&nbsp;<span class="builtinfunc" id="3988780">append</span><span class="op" id="3988786">(</span><span class="ident" id="3988787">out</span><span class="op" id="3988790">,</span>&nbsp;<span class="ident" id="3988792">fi</span><span class="op" id="3988794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988799">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988810">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988814">dominant</span><span class="op" id="3988822">,</span>&nbsp;<span class="ident" id="3988824">ok</span>&nbsp;<span class="op" id="3988827">:=</span>&nbsp;<span class="ident" id="3988830">dominantField</span><span class="op" id="3988843">(</span><span class="ident" id="3988844">fields</span><span class="op" id="3988850">[</span><span class="ident" id="3988851">i</span>&nbsp;<span class="op" id="3988853">:</span>&nbsp;<span class="ident" id="3988855">i</span><span class="op" id="3988856">+</span><span class="ident" id="3988857">advance</span><span class="op" id="3988864">]</span><span class="op" id="3988865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988869">if</span>&nbsp;<span class="ident" id="3988872">ok</span>&nbsp;<span class="op" id="3988875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988880">out</span>&nbsp;<span class="op" id="3988884">=</span>&nbsp;<span class="builtinfunc" id="3988886">append</span><span class="op" id="3988892">(</span><span class="ident" id="3988893">out</span><span class="op" id="3988896">,</span>&nbsp;<span class="ident" id="3988898">dominant</span><span class="op" id="3988906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988913">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988917">fields</span>&nbsp;<span class="op" id="3988924">=</span>&nbsp;<span class="ident" id="3988926">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988931">sort</span><span class="op" id="3988935">.</span><span class="ident" id="3988936">Sort</span><span class="op" id="3988940">(</span><span class="ident" id="3988941">byIndex</span><span class="op" id="3988948">(</span><span class="ident" id="3988949">fields</span><span class="op" id="3988955">)</span><span class="op" id="3988956">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988960">return</span>&nbsp;<span class="ident" id="3988967">fields</span><br>
<span class="lineno">1115</span><span class="op" id="3988974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3988977">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3989046">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3989113">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="3989179">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="3989245">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="3989312">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="3989327">func</span>&nbsp;<span class="ident" id="3989332">dominantField</span><span class="op" id="3989345">(</span><span class="ident" id="3989346">fields</span>&nbsp;<span class="op" id="3989353">[</span><span class="op" id="3989354">]</span><span class="ident" id="3989355">field</span><span class="op" id="3989360">)</span>&nbsp;<span class="op" id="3989362">(</span><span class="ident" id="3989363">field</span><span class="op" id="3989368">,</span>&nbsp;<span class="builtintype" id="3989370">bool</span><span class="op" id="3989374">)</span>&nbsp;<span class="op" id="3989376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989379">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989450">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989517">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989577">length</span>&nbsp;<span class="op" id="3989584">:=</span>&nbsp;<span class="builtinfunc" id="3989587">len</span><span class="op" id="3989590">(</span><span class="ident" id="3989591">fields</span><span class="op" id="3989597">[</span><span class="num" id="3989598">0</span><span class="op" id="3989599">]</span><span class="op" id="3989600">.</span><span class="ident" id="3989601">index</span><span class="op" id="3989606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989609">tagged</span>&nbsp;<span class="op" id="3989616">:=</span>&nbsp;<span class="op" id="3989619">-</span><span class="num" id="3989620">1</span>&nbsp;<span class="comment" id="3989622">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989655">for</span>&nbsp;<span class="ident" id="3989659">i</span><span class="op" id="3989660">,</span>&nbsp;<span class="ident" id="3989662">f</span>&nbsp;<span class="op" id="3989664">:=</span>&nbsp;<span class="keyword" id="3989667">range</span>&nbsp;<span class="ident" id="3989673">fields</span>&nbsp;<span class="op" id="3989680">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989684">if</span>&nbsp;<span class="builtinfunc" id="3989687">len</span><span class="op" id="3989690">(</span><span class="ident" id="3989691">f</span><span class="op" id="3989692">.</span><span class="ident" id="3989693">index</span><span class="op" id="3989698">)</span>&nbsp;<span class="op" id="3989700">&gt;</span>&nbsp;<span class="ident" id="3989702">length</span>&nbsp;<span class="op" id="3989709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989714">fields</span>&nbsp;<span class="op" id="3989721">=</span>&nbsp;<span class="ident" id="3989723">fields</span><span class="op" id="3989729">[</span><span class="op" id="3989730">:</span><span class="ident" id="3989731">i</span><span class="op" id="3989732">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989737">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989749">if</span>&nbsp;<span class="ident" id="3989752">f</span><span class="op" id="3989753">.</span><span class="ident" id="3989754">tag</span>&nbsp;<span class="op" id="3989758">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989763">if</span>&nbsp;<span class="ident" id="3989766">tagged</span>&nbsp;<span class="op" id="3989773">&gt;=</span>&nbsp;<span class="num" id="3989776">0</span>&nbsp;<span class="op" id="3989778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989784">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989843">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989867">return</span>&nbsp;<span class="ident" id="3989874">field</span><span class="op" id="3989879">{</span><span class="op" id="3989880">}</span><span class="op" id="3989881">,</span>&nbsp;<span class="builtintype" id="3989883">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989892">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989897">tagged</span>&nbsp;<span class="op" id="3989904">=</span>&nbsp;<span class="ident" id="3989906">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989916">if</span>&nbsp;<span class="ident" id="3989919">tagged</span>&nbsp;<span class="op" id="3989926">&gt;=</span>&nbsp;<span class="num" id="3989929">0</span>&nbsp;<span class="op" id="3989931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989935">return</span>&nbsp;<span class="ident" id="3989942">fields</span><span class="op" id="3989948">[</span><span class="ident" id="3989949">tagged</span><span class="op" id="3989955">]</span><span class="op" id="3989956">,</span>&nbsp;<span class="builtintype" id="3989958">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989967">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990040">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990111">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990132">if</span>&nbsp;<span class="builtinfunc" id="3990135">len</span><span class="op" id="3990138">(</span><span class="ident" id="3990139">fields</span><span class="op" id="3990145">)</span>&nbsp;<span class="op" id="3990147">&gt;</span>&nbsp;<span class="num" id="3990149">1</span>&nbsp;<span class="op" id="3990151">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990155">return</span>&nbsp;<span class="ident" id="3990162">field</span><span class="op" id="3990167">{</span><span class="op" id="3990168">}</span><span class="op" id="3990169">,</span>&nbsp;<span class="builtintype" id="3990171">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990181">return</span>&nbsp;<span class="ident" id="3990188">fields</span><span class="op" id="3990194">[</span><span class="num" id="3990195">0</span><span class="op" id="3990196">]</span><span class="op" id="3990197">,</span>&nbsp;<span class="builtintype" id="3990199">true</span><br>
<span class="lineno"></span><span class="op" id="3990204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="3990207">var</span>&nbsp;<span class="ident" id="3990211">fieldCache</span>&nbsp;<span class="keyword" id="3990222">struct</span>&nbsp;<span class="op" id="3990229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990232">sync</span><span class="op" id="3990236">.</span><span class="ident" id="3990237">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990246">m</span>&nbsp;<span class="keyword" id="3990248">map</span><span class="op" id="3990251">[</span><span class="ident" id="3990252">reflect</span><span class="op" id="3990259">.</span><span class="ident" id="3990260">Type</span><span class="op" id="3990264">]</span><span class="op" id="3990265">[</span><span class="op" id="3990266">]</span><span class="ident" id="3990267">field</span><br>
<span class="lineno"></span><span class="op" id="3990273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="3990276">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="3990356">func</span>&nbsp;<span class="ident" id="3990361">cachedTypeFields</span><span class="op" id="3990377">(</span><span class="ident" id="3990378">t</span>&nbsp;<span class="ident" id="3990380">reflect</span><span class="op" id="3990387">.</span><span class="ident" id="3990388">Type</span><span class="op" id="3990392">)</span>&nbsp;<span class="op" id="3990394">[</span><span class="op" id="3990395">]</span><span class="ident" id="3990396">field</span>&nbsp;<span class="op" id="3990402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990405">fieldCache</span><span class="op" id="3990415">.</span><span class="ident" id="3990416">RLock</span><span class="op" id="3990421">(</span><span class="op" id="3990422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990425">f</span>&nbsp;<span class="op" id="3990427">:=</span>&nbsp;<span class="ident" id="3990430">fieldCache</span><span class="op" id="3990440">.</span><span class="ident" id="3990441">m</span><span class="op" id="3990442">[</span><span class="ident" id="3990443">t</span><span class="op" id="3990444">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990447">fieldCache</span><span class="op" id="3990457">.</span><span class="ident" id="3990458">RUnlock</span><span class="op" id="3990465">(</span><span class="op" id="3990466">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990469">if</span>&nbsp;<span class="ident" id="3990472">f</span>&nbsp;<span class="op" id="3990474">!=</span>&nbsp;<span class="ident" id="3990477">nil</span>&nbsp;<span class="op" id="3990481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990485">return</span>&nbsp;<span class="ident" id="3990492">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990499">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990532">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990599">f</span>&nbsp;<span class="op" id="3990601">=</span>&nbsp;<span class="ident" id="3990603">typeFields</span><span class="op" id="3990613">(</span><span class="ident" id="3990614">t</span><span class="op" id="3990615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990618">if</span>&nbsp;<span class="ident" id="3990621">f</span>&nbsp;<span class="op" id="3990623">==</span>&nbsp;<span class="ident" id="3990626">nil</span>&nbsp;<span class="op" id="3990630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990634">f</span>&nbsp;<span class="op" id="3990636">=</span>&nbsp;<span class="op" id="3990638">[</span><span class="op" id="3990639">]</span><span class="ident" id="3990640">field</span><span class="op" id="3990645">{</span><span class="op" id="3990646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990649">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990653">fieldCache</span><span class="op" id="3990663">.</span><span class="ident" id="3990664">Lock</span><span class="op" id="3990668">(</span><span class="op" id="3990669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990672">if</span>&nbsp;<span class="ident" id="3990675">fieldCache</span><span class="op" id="3990685">.</span><span class="ident" id="3990686">m</span>&nbsp;<span class="op" id="3990688">==</span>&nbsp;<span class="ident" id="3990691">nil</span>&nbsp;<span class="op" id="3990695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990699">fieldCache</span><span class="op" id="3990709">.</span><span class="ident" id="3990710">m</span>&nbsp;<span class="op" id="3990712">=</span>&nbsp;<span class="keyword" id="3990714">map</span><span class="op" id="3990717">[</span><span class="ident" id="3990718">reflect</span><span class="op" id="3990725">.</span><span class="ident" id="3990726">Type</span><span class="op" id="3990730">]</span><span class="op" id="3990731">[</span><span class="op" id="3990732">]</span><span class="ident" id="3990733">field</span><span class="op" id="3990738">{</span><span class="op" id="3990739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990742">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990745">fieldCache</span><span class="op" id="3990755">.</span><span class="ident" id="3990756">m</span><span class="op" id="3990757">[</span><span class="ident" id="3990758">t</span><span class="op" id="3990759">]</span>&nbsp;<span class="op" id="3990761">=</span>&nbsp;<span class="ident" id="3990763">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990766">fieldCache</span><span class="op" id="3990776">.</span><span class="ident" id="3990777">Unlock</span><span class="op" id="3990783">(</span><span class="op" id="3990784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990787">return</span>&nbsp;<span class="ident" id="3990794">f</span><br>
<span class="lineno"></span><span class="op" id="3990796">}</span>
</div>
</body>
</html>
