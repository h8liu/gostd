<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2797494">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2797550">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2797604">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2797655">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2797684">package</span>&nbsp;<span class="ident" id="2797692">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2797701">import</span>&nbsp;<span class="op" id="2797708">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2797711">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2797720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2797723">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2797786">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2797811">type</span>&nbsp;<span class="ident" id="2797816">makeFuncImpl</span>&nbsp;<span class="keyword" id="2797829">struct</span>&nbsp;<span class="op" id="2797836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2797839">code</span>&nbsp;&nbsp;<span class="builtintype" id="2797845">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2797854">stack</span>&nbsp;<span class="op" id="2797860">*</span><span class="ident" id="2797861">bitVector</span>&nbsp;<span class="comment" id="2797871">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2797923">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2797929">*</span><span class="ident" id="2797930">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2797940">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2797946">func</span><span class="op" id="2797950">(</span><span class="op" id="2797951">[</span><span class="op" id="2797952">]</span><span class="ident" id="2797953">Value</span><span class="op" id="2797958">)</span>&nbsp;<span class="op" id="2797960">[</span><span class="op" id="2797961">]</span><span class="ident" id="2797962">Value</span><br>
<span class="lineno">20</span><span class="op" id="2797968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2797971">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2798024">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2798086">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2798109">//</span><br>
<span class="lineno"></span><span class="comment" id="2798112">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2798162">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2798193">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2798263">//</span><br>
<span class="lineno">30</span><span class="comment" id="2798266">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2798332">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2798386">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2798453">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2798511">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2798581">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2798639">//</span><br>
<span class="lineno"></span><span class="comment" id="2798642">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2798712">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2798788">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2798828">//</span><br>
<span class="lineno"></span><span class="comment" id="2798831">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2798901">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2798973">//</span><br>
<span class="lineno"></span><span class="keyword" id="2798976">func</span>&nbsp;<span class="ident" id="2798981">MakeFunc</span><span class="op" id="2798989">(</span><span class="ident" id="2798990">typ</span>&nbsp;<span class="ident" id="2798994">Type</span><span class="op" id="2798998">,</span>&nbsp;<span class="ident" id="2799000">fn</span>&nbsp;<span class="keyword" id="2799003">func</span><span class="op" id="2799007">(</span><span class="ident" id="2799008">args</span>&nbsp;<span class="op" id="2799013">[</span><span class="op" id="2799014">]</span><span class="ident" id="2799015">Value</span><span class="op" id="2799020">)</span>&nbsp;<span class="op" id="2799022">(</span><span class="ident" id="2799023">results</span>&nbsp;<span class="op" id="2799031">[</span><span class="op" id="2799032">]</span><span class="ident" id="2799033">Value</span><span class="op" id="2799038">)</span><span class="op" id="2799039">)</span>&nbsp;<span class="ident" id="2799041">Value</span>&nbsp;<span class="op" id="2799047">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2799050">if</span>&nbsp;<span class="ident" id="2799053">typ</span><span class="op" id="2799056">.</span><span class="ident" id="2799057">Kind</span><span class="op" id="2799061">(</span><span class="op" id="2799062">)</span>&nbsp;<span class="op" id="2799064">!=</span>&nbsp;<span class="ident" id="2799067">Func</span>&nbsp;<span class="op" id="2799072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2799076">panic</span><span class="op" id="2799081">(</span><span class="string" id="2799082">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2799128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2799131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799135">t</span>&nbsp;<span class="op" id="2799137">:=</span>&nbsp;<span class="ident" id="2799140">typ</span><span class="op" id="2799143">.</span><span class="ident" id="2799144">common</span><span class="op" id="2799150">(</span><span class="op" id="2799151">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799154">ftyp</span>&nbsp;<span class="op" id="2799159">:=</span>&nbsp;<span class="op" id="2799162">(</span><span class="op" id="2799163">*</span><span class="ident" id="2799164">funcType</span><span class="op" id="2799172">)</span><span class="op" id="2799173">(</span><span class="ident" id="2799174">unsafe</span><span class="op" id="2799180">.</span><span class="ident" id="2799181">Pointer</span><span class="op" id="2799188">(</span><span class="ident" id="2799189">t</span><span class="op" id="2799190">)</span><span class="op" id="2799191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2799195">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2799240">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2799295">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799355">dummy</span>&nbsp;<span class="op" id="2799361">:=</span>&nbsp;<span class="ident" id="2799364">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799378">code</span>&nbsp;<span class="op" id="2799383">:=</span>&nbsp;<span class="op" id="2799386">*</span><span class="op" id="2799387">*</span><span class="op" id="2799388">(</span><span class="op" id="2799389">*</span><span class="op" id="2799390">*</span><span class="builtintype" id="2799391">uintptr</span><span class="op" id="2799398">)</span><span class="op" id="2799399">(</span><span class="ident" id="2799400">unsafe</span><span class="op" id="2799406">.</span><span class="ident" id="2799407">Pointer</span><span class="op" id="2799414">(</span><span class="op" id="2799415">&amp;</span><span class="ident" id="2799416">dummy</span><span class="op" id="2799421">)</span><span class="op" id="2799422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2799426">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799487">_</span><span class="op" id="2799488">,</span>&nbsp;<span class="ident" id="2799490">_</span><span class="op" id="2799491">,</span>&nbsp;<span class="ident" id="2799493">_</span><span class="op" id="2799494">,</span>&nbsp;<span class="ident" id="2799496">stack</span>&nbsp;<span class="op" id="2799502">:=</span>&nbsp;<span class="ident" id="2799505">funcLayout</span><span class="op" id="2799515">(</span><span class="ident" id="2799516">t</span><span class="op" id="2799517">,</span>&nbsp;<span class="ident" id="2799519">nil</span><span class="op" id="2799522">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799526">impl</span>&nbsp;<span class="op" id="2799531">:=</span>&nbsp;<span class="op" id="2799534">&amp;</span><span class="ident" id="2799535">makeFuncImpl</span><span class="op" id="2799547">{</span><span class="ident" id="2799548">code</span><span class="op" id="2799552">:</span>&nbsp;<span class="ident" id="2799554">code</span><span class="op" id="2799558">,</span>&nbsp;<span class="ident" id="2799560">stack</span><span class="op" id="2799565">:</span>&nbsp;<span class="ident" id="2799567">stack</span><span class="op" id="2799572">,</span>&nbsp;<span class="ident" id="2799574">typ</span><span class="op" id="2799577">:</span>&nbsp;<span class="ident" id="2799579">ftyp</span><span class="op" id="2799583">,</span>&nbsp;<span class="ident" id="2799585">fn</span><span class="op" id="2799587">:</span>&nbsp;<span class="ident" id="2799589">fn</span><span class="op" id="2799591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2799595">return</span>&nbsp;<span class="ident" id="2799602">Value</span><span class="op" id="2799607">{</span><span class="ident" id="2799608">t</span><span class="op" id="2799609">,</span>&nbsp;<span class="ident" id="2799611">unsafe</span><span class="op" id="2799617">.</span><span class="ident" id="2799618">Pointer</span><span class="op" id="2799625">(</span><span class="ident" id="2799626">impl</span><span class="op" id="2799630">)</span><span class="op" id="2799631">,</span>&nbsp;<span class="ident" id="2799633">flag</span><span class="op" id="2799637">(</span><span class="ident" id="2799638">Func</span><span class="op" id="2799642">)</span><span class="op" id="2799643">}</span><br>
<span class="lineno"></span><span class="op" id="2799645">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2799648">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2799713">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2799783">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2799861">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2799935">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2799976">func</span>&nbsp;<span class="ident" id="2799981">makeFuncStub</span><span class="op" id="2799993">(</span><span class="op" id="2799994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2799997">type</span>&nbsp;<span class="ident" id="2800002">methodValue</span>&nbsp;<span class="keyword" id="2800014">struct</span>&nbsp;<span class="op" id="2800021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800024">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2800031">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800040">stack</span>&nbsp;&nbsp;<span class="op" id="2800047">*</span><span class="ident" id="2800048">bitVector</span>&nbsp;<span class="comment" id="2800058">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800110">method</span>&nbsp;<span class="builtintype" id="2800117">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800122">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2800129">Value</span><br>
<span class="lineno"></span><span class="op" id="2800135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2800138">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2800210">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2800272">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2800340">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2800402">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2800472">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2800541">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2800591">func</span>&nbsp;<span class="ident" id="2800596">makeMethodValue</span><span class="op" id="2800611">(</span><span class="ident" id="2800612">op</span>&nbsp;<span class="builtintype" id="2800615">string</span><span class="op" id="2800621">,</span>&nbsp;<span class="ident" id="2800623">v</span>&nbsp;<span class="ident" id="2800625">Value</span><span class="op" id="2800630">)</span>&nbsp;<span class="ident" id="2800632">Value</span>&nbsp;<span class="op" id="2800638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800641">if</span>&nbsp;<span class="ident" id="2800644">v</span><span class="op" id="2800645">.</span><span class="ident" id="2800646">flag</span><span class="op" id="2800650">&amp;</span><span class="ident" id="2800651">flagMethod</span>&nbsp;<span class="op" id="2800662">==</span>&nbsp;<span class="num" id="2800665">0</span>&nbsp;<span class="op" id="2800667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2800671">panic</span><span class="op" id="2800676">(</span><span class="string" id="2800677">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2800734">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2800741">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800821">fl</span>&nbsp;<span class="op" id="2800824">:=</span>&nbsp;<span class="ident" id="2800827">v</span><span class="op" id="2800828">.</span><span class="ident" id="2800829">flag</span>&nbsp;<span class="op" id="2800834">&amp;</span>&nbsp;<span class="op" id="2800836">(</span><span class="ident" id="2800837">flagRO</span>&nbsp;<span class="op" id="2800844">|</span>&nbsp;<span class="ident" id="2800846">flagAddr</span>&nbsp;<span class="op" id="2800855">|</span>&nbsp;<span class="ident" id="2800857">flagIndir</span><span class="op" id="2800866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800869">fl</span>&nbsp;<span class="op" id="2800872">|=</span>&nbsp;<span class="ident" id="2800875">flag</span><span class="op" id="2800879">(</span><span class="ident" id="2800880">v</span><span class="op" id="2800881">.</span><span class="ident" id="2800882">typ</span><span class="op" id="2800885">.</span><span class="ident" id="2800886">Kind</span><span class="op" id="2800890">(</span><span class="op" id="2800891">)</span><span class="op" id="2800892">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800895">rcvr</span>&nbsp;<span class="op" id="2800900">:=</span>&nbsp;<span class="ident" id="2800903">Value</span><span class="op" id="2800908">{</span><span class="ident" id="2800909">v</span><span class="op" id="2800910">.</span><span class="ident" id="2800911">typ</span><span class="op" id="2800914">,</span>&nbsp;<span class="ident" id="2800916">v</span><span class="op" id="2800917">.</span><span class="ident" id="2800918">ptr</span><span class="op" id="2800921">,</span>&nbsp;<span class="ident" id="2800923">fl</span><span class="op" id="2800925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2800929">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800985">funcType</span>&nbsp;<span class="op" id="2800994">:=</span>&nbsp;<span class="ident" id="2800997">v</span><span class="op" id="2800998">.</span><span class="ident" id="2800999">Type</span><span class="op" id="2801003">(</span><span class="op" id="2801004">)</span><span class="op" id="2801005">.</span><span class="op" id="2801006">(</span><span class="op" id="2801007">*</span><span class="ident" id="2801008">rtype</span><span class="op" id="2801013">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801017">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801062">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801117">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801177">dummy</span>&nbsp;<span class="op" id="2801183">:=</span>&nbsp;<span class="ident" id="2801186">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801203">code</span>&nbsp;<span class="op" id="2801208">:=</span>&nbsp;<span class="op" id="2801211">*</span><span class="op" id="2801212">*</span><span class="op" id="2801213">(</span><span class="op" id="2801214">*</span><span class="op" id="2801215">*</span><span class="builtintype" id="2801216">uintptr</span><span class="op" id="2801223">)</span><span class="op" id="2801224">(</span><span class="ident" id="2801225">unsafe</span><span class="op" id="2801231">.</span><span class="ident" id="2801232">Pointer</span><span class="op" id="2801239">(</span><span class="op" id="2801240">&amp;</span><span class="ident" id="2801241">dummy</span><span class="op" id="2801246">)</span><span class="op" id="2801247">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801251">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801311">_</span><span class="op" id="2801312">,</span>&nbsp;<span class="ident" id="2801314">_</span><span class="op" id="2801315">,</span>&nbsp;<span class="ident" id="2801317">_</span><span class="op" id="2801318">,</span>&nbsp;<span class="ident" id="2801320">stack</span>&nbsp;<span class="op" id="2801326">:=</span>&nbsp;<span class="ident" id="2801329">funcLayout</span><span class="op" id="2801339">(</span><span class="ident" id="2801340">funcType</span><span class="op" id="2801348">,</span>&nbsp;<span class="ident" id="2801350">nil</span><span class="op" id="2801353">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801357">fv</span>&nbsp;<span class="op" id="2801360">:=</span>&nbsp;<span class="op" id="2801363">&amp;</span><span class="ident" id="2801364">methodValue</span><span class="op" id="2801375">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801379">fn</span><span class="op" id="2801381">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2801387">code</span><span class="op" id="2801391">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801395">stack</span><span class="op" id="2801400">:</span>&nbsp;&nbsp;<span class="ident" id="2801403">stack</span><span class="op" id="2801408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801412">method</span><span class="op" id="2801418">:</span>&nbsp;<span class="builtintype" id="2801420">int</span><span class="op" id="2801423">(</span><span class="ident" id="2801424">v</span><span class="op" id="2801425">.</span><span class="ident" id="2801426">flag</span><span class="op" id="2801430">)</span>&nbsp;<span class="op" id="2801432">&gt;&gt;</span>&nbsp;<span class="ident" id="2801435">flagMethodShift</span><span class="op" id="2801450">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801454">rcvr</span><span class="op" id="2801458">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2801462">rcvr</span><span class="op" id="2801466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2801469">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801473">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801519">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801585">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801649">methodReceiver</span><span class="op" id="2801663">(</span><span class="ident" id="2801664">op</span><span class="op" id="2801666">,</span>&nbsp;<span class="ident" id="2801668">fv</span><span class="op" id="2801670">.</span><span class="ident" id="2801671">rcvr</span><span class="op" id="2801675">,</span>&nbsp;<span class="ident" id="2801677">fv</span><span class="op" id="2801679">.</span><span class="ident" id="2801680">method</span><span class="op" id="2801686">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2801690">return</span>&nbsp;<span class="ident" id="2801697">Value</span><span class="op" id="2801702">{</span><span class="ident" id="2801703">funcType</span><span class="op" id="2801711">,</span>&nbsp;<span class="ident" id="2801713">unsafe</span><span class="op" id="2801719">.</span><span class="ident" id="2801720">Pointer</span><span class="op" id="2801727">(</span><span class="ident" id="2801728">fv</span><span class="op" id="2801730">)</span><span class="op" id="2801731">,</span>&nbsp;<span class="ident" id="2801733">v</span><span class="op" id="2801734">.</span><span class="ident" id="2801735">flag</span><span class="op" id="2801739">&amp;</span><span class="ident" id="2801740">flagRO</span>&nbsp;<span class="op" id="2801747">|</span>&nbsp;<span class="ident" id="2801749">flag</span><span class="op" id="2801753">(</span><span class="ident" id="2801754">Func</span><span class="op" id="2801758">)</span><span class="op" id="2801759">}</span><br>
<span class="lineno"></span><span class="op" id="2801761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2801764">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2801832">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2801905">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2801982">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2802056">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2802097">func</span>&nbsp;<span class="ident" id="2802102">methodValueCall</span><span class="op" id="2802117">(</span><span class="op" id="2802118">)</span>
</div>
</body>
</html>
