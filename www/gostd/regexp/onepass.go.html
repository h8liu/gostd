<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4404581">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4404637">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4404691">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4404742">package</span>&nbsp;<span class="ident" id="4404750">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4404758">import</span>&nbsp;<span class="op" id="4404765">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4404768">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4404777">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4404794">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4404802">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="4404812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4404815">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="4404847">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="4404913">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4404985">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4405039">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4405087">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="4405155">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="4405223">type</span>&nbsp;<span class="ident" id="4405228">onePassProg</span>&nbsp;<span class="keyword" id="4405240">struct</span>&nbsp;<span class="op" id="4405247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4405250">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4405257">[</span><span class="op" id="4405258">]</span><span class="ident" id="4405259">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4405272">Start</span>&nbsp;&nbsp;<span class="builtintype" id="4405279">int</span>&nbsp;<span class="comment" id="4405283">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4405314">NumCap</span>&nbsp;<span class="builtintype" id="4405321">int</span>&nbsp;<span class="comment" id="4405325">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="4405362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4405365">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="4405448">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="4405514">type</span>&nbsp;<span class="ident" id="4405519">onePassInst</span>&nbsp;<span class="keyword" id="4405531">struct</span>&nbsp;<span class="op" id="4405538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4405541">syntax</span><span class="op" id="4405547">.</span><span class="ident" id="4405548">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4405554">Next</span>&nbsp;<span class="op" id="4405559">[</span><span class="op" id="4405560">]</span><span class="builtintype" id="4405561">uint32</span><br>
<span class="lineno"></span><span class="op" id="4405568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4405571">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4405638">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4405697">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="4405766">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="4405827">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="4405845">func</span>&nbsp;<span class="ident" id="4405850">onePassPrefix</span><span class="op" id="4405863">(</span><span class="ident" id="4405864">p</span>&nbsp;<span class="op" id="4405866">*</span><span class="ident" id="4405867">syntax</span><span class="op" id="4405873">.</span><span class="ident" id="4405874">Prog</span><span class="op" id="4405878">)</span>&nbsp;<span class="op" id="4405880">(</span><span class="ident" id="4405881">prefix</span>&nbsp;<span class="builtintype" id="4405888">string</span><span class="op" id="4405894">,</span>&nbsp;<span class="ident" id="4405896">complete</span>&nbsp;<span class="builtintype" id="4405905">bool</span><span class="op" id="4405909">,</span>&nbsp;<span class="ident" id="4405911">pc</span>&nbsp;<span class="builtintype" id="4405914">uint32</span><span class="op" id="4405920">)</span>&nbsp;<span class="op" id="4405922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4405925">i</span>&nbsp;<span class="op" id="4405927">:=</span>&nbsp;<span class="op" id="4405930">&amp;</span><span class="ident" id="4405931">p</span><span class="op" id="4405932">.</span><span class="ident" id="4405933">Inst</span><span class="op" id="4405937">[</span><span class="ident" id="4405938">p</span><span class="op" id="4405939">.</span><span class="ident" id="4405940">Start</span><span class="op" id="4405945">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4405948">if</span>&nbsp;<span class="ident" id="4405951">i</span><span class="op" id="4405952">.</span><span class="ident" id="4405953">Op</span>&nbsp;<span class="op" id="4405956">!=</span>&nbsp;<span class="ident" id="4405959">syntax</span><span class="op" id="4405965">.</span><span class="ident" id="4405966">InstEmptyWidth</span>&nbsp;<span class="op" id="4405981">||</span>&nbsp;<span class="op" id="4405984">(</span><span class="ident" id="4405985">syntax</span><span class="op" id="4405991">.</span><span class="ident" id="4405992">EmptyOp</span><span class="op" id="4405999">(</span><span class="ident" id="4406000">i</span><span class="op" id="4406001">.</span><span class="ident" id="4406002">Arg</span><span class="op" id="4406005">)</span><span class="op" id="4406006">)</span><span class="op" id="4406007">&amp;</span><span class="ident" id="4406008">syntax</span><span class="op" id="4406014">.</span><span class="ident" id="4406015">EmptyBeginText</span>&nbsp;<span class="op" id="4406030">==</span>&nbsp;<span class="num" id="4406033">0</span>&nbsp;<span class="op" id="4406035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406039">return</span>&nbsp;<span class="string" id="4406046">&#34;&#34;</span><span class="op" id="4406048">,</span>&nbsp;<span class="ident" id="4406050">i</span><span class="op" id="4406051">.</span><span class="ident" id="4406052">Op</span>&nbsp;<span class="op" id="4406055">==</span>&nbsp;<span class="ident" id="4406058">syntax</span><span class="op" id="4406064">.</span><span class="ident" id="4406065">InstMatch</span><span class="op" id="4406074">,</span>&nbsp;<span class="builtintype" id="4406076">uint32</span><span class="op" id="4406082">(</span><span class="ident" id="4406083">p</span><span class="op" id="4406084">.</span><span class="ident" id="4406085">Start</span><span class="op" id="4406090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4406093">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4406096">pc</span>&nbsp;<span class="op" id="4406099">=</span>&nbsp;<span class="ident" id="4406101">i</span><span class="op" id="4406102">.</span><span class="ident" id="4406103">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4406108">i</span>&nbsp;<span class="op" id="4406110">=</span>&nbsp;<span class="op" id="4406112">&amp;</span><span class="ident" id="4406113">p</span><span class="op" id="4406114">.</span><span class="ident" id="4406115">Inst</span><span class="op" id="4406119">[</span><span class="ident" id="4406120">pc</span><span class="op" id="4406122">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406125">for</span>&nbsp;<span class="ident" id="4406129">i</span><span class="op" id="4406130">.</span><span class="ident" id="4406131">Op</span>&nbsp;<span class="op" id="4406134">==</span>&nbsp;<span class="ident" id="4406137">syntax</span><span class="op" id="4406143">.</span><span class="ident" id="4406144">InstNop</span>&nbsp;<span class="op" id="4406152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4406156">pc</span>&nbsp;<span class="op" id="4406159">=</span>&nbsp;<span class="ident" id="4406161">i</span><span class="op" id="4406162">.</span><span class="ident" id="4406163">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4406169">i</span>&nbsp;<span class="op" id="4406171">=</span>&nbsp;<span class="op" id="4406173">&amp;</span><span class="ident" id="4406174">p</span><span class="op" id="4406175">.</span><span class="ident" id="4406176">Inst</span><span class="op" id="4406180">[</span><span class="ident" id="4406181">pc</span><span class="op" id="4406183">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4406186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4406189">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406240">if</span>&nbsp;<span class="ident" id="4406243">iop</span><span class="op" id="4406246">(</span><span class="ident" id="4406247">i</span><span class="op" id="4406248">)</span>&nbsp;<span class="op" id="4406250">!=</span>&nbsp;<span class="ident" id="4406253">syntax</span><span class="op" id="4406259">.</span><span class="ident" id="4406260">InstRune</span>&nbsp;<span class="op" id="4406269">||</span>&nbsp;<span class="builtinfunc" id="4406272">len</span><span class="op" id="4406275">(</span><span class="ident" id="4406276">i</span><span class="op" id="4406277">.</span><span class="ident" id="4406278">Rune</span><span class="op" id="4406282">)</span>&nbsp;<span class="op" id="4406284">!=</span>&nbsp;<span class="num" id="4406287">1</span>&nbsp;<span class="op" id="4406289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406293">return</span>&nbsp;<span class="string" id="4406300">&#34;&#34;</span><span class="op" id="4406302">,</span>&nbsp;<span class="ident" id="4406304">i</span><span class="op" id="4406305">.</span><span class="ident" id="4406306">Op</span>&nbsp;<span class="op" id="4406309">==</span>&nbsp;<span class="ident" id="4406312">syntax</span><span class="op" id="4406318">.</span><span class="ident" id="4406319">InstMatch</span><span class="op" id="4406328">,</span>&nbsp;<span class="builtintype" id="4406330">uint32</span><span class="op" id="4406336">(</span><span class="ident" id="4406337">p</span><span class="op" id="4406338">.</span><span class="ident" id="4406339">Start</span><span class="op" id="4406344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4406347">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4406351">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406387">var</span>&nbsp;<span class="ident" id="4406391">buf</span>&nbsp;<span class="ident" id="4406395">bytes</span><span class="op" id="4406400">.</span><span class="ident" id="4406401">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406409">for</span>&nbsp;<span class="ident" id="4406413">iop</span><span class="op" id="4406416">(</span><span class="ident" id="4406417">i</span><span class="op" id="4406418">)</span>&nbsp;<span class="op" id="4406420">==</span>&nbsp;<span class="ident" id="4406423">syntax</span><span class="op" id="4406429">.</span><span class="ident" id="4406430">InstRune</span>&nbsp;<span class="op" id="4406439">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4406442">len</span><span class="op" id="4406445">(</span><span class="ident" id="4406446">i</span><span class="op" id="4406447">.</span><span class="ident" id="4406448">Rune</span><span class="op" id="4406452">)</span>&nbsp;<span class="op" id="4406454">==</span>&nbsp;<span class="num" id="4406457">1</span>&nbsp;<span class="op" id="4406459">&amp;&amp;</span>&nbsp;<span class="ident" id="4406462">syntax</span><span class="op" id="4406468">.</span><span class="ident" id="4406469">Flags</span><span class="op" id="4406474">(</span><span class="ident" id="4406475">i</span><span class="op" id="4406476">.</span><span class="ident" id="4406477">Arg</span><span class="op" id="4406480">)</span><span class="op" id="4406481">&amp;</span><span class="ident" id="4406482">syntax</span><span class="op" id="4406488">.</span><span class="ident" id="4406489">FoldCase</span>&nbsp;<span class="op" id="4406498">==</span>&nbsp;<span class="num" id="4406501">0</span>&nbsp;<span class="op" id="4406503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4406507">buf</span><span class="op" id="4406510">.</span><span class="ident" id="4406511">WriteRune</span><span class="op" id="4406520">(</span><span class="ident" id="4406521">i</span><span class="op" id="4406522">.</span><span class="ident" id="4406523">Rune</span><span class="op" id="4406527">[</span><span class="num" id="4406528">0</span><span class="op" id="4406529">]</span><span class="op" id="4406530">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4406534">pc</span><span class="op" id="4406536">,</span>&nbsp;<span class="ident" id="4406538">i</span>&nbsp;<span class="op" id="4406540">=</span>&nbsp;<span class="ident" id="4406542">i</span><span class="op" id="4406543">.</span><span class="ident" id="4406544">Out</span><span class="op" id="4406547">,</span>&nbsp;<span class="op" id="4406549">&amp;</span><span class="ident" id="4406550">p</span><span class="op" id="4406551">.</span><span class="ident" id="4406552">Inst</span><span class="op" id="4406556">[</span><span class="ident" id="4406557">i</span><span class="op" id="4406558">.</span><span class="ident" id="4406559">Out</span><span class="op" id="4406562">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4406565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4406568">return</span>&nbsp;<span class="ident" id="4406575">buf</span><span class="op" id="4406578">.</span><span class="ident" id="4406579">String</span><span class="op" id="4406585">(</span><span class="op" id="4406586">)</span><span class="op" id="4406587">,</span>&nbsp;<span class="ident" id="4406589">i</span><span class="op" id="4406590">.</span><span class="ident" id="4406591">Op</span>&nbsp;<span class="op" id="4406594">==</span>&nbsp;<span class="ident" id="4406597">syntax</span><span class="op" id="4406603">.</span><span class="ident" id="4406604">InstEmptyWidth</span>&nbsp;<span class="op" id="4406619">&amp;&amp;</span>&nbsp;<span class="op" id="4406622">(</span><span class="ident" id="4406623">syntax</span><span class="op" id="4406629">.</span><span class="ident" id="4406630">EmptyOp</span><span class="op" id="4406637">(</span><span class="ident" id="4406638">i</span><span class="op" id="4406639">.</span><span class="ident" id="4406640">Arg</span><span class="op" id="4406643">)</span><span class="op" id="4406644">)</span><span class="op" id="4406645">&amp;</span><span class="ident" id="4406646">syntax</span><span class="op" id="4406652">.</span><span class="ident" id="4406653">EmptyBeginText</span>&nbsp;<span class="op" id="4406668">!=</span>&nbsp;<span class="num" id="4406671">0</span><span class="op" id="4406672">,</span>&nbsp;<span class="ident" id="4406674">pc</span><br>
<span class="lineno"></span><span class="op" id="4406677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4406680">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4406772">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="4406869">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="4406963">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="4407048">func</span>&nbsp;<span class="ident" id="4407053">onePassNext</span><span class="op" id="4407064">(</span><span class="ident" id="4407065">i</span>&nbsp;<span class="op" id="4407067">*</span><span class="ident" id="4407068">onePassInst</span><span class="op" id="4407079">,</span>&nbsp;<span class="ident" id="4407081">r</span>&nbsp;<span class="builtintype" id="4407083">rune</span><span class="op" id="4407087">)</span>&nbsp;<span class="builtintype" id="4407089">uint32</span>&nbsp;<span class="op" id="4407096">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407099">next</span>&nbsp;<span class="op" id="4407104">:=</span>&nbsp;<span class="ident" id="4407107">i</span><span class="op" id="4407108">.</span><span class="ident" id="4407109">MatchRunePos</span><span class="op" id="4407121">(</span><span class="ident" id="4407122">r</span><span class="op" id="4407123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407126">if</span>&nbsp;<span class="ident" id="4407129">next</span>&nbsp;<span class="op" id="4407134">&gt;=</span>&nbsp;<span class="num" id="4407137">0</span>&nbsp;<span class="op" id="4407139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407143">return</span>&nbsp;<span class="ident" id="4407150">i</span><span class="op" id="4407151">.</span><span class="ident" id="4407152">Next</span><span class="op" id="4407156">[</span><span class="ident" id="4407157">next</span><span class="op" id="4407161">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4407164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407167">if</span>&nbsp;<span class="ident" id="4407170">i</span><span class="op" id="4407171">.</span><span class="ident" id="4407172">Op</span>&nbsp;<span class="op" id="4407175">==</span>&nbsp;<span class="ident" id="4407178">syntax</span><span class="op" id="4407184">.</span><span class="ident" id="4407185">InstAltMatch</span>&nbsp;<span class="op" id="4407198">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407202">return</span>&nbsp;<span class="ident" id="4407209">i</span><span class="op" id="4407210">.</span><span class="ident" id="4407211">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4407216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407219">return</span>&nbsp;<span class="num" id="4407226">0</span><br>
<span class="lineno"></span><span class="op" id="4407228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4407231">func</span>&nbsp;<span class="ident" id="4407236">iop</span><span class="op" id="4407239">(</span><span class="ident" id="4407240">i</span>&nbsp;<span class="op" id="4407242">*</span><span class="ident" id="4407243">syntax</span><span class="op" id="4407249">.</span><span class="ident" id="4407250">Inst</span><span class="op" id="4407254">)</span>&nbsp;<span class="ident" id="4407256">syntax</span><span class="op" id="4407262">.</span><span class="ident" id="4407263">InstOp</span>&nbsp;<span class="op" id="4407270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407273">op</span>&nbsp;<span class="op" id="4407276">:=</span>&nbsp;<span class="ident" id="4407279">i</span><span class="op" id="4407280">.</span><span class="ident" id="4407281">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407285">switch</span>&nbsp;<span class="ident" id="4407292">op</span>&nbsp;<span class="op" id="4407295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407298">case</span>&nbsp;<span class="ident" id="4407303">syntax</span><span class="op" id="4407309">.</span><span class="ident" id="4407310">InstRune1</span><span class="op" id="4407319">,</span>&nbsp;<span class="ident" id="4407321">syntax</span><span class="op" id="4407327">.</span><span class="ident" id="4407328">InstRuneAny</span><span class="op" id="4407339">,</span>&nbsp;<span class="ident" id="4407341">syntax</span><span class="op" id="4407347">.</span><span class="ident" id="4407348">InstRuneAnyNotNL</span><span class="op" id="4407364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407368">op</span>&nbsp;<span class="op" id="4407371">=</span>&nbsp;<span class="ident" id="4407373">syntax</span><span class="op" id="4407379">.</span><span class="ident" id="4407380">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4407390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407393">return</span>&nbsp;<span class="ident" id="4407400">op</span><br>
<span class="lineno"></span><span class="op" id="4407403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4407406">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="4407464">type</span>&nbsp;<span class="ident" id="4407469">queueOnePass</span>&nbsp;<span class="keyword" id="4407482">struct</span>&nbsp;<span class="op" id="4407489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407492">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4407508">[</span><span class="op" id="4407509">]</span><span class="builtintype" id="4407510">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407518">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4407534">[</span><span class="op" id="4407535">]</span><span class="builtintype" id="4407536">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407544">size</span><span class="op" id="4407548">,</span>&nbsp;<span class="ident" id="4407550">nextIndex</span>&nbsp;<span class="builtintype" id="4407560">uint32</span><br>
<span class="lineno"></span><span class="op" id="4407567">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="4407570">func</span>&nbsp;<span class="op" id="4407575">(</span><span class="ident" id="4407576">q</span>&nbsp;<span class="op" id="4407578">*</span><span class="ident" id="4407579">queueOnePass</span><span class="op" id="4407591">)</span>&nbsp;<span class="ident" id="4407593">empty</span><span class="op" id="4407598">(</span><span class="op" id="4407599">)</span>&nbsp;<span class="builtintype" id="4407601">bool</span>&nbsp;<span class="op" id="4407606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407609">return</span>&nbsp;<span class="ident" id="4407616">q</span><span class="op" id="4407617">.</span><span class="ident" id="4407618">nextIndex</span>&nbsp;<span class="op" id="4407628">&gt;=</span>&nbsp;<span class="ident" id="4407631">q</span><span class="op" id="4407632">.</span><span class="ident" id="4407633">size</span><br>
<span class="lineno"></span><span class="op" id="4407638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4407641">func</span>&nbsp;<span class="op" id="4407646">(</span><span class="ident" id="4407647">q</span>&nbsp;<span class="op" id="4407649">*</span><span class="ident" id="4407650">queueOnePass</span><span class="op" id="4407662">)</span>&nbsp;<span class="ident" id="4407664">next</span><span class="op" id="4407668">(</span><span class="op" id="4407669">)</span>&nbsp;<span class="op" id="4407671">(</span><span class="ident" id="4407672">n</span>&nbsp;<span class="builtintype" id="4407674">uint32</span><span class="op" id="4407680">)</span>&nbsp;<span class="op" id="4407682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407685">n</span>&nbsp;<span class="op" id="4407687">=</span>&nbsp;<span class="ident" id="4407689">q</span><span class="op" id="4407690">.</span><span class="ident" id="4407691">dense</span><span class="op" id="4407696">[</span><span class="ident" id="4407697">q</span><span class="op" id="4407698">.</span><span class="ident" id="4407699">nextIndex</span><span class="op" id="4407708">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407711">q</span><span class="op" id="4407712">.</span><span class="ident" id="4407713">nextIndex</span><span class="op" id="4407722">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407726">return</span><br>
<span class="lineno"></span><span class="op" id="4407733">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="4407736">func</span>&nbsp;<span class="op" id="4407741">(</span><span class="ident" id="4407742">q</span>&nbsp;<span class="op" id="4407744">*</span><span class="ident" id="4407745">queueOnePass</span><span class="op" id="4407757">)</span>&nbsp;<span class="ident" id="4407759">clear</span><span class="op" id="4407764">(</span><span class="op" id="4407765">)</span>&nbsp;<span class="op" id="4407767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407770">q</span><span class="op" id="4407771">.</span><span class="ident" id="4407772">size</span>&nbsp;<span class="op" id="4407777">=</span>&nbsp;<span class="num" id="4407779">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407782">q</span><span class="op" id="4407783">.</span><span class="ident" id="4407784">nextIndex</span>&nbsp;<span class="op" id="4407794">=</span>&nbsp;<span class="num" id="4407796">0</span><br>
<span class="lineno"></span><span class="op" id="4407798">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="4407801">func</span>&nbsp;<span class="op" id="4407806">(</span><span class="ident" id="4407807">q</span>&nbsp;<span class="op" id="4407809">*</span><span class="ident" id="4407810">queueOnePass</span><span class="op" id="4407822">)</span>&nbsp;<span class="ident" id="4407824">reset</span><span class="op" id="4407829">(</span><span class="op" id="4407830">)</span>&nbsp;<span class="op" id="4407832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4407835">q</span><span class="op" id="4407836">.</span><span class="ident" id="4407837">nextIndex</span>&nbsp;<span class="op" id="4407847">=</span>&nbsp;<span class="num" id="4407849">0</span><br>
<span class="lineno"></span><span class="op" id="4407851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="4407854">func</span>&nbsp;<span class="op" id="4407859">(</span><span class="ident" id="4407860">q</span>&nbsp;<span class="op" id="4407862">*</span><span class="ident" id="4407863">queueOnePass</span><span class="op" id="4407875">)</span>&nbsp;<span class="ident" id="4407877">contains</span><span class="op" id="4407885">(</span><span class="ident" id="4407886">u</span>&nbsp;<span class="builtintype" id="4407888">uint32</span><span class="op" id="4407894">)</span>&nbsp;<span class="builtintype" id="4407896">bool</span>&nbsp;<span class="op" id="4407901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407904">if</span>&nbsp;<span class="ident" id="4407907">u</span>&nbsp;<span class="op" id="4407909">&gt;=</span>&nbsp;<span class="builtintype" id="4407912">uint32</span><span class="op" id="4407918">(</span><span class="builtinfunc" id="4407919">len</span><span class="op" id="4407922">(</span><span class="ident" id="4407923">q</span><span class="op" id="4407924">.</span><span class="ident" id="4407925">sparse</span><span class="op" id="4407931">)</span><span class="op" id="4407932">)</span>&nbsp;<span class="op" id="4407934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407938">return</span>&nbsp;<span class="builtintype" id="4407945">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4407952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4407955">return</span>&nbsp;<span class="ident" id="4407962">q</span><span class="op" id="4407963">.</span><span class="ident" id="4407964">sparse</span><span class="op" id="4407970">[</span><span class="ident" id="4407971">u</span><span class="op" id="4407972">]</span>&nbsp;<span class="op" id="4407974">&lt;</span>&nbsp;<span class="ident" id="4407976">q</span><span class="op" id="4407977">.</span><span class="ident" id="4407978">size</span>&nbsp;<span class="op" id="4407983">&amp;&amp;</span>&nbsp;<span class="ident" id="4407986">q</span><span class="op" id="4407987">.</span><span class="ident" id="4407988">dense</span><span class="op" id="4407993">[</span><span class="ident" id="4407994">q</span><span class="op" id="4407995">.</span><span class="ident" id="4407996">sparse</span><span class="op" id="4408002">[</span><span class="ident" id="4408003">u</span><span class="op" id="4408004">]</span><span class="op" id="4408005">]</span>&nbsp;<span class="op" id="4408007">==</span>&nbsp;<span class="ident" id="4408010">u</span><br>
<span class="lineno">120</span><span class="op" id="4408012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4408015">func</span>&nbsp;<span class="op" id="4408020">(</span><span class="ident" id="4408021">q</span>&nbsp;<span class="op" id="4408023">*</span><span class="ident" id="4408024">queueOnePass</span><span class="op" id="4408036">)</span>&nbsp;<span class="ident" id="4408038">insert</span><span class="op" id="4408044">(</span><span class="ident" id="4408045">u</span>&nbsp;<span class="builtintype" id="4408047">uint32</span><span class="op" id="4408053">)</span>&nbsp;<span class="op" id="4408055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4408058">if</span>&nbsp;<span class="op" id="4408061">!</span><span class="ident" id="4408062">q</span><span class="op" id="4408063">.</span><span class="ident" id="4408064">contains</span><span class="op" id="4408072">(</span><span class="ident" id="4408073">u</span><span class="op" id="4408074">)</span>&nbsp;<span class="op" id="4408076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408080">q</span><span class="op" id="4408081">.</span><span class="ident" id="4408082">insertNew</span><span class="op" id="4408091">(</span><span class="ident" id="4408092">u</span><span class="op" id="4408093">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4408096">}</span><br>
<span class="lineno"></span><span class="op" id="4408098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4408101">func</span>&nbsp;<span class="op" id="4408106">(</span><span class="ident" id="4408107">q</span>&nbsp;<span class="op" id="4408109">*</span><span class="ident" id="4408110">queueOnePass</span><span class="op" id="4408122">)</span>&nbsp;<span class="ident" id="4408124">insertNew</span><span class="op" id="4408133">(</span><span class="ident" id="4408134">u</span>&nbsp;<span class="builtintype" id="4408136">uint32</span><span class="op" id="4408142">)</span>&nbsp;<span class="op" id="4408144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4408147">if</span>&nbsp;<span class="ident" id="4408150">u</span>&nbsp;<span class="op" id="4408152">&gt;=</span>&nbsp;<span class="builtintype" id="4408155">uint32</span><span class="op" id="4408161">(</span><span class="builtinfunc" id="4408162">len</span><span class="op" id="4408165">(</span><span class="ident" id="4408166">q</span><span class="op" id="4408167">.</span><span class="ident" id="4408168">sparse</span><span class="op" id="4408174">)</span><span class="op" id="4408175">)</span>&nbsp;<span class="op" id="4408177">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4408181">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4408189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408192">q</span><span class="op" id="4408193">.</span><span class="ident" id="4408194">sparse</span><span class="op" id="4408200">[</span><span class="ident" id="4408201">u</span><span class="op" id="4408202">]</span>&nbsp;<span class="op" id="4408204">=</span>&nbsp;<span class="ident" id="4408206">q</span><span class="op" id="4408207">.</span><span class="ident" id="4408208">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408214">q</span><span class="op" id="4408215">.</span><span class="ident" id="4408216">dense</span><span class="op" id="4408221">[</span><span class="ident" id="4408222">q</span><span class="op" id="4408223">.</span><span class="ident" id="4408224">size</span><span class="op" id="4408228">]</span>&nbsp;<span class="op" id="4408230">=</span>&nbsp;<span class="ident" id="4408232">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408235">q</span><span class="op" id="4408236">.</span><span class="ident" id="4408237">size</span><span class="op" id="4408241">++</span><br>
<span class="lineno">135</span><span class="op" id="4408244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4408247">func</span>&nbsp;<span class="ident" id="4408252">newQueue</span><span class="op" id="4408260">(</span><span class="ident" id="4408261">size</span>&nbsp;<span class="builtintype" id="4408266">int</span><span class="op" id="4408269">)</span>&nbsp;<span class="op" id="4408271">(</span><span class="ident" id="4408272">q</span>&nbsp;<span class="op" id="4408274">*</span><span class="ident" id="4408275">queueOnePass</span><span class="op" id="4408287">)</span>&nbsp;<span class="op" id="4408289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4408292">return</span>&nbsp;<span class="op" id="4408299">&amp;</span><span class="ident" id="4408300">queueOnePass</span><span class="op" id="4408312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408316">sparse</span><span class="op" id="4408322">:</span>&nbsp;<span class="builtinfunc" id="4408324">make</span><span class="op" id="4408328">(</span><span class="op" id="4408329">[</span><span class="op" id="4408330">]</span><span class="builtintype" id="4408331">uint32</span><span class="op" id="4408337">,</span>&nbsp;<span class="ident" id="4408339">size</span><span class="op" id="4408343">)</span><span class="op" id="4408344">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408348">dense</span><span class="op" id="4408353">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="4408356">make</span><span class="op" id="4408360">(</span><span class="op" id="4408361">[</span><span class="op" id="4408362">]</span><span class="builtintype" id="4408363">uint32</span><span class="op" id="4408369">,</span>&nbsp;<span class="ident" id="4408371">size</span><span class="op" id="4408375">)</span><span class="op" id="4408376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4408379">}</span><br>
<span class="lineno"></span><span class="op" id="4408381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4408384">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="4408470">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="4408554">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4408639">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="4408704">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="4408790">const</span>&nbsp;<span class="ident" id="4408796">mergeFailed</span>&nbsp;<span class="op" id="4408808">=</span>&nbsp;<span class="builtintype" id="4408810">uint32</span><span class="op" id="4408816">(</span><span class="num" id="4408817">0xffffffff</span><span class="op" id="4408827">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="4408830">var</span>&nbsp;<span class="op" id="4408834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408837">noRune</span>&nbsp;<span class="op" id="4408844">=</span>&nbsp;<span class="op" id="4408846">[</span><span class="op" id="4408847">]</span><span class="builtintype" id="4408848">rune</span><span class="op" id="4408852">{</span><span class="op" id="4408853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408856">noNext</span>&nbsp;<span class="op" id="4408863">=</span>&nbsp;<span class="op" id="4408865">[</span><span class="op" id="4408866">]</span><span class="builtintype" id="4408867">uint32</span><span class="op" id="4408873">{</span><span class="ident" id="4408874">mergeFailed</span><span class="op" id="4408885">}</span><br>
<span class="lineno"></span><span class="op" id="4408887">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="4408890">func</span>&nbsp;<span class="ident" id="4408895">mergeRuneSets</span><span class="op" id="4408908">(</span><span class="ident" id="4408909">leftRunes</span><span class="op" id="4408918">,</span>&nbsp;<span class="ident" id="4408920">rightRunes</span>&nbsp;<span class="op" id="4408931">*</span><span class="op" id="4408932">[</span><span class="op" id="4408933">]</span><span class="builtintype" id="4408934">rune</span><span class="op" id="4408938">,</span>&nbsp;<span class="ident" id="4408940">leftPC</span><span class="op" id="4408946">,</span>&nbsp;<span class="ident" id="4408948">rightPC</span>&nbsp;<span class="builtintype" id="4408956">uint32</span><span class="op" id="4408962">)</span>&nbsp;<span class="op" id="4408964">(</span><span class="op" id="4408965">[</span><span class="op" id="4408966">]</span><span class="builtintype" id="4408967">rune</span><span class="op" id="4408971">,</span>&nbsp;<span class="op" id="4408973">[</span><span class="op" id="4408974">]</span><span class="builtintype" id="4408975">uint32</span><span class="op" id="4408981">)</span>&nbsp;<span class="op" id="4408983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4408986">leftLen</span>&nbsp;<span class="op" id="4408994">:=</span>&nbsp;<span class="builtinfunc" id="4408997">len</span><span class="op" id="4409000">(</span><span class="op" id="4409001">*</span><span class="ident" id="4409002">leftRunes</span><span class="op" id="4409011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409014">rightLen</span>&nbsp;<span class="op" id="4409023">:=</span>&nbsp;<span class="builtinfunc" id="4409026">len</span><span class="op" id="4409029">(</span><span class="op" id="4409030">*</span><span class="ident" id="4409031">rightRunes</span><span class="op" id="4409041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409044">if</span>&nbsp;<span class="ident" id="4409047">leftLen</span><span class="op" id="4409054">&amp;</span><span class="num" id="4409055">0x1</span>&nbsp;<span class="op" id="4409059">!=</span>&nbsp;<span class="num" id="4409062">0</span>&nbsp;<span class="op" id="4409064">||</span>&nbsp;<span class="ident" id="4409067">rightLen</span><span class="op" id="4409075">&amp;</span><span class="num" id="4409076">0x1</span>&nbsp;<span class="op" id="4409080">!=</span>&nbsp;<span class="num" id="4409083">0</span>&nbsp;<span class="op" id="4409085">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4409089">panic</span><span class="op" id="4409094">(</span><span class="string" id="4409095">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="4409128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409134">var</span>&nbsp;<span class="op" id="4409138">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409142">lx</span><span class="op" id="4409144">,</span>&nbsp;<span class="ident" id="4409146">rx</span>&nbsp;<span class="builtintype" id="4409149">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409154">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409157">merged</span>&nbsp;<span class="op" id="4409164">:=</span>&nbsp;<span class="builtinfunc" id="4409167">make</span><span class="op" id="4409171">(</span><span class="op" id="4409172">[</span><span class="op" id="4409173">]</span><span class="builtintype" id="4409174">rune</span><span class="op" id="4409178">,</span>&nbsp;<span class="num" id="4409180">0</span><span class="op" id="4409181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409184">next</span>&nbsp;<span class="op" id="4409189">:=</span>&nbsp;<span class="builtinfunc" id="4409192">make</span><span class="op" id="4409196">(</span><span class="op" id="4409197">[</span><span class="op" id="4409198">]</span><span class="builtintype" id="4409199">uint32</span><span class="op" id="4409205">,</span>&nbsp;<span class="num" id="4409207">0</span><span class="op" id="4409208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409211">ok</span>&nbsp;<span class="op" id="4409214">:=</span>&nbsp;<span class="builtintype" id="4409217">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409223">defer</span>&nbsp;<span class="keyword" id="4409229">func</span><span class="op" id="4409233">(</span><span class="op" id="4409234">)</span>&nbsp;<span class="op" id="4409236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409240">if</span>&nbsp;<span class="op" id="4409243">!</span><span class="ident" id="4409244">ok</span>&nbsp;<span class="op" id="4409247">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409252">merged</span>&nbsp;<span class="op" id="4409259">=</span>&nbsp;<span class="ident" id="4409261">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409268">next</span>&nbsp;<span class="op" id="4409273">=</span>&nbsp;<span class="ident" id="4409275">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409284">}</span><span class="op" id="4409285">(</span><span class="op" id="4409286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409290">ix</span>&nbsp;<span class="op" id="4409293">:=</span>&nbsp;<span class="op" id="4409296">-</span><span class="num" id="4409297">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409300">extend</span>&nbsp;<span class="op" id="4409307">:=</span>&nbsp;<span class="keyword" id="4409310">func</span><span class="op" id="4409314">(</span><span class="ident" id="4409315">newLow</span>&nbsp;<span class="op" id="4409322">*</span><span class="builtintype" id="4409323">int</span><span class="op" id="4409326">,</span>&nbsp;<span class="ident" id="4409328">newArray</span>&nbsp;<span class="op" id="4409337">*</span><span class="op" id="4409338">[</span><span class="op" id="4409339">]</span><span class="builtintype" id="4409340">rune</span><span class="op" id="4409344">,</span>&nbsp;<span class="ident" id="4409346">pc</span>&nbsp;<span class="builtintype" id="4409349">uint32</span><span class="op" id="4409355">)</span>&nbsp;<span class="builtintype" id="4409357">bool</span>&nbsp;<span class="op" id="4409362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409366">if</span>&nbsp;<span class="ident" id="4409369">ix</span>&nbsp;<span class="op" id="4409372">&gt;</span>&nbsp;<span class="num" id="4409374">0</span>&nbsp;<span class="op" id="4409376">&amp;&amp;</span>&nbsp;<span class="op" id="4409379">(</span><span class="op" id="4409380">*</span><span class="ident" id="4409381">newArray</span><span class="op" id="4409389">)</span><span class="op" id="4409390">[</span><span class="op" id="4409391">*</span><span class="ident" id="4409392">newLow</span><span class="op" id="4409398">]</span>&nbsp;<span class="op" id="4409400">&lt;=</span>&nbsp;<span class="ident" id="4409403">merged</span><span class="op" id="4409409">[</span><span class="ident" id="4409410">ix</span><span class="op" id="4409412">]</span>&nbsp;<span class="op" id="4409414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409419">return</span>&nbsp;<span class="builtintype" id="4409426">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409434">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409438">merged</span>&nbsp;<span class="op" id="4409445">=</span>&nbsp;<span class="builtinfunc" id="4409447">append</span><span class="op" id="4409453">(</span><span class="ident" id="4409454">merged</span><span class="op" id="4409460">,</span>&nbsp;<span class="op" id="4409462">(</span><span class="op" id="4409463">*</span><span class="ident" id="4409464">newArray</span><span class="op" id="4409472">)</span><span class="op" id="4409473">[</span><span class="op" id="4409474">*</span><span class="ident" id="4409475">newLow</span><span class="op" id="4409481">]</span><span class="op" id="4409482">,</span>&nbsp;<span class="op" id="4409484">(</span><span class="op" id="4409485">*</span><span class="ident" id="4409486">newArray</span><span class="op" id="4409494">)</span><span class="op" id="4409495">[</span><span class="op" id="4409496">*</span><span class="ident" id="4409497">newLow</span><span class="op" id="4409503">+</span><span class="num" id="4409504">1</span><span class="op" id="4409505">]</span><span class="op" id="4409506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409510">*</span><span class="ident" id="4409511">newLow</span>&nbsp;<span class="op" id="4409518">+=</span>&nbsp;<span class="num" id="4409521">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409525">ix</span>&nbsp;<span class="op" id="4409528">+=</span>&nbsp;<span class="num" id="4409531">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409535">next</span>&nbsp;<span class="op" id="4409540">=</span>&nbsp;<span class="builtinfunc" id="4409542">append</span><span class="op" id="4409548">(</span><span class="ident" id="4409549">next</span><span class="op" id="4409553">,</span>&nbsp;<span class="ident" id="4409555">pc</span><span class="op" id="4409557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409561">return</span>&nbsp;<span class="builtintype" id="4409568">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409578">for</span>&nbsp;<span class="ident" id="4409582">lx</span>&nbsp;<span class="op" id="4409585">&lt;</span>&nbsp;<span class="ident" id="4409587">leftLen</span>&nbsp;<span class="op" id="4409595">||</span>&nbsp;<span class="ident" id="4409598">rx</span>&nbsp;<span class="op" id="4409601">&lt;</span>&nbsp;<span class="ident" id="4409603">rightLen</span>&nbsp;<span class="op" id="4409612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409616">switch</span>&nbsp;<span class="op" id="4409623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409627">case</span>&nbsp;<span class="ident" id="4409632">rx</span>&nbsp;<span class="op" id="4409635">&gt;=</span>&nbsp;<span class="ident" id="4409638">rightLen</span><span class="op" id="4409646">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409651">ok</span>&nbsp;<span class="op" id="4409654">=</span>&nbsp;<span class="ident" id="4409656">extend</span><span class="op" id="4409662">(</span><span class="op" id="4409663">&amp;</span><span class="ident" id="4409664">lx</span><span class="op" id="4409666">,</span>&nbsp;<span class="ident" id="4409668">leftRunes</span><span class="op" id="4409677">,</span>&nbsp;<span class="ident" id="4409679">leftPC</span><span class="op" id="4409685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409689">case</span>&nbsp;<span class="ident" id="4409694">lx</span>&nbsp;<span class="op" id="4409697">&gt;=</span>&nbsp;<span class="ident" id="4409700">leftLen</span><span class="op" id="4409707">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409712">ok</span>&nbsp;<span class="op" id="4409715">=</span>&nbsp;<span class="ident" id="4409717">extend</span><span class="op" id="4409723">(</span><span class="op" id="4409724">&amp;</span><span class="ident" id="4409725">rx</span><span class="op" id="4409727">,</span>&nbsp;<span class="ident" id="4409729">rightRunes</span><span class="op" id="4409739">,</span>&nbsp;<span class="ident" id="4409741">rightPC</span><span class="op" id="4409748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409752">case</span>&nbsp;<span class="op" id="4409757">(</span><span class="op" id="4409758">*</span><span class="ident" id="4409759">rightRunes</span><span class="op" id="4409769">)</span><span class="op" id="4409770">[</span><span class="ident" id="4409771">rx</span><span class="op" id="4409773">]</span>&nbsp;<span class="op" id="4409775">&lt;</span>&nbsp;<span class="op" id="4409777">(</span><span class="op" id="4409778">*</span><span class="ident" id="4409779">leftRunes</span><span class="op" id="4409788">)</span><span class="op" id="4409789">[</span><span class="ident" id="4409790">lx</span><span class="op" id="4409792">]</span><span class="op" id="4409793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409798">ok</span>&nbsp;<span class="op" id="4409801">=</span>&nbsp;<span class="ident" id="4409803">extend</span><span class="op" id="4409809">(</span><span class="op" id="4409810">&amp;</span><span class="ident" id="4409811">rx</span><span class="op" id="4409813">,</span>&nbsp;<span class="ident" id="4409815">rightRunes</span><span class="op" id="4409825">,</span>&nbsp;<span class="ident" id="4409827">rightPC</span><span class="op" id="4409834">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409838">default</span><span class="op" id="4409845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4409850">ok</span>&nbsp;<span class="op" id="4409853">=</span>&nbsp;<span class="ident" id="4409855">extend</span><span class="op" id="4409861">(</span><span class="op" id="4409862">&amp;</span><span class="ident" id="4409863">lx</span><span class="op" id="4409865">,</span>&nbsp;<span class="ident" id="4409867">leftRunes</span><span class="op" id="4409876">,</span>&nbsp;<span class="ident" id="4409878">leftPC</span><span class="op" id="4409884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409892">if</span>&nbsp;<span class="op" id="4409895">!</span><span class="ident" id="4409896">ok</span>&nbsp;<span class="op" id="4409899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409904">return</span>&nbsp;<span class="ident" id="4409911">noRune</span><span class="op" id="4409917">,</span>&nbsp;<span class="ident" id="4409919">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4409931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4409934">return</span>&nbsp;<span class="ident" id="4409941">merged</span><span class="op" id="4409947">,</span>&nbsp;<span class="ident" id="4409949">next</span><br>
<span class="lineno"></span><span class="op" id="4409954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="4409957">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="4410041">func</span>&nbsp;<span class="ident" id="4410046">cleanupOnePass</span><span class="op" id="4410060">(</span><span class="ident" id="4410061">prog</span>&nbsp;<span class="op" id="4410066">*</span><span class="ident" id="4410067">onePassProg</span><span class="op" id="4410078">,</span>&nbsp;<span class="ident" id="4410080">original</span>&nbsp;<span class="op" id="4410089">*</span><span class="ident" id="4410090">syntax</span><span class="op" id="4410096">.</span><span class="ident" id="4410097">Prog</span><span class="op" id="4410101">)</span>&nbsp;<span class="op" id="4410103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4410106">for</span>&nbsp;<span class="ident" id="4410110">ix</span><span class="op" id="4410112">,</span>&nbsp;<span class="ident" id="4410114">instOriginal</span>&nbsp;<span class="op" id="4410127">:=</span>&nbsp;<span class="keyword" id="4410130">range</span>&nbsp;<span class="ident" id="4410136">original</span><span class="op" id="4410144">.</span><span class="ident" id="4410145">Inst</span>&nbsp;<span class="op" id="4410150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4410154">switch</span>&nbsp;<span class="ident" id="4410161">instOriginal</span><span class="op" id="4410173">.</span><span class="ident" id="4410174">Op</span>&nbsp;<span class="op" id="4410177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4410181">case</span>&nbsp;<span class="ident" id="4410186">syntax</span><span class="op" id="4410192">.</span><span class="ident" id="4410193">InstAlt</span><span class="op" id="4410200">,</span>&nbsp;<span class="ident" id="4410202">syntax</span><span class="op" id="4410208">.</span><span class="ident" id="4410209">InstAltMatch</span><span class="op" id="4410221">,</span>&nbsp;<span class="ident" id="4410223">syntax</span><span class="op" id="4410229">.</span><span class="ident" id="4410230">InstRune</span><span class="op" id="4410238">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4410242">case</span>&nbsp;<span class="ident" id="4410247">syntax</span><span class="op" id="4410253">.</span><span class="ident" id="4410254">InstCapture</span><span class="op" id="4410265">,</span>&nbsp;<span class="ident" id="4410267">syntax</span><span class="op" id="4410273">.</span><span class="ident" id="4410274">InstEmptyWidth</span><span class="op" id="4410288">,</span>&nbsp;<span class="ident" id="4410290">syntax</span><span class="op" id="4410296">.</span><span class="ident" id="4410297">InstNop</span><span class="op" id="4410304">,</span>&nbsp;<span class="ident" id="4410306">syntax</span><span class="op" id="4410312">.</span><span class="ident" id="4410313">InstMatch</span><span class="op" id="4410322">,</span>&nbsp;<span class="ident" id="4410324">syntax</span><span class="op" id="4410330">.</span><span class="ident" id="4410331">InstFail</span><span class="op" id="4410339">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410344">prog</span><span class="op" id="4410348">.</span><span class="ident" id="4410349">Inst</span><span class="op" id="4410353">[</span><span class="ident" id="4410354">ix</span><span class="op" id="4410356">]</span><span class="op" id="4410357">.</span><span class="ident" id="4410358">Next</span>&nbsp;<span class="op" id="4410363">=</span>&nbsp;<span class="ident" id="4410365">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4410371">case</span>&nbsp;<span class="ident" id="4410376">syntax</span><span class="op" id="4410382">.</span><span class="ident" id="4410383">InstRune1</span><span class="op" id="4410392">,</span>&nbsp;<span class="ident" id="4410394">syntax</span><span class="op" id="4410400">.</span><span class="ident" id="4410401">InstRuneAny</span><span class="op" id="4410412">,</span>&nbsp;<span class="ident" id="4410414">syntax</span><span class="op" id="4410420">.</span><span class="ident" id="4410421">InstRuneAnyNotNL</span><span class="op" id="4410437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410442">prog</span><span class="op" id="4410446">.</span><span class="ident" id="4410447">Inst</span><span class="op" id="4410451">[</span><span class="ident" id="4410452">ix</span><span class="op" id="4410454">]</span><span class="op" id="4410455">.</span><span class="ident" id="4410456">Next</span>&nbsp;<span class="op" id="4410461">=</span>&nbsp;<span class="ident" id="4410463">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410470">prog</span><span class="op" id="4410474">.</span><span class="ident" id="4410475">Inst</span><span class="op" id="4410479">[</span><span class="ident" id="4410480">ix</span><span class="op" id="4410482">]</span>&nbsp;<span class="op" id="4410484">=</span>&nbsp;<span class="ident" id="4410486">onePassInst</span><span class="op" id="4410497">{</span><span class="ident" id="4410498">Inst</span><span class="op" id="4410502">:</span>&nbsp;<span class="ident" id="4410504">instOriginal</span><span class="op" id="4410516">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4410520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4410523">}</span><br>
<span class="lineno"></span><span class="op" id="4410525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4410528">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="4410605">func</span>&nbsp;<span class="ident" id="4410610">onePassCopy</span><span class="op" id="4410621">(</span><span class="ident" id="4410622">prog</span>&nbsp;<span class="op" id="4410627">*</span><span class="ident" id="4410628">syntax</span><span class="op" id="4410634">.</span><span class="ident" id="4410635">Prog</span><span class="op" id="4410639">)</span>&nbsp;<span class="op" id="4410641">*</span><span class="ident" id="4410642">onePassProg</span>&nbsp;<span class="op" id="4410654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410657">p</span>&nbsp;<span class="op" id="4410659">:=</span>&nbsp;<span class="op" id="4410662">&amp;</span><span class="ident" id="4410663">onePassProg</span><span class="op" id="4410674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410678">Start</span><span class="op" id="4410683">:</span>&nbsp;&nbsp;<span class="ident" id="4410686">prog</span><span class="op" id="4410690">.</span><span class="ident" id="4410691">Start</span><span class="op" id="4410696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410700">NumCap</span><span class="op" id="4410706">:</span>&nbsp;<span class="ident" id="4410708">prog</span><span class="op" id="4410712">.</span><span class="ident" id="4410713">NumCap</span><span class="op" id="4410719">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4410722">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4410725">for</span>&nbsp;<span class="ident" id="4410729">_</span><span class="op" id="4410730">,</span>&nbsp;<span class="ident" id="4410732">inst</span>&nbsp;<span class="op" id="4410737">:=</span>&nbsp;<span class="keyword" id="4410740">range</span>&nbsp;<span class="ident" id="4410746">prog</span><span class="op" id="4410750">.</span><span class="ident" id="4410751">Inst</span>&nbsp;<span class="op" id="4410756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4410760">p</span><span class="op" id="4410761">.</span><span class="ident" id="4410762">Inst</span>&nbsp;<span class="op" id="4410767">=</span>&nbsp;<span class="builtinfunc" id="4410769">append</span><span class="op" id="4410775">(</span><span class="ident" id="4410776">p</span><span class="op" id="4410777">.</span><span class="ident" id="4410778">Inst</span><span class="op" id="4410782">,</span>&nbsp;<span class="ident" id="4410784">onePassInst</span><span class="op" id="4410795">{</span><span class="ident" id="4410796">Inst</span><span class="op" id="4410800">:</span>&nbsp;<span class="ident" id="4410802">inst</span><span class="op" id="4410806">}</span><span class="op" id="4410807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4410810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4410814">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4410889">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4410965">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411001">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411032">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411063">for</span>&nbsp;<span class="ident" id="4411067">pc</span>&nbsp;<span class="op" id="4411070">:=</span>&nbsp;<span class="keyword" id="4411073">range</span>&nbsp;<span class="ident" id="4411079">p</span><span class="op" id="4411080">.</span><span class="ident" id="4411081">Inst</span>&nbsp;<span class="op" id="4411086">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411090">switch</span>&nbsp;<span class="ident" id="4411097">p</span><span class="op" id="4411098">.</span><span class="ident" id="4411099">Inst</span><span class="op" id="4411103">[</span><span class="ident" id="4411104">pc</span><span class="op" id="4411106">]</span><span class="op" id="4411107">.</span><span class="ident" id="4411108">Op</span>&nbsp;<span class="op" id="4411111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411115">default</span><span class="op" id="4411122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411127">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411138">case</span>&nbsp;<span class="ident" id="4411143">syntax</span><span class="op" id="4411149">.</span><span class="ident" id="4411150">InstAlt</span><span class="op" id="4411157">,</span>&nbsp;<span class="ident" id="4411159">syntax</span><span class="op" id="4411165">.</span><span class="ident" id="4411166">InstAltMatch</span><span class="op" id="4411178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411183">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411201">p_A_Other</span>&nbsp;<span class="op" id="4411211">:=</span>&nbsp;<span class="op" id="4411214">&amp;</span><span class="ident" id="4411215">p</span><span class="op" id="4411216">.</span><span class="ident" id="4411217">Inst</span><span class="op" id="4411221">[</span><span class="ident" id="4411222">pc</span><span class="op" id="4411224">]</span><span class="op" id="4411225">.</span><span class="ident" id="4411226">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411233">p_A_Alt</span>&nbsp;<span class="op" id="4411241">:=</span>&nbsp;<span class="op" id="4411244">&amp;</span><span class="ident" id="4411245">p</span><span class="op" id="4411246">.</span><span class="ident" id="4411247">Inst</span><span class="op" id="4411251">[</span><span class="ident" id="4411252">pc</span><span class="op" id="4411254">]</span><span class="op" id="4411255">.</span><span class="ident" id="4411256">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411263">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411303">instAlt</span>&nbsp;<span class="op" id="4411311">:=</span>&nbsp;<span class="ident" id="4411314">p</span><span class="op" id="4411315">.</span><span class="ident" id="4411316">Inst</span><span class="op" id="4411320">[</span><span class="op" id="4411321">*</span><span class="ident" id="4411322">p_A_Alt</span><span class="op" id="4411329">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411334">if</span>&nbsp;<span class="op" id="4411337">!</span><span class="op" id="4411338">(</span><span class="ident" id="4411339">instAlt</span><span class="op" id="4411346">.</span><span class="ident" id="4411347">Op</span>&nbsp;<span class="op" id="4411350">==</span>&nbsp;<span class="ident" id="4411353">syntax</span><span class="op" id="4411359">.</span><span class="ident" id="4411360">InstAlt</span>&nbsp;<span class="op" id="4411368">||</span>&nbsp;<span class="ident" id="4411371">instAlt</span><span class="op" id="4411378">.</span><span class="ident" id="4411379">Op</span>&nbsp;<span class="op" id="4411382">==</span>&nbsp;<span class="ident" id="4411385">syntax</span><span class="op" id="4411391">.</span><span class="ident" id="4411392">InstAltMatch</span><span class="op" id="4411404">)</span>&nbsp;<span class="op" id="4411406">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411412">p_A_Alt</span><span class="op" id="4411419">,</span>&nbsp;<span class="ident" id="4411421">p_A_Other</span>&nbsp;<span class="op" id="4411431">=</span>&nbsp;<span class="ident" id="4411433">p_A_Other</span><span class="op" id="4411442">,</span>&nbsp;<span class="ident" id="4411444">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411456">instAlt</span>&nbsp;<span class="op" id="4411464">=</span>&nbsp;<span class="ident" id="4411466">p</span><span class="op" id="4411467">.</span><span class="ident" id="4411468">Inst</span><span class="op" id="4411472">[</span><span class="op" id="4411473">*</span><span class="ident" id="4411474">p_A_Alt</span><span class="op" id="4411481">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411487">if</span>&nbsp;<span class="op" id="4411490">!</span><span class="op" id="4411491">(</span><span class="ident" id="4411492">instAlt</span><span class="op" id="4411499">.</span><span class="ident" id="4411500">Op</span>&nbsp;<span class="op" id="4411503">==</span>&nbsp;<span class="ident" id="4411506">syntax</span><span class="op" id="4411512">.</span><span class="ident" id="4411513">InstAlt</span>&nbsp;<span class="op" id="4411521">||</span>&nbsp;<span class="ident" id="4411524">instAlt</span><span class="op" id="4411531">.</span><span class="ident" id="4411532">Op</span>&nbsp;<span class="op" id="4411535">==</span>&nbsp;<span class="ident" id="4411538">syntax</span><span class="op" id="4411544">.</span><span class="ident" id="4411545">InstAltMatch</span><span class="op" id="4411557">)</span>&nbsp;<span class="op" id="4411559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411566">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411579">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411589">instOther</span>&nbsp;<span class="op" id="4411599">:=</span>&nbsp;<span class="ident" id="4411602">p</span><span class="op" id="4411603">.</span><span class="ident" id="4411604">Inst</span><span class="op" id="4411608">[</span><span class="op" id="4411609">*</span><span class="ident" id="4411610">p_A_Other</span><span class="op" id="4411619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411624">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411686">if</span>&nbsp;<span class="ident" id="4411689">instOther</span><span class="op" id="4411698">.</span><span class="ident" id="4411699">Op</span>&nbsp;<span class="op" id="4411702">==</span>&nbsp;<span class="ident" id="4411705">syntax</span><span class="op" id="4411711">.</span><span class="ident" id="4411712">InstAlt</span>&nbsp;<span class="op" id="4411720">||</span>&nbsp;<span class="ident" id="4411723">instOther</span><span class="op" id="4411732">.</span><span class="ident" id="4411733">Op</span>&nbsp;<span class="op" id="4411736">==</span>&nbsp;<span class="ident" id="4411739">syntax</span><span class="op" id="4411745">.</span><span class="ident" id="4411746">InstAltMatch</span>&nbsp;<span class="op" id="4411759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411765">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411788">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4411800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411805">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4411840">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411873">p_B_Alt</span>&nbsp;<span class="op" id="4411881">:=</span>&nbsp;<span class="op" id="4411884">&amp;</span><span class="ident" id="4411885">p</span><span class="op" id="4411886">.</span><span class="ident" id="4411887">Inst</span><span class="op" id="4411891">[</span><span class="op" id="4411892">*</span><span class="ident" id="4411893">p_A_Alt</span><span class="op" id="4411900">]</span><span class="op" id="4411901">.</span><span class="ident" id="4411902">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411909">p_B_Other</span>&nbsp;<span class="op" id="4411919">:=</span>&nbsp;<span class="op" id="4411922">&amp;</span><span class="ident" id="4411923">p</span><span class="op" id="4411924">.</span><span class="ident" id="4411925">Inst</span><span class="op" id="4411929">[</span><span class="op" id="4411930">*</span><span class="ident" id="4411931">p_A_Alt</span><span class="op" id="4411938">]</span><span class="op" id="4411939">.</span><span class="ident" id="4411940">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4411947">patch</span>&nbsp;<span class="op" id="4411953">:=</span>&nbsp;<span class="builtintype" id="4411956">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4411965">if</span>&nbsp;<span class="ident" id="4411968">instAlt</span><span class="op" id="4411975">.</span><span class="ident" id="4411976">Out</span>&nbsp;<span class="op" id="4411980">==</span>&nbsp;<span class="builtintype" id="4411983">uint32</span><span class="op" id="4411989">(</span><span class="ident" id="4411990">pc</span><span class="op" id="4411992">)</span>&nbsp;<span class="op" id="4411994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4412000">patch</span>&nbsp;<span class="op" id="4412006">=</span>&nbsp;<span class="builtintype" id="4412008">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412016">}</span>&nbsp;<span class="keyword" id="4412018">else</span>&nbsp;<span class="keyword" id="4412023">if</span>&nbsp;<span class="ident" id="4412026">instAlt</span><span class="op" id="4412033">.</span><span class="ident" id="4412034">Arg</span>&nbsp;<span class="op" id="4412038">==</span>&nbsp;<span class="builtintype" id="4412041">uint32</span><span class="op" id="4412047">(</span><span class="ident" id="4412048">pc</span><span class="op" id="4412050">)</span>&nbsp;<span class="op" id="4412052">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4412058">patch</span>&nbsp;<span class="op" id="4412064">=</span>&nbsp;<span class="builtintype" id="4412066">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4412075">p_B_Alt</span><span class="op" id="4412082">,</span>&nbsp;<span class="ident" id="4412084">p_B_Other</span>&nbsp;<span class="op" id="4412094">=</span>&nbsp;<span class="ident" id="4412096">p_B_Other</span><span class="op" id="4412105">,</span>&nbsp;<span class="ident" id="4412107">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4412123">if</span>&nbsp;<span class="ident" id="4412126">patch</span>&nbsp;<span class="op" id="4412132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412138">*</span><span class="ident" id="4412139">p_B_Alt</span>&nbsp;<span class="op" id="4412147">=</span>&nbsp;<span class="op" id="4412149">*</span><span class="ident" id="4412150">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4412169">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4412209">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4412242">if</span>&nbsp;<span class="op" id="4412245">*</span><span class="ident" id="4412246">p_A_Other</span>&nbsp;<span class="op" id="4412256">==</span>&nbsp;<span class="op" id="4412259">*</span><span class="ident" id="4412260">p_B_Alt</span>&nbsp;<span class="op" id="4412268">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412274">*</span><span class="ident" id="4412275">p_A_Alt</span>&nbsp;<span class="op" id="4412283">=</span>&nbsp;<span class="op" id="4412285">*</span><span class="ident" id="4412286">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4412306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4412309">return</span>&nbsp;<span class="ident" id="4412316">p</span><br>
<span class="lineno">280</span><span class="op" id="4412318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4412321">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="4412386">type</span>&nbsp;<span class="ident" id="4412391">runeSlice</span>&nbsp;<span class="op" id="4412401">[</span><span class="op" id="4412402">]</span><span class="builtintype" id="4412403">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="4412409">func</span>&nbsp;<span class="op" id="4412414">(</span><span class="ident" id="4412415">p</span>&nbsp;<span class="ident" id="4412417">runeSlice</span><span class="op" id="4412426">)</span>&nbsp;<span class="ident" id="4412428">Len</span><span class="op" id="4412431">(</span><span class="op" id="4412432">)</span>&nbsp;<span class="builtintype" id="4412434">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4412448">{</span>&nbsp;<span class="keyword" id="4412450">return</span>&nbsp;<span class="builtinfunc" id="4412457">len</span><span class="op" id="4412460">(</span><span class="ident" id="4412461">p</span><span class="op" id="4412462">)</span>&nbsp;<span class="op" id="4412464">}</span><br>
<span class="lineno"></span><span class="keyword" id="4412466">func</span>&nbsp;<span class="op" id="4412471">(</span><span class="ident" id="4412472">p</span>&nbsp;<span class="ident" id="4412474">runeSlice</span><span class="op" id="4412483">)</span>&nbsp;<span class="ident" id="4412485">Less</span><span class="op" id="4412489">(</span><span class="ident" id="4412490">i</span><span class="op" id="4412491">,</span>&nbsp;<span class="ident" id="4412493">j</span>&nbsp;<span class="builtintype" id="4412495">int</span><span class="op" id="4412498">)</span>&nbsp;<span class="builtintype" id="4412500">bool</span>&nbsp;<span class="op" id="4412505">{</span>&nbsp;<span class="keyword" id="4412507">return</span>&nbsp;<span class="ident" id="4412514">p</span><span class="op" id="4412515">[</span><span class="ident" id="4412516">i</span><span class="op" id="4412517">]</span>&nbsp;<span class="op" id="4412519">&lt;</span>&nbsp;<span class="ident" id="4412521">p</span><span class="op" id="4412522">[</span><span class="ident" id="4412523">j</span><span class="op" id="4412524">]</span>&nbsp;<span class="op" id="4412526">}</span><br>
<span class="lineno"></span><span class="keyword" id="4412528">func</span>&nbsp;<span class="op" id="4412533">(</span><span class="ident" id="4412534">p</span>&nbsp;<span class="ident" id="4412536">runeSlice</span><span class="op" id="4412545">)</span>&nbsp;<span class="ident" id="4412547">Swap</span><span class="op" id="4412551">(</span><span class="ident" id="4412552">i</span><span class="op" id="4412553">,</span>&nbsp;<span class="ident" id="4412555">j</span>&nbsp;<span class="builtintype" id="4412557">int</span><span class="op" id="4412560">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4412567">{</span>&nbsp;<span class="ident" id="4412569">p</span><span class="op" id="4412570">[</span><span class="ident" id="4412571">i</span><span class="op" id="4412572">]</span><span class="op" id="4412573">,</span>&nbsp;<span class="ident" id="4412575">p</span><span class="op" id="4412576">[</span><span class="ident" id="4412577">j</span><span class="op" id="4412578">]</span>&nbsp;<span class="op" id="4412580">=</span>&nbsp;<span class="ident" id="4412582">p</span><span class="op" id="4412583">[</span><span class="ident" id="4412584">j</span><span class="op" id="4412585">]</span><span class="op" id="4412586">,</span>&nbsp;<span class="ident" id="4412588">p</span><span class="op" id="4412589">[</span><span class="ident" id="4412590">i</span><span class="op" id="4412591">]</span>&nbsp;<span class="op" id="4412593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4412596">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="4412629">func</span>&nbsp;<span class="op" id="4412634">(</span><span class="ident" id="4412635">p</span>&nbsp;<span class="ident" id="4412637">runeSlice</span><span class="op" id="4412646">)</span>&nbsp;<span class="ident" id="4412648">Sort</span><span class="op" id="4412652">(</span><span class="op" id="4412653">)</span>&nbsp;<span class="op" id="4412655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4412658">sort</span><span class="op" id="4412662">.</span><span class="ident" id="4412663">Sort</span><span class="op" id="4412667">(</span><span class="ident" id="4412668">p</span><span class="op" id="4412669">)</span><br>
<span class="lineno"></span><span class="op" id="4412671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4412674">var</span>&nbsp;<span class="ident" id="4412678">anyRuneNotNL</span>&nbsp;<span class="op" id="4412691">=</span>&nbsp;<span class="op" id="4412693">[</span><span class="op" id="4412694">]</span><span class="builtintype" id="4412695">rune</span><span class="op" id="4412699">{</span><span class="num" id="4412700">0</span><span class="op" id="4412701">,</span>&nbsp;<span class="string" id="4412703">&#39;\n&#39;</span>&nbsp;<span class="op" id="4412708">-</span>&nbsp;<span class="num" id="4412710">1</span><span class="op" id="4412711">,</span>&nbsp;<span class="string" id="4412713">&#39;\n&#39;</span>&nbsp;<span class="op" id="4412718">+</span>&nbsp;<span class="num" id="4412720">1</span><span class="op" id="4412721">,</span>&nbsp;<span class="ident" id="4412723">unicode</span><span class="op" id="4412730">.</span><span class="ident" id="4412731">MaxRune</span><span class="op" id="4412738">}</span><br>
<span class="lineno">295</span><span class="keyword" id="4412740">var</span>&nbsp;<span class="ident" id="4412744">anyRune</span>&nbsp;<span class="op" id="4412752">=</span>&nbsp;<span class="op" id="4412754">[</span><span class="op" id="4412755">]</span><span class="builtintype" id="4412756">rune</span><span class="op" id="4412760">{</span><span class="num" id="4412761">0</span><span class="op" id="4412762">,</span>&nbsp;<span class="ident" id="4412764">unicode</span><span class="op" id="4412771">.</span><span class="ident" id="4412772">MaxRune</span><span class="op" id="4412779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4412782">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="4412864">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="4412945">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="4413025">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="4413100">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="4413128">func</span>&nbsp;<span class="ident" id="4413133">makeOnePass</span><span class="op" id="4413144">(</span><span class="ident" id="4413145">p</span>&nbsp;<span class="op" id="4413147">*</span><span class="ident" id="4413148">onePassProg</span><span class="op" id="4413159">)</span>&nbsp;<span class="op" id="4413161">*</span><span class="ident" id="4413162">onePassProg</span>&nbsp;<span class="op" id="4413174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413177">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413267">if</span>&nbsp;<span class="builtinfunc" id="4413270">len</span><span class="op" id="4413273">(</span><span class="ident" id="4413274">p</span><span class="op" id="4413275">.</span><span class="ident" id="4413276">Inst</span><span class="op" id="4413280">)</span>&nbsp;<span class="op" id="4413282">&gt;=</span>&nbsp;<span class="num" id="4413285">1000</span>&nbsp;<span class="op" id="4413290">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413294">return</span>&nbsp;<span class="ident" id="4413301">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4413313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413317">var</span>&nbsp;<span class="op" id="4413321">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413325">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4413338">=</span>&nbsp;<span class="ident" id="4413340">newQueue</span><span class="op" id="4413348">(</span><span class="builtinfunc" id="4413349">len</span><span class="op" id="4413352">(</span><span class="ident" id="4413353">p</span><span class="op" id="4413354">.</span><span class="ident" id="4413355">Inst</span><span class="op" id="4413359">)</span><span class="op" id="4413360">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413364">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4413377">=</span>&nbsp;<span class="ident" id="4413379">newQueue</span><span class="op" id="4413387">(</span><span class="builtinfunc" id="4413388">len</span><span class="op" id="4413391">(</span><span class="ident" id="4413392">p</span><span class="op" id="4413393">.</span><span class="ident" id="4413394">Inst</span><span class="op" id="4413398">)</span><span class="op" id="4413399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413403">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4413416">func</span><span class="op" id="4413420">(</span><span class="builtintype" id="4413421">uint32</span><span class="op" id="4413427">,</span>&nbsp;<span class="op" id="4413429">*</span><span class="ident" id="4413430">queueOnePass</span><span class="op" id="4413442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413446">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4413459">func</span><span class="op" id="4413463">(</span><span class="builtintype" id="4413464">uint32</span><span class="op" id="4413470">,</span>&nbsp;<span class="keyword" id="4413472">map</span><span class="op" id="4413475">[</span><span class="builtintype" id="4413476">uint32</span><span class="op" id="4413482">]</span><span class="builtintype" id="4413483">bool</span><span class="op" id="4413487">)</span>&nbsp;<span class="builtintype" id="4413489">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413496">onePassRunes</span>&nbsp;<span class="op" id="4413509">=</span>&nbsp;<span class="builtinfunc" id="4413511">make</span><span class="op" id="4413515">(</span><span class="op" id="4413516">[</span><span class="op" id="4413517">]</span><span class="op" id="4413518">[</span><span class="op" id="4413519">]</span><span class="builtintype" id="4413520">rune</span><span class="op" id="4413524">,</span>&nbsp;<span class="builtinfunc" id="4413526">len</span><span class="op" id="4413529">(</span><span class="ident" id="4413530">p</span><span class="op" id="4413531">.</span><span class="ident" id="4413532">Inst</span><span class="op" id="4413536">)</span><span class="op" id="4413537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4413540">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413543">build</span>&nbsp;<span class="op" id="4413549">=</span>&nbsp;<span class="keyword" id="4413551">func</span><span class="op" id="4413555">(</span><span class="ident" id="4413556">pc</span>&nbsp;<span class="builtintype" id="4413559">uint32</span><span class="op" id="4413565">,</span>&nbsp;<span class="ident" id="4413567">q</span>&nbsp;<span class="op" id="4413569">*</span><span class="ident" id="4413570">queueOnePass</span><span class="op" id="4413582">)</span>&nbsp;<span class="op" id="4413584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413588">if</span>&nbsp;<span class="ident" id="4413591">q</span><span class="op" id="4413592">.</span><span class="ident" id="4413593">contains</span><span class="op" id="4413601">(</span><span class="ident" id="4413602">pc</span><span class="op" id="4413604">)</span>&nbsp;<span class="op" id="4413606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413611">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4413620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413624">inst</span>&nbsp;<span class="op" id="4413629">:=</span>&nbsp;<span class="ident" id="4413632">p</span><span class="op" id="4413633">.</span><span class="ident" id="4413634">Inst</span><span class="op" id="4413638">[</span><span class="ident" id="4413639">pc</span><span class="op" id="4413641">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413645">switch</span>&nbsp;<span class="ident" id="4413652">inst</span><span class="op" id="4413656">.</span><span class="ident" id="4413657">Op</span>&nbsp;<span class="op" id="4413660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413664">case</span>&nbsp;<span class="ident" id="4413669">syntax</span><span class="op" id="4413675">.</span><span class="ident" id="4413676">InstAlt</span><span class="op" id="4413683">,</span>&nbsp;<span class="ident" id="4413685">syntax</span><span class="op" id="4413691">.</span><span class="ident" id="4413692">InstAltMatch</span><span class="op" id="4413704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413709">q</span><span class="op" id="4413710">.</span><span class="ident" id="4413711">insert</span><span class="op" id="4413717">(</span><span class="ident" id="4413718">inst</span><span class="op" id="4413722">.</span><span class="ident" id="4413723">Out</span><span class="op" id="4413726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413731">build</span><span class="op" id="4413736">(</span><span class="ident" id="4413737">inst</span><span class="op" id="4413741">.</span><span class="ident" id="4413742">Out</span><span class="op" id="4413745">,</span>&nbsp;<span class="ident" id="4413747">q</span><span class="op" id="4413748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413753">q</span><span class="op" id="4413754">.</span><span class="ident" id="4413755">insert</span><span class="op" id="4413761">(</span><span class="ident" id="4413762">inst</span><span class="op" id="4413766">.</span><span class="ident" id="4413767">Arg</span><span class="op" id="4413770">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413774">case</span>&nbsp;<span class="ident" id="4413779">syntax</span><span class="op" id="4413785">.</span><span class="ident" id="4413786">InstMatch</span><span class="op" id="4413795">,</span>&nbsp;<span class="ident" id="4413797">syntax</span><span class="op" id="4413803">.</span><span class="ident" id="4413804">InstFail</span><span class="op" id="4413812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4413816">default</span><span class="op" id="4413823">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413828">q</span><span class="op" id="4413829">.</span><span class="ident" id="4413830">insert</span><span class="op" id="4413836">(</span><span class="ident" id="4413837">inst</span><span class="op" id="4413841">.</span><span class="ident" id="4413842">Out</span><span class="op" id="4413845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4413849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4413852">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413856">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4413936">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4413969">check</span>&nbsp;<span class="op" id="4413975">=</span>&nbsp;<span class="keyword" id="4413977">func</span><span class="op" id="4413981">(</span><span class="ident" id="4413982">pc</span>&nbsp;<span class="builtintype" id="4413985">uint32</span><span class="op" id="4413991">,</span>&nbsp;<span class="ident" id="4413993">m</span>&nbsp;<span class="keyword" id="4413995">map</span><span class="op" id="4413998">[</span><span class="builtintype" id="4413999">uint32</span><span class="op" id="4414005">]</span><span class="builtintype" id="4414006">bool</span><span class="op" id="4414010">)</span>&nbsp;<span class="op" id="4414012">(</span><span class="ident" id="4414013">ok</span>&nbsp;<span class="builtintype" id="4414016">bool</span><span class="op" id="4414020">)</span>&nbsp;<span class="op" id="4414022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414026">ok</span>&nbsp;<span class="op" id="4414029">=</span>&nbsp;<span class="builtintype" id="4414031">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414038">inst</span>&nbsp;<span class="op" id="4414043">:=</span>&nbsp;<span class="op" id="4414046">&amp;</span><span class="ident" id="4414047">p</span><span class="op" id="4414048">.</span><span class="ident" id="4414049">Inst</span><span class="op" id="4414053">[</span><span class="ident" id="4414054">pc</span><span class="op" id="4414056">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414060">if</span>&nbsp;<span class="ident" id="4414063">visitQueue</span><span class="op" id="4414073">.</span><span class="ident" id="4414074">contains</span><span class="op" id="4414082">(</span><span class="ident" id="4414083">pc</span><span class="op" id="4414085">)</span>&nbsp;<span class="op" id="4414087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414092">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414105">visitQueue</span><span class="op" id="4414115">.</span><span class="ident" id="4414116">insert</span><span class="op" id="4414122">(</span><span class="ident" id="4414123">pc</span><span class="op" id="4414125">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414129">switch</span>&nbsp;<span class="ident" id="4414136">inst</span><span class="op" id="4414140">.</span><span class="ident" id="4414141">Op</span>&nbsp;<span class="op" id="4414144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414148">case</span>&nbsp;<span class="ident" id="4414153">syntax</span><span class="op" id="4414159">.</span><span class="ident" id="4414160">InstAlt</span><span class="op" id="4414167">,</span>&nbsp;<span class="ident" id="4414169">syntax</span><span class="op" id="4414175">.</span><span class="ident" id="4414176">InstAltMatch</span><span class="op" id="4414188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414193">ok</span>&nbsp;<span class="op" id="4414196">=</span>&nbsp;<span class="ident" id="4414198">check</span><span class="op" id="4414203">(</span><span class="ident" id="4414204">inst</span><span class="op" id="4414208">.</span><span class="ident" id="4414209">Out</span><span class="op" id="4414212">,</span>&nbsp;<span class="ident" id="4414214">m</span><span class="op" id="4414215">)</span>&nbsp;<span class="op" id="4414217">&amp;&amp;</span>&nbsp;<span class="ident" id="4414220">check</span><span class="op" id="4414225">(</span><span class="ident" id="4414226">inst</span><span class="op" id="4414230">.</span><span class="ident" id="4414231">Arg</span><span class="op" id="4414234">,</span>&nbsp;<span class="ident" id="4414236">m</span><span class="op" id="4414237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4414242">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414282">matchOut</span>&nbsp;<span class="op" id="4414291">:=</span>&nbsp;<span class="ident" id="4414294">m</span><span class="op" id="4414295">[</span><span class="ident" id="4414296">inst</span><span class="op" id="4414300">.</span><span class="ident" id="4414301">Out</span><span class="op" id="4414304">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414309">matchArg</span>&nbsp;<span class="op" id="4414318">:=</span>&nbsp;<span class="ident" id="4414321">m</span><span class="op" id="4414322">[</span><span class="ident" id="4414323">inst</span><span class="op" id="4414327">.</span><span class="ident" id="4414328">Arg</span><span class="op" id="4414331">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414336">if</span>&nbsp;<span class="ident" id="4414339">matchOut</span>&nbsp;<span class="op" id="4414348">&amp;&amp;</span>&nbsp;<span class="ident" id="4414351">matchArg</span>&nbsp;<span class="op" id="4414360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414366">ok</span>&nbsp;<span class="op" id="4414369">=</span>&nbsp;<span class="builtintype" id="4414371">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414381">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414390">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4414395">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414433">if</span>&nbsp;<span class="ident" id="4414436">matchArg</span>&nbsp;<span class="op" id="4414445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414451">inst</span><span class="op" id="4414455">.</span><span class="ident" id="4414456">Out</span><span class="op" id="4414459">,</span>&nbsp;<span class="ident" id="4414461">inst</span><span class="op" id="4414465">.</span><span class="ident" id="4414466">Arg</span>&nbsp;<span class="op" id="4414470">=</span>&nbsp;<span class="ident" id="4414472">inst</span><span class="op" id="4414476">.</span><span class="ident" id="4414477">Arg</span><span class="op" id="4414480">,</span>&nbsp;<span class="ident" id="4414482">inst</span><span class="op" id="4414486">.</span><span class="ident" id="4414487">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414495">matchOut</span><span class="op" id="4414503">,</span>&nbsp;<span class="ident" id="4414505">matchArg</span>&nbsp;<span class="op" id="4414514">=</span>&nbsp;<span class="ident" id="4414516">matchArg</span><span class="op" id="4414524">,</span>&nbsp;<span class="ident" id="4414526">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414538">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414543">if</span>&nbsp;<span class="ident" id="4414546">matchOut</span>&nbsp;<span class="op" id="4414555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414561">m</span><span class="op" id="4414562">[</span><span class="ident" id="4414563">pc</span><span class="op" id="4414565">]</span>&nbsp;<span class="op" id="4414567">=</span>&nbsp;<span class="builtintype" id="4414569">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414578">inst</span><span class="op" id="4414582">.</span><span class="ident" id="4414583">Op</span>&nbsp;<span class="op" id="4414586">=</span>&nbsp;<span class="ident" id="4414588">syntax</span><span class="op" id="4414594">.</span><span class="ident" id="4414595">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4414617">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414679">onePassRunes</span><span class="op" id="4414691">[</span><span class="ident" id="4414692">pc</span><span class="op" id="4414694">]</span><span class="op" id="4414695">,</span>&nbsp;<span class="ident" id="4414697">inst</span><span class="op" id="4414701">.</span><span class="ident" id="4414702">Next</span>&nbsp;<span class="op" id="4414707">=</span>&nbsp;<span class="ident" id="4414709">mergeRuneSets</span><span class="op" id="4414722">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414728">&amp;</span><span class="ident" id="4414729">onePassRunes</span><span class="op" id="4414741">[</span><span class="ident" id="4414742">inst</span><span class="op" id="4414746">.</span><span class="ident" id="4414747">Out</span><span class="op" id="4414750">]</span><span class="op" id="4414751">,</span>&nbsp;<span class="op" id="4414753">&amp;</span><span class="ident" id="4414754">onePassRunes</span><span class="op" id="4414766">[</span><span class="ident" id="4414767">inst</span><span class="op" id="4414771">.</span><span class="ident" id="4414772">Arg</span><span class="op" id="4414775">]</span><span class="op" id="4414776">,</span>&nbsp;<span class="ident" id="4414778">inst</span><span class="op" id="4414782">.</span><span class="ident" id="4414783">Out</span><span class="op" id="4414786">,</span>&nbsp;<span class="ident" id="4414788">inst</span><span class="op" id="4414792">.</span><span class="ident" id="4414793">Arg</span><span class="op" id="4414796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414801">if</span>&nbsp;<span class="builtinfunc" id="4414804">len</span><span class="op" id="4414807">(</span><span class="ident" id="4414808">inst</span><span class="op" id="4414812">.</span><span class="ident" id="4414813">Next</span><span class="op" id="4414817">)</span>&nbsp;<span class="op" id="4414819">&gt;</span>&nbsp;<span class="num" id="4414821">0</span>&nbsp;<span class="op" id="4414823">&amp;&amp;</span>&nbsp;<span class="ident" id="4414826">inst</span><span class="op" id="4414830">.</span><span class="ident" id="4414831">Next</span><span class="op" id="4414835">[</span><span class="num" id="4414836">0</span><span class="op" id="4414837">]</span>&nbsp;<span class="op" id="4414839">==</span>&nbsp;<span class="ident" id="4414842">mergeFailed</span>&nbsp;<span class="op" id="4414854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414860">ok</span>&nbsp;<span class="op" id="4414863">=</span>&nbsp;<span class="builtintype" id="4414865">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414875">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4414884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4414888">case</span>&nbsp;<span class="ident" id="4414893">syntax</span><span class="op" id="4414899">.</span><span class="ident" id="4414900">InstCapture</span><span class="op" id="4414911">,</span>&nbsp;<span class="ident" id="4414913">syntax</span><span class="op" id="4414919">.</span><span class="ident" id="4414920">InstNop</span><span class="op" id="4414927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414932">ok</span>&nbsp;<span class="op" id="4414935">=</span>&nbsp;<span class="ident" id="4414937">check</span><span class="op" id="4414942">(</span><span class="ident" id="4414943">inst</span><span class="op" id="4414947">.</span><span class="ident" id="4414948">Out</span><span class="op" id="4414951">,</span>&nbsp;<span class="ident" id="4414953">m</span><span class="op" id="4414954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4414959">m</span><span class="op" id="4414960">[</span><span class="ident" id="4414961">pc</span><span class="op" id="4414963">]</span>&nbsp;<span class="op" id="4414965">=</span>&nbsp;<span class="ident" id="4414967">m</span><span class="op" id="4414968">[</span><span class="ident" id="4414969">inst</span><span class="op" id="4414973">.</span><span class="ident" id="4414974">Out</span><span class="op" id="4414977">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4414982">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415035">onePassRunes</span><span class="op" id="4415047">[</span><span class="ident" id="4415048">pc</span><span class="op" id="4415050">]</span>&nbsp;<span class="op" id="4415052">=</span>&nbsp;<span class="builtinfunc" id="4415054">append</span><span class="op" id="4415060">(</span><span class="op" id="4415061">[</span><span class="op" id="4415062">]</span><span class="builtintype" id="4415063">rune</span><span class="op" id="4415067">{</span><span class="op" id="4415068">}</span><span class="op" id="4415069">,</span>&nbsp;<span class="ident" id="4415071">onePassRunes</span><span class="op" id="4415083">[</span><span class="ident" id="4415084">inst</span><span class="op" id="4415088">.</span><span class="ident" id="4415089">Out</span><span class="op" id="4415092">]</span><span class="op" id="4415093">...</span><span class="op" id="4415096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415101">inst</span><span class="op" id="4415105">.</span><span class="ident" id="4415106">Next</span>&nbsp;<span class="op" id="4415111">=</span>&nbsp;<span class="op" id="4415113">[</span><span class="op" id="4415114">]</span><span class="builtintype" id="4415115">uint32</span><span class="op" id="4415121">{</span><span class="op" id="4415122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415127">for</span>&nbsp;<span class="ident" id="4415131">i</span>&nbsp;<span class="op" id="4415133">:=</span>&nbsp;<span class="builtinfunc" id="4415136">len</span><span class="op" id="4415139">(</span><span class="ident" id="4415140">onePassRunes</span><span class="op" id="4415152">[</span><span class="ident" id="4415153">pc</span><span class="op" id="4415155">]</span><span class="op" id="4415156">)</span>&nbsp;<span class="op" id="4415158">/</span>&nbsp;<span class="num" id="4415160">2</span><span class="op" id="4415161">;</span>&nbsp;<span class="ident" id="4415163">i</span>&nbsp;<span class="op" id="4415165">&gt;=</span>&nbsp;<span class="num" id="4415168">0</span><span class="op" id="4415169">;</span>&nbsp;<span class="ident" id="4415171">i</span><span class="op" id="4415172">--</span>&nbsp;<span class="op" id="4415175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415181">inst</span><span class="op" id="4415185">.</span><span class="ident" id="4415186">Next</span>&nbsp;<span class="op" id="4415191">=</span>&nbsp;<span class="builtinfunc" id="4415193">append</span><span class="op" id="4415199">(</span><span class="ident" id="4415200">inst</span><span class="op" id="4415204">.</span><span class="ident" id="4415205">Next</span><span class="op" id="4415209">,</span>&nbsp;<span class="ident" id="4415211">inst</span><span class="op" id="4415215">.</span><span class="ident" id="4415216">Out</span><span class="op" id="4415219">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415228">case</span>&nbsp;<span class="ident" id="4415233">syntax</span><span class="op" id="4415239">.</span><span class="ident" id="4415240">InstEmptyWidth</span><span class="op" id="4415254">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415259">ok</span>&nbsp;<span class="op" id="4415262">=</span>&nbsp;<span class="ident" id="4415264">check</span><span class="op" id="4415269">(</span><span class="ident" id="4415270">inst</span><span class="op" id="4415274">.</span><span class="ident" id="4415275">Out</span><span class="op" id="4415278">,</span>&nbsp;<span class="ident" id="4415280">m</span><span class="op" id="4415281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415286">m</span><span class="op" id="4415287">[</span><span class="ident" id="4415288">pc</span><span class="op" id="4415290">]</span>&nbsp;<span class="op" id="4415292">=</span>&nbsp;<span class="ident" id="4415294">m</span><span class="op" id="4415295">[</span><span class="ident" id="4415296">inst</span><span class="op" id="4415300">.</span><span class="ident" id="4415301">Out</span><span class="op" id="4415304">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415309">onePassRunes</span><span class="op" id="4415321">[</span><span class="ident" id="4415322">pc</span><span class="op" id="4415324">]</span>&nbsp;<span class="op" id="4415326">=</span>&nbsp;<span class="builtinfunc" id="4415328">append</span><span class="op" id="4415334">(</span><span class="op" id="4415335">[</span><span class="op" id="4415336">]</span><span class="builtintype" id="4415337">rune</span><span class="op" id="4415341">{</span><span class="op" id="4415342">}</span><span class="op" id="4415343">,</span>&nbsp;<span class="ident" id="4415345">onePassRunes</span><span class="op" id="4415357">[</span><span class="ident" id="4415358">inst</span><span class="op" id="4415362">.</span><span class="ident" id="4415363">Out</span><span class="op" id="4415366">]</span><span class="op" id="4415367">...</span><span class="op" id="4415370">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415375">inst</span><span class="op" id="4415379">.</span><span class="ident" id="4415380">Next</span>&nbsp;<span class="op" id="4415385">=</span>&nbsp;<span class="op" id="4415387">[</span><span class="op" id="4415388">]</span><span class="builtintype" id="4415389">uint32</span><span class="op" id="4415395">{</span><span class="op" id="4415396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415401">for</span>&nbsp;<span class="ident" id="4415405">i</span>&nbsp;<span class="op" id="4415407">:=</span>&nbsp;<span class="builtinfunc" id="4415410">len</span><span class="op" id="4415413">(</span><span class="ident" id="4415414">onePassRunes</span><span class="op" id="4415426">[</span><span class="ident" id="4415427">pc</span><span class="op" id="4415429">]</span><span class="op" id="4415430">)</span>&nbsp;<span class="op" id="4415432">/</span>&nbsp;<span class="num" id="4415434">2</span><span class="op" id="4415435">;</span>&nbsp;<span class="ident" id="4415437">i</span>&nbsp;<span class="op" id="4415439">&gt;=</span>&nbsp;<span class="num" id="4415442">0</span><span class="op" id="4415443">;</span>&nbsp;<span class="ident" id="4415445">i</span><span class="op" id="4415446">--</span>&nbsp;<span class="op" id="4415449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415455">inst</span><span class="op" id="4415459">.</span><span class="ident" id="4415460">Next</span>&nbsp;<span class="op" id="4415465">=</span>&nbsp;<span class="builtinfunc" id="4415467">append</span><span class="op" id="4415473">(</span><span class="ident" id="4415474">inst</span><span class="op" id="4415478">.</span><span class="ident" id="4415479">Next</span><span class="op" id="4415483">,</span>&nbsp;<span class="ident" id="4415485">inst</span><span class="op" id="4415489">.</span><span class="ident" id="4415490">Out</span><span class="op" id="4415493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415502">case</span>&nbsp;<span class="ident" id="4415507">syntax</span><span class="op" id="4415513">.</span><span class="ident" id="4415514">InstMatch</span><span class="op" id="4415523">,</span>&nbsp;<span class="ident" id="4415525">syntax</span><span class="op" id="4415531">.</span><span class="ident" id="4415532">InstFail</span><span class="op" id="4415540">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415545">m</span><span class="op" id="4415546">[</span><span class="ident" id="4415547">pc</span><span class="op" id="4415549">]</span>&nbsp;<span class="op" id="4415551">=</span>&nbsp;<span class="ident" id="4415553">inst</span><span class="op" id="4415557">.</span><span class="ident" id="4415558">Op</span>&nbsp;<span class="op" id="4415561">==</span>&nbsp;<span class="ident" id="4415564">syntax</span><span class="op" id="4415570">.</span><span class="ident" id="4415571">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415584">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415592">case</span>&nbsp;<span class="ident" id="4415597">syntax</span><span class="op" id="4415603">.</span><span class="ident" id="4415604">InstRune</span><span class="op" id="4415612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415617">ok</span>&nbsp;<span class="op" id="4415620">=</span>&nbsp;<span class="ident" id="4415622">check</span><span class="op" id="4415627">(</span><span class="ident" id="4415628">inst</span><span class="op" id="4415632">.</span><span class="ident" id="4415633">Out</span><span class="op" id="4415636">,</span>&nbsp;<span class="ident" id="4415638">m</span><span class="op" id="4415639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415644">m</span><span class="op" id="4415645">[</span><span class="ident" id="4415646">pc</span><span class="op" id="4415648">]</span>&nbsp;<span class="op" id="4415650">=</span>&nbsp;<span class="builtintype" id="4415652">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415661">if</span>&nbsp;<span class="builtinfunc" id="4415664">len</span><span class="op" id="4415667">(</span><span class="ident" id="4415668">inst</span><span class="op" id="4415672">.</span><span class="ident" id="4415673">Next</span><span class="op" id="4415677">)</span>&nbsp;<span class="op" id="4415679">&gt;</span>&nbsp;<span class="num" id="4415681">0</span>&nbsp;<span class="op" id="4415683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415689">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415703">if</span>&nbsp;<span class="builtinfunc" id="4415706">len</span><span class="op" id="4415709">(</span><span class="ident" id="4415710">inst</span><span class="op" id="4415714">.</span><span class="ident" id="4415715">Rune</span><span class="op" id="4415719">)</span>&nbsp;<span class="op" id="4415721">==</span>&nbsp;<span class="num" id="4415724">0</span>&nbsp;<span class="op" id="4415726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415732">onePassRunes</span><span class="op" id="4415744">[</span><span class="ident" id="4415745">pc</span><span class="op" id="4415747">]</span>&nbsp;<span class="op" id="4415749">=</span>&nbsp;<span class="op" id="4415751">[</span><span class="op" id="4415752">]</span><span class="builtintype" id="4415753">rune</span><span class="op" id="4415757">{</span><span class="op" id="4415758">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415764">inst</span><span class="op" id="4415768">.</span><span class="ident" id="4415769">Next</span>&nbsp;<span class="op" id="4415774">=</span>&nbsp;<span class="op" id="4415776">[</span><span class="op" id="4415777">]</span><span class="builtintype" id="4415778">uint32</span><span class="op" id="4415784">{</span><span class="ident" id="4415785">inst</span><span class="op" id="4415789">.</span><span class="ident" id="4415790">Out</span><span class="op" id="4415793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415799">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4415808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415813">runes</span>&nbsp;<span class="op" id="4415819">:=</span>&nbsp;<span class="builtinfunc" id="4415822">make</span><span class="op" id="4415826">(</span><span class="op" id="4415827">[</span><span class="op" id="4415828">]</span><span class="builtintype" id="4415829">rune</span><span class="op" id="4415833">,</span>&nbsp;<span class="num" id="4415835">0</span><span class="op" id="4415836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415841">if</span>&nbsp;<span class="builtinfunc" id="4415844">len</span><span class="op" id="4415847">(</span><span class="ident" id="4415848">inst</span><span class="op" id="4415852">.</span><span class="ident" id="4415853">Rune</span><span class="op" id="4415857">)</span>&nbsp;<span class="op" id="4415859">==</span>&nbsp;<span class="num" id="4415862">1</span>&nbsp;<span class="op" id="4415864">&amp;&amp;</span>&nbsp;<span class="ident" id="4415867">syntax</span><span class="op" id="4415873">.</span><span class="ident" id="4415874">Flags</span><span class="op" id="4415879">(</span><span class="ident" id="4415880">inst</span><span class="op" id="4415884">.</span><span class="ident" id="4415885">Arg</span><span class="op" id="4415888">)</span><span class="op" id="4415889">&amp;</span><span class="ident" id="4415890">syntax</span><span class="op" id="4415896">.</span><span class="ident" id="4415897">FoldCase</span>&nbsp;<span class="op" id="4415906">!=</span>&nbsp;<span class="num" id="4415909">0</span>&nbsp;<span class="op" id="4415911">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415917">r0</span>&nbsp;<span class="op" id="4415920">:=</span>&nbsp;<span class="ident" id="4415923">inst</span><span class="op" id="4415927">.</span><span class="ident" id="4415928">Rune</span><span class="op" id="4415932">[</span><span class="num" id="4415933">0</span><span class="op" id="4415934">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4415940">runes</span>&nbsp;<span class="op" id="4415946">=</span>&nbsp;<span class="builtinfunc" id="4415948">append</span><span class="op" id="4415954">(</span><span class="ident" id="4415955">runes</span><span class="op" id="4415960">,</span>&nbsp;<span class="ident" id="4415962">r0</span><span class="op" id="4415964">,</span>&nbsp;<span class="ident" id="4415966">r0</span><span class="op" id="4415968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4415974">for</span>&nbsp;<span class="ident" id="4415978">r1</span>&nbsp;<span class="op" id="4415981">:=</span>&nbsp;<span class="ident" id="4415984">unicode</span><span class="op" id="4415991">.</span><span class="ident" id="4415992">SimpleFold</span><span class="op" id="4416002">(</span><span class="ident" id="4416003">r0</span><span class="op" id="4416005">)</span><span class="op" id="4416006">;</span>&nbsp;<span class="ident" id="4416008">r1</span>&nbsp;<span class="op" id="4416011">!=</span>&nbsp;<span class="ident" id="4416014">r0</span><span class="op" id="4416016">;</span>&nbsp;<span class="ident" id="4416018">r1</span>&nbsp;<span class="op" id="4416021">=</span>&nbsp;<span class="ident" id="4416023">unicode</span><span class="op" id="4416030">.</span><span class="ident" id="4416031">SimpleFold</span><span class="op" id="4416041">(</span><span class="ident" id="4416042">r1</span><span class="op" id="4416044">)</span>&nbsp;<span class="op" id="4416046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416053">runes</span>&nbsp;<span class="op" id="4416059">=</span>&nbsp;<span class="builtinfunc" id="4416061">append</span><span class="op" id="4416067">(</span><span class="ident" id="4416068">runes</span><span class="op" id="4416073">,</span>&nbsp;<span class="ident" id="4416075">r1</span><span class="op" id="4416077">,</span>&nbsp;<span class="ident" id="4416079">r1</span><span class="op" id="4416081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416087">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416093">sort</span><span class="op" id="4416097">.</span><span class="ident" id="4416098">Sort</span><span class="op" id="4416102">(</span><span class="ident" id="4416103">runeSlice</span><span class="op" id="4416112">(</span><span class="ident" id="4416113">runes</span><span class="op" id="4416118">)</span><span class="op" id="4416119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416124">}</span>&nbsp;<span class="keyword" id="4416126">else</span>&nbsp;<span class="op" id="4416131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416137">runes</span>&nbsp;<span class="op" id="4416143">=</span>&nbsp;<span class="builtinfunc" id="4416145">append</span><span class="op" id="4416151">(</span><span class="ident" id="4416152">runes</span><span class="op" id="4416157">,</span>&nbsp;<span class="ident" id="4416159">inst</span><span class="op" id="4416163">.</span><span class="ident" id="4416164">Rune</span><span class="op" id="4416168">...</span><span class="op" id="4416171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416181">onePassRunes</span><span class="op" id="4416193">[</span><span class="ident" id="4416194">pc</span><span class="op" id="4416196">]</span>&nbsp;<span class="op" id="4416198">=</span>&nbsp;<span class="ident" id="4416200">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416209">inst</span><span class="op" id="4416213">.</span><span class="ident" id="4416214">Next</span>&nbsp;<span class="op" id="4416219">=</span>&nbsp;<span class="op" id="4416221">[</span><span class="op" id="4416222">]</span><span class="builtintype" id="4416223">uint32</span><span class="op" id="4416229">{</span><span class="op" id="4416230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416235">for</span>&nbsp;<span class="ident" id="4416239">i</span>&nbsp;<span class="op" id="4416241">:=</span>&nbsp;<span class="builtinfunc" id="4416244">len</span><span class="op" id="4416247">(</span><span class="ident" id="4416248">onePassRunes</span><span class="op" id="4416260">[</span><span class="ident" id="4416261">pc</span><span class="op" id="4416263">]</span><span class="op" id="4416264">)</span>&nbsp;<span class="op" id="4416266">/</span>&nbsp;<span class="num" id="4416268">2</span><span class="op" id="4416269">;</span>&nbsp;<span class="ident" id="4416271">i</span>&nbsp;<span class="op" id="4416273">&gt;=</span>&nbsp;<span class="num" id="4416276">0</span><span class="op" id="4416277">;</span>&nbsp;<span class="ident" id="4416279">i</span><span class="op" id="4416280">--</span>&nbsp;<span class="op" id="4416283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416289">inst</span><span class="op" id="4416293">.</span><span class="ident" id="4416294">Next</span>&nbsp;<span class="op" id="4416299">=</span>&nbsp;<span class="builtinfunc" id="4416301">append</span><span class="op" id="4416307">(</span><span class="ident" id="4416308">inst</span><span class="op" id="4416312">.</span><span class="ident" id="4416313">Next</span><span class="op" id="4416317">,</span>&nbsp;<span class="ident" id="4416319">inst</span><span class="op" id="4416323">.</span><span class="ident" id="4416324">Out</span><span class="op" id="4416327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416337">inst</span><span class="op" id="4416341">.</span><span class="ident" id="4416342">Op</span>&nbsp;<span class="op" id="4416345">=</span>&nbsp;<span class="ident" id="4416347">syntax</span><span class="op" id="4416353">.</span><span class="ident" id="4416354">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416365">case</span>&nbsp;<span class="ident" id="4416370">syntax</span><span class="op" id="4416376">.</span><span class="ident" id="4416377">InstRune1</span><span class="op" id="4416386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416391">ok</span>&nbsp;<span class="op" id="4416394">=</span>&nbsp;<span class="ident" id="4416396">check</span><span class="op" id="4416401">(</span><span class="ident" id="4416402">inst</span><span class="op" id="4416406">.</span><span class="ident" id="4416407">Out</span><span class="op" id="4416410">,</span>&nbsp;<span class="ident" id="4416412">m</span><span class="op" id="4416413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416418">m</span><span class="op" id="4416419">[</span><span class="ident" id="4416420">pc</span><span class="op" id="4416422">]</span>&nbsp;<span class="op" id="4416424">=</span>&nbsp;<span class="builtintype" id="4416426">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416435">if</span>&nbsp;<span class="builtinfunc" id="4416438">len</span><span class="op" id="4416441">(</span><span class="ident" id="4416442">inst</span><span class="op" id="4416446">.</span><span class="ident" id="4416447">Next</span><span class="op" id="4416451">)</span>&nbsp;<span class="op" id="4416453">&gt;</span>&nbsp;<span class="num" id="4416455">0</span>&nbsp;<span class="op" id="4416457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416463">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416477">runes</span>&nbsp;<span class="op" id="4416483">:=</span>&nbsp;<span class="op" id="4416486">[</span><span class="op" id="4416487">]</span><span class="builtintype" id="4416488">rune</span><span class="op" id="4416492">{</span><span class="op" id="4416493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4416498">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416529">if</span>&nbsp;<span class="ident" id="4416532">syntax</span><span class="op" id="4416538">.</span><span class="ident" id="4416539">Flags</span><span class="op" id="4416544">(</span><span class="ident" id="4416545">inst</span><span class="op" id="4416549">.</span><span class="ident" id="4416550">Arg</span><span class="op" id="4416553">)</span><span class="op" id="4416554">&amp;</span><span class="ident" id="4416555">syntax</span><span class="op" id="4416561">.</span><span class="ident" id="4416562">FoldCase</span>&nbsp;<span class="op" id="4416571">!=</span>&nbsp;<span class="num" id="4416574">0</span>&nbsp;<span class="op" id="4416576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416582">r0</span>&nbsp;<span class="op" id="4416585">:=</span>&nbsp;<span class="ident" id="4416588">inst</span><span class="op" id="4416592">.</span><span class="ident" id="4416593">Rune</span><span class="op" id="4416597">[</span><span class="num" id="4416598">0</span><span class="op" id="4416599">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416605">runes</span>&nbsp;<span class="op" id="4416611">=</span>&nbsp;<span class="builtinfunc" id="4416613">append</span><span class="op" id="4416619">(</span><span class="ident" id="4416620">runes</span><span class="op" id="4416625">,</span>&nbsp;<span class="ident" id="4416627">r0</span><span class="op" id="4416629">,</span>&nbsp;<span class="ident" id="4416631">r0</span><span class="op" id="4416633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416639">for</span>&nbsp;<span class="ident" id="4416643">r1</span>&nbsp;<span class="op" id="4416646">:=</span>&nbsp;<span class="ident" id="4416649">unicode</span><span class="op" id="4416656">.</span><span class="ident" id="4416657">SimpleFold</span><span class="op" id="4416667">(</span><span class="ident" id="4416668">r0</span><span class="op" id="4416670">)</span><span class="op" id="4416671">;</span>&nbsp;<span class="ident" id="4416673">r1</span>&nbsp;<span class="op" id="4416676">!=</span>&nbsp;<span class="ident" id="4416679">r0</span><span class="op" id="4416681">;</span>&nbsp;<span class="ident" id="4416683">r1</span>&nbsp;<span class="op" id="4416686">=</span>&nbsp;<span class="ident" id="4416688">unicode</span><span class="op" id="4416695">.</span><span class="ident" id="4416696">SimpleFold</span><span class="op" id="4416706">(</span><span class="ident" id="4416707">r1</span><span class="op" id="4416709">)</span>&nbsp;<span class="op" id="4416711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416718">runes</span>&nbsp;<span class="op" id="4416724">=</span>&nbsp;<span class="builtinfunc" id="4416726">append</span><span class="op" id="4416732">(</span><span class="ident" id="4416733">runes</span><span class="op" id="4416738">,</span>&nbsp;<span class="ident" id="4416740">r1</span><span class="op" id="4416742">,</span>&nbsp;<span class="ident" id="4416744">r1</span><span class="op" id="4416746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416758">sort</span><span class="op" id="4416762">.</span><span class="ident" id="4416763">Sort</span><span class="op" id="4416767">(</span><span class="ident" id="4416768">runeSlice</span><span class="op" id="4416777">(</span><span class="ident" id="4416778">runes</span><span class="op" id="4416783">)</span><span class="op" id="4416784">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416789">}</span>&nbsp;<span class="keyword" id="4416791">else</span>&nbsp;<span class="op" id="4416796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416802">runes</span>&nbsp;<span class="op" id="4416808">=</span>&nbsp;<span class="builtinfunc" id="4416810">append</span><span class="op" id="4416816">(</span><span class="ident" id="4416817">runes</span><span class="op" id="4416822">,</span>&nbsp;<span class="ident" id="4416824">inst</span><span class="op" id="4416828">.</span><span class="ident" id="4416829">Rune</span><span class="op" id="4416833">[</span><span class="num" id="4416834">0</span><span class="op" id="4416835">]</span><span class="op" id="4416836">,</span>&nbsp;<span class="ident" id="4416838">inst</span><span class="op" id="4416842">.</span><span class="ident" id="4416843">Rune</span><span class="op" id="4416847">[</span><span class="num" id="4416848">0</span><span class="op" id="4416849">]</span><span class="op" id="4416850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4416855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416860">onePassRunes</span><span class="op" id="4416872">[</span><span class="ident" id="4416873">pc</span><span class="op" id="4416875">]</span>&nbsp;<span class="op" id="4416877">=</span>&nbsp;<span class="ident" id="4416879">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416888">inst</span><span class="op" id="4416892">.</span><span class="ident" id="4416893">Next</span>&nbsp;<span class="op" id="4416898">=</span>&nbsp;<span class="op" id="4416900">[</span><span class="op" id="4416901">]</span><span class="builtintype" id="4416902">uint32</span><span class="op" id="4416908">{</span><span class="op" id="4416909">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4416914">for</span>&nbsp;<span class="ident" id="4416918">i</span>&nbsp;<span class="op" id="4416920">:=</span>&nbsp;<span class="builtinfunc" id="4416923">len</span><span class="op" id="4416926">(</span><span class="ident" id="4416927">onePassRunes</span><span class="op" id="4416939">[</span><span class="ident" id="4416940">pc</span><span class="op" id="4416942">]</span><span class="op" id="4416943">)</span>&nbsp;<span class="op" id="4416945">/</span>&nbsp;<span class="num" id="4416947">2</span><span class="op" id="4416948">;</span>&nbsp;<span class="ident" id="4416950">i</span>&nbsp;<span class="op" id="4416952">&gt;=</span>&nbsp;<span class="num" id="4416955">0</span><span class="op" id="4416956">;</span>&nbsp;<span class="ident" id="4416958">i</span><span class="op" id="4416959">--</span>&nbsp;<span class="op" id="4416962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4416968">inst</span><span class="op" id="4416972">.</span><span class="ident" id="4416973">Next</span>&nbsp;<span class="op" id="4416978">=</span>&nbsp;<span class="builtinfunc" id="4416980">append</span><span class="op" id="4416986">(</span><span class="ident" id="4416987">inst</span><span class="op" id="4416991">.</span><span class="ident" id="4416992">Next</span><span class="op" id="4416996">,</span>&nbsp;<span class="ident" id="4416998">inst</span><span class="op" id="4417002">.</span><span class="ident" id="4417003">Out</span><span class="op" id="4417006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417016">inst</span><span class="op" id="4417020">.</span><span class="ident" id="4417021">Op</span>&nbsp;<span class="op" id="4417024">=</span>&nbsp;<span class="ident" id="4417026">syntax</span><span class="op" id="4417032">.</span><span class="ident" id="4417033">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417044">case</span>&nbsp;<span class="ident" id="4417049">syntax</span><span class="op" id="4417055">.</span><span class="ident" id="4417056">InstRuneAny</span><span class="op" id="4417067">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417072">ok</span>&nbsp;<span class="op" id="4417075">=</span>&nbsp;<span class="ident" id="4417077">check</span><span class="op" id="4417082">(</span><span class="ident" id="4417083">inst</span><span class="op" id="4417087">.</span><span class="ident" id="4417088">Out</span><span class="op" id="4417091">,</span>&nbsp;<span class="ident" id="4417093">m</span><span class="op" id="4417094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417099">m</span><span class="op" id="4417100">[</span><span class="ident" id="4417101">pc</span><span class="op" id="4417103">]</span>&nbsp;<span class="op" id="4417105">=</span>&nbsp;<span class="builtintype" id="4417107">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417116">if</span>&nbsp;<span class="builtinfunc" id="4417119">len</span><span class="op" id="4417122">(</span><span class="ident" id="4417123">inst</span><span class="op" id="4417127">.</span><span class="ident" id="4417128">Next</span><span class="op" id="4417132">)</span>&nbsp;<span class="op" id="4417134">&gt;</span>&nbsp;<span class="num" id="4417136">0</span>&nbsp;<span class="op" id="4417138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417144">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417153">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417158">onePassRunes</span><span class="op" id="4417170">[</span><span class="ident" id="4417171">pc</span><span class="op" id="4417173">]</span>&nbsp;<span class="op" id="4417175">=</span>&nbsp;<span class="builtinfunc" id="4417177">append</span><span class="op" id="4417183">(</span><span class="op" id="4417184">[</span><span class="op" id="4417185">]</span><span class="builtintype" id="4417186">rune</span><span class="op" id="4417190">{</span><span class="op" id="4417191">}</span><span class="op" id="4417192">,</span>&nbsp;<span class="ident" id="4417194">anyRune</span><span class="op" id="4417201">...</span><span class="op" id="4417204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417209">inst</span><span class="op" id="4417213">.</span><span class="ident" id="4417214">Next</span>&nbsp;<span class="op" id="4417219">=</span>&nbsp;<span class="op" id="4417221">[</span><span class="op" id="4417222">]</span><span class="builtintype" id="4417223">uint32</span><span class="op" id="4417229">{</span><span class="ident" id="4417230">inst</span><span class="op" id="4417234">.</span><span class="ident" id="4417235">Out</span><span class="op" id="4417238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417242">case</span>&nbsp;<span class="ident" id="4417247">syntax</span><span class="op" id="4417253">.</span><span class="ident" id="4417254">InstRuneAnyNotNL</span><span class="op" id="4417270">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417275">ok</span>&nbsp;<span class="op" id="4417278">=</span>&nbsp;<span class="ident" id="4417280">check</span><span class="op" id="4417285">(</span><span class="ident" id="4417286">inst</span><span class="op" id="4417290">.</span><span class="ident" id="4417291">Out</span><span class="op" id="4417294">,</span>&nbsp;<span class="ident" id="4417296">m</span><span class="op" id="4417297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417302">m</span><span class="op" id="4417303">[</span><span class="ident" id="4417304">pc</span><span class="op" id="4417306">]</span>&nbsp;<span class="op" id="4417308">=</span>&nbsp;<span class="builtintype" id="4417310">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417319">if</span>&nbsp;<span class="builtinfunc" id="4417322">len</span><span class="op" id="4417325">(</span><span class="ident" id="4417326">inst</span><span class="op" id="4417330">.</span><span class="ident" id="4417331">Next</span><span class="op" id="4417335">)</span>&nbsp;<span class="op" id="4417337">&gt;</span>&nbsp;<span class="num" id="4417339">0</span>&nbsp;<span class="op" id="4417341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417347">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417361">onePassRunes</span><span class="op" id="4417373">[</span><span class="ident" id="4417374">pc</span><span class="op" id="4417376">]</span>&nbsp;<span class="op" id="4417378">=</span>&nbsp;<span class="builtinfunc" id="4417380">append</span><span class="op" id="4417386">(</span><span class="op" id="4417387">[</span><span class="op" id="4417388">]</span><span class="builtintype" id="4417389">rune</span><span class="op" id="4417393">{</span><span class="op" id="4417394">}</span><span class="op" id="4417395">,</span>&nbsp;<span class="ident" id="4417397">anyRuneNotNL</span><span class="op" id="4417409">...</span><span class="op" id="4417412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417417">inst</span><span class="op" id="4417421">.</span><span class="ident" id="4417422">Next</span>&nbsp;<span class="op" id="4417427">=</span>&nbsp;<span class="op" id="4417429">[</span><span class="op" id="4417430">]</span><span class="builtintype" id="4417431">uint32</span><span class="op" id="4417437">{</span><span class="op" id="4417438">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417443">for</span>&nbsp;<span class="ident" id="4417447">i</span>&nbsp;<span class="op" id="4417449">:=</span>&nbsp;<span class="builtinfunc" id="4417452">len</span><span class="op" id="4417455">(</span><span class="ident" id="4417456">onePassRunes</span><span class="op" id="4417468">[</span><span class="ident" id="4417469">pc</span><span class="op" id="4417471">]</span><span class="op" id="4417472">)</span>&nbsp;<span class="op" id="4417474">/</span>&nbsp;<span class="num" id="4417476">2</span><span class="op" id="4417477">;</span>&nbsp;<span class="ident" id="4417479">i</span>&nbsp;<span class="op" id="4417481">&gt;=</span>&nbsp;<span class="num" id="4417484">0</span><span class="op" id="4417485">;</span>&nbsp;<span class="ident" id="4417487">i</span><span class="op" id="4417488">--</span>&nbsp;<span class="op" id="4417491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417497">inst</span><span class="op" id="4417501">.</span><span class="ident" id="4417502">Next</span>&nbsp;<span class="op" id="4417507">=</span>&nbsp;<span class="builtinfunc" id="4417509">append</span><span class="op" id="4417515">(</span><span class="ident" id="4417516">inst</span><span class="op" id="4417520">.</span><span class="ident" id="4417521">Next</span><span class="op" id="4417525">,</span>&nbsp;<span class="ident" id="4417527">inst</span><span class="op" id="4417531">.</span><span class="ident" id="4417532">Out</span><span class="op" id="4417535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417548">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417560">instQueue</span><span class="op" id="4417569">.</span><span class="ident" id="4417570">clear</span><span class="op" id="4417575">(</span><span class="op" id="4417576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417579">instQueue</span><span class="op" id="4417588">.</span><span class="ident" id="4417589">insert</span><span class="op" id="4417595">(</span><span class="builtintype" id="4417596">uint32</span><span class="op" id="4417602">(</span><span class="ident" id="4417603">p</span><span class="op" id="4417604">.</span><span class="ident" id="4417605">Start</span><span class="op" id="4417610">)</span><span class="op" id="4417611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417614">m</span>&nbsp;<span class="op" id="4417616">:=</span>&nbsp;<span class="builtinfunc" id="4417619">make</span><span class="op" id="4417623">(</span><span class="keyword" id="4417624">map</span><span class="op" id="4417627">[</span><span class="builtintype" id="4417628">uint32</span><span class="op" id="4417634">]</span><span class="builtintype" id="4417635">bool</span><span class="op" id="4417639">,</span>&nbsp;<span class="builtinfunc" id="4417641">len</span><span class="op" id="4417644">(</span><span class="ident" id="4417645">p</span><span class="op" id="4417646">.</span><span class="ident" id="4417647">Inst</span><span class="op" id="4417651">)</span><span class="op" id="4417652">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417655">for</span>&nbsp;<span class="op" id="4417659">!</span><span class="ident" id="4417660">instQueue</span><span class="op" id="4417669">.</span><span class="ident" id="4417670">empty</span><span class="op" id="4417675">(</span><span class="op" id="4417676">)</span>&nbsp;<span class="op" id="4417678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417682">pc</span>&nbsp;<span class="op" id="4417685">:=</span>&nbsp;<span class="ident" id="4417688">instQueue</span><span class="op" id="4417697">.</span><span class="ident" id="4417698">next</span><span class="op" id="4417702">(</span><span class="op" id="4417703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417707">inst</span>&nbsp;<span class="op" id="4417712">:=</span>&nbsp;<span class="ident" id="4417715">p</span><span class="op" id="4417716">.</span><span class="ident" id="4417717">Inst</span><span class="op" id="4417721">[</span><span class="ident" id="4417722">pc</span><span class="op" id="4417724">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417728">visitQueue</span><span class="op" id="4417738">.</span><span class="ident" id="4417739">clear</span><span class="op" id="4417744">(</span><span class="op" id="4417745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417749">if</span>&nbsp;<span class="op" id="4417752">!</span><span class="ident" id="4417753">check</span><span class="op" id="4417758">(</span><span class="builtintype" id="4417759">uint32</span><span class="op" id="4417765">(</span><span class="ident" id="4417766">pc</span><span class="op" id="4417768">)</span><span class="op" id="4417769">,</span>&nbsp;<span class="ident" id="4417771">m</span><span class="op" id="4417772">)</span>&nbsp;<span class="op" id="4417774">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417779">p</span>&nbsp;<span class="op" id="4417781">=</span>&nbsp;<span class="ident" id="4417783">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417797">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4417805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417809">switch</span>&nbsp;<span class="ident" id="4417816">inst</span><span class="op" id="4417820">.</span><span class="ident" id="4417821">Op</span>&nbsp;<span class="op" id="4417824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417828">case</span>&nbsp;<span class="ident" id="4417833">syntax</span><span class="op" id="4417839">.</span><span class="ident" id="4417840">InstAlt</span><span class="op" id="4417847">,</span>&nbsp;<span class="ident" id="4417849">syntax</span><span class="op" id="4417855">.</span><span class="ident" id="4417856">InstAltMatch</span><span class="op" id="4417868">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417873">instQueue</span><span class="op" id="4417882">.</span><span class="ident" id="4417883">insert</span><span class="op" id="4417889">(</span><span class="ident" id="4417890">inst</span><span class="op" id="4417894">.</span><span class="ident" id="4417895">Out</span><span class="op" id="4417898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417903">instQueue</span><span class="op" id="4417912">.</span><span class="ident" id="4417913">insert</span><span class="op" id="4417919">(</span><span class="ident" id="4417920">inst</span><span class="op" id="4417924">.</span><span class="ident" id="4417925">Arg</span><span class="op" id="4417928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4417932">case</span>&nbsp;<span class="ident" id="4417937">syntax</span><span class="op" id="4417943">.</span><span class="ident" id="4417944">InstCapture</span><span class="op" id="4417955">,</span>&nbsp;<span class="ident" id="4417957">syntax</span><span class="op" id="4417963">.</span><span class="ident" id="4417964">InstEmptyWidth</span><span class="op" id="4417978">,</span>&nbsp;<span class="ident" id="4417980">syntax</span><span class="op" id="4417986">.</span><span class="ident" id="4417987">InstNop</span><span class="op" id="4417994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4417999">instQueue</span><span class="op" id="4418008">.</span><span class="ident" id="4418009">insert</span><span class="op" id="4418015">(</span><span class="ident" id="4418016">inst</span><span class="op" id="4418020">.</span><span class="ident" id="4418021">Out</span><span class="op" id="4418024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418028">case</span>&nbsp;<span class="ident" id="4418033">syntax</span><span class="op" id="4418039">.</span><span class="ident" id="4418040">InstMatch</span><span class="op" id="4418049">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418053">case</span>&nbsp;<span class="ident" id="4418058">syntax</span><span class="op" id="4418064">.</span><span class="ident" id="4418065">InstFail</span><span class="op" id="4418073">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418077">case</span>&nbsp;<span class="ident" id="4418082">syntax</span><span class="op" id="4418088">.</span><span class="ident" id="4418089">InstRune</span><span class="op" id="4418097">,</span>&nbsp;<span class="ident" id="4418099">syntax</span><span class="op" id="4418105">.</span><span class="ident" id="4418106">InstRune1</span><span class="op" id="4418115">,</span>&nbsp;<span class="ident" id="4418117">syntax</span><span class="op" id="4418123">.</span><span class="ident" id="4418124">InstRuneAny</span><span class="op" id="4418135">,</span>&nbsp;<span class="ident" id="4418137">syntax</span><span class="op" id="4418143">.</span><span class="ident" id="4418144">InstRuneAnyNotNL</span><span class="op" id="4418160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418164">default</span><span class="op" id="4418171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418178">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418181">if</span>&nbsp;<span class="ident" id="4418184">p</span>&nbsp;<span class="op" id="4418186">!=</span>&nbsp;<span class="ident" id="4418189">notOnePass</span>&nbsp;<span class="op" id="4418200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418204">for</span>&nbsp;<span class="ident" id="4418208">i</span>&nbsp;<span class="op" id="4418210">:=</span>&nbsp;<span class="keyword" id="4418213">range</span>&nbsp;<span class="ident" id="4418219">p</span><span class="op" id="4418220">.</span><span class="ident" id="4418221">Inst</span>&nbsp;<span class="op" id="4418226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418231">p</span><span class="op" id="4418232">.</span><span class="ident" id="4418233">Inst</span><span class="op" id="4418237">[</span><span class="ident" id="4418238">i</span><span class="op" id="4418239">]</span><span class="op" id="4418240">.</span><span class="ident" id="4418241">Rune</span>&nbsp;<span class="op" id="4418246">=</span>&nbsp;<span class="ident" id="4418248">onePassRunes</span><span class="op" id="4418260">[</span><span class="ident" id="4418261">i</span><span class="op" id="4418262">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418269">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418272">return</span>&nbsp;<span class="ident" id="4418279">p</span><br>
<span class="lineno"></span><span class="op" id="4418281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4418284">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="4418352">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="4418389">func</span>&nbsp;<span class="ident" id="4418394">walk</span><span class="op" id="4418398">(</span><span class="ident" id="4418399">prog</span>&nbsp;<span class="op" id="4418404">*</span><span class="ident" id="4418405">syntax</span><span class="op" id="4418411">.</span><span class="ident" id="4418412">Prog</span><span class="op" id="4418416">,</span>&nbsp;<span class="ident" id="4418418">funcs</span>&nbsp;<span class="op" id="4418424">...</span><span class="keyword" id="4418427">func</span><span class="op" id="4418431">(</span><span class="ident" id="4418432">ip</span><span class="op" id="4418434">,</span>&nbsp;<span class="ident" id="4418436">next</span>&nbsp;<span class="builtintype" id="4418441">uint32</span><span class="op" id="4418447">)</span><span class="op" id="4418448">)</span>&nbsp;<span class="op" id="4418450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418453">var</span>&nbsp;<span class="ident" id="4418457">walk1</span>&nbsp;<span class="keyword" id="4418463">func</span><span class="op" id="4418467">(</span><span class="builtintype" id="4418468">uint32</span><span class="op" id="4418474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418477">progQueue</span>&nbsp;<span class="op" id="4418487">:=</span>&nbsp;<span class="ident" id="4418490">newQueue</span><span class="op" id="4418498">(</span><span class="builtinfunc" id="4418499">len</span><span class="op" id="4418502">(</span><span class="ident" id="4418503">prog</span><span class="op" id="4418507">.</span><span class="ident" id="4418508">Inst</span><span class="op" id="4418512">)</span><span class="op" id="4418513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418516">walk1</span>&nbsp;<span class="op" id="4418522">=</span>&nbsp;<span class="keyword" id="4418524">func</span><span class="op" id="4418528">(</span><span class="ident" id="4418529">ip</span>&nbsp;<span class="builtintype" id="4418532">uint32</span><span class="op" id="4418538">)</span>&nbsp;<span class="op" id="4418540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418544">if</span>&nbsp;<span class="ident" id="4418547">progQueue</span><span class="op" id="4418556">.</span><span class="ident" id="4418557">contains</span><span class="op" id="4418565">(</span><span class="ident" id="4418566">ip</span><span class="op" id="4418568">)</span>&nbsp;<span class="op" id="4418570">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418575">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418588">progQueue</span><span class="op" id="4418597">.</span><span class="ident" id="4418598">insert</span><span class="op" id="4418604">(</span><span class="ident" id="4418605">ip</span><span class="op" id="4418607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418611">inst</span>&nbsp;<span class="op" id="4418616">:=</span>&nbsp;<span class="ident" id="4418619">prog</span><span class="op" id="4418623">.</span><span class="ident" id="4418624">Inst</span><span class="op" id="4418628">[</span><span class="ident" id="4418629">ip</span><span class="op" id="4418631">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418635">switch</span>&nbsp;<span class="ident" id="4418642">inst</span><span class="op" id="4418646">.</span><span class="ident" id="4418647">Op</span>&nbsp;<span class="op" id="4418650">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418654">case</span>&nbsp;<span class="ident" id="4418659">syntax</span><span class="op" id="4418665">.</span><span class="ident" id="4418666">InstAlt</span><span class="op" id="4418673">,</span>&nbsp;<span class="ident" id="4418675">syntax</span><span class="op" id="4418681">.</span><span class="ident" id="4418682">InstAltMatch</span><span class="op" id="4418694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418699">for</span>&nbsp;<span class="ident" id="4418703">_</span><span class="op" id="4418704">,</span>&nbsp;<span class="ident" id="4418706">f</span>&nbsp;<span class="op" id="4418708">:=</span>&nbsp;<span class="keyword" id="4418711">range</span>&nbsp;<span class="ident" id="4418717">funcs</span>&nbsp;<span class="op" id="4418723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418729">f</span><span class="op" id="4418730">(</span><span class="ident" id="4418731">ip</span><span class="op" id="4418733">,</span>&nbsp;<span class="ident" id="4418735">inst</span><span class="op" id="4418739">.</span><span class="ident" id="4418740">Out</span><span class="op" id="4418743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418749">f</span><span class="op" id="4418750">(</span><span class="ident" id="4418751">ip</span><span class="op" id="4418753">,</span>&nbsp;<span class="ident" id="4418755">inst</span><span class="op" id="4418759">.</span><span class="ident" id="4418760">Arg</span><span class="op" id="4418763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418768">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418773">walk1</span><span class="op" id="4418778">(</span><span class="ident" id="4418779">inst</span><span class="op" id="4418783">.</span><span class="ident" id="4418784">Out</span><span class="op" id="4418787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418792">walk1</span><span class="op" id="4418797">(</span><span class="ident" id="4418798">inst</span><span class="op" id="4418802">.</span><span class="ident" id="4418803">Arg</span><span class="op" id="4418806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418810">default</span><span class="op" id="4418817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4418822">for</span>&nbsp;<span class="ident" id="4418826">_</span><span class="op" id="4418827">,</span>&nbsp;<span class="ident" id="4418829">f</span>&nbsp;<span class="op" id="4418831">:=</span>&nbsp;<span class="keyword" id="4418834">range</span>&nbsp;<span class="ident" id="4418840">funcs</span>&nbsp;<span class="op" id="4418846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418852">f</span><span class="op" id="4418853">(</span><span class="ident" id="4418854">ip</span><span class="op" id="4418856">,</span>&nbsp;<span class="ident" id="4418858">inst</span><span class="op" id="4418862">.</span><span class="ident" id="4418863">Out</span><span class="op" id="4418866">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418876">walk1</span><span class="op" id="4418881">(</span><span class="ident" id="4418882">inst</span><span class="op" id="4418886">.</span><span class="ident" id="4418887">Out</span><span class="op" id="4418890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4418897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4418900">walk1</span><span class="op" id="4418905">(</span><span class="builtintype" id="4418906">uint32</span><span class="op" id="4418912">(</span><span class="ident" id="4418913">prog</span><span class="op" id="4418917">.</span><span class="ident" id="4418918">Start</span><span class="op" id="4418923">)</span><span class="op" id="4418924">)</span><br>
<span class="lineno">520</span><span class="op" id="4418926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4418929">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="4418998">func</span>&nbsp;<span class="ident" id="4419003">find</span><span class="op" id="4419007">(</span><span class="ident" id="4419008">prog</span>&nbsp;<span class="op" id="4419013">*</span><span class="ident" id="4419014">syntax</span><span class="op" id="4419020">.</span><span class="ident" id="4419021">Prog</span><span class="op" id="4419025">,</span>&nbsp;<span class="ident" id="4419027">f</span>&nbsp;<span class="keyword" id="4419029">func</span><span class="op" id="4419033">(</span><span class="op" id="4419034">*</span><span class="ident" id="4419035">syntax</span><span class="op" id="4419041">.</span><span class="ident" id="4419042">Prog</span><span class="op" id="4419046">,</span>&nbsp;<span class="builtintype" id="4419048">int</span><span class="op" id="4419051">)</span>&nbsp;<span class="builtintype" id="4419053">bool</span><span class="op" id="4419057">)</span>&nbsp;<span class="op" id="4419059">(</span><span class="ident" id="4419060">matches</span>&nbsp;<span class="op" id="4419068">[</span><span class="op" id="4419069">]</span><span class="builtintype" id="4419070">uint32</span><span class="op" id="4419076">)</span>&nbsp;<span class="op" id="4419078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4419081">matches</span>&nbsp;<span class="op" id="4419089">=</span>&nbsp;<span class="op" id="4419091">[</span><span class="op" id="4419092">]</span><span class="builtintype" id="4419093">uint32</span><span class="op" id="4419099">{</span><span class="op" id="4419100">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419104">for</span>&nbsp;<span class="ident" id="4419108">ip</span>&nbsp;<span class="op" id="4419111">:=</span>&nbsp;<span class="keyword" id="4419114">range</span>&nbsp;<span class="ident" id="4419120">prog</span><span class="op" id="4419124">.</span><span class="ident" id="4419125">Inst</span>&nbsp;<span class="op" id="4419130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419134">if</span>&nbsp;<span class="ident" id="4419137">f</span><span class="op" id="4419138">(</span><span class="ident" id="4419139">prog</span><span class="op" id="4419143">,</span>&nbsp;<span class="ident" id="4419145">ip</span><span class="op" id="4419147">)</span>&nbsp;<span class="op" id="4419149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4419154">matches</span>&nbsp;<span class="op" id="4419162">=</span>&nbsp;<span class="builtinfunc" id="4419164">append</span><span class="op" id="4419170">(</span><span class="ident" id="4419171">matches</span><span class="op" id="4419178">,</span>&nbsp;<span class="builtintype" id="4419180">uint32</span><span class="op" id="4419186">(</span><span class="ident" id="4419187">ip</span><span class="op" id="4419189">)</span><span class="op" id="4419190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419194">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419200">return</span><br>
<span class="lineno"></span><span class="op" id="4419207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4419210">var</span>&nbsp;<span class="ident" id="4419214">notOnePass</span>&nbsp;<span class="op" id="4419225">*</span><span class="ident" id="4419226">onePassProg</span>&nbsp;<span class="op" id="4419238">=</span>&nbsp;<span class="ident" id="4419240">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="4419245">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="4419342">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4419426">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="4419512">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="4419598">func</span>&nbsp;<span class="ident" id="4419603">compileOnePass</span><span class="op" id="4419617">(</span><span class="ident" id="4419618">prog</span>&nbsp;<span class="op" id="4419623">*</span><span class="ident" id="4419624">syntax</span><span class="op" id="4419630">.</span><span class="ident" id="4419631">Prog</span><span class="op" id="4419635">)</span>&nbsp;<span class="op" id="4419637">(</span><span class="ident" id="4419638">p</span>&nbsp;<span class="op" id="4419640">*</span><span class="ident" id="4419641">onePassProg</span><span class="op" id="4419652">)</span>&nbsp;<span class="op" id="4419654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419657">if</span>&nbsp;<span class="ident" id="4419660">prog</span><span class="op" id="4419664">.</span><span class="ident" id="4419665">Start</span>&nbsp;<span class="op" id="4419671">==</span>&nbsp;<span class="num" id="4419674">0</span>&nbsp;<span class="op" id="4419676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419680">return</span>&nbsp;<span class="ident" id="4419687">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4419702">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419733">if</span>&nbsp;<span class="ident" id="4419736">prog</span><span class="op" id="4419740">.</span><span class="ident" id="4419741">Inst</span><span class="op" id="4419745">[</span><span class="ident" id="4419746">prog</span><span class="op" id="4419750">.</span><span class="ident" id="4419751">Start</span><span class="op" id="4419756">]</span><span class="op" id="4419757">.</span><span class="ident" id="4419758">Op</span>&nbsp;<span class="op" id="4419761">!=</span>&nbsp;<span class="ident" id="4419764">syntax</span><span class="op" id="4419770">.</span><span class="ident" id="4419771">InstEmptyWidth</span>&nbsp;<span class="op" id="4419786">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4419791">syntax</span><span class="op" id="4419797">.</span><span class="ident" id="4419798">EmptyOp</span><span class="op" id="4419805">(</span><span class="ident" id="4419806">prog</span><span class="op" id="4419810">.</span><span class="ident" id="4419811">Inst</span><span class="op" id="4419815">[</span><span class="ident" id="4419816">prog</span><span class="op" id="4419820">.</span><span class="ident" id="4419821">Start</span><span class="op" id="4419826">]</span><span class="op" id="4419827">.</span><span class="ident" id="4419828">Arg</span><span class="op" id="4419831">)</span><span class="op" id="4419832">&amp;</span><span class="ident" id="4419833">syntax</span><span class="op" id="4419839">.</span><span class="ident" id="4419840">EmptyBeginText</span>&nbsp;<span class="op" id="4419855">!=</span>&nbsp;<span class="ident" id="4419858">syntax</span><span class="op" id="4419864">.</span><span class="ident" id="4419865">EmptyBeginText</span>&nbsp;<span class="op" id="4419880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419884">return</span>&nbsp;<span class="ident" id="4419891">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4419903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4419906">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4419970">for</span>&nbsp;<span class="ident" id="4419974">_</span><span class="op" id="4419975">,</span>&nbsp;<span class="ident" id="4419977">inst</span>&nbsp;<span class="op" id="4419982">:=</span>&nbsp;<span class="keyword" id="4419985">range</span>&nbsp;<span class="ident" id="4419991">prog</span><span class="op" id="4419995">.</span><span class="ident" id="4419996">Inst</span>&nbsp;<span class="op" id="4420001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420005">opOut</span>&nbsp;<span class="op" id="4420011">:=</span>&nbsp;<span class="ident" id="4420014">prog</span><span class="op" id="4420018">.</span><span class="ident" id="4420019">Inst</span><span class="op" id="4420023">[</span><span class="ident" id="4420024">inst</span><span class="op" id="4420028">.</span><span class="ident" id="4420029">Out</span><span class="op" id="4420032">]</span><span class="op" id="4420033">.</span><span class="ident" id="4420034">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420039">switch</span>&nbsp;<span class="ident" id="4420046">inst</span><span class="op" id="4420050">.</span><span class="ident" id="4420051">Op</span>&nbsp;<span class="op" id="4420054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420058">default</span><span class="op" id="4420065">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420070">if</span>&nbsp;<span class="ident" id="4420073">opOut</span>&nbsp;<span class="op" id="4420079">==</span>&nbsp;<span class="ident" id="4420082">syntax</span><span class="op" id="4420088">.</span><span class="ident" id="4420089">InstMatch</span>&nbsp;<span class="op" id="4420099">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420105">return</span>&nbsp;<span class="ident" id="4420112">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420130">case</span>&nbsp;<span class="ident" id="4420135">syntax</span><span class="op" id="4420141">.</span><span class="ident" id="4420142">InstAlt</span><span class="op" id="4420149">,</span>&nbsp;<span class="ident" id="4420151">syntax</span><span class="op" id="4420157">.</span><span class="ident" id="4420158">InstAltMatch</span><span class="op" id="4420170">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420175">if</span>&nbsp;<span class="ident" id="4420178">opOut</span>&nbsp;<span class="op" id="4420184">==</span>&nbsp;<span class="ident" id="4420187">syntax</span><span class="op" id="4420193">.</span><span class="ident" id="4420194">InstMatch</span>&nbsp;<span class="op" id="4420204">||</span>&nbsp;<span class="ident" id="4420207">prog</span><span class="op" id="4420211">.</span><span class="ident" id="4420212">Inst</span><span class="op" id="4420216">[</span><span class="ident" id="4420217">inst</span><span class="op" id="4420221">.</span><span class="ident" id="4420222">Arg</span><span class="op" id="4420225">]</span><span class="op" id="4420226">.</span><span class="ident" id="4420227">Op</span>&nbsp;<span class="op" id="4420230">==</span>&nbsp;<span class="ident" id="4420233">syntax</span><span class="op" id="4420239">.</span><span class="ident" id="4420240">InstMatch</span>&nbsp;<span class="op" id="4420250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420256">return</span>&nbsp;<span class="ident" id="4420263">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420281">case</span>&nbsp;<span class="ident" id="4420286">syntax</span><span class="op" id="4420292">.</span><span class="ident" id="4420293">InstEmptyWidth</span><span class="op" id="4420307">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420312">if</span>&nbsp;<span class="ident" id="4420315">opOut</span>&nbsp;<span class="op" id="4420321">==</span>&nbsp;<span class="ident" id="4420324">syntax</span><span class="op" id="4420330">.</span><span class="ident" id="4420331">InstMatch</span>&nbsp;<span class="op" id="4420341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420347">if</span>&nbsp;<span class="ident" id="4420350">syntax</span><span class="op" id="4420356">.</span><span class="ident" id="4420357">EmptyOp</span><span class="op" id="4420364">(</span><span class="ident" id="4420365">inst</span><span class="op" id="4420369">.</span><span class="ident" id="4420370">Arg</span><span class="op" id="4420373">)</span><span class="op" id="4420374">&amp;</span><span class="ident" id="4420375">syntax</span><span class="op" id="4420381">.</span><span class="ident" id="4420382">EmptyEndText</span>&nbsp;<span class="op" id="4420395">==</span>&nbsp;<span class="ident" id="4420398">syntax</span><span class="op" id="4420404">.</span><span class="ident" id="4420405">EmptyEndText</span>&nbsp;<span class="op" id="4420418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420425">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420444">return</span>&nbsp;<span class="ident" id="4420451">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420472">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4420475">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4420534">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420604">p</span>&nbsp;<span class="op" id="4420606">=</span>&nbsp;<span class="ident" id="4420608">onePassCopy</span><span class="op" id="4420619">(</span><span class="ident" id="4420620">prog</span><span class="op" id="4420624">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4420628">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420691">p</span>&nbsp;<span class="op" id="4420693">=</span>&nbsp;<span class="ident" id="4420695">makeOnePass</span><span class="op" id="4420706">(</span><span class="ident" id="4420707">p</span><span class="op" id="4420708">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420712">if</span>&nbsp;<span class="ident" id="4420715">p</span>&nbsp;<span class="op" id="4420717">!=</span>&nbsp;<span class="ident" id="4420720">notOnePass</span>&nbsp;<span class="op" id="4420731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4420735">cleanupOnePass</span><span class="op" id="4420749">(</span><span class="ident" id="4420750">p</span><span class="op" id="4420751">,</span>&nbsp;<span class="ident" id="4420753">prog</span><span class="op" id="4420757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4420760">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4420763">return</span>&nbsp;<span class="ident" id="4420770">p</span><br>
<span class="lineno"></span><span class="op" id="4420772">}</span>
</div>
</body>
</html>
