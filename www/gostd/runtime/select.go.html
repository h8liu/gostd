<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html" class="current">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1682694">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1682749">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1682803">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1682854">package</span>&nbsp;<span class="ident" id="1682862">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1682871">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1682938">import</span>&nbsp;<span class="string" id="1682945">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1682955">const</span>&nbsp;<span class="op" id="1682961">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682964">debugSelect</span>&nbsp;<span class="op" id="1682976">=</span>&nbsp;<span class="builtintype" id="1682978">false</span><br>
<span class="lineno"></span><span class="op" id="1682984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1682987">var</span>&nbsp;<span class="op" id="1682991">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682994">chansendpc</span>&nbsp;<span class="op" id="1683005">=</span>&nbsp;<span class="ident" id="1683007">funcPC</span><span class="op" id="1683013">(</span><span class="ident" id="1683014">chansend</span><span class="op" id="1683022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683025">chanrecvpc</span>&nbsp;<span class="op" id="1683036">=</span>&nbsp;<span class="ident" id="1683038">funcPC</span><span class="op" id="1683044">(</span><span class="ident" id="1683045">chanrecv</span><span class="op" id="1683053">)</span><br>
<span class="lineno"></span><span class="op" id="1683055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1683058">func</span>&nbsp;<span class="ident" id="1683063">selectsize</span><span class="op" id="1683073">(</span><span class="ident" id="1683074">size</span>&nbsp;<span class="builtintype" id="1683079">uintptr</span><span class="op" id="1683086">)</span>&nbsp;<span class="builtintype" id="1683088">uintptr</span>&nbsp;<span class="op" id="1683096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683099">selsize</span>&nbsp;<span class="op" id="1683107">:=</span>&nbsp;<span class="ident" id="1683110">unsafe</span><span class="op" id="1683116">.</span><span class="ident" id="1683117">Sizeof</span><span class="op" id="1683123">(</span><span class="ident" id="1683124">_select</span><span class="op" id="1683131">{</span><span class="op" id="1683132">}</span><span class="op" id="1683133">)</span>&nbsp;<span class="op" id="1683135">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683139">(</span><span class="ident" id="1683140">size</span><span class="op" id="1683144">-</span><span class="num" id="1683145">1</span><span class="op" id="1683146">)</span><span class="op" id="1683147">*</span><span class="ident" id="1683148">unsafe</span><span class="op" id="1683154">.</span><span class="ident" id="1683155">Sizeof</span><span class="op" id="1683161">(</span><span class="ident" id="1683162">_select</span><span class="op" id="1683169">{</span><span class="op" id="1683170">}</span><span class="op" id="1683171">.</span><span class="ident" id="1683172">scase</span><span class="op" id="1683177">[</span><span class="num" id="1683178">0</span><span class="op" id="1683179">]</span><span class="op" id="1683180">)</span>&nbsp;<span class="op" id="1683182">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683186">size</span><span class="op" id="1683190">*</span><span class="ident" id="1683191">unsafe</span><span class="op" id="1683197">.</span><span class="ident" id="1683198">Sizeof</span><span class="op" id="1683204">(</span><span class="op" id="1683205">*</span><span class="ident" id="1683206">_select</span><span class="op" id="1683213">{</span><span class="op" id="1683214">}</span><span class="op" id="1683215">.</span><span class="ident" id="1683216">lockorder</span><span class="op" id="1683225">)</span>&nbsp;<span class="op" id="1683227">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683231">size</span><span class="op" id="1683235">*</span><span class="ident" id="1683236">unsafe</span><span class="op" id="1683242">.</span><span class="ident" id="1683243">Sizeof</span><span class="op" id="1683249">(</span><span class="op" id="1683250">*</span><span class="ident" id="1683251">_select</span><span class="op" id="1683258">{</span><span class="op" id="1683259">}</span><span class="op" id="1683260">.</span><span class="ident" id="1683261">pollorder</span><span class="op" id="1683270">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683273">return</span>&nbsp;<span class="ident" id="1683280">round</span><span class="op" id="1683285">(</span><span class="ident" id="1683286">selsize</span><span class="op" id="1683293">,</span>&nbsp;<span class="ident" id="1683295">_Int64Align</span><span class="op" id="1683306">)</span><br>
<span class="lineno"></span><span class="op" id="1683308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1683311">func</span>&nbsp;<span class="ident" id="1683316">newselect</span><span class="op" id="1683325">(</span><span class="ident" id="1683326">sel</span>&nbsp;<span class="op" id="1683330">*</span><span class="ident" id="1683331">_select</span><span class="op" id="1683338">,</span>&nbsp;<span class="ident" id="1683340">selsize</span>&nbsp;<span class="ident" id="1683348">int64</span><span class="op" id="1683353">,</span>&nbsp;<span class="ident" id="1683355">size</span>&nbsp;<span class="builtintype" id="1683360">int32</span><span class="op" id="1683365">)</span>&nbsp;<span class="op" id="1683367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683370">if</span>&nbsp;<span class="ident" id="1683373">selsize</span>&nbsp;<span class="op" id="1683381">!=</span>&nbsp;<span class="ident" id="1683384">int64</span><span class="op" id="1683389">(</span><span class="ident" id="1683390">selectsize</span><span class="op" id="1683400">(</span><span class="builtintype" id="1683401">uintptr</span><span class="op" id="1683408">(</span><span class="ident" id="1683409">size</span><span class="op" id="1683413">)</span><span class="op" id="1683414">)</span><span class="op" id="1683415">)</span>&nbsp;<span class="op" id="1683417">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1683421">print</span><span class="op" id="1683426">(</span><span class="string" id="1683427">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1683454">,</span>&nbsp;<span class="ident" id="1683456">selsize</span><span class="op" id="1683463">,</span>&nbsp;<span class="string" id="1683465">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1683474">,</span>&nbsp;<span class="ident" id="1683476">selectsize</span><span class="op" id="1683486">(</span><span class="builtintype" id="1683487">uintptr</span><span class="op" id="1683494">(</span><span class="ident" id="1683495">size</span><span class="op" id="1683499">)</span><span class="op" id="1683500">)</span><span class="op" id="1683501">,</span>&nbsp;<span class="string" id="1683503">&#34;\n&#34;</span><span class="op" id="1683507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683511">gothrow</span><span class="op" id="1683518">(</span><span class="string" id="1683519">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1683536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683542">sel</span><span class="op" id="1683545">.</span><span class="ident" id="1683546">tcase</span>&nbsp;<span class="op" id="1683552">=</span>&nbsp;<span class="builtintype" id="1683554">uint16</span><span class="op" id="1683560">(</span><span class="ident" id="1683561">size</span><span class="op" id="1683565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683568">sel</span><span class="op" id="1683571">.</span><span class="ident" id="1683572">ncase</span>&nbsp;<span class="op" id="1683578">=</span>&nbsp;<span class="num" id="1683580">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683583">sel</span><span class="op" id="1683586">.</span><span class="ident" id="1683587">lockorder</span>&nbsp;<span class="op" id="1683597">=</span>&nbsp;<span class="op" id="1683599">(</span><span class="op" id="1683600">*</span><span class="op" id="1683601">*</span><span class="ident" id="1683602">hchan</span><span class="op" id="1683607">)</span><span class="op" id="1683608">(</span><span class="ident" id="1683609">add</span><span class="op" id="1683612">(</span><span class="ident" id="1683613">unsafe</span><span class="op" id="1683619">.</span><span class="ident" id="1683620">Pointer</span><span class="op" id="1683627">(</span><span class="op" id="1683628">&amp;</span><span class="ident" id="1683629">sel</span><span class="op" id="1683632">.</span><span class="ident" id="1683633">scase</span><span class="op" id="1683638">)</span><span class="op" id="1683639">,</span>&nbsp;<span class="builtintype" id="1683641">uintptr</span><span class="op" id="1683648">(</span><span class="ident" id="1683649">size</span><span class="op" id="1683653">)</span><span class="op" id="1683654">*</span><span class="ident" id="1683655">unsafe</span><span class="op" id="1683661">.</span><span class="ident" id="1683662">Sizeof</span><span class="op" id="1683668">(</span><span class="ident" id="1683669">_select</span><span class="op" id="1683676">{</span><span class="op" id="1683677">}</span><span class="op" id="1683678">.</span><span class="ident" id="1683679">scase</span><span class="op" id="1683684">[</span><span class="num" id="1683685">0</span><span class="op" id="1683686">]</span><span class="op" id="1683687">)</span><span class="op" id="1683688">)</span><span class="op" id="1683689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683692">sel</span><span class="op" id="1683695">.</span><span class="ident" id="1683696">pollorder</span>&nbsp;<span class="op" id="1683706">=</span>&nbsp;<span class="op" id="1683708">(</span><span class="op" id="1683709">*</span><span class="builtintype" id="1683710">uint16</span><span class="op" id="1683716">)</span><span class="op" id="1683717">(</span><span class="ident" id="1683718">add</span><span class="op" id="1683721">(</span><span class="ident" id="1683722">unsafe</span><span class="op" id="1683728">.</span><span class="ident" id="1683729">Pointer</span><span class="op" id="1683736">(</span><span class="ident" id="1683737">sel</span><span class="op" id="1683740">.</span><span class="ident" id="1683741">lockorder</span><span class="op" id="1683750">)</span><span class="op" id="1683751">,</span>&nbsp;<span class="builtintype" id="1683753">uintptr</span><span class="op" id="1683760">(</span><span class="ident" id="1683761">size</span><span class="op" id="1683765">)</span><span class="op" id="1683766">*</span><span class="ident" id="1683767">unsafe</span><span class="op" id="1683773">.</span><span class="ident" id="1683774">Sizeof</span><span class="op" id="1683780">(</span><span class="op" id="1683781">*</span><span class="ident" id="1683782">_select</span><span class="op" id="1683789">{</span><span class="op" id="1683790">}</span><span class="op" id="1683791">.</span><span class="ident" id="1683792">lockorder</span><span class="op" id="1683801">)</span><span class="op" id="1683802">)</span><span class="op" id="1683803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683807">if</span>&nbsp;<span class="ident" id="1683810">debugSelect</span>&nbsp;<span class="op" id="1683822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1683826">print</span><span class="op" id="1683831">(</span><span class="string" id="1683832">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1683846">,</span>&nbsp;<span class="ident" id="1683848">sel</span><span class="op" id="1683851">,</span>&nbsp;<span class="string" id="1683853">&#34;&nbsp;size=&#34;</span><span class="op" id="1683861">,</span>&nbsp;<span class="ident" id="1683863">size</span><span class="op" id="1683867">,</span>&nbsp;<span class="string" id="1683869">&#34;\n&#34;</span><span class="op" id="1683873">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683876">}</span><br>
<span class="lineno"></span><span class="op" id="1683878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1683881">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1683894">func</span>&nbsp;<span class="ident" id="1683899">selectsend</span><span class="op" id="1683909">(</span><span class="ident" id="1683910">sel</span>&nbsp;<span class="op" id="1683914">*</span><span class="ident" id="1683915">_select</span><span class="op" id="1683922">,</span>&nbsp;<span class="ident" id="1683924">c</span>&nbsp;<span class="op" id="1683926">*</span><span class="ident" id="1683927">hchan</span><span class="op" id="1683932">,</span>&nbsp;<span class="ident" id="1683934">elem</span>&nbsp;<span class="ident" id="1683939">unsafe</span><span class="op" id="1683945">.</span><span class="ident" id="1683946">Pointer</span><span class="op" id="1683953">)</span>&nbsp;<span class="op" id="1683955">(</span><span class="ident" id="1683956">selected</span>&nbsp;<span class="builtintype" id="1683965">bool</span><span class="op" id="1683969">)</span>&nbsp;<span class="op" id="1683971">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683974">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684003">if</span>&nbsp;<span class="ident" id="1684006">c</span>&nbsp;<span class="op" id="1684008">!=</span>&nbsp;<span class="ident" id="1684011">nil</span>&nbsp;<span class="op" id="1684015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684019">selectsendImpl</span><span class="op" id="1684033">(</span><span class="ident" id="1684034">sel</span><span class="op" id="1684037">,</span>&nbsp;<span class="ident" id="1684039">c</span><span class="op" id="1684040">,</span>&nbsp;<span class="ident" id="1684042">getcallerpc</span><span class="op" id="1684053">(</span><span class="ident" id="1684054">unsafe</span><span class="op" id="1684060">.</span><span class="ident" id="1684061">Pointer</span><span class="op" id="1684068">(</span><span class="op" id="1684069">&amp;</span><span class="ident" id="1684070">sel</span><span class="op" id="1684073">)</span><span class="op" id="1684074">)</span><span class="op" id="1684075">,</span>&nbsp;<span class="ident" id="1684077">elem</span><span class="op" id="1684081">,</span>&nbsp;<span class="builtintype" id="1684083">uintptr</span><span class="op" id="1684090">(</span><span class="ident" id="1684091">unsafe</span><span class="op" id="1684097">.</span><span class="ident" id="1684098">Pointer</span><span class="op" id="1684105">(</span><span class="op" id="1684106">&amp;</span><span class="ident" id="1684107">selected</span><span class="op" id="1684115">)</span><span class="op" id="1684116">)</span><span class="op" id="1684117">-</span><span class="builtintype" id="1684118">uintptr</span><span class="op" id="1684125">(</span><span class="ident" id="1684126">unsafe</span><span class="op" id="1684132">.</span><span class="ident" id="1684133">Pointer</span><span class="op" id="1684140">(</span><span class="op" id="1684141">&amp;</span><span class="ident" id="1684142">sel</span><span class="op" id="1684145">)</span><span class="op" id="1684146">)</span><span class="op" id="1684147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684153">return</span><br>
<span class="lineno">50</span><span class="op" id="1684160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1684163">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1684210">func</span>&nbsp;<span class="ident" id="1684215">selectsendImpl</span><span class="op" id="1684229">(</span><span class="ident" id="1684230">sel</span>&nbsp;<span class="op" id="1684234">*</span><span class="ident" id="1684235">_select</span><span class="op" id="1684242">,</span>&nbsp;<span class="ident" id="1684244">c</span>&nbsp;<span class="op" id="1684246">*</span><span class="ident" id="1684247">hchan</span><span class="op" id="1684252">,</span>&nbsp;<span class="ident" id="1684254">pc</span>&nbsp;<span class="builtintype" id="1684257">uintptr</span><span class="op" id="1684264">,</span>&nbsp;<span class="ident" id="1684266">elem</span>&nbsp;<span class="ident" id="1684271">unsafe</span><span class="op" id="1684277">.</span><span class="ident" id="1684278">Pointer</span><span class="op" id="1684285">,</span>&nbsp;<span class="ident" id="1684287">so</span>&nbsp;<span class="builtintype" id="1684290">uintptr</span><span class="op" id="1684297">)</span>&nbsp;<span class="op" id="1684299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684302">i</span>&nbsp;<span class="op" id="1684304">:=</span>&nbsp;<span class="ident" id="1684307">sel</span><span class="op" id="1684310">.</span><span class="ident" id="1684311">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684318">if</span>&nbsp;<span class="ident" id="1684321">i</span>&nbsp;<span class="op" id="1684323">&gt;=</span>&nbsp;<span class="ident" id="1684326">sel</span><span class="op" id="1684329">.</span><span class="ident" id="1684330">tcase</span>&nbsp;<span class="op" id="1684336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684340">gothrow</span><span class="op" id="1684347">(</span><span class="string" id="1684348">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1684376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684382">sel</span><span class="op" id="1684385">.</span><span class="ident" id="1684386">ncase</span>&nbsp;<span class="op" id="1684392">=</span>&nbsp;<span class="ident" id="1684394">i</span>&nbsp;<span class="op" id="1684396">+</span>&nbsp;<span class="num" id="1684398">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684401">cas</span>&nbsp;<span class="op" id="1684405">:=</span>&nbsp;<span class="op" id="1684408">(</span><span class="op" id="1684409">*</span><span class="ident" id="1684410">scase</span><span class="op" id="1684415">)</span><span class="op" id="1684416">(</span><span class="ident" id="1684417">add</span><span class="op" id="1684420">(</span><span class="ident" id="1684421">unsafe</span><span class="op" id="1684427">.</span><span class="ident" id="1684428">Pointer</span><span class="op" id="1684435">(</span><span class="op" id="1684436">&amp;</span><span class="ident" id="1684437">sel</span><span class="op" id="1684440">.</span><span class="ident" id="1684441">scase</span><span class="op" id="1684446">)</span><span class="op" id="1684447">,</span>&nbsp;<span class="builtintype" id="1684449">uintptr</span><span class="op" id="1684456">(</span><span class="ident" id="1684457">i</span><span class="op" id="1684458">)</span><span class="op" id="1684459">*</span><span class="ident" id="1684460">unsafe</span><span class="op" id="1684466">.</span><span class="ident" id="1684467">Sizeof</span><span class="op" id="1684473">(</span><span class="ident" id="1684474">sel</span><span class="op" id="1684477">.</span><span class="ident" id="1684478">scase</span><span class="op" id="1684483">[</span><span class="num" id="1684484">0</span><span class="op" id="1684485">]</span><span class="op" id="1684486">)</span><span class="op" id="1684487">)</span><span class="op" id="1684488">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684492">cas</span><span class="op" id="1684495">.</span><span class="ident" id="1684496">pc</span>&nbsp;<span class="op" id="1684499">=</span>&nbsp;<span class="ident" id="1684501">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684505">cas</span><span class="op" id="1684508">.</span><span class="ident" id="1684509">_chan</span>&nbsp;<span class="op" id="1684515">=</span>&nbsp;<span class="ident" id="1684517">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684520">cas</span><span class="op" id="1684523">.</span><span class="ident" id="1684524">so</span>&nbsp;<span class="op" id="1684527">=</span>&nbsp;<span class="builtintype" id="1684529">uint16</span><span class="op" id="1684535">(</span><span class="ident" id="1684536">so</span><span class="op" id="1684538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684541">cas</span><span class="op" id="1684544">.</span><span class="ident" id="1684545">kind</span>&nbsp;<span class="op" id="1684550">=</span>&nbsp;<span class="ident" id="1684552">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684563">cas</span><span class="op" id="1684566">.</span><span class="ident" id="1684567">elem</span>&nbsp;<span class="op" id="1684572">=</span>&nbsp;<span class="ident" id="1684574">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684581">if</span>&nbsp;<span class="ident" id="1684584">debugSelect</span>&nbsp;<span class="op" id="1684596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1684600">print</span><span class="op" id="1684605">(</span><span class="string" id="1684606">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1684621">,</span>&nbsp;<span class="ident" id="1684623">sel</span><span class="op" id="1684626">,</span>&nbsp;<span class="string" id="1684628">&#34;&nbsp;pc=&#34;</span><span class="op" id="1684634">,</span>&nbsp;<span class="ident" id="1684636">hex</span><span class="op" id="1684639">(</span><span class="ident" id="1684640">cas</span><span class="op" id="1684643">.</span><span class="ident" id="1684644">pc</span><span class="op" id="1684646">)</span><span class="op" id="1684647">,</span>&nbsp;<span class="string" id="1684649">&#34;&nbsp;chan=&#34;</span><span class="op" id="1684657">,</span>&nbsp;<span class="ident" id="1684659">cas</span><span class="op" id="1684662">.</span><span class="ident" id="1684663">_chan</span><span class="op" id="1684668">,</span>&nbsp;<span class="string" id="1684670">&#34;&nbsp;so=&#34;</span><span class="op" id="1684676">,</span>&nbsp;<span class="ident" id="1684678">cas</span><span class="op" id="1684681">.</span><span class="ident" id="1684682">so</span><span class="op" id="1684684">,</span>&nbsp;<span class="string" id="1684686">&#34;\n&#34;</span><span class="op" id="1684690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684693">}</span><br>
<span class="lineno">70</span><span class="op" id="1684695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1684698">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1684711">func</span>&nbsp;<span class="ident" id="1684716">selectrecv</span><span class="op" id="1684726">(</span><span class="ident" id="1684727">sel</span>&nbsp;<span class="op" id="1684731">*</span><span class="ident" id="1684732">_select</span><span class="op" id="1684739">,</span>&nbsp;<span class="ident" id="1684741">c</span>&nbsp;<span class="op" id="1684743">*</span><span class="ident" id="1684744">hchan</span><span class="op" id="1684749">,</span>&nbsp;<span class="ident" id="1684751">elem</span>&nbsp;<span class="ident" id="1684756">unsafe</span><span class="op" id="1684762">.</span><span class="ident" id="1684763">Pointer</span><span class="op" id="1684770">)</span>&nbsp;<span class="op" id="1684772">(</span><span class="ident" id="1684773">selected</span>&nbsp;<span class="builtintype" id="1684782">bool</span><span class="op" id="1684786">)</span>&nbsp;<span class="op" id="1684788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684791">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684820">if</span>&nbsp;<span class="ident" id="1684823">c</span>&nbsp;<span class="op" id="1684825">!=</span>&nbsp;<span class="ident" id="1684828">nil</span>&nbsp;<span class="op" id="1684832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684836">selectrecvImpl</span><span class="op" id="1684850">(</span><span class="ident" id="1684851">sel</span><span class="op" id="1684854">,</span>&nbsp;<span class="ident" id="1684856">c</span><span class="op" id="1684857">,</span>&nbsp;<span class="ident" id="1684859">getcallerpc</span><span class="op" id="1684870">(</span><span class="ident" id="1684871">unsafe</span><span class="op" id="1684877">.</span><span class="ident" id="1684878">Pointer</span><span class="op" id="1684885">(</span><span class="op" id="1684886">&amp;</span><span class="ident" id="1684887">sel</span><span class="op" id="1684890">)</span><span class="op" id="1684891">)</span><span class="op" id="1684892">,</span>&nbsp;<span class="ident" id="1684894">elem</span><span class="op" id="1684898">,</span>&nbsp;<span class="ident" id="1684900">nil</span><span class="op" id="1684903">,</span>&nbsp;<span class="builtintype" id="1684905">uintptr</span><span class="op" id="1684912">(</span><span class="ident" id="1684913">unsafe</span><span class="op" id="1684919">.</span><span class="ident" id="1684920">Pointer</span><span class="op" id="1684927">(</span><span class="op" id="1684928">&amp;</span><span class="ident" id="1684929">selected</span><span class="op" id="1684937">)</span><span class="op" id="1684938">)</span><span class="op" id="1684939">-</span><span class="builtintype" id="1684940">uintptr</span><span class="op" id="1684947">(</span><span class="ident" id="1684948">unsafe</span><span class="op" id="1684954">.</span><span class="ident" id="1684955">Pointer</span><span class="op" id="1684962">(</span><span class="op" id="1684963">&amp;</span><span class="ident" id="1684964">sel</span><span class="op" id="1684967">)</span><span class="op" id="1684968">)</span><span class="op" id="1684969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684975">return</span><br>
<span class="lineno"></span><span class="op" id="1684982">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1684985">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1684998">func</span>&nbsp;<span class="ident" id="1685003">selectrecv2</span><span class="op" id="1685014">(</span><span class="ident" id="1685015">sel</span>&nbsp;<span class="op" id="1685019">*</span><span class="ident" id="1685020">_select</span><span class="op" id="1685027">,</span>&nbsp;<span class="ident" id="1685029">c</span>&nbsp;<span class="op" id="1685031">*</span><span class="ident" id="1685032">hchan</span><span class="op" id="1685037">,</span>&nbsp;<span class="ident" id="1685039">elem</span>&nbsp;<span class="ident" id="1685044">unsafe</span><span class="op" id="1685050">.</span><span class="ident" id="1685051">Pointer</span><span class="op" id="1685058">,</span>&nbsp;<span class="ident" id="1685060">received</span>&nbsp;<span class="op" id="1685069">*</span><span class="builtintype" id="1685070">bool</span><span class="op" id="1685074">)</span>&nbsp;<span class="op" id="1685076">(</span><span class="ident" id="1685077">selected</span>&nbsp;<span class="builtintype" id="1685086">bool</span><span class="op" id="1685090">)</span>&nbsp;<span class="op" id="1685092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685095">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685124">if</span>&nbsp;<span class="ident" id="1685127">c</span>&nbsp;<span class="op" id="1685129">!=</span>&nbsp;<span class="ident" id="1685132">nil</span>&nbsp;<span class="op" id="1685136">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685140">selectrecvImpl</span><span class="op" id="1685154">(</span><span class="ident" id="1685155">sel</span><span class="op" id="1685158">,</span>&nbsp;<span class="ident" id="1685160">c</span><span class="op" id="1685161">,</span>&nbsp;<span class="ident" id="1685163">getcallerpc</span><span class="op" id="1685174">(</span><span class="ident" id="1685175">unsafe</span><span class="op" id="1685181">.</span><span class="ident" id="1685182">Pointer</span><span class="op" id="1685189">(</span><span class="op" id="1685190">&amp;</span><span class="ident" id="1685191">sel</span><span class="op" id="1685194">)</span><span class="op" id="1685195">)</span><span class="op" id="1685196">,</span>&nbsp;<span class="ident" id="1685198">elem</span><span class="op" id="1685202">,</span>&nbsp;<span class="ident" id="1685204">received</span><span class="op" id="1685212">,</span>&nbsp;<span class="builtintype" id="1685214">uintptr</span><span class="op" id="1685221">(</span><span class="ident" id="1685222">unsafe</span><span class="op" id="1685228">.</span><span class="ident" id="1685229">Pointer</span><span class="op" id="1685236">(</span><span class="op" id="1685237">&amp;</span><span class="ident" id="1685238">selected</span><span class="op" id="1685246">)</span><span class="op" id="1685247">)</span><span class="op" id="1685248">-</span><span class="builtintype" id="1685249">uintptr</span><span class="op" id="1685256">(</span><span class="ident" id="1685257">unsafe</span><span class="op" id="1685263">.</span><span class="ident" id="1685264">Pointer</span><span class="op" id="1685271">(</span><span class="op" id="1685272">&amp;</span><span class="ident" id="1685273">sel</span><span class="op" id="1685276">)</span><span class="op" id="1685277">)</span><span class="op" id="1685278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685284">return</span><br>
<span class="lineno"></span><span class="op" id="1685291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1685294">func</span>&nbsp;<span class="ident" id="1685299">selectrecvImpl</span><span class="op" id="1685313">(</span><span class="ident" id="1685314">sel</span>&nbsp;<span class="op" id="1685318">*</span><span class="ident" id="1685319">_select</span><span class="op" id="1685326">,</span>&nbsp;<span class="ident" id="1685328">c</span>&nbsp;<span class="op" id="1685330">*</span><span class="ident" id="1685331">hchan</span><span class="op" id="1685336">,</span>&nbsp;<span class="ident" id="1685338">pc</span>&nbsp;<span class="builtintype" id="1685341">uintptr</span><span class="op" id="1685348">,</span>&nbsp;<span class="ident" id="1685350">elem</span>&nbsp;<span class="ident" id="1685355">unsafe</span><span class="op" id="1685361">.</span><span class="ident" id="1685362">Pointer</span><span class="op" id="1685369">,</span>&nbsp;<span class="ident" id="1685371">received</span>&nbsp;<span class="op" id="1685380">*</span><span class="builtintype" id="1685381">bool</span><span class="op" id="1685385">,</span>&nbsp;<span class="ident" id="1685387">so</span>&nbsp;<span class="builtintype" id="1685390">uintptr</span><span class="op" id="1685397">)</span>&nbsp;<span class="op" id="1685399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685402">i</span>&nbsp;<span class="op" id="1685404">:=</span>&nbsp;<span class="ident" id="1685407">sel</span><span class="op" id="1685410">.</span><span class="ident" id="1685411">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685418">if</span>&nbsp;<span class="ident" id="1685421">i</span>&nbsp;<span class="op" id="1685423">&gt;=</span>&nbsp;<span class="ident" id="1685426">sel</span><span class="op" id="1685429">.</span><span class="ident" id="1685430">tcase</span>&nbsp;<span class="op" id="1685436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685440">gothrow</span><span class="op" id="1685447">(</span><span class="string" id="1685448">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1685476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685479">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685482">sel</span><span class="op" id="1685485">.</span><span class="ident" id="1685486">ncase</span>&nbsp;<span class="op" id="1685492">=</span>&nbsp;<span class="ident" id="1685494">i</span>&nbsp;<span class="op" id="1685496">+</span>&nbsp;<span class="num" id="1685498">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685501">cas</span>&nbsp;<span class="op" id="1685505">:=</span>&nbsp;<span class="op" id="1685508">(</span><span class="op" id="1685509">*</span><span class="ident" id="1685510">scase</span><span class="op" id="1685515">)</span><span class="op" id="1685516">(</span><span class="ident" id="1685517">add</span><span class="op" id="1685520">(</span><span class="ident" id="1685521">unsafe</span><span class="op" id="1685527">.</span><span class="ident" id="1685528">Pointer</span><span class="op" id="1685535">(</span><span class="op" id="1685536">&amp;</span><span class="ident" id="1685537">sel</span><span class="op" id="1685540">.</span><span class="ident" id="1685541">scase</span><span class="op" id="1685546">)</span><span class="op" id="1685547">,</span>&nbsp;<span class="builtintype" id="1685549">uintptr</span><span class="op" id="1685556">(</span><span class="ident" id="1685557">i</span><span class="op" id="1685558">)</span><span class="op" id="1685559">*</span><span class="ident" id="1685560">unsafe</span><span class="op" id="1685566">.</span><span class="ident" id="1685567">Sizeof</span><span class="op" id="1685573">(</span><span class="ident" id="1685574">sel</span><span class="op" id="1685577">.</span><span class="ident" id="1685578">scase</span><span class="op" id="1685583">[</span><span class="num" id="1685584">0</span><span class="op" id="1685585">]</span><span class="op" id="1685586">)</span><span class="op" id="1685587">)</span><span class="op" id="1685588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685591">cas</span><span class="op" id="1685594">.</span><span class="ident" id="1685595">pc</span>&nbsp;<span class="op" id="1685598">=</span>&nbsp;<span class="ident" id="1685600">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685604">cas</span><span class="op" id="1685607">.</span><span class="ident" id="1685608">_chan</span>&nbsp;<span class="op" id="1685614">=</span>&nbsp;<span class="ident" id="1685616">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685619">cas</span><span class="op" id="1685622">.</span><span class="ident" id="1685623">so</span>&nbsp;<span class="op" id="1685626">=</span>&nbsp;<span class="builtintype" id="1685628">uint16</span><span class="op" id="1685634">(</span><span class="ident" id="1685635">so</span><span class="op" id="1685637">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685640">cas</span><span class="op" id="1685643">.</span><span class="ident" id="1685644">kind</span>&nbsp;<span class="op" id="1685649">=</span>&nbsp;<span class="ident" id="1685651">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685662">cas</span><span class="op" id="1685665">.</span><span class="ident" id="1685666">elem</span>&nbsp;<span class="op" id="1685671">=</span>&nbsp;<span class="ident" id="1685673">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685679">cas</span><span class="op" id="1685682">.</span><span class="ident" id="1685683">receivedp</span>&nbsp;<span class="op" id="1685693">=</span>&nbsp;<span class="ident" id="1685695">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685706">if</span>&nbsp;<span class="ident" id="1685709">debugSelect</span>&nbsp;<span class="op" id="1685721">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1685725">print</span><span class="op" id="1685730">(</span><span class="string" id="1685731">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1685746">,</span>&nbsp;<span class="ident" id="1685748">sel</span><span class="op" id="1685751">,</span>&nbsp;<span class="string" id="1685753">&#34;&nbsp;pc=&#34;</span><span class="op" id="1685759">,</span>&nbsp;<span class="ident" id="1685761">hex</span><span class="op" id="1685764">(</span><span class="ident" id="1685765">cas</span><span class="op" id="1685768">.</span><span class="ident" id="1685769">pc</span><span class="op" id="1685771">)</span><span class="op" id="1685772">,</span>&nbsp;<span class="string" id="1685774">&#34;&nbsp;chan=&#34;</span><span class="op" id="1685782">,</span>&nbsp;<span class="ident" id="1685784">cas</span><span class="op" id="1685787">.</span><span class="ident" id="1685788">_chan</span><span class="op" id="1685793">,</span>&nbsp;<span class="string" id="1685795">&#34;&nbsp;so=&#34;</span><span class="op" id="1685801">,</span>&nbsp;<span class="ident" id="1685803">cas</span><span class="op" id="1685806">.</span><span class="ident" id="1685807">so</span><span class="op" id="1685809">,</span>&nbsp;<span class="string" id="1685811">&#34;\n&#34;</span><span class="op" id="1685815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685818">}</span><br>
<span class="lineno"></span><span class="op" id="1685820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1685823">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1685836">func</span>&nbsp;<span class="ident" id="1685841">selectdefault</span><span class="op" id="1685854">(</span><span class="ident" id="1685855">sel</span>&nbsp;<span class="op" id="1685859">*</span><span class="ident" id="1685860">_select</span><span class="op" id="1685867">)</span>&nbsp;<span class="op" id="1685869">(</span><span class="ident" id="1685870">selected</span>&nbsp;<span class="builtintype" id="1685879">bool</span><span class="op" id="1685883">)</span>&nbsp;<span class="op" id="1685885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685888">selectdefaultImpl</span><span class="op" id="1685905">(</span><span class="ident" id="1685906">sel</span><span class="op" id="1685909">,</span>&nbsp;<span class="ident" id="1685911">getcallerpc</span><span class="op" id="1685922">(</span><span class="ident" id="1685923">unsafe</span><span class="op" id="1685929">.</span><span class="ident" id="1685930">Pointer</span><span class="op" id="1685937">(</span><span class="op" id="1685938">&amp;</span><span class="ident" id="1685939">sel</span><span class="op" id="1685942">)</span><span class="op" id="1685943">)</span><span class="op" id="1685944">,</span>&nbsp;<span class="builtintype" id="1685946">uintptr</span><span class="op" id="1685953">(</span><span class="ident" id="1685954">unsafe</span><span class="op" id="1685960">.</span><span class="ident" id="1685961">Pointer</span><span class="op" id="1685968">(</span><span class="op" id="1685969">&amp;</span><span class="ident" id="1685970">selected</span><span class="op" id="1685978">)</span><span class="op" id="1685979">)</span><span class="op" id="1685980">-</span><span class="builtintype" id="1685981">uintptr</span><span class="op" id="1685988">(</span><span class="ident" id="1685989">unsafe</span><span class="op" id="1685995">.</span><span class="ident" id="1685996">Pointer</span><span class="op" id="1686003">(</span><span class="op" id="1686004">&amp;</span><span class="ident" id="1686005">sel</span><span class="op" id="1686008">)</span><span class="op" id="1686009">)</span><span class="op" id="1686010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686013">return</span><br>
<span class="lineno"></span><span class="op" id="1686020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1686023">func</span>&nbsp;<span class="ident" id="1686028">selectdefaultImpl</span><span class="op" id="1686045">(</span><span class="ident" id="1686046">sel</span>&nbsp;<span class="op" id="1686050">*</span><span class="ident" id="1686051">_select</span><span class="op" id="1686058">,</span>&nbsp;<span class="ident" id="1686060">callerpc</span>&nbsp;<span class="builtintype" id="1686069">uintptr</span><span class="op" id="1686076">,</span>&nbsp;<span class="ident" id="1686078">so</span>&nbsp;<span class="builtintype" id="1686081">uintptr</span><span class="op" id="1686088">)</span>&nbsp;<span class="op" id="1686090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686093">i</span>&nbsp;<span class="op" id="1686095">:=</span>&nbsp;<span class="ident" id="1686098">sel</span><span class="op" id="1686101">.</span><span class="ident" id="1686102">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686109">if</span>&nbsp;<span class="ident" id="1686112">i</span>&nbsp;<span class="op" id="1686114">&gt;=</span>&nbsp;<span class="ident" id="1686117">sel</span><span class="op" id="1686120">.</span><span class="ident" id="1686121">tcase</span>&nbsp;<span class="op" id="1686127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686131">gothrow</span><span class="op" id="1686138">(</span><span class="string" id="1686139">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1686170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686173">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686176">sel</span><span class="op" id="1686179">.</span><span class="ident" id="1686180">ncase</span>&nbsp;<span class="op" id="1686186">=</span>&nbsp;<span class="ident" id="1686188">i</span>&nbsp;<span class="op" id="1686190">+</span>&nbsp;<span class="num" id="1686192">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686195">cas</span>&nbsp;<span class="op" id="1686199">:=</span>&nbsp;<span class="op" id="1686202">(</span><span class="op" id="1686203">*</span><span class="ident" id="1686204">scase</span><span class="op" id="1686209">)</span><span class="op" id="1686210">(</span><span class="ident" id="1686211">add</span><span class="op" id="1686214">(</span><span class="ident" id="1686215">unsafe</span><span class="op" id="1686221">.</span><span class="ident" id="1686222">Pointer</span><span class="op" id="1686229">(</span><span class="op" id="1686230">&amp;</span><span class="ident" id="1686231">sel</span><span class="op" id="1686234">.</span><span class="ident" id="1686235">scase</span><span class="op" id="1686240">)</span><span class="op" id="1686241">,</span>&nbsp;<span class="builtintype" id="1686243">uintptr</span><span class="op" id="1686250">(</span><span class="ident" id="1686251">i</span><span class="op" id="1686252">)</span><span class="op" id="1686253">*</span><span class="ident" id="1686254">unsafe</span><span class="op" id="1686260">.</span><span class="ident" id="1686261">Sizeof</span><span class="op" id="1686267">(</span><span class="ident" id="1686268">sel</span><span class="op" id="1686271">.</span><span class="ident" id="1686272">scase</span><span class="op" id="1686277">[</span><span class="num" id="1686278">0</span><span class="op" id="1686279">]</span><span class="op" id="1686280">)</span><span class="op" id="1686281">)</span><span class="op" id="1686282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686285">cas</span><span class="op" id="1686288">.</span><span class="ident" id="1686289">pc</span>&nbsp;<span class="op" id="1686292">=</span>&nbsp;<span class="ident" id="1686294">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686304">cas</span><span class="op" id="1686307">.</span><span class="ident" id="1686308">_chan</span>&nbsp;<span class="op" id="1686314">=</span>&nbsp;<span class="ident" id="1686316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686321">cas</span><span class="op" id="1686324">.</span><span class="ident" id="1686325">so</span>&nbsp;<span class="op" id="1686328">=</span>&nbsp;<span class="builtintype" id="1686330">uint16</span><span class="op" id="1686336">(</span><span class="ident" id="1686337">so</span><span class="op" id="1686339">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686342">cas</span><span class="op" id="1686345">.</span><span class="ident" id="1686346">kind</span>&nbsp;<span class="op" id="1686351">=</span>&nbsp;<span class="ident" id="1686353">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686368">if</span>&nbsp;<span class="ident" id="1686371">debugSelect</span>&nbsp;<span class="op" id="1686383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1686387">print</span><span class="op" id="1686392">(</span><span class="string" id="1686393">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1686411">,</span>&nbsp;<span class="ident" id="1686413">sel</span><span class="op" id="1686416">,</span>&nbsp;<span class="string" id="1686418">&#34;&nbsp;pc=&#34;</span><span class="op" id="1686424">,</span>&nbsp;<span class="ident" id="1686426">hex</span><span class="op" id="1686429">(</span><span class="ident" id="1686430">cas</span><span class="op" id="1686433">.</span><span class="ident" id="1686434">pc</span><span class="op" id="1686436">)</span><span class="op" id="1686437">,</span>&nbsp;<span class="string" id="1686439">&#34;&nbsp;so=&#34;</span><span class="op" id="1686445">,</span>&nbsp;<span class="ident" id="1686447">cas</span><span class="op" id="1686450">.</span><span class="ident" id="1686451">so</span><span class="op" id="1686453">,</span>&nbsp;<span class="string" id="1686455">&#34;\n&#34;</span><span class="op" id="1686459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686462">}</span><br>
<span class="lineno">130</span><span class="op" id="1686464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1686467">func</span>&nbsp;<span class="ident" id="1686472">sellock</span><span class="op" id="1686479">(</span><span class="ident" id="1686480">sel</span>&nbsp;<span class="op" id="1686484">*</span><span class="ident" id="1686485">_select</span><span class="op" id="1686492">)</span>&nbsp;<span class="op" id="1686494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686497">lockslice</span>&nbsp;<span class="op" id="1686507">:=</span>&nbsp;<span class="ident" id="1686510">sliceStruct</span><span class="op" id="1686521">{</span><span class="ident" id="1686522">unsafe</span><span class="op" id="1686528">.</span><span class="ident" id="1686529">Pointer</span><span class="op" id="1686536">(</span><span class="ident" id="1686537">sel</span><span class="op" id="1686540">.</span><span class="ident" id="1686541">lockorder</span><span class="op" id="1686550">)</span><span class="op" id="1686551">,</span>&nbsp;<span class="builtintype" id="1686553">int</span><span class="op" id="1686556">(</span><span class="ident" id="1686557">sel</span><span class="op" id="1686560">.</span><span class="ident" id="1686561">ncase</span><span class="op" id="1686566">)</span><span class="op" id="1686567">,</span>&nbsp;<span class="builtintype" id="1686569">int</span><span class="op" id="1686572">(</span><span class="ident" id="1686573">sel</span><span class="op" id="1686576">.</span><span class="ident" id="1686577">ncase</span><span class="op" id="1686582">)</span><span class="op" id="1686583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686586">lockorder</span>&nbsp;<span class="op" id="1686596">:=</span>&nbsp;<span class="op" id="1686599">*</span><span class="op" id="1686600">(</span><span class="op" id="1686601">*</span><span class="op" id="1686602">[</span><span class="op" id="1686603">]</span><span class="op" id="1686604">*</span><span class="ident" id="1686605">hchan</span><span class="op" id="1686610">)</span><span class="op" id="1686611">(</span><span class="ident" id="1686612">unsafe</span><span class="op" id="1686618">.</span><span class="ident" id="1686619">Pointer</span><span class="op" id="1686626">(</span><span class="op" id="1686627">&amp;</span><span class="ident" id="1686628">lockslice</span><span class="op" id="1686637">)</span><span class="op" id="1686638">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686641">var</span>&nbsp;<span class="ident" id="1686645">c</span>&nbsp;<span class="op" id="1686647">*</span><span class="ident" id="1686648">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686655">for</span>&nbsp;<span class="ident" id="1686659">_</span><span class="op" id="1686660">,</span>&nbsp;<span class="ident" id="1686662">c0</span>&nbsp;<span class="op" id="1686665">:=</span>&nbsp;<span class="keyword" id="1686668">range</span>&nbsp;<span class="ident" id="1686674">lockorder</span>&nbsp;<span class="op" id="1686684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686688">if</span>&nbsp;<span class="ident" id="1686691">c0</span>&nbsp;<span class="op" id="1686694">!=</span>&nbsp;<span class="ident" id="1686697">nil</span>&nbsp;<span class="op" id="1686701">&amp;&amp;</span>&nbsp;<span class="ident" id="1686704">c0</span>&nbsp;<span class="op" id="1686707">!=</span>&nbsp;<span class="ident" id="1686710">c</span>&nbsp;<span class="op" id="1686712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686717">c</span>&nbsp;<span class="op" id="1686719">=</span>&nbsp;<span class="ident" id="1686721">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686727">lock</span><span class="op" id="1686731">(</span><span class="op" id="1686732">&amp;</span><span class="ident" id="1686733">c</span><span class="op" id="1686734">.</span><span class="ident" id="1686735">lock</span><span class="op" id="1686739">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686746">}</span><br>
<span class="lineno"></span><span class="op" id="1686748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1686751">func</span>&nbsp;<span class="ident" id="1686756">selunlock</span><span class="op" id="1686765">(</span><span class="ident" id="1686766">sel</span>&nbsp;<span class="op" id="1686770">*</span><span class="ident" id="1686771">_select</span><span class="op" id="1686778">)</span>&nbsp;<span class="op" id="1686780">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686783">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686856">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686929">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686967">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687041">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687110">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687185">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687257">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687322">n</span>&nbsp;<span class="op" id="1687324">:=</span>&nbsp;<span class="builtintype" id="1687327">int</span><span class="op" id="1687330">(</span><span class="ident" id="1687331">sel</span><span class="op" id="1687334">.</span><span class="ident" id="1687335">ncase</span><span class="op" id="1687340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687343">r</span>&nbsp;<span class="op" id="1687345">:=</span>&nbsp;<span class="num" id="1687348">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687351">lockslice</span>&nbsp;<span class="op" id="1687361">:=</span>&nbsp;<span class="ident" id="1687364">sliceStruct</span><span class="op" id="1687375">{</span><span class="ident" id="1687376">unsafe</span><span class="op" id="1687382">.</span><span class="ident" id="1687383">Pointer</span><span class="op" id="1687390">(</span><span class="ident" id="1687391">sel</span><span class="op" id="1687394">.</span><span class="ident" id="1687395">lockorder</span><span class="op" id="1687404">)</span><span class="op" id="1687405">,</span>&nbsp;<span class="ident" id="1687407">n</span><span class="op" id="1687408">,</span>&nbsp;<span class="ident" id="1687410">n</span><span class="op" id="1687411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687414">lockorder</span>&nbsp;<span class="op" id="1687424">:=</span>&nbsp;<span class="op" id="1687427">*</span><span class="op" id="1687428">(</span><span class="op" id="1687429">*</span><span class="op" id="1687430">[</span><span class="op" id="1687431">]</span><span class="op" id="1687432">*</span><span class="ident" id="1687433">hchan</span><span class="op" id="1687438">)</span><span class="op" id="1687439">(</span><span class="ident" id="1687440">unsafe</span><span class="op" id="1687446">.</span><span class="ident" id="1687447">Pointer</span><span class="op" id="1687454">(</span><span class="op" id="1687455">&amp;</span><span class="ident" id="1687456">lockslice</span><span class="op" id="1687465">)</span><span class="op" id="1687466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687469">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687495">if</span>&nbsp;<span class="ident" id="1687498">n</span>&nbsp;<span class="op" id="1687500">&gt;</span>&nbsp;<span class="num" id="1687502">0</span>&nbsp;<span class="op" id="1687504">&amp;&amp;</span>&nbsp;<span class="ident" id="1687507">lockorder</span><span class="op" id="1687516">[</span><span class="num" id="1687517">0</span><span class="op" id="1687518">]</span>&nbsp;<span class="op" id="1687520">==</span>&nbsp;<span class="ident" id="1687523">nil</span>&nbsp;<span class="op" id="1687527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687531">r</span>&nbsp;<span class="op" id="1687533">=</span>&nbsp;<span class="num" id="1687535">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687541">for</span>&nbsp;<span class="ident" id="1687545">i</span>&nbsp;<span class="op" id="1687547">:=</span>&nbsp;<span class="ident" id="1687550">n</span>&nbsp;<span class="op" id="1687552">-</span>&nbsp;<span class="num" id="1687554">1</span><span class="op" id="1687555">;</span>&nbsp;<span class="ident" id="1687557">i</span>&nbsp;<span class="op" id="1687559">&gt;=</span>&nbsp;<span class="ident" id="1687562">r</span><span class="op" id="1687563">;</span>&nbsp;<span class="ident" id="1687565">i</span><span class="op" id="1687566">--</span>&nbsp;<span class="op" id="1687569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687573">c</span>&nbsp;<span class="op" id="1687575">:=</span>&nbsp;<span class="ident" id="1687578">lockorder</span><span class="op" id="1687587">[</span><span class="ident" id="1687588">i</span><span class="op" id="1687589">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687593">if</span>&nbsp;<span class="ident" id="1687596">i</span>&nbsp;<span class="op" id="1687598">&gt;</span>&nbsp;<span class="num" id="1687600">0</span>&nbsp;<span class="op" id="1687602">&amp;&amp;</span>&nbsp;<span class="ident" id="1687605">c</span>&nbsp;<span class="op" id="1687607">==</span>&nbsp;<span class="ident" id="1687610">lockorder</span><span class="op" id="1687619">[</span><span class="ident" id="1687620">i</span><span class="op" id="1687621">-</span><span class="num" id="1687622">1</span><span class="op" id="1687623">]</span>&nbsp;<span class="op" id="1687625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687630">continue</span>&nbsp;<span class="comment" id="1687639">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687685">unlock</span><span class="op" id="1687691">(</span><span class="op" id="1687692">&amp;</span><span class="ident" id="1687693">c</span><span class="op" id="1687694">.</span><span class="ident" id="1687695">lock</span><span class="op" id="1687699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687702">}</span><br>
<span class="lineno"></span><span class="op" id="1687704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1687707">func</span>&nbsp;<span class="ident" id="1687712">selparkcommit</span><span class="op" id="1687725">(</span><span class="ident" id="1687726">gp</span>&nbsp;<span class="op" id="1687729">*</span><span class="ident" id="1687730">g</span><span class="op" id="1687731">,</span>&nbsp;<span class="ident" id="1687733">sel</span>&nbsp;<span class="op" id="1687737">*</span><span class="ident" id="1687738">_select</span><span class="op" id="1687745">)</span>&nbsp;<span class="builtintype" id="1687747">bool</span>&nbsp;<span class="op" id="1687752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687755">selunlock</span><span class="op" id="1687764">(</span><span class="ident" id="1687765">sel</span><span class="op" id="1687768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687771">return</span>&nbsp;<span class="builtintype" id="1687778">true</span><br>
<span class="lineno"></span><span class="op" id="1687783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1687786">func</span>&nbsp;<span class="ident" id="1687791">block</span><span class="op" id="1687796">(</span><span class="op" id="1687797">)</span>&nbsp;<span class="op" id="1687799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687802">gopark</span><span class="op" id="1687808">(</span><span class="ident" id="1687809">nil</span><span class="op" id="1687812">,</span>&nbsp;<span class="ident" id="1687814">nil</span><span class="op" id="1687817">,</span>&nbsp;<span class="string" id="1687819">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1687838">)</span>&nbsp;<span class="comment" id="1687840">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1687851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1687854">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1687922">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1687979">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1687992">func</span>&nbsp;<span class="ident" id="1687997">selectgo</span><span class="op" id="1688005">(</span><span class="ident" id="1688006">sel</span>&nbsp;<span class="op" id="1688010">*</span><span class="ident" id="1688011">_select</span><span class="op" id="1688018">)</span>&nbsp;<span class="op" id="1688020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688023">pc</span><span class="op" id="1688025">,</span>&nbsp;<span class="ident" id="1688027">offset</span>&nbsp;<span class="op" id="1688034">:=</span>&nbsp;<span class="ident" id="1688037">selectgoImpl</span><span class="op" id="1688049">(</span><span class="ident" id="1688050">sel</span><span class="op" id="1688053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688056">*</span><span class="op" id="1688057">(</span><span class="op" id="1688058">*</span><span class="builtintype" id="1688059">bool</span><span class="op" id="1688063">)</span><span class="op" id="1688064">(</span><span class="ident" id="1688065">add</span><span class="op" id="1688068">(</span><span class="ident" id="1688069">unsafe</span><span class="op" id="1688075">.</span><span class="ident" id="1688076">Pointer</span><span class="op" id="1688083">(</span><span class="op" id="1688084">&amp;</span><span class="ident" id="1688085">sel</span><span class="op" id="1688088">)</span><span class="op" id="1688089">,</span>&nbsp;<span class="builtintype" id="1688091">uintptr</span><span class="op" id="1688098">(</span><span class="ident" id="1688099">offset</span><span class="op" id="1688105">)</span><span class="op" id="1688106">)</span><span class="op" id="1688107">)</span>&nbsp;<span class="op" id="1688109">=</span>&nbsp;<span class="builtintype" id="1688111">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688117">setcallerpc</span><span class="op" id="1688128">(</span><span class="ident" id="1688129">unsafe</span><span class="op" id="1688135">.</span><span class="ident" id="1688136">Pointer</span><span class="op" id="1688143">(</span><span class="op" id="1688144">&amp;</span><span class="ident" id="1688145">sel</span><span class="op" id="1688148">)</span><span class="op" id="1688149">,</span>&nbsp;<span class="ident" id="1688151">pc</span><span class="op" id="1688153">)</span><br>
<span class="lineno"></span><span class="op" id="1688155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1688158">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1688219">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1688240">func</span>&nbsp;<span class="ident" id="1688245">selectgoImpl</span><span class="op" id="1688257">(</span><span class="ident" id="1688258">sel</span>&nbsp;<span class="op" id="1688262">*</span><span class="ident" id="1688263">_select</span><span class="op" id="1688270">)</span>&nbsp;<span class="op" id="1688272">(</span><span class="builtintype" id="1688273">uintptr</span><span class="op" id="1688280">,</span>&nbsp;<span class="builtintype" id="1688282">uint16</span><span class="op" id="1688288">)</span>&nbsp;<span class="op" id="1688290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688293">if</span>&nbsp;<span class="ident" id="1688296">debugSelect</span>&nbsp;<span class="op" id="1688308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1688312">print</span><span class="op" id="1688317">(</span><span class="string" id="1688318">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1688332">,</span>&nbsp;<span class="ident" id="1688334">sel</span><span class="op" id="1688337">,</span>&nbsp;<span class="string" id="1688339">&#34;\n&#34;</span><span class="op" id="1688343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688350">scaseslice</span>&nbsp;<span class="op" id="1688361">:=</span>&nbsp;<span class="ident" id="1688364">sliceStruct</span><span class="op" id="1688375">{</span><span class="ident" id="1688376">unsafe</span><span class="op" id="1688382">.</span><span class="ident" id="1688383">Pointer</span><span class="op" id="1688390">(</span><span class="op" id="1688391">&amp;</span><span class="ident" id="1688392">sel</span><span class="op" id="1688395">.</span><span class="ident" id="1688396">scase</span><span class="op" id="1688401">)</span><span class="op" id="1688402">,</span>&nbsp;<span class="builtintype" id="1688404">int</span><span class="op" id="1688407">(</span><span class="ident" id="1688408">sel</span><span class="op" id="1688411">.</span><span class="ident" id="1688412">ncase</span><span class="op" id="1688417">)</span><span class="op" id="1688418">,</span>&nbsp;<span class="builtintype" id="1688420">int</span><span class="op" id="1688423">(</span><span class="ident" id="1688424">sel</span><span class="op" id="1688427">.</span><span class="ident" id="1688428">ncase</span><span class="op" id="1688433">)</span><span class="op" id="1688434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688437">scases</span>&nbsp;<span class="op" id="1688444">:=</span>&nbsp;<span class="op" id="1688447">*</span><span class="op" id="1688448">(</span><span class="op" id="1688449">*</span><span class="op" id="1688450">[</span><span class="op" id="1688451">]</span><span class="ident" id="1688452">scase</span><span class="op" id="1688457">)</span><span class="op" id="1688458">(</span><span class="ident" id="1688459">unsafe</span><span class="op" id="1688465">.</span><span class="ident" id="1688466">Pointer</span><span class="op" id="1688473">(</span><span class="op" id="1688474">&amp;</span><span class="ident" id="1688475">scaseslice</span><span class="op" id="1688485">)</span><span class="op" id="1688486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688490">var</span>&nbsp;<span class="ident" id="1688494">t0</span>&nbsp;<span class="ident" id="1688497">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688504">if</span>&nbsp;<span class="ident" id="1688507">blockprofilerate</span>&nbsp;<span class="op" id="1688524">&gt;</span>&nbsp;<span class="num" id="1688526">0</span>&nbsp;<span class="op" id="1688528">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688532">t0</span>&nbsp;<span class="op" id="1688535">=</span>&nbsp;<span class="ident" id="1688537">cputicks</span><span class="op" id="1688545">(</span><span class="op" id="1688546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688550">for</span>&nbsp;<span class="ident" id="1688554">i</span>&nbsp;<span class="op" id="1688556">:=</span>&nbsp;<span class="num" id="1688559">0</span><span class="op" id="1688560">;</span>&nbsp;<span class="ident" id="1688562">i</span>&nbsp;<span class="op" id="1688564">&lt;</span>&nbsp;<span class="builtintype" id="1688566">int</span><span class="op" id="1688569">(</span><span class="ident" id="1688570">sel</span><span class="op" id="1688573">.</span><span class="ident" id="1688574">ncase</span><span class="op" id="1688579">)</span><span class="op" id="1688580">;</span>&nbsp;<span class="ident" id="1688582">i</span><span class="op" id="1688583">++</span>&nbsp;<span class="op" id="1688586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688591">scases</span><span class="op" id="1688597">[</span><span class="ident" id="1688598">i</span><span class="op" id="1688599">]</span><span class="op" id="1688600">.</span><span class="ident" id="1688601">releasetime</span>&nbsp;<span class="op" id="1688613">=</span>&nbsp;<span class="op" id="1688615">-</span><span class="num" id="1688616">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688623">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688627">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688682">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688742">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688799">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688861">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688919">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688979">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689018">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689046">pollslice</span>&nbsp;<span class="op" id="1689056">:=</span>&nbsp;<span class="ident" id="1689059">sliceStruct</span><span class="op" id="1689070">{</span><span class="ident" id="1689071">unsafe</span><span class="op" id="1689077">.</span><span class="ident" id="1689078">Pointer</span><span class="op" id="1689085">(</span><span class="ident" id="1689086">sel</span><span class="op" id="1689089">.</span><span class="ident" id="1689090">pollorder</span><span class="op" id="1689099">)</span><span class="op" id="1689100">,</span>&nbsp;<span class="builtintype" id="1689102">int</span><span class="op" id="1689105">(</span><span class="ident" id="1689106">sel</span><span class="op" id="1689109">.</span><span class="ident" id="1689110">ncase</span><span class="op" id="1689115">)</span><span class="op" id="1689116">,</span>&nbsp;<span class="builtintype" id="1689118">int</span><span class="op" id="1689121">(</span><span class="ident" id="1689122">sel</span><span class="op" id="1689125">.</span><span class="ident" id="1689126">ncase</span><span class="op" id="1689131">)</span><span class="op" id="1689132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689135">pollorder</span>&nbsp;<span class="op" id="1689145">:=</span>&nbsp;<span class="op" id="1689148">*</span><span class="op" id="1689149">(</span><span class="op" id="1689150">*</span><span class="op" id="1689151">[</span><span class="op" id="1689152">]</span><span class="builtintype" id="1689153">uint16</span><span class="op" id="1689159">)</span><span class="op" id="1689160">(</span><span class="ident" id="1689161">unsafe</span><span class="op" id="1689167">.</span><span class="ident" id="1689168">Pointer</span><span class="op" id="1689175">(</span><span class="op" id="1689176">&amp;</span><span class="ident" id="1689177">pollslice</span><span class="op" id="1689186">)</span><span class="op" id="1689187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689190">for</span>&nbsp;<span class="ident" id="1689194">i</span>&nbsp;<span class="op" id="1689196">:=</span>&nbsp;<span class="num" id="1689199">0</span><span class="op" id="1689200">;</span>&nbsp;<span class="ident" id="1689202">i</span>&nbsp;<span class="op" id="1689204">&lt;</span>&nbsp;<span class="builtintype" id="1689206">int</span><span class="op" id="1689209">(</span><span class="ident" id="1689210">sel</span><span class="op" id="1689213">.</span><span class="ident" id="1689214">ncase</span><span class="op" id="1689219">)</span><span class="op" id="1689220">;</span>&nbsp;<span class="ident" id="1689222">i</span><span class="op" id="1689223">++</span>&nbsp;<span class="op" id="1689226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689230">pollorder</span><span class="op" id="1689239">[</span><span class="ident" id="1689240">i</span><span class="op" id="1689241">]</span>&nbsp;<span class="op" id="1689243">=</span>&nbsp;<span class="builtintype" id="1689245">uint16</span><span class="op" id="1689251">(</span><span class="ident" id="1689252">i</span><span class="op" id="1689253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689256">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689259">for</span>&nbsp;<span class="ident" id="1689263">i</span>&nbsp;<span class="op" id="1689265">:=</span>&nbsp;<span class="num" id="1689268">1</span><span class="op" id="1689269">;</span>&nbsp;<span class="ident" id="1689271">i</span>&nbsp;<span class="op" id="1689273">&lt;</span>&nbsp;<span class="builtintype" id="1689275">int</span><span class="op" id="1689278">(</span><span class="ident" id="1689279">sel</span><span class="op" id="1689282">.</span><span class="ident" id="1689283">ncase</span><span class="op" id="1689288">)</span><span class="op" id="1689289">;</span>&nbsp;<span class="ident" id="1689291">i</span><span class="op" id="1689292">++</span>&nbsp;<span class="op" id="1689295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689299">o</span>&nbsp;<span class="op" id="1689301">:=</span>&nbsp;<span class="ident" id="1689304">pollorder</span><span class="op" id="1689313">[</span><span class="ident" id="1689314">i</span><span class="op" id="1689315">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689319">j</span>&nbsp;<span class="op" id="1689321">:=</span>&nbsp;<span class="builtintype" id="1689324">int</span><span class="op" id="1689327">(</span><span class="ident" id="1689328">fastrand1</span><span class="op" id="1689337">(</span><span class="op" id="1689338">)</span><span class="op" id="1689339">)</span>&nbsp;<span class="op" id="1689341">%</span>&nbsp;<span class="op" id="1689343">(</span><span class="ident" id="1689344">i</span>&nbsp;<span class="op" id="1689346">+</span>&nbsp;<span class="num" id="1689348">1</span><span class="op" id="1689349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689353">pollorder</span><span class="op" id="1689362">[</span><span class="ident" id="1689363">i</span><span class="op" id="1689364">]</span>&nbsp;<span class="op" id="1689366">=</span>&nbsp;<span class="ident" id="1689368">pollorder</span><span class="op" id="1689377">[</span><span class="ident" id="1689378">j</span><span class="op" id="1689379">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689383">pollorder</span><span class="op" id="1689392">[</span><span class="ident" id="1689393">j</span><span class="op" id="1689394">]</span>&nbsp;<span class="op" id="1689396">=</span>&nbsp;<span class="ident" id="1689398">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689405">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689467">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689545">lockslice</span>&nbsp;<span class="op" id="1689555">:=</span>&nbsp;<span class="ident" id="1689558">sliceStruct</span><span class="op" id="1689569">{</span><span class="ident" id="1689570">unsafe</span><span class="op" id="1689576">.</span><span class="ident" id="1689577">Pointer</span><span class="op" id="1689584">(</span><span class="ident" id="1689585">sel</span><span class="op" id="1689588">.</span><span class="ident" id="1689589">lockorder</span><span class="op" id="1689598">)</span><span class="op" id="1689599">,</span>&nbsp;<span class="builtintype" id="1689601">int</span><span class="op" id="1689604">(</span><span class="ident" id="1689605">sel</span><span class="op" id="1689608">.</span><span class="ident" id="1689609">ncase</span><span class="op" id="1689614">)</span><span class="op" id="1689615">,</span>&nbsp;<span class="builtintype" id="1689617">int</span><span class="op" id="1689620">(</span><span class="ident" id="1689621">sel</span><span class="op" id="1689624">.</span><span class="ident" id="1689625">ncase</span><span class="op" id="1689630">)</span><span class="op" id="1689631">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689634">lockorder</span>&nbsp;<span class="op" id="1689644">:=</span>&nbsp;<span class="op" id="1689647">*</span><span class="op" id="1689648">(</span><span class="op" id="1689649">*</span><span class="op" id="1689650">[</span><span class="op" id="1689651">]</span><span class="op" id="1689652">*</span><span class="ident" id="1689653">hchan</span><span class="op" id="1689658">)</span><span class="op" id="1689659">(</span><span class="ident" id="1689660">unsafe</span><span class="op" id="1689666">.</span><span class="ident" id="1689667">Pointer</span><span class="op" id="1689674">(</span><span class="op" id="1689675">&amp;</span><span class="ident" id="1689676">lockslice</span><span class="op" id="1689685">)</span><span class="op" id="1689686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689689">for</span>&nbsp;<span class="ident" id="1689693">i</span>&nbsp;<span class="op" id="1689695">:=</span>&nbsp;<span class="num" id="1689698">0</span><span class="op" id="1689699">;</span>&nbsp;<span class="ident" id="1689701">i</span>&nbsp;<span class="op" id="1689703">&lt;</span>&nbsp;<span class="builtintype" id="1689705">int</span><span class="op" id="1689708">(</span><span class="ident" id="1689709">sel</span><span class="op" id="1689712">.</span><span class="ident" id="1689713">ncase</span><span class="op" id="1689718">)</span><span class="op" id="1689719">;</span>&nbsp;<span class="ident" id="1689721">i</span><span class="op" id="1689722">++</span>&nbsp;<span class="op" id="1689725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689729">j</span>&nbsp;<span class="op" id="1689731">:=</span>&nbsp;<span class="ident" id="1689734">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689738">c</span>&nbsp;<span class="op" id="1689740">:=</span>&nbsp;<span class="ident" id="1689743">scases</span><span class="op" id="1689749">[</span><span class="ident" id="1689750">j</span><span class="op" id="1689751">]</span><span class="op" id="1689752">.</span><span class="ident" id="1689753">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689761">for</span>&nbsp;<span class="ident" id="1689765">j</span>&nbsp;<span class="op" id="1689767">&gt;</span>&nbsp;<span class="num" id="1689769">0</span>&nbsp;<span class="op" id="1689771">&amp;&amp;</span>&nbsp;<span class="ident" id="1689774">lockorder</span><span class="op" id="1689783">[</span><span class="op" id="1689784">(</span><span class="ident" id="1689785">j</span><span class="op" id="1689786">-</span><span class="num" id="1689787">1</span><span class="op" id="1689788">)</span><span class="op" id="1689789">/</span><span class="num" id="1689790">2</span><span class="op" id="1689791">]</span><span class="op" id="1689792">.</span><span class="ident" id="1689793">sortkey</span><span class="op" id="1689800">(</span><span class="op" id="1689801">)</span>&nbsp;<span class="op" id="1689803">&lt;</span>&nbsp;<span class="ident" id="1689805">c</span><span class="op" id="1689806">.</span><span class="ident" id="1689807">sortkey</span><span class="op" id="1689814">(</span><span class="op" id="1689815">)</span>&nbsp;<span class="op" id="1689817">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689822">k</span>&nbsp;<span class="op" id="1689824">:=</span>&nbsp;<span class="op" id="1689827">(</span><span class="ident" id="1689828">j</span>&nbsp;<span class="op" id="1689830">-</span>&nbsp;<span class="num" id="1689832">1</span><span class="op" id="1689833">)</span>&nbsp;<span class="op" id="1689835">/</span>&nbsp;<span class="num" id="1689837">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689842">lockorder</span><span class="op" id="1689851">[</span><span class="ident" id="1689852">j</span><span class="op" id="1689853">]</span>&nbsp;<span class="op" id="1689855">=</span>&nbsp;<span class="ident" id="1689857">lockorder</span><span class="op" id="1689866">[</span><span class="ident" id="1689867">k</span><span class="op" id="1689868">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689873">j</span>&nbsp;<span class="op" id="1689875">=</span>&nbsp;<span class="ident" id="1689877">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689885">lockorder</span><span class="op" id="1689894">[</span><span class="ident" id="1689895">j</span><span class="op" id="1689896">]</span>&nbsp;<span class="op" id="1689898">=</span>&nbsp;<span class="ident" id="1689900">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689906">for</span>&nbsp;<span class="ident" id="1689910">i</span>&nbsp;<span class="op" id="1689912">:=</span>&nbsp;<span class="builtintype" id="1689915">int</span><span class="op" id="1689918">(</span><span class="ident" id="1689919">sel</span><span class="op" id="1689922">.</span><span class="ident" id="1689923">ncase</span><span class="op" id="1689928">)</span>&nbsp;<span class="op" id="1689930">-</span>&nbsp;<span class="num" id="1689932">1</span><span class="op" id="1689933">;</span>&nbsp;<span class="ident" id="1689935">i</span>&nbsp;<span class="op" id="1689937">&gt;=</span>&nbsp;<span class="num" id="1689940">0</span><span class="op" id="1689941">;</span>&nbsp;<span class="ident" id="1689943">i</span><span class="op" id="1689944">--</span>&nbsp;<span class="op" id="1689947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689951">c</span>&nbsp;<span class="op" id="1689953">:=</span>&nbsp;<span class="ident" id="1689956">lockorder</span><span class="op" id="1689965">[</span><span class="ident" id="1689966">i</span><span class="op" id="1689967">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689971">lockorder</span><span class="op" id="1689980">[</span><span class="ident" id="1689981">i</span><span class="op" id="1689982">]</span>&nbsp;<span class="op" id="1689984">=</span>&nbsp;<span class="ident" id="1689986">lockorder</span><span class="op" id="1689995">[</span><span class="num" id="1689996">0</span><span class="op" id="1689997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690001">j</span>&nbsp;<span class="op" id="1690003">:=</span>&nbsp;<span class="num" id="1690006">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690010">for</span>&nbsp;<span class="op" id="1690014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690019">k</span>&nbsp;<span class="op" id="1690021">:=</span>&nbsp;<span class="ident" id="1690024">j</span><span class="op" id="1690025">*</span><span class="num" id="1690026">2</span>&nbsp;<span class="op" id="1690028">+</span>&nbsp;<span class="num" id="1690030">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690035">if</span>&nbsp;<span class="ident" id="1690038">k</span>&nbsp;<span class="op" id="1690040">&gt;=</span>&nbsp;<span class="ident" id="1690043">i</span>&nbsp;<span class="op" id="1690045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690051">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690060">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690065">if</span>&nbsp;<span class="ident" id="1690068">k</span><span class="op" id="1690069">+</span><span class="num" id="1690070">1</span>&nbsp;<span class="op" id="1690072">&lt;</span>&nbsp;<span class="ident" id="1690074">i</span>&nbsp;<span class="op" id="1690076">&amp;&amp;</span>&nbsp;<span class="ident" id="1690079">lockorder</span><span class="op" id="1690088">[</span><span class="ident" id="1690089">k</span><span class="op" id="1690090">]</span><span class="op" id="1690091">.</span><span class="ident" id="1690092">sortkey</span><span class="op" id="1690099">(</span><span class="op" id="1690100">)</span>&nbsp;<span class="op" id="1690102">&lt;</span>&nbsp;<span class="ident" id="1690104">lockorder</span><span class="op" id="1690113">[</span><span class="ident" id="1690114">k</span><span class="op" id="1690115">+</span><span class="num" id="1690116">1</span><span class="op" id="1690117">]</span><span class="op" id="1690118">.</span><span class="ident" id="1690119">sortkey</span><span class="op" id="1690126">(</span><span class="op" id="1690127">)</span>&nbsp;<span class="op" id="1690129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690135">k</span><span class="op" id="1690136">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690147">if</span>&nbsp;<span class="ident" id="1690150">c</span><span class="op" id="1690151">.</span><span class="ident" id="1690152">sortkey</span><span class="op" id="1690159">(</span><span class="op" id="1690160">)</span>&nbsp;<span class="op" id="1690162">&lt;</span>&nbsp;<span class="ident" id="1690164">lockorder</span><span class="op" id="1690173">[</span><span class="ident" id="1690174">k</span><span class="op" id="1690175">]</span><span class="op" id="1690176">.</span><span class="ident" id="1690177">sortkey</span><span class="op" id="1690184">(</span><span class="op" id="1690185">)</span>&nbsp;<span class="op" id="1690187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690193">lockorder</span><span class="op" id="1690202">[</span><span class="ident" id="1690203">j</span><span class="op" id="1690204">]</span>&nbsp;<span class="op" id="1690206">=</span>&nbsp;<span class="ident" id="1690208">lockorder</span><span class="op" id="1690217">[</span><span class="ident" id="1690218">k</span><span class="op" id="1690219">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690225">j</span>&nbsp;<span class="op" id="1690227">=</span>&nbsp;<span class="ident" id="1690229">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690235">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690252">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690260">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690264">lockorder</span><span class="op" id="1690273">[</span><span class="ident" id="1690274">j</span><span class="op" id="1690275">]</span>&nbsp;<span class="op" id="1690277">=</span>&nbsp;<span class="ident" id="1690279">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690285">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690507">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690556">sellock</span><span class="op" id="1690563">(</span><span class="ident" id="1690564">sel</span><span class="op" id="1690567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690571">var</span>&nbsp;<span class="op" id="1690575">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690579">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690586">*</span><span class="ident" id="1690587">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690591">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1690598">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690607">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690614">*</span><span class="ident" id="1690615">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690623">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690630">*</span><span class="ident" id="1690631">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690639">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690646">*</span><span class="ident" id="1690647">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690655">sglist</span>&nbsp;<span class="op" id="1690662">*</span><span class="ident" id="1690663">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690671">sgnext</span>&nbsp;<span class="op" id="1690678">*</span><span class="ident" id="1690679">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690686">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1690689">loop</span><span class="op" id="1690693">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690696">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690744">var</span>&nbsp;<span class="ident" id="1690748">dfl</span>&nbsp;<span class="op" id="1690752">*</span><span class="ident" id="1690753">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690760">var</span>&nbsp;<span class="ident" id="1690764">cas</span>&nbsp;<span class="op" id="1690768">*</span><span class="ident" id="1690769">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690776">for</span>&nbsp;<span class="ident" id="1690780">i</span>&nbsp;<span class="op" id="1690782">:=</span>&nbsp;<span class="num" id="1690785">0</span><span class="op" id="1690786">;</span>&nbsp;<span class="ident" id="1690788">i</span>&nbsp;<span class="op" id="1690790">&lt;</span>&nbsp;<span class="builtintype" id="1690792">int</span><span class="op" id="1690795">(</span><span class="ident" id="1690796">sel</span><span class="op" id="1690799">.</span><span class="ident" id="1690800">ncase</span><span class="op" id="1690805">)</span><span class="op" id="1690806">;</span>&nbsp;<span class="ident" id="1690808">i</span><span class="op" id="1690809">++</span>&nbsp;<span class="op" id="1690812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690816">cas</span>&nbsp;<span class="op" id="1690820">=</span>&nbsp;<span class="op" id="1690822">&amp;</span><span class="ident" id="1690823">scases</span><span class="op" id="1690829">[</span><span class="ident" id="1690830">pollorder</span><span class="op" id="1690839">[</span><span class="ident" id="1690840">i</span><span class="op" id="1690841">]</span><span class="op" id="1690842">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690846">c</span>&nbsp;<span class="op" id="1690848">=</span>&nbsp;<span class="ident" id="1690850">cas</span><span class="op" id="1690853">.</span><span class="ident" id="1690854">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690863">switch</span>&nbsp;<span class="ident" id="1690870">cas</span><span class="op" id="1690873">.</span><span class="ident" id="1690874">kind</span>&nbsp;<span class="op" id="1690879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690883">case</span>&nbsp;<span class="ident" id="1690888">_CaseRecv</span><span class="op" id="1690897">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690902">if</span>&nbsp;<span class="ident" id="1690905">c</span><span class="op" id="1690906">.</span><span class="ident" id="1690907">dataqsiz</span>&nbsp;<span class="op" id="1690916">&gt;</span>&nbsp;<span class="num" id="1690918">0</span>&nbsp;<span class="op" id="1690920">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690926">if</span>&nbsp;<span class="ident" id="1690929">c</span><span class="op" id="1690930">.</span><span class="ident" id="1690931">qcount</span>&nbsp;<span class="op" id="1690938">&gt;</span>&nbsp;<span class="num" id="1690940">0</span>&nbsp;<span class="op" id="1690942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690949">goto</span>&nbsp;<span class="ident" id="1690954">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690973">}</span>&nbsp;<span class="keyword" id="1690975">else</span>&nbsp;<span class="op" id="1690980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690986">sg</span>&nbsp;<span class="op" id="1690989">=</span>&nbsp;<span class="ident" id="1690991">c</span><span class="op" id="1690992">.</span><span class="ident" id="1690993">sendq</span><span class="op" id="1690998">.</span><span class="ident" id="1690999">dequeue</span><span class="op" id="1691006">(</span><span class="op" id="1691007">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691013">if</span>&nbsp;<span class="ident" id="1691016">sg</span>&nbsp;<span class="op" id="1691019">!=</span>&nbsp;<span class="ident" id="1691022">nil</span>&nbsp;<span class="op" id="1691026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691033">goto</span>&nbsp;<span class="ident" id="1691038">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691061">if</span>&nbsp;<span class="ident" id="1691064">c</span><span class="op" id="1691065">.</span><span class="ident" id="1691066">closed</span>&nbsp;<span class="op" id="1691073">!=</span>&nbsp;<span class="num" id="1691076">0</span>&nbsp;<span class="op" id="1691078">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691084">goto</span>&nbsp;<span class="ident" id="1691089">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691104">case</span>&nbsp;<span class="ident" id="1691109">_CaseSend</span><span class="op" id="1691118">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691123">if</span>&nbsp;<span class="ident" id="1691126">raceenabled</span>&nbsp;<span class="op" id="1691138">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691144">racereadpc</span><span class="op" id="1691154">(</span><span class="ident" id="1691155">unsafe</span><span class="op" id="1691161">.</span><span class="ident" id="1691162">Pointer</span><span class="op" id="1691169">(</span><span class="ident" id="1691170">c</span><span class="op" id="1691171">)</span><span class="op" id="1691172">,</span>&nbsp;<span class="ident" id="1691174">cas</span><span class="op" id="1691177">.</span><span class="ident" id="1691178">pc</span><span class="op" id="1691180">,</span>&nbsp;<span class="ident" id="1691182">chansendpc</span><span class="op" id="1691192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691202">if</span>&nbsp;<span class="ident" id="1691205">c</span><span class="op" id="1691206">.</span><span class="ident" id="1691207">closed</span>&nbsp;<span class="op" id="1691214">!=</span>&nbsp;<span class="num" id="1691217">0</span>&nbsp;<span class="op" id="1691219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691225">goto</span>&nbsp;<span class="ident" id="1691230">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691240">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691245">if</span>&nbsp;<span class="ident" id="1691248">c</span><span class="op" id="1691249">.</span><span class="ident" id="1691250">dataqsiz</span>&nbsp;<span class="op" id="1691259">&gt;</span>&nbsp;<span class="num" id="1691261">0</span>&nbsp;<span class="op" id="1691263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691269">if</span>&nbsp;<span class="ident" id="1691272">c</span><span class="op" id="1691273">.</span><span class="ident" id="1691274">qcount</span>&nbsp;<span class="op" id="1691281">&lt;</span>&nbsp;<span class="ident" id="1691283">c</span><span class="op" id="1691284">.</span><span class="ident" id="1691285">dataqsiz</span>&nbsp;<span class="op" id="1691294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691301">goto</span>&nbsp;<span class="ident" id="1691306">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691325">}</span>&nbsp;<span class="keyword" id="1691327">else</span>&nbsp;<span class="op" id="1691332">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691338">sg</span>&nbsp;<span class="op" id="1691341">=</span>&nbsp;<span class="ident" id="1691343">c</span><span class="op" id="1691344">.</span><span class="ident" id="1691345">recvq</span><span class="op" id="1691350">.</span><span class="ident" id="1691351">dequeue</span><span class="op" id="1691358">(</span><span class="op" id="1691359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691365">if</span>&nbsp;<span class="ident" id="1691368">sg</span>&nbsp;<span class="op" id="1691371">!=</span>&nbsp;<span class="ident" id="1691374">nil</span>&nbsp;<span class="op" id="1691378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691385">goto</span>&nbsp;<span class="ident" id="1691390">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691408">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691413">case</span>&nbsp;<span class="ident" id="1691418">_CaseDefault</span><span class="op" id="1691430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691435">dfl</span>&nbsp;<span class="op" id="1691439">=</span>&nbsp;<span class="ident" id="1691441">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691450">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691454">if</span>&nbsp;<span class="ident" id="1691457">dfl</span>&nbsp;<span class="op" id="1691461">!=</span>&nbsp;<span class="ident" id="1691464">nil</span>&nbsp;<span class="op" id="1691468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691472">selunlock</span><span class="op" id="1691481">(</span><span class="ident" id="1691482">sel</span><span class="op" id="1691485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691489">cas</span>&nbsp;<span class="op" id="1691493">=</span>&nbsp;<span class="ident" id="1691495">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691501">goto</span>&nbsp;<span class="ident" id="1691506">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691516">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691550">gp</span>&nbsp;<span class="op" id="1691553">=</span>&nbsp;<span class="ident" id="1691555">getg</span><span class="op" id="1691559">(</span><span class="op" id="1691560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691563">done</span>&nbsp;<span class="op" id="1691568">=</span>&nbsp;<span class="num" id="1691570">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691573">for</span>&nbsp;<span class="ident" id="1691577">i</span>&nbsp;<span class="op" id="1691579">:=</span>&nbsp;<span class="num" id="1691582">0</span><span class="op" id="1691583">;</span>&nbsp;<span class="ident" id="1691585">i</span>&nbsp;<span class="op" id="1691587">&lt;</span>&nbsp;<span class="builtintype" id="1691589">int</span><span class="op" id="1691592">(</span><span class="ident" id="1691593">sel</span><span class="op" id="1691596">.</span><span class="ident" id="1691597">ncase</span><span class="op" id="1691602">)</span><span class="op" id="1691603">;</span>&nbsp;<span class="ident" id="1691605">i</span><span class="op" id="1691606">++</span>&nbsp;<span class="op" id="1691609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691613">cas</span>&nbsp;<span class="op" id="1691617">=</span>&nbsp;<span class="op" id="1691619">&amp;</span><span class="ident" id="1691620">scases</span><span class="op" id="1691626">[</span><span class="ident" id="1691627">pollorder</span><span class="op" id="1691636">[</span><span class="ident" id="1691637">i</span><span class="op" id="1691638">]</span><span class="op" id="1691639">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691643">c</span>&nbsp;<span class="op" id="1691645">=</span>&nbsp;<span class="ident" id="1691647">cas</span><span class="op" id="1691650">.</span><span class="ident" id="1691651">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691659">sg</span>&nbsp;<span class="op" id="1691662">:=</span>&nbsp;<span class="ident" id="1691665">acquireSudog</span><span class="op" id="1691677">(</span><span class="op" id="1691678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691682">sg</span><span class="op" id="1691684">.</span><span class="ident" id="1691685">g</span>&nbsp;<span class="op" id="1691687">=</span>&nbsp;<span class="ident" id="1691689">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1691694">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691769">sg</span><span class="op" id="1691771">.</span><span class="ident" id="1691772">selectdone</span>&nbsp;<span class="op" id="1691783">=</span>&nbsp;<span class="op" id="1691785">(</span><span class="op" id="1691786">*</span><span class="builtintype" id="1691787">uint32</span><span class="op" id="1691793">)</span><span class="op" id="1691794">(</span><span class="ident" id="1691795">noescape</span><span class="op" id="1691803">(</span><span class="ident" id="1691804">unsafe</span><span class="op" id="1691810">.</span><span class="ident" id="1691811">Pointer</span><span class="op" id="1691818">(</span><span class="op" id="1691819">&amp;</span><span class="ident" id="1691820">done</span><span class="op" id="1691824">)</span><span class="op" id="1691825">)</span><span class="op" id="1691826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691830">sg</span><span class="op" id="1691832">.</span><span class="ident" id="1691833">elem</span>&nbsp;<span class="op" id="1691838">=</span>&nbsp;<span class="ident" id="1691840">cas</span><span class="op" id="1691843">.</span><span class="ident" id="1691844">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691851">sg</span><span class="op" id="1691853">.</span><span class="ident" id="1691854">releasetime</span>&nbsp;<span class="op" id="1691866">=</span>&nbsp;<span class="num" id="1691868">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691872">if</span>&nbsp;<span class="ident" id="1691875">t0</span>&nbsp;<span class="op" id="1691878">!=</span>&nbsp;<span class="num" id="1691881">0</span>&nbsp;<span class="op" id="1691883">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691888">sg</span><span class="op" id="1691890">.</span><span class="ident" id="1691891">releasetime</span>&nbsp;<span class="op" id="1691903">=</span>&nbsp;<span class="op" id="1691905">-</span><span class="num" id="1691906">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691914">sg</span><span class="op" id="1691916">.</span><span class="ident" id="1691917">waitlink</span>&nbsp;<span class="op" id="1691926">=</span>&nbsp;<span class="ident" id="1691928">gp</span><span class="op" id="1691930">.</span><span class="ident" id="1691931">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691941">gp</span><span class="op" id="1691943">.</span><span class="ident" id="1691944">waiting</span>&nbsp;<span class="op" id="1691952">=</span>&nbsp;<span class="ident" id="1691954">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691960">switch</span>&nbsp;<span class="ident" id="1691967">cas</span><span class="op" id="1691970">.</span><span class="ident" id="1691971">kind</span>&nbsp;<span class="op" id="1691976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691980">case</span>&nbsp;<span class="ident" id="1691985">_CaseRecv</span><span class="op" id="1691994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691999">c</span><span class="op" id="1692000">.</span><span class="ident" id="1692001">recvq</span><span class="op" id="1692006">.</span><span class="ident" id="1692007">enqueue</span><span class="op" id="1692014">(</span><span class="ident" id="1692015">sg</span><span class="op" id="1692017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692022">case</span>&nbsp;<span class="ident" id="1692027">_CaseSend</span><span class="op" id="1692036">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692041">c</span><span class="op" id="1692042">.</span><span class="ident" id="1692043">sendq</span><span class="op" id="1692048">.</span><span class="ident" id="1692049">enqueue</span><span class="op" id="1692056">(</span><span class="ident" id="1692057">sg</span><span class="op" id="1692059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692070">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692105">gp</span><span class="op" id="1692107">.</span><span class="ident" id="1692108">param</span>&nbsp;<span class="op" id="1692114">=</span>&nbsp;<span class="ident" id="1692116">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692121">gopark</span><span class="op" id="1692127">(</span><span class="ident" id="1692128">unsafe</span><span class="op" id="1692134">.</span><span class="ident" id="1692135">Pointer</span><span class="op" id="1692142">(</span><span class="ident" id="1692143">funcPC</span><span class="op" id="1692149">(</span><span class="ident" id="1692150">selparkcommit</span><span class="op" id="1692163">)</span><span class="op" id="1692164">)</span><span class="op" id="1692165">,</span>&nbsp;<span class="ident" id="1692167">unsafe</span><span class="op" id="1692173">.</span><span class="ident" id="1692174">Pointer</span><span class="op" id="1692181">(</span><span class="ident" id="1692182">sel</span><span class="op" id="1692185">)</span><span class="op" id="1692186">,</span>&nbsp;<span class="string" id="1692188">&#34;select&#34;</span><span class="op" id="1692196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692200">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692223">sellock</span><span class="op" id="1692230">(</span><span class="ident" id="1692231">sel</span><span class="op" id="1692234">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692237">sg</span>&nbsp;<span class="op" id="1692240">=</span>&nbsp;<span class="op" id="1692242">(</span><span class="op" id="1692243">*</span><span class="ident" id="1692244">sudog</span><span class="op" id="1692249">)</span><span class="op" id="1692250">(</span><span class="ident" id="1692251">gp</span><span class="op" id="1692253">.</span><span class="ident" id="1692254">param</span><span class="op" id="1692259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692262">gp</span><span class="op" id="1692264">.</span><span class="ident" id="1692265">param</span>&nbsp;<span class="op" id="1692271">=</span>&nbsp;<span class="ident" id="1692273">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692279">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692324">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692370">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692410">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692468">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692533">cas</span>&nbsp;<span class="op" id="1692537">=</span>&nbsp;<span class="ident" id="1692539">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692544">sglist</span>&nbsp;<span class="op" id="1692551">=</span>&nbsp;<span class="ident" id="1692553">gp</span><span class="op" id="1692555">.</span><span class="ident" id="1692556">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692565">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692633">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692702">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692780">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692855">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692921">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692944">for</span>&nbsp;<span class="ident" id="1692948">sg1</span>&nbsp;<span class="op" id="1692952">:=</span>&nbsp;<span class="ident" id="1692955">gp</span><span class="op" id="1692957">.</span><span class="ident" id="1692958">waiting</span><span class="op" id="1692965">;</span>&nbsp;<span class="ident" id="1692967">sg1</span>&nbsp;<span class="op" id="1692971">!=</span>&nbsp;<span class="ident" id="1692974">nil</span><span class="op" id="1692977">;</span>&nbsp;<span class="ident" id="1692979">sg1</span>&nbsp;<span class="op" id="1692983">=</span>&nbsp;<span class="ident" id="1692985">sg1</span><span class="op" id="1692988">.</span><span class="ident" id="1692989">waitlink</span>&nbsp;<span class="op" id="1692998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693002">sg1</span><span class="op" id="1693005">.</span><span class="ident" id="1693006">selectdone</span>&nbsp;<span class="op" id="1693017">=</span>&nbsp;<span class="ident" id="1693019">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693025">sg1</span><span class="op" id="1693028">.</span><span class="ident" id="1693029">elem</span>&nbsp;<span class="op" id="1693034">=</span>&nbsp;<span class="ident" id="1693036">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693041">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693044">gp</span><span class="op" id="1693046">.</span><span class="ident" id="1693047">waiting</span>&nbsp;<span class="op" id="1693055">=</span>&nbsp;<span class="ident" id="1693057">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693062">for</span>&nbsp;<span class="ident" id="1693066">i</span>&nbsp;<span class="op" id="1693068">:=</span>&nbsp;<span class="builtintype" id="1693071">int</span><span class="op" id="1693074">(</span><span class="ident" id="1693075">sel</span><span class="op" id="1693078">.</span><span class="ident" id="1693079">ncase</span><span class="op" id="1693084">)</span>&nbsp;<span class="op" id="1693086">-</span>&nbsp;<span class="num" id="1693088">1</span><span class="op" id="1693089">;</span>&nbsp;<span class="ident" id="1693091">i</span>&nbsp;<span class="op" id="1693093">&gt;=</span>&nbsp;<span class="num" id="1693096">0</span><span class="op" id="1693097">;</span>&nbsp;<span class="ident" id="1693099">i</span><span class="op" id="1693100">--</span>&nbsp;<span class="op" id="1693103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693107">k</span>&nbsp;<span class="op" id="1693109">=</span>&nbsp;<span class="op" id="1693111">&amp;</span><span class="ident" id="1693112">scases</span><span class="op" id="1693118">[</span><span class="ident" id="1693119">pollorder</span><span class="op" id="1693128">[</span><span class="ident" id="1693129">i</span><span class="op" id="1693130">]</span><span class="op" id="1693131">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693135">if</span>&nbsp;<span class="ident" id="1693138">sglist</span><span class="op" id="1693144">.</span><span class="ident" id="1693145">releasetime</span>&nbsp;<span class="op" id="1693157">&gt;</span>&nbsp;<span class="num" id="1693159">0</span>&nbsp;<span class="op" id="1693161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693166">k</span><span class="op" id="1693167">.</span><span class="ident" id="1693168">releasetime</span>&nbsp;<span class="op" id="1693180">=</span>&nbsp;<span class="ident" id="1693182">sglist</span><span class="op" id="1693188">.</span><span class="ident" id="1693189">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693207">if</span>&nbsp;<span class="ident" id="1693210">sg</span>&nbsp;<span class="op" id="1693213">==</span>&nbsp;<span class="ident" id="1693216">sglist</span>&nbsp;<span class="op" id="1693223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693228">cas</span>&nbsp;<span class="op" id="1693232">=</span>&nbsp;<span class="ident" id="1693234">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693238">}</span>&nbsp;<span class="keyword" id="1693240">else</span>&nbsp;<span class="op" id="1693245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693250">c</span>&nbsp;<span class="op" id="1693252">=</span>&nbsp;<span class="ident" id="1693254">k</span><span class="op" id="1693255">.</span><span class="ident" id="1693256">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693265">if</span>&nbsp;<span class="ident" id="1693268">k</span><span class="op" id="1693269">.</span><span class="ident" id="1693270">kind</span>&nbsp;<span class="op" id="1693275">==</span>&nbsp;<span class="ident" id="1693278">_CaseSend</span>&nbsp;<span class="op" id="1693288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693294">c</span><span class="op" id="1693295">.</span><span class="ident" id="1693296">sendq</span><span class="op" id="1693301">.</span><span class="ident" id="1693302">dequeueSudoG</span><span class="op" id="1693314">(</span><span class="ident" id="1693315">sglist</span><span class="op" id="1693321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693326">}</span>&nbsp;<span class="keyword" id="1693328">else</span>&nbsp;<span class="op" id="1693333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693339">c</span><span class="op" id="1693340">.</span><span class="ident" id="1693341">recvq</span><span class="op" id="1693346">.</span><span class="ident" id="1693347">dequeueSudoG</span><span class="op" id="1693359">(</span><span class="ident" id="1693360">sglist</span><span class="op" id="1693366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693371">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693379">sgnext</span>&nbsp;<span class="op" id="1693386">=</span>&nbsp;<span class="ident" id="1693388">sglist</span><span class="op" id="1693394">.</span><span class="ident" id="1693395">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693406">sglist</span><span class="op" id="1693412">.</span><span class="ident" id="1693413">waitlink</span>&nbsp;<span class="op" id="1693422">=</span>&nbsp;<span class="ident" id="1693424">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693430">releaseSudog</span><span class="op" id="1693442">(</span><span class="ident" id="1693443">sglist</span><span class="op" id="1693449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693453">sglist</span>&nbsp;<span class="op" id="1693460">=</span>&nbsp;<span class="ident" id="1693462">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693474">if</span>&nbsp;<span class="ident" id="1693477">cas</span>&nbsp;<span class="op" id="1693481">==</span>&nbsp;<span class="ident" id="1693484">nil</span>&nbsp;<span class="op" id="1693488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693492">goto</span>&nbsp;<span class="ident" id="1693497">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693503">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693507">c</span>&nbsp;<span class="op" id="1693509">=</span>&nbsp;<span class="ident" id="1693511">cas</span><span class="op" id="1693514">.</span><span class="ident" id="1693515">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693523">if</span>&nbsp;<span class="ident" id="1693526">c</span><span class="op" id="1693527">.</span><span class="ident" id="1693528">dataqsiz</span>&nbsp;<span class="op" id="1693537">&gt;</span>&nbsp;<span class="num" id="1693539">0</span>&nbsp;<span class="op" id="1693541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693545">gothrow</span><span class="op" id="1693552">(</span><span class="string" id="1693553">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1693581">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693588">if</span>&nbsp;<span class="ident" id="1693591">debugSelect</span>&nbsp;<span class="op" id="1693603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1693607">print</span><span class="op" id="1693612">(</span><span class="string" id="1693613">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1693632">,</span>&nbsp;<span class="ident" id="1693634">sel</span><span class="op" id="1693637">,</span>&nbsp;<span class="string" id="1693639">&#34;&nbsp;c=&#34;</span><span class="op" id="1693644">,</span>&nbsp;<span class="ident" id="1693646">c</span><span class="op" id="1693647">,</span>&nbsp;<span class="string" id="1693649">&#34;&nbsp;cas=&#34;</span><span class="op" id="1693656">,</span>&nbsp;<span class="ident" id="1693658">cas</span><span class="op" id="1693661">,</span>&nbsp;<span class="string" id="1693663">&#34;&nbsp;kind=&#34;</span><span class="op" id="1693671">,</span>&nbsp;<span class="ident" id="1693673">cas</span><span class="op" id="1693676">.</span><span class="ident" id="1693677">kind</span><span class="op" id="1693681">,</span>&nbsp;<span class="string" id="1693683">&#34;\n&#34;</span><span class="op" id="1693687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693690">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693694">if</span>&nbsp;<span class="ident" id="1693697">cas</span><span class="op" id="1693700">.</span><span class="ident" id="1693701">kind</span>&nbsp;<span class="op" id="1693706">==</span>&nbsp;<span class="ident" id="1693709">_CaseRecv</span>&nbsp;<span class="op" id="1693719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693723">if</span>&nbsp;<span class="ident" id="1693726">cas</span><span class="op" id="1693729">.</span><span class="ident" id="1693730">receivedp</span>&nbsp;<span class="op" id="1693740">!=</span>&nbsp;<span class="ident" id="1693743">nil</span>&nbsp;<span class="op" id="1693747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693752">*</span><span class="ident" id="1693753">cas</span><span class="op" id="1693756">.</span><span class="ident" id="1693757">receivedp</span>&nbsp;<span class="op" id="1693767">=</span>&nbsp;<span class="builtintype" id="1693769">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693776">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693783">if</span>&nbsp;<span class="ident" id="1693786">raceenabled</span>&nbsp;<span class="op" id="1693798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693802">if</span>&nbsp;<span class="ident" id="1693805">cas</span><span class="op" id="1693808">.</span><span class="ident" id="1693809">kind</span>&nbsp;<span class="op" id="1693814">==</span>&nbsp;<span class="ident" id="1693817">_CaseRecv</span>&nbsp;<span class="op" id="1693827">&amp;&amp;</span>&nbsp;<span class="ident" id="1693830">cas</span><span class="op" id="1693833">.</span><span class="ident" id="1693834">elem</span>&nbsp;<span class="op" id="1693839">!=</span>&nbsp;<span class="ident" id="1693842">nil</span>&nbsp;<span class="op" id="1693846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693851">raceWriteObjectPC</span><span class="op" id="1693868">(</span><span class="ident" id="1693869">c</span><span class="op" id="1693870">.</span><span class="ident" id="1693871">elemtype</span><span class="op" id="1693879">,</span>&nbsp;<span class="ident" id="1693881">cas</span><span class="op" id="1693884">.</span><span class="ident" id="1693885">elem</span><span class="op" id="1693889">,</span>&nbsp;<span class="ident" id="1693891">cas</span><span class="op" id="1693894">.</span><span class="ident" id="1693895">pc</span><span class="op" id="1693897">,</span>&nbsp;<span class="ident" id="1693899">chanrecvpc</span><span class="op" id="1693909">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693913">}</span>&nbsp;<span class="keyword" id="1693915">else</span>&nbsp;<span class="keyword" id="1693920">if</span>&nbsp;<span class="ident" id="1693923">cas</span><span class="op" id="1693926">.</span><span class="ident" id="1693927">kind</span>&nbsp;<span class="op" id="1693932">==</span>&nbsp;<span class="ident" id="1693935">_CaseSend</span>&nbsp;<span class="op" id="1693945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693950">raceReadObjectPC</span><span class="op" id="1693966">(</span><span class="ident" id="1693967">c</span><span class="op" id="1693968">.</span><span class="ident" id="1693969">elemtype</span><span class="op" id="1693977">,</span>&nbsp;<span class="ident" id="1693979">cas</span><span class="op" id="1693982">.</span><span class="ident" id="1693983">elem</span><span class="op" id="1693987">,</span>&nbsp;<span class="ident" id="1693989">cas</span><span class="op" id="1693992">.</span><span class="ident" id="1693993">pc</span><span class="op" id="1693995">,</span>&nbsp;<span class="ident" id="1693997">chansendpc</span><span class="op" id="1694007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694018">selunlock</span><span class="op" id="1694027">(</span><span class="ident" id="1694028">sel</span><span class="op" id="1694031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694034">goto</span>&nbsp;<span class="ident" id="1694039">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1694045">asyncrecv</span><span class="op" id="1694054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1694057">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694085">if</span>&nbsp;<span class="ident" id="1694088">raceenabled</span>&nbsp;<span class="op" id="1694100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694104">if</span>&nbsp;<span class="ident" id="1694107">cas</span><span class="op" id="1694110">.</span><span class="ident" id="1694111">elem</span>&nbsp;<span class="op" id="1694116">!=</span>&nbsp;<span class="ident" id="1694119">nil</span>&nbsp;<span class="op" id="1694123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694128">raceWriteObjectPC</span><span class="op" id="1694145">(</span><span class="ident" id="1694146">c</span><span class="op" id="1694147">.</span><span class="ident" id="1694148">elemtype</span><span class="op" id="1694156">,</span>&nbsp;<span class="ident" id="1694158">cas</span><span class="op" id="1694161">.</span><span class="ident" id="1694162">elem</span><span class="op" id="1694166">,</span>&nbsp;<span class="ident" id="1694168">cas</span><span class="op" id="1694171">.</span><span class="ident" id="1694172">pc</span><span class="op" id="1694174">,</span>&nbsp;<span class="ident" id="1694176">chanrecvpc</span><span class="op" id="1694186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694194">raceacquire</span><span class="op" id="1694205">(</span><span class="ident" id="1694206">chanbuf</span><span class="op" id="1694213">(</span><span class="ident" id="1694214">c</span><span class="op" id="1694215">,</span>&nbsp;<span class="ident" id="1694217">c</span><span class="op" id="1694218">.</span><span class="ident" id="1694219">recvx</span><span class="op" id="1694224">)</span><span class="op" id="1694225">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694229">racerelease</span><span class="op" id="1694240">(</span><span class="ident" id="1694241">chanbuf</span><span class="op" id="1694248">(</span><span class="ident" id="1694249">c</span><span class="op" id="1694250">,</span>&nbsp;<span class="ident" id="1694252">c</span><span class="op" id="1694253">.</span><span class="ident" id="1694254">recvx</span><span class="op" id="1694259">)</span><span class="op" id="1694260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694266">if</span>&nbsp;<span class="ident" id="1694269">cas</span><span class="op" id="1694272">.</span><span class="ident" id="1694273">receivedp</span>&nbsp;<span class="op" id="1694283">!=</span>&nbsp;<span class="ident" id="1694286">nil</span>&nbsp;<span class="op" id="1694290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694294">*</span><span class="ident" id="1694295">cas</span><span class="op" id="1694298">.</span><span class="ident" id="1694299">receivedp</span>&nbsp;<span class="op" id="1694309">=</span>&nbsp;<span class="builtintype" id="1694311">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694317">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694320">if</span>&nbsp;<span class="ident" id="1694323">cas</span><span class="op" id="1694326">.</span><span class="ident" id="1694327">elem</span>&nbsp;<span class="op" id="1694332">!=</span>&nbsp;<span class="ident" id="1694335">nil</span>&nbsp;<span class="op" id="1694339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694343">memmove</span><span class="op" id="1694350">(</span><span class="ident" id="1694351">cas</span><span class="op" id="1694354">.</span><span class="ident" id="1694355">elem</span><span class="op" id="1694359">,</span>&nbsp;<span class="ident" id="1694361">chanbuf</span><span class="op" id="1694368">(</span><span class="ident" id="1694369">c</span><span class="op" id="1694370">,</span>&nbsp;<span class="ident" id="1694372">c</span><span class="op" id="1694373">.</span><span class="ident" id="1694374">recvx</span><span class="op" id="1694379">)</span><span class="op" id="1694380">,</span>&nbsp;<span class="builtintype" id="1694382">uintptr</span><span class="op" id="1694389">(</span><span class="ident" id="1694390">c</span><span class="op" id="1694391">.</span><span class="ident" id="1694392">elemsize</span><span class="op" id="1694400">)</span><span class="op" id="1694401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694407">memclr</span><span class="op" id="1694413">(</span><span class="ident" id="1694414">chanbuf</span><span class="op" id="1694421">(</span><span class="ident" id="1694422">c</span><span class="op" id="1694423">,</span>&nbsp;<span class="ident" id="1694425">c</span><span class="op" id="1694426">.</span><span class="ident" id="1694427">recvx</span><span class="op" id="1694432">)</span><span class="op" id="1694433">,</span>&nbsp;<span class="builtintype" id="1694435">uintptr</span><span class="op" id="1694442">(</span><span class="ident" id="1694443">c</span><span class="op" id="1694444">.</span><span class="ident" id="1694445">elemsize</span><span class="op" id="1694453">)</span><span class="op" id="1694454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694457">c</span><span class="op" id="1694458">.</span><span class="ident" id="1694459">recvx</span><span class="op" id="1694464">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694468">if</span>&nbsp;<span class="ident" id="1694471">c</span><span class="op" id="1694472">.</span><span class="ident" id="1694473">recvx</span>&nbsp;<span class="op" id="1694479">==</span>&nbsp;<span class="ident" id="1694482">c</span><span class="op" id="1694483">.</span><span class="ident" id="1694484">dataqsiz</span>&nbsp;<span class="op" id="1694493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694497">c</span><span class="op" id="1694498">.</span><span class="ident" id="1694499">recvx</span>&nbsp;<span class="op" id="1694505">=</span>&nbsp;<span class="num" id="1694507">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694513">c</span><span class="op" id="1694514">.</span><span class="ident" id="1694515">qcount</span><span class="op" id="1694521">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694525">sg</span>&nbsp;<span class="op" id="1694528">=</span>&nbsp;<span class="ident" id="1694530">c</span><span class="op" id="1694531">.</span><span class="ident" id="1694532">sendq</span><span class="op" id="1694537">.</span><span class="ident" id="1694538">dequeue</span><span class="op" id="1694545">(</span><span class="op" id="1694546">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694549">if</span>&nbsp;<span class="ident" id="1694552">sg</span>&nbsp;<span class="op" id="1694555">!=</span>&nbsp;<span class="ident" id="1694558">nil</span>&nbsp;<span class="op" id="1694562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694566">gp</span>&nbsp;<span class="op" id="1694569">=</span>&nbsp;<span class="ident" id="1694571">sg</span><span class="op" id="1694573">.</span><span class="ident" id="1694574">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694578">selunlock</span><span class="op" id="1694587">(</span><span class="ident" id="1694588">sel</span><span class="op" id="1694591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694595">if</span>&nbsp;<span class="ident" id="1694598">sg</span><span class="op" id="1694600">.</span><span class="ident" id="1694601">releasetime</span>&nbsp;<span class="op" id="1694613">!=</span>&nbsp;<span class="num" id="1694616">0</span>&nbsp;<span class="op" id="1694618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694623">sg</span><span class="op" id="1694625">.</span><span class="ident" id="1694626">releasetime</span>&nbsp;<span class="op" id="1694638">=</span>&nbsp;<span class="ident" id="1694640">cputicks</span><span class="op" id="1694648">(</span><span class="op" id="1694649">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694657">goready</span><span class="op" id="1694664">(</span><span class="ident" id="1694665">gp</span><span class="op" id="1694667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694670">}</span>&nbsp;<span class="keyword" id="1694672">else</span>&nbsp;<span class="op" id="1694677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694681">selunlock</span><span class="op" id="1694690">(</span><span class="ident" id="1694691">sel</span><span class="op" id="1694694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694697">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694700">goto</span>&nbsp;<span class="ident" id="1694705">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1694711">asyncsend</span><span class="op" id="1694720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1694723">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694746">if</span>&nbsp;<span class="ident" id="1694749">raceenabled</span>&nbsp;<span class="op" id="1694761">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694765">raceacquire</span><span class="op" id="1694776">(</span><span class="ident" id="1694777">chanbuf</span><span class="op" id="1694784">(</span><span class="ident" id="1694785">c</span><span class="op" id="1694786">,</span>&nbsp;<span class="ident" id="1694788">c</span><span class="op" id="1694789">.</span><span class="ident" id="1694790">sendx</span><span class="op" id="1694795">)</span><span class="op" id="1694796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694800">racerelease</span><span class="op" id="1694811">(</span><span class="ident" id="1694812">chanbuf</span><span class="op" id="1694819">(</span><span class="ident" id="1694820">c</span><span class="op" id="1694821">,</span>&nbsp;<span class="ident" id="1694823">c</span><span class="op" id="1694824">.</span><span class="ident" id="1694825">sendx</span><span class="op" id="1694830">)</span><span class="op" id="1694831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694835">raceReadObjectPC</span><span class="op" id="1694851">(</span><span class="ident" id="1694852">c</span><span class="op" id="1694853">.</span><span class="ident" id="1694854">elemtype</span><span class="op" id="1694862">,</span>&nbsp;<span class="ident" id="1694864">cas</span><span class="op" id="1694867">.</span><span class="ident" id="1694868">elem</span><span class="op" id="1694872">,</span>&nbsp;<span class="ident" id="1694874">cas</span><span class="op" id="1694877">.</span><span class="ident" id="1694878">pc</span><span class="op" id="1694880">,</span>&nbsp;<span class="ident" id="1694882">chansendpc</span><span class="op" id="1694892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694898">memmove</span><span class="op" id="1694905">(</span><span class="ident" id="1694906">chanbuf</span><span class="op" id="1694913">(</span><span class="ident" id="1694914">c</span><span class="op" id="1694915">,</span>&nbsp;<span class="ident" id="1694917">c</span><span class="op" id="1694918">.</span><span class="ident" id="1694919">sendx</span><span class="op" id="1694924">)</span><span class="op" id="1694925">,</span>&nbsp;<span class="ident" id="1694927">cas</span><span class="op" id="1694930">.</span><span class="ident" id="1694931">elem</span><span class="op" id="1694935">,</span>&nbsp;<span class="builtintype" id="1694937">uintptr</span><span class="op" id="1694944">(</span><span class="ident" id="1694945">c</span><span class="op" id="1694946">.</span><span class="ident" id="1694947">elemsize</span><span class="op" id="1694955">)</span><span class="op" id="1694956">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694959">c</span><span class="op" id="1694960">.</span><span class="ident" id="1694961">sendx</span><span class="op" id="1694966">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694970">if</span>&nbsp;<span class="ident" id="1694973">c</span><span class="op" id="1694974">.</span><span class="ident" id="1694975">sendx</span>&nbsp;<span class="op" id="1694981">==</span>&nbsp;<span class="ident" id="1694984">c</span><span class="op" id="1694985">.</span><span class="ident" id="1694986">dataqsiz</span>&nbsp;<span class="op" id="1694995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694999">c</span><span class="op" id="1695000">.</span><span class="ident" id="1695001">sendx</span>&nbsp;<span class="op" id="1695007">=</span>&nbsp;<span class="num" id="1695009">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695015">c</span><span class="op" id="1695016">.</span><span class="ident" id="1695017">qcount</span><span class="op" id="1695023">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695027">sg</span>&nbsp;<span class="op" id="1695030">=</span>&nbsp;<span class="ident" id="1695032">c</span><span class="op" id="1695033">.</span><span class="ident" id="1695034">recvq</span><span class="op" id="1695039">.</span><span class="ident" id="1695040">dequeue</span><span class="op" id="1695047">(</span><span class="op" id="1695048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695051">if</span>&nbsp;<span class="ident" id="1695054">sg</span>&nbsp;<span class="op" id="1695057">!=</span>&nbsp;<span class="ident" id="1695060">nil</span>&nbsp;<span class="op" id="1695064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695068">gp</span>&nbsp;<span class="op" id="1695071">=</span>&nbsp;<span class="ident" id="1695073">sg</span><span class="op" id="1695075">.</span><span class="ident" id="1695076">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695080">selunlock</span><span class="op" id="1695089">(</span><span class="ident" id="1695090">sel</span><span class="op" id="1695093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695097">if</span>&nbsp;<span class="ident" id="1695100">sg</span><span class="op" id="1695102">.</span><span class="ident" id="1695103">releasetime</span>&nbsp;<span class="op" id="1695115">!=</span>&nbsp;<span class="num" id="1695118">0</span>&nbsp;<span class="op" id="1695120">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695125">sg</span><span class="op" id="1695127">.</span><span class="ident" id="1695128">releasetime</span>&nbsp;<span class="op" id="1695140">=</span>&nbsp;<span class="ident" id="1695142">cputicks</span><span class="op" id="1695150">(</span><span class="op" id="1695151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695159">goready</span><span class="op" id="1695166">(</span><span class="ident" id="1695167">gp</span><span class="op" id="1695169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695172">}</span>&nbsp;<span class="keyword" id="1695174">else</span>&nbsp;<span class="op" id="1695179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695183">selunlock</span><span class="op" id="1695192">(</span><span class="ident" id="1695193">sel</span><span class="op" id="1695196">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695202">goto</span>&nbsp;<span class="ident" id="1695207">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1695213">syncrecv</span><span class="op" id="1695221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1695224">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695266">if</span>&nbsp;<span class="ident" id="1695269">raceenabled</span>&nbsp;<span class="op" id="1695281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695285">if</span>&nbsp;<span class="ident" id="1695288">cas</span><span class="op" id="1695291">.</span><span class="ident" id="1695292">elem</span>&nbsp;<span class="op" id="1695297">!=</span>&nbsp;<span class="ident" id="1695300">nil</span>&nbsp;<span class="op" id="1695304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695309">raceWriteObjectPC</span><span class="op" id="1695326">(</span><span class="ident" id="1695327">c</span><span class="op" id="1695328">.</span><span class="ident" id="1695329">elemtype</span><span class="op" id="1695337">,</span>&nbsp;<span class="ident" id="1695339">cas</span><span class="op" id="1695342">.</span><span class="ident" id="1695343">elem</span><span class="op" id="1695347">,</span>&nbsp;<span class="ident" id="1695349">cas</span><span class="op" id="1695352">.</span><span class="ident" id="1695353">pc</span><span class="op" id="1695355">,</span>&nbsp;<span class="ident" id="1695357">chanrecvpc</span><span class="op" id="1695367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695375">racesync</span><span class="op" id="1695383">(</span><span class="ident" id="1695384">c</span><span class="op" id="1695385">,</span>&nbsp;<span class="ident" id="1695387">sg</span><span class="op" id="1695389">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695395">selunlock</span><span class="op" id="1695404">(</span><span class="ident" id="1695405">sel</span><span class="op" id="1695408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695411">if</span>&nbsp;<span class="ident" id="1695414">debugSelect</span>&nbsp;<span class="op" id="1695426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1695430">print</span><span class="op" id="1695435">(</span><span class="string" id="1695436">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1695452">,</span>&nbsp;<span class="ident" id="1695454">sel</span><span class="op" id="1695457">,</span>&nbsp;<span class="string" id="1695459">&#34;&nbsp;c=&#34;</span><span class="op" id="1695464">,</span>&nbsp;<span class="ident" id="1695466">c</span><span class="op" id="1695467">,</span>&nbsp;<span class="string" id="1695469">&#34;\n&#34;</span><span class="op" id="1695473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695476">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695479">if</span>&nbsp;<span class="ident" id="1695482">cas</span><span class="op" id="1695485">.</span><span class="ident" id="1695486">receivedp</span>&nbsp;<span class="op" id="1695496">!=</span>&nbsp;<span class="ident" id="1695499">nil</span>&nbsp;<span class="op" id="1695503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695507">*</span><span class="ident" id="1695508">cas</span><span class="op" id="1695511">.</span><span class="ident" id="1695512">receivedp</span>&nbsp;<span class="op" id="1695522">=</span>&nbsp;<span class="builtintype" id="1695524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695533">if</span>&nbsp;<span class="ident" id="1695536">cas</span><span class="op" id="1695539">.</span><span class="ident" id="1695540">elem</span>&nbsp;<span class="op" id="1695545">!=</span>&nbsp;<span class="ident" id="1695548">nil</span>&nbsp;<span class="op" id="1695552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695556">memmove</span><span class="op" id="1695563">(</span><span class="ident" id="1695564">cas</span><span class="op" id="1695567">.</span><span class="ident" id="1695568">elem</span><span class="op" id="1695572">,</span>&nbsp;<span class="ident" id="1695574">sg</span><span class="op" id="1695576">.</span><span class="ident" id="1695577">elem</span><span class="op" id="1695581">,</span>&nbsp;<span class="builtintype" id="1695583">uintptr</span><span class="op" id="1695590">(</span><span class="ident" id="1695591">c</span><span class="op" id="1695592">.</span><span class="ident" id="1695593">elemsize</span><span class="op" id="1695601">)</span><span class="op" id="1695602">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695608">sg</span><span class="op" id="1695610">.</span><span class="ident" id="1695611">elem</span>&nbsp;<span class="op" id="1695616">=</span>&nbsp;<span class="ident" id="1695618">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695623">gp</span>&nbsp;<span class="op" id="1695626">=</span>&nbsp;<span class="ident" id="1695628">sg</span><span class="op" id="1695630">.</span><span class="ident" id="1695631">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695634">gp</span><span class="op" id="1695636">.</span><span class="ident" id="1695637">param</span>&nbsp;<span class="op" id="1695643">=</span>&nbsp;<span class="ident" id="1695645">unsafe</span><span class="op" id="1695651">.</span><span class="ident" id="1695652">Pointer</span><span class="op" id="1695659">(</span><span class="ident" id="1695660">sg</span><span class="op" id="1695662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695665">if</span>&nbsp;<span class="ident" id="1695668">sg</span><span class="op" id="1695670">.</span><span class="ident" id="1695671">releasetime</span>&nbsp;<span class="op" id="1695683">!=</span>&nbsp;<span class="num" id="1695686">0</span>&nbsp;<span class="op" id="1695688">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695692">sg</span><span class="op" id="1695694">.</span><span class="ident" id="1695695">releasetime</span>&nbsp;<span class="op" id="1695707">=</span>&nbsp;<span class="ident" id="1695709">cputicks</span><span class="op" id="1695717">(</span><span class="op" id="1695718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695724">goready</span><span class="op" id="1695731">(</span><span class="ident" id="1695732">gp</span><span class="op" id="1695734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695737">goto</span>&nbsp;<span class="ident" id="1695742">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1695748">rclose</span><span class="op" id="1695754">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1695757">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695791">selunlock</span><span class="op" id="1695800">(</span><span class="ident" id="1695801">sel</span><span class="op" id="1695804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695807">if</span>&nbsp;<span class="ident" id="1695810">cas</span><span class="op" id="1695813">.</span><span class="ident" id="1695814">receivedp</span>&nbsp;<span class="op" id="1695824">!=</span>&nbsp;<span class="ident" id="1695827">nil</span>&nbsp;<span class="op" id="1695831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695835">*</span><span class="ident" id="1695836">cas</span><span class="op" id="1695839">.</span><span class="ident" id="1695840">receivedp</span>&nbsp;<span class="op" id="1695850">=</span>&nbsp;<span class="builtintype" id="1695852">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695862">if</span>&nbsp;<span class="ident" id="1695865">cas</span><span class="op" id="1695868">.</span><span class="ident" id="1695869">elem</span>&nbsp;<span class="op" id="1695874">!=</span>&nbsp;<span class="ident" id="1695877">nil</span>&nbsp;<span class="op" id="1695881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695885">memclr</span><span class="op" id="1695891">(</span><span class="ident" id="1695892">cas</span><span class="op" id="1695895">.</span><span class="ident" id="1695896">elem</span><span class="op" id="1695900">,</span>&nbsp;<span class="builtintype" id="1695902">uintptr</span><span class="op" id="1695909">(</span><span class="ident" id="1695910">c</span><span class="op" id="1695911">.</span><span class="ident" id="1695912">elemsize</span><span class="op" id="1695920">)</span><span class="op" id="1695921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695927">if</span>&nbsp;<span class="ident" id="1695930">raceenabled</span>&nbsp;<span class="op" id="1695942">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695946">raceacquire</span><span class="op" id="1695957">(</span><span class="ident" id="1695958">unsafe</span><span class="op" id="1695964">.</span><span class="ident" id="1695965">Pointer</span><span class="op" id="1695972">(</span><span class="ident" id="1695973">c</span><span class="op" id="1695974">)</span><span class="op" id="1695975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695981">goto</span>&nbsp;<span class="ident" id="1695986">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1695992">syncsend</span><span class="op" id="1696000">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1696003">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696042">if</span>&nbsp;<span class="ident" id="1696045">raceenabled</span>&nbsp;<span class="op" id="1696057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696061">raceReadObjectPC</span><span class="op" id="1696077">(</span><span class="ident" id="1696078">c</span><span class="op" id="1696079">.</span><span class="ident" id="1696080">elemtype</span><span class="op" id="1696088">,</span>&nbsp;<span class="ident" id="1696090">cas</span><span class="op" id="1696093">.</span><span class="ident" id="1696094">elem</span><span class="op" id="1696098">,</span>&nbsp;<span class="ident" id="1696100">cas</span><span class="op" id="1696103">.</span><span class="ident" id="1696104">pc</span><span class="op" id="1696106">,</span>&nbsp;<span class="ident" id="1696108">chansendpc</span><span class="op" id="1696118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696122">racesync</span><span class="op" id="1696130">(</span><span class="ident" id="1696131">c</span><span class="op" id="1696132">,</span>&nbsp;<span class="ident" id="1696134">sg</span><span class="op" id="1696136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696139">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696142">selunlock</span><span class="op" id="1696151">(</span><span class="ident" id="1696152">sel</span><span class="op" id="1696155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696158">if</span>&nbsp;<span class="ident" id="1696161">debugSelect</span>&nbsp;<span class="op" id="1696173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1696177">print</span><span class="op" id="1696182">(</span><span class="string" id="1696183">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1696199">,</span>&nbsp;<span class="ident" id="1696201">sel</span><span class="op" id="1696204">,</span>&nbsp;<span class="string" id="1696206">&#34;&nbsp;c=&#34;</span><span class="op" id="1696211">,</span>&nbsp;<span class="ident" id="1696213">c</span><span class="op" id="1696214">,</span>&nbsp;<span class="string" id="1696216">&#34;\n&#34;</span><span class="op" id="1696220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696226">if</span>&nbsp;<span class="ident" id="1696229">sg</span><span class="op" id="1696231">.</span><span class="ident" id="1696232">elem</span>&nbsp;<span class="op" id="1696237">!=</span>&nbsp;<span class="ident" id="1696240">nil</span>&nbsp;<span class="op" id="1696244">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696248">memmove</span><span class="op" id="1696255">(</span><span class="ident" id="1696256">sg</span><span class="op" id="1696258">.</span><span class="ident" id="1696259">elem</span><span class="op" id="1696263">,</span>&nbsp;<span class="ident" id="1696265">cas</span><span class="op" id="1696268">.</span><span class="ident" id="1696269">elem</span><span class="op" id="1696273">,</span>&nbsp;<span class="builtintype" id="1696275">uintptr</span><span class="op" id="1696282">(</span><span class="ident" id="1696283">c</span><span class="op" id="1696284">.</span><span class="ident" id="1696285">elemsize</span><span class="op" id="1696293">)</span><span class="op" id="1696294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696300">sg</span><span class="op" id="1696302">.</span><span class="ident" id="1696303">elem</span>&nbsp;<span class="op" id="1696308">=</span>&nbsp;<span class="ident" id="1696310">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696315">gp</span>&nbsp;<span class="op" id="1696318">=</span>&nbsp;<span class="ident" id="1696320">sg</span><span class="op" id="1696322">.</span><span class="ident" id="1696323">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696326">gp</span><span class="op" id="1696328">.</span><span class="ident" id="1696329">param</span>&nbsp;<span class="op" id="1696335">=</span>&nbsp;<span class="ident" id="1696337">unsafe</span><span class="op" id="1696343">.</span><span class="ident" id="1696344">Pointer</span><span class="op" id="1696351">(</span><span class="ident" id="1696352">sg</span><span class="op" id="1696354">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696357">if</span>&nbsp;<span class="ident" id="1696360">sg</span><span class="op" id="1696362">.</span><span class="ident" id="1696363">releasetime</span>&nbsp;<span class="op" id="1696375">!=</span>&nbsp;<span class="num" id="1696378">0</span>&nbsp;<span class="op" id="1696380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696384">sg</span><span class="op" id="1696386">.</span><span class="ident" id="1696387">releasetime</span>&nbsp;<span class="op" id="1696399">=</span>&nbsp;<span class="ident" id="1696401">cputicks</span><span class="op" id="1696409">(</span><span class="op" id="1696410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696416">goready</span><span class="op" id="1696423">(</span><span class="ident" id="1696424">gp</span><span class="op" id="1696426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1696429">retc</span><span class="op" id="1696433">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696436">if</span>&nbsp;<span class="ident" id="1696439">cas</span><span class="op" id="1696442">.</span><span class="ident" id="1696443">releasetime</span>&nbsp;<span class="op" id="1696455">&gt;</span>&nbsp;<span class="num" id="1696457">0</span>&nbsp;<span class="op" id="1696459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696463">blockevent</span><span class="op" id="1696473">(</span><span class="ident" id="1696474">cas</span><span class="op" id="1696477">.</span><span class="ident" id="1696478">releasetime</span><span class="op" id="1696489">-</span><span class="ident" id="1696490">t0</span><span class="op" id="1696492">,</span>&nbsp;<span class="num" id="1696494">2</span><span class="op" id="1696495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696501">return</span>&nbsp;<span class="ident" id="1696508">cas</span><span class="op" id="1696511">.</span><span class="ident" id="1696512">pc</span><span class="op" id="1696514">,</span>&nbsp;<span class="ident" id="1696516">cas</span><span class="op" id="1696519">.</span><span class="ident" id="1696520">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1696524">sclose</span><span class="op" id="1696530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1696533">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696560">selunlock</span><span class="op" id="1696569">(</span><span class="ident" id="1696570">sel</span><span class="op" id="1696573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1696576">panic</span><span class="op" id="1696581">(</span><span class="string" id="1696582">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1696606">)</span><br>
<span class="lineno">575</span><span class="op" id="1696608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1696611">func</span>&nbsp;<span class="op" id="1696616">(</span><span class="ident" id="1696617">c</span>&nbsp;<span class="op" id="1696619">*</span><span class="ident" id="1696620">hchan</span><span class="op" id="1696625">)</span>&nbsp;<span class="ident" id="1696627">sortkey</span><span class="op" id="1696634">(</span><span class="op" id="1696635">)</span>&nbsp;<span class="builtintype" id="1696637">uintptr</span>&nbsp;<span class="op" id="1696645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1696648">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1696716">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696742">return</span>&nbsp;<span class="builtintype" id="1696749">uintptr</span><span class="op" id="1696756">(</span><span class="ident" id="1696757">unsafe</span><span class="op" id="1696763">.</span><span class="ident" id="1696764">Pointer</span><span class="op" id="1696771">(</span><span class="ident" id="1696772">c</span><span class="op" id="1696773">)</span><span class="op" id="1696774">)</span><br>
<span class="lineno"></span><span class="op" id="1696776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1696779">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1696834">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1696888">type</span>&nbsp;<span class="ident" id="1696893">runtimeSelect</span>&nbsp;<span class="keyword" id="1696907">struct</span>&nbsp;<span class="op" id="1696914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696917">dir</span>&nbsp;<span class="ident" id="1696921">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696932">typ</span>&nbsp;<span class="ident" id="1696936">unsafe</span><span class="op" id="1696942">.</span><span class="ident" id="1696943">Pointer</span>&nbsp;<span class="comment" id="1696951">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696984">ch</span>&nbsp;&nbsp;<span class="op" id="1696988">*</span><span class="ident" id="1696989">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1697003">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697015">val</span>&nbsp;<span class="ident" id="1697019">unsafe</span><span class="op" id="1697025">.</span><span class="ident" id="1697026">Pointer</span>&nbsp;<span class="comment" id="1697034">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1697094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1697097">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1697156">type</span>&nbsp;<span class="ident" id="1697161">selectDir</span>&nbsp;<span class="builtintype" id="1697171">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1697176">const</span>&nbsp;<span class="op" id="1697182">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697185">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1697199">selectDir</span>&nbsp;<span class="op" id="1697209">=</span>&nbsp;<span class="ident" id="1697211">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697217">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1697241">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697263">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1697287">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697304">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1697328">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1697339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1697342">func</span>&nbsp;<span class="ident" id="1697347">reflect_rselect</span><span class="op" id="1697362">(</span><span class="ident" id="1697363">cases</span>&nbsp;<span class="op" id="1697369">[</span><span class="op" id="1697370">]</span><span class="ident" id="1697371">runtimeSelect</span><span class="op" id="1697384">)</span>&nbsp;<span class="op" id="1697386">(</span><span class="ident" id="1697387">chosen</span>&nbsp;<span class="builtintype" id="1697394">int</span><span class="op" id="1697397">,</span>&nbsp;<span class="ident" id="1697399">recvOK</span>&nbsp;<span class="builtintype" id="1697406">bool</span><span class="op" id="1697410">)</span>&nbsp;<span class="op" id="1697412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1697415">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697496">size</span>&nbsp;<span class="op" id="1697501">:=</span>&nbsp;<span class="ident" id="1697504">selectsize</span><span class="op" id="1697514">(</span><span class="builtintype" id="1697515">uintptr</span><span class="op" id="1697522">(</span><span class="builtinfunc" id="1697523">len</span><span class="op" id="1697526">(</span><span class="ident" id="1697527">cases</span><span class="op" id="1697532">)</span><span class="op" id="1697533">)</span><span class="op" id="1697534">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697537">sel</span>&nbsp;<span class="op" id="1697541">:=</span>&nbsp;<span class="op" id="1697544">(</span><span class="op" id="1697545">*</span><span class="ident" id="1697546">_select</span><span class="op" id="1697553">)</span><span class="op" id="1697554">(</span><span class="ident" id="1697555">mallocgc</span><span class="op" id="1697563">(</span><span class="ident" id="1697564">size</span><span class="op" id="1697568">,</span>&nbsp;<span class="ident" id="1697570">nil</span><span class="op" id="1697573">,</span>&nbsp;<span class="ident" id="1697575">flagNoScan</span><span class="op" id="1697585">)</span><span class="op" id="1697586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697589">newselect</span><span class="op" id="1697598">(</span><span class="ident" id="1697599">sel</span><span class="op" id="1697602">,</span>&nbsp;<span class="ident" id="1697604">int64</span><span class="op" id="1697609">(</span><span class="ident" id="1697610">size</span><span class="op" id="1697614">)</span><span class="op" id="1697615">,</span>&nbsp;<span class="builtintype" id="1697617">int32</span><span class="op" id="1697622">(</span><span class="builtinfunc" id="1697623">len</span><span class="op" id="1697626">(</span><span class="ident" id="1697627">cases</span><span class="op" id="1697632">)</span><span class="op" id="1697633">)</span><span class="op" id="1697634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697637">r</span>&nbsp;<span class="op" id="1697639">:=</span>&nbsp;<span class="builtinfunc" id="1697642">new</span><span class="op" id="1697645">(</span><span class="builtintype" id="1697646">bool</span><span class="op" id="1697650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697653">for</span>&nbsp;<span class="ident" id="1697657">i</span>&nbsp;<span class="op" id="1697659">:=</span>&nbsp;<span class="keyword" id="1697662">range</span>&nbsp;<span class="ident" id="1697668">cases</span>&nbsp;<span class="op" id="1697674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697678">rc</span>&nbsp;<span class="op" id="1697681">:=</span>&nbsp;<span class="op" id="1697684">&amp;</span><span class="ident" id="1697685">cases</span><span class="op" id="1697690">[</span><span class="ident" id="1697691">i</span><span class="op" id="1697692">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697696">switch</span>&nbsp;<span class="ident" id="1697703">rc</span><span class="op" id="1697705">.</span><span class="ident" id="1697706">dir</span>&nbsp;<span class="op" id="1697710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697714">case</span>&nbsp;<span class="ident" id="1697719">selectDefault</span><span class="op" id="1697732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697737">selectdefaultImpl</span><span class="op" id="1697754">(</span><span class="ident" id="1697755">sel</span><span class="op" id="1697758">,</span>&nbsp;<span class="builtintype" id="1697760">uintptr</span><span class="op" id="1697767">(</span><span class="ident" id="1697768">i</span><span class="op" id="1697769">)</span><span class="op" id="1697770">,</span>&nbsp;<span class="num" id="1697772">0</span><span class="op" id="1697773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697777">case</span>&nbsp;<span class="ident" id="1697782">selectSend</span><span class="op" id="1697792">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697797">if</span>&nbsp;<span class="ident" id="1697800">rc</span><span class="op" id="1697802">.</span><span class="ident" id="1697803">ch</span>&nbsp;<span class="op" id="1697806">==</span>&nbsp;<span class="ident" id="1697809">nil</span>&nbsp;<span class="op" id="1697813">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697819">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1697828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697833">selectsendImpl</span><span class="op" id="1697847">(</span><span class="ident" id="1697848">sel</span><span class="op" id="1697851">,</span>&nbsp;<span class="ident" id="1697853">rc</span><span class="op" id="1697855">.</span><span class="ident" id="1697856">ch</span><span class="op" id="1697858">,</span>&nbsp;<span class="builtintype" id="1697860">uintptr</span><span class="op" id="1697867">(</span><span class="ident" id="1697868">i</span><span class="op" id="1697869">)</span><span class="op" id="1697870">,</span>&nbsp;<span class="ident" id="1697872">rc</span><span class="op" id="1697874">.</span><span class="ident" id="1697875">val</span><span class="op" id="1697878">,</span>&nbsp;<span class="num" id="1697880">0</span><span class="op" id="1697881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697885">case</span>&nbsp;<span class="ident" id="1697890">selectRecv</span><span class="op" id="1697900">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697905">if</span>&nbsp;<span class="ident" id="1697908">rc</span><span class="op" id="1697910">.</span><span class="ident" id="1697911">ch</span>&nbsp;<span class="op" id="1697914">==</span>&nbsp;<span class="ident" id="1697917">nil</span>&nbsp;<span class="op" id="1697921">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1697927">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1697936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697941">selectrecvImpl</span><span class="op" id="1697955">(</span><span class="ident" id="1697956">sel</span><span class="op" id="1697959">,</span>&nbsp;<span class="ident" id="1697961">rc</span><span class="op" id="1697963">.</span><span class="ident" id="1697964">ch</span><span class="op" id="1697966">,</span>&nbsp;<span class="builtintype" id="1697968">uintptr</span><span class="op" id="1697975">(</span><span class="ident" id="1697976">i</span><span class="op" id="1697977">)</span><span class="op" id="1697978">,</span>&nbsp;<span class="ident" id="1697980">rc</span><span class="op" id="1697982">.</span><span class="ident" id="1697983">val</span><span class="op" id="1697986">,</span>&nbsp;<span class="ident" id="1697988">r</span><span class="op" id="1697989">,</span>&nbsp;<span class="num" id="1697991">0</span><span class="op" id="1697992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1697996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1697999">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698003">pc</span><span class="op" id="1698005">,</span>&nbsp;<span class="ident" id="1698007">_</span>&nbsp;<span class="op" id="1698009">:=</span>&nbsp;<span class="ident" id="1698012">selectgoImpl</span><span class="op" id="1698024">(</span><span class="ident" id="1698025">sel</span><span class="op" id="1698028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698031">chosen</span>&nbsp;<span class="op" id="1698038">=</span>&nbsp;<span class="builtintype" id="1698040">int</span><span class="op" id="1698043">(</span><span class="ident" id="1698044">pc</span><span class="op" id="1698046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698049">recvOK</span>&nbsp;<span class="op" id="1698056">=</span>&nbsp;<span class="op" id="1698058">*</span><span class="ident" id="1698059">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698062">return</span><br>
<span class="lineno">630</span><span class="op" id="1698069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1698072">func</span>&nbsp;<span class="op" id="1698077">(</span><span class="ident" id="1698078">q</span>&nbsp;<span class="op" id="1698080">*</span><span class="ident" id="1698081">waitq</span><span class="op" id="1698086">)</span>&nbsp;<span class="ident" id="1698088">dequeueSudoG</span><span class="op" id="1698100">(</span><span class="ident" id="1698101">s</span>&nbsp;<span class="op" id="1698103">*</span><span class="ident" id="1698104">sudog</span><span class="op" id="1698109">)</span>&nbsp;<span class="op" id="1698111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698114">var</span>&nbsp;<span class="ident" id="1698118">prevsgp</span>&nbsp;<span class="op" id="1698126">*</span><span class="ident" id="1698127">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698134">l</span>&nbsp;<span class="op" id="1698136">:=</span>&nbsp;<span class="op" id="1698139">&amp;</span><span class="ident" id="1698140">q</span><span class="op" id="1698141">.</span><span class="ident" id="1698142">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698149">for</span>&nbsp;<span class="op" id="1698153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698157">sgp</span>&nbsp;<span class="op" id="1698161">:=</span>&nbsp;<span class="op" id="1698164">*</span><span class="ident" id="1698165">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698169">if</span>&nbsp;<span class="ident" id="1698172">sgp</span>&nbsp;<span class="op" id="1698176">==</span>&nbsp;<span class="ident" id="1698179">nil</span>&nbsp;<span class="op" id="1698183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698188">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1698197">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698201">if</span>&nbsp;<span class="ident" id="1698204">sgp</span>&nbsp;<span class="op" id="1698208">==</span>&nbsp;<span class="ident" id="1698211">s</span>&nbsp;<span class="op" id="1698213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1698218">*</span><span class="ident" id="1698219">l</span>&nbsp;<span class="op" id="1698221">=</span>&nbsp;<span class="ident" id="1698223">sgp</span><span class="op" id="1698226">.</span><span class="ident" id="1698227">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698235">if</span>&nbsp;<span class="ident" id="1698238">q</span><span class="op" id="1698239">.</span><span class="ident" id="1698240">last</span>&nbsp;<span class="op" id="1698245">==</span>&nbsp;<span class="ident" id="1698248">sgp</span>&nbsp;<span class="op" id="1698252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698258">q</span><span class="op" id="1698259">.</span><span class="ident" id="1698260">last</span>&nbsp;<span class="op" id="1698265">=</span>&nbsp;<span class="ident" id="1698267">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1698278">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698283">s</span><span class="op" id="1698284">.</span><span class="ident" id="1698285">next</span>&nbsp;<span class="op" id="1698290">=</span>&nbsp;<span class="ident" id="1698292">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1698299">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1698308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698312">l</span>&nbsp;<span class="op" id="1698314">=</span>&nbsp;<span class="op" id="1698316">&amp;</span><span class="ident" id="1698317">sgp</span><span class="op" id="1698320">.</span><span class="ident" id="1698321">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1698328">prevsgp</span>&nbsp;<span class="op" id="1698336">=</span>&nbsp;<span class="ident" id="1698338">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1698343">}</span><br>
<span class="lineno"></span><span class="op" id="1698345">}</span>
</div>
</body>
</html>
