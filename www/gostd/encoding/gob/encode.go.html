<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5010011">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5010066">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5010120">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5010171">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5010226">package</span>&nbsp;<span class="ident" id="5010234">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5010239">import</span>&nbsp;<span class="op" id="5010246">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5010249">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5010261">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5010269">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="5010279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5010282">const</span>&nbsp;<span class="ident" id="5010288">uint64Size</span>&nbsp;<span class="op" id="5010299">=</span>&nbsp;<span class="num" id="5010301">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5010304">type</span>&nbsp;<span class="ident" id="5010309">encHelper</span>&nbsp;<span class="keyword" id="5010319">func</span><span class="op" id="5010323">(</span><span class="ident" id="5010324">state</span>&nbsp;<span class="op" id="5010330">*</span><span class="ident" id="5010331">encoderState</span><span class="op" id="5010343">,</span>&nbsp;<span class="ident" id="5010345">v</span>&nbsp;<span class="ident" id="5010347">reflect</span><span class="op" id="5010354">.</span><span class="ident" id="5010355">Value</span><span class="op" id="5010360">)</span>&nbsp;<span class="builtintype" id="5010362">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5010368">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="5010445">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5010511">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5010581">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="5010612">type</span>&nbsp;<span class="ident" id="5010617">encoderState</span>&nbsp;<span class="keyword" id="5010630">struct</span>&nbsp;<span class="op" id="5010637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010640">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5010649">*</span><span class="ident" id="5010650">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010659">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5010668">*</span><span class="ident" id="5010669">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010680">sendZero</span>&nbsp;<span class="builtintype" id="5010689">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5010710">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010780">fieldnum</span>&nbsp;<span class="builtintype" id="5010789">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5010810">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010845">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5010854">[</span><span class="num" id="5010855">1</span>&nbsp;<span class="op" id="5010857">+</span>&nbsp;<span class="ident" id="5010859">uint64Size</span><span class="op" id="5010869">]</span><span class="builtintype" id="5010870">byte</span>&nbsp;<span class="comment" id="5010875">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010933">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5010942">*</span><span class="ident" id="5010943">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5010963">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="5010980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5010983">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="5011069">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5011164">type</span>&nbsp;<span class="ident" id="5011169">encBuffer</span>&nbsp;<span class="keyword" id="5011179">struct</span>&nbsp;<span class="op" id="5011186">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011189">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5011197">[</span><span class="op" id="5011198">]</span><span class="builtintype" id="5011199">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011205">scratch</span>&nbsp;<span class="op" id="5011213">[</span><span class="num" id="5011214">64</span><span class="op" id="5011216">]</span><span class="builtintype" id="5011217">byte</span><br>
<span class="lineno"></span><span class="op" id="5011222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5011225">func</span>&nbsp;<span class="op" id="5011230">(</span><span class="ident" id="5011231">e</span>&nbsp;<span class="op" id="5011233">*</span><span class="ident" id="5011234">encBuffer</span><span class="op" id="5011243">)</span>&nbsp;<span class="ident" id="5011245">WriteByte</span><span class="op" id="5011254">(</span><span class="ident" id="5011255">c</span>&nbsp;<span class="builtintype" id="5011257">byte</span><span class="op" id="5011261">)</span>&nbsp;<span class="op" id="5011263">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011266">e</span><span class="op" id="5011267">.</span><span class="ident" id="5011268">data</span>&nbsp;<span class="op" id="5011273">=</span>&nbsp;<span class="builtinfunc" id="5011275">append</span><span class="op" id="5011281">(</span><span class="ident" id="5011282">e</span><span class="op" id="5011283">.</span><span class="ident" id="5011284">data</span><span class="op" id="5011288">,</span>&nbsp;<span class="ident" id="5011290">c</span><span class="op" id="5011291">)</span><br>
<span class="lineno"></span><span class="op" id="5011293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5011296">func</span>&nbsp;<span class="op" id="5011301">(</span><span class="ident" id="5011302">e</span>&nbsp;<span class="op" id="5011304">*</span><span class="ident" id="5011305">encBuffer</span><span class="op" id="5011314">)</span>&nbsp;<span class="ident" id="5011316">Write</span><span class="op" id="5011321">(</span><span class="ident" id="5011322">p</span>&nbsp;<span class="op" id="5011324">[</span><span class="op" id="5011325">]</span><span class="builtintype" id="5011326">byte</span><span class="op" id="5011330">)</span>&nbsp;<span class="op" id="5011332">(</span><span class="builtintype" id="5011333">int</span><span class="op" id="5011336">,</span>&nbsp;<span class="builtintype" id="5011338">error</span><span class="op" id="5011343">)</span>&nbsp;<span class="op" id="5011345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011348">e</span><span class="op" id="5011349">.</span><span class="ident" id="5011350">data</span>&nbsp;<span class="op" id="5011355">=</span>&nbsp;<span class="builtinfunc" id="5011357">append</span><span class="op" id="5011363">(</span><span class="ident" id="5011364">e</span><span class="op" id="5011365">.</span><span class="ident" id="5011366">data</span><span class="op" id="5011370">,</span>&nbsp;<span class="ident" id="5011372">p</span><span class="op" id="5011373">...</span><span class="op" id="5011376">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011379">return</span>&nbsp;<span class="builtinfunc" id="5011386">len</span><span class="op" id="5011389">(</span><span class="ident" id="5011390">p</span><span class="op" id="5011391">)</span><span class="op" id="5011392">,</span>&nbsp;<span class="ident" id="5011394">nil</span><br>
<span class="lineno"></span><span class="op" id="5011398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5011401">func</span>&nbsp;<span class="op" id="5011406">(</span><span class="ident" id="5011407">e</span>&nbsp;<span class="op" id="5011409">*</span><span class="ident" id="5011410">encBuffer</span><span class="op" id="5011419">)</span>&nbsp;<span class="ident" id="5011421">WriteString</span><span class="op" id="5011432">(</span><span class="ident" id="5011433">s</span>&nbsp;<span class="builtintype" id="5011435">string</span><span class="op" id="5011441">)</span>&nbsp;<span class="op" id="5011443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011446">e</span><span class="op" id="5011447">.</span><span class="ident" id="5011448">data</span>&nbsp;<span class="op" id="5011453">=</span>&nbsp;<span class="builtinfunc" id="5011455">append</span><span class="op" id="5011461">(</span><span class="ident" id="5011462">e</span><span class="op" id="5011463">.</span><span class="ident" id="5011464">data</span><span class="op" id="5011468">,</span>&nbsp;<span class="ident" id="5011470">s</span><span class="op" id="5011471">...</span><span class="op" id="5011474">)</span><br>
<span class="lineno">50</span><span class="op" id="5011476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5011479">func</span>&nbsp;<span class="op" id="5011484">(</span><span class="ident" id="5011485">e</span>&nbsp;<span class="op" id="5011487">*</span><span class="ident" id="5011488">encBuffer</span><span class="op" id="5011497">)</span>&nbsp;<span class="ident" id="5011499">Len</span><span class="op" id="5011502">(</span><span class="op" id="5011503">)</span>&nbsp;<span class="builtintype" id="5011505">int</span>&nbsp;<span class="op" id="5011509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011512">return</span>&nbsp;<span class="builtinfunc" id="5011519">len</span><span class="op" id="5011522">(</span><span class="ident" id="5011523">e</span><span class="op" id="5011524">.</span><span class="ident" id="5011525">data</span><span class="op" id="5011529">)</span><br>
<span class="lineno"></span><span class="op" id="5011531">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5011534">func</span>&nbsp;<span class="op" id="5011539">(</span><span class="ident" id="5011540">e</span>&nbsp;<span class="op" id="5011542">*</span><span class="ident" id="5011543">encBuffer</span><span class="op" id="5011552">)</span>&nbsp;<span class="ident" id="5011554">Bytes</span><span class="op" id="5011559">(</span><span class="op" id="5011560">)</span>&nbsp;<span class="op" id="5011562">[</span><span class="op" id="5011563">]</span><span class="builtintype" id="5011564">byte</span>&nbsp;<span class="op" id="5011569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011572">return</span>&nbsp;<span class="ident" id="5011579">e</span><span class="op" id="5011580">.</span><span class="ident" id="5011581">data</span><br>
<span class="lineno"></span><span class="op" id="5011586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5011589">func</span>&nbsp;<span class="op" id="5011594">(</span><span class="ident" id="5011595">e</span>&nbsp;<span class="op" id="5011597">*</span><span class="ident" id="5011598">encBuffer</span><span class="op" id="5011607">)</span>&nbsp;<span class="ident" id="5011609">Reset</span><span class="op" id="5011614">(</span><span class="op" id="5011615">)</span>&nbsp;<span class="op" id="5011617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011620">e</span><span class="op" id="5011621">.</span><span class="ident" id="5011622">data</span>&nbsp;<span class="op" id="5011627">=</span>&nbsp;<span class="ident" id="5011629">e</span><span class="op" id="5011630">.</span><span class="ident" id="5011631">data</span><span class="op" id="5011635">[</span><span class="num" id="5011636">0</span><span class="op" id="5011637">:</span><span class="num" id="5011638">0</span><span class="op" id="5011639">]</span><br>
<span class="lineno"></span><span class="op" id="5011641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5011644">func</span>&nbsp;<span class="op" id="5011649">(</span><span class="ident" id="5011650">enc</span>&nbsp;<span class="op" id="5011654">*</span><span class="ident" id="5011655">Encoder</span><span class="op" id="5011662">)</span>&nbsp;<span class="ident" id="5011664">newEncoderState</span><span class="op" id="5011679">(</span><span class="ident" id="5011680">b</span>&nbsp;<span class="op" id="5011682">*</span><span class="ident" id="5011683">encBuffer</span><span class="op" id="5011692">)</span>&nbsp;<span class="op" id="5011694">*</span><span class="ident" id="5011695">encoderState</span>&nbsp;<span class="op" id="5011708">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011711">e</span>&nbsp;<span class="op" id="5011713">:=</span>&nbsp;<span class="ident" id="5011716">enc</span><span class="op" id="5011719">.</span><span class="ident" id="5011720">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011730">if</span>&nbsp;<span class="ident" id="5011733">e</span>&nbsp;<span class="op" id="5011735">==</span>&nbsp;<span class="ident" id="5011738">nil</span>&nbsp;<span class="op" id="5011742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011746">e</span>&nbsp;<span class="op" id="5011748">=</span>&nbsp;<span class="builtinfunc" id="5011750">new</span><span class="op" id="5011753">(</span><span class="ident" id="5011754">encoderState</span><span class="op" id="5011766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011770">e</span><span class="op" id="5011771">.</span><span class="ident" id="5011772">enc</span>&nbsp;<span class="op" id="5011776">=</span>&nbsp;<span class="ident" id="5011778">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011783">}</span>&nbsp;<span class="keyword" id="5011785">else</span>&nbsp;<span class="op" id="5011790">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011794">enc</span><span class="op" id="5011797">.</span><span class="ident" id="5011798">freeList</span>&nbsp;<span class="op" id="5011807">=</span>&nbsp;<span class="ident" id="5011809">e</span><span class="op" id="5011810">.</span><span class="ident" id="5011811">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011820">e</span><span class="op" id="5011821">.</span><span class="ident" id="5011822">sendZero</span>&nbsp;<span class="op" id="5011831">=</span>&nbsp;<span class="builtintype" id="5011833">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011840">e</span><span class="op" id="5011841">.</span><span class="ident" id="5011842">fieldnum</span>&nbsp;<span class="op" id="5011851">=</span>&nbsp;<span class="num" id="5011853">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011856">e</span><span class="op" id="5011857">.</span><span class="ident" id="5011858">b</span>&nbsp;<span class="op" id="5011860">=</span>&nbsp;<span class="ident" id="5011862">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011865">if</span>&nbsp;<span class="builtinfunc" id="5011868">len</span><span class="op" id="5011871">(</span><span class="ident" id="5011872">b</span><span class="op" id="5011873">.</span><span class="ident" id="5011874">data</span><span class="op" id="5011878">)</span>&nbsp;<span class="op" id="5011880">==</span>&nbsp;<span class="num" id="5011883">0</span>&nbsp;<span class="op" id="5011885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011889">b</span><span class="op" id="5011890">.</span><span class="ident" id="5011891">data</span>&nbsp;<span class="op" id="5011896">=</span>&nbsp;<span class="ident" id="5011898">b</span><span class="op" id="5011899">.</span><span class="ident" id="5011900">scratch</span><span class="op" id="5011907">[</span><span class="num" id="5011908">0</span><span class="op" id="5011909">:</span><span class="num" id="5011910">0</span><span class="op" id="5011911">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011917">return</span>&nbsp;<span class="ident" id="5011924">e</span><br>
<span class="lineno"></span><span class="op" id="5011926">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="5011929">func</span>&nbsp;<span class="op" id="5011934">(</span><span class="ident" id="5011935">enc</span>&nbsp;<span class="op" id="5011939">*</span><span class="ident" id="5011940">Encoder</span><span class="op" id="5011947">)</span>&nbsp;<span class="ident" id="5011949">freeEncoderState</span><span class="op" id="5011965">(</span><span class="ident" id="5011966">e</span>&nbsp;<span class="op" id="5011968">*</span><span class="ident" id="5011969">encoderState</span><span class="op" id="5011981">)</span>&nbsp;<span class="op" id="5011983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011986">e</span><span class="op" id="5011987">.</span><span class="ident" id="5011988">next</span>&nbsp;<span class="op" id="5011993">=</span>&nbsp;<span class="ident" id="5011995">enc</span><span class="op" id="5011998">.</span><span class="ident" id="5011999">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012009">enc</span><span class="op" id="5012012">.</span><span class="ident" id="5012013">freeList</span>&nbsp;<span class="op" id="5012022">=</span>&nbsp;<span class="ident" id="5012024">e</span><br>
<span class="lineno"></span><span class="op" id="5012026">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5012029">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="5012100">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="5012161">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="5012229">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="5012262">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="5012323">func</span>&nbsp;<span class="op" id="5012328">(</span><span class="ident" id="5012329">state</span>&nbsp;<span class="op" id="5012335">*</span><span class="ident" id="5012336">encoderState</span><span class="op" id="5012348">)</span>&nbsp;<span class="ident" id="5012350">encodeUint</span><span class="op" id="5012360">(</span><span class="ident" id="5012361">x</span>&nbsp;<span class="ident" id="5012363">uint64</span><span class="op" id="5012369">)</span>&nbsp;<span class="op" id="5012371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012374">if</span>&nbsp;<span class="ident" id="5012377">x</span>&nbsp;<span class="op" id="5012379">&lt;=</span>&nbsp;<span class="num" id="5012382">0x7F</span>&nbsp;<span class="op" id="5012387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012391">state</span><span class="op" id="5012396">.</span><span class="ident" id="5012397">b</span><span class="op" id="5012398">.</span><span class="ident" id="5012399">WriteByte</span><span class="op" id="5012408">(</span><span class="builtintype" id="5012409">uint8</span><span class="op" id="5012414">(</span><span class="ident" id="5012415">x</span><span class="op" id="5012416">)</span><span class="op" id="5012417">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012421">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012432">i</span>&nbsp;<span class="op" id="5012434">:=</span>&nbsp;<span class="ident" id="5012437">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012449">for</span>&nbsp;<span class="ident" id="5012453">x</span>&nbsp;<span class="op" id="5012455">&gt;</span>&nbsp;<span class="num" id="5012457">0</span>&nbsp;<span class="op" id="5012459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012463">state</span><span class="op" id="5012468">.</span><span class="ident" id="5012469">buf</span><span class="op" id="5012472">[</span><span class="ident" id="5012473">i</span><span class="op" id="5012474">]</span>&nbsp;<span class="op" id="5012476">=</span>&nbsp;<span class="builtintype" id="5012478">uint8</span><span class="op" id="5012483">(</span><span class="ident" id="5012484">x</span><span class="op" id="5012485">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012489">x</span>&nbsp;<span class="op" id="5012491">&gt;&gt;=</span>&nbsp;<span class="num" id="5012495">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012499">i</span><span class="op" id="5012500">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012507">state</span><span class="op" id="5012512">.</span><span class="ident" id="5012513">buf</span><span class="op" id="5012516">[</span><span class="ident" id="5012517">i</span><span class="op" id="5012518">]</span>&nbsp;<span class="op" id="5012520">=</span>&nbsp;<span class="builtintype" id="5012522">uint8</span><span class="op" id="5012527">(</span><span class="ident" id="5012528">i</span>&nbsp;<span class="op" id="5012530">-</span>&nbsp;<span class="ident" id="5012532">uint64Size</span><span class="op" id="5012542">)</span>&nbsp;<span class="comment" id="5012544">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012570">state</span><span class="op" id="5012575">.</span><span class="ident" id="5012576">b</span><span class="op" id="5012577">.</span><span class="ident" id="5012578">Write</span><span class="op" id="5012583">(</span><span class="ident" id="5012584">state</span><span class="op" id="5012589">.</span><span class="ident" id="5012590">buf</span><span class="op" id="5012593">[</span><span class="ident" id="5012594">i</span>&nbsp;<span class="op" id="5012596">:</span>&nbsp;<span class="ident" id="5012598">uint64Size</span><span class="op" id="5012608">+</span><span class="num" id="5012609">1</span><span class="op" id="5012610">]</span><span class="op" id="5012611">)</span><br>
<span class="lineno">105</span><span class="op" id="5012613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5012616">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="5012674">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="5012760">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="5012788">func</span>&nbsp;<span class="op" id="5012793">(</span><span class="ident" id="5012794">state</span>&nbsp;<span class="op" id="5012800">*</span><span class="ident" id="5012801">encoderState</span><span class="op" id="5012813">)</span>&nbsp;<span class="ident" id="5012815">encodeInt</span><span class="op" id="5012824">(</span><span class="ident" id="5012825">i</span>&nbsp;<span class="ident" id="5012827">int64</span><span class="op" id="5012832">)</span>&nbsp;<span class="op" id="5012834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012837">var</span>&nbsp;<span class="ident" id="5012841">x</span>&nbsp;<span class="ident" id="5012843">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012851">if</span>&nbsp;<span class="ident" id="5012854">i</span>&nbsp;<span class="op" id="5012856">&lt;</span>&nbsp;<span class="num" id="5012858">0</span>&nbsp;<span class="op" id="5012860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012864">x</span>&nbsp;<span class="op" id="5012866">=</span>&nbsp;<span class="ident" id="5012868">uint64</span><span class="op" id="5012874">(</span><span class="op" id="5012875">^</span><span class="ident" id="5012876">i</span><span class="op" id="5012877">&lt;&lt;</span><span class="num" id="5012879">1</span><span class="op" id="5012880">)</span>&nbsp;<span class="op" id="5012882">|</span>&nbsp;<span class="num" id="5012884">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012887">}</span>&nbsp;<span class="keyword" id="5012889">else</span>&nbsp;<span class="op" id="5012894">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012898">x</span>&nbsp;<span class="op" id="5012900">=</span>&nbsp;<span class="ident" id="5012902">uint64</span><span class="op" id="5012908">(</span><span class="ident" id="5012909">i</span>&nbsp;<span class="op" id="5012911">&lt;&lt;</span>&nbsp;<span class="num" id="5012914">1</span><span class="op" id="5012915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012921">state</span><span class="op" id="5012926">.</span><span class="ident" id="5012927">encodeUint</span><span class="op" id="5012937">(</span><span class="ident" id="5012938">uint64</span><span class="op" id="5012944">(</span><span class="ident" id="5012945">x</span><span class="op" id="5012946">)</span><span class="op" id="5012947">)</span><br>
<span class="lineno"></span><span class="op" id="5012949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5012952">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5013020">type</span>&nbsp;<span class="ident" id="5013025">encOp</span>&nbsp;<span class="keyword" id="5013031">func</span><span class="op" id="5013035">(</span><span class="ident" id="5013036">i</span>&nbsp;<span class="op" id="5013038">*</span><span class="ident" id="5013039">encInstr</span><span class="op" id="5013047">,</span>&nbsp;<span class="ident" id="5013049">state</span>&nbsp;<span class="op" id="5013055">*</span><span class="ident" id="5013056">encoderState</span><span class="op" id="5013068">,</span>&nbsp;<span class="ident" id="5013070">v</span>&nbsp;<span class="ident" id="5013072">reflect</span><span class="op" id="5013079">.</span><span class="ident" id="5013080">Value</span><span class="op" id="5013085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5013088">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="5013134">type</span>&nbsp;<span class="ident" id="5013139">encInstr</span>&nbsp;<span class="keyword" id="5013148">struct</span>&nbsp;<span class="op" id="5013155">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013158">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5013164">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013171">field</span>&nbsp;<span class="builtintype" id="5013177">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5013183">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013209">index</span>&nbsp;<span class="op" id="5013215">[</span><span class="op" id="5013216">]</span><span class="builtintype" id="5013217">int</span>&nbsp;<span class="comment" id="5013221">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013238">indir</span>&nbsp;<span class="builtintype" id="5013244">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5013250">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="5013316">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5013319">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="5013412">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="5013466">func</span>&nbsp;<span class="op" id="5013471">(</span><span class="ident" id="5013472">state</span>&nbsp;<span class="op" id="5013478">*</span><span class="ident" id="5013479">encoderState</span><span class="op" id="5013491">)</span>&nbsp;<span class="ident" id="5013493">update</span><span class="op" id="5013499">(</span><span class="ident" id="5013500">instr</span>&nbsp;<span class="op" id="5013506">*</span><span class="ident" id="5013507">encInstr</span><span class="op" id="5013515">)</span>&nbsp;<span class="op" id="5013517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013520">if</span>&nbsp;<span class="ident" id="5013523">instr</span>&nbsp;<span class="op" id="5013529">!=</span>&nbsp;<span class="ident" id="5013532">nil</span>&nbsp;<span class="op" id="5013536">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013540">state</span><span class="op" id="5013545">.</span><span class="ident" id="5013546">encodeUint</span><span class="op" id="5013556">(</span><span class="ident" id="5013557">uint64</span><span class="op" id="5013563">(</span><span class="ident" id="5013564">instr</span><span class="op" id="5013569">.</span><span class="ident" id="5013570">field</span>&nbsp;<span class="op" id="5013576">-</span>&nbsp;<span class="ident" id="5013578">state</span><span class="op" id="5013583">.</span><span class="ident" id="5013584">fieldnum</span><span class="op" id="5013592">)</span><span class="op" id="5013593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013597">state</span><span class="op" id="5013602">.</span><span class="ident" id="5013603">fieldnum</span>&nbsp;<span class="op" id="5013612">=</span>&nbsp;<span class="ident" id="5013614">instr</span><span class="op" id="5013619">.</span><span class="ident" id="5013620">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5013627">}</span><br>
<span class="lineno"></span><span class="op" id="5013629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5013632">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5013696">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="5013764">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5013831">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="5013898">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="5013962">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5014029">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="5014095">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5014107">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="5014174">func</span>&nbsp;<span class="ident" id="5014179">encIndirect</span><span class="op" id="5014190">(</span><span class="ident" id="5014191">pv</span>&nbsp;<span class="ident" id="5014194">reflect</span><span class="op" id="5014201">.</span><span class="ident" id="5014202">Value</span><span class="op" id="5014207">,</span>&nbsp;<span class="ident" id="5014209">indir</span>&nbsp;<span class="builtintype" id="5014215">int</span><span class="op" id="5014218">)</span>&nbsp;<span class="ident" id="5014220">reflect</span><span class="op" id="5014227">.</span><span class="ident" id="5014228">Value</span>&nbsp;<span class="op" id="5014234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014237">for</span>&nbsp;<span class="op" id="5014241">;</span>&nbsp;<span class="ident" id="5014243">indir</span>&nbsp;<span class="op" id="5014249">&gt;</span>&nbsp;<span class="num" id="5014251">0</span><span class="op" id="5014252">;</span>&nbsp;<span class="ident" id="5014254">indir</span><span class="op" id="5014259">--</span>&nbsp;<span class="op" id="5014262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014266">if</span>&nbsp;<span class="ident" id="5014269">pv</span><span class="op" id="5014271">.</span><span class="ident" id="5014272">IsNil</span><span class="op" id="5014277">(</span><span class="op" id="5014278">)</span>&nbsp;<span class="op" id="5014280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014285">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014293">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014297">pv</span>&nbsp;<span class="op" id="5014300">=</span>&nbsp;<span class="ident" id="5014302">pv</span><span class="op" id="5014304">.</span><span class="ident" id="5014305">Elem</span><span class="op" id="5014309">(</span><span class="op" id="5014310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014316">return</span>&nbsp;<span class="ident" id="5014323">pv</span><br>
<span class="lineno"></span><span class="op" id="5014326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="5014329">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="5014396">func</span>&nbsp;<span class="ident" id="5014401">encBool</span><span class="op" id="5014408">(</span><span class="ident" id="5014409">i</span>&nbsp;<span class="op" id="5014411">*</span><span class="ident" id="5014412">encInstr</span><span class="op" id="5014420">,</span>&nbsp;<span class="ident" id="5014422">state</span>&nbsp;<span class="op" id="5014428">*</span><span class="ident" id="5014429">encoderState</span><span class="op" id="5014441">,</span>&nbsp;<span class="ident" id="5014443">v</span>&nbsp;<span class="ident" id="5014445">reflect</span><span class="op" id="5014452">.</span><span class="ident" id="5014453">Value</span><span class="op" id="5014458">)</span>&nbsp;<span class="op" id="5014460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014463">b</span>&nbsp;<span class="op" id="5014465">:=</span>&nbsp;<span class="ident" id="5014468">v</span><span class="op" id="5014469">.</span><span class="ident" id="5014470">Bool</span><span class="op" id="5014474">(</span><span class="op" id="5014475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014478">if</span>&nbsp;<span class="ident" id="5014481">b</span>&nbsp;<span class="op" id="5014483">||</span>&nbsp;<span class="ident" id="5014486">state</span><span class="op" id="5014491">.</span><span class="ident" id="5014492">sendZero</span>&nbsp;<span class="op" id="5014501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014505">state</span><span class="op" id="5014510">.</span><span class="ident" id="5014511">update</span><span class="op" id="5014517">(</span><span class="ident" id="5014518">i</span><span class="op" id="5014519">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014523">if</span>&nbsp;<span class="ident" id="5014526">b</span>&nbsp;<span class="op" id="5014528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014533">state</span><span class="op" id="5014538">.</span><span class="ident" id="5014539">encodeUint</span><span class="op" id="5014549">(</span><span class="num" id="5014550">1</span><span class="op" id="5014551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014555">}</span>&nbsp;<span class="keyword" id="5014557">else</span>&nbsp;<span class="op" id="5014562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014567">state</span><span class="op" id="5014572">.</span><span class="ident" id="5014573">encodeUint</span><span class="op" id="5014583">(</span><span class="num" id="5014584">0</span><span class="op" id="5014585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014589">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014592">}</span><br>
<span class="lineno"></span><span class="op" id="5014594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5014597">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5014680">func</span>&nbsp;<span class="ident" id="5014685">encInt</span><span class="op" id="5014691">(</span><span class="ident" id="5014692">i</span>&nbsp;<span class="op" id="5014694">*</span><span class="ident" id="5014695">encInstr</span><span class="op" id="5014703">,</span>&nbsp;<span class="ident" id="5014705">state</span>&nbsp;<span class="op" id="5014711">*</span><span class="ident" id="5014712">encoderState</span><span class="op" id="5014724">,</span>&nbsp;<span class="ident" id="5014726">v</span>&nbsp;<span class="ident" id="5014728">reflect</span><span class="op" id="5014735">.</span><span class="ident" id="5014736">Value</span><span class="op" id="5014741">)</span>&nbsp;<span class="op" id="5014743">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014746">value</span>&nbsp;<span class="op" id="5014752">:=</span>&nbsp;<span class="ident" id="5014755">v</span><span class="op" id="5014756">.</span><span class="ident" id="5014757">Int</span><span class="op" id="5014760">(</span><span class="op" id="5014761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014764">if</span>&nbsp;<span class="ident" id="5014767">value</span>&nbsp;<span class="op" id="5014773">!=</span>&nbsp;<span class="num" id="5014776">0</span>&nbsp;<span class="op" id="5014778">||</span>&nbsp;<span class="ident" id="5014781">state</span><span class="op" id="5014786">.</span><span class="ident" id="5014787">sendZero</span>&nbsp;<span class="op" id="5014796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014800">state</span><span class="op" id="5014805">.</span><span class="ident" id="5014806">update</span><span class="op" id="5014812">(</span><span class="ident" id="5014813">i</span><span class="op" id="5014814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014818">state</span><span class="op" id="5014823">.</span><span class="ident" id="5014824">encodeInt</span><span class="op" id="5014833">(</span><span class="ident" id="5014834">value</span><span class="op" id="5014839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014842">}</span><br>
<span class="lineno">180</span><span class="op" id="5014844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5014847">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5014946">func</span>&nbsp;<span class="ident" id="5014951">encUint</span><span class="op" id="5014958">(</span><span class="ident" id="5014959">i</span>&nbsp;<span class="op" id="5014961">*</span><span class="ident" id="5014962">encInstr</span><span class="op" id="5014970">,</span>&nbsp;<span class="ident" id="5014972">state</span>&nbsp;<span class="op" id="5014978">*</span><span class="ident" id="5014979">encoderState</span><span class="op" id="5014991">,</span>&nbsp;<span class="ident" id="5014993">v</span>&nbsp;<span class="ident" id="5014995">reflect</span><span class="op" id="5015002">.</span><span class="ident" id="5015003">Value</span><span class="op" id="5015008">)</span>&nbsp;<span class="op" id="5015010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015013">value</span>&nbsp;<span class="op" id="5015019">:=</span>&nbsp;<span class="ident" id="5015022">v</span><span class="op" id="5015023">.</span><span class="ident" id="5015024">Uint</span><span class="op" id="5015028">(</span><span class="op" id="5015029">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015032">if</span>&nbsp;<span class="ident" id="5015035">value</span>&nbsp;<span class="op" id="5015041">!=</span>&nbsp;<span class="num" id="5015044">0</span>&nbsp;<span class="op" id="5015046">||</span>&nbsp;<span class="ident" id="5015049">state</span><span class="op" id="5015054">.</span><span class="ident" id="5015055">sendZero</span>&nbsp;<span class="op" id="5015064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015068">state</span><span class="op" id="5015073">.</span><span class="ident" id="5015074">update</span><span class="op" id="5015080">(</span><span class="ident" id="5015081">i</span><span class="op" id="5015082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015086">state</span><span class="op" id="5015091">.</span><span class="ident" id="5015092">encodeUint</span><span class="op" id="5015102">(</span><span class="ident" id="5015103">value</span><span class="op" id="5015108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015111">}</span><br>
<span class="lineno"></span><span class="op" id="5015113">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5015116">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="5015191">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5015261">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5015333">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="5015405">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5015470">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="5015484">func</span>&nbsp;<span class="ident" id="5015489">floatBits</span><span class="op" id="5015498">(</span><span class="ident" id="5015499">f</span>&nbsp;<span class="builtintype" id="5015501">float64</span><span class="op" id="5015508">)</span>&nbsp;<span class="ident" id="5015510">uint64</span>&nbsp;<span class="op" id="5015517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015520">u</span>&nbsp;<span class="op" id="5015522">:=</span>&nbsp;<span class="ident" id="5015525">math</span><span class="op" id="5015529">.</span><span class="ident" id="5015530">Float64bits</span><span class="op" id="5015541">(</span><span class="ident" id="5015542">f</span><span class="op" id="5015543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015546">var</span>&nbsp;<span class="ident" id="5015550">v</span>&nbsp;<span class="ident" id="5015552">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015560">for</span>&nbsp;<span class="ident" id="5015564">i</span>&nbsp;<span class="op" id="5015566">:=</span>&nbsp;<span class="num" id="5015569">0</span><span class="op" id="5015570">;</span>&nbsp;<span class="ident" id="5015572">i</span>&nbsp;<span class="op" id="5015574">&lt;</span>&nbsp;<span class="num" id="5015576">8</span><span class="op" id="5015577">;</span>&nbsp;<span class="ident" id="5015579">i</span><span class="op" id="5015580">++</span>&nbsp;<span class="op" id="5015583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015587">v</span>&nbsp;<span class="op" id="5015589">&lt;&lt;=</span>&nbsp;<span class="num" id="5015593">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015597">v</span>&nbsp;<span class="op" id="5015599">|=</span>&nbsp;<span class="ident" id="5015602">u</span>&nbsp;<span class="op" id="5015604">&amp;</span>&nbsp;<span class="num" id="5015606">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015613">u</span>&nbsp;<span class="op" id="5015615">&gt;&gt;=</span>&nbsp;<span class="num" id="5015619">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015622">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015625">return</span>&nbsp;<span class="ident" id="5015632">v</span><br>
<span class="lineno"></span><span class="op" id="5015634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5015637">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5015717">func</span>&nbsp;<span class="ident" id="5015722">encFloat</span><span class="op" id="5015730">(</span><span class="ident" id="5015731">i</span>&nbsp;<span class="op" id="5015733">*</span><span class="ident" id="5015734">encInstr</span><span class="op" id="5015742">,</span>&nbsp;<span class="ident" id="5015744">state</span>&nbsp;<span class="op" id="5015750">*</span><span class="ident" id="5015751">encoderState</span><span class="op" id="5015763">,</span>&nbsp;<span class="ident" id="5015765">v</span>&nbsp;<span class="ident" id="5015767">reflect</span><span class="op" id="5015774">.</span><span class="ident" id="5015775">Value</span><span class="op" id="5015780">)</span>&nbsp;<span class="op" id="5015782">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015785">f</span>&nbsp;<span class="op" id="5015787">:=</span>&nbsp;<span class="ident" id="5015790">v</span><span class="op" id="5015791">.</span><span class="ident" id="5015792">Float</span><span class="op" id="5015797">(</span><span class="op" id="5015798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015801">if</span>&nbsp;<span class="ident" id="5015804">f</span>&nbsp;<span class="op" id="5015806">!=</span>&nbsp;<span class="num" id="5015809">0</span>&nbsp;<span class="op" id="5015811">||</span>&nbsp;<span class="ident" id="5015814">state</span><span class="op" id="5015819">.</span><span class="ident" id="5015820">sendZero</span>&nbsp;<span class="op" id="5015829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015833">bits</span>&nbsp;<span class="op" id="5015838">:=</span>&nbsp;<span class="ident" id="5015841">floatBits</span><span class="op" id="5015850">(</span><span class="ident" id="5015851">f</span><span class="op" id="5015852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015856">state</span><span class="op" id="5015861">.</span><span class="ident" id="5015862">update</span><span class="op" id="5015868">(</span><span class="ident" id="5015869">i</span><span class="op" id="5015870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015874">state</span><span class="op" id="5015879">.</span><span class="ident" id="5015880">encodeUint</span><span class="op" id="5015890">(</span><span class="ident" id="5015891">bits</span><span class="op" id="5015895">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015898">}</span><br>
<span class="lineno"></span><span class="op" id="5015900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5015903">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5015983">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="5016062">func</span>&nbsp;<span class="ident" id="5016067">encComplex</span><span class="op" id="5016077">(</span><span class="ident" id="5016078">i</span>&nbsp;<span class="op" id="5016080">*</span><span class="ident" id="5016081">encInstr</span><span class="op" id="5016089">,</span>&nbsp;<span class="ident" id="5016091">state</span>&nbsp;<span class="op" id="5016097">*</span><span class="ident" id="5016098">encoderState</span><span class="op" id="5016110">,</span>&nbsp;<span class="ident" id="5016112">v</span>&nbsp;<span class="ident" id="5016114">reflect</span><span class="op" id="5016121">.</span><span class="ident" id="5016122">Value</span><span class="op" id="5016127">)</span>&nbsp;<span class="op" id="5016129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016132">c</span>&nbsp;<span class="op" id="5016134">:=</span>&nbsp;<span class="ident" id="5016137">v</span><span class="op" id="5016138">.</span><span class="ident" id="5016139">Complex</span><span class="op" id="5016146">(</span><span class="op" id="5016147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016150">if</span>&nbsp;<span class="ident" id="5016153">c</span>&nbsp;<span class="op" id="5016155">!=</span>&nbsp;<span class="num" id="5016158">0</span><span class="op" id="5016159">+</span><span class="num" id="5016160">0i</span>&nbsp;<span class="op" id="5016163">||</span>&nbsp;<span class="ident" id="5016166">state</span><span class="op" id="5016171">.</span><span class="ident" id="5016172">sendZero</span>&nbsp;<span class="op" id="5016181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016185">rpart</span>&nbsp;<span class="op" id="5016191">:=</span>&nbsp;<span class="ident" id="5016194">floatBits</span><span class="op" id="5016203">(</span><span class="builtinfunc" id="5016204">real</span><span class="op" id="5016208">(</span><span class="ident" id="5016209">c</span><span class="op" id="5016210">)</span><span class="op" id="5016211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016215">ipart</span>&nbsp;<span class="op" id="5016221">:=</span>&nbsp;<span class="ident" id="5016224">floatBits</span><span class="op" id="5016233">(</span><span class="builtinfunc" id="5016234">imag</span><span class="op" id="5016238">(</span><span class="ident" id="5016239">c</span><span class="op" id="5016240">)</span><span class="op" id="5016241">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016245">state</span><span class="op" id="5016250">.</span><span class="ident" id="5016251">update</span><span class="op" id="5016257">(</span><span class="ident" id="5016258">i</span><span class="op" id="5016259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016263">state</span><span class="op" id="5016268">.</span><span class="ident" id="5016269">encodeUint</span><span class="op" id="5016279">(</span><span class="ident" id="5016280">rpart</span><span class="op" id="5016285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016289">state</span><span class="op" id="5016294">.</span><span class="ident" id="5016295">encodeUint</span><span class="op" id="5016305">(</span><span class="ident" id="5016306">ipart</span><span class="op" id="5016311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016314">}</span><br>
<span class="lineno"></span><span class="op" id="5016316">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5016319">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5016376">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5016451">func</span>&nbsp;<span class="ident" id="5016456">encUint8Array</span><span class="op" id="5016469">(</span><span class="ident" id="5016470">i</span>&nbsp;<span class="op" id="5016472">*</span><span class="ident" id="5016473">encInstr</span><span class="op" id="5016481">,</span>&nbsp;<span class="ident" id="5016483">state</span>&nbsp;<span class="op" id="5016489">*</span><span class="ident" id="5016490">encoderState</span><span class="op" id="5016502">,</span>&nbsp;<span class="ident" id="5016504">v</span>&nbsp;<span class="ident" id="5016506">reflect</span><span class="op" id="5016513">.</span><span class="ident" id="5016514">Value</span><span class="op" id="5016519">)</span>&nbsp;<span class="op" id="5016521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016524">b</span>&nbsp;<span class="op" id="5016526">:=</span>&nbsp;<span class="ident" id="5016529">v</span><span class="op" id="5016530">.</span><span class="ident" id="5016531">Bytes</span><span class="op" id="5016536">(</span><span class="op" id="5016537">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016540">if</span>&nbsp;<span class="builtinfunc" id="5016543">len</span><span class="op" id="5016546">(</span><span class="ident" id="5016547">b</span><span class="op" id="5016548">)</span>&nbsp;<span class="op" id="5016550">&gt;</span>&nbsp;<span class="num" id="5016552">0</span>&nbsp;<span class="op" id="5016554">||</span>&nbsp;<span class="ident" id="5016557">state</span><span class="op" id="5016562">.</span><span class="ident" id="5016563">sendZero</span>&nbsp;<span class="op" id="5016572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016576">state</span><span class="op" id="5016581">.</span><span class="ident" id="5016582">update</span><span class="op" id="5016588">(</span><span class="ident" id="5016589">i</span><span class="op" id="5016590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016594">state</span><span class="op" id="5016599">.</span><span class="ident" id="5016600">encodeUint</span><span class="op" id="5016610">(</span><span class="ident" id="5016611">uint64</span><span class="op" id="5016617">(</span><span class="builtinfunc" id="5016618">len</span><span class="op" id="5016621">(</span><span class="ident" id="5016622">b</span><span class="op" id="5016623">)</span><span class="op" id="5016624">)</span><span class="op" id="5016625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016629">state</span><span class="op" id="5016634">.</span><span class="ident" id="5016635">b</span><span class="op" id="5016636">.</span><span class="ident" id="5016637">Write</span><span class="op" id="5016642">(</span><span class="ident" id="5016643">b</span><span class="op" id="5016644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016647">}</span><br>
<span class="lineno">240</span><span class="op" id="5016649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5016652">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5016701">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5016772">func</span>&nbsp;<span class="ident" id="5016777">encString</span><span class="op" id="5016786">(</span><span class="ident" id="5016787">i</span>&nbsp;<span class="op" id="5016789">*</span><span class="ident" id="5016790">encInstr</span><span class="op" id="5016798">,</span>&nbsp;<span class="ident" id="5016800">state</span>&nbsp;<span class="op" id="5016806">*</span><span class="ident" id="5016807">encoderState</span><span class="op" id="5016819">,</span>&nbsp;<span class="ident" id="5016821">v</span>&nbsp;<span class="ident" id="5016823">reflect</span><span class="op" id="5016830">.</span><span class="ident" id="5016831">Value</span><span class="op" id="5016836">)</span>&nbsp;<span class="op" id="5016838">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016841">s</span>&nbsp;<span class="op" id="5016843">:=</span>&nbsp;<span class="ident" id="5016846">v</span><span class="op" id="5016847">.</span><span class="ident" id="5016848">String</span><span class="op" id="5016854">(</span><span class="op" id="5016855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016858">if</span>&nbsp;<span class="builtinfunc" id="5016861">len</span><span class="op" id="5016864">(</span><span class="ident" id="5016865">s</span><span class="op" id="5016866">)</span>&nbsp;<span class="op" id="5016868">&gt;</span>&nbsp;<span class="num" id="5016870">0</span>&nbsp;<span class="op" id="5016872">||</span>&nbsp;<span class="ident" id="5016875">state</span><span class="op" id="5016880">.</span><span class="ident" id="5016881">sendZero</span>&nbsp;<span class="op" id="5016890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016894">state</span><span class="op" id="5016899">.</span><span class="ident" id="5016900">update</span><span class="op" id="5016906">(</span><span class="ident" id="5016907">i</span><span class="op" id="5016908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016912">state</span><span class="op" id="5016917">.</span><span class="ident" id="5016918">encodeUint</span><span class="op" id="5016928">(</span><span class="ident" id="5016929">uint64</span><span class="op" id="5016935">(</span><span class="builtinfunc" id="5016936">len</span><span class="op" id="5016939">(</span><span class="ident" id="5016940">s</span><span class="op" id="5016941">)</span><span class="op" id="5016942">)</span><span class="op" id="5016943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016947">state</span><span class="op" id="5016952">.</span><span class="ident" id="5016953">b</span><span class="op" id="5016954">.</span><span class="ident" id="5016955">WriteString</span><span class="op" id="5016966">(</span><span class="ident" id="5016967">s</span><span class="op" id="5016968">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016971">}</span><br>
<span class="lineno"></span><span class="op" id="5016973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5016976">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5017036">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="5017067">func</span>&nbsp;<span class="ident" id="5017072">encStructTerminator</span><span class="op" id="5017091">(</span><span class="ident" id="5017092">i</span>&nbsp;<span class="op" id="5017094">*</span><span class="ident" id="5017095">encInstr</span><span class="op" id="5017103">,</span>&nbsp;<span class="ident" id="5017105">state</span>&nbsp;<span class="op" id="5017111">*</span><span class="ident" id="5017112">encoderState</span><span class="op" id="5017124">,</span>&nbsp;<span class="ident" id="5017126">v</span>&nbsp;<span class="ident" id="5017128">reflect</span><span class="op" id="5017135">.</span><span class="ident" id="5017136">Value</span><span class="op" id="5017141">)</span>&nbsp;<span class="op" id="5017143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017146">state</span><span class="op" id="5017151">.</span><span class="ident" id="5017152">encodeUint</span><span class="op" id="5017162">(</span><span class="num" id="5017163">0</span><span class="op" id="5017164">)</span><br>
<span class="lineno"></span><span class="op" id="5017166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5017169">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5017190">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="5017268">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5017348">type</span>&nbsp;<span class="ident" id="5017353">encEngine</span>&nbsp;<span class="keyword" id="5017363">struct</span>&nbsp;<span class="op" id="5017370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017373">instr</span>&nbsp;<span class="op" id="5017379">[</span><span class="op" id="5017380">]</span><span class="ident" id="5017381">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="5017390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5017393">const</span>&nbsp;<span class="ident" id="5017399">singletonField</span>&nbsp;<span class="op" id="5017414">=</span>&nbsp;<span class="num" id="5017416">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5017419">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="5017486">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="5017540">func</span>&nbsp;<span class="ident" id="5017545">valid</span><span class="op" id="5017550">(</span><span class="ident" id="5017551">v</span>&nbsp;<span class="ident" id="5017553">reflect</span><span class="op" id="5017560">.</span><span class="ident" id="5017561">Value</span><span class="op" id="5017566">)</span>&nbsp;<span class="builtintype" id="5017568">bool</span>&nbsp;<span class="op" id="5017573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017576">switch</span>&nbsp;<span class="ident" id="5017583">v</span><span class="op" id="5017584">.</span><span class="ident" id="5017585">Kind</span><span class="op" id="5017589">(</span><span class="op" id="5017590">)</span>&nbsp;<span class="op" id="5017592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017595">case</span>&nbsp;<span class="ident" id="5017600">reflect</span><span class="op" id="5017607">.</span><span class="ident" id="5017608">Invalid</span><span class="op" id="5017615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017619">return</span>&nbsp;<span class="builtintype" id="5017626">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017633">case</span>&nbsp;<span class="ident" id="5017638">reflect</span><span class="op" id="5017645">.</span><span class="ident" id="5017646">Ptr</span><span class="op" id="5017649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017653">return</span>&nbsp;<span class="op" id="5017660">!</span><span class="ident" id="5017661">v</span><span class="op" id="5017662">.</span><span class="ident" id="5017663">IsNil</span><span class="op" id="5017668">(</span><span class="op" id="5017669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5017672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017675">return</span>&nbsp;<span class="builtintype" id="5017682">true</span><br>
<span class="lineno"></span><span class="op" id="5017687">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5017690">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5017751">func</span>&nbsp;<span class="op" id="5017756">(</span><span class="ident" id="5017757">enc</span>&nbsp;<span class="op" id="5017761">*</span><span class="ident" id="5017762">Encoder</span><span class="op" id="5017769">)</span>&nbsp;<span class="ident" id="5017771">encodeSingle</span><span class="op" id="5017783">(</span><span class="ident" id="5017784">b</span>&nbsp;<span class="op" id="5017786">*</span><span class="ident" id="5017787">encBuffer</span><span class="op" id="5017796">,</span>&nbsp;<span class="ident" id="5017798">engine</span>&nbsp;<span class="op" id="5017805">*</span><span class="ident" id="5017806">encEngine</span><span class="op" id="5017815">,</span>&nbsp;<span class="ident" id="5017817">value</span>&nbsp;<span class="ident" id="5017823">reflect</span><span class="op" id="5017830">.</span><span class="ident" id="5017831">Value</span><span class="op" id="5017836">)</span>&nbsp;<span class="op" id="5017838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017841">state</span>&nbsp;<span class="op" id="5017847">:=</span>&nbsp;<span class="ident" id="5017850">enc</span><span class="op" id="5017853">.</span><span class="ident" id="5017854">newEncoderState</span><span class="op" id="5017869">(</span><span class="ident" id="5017870">b</span><span class="op" id="5017871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017874">defer</span>&nbsp;<span class="ident" id="5017880">enc</span><span class="op" id="5017883">.</span><span class="ident" id="5017884">freeEncoderState</span><span class="op" id="5017900">(</span><span class="ident" id="5017901">state</span><span class="op" id="5017906">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017909">state</span><span class="op" id="5017914">.</span><span class="ident" id="5017915">fieldnum</span>&nbsp;<span class="op" id="5017924">=</span>&nbsp;<span class="ident" id="5017926">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017942">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5018015">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018086">state</span><span class="op" id="5018091">.</span><span class="ident" id="5018092">sendZero</span>&nbsp;<span class="op" id="5018101">=</span>&nbsp;<span class="builtintype" id="5018103">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018109">instr</span>&nbsp;<span class="op" id="5018115">:=</span>&nbsp;<span class="op" id="5018118">&amp;</span><span class="ident" id="5018119">engine</span><span class="op" id="5018125">.</span><span class="ident" id="5018126">instr</span><span class="op" id="5018131">[</span><span class="ident" id="5018132">singletonField</span><span class="op" id="5018146">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018149">if</span>&nbsp;<span class="ident" id="5018152">instr</span><span class="op" id="5018157">.</span><span class="ident" id="5018158">indir</span>&nbsp;<span class="op" id="5018164">&gt;</span>&nbsp;<span class="num" id="5018166">0</span>&nbsp;<span class="op" id="5018168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018172">value</span>&nbsp;<span class="op" id="5018178">=</span>&nbsp;<span class="ident" id="5018180">encIndirect</span><span class="op" id="5018191">(</span><span class="ident" id="5018192">value</span><span class="op" id="5018197">,</span>&nbsp;<span class="ident" id="5018199">instr</span><span class="op" id="5018204">.</span><span class="ident" id="5018205">indir</span><span class="op" id="5018210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018216">if</span>&nbsp;<span class="ident" id="5018219">valid</span><span class="op" id="5018224">(</span><span class="ident" id="5018225">value</span><span class="op" id="5018230">)</span>&nbsp;<span class="op" id="5018232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018236">instr</span><span class="op" id="5018241">.</span><span class="ident" id="5018242">op</span><span class="op" id="5018244">(</span><span class="ident" id="5018245">instr</span><span class="op" id="5018250">,</span>&nbsp;<span class="ident" id="5018252">state</span><span class="op" id="5018257">,</span>&nbsp;<span class="ident" id="5018259">value</span><span class="op" id="5018264">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018267">}</span><br>
<span class="lineno"></span><span class="op" id="5018269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5018272">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5018319">func</span>&nbsp;<span class="op" id="5018324">(</span><span class="ident" id="5018325">enc</span>&nbsp;<span class="op" id="5018329">*</span><span class="ident" id="5018330">Encoder</span><span class="op" id="5018337">)</span>&nbsp;<span class="ident" id="5018339">encodeStruct</span><span class="op" id="5018351">(</span><span class="ident" id="5018352">b</span>&nbsp;<span class="op" id="5018354">*</span><span class="ident" id="5018355">encBuffer</span><span class="op" id="5018364">,</span>&nbsp;<span class="ident" id="5018366">engine</span>&nbsp;<span class="op" id="5018373">*</span><span class="ident" id="5018374">encEngine</span><span class="op" id="5018383">,</span>&nbsp;<span class="ident" id="5018385">value</span>&nbsp;<span class="ident" id="5018391">reflect</span><span class="op" id="5018398">.</span><span class="ident" id="5018399">Value</span><span class="op" id="5018404">)</span>&nbsp;<span class="op" id="5018406">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018409">if</span>&nbsp;<span class="op" id="5018412">!</span><span class="ident" id="5018413">valid</span><span class="op" id="5018418">(</span><span class="ident" id="5018419">value</span><span class="op" id="5018424">)</span>&nbsp;<span class="op" id="5018426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018430">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018441">state</span>&nbsp;<span class="op" id="5018447">:=</span>&nbsp;<span class="ident" id="5018450">enc</span><span class="op" id="5018453">.</span><span class="ident" id="5018454">newEncoderState</span><span class="op" id="5018469">(</span><span class="ident" id="5018470">b</span><span class="op" id="5018471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018474">defer</span>&nbsp;<span class="ident" id="5018480">enc</span><span class="op" id="5018483">.</span><span class="ident" id="5018484">freeEncoderState</span><span class="op" id="5018500">(</span><span class="ident" id="5018501">state</span><span class="op" id="5018506">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018509">state</span><span class="op" id="5018514">.</span><span class="ident" id="5018515">fieldnum</span>&nbsp;<span class="op" id="5018524">=</span>&nbsp;<span class="op" id="5018526">-</span><span class="num" id="5018527">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018530">for</span>&nbsp;<span class="ident" id="5018534">i</span>&nbsp;<span class="op" id="5018536">:=</span>&nbsp;<span class="num" id="5018539">0</span><span class="op" id="5018540">;</span>&nbsp;<span class="ident" id="5018542">i</span>&nbsp;<span class="op" id="5018544">&lt;</span>&nbsp;<span class="builtinfunc" id="5018546">len</span><span class="op" id="5018549">(</span><span class="ident" id="5018550">engine</span><span class="op" id="5018556">.</span><span class="ident" id="5018557">instr</span><span class="op" id="5018562">)</span><span class="op" id="5018563">;</span>&nbsp;<span class="ident" id="5018565">i</span><span class="op" id="5018566">++</span>&nbsp;<span class="op" id="5018569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018573">instr</span>&nbsp;<span class="op" id="5018579">:=</span>&nbsp;<span class="op" id="5018582">&amp;</span><span class="ident" id="5018583">engine</span><span class="op" id="5018589">.</span><span class="ident" id="5018590">instr</span><span class="op" id="5018595">[</span><span class="ident" id="5018596">i</span><span class="op" id="5018597">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018601">if</span>&nbsp;<span class="ident" id="5018604">i</span>&nbsp;<span class="op" id="5018606">&gt;=</span>&nbsp;<span class="ident" id="5018609">value</span><span class="op" id="5018614">.</span><span class="ident" id="5018615">NumField</span><span class="op" id="5018623">(</span><span class="op" id="5018624">)</span>&nbsp;<span class="op" id="5018626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5018631">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018657">instr</span><span class="op" id="5018662">.</span><span class="ident" id="5018663">op</span><span class="op" id="5018665">(</span><span class="ident" id="5018666">instr</span><span class="op" id="5018671">,</span>&nbsp;<span class="ident" id="5018673">state</span><span class="op" id="5018678">,</span>&nbsp;<span class="ident" id="5018680">reflect</span><span class="op" id="5018687">.</span><span class="ident" id="5018688">Value</span><span class="op" id="5018693">{</span><span class="op" id="5018694">}</span><span class="op" id="5018695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018700">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018712">field</span>&nbsp;<span class="op" id="5018718">:=</span>&nbsp;<span class="ident" id="5018721">value</span><span class="op" id="5018726">.</span><span class="ident" id="5018727">FieldByIndex</span><span class="op" id="5018739">(</span><span class="ident" id="5018740">instr</span><span class="op" id="5018745">.</span><span class="ident" id="5018746">index</span><span class="op" id="5018751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018755">if</span>&nbsp;<span class="ident" id="5018758">instr</span><span class="op" id="5018763">.</span><span class="ident" id="5018764">indir</span>&nbsp;<span class="op" id="5018770">&gt;</span>&nbsp;<span class="num" id="5018772">0</span>&nbsp;<span class="op" id="5018774">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018779">field</span>&nbsp;<span class="op" id="5018785">=</span>&nbsp;<span class="ident" id="5018787">encIndirect</span><span class="op" id="5018798">(</span><span class="ident" id="5018799">field</span><span class="op" id="5018804">,</span>&nbsp;<span class="ident" id="5018806">instr</span><span class="op" id="5018811">.</span><span class="ident" id="5018812">indir</span><span class="op" id="5018817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5018822">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018894">if</span>&nbsp;<span class="op" id="5018897">!</span><span class="ident" id="5018898">valid</span><span class="op" id="5018903">(</span><span class="ident" id="5018904">field</span><span class="op" id="5018909">)</span>&nbsp;<span class="op" id="5018911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018917">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018929">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018937">instr</span><span class="op" id="5018942">.</span><span class="ident" id="5018943">op</span><span class="op" id="5018945">(</span><span class="ident" id="5018946">instr</span><span class="op" id="5018951">,</span>&nbsp;<span class="ident" id="5018953">state</span><span class="op" id="5018958">,</span>&nbsp;<span class="ident" id="5018960">field</span><span class="op" id="5018965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018968">}</span><br>
<span class="lineno"></span><span class="op" id="5018970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="5018973">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5019006">func</span>&nbsp;<span class="op" id="5019011">(</span><span class="ident" id="5019012">enc</span>&nbsp;<span class="op" id="5019016">*</span><span class="ident" id="5019017">Encoder</span><span class="op" id="5019024">)</span>&nbsp;<span class="ident" id="5019026">encodeArray</span><span class="op" id="5019037">(</span><span class="ident" id="5019038">b</span>&nbsp;<span class="op" id="5019040">*</span><span class="ident" id="5019041">encBuffer</span><span class="op" id="5019050">,</span>&nbsp;<span class="ident" id="5019052">value</span>&nbsp;<span class="ident" id="5019058">reflect</span><span class="op" id="5019065">.</span><span class="ident" id="5019066">Value</span><span class="op" id="5019071">,</span>&nbsp;<span class="ident" id="5019073">op</span>&nbsp;<span class="ident" id="5019076">encOp</span><span class="op" id="5019081">,</span>&nbsp;<span class="ident" id="5019083">elemIndir</span>&nbsp;<span class="builtintype" id="5019093">int</span><span class="op" id="5019096">,</span>&nbsp;<span class="ident" id="5019098">length</span>&nbsp;<span class="builtintype" id="5019105">int</span><span class="op" id="5019108">,</span>&nbsp;<span class="ident" id="5019110">helper</span>&nbsp;<span class="ident" id="5019117">encHelper</span><span class="op" id="5019126">)</span>&nbsp;<span class="op" id="5019128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019131">state</span>&nbsp;<span class="op" id="5019137">:=</span>&nbsp;<span class="ident" id="5019140">enc</span><span class="op" id="5019143">.</span><span class="ident" id="5019144">newEncoderState</span><span class="op" id="5019159">(</span><span class="ident" id="5019160">b</span><span class="op" id="5019161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019164">defer</span>&nbsp;<span class="ident" id="5019170">enc</span><span class="op" id="5019173">.</span><span class="ident" id="5019174">freeEncoderState</span><span class="op" id="5019190">(</span><span class="ident" id="5019191">state</span><span class="op" id="5019196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019199">state</span><span class="op" id="5019204">.</span><span class="ident" id="5019205">fieldnum</span>&nbsp;<span class="op" id="5019214">=</span>&nbsp;<span class="op" id="5019216">-</span><span class="num" id="5019217">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019220">state</span><span class="op" id="5019225">.</span><span class="ident" id="5019226">sendZero</span>&nbsp;<span class="op" id="5019235">=</span>&nbsp;<span class="builtintype" id="5019237">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019243">state</span><span class="op" id="5019248">.</span><span class="ident" id="5019249">encodeUint</span><span class="op" id="5019259">(</span><span class="ident" id="5019260">uint64</span><span class="op" id="5019266">(</span><span class="ident" id="5019267">length</span><span class="op" id="5019273">)</span><span class="op" id="5019274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019277">if</span>&nbsp;<span class="ident" id="5019280">helper</span>&nbsp;<span class="op" id="5019287">!=</span>&nbsp;<span class="ident" id="5019290">nil</span>&nbsp;<span class="op" id="5019294">&amp;&amp;</span>&nbsp;<span class="ident" id="5019297">helper</span><span class="op" id="5019303">(</span><span class="ident" id="5019304">state</span><span class="op" id="5019309">,</span>&nbsp;<span class="ident" id="5019311">value</span><span class="op" id="5019316">)</span>&nbsp;<span class="op" id="5019318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019322">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019330">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019333">for</span>&nbsp;<span class="ident" id="5019337">i</span>&nbsp;<span class="op" id="5019339">:=</span>&nbsp;<span class="num" id="5019342">0</span><span class="op" id="5019343">;</span>&nbsp;<span class="ident" id="5019345">i</span>&nbsp;<span class="op" id="5019347">&lt;</span>&nbsp;<span class="ident" id="5019349">length</span><span class="op" id="5019355">;</span>&nbsp;<span class="ident" id="5019357">i</span><span class="op" id="5019358">++</span>&nbsp;<span class="op" id="5019361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019365">elem</span>&nbsp;<span class="op" id="5019370">:=</span>&nbsp;<span class="ident" id="5019373">value</span><span class="op" id="5019378">.</span><span class="ident" id="5019379">Index</span><span class="op" id="5019384">(</span><span class="ident" id="5019385">i</span><span class="op" id="5019386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019390">if</span>&nbsp;<span class="ident" id="5019393">elemIndir</span>&nbsp;<span class="op" id="5019403">&gt;</span>&nbsp;<span class="num" id="5019405">0</span>&nbsp;<span class="op" id="5019407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019412">elem</span>&nbsp;<span class="op" id="5019417">=</span>&nbsp;<span class="ident" id="5019419">encIndirect</span><span class="op" id="5019430">(</span><span class="ident" id="5019431">elem</span><span class="op" id="5019435">,</span>&nbsp;<span class="ident" id="5019437">elemIndir</span><span class="op" id="5019446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5019451">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019522">if</span>&nbsp;<span class="op" id="5019525">!</span><span class="ident" id="5019526">valid</span><span class="op" id="5019531">(</span><span class="ident" id="5019532">elem</span><span class="op" id="5019536">)</span>&nbsp;<span class="op" id="5019538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019544">errorf</span><span class="op" id="5019550">(</span><span class="string" id="5019551">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5019577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019590">op</span><span class="op" id="5019592">(</span><span class="ident" id="5019593">nil</span><span class="op" id="5019596">,</span>&nbsp;<span class="ident" id="5019598">state</span><span class="op" id="5019603">,</span>&nbsp;<span class="ident" id="5019605">elem</span><span class="op" id="5019609">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019612">}</span><br>
<span class="lineno"></span><span class="op" id="5019614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5019617">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5019685">func</span>&nbsp;<span class="ident" id="5019690">encodeReflectValue</span><span class="op" id="5019708">(</span><span class="ident" id="5019709">state</span>&nbsp;<span class="op" id="5019715">*</span><span class="ident" id="5019716">encoderState</span><span class="op" id="5019728">,</span>&nbsp;<span class="ident" id="5019730">v</span>&nbsp;<span class="ident" id="5019732">reflect</span><span class="op" id="5019739">.</span><span class="ident" id="5019740">Value</span><span class="op" id="5019745">,</span>&nbsp;<span class="ident" id="5019747">op</span>&nbsp;<span class="ident" id="5019750">encOp</span><span class="op" id="5019755">,</span>&nbsp;<span class="ident" id="5019757">indir</span>&nbsp;<span class="builtintype" id="5019763">int</span><span class="op" id="5019766">)</span>&nbsp;<span class="op" id="5019768">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019771">for</span>&nbsp;<span class="ident" id="5019775">i</span>&nbsp;<span class="op" id="5019777">:=</span>&nbsp;<span class="num" id="5019780">0</span><span class="op" id="5019781">;</span>&nbsp;<span class="ident" id="5019783">i</span>&nbsp;<span class="op" id="5019785">&lt;</span>&nbsp;<span class="ident" id="5019787">indir</span>&nbsp;<span class="op" id="5019793">&amp;&amp;</span>&nbsp;<span class="ident" id="5019796">v</span><span class="op" id="5019797">.</span><span class="ident" id="5019798">IsValid</span><span class="op" id="5019805">(</span><span class="op" id="5019806">)</span><span class="op" id="5019807">;</span>&nbsp;<span class="ident" id="5019809">i</span><span class="op" id="5019810">++</span>&nbsp;<span class="op" id="5019813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019817">v</span>&nbsp;<span class="op" id="5019819">=</span>&nbsp;<span class="ident" id="5019821">reflect</span><span class="op" id="5019828">.</span><span class="ident" id="5019829">Indirect</span><span class="op" id="5019837">(</span><span class="ident" id="5019838">v</span><span class="op" id="5019839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019845">if</span>&nbsp;<span class="op" id="5019848">!</span><span class="ident" id="5019849">v</span><span class="op" id="5019850">.</span><span class="ident" id="5019851">IsValid</span><span class="op" id="5019858">(</span><span class="op" id="5019859">)</span>&nbsp;<span class="op" id="5019861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019865">errorf</span><span class="op" id="5019871">(</span><span class="string" id="5019872">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5019905">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019911">op</span><span class="op" id="5019913">(</span><span class="ident" id="5019914">nil</span><span class="op" id="5019917">,</span>&nbsp;<span class="ident" id="5019919">state</span><span class="op" id="5019924">,</span>&nbsp;<span class="ident" id="5019926">v</span><span class="op" id="5019927">)</span><br>
<span class="lineno"></span><span class="op" id="5019929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5019932">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="5020006">func</span>&nbsp;<span class="op" id="5020011">(</span><span class="ident" id="5020012">enc</span>&nbsp;<span class="op" id="5020016">*</span><span class="ident" id="5020017">Encoder</span><span class="op" id="5020024">)</span>&nbsp;<span class="ident" id="5020026">encodeMap</span><span class="op" id="5020035">(</span><span class="ident" id="5020036">b</span>&nbsp;<span class="op" id="5020038">*</span><span class="ident" id="5020039">encBuffer</span><span class="op" id="5020048">,</span>&nbsp;<span class="ident" id="5020050">mv</span>&nbsp;<span class="ident" id="5020053">reflect</span><span class="op" id="5020060">.</span><span class="ident" id="5020061">Value</span><span class="op" id="5020066">,</span>&nbsp;<span class="ident" id="5020068">keyOp</span><span class="op" id="5020073">,</span>&nbsp;<span class="ident" id="5020075">elemOp</span>&nbsp;<span class="ident" id="5020082">encOp</span><span class="op" id="5020087">,</span>&nbsp;<span class="ident" id="5020089">keyIndir</span><span class="op" id="5020097">,</span>&nbsp;<span class="ident" id="5020099">elemIndir</span>&nbsp;<span class="builtintype" id="5020109">int</span><span class="op" id="5020112">)</span>&nbsp;<span class="op" id="5020114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020117">state</span>&nbsp;<span class="op" id="5020123">:=</span>&nbsp;<span class="ident" id="5020126">enc</span><span class="op" id="5020129">.</span><span class="ident" id="5020130">newEncoderState</span><span class="op" id="5020145">(</span><span class="ident" id="5020146">b</span><span class="op" id="5020147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020150">state</span><span class="op" id="5020155">.</span><span class="ident" id="5020156">fieldnum</span>&nbsp;<span class="op" id="5020165">=</span>&nbsp;<span class="op" id="5020167">-</span><span class="num" id="5020168">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020171">state</span><span class="op" id="5020176">.</span><span class="ident" id="5020177">sendZero</span>&nbsp;<span class="op" id="5020186">=</span>&nbsp;<span class="builtintype" id="5020188">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020194">keys</span>&nbsp;<span class="op" id="5020199">:=</span>&nbsp;<span class="ident" id="5020202">mv</span><span class="op" id="5020204">.</span><span class="ident" id="5020205">MapKeys</span><span class="op" id="5020212">(</span><span class="op" id="5020213">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020216">state</span><span class="op" id="5020221">.</span><span class="ident" id="5020222">encodeUint</span><span class="op" id="5020232">(</span><span class="ident" id="5020233">uint64</span><span class="op" id="5020239">(</span><span class="builtinfunc" id="5020240">len</span><span class="op" id="5020243">(</span><span class="ident" id="5020244">keys</span><span class="op" id="5020248">)</span><span class="op" id="5020249">)</span><span class="op" id="5020250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020253">for</span>&nbsp;<span class="ident" id="5020257">_</span><span class="op" id="5020258">,</span>&nbsp;<span class="ident" id="5020260">key</span>&nbsp;<span class="op" id="5020264">:=</span>&nbsp;<span class="keyword" id="5020267">range</span>&nbsp;<span class="ident" id="5020273">keys</span>&nbsp;<span class="op" id="5020278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020282">encodeReflectValue</span><span class="op" id="5020300">(</span><span class="ident" id="5020301">state</span><span class="op" id="5020306">,</span>&nbsp;<span class="ident" id="5020308">key</span><span class="op" id="5020311">,</span>&nbsp;<span class="ident" id="5020313">keyOp</span><span class="op" id="5020318">,</span>&nbsp;<span class="ident" id="5020320">keyIndir</span><span class="op" id="5020328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020332">encodeReflectValue</span><span class="op" id="5020350">(</span><span class="ident" id="5020351">state</span><span class="op" id="5020356">,</span>&nbsp;<span class="ident" id="5020358">mv</span><span class="op" id="5020360">.</span><span class="ident" id="5020361">MapIndex</span><span class="op" id="5020369">(</span><span class="ident" id="5020370">key</span><span class="op" id="5020373">)</span><span class="op" id="5020374">,</span>&nbsp;<span class="ident" id="5020376">elemOp</span><span class="op" id="5020382">,</span>&nbsp;<span class="ident" id="5020384">elemIndir</span><span class="op" id="5020393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020396">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020399">enc</span><span class="op" id="5020402">.</span><span class="ident" id="5020403">freeEncoderState</span><span class="op" id="5020419">(</span><span class="ident" id="5020420">state</span><span class="op" id="5020425">)</span><br>
<span class="lineno"></span><span class="op" id="5020427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5020430">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="5020481">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="5020563">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="5020650">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="5020733">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5020758">func</span>&nbsp;<span class="op" id="5020763">(</span><span class="ident" id="5020764">enc</span>&nbsp;<span class="op" id="5020768">*</span><span class="ident" id="5020769">Encoder</span><span class="op" id="5020776">)</span>&nbsp;<span class="ident" id="5020778">encodeInterface</span><span class="op" id="5020793">(</span><span class="ident" id="5020794">b</span>&nbsp;<span class="op" id="5020796">*</span><span class="ident" id="5020797">encBuffer</span><span class="op" id="5020806">,</span>&nbsp;<span class="ident" id="5020808">iv</span>&nbsp;<span class="ident" id="5020811">reflect</span><span class="op" id="5020818">.</span><span class="ident" id="5020819">Value</span><span class="op" id="5020824">)</span>&nbsp;<span class="op" id="5020826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5020829">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5020894">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020965">elem</span>&nbsp;<span class="op" id="5020970">:=</span>&nbsp;<span class="ident" id="5020973">iv</span><span class="op" id="5020975">.</span><span class="ident" id="5020976">Elem</span><span class="op" id="5020980">(</span><span class="op" id="5020981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020984">if</span>&nbsp;<span class="ident" id="5020987">elem</span><span class="op" id="5020991">.</span><span class="ident" id="5020992">Kind</span><span class="op" id="5020996">(</span><span class="op" id="5020997">)</span>&nbsp;<span class="op" id="5020999">==</span>&nbsp;<span class="ident" id="5021002">reflect</span><span class="op" id="5021009">.</span><span class="ident" id="5021010">Ptr</span>&nbsp;<span class="op" id="5021014">&amp;&amp;</span>&nbsp;<span class="ident" id="5021017">elem</span><span class="op" id="5021021">.</span><span class="ident" id="5021022">IsNil</span><span class="op" id="5021027">(</span><span class="op" id="5021028">)</span>&nbsp;<span class="op" id="5021030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021034">errorf</span><span class="op" id="5021040">(</span><span class="string" id="5021041">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="5021101">,</span>&nbsp;<span class="ident" id="5021103">iv</span><span class="op" id="5021105">.</span><span class="ident" id="5021106">Elem</span><span class="op" id="5021110">(</span><span class="op" id="5021111">)</span><span class="op" id="5021112">.</span><span class="ident" id="5021113">Type</span><span class="op" id="5021117">(</span><span class="op" id="5021118">)</span><span class="op" id="5021119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021122">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021125">state</span>&nbsp;<span class="op" id="5021131">:=</span>&nbsp;<span class="ident" id="5021134">enc</span><span class="op" id="5021137">.</span><span class="ident" id="5021138">newEncoderState</span><span class="op" id="5021153">(</span><span class="ident" id="5021154">b</span><span class="op" id="5021155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021158">state</span><span class="op" id="5021163">.</span><span class="ident" id="5021164">fieldnum</span>&nbsp;<span class="op" id="5021173">=</span>&nbsp;<span class="op" id="5021175">-</span><span class="num" id="5021176">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021179">state</span><span class="op" id="5021184">.</span><span class="ident" id="5021185">sendZero</span>&nbsp;<span class="op" id="5021194">=</span>&nbsp;<span class="builtintype" id="5021196">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021202">if</span>&nbsp;<span class="ident" id="5021205">iv</span><span class="op" id="5021207">.</span><span class="ident" id="5021208">IsNil</span><span class="op" id="5021213">(</span><span class="op" id="5021214">)</span>&nbsp;<span class="op" id="5021216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021220">state</span><span class="op" id="5021225">.</span><span class="ident" id="5021226">encodeUint</span><span class="op" id="5021236">(</span><span class="num" id="5021237">0</span><span class="op" id="5021238">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021242">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021254">ut</span>&nbsp;<span class="op" id="5021257">:=</span>&nbsp;<span class="ident" id="5021260">userType</span><span class="op" id="5021268">(</span><span class="ident" id="5021269">iv</span><span class="op" id="5021271">.</span><span class="ident" id="5021272">Elem</span><span class="op" id="5021276">(</span><span class="op" id="5021277">)</span><span class="op" id="5021278">.</span><span class="ident" id="5021279">Type</span><span class="op" id="5021283">(</span><span class="op" id="5021284">)</span><span class="op" id="5021285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021288">registerLock</span><span class="op" id="5021300">.</span><span class="ident" id="5021301">RLock</span><span class="op" id="5021306">(</span><span class="op" id="5021307">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021310">name</span><span class="op" id="5021314">,</span>&nbsp;<span class="ident" id="5021316">ok</span>&nbsp;<span class="op" id="5021319">:=</span>&nbsp;<span class="ident" id="5021322">concreteTypeToName</span><span class="op" id="5021340">[</span><span class="ident" id="5021341">ut</span><span class="op" id="5021343">.</span><span class="ident" id="5021344">base</span><span class="op" id="5021348">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021351">registerLock</span><span class="op" id="5021363">.</span><span class="ident" id="5021364">RUnlock</span><span class="op" id="5021371">(</span><span class="op" id="5021372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021375">if</span>&nbsp;<span class="op" id="5021378">!</span><span class="ident" id="5021379">ok</span>&nbsp;<span class="op" id="5021382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021386">errorf</span><span class="op" id="5021392">(</span><span class="string" id="5021393">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="5021432">,</span>&nbsp;<span class="ident" id="5021434">ut</span><span class="op" id="5021436">.</span><span class="ident" id="5021437">base</span><span class="op" id="5021441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021444">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021447">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021466">state</span><span class="op" id="5021471">.</span><span class="ident" id="5021472">encodeUint</span><span class="op" id="5021482">(</span><span class="ident" id="5021483">uint64</span><span class="op" id="5021489">(</span><span class="builtinfunc" id="5021490">len</span><span class="op" id="5021493">(</span><span class="ident" id="5021494">name</span><span class="op" id="5021498">)</span><span class="op" id="5021499">)</span><span class="op" id="5021500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021503">state</span><span class="op" id="5021508">.</span><span class="ident" id="5021509">b</span><span class="op" id="5021510">.</span><span class="ident" id="5021511">WriteString</span><span class="op" id="5021522">(</span><span class="ident" id="5021523">name</span><span class="op" id="5021527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021530">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021567">enc</span><span class="op" id="5021570">.</span><span class="ident" id="5021571">sendTypeDescriptor</span><span class="op" id="5021589">(</span><span class="ident" id="5021590">enc</span><span class="op" id="5021593">.</span><span class="ident" id="5021594">writer</span><span class="op" id="5021600">(</span><span class="op" id="5021601">)</span><span class="op" id="5021602">,</span>&nbsp;<span class="ident" id="5021604">state</span><span class="op" id="5021609">,</span>&nbsp;<span class="ident" id="5021611">ut</span><span class="op" id="5021613">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021616">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021638">enc</span><span class="op" id="5021641">.</span><span class="ident" id="5021642">sendTypeId</span><span class="op" id="5021652">(</span><span class="ident" id="5021653">state</span><span class="op" id="5021658">,</span>&nbsp;<span class="ident" id="5021660">ut</span><span class="op" id="5021662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021665">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021734">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021788">enc</span><span class="op" id="5021791">.</span><span class="ident" id="5021792">pushWriter</span><span class="op" id="5021802">(</span><span class="ident" id="5021803">b</span><span class="op" id="5021804">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021807">data</span>&nbsp;<span class="op" id="5021812">:=</span>&nbsp;<span class="builtinfunc" id="5021815">new</span><span class="op" id="5021818">(</span><span class="ident" id="5021819">encBuffer</span><span class="op" id="5021828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021831">data</span><span class="op" id="5021835">.</span><span class="ident" id="5021836">Write</span><span class="op" id="5021841">(</span><span class="ident" id="5021842">spaceForLength</span><span class="op" id="5021856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021859">enc</span><span class="op" id="5021862">.</span><span class="ident" id="5021863">encode</span><span class="op" id="5021869">(</span><span class="ident" id="5021870">data</span><span class="op" id="5021874">,</span>&nbsp;<span class="ident" id="5021876">elem</span><span class="op" id="5021880">,</span>&nbsp;<span class="ident" id="5021882">ut</span><span class="op" id="5021884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021887">if</span>&nbsp;<span class="ident" id="5021890">enc</span><span class="op" id="5021893">.</span><span class="ident" id="5021894">err</span>&nbsp;<span class="op" id="5021898">!=</span>&nbsp;<span class="ident" id="5021901">nil</span>&nbsp;<span class="op" id="5021905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021909">error_</span><span class="op" id="5021915">(</span><span class="ident" id="5021916">enc</span><span class="op" id="5021919">.</span><span class="ident" id="5021920">err</span><span class="op" id="5021923">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021929">enc</span><span class="op" id="5021932">.</span><span class="ident" id="5021933">popWriter</span><span class="op" id="5021942">(</span><span class="op" id="5021943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021946">enc</span><span class="op" id="5021949">.</span><span class="ident" id="5021950">writeMessage</span><span class="op" id="5021962">(</span><span class="ident" id="5021963">b</span><span class="op" id="5021964">,</span>&nbsp;<span class="ident" id="5021966">data</span><span class="op" id="5021970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021973">if</span>&nbsp;<span class="ident" id="5021976">enc</span><span class="op" id="5021979">.</span><span class="ident" id="5021980">err</span>&nbsp;<span class="op" id="5021984">!=</span>&nbsp;<span class="ident" id="5021987">nil</span>&nbsp;<span class="op" id="5021991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021995">error_</span><span class="op" id="5022001">(</span><span class="ident" id="5022002">enc</span><span class="op" id="5022005">.</span><span class="ident" id="5022006">err</span><span class="op" id="5022009">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5022012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022015">enc</span><span class="op" id="5022018">.</span><span class="ident" id="5022019">freeEncoderState</span><span class="op" id="5022035">(</span><span class="ident" id="5022036">state</span><span class="op" id="5022041">)</span><br>
<span class="lineno"></span><span class="op" id="5022043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5022046">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="5022107">func</span>&nbsp;<span class="ident" id="5022112">isZero</span><span class="op" id="5022118">(</span><span class="ident" id="5022119">val</span>&nbsp;<span class="ident" id="5022123">reflect</span><span class="op" id="5022130">.</span><span class="ident" id="5022131">Value</span><span class="op" id="5022136">)</span>&nbsp;<span class="builtintype" id="5022138">bool</span>&nbsp;<span class="op" id="5022143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022146">switch</span>&nbsp;<span class="ident" id="5022153">val</span><span class="op" id="5022156">.</span><span class="ident" id="5022157">Kind</span><span class="op" id="5022161">(</span><span class="op" id="5022162">)</span>&nbsp;<span class="op" id="5022164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022167">case</span>&nbsp;<span class="ident" id="5022172">reflect</span><span class="op" id="5022179">.</span><span class="ident" id="5022180">Array</span><span class="op" id="5022185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022189">for</span>&nbsp;<span class="ident" id="5022193">i</span>&nbsp;<span class="op" id="5022195">:=</span>&nbsp;<span class="num" id="5022198">0</span><span class="op" id="5022199">;</span>&nbsp;<span class="ident" id="5022201">i</span>&nbsp;<span class="op" id="5022203">&lt;</span>&nbsp;<span class="ident" id="5022205">val</span><span class="op" id="5022208">.</span><span class="ident" id="5022209">Len</span><span class="op" id="5022212">(</span><span class="op" id="5022213">)</span><span class="op" id="5022214">;</span>&nbsp;<span class="ident" id="5022216">i</span><span class="op" id="5022217">++</span>&nbsp;<span class="op" id="5022220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022225">if</span>&nbsp;<span class="op" id="5022228">!</span><span class="ident" id="5022229">isZero</span><span class="op" id="5022235">(</span><span class="ident" id="5022236">val</span><span class="op" id="5022239">.</span><span class="ident" id="5022240">Index</span><span class="op" id="5022245">(</span><span class="ident" id="5022246">i</span><span class="op" id="5022247">)</span><span class="op" id="5022248">)</span>&nbsp;<span class="op" id="5022250">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022256">return</span>&nbsp;<span class="builtintype" id="5022263">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5022272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5022276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022280">return</span>&nbsp;<span class="builtintype" id="5022287">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022293">case</span>&nbsp;<span class="ident" id="5022298">reflect</span><span class="op" id="5022305">.</span><span class="ident" id="5022306">Map</span><span class="op" id="5022309">,</span>&nbsp;<span class="ident" id="5022311">reflect</span><span class="op" id="5022318">.</span><span class="ident" id="5022319">Slice</span><span class="op" id="5022324">,</span>&nbsp;<span class="ident" id="5022326">reflect</span><span class="op" id="5022333">.</span><span class="ident" id="5022334">String</span><span class="op" id="5022340">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022344">return</span>&nbsp;<span class="ident" id="5022351">val</span><span class="op" id="5022354">.</span><span class="ident" id="5022355">Len</span><span class="op" id="5022358">(</span><span class="op" id="5022359">)</span>&nbsp;<span class="op" id="5022361">==</span>&nbsp;<span class="num" id="5022364">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022367">case</span>&nbsp;<span class="ident" id="5022372">reflect</span><span class="op" id="5022379">.</span><span class="ident" id="5022380">Bool</span><span class="op" id="5022384">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022388">return</span>&nbsp;<span class="op" id="5022395">!</span><span class="ident" id="5022396">val</span><span class="op" id="5022399">.</span><span class="ident" id="5022400">Bool</span><span class="op" id="5022404">(</span><span class="op" id="5022405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022408">case</span>&nbsp;<span class="ident" id="5022413">reflect</span><span class="op" id="5022420">.</span><span class="ident" id="5022421">Complex64</span><span class="op" id="5022430">,</span>&nbsp;<span class="ident" id="5022432">reflect</span><span class="op" id="5022439">.</span><span class="ident" id="5022440">Complex128</span><span class="op" id="5022450">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022454">return</span>&nbsp;<span class="ident" id="5022461">val</span><span class="op" id="5022464">.</span><span class="ident" id="5022465">Complex</span><span class="op" id="5022472">(</span><span class="op" id="5022473">)</span>&nbsp;<span class="op" id="5022475">==</span>&nbsp;<span class="num" id="5022478">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022481">case</span>&nbsp;<span class="ident" id="5022486">reflect</span><span class="op" id="5022493">.</span><span class="ident" id="5022494">Chan</span><span class="op" id="5022498">,</span>&nbsp;<span class="ident" id="5022500">reflect</span><span class="op" id="5022507">.</span><span class="ident" id="5022508">Func</span><span class="op" id="5022512">,</span>&nbsp;<span class="ident" id="5022514">reflect</span><span class="op" id="5022521">.</span><span class="ident" id="5022522">Interface</span><span class="op" id="5022531">,</span>&nbsp;<span class="ident" id="5022533">reflect</span><span class="op" id="5022540">.</span><span class="ident" id="5022541">Ptr</span><span class="op" id="5022544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022548">return</span>&nbsp;<span class="ident" id="5022555">val</span><span class="op" id="5022558">.</span><span class="ident" id="5022559">IsNil</span><span class="op" id="5022564">(</span><span class="op" id="5022565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022568">case</span>&nbsp;<span class="ident" id="5022573">reflect</span><span class="op" id="5022580">.</span><span class="ident" id="5022581">Int</span><span class="op" id="5022584">,</span>&nbsp;<span class="ident" id="5022586">reflect</span><span class="op" id="5022593">.</span><span class="ident" id="5022594">Int8</span><span class="op" id="5022598">,</span>&nbsp;<span class="ident" id="5022600">reflect</span><span class="op" id="5022607">.</span><span class="ident" id="5022608">Int16</span><span class="op" id="5022613">,</span>&nbsp;<span class="ident" id="5022615">reflect</span><span class="op" id="5022622">.</span><span class="ident" id="5022623">Int32</span><span class="op" id="5022628">,</span>&nbsp;<span class="ident" id="5022630">reflect</span><span class="op" id="5022637">.</span><span class="ident" id="5022638">Int64</span><span class="op" id="5022643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022647">return</span>&nbsp;<span class="ident" id="5022654">val</span><span class="op" id="5022657">.</span><span class="ident" id="5022658">Int</span><span class="op" id="5022661">(</span><span class="op" id="5022662">)</span>&nbsp;<span class="op" id="5022664">==</span>&nbsp;<span class="num" id="5022667">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022670">case</span>&nbsp;<span class="ident" id="5022675">reflect</span><span class="op" id="5022682">.</span><span class="ident" id="5022683">Float32</span><span class="op" id="5022690">,</span>&nbsp;<span class="ident" id="5022692">reflect</span><span class="op" id="5022699">.</span><span class="ident" id="5022700">Float64</span><span class="op" id="5022707">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022711">return</span>&nbsp;<span class="ident" id="5022718">val</span><span class="op" id="5022721">.</span><span class="ident" id="5022722">Float</span><span class="op" id="5022727">(</span><span class="op" id="5022728">)</span>&nbsp;<span class="op" id="5022730">==</span>&nbsp;<span class="num" id="5022733">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022736">case</span>&nbsp;<span class="ident" id="5022741">reflect</span><span class="op" id="5022748">.</span><span class="ident" id="5022749">Uint</span><span class="op" id="5022753">,</span>&nbsp;<span class="ident" id="5022755">reflect</span><span class="op" id="5022762">.</span><span class="ident" id="5022763">Uint8</span><span class="op" id="5022768">,</span>&nbsp;<span class="ident" id="5022770">reflect</span><span class="op" id="5022777">.</span><span class="ident" id="5022778">Uint16</span><span class="op" id="5022784">,</span>&nbsp;<span class="ident" id="5022786">reflect</span><span class="op" id="5022793">.</span><span class="ident" id="5022794">Uint32</span><span class="op" id="5022800">,</span>&nbsp;<span class="ident" id="5022802">reflect</span><span class="op" id="5022809">.</span><span class="ident" id="5022810">Uint64</span><span class="op" id="5022816">,</span>&nbsp;<span class="ident" id="5022818">reflect</span><span class="op" id="5022825">.</span><span class="ident" id="5022826">Uintptr</span><span class="op" id="5022833">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022837">return</span>&nbsp;<span class="ident" id="5022844">val</span><span class="op" id="5022847">.</span><span class="ident" id="5022848">Uint</span><span class="op" id="5022852">(</span><span class="op" id="5022853">)</span>&nbsp;<span class="op" id="5022855">==</span>&nbsp;<span class="num" id="5022858">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022861">case</span>&nbsp;<span class="ident" id="5022866">reflect</span><span class="op" id="5022873">.</span><span class="ident" id="5022874">Struct</span><span class="op" id="5022880">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022884">for</span>&nbsp;<span class="ident" id="5022888">i</span>&nbsp;<span class="op" id="5022890">:=</span>&nbsp;<span class="num" id="5022893">0</span><span class="op" id="5022894">;</span>&nbsp;<span class="ident" id="5022896">i</span>&nbsp;<span class="op" id="5022898">&lt;</span>&nbsp;<span class="ident" id="5022900">val</span><span class="op" id="5022903">.</span><span class="ident" id="5022904">NumField</span><span class="op" id="5022912">(</span><span class="op" id="5022913">)</span><span class="op" id="5022914">;</span>&nbsp;<span class="ident" id="5022916">i</span><span class="op" id="5022917">++</span>&nbsp;<span class="op" id="5022920">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022925">if</span>&nbsp;<span class="op" id="5022928">!</span><span class="ident" id="5022929">isZero</span><span class="op" id="5022935">(</span><span class="ident" id="5022936">val</span><span class="op" id="5022939">.</span><span class="ident" id="5022940">Field</span><span class="op" id="5022945">(</span><span class="ident" id="5022946">i</span><span class="op" id="5022947">)</span><span class="op" id="5022948">)</span>&nbsp;<span class="op" id="5022950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022956">return</span>&nbsp;<span class="builtintype" id="5022963">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5022972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5022976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022980">return</span>&nbsp;<span class="builtintype" id="5022987">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5022993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5022996">panic</span><span class="op" id="5023001">(</span><span class="string" id="5023002">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="5023028">+</span>&nbsp;<span class="ident" id="5023030">val</span><span class="op" id="5023033">.</span><span class="ident" id="5023034">Type</span><span class="op" id="5023038">(</span><span class="op" id="5023039">)</span><span class="op" id="5023040">.</span><span class="ident" id="5023041">String</span><span class="op" id="5023047">(</span><span class="op" id="5023048">)</span><span class="op" id="5023049">)</span><br>
<span class="lineno"></span><span class="op" id="5023051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5023054">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="5023129">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5023166">func</span>&nbsp;<span class="op" id="5023171">(</span><span class="ident" id="5023172">enc</span>&nbsp;<span class="op" id="5023176">*</span><span class="ident" id="5023177">Encoder</span><span class="op" id="5023184">)</span>&nbsp;<span class="ident" id="5023186">encodeGobEncoder</span><span class="op" id="5023202">(</span><span class="ident" id="5023203">b</span>&nbsp;<span class="op" id="5023205">*</span><span class="ident" id="5023206">encBuffer</span><span class="op" id="5023215">,</span>&nbsp;<span class="ident" id="5023217">ut</span>&nbsp;<span class="op" id="5023220">*</span><span class="ident" id="5023221">userTypeInfo</span><span class="op" id="5023233">,</span>&nbsp;<span class="ident" id="5023235">v</span>&nbsp;<span class="ident" id="5023237">reflect</span><span class="op" id="5023244">.</span><span class="ident" id="5023245">Value</span><span class="op" id="5023250">)</span>&nbsp;<span class="op" id="5023252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5023255">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023313">var</span>&nbsp;<span class="ident" id="5023317">data</span>&nbsp;<span class="op" id="5023322">[</span><span class="op" id="5023323">]</span><span class="builtintype" id="5023324">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023330">var</span>&nbsp;<span class="ident" id="5023334">err</span>&nbsp;<span class="builtintype" id="5023338">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5023345">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023376">switch</span>&nbsp;<span class="ident" id="5023383">ut</span><span class="op" id="5023385">.</span><span class="ident" id="5023386">externalEnc</span>&nbsp;<span class="op" id="5023398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023401">case</span>&nbsp;<span class="ident" id="5023406">xGob</span><span class="op" id="5023410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023414">data</span><span class="op" id="5023418">,</span>&nbsp;<span class="ident" id="5023420">err</span>&nbsp;<span class="op" id="5023424">=</span>&nbsp;<span class="ident" id="5023426">v</span><span class="op" id="5023427">.</span><span class="ident" id="5023428">Interface</span><span class="op" id="5023437">(</span><span class="op" id="5023438">)</span><span class="op" id="5023439">.</span><span class="op" id="5023440">(</span><span class="ident" id="5023441">GobEncoder</span><span class="op" id="5023451">)</span><span class="op" id="5023452">.</span><span class="ident" id="5023453">GobEncode</span><span class="op" id="5023462">(</span><span class="op" id="5023463">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023466">case</span>&nbsp;<span class="ident" id="5023471">xBinary</span><span class="op" id="5023478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023482">data</span><span class="op" id="5023486">,</span>&nbsp;<span class="ident" id="5023488">err</span>&nbsp;<span class="op" id="5023492">=</span>&nbsp;<span class="ident" id="5023494">v</span><span class="op" id="5023495">.</span><span class="ident" id="5023496">Interface</span><span class="op" id="5023505">(</span><span class="op" id="5023506">)</span><span class="op" id="5023507">.</span><span class="op" id="5023508">(</span><span class="ident" id="5023509">encoding</span><span class="op" id="5023517">.</span><span class="ident" id="5023518">BinaryMarshaler</span><span class="op" id="5023533">)</span><span class="op" id="5023534">.</span><span class="ident" id="5023535">MarshalBinary</span><span class="op" id="5023548">(</span><span class="op" id="5023549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023552">case</span>&nbsp;<span class="ident" id="5023557">xText</span><span class="op" id="5023562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023566">data</span><span class="op" id="5023570">,</span>&nbsp;<span class="ident" id="5023572">err</span>&nbsp;<span class="op" id="5023576">=</span>&nbsp;<span class="ident" id="5023578">v</span><span class="op" id="5023579">.</span><span class="ident" id="5023580">Interface</span><span class="op" id="5023589">(</span><span class="op" id="5023590">)</span><span class="op" id="5023591">.</span><span class="op" id="5023592">(</span><span class="ident" id="5023593">encoding</span><span class="op" id="5023601">.</span><span class="ident" id="5023602">TextMarshaler</span><span class="op" id="5023615">)</span><span class="op" id="5023616">.</span><span class="ident" id="5023617">MarshalText</span><span class="op" id="5023628">(</span><span class="op" id="5023629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023632">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023635">if</span>&nbsp;<span class="ident" id="5023638">err</span>&nbsp;<span class="op" id="5023642">!=</span>&nbsp;<span class="ident" id="5023645">nil</span>&nbsp;<span class="op" id="5023649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023653">error_</span><span class="op" id="5023659">(</span><span class="ident" id="5023660">err</span><span class="op" id="5023663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023669">state</span>&nbsp;<span class="op" id="5023675">:=</span>&nbsp;<span class="ident" id="5023678">enc</span><span class="op" id="5023681">.</span><span class="ident" id="5023682">newEncoderState</span><span class="op" id="5023697">(</span><span class="ident" id="5023698">b</span><span class="op" id="5023699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023702">state</span><span class="op" id="5023707">.</span><span class="ident" id="5023708">fieldnum</span>&nbsp;<span class="op" id="5023717">=</span>&nbsp;<span class="op" id="5023719">-</span><span class="num" id="5023720">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023723">state</span><span class="op" id="5023728">.</span><span class="ident" id="5023729">encodeUint</span><span class="op" id="5023739">(</span><span class="ident" id="5023740">uint64</span><span class="op" id="5023746">(</span><span class="builtinfunc" id="5023747">len</span><span class="op" id="5023750">(</span><span class="ident" id="5023751">data</span><span class="op" id="5023755">)</span><span class="op" id="5023756">)</span><span class="op" id="5023757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023760">state</span><span class="op" id="5023765">.</span><span class="ident" id="5023766">b</span><span class="op" id="5023767">.</span><span class="ident" id="5023768">Write</span><span class="op" id="5023773">(</span><span class="ident" id="5023774">data</span><span class="op" id="5023778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023781">enc</span><span class="op" id="5023784">.</span><span class="ident" id="5023785">freeEncoderState</span><span class="op" id="5023801">(</span><span class="ident" id="5023802">state</span><span class="op" id="5023807">)</span><br>
<span class="lineno"></span><span class="op" id="5023809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="5023812">var</span>&nbsp;<span class="ident" id="5023816">encOpTable</span>&nbsp;<span class="op" id="5023827">=</span>&nbsp;<span class="op" id="5023829">[</span><span class="op" id="5023830">...</span><span class="op" id="5023833">]</span><span class="ident" id="5023834">encOp</span><span class="op" id="5023839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023842">reflect</span><span class="op" id="5023849">.</span><span class="ident" id="5023850">Bool</span><span class="op" id="5023854">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023862">encBool</span><span class="op" id="5023869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023872">reflect</span><span class="op" id="5023879">.</span><span class="ident" id="5023880">Int</span><span class="op" id="5023883">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023892">encInt</span><span class="op" id="5023898">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023901">reflect</span><span class="op" id="5023908">.</span><span class="ident" id="5023909">Int8</span><span class="op" id="5023913">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023921">encInt</span><span class="op" id="5023927">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023930">reflect</span><span class="op" id="5023937">.</span><span class="ident" id="5023938">Int16</span><span class="op" id="5023943">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023950">encInt</span><span class="op" id="5023956">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023959">reflect</span><span class="op" id="5023966">.</span><span class="ident" id="5023967">Int32</span><span class="op" id="5023972">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023979">encInt</span><span class="op" id="5023985">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023988">reflect</span><span class="op" id="5023995">.</span><span class="ident" id="5023996">Int64</span><span class="op" id="5024001">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024008">encInt</span><span class="op" id="5024014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024017">reflect</span><span class="op" id="5024024">.</span><span class="ident" id="5024025">Uint</span><span class="op" id="5024029">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024037">encUint</span><span class="op" id="5024044">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024047">reflect</span><span class="op" id="5024054">.</span><span class="ident" id="5024055">Uint8</span><span class="op" id="5024060">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024067">encUint</span><span class="op" id="5024074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024077">reflect</span><span class="op" id="5024084">.</span><span class="ident" id="5024085">Uint16</span><span class="op" id="5024091">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024097">encUint</span><span class="op" id="5024104">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024107">reflect</span><span class="op" id="5024114">.</span><span class="ident" id="5024115">Uint32</span><span class="op" id="5024121">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024127">encUint</span><span class="op" id="5024134">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024137">reflect</span><span class="op" id="5024144">.</span><span class="ident" id="5024145">Uint64</span><span class="op" id="5024151">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024157">encUint</span><span class="op" id="5024164">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024167">reflect</span><span class="op" id="5024174">.</span><span class="ident" id="5024175">Uintptr</span><span class="op" id="5024182">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024187">encUint</span><span class="op" id="5024194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024197">reflect</span><span class="op" id="5024204">.</span><span class="ident" id="5024205">Float32</span><span class="op" id="5024212">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024217">encFloat</span><span class="op" id="5024225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024228">reflect</span><span class="op" id="5024235">.</span><span class="ident" id="5024236">Float64</span><span class="op" id="5024243">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024248">encFloat</span><span class="op" id="5024256">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024259">reflect</span><span class="op" id="5024266">.</span><span class="ident" id="5024267">Complex64</span><span class="op" id="5024276">:</span>&nbsp;&nbsp;<span class="ident" id="5024279">encComplex</span><span class="op" id="5024289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024292">reflect</span><span class="op" id="5024299">.</span><span class="ident" id="5024300">Complex128</span><span class="op" id="5024310">:</span>&nbsp;<span class="ident" id="5024312">encComplex</span><span class="op" id="5024322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024325">reflect</span><span class="op" id="5024332">.</span><span class="ident" id="5024333">String</span><span class="op" id="5024339">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024345">encString</span><span class="op" id="5024354">,</span><br>
<span class="lineno"></span><span class="op" id="5024356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="5024359">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5024441">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5024479">func</span>&nbsp;<span class="ident" id="5024484">encOpFor</span><span class="op" id="5024492">(</span><span class="ident" id="5024493">rt</span>&nbsp;<span class="ident" id="5024496">reflect</span><span class="op" id="5024503">.</span><span class="ident" id="5024504">Type</span><span class="op" id="5024508">,</span>&nbsp;<span class="ident" id="5024510">inProgress</span>&nbsp;<span class="keyword" id="5024521">map</span><span class="op" id="5024524">[</span><span class="ident" id="5024525">reflect</span><span class="op" id="5024532">.</span><span class="ident" id="5024533">Type</span><span class="op" id="5024537">]</span><span class="op" id="5024538">*</span><span class="ident" id="5024539">encOp</span><span class="op" id="5024544">,</span>&nbsp;<span class="ident" id="5024546">building</span>&nbsp;<span class="keyword" id="5024555">map</span><span class="op" id="5024558">[</span><span class="op" id="5024559">*</span><span class="ident" id="5024560">typeInfo</span><span class="op" id="5024568">]</span><span class="builtintype" id="5024569">bool</span><span class="op" id="5024573">)</span>&nbsp;<span class="op" id="5024575">(</span><span class="op" id="5024576">*</span><span class="ident" id="5024577">encOp</span><span class="op" id="5024582">,</span>&nbsp;<span class="builtintype" id="5024584">int</span><span class="op" id="5024587">)</span>&nbsp;<span class="op" id="5024589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024592">ut</span>&nbsp;<span class="op" id="5024595">:=</span>&nbsp;<span class="ident" id="5024598">userType</span><span class="op" id="5024606">(</span><span class="ident" id="5024607">rt</span><span class="op" id="5024609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024612">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5024692">if</span>&nbsp;<span class="ident" id="5024695">ut</span><span class="op" id="5024697">.</span><span class="ident" id="5024698">externalEnc</span>&nbsp;<span class="op" id="5024710">!=</span>&nbsp;<span class="num" id="5024713">0</span>&nbsp;<span class="op" id="5024715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5024719">return</span>&nbsp;<span class="ident" id="5024726">gobEncodeOpFor</span><span class="op" id="5024740">(</span><span class="ident" id="5024741">ut</span><span class="op" id="5024743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5024746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024749">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024834">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5024891">if</span>&nbsp;<span class="ident" id="5024894">opPtr</span>&nbsp;<span class="op" id="5024900">:=</span>&nbsp;<span class="ident" id="5024903">inProgress</span><span class="op" id="5024913">[</span><span class="ident" id="5024914">rt</span><span class="op" id="5024916">]</span><span class="op" id="5024917">;</span>&nbsp;<span class="ident" id="5024919">opPtr</span>&nbsp;<span class="op" id="5024925">!=</span>&nbsp;<span class="ident" id="5024928">nil</span>&nbsp;<span class="op" id="5024932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5024936">return</span>&nbsp;<span class="ident" id="5024943">opPtr</span><span class="op" id="5024948">,</span>&nbsp;<span class="ident" id="5024950">ut</span><span class="op" id="5024952">.</span><span class="ident" id="5024953">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5024960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024963">typ</span>&nbsp;<span class="op" id="5024967">:=</span>&nbsp;<span class="ident" id="5024970">ut</span><span class="op" id="5024972">.</span><span class="ident" id="5024973">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024979">indir</span>&nbsp;<span class="op" id="5024985">:=</span>&nbsp;<span class="ident" id="5024988">ut</span><span class="op" id="5024990">.</span><span class="ident" id="5024991">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024998">k</span>&nbsp;<span class="op" id="5025000">:=</span>&nbsp;<span class="ident" id="5025003">typ</span><span class="op" id="5025006">.</span><span class="ident" id="5025007">Kind</span><span class="op" id="5025011">(</span><span class="op" id="5025012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025015">var</span>&nbsp;<span class="ident" id="5025019">op</span>&nbsp;<span class="ident" id="5025022">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025029">if</span>&nbsp;<span class="builtintype" id="5025032">int</span><span class="op" id="5025035">(</span><span class="ident" id="5025036">k</span><span class="op" id="5025037">)</span>&nbsp;<span class="op" id="5025039">&lt;</span>&nbsp;<span class="builtinfunc" id="5025041">len</span><span class="op" id="5025044">(</span><span class="ident" id="5025045">encOpTable</span><span class="op" id="5025055">)</span>&nbsp;<span class="op" id="5025057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025061">op</span>&nbsp;<span class="op" id="5025064">=</span>&nbsp;<span class="ident" id="5025066">encOpTable</span><span class="op" id="5025076">[</span><span class="ident" id="5025077">k</span><span class="op" id="5025078">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5025081">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025084">if</span>&nbsp;<span class="ident" id="5025087">op</span>&nbsp;<span class="op" id="5025090">==</span>&nbsp;<span class="ident" id="5025093">nil</span>&nbsp;<span class="op" id="5025097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025101">inProgress</span><span class="op" id="5025111">[</span><span class="ident" id="5025112">rt</span><span class="op" id="5025114">]</span>&nbsp;<span class="op" id="5025116">=</span>&nbsp;<span class="op" id="5025118">&amp;</span><span class="ident" id="5025119">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5025124">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025143">switch</span>&nbsp;<span class="ident" id="5025150">t</span>&nbsp;<span class="op" id="5025152">:=</span>&nbsp;<span class="ident" id="5025155">typ</span><span class="op" id="5025158">;</span>&nbsp;<span class="ident" id="5025160">t</span><span class="op" id="5025161">.</span><span class="ident" id="5025162">Kind</span><span class="op" id="5025166">(</span><span class="op" id="5025167">)</span>&nbsp;<span class="op" id="5025169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025173">case</span>&nbsp;<span class="ident" id="5025178">reflect</span><span class="op" id="5025185">.</span><span class="ident" id="5025186">Slice</span><span class="op" id="5025191">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025196">if</span>&nbsp;<span class="ident" id="5025199">t</span><span class="op" id="5025200">.</span><span class="ident" id="5025201">Elem</span><span class="op" id="5025205">(</span><span class="op" id="5025206">)</span><span class="op" id="5025207">.</span><span class="ident" id="5025208">Kind</span><span class="op" id="5025212">(</span><span class="op" id="5025213">)</span>&nbsp;<span class="op" id="5025215">==</span>&nbsp;<span class="ident" id="5025218">reflect</span><span class="op" id="5025225">.</span><span class="ident" id="5025226">Uint8</span>&nbsp;<span class="op" id="5025232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025238">op</span>&nbsp;<span class="op" id="5025241">=</span>&nbsp;<span class="ident" id="5025243">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025261">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5025270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5025275">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025346">elemOp</span><span class="op" id="5025352">,</span>&nbsp;<span class="ident" id="5025354">elemIndir</span>&nbsp;<span class="op" id="5025364">:=</span>&nbsp;<span class="ident" id="5025367">encOpFor</span><span class="op" id="5025375">(</span><span class="ident" id="5025376">t</span><span class="op" id="5025377">.</span><span class="ident" id="5025378">Elem</span><span class="op" id="5025382">(</span><span class="op" id="5025383">)</span><span class="op" id="5025384">,</span>&nbsp;<span class="ident" id="5025386">inProgress</span><span class="op" id="5025396">,</span>&nbsp;<span class="ident" id="5025398">building</span><span class="op" id="5025406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025411">helper</span>&nbsp;<span class="op" id="5025418">:=</span>&nbsp;<span class="ident" id="5025421">encSliceHelper</span><span class="op" id="5025435">[</span><span class="ident" id="5025436">t</span><span class="op" id="5025437">.</span><span class="ident" id="5025438">Elem</span><span class="op" id="5025442">(</span><span class="op" id="5025443">)</span><span class="op" id="5025444">.</span><span class="ident" id="5025445">Kind</span><span class="op" id="5025449">(</span><span class="op" id="5025450">)</span><span class="op" id="5025451">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025456">op</span>&nbsp;<span class="op" id="5025459">=</span>&nbsp;<span class="keyword" id="5025461">func</span><span class="op" id="5025465">(</span><span class="ident" id="5025466">i</span>&nbsp;<span class="op" id="5025468">*</span><span class="ident" id="5025469">encInstr</span><span class="op" id="5025477">,</span>&nbsp;<span class="ident" id="5025479">state</span>&nbsp;<span class="op" id="5025485">*</span><span class="ident" id="5025486">encoderState</span><span class="op" id="5025498">,</span>&nbsp;<span class="ident" id="5025500">slice</span>&nbsp;<span class="ident" id="5025506">reflect</span><span class="op" id="5025513">.</span><span class="ident" id="5025514">Value</span><span class="op" id="5025519">)</span>&nbsp;<span class="op" id="5025521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025527">if</span>&nbsp;<span class="op" id="5025530">!</span><span class="ident" id="5025531">state</span><span class="op" id="5025536">.</span><span class="ident" id="5025537">sendZero</span>&nbsp;<span class="op" id="5025546">&amp;&amp;</span>&nbsp;<span class="ident" id="5025549">slice</span><span class="op" id="5025554">.</span><span class="ident" id="5025555">Len</span><span class="op" id="5025558">(</span><span class="op" id="5025559">)</span>&nbsp;<span class="op" id="5025561">==</span>&nbsp;<span class="num" id="5025564">0</span>&nbsp;<span class="op" id="5025566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025573">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5025584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025590">state</span><span class="op" id="5025595">.</span><span class="ident" id="5025596">update</span><span class="op" id="5025602">(</span><span class="ident" id="5025603">i</span><span class="op" id="5025604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025610">state</span><span class="op" id="5025615">.</span><span class="ident" id="5025616">enc</span><span class="op" id="5025619">.</span><span class="ident" id="5025620">encodeArray</span><span class="op" id="5025631">(</span><span class="ident" id="5025632">state</span><span class="op" id="5025637">.</span><span class="ident" id="5025638">b</span><span class="op" id="5025639">,</span>&nbsp;<span class="ident" id="5025641">slice</span><span class="op" id="5025646">,</span>&nbsp;<span class="op" id="5025648">*</span><span class="ident" id="5025649">elemOp</span><span class="op" id="5025655">,</span>&nbsp;<span class="ident" id="5025657">elemIndir</span><span class="op" id="5025666">,</span>&nbsp;<span class="ident" id="5025668">slice</span><span class="op" id="5025673">.</span><span class="ident" id="5025674">Len</span><span class="op" id="5025677">(</span><span class="op" id="5025678">)</span><span class="op" id="5025679">,</span>&nbsp;<span class="ident" id="5025681">helper</span><span class="op" id="5025687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5025692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025696">case</span>&nbsp;<span class="ident" id="5025701">reflect</span><span class="op" id="5025708">.</span><span class="ident" id="5025709">Array</span><span class="op" id="5025714">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5025719">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025760">elemOp</span><span class="op" id="5025766">,</span>&nbsp;<span class="ident" id="5025768">elemIndir</span>&nbsp;<span class="op" id="5025778">:=</span>&nbsp;<span class="ident" id="5025781">encOpFor</span><span class="op" id="5025789">(</span><span class="ident" id="5025790">t</span><span class="op" id="5025791">.</span><span class="ident" id="5025792">Elem</span><span class="op" id="5025796">(</span><span class="op" id="5025797">)</span><span class="op" id="5025798">,</span>&nbsp;<span class="ident" id="5025800">inProgress</span><span class="op" id="5025810">,</span>&nbsp;<span class="ident" id="5025812">building</span><span class="op" id="5025820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025825">helper</span>&nbsp;<span class="op" id="5025832">:=</span>&nbsp;<span class="ident" id="5025835">encArrayHelper</span><span class="op" id="5025849">[</span><span class="ident" id="5025850">t</span><span class="op" id="5025851">.</span><span class="ident" id="5025852">Elem</span><span class="op" id="5025856">(</span><span class="op" id="5025857">)</span><span class="op" id="5025858">.</span><span class="ident" id="5025859">Kind</span><span class="op" id="5025863">(</span><span class="op" id="5025864">)</span><span class="op" id="5025865">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025870">op</span>&nbsp;<span class="op" id="5025873">=</span>&nbsp;<span class="keyword" id="5025875">func</span><span class="op" id="5025879">(</span><span class="ident" id="5025880">i</span>&nbsp;<span class="op" id="5025882">*</span><span class="ident" id="5025883">encInstr</span><span class="op" id="5025891">,</span>&nbsp;<span class="ident" id="5025893">state</span>&nbsp;<span class="op" id="5025899">*</span><span class="ident" id="5025900">encoderState</span><span class="op" id="5025912">,</span>&nbsp;<span class="ident" id="5025914">array</span>&nbsp;<span class="ident" id="5025920">reflect</span><span class="op" id="5025927">.</span><span class="ident" id="5025928">Value</span><span class="op" id="5025933">)</span>&nbsp;<span class="op" id="5025935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025941">state</span><span class="op" id="5025946">.</span><span class="ident" id="5025947">update</span><span class="op" id="5025953">(</span><span class="ident" id="5025954">i</span><span class="op" id="5025955">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025961">state</span><span class="op" id="5025966">.</span><span class="ident" id="5025967">enc</span><span class="op" id="5025970">.</span><span class="ident" id="5025971">encodeArray</span><span class="op" id="5025982">(</span><span class="ident" id="5025983">state</span><span class="op" id="5025988">.</span><span class="ident" id="5025989">b</span><span class="op" id="5025990">,</span>&nbsp;<span class="ident" id="5025992">array</span><span class="op" id="5025997">,</span>&nbsp;<span class="op" id="5025999">*</span><span class="ident" id="5026000">elemOp</span><span class="op" id="5026006">,</span>&nbsp;<span class="ident" id="5026008">elemIndir</span><span class="op" id="5026017">,</span>&nbsp;<span class="ident" id="5026019">array</span><span class="op" id="5026024">.</span><span class="ident" id="5026025">Len</span><span class="op" id="5026028">(</span><span class="op" id="5026029">)</span><span class="op" id="5026030">,</span>&nbsp;<span class="ident" id="5026032">helper</span><span class="op" id="5026038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026047">case</span>&nbsp;<span class="ident" id="5026052">reflect</span><span class="op" id="5026059">.</span><span class="ident" id="5026060">Map</span><span class="op" id="5026063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026068">keyOp</span><span class="op" id="5026073">,</span>&nbsp;<span class="ident" id="5026075">keyIndir</span>&nbsp;<span class="op" id="5026084">:=</span>&nbsp;<span class="ident" id="5026087">encOpFor</span><span class="op" id="5026095">(</span><span class="ident" id="5026096">t</span><span class="op" id="5026097">.</span><span class="ident" id="5026098">Key</span><span class="op" id="5026101">(</span><span class="op" id="5026102">)</span><span class="op" id="5026103">,</span>&nbsp;<span class="ident" id="5026105">inProgress</span><span class="op" id="5026115">,</span>&nbsp;<span class="ident" id="5026117">building</span><span class="op" id="5026125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026130">elemOp</span><span class="op" id="5026136">,</span>&nbsp;<span class="ident" id="5026138">elemIndir</span>&nbsp;<span class="op" id="5026148">:=</span>&nbsp;<span class="ident" id="5026151">encOpFor</span><span class="op" id="5026159">(</span><span class="ident" id="5026160">t</span><span class="op" id="5026161">.</span><span class="ident" id="5026162">Elem</span><span class="op" id="5026166">(</span><span class="op" id="5026167">)</span><span class="op" id="5026168">,</span>&nbsp;<span class="ident" id="5026170">inProgress</span><span class="op" id="5026180">,</span>&nbsp;<span class="ident" id="5026182">building</span><span class="op" id="5026190">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026195">op</span>&nbsp;<span class="op" id="5026198">=</span>&nbsp;<span class="keyword" id="5026200">func</span><span class="op" id="5026204">(</span><span class="ident" id="5026205">i</span>&nbsp;<span class="op" id="5026207">*</span><span class="ident" id="5026208">encInstr</span><span class="op" id="5026216">,</span>&nbsp;<span class="ident" id="5026218">state</span>&nbsp;<span class="op" id="5026224">*</span><span class="ident" id="5026225">encoderState</span><span class="op" id="5026237">,</span>&nbsp;<span class="ident" id="5026239">mv</span>&nbsp;<span class="ident" id="5026242">reflect</span><span class="op" id="5026249">.</span><span class="ident" id="5026250">Value</span><span class="op" id="5026255">)</span>&nbsp;<span class="op" id="5026257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026263">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026321">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026390">if</span>&nbsp;<span class="op" id="5026393">!</span><span class="ident" id="5026394">state</span><span class="op" id="5026399">.</span><span class="ident" id="5026400">sendZero</span>&nbsp;<span class="op" id="5026409">&amp;&amp;</span>&nbsp;<span class="ident" id="5026412">mv</span><span class="op" id="5026414">.</span><span class="ident" id="5026415">IsNil</span><span class="op" id="5026420">(</span><span class="op" id="5026421">)</span>&nbsp;<span class="op" id="5026423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026430">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026447">state</span><span class="op" id="5026452">.</span><span class="ident" id="5026453">update</span><span class="op" id="5026459">(</span><span class="ident" id="5026460">i</span><span class="op" id="5026461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026467">state</span><span class="op" id="5026472">.</span><span class="ident" id="5026473">enc</span><span class="op" id="5026476">.</span><span class="ident" id="5026477">encodeMap</span><span class="op" id="5026486">(</span><span class="ident" id="5026487">state</span><span class="op" id="5026492">.</span><span class="ident" id="5026493">b</span><span class="op" id="5026494">,</span>&nbsp;<span class="ident" id="5026496">mv</span><span class="op" id="5026498">,</span>&nbsp;<span class="op" id="5026500">*</span><span class="ident" id="5026501">keyOp</span><span class="op" id="5026506">,</span>&nbsp;<span class="op" id="5026508">*</span><span class="ident" id="5026509">elemOp</span><span class="op" id="5026515">,</span>&nbsp;<span class="ident" id="5026517">keyIndir</span><span class="op" id="5026525">,</span>&nbsp;<span class="ident" id="5026527">elemIndir</span><span class="op" id="5026536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026545">case</span>&nbsp;<span class="ident" id="5026550">reflect</span><span class="op" id="5026557">.</span><span class="ident" id="5026558">Struct</span><span class="op" id="5026564">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026569">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026644">getEncEngine</span><span class="op" id="5026656">(</span><span class="ident" id="5026657">userType</span><span class="op" id="5026665">(</span><span class="ident" id="5026666">typ</span><span class="op" id="5026669">)</span><span class="op" id="5026670">,</span>&nbsp;<span class="ident" id="5026672">building</span><span class="op" id="5026680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026685">info</span>&nbsp;<span class="op" id="5026690">:=</span>&nbsp;<span class="ident" id="5026693">mustGetTypeInfo</span><span class="op" id="5026708">(</span><span class="ident" id="5026709">typ</span><span class="op" id="5026712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026717">op</span>&nbsp;<span class="op" id="5026720">=</span>&nbsp;<span class="keyword" id="5026722">func</span><span class="op" id="5026726">(</span><span class="ident" id="5026727">i</span>&nbsp;<span class="op" id="5026729">*</span><span class="ident" id="5026730">encInstr</span><span class="op" id="5026738">,</span>&nbsp;<span class="ident" id="5026740">state</span>&nbsp;<span class="op" id="5026746">*</span><span class="ident" id="5026747">encoderState</span><span class="op" id="5026759">,</span>&nbsp;<span class="ident" id="5026761">sv</span>&nbsp;<span class="ident" id="5026764">reflect</span><span class="op" id="5026771">.</span><span class="ident" id="5026772">Value</span><span class="op" id="5026777">)</span>&nbsp;<span class="op" id="5026779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026785">state</span><span class="op" id="5026790">.</span><span class="ident" id="5026791">update</span><span class="op" id="5026797">(</span><span class="ident" id="5026798">i</span><span class="op" id="5026799">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026805">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026876">enc</span>&nbsp;<span class="op" id="5026880">:=</span>&nbsp;<span class="ident" id="5026883">info</span><span class="op" id="5026887">.</span><span class="ident" id="5026888">encoder</span><span class="op" id="5026895">.</span><span class="ident" id="5026896">Load</span><span class="op" id="5026900">(</span><span class="op" id="5026901">)</span><span class="op" id="5026902">.</span><span class="op" id="5026903">(</span><span class="op" id="5026904">*</span><span class="ident" id="5026905">encEngine</span><span class="op" id="5026914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026920">state</span><span class="op" id="5026925">.</span><span class="ident" id="5026926">enc</span><span class="op" id="5026929">.</span><span class="ident" id="5026930">encodeStruct</span><span class="op" id="5026942">(</span><span class="ident" id="5026943">state</span><span class="op" id="5026948">.</span><span class="ident" id="5026949">b</span><span class="op" id="5026950">,</span>&nbsp;<span class="ident" id="5026952">enc</span><span class="op" id="5026955">,</span>&nbsp;<span class="ident" id="5026957">sv</span><span class="op" id="5026959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026968">case</span>&nbsp;<span class="ident" id="5026973">reflect</span><span class="op" id="5026980">.</span><span class="ident" id="5026981">Interface</span><span class="op" id="5026990">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026995">op</span>&nbsp;<span class="op" id="5026998">=</span>&nbsp;<span class="keyword" id="5027000">func</span><span class="op" id="5027004">(</span><span class="ident" id="5027005">i</span>&nbsp;<span class="op" id="5027007">*</span><span class="ident" id="5027008">encInstr</span><span class="op" id="5027016">,</span>&nbsp;<span class="ident" id="5027018">state</span>&nbsp;<span class="op" id="5027024">*</span><span class="ident" id="5027025">encoderState</span><span class="op" id="5027037">,</span>&nbsp;<span class="ident" id="5027039">iv</span>&nbsp;<span class="ident" id="5027042">reflect</span><span class="op" id="5027049">.</span><span class="ident" id="5027050">Value</span><span class="op" id="5027055">)</span>&nbsp;<span class="op" id="5027057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027063">if</span>&nbsp;<span class="op" id="5027066">!</span><span class="ident" id="5027067">state</span><span class="op" id="5027072">.</span><span class="ident" id="5027073">sendZero</span>&nbsp;<span class="op" id="5027082">&amp;&amp;</span>&nbsp;<span class="op" id="5027085">(</span><span class="op" id="5027086">!</span><span class="ident" id="5027087">iv</span><span class="op" id="5027089">.</span><span class="ident" id="5027090">IsValid</span><span class="op" id="5027097">(</span><span class="op" id="5027098">)</span>&nbsp;<span class="op" id="5027100">||</span>&nbsp;<span class="ident" id="5027103">iv</span><span class="op" id="5027105">.</span><span class="ident" id="5027106">IsNil</span><span class="op" id="5027111">(</span><span class="op" id="5027112">)</span><span class="op" id="5027113">)</span>&nbsp;<span class="op" id="5027115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027139">state</span><span class="op" id="5027144">.</span><span class="ident" id="5027145">update</span><span class="op" id="5027151">(</span><span class="ident" id="5027152">i</span><span class="op" id="5027153">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027159">state</span><span class="op" id="5027164">.</span><span class="ident" id="5027165">enc</span><span class="op" id="5027168">.</span><span class="ident" id="5027169">encodeInterface</span><span class="op" id="5027184">(</span><span class="ident" id="5027185">state</span><span class="op" id="5027190">.</span><span class="ident" id="5027191">b</span><span class="op" id="5027192">,</span>&nbsp;<span class="ident" id="5027194">iv</span><span class="op" id="5027196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027211">if</span>&nbsp;<span class="ident" id="5027214">op</span>&nbsp;<span class="op" id="5027217">==</span>&nbsp;<span class="ident" id="5027220">nil</span>&nbsp;<span class="op" id="5027224">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027228">errorf</span><span class="op" id="5027234">(</span><span class="string" id="5027235">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5027265">,</span>&nbsp;<span class="ident" id="5027267">rt</span><span class="op" id="5027269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027275">return</span>&nbsp;<span class="op" id="5027282">&amp;</span><span class="ident" id="5027283">op</span><span class="op" id="5027285">,</span>&nbsp;<span class="ident" id="5027287">indir</span><br>
<span class="lineno"></span><span class="op" id="5027293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="5027296">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5027379">func</span>&nbsp;<span class="ident" id="5027384">gobEncodeOpFor</span><span class="op" id="5027398">(</span><span class="ident" id="5027399">ut</span>&nbsp;<span class="op" id="5027402">*</span><span class="ident" id="5027403">userTypeInfo</span><span class="op" id="5027415">)</span>&nbsp;<span class="op" id="5027417">(</span><span class="op" id="5027418">*</span><span class="ident" id="5027419">encOp</span><span class="op" id="5027424">,</span>&nbsp;<span class="builtintype" id="5027426">int</span><span class="op" id="5027429">)</span>&nbsp;<span class="op" id="5027431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027434">rt</span>&nbsp;<span class="op" id="5027437">:=</span>&nbsp;<span class="ident" id="5027440">ut</span><span class="op" id="5027442">.</span><span class="ident" id="5027443">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027449">if</span>&nbsp;<span class="ident" id="5027452">ut</span><span class="op" id="5027454">.</span><span class="ident" id="5027455">encIndir</span>&nbsp;<span class="op" id="5027464">==</span>&nbsp;<span class="op" id="5027467">-</span><span class="num" id="5027468">1</span>&nbsp;<span class="op" id="5027470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027474">rt</span>&nbsp;<span class="op" id="5027477">=</span>&nbsp;<span class="ident" id="5027479">reflect</span><span class="op" id="5027486">.</span><span class="ident" id="5027487">PtrTo</span><span class="op" id="5027492">(</span><span class="ident" id="5027493">rt</span><span class="op" id="5027495">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027498">}</span>&nbsp;<span class="keyword" id="5027500">else</span>&nbsp;<span class="keyword" id="5027505">if</span>&nbsp;<span class="ident" id="5027508">ut</span><span class="op" id="5027510">.</span><span class="ident" id="5027511">encIndir</span>&nbsp;<span class="op" id="5027520">&gt;</span>&nbsp;<span class="num" id="5027522">0</span>&nbsp;<span class="op" id="5027524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027528">for</span>&nbsp;<span class="ident" id="5027532">i</span>&nbsp;<span class="op" id="5027534">:=</span>&nbsp;<span class="builtintype" id="5027537">int8</span><span class="op" id="5027541">(</span><span class="num" id="5027542">0</span><span class="op" id="5027543">)</span><span class="op" id="5027544">;</span>&nbsp;<span class="ident" id="5027546">i</span>&nbsp;<span class="op" id="5027548">&lt;</span>&nbsp;<span class="ident" id="5027550">ut</span><span class="op" id="5027552">.</span><span class="ident" id="5027553">encIndir</span><span class="op" id="5027561">;</span>&nbsp;<span class="ident" id="5027563">i</span><span class="op" id="5027564">++</span>&nbsp;<span class="op" id="5027567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027572">rt</span>&nbsp;<span class="op" id="5027575">=</span>&nbsp;<span class="ident" id="5027577">rt</span><span class="op" id="5027579">.</span><span class="ident" id="5027580">Elem</span><span class="op" id="5027584">(</span><span class="op" id="5027585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027592">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027595">var</span>&nbsp;<span class="ident" id="5027599">op</span>&nbsp;<span class="ident" id="5027602">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027609">op</span>&nbsp;<span class="op" id="5027612">=</span>&nbsp;<span class="keyword" id="5027614">func</span><span class="op" id="5027618">(</span><span class="ident" id="5027619">i</span>&nbsp;<span class="op" id="5027621">*</span><span class="ident" id="5027622">encInstr</span><span class="op" id="5027630">,</span>&nbsp;<span class="ident" id="5027632">state</span>&nbsp;<span class="op" id="5027638">*</span><span class="ident" id="5027639">encoderState</span><span class="op" id="5027651">,</span>&nbsp;<span class="ident" id="5027653">v</span>&nbsp;<span class="ident" id="5027655">reflect</span><span class="op" id="5027662">.</span><span class="ident" id="5027663">Value</span><span class="op" id="5027668">)</span>&nbsp;<span class="op" id="5027670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027674">if</span>&nbsp;<span class="ident" id="5027677">ut</span><span class="op" id="5027679">.</span><span class="ident" id="5027680">encIndir</span>&nbsp;<span class="op" id="5027689">==</span>&nbsp;<span class="op" id="5027692">-</span><span class="num" id="5027693">1</span>&nbsp;<span class="op" id="5027695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027700">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027761">if</span>&nbsp;<span class="op" id="5027764">!</span><span class="ident" id="5027765">v</span><span class="op" id="5027766">.</span><span class="ident" id="5027767">CanAddr</span><span class="op" id="5027774">(</span><span class="op" id="5027775">)</span>&nbsp;<span class="op" id="5027777">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027783">errorf</span><span class="op" id="5027789">(</span><span class="string" id="5027790">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5027822">,</span>&nbsp;<span class="ident" id="5027824">rt</span><span class="op" id="5027826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027836">v</span>&nbsp;<span class="op" id="5027838">=</span>&nbsp;<span class="ident" id="5027840">v</span><span class="op" id="5027841">.</span><span class="ident" id="5027842">Addr</span><span class="op" id="5027846">(</span><span class="op" id="5027847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027855">if</span>&nbsp;<span class="op" id="5027858">!</span><span class="ident" id="5027859">state</span><span class="op" id="5027864">.</span><span class="ident" id="5027865">sendZero</span>&nbsp;<span class="op" id="5027874">&amp;&amp;</span>&nbsp;<span class="ident" id="5027877">isZero</span><span class="op" id="5027883">(</span><span class="ident" id="5027884">v</span><span class="op" id="5027885">)</span>&nbsp;<span class="op" id="5027887">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027892">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027905">state</span><span class="op" id="5027910">.</span><span class="ident" id="5027911">update</span><span class="op" id="5027917">(</span><span class="ident" id="5027918">i</span><span class="op" id="5027919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027923">state</span><span class="op" id="5027928">.</span><span class="ident" id="5027929">enc</span><span class="op" id="5027932">.</span><span class="ident" id="5027933">encodeGobEncoder</span><span class="op" id="5027949">(</span><span class="ident" id="5027950">state</span><span class="op" id="5027955">.</span><span class="ident" id="5027956">b</span><span class="op" id="5027957">,</span>&nbsp;<span class="ident" id="5027959">ut</span><span class="op" id="5027961">,</span>&nbsp;<span class="ident" id="5027963">v</span><span class="op" id="5027964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027967">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027970">return</span>&nbsp;<span class="op" id="5027977">&amp;</span><span class="ident" id="5027978">op</span><span class="op" id="5027980">,</span>&nbsp;<span class="builtintype" id="5027982">int</span><span class="op" id="5027985">(</span><span class="ident" id="5027986">ut</span><span class="op" id="5027988">.</span><span class="ident" id="5027989">encIndir</span><span class="op" id="5027997">)</span>&nbsp;<span class="comment" id="5027999">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="5028062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5028065">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5028119">func</span>&nbsp;<span class="ident" id="5028124">compileEnc</span><span class="op" id="5028134">(</span><span class="ident" id="5028135">ut</span>&nbsp;<span class="op" id="5028138">*</span><span class="ident" id="5028139">userTypeInfo</span><span class="op" id="5028151">,</span>&nbsp;<span class="ident" id="5028153">building</span>&nbsp;<span class="keyword" id="5028162">map</span><span class="op" id="5028165">[</span><span class="op" id="5028166">*</span><span class="ident" id="5028167">typeInfo</span><span class="op" id="5028175">]</span><span class="builtintype" id="5028176">bool</span><span class="op" id="5028180">)</span>&nbsp;<span class="op" id="5028182">*</span><span class="ident" id="5028183">encEngine</span>&nbsp;<span class="op" id="5028193">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028196">srt</span>&nbsp;<span class="op" id="5028200">:=</span>&nbsp;<span class="ident" id="5028203">ut</span><span class="op" id="5028205">.</span><span class="ident" id="5028206">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028212">engine</span>&nbsp;<span class="op" id="5028219">:=</span>&nbsp;<span class="builtinfunc" id="5028222">new</span><span class="op" id="5028225">(</span><span class="ident" id="5028226">encEngine</span><span class="op" id="5028235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028238">seen</span>&nbsp;<span class="op" id="5028243">:=</span>&nbsp;<span class="builtinfunc" id="5028246">make</span><span class="op" id="5028250">(</span><span class="keyword" id="5028251">map</span><span class="op" id="5028254">[</span><span class="ident" id="5028255">reflect</span><span class="op" id="5028262">.</span><span class="ident" id="5028263">Type</span><span class="op" id="5028267">]</span><span class="op" id="5028268">*</span><span class="ident" id="5028269">encOp</span><span class="op" id="5028274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028277">rt</span>&nbsp;<span class="op" id="5028280">:=</span>&nbsp;<span class="ident" id="5028283">ut</span><span class="op" id="5028285">.</span><span class="ident" id="5028286">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028292">if</span>&nbsp;<span class="ident" id="5028295">ut</span><span class="op" id="5028297">.</span><span class="ident" id="5028298">externalEnc</span>&nbsp;<span class="op" id="5028310">!=</span>&nbsp;<span class="num" id="5028313">0</span>&nbsp;<span class="op" id="5028315">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028319">rt</span>&nbsp;<span class="op" id="5028322">=</span>&nbsp;<span class="ident" id="5028324">ut</span><span class="op" id="5028326">.</span><span class="ident" id="5028327">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028336">if</span>&nbsp;<span class="ident" id="5028339">ut</span><span class="op" id="5028341">.</span><span class="ident" id="5028342">externalEnc</span>&nbsp;<span class="op" id="5028354">==</span>&nbsp;<span class="num" id="5028357">0</span>&nbsp;<span class="op" id="5028359">&amp;&amp;</span>&nbsp;<span class="ident" id="5028362">srt</span><span class="op" id="5028365">.</span><span class="ident" id="5028366">Kind</span><span class="op" id="5028370">(</span><span class="op" id="5028371">)</span>&nbsp;<span class="op" id="5028373">==</span>&nbsp;<span class="ident" id="5028376">reflect</span><span class="op" id="5028383">.</span><span class="ident" id="5028384">Struct</span>&nbsp;<span class="op" id="5028391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028395">for</span>&nbsp;<span class="ident" id="5028399">fieldNum</span><span class="op" id="5028407">,</span>&nbsp;<span class="ident" id="5028409">wireFieldNum</span>&nbsp;<span class="op" id="5028422">:=</span>&nbsp;<span class="num" id="5028425">0</span><span class="op" id="5028426">,</span>&nbsp;<span class="num" id="5028428">0</span><span class="op" id="5028429">;</span>&nbsp;<span class="ident" id="5028431">fieldNum</span>&nbsp;<span class="op" id="5028440">&lt;</span>&nbsp;<span class="ident" id="5028442">srt</span><span class="op" id="5028445">.</span><span class="ident" id="5028446">NumField</span><span class="op" id="5028454">(</span><span class="op" id="5028455">)</span><span class="op" id="5028456">;</span>&nbsp;<span class="ident" id="5028458">fieldNum</span><span class="op" id="5028466">++</span>&nbsp;<span class="op" id="5028469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028474">f</span>&nbsp;<span class="op" id="5028476">:=</span>&nbsp;<span class="ident" id="5028479">srt</span><span class="op" id="5028482">.</span><span class="ident" id="5028483">Field</span><span class="op" id="5028488">(</span><span class="ident" id="5028489">fieldNum</span><span class="op" id="5028497">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028502">if</span>&nbsp;<span class="op" id="5028505">!</span><span class="ident" id="5028506">isSent</span><span class="op" id="5028512">(</span><span class="op" id="5028513">&amp;</span><span class="ident" id="5028514">f</span><span class="op" id="5028515">)</span>&nbsp;<span class="op" id="5028517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028523">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028540">op</span><span class="op" id="5028542">,</span>&nbsp;<span class="ident" id="5028544">indir</span>&nbsp;<span class="op" id="5028550">:=</span>&nbsp;<span class="ident" id="5028553">encOpFor</span><span class="op" id="5028561">(</span><span class="ident" id="5028562">f</span><span class="op" id="5028563">.</span><span class="ident" id="5028564">Type</span><span class="op" id="5028568">,</span>&nbsp;<span class="ident" id="5028570">seen</span><span class="op" id="5028574">,</span>&nbsp;<span class="ident" id="5028576">building</span><span class="op" id="5028584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028589">engine</span><span class="op" id="5028595">.</span><span class="ident" id="5028596">instr</span>&nbsp;<span class="op" id="5028602">=</span>&nbsp;<span class="builtinfunc" id="5028604">append</span><span class="op" id="5028610">(</span><span class="ident" id="5028611">engine</span><span class="op" id="5028617">.</span><span class="ident" id="5028618">instr</span><span class="op" id="5028623">,</span>&nbsp;<span class="ident" id="5028625">encInstr</span><span class="op" id="5028633">{</span><span class="op" id="5028634">*</span><span class="ident" id="5028635">op</span><span class="op" id="5028637">,</span>&nbsp;<span class="ident" id="5028639">wireFieldNum</span><span class="op" id="5028651">,</span>&nbsp;<span class="ident" id="5028653">f</span><span class="op" id="5028654">.</span><span class="ident" id="5028655">Index</span><span class="op" id="5028660">,</span>&nbsp;<span class="ident" id="5028662">indir</span><span class="op" id="5028667">}</span><span class="op" id="5028668">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028673">wireFieldNum</span><span class="op" id="5028685">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028694">if</span>&nbsp;<span class="ident" id="5028697">srt</span><span class="op" id="5028700">.</span><span class="ident" id="5028701">NumField</span><span class="op" id="5028709">(</span><span class="op" id="5028710">)</span>&nbsp;<span class="op" id="5028712">&gt;</span>&nbsp;<span class="num" id="5028714">0</span>&nbsp;<span class="op" id="5028716">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5028719">len</span><span class="op" id="5028722">(</span><span class="ident" id="5028723">engine</span><span class="op" id="5028729">.</span><span class="ident" id="5028730">instr</span><span class="op" id="5028735">)</span>&nbsp;<span class="op" id="5028737">==</span>&nbsp;<span class="num" id="5028740">0</span>&nbsp;<span class="op" id="5028742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028747">errorf</span><span class="op" id="5028753">(</span><span class="string" id="5028754">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="5028786">,</span>&nbsp;<span class="ident" id="5028788">rt</span><span class="op" id="5028790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028794">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028798">engine</span><span class="op" id="5028804">.</span><span class="ident" id="5028805">instr</span>&nbsp;<span class="op" id="5028811">=</span>&nbsp;<span class="builtinfunc" id="5028813">append</span><span class="op" id="5028819">(</span><span class="ident" id="5028820">engine</span><span class="op" id="5028826">.</span><span class="ident" id="5028827">instr</span><span class="op" id="5028832">,</span>&nbsp;<span class="ident" id="5028834">encInstr</span><span class="op" id="5028842">{</span><span class="ident" id="5028843">encStructTerminator</span><span class="op" id="5028862">,</span>&nbsp;<span class="num" id="5028864">0</span><span class="op" id="5028865">,</span>&nbsp;<span class="ident" id="5028867">nil</span><span class="op" id="5028870">,</span>&nbsp;<span class="num" id="5028872">0</span><span class="op" id="5028873">}</span><span class="op" id="5028874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028877">}</span>&nbsp;<span class="keyword" id="5028879">else</span>&nbsp;<span class="op" id="5028884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028888">engine</span><span class="op" id="5028894">.</span><span class="ident" id="5028895">instr</span>&nbsp;<span class="op" id="5028901">=</span>&nbsp;<span class="builtinfunc" id="5028903">make</span><span class="op" id="5028907">(</span><span class="op" id="5028908">[</span><span class="op" id="5028909">]</span><span class="ident" id="5028910">encInstr</span><span class="op" id="5028918">,</span>&nbsp;<span class="num" id="5028920">1</span><span class="op" id="5028921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028925">op</span><span class="op" id="5028927">,</span>&nbsp;<span class="ident" id="5028929">indir</span>&nbsp;<span class="op" id="5028935">:=</span>&nbsp;<span class="ident" id="5028938">encOpFor</span><span class="op" id="5028946">(</span><span class="ident" id="5028947">rt</span><span class="op" id="5028949">,</span>&nbsp;<span class="ident" id="5028951">seen</span><span class="op" id="5028955">,</span>&nbsp;<span class="ident" id="5028957">building</span><span class="op" id="5028965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028969">engine</span><span class="op" id="5028975">.</span><span class="ident" id="5028976">instr</span><span class="op" id="5028981">[</span><span class="num" id="5028982">0</span><span class="op" id="5028983">]</span>&nbsp;<span class="op" id="5028985">=</span>&nbsp;<span class="ident" id="5028987">encInstr</span><span class="op" id="5028995">{</span><span class="op" id="5028996">*</span><span class="ident" id="5028997">op</span><span class="op" id="5028999">,</span>&nbsp;<span class="ident" id="5029001">singletonField</span><span class="op" id="5029015">,</span>&nbsp;<span class="ident" id="5029017">nil</span><span class="op" id="5029020">,</span>&nbsp;<span class="ident" id="5029022">indir</span><span class="op" id="5029027">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029033">return</span>&nbsp;<span class="ident" id="5029040">engine</span><br>
<span class="lineno"></span><span class="op" id="5029047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5029050">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="5029106">func</span>&nbsp;<span class="ident" id="5029111">getEncEngine</span><span class="op" id="5029123">(</span><span class="ident" id="5029124">ut</span>&nbsp;<span class="op" id="5029127">*</span><span class="ident" id="5029128">userTypeInfo</span><span class="op" id="5029140">,</span>&nbsp;<span class="ident" id="5029142">building</span>&nbsp;<span class="keyword" id="5029151">map</span><span class="op" id="5029154">[</span><span class="op" id="5029155">*</span><span class="ident" id="5029156">typeInfo</span><span class="op" id="5029164">]</span><span class="builtintype" id="5029165">bool</span><span class="op" id="5029169">)</span>&nbsp;<span class="op" id="5029171">*</span><span class="ident" id="5029172">encEngine</span>&nbsp;<span class="op" id="5029182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029185">info</span><span class="op" id="5029189">,</span>&nbsp;<span class="ident" id="5029191">err</span>&nbsp;<span class="op" id="5029195">:=</span>&nbsp;<span class="ident" id="5029198">getTypeInfo</span><span class="op" id="5029209">(</span><span class="ident" id="5029210">ut</span><span class="op" id="5029212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029215">if</span>&nbsp;<span class="ident" id="5029218">err</span>&nbsp;<span class="op" id="5029222">!=</span>&nbsp;<span class="ident" id="5029225">nil</span>&nbsp;<span class="op" id="5029229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029233">error_</span><span class="op" id="5029239">(</span><span class="ident" id="5029240">err</span><span class="op" id="5029243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029246">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029249">enc</span><span class="op" id="5029252">,</span>&nbsp;<span class="ident" id="5029254">ok</span>&nbsp;<span class="op" id="5029257">:=</span>&nbsp;<span class="ident" id="5029260">info</span><span class="op" id="5029264">.</span><span class="ident" id="5029265">encoder</span><span class="op" id="5029272">.</span><span class="ident" id="5029273">Load</span><span class="op" id="5029277">(</span><span class="op" id="5029278">)</span><span class="op" id="5029279">.</span><span class="op" id="5029280">(</span><span class="op" id="5029281">*</span><span class="ident" id="5029282">encEngine</span><span class="op" id="5029291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029294">if</span>&nbsp;<span class="op" id="5029297">!</span><span class="ident" id="5029298">ok</span>&nbsp;<span class="op" id="5029301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029305">enc</span>&nbsp;<span class="op" id="5029309">=</span>&nbsp;<span class="ident" id="5029311">buildEncEngine</span><span class="op" id="5029325">(</span><span class="ident" id="5029326">info</span><span class="op" id="5029330">,</span>&nbsp;<span class="ident" id="5029332">ut</span><span class="op" id="5029334">,</span>&nbsp;<span class="ident" id="5029336">building</span><span class="op" id="5029344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029350">return</span>&nbsp;<span class="ident" id="5029357">enc</span><br>
<span class="lineno">660</span><span class="op" id="5029361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5029364">func</span>&nbsp;<span class="ident" id="5029369">buildEncEngine</span><span class="op" id="5029383">(</span><span class="ident" id="5029384">info</span>&nbsp;<span class="op" id="5029389">*</span><span class="ident" id="5029390">typeInfo</span><span class="op" id="5029398">,</span>&nbsp;<span class="ident" id="5029400">ut</span>&nbsp;<span class="op" id="5029403">*</span><span class="ident" id="5029404">userTypeInfo</span><span class="op" id="5029416">,</span>&nbsp;<span class="ident" id="5029418">building</span>&nbsp;<span class="keyword" id="5029427">map</span><span class="op" id="5029430">[</span><span class="op" id="5029431">*</span><span class="ident" id="5029432">typeInfo</span><span class="op" id="5029440">]</span><span class="builtintype" id="5029441">bool</span><span class="op" id="5029445">)</span>&nbsp;<span class="op" id="5029447">*</span><span class="ident" id="5029448">encEngine</span>&nbsp;<span class="op" id="5029458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029461">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029492">if</span>&nbsp;<span class="ident" id="5029495">building</span>&nbsp;<span class="op" id="5029504">!=</span>&nbsp;<span class="ident" id="5029507">nil</span>&nbsp;<span class="op" id="5029511">&amp;&amp;</span>&nbsp;<span class="ident" id="5029514">building</span><span class="op" id="5029522">[</span><span class="ident" id="5029523">info</span><span class="op" id="5029527">]</span>&nbsp;<span class="op" id="5029529">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029533">return</span>&nbsp;<span class="ident" id="5029540">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029548">info</span><span class="op" id="5029552">.</span><span class="ident" id="5029553">encInit</span><span class="op" id="5029560">.</span><span class="ident" id="5029561">Lock</span><span class="op" id="5029565">(</span><span class="op" id="5029566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029569">defer</span>&nbsp;<span class="ident" id="5029575">info</span><span class="op" id="5029579">.</span><span class="ident" id="5029580">encInit</span><span class="op" id="5029587">.</span><span class="ident" id="5029588">Unlock</span><span class="op" id="5029594">(</span><span class="op" id="5029595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029598">enc</span><span class="op" id="5029601">,</span>&nbsp;<span class="ident" id="5029603">ok</span>&nbsp;<span class="op" id="5029606">:=</span>&nbsp;<span class="ident" id="5029609">info</span><span class="op" id="5029613">.</span><span class="ident" id="5029614">encoder</span><span class="op" id="5029621">.</span><span class="ident" id="5029622">Load</span><span class="op" id="5029626">(</span><span class="op" id="5029627">)</span><span class="op" id="5029628">.</span><span class="op" id="5029629">(</span><span class="op" id="5029630">*</span><span class="ident" id="5029631">encEngine</span><span class="op" id="5029640">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029643">if</span>&nbsp;<span class="op" id="5029646">!</span><span class="ident" id="5029647">ok</span>&nbsp;<span class="op" id="5029650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029654">if</span>&nbsp;<span class="ident" id="5029657">building</span>&nbsp;<span class="op" id="5029666">==</span>&nbsp;<span class="ident" id="5029669">nil</span>&nbsp;<span class="op" id="5029673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029678">building</span>&nbsp;<span class="op" id="5029687">=</span>&nbsp;<span class="builtinfunc" id="5029689">make</span><span class="op" id="5029693">(</span><span class="keyword" id="5029694">map</span><span class="op" id="5029697">[</span><span class="op" id="5029698">*</span><span class="ident" id="5029699">typeInfo</span><span class="op" id="5029707">]</span><span class="builtintype" id="5029708">bool</span><span class="op" id="5029712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029720">building</span><span class="op" id="5029728">[</span><span class="ident" id="5029729">info</span><span class="op" id="5029733">]</span>&nbsp;<span class="op" id="5029735">=</span>&nbsp;<span class="builtintype" id="5029737">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029744">enc</span>&nbsp;<span class="op" id="5029748">=</span>&nbsp;<span class="ident" id="5029750">compileEnc</span><span class="op" id="5029760">(</span><span class="ident" id="5029761">ut</span><span class="op" id="5029763">,</span>&nbsp;<span class="ident" id="5029765">building</span><span class="op" id="5029773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029777">info</span><span class="op" id="5029781">.</span><span class="ident" id="5029782">encoder</span><span class="op" id="5029789">.</span><span class="ident" id="5029790">Store</span><span class="op" id="5029795">(</span><span class="ident" id="5029796">enc</span><span class="op" id="5029799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029805">return</span>&nbsp;<span class="ident" id="5029812">enc</span><br>
<span class="lineno"></span><span class="op" id="5029816">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5029819">func</span>&nbsp;<span class="op" id="5029824">(</span><span class="ident" id="5029825">enc</span>&nbsp;<span class="op" id="5029829">*</span><span class="ident" id="5029830">Encoder</span><span class="op" id="5029837">)</span>&nbsp;<span class="ident" id="5029839">encode</span><span class="op" id="5029845">(</span><span class="ident" id="5029846">b</span>&nbsp;<span class="op" id="5029848">*</span><span class="ident" id="5029849">encBuffer</span><span class="op" id="5029858">,</span>&nbsp;<span class="ident" id="5029860">value</span>&nbsp;<span class="ident" id="5029866">reflect</span><span class="op" id="5029873">.</span><span class="ident" id="5029874">Value</span><span class="op" id="5029879">,</span>&nbsp;<span class="ident" id="5029881">ut</span>&nbsp;<span class="op" id="5029884">*</span><span class="ident" id="5029885">userTypeInfo</span><span class="op" id="5029897">)</span>&nbsp;<span class="op" id="5029899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029902">defer</span>&nbsp;<span class="ident" id="5029908">catchError</span><span class="op" id="5029918">(</span><span class="op" id="5029919">&amp;</span><span class="ident" id="5029920">enc</span><span class="op" id="5029923">.</span><span class="ident" id="5029924">err</span><span class="op" id="5029927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029930">engine</span>&nbsp;<span class="op" id="5029937">:=</span>&nbsp;<span class="ident" id="5029940">getEncEngine</span><span class="op" id="5029952">(</span><span class="ident" id="5029953">ut</span><span class="op" id="5029955">,</span>&nbsp;<span class="ident" id="5029957">nil</span><span class="op" id="5029960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029963">indir</span>&nbsp;<span class="op" id="5029969">:=</span>&nbsp;<span class="ident" id="5029972">ut</span><span class="op" id="5029974">.</span><span class="ident" id="5029975">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029982">if</span>&nbsp;<span class="ident" id="5029985">ut</span><span class="op" id="5029987">.</span><span class="ident" id="5029988">externalEnc</span>&nbsp;<span class="op" id="5030000">!=</span>&nbsp;<span class="num" id="5030003">0</span>&nbsp;<span class="op" id="5030005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030009">indir</span>&nbsp;<span class="op" id="5030015">=</span>&nbsp;<span class="builtintype" id="5030017">int</span><span class="op" id="5030020">(</span><span class="ident" id="5030021">ut</span><span class="op" id="5030023">.</span><span class="ident" id="5030024">encIndir</span><span class="op" id="5030032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5030035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5030038">for</span>&nbsp;<span class="ident" id="5030042">i</span>&nbsp;<span class="op" id="5030044">:=</span>&nbsp;<span class="num" id="5030047">0</span><span class="op" id="5030048">;</span>&nbsp;<span class="ident" id="5030050">i</span>&nbsp;<span class="op" id="5030052">&lt;</span>&nbsp;<span class="ident" id="5030054">indir</span><span class="op" id="5030059">;</span>&nbsp;<span class="ident" id="5030061">i</span><span class="op" id="5030062">++</span>&nbsp;<span class="op" id="5030065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030069">value</span>&nbsp;<span class="op" id="5030075">=</span>&nbsp;<span class="ident" id="5030077">reflect</span><span class="op" id="5030084">.</span><span class="ident" id="5030085">Indirect</span><span class="op" id="5030093">(</span><span class="ident" id="5030094">value</span><span class="op" id="5030099">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5030102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5030105">if</span>&nbsp;<span class="ident" id="5030108">ut</span><span class="op" id="5030110">.</span><span class="ident" id="5030111">externalEnc</span>&nbsp;<span class="op" id="5030123">==</span>&nbsp;<span class="num" id="5030126">0</span>&nbsp;<span class="op" id="5030128">&amp;&amp;</span>&nbsp;<span class="ident" id="5030131">value</span><span class="op" id="5030136">.</span><span class="ident" id="5030137">Type</span><span class="op" id="5030141">(</span><span class="op" id="5030142">)</span><span class="op" id="5030143">.</span><span class="ident" id="5030144">Kind</span><span class="op" id="5030148">(</span><span class="op" id="5030149">)</span>&nbsp;<span class="op" id="5030151">==</span>&nbsp;<span class="ident" id="5030154">reflect</span><span class="op" id="5030161">.</span><span class="ident" id="5030162">Struct</span>&nbsp;<span class="op" id="5030169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030173">enc</span><span class="op" id="5030176">.</span><span class="ident" id="5030177">encodeStruct</span><span class="op" id="5030189">(</span><span class="ident" id="5030190">b</span><span class="op" id="5030191">,</span>&nbsp;<span class="ident" id="5030193">engine</span><span class="op" id="5030199">,</span>&nbsp;<span class="ident" id="5030201">value</span><span class="op" id="5030206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5030209">}</span>&nbsp;<span class="keyword" id="5030211">else</span>&nbsp;<span class="op" id="5030216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030220">enc</span><span class="op" id="5030223">.</span><span class="ident" id="5030224">encodeSingle</span><span class="op" id="5030236">(</span><span class="ident" id="5030237">b</span><span class="op" id="5030238">,</span>&nbsp;<span class="ident" id="5030240">engine</span><span class="op" id="5030246">,</span>&nbsp;<span class="ident" id="5030248">value</span><span class="op" id="5030253">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5030256">}</span><br>
<span class="lineno"></span><span class="op" id="5030258">}</span>
</div>
</body>
</html>
