<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html" class="current">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4022431">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4022486">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4022540">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4022591">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4022629">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="4022703">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4022776">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4022810">package</span>&nbsp;<span class="ident" id="4022818">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4022826">type</span>&nbsp;<span class="ident" id="4022831">cbc</span>&nbsp;<span class="keyword" id="4022835">struct</span>&nbsp;<span class="op" id="4022842">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022845">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022855">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022862">blockSize</span>&nbsp;<span class="builtintype" id="4022872">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022877">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4022887">[</span><span class="op" id="4022888">]</span><span class="builtintype" id="4022889">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022895">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4022905">[</span><span class="op" id="4022906">]</span><span class="builtintype" id="4022907">byte</span><br>
<span class="lineno"></span><span class="op" id="4022912">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4022915">func</span>&nbsp;<span class="ident" id="4022920">newCBC</span><span class="op" id="4022926">(</span><span class="ident" id="4022927">b</span>&nbsp;<span class="ident" id="4022929">Block</span><span class="op" id="4022934">,</span>&nbsp;<span class="ident" id="4022936">iv</span>&nbsp;<span class="op" id="4022939">[</span><span class="op" id="4022940">]</span><span class="builtintype" id="4022941">byte</span><span class="op" id="4022945">)</span>&nbsp;<span class="op" id="4022947">*</span><span class="ident" id="4022948">cbc</span>&nbsp;<span class="op" id="4022952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022955">return</span>&nbsp;<span class="op" id="4022962">&amp;</span><span class="ident" id="4022963">cbc</span><span class="op" id="4022966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022970">b</span><span class="op" id="4022971">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022981">b</span><span class="op" id="4022982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022986">blockSize</span><span class="op" id="4022995">:</span>&nbsp;<span class="ident" id="4022997">b</span><span class="op" id="4022998">.</span><span class="ident" id="4022999">BlockSize</span><span class="op" id="4023008">(</span><span class="op" id="4023009">)</span><span class="op" id="4023010">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4023014">iv</span><span class="op" id="4023016">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4023025">dup</span><span class="op" id="4023028">(</span><span class="ident" id="4023029">iv</span><span class="op" id="4023031">)</span><span class="op" id="4023032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4023036">tmp</span><span class="op" id="4023039">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4023047">make</span><span class="op" id="4023051">(</span><span class="op" id="4023052">[</span><span class="op" id="4023053">]</span><span class="builtintype" id="4023054">byte</span><span class="op" id="4023058">,</span>&nbsp;<span class="ident" id="4023060">b</span><span class="op" id="4023061">.</span><span class="ident" id="4023062">BlockSize</span><span class="op" id="4023071">(</span><span class="op" id="4023072">)</span><span class="op" id="4023073">)</span><span class="op" id="4023074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4023077">}</span><br>
<span class="lineno"></span><span class="op" id="4023079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="4023082">type</span>&nbsp;<span class="ident" id="4023087">cbcEncrypter</span>&nbsp;<span class="ident" id="4023100">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4023105">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="4023184">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4023257">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="4023280">func</span>&nbsp;<span class="ident" id="4023285">NewCBCEncrypter</span><span class="op" id="4023300">(</span><span class="ident" id="4023301">b</span>&nbsp;<span class="ident" id="4023303">Block</span><span class="op" id="4023308">,</span>&nbsp;<span class="ident" id="4023310">iv</span>&nbsp;<span class="op" id="4023313">[</span><span class="op" id="4023314">]</span><span class="builtintype" id="4023315">byte</span><span class="op" id="4023319">)</span>&nbsp;<span class="ident" id="4023321">BlockMode</span>&nbsp;<span class="op" id="4023331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4023334">if</span>&nbsp;<span class="builtinfunc" id="4023337">len</span><span class="op" id="4023340">(</span><span class="ident" id="4023341">iv</span><span class="op" id="4023343">)</span>&nbsp;<span class="op" id="4023345">!=</span>&nbsp;<span class="ident" id="4023348">b</span><span class="op" id="4023349">.</span><span class="ident" id="4023350">BlockSize</span><span class="op" id="4023359">(</span><span class="op" id="4023360">)</span>&nbsp;<span class="op" id="4023362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4023366">panic</span><span class="op" id="4023371">(</span><span class="string" id="4023372">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="4023429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4023432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4023435">return</span>&nbsp;<span class="op" id="4023442">(</span><span class="op" id="4023443">*</span><span class="ident" id="4023444">cbcEncrypter</span><span class="op" id="4023456">)</span><span class="op" id="4023457">(</span><span class="ident" id="4023458">newCBC</span><span class="op" id="4023464">(</span><span class="ident" id="4023465">b</span><span class="op" id="4023466">,</span>&nbsp;<span class="ident" id="4023468">iv</span><span class="op" id="4023470">)</span><span class="op" id="4023471">)</span><br>
<span class="lineno">40</span><span class="op" id="4023473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4023476">func</span>&nbsp;<span class="op" id="4023481">(</span><span class="ident" id="4023482">x</span>&nbsp;<span class="op" id="4023484">*</span><span class="ident" id="4023485">cbcEncrypter</span><span class="op" id="4023497">)</span>&nbsp;<span class="ident" id="4023499">BlockSize</span><span class="op" id="4023508">(</span><span class="op" id="4023509">)</span>&nbsp;<span class="builtintype" id="4023511">int</span>&nbsp;<span class="op" id="4023515">{</span>&nbsp;<span class="keyword" id="4023517">return</span>&nbsp;<span class="ident" id="4023524">x</span><span class="op" id="4023525">.</span><span class="ident" id="4023526">blockSize</span>&nbsp;<span class="op" id="4023536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4023539">func</span>&nbsp;<span class="op" id="4023544">(</span><span class="ident" id="4023545">x</span>&nbsp;<span class="op" id="4023547">*</span><span class="ident" id="4023548">cbcEncrypter</span><span class="op" id="4023560">)</span>&nbsp;<span class="ident" id="4023562">CryptBlocks</span><span class="op" id="4023573">(</span><span class="ident" id="4023574">dst</span><span class="op" id="4023577">,</span>&nbsp;<span class="ident" id="4023579">src</span>&nbsp;<span class="op" id="4023583">[</span><span class="op" id="4023584">]</span><span class="builtintype" id="4023585">byte</span><span class="op" id="4023589">)</span>&nbsp;<span class="op" id="4023591">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4023594">if</span>&nbsp;<span class="builtinfunc" id="4023597">len</span><span class="op" id="4023600">(</span><span class="ident" id="4023601">src</span><span class="op" id="4023604">)</span><span class="op" id="4023605">%</span><span class="ident" id="4023606">x</span><span class="op" id="4023607">.</span><span class="ident" id="4023608">blockSize</span>&nbsp;<span class="op" id="4023618">!=</span>&nbsp;<span class="num" id="4023621">0</span>&nbsp;<span class="op" id="4023623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4023627">panic</span><span class="op" id="4023632">(</span><span class="string" id="4023633">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="4023671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4023674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4023677">if</span>&nbsp;<span class="builtinfunc" id="4023680">len</span><span class="op" id="4023683">(</span><span class="ident" id="4023684">dst</span><span class="op" id="4023687">)</span>&nbsp;<span class="op" id="4023689">&lt;</span>&nbsp;<span class="builtinfunc" id="4023691">len</span><span class="op" id="4023694">(</span><span class="ident" id="4023695">src</span><span class="op" id="4023698">)</span>&nbsp;<span class="op" id="4023700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4023704">panic</span><span class="op" id="4023709">(</span><span class="string" id="4023710">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="4023752">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4023755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4023759">iv</span>&nbsp;<span class="op" id="4023762">:=</span>&nbsp;<span class="ident" id="4023765">x</span><span class="op" id="4023766">.</span><span class="ident" id="4023767">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4023772">for</span>&nbsp;<span class="builtinfunc" id="4023776">len</span><span class="op" id="4023779">(</span><span class="ident" id="4023780">src</span><span class="op" id="4023783">)</span>&nbsp;<span class="op" id="4023785">&gt;</span>&nbsp;<span class="num" id="4023787">0</span>&nbsp;<span class="op" id="4023789">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4023793">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4023843">xorBytes</span><span class="op" id="4023851">(</span><span class="ident" id="4023852">dst</span><span class="op" id="4023855">[</span><span class="op" id="4023856">:</span><span class="ident" id="4023857">x</span><span class="op" id="4023858">.</span><span class="ident" id="4023859">blockSize</span><span class="op" id="4023868">]</span><span class="op" id="4023869">,</span>&nbsp;<span class="ident" id="4023871">src</span><span class="op" id="4023874">[</span><span class="op" id="4023875">:</span><span class="ident" id="4023876">x</span><span class="op" id="4023877">.</span><span class="ident" id="4023878">blockSize</span><span class="op" id="4023887">]</span><span class="op" id="4023888">,</span>&nbsp;<span class="ident" id="4023890">iv</span><span class="op" id="4023892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4023896">x</span><span class="op" id="4023897">.</span><span class="ident" id="4023898">b</span><span class="op" id="4023899">.</span><span class="ident" id="4023900">Encrypt</span><span class="op" id="4023907">(</span><span class="ident" id="4023908">dst</span><span class="op" id="4023911">[</span><span class="op" id="4023912">:</span><span class="ident" id="4023913">x</span><span class="op" id="4023914">.</span><span class="ident" id="4023915">blockSize</span><span class="op" id="4023924">]</span><span class="op" id="4023925">,</span>&nbsp;<span class="ident" id="4023927">dst</span><span class="op" id="4023930">[</span><span class="op" id="4023931">:</span><span class="ident" id="4023932">x</span><span class="op" id="4023933">.</span><span class="ident" id="4023934">blockSize</span><span class="op" id="4023943">]</span><span class="op" id="4023944">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4023949">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4024009">iv</span>&nbsp;<span class="op" id="4024012">=</span>&nbsp;<span class="ident" id="4024014">dst</span><span class="op" id="4024017">[</span><span class="op" id="4024018">:</span><span class="ident" id="4024019">x</span><span class="op" id="4024020">.</span><span class="ident" id="4024021">blockSize</span><span class="op" id="4024030">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4024034">src</span>&nbsp;<span class="op" id="4024038">=</span>&nbsp;<span class="ident" id="4024040">src</span><span class="op" id="4024043">[</span><span class="ident" id="4024044">x</span><span class="op" id="4024045">.</span><span class="ident" id="4024046">blockSize</span><span class="op" id="4024055">:</span><span class="op" id="4024056">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4024060">dst</span>&nbsp;<span class="op" id="4024064">=</span>&nbsp;<span class="ident" id="4024066">dst</span><span class="op" id="4024069">[</span><span class="ident" id="4024070">x</span><span class="op" id="4024071">.</span><span class="ident" id="4024072">blockSize</span><span class="op" id="4024081">:</span><span class="op" id="4024082">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4024085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4024089">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4024136">copy</span><span class="op" id="4024140">(</span><span class="ident" id="4024141">x</span><span class="op" id="4024142">.</span><span class="ident" id="4024143">iv</span><span class="op" id="4024145">,</span>&nbsp;<span class="ident" id="4024147">iv</span><span class="op" id="4024149">)</span><br>
<span class="lineno"></span><span class="op" id="4024151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4024154">func</span>&nbsp;<span class="op" id="4024159">(</span><span class="ident" id="4024160">x</span>&nbsp;<span class="op" id="4024162">*</span><span class="ident" id="4024163">cbcEncrypter</span><span class="op" id="4024175">)</span>&nbsp;<span class="ident" id="4024177">SetIV</span><span class="op" id="4024182">(</span><span class="ident" id="4024183">iv</span>&nbsp;<span class="op" id="4024186">[</span><span class="op" id="4024187">]</span><span class="builtintype" id="4024188">byte</span><span class="op" id="4024192">)</span>&nbsp;<span class="op" id="4024194">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4024197">if</span>&nbsp;<span class="builtinfunc" id="4024200">len</span><span class="op" id="4024203">(</span><span class="ident" id="4024204">iv</span><span class="op" id="4024206">)</span>&nbsp;<span class="op" id="4024208">!=</span>&nbsp;<span class="builtinfunc" id="4024211">len</span><span class="op" id="4024214">(</span><span class="ident" id="4024215">x</span><span class="op" id="4024216">.</span><span class="ident" id="4024217">iv</span><span class="op" id="4024219">)</span>&nbsp;<span class="op" id="4024221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4024225">panic</span><span class="op" id="4024230">(</span><span class="string" id="4024231">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="4024260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4024263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4024266">copy</span><span class="op" id="4024270">(</span><span class="ident" id="4024271">x</span><span class="op" id="4024272">.</span><span class="ident" id="4024273">iv</span><span class="op" id="4024275">,</span>&nbsp;<span class="ident" id="4024277">iv</span><span class="op" id="4024279">)</span><br>
<span class="lineno"></span><span class="op" id="4024281">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="4024284">type</span>&nbsp;<span class="ident" id="4024289">cbcDecrypter</span>&nbsp;<span class="ident" id="4024302">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4024307">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="4024386">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="4024459">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4024529">func</span>&nbsp;<span class="ident" id="4024534">NewCBCDecrypter</span><span class="op" id="4024549">(</span><span class="ident" id="4024550">b</span>&nbsp;<span class="ident" id="4024552">Block</span><span class="op" id="4024557">,</span>&nbsp;<span class="ident" id="4024559">iv</span>&nbsp;<span class="op" id="4024562">[</span><span class="op" id="4024563">]</span><span class="builtintype" id="4024564">byte</span><span class="op" id="4024568">)</span>&nbsp;<span class="ident" id="4024570">BlockMode</span>&nbsp;<span class="op" id="4024580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4024583">if</span>&nbsp;<span class="builtinfunc" id="4024586">len</span><span class="op" id="4024589">(</span><span class="ident" id="4024590">iv</span><span class="op" id="4024592">)</span>&nbsp;<span class="op" id="4024594">!=</span>&nbsp;<span class="ident" id="4024597">b</span><span class="op" id="4024598">.</span><span class="ident" id="4024599">BlockSize</span><span class="op" id="4024608">(</span><span class="op" id="4024609">)</span>&nbsp;<span class="op" id="4024611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4024615">panic</span><span class="op" id="4024620">(</span><span class="string" id="4024621">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="4024678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4024681">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4024684">return</span>&nbsp;<span class="op" id="4024691">(</span><span class="op" id="4024692">*</span><span class="ident" id="4024693">cbcDecrypter</span><span class="op" id="4024705">)</span><span class="op" id="4024706">(</span><span class="ident" id="4024707">newCBC</span><span class="op" id="4024713">(</span><span class="ident" id="4024714">b</span><span class="op" id="4024715">,</span>&nbsp;<span class="ident" id="4024717">iv</span><span class="op" id="4024719">)</span><span class="op" id="4024720">)</span><br>
<span class="lineno"></span><span class="op" id="4024722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4024725">func</span>&nbsp;<span class="op" id="4024730">(</span><span class="ident" id="4024731">x</span>&nbsp;<span class="op" id="4024733">*</span><span class="ident" id="4024734">cbcDecrypter</span><span class="op" id="4024746">)</span>&nbsp;<span class="ident" id="4024748">BlockSize</span><span class="op" id="4024757">(</span><span class="op" id="4024758">)</span>&nbsp;<span class="builtintype" id="4024760">int</span>&nbsp;<span class="op" id="4024764">{</span>&nbsp;<span class="keyword" id="4024766">return</span>&nbsp;<span class="ident" id="4024773">x</span><span class="op" id="4024774">.</span><span class="ident" id="4024775">blockSize</span>&nbsp;<span class="op" id="4024785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="4024788">func</span>&nbsp;<span class="op" id="4024793">(</span><span class="ident" id="4024794">x</span>&nbsp;<span class="op" id="4024796">*</span><span class="ident" id="4024797">cbcDecrypter</span><span class="op" id="4024809">)</span>&nbsp;<span class="ident" id="4024811">CryptBlocks</span><span class="op" id="4024822">(</span><span class="ident" id="4024823">dst</span><span class="op" id="4024826">,</span>&nbsp;<span class="ident" id="4024828">src</span>&nbsp;<span class="op" id="4024832">[</span><span class="op" id="4024833">]</span><span class="builtintype" id="4024834">byte</span><span class="op" id="4024838">)</span>&nbsp;<span class="op" id="4024840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4024843">if</span>&nbsp;<span class="builtinfunc" id="4024846">len</span><span class="op" id="4024849">(</span><span class="ident" id="4024850">src</span><span class="op" id="4024853">)</span><span class="op" id="4024854">%</span><span class="ident" id="4024855">x</span><span class="op" id="4024856">.</span><span class="ident" id="4024857">blockSize</span>&nbsp;<span class="op" id="4024867">!=</span>&nbsp;<span class="num" id="4024870">0</span>&nbsp;<span class="op" id="4024872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4024876">panic</span><span class="op" id="4024881">(</span><span class="string" id="4024882">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="4024920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4024923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4024926">if</span>&nbsp;<span class="builtinfunc" id="4024929">len</span><span class="op" id="4024932">(</span><span class="ident" id="4024933">dst</span><span class="op" id="4024936">)</span>&nbsp;<span class="op" id="4024938">&lt;</span>&nbsp;<span class="builtinfunc" id="4024940">len</span><span class="op" id="4024943">(</span><span class="ident" id="4024944">src</span><span class="op" id="4024947">)</span>&nbsp;<span class="op" id="4024949">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4024953">panic</span><span class="op" id="4024958">(</span><span class="string" id="4024959">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="4025001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4025004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4025007">if</span>&nbsp;<span class="builtinfunc" id="4025010">len</span><span class="op" id="4025013">(</span><span class="ident" id="4025014">src</span><span class="op" id="4025017">)</span>&nbsp;<span class="op" id="4025019">==</span>&nbsp;<span class="num" id="4025022">0</span>&nbsp;<span class="op" id="4025024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4025028">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4025036">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4025040">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4025141">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025214">end</span>&nbsp;<span class="op" id="4025218">:=</span>&nbsp;<span class="builtinfunc" id="4025221">len</span><span class="op" id="4025224">(</span><span class="ident" id="4025225">src</span><span class="op" id="4025228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025231">start</span>&nbsp;<span class="op" id="4025237">:=</span>&nbsp;<span class="ident" id="4025240">end</span>&nbsp;<span class="op" id="4025244">-</span>&nbsp;<span class="ident" id="4025246">x</span><span class="op" id="4025247">.</span><span class="ident" id="4025248">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025259">prev</span>&nbsp;<span class="op" id="4025264">:=</span>&nbsp;<span class="ident" id="4025267">start</span>&nbsp;<span class="op" id="4025273">-</span>&nbsp;<span class="ident" id="4025275">x</span><span class="op" id="4025276">.</span><span class="ident" id="4025277">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4025289">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4025357">copy</span><span class="op" id="4025361">(</span><span class="ident" id="4025362">x</span><span class="op" id="4025363">.</span><span class="ident" id="4025364">tmp</span><span class="op" id="4025367">,</span>&nbsp;<span class="ident" id="4025369">src</span><span class="op" id="4025372">[</span><span class="ident" id="4025373">start</span><span class="op" id="4025378">:</span><span class="ident" id="4025379">end</span><span class="op" id="4025382">]</span><span class="op" id="4025383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4025387">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4025426">for</span>&nbsp;<span class="ident" id="4025430">start</span>&nbsp;<span class="op" id="4025436">&gt;</span>&nbsp;<span class="num" id="4025438">0</span>&nbsp;<span class="op" id="4025440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025444">x</span><span class="op" id="4025445">.</span><span class="ident" id="4025446">b</span><span class="op" id="4025447">.</span><span class="ident" id="4025448">Decrypt</span><span class="op" id="4025455">(</span><span class="ident" id="4025456">dst</span><span class="op" id="4025459">[</span><span class="ident" id="4025460">start</span><span class="op" id="4025465">:</span><span class="ident" id="4025466">end</span><span class="op" id="4025469">]</span><span class="op" id="4025470">,</span>&nbsp;<span class="ident" id="4025472">src</span><span class="op" id="4025475">[</span><span class="ident" id="4025476">start</span><span class="op" id="4025481">:</span><span class="ident" id="4025482">end</span><span class="op" id="4025485">]</span><span class="op" id="4025486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025490">xorBytes</span><span class="op" id="4025498">(</span><span class="ident" id="4025499">dst</span><span class="op" id="4025502">[</span><span class="ident" id="4025503">start</span><span class="op" id="4025508">:</span><span class="ident" id="4025509">end</span><span class="op" id="4025512">]</span><span class="op" id="4025513">,</span>&nbsp;<span class="ident" id="4025515">dst</span><span class="op" id="4025518">[</span><span class="ident" id="4025519">start</span><span class="op" id="4025524">:</span><span class="ident" id="4025525">end</span><span class="op" id="4025528">]</span><span class="op" id="4025529">,</span>&nbsp;<span class="ident" id="4025531">src</span><span class="op" id="4025534">[</span><span class="ident" id="4025535">prev</span><span class="op" id="4025539">:</span><span class="ident" id="4025540">start</span><span class="op" id="4025545">]</span><span class="op" id="4025546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025551">end</span>&nbsp;<span class="op" id="4025555">=</span>&nbsp;<span class="ident" id="4025557">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025565">start</span>&nbsp;<span class="op" id="4025571">=</span>&nbsp;<span class="ident" id="4025573">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025580">prev</span>&nbsp;<span class="op" id="4025585">-=</span>&nbsp;<span class="ident" id="4025588">x</span><span class="op" id="4025589">.</span><span class="ident" id="4025590">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4025601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4025605">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025666">x</span><span class="op" id="4025667">.</span><span class="ident" id="4025668">b</span><span class="op" id="4025669">.</span><span class="ident" id="4025670">Decrypt</span><span class="op" id="4025677">(</span><span class="ident" id="4025678">dst</span><span class="op" id="4025681">[</span><span class="ident" id="4025682">start</span><span class="op" id="4025687">:</span><span class="ident" id="4025688">end</span><span class="op" id="4025691">]</span><span class="op" id="4025692">,</span>&nbsp;<span class="ident" id="4025694">src</span><span class="op" id="4025697">[</span><span class="ident" id="4025698">start</span><span class="op" id="4025703">:</span><span class="ident" id="4025704">end</span><span class="op" id="4025707">]</span><span class="op" id="4025708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025711">xorBytes</span><span class="op" id="4025719">(</span><span class="ident" id="4025720">dst</span><span class="op" id="4025723">[</span><span class="ident" id="4025724">start</span><span class="op" id="4025729">:</span><span class="ident" id="4025730">end</span><span class="op" id="4025733">]</span><span class="op" id="4025734">,</span>&nbsp;<span class="ident" id="4025736">dst</span><span class="op" id="4025739">[</span><span class="ident" id="4025740">start</span><span class="op" id="4025745">:</span><span class="ident" id="4025746">end</span><span class="op" id="4025749">]</span><span class="op" id="4025750">,</span>&nbsp;<span class="ident" id="4025752">x</span><span class="op" id="4025753">.</span><span class="ident" id="4025754">iv</span><span class="op" id="4025756">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4025760">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4025817">x</span><span class="op" id="4025818">.</span><span class="ident" id="4025819">iv</span><span class="op" id="4025821">,</span>&nbsp;<span class="ident" id="4025823">x</span><span class="op" id="4025824">.</span><span class="ident" id="4025825">tmp</span>&nbsp;<span class="op" id="4025829">=</span>&nbsp;<span class="ident" id="4025831">x</span><span class="op" id="4025832">.</span><span class="ident" id="4025833">tmp</span><span class="op" id="4025836">,</span>&nbsp;<span class="ident" id="4025838">x</span><span class="op" id="4025839">.</span><span class="ident" id="4025840">iv</span><br>
<span class="lineno"></span><span class="op" id="4025843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4025846">func</span>&nbsp;<span class="op" id="4025851">(</span><span class="ident" id="4025852">x</span>&nbsp;<span class="op" id="4025854">*</span><span class="ident" id="4025855">cbcDecrypter</span><span class="op" id="4025867">)</span>&nbsp;<span class="ident" id="4025869">SetIV</span><span class="op" id="4025874">(</span><span class="ident" id="4025875">iv</span>&nbsp;<span class="op" id="4025878">[</span><span class="op" id="4025879">]</span><span class="builtintype" id="4025880">byte</span><span class="op" id="4025884">)</span>&nbsp;<span class="op" id="4025886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4025889">if</span>&nbsp;<span class="builtinfunc" id="4025892">len</span><span class="op" id="4025895">(</span><span class="ident" id="4025896">iv</span><span class="op" id="4025898">)</span>&nbsp;<span class="op" id="4025900">!=</span>&nbsp;<span class="builtinfunc" id="4025903">len</span><span class="op" id="4025906">(</span><span class="ident" id="4025907">x</span><span class="op" id="4025908">.</span><span class="ident" id="4025909">iv</span><span class="op" id="4025911">)</span>&nbsp;<span class="op" id="4025913">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4025917">panic</span><span class="op" id="4025922">(</span><span class="string" id="4025923">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="4025952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4025955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4025958">copy</span><span class="op" id="4025962">(</span><span class="ident" id="4025963">x</span><span class="op" id="4025964">.</span><span class="ident" id="4025965">iv</span><span class="op" id="4025967">,</span>&nbsp;<span class="ident" id="4025969">iv</span><span class="op" id="4025971">)</span><br>
<span class="lineno"></span><span class="op" id="4025973">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
