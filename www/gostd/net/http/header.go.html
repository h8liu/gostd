<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4776099">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4776155">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4776209">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4776260">package</span>&nbsp;<span class="ident" id="4776268">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4776274">import</span>&nbsp;<span class="op" id="4776281">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4776284">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4776290">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4776307">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4776315">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4776326">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4776334">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4776341">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4776344">var</span>&nbsp;<span class="ident" id="4776348">raceEnabled</span>&nbsp;<span class="op" id="4776360">=</span>&nbsp;<span class="builtintype" id="4776362">false</span>&nbsp;<span class="comment" id="4776368">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4776387">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4776449">type</span>&nbsp;<span class="ident" id="4776454">Header</span>&nbsp;<span class="keyword" id="4776461">map</span><span class="op" id="4776464">[</span><span class="builtintype" id="4776465">string</span><span class="op" id="4776471">]</span><span class="op" id="4776472">[</span><span class="op" id="4776473">]</span><span class="builtintype" id="4776474">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4776482">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4776529">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4776587">func</span>&nbsp;<span class="op" id="4776592">(</span><span class="ident" id="4776593">h</span>&nbsp;<span class="ident" id="4776595">Header</span><span class="op" id="4776601">)</span>&nbsp;<span class="ident" id="4776603">Add</span><span class="op" id="4776606">(</span><span class="ident" id="4776607">key</span><span class="op" id="4776610">,</span>&nbsp;<span class="ident" id="4776612">value</span>&nbsp;<span class="builtintype" id="4776618">string</span><span class="op" id="4776624">)</span>&nbsp;<span class="op" id="4776626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776629">textproto</span><span class="op" id="4776638">.</span><span class="ident" id="4776639">MIMEHeader</span><span class="op" id="4776649">(</span><span class="ident" id="4776650">h</span><span class="op" id="4776651">)</span><span class="op" id="4776652">.</span><span class="ident" id="4776653">Add</span><span class="op" id="4776656">(</span><span class="ident" id="4776657">key</span><span class="op" id="4776660">,</span>&nbsp;<span class="ident" id="4776662">value</span><span class="op" id="4776667">)</span><br>
<span class="lineno">25</span><span class="op" id="4776669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4776672">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4776726">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="4776781">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="4776812">func</span>&nbsp;<span class="op" id="4776817">(</span><span class="ident" id="4776818">h</span>&nbsp;<span class="ident" id="4776820">Header</span><span class="op" id="4776826">)</span>&nbsp;<span class="ident" id="4776828">Set</span><span class="op" id="4776831">(</span><span class="ident" id="4776832">key</span><span class="op" id="4776835">,</span>&nbsp;<span class="ident" id="4776837">value</span>&nbsp;<span class="builtintype" id="4776843">string</span><span class="op" id="4776849">)</span>&nbsp;<span class="op" id="4776851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776854">textproto</span><span class="op" id="4776863">.</span><span class="ident" id="4776864">MIMEHeader</span><span class="op" id="4776874">(</span><span class="ident" id="4776875">h</span><span class="op" id="4776876">)</span><span class="op" id="4776877">.</span><span class="ident" id="4776878">Set</span><span class="op" id="4776881">(</span><span class="ident" id="4776882">key</span><span class="op" id="4776885">,</span>&nbsp;<span class="ident" id="4776887">value</span><span class="op" id="4776892">)</span><br>
<span class="lineno"></span><span class="op" id="4776894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4776897">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="4776956">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4777023">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="4777086">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="4777114">func</span>&nbsp;<span class="op" id="4777119">(</span><span class="ident" id="4777120">h</span>&nbsp;<span class="ident" id="4777122">Header</span><span class="op" id="4777128">)</span>&nbsp;<span class="ident" id="4777130">Get</span><span class="op" id="4777133">(</span><span class="ident" id="4777134">key</span>&nbsp;<span class="builtintype" id="4777138">string</span><span class="op" id="4777144">)</span>&nbsp;<span class="builtintype" id="4777146">string</span>&nbsp;<span class="op" id="4777153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777156">return</span>&nbsp;<span class="ident" id="4777163">textproto</span><span class="op" id="4777172">.</span><span class="ident" id="4777173">MIMEHeader</span><span class="op" id="4777183">(</span><span class="ident" id="4777184">h</span><span class="op" id="4777185">)</span><span class="op" id="4777186">.</span><span class="ident" id="4777187">Get</span><span class="op" id="4777190">(</span><span class="ident" id="4777191">key</span><span class="op" id="4777194">)</span><br>
<span class="lineno">40</span><span class="op" id="4777196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4777199">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="4777271">func</span>&nbsp;<span class="op" id="4777276">(</span><span class="ident" id="4777277">h</span>&nbsp;<span class="ident" id="4777279">Header</span><span class="op" id="4777285">)</span>&nbsp;<span class="ident" id="4777287">get</span><span class="op" id="4777290">(</span><span class="ident" id="4777291">key</span>&nbsp;<span class="builtintype" id="4777295">string</span><span class="op" id="4777301">)</span>&nbsp;<span class="builtintype" id="4777303">string</span>&nbsp;<span class="op" id="4777310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777313">if</span>&nbsp;<span class="ident" id="4777316">v</span>&nbsp;<span class="op" id="4777318">:=</span>&nbsp;<span class="ident" id="4777321">h</span><span class="op" id="4777322">[</span><span class="ident" id="4777323">key</span><span class="op" id="4777326">]</span><span class="op" id="4777327">;</span>&nbsp;<span class="builtinfunc" id="4777329">len</span><span class="op" id="4777332">(</span><span class="ident" id="4777333">v</span><span class="op" id="4777334">)</span>&nbsp;<span class="op" id="4777336">&gt;</span>&nbsp;<span class="num" id="4777338">0</span>&nbsp;<span class="op" id="4777340">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777344">return</span>&nbsp;<span class="ident" id="4777351">v</span><span class="op" id="4777352">[</span><span class="num" id="4777353">0</span><span class="op" id="4777354">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777360">return</span>&nbsp;<span class="string" id="4777367">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4777370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4777373">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4777420">func</span>&nbsp;<span class="op" id="4777425">(</span><span class="ident" id="4777426">h</span>&nbsp;<span class="ident" id="4777428">Header</span><span class="op" id="4777434">)</span>&nbsp;<span class="ident" id="4777436">Del</span><span class="op" id="4777439">(</span><span class="ident" id="4777440">key</span>&nbsp;<span class="builtintype" id="4777444">string</span><span class="op" id="4777450">)</span>&nbsp;<span class="op" id="4777452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777455">textproto</span><span class="op" id="4777464">.</span><span class="ident" id="4777465">MIMEHeader</span><span class="op" id="4777475">(</span><span class="ident" id="4777476">h</span><span class="op" id="4777477">)</span><span class="op" id="4777478">.</span><span class="ident" id="4777479">Del</span><span class="op" id="4777482">(</span><span class="ident" id="4777483">key</span><span class="op" id="4777486">)</span><br>
<span class="lineno"></span><span class="op" id="4777488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4777491">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="4777532">func</span>&nbsp;<span class="op" id="4777537">(</span><span class="ident" id="4777538">h</span>&nbsp;<span class="ident" id="4777540">Header</span><span class="op" id="4777546">)</span>&nbsp;<span class="ident" id="4777548">Write</span><span class="op" id="4777553">(</span><span class="ident" id="4777554">w</span>&nbsp;<span class="ident" id="4777556">io</span><span class="op" id="4777558">.</span><span class="ident" id="4777559">Writer</span><span class="op" id="4777565">)</span>&nbsp;<span class="builtintype" id="4777567">error</span>&nbsp;<span class="op" id="4777573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777576">return</span>&nbsp;<span class="ident" id="4777583">h</span><span class="op" id="4777584">.</span><span class="ident" id="4777585">WriteSubset</span><span class="op" id="4777596">(</span><span class="ident" id="4777597">w</span><span class="op" id="4777598">,</span>&nbsp;<span class="ident" id="4777600">nil</span><span class="op" id="4777603">)</span><br>
<span class="lineno"></span><span class="op" id="4777605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4777608">func</span>&nbsp;<span class="op" id="4777613">(</span><span class="ident" id="4777614">h</span>&nbsp;<span class="ident" id="4777616">Header</span><span class="op" id="4777622">)</span>&nbsp;<span class="ident" id="4777624">clone</span><span class="op" id="4777629">(</span><span class="op" id="4777630">)</span>&nbsp;<span class="ident" id="4777632">Header</span>&nbsp;<span class="op" id="4777639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777642">h2</span>&nbsp;<span class="op" id="4777645">:=</span>&nbsp;<span class="builtinfunc" id="4777648">make</span><span class="op" id="4777652">(</span><span class="ident" id="4777653">Header</span><span class="op" id="4777659">,</span>&nbsp;<span class="builtinfunc" id="4777661">len</span><span class="op" id="4777664">(</span><span class="ident" id="4777665">h</span><span class="op" id="4777666">)</span><span class="op" id="4777667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777670">for</span>&nbsp;<span class="ident" id="4777674">k</span><span class="op" id="4777675">,</span>&nbsp;<span class="ident" id="4777677">vv</span>&nbsp;<span class="op" id="4777680">:=</span>&nbsp;<span class="keyword" id="4777683">range</span>&nbsp;<span class="ident" id="4777689">h</span>&nbsp;<span class="op" id="4777691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777695">vv2</span>&nbsp;<span class="op" id="4777699">:=</span>&nbsp;<span class="builtinfunc" id="4777702">make</span><span class="op" id="4777706">(</span><span class="op" id="4777707">[</span><span class="op" id="4777708">]</span><span class="builtintype" id="4777709">string</span><span class="op" id="4777715">,</span>&nbsp;<span class="builtinfunc" id="4777717">len</span><span class="op" id="4777720">(</span><span class="ident" id="4777721">vv</span><span class="op" id="4777723">)</span><span class="op" id="4777724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4777728">copy</span><span class="op" id="4777732">(</span><span class="ident" id="4777733">vv2</span><span class="op" id="4777736">,</span>&nbsp;<span class="ident" id="4777738">vv</span><span class="op" id="4777740">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777744">h2</span><span class="op" id="4777746">[</span><span class="ident" id="4777747">k</span><span class="op" id="4777748">]</span>&nbsp;<span class="op" id="4777750">=</span>&nbsp;<span class="ident" id="4777752">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777760">return</span>&nbsp;<span class="ident" id="4777767">h2</span><br>
<span class="lineno"></span><span class="op" id="4777770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4777773">var</span>&nbsp;<span class="ident" id="4777777">timeFormats</span>&nbsp;<span class="op" id="4777789">=</span>&nbsp;<span class="op" id="4777791">[</span><span class="op" id="4777792">]</span><span class="builtintype" id="4777793">string</span><span class="op" id="4777799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777802">TimeFormat</span><span class="op" id="4777812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777815">time</span><span class="op" id="4777819">.</span><span class="ident" id="4777820">RFC850</span><span class="op" id="4777826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777829">time</span><span class="op" id="4777833">.</span><span class="ident" id="4777834">ANSIC</span><span class="op" id="4777839">,</span><br>
<span class="lineno"></span><span class="op" id="4777841">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="4777844">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="4777906">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="4777963">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="4778007">func</span>&nbsp;<span class="ident" id="4778012">ParseTime</span><span class="op" id="4778021">(</span><span class="ident" id="4778022">text</span>&nbsp;<span class="builtintype" id="4778027">string</span><span class="op" id="4778033">)</span>&nbsp;<span class="op" id="4778035">(</span><span class="ident" id="4778036">t</span>&nbsp;<span class="ident" id="4778038">time</span><span class="op" id="4778042">.</span><span class="ident" id="4778043">Time</span><span class="op" id="4778047">,</span>&nbsp;<span class="ident" id="4778049">err</span>&nbsp;<span class="builtintype" id="4778053">error</span><span class="op" id="4778058">)</span>&nbsp;<span class="op" id="4778060">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778063">for</span>&nbsp;<span class="ident" id="4778067">_</span><span class="op" id="4778068">,</span>&nbsp;<span class="ident" id="4778070">layout</span>&nbsp;<span class="op" id="4778077">:=</span>&nbsp;<span class="keyword" id="4778080">range</span>&nbsp;<span class="ident" id="4778086">timeFormats</span>&nbsp;<span class="op" id="4778098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778102">t</span><span class="op" id="4778103">,</span>&nbsp;<span class="ident" id="4778105">err</span>&nbsp;<span class="op" id="4778109">=</span>&nbsp;<span class="ident" id="4778111">time</span><span class="op" id="4778115">.</span><span class="ident" id="4778116">Parse</span><span class="op" id="4778121">(</span><span class="ident" id="4778122">layout</span><span class="op" id="4778128">,</span>&nbsp;<span class="ident" id="4778130">text</span><span class="op" id="4778134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778138">if</span>&nbsp;<span class="ident" id="4778141">err</span>&nbsp;<span class="op" id="4778145">==</span>&nbsp;<span class="ident" id="4778148">nil</span>&nbsp;<span class="op" id="4778152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778157">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778166">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778172">return</span><br>
<span class="lineno"></span><span class="op" id="4778179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4778182">var</span>&nbsp;<span class="ident" id="4778186">headerNewlineToSpace</span>&nbsp;<span class="op" id="4778207">=</span>&nbsp;<span class="ident" id="4778209">strings</span><span class="op" id="4778216">.</span><span class="ident" id="4778217">NewReplacer</span><span class="op" id="4778228">(</span><span class="string" id="4778229">&#34;\n&#34;</span><span class="op" id="4778233">,</span>&nbsp;<span class="string" id="4778235">&#34;&nbsp;&#34;</span><span class="op" id="4778238">,</span>&nbsp;<span class="string" id="4778240">&#34;\r&#34;</span><span class="op" id="4778244">,</span>&nbsp;<span class="string" id="4778246">&#34;&nbsp;&#34;</span><span class="op" id="4778249">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="4778252">type</span>&nbsp;<span class="ident" id="4778257">writeStringer</span>&nbsp;<span class="keyword" id="4778271">interface</span>&nbsp;<span class="op" id="4778281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778284">WriteString</span><span class="op" id="4778295">(</span><span class="builtintype" id="4778296">string</span><span class="op" id="4778302">)</span>&nbsp;<span class="op" id="4778304">(</span><span class="builtintype" id="4778305">int</span><span class="op" id="4778308">,</span>&nbsp;<span class="builtintype" id="4778310">error</span><span class="op" id="4778315">)</span><br>
<span class="lineno"></span><span class="op" id="4778317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4778320">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4778372">type</span>&nbsp;<span class="ident" id="4778377">stringWriter</span>&nbsp;<span class="keyword" id="4778390">struct</span>&nbsp;<span class="op" id="4778397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778400">w</span>&nbsp;<span class="ident" id="4778402">io</span><span class="op" id="4778404">.</span><span class="ident" id="4778405">Writer</span><br>
<span class="lineno"></span><span class="op" id="4778412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4778415">func</span>&nbsp;<span class="op" id="4778420">(</span><span class="ident" id="4778421">w</span>&nbsp;<span class="ident" id="4778423">stringWriter</span><span class="op" id="4778435">)</span>&nbsp;<span class="ident" id="4778437">WriteString</span><span class="op" id="4778448">(</span><span class="ident" id="4778449">s</span>&nbsp;<span class="builtintype" id="4778451">string</span><span class="op" id="4778457">)</span>&nbsp;<span class="op" id="4778459">(</span><span class="ident" id="4778460">n</span>&nbsp;<span class="builtintype" id="4778462">int</span><span class="op" id="4778465">,</span>&nbsp;<span class="ident" id="4778467">err</span>&nbsp;<span class="builtintype" id="4778471">error</span><span class="op" id="4778476">)</span>&nbsp;<span class="op" id="4778478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778481">return</span>&nbsp;<span class="ident" id="4778488">w</span><span class="op" id="4778489">.</span><span class="ident" id="4778490">w</span><span class="op" id="4778491">.</span><span class="ident" id="4778492">Write</span><span class="op" id="4778497">(</span><span class="op" id="4778498">[</span><span class="op" id="4778499">]</span><span class="builtintype" id="4778500">byte</span><span class="op" id="4778504">(</span><span class="ident" id="4778505">s</span><span class="op" id="4778506">)</span><span class="op" id="4778507">)</span><br>
<span class="lineno"></span><span class="op" id="4778509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4778512">type</span>&nbsp;<span class="ident" id="4778517">keyValues</span>&nbsp;<span class="keyword" id="4778527">struct</span>&nbsp;<span class="op" id="4778534">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778537">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4778544">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778552">values</span>&nbsp;<span class="op" id="4778559">[</span><span class="op" id="4778560">]</span><span class="builtintype" id="4778561">string</span><br>
<span class="lineno"></span><span class="op" id="4778568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4778571">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="4778640">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="4778709">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4778748">type</span>&nbsp;<span class="ident" id="4778753">headerSorter</span>&nbsp;<span class="keyword" id="4778766">struct</span>&nbsp;<span class="op" id="4778773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778776">kvs</span>&nbsp;<span class="op" id="4778780">[</span><span class="op" id="4778781">]</span><span class="ident" id="4778782">keyValues</span><br>
<span class="lineno"></span><span class="op" id="4778792">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="4778795">func</span>&nbsp;<span class="op" id="4778800">(</span><span class="ident" id="4778801">s</span>&nbsp;<span class="op" id="4778803">*</span><span class="ident" id="4778804">headerSorter</span><span class="op" id="4778816">)</span>&nbsp;<span class="ident" id="4778818">Len</span><span class="op" id="4778821">(</span><span class="op" id="4778822">)</span>&nbsp;<span class="builtintype" id="4778824">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778838">{</span>&nbsp;<span class="keyword" id="4778840">return</span>&nbsp;<span class="builtinfunc" id="4778847">len</span><span class="op" id="4778850">(</span><span class="ident" id="4778851">s</span><span class="op" id="4778852">.</span><span class="ident" id="4778853">kvs</span><span class="op" id="4778856">)</span>&nbsp;<span class="op" id="4778858">}</span><br>
<span class="lineno"></span><span class="keyword" id="4778860">func</span>&nbsp;<span class="op" id="4778865">(</span><span class="ident" id="4778866">s</span>&nbsp;<span class="op" id="4778868">*</span><span class="ident" id="4778869">headerSorter</span><span class="op" id="4778881">)</span>&nbsp;<span class="ident" id="4778883">Swap</span><span class="op" id="4778887">(</span><span class="ident" id="4778888">i</span><span class="op" id="4778889">,</span>&nbsp;<span class="ident" id="4778891">j</span>&nbsp;<span class="builtintype" id="4778893">int</span><span class="op" id="4778896">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778903">{</span>&nbsp;<span class="ident" id="4778905">s</span><span class="op" id="4778906">.</span><span class="ident" id="4778907">kvs</span><span class="op" id="4778910">[</span><span class="ident" id="4778911">i</span><span class="op" id="4778912">]</span><span class="op" id="4778913">,</span>&nbsp;<span class="ident" id="4778915">s</span><span class="op" id="4778916">.</span><span class="ident" id="4778917">kvs</span><span class="op" id="4778920">[</span><span class="ident" id="4778921">j</span><span class="op" id="4778922">]</span>&nbsp;<span class="op" id="4778924">=</span>&nbsp;<span class="ident" id="4778926">s</span><span class="op" id="4778927">.</span><span class="ident" id="4778928">kvs</span><span class="op" id="4778931">[</span><span class="ident" id="4778932">j</span><span class="op" id="4778933">]</span><span class="op" id="4778934">,</span>&nbsp;<span class="ident" id="4778936">s</span><span class="op" id="4778937">.</span><span class="ident" id="4778938">kvs</span><span class="op" id="4778941">[</span><span class="ident" id="4778942">i</span><span class="op" id="4778943">]</span>&nbsp;<span class="op" id="4778945">}</span><br>
<span class="lineno"></span><span class="keyword" id="4778947">func</span>&nbsp;<span class="op" id="4778952">(</span><span class="ident" id="4778953">s</span>&nbsp;<span class="op" id="4778955">*</span><span class="ident" id="4778956">headerSorter</span><span class="op" id="4778968">)</span>&nbsp;<span class="ident" id="4778970">Less</span><span class="op" id="4778974">(</span><span class="ident" id="4778975">i</span><span class="op" id="4778976">,</span>&nbsp;<span class="ident" id="4778978">j</span>&nbsp;<span class="builtintype" id="4778980">int</span><span class="op" id="4778983">)</span>&nbsp;<span class="builtintype" id="4778985">bool</span>&nbsp;<span class="op" id="4778990">{</span>&nbsp;<span class="keyword" id="4778992">return</span>&nbsp;<span class="ident" id="4778999">s</span><span class="op" id="4779000">.</span><span class="ident" id="4779001">kvs</span><span class="op" id="4779004">[</span><span class="ident" id="4779005">i</span><span class="op" id="4779006">]</span><span class="op" id="4779007">.</span><span class="ident" id="4779008">key</span>&nbsp;<span class="op" id="4779012">&lt;</span>&nbsp;<span class="ident" id="4779014">s</span><span class="op" id="4779015">.</span><span class="ident" id="4779016">kvs</span><span class="op" id="4779019">[</span><span class="ident" id="4779020">j</span><span class="op" id="4779021">]</span><span class="op" id="4779022">.</span><span class="ident" id="4779023">key</span>&nbsp;<span class="op" id="4779027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="4779030">var</span>&nbsp;<span class="ident" id="4779034">headerSorterPool</span>&nbsp;<span class="op" id="4779051">=</span>&nbsp;<span class="ident" id="4779053">sync</span><span class="op" id="4779057">.</span><span class="ident" id="4779058">Pool</span><span class="op" id="4779062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779065">New</span><span class="op" id="4779068">:</span>&nbsp;<span class="keyword" id="4779070">func</span><span class="op" id="4779074">(</span><span class="op" id="4779075">)</span>&nbsp;<span class="keyword" id="4779077">interface</span><span class="op" id="4779086">{</span><span class="op" id="4779087">}</span>&nbsp;<span class="op" id="4779089">{</span>&nbsp;<span class="keyword" id="4779091">return</span>&nbsp;<span class="builtinfunc" id="4779098">new</span><span class="op" id="4779101">(</span><span class="ident" id="4779102">headerSorter</span><span class="op" id="4779114">)</span>&nbsp;<span class="op" id="4779116">}</span><span class="op" id="4779117">,</span><br>
<span class="lineno"></span><span class="op" id="4779119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4779122">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="4779185">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="4779256">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="4779288">func</span>&nbsp;<span class="op" id="4779293">(</span><span class="ident" id="4779294">h</span>&nbsp;<span class="ident" id="4779296">Header</span><span class="op" id="4779302">)</span>&nbsp;<span class="ident" id="4779304">sortedKeyValues</span><span class="op" id="4779319">(</span><span class="ident" id="4779320">exclude</span>&nbsp;<span class="keyword" id="4779328">map</span><span class="op" id="4779331">[</span><span class="builtintype" id="4779332">string</span><span class="op" id="4779338">]</span><span class="builtintype" id="4779339">bool</span><span class="op" id="4779343">)</span>&nbsp;<span class="op" id="4779345">(</span><span class="ident" id="4779346">kvs</span>&nbsp;<span class="op" id="4779350">[</span><span class="op" id="4779351">]</span><span class="ident" id="4779352">keyValues</span><span class="op" id="4779361">,</span>&nbsp;<span class="ident" id="4779363">hs</span>&nbsp;<span class="op" id="4779366">*</span><span class="ident" id="4779367">headerSorter</span><span class="op" id="4779379">)</span>&nbsp;<span class="op" id="4779381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779384">hs</span>&nbsp;<span class="op" id="4779387">=</span>&nbsp;<span class="ident" id="4779389">headerSorterPool</span><span class="op" id="4779405">.</span><span class="ident" id="4779406">Get</span><span class="op" id="4779409">(</span><span class="op" id="4779410">)</span><span class="op" id="4779411">.</span><span class="op" id="4779412">(</span><span class="op" id="4779413">*</span><span class="ident" id="4779414">headerSorter</span><span class="op" id="4779426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779429">if</span>&nbsp;<span class="builtinfunc" id="4779432">cap</span><span class="op" id="4779435">(</span><span class="ident" id="4779436">hs</span><span class="op" id="4779438">.</span><span class="ident" id="4779439">kvs</span><span class="op" id="4779442">)</span>&nbsp;<span class="op" id="4779444">&lt;</span>&nbsp;<span class="builtinfunc" id="4779446">len</span><span class="op" id="4779449">(</span><span class="ident" id="4779450">h</span><span class="op" id="4779451">)</span>&nbsp;<span class="op" id="4779453">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779457">hs</span><span class="op" id="4779459">.</span><span class="ident" id="4779460">kvs</span>&nbsp;<span class="op" id="4779464">=</span>&nbsp;<span class="builtinfunc" id="4779466">make</span><span class="op" id="4779470">(</span><span class="op" id="4779471">[</span><span class="op" id="4779472">]</span><span class="ident" id="4779473">keyValues</span><span class="op" id="4779482">,</span>&nbsp;<span class="num" id="4779484">0</span><span class="op" id="4779485">,</span>&nbsp;<span class="builtinfunc" id="4779487">len</span><span class="op" id="4779490">(</span><span class="ident" id="4779491">h</span><span class="op" id="4779492">)</span><span class="op" id="4779493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779499">kvs</span>&nbsp;<span class="op" id="4779503">=</span>&nbsp;<span class="ident" id="4779505">hs</span><span class="op" id="4779507">.</span><span class="ident" id="4779508">kvs</span><span class="op" id="4779511">[</span><span class="op" id="4779512">:</span><span class="num" id="4779513">0</span><span class="op" id="4779514">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779517">for</span>&nbsp;<span class="ident" id="4779521">k</span><span class="op" id="4779522">,</span>&nbsp;<span class="ident" id="4779524">vv</span>&nbsp;<span class="op" id="4779527">:=</span>&nbsp;<span class="keyword" id="4779530">range</span>&nbsp;<span class="ident" id="4779536">h</span>&nbsp;<span class="op" id="4779538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779542">if</span>&nbsp;<span class="op" id="4779545">!</span><span class="ident" id="4779546">exclude</span><span class="op" id="4779553">[</span><span class="ident" id="4779554">k</span><span class="op" id="4779555">]</span>&nbsp;<span class="op" id="4779557">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779562">kvs</span>&nbsp;<span class="op" id="4779566">=</span>&nbsp;<span class="builtinfunc" id="4779568">append</span><span class="op" id="4779574">(</span><span class="ident" id="4779575">kvs</span><span class="op" id="4779578">,</span>&nbsp;<span class="ident" id="4779580">keyValues</span><span class="op" id="4779589">{</span><span class="ident" id="4779590">k</span><span class="op" id="4779591">,</span>&nbsp;<span class="ident" id="4779593">vv</span><span class="op" id="4779595">}</span><span class="op" id="4779596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779606">hs</span><span class="op" id="4779608">.</span><span class="ident" id="4779609">kvs</span>&nbsp;<span class="op" id="4779613">=</span>&nbsp;<span class="ident" id="4779615">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779620">sort</span><span class="op" id="4779624">.</span><span class="ident" id="4779625">Sort</span><span class="op" id="4779629">(</span><span class="ident" id="4779630">hs</span><span class="op" id="4779632">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779635">return</span>&nbsp;<span class="ident" id="4779642">kvs</span><span class="op" id="4779645">,</span>&nbsp;<span class="ident" id="4779647">hs</span><br>
<span class="lineno"></span><span class="op" id="4779650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4779653">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="4779700">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="4779775">func</span>&nbsp;<span class="op" id="4779780">(</span><span class="ident" id="4779781">h</span>&nbsp;<span class="ident" id="4779783">Header</span><span class="op" id="4779789">)</span>&nbsp;<span class="ident" id="4779791">WriteSubset</span><span class="op" id="4779802">(</span><span class="ident" id="4779803">w</span>&nbsp;<span class="ident" id="4779805">io</span><span class="op" id="4779807">.</span><span class="ident" id="4779808">Writer</span><span class="op" id="4779814">,</span>&nbsp;<span class="ident" id="4779816">exclude</span>&nbsp;<span class="keyword" id="4779824">map</span><span class="op" id="4779827">[</span><span class="builtintype" id="4779828">string</span><span class="op" id="4779834">]</span><span class="builtintype" id="4779835">bool</span><span class="op" id="4779839">)</span>&nbsp;<span class="builtintype" id="4779841">error</span>&nbsp;<span class="op" id="4779847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779850">ws</span><span class="op" id="4779852">,</span>&nbsp;<span class="ident" id="4779854">ok</span>&nbsp;<span class="op" id="4779857">:=</span>&nbsp;<span class="ident" id="4779860">w</span><span class="op" id="4779861">.</span><span class="op" id="4779862">(</span><span class="ident" id="4779863">writeStringer</span><span class="op" id="4779876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779879">if</span>&nbsp;<span class="op" id="4779882">!</span><span class="ident" id="4779883">ok</span>&nbsp;<span class="op" id="4779886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779890">ws</span>&nbsp;<span class="op" id="4779893">=</span>&nbsp;<span class="ident" id="4779895">stringWriter</span><span class="op" id="4779907">{</span><span class="ident" id="4779908">w</span><span class="op" id="4779909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779912">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779915">kvs</span><span class="op" id="4779918">,</span>&nbsp;<span class="ident" id="4779920">sorter</span>&nbsp;<span class="op" id="4779927">:=</span>&nbsp;<span class="ident" id="4779930">h</span><span class="op" id="4779931">.</span><span class="ident" id="4779932">sortedKeyValues</span><span class="op" id="4779947">(</span><span class="ident" id="4779948">exclude</span><span class="op" id="4779955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779958">for</span>&nbsp;<span class="ident" id="4779962">_</span><span class="op" id="4779963">,</span>&nbsp;<span class="ident" id="4779965">kv</span>&nbsp;<span class="op" id="4779968">:=</span>&nbsp;<span class="keyword" id="4779971">range</span>&nbsp;<span class="ident" id="4779977">kvs</span>&nbsp;<span class="op" id="4779981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779985">for</span>&nbsp;<span class="ident" id="4779989">_</span><span class="op" id="4779990">,</span>&nbsp;<span class="ident" id="4779992">v</span>&nbsp;<span class="op" id="4779994">:=</span>&nbsp;<span class="keyword" id="4779997">range</span>&nbsp;<span class="ident" id="4780003">kv</span><span class="op" id="4780005">.</span><span class="ident" id="4780006">values</span>&nbsp;<span class="op" id="4780013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780018">v</span>&nbsp;<span class="op" id="4780020">=</span>&nbsp;<span class="ident" id="4780022">headerNewlineToSpace</span><span class="op" id="4780042">.</span><span class="ident" id="4780043">Replace</span><span class="op" id="4780050">(</span><span class="ident" id="4780051">v</span><span class="op" id="4780052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780057">v</span>&nbsp;<span class="op" id="4780059">=</span>&nbsp;<span class="ident" id="4780061">textproto</span><span class="op" id="4780070">.</span><span class="ident" id="4780071">TrimString</span><span class="op" id="4780081">(</span><span class="ident" id="4780082">v</span><span class="op" id="4780083">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780088">for</span>&nbsp;<span class="ident" id="4780092">_</span><span class="op" id="4780093">,</span>&nbsp;<span class="ident" id="4780095">s</span>&nbsp;<span class="op" id="4780097">:=</span>&nbsp;<span class="keyword" id="4780100">range</span>&nbsp;<span class="op" id="4780106">[</span><span class="op" id="4780107">]</span><span class="builtintype" id="4780108">string</span><span class="op" id="4780114">{</span><span class="ident" id="4780115">kv</span><span class="op" id="4780117">.</span><span class="ident" id="4780118">key</span><span class="op" id="4780121">,</span>&nbsp;<span class="string" id="4780123">&#34;:&nbsp;&#34;</span><span class="op" id="4780127">,</span>&nbsp;<span class="ident" id="4780129">v</span><span class="op" id="4780130">,</span>&nbsp;<span class="string" id="4780132">&#34;\r\n&#34;</span><span class="op" id="4780138">}</span>&nbsp;<span class="op" id="4780140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780146">if</span>&nbsp;<span class="ident" id="4780149">_</span><span class="op" id="4780150">,</span>&nbsp;<span class="ident" id="4780152">err</span>&nbsp;<span class="op" id="4780156">:=</span>&nbsp;<span class="ident" id="4780159">ws</span><span class="op" id="4780161">.</span><span class="ident" id="4780162">WriteString</span><span class="op" id="4780173">(</span><span class="ident" id="4780174">s</span><span class="op" id="4780175">)</span><span class="op" id="4780176">;</span>&nbsp;<span class="ident" id="4780178">err</span>&nbsp;<span class="op" id="4780182">!=</span>&nbsp;<span class="ident" id="4780185">nil</span>&nbsp;<span class="op" id="4780189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780196">return</span>&nbsp;<span class="ident" id="4780203">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780216">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780226">headerSorterPool</span><span class="op" id="4780242">.</span><span class="ident" id="4780243">Put</span><span class="op" id="4780246">(</span><span class="ident" id="4780247">sorter</span><span class="op" id="4780253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780256">return</span>&nbsp;<span class="ident" id="4780263">nil</span><br>
<span class="lineno"></span><span class="op" id="4780267">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="4780270">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4780328">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4780386">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="4780445">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="4780503">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4780564">func</span>&nbsp;<span class="ident" id="4780569">CanonicalHeaderKey</span><span class="op" id="4780587">(</span><span class="ident" id="4780588">s</span>&nbsp;<span class="builtintype" id="4780590">string</span><span class="op" id="4780596">)</span>&nbsp;<span class="builtintype" id="4780598">string</span>&nbsp;<span class="op" id="4780605">{</span>&nbsp;<span class="keyword" id="4780607">return</span>&nbsp;<span class="ident" id="4780614">textproto</span><span class="op" id="4780623">.</span><span class="ident" id="4780624">CanonicalMIMEHeaderKey</span><span class="op" id="4780646">(</span><span class="ident" id="4780647">s</span><span class="op" id="4780648">)</span>&nbsp;<span class="op" id="4780650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4780653">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="4780709">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="4780762">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="4780794">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="4780824">func</span>&nbsp;<span class="ident" id="4780829">hasToken</span><span class="op" id="4780837">(</span><span class="ident" id="4780838">v</span><span class="op" id="4780839">,</span>&nbsp;<span class="ident" id="4780841">token</span>&nbsp;<span class="builtintype" id="4780847">string</span><span class="op" id="4780853">)</span>&nbsp;<span class="builtintype" id="4780855">bool</span>&nbsp;<span class="op" id="4780860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780863">if</span>&nbsp;<span class="builtinfunc" id="4780866">len</span><span class="op" id="4780869">(</span><span class="ident" id="4780870">token</span><span class="op" id="4780875">)</span>&nbsp;<span class="op" id="4780877">&gt;</span>&nbsp;<span class="builtinfunc" id="4780879">len</span><span class="op" id="4780882">(</span><span class="ident" id="4780883">v</span><span class="op" id="4780884">)</span>&nbsp;<span class="op" id="4780886">||</span>&nbsp;<span class="ident" id="4780889">token</span>&nbsp;<span class="op" id="4780895">==</span>&nbsp;<span class="string" id="4780898">&#34;&#34;</span>&nbsp;<span class="op" id="4780901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780905">return</span>&nbsp;<span class="builtintype" id="4780912">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780922">if</span>&nbsp;<span class="ident" id="4780925">v</span>&nbsp;<span class="op" id="4780927">==</span>&nbsp;<span class="ident" id="4780930">token</span>&nbsp;<span class="op" id="4780936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780940">return</span>&nbsp;<span class="builtintype" id="4780947">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780956">for</span>&nbsp;<span class="ident" id="4780960">sp</span>&nbsp;<span class="op" id="4780963">:=</span>&nbsp;<span class="num" id="4780966">0</span><span class="op" id="4780967">;</span>&nbsp;<span class="ident" id="4780969">sp</span>&nbsp;<span class="op" id="4780972">&lt;=</span>&nbsp;<span class="builtinfunc" id="4780975">len</span><span class="op" id="4780978">(</span><span class="ident" id="4780979">v</span><span class="op" id="4780980">)</span><span class="op" id="4780981">-</span><span class="builtinfunc" id="4780982">len</span><span class="op" id="4780985">(</span><span class="ident" id="4780986">token</span><span class="op" id="4780991">)</span><span class="op" id="4780992">;</span>&nbsp;<span class="ident" id="4780994">sp</span><span class="op" id="4780996">++</span>&nbsp;<span class="op" id="4780999">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781003">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781044">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781100">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781153">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781208">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781262">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781321">if</span>&nbsp;<span class="ident" id="4781324">b</span>&nbsp;<span class="op" id="4781326">:=</span>&nbsp;<span class="ident" id="4781329">v</span><span class="op" id="4781330">[</span><span class="ident" id="4781331">sp</span><span class="op" id="4781333">]</span><span class="op" id="4781334">;</span>&nbsp;<span class="ident" id="4781336">b</span>&nbsp;<span class="op" id="4781338">!=</span>&nbsp;<span class="ident" id="4781341">token</span><span class="op" id="4781346">[</span><span class="num" id="4781347">0</span><span class="op" id="4781348">]</span>&nbsp;<span class="op" id="4781350">&amp;&amp;</span>&nbsp;<span class="ident" id="4781353">b</span><span class="op" id="4781354">|</span><span class="num" id="4781355">0x20</span>&nbsp;<span class="op" id="4781360">!=</span>&nbsp;<span class="ident" id="4781363">token</span><span class="op" id="4781368">[</span><span class="num" id="4781369">0</span><span class="op" id="4781370">]</span>&nbsp;<span class="op" id="4781372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781377">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781392">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781448">if</span>&nbsp;<span class="ident" id="4781451">sp</span>&nbsp;<span class="op" id="4781454">&gt;</span>&nbsp;<span class="num" id="4781456">0</span>&nbsp;<span class="op" id="4781458">&amp;&amp;</span>&nbsp;<span class="op" id="4781461">!</span><span class="ident" id="4781462">isTokenBoundary</span><span class="op" id="4781477">(</span><span class="ident" id="4781478">v</span><span class="op" id="4781479">[</span><span class="ident" id="4781480">sp</span><span class="op" id="4781482">-</span><span class="num" id="4781483">1</span><span class="op" id="4781484">]</span><span class="op" id="4781485">)</span>&nbsp;<span class="op" id="4781487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781492">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781507">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781561">if</span>&nbsp;<span class="ident" id="4781564">endPos</span>&nbsp;<span class="op" id="4781571">:=</span>&nbsp;<span class="ident" id="4781574">sp</span>&nbsp;<span class="op" id="4781577">+</span>&nbsp;<span class="builtinfunc" id="4781579">len</span><span class="op" id="4781582">(</span><span class="ident" id="4781583">token</span><span class="op" id="4781588">)</span><span class="op" id="4781589">;</span>&nbsp;<span class="ident" id="4781591">endPos</span>&nbsp;<span class="op" id="4781598">!=</span>&nbsp;<span class="builtinfunc" id="4781601">len</span><span class="op" id="4781604">(</span><span class="ident" id="4781605">v</span><span class="op" id="4781606">)</span>&nbsp;<span class="op" id="4781608">&amp;&amp;</span>&nbsp;<span class="op" id="4781611">!</span><span class="ident" id="4781612">isTokenBoundary</span><span class="op" id="4781627">(</span><span class="ident" id="4781628">v</span><span class="op" id="4781629">[</span><span class="ident" id="4781630">endPos</span><span class="op" id="4781636">]</span><span class="op" id="4781637">)</span>&nbsp;<span class="op" id="4781639">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781644">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781659">if</span>&nbsp;<span class="ident" id="4781662">strings</span><span class="op" id="4781669">.</span><span class="ident" id="4781670">EqualFold</span><span class="op" id="4781679">(</span><span class="ident" id="4781680">v</span><span class="op" id="4781681">[</span><span class="ident" id="4781682">sp</span><span class="op" id="4781684">:</span><span class="ident" id="4781685">sp</span><span class="op" id="4781687">+</span><span class="builtinfunc" id="4781688">len</span><span class="op" id="4781691">(</span><span class="ident" id="4781692">token</span><span class="op" id="4781697">)</span><span class="op" id="4781698">]</span><span class="op" id="4781699">,</span>&nbsp;<span class="ident" id="4781701">token</span><span class="op" id="4781706">)</span>&nbsp;<span class="op" id="4781708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781713">return</span>&nbsp;<span class="builtintype" id="4781720">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781727">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781733">return</span>&nbsp;<span class="builtintype" id="4781740">false</span><br>
<span class="lineno"></span><span class="op" id="4781746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4781749">func</span>&nbsp;<span class="ident" id="4781754">isTokenBoundary</span><span class="op" id="4781769">(</span><span class="ident" id="4781770">b</span>&nbsp;<span class="builtintype" id="4781772">byte</span><span class="op" id="4781776">)</span>&nbsp;<span class="builtintype" id="4781778">bool</span>&nbsp;<span class="op" id="4781783">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781786">return</span>&nbsp;<span class="ident" id="4781793">b</span>&nbsp;<span class="op" id="4781795">==</span>&nbsp;<span class="string" id="4781798">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4781802">||</span>&nbsp;<span class="ident" id="4781805">b</span>&nbsp;<span class="op" id="4781807">==</span>&nbsp;<span class="string" id="4781810">&#39;,&#39;</span>&nbsp;<span class="op" id="4781814">||</span>&nbsp;<span class="ident" id="4781817">b</span>&nbsp;<span class="op" id="4781819">==</span>&nbsp;<span class="string" id="4781822">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="4781827">}</span>
</div>
</body>
</html>
