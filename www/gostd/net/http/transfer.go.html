<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html" class="current">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4202437">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4202492">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4202546">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4202597">package</span>&nbsp;<span class="ident" id="4202605">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4202611">import</span>&nbsp;<span class="op" id="4202618">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202621">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202630">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202639">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202649">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202656">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202662">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202675">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202696">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202713">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202721">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202732">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4202743">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4202750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4202753">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="4202823">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="4202859">var</span>&nbsp;<span class="ident" id="4202863">ErrLineTooLong</span>&nbsp;<span class="op" id="4202878">=</span>&nbsp;<span class="ident" id="4202880">internal</span><span class="op" id="4202888">.</span><span class="ident" id="4202889">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4202905">type</span>&nbsp;<span class="ident" id="4202910">errorReader</span>&nbsp;<span class="keyword" id="4202922">struct</span>&nbsp;<span class="op" id="4202929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202932">err</span>&nbsp;<span class="builtintype" id="4202936">error</span><br>
<span class="lineno"></span><span class="op" id="4202942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="4202945">func</span>&nbsp;<span class="op" id="4202950">(</span><span class="ident" id="4202951">r</span>&nbsp;<span class="op" id="4202953">*</span><span class="ident" id="4202954">errorReader</span><span class="op" id="4202965">)</span>&nbsp;<span class="ident" id="4202967">Read</span><span class="op" id="4202971">(</span><span class="ident" id="4202972">p</span>&nbsp;<span class="op" id="4202974">[</span><span class="op" id="4202975">]</span><span class="builtintype" id="4202976">byte</span><span class="op" id="4202980">)</span>&nbsp;<span class="op" id="4202982">(</span><span class="ident" id="4202983">n</span>&nbsp;<span class="builtintype" id="4202985">int</span><span class="op" id="4202988">,</span>&nbsp;<span class="ident" id="4202990">err</span>&nbsp;<span class="builtintype" id="4202994">error</span><span class="op" id="4202999">)</span>&nbsp;<span class="op" id="4203001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203004">return</span>&nbsp;<span class="num" id="4203011">0</span><span class="op" id="4203012">,</span>&nbsp;<span class="ident" id="4203014">r</span><span class="op" id="4203015">.</span><span class="ident" id="4203016">err</span><br>
<span class="lineno"></span><span class="op" id="4203020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4203023">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="4203101">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4203177">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="4203244">type</span>&nbsp;<span class="ident" id="4203249">transferWriter</span>&nbsp;<span class="keyword" id="4203264">struct</span>&nbsp;<span class="op" id="4203271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203274">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4203291">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203299">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203316">io</span><span class="op" id="4203318">.</span><span class="ident" id="4203319">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203327">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203344">io</span><span class="op" id="4203346">.</span><span class="ident" id="4203347">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203355">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4203372">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203378">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203395">int64</span>&nbsp;<span class="comment" id="4203401">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203444">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4203461">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203467">TransferEncoding</span>&nbsp;<span class="op" id="4203484">[</span><span class="op" id="4203485">]</span><span class="builtintype" id="4203486">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203494">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203511">Header</span><br>
<span class="lineno"></span><span class="op" id="4203518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4203521">func</span>&nbsp;<span class="ident" id="4203526">newTransferWriter</span><span class="op" id="4203543">(</span><span class="ident" id="4203544">r</span>&nbsp;<span class="keyword" id="4203546">interface</span><span class="op" id="4203555">{</span><span class="op" id="4203556">}</span><span class="op" id="4203557">)</span>&nbsp;<span class="op" id="4203559">(</span><span class="ident" id="4203560">t</span>&nbsp;<span class="op" id="4203562">*</span><span class="ident" id="4203563">transferWriter</span><span class="op" id="4203577">,</span>&nbsp;<span class="ident" id="4203579">err</span>&nbsp;<span class="builtintype" id="4203583">error</span><span class="op" id="4203588">)</span>&nbsp;<span class="op" id="4203590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203593">t</span>&nbsp;<span class="op" id="4203595">=</span>&nbsp;<span class="op" id="4203597">&amp;</span><span class="ident" id="4203598">transferWriter</span><span class="op" id="4203612">{</span><span class="op" id="4203613">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203617">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203645">atLeastHTTP11</span>&nbsp;<span class="op" id="4203659">:=</span>&nbsp;<span class="builtintype" id="4203662">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203669">switch</span>&nbsp;<span class="ident" id="4203676">rr</span>&nbsp;<span class="op" id="4203679">:=</span>&nbsp;<span class="ident" id="4203682">r</span><span class="op" id="4203683">.</span><span class="op" id="4203684">(</span><span class="keyword" id="4203685">type</span><span class="op" id="4203689">)</span>&nbsp;<span class="op" id="4203691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203694">case</span>&nbsp;<span class="op" id="4203699">*</span><span class="ident" id="4203700">Request</span><span class="op" id="4203707">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203711">if</span>&nbsp;<span class="ident" id="4203714">rr</span><span class="op" id="4203716">.</span><span class="ident" id="4203717">ContentLength</span>&nbsp;<span class="op" id="4203731">!=</span>&nbsp;<span class="num" id="4203734">0</span>&nbsp;<span class="op" id="4203736">&amp;&amp;</span>&nbsp;<span class="ident" id="4203739">rr</span><span class="op" id="4203741">.</span><span class="ident" id="4203742">Body</span>&nbsp;<span class="op" id="4203747">==</span>&nbsp;<span class="builtintype" id="4203750">nil</span>&nbsp;<span class="op" id="4203754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203759">return</span>&nbsp;<span class="builtintype" id="4203766">nil</span><span class="op" id="4203769">,</span>&nbsp;<span class="ident" id="4203771">fmt</span><span class="op" id="4203774">.</span><span class="ident" id="4203775">Errorf</span><span class="op" id="4203781">(</span><span class="string" id="4203782">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="4203828">,</span>&nbsp;<span class="ident" id="4203830">rr</span><span class="op" id="4203832">.</span><span class="ident" id="4203833">ContentLength</span><span class="op" id="4203846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203854">t</span><span class="op" id="4203855">.</span><span class="ident" id="4203856">Method</span>&nbsp;<span class="op" id="4203863">=</span>&nbsp;<span class="ident" id="4203865">rr</span><span class="op" id="4203867">.</span><span class="ident" id="4203868">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203877">t</span><span class="op" id="4203878">.</span><span class="ident" id="4203879">Body</span>&nbsp;<span class="op" id="4203884">=</span>&nbsp;<span class="ident" id="4203886">rr</span><span class="op" id="4203888">.</span><span class="ident" id="4203889">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203896">t</span><span class="op" id="4203897">.</span><span class="ident" id="4203898">BodyCloser</span>&nbsp;<span class="op" id="4203909">=</span>&nbsp;<span class="ident" id="4203911">rr</span><span class="op" id="4203913">.</span><span class="ident" id="4203914">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203921">t</span><span class="op" id="4203922">.</span><span class="ident" id="4203923">ContentLength</span>&nbsp;<span class="op" id="4203937">=</span>&nbsp;<span class="ident" id="4203939">rr</span><span class="op" id="4203941">.</span><span class="ident" id="4203942">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203958">t</span><span class="op" id="4203959">.</span><span class="ident" id="4203960">Close</span>&nbsp;<span class="op" id="4203966">=</span>&nbsp;<span class="ident" id="4203968">rr</span><span class="op" id="4203970">.</span><span class="ident" id="4203971">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203979">t</span><span class="op" id="4203980">.</span><span class="ident" id="4203981">TransferEncoding</span>&nbsp;<span class="op" id="4203998">=</span>&nbsp;<span class="ident" id="4204000">rr</span><span class="op" id="4204002">.</span><span class="ident" id="4204003">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204022">t</span><span class="op" id="4204023">.</span><span class="ident" id="4204024">Trailer</span>&nbsp;<span class="op" id="4204032">=</span>&nbsp;<span class="ident" id="4204034">rr</span><span class="op" id="4204036">.</span><span class="ident" id="4204037">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204047">atLeastHTTP11</span>&nbsp;<span class="op" id="4204061">=</span>&nbsp;<span class="ident" id="4204063">rr</span><span class="op" id="4204065">.</span><span class="ident" id="4204066">ProtoAtLeast</span><span class="op" id="4204078">(</span><span class="num" id="4204079">1</span><span class="op" id="4204080">,</span>&nbsp;<span class="num" id="4204082">1</span><span class="op" id="4204083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204087">if</span>&nbsp;<span class="ident" id="4204090">t</span><span class="op" id="4204091">.</span><span class="ident" id="4204092">Body</span>&nbsp;<span class="op" id="4204097">!=</span>&nbsp;<span class="builtintype" id="4204100">nil</span>&nbsp;<span class="op" id="4204104">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4204107">len</span><span class="op" id="4204110">(</span><span class="ident" id="4204111">t</span><span class="op" id="4204112">.</span><span class="ident" id="4204113">TransferEncoding</span><span class="op" id="4204129">)</span>&nbsp;<span class="op" id="4204131">==</span>&nbsp;<span class="num" id="4204134">0</span>&nbsp;<span class="op" id="4204136">&amp;&amp;</span>&nbsp;<span class="ident" id="4204139">atLeastHTTP11</span>&nbsp;<span class="op" id="4204153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204158">if</span>&nbsp;<span class="ident" id="4204161">t</span><span class="op" id="4204162">.</span><span class="ident" id="4204163">ContentLength</span>&nbsp;<span class="op" id="4204177">==</span>&nbsp;<span class="num" id="4204180">0</span>&nbsp;<span class="op" id="4204182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204188">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204244">var</span>&nbsp;<span class="ident" id="4204248">buf</span>&nbsp;<span class="op" id="4204252">[</span><span class="num" id="4204253">1</span><span class="op" id="4204254">]</span><span class="builtintype" id="4204255">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204264">n</span><span class="op" id="4204265">,</span>&nbsp;<span class="ident" id="4204267">rerr</span>&nbsp;<span class="op" id="4204272">:=</span>&nbsp;<span class="ident" id="4204275">io</span><span class="op" id="4204277">.</span><span class="ident" id="4204278">ReadFull</span><span class="op" id="4204286">(</span><span class="ident" id="4204287">t</span><span class="op" id="4204288">.</span><span class="ident" id="4204289">Body</span><span class="op" id="4204293">,</span>&nbsp;<span class="ident" id="4204295">buf</span><span class="op" id="4204298">[</span><span class="op" id="4204299">:</span><span class="op" id="4204300">]</span><span class="op" id="4204301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204307">if</span>&nbsp;<span class="ident" id="4204310">rerr</span>&nbsp;<span class="op" id="4204315">!=</span>&nbsp;<span class="builtintype" id="4204318">nil</span>&nbsp;<span class="op" id="4204322">&amp;&amp;</span>&nbsp;<span class="ident" id="4204325">rerr</span>&nbsp;<span class="op" id="4204330">!=</span>&nbsp;<span class="ident" id="4204333">io</span><span class="op" id="4204335">.</span><span class="ident" id="4204336">EOF</span>&nbsp;<span class="op" id="4204340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204347">t</span><span class="op" id="4204348">.</span><span class="ident" id="4204349">ContentLength</span>&nbsp;<span class="op" id="4204363">=</span>&nbsp;<span class="op" id="4204365">-</span><span class="num" id="4204366">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204373">t</span><span class="op" id="4204374">.</span><span class="ident" id="4204375">Body</span>&nbsp;<span class="op" id="4204380">=</span>&nbsp;<span class="op" id="4204382">&amp;</span><span class="ident" id="4204383">errorReader</span><span class="op" id="4204394">{</span><span class="ident" id="4204395">rerr</span><span class="op" id="4204399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204405">}</span>&nbsp;<span class="keyword" id="4204407">else</span>&nbsp;<span class="keyword" id="4204412">if</span>&nbsp;<span class="ident" id="4204415">n</span>&nbsp;<span class="op" id="4204417">==</span>&nbsp;<span class="num" id="4204420">1</span>&nbsp;<span class="op" id="4204422">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204429">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204492">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204541">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204602">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204625">t</span><span class="op" id="4204626">.</span><span class="ident" id="4204627">ContentLength</span>&nbsp;<span class="op" id="4204641">=</span>&nbsp;<span class="op" id="4204643">-</span><span class="num" id="4204644">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204651">t</span><span class="op" id="4204652">.</span><span class="ident" id="4204653">Body</span>&nbsp;<span class="op" id="4204658">=</span>&nbsp;<span class="ident" id="4204660">io</span><span class="op" id="4204662">.</span><span class="ident" id="4204663">MultiReader</span><span class="op" id="4204674">(</span><span class="ident" id="4204675">bytes</span><span class="op" id="4204680">.</span><span class="ident" id="4204681">NewReader</span><span class="op" id="4204690">(</span><span class="ident" id="4204691">buf</span><span class="op" id="4204694">[</span><span class="op" id="4204695">:</span><span class="op" id="4204696">]</span><span class="op" id="4204697">)</span><span class="op" id="4204698">,</span>&nbsp;<span class="ident" id="4204700">t</span><span class="op" id="4204701">.</span><span class="ident" id="4204702">Body</span><span class="op" id="4204706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204712">}</span>&nbsp;<span class="keyword" id="4204714">else</span>&nbsp;<span class="op" id="4204719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204726">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204758">t</span><span class="op" id="4204759">.</span><span class="ident" id="4204760">Body</span>&nbsp;<span class="op" id="4204765">=</span>&nbsp;<span class="builtintype" id="4204767">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204776">t</span><span class="op" id="4204777">.</span><span class="ident" id="4204778">BodyCloser</span>&nbsp;<span class="op" id="4204789">=</span>&nbsp;<span class="builtintype" id="4204791">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204809">if</span>&nbsp;<span class="ident" id="4204812">t</span><span class="op" id="4204813">.</span><span class="ident" id="4204814">ContentLength</span>&nbsp;<span class="op" id="4204828">&lt;</span>&nbsp;<span class="num" id="4204830">0</span>&nbsp;<span class="op" id="4204832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204838">t</span><span class="op" id="4204839">.</span><span class="ident" id="4204840">TransferEncoding</span>&nbsp;<span class="op" id="4204857">=</span>&nbsp;<span class="op" id="4204859">[</span><span class="op" id="4204860">]</span><span class="builtintype" id="4204861">string</span><span class="op" id="4204867">{</span><span class="string" id="4204868">&#34;chunked&#34;</span><span class="op" id="4204877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204882">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204889">case</span>&nbsp;<span class="op" id="4204894">*</span><span class="ident" id="4204895">Response</span><span class="op" id="4204903">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204907">if</span>&nbsp;<span class="ident" id="4204910">rr</span><span class="op" id="4204912">.</span><span class="ident" id="4204913">Request</span>&nbsp;<span class="op" id="4204921">!=</span>&nbsp;<span class="builtintype" id="4204924">nil</span>&nbsp;<span class="op" id="4204928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204933">t</span><span class="op" id="4204934">.</span><span class="ident" id="4204935">Method</span>&nbsp;<span class="op" id="4204942">=</span>&nbsp;<span class="ident" id="4204944">rr</span><span class="op" id="4204946">.</span><span class="ident" id="4204947">Request</span><span class="op" id="4204954">.</span><span class="ident" id="4204955">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204964">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204968">t</span><span class="op" id="4204969">.</span><span class="ident" id="4204970">Body</span>&nbsp;<span class="op" id="4204975">=</span>&nbsp;<span class="ident" id="4204977">rr</span><span class="op" id="4204979">.</span><span class="ident" id="4204980">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204987">t</span><span class="op" id="4204988">.</span><span class="ident" id="4204989">BodyCloser</span>&nbsp;<span class="op" id="4205000">=</span>&nbsp;<span class="ident" id="4205002">rr</span><span class="op" id="4205004">.</span><span class="ident" id="4205005">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205012">t</span><span class="op" id="4205013">.</span><span class="ident" id="4205014">ContentLength</span>&nbsp;<span class="op" id="4205028">=</span>&nbsp;<span class="ident" id="4205030">rr</span><span class="op" id="4205032">.</span><span class="ident" id="4205033">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205049">t</span><span class="op" id="4205050">.</span><span class="ident" id="4205051">Close</span>&nbsp;<span class="op" id="4205057">=</span>&nbsp;<span class="ident" id="4205059">rr</span><span class="op" id="4205061">.</span><span class="ident" id="4205062">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205070">t</span><span class="op" id="4205071">.</span><span class="ident" id="4205072">TransferEncoding</span>&nbsp;<span class="op" id="4205089">=</span>&nbsp;<span class="ident" id="4205091">rr</span><span class="op" id="4205093">.</span><span class="ident" id="4205094">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205113">t</span><span class="op" id="4205114">.</span><span class="ident" id="4205115">Trailer</span>&nbsp;<span class="op" id="4205123">=</span>&nbsp;<span class="ident" id="4205125">rr</span><span class="op" id="4205127">.</span><span class="ident" id="4205128">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205138">atLeastHTTP11</span>&nbsp;<span class="op" id="4205152">=</span>&nbsp;<span class="ident" id="4205154">rr</span><span class="op" id="4205156">.</span><span class="ident" id="4205157">ProtoAtLeast</span><span class="op" id="4205169">(</span><span class="num" id="4205170">1</span><span class="op" id="4205171">,</span>&nbsp;<span class="num" id="4205173">1</span><span class="op" id="4205174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205178">t</span><span class="op" id="4205179">.</span><span class="ident" id="4205180">ResponseToHEAD</span>&nbsp;<span class="op" id="4205195">=</span>&nbsp;<span class="ident" id="4205197">noBodyExpected</span><span class="op" id="4205211">(</span><span class="ident" id="4205212">t</span><span class="op" id="4205213">.</span><span class="ident" id="4205214">Method</span><span class="op" id="4205220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205227">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205276">if</span>&nbsp;<span class="ident" id="4205279">t</span><span class="op" id="4205280">.</span><span class="ident" id="4205281">ResponseToHEAD</span>&nbsp;<span class="op" id="4205296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205300">t</span><span class="op" id="4205301">.</span><span class="ident" id="4205302">Body</span>&nbsp;<span class="op" id="4205307">=</span>&nbsp;<span class="builtintype" id="4205309">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205315">if</span>&nbsp;<span class="ident" id="4205318">chunked</span><span class="op" id="4205325">(</span><span class="ident" id="4205326">t</span><span class="op" id="4205327">.</span><span class="ident" id="4205328">TransferEncoding</span><span class="op" id="4205344">)</span>&nbsp;<span class="op" id="4205346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205351">t</span><span class="op" id="4205352">.</span><span class="ident" id="4205353">ContentLength</span>&nbsp;<span class="op" id="4205367">=</span>&nbsp;<span class="op" id="4205369">-</span><span class="num" id="4205370">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205377">}</span>&nbsp;<span class="keyword" id="4205379">else</span>&nbsp;<span class="op" id="4205384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205388">if</span>&nbsp;<span class="op" id="4205391">!</span><span class="ident" id="4205392">atLeastHTTP11</span>&nbsp;<span class="op" id="4205406">||</span>&nbsp;<span class="ident" id="4205409">t</span><span class="op" id="4205410">.</span><span class="ident" id="4205411">Body</span>&nbsp;<span class="op" id="4205416">==</span>&nbsp;<span class="builtintype" id="4205419">nil</span>&nbsp;<span class="op" id="4205423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205428">t</span><span class="op" id="4205429">.</span><span class="ident" id="4205430">TransferEncoding</span>&nbsp;<span class="op" id="4205447">=</span>&nbsp;<span class="builtintype" id="4205449">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205455">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205459">if</span>&nbsp;<span class="ident" id="4205462">chunked</span><span class="op" id="4205469">(</span><span class="ident" id="4205470">t</span><span class="op" id="4205471">.</span><span class="ident" id="4205472">TransferEncoding</span><span class="op" id="4205488">)</span>&nbsp;<span class="op" id="4205490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205495">t</span><span class="op" id="4205496">.</span><span class="ident" id="4205497">ContentLength</span>&nbsp;<span class="op" id="4205511">=</span>&nbsp;<span class="op" id="4205513">-</span><span class="num" id="4205514">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205518">}</span>&nbsp;<span class="keyword" id="4205520">else</span>&nbsp;<span class="keyword" id="4205525">if</span>&nbsp;<span class="ident" id="4205528">t</span><span class="op" id="4205529">.</span><span class="ident" id="4205530">Body</span>&nbsp;<span class="op" id="4205535">==</span>&nbsp;<span class="builtintype" id="4205538">nil</span>&nbsp;<span class="op" id="4205542">{</span>&nbsp;<span class="comment" id="4205544">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205571">t</span><span class="op" id="4205572">.</span><span class="ident" id="4205573">ContentLength</span>&nbsp;<span class="op" id="4205587">=</span>&nbsp;<span class="num" id="4205589">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205593">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205600">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205621">if</span>&nbsp;<span class="op" id="4205624">!</span><span class="ident" id="4205625">chunked</span><span class="op" id="4205632">(</span><span class="ident" id="4205633">t</span><span class="op" id="4205634">.</span><span class="ident" id="4205635">TransferEncoding</span><span class="op" id="4205651">)</span>&nbsp;<span class="op" id="4205653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205657">t</span><span class="op" id="4205658">.</span><span class="ident" id="4205659">Trailer</span>&nbsp;<span class="op" id="4205667">=</span>&nbsp;<span class="builtintype" id="4205669">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205678">return</span>&nbsp;<span class="ident" id="4205685">t</span><span class="op" id="4205686">,</span>&nbsp;<span class="builtintype" id="4205688">nil</span><br>
<span class="lineno"></span><span class="op" id="4205692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4205695">func</span>&nbsp;<span class="ident" id="4205700">noBodyExpected</span><span class="op" id="4205714">(</span><span class="ident" id="4205715">requestMethod</span>&nbsp;<span class="builtintype" id="4205729">string</span><span class="op" id="4205735">)</span>&nbsp;<span class="builtintype" id="4205737">bool</span>&nbsp;<span class="op" id="4205742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205745">return</span>&nbsp;<span class="ident" id="4205752">requestMethod</span>&nbsp;<span class="op" id="4205766">==</span>&nbsp;<span class="string" id="4205769">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="4205776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4205779">func</span>&nbsp;<span class="op" id="4205784">(</span><span class="ident" id="4205785">t</span>&nbsp;<span class="op" id="4205787">*</span><span class="ident" id="4205788">transferWriter</span><span class="op" id="4205802">)</span>&nbsp;<span class="ident" id="4205804">shouldSendContentLength</span><span class="op" id="4205827">(</span><span class="op" id="4205828">)</span>&nbsp;<span class="builtintype" id="4205830">bool</span>&nbsp;<span class="op" id="4205835">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205838">if</span>&nbsp;<span class="ident" id="4205841">chunked</span><span class="op" id="4205848">(</span><span class="ident" id="4205849">t</span><span class="op" id="4205850">.</span><span class="ident" id="4205851">TransferEncoding</span><span class="op" id="4205867">)</span>&nbsp;<span class="op" id="4205869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205873">return</span>&nbsp;<span class="builtintype" id="4205880">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205890">if</span>&nbsp;<span class="ident" id="4205893">t</span><span class="op" id="4205894">.</span><span class="ident" id="4205895">ContentLength</span>&nbsp;<span class="op" id="4205909">&gt;</span>&nbsp;<span class="num" id="4205911">0</span>&nbsp;<span class="op" id="4205913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205917">return</span>&nbsp;<span class="builtintype" id="4205924">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205933">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205992">if</span>&nbsp;<span class="ident" id="4205995">t</span><span class="op" id="4205996">.</span><span class="ident" id="4205997">Method</span>&nbsp;<span class="op" id="4206004">==</span>&nbsp;<span class="string" id="4206007">&#34;POST&#34;</span>&nbsp;<span class="op" id="4206014">||</span>&nbsp;<span class="ident" id="4206017">t</span><span class="op" id="4206018">.</span><span class="ident" id="4206019">Method</span>&nbsp;<span class="op" id="4206026">==</span>&nbsp;<span class="string" id="4206029">&#34;PUT&#34;</span>&nbsp;<span class="op" id="4206035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206039">return</span>&nbsp;<span class="builtintype" id="4206046">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206052">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206055">if</span>&nbsp;<span class="ident" id="4206058">t</span><span class="op" id="4206059">.</span><span class="ident" id="4206060">ContentLength</span>&nbsp;<span class="op" id="4206074">==</span>&nbsp;<span class="num" id="4206077">0</span>&nbsp;<span class="op" id="4206079">&amp;&amp;</span>&nbsp;<span class="ident" id="4206082">isIdentity</span><span class="op" id="4206092">(</span><span class="ident" id="4206093">t</span><span class="op" id="4206094">.</span><span class="ident" id="4206095">TransferEncoding</span><span class="op" id="4206111">)</span>&nbsp;<span class="op" id="4206113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206117">return</span>&nbsp;<span class="builtintype" id="4206124">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206134">return</span>&nbsp;<span class="builtintype" id="4206141">false</span><br>
<span class="lineno">150</span><span class="op" id="4206147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4206150">func</span>&nbsp;<span class="op" id="4206155">(</span><span class="ident" id="4206156">t</span>&nbsp;<span class="op" id="4206158">*</span><span class="ident" id="4206159">transferWriter</span><span class="op" id="4206173">)</span>&nbsp;<span class="ident" id="4206175">WriteHeader</span><span class="op" id="4206186">(</span><span class="ident" id="4206187">w</span>&nbsp;<span class="ident" id="4206189">io</span><span class="op" id="4206191">.</span><span class="ident" id="4206192">Writer</span><span class="op" id="4206198">)</span>&nbsp;<span class="builtintype" id="4206200">error</span>&nbsp;<span class="op" id="4206206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206209">if</span>&nbsp;<span class="ident" id="4206212">t</span><span class="op" id="4206213">.</span><span class="ident" id="4206214">Close</span>&nbsp;<span class="op" id="4206220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206224">if</span>&nbsp;<span class="ident" id="4206227">_</span><span class="op" id="4206228">,</span>&nbsp;<span class="ident" id="4206230">err</span>&nbsp;<span class="op" id="4206234">:=</span>&nbsp;<span class="ident" id="4206237">io</span><span class="op" id="4206239">.</span><span class="ident" id="4206240">WriteString</span><span class="op" id="4206251">(</span><span class="ident" id="4206252">w</span><span class="op" id="4206253">,</span>&nbsp;<span class="string" id="4206255">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="4206278">)</span><span class="op" id="4206279">;</span>&nbsp;<span class="ident" id="4206281">err</span>&nbsp;<span class="op" id="4206285">!=</span>&nbsp;<span class="builtintype" id="4206288">nil</span>&nbsp;<span class="op" id="4206292">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206297">return</span>&nbsp;<span class="ident" id="4206304">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206317">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206386">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206451">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206473">if</span>&nbsp;<span class="ident" id="4206476">t</span><span class="op" id="4206477">.</span><span class="ident" id="4206478">shouldSendContentLength</span><span class="op" id="4206501">(</span><span class="op" id="4206502">)</span>&nbsp;<span class="op" id="4206504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206508">if</span>&nbsp;<span class="ident" id="4206511">_</span><span class="op" id="4206512">,</span>&nbsp;<span class="ident" id="4206514">err</span>&nbsp;<span class="op" id="4206518">:=</span>&nbsp;<span class="ident" id="4206521">io</span><span class="op" id="4206523">.</span><span class="ident" id="4206524">WriteString</span><span class="op" id="4206535">(</span><span class="ident" id="4206536">w</span><span class="op" id="4206537">,</span>&nbsp;<span class="string" id="4206539">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4206557">)</span><span class="op" id="4206558">;</span>&nbsp;<span class="ident" id="4206560">err</span>&nbsp;<span class="op" id="4206564">!=</span>&nbsp;<span class="builtintype" id="4206567">nil</span>&nbsp;<span class="op" id="4206571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206576">return</span>&nbsp;<span class="ident" id="4206583">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206593">if</span>&nbsp;<span class="ident" id="4206596">_</span><span class="op" id="4206597">,</span>&nbsp;<span class="ident" id="4206599">err</span>&nbsp;<span class="op" id="4206603">:=</span>&nbsp;<span class="ident" id="4206606">io</span><span class="op" id="4206608">.</span><span class="ident" id="4206609">WriteString</span><span class="op" id="4206620">(</span><span class="ident" id="4206621">w</span><span class="op" id="4206622">,</span>&nbsp;<span class="ident" id="4206624">strconv</span><span class="op" id="4206631">.</span><span class="ident" id="4206632">FormatInt</span><span class="op" id="4206641">(</span><span class="ident" id="4206642">t</span><span class="op" id="4206643">.</span><span class="ident" id="4206644">ContentLength</span><span class="op" id="4206657">,</span>&nbsp;<span class="num" id="4206659">10</span><span class="op" id="4206661">)</span><span class="op" id="4206662">+</span><span class="string" id="4206663">&#34;\r\n&#34;</span><span class="op" id="4206669">)</span><span class="op" id="4206670">;</span>&nbsp;<span class="ident" id="4206672">err</span>&nbsp;<span class="op" id="4206676">!=</span>&nbsp;<span class="builtintype" id="4206679">nil</span>&nbsp;<span class="op" id="4206683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206688">return</span>&nbsp;<span class="ident" id="4206695">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206704">}</span>&nbsp;<span class="keyword" id="4206706">else</span>&nbsp;<span class="keyword" id="4206711">if</span>&nbsp;<span class="ident" id="4206714">chunked</span><span class="op" id="4206721">(</span><span class="ident" id="4206722">t</span><span class="op" id="4206723">.</span><span class="ident" id="4206724">TransferEncoding</span><span class="op" id="4206740">)</span>&nbsp;<span class="op" id="4206742">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206746">if</span>&nbsp;<span class="ident" id="4206749">_</span><span class="op" id="4206750">,</span>&nbsp;<span class="ident" id="4206752">err</span>&nbsp;<span class="op" id="4206756">:=</span>&nbsp;<span class="ident" id="4206759">io</span><span class="op" id="4206761">.</span><span class="ident" id="4206762">WriteString</span><span class="op" id="4206773">(</span><span class="ident" id="4206774">w</span><span class="op" id="4206775">,</span>&nbsp;<span class="string" id="4206777">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="4206809">)</span><span class="op" id="4206810">;</span>&nbsp;<span class="ident" id="4206812">err</span>&nbsp;<span class="op" id="4206816">!=</span>&nbsp;<span class="builtintype" id="4206819">nil</span>&nbsp;<span class="op" id="4206823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206828">return</span>&nbsp;<span class="ident" id="4206835">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206848">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206873">if</span>&nbsp;<span class="ident" id="4206876">t</span><span class="op" id="4206877">.</span><span class="ident" id="4206878">Trailer</span>&nbsp;<span class="op" id="4206886">!=</span>&nbsp;<span class="builtintype" id="4206889">nil</span>&nbsp;<span class="op" id="4206893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206897">keys</span>&nbsp;<span class="op" id="4206902">:=</span>&nbsp;<span class="builtinfunc" id="4206905">make</span><span class="op" id="4206909">(</span><span class="op" id="4206910">[</span><span class="op" id="4206911">]</span><span class="builtintype" id="4206912">string</span><span class="op" id="4206918">,</span>&nbsp;<span class="num" id="4206920">0</span><span class="op" id="4206921">,</span>&nbsp;<span class="builtinfunc" id="4206923">len</span><span class="op" id="4206926">(</span><span class="ident" id="4206927">t</span><span class="op" id="4206928">.</span><span class="ident" id="4206929">Trailer</span><span class="op" id="4206936">)</span><span class="op" id="4206937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206941">for</span>&nbsp;<span class="ident" id="4206945">k</span>&nbsp;<span class="op" id="4206947">:=</span>&nbsp;<span class="keyword" id="4206950">range</span>&nbsp;<span class="ident" id="4206956">t</span><span class="op" id="4206957">.</span><span class="ident" id="4206958">Trailer</span>&nbsp;<span class="op" id="4206966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206971">k</span>&nbsp;<span class="op" id="4206973">=</span>&nbsp;<span class="ident" id="4206975">CanonicalHeaderKey</span><span class="op" id="4206993">(</span><span class="ident" id="4206994">k</span><span class="op" id="4206995">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207000">switch</span>&nbsp;<span class="ident" id="4207007">k</span>&nbsp;<span class="op" id="4207009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207014">case</span>&nbsp;<span class="string" id="4207019">&#34;Transfer-Encoding&#34;</span><span class="op" id="4207038">,</span>&nbsp;<span class="string" id="4207040">&#34;Trailer&#34;</span><span class="op" id="4207049">,</span>&nbsp;<span class="string" id="4207051">&#34;Content-Length&#34;</span><span class="op" id="4207067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207073">return</span>&nbsp;<span class="op" id="4207080">&amp;</span><span class="ident" id="4207081">badStringError</span><span class="op" id="4207095">{</span><span class="string" id="4207096">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="4207117">,</span>&nbsp;<span class="ident" id="4207119">k</span><span class="op" id="4207120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207130">keys</span>&nbsp;<span class="op" id="4207135">=</span>&nbsp;<span class="builtinfunc" id="4207137">append</span><span class="op" id="4207143">(</span><span class="ident" id="4207144">keys</span><span class="op" id="4207148">,</span>&nbsp;<span class="ident" id="4207150">k</span><span class="op" id="4207151">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207159">if</span>&nbsp;<span class="builtinfunc" id="4207162">len</span><span class="op" id="4207165">(</span><span class="ident" id="4207166">keys</span><span class="op" id="4207170">)</span>&nbsp;<span class="op" id="4207172">&gt;</span>&nbsp;<span class="num" id="4207174">0</span>&nbsp;<span class="op" id="4207176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207181">sort</span><span class="op" id="4207185">.</span><span class="ident" id="4207186">Strings</span><span class="op" id="4207193">(</span><span class="ident" id="4207194">keys</span><span class="op" id="4207198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207203">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207276">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207305">if</span>&nbsp;<span class="ident" id="4207308">_</span><span class="op" id="4207309">,</span>&nbsp;<span class="ident" id="4207311">err</span>&nbsp;<span class="op" id="4207315">:=</span>&nbsp;<span class="ident" id="4207318">io</span><span class="op" id="4207320">.</span><span class="ident" id="4207321">WriteString</span><span class="op" id="4207332">(</span><span class="ident" id="4207333">w</span><span class="op" id="4207334">,</span>&nbsp;<span class="string" id="4207336">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="4207347">+</span><span class="ident" id="4207348">strings</span><span class="op" id="4207355">.</span><span class="ident" id="4207356">Join</span><span class="op" id="4207360">(</span><span class="ident" id="4207361">keys</span><span class="op" id="4207365">,</span>&nbsp;<span class="string" id="4207367">&#34;,&#34;</span><span class="op" id="4207370">)</span><span class="op" id="4207371">+</span><span class="string" id="4207372">&#34;\r\n&#34;</span><span class="op" id="4207378">)</span><span class="op" id="4207379">;</span>&nbsp;<span class="ident" id="4207381">err</span>&nbsp;<span class="op" id="4207385">!=</span>&nbsp;<span class="builtintype" id="4207388">nil</span>&nbsp;<span class="op" id="4207392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207398">return</span>&nbsp;<span class="ident" id="4207405">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207419">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207423">return</span>&nbsp;<span class="builtintype" id="4207430">nil</span><br>
<span class="lineno"></span><span class="op" id="4207434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4207437">func</span>&nbsp;<span class="op" id="4207442">(</span><span class="ident" id="4207443">t</span>&nbsp;<span class="op" id="4207445">*</span><span class="ident" id="4207446">transferWriter</span><span class="op" id="4207460">)</span>&nbsp;<span class="ident" id="4207462">WriteBody</span><span class="op" id="4207471">(</span><span class="ident" id="4207472">w</span>&nbsp;<span class="ident" id="4207474">io</span><span class="op" id="4207476">.</span><span class="ident" id="4207477">Writer</span><span class="op" id="4207483">)</span>&nbsp;<span class="builtintype" id="4207485">error</span>&nbsp;<span class="op" id="4207491">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207494">var</span>&nbsp;<span class="ident" id="4207498">err</span>&nbsp;<span class="builtintype" id="4207502">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207509">var</span>&nbsp;<span class="ident" id="4207513">ncopy</span>&nbsp;<span class="ident" id="4207519">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207527">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207542">if</span>&nbsp;<span class="ident" id="4207545">t</span><span class="op" id="4207546">.</span><span class="ident" id="4207547">Body</span>&nbsp;<span class="op" id="4207552">!=</span>&nbsp;<span class="builtintype" id="4207555">nil</span>&nbsp;<span class="op" id="4207559">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207563">if</span>&nbsp;<span class="ident" id="4207566">chunked</span><span class="op" id="4207573">(</span><span class="ident" id="4207574">t</span><span class="op" id="4207575">.</span><span class="ident" id="4207576">TransferEncoding</span><span class="op" id="4207592">)</span>&nbsp;<span class="op" id="4207594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207599">cw</span>&nbsp;<span class="op" id="4207602">:=</span>&nbsp;<span class="ident" id="4207605">internal</span><span class="op" id="4207613">.</span><span class="ident" id="4207614">NewChunkedWriter</span><span class="op" id="4207630">(</span><span class="ident" id="4207631">w</span><span class="op" id="4207632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207637">_</span><span class="op" id="4207638">,</span>&nbsp;<span class="ident" id="4207640">err</span>&nbsp;<span class="op" id="4207644">=</span>&nbsp;<span class="ident" id="4207646">io</span><span class="op" id="4207648">.</span><span class="ident" id="4207649">Copy</span><span class="op" id="4207653">(</span><span class="ident" id="4207654">cw</span><span class="op" id="4207656">,</span>&nbsp;<span class="ident" id="4207658">t</span><span class="op" id="4207659">.</span><span class="ident" id="4207660">Body</span><span class="op" id="4207664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207669">if</span>&nbsp;<span class="ident" id="4207672">err</span>&nbsp;<span class="op" id="4207676">==</span>&nbsp;<span class="builtintype" id="4207679">nil</span>&nbsp;<span class="op" id="4207683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207689">err</span>&nbsp;<span class="op" id="4207693">=</span>&nbsp;<span class="ident" id="4207695">cw</span><span class="op" id="4207697">.</span><span class="ident" id="4207698">Close</span><span class="op" id="4207703">(</span><span class="op" id="4207704">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207713">}</span>&nbsp;<span class="keyword" id="4207715">else</span>&nbsp;<span class="keyword" id="4207720">if</span>&nbsp;<span class="ident" id="4207723">t</span><span class="op" id="4207724">.</span><span class="ident" id="4207725">ContentLength</span>&nbsp;<span class="op" id="4207739">==</span>&nbsp;<span class="op" id="4207742">-</span><span class="num" id="4207743">1</span>&nbsp;<span class="op" id="4207745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207750">ncopy</span><span class="op" id="4207755">,</span>&nbsp;<span class="ident" id="4207757">err</span>&nbsp;<span class="op" id="4207761">=</span>&nbsp;<span class="ident" id="4207763">io</span><span class="op" id="4207765">.</span><span class="ident" id="4207766">Copy</span><span class="op" id="4207770">(</span><span class="ident" id="4207771">w</span><span class="op" id="4207772">,</span>&nbsp;<span class="ident" id="4207774">t</span><span class="op" id="4207775">.</span><span class="ident" id="4207776">Body</span><span class="op" id="4207780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207784">}</span>&nbsp;<span class="keyword" id="4207786">else</span>&nbsp;<span class="op" id="4207791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207796">ncopy</span><span class="op" id="4207801">,</span>&nbsp;<span class="ident" id="4207803">err</span>&nbsp;<span class="op" id="4207807">=</span>&nbsp;<span class="ident" id="4207809">io</span><span class="op" id="4207811">.</span><span class="ident" id="4207812">Copy</span><span class="op" id="4207816">(</span><span class="ident" id="4207817">w</span><span class="op" id="4207818">,</span>&nbsp;<span class="ident" id="4207820">io</span><span class="op" id="4207822">.</span><span class="ident" id="4207823">LimitReader</span><span class="op" id="4207834">(</span><span class="ident" id="4207835">t</span><span class="op" id="4207836">.</span><span class="ident" id="4207837">Body</span><span class="op" id="4207841">,</span>&nbsp;<span class="ident" id="4207843">t</span><span class="op" id="4207844">.</span><span class="ident" id="4207845">ContentLength</span><span class="op" id="4207858">)</span><span class="op" id="4207859">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207864">if</span>&nbsp;<span class="ident" id="4207867">err</span>&nbsp;<span class="op" id="4207871">!=</span>&nbsp;<span class="builtintype" id="4207874">nil</span>&nbsp;<span class="op" id="4207878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207884">return</span>&nbsp;<span class="ident" id="4207891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207903">var</span>&nbsp;<span class="ident" id="4207907">nextra</span>&nbsp;<span class="ident" id="4207914">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207923">nextra</span><span class="op" id="4207929">,</span>&nbsp;<span class="ident" id="4207931">err</span>&nbsp;<span class="op" id="4207935">=</span>&nbsp;<span class="ident" id="4207937">io</span><span class="op" id="4207939">.</span><span class="ident" id="4207940">Copy</span><span class="op" id="4207944">(</span><span class="ident" id="4207945">ioutil</span><span class="op" id="4207951">.</span><span class="ident" id="4207952">Discard</span><span class="op" id="4207959">,</span>&nbsp;<span class="ident" id="4207961">t</span><span class="op" id="4207962">.</span><span class="ident" id="4207963">Body</span><span class="op" id="4207967">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207972">ncopy</span>&nbsp;<span class="op" id="4207978">+=</span>&nbsp;<span class="ident" id="4207981">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207994">if</span>&nbsp;<span class="ident" id="4207997">err</span>&nbsp;<span class="op" id="4208001">!=</span>&nbsp;<span class="builtintype" id="4208004">nil</span>&nbsp;<span class="op" id="4208008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208013">return</span>&nbsp;<span class="ident" id="4208020">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208026">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208030">if</span>&nbsp;<span class="ident" id="4208033">err</span>&nbsp;<span class="op" id="4208037">=</span>&nbsp;<span class="ident" id="4208039">t</span><span class="op" id="4208040">.</span><span class="ident" id="4208041">BodyCloser</span><span class="op" id="4208051">.</span><span class="ident" id="4208052">Close</span><span class="op" id="4208057">(</span><span class="op" id="4208058">)</span><span class="op" id="4208059">;</span>&nbsp;<span class="ident" id="4208061">err</span>&nbsp;<span class="op" id="4208065">!=</span>&nbsp;<span class="builtintype" id="4208068">nil</span>&nbsp;<span class="op" id="4208072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208077">return</span>&nbsp;<span class="ident" id="4208084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208097">if</span>&nbsp;<span class="op" id="4208100">!</span><span class="ident" id="4208101">t</span><span class="op" id="4208102">.</span><span class="ident" id="4208103">ResponseToHEAD</span>&nbsp;<span class="op" id="4208118">&amp;&amp;</span>&nbsp;<span class="ident" id="4208121">t</span><span class="op" id="4208122">.</span><span class="ident" id="4208123">ContentLength</span>&nbsp;<span class="op" id="4208137">!=</span>&nbsp;<span class="op" id="4208140">-</span><span class="num" id="4208141">1</span>&nbsp;<span class="op" id="4208143">&amp;&amp;</span>&nbsp;<span class="ident" id="4208146">t</span><span class="op" id="4208147">.</span><span class="ident" id="4208148">ContentLength</span>&nbsp;<span class="op" id="4208162">!=</span>&nbsp;<span class="ident" id="4208165">ncopy</span>&nbsp;<span class="op" id="4208171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208175">return</span>&nbsp;<span class="ident" id="4208182">fmt</span><span class="op" id="4208185">.</span><span class="ident" id="4208186">Errorf</span><span class="op" id="4208192">(</span><span class="string" id="4208193">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4208237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208242">t</span><span class="op" id="4208243">.</span><span class="ident" id="4208244">ContentLength</span><span class="op" id="4208257">,</span>&nbsp;<span class="ident" id="4208259">ncopy</span><span class="op" id="4208264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208271">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208320">if</span>&nbsp;<span class="ident" id="4208323">chunked</span><span class="op" id="4208330">(</span><span class="ident" id="4208331">t</span><span class="op" id="4208332">.</span><span class="ident" id="4208333">TransferEncoding</span><span class="op" id="4208349">)</span>&nbsp;<span class="op" id="4208351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208355">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208381">if</span>&nbsp;<span class="ident" id="4208384">t</span><span class="op" id="4208385">.</span><span class="ident" id="4208386">Trailer</span>&nbsp;<span class="op" id="4208394">!=</span>&nbsp;<span class="builtintype" id="4208397">nil</span>&nbsp;<span class="op" id="4208401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208406">if</span>&nbsp;<span class="ident" id="4208409">err</span>&nbsp;<span class="op" id="4208413">:=</span>&nbsp;<span class="ident" id="4208416">t</span><span class="op" id="4208417">.</span><span class="ident" id="4208418">Trailer</span><span class="op" id="4208425">.</span><span class="ident" id="4208426">Write</span><span class="op" id="4208431">(</span><span class="ident" id="4208432">w</span><span class="op" id="4208433">)</span><span class="op" id="4208434">;</span>&nbsp;<span class="ident" id="4208436">err</span>&nbsp;<span class="op" id="4208440">!=</span>&nbsp;<span class="builtintype" id="4208443">nil</span>&nbsp;<span class="op" id="4208447">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208453">return</span>&nbsp;<span class="ident" id="4208460">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208475">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208506">_</span><span class="op" id="4208507">,</span>&nbsp;<span class="ident" id="4208509">err</span>&nbsp;<span class="op" id="4208513">=</span>&nbsp;<span class="ident" id="4208515">io</span><span class="op" id="4208517">.</span><span class="ident" id="4208518">WriteString</span><span class="op" id="4208529">(</span><span class="ident" id="4208530">w</span><span class="op" id="4208531">,</span>&nbsp;<span class="string" id="4208533">&#34;\r\n&#34;</span><span class="op" id="4208539">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208545">return</span>&nbsp;<span class="ident" id="4208552">err</span><br>
<span class="lineno"></span><span class="op" id="4208556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4208559">type</span>&nbsp;<span class="ident" id="4208564">transferReader</span>&nbsp;<span class="keyword" id="4208579">struct</span>&nbsp;<span class="op" id="4208586">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208589">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208599">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208613">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208621">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4208635">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208640">RequestMethod</span>&nbsp;<span class="builtintype" id="4208654">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208662">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4208676">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208681">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4208695">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208700">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208711">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208728">io</span><span class="op" id="4208730">.</span><span class="ident" id="4208731">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208743">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208760">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208767">TransferEncoding</span>&nbsp;<span class="op" id="4208784">[</span><span class="op" id="4208785">]</span><span class="builtintype" id="4208786">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208794">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4208811">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208817">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208834">Header</span><br>
<span class="lineno"></span><span class="op" id="4208841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4208844">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="4208913">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="4208959">func</span>&nbsp;<span class="ident" id="4208964">bodyAllowedForStatus</span><span class="op" id="4208984">(</span><span class="ident" id="4208985">status</span>&nbsp;<span class="builtintype" id="4208992">int</span><span class="op" id="4208995">)</span>&nbsp;<span class="builtintype" id="4208997">bool</span>&nbsp;<span class="op" id="4209002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209005">switch</span>&nbsp;<span class="op" id="4209012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209015">case</span>&nbsp;<span class="ident" id="4209020">status</span>&nbsp;<span class="op" id="4209027">&gt;=</span>&nbsp;<span class="num" id="4209030">100</span>&nbsp;<span class="op" id="4209034">&amp;&amp;</span>&nbsp;<span class="ident" id="4209037">status</span>&nbsp;<span class="op" id="4209044">&lt;=</span>&nbsp;<span class="num" id="4209047">199</span><span class="op" id="4209050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209054">return</span>&nbsp;<span class="builtintype" id="4209061">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209068">case</span>&nbsp;<span class="ident" id="4209073">status</span>&nbsp;<span class="op" id="4209080">==</span>&nbsp;<span class="num" id="4209083">204</span><span class="op" id="4209086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209090">return</span>&nbsp;<span class="builtintype" id="4209097">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209104">case</span>&nbsp;<span class="ident" id="4209109">status</span>&nbsp;<span class="op" id="4209116">==</span>&nbsp;<span class="num" id="4209119">304</span><span class="op" id="4209122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209126">return</span>&nbsp;<span class="builtintype" id="4209133">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209140">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209143">return</span>&nbsp;<span class="builtintype" id="4209150">true</span><br>
<span class="lineno"></span><span class="op" id="4209155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4209158">var</span>&nbsp;<span class="op" id="4209162">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209165">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209189">=</span>&nbsp;<span class="op" id="4209191">[</span><span class="op" id="4209192">]</span><span class="builtintype" id="4209193">string</span><span class="op" id="4209199">{</span><span class="string" id="4209200">&#34;Content-Type&#34;</span><span class="op" id="4209214">,</span>&nbsp;<span class="string" id="4209216">&#34;Content-Length&#34;</span><span class="op" id="4209232">,</span>&nbsp;<span class="string" id="4209234">&#34;Transfer-Encoding&#34;</span><span class="op" id="4209253">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209256">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="4209280">=</span>&nbsp;<span class="op" id="4209282">[</span><span class="op" id="4209283">]</span><span class="builtintype" id="4209284">string</span><span class="op" id="4209290">{</span><span class="string" id="4209291">&#34;Content-Length&#34;</span><span class="op" id="4209307">,</span>&nbsp;<span class="string" id="4209309">&#34;Transfer-Encoding&#34;</span><span class="op" id="4209328">}</span><br>
<span class="lineno"></span><span class="op" id="4209330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4209333">func</span>&nbsp;<span class="ident" id="4209338">suppressedHeaders</span><span class="op" id="4209355">(</span><span class="ident" id="4209356">status</span>&nbsp;<span class="builtintype" id="4209363">int</span><span class="op" id="4209366">)</span>&nbsp;<span class="op" id="4209368">[</span><span class="op" id="4209369">]</span><span class="builtintype" id="4209370">string</span>&nbsp;<span class="op" id="4209377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209380">switch</span>&nbsp;<span class="op" id="4209387">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209390">case</span>&nbsp;<span class="ident" id="4209395">status</span>&nbsp;<span class="op" id="4209402">==</span>&nbsp;<span class="num" id="4209405">304</span><span class="op" id="4209408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209412">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209495">return</span>&nbsp;<span class="ident" id="4209502">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209524">case</span>&nbsp;<span class="op" id="4209529">!</span><span class="ident" id="4209530">bodyAllowedForStatus</span><span class="op" id="4209550">(</span><span class="ident" id="4209551">status</span><span class="op" id="4209557">)</span><span class="op" id="4209558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209562">return</span>&nbsp;<span class="ident" id="4209569">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209597">return</span>&nbsp;<span class="builtintype" id="4209604">nil</span><br>
<span class="lineno"></span><span class="op" id="4209608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4209611">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="4209644">func</span>&nbsp;<span class="ident" id="4209649">readTransfer</span><span class="op" id="4209661">(</span><span class="ident" id="4209662">msg</span>&nbsp;<span class="keyword" id="4209666">interface</span><span class="op" id="4209675">{</span><span class="op" id="4209676">}</span><span class="op" id="4209677">,</span>&nbsp;<span class="ident" id="4209679">r</span>&nbsp;<span class="op" id="4209681">*</span><span class="ident" id="4209682">bufio</span><span class="op" id="4209687">.</span><span class="ident" id="4209688">Reader</span><span class="op" id="4209694">)</span>&nbsp;<span class="op" id="4209696">(</span><span class="ident" id="4209697">err</span>&nbsp;<span class="builtintype" id="4209701">error</span><span class="op" id="4209706">)</span>&nbsp;<span class="op" id="4209708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209711">t</span>&nbsp;<span class="op" id="4209713">:=</span>&nbsp;<span class="op" id="4209716">&amp;</span><span class="ident" id="4209717">transferReader</span><span class="op" id="4209731">{</span><span class="ident" id="4209732">RequestMethod</span><span class="op" id="4209745">:</span>&nbsp;<span class="string" id="4209747">&#34;GET&#34;</span><span class="op" id="4209752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209756">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209772">isResponse</span>&nbsp;<span class="op" id="4209783">:=</span>&nbsp;<span class="builtintype" id="4209786">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209793">switch</span>&nbsp;<span class="ident" id="4209800">rr</span>&nbsp;<span class="op" id="4209803">:=</span>&nbsp;<span class="ident" id="4209806">msg</span><span class="op" id="4209809">.</span><span class="op" id="4209810">(</span><span class="keyword" id="4209811">type</span><span class="op" id="4209815">)</span>&nbsp;<span class="op" id="4209817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209820">case</span>&nbsp;<span class="op" id="4209825">*</span><span class="ident" id="4209826">Response</span><span class="op" id="4209834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209838">t</span><span class="op" id="4209839">.</span><span class="ident" id="4209840">Header</span>&nbsp;<span class="op" id="4209847">=</span>&nbsp;<span class="ident" id="4209849">rr</span><span class="op" id="4209851">.</span><span class="ident" id="4209852">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209861">t</span><span class="op" id="4209862">.</span><span class="ident" id="4209863">StatusCode</span>&nbsp;<span class="op" id="4209874">=</span>&nbsp;<span class="ident" id="4209876">rr</span><span class="op" id="4209878">.</span><span class="ident" id="4209879">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209892">t</span><span class="op" id="4209893">.</span><span class="ident" id="4209894">ProtoMajor</span>&nbsp;<span class="op" id="4209905">=</span>&nbsp;<span class="ident" id="4209907">rr</span><span class="op" id="4209909">.</span><span class="ident" id="4209910">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209923">t</span><span class="op" id="4209924">.</span><span class="ident" id="4209925">ProtoMinor</span>&nbsp;<span class="op" id="4209936">=</span>&nbsp;<span class="ident" id="4209938">rr</span><span class="op" id="4209940">.</span><span class="ident" id="4209941">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209954">t</span><span class="op" id="4209955">.</span><span class="ident" id="4209956">Close</span>&nbsp;<span class="op" id="4209962">=</span>&nbsp;<span class="ident" id="4209964">shouldClose</span><span class="op" id="4209975">(</span><span class="ident" id="4209976">t</span><span class="op" id="4209977">.</span><span class="ident" id="4209978">ProtoMajor</span><span class="op" id="4209988">,</span>&nbsp;<span class="ident" id="4209990">t</span><span class="op" id="4209991">.</span><span class="ident" id="4209992">ProtoMinor</span><span class="op" id="4210002">,</span>&nbsp;<span class="ident" id="4210004">t</span><span class="op" id="4210005">.</span><span class="ident" id="4210006">Header</span><span class="op" id="4210012">,</span>&nbsp;<span class="builtintype" id="4210014">true</span><span class="op" id="4210018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210022">isResponse</span>&nbsp;<span class="op" id="4210033">=</span>&nbsp;<span class="builtintype" id="4210035">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210042">if</span>&nbsp;<span class="ident" id="4210045">rr</span><span class="op" id="4210047">.</span><span class="ident" id="4210048">Request</span>&nbsp;<span class="op" id="4210056">!=</span>&nbsp;<span class="builtintype" id="4210059">nil</span>&nbsp;<span class="op" id="4210063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210068">t</span><span class="op" id="4210069">.</span><span class="ident" id="4210070">RequestMethod</span>&nbsp;<span class="op" id="4210084">=</span>&nbsp;<span class="ident" id="4210086">rr</span><span class="op" id="4210088">.</span><span class="ident" id="4210089">Request</span><span class="op" id="4210096">.</span><span class="ident" id="4210097">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210109">case</span>&nbsp;<span class="op" id="4210114">*</span><span class="ident" id="4210115">Request</span><span class="op" id="4210122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210126">t</span><span class="op" id="4210127">.</span><span class="ident" id="4210128">Header</span>&nbsp;<span class="op" id="4210135">=</span>&nbsp;<span class="ident" id="4210137">rr</span><span class="op" id="4210139">.</span><span class="ident" id="4210140">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210149">t</span><span class="op" id="4210150">.</span><span class="ident" id="4210151">ProtoMajor</span>&nbsp;<span class="op" id="4210162">=</span>&nbsp;<span class="ident" id="4210164">rr</span><span class="op" id="4210166">.</span><span class="ident" id="4210167">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210180">t</span><span class="op" id="4210181">.</span><span class="ident" id="4210182">ProtoMinor</span>&nbsp;<span class="op" id="4210193">=</span>&nbsp;<span class="ident" id="4210195">rr</span><span class="op" id="4210197">.</span><span class="ident" id="4210198">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210211">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210275">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210339">t</span><span class="op" id="4210340">.</span><span class="ident" id="4210341">StatusCode</span>&nbsp;<span class="op" id="4210352">=</span>&nbsp;<span class="num" id="4210354">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210359">default</span><span class="op" id="4210366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4210370">panic</span><span class="op" id="4210375">(</span><span class="string" id="4210376">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="4210393">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210400">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210424">if</span>&nbsp;<span class="ident" id="4210427">t</span><span class="op" id="4210428">.</span><span class="ident" id="4210429">ProtoMajor</span>&nbsp;<span class="op" id="4210440">==</span>&nbsp;<span class="num" id="4210443">0</span>&nbsp;<span class="op" id="4210445">&amp;&amp;</span>&nbsp;<span class="ident" id="4210448">t</span><span class="op" id="4210449">.</span><span class="ident" id="4210450">ProtoMinor</span>&nbsp;<span class="op" id="4210461">==</span>&nbsp;<span class="num" id="4210464">0</span>&nbsp;<span class="op" id="4210466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210470">t</span><span class="op" id="4210471">.</span><span class="ident" id="4210472">ProtoMajor</span><span class="op" id="4210482">,</span>&nbsp;<span class="ident" id="4210484">t</span><span class="op" id="4210485">.</span><span class="ident" id="4210486">ProtoMinor</span>&nbsp;<span class="op" id="4210497">=</span>&nbsp;<span class="num" id="4210499">1</span><span class="op" id="4210500">,</span>&nbsp;<span class="num" id="4210502">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210509">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210547">t</span><span class="op" id="4210548">.</span><span class="ident" id="4210549">TransferEncoding</span><span class="op" id="4210565">,</span>&nbsp;<span class="ident" id="4210567">err</span>&nbsp;<span class="op" id="4210571">=</span>&nbsp;<span class="ident" id="4210573">fixTransferEncoding</span><span class="op" id="4210592">(</span><span class="ident" id="4210593">t</span><span class="op" id="4210594">.</span><span class="ident" id="4210595">RequestMethod</span><span class="op" id="4210608">,</span>&nbsp;<span class="ident" id="4210610">t</span><span class="op" id="4210611">.</span><span class="ident" id="4210612">Header</span><span class="op" id="4210618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210621">if</span>&nbsp;<span class="ident" id="4210624">err</span>&nbsp;<span class="op" id="4210628">!=</span>&nbsp;<span class="builtintype" id="4210631">nil</span>&nbsp;<span class="op" id="4210635">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210639">return</span>&nbsp;<span class="ident" id="4210646">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210655">realLength</span><span class="op" id="4210665">,</span>&nbsp;<span class="ident" id="4210667">err</span>&nbsp;<span class="op" id="4210671">:=</span>&nbsp;<span class="ident" id="4210674">fixLength</span><span class="op" id="4210683">(</span><span class="ident" id="4210684">isResponse</span><span class="op" id="4210694">,</span>&nbsp;<span class="ident" id="4210696">t</span><span class="op" id="4210697">.</span><span class="ident" id="4210698">StatusCode</span><span class="op" id="4210708">,</span>&nbsp;<span class="ident" id="4210710">t</span><span class="op" id="4210711">.</span><span class="ident" id="4210712">RequestMethod</span><span class="op" id="4210725">,</span>&nbsp;<span class="ident" id="4210727">t</span><span class="op" id="4210728">.</span><span class="ident" id="4210729">Header</span><span class="op" id="4210735">,</span>&nbsp;<span class="ident" id="4210737">t</span><span class="op" id="4210738">.</span><span class="ident" id="4210739">TransferEncoding</span><span class="op" id="4210755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210758">if</span>&nbsp;<span class="ident" id="4210761">err</span>&nbsp;<span class="op" id="4210765">!=</span>&nbsp;<span class="builtintype" id="4210768">nil</span>&nbsp;<span class="op" id="4210772">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210776">return</span>&nbsp;<span class="ident" id="4210783">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210791">if</span>&nbsp;<span class="ident" id="4210794">isResponse</span>&nbsp;<span class="op" id="4210805">&amp;&amp;</span>&nbsp;<span class="ident" id="4210808">t</span><span class="op" id="4210809">.</span><span class="ident" id="4210810">RequestMethod</span>&nbsp;<span class="op" id="4210824">==</span>&nbsp;<span class="string" id="4210827">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4210834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210838">if</span>&nbsp;<span class="ident" id="4210841">n</span><span class="op" id="4210842">,</span>&nbsp;<span class="ident" id="4210844">err</span>&nbsp;<span class="op" id="4210848">:=</span>&nbsp;<span class="ident" id="4210851">parseContentLength</span><span class="op" id="4210869">(</span><span class="ident" id="4210870">t</span><span class="op" id="4210871">.</span><span class="ident" id="4210872">Header</span><span class="op" id="4210878">.</span><span class="ident" id="4210879">get</span><span class="op" id="4210882">(</span><span class="string" id="4210883">&#34;Content-Length&#34;</span><span class="op" id="4210899">)</span><span class="op" id="4210900">)</span><span class="op" id="4210901">;</span>&nbsp;<span class="ident" id="4210903">err</span>&nbsp;<span class="op" id="4210907">!=</span>&nbsp;<span class="builtintype" id="4210910">nil</span>&nbsp;<span class="op" id="4210914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210919">return</span>&nbsp;<span class="ident" id="4210926">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210932">}</span>&nbsp;<span class="keyword" id="4210934">else</span>&nbsp;<span class="op" id="4210939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210944">t</span><span class="op" id="4210945">.</span><span class="ident" id="4210946">ContentLength</span>&nbsp;<span class="op" id="4210960">=</span>&nbsp;<span class="ident" id="4210962">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210969">}</span>&nbsp;<span class="keyword" id="4210971">else</span>&nbsp;<span class="op" id="4210976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210980">t</span><span class="op" id="4210981">.</span><span class="ident" id="4210982">ContentLength</span>&nbsp;<span class="op" id="4210996">=</span>&nbsp;<span class="ident" id="4210998">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211014">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211026">t</span><span class="op" id="4211027">.</span><span class="ident" id="4211028">Trailer</span><span class="op" id="4211035">,</span>&nbsp;<span class="ident" id="4211037">err</span>&nbsp;<span class="op" id="4211041">=</span>&nbsp;<span class="ident" id="4211043">fixTrailer</span><span class="op" id="4211053">(</span><span class="ident" id="4211054">t</span><span class="op" id="4211055">.</span><span class="ident" id="4211056">Header</span><span class="op" id="4211062">,</span>&nbsp;<span class="ident" id="4211064">t</span><span class="op" id="4211065">.</span><span class="ident" id="4211066">TransferEncoding</span><span class="op" id="4211082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211085">if</span>&nbsp;<span class="ident" id="4211088">err</span>&nbsp;<span class="op" id="4211092">!=</span>&nbsp;<span class="builtintype" id="4211095">nil</span>&nbsp;<span class="op" id="4211099">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211103">return</span>&nbsp;<span class="ident" id="4211110">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211119">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211197">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211268">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211298">switch</span>&nbsp;<span class="ident" id="4211305">msg</span><span class="op" id="4211308">.</span><span class="op" id="4211309">(</span><span class="keyword" id="4211310">type</span><span class="op" id="4211314">)</span>&nbsp;<span class="op" id="4211316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211319">case</span>&nbsp;<span class="op" id="4211324">*</span><span class="ident" id="4211325">Response</span><span class="op" id="4211333">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211337">if</span>&nbsp;<span class="ident" id="4211340">realLength</span>&nbsp;<span class="op" id="4211351">==</span>&nbsp;<span class="op" id="4211354">-</span><span class="num" id="4211355">1</span>&nbsp;<span class="op" id="4211357">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211363">!</span><span class="ident" id="4211364">chunked</span><span class="op" id="4211371">(</span><span class="ident" id="4211372">t</span><span class="op" id="4211373">.</span><span class="ident" id="4211374">TransferEncoding</span><span class="op" id="4211390">)</span>&nbsp;<span class="op" id="4211392">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211398">bodyAllowedForStatus</span><span class="op" id="4211418">(</span><span class="ident" id="4211419">t</span><span class="op" id="4211420">.</span><span class="ident" id="4211421">StatusCode</span><span class="op" id="4211431">)</span>&nbsp;<span class="op" id="4211433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211438">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211460">t</span><span class="op" id="4211461">.</span><span class="ident" id="4211462">Close</span>&nbsp;<span class="op" id="4211468">=</span>&nbsp;<span class="builtintype" id="4211470">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211480">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211484">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211551">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211627">switch</span>&nbsp;<span class="op" id="4211634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211637">case</span>&nbsp;<span class="ident" id="4211642">chunked</span><span class="op" id="4211649">(</span><span class="ident" id="4211650">t</span><span class="op" id="4211651">.</span><span class="ident" id="4211652">TransferEncoding</span><span class="op" id="4211668">)</span><span class="op" id="4211669">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211673">if</span>&nbsp;<span class="ident" id="4211676">noBodyExpected</span><span class="op" id="4211690">(</span><span class="ident" id="4211691">t</span><span class="op" id="4211692">.</span><span class="ident" id="4211693">RequestMethod</span><span class="op" id="4211706">)</span>&nbsp;<span class="op" id="4211708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211713">t</span><span class="op" id="4211714">.</span><span class="ident" id="4211715">Body</span>&nbsp;<span class="op" id="4211720">=</span>&nbsp;<span class="ident" id="4211722">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211734">}</span>&nbsp;<span class="keyword" id="4211736">else</span>&nbsp;<span class="op" id="4211741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211746">t</span><span class="op" id="4211747">.</span><span class="ident" id="4211748">Body</span>&nbsp;<span class="op" id="4211753">=</span>&nbsp;<span class="op" id="4211755">&amp;</span><span class="ident" id="4211756">body</span><span class="op" id="4211760">{</span><span class="ident" id="4211761">src</span><span class="op" id="4211764">:</span>&nbsp;<span class="ident" id="4211766">internal</span><span class="op" id="4211774">.</span><span class="ident" id="4211775">NewChunkedReader</span><span class="op" id="4211791">(</span><span class="ident" id="4211792">r</span><span class="op" id="4211793">)</span><span class="op" id="4211794">,</span>&nbsp;<span class="ident" id="4211796">hdr</span><span class="op" id="4211799">:</span>&nbsp;<span class="ident" id="4211801">msg</span><span class="op" id="4211804">,</span>&nbsp;<span class="ident" id="4211806">r</span><span class="op" id="4211807">:</span>&nbsp;<span class="ident" id="4211809">r</span><span class="op" id="4211810">,</span>&nbsp;<span class="ident" id="4211812">closing</span><span class="op" id="4211819">:</span>&nbsp;<span class="ident" id="4211821">t</span><span class="op" id="4211822">.</span><span class="ident" id="4211823">Close</span><span class="op" id="4211828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211832">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211835">case</span>&nbsp;<span class="ident" id="4211840">realLength</span>&nbsp;<span class="op" id="4211851">==</span>&nbsp;<span class="num" id="4211854">0</span><span class="op" id="4211855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211859">t</span><span class="op" id="4211860">.</span><span class="ident" id="4211861">Body</span>&nbsp;<span class="op" id="4211866">=</span>&nbsp;<span class="ident" id="4211868">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211879">case</span>&nbsp;<span class="ident" id="4211884">realLength</span>&nbsp;<span class="op" id="4211895">&gt;</span>&nbsp;<span class="num" id="4211897">0</span><span class="op" id="4211898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211902">t</span><span class="op" id="4211903">.</span><span class="ident" id="4211904">Body</span>&nbsp;<span class="op" id="4211909">=</span>&nbsp;<span class="op" id="4211911">&amp;</span><span class="ident" id="4211912">body</span><span class="op" id="4211916">{</span><span class="ident" id="4211917">src</span><span class="op" id="4211920">:</span>&nbsp;<span class="ident" id="4211922">io</span><span class="op" id="4211924">.</span><span class="ident" id="4211925">LimitReader</span><span class="op" id="4211936">(</span><span class="ident" id="4211937">r</span><span class="op" id="4211938">,</span>&nbsp;<span class="ident" id="4211940">realLength</span><span class="op" id="4211950">)</span><span class="op" id="4211951">,</span>&nbsp;<span class="ident" id="4211953">closing</span><span class="op" id="4211960">:</span>&nbsp;<span class="ident" id="4211962">t</span><span class="op" id="4211963">.</span><span class="ident" id="4211964">Close</span><span class="op" id="4211969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211972">default</span><span class="op" id="4211979">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211983">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212050">if</span>&nbsp;<span class="ident" id="4212053">t</span><span class="op" id="4212054">.</span><span class="ident" id="4212055">Close</span>&nbsp;<span class="op" id="4212061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212066">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212104">t</span><span class="op" id="4212105">.</span><span class="ident" id="4212106">Body</span>&nbsp;<span class="op" id="4212111">=</span>&nbsp;<span class="op" id="4212113">&amp;</span><span class="ident" id="4212114">body</span><span class="op" id="4212118">{</span><span class="ident" id="4212119">src</span><span class="op" id="4212122">:</span>&nbsp;<span class="ident" id="4212124">r</span><span class="op" id="4212125">,</span>&nbsp;<span class="ident" id="4212127">closing</span><span class="op" id="4212134">:</span>&nbsp;<span class="ident" id="4212136">t</span><span class="op" id="4212137">.</span><span class="ident" id="4212138">Close</span><span class="op" id="4212143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212147">}</span>&nbsp;<span class="keyword" id="4212149">else</span>&nbsp;<span class="op" id="4212154">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212159">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212203">t</span><span class="op" id="4212204">.</span><span class="ident" id="4212205">Body</span>&nbsp;<span class="op" id="4212210">=</span>&nbsp;<span class="ident" id="4212212">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212231">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212248">switch</span>&nbsp;<span class="ident" id="4212255">rr</span>&nbsp;<span class="op" id="4212258">:=</span>&nbsp;<span class="ident" id="4212261">msg</span><span class="op" id="4212264">.</span><span class="op" id="4212265">(</span><span class="keyword" id="4212266">type</span><span class="op" id="4212270">)</span>&nbsp;<span class="op" id="4212272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212275">case</span>&nbsp;<span class="op" id="4212280">*</span><span class="ident" id="4212281">Request</span><span class="op" id="4212288">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212292">rr</span><span class="op" id="4212294">.</span><span class="ident" id="4212295">Body</span>&nbsp;<span class="op" id="4212300">=</span>&nbsp;<span class="ident" id="4212302">t</span><span class="op" id="4212303">.</span><span class="ident" id="4212304">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212311">rr</span><span class="op" id="4212313">.</span><span class="ident" id="4212314">ContentLength</span>&nbsp;<span class="op" id="4212328">=</span>&nbsp;<span class="ident" id="4212330">t</span><span class="op" id="4212331">.</span><span class="ident" id="4212332">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212348">rr</span><span class="op" id="4212350">.</span><span class="ident" id="4212351">TransferEncoding</span>&nbsp;<span class="op" id="4212368">=</span>&nbsp;<span class="ident" id="4212370">t</span><span class="op" id="4212371">.</span><span class="ident" id="4212372">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212391">rr</span><span class="op" id="4212393">.</span><span class="ident" id="4212394">Close</span>&nbsp;<span class="op" id="4212400">=</span>&nbsp;<span class="ident" id="4212402">t</span><span class="op" id="4212403">.</span><span class="ident" id="4212404">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212412">rr</span><span class="op" id="4212414">.</span><span class="ident" id="4212415">Trailer</span>&nbsp;<span class="op" id="4212423">=</span>&nbsp;<span class="ident" id="4212425">t</span><span class="op" id="4212426">.</span><span class="ident" id="4212427">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212436">case</span>&nbsp;<span class="op" id="4212441">*</span><span class="ident" id="4212442">Response</span><span class="op" id="4212450">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212454">rr</span><span class="op" id="4212456">.</span><span class="ident" id="4212457">Body</span>&nbsp;<span class="op" id="4212462">=</span>&nbsp;<span class="ident" id="4212464">t</span><span class="op" id="4212465">.</span><span class="ident" id="4212466">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212473">rr</span><span class="op" id="4212475">.</span><span class="ident" id="4212476">ContentLength</span>&nbsp;<span class="op" id="4212490">=</span>&nbsp;<span class="ident" id="4212492">t</span><span class="op" id="4212493">.</span><span class="ident" id="4212494">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212510">rr</span><span class="op" id="4212512">.</span><span class="ident" id="4212513">TransferEncoding</span>&nbsp;<span class="op" id="4212530">=</span>&nbsp;<span class="ident" id="4212532">t</span><span class="op" id="4212533">.</span><span class="ident" id="4212534">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212553">rr</span><span class="op" id="4212555">.</span><span class="ident" id="4212556">Close</span>&nbsp;<span class="op" id="4212562">=</span>&nbsp;<span class="ident" id="4212564">t</span><span class="op" id="4212565">.</span><span class="ident" id="4212566">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212574">rr</span><span class="op" id="4212576">.</span><span class="ident" id="4212577">Trailer</span>&nbsp;<span class="op" id="4212585">=</span>&nbsp;<span class="ident" id="4212587">t</span><span class="op" id="4212588">.</span><span class="ident" id="4212589">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212598">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212602">return</span>&nbsp;<span class="builtintype" id="4212609">nil</span><br>
<span class="lineno"></span><span class="op" id="4212613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4212616">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="4212673">func</span>&nbsp;<span class="ident" id="4212678">chunked</span><span class="op" id="4212685">(</span><span class="ident" id="4212686">te</span>&nbsp;<span class="op" id="4212689">[</span><span class="op" id="4212690">]</span><span class="builtintype" id="4212691">string</span><span class="op" id="4212697">)</span>&nbsp;<span class="builtintype" id="4212699">bool</span>&nbsp;<span class="op" id="4212704">{</span>&nbsp;<span class="keyword" id="4212706">return</span>&nbsp;<span class="builtinfunc" id="4212713">len</span><span class="op" id="4212716">(</span><span class="ident" id="4212717">te</span><span class="op" id="4212719">)</span>&nbsp;<span class="op" id="4212721">&gt;</span>&nbsp;<span class="num" id="4212723">0</span>&nbsp;<span class="op" id="4212725">&amp;&amp;</span>&nbsp;<span class="ident" id="4212728">te</span><span class="op" id="4212730">[</span><span class="num" id="4212731">0</span><span class="op" id="4212732">]</span>&nbsp;<span class="op" id="4212734">==</span>&nbsp;<span class="string" id="4212737">&#34;chunked&#34;</span>&nbsp;<span class="op" id="4212747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4212750">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4212807">func</span>&nbsp;<span class="ident" id="4212812">isIdentity</span><span class="op" id="4212822">(</span><span class="ident" id="4212823">te</span>&nbsp;<span class="op" id="4212826">[</span><span class="op" id="4212827">]</span><span class="builtintype" id="4212828">string</span><span class="op" id="4212834">)</span>&nbsp;<span class="builtintype" id="4212836">bool</span>&nbsp;<span class="op" id="4212841">{</span>&nbsp;<span class="keyword" id="4212843">return</span>&nbsp;<span class="builtinfunc" id="4212850">len</span><span class="op" id="4212853">(</span><span class="ident" id="4212854">te</span><span class="op" id="4212856">)</span>&nbsp;<span class="op" id="4212858">==</span>&nbsp;<span class="num" id="4212861">1</span>&nbsp;<span class="op" id="4212863">&amp;&amp;</span>&nbsp;<span class="ident" id="4212866">te</span><span class="op" id="4212868">[</span><span class="num" id="4212869">0</span><span class="op" id="4212870">]</span>&nbsp;<span class="op" id="4212872">==</span>&nbsp;<span class="string" id="4212875">&#34;identity&#34;</span>&nbsp;<span class="op" id="4212886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4212889">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="4212919">func</span>&nbsp;<span class="ident" id="4212924">fixTransferEncoding</span><span class="op" id="4212943">(</span><span class="ident" id="4212944">requestMethod</span>&nbsp;<span class="builtintype" id="4212958">string</span><span class="op" id="4212964">,</span>&nbsp;<span class="ident" id="4212966">header</span>&nbsp;<span class="ident" id="4212973">Header</span><span class="op" id="4212979">)</span>&nbsp;<span class="op" id="4212981">(</span><span class="op" id="4212982">[</span><span class="op" id="4212983">]</span><span class="builtintype" id="4212984">string</span><span class="op" id="4212990">,</span>&nbsp;<span class="builtintype" id="4212992">error</span><span class="op" id="4212997">)</span>&nbsp;<span class="op" id="4212999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213002">raw</span><span class="op" id="4213005">,</span>&nbsp;<span class="ident" id="4213007">present</span>&nbsp;<span class="op" id="4213015">:=</span>&nbsp;<span class="ident" id="4213018">header</span><span class="op" id="4213024">[</span><span class="string" id="4213025">&#34;Transfer-Encoding&#34;</span><span class="op" id="4213044">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213047">if</span>&nbsp;<span class="op" id="4213050">!</span><span class="ident" id="4213051">present</span>&nbsp;<span class="op" id="4213059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213063">return</span>&nbsp;<span class="builtintype" id="4213070">nil</span><span class="op" id="4213073">,</span>&nbsp;<span class="builtintype" id="4213075">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4213084">delete</span><span class="op" id="4213090">(</span><span class="ident" id="4213091">header</span><span class="op" id="4213097">,</span>&nbsp;<span class="string" id="4213099">&#34;Transfer-Encoding&#34;</span><span class="op" id="4213118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213122">encodings</span>&nbsp;<span class="op" id="4213132">:=</span>&nbsp;<span class="ident" id="4213135">strings</span><span class="op" id="4213142">.</span><span class="ident" id="4213143">Split</span><span class="op" id="4213148">(</span><span class="ident" id="4213149">raw</span><span class="op" id="4213152">[</span><span class="num" id="4213153">0</span><span class="op" id="4213154">]</span><span class="op" id="4213155">,</span>&nbsp;<span class="string" id="4213157">&#34;,&#34;</span><span class="op" id="4213160">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213163">te</span>&nbsp;<span class="op" id="4213166">:=</span>&nbsp;<span class="builtinfunc" id="4213169">make</span><span class="op" id="4213173">(</span><span class="op" id="4213174">[</span><span class="op" id="4213175">]</span><span class="builtintype" id="4213176">string</span><span class="op" id="4213182">,</span>&nbsp;<span class="num" id="4213184">0</span><span class="op" id="4213185">,</span>&nbsp;<span class="builtinfunc" id="4213187">len</span><span class="op" id="4213190">(</span><span class="ident" id="4213191">encodings</span><span class="op" id="4213200">)</span><span class="op" id="4213201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213204">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213267">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213329">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213388">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213433">for</span>&nbsp;<span class="ident" id="4213437">_</span><span class="op" id="4213438">,</span>&nbsp;<span class="ident" id="4213440">encoding</span>&nbsp;<span class="op" id="4213449">:=</span>&nbsp;<span class="keyword" id="4213452">range</span>&nbsp;<span class="ident" id="4213458">encodings</span>&nbsp;<span class="op" id="4213468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213472">encoding</span>&nbsp;<span class="op" id="4213481">=</span>&nbsp;<span class="ident" id="4213483">strings</span><span class="op" id="4213490">.</span><span class="ident" id="4213491">ToLower</span><span class="op" id="4213498">(</span><span class="ident" id="4213499">strings</span><span class="op" id="4213506">.</span><span class="ident" id="4213507">TrimSpace</span><span class="op" id="4213516">(</span><span class="ident" id="4213517">encoding</span><span class="op" id="4213525">)</span><span class="op" id="4213526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213530">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213571">if</span>&nbsp;<span class="ident" id="4213574">encoding</span>&nbsp;<span class="op" id="4213583">==</span>&nbsp;<span class="string" id="4213586">&#34;identity&#34;</span>&nbsp;<span class="op" id="4213597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213602">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213614">if</span>&nbsp;<span class="ident" id="4213617">encoding</span>&nbsp;<span class="op" id="4213626">!=</span>&nbsp;<span class="string" id="4213629">&#34;chunked&#34;</span>&nbsp;<span class="op" id="4213639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213644">return</span>&nbsp;<span class="builtintype" id="4213651">nil</span><span class="op" id="4213654">,</span>&nbsp;<span class="op" id="4213656">&amp;</span><span class="ident" id="4213657">badStringError</span><span class="op" id="4213671">{</span><span class="string" id="4213672">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="4213703">,</span>&nbsp;<span class="ident" id="4213705">encoding</span><span class="op" id="4213713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213721">te</span>&nbsp;<span class="op" id="4213724">=</span>&nbsp;<span class="ident" id="4213726">te</span><span class="op" id="4213728">[</span><span class="num" id="4213729">0</span>&nbsp;<span class="op" id="4213731">:</span>&nbsp;<span class="builtinfunc" id="4213733">len</span><span class="op" id="4213736">(</span><span class="ident" id="4213737">te</span><span class="op" id="4213739">)</span><span class="op" id="4213740">+</span><span class="num" id="4213741">1</span><span class="op" id="4213742">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213746">te</span><span class="op" id="4213748">[</span><span class="builtinfunc" id="4213749">len</span><span class="op" id="4213752">(</span><span class="ident" id="4213753">te</span><span class="op" id="4213755">)</span><span class="op" id="4213756">-</span><span class="num" id="4213757">1</span><span class="op" id="4213758">]</span>&nbsp;<span class="op" id="4213760">=</span>&nbsp;<span class="ident" id="4213762">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213775">if</span>&nbsp;<span class="builtinfunc" id="4213778">len</span><span class="op" id="4213781">(</span><span class="ident" id="4213782">te</span><span class="op" id="4213784">)</span>&nbsp;<span class="op" id="4213786">&gt;</span>&nbsp;<span class="num" id="4213788">1</span>&nbsp;<span class="op" id="4213790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213794">return</span>&nbsp;<span class="builtintype" id="4213801">nil</span><span class="op" id="4213804">,</span>&nbsp;<span class="op" id="4213806">&amp;</span><span class="ident" id="4213807">badStringError</span><span class="op" id="4213821">{</span><span class="string" id="4213822">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="4213851">,</span>&nbsp;<span class="ident" id="4213853">strings</span><span class="op" id="4213860">.</span><span class="ident" id="4213861">Join</span><span class="op" id="4213865">(</span><span class="ident" id="4213866">te</span><span class="op" id="4213868">,</span>&nbsp;<span class="string" id="4213870">&#34;,&#34;</span><span class="op" id="4213873">)</span><span class="op" id="4213874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213877">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213880">if</span>&nbsp;<span class="builtinfunc" id="4213883">len</span><span class="op" id="4213886">(</span><span class="ident" id="4213887">te</span><span class="op" id="4213889">)</span>&nbsp;<span class="op" id="4213891">&gt;</span>&nbsp;<span class="num" id="4213893">0</span>&nbsp;<span class="op" id="4213895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213899">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213957">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214013">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4214028">delete</span><span class="op" id="4214034">(</span><span class="ident" id="4214035">header</span><span class="op" id="4214041">,</span>&nbsp;<span class="string" id="4214043">&#34;Content-Length&#34;</span><span class="op" id="4214059">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214063">return</span>&nbsp;<span class="ident" id="4214070">te</span><span class="op" id="4214072">,</span>&nbsp;<span class="builtintype" id="4214074">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214083">return</span>&nbsp;<span class="builtintype" id="4214090">nil</span><span class="op" id="4214093">,</span>&nbsp;<span class="builtintype" id="4214095">nil</span><br>
<span class="lineno"></span><span class="op" id="4214099">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="4214102">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="4214174">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4214245">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="4214278">func</span>&nbsp;<span class="ident" id="4214283">fixLength</span><span class="op" id="4214292">(</span><span class="ident" id="4214293">isResponse</span>&nbsp;<span class="builtintype" id="4214304">bool</span><span class="op" id="4214308">,</span>&nbsp;<span class="ident" id="4214310">status</span>&nbsp;<span class="builtintype" id="4214317">int</span><span class="op" id="4214320">,</span>&nbsp;<span class="ident" id="4214322">requestMethod</span>&nbsp;<span class="builtintype" id="4214336">string</span><span class="op" id="4214342">,</span>&nbsp;<span class="ident" id="4214344">header</span>&nbsp;<span class="ident" id="4214351">Header</span><span class="op" id="4214357">,</span>&nbsp;<span class="ident" id="4214359">te</span>&nbsp;<span class="op" id="4214362">[</span><span class="op" id="4214363">]</span><span class="builtintype" id="4214364">string</span><span class="op" id="4214370">)</span>&nbsp;<span class="op" id="4214372">(</span><span class="ident" id="4214373">int64</span><span class="op" id="4214378">,</span>&nbsp;<span class="builtintype" id="4214380">error</span><span class="op" id="4214385">)</span>&nbsp;<span class="op" id="4214387">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214391">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214434">if</span>&nbsp;<span class="ident" id="4214437">noBodyExpected</span><span class="op" id="4214451">(</span><span class="ident" id="4214452">requestMethod</span><span class="op" id="4214465">)</span>&nbsp;<span class="op" id="4214467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214471">return</span>&nbsp;<span class="num" id="4214478">0</span><span class="op" id="4214479">,</span>&nbsp;<span class="builtintype" id="4214481">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214486">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214489">if</span>&nbsp;<span class="ident" id="4214492">status</span><span class="op" id="4214498">/</span><span class="num" id="4214499">100</span>&nbsp;<span class="op" id="4214503">==</span>&nbsp;<span class="num" id="4214506">1</span>&nbsp;<span class="op" id="4214508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214512">return</span>&nbsp;<span class="num" id="4214519">0</span><span class="op" id="4214520">,</span>&nbsp;<span class="builtintype" id="4214522">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214530">switch</span>&nbsp;<span class="ident" id="4214537">status</span>&nbsp;<span class="op" id="4214544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214547">case</span>&nbsp;<span class="num" id="4214552">204</span><span class="op" id="4214555">,</span>&nbsp;<span class="num" id="4214557">304</span><span class="op" id="4214560">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214564">return</span>&nbsp;<span class="num" id="4214571">0</span><span class="op" id="4214572">,</span>&nbsp;<span class="builtintype" id="4214574">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214583">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214620">if</span>&nbsp;<span class="ident" id="4214623">chunked</span><span class="op" id="4214630">(</span><span class="ident" id="4214631">te</span><span class="op" id="4214633">)</span>&nbsp;<span class="op" id="4214635">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214639">return</span>&nbsp;<span class="op" id="4214646">-</span><span class="num" id="4214647">1</span><span class="op" id="4214648">,</span>&nbsp;<span class="builtintype" id="4214650">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214659">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214693">cl</span>&nbsp;<span class="op" id="4214696">:=</span>&nbsp;<span class="ident" id="4214699">strings</span><span class="op" id="4214706">.</span><span class="ident" id="4214707">TrimSpace</span><span class="op" id="4214716">(</span><span class="ident" id="4214717">header</span><span class="op" id="4214723">.</span><span class="ident" id="4214724">get</span><span class="op" id="4214727">(</span><span class="string" id="4214728">&#34;Content-Length&#34;</span><span class="op" id="4214744">)</span><span class="op" id="4214745">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214748">if</span>&nbsp;<span class="ident" id="4214751">cl</span>&nbsp;<span class="op" id="4214754">!=</span>&nbsp;<span class="string" id="4214757">&#34;&#34;</span>&nbsp;<span class="op" id="4214760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214764">n</span><span class="op" id="4214765">,</span>&nbsp;<span class="ident" id="4214767">err</span>&nbsp;<span class="op" id="4214771">:=</span>&nbsp;<span class="ident" id="4214774">parseContentLength</span><span class="op" id="4214792">(</span><span class="ident" id="4214793">cl</span><span class="op" id="4214795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214799">if</span>&nbsp;<span class="ident" id="4214802">err</span>&nbsp;<span class="op" id="4214806">!=</span>&nbsp;<span class="builtintype" id="4214809">nil</span>&nbsp;<span class="op" id="4214813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214818">return</span>&nbsp;<span class="op" id="4214825">-</span><span class="num" id="4214826">1</span><span class="op" id="4214827">,</span>&nbsp;<span class="ident" id="4214829">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214835">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214839">return</span>&nbsp;<span class="ident" id="4214846">n</span><span class="op" id="4214847">,</span>&nbsp;<span class="builtintype" id="4214849">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214854">}</span>&nbsp;<span class="keyword" id="4214856">else</span>&nbsp;<span class="op" id="4214861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214865">header</span><span class="op" id="4214871">.</span><span class="ident" id="4214872">Del</span><span class="op" id="4214875">(</span><span class="string" id="4214876">&#34;Content-Length&#34;</span><span class="op" id="4214892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214899">if</span>&nbsp;<span class="op" id="4214902">!</span><span class="ident" id="4214903">isResponse</span>&nbsp;<span class="op" id="4214914">&amp;&amp;</span>&nbsp;<span class="ident" id="4214917">requestMethod</span>&nbsp;<span class="op" id="4214931">==</span>&nbsp;<span class="string" id="4214934">&#34;GET&#34;</span>&nbsp;<span class="op" id="4214940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214944">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214998">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215052">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215107">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215145">return</span>&nbsp;<span class="num" id="4215152">0</span><span class="op" id="4215153">,</span>&nbsp;<span class="builtintype" id="4215155">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215164">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215240">return</span>&nbsp;<span class="op" id="4215247">-</span><span class="num" id="4215248">1</span><span class="op" id="4215249">,</span>&nbsp;<span class="builtintype" id="4215251">nil</span><br>
<span class="lineno">500</span><span class="op" id="4215255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215258">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4215327">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="4215360">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="4215395">func</span>&nbsp;<span class="ident" id="4215400">shouldClose</span><span class="op" id="4215411">(</span><span class="ident" id="4215412">major</span><span class="op" id="4215417">,</span>&nbsp;<span class="ident" id="4215419">minor</span>&nbsp;<span class="builtintype" id="4215425">int</span><span class="op" id="4215428">,</span>&nbsp;<span class="ident" id="4215430">header</span>&nbsp;<span class="ident" id="4215437">Header</span><span class="op" id="4215443">,</span>&nbsp;<span class="ident" id="4215445">removeCloseHeader</span>&nbsp;<span class="builtintype" id="4215463">bool</span><span class="op" id="4215467">)</span>&nbsp;<span class="builtintype" id="4215469">bool</span>&nbsp;<span class="op" id="4215474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215477">if</span>&nbsp;<span class="ident" id="4215480">major</span>&nbsp;<span class="op" id="4215486">&lt;</span>&nbsp;<span class="num" id="4215488">1</span>&nbsp;<span class="op" id="4215490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215494">return</span>&nbsp;<span class="builtintype" id="4215501">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215507">}</span>&nbsp;<span class="keyword" id="4215509">else</span>&nbsp;<span class="keyword" id="4215514">if</span>&nbsp;<span class="ident" id="4215517">major</span>&nbsp;<span class="op" id="4215523">==</span>&nbsp;<span class="num" id="4215526">1</span>&nbsp;<span class="op" id="4215528">&amp;&amp;</span>&nbsp;<span class="ident" id="4215531">minor</span>&nbsp;<span class="op" id="4215537">==</span>&nbsp;<span class="num" id="4215540">0</span>&nbsp;<span class="op" id="4215542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215546">if</span>&nbsp;<span class="op" id="4215549">!</span><span class="ident" id="4215550">strings</span><span class="op" id="4215557">.</span><span class="ident" id="4215558">Contains</span><span class="op" id="4215566">(</span><span class="ident" id="4215567">strings</span><span class="op" id="4215574">.</span><span class="ident" id="4215575">ToLower</span><span class="op" id="4215582">(</span><span class="ident" id="4215583">header</span><span class="op" id="4215589">.</span><span class="ident" id="4215590">get</span><span class="op" id="4215593">(</span><span class="string" id="4215594">&#34;Connection&#34;</span><span class="op" id="4215606">)</span><span class="op" id="4215607">)</span><span class="op" id="4215608">,</span>&nbsp;<span class="string" id="4215610">&#34;keep-alive&#34;</span><span class="op" id="4215622">)</span>&nbsp;<span class="op" id="4215624">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215629">return</span>&nbsp;<span class="builtintype" id="4215636">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215647">return</span>&nbsp;<span class="builtintype" id="4215654">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215661">}</span>&nbsp;<span class="keyword" id="4215663">else</span>&nbsp;<span class="op" id="4215668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215672">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215737">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215764">if</span>&nbsp;<span class="ident" id="4215767">strings</span><span class="op" id="4215774">.</span><span class="ident" id="4215775">ToLower</span><span class="op" id="4215782">(</span><span class="ident" id="4215783">header</span><span class="op" id="4215789">.</span><span class="ident" id="4215790">get</span><span class="op" id="4215793">(</span><span class="string" id="4215794">&#34;Connection&#34;</span><span class="op" id="4215806">)</span><span class="op" id="4215807">)</span>&nbsp;<span class="op" id="4215809">==</span>&nbsp;<span class="string" id="4215812">&#34;close&#34;</span>&nbsp;<span class="op" id="4215820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215825">if</span>&nbsp;<span class="ident" id="4215828">removeCloseHeader</span>&nbsp;<span class="op" id="4215846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215852">header</span><span class="op" id="4215858">.</span><span class="ident" id="4215859">Del</span><span class="op" id="4215862">(</span><span class="string" id="4215863">&#34;Connection&#34;</span><span class="op" id="4215875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215880">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215885">return</span>&nbsp;<span class="builtintype" id="4215892">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215905">return</span>&nbsp;<span class="builtintype" id="4215912">false</span><br>
<span class="lineno"></span><span class="op" id="4215918">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="4215921">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4215949">func</span>&nbsp;<span class="ident" id="4215954">fixTrailer</span><span class="op" id="4215964">(</span><span class="ident" id="4215965">header</span>&nbsp;<span class="ident" id="4215972">Header</span><span class="op" id="4215978">,</span>&nbsp;<span class="ident" id="4215980">te</span>&nbsp;<span class="op" id="4215983">[</span><span class="op" id="4215984">]</span><span class="builtintype" id="4215985">string</span><span class="op" id="4215991">)</span>&nbsp;<span class="op" id="4215993">(</span><span class="ident" id="4215994">Header</span><span class="op" id="4216000">,</span>&nbsp;<span class="builtintype" id="4216002">error</span><span class="op" id="4216007">)</span>&nbsp;<span class="op" id="4216009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216012">raw</span>&nbsp;<span class="op" id="4216016">:=</span>&nbsp;<span class="ident" id="4216019">header</span><span class="op" id="4216025">.</span><span class="ident" id="4216026">get</span><span class="op" id="4216029">(</span><span class="string" id="4216030">&#34;Trailer&#34;</span><span class="op" id="4216039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216042">if</span>&nbsp;<span class="ident" id="4216045">raw</span>&nbsp;<span class="op" id="4216049">==</span>&nbsp;<span class="string" id="4216052">&#34;&#34;</span>&nbsp;<span class="op" id="4216055">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216059">return</span>&nbsp;<span class="builtintype" id="4216066">nil</span><span class="op" id="4216069">,</span>&nbsp;<span class="builtintype" id="4216071">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216080">header</span><span class="op" id="4216086">.</span><span class="ident" id="4216087">Del</span><span class="op" id="4216090">(</span><span class="string" id="4216091">&#34;Trailer&#34;</span><span class="op" id="4216100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216103">trailer</span>&nbsp;<span class="op" id="4216111">:=</span>&nbsp;<span class="builtinfunc" id="4216114">make</span><span class="op" id="4216118">(</span><span class="ident" id="4216119">Header</span><span class="op" id="4216125">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216128">keys</span>&nbsp;<span class="op" id="4216133">:=</span>&nbsp;<span class="ident" id="4216136">strings</span><span class="op" id="4216143">.</span><span class="ident" id="4216144">Split</span><span class="op" id="4216149">(</span><span class="ident" id="4216150">raw</span><span class="op" id="4216153">,</span>&nbsp;<span class="string" id="4216155">&#34;,&#34;</span><span class="op" id="4216158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216161">for</span>&nbsp;<span class="ident" id="4216165">_</span><span class="op" id="4216166">,</span>&nbsp;<span class="ident" id="4216168">key</span>&nbsp;<span class="op" id="4216172">:=</span>&nbsp;<span class="keyword" id="4216175">range</span>&nbsp;<span class="ident" id="4216181">keys</span>&nbsp;<span class="op" id="4216186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216190">key</span>&nbsp;<span class="op" id="4216194">=</span>&nbsp;<span class="ident" id="4216196">CanonicalHeaderKey</span><span class="op" id="4216214">(</span><span class="ident" id="4216215">strings</span><span class="op" id="4216222">.</span><span class="ident" id="4216223">TrimSpace</span><span class="op" id="4216232">(</span><span class="ident" id="4216233">key</span><span class="op" id="4216236">)</span><span class="op" id="4216237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216241">switch</span>&nbsp;<span class="ident" id="4216248">key</span>&nbsp;<span class="op" id="4216252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216256">case</span>&nbsp;<span class="string" id="4216261">&#34;Transfer-Encoding&#34;</span><span class="op" id="4216280">,</span>&nbsp;<span class="string" id="4216282">&#34;Trailer&#34;</span><span class="op" id="4216291">,</span>&nbsp;<span class="string" id="4216293">&#34;Content-Length&#34;</span><span class="op" id="4216309">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216314">return</span>&nbsp;<span class="builtintype" id="4216321">nil</span><span class="op" id="4216324">,</span>&nbsp;<span class="op" id="4216326">&amp;</span><span class="ident" id="4216327">badStringError</span><span class="op" id="4216341">{</span><span class="string" id="4216342">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="4216359">,</span>&nbsp;<span class="ident" id="4216361">key</span><span class="op" id="4216364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216372">trailer</span><span class="op" id="4216379">[</span><span class="ident" id="4216380">key</span><span class="op" id="4216383">]</span>&nbsp;<span class="op" id="4216385">=</span>&nbsp;<span class="builtintype" id="4216387">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216395">if</span>&nbsp;<span class="builtinfunc" id="4216398">len</span><span class="op" id="4216401">(</span><span class="ident" id="4216402">trailer</span><span class="op" id="4216409">)</span>&nbsp;<span class="op" id="4216411">==</span>&nbsp;<span class="num" id="4216414">0</span>&nbsp;<span class="op" id="4216416">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216420">return</span>&nbsp;<span class="builtintype" id="4216427">nil</span><span class="op" id="4216430">,</span>&nbsp;<span class="builtintype" id="4216432">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216440">if</span>&nbsp;<span class="op" id="4216443">!</span><span class="ident" id="4216444">chunked</span><span class="op" id="4216451">(</span><span class="ident" id="4216452">te</span><span class="op" id="4216454">)</span>&nbsp;<span class="op" id="4216456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216460">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216489">return</span>&nbsp;<span class="builtintype" id="4216496">nil</span><span class="op" id="4216499">,</span>&nbsp;<span class="ident" id="4216501">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216526">return</span>&nbsp;<span class="ident" id="4216533">trailer</span><span class="op" id="4216540">,</span>&nbsp;<span class="builtintype" id="4216542">nil</span><br>
<span class="lineno"></span><span class="op" id="4216546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4216549">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="4216591">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="4216642">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4216686">type</span>&nbsp;<span class="ident" id="4216691">body</span>&nbsp;<span class="keyword" id="4216696">struct</span>&nbsp;<span class="op" id="4216703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216706">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216714">io</span><span class="op" id="4216716">.</span><span class="ident" id="4216717">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216725">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216733">interface</span><span class="op" id="4216742">{</span><span class="op" id="4216743">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4216747">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216806">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216814">*</span><span class="ident" id="4216815">bufio</span><span class="op" id="4216820">.</span><span class="ident" id="4216821">Reader</span>&nbsp;<span class="comment" id="4216828">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216878">closing</span>&nbsp;<span class="builtintype" id="4216886">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216900">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216956">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216963">sync</span><span class="op" id="4216967">.</span><span class="ident" id="4216968">Mutex</span>&nbsp;<span class="comment" id="4216974">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217021">closed</span>&nbsp;<span class="builtintype" id="4217028">bool</span><br>
<span class="lineno">565</span><span class="op" id="4217033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4217036">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="4217108">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4217188">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="4217252">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4217271">var</span>&nbsp;<span class="ident" id="4217275">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="4217297">=</span>&nbsp;<span class="ident" id="4217299">errors</span><span class="op" id="4217305">.</span><span class="ident" id="4217306">New</span><span class="op" id="4217309">(</span><span class="string" id="4217310">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="4217345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4217348">func</span>&nbsp;<span class="op" id="4217353">(</span><span class="ident" id="4217354">b</span>&nbsp;<span class="op" id="4217356">*</span><span class="ident" id="4217357">body</span><span class="op" id="4217361">)</span>&nbsp;<span class="ident" id="4217363">Read</span><span class="op" id="4217367">(</span><span class="ident" id="4217368">p</span>&nbsp;<span class="op" id="4217370">[</span><span class="op" id="4217371">]</span><span class="builtintype" id="4217372">byte</span><span class="op" id="4217376">)</span>&nbsp;<span class="op" id="4217378">(</span><span class="ident" id="4217379">n</span>&nbsp;<span class="builtintype" id="4217381">int</span><span class="op" id="4217384">,</span>&nbsp;<span class="ident" id="4217386">err</span>&nbsp;<span class="builtintype" id="4217390">error</span><span class="op" id="4217395">)</span>&nbsp;<span class="op" id="4217397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217400">b</span><span class="op" id="4217401">.</span><span class="ident" id="4217402">mu</span><span class="op" id="4217404">.</span><span class="ident" id="4217405">Lock</span><span class="op" id="4217409">(</span><span class="op" id="4217410">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217413">defer</span>&nbsp;<span class="ident" id="4217419">b</span><span class="op" id="4217420">.</span><span class="ident" id="4217421">mu</span><span class="op" id="4217423">.</span><span class="ident" id="4217424">Unlock</span><span class="op" id="4217430">(</span><span class="op" id="4217431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217434">if</span>&nbsp;<span class="ident" id="4217437">b</span><span class="op" id="4217438">.</span><span class="ident" id="4217439">closed</span>&nbsp;<span class="op" id="4217446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217450">return</span>&nbsp;<span class="num" id="4217457">0</span><span class="op" id="4217458">,</span>&nbsp;<span class="ident" id="4217460">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217486">return</span>&nbsp;<span class="ident" id="4217493">b</span><span class="op" id="4217494">.</span><span class="ident" id="4217495">readLocked</span><span class="op" id="4217505">(</span><span class="ident" id="4217506">p</span><span class="op" id="4217507">)</span><br>
<span class="lineno">580</span><span class="op" id="4217509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4217512">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="4217531">func</span>&nbsp;<span class="op" id="4217536">(</span><span class="ident" id="4217537">b</span>&nbsp;<span class="op" id="4217539">*</span><span class="ident" id="4217540">body</span><span class="op" id="4217544">)</span>&nbsp;<span class="ident" id="4217546">readLocked</span><span class="op" id="4217556">(</span><span class="ident" id="4217557">p</span>&nbsp;<span class="op" id="4217559">[</span><span class="op" id="4217560">]</span><span class="builtintype" id="4217561">byte</span><span class="op" id="4217565">)</span>&nbsp;<span class="op" id="4217567">(</span><span class="ident" id="4217568">n</span>&nbsp;<span class="builtintype" id="4217570">int</span><span class="op" id="4217573">,</span>&nbsp;<span class="ident" id="4217575">err</span>&nbsp;<span class="builtintype" id="4217579">error</span><span class="op" id="4217584">)</span>&nbsp;<span class="op" id="4217586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217589">n</span><span class="op" id="4217590">,</span>&nbsp;<span class="ident" id="4217592">err</span>&nbsp;<span class="op" id="4217596">=</span>&nbsp;<span class="ident" id="4217598">b</span><span class="op" id="4217599">.</span><span class="ident" id="4217600">src</span><span class="op" id="4217603">.</span><span class="ident" id="4217604">Read</span><span class="op" id="4217608">(</span><span class="ident" id="4217609">p</span><span class="op" id="4217610">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217614">if</span>&nbsp;<span class="ident" id="4217617">err</span>&nbsp;<span class="op" id="4217621">==</span>&nbsp;<span class="ident" id="4217624">io</span><span class="op" id="4217626">.</span><span class="ident" id="4217627">EOF</span>&nbsp;<span class="op" id="4217631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217635">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217672">if</span>&nbsp;<span class="ident" id="4217675">b</span><span class="op" id="4217676">.</span><span class="ident" id="4217677">hdr</span>&nbsp;<span class="op" id="4217681">!=</span>&nbsp;<span class="builtintype" id="4217684">nil</span>&nbsp;<span class="op" id="4217688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217693">if</span>&nbsp;<span class="ident" id="4217696">e</span>&nbsp;<span class="op" id="4217698">:=</span>&nbsp;<span class="ident" id="4217701">b</span><span class="op" id="4217702">.</span><span class="ident" id="4217703">readTrailer</span><span class="op" id="4217714">(</span><span class="op" id="4217715">)</span><span class="op" id="4217716">;</span>&nbsp;<span class="ident" id="4217718">e</span>&nbsp;<span class="op" id="4217720">!=</span>&nbsp;<span class="builtintype" id="4217723">nil</span>&nbsp;<span class="op" id="4217727">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217733">err</span>&nbsp;<span class="op" id="4217737">=</span>&nbsp;<span class="ident" id="4217739">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217749">b</span><span class="op" id="4217750">.</span><span class="ident" id="4217751">hdr</span>&nbsp;<span class="op" id="4217755">=</span>&nbsp;<span class="builtintype" id="4217757">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217763">}</span>&nbsp;<span class="keyword" id="4217765">else</span>&nbsp;<span class="op" id="4217770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217775">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217852">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217911">if</span>&nbsp;<span class="ident" id="4217914">lr</span><span class="op" id="4217916">,</span>&nbsp;<span class="ident" id="4217918">ok</span>&nbsp;<span class="op" id="4217921">:=</span>&nbsp;<span class="ident" id="4217924">b</span><span class="op" id="4217925">.</span><span class="ident" id="4217926">src</span><span class="op" id="4217929">.</span><span class="op" id="4217930">(</span><span class="op" id="4217931">*</span><span class="ident" id="4217932">io</span><span class="op" id="4217934">.</span><span class="ident" id="4217935">LimitedReader</span><span class="op" id="4217948">)</span><span class="op" id="4217949">;</span>&nbsp;<span class="ident" id="4217951">ok</span>&nbsp;<span class="op" id="4217954">&amp;&amp;</span>&nbsp;<span class="ident" id="4217957">lr</span><span class="op" id="4217959">.</span><span class="ident" id="4217960">N</span>&nbsp;<span class="op" id="4217962">&gt;</span>&nbsp;<span class="num" id="4217964">0</span>&nbsp;<span class="op" id="4217966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217972">err</span>&nbsp;<span class="op" id="4217976">=</span>&nbsp;<span class="ident" id="4217978">io</span><span class="op" id="4217980">.</span><span class="ident" id="4217981">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218005">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218012">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218074">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218137">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218197">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218258">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218303">if</span>&nbsp;<span class="ident" id="4218306">err</span>&nbsp;<span class="op" id="4218310">==</span>&nbsp;<span class="builtintype" id="4218313">nil</span>&nbsp;<span class="op" id="4218317">&amp;&amp;</span>&nbsp;<span class="ident" id="4218320">n</span>&nbsp;<span class="op" id="4218322">&gt;</span>&nbsp;<span class="num" id="4218324">0</span>&nbsp;<span class="op" id="4218326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218330">if</span>&nbsp;<span class="ident" id="4218333">lr</span><span class="op" id="4218335">,</span>&nbsp;<span class="ident" id="4218337">ok</span>&nbsp;<span class="op" id="4218340">:=</span>&nbsp;<span class="ident" id="4218343">b</span><span class="op" id="4218344">.</span><span class="ident" id="4218345">src</span><span class="op" id="4218348">.</span><span class="op" id="4218349">(</span><span class="op" id="4218350">*</span><span class="ident" id="4218351">io</span><span class="op" id="4218353">.</span><span class="ident" id="4218354">LimitedReader</span><span class="op" id="4218367">)</span><span class="op" id="4218368">;</span>&nbsp;<span class="ident" id="4218370">ok</span>&nbsp;<span class="op" id="4218373">&amp;&amp;</span>&nbsp;<span class="ident" id="4218376">lr</span><span class="op" id="4218378">.</span><span class="ident" id="4218379">N</span>&nbsp;<span class="op" id="4218381">==</span>&nbsp;<span class="num" id="4218384">0</span>&nbsp;<span class="op" id="4218386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218391">err</span>&nbsp;<span class="op" id="4218395">=</span>&nbsp;<span class="ident" id="4218397">io</span><span class="op" id="4218399">.</span><span class="ident" id="4218400">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218413">return</span>&nbsp;<span class="ident" id="4218420">n</span><span class="op" id="4218421">,</span>&nbsp;<span class="ident" id="4218423">err</span><br>
<span class="lineno"></span><span class="op" id="4218427">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="4218430">var</span>&nbsp;<span class="op" id="4218434">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218437">singleCRLF</span>&nbsp;<span class="op" id="4218448">=</span>&nbsp;<span class="op" id="4218450">[</span><span class="op" id="4218451">]</span><span class="builtintype" id="4218452">byte</span><span class="op" id="4218456">(</span><span class="string" id="4218457">&#34;\r\n&#34;</span><span class="op" id="4218463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218466">doubleCRLF</span>&nbsp;<span class="op" id="4218477">=</span>&nbsp;<span class="op" id="4218479">[</span><span class="op" id="4218480">]</span><span class="builtintype" id="4218481">byte</span><span class="op" id="4218485">(</span><span class="string" id="4218486">&#34;\r\n\r\n&#34;</span><span class="op" id="4218496">)</span><br>
<span class="lineno"></span><span class="op" id="4218498">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="4218501">func</span>&nbsp;<span class="ident" id="4218506">seeUpcomingDoubleCRLF</span><span class="op" id="4218527">(</span><span class="ident" id="4218528">r</span>&nbsp;<span class="op" id="4218530">*</span><span class="ident" id="4218531">bufio</span><span class="op" id="4218536">.</span><span class="ident" id="4218537">Reader</span><span class="op" id="4218543">)</span>&nbsp;<span class="builtintype" id="4218545">bool</span>&nbsp;<span class="op" id="4218550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218553">for</span>&nbsp;<span class="ident" id="4218557">peekSize</span>&nbsp;<span class="op" id="4218566">:=</span>&nbsp;<span class="num" id="4218569">4</span><span class="op" id="4218570">;</span>&nbsp;<span class="op" id="4218572">;</span>&nbsp;<span class="ident" id="4218574">peekSize</span><span class="op" id="4218582">++</span>&nbsp;<span class="op" id="4218585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218589">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218638">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218690">buf</span><span class="op" id="4218693">,</span>&nbsp;<span class="ident" id="4218695">err</span>&nbsp;<span class="op" id="4218699">:=</span>&nbsp;<span class="ident" id="4218702">r</span><span class="op" id="4218703">.</span><span class="ident" id="4218704">Peek</span><span class="op" id="4218708">(</span><span class="ident" id="4218709">peekSize</span><span class="op" id="4218717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218721">if</span>&nbsp;<span class="ident" id="4218724">bytes</span><span class="op" id="4218729">.</span><span class="ident" id="4218730">HasSuffix</span><span class="op" id="4218739">(</span><span class="ident" id="4218740">buf</span><span class="op" id="4218743">,</span>&nbsp;<span class="ident" id="4218745">doubleCRLF</span><span class="op" id="4218755">)</span>&nbsp;<span class="op" id="4218757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218762">return</span>&nbsp;<span class="builtintype" id="4218769">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218780">if</span>&nbsp;<span class="ident" id="4218783">err</span>&nbsp;<span class="op" id="4218787">!=</span>&nbsp;<span class="builtintype" id="4218790">nil</span>&nbsp;<span class="op" id="4218794">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218799">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218813">return</span>&nbsp;<span class="builtintype" id="4218820">false</span><br>
<span class="lineno"></span><span class="op" id="4218826">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="4218829">var</span>&nbsp;<span class="ident" id="4218833">errTrailerEOF</span>&nbsp;<span class="op" id="4218847">=</span>&nbsp;<span class="ident" id="4218849">errors</span><span class="op" id="4218855">.</span><span class="ident" id="4218856">New</span><span class="op" id="4218859">(</span><span class="string" id="4218860">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="4218898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218901">func</span>&nbsp;<span class="op" id="4218906">(</span><span class="ident" id="4218907">b</span>&nbsp;<span class="op" id="4218909">*</span><span class="ident" id="4218910">body</span><span class="op" id="4218914">)</span>&nbsp;<span class="ident" id="4218916">readTrailer</span><span class="op" id="4218927">(</span><span class="op" id="4218928">)</span>&nbsp;<span class="builtintype" id="4218930">error</span>&nbsp;<span class="op" id="4218936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218939">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218988">buf</span><span class="op" id="4218991">,</span>&nbsp;<span class="ident" id="4218993">err</span>&nbsp;<span class="op" id="4218997">:=</span>&nbsp;<span class="ident" id="4219000">b</span><span class="op" id="4219001">.</span><span class="ident" id="4219002">r</span><span class="op" id="4219003">.</span><span class="ident" id="4219004">Peek</span><span class="op" id="4219008">(</span><span class="num" id="4219009">2</span><span class="op" id="4219010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219013">if</span>&nbsp;<span class="ident" id="4219016">bytes</span><span class="op" id="4219021">.</span><span class="ident" id="4219022">Equal</span><span class="op" id="4219027">(</span><span class="ident" id="4219028">buf</span><span class="op" id="4219031">,</span>&nbsp;<span class="ident" id="4219033">singleCRLF</span><span class="op" id="4219043">)</span>&nbsp;<span class="op" id="4219045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219049">b</span><span class="op" id="4219050">.</span><span class="ident" id="4219051">r</span><span class="op" id="4219052">.</span><span class="ident" id="4219053">ReadByte</span><span class="op" id="4219061">(</span><span class="op" id="4219062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219066">b</span><span class="op" id="4219067">.</span><span class="ident" id="4219068">r</span><span class="op" id="4219069">.</span><span class="ident" id="4219070">ReadByte</span><span class="op" id="4219078">(</span><span class="op" id="4219079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219083">return</span>&nbsp;<span class="builtintype" id="4219090">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219098">if</span>&nbsp;<span class="builtinfunc" id="4219101">len</span><span class="op" id="4219104">(</span><span class="ident" id="4219105">buf</span><span class="op" id="4219108">)</span>&nbsp;<span class="op" id="4219110">&lt;</span>&nbsp;<span class="num" id="4219112">2</span>&nbsp;<span class="op" id="4219114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219118">return</span>&nbsp;<span class="ident" id="4219125">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219143">if</span>&nbsp;<span class="ident" id="4219146">err</span>&nbsp;<span class="op" id="4219150">!=</span>&nbsp;<span class="builtintype" id="4219153">nil</span>&nbsp;<span class="op" id="4219157">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219161">return</span>&nbsp;<span class="ident" id="4219168">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219177">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219241">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219301">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219365">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219427">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219491">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219555">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219618">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219692">if</span>&nbsp;<span class="op" id="4219695">!</span><span class="ident" id="4219696">seeUpcomingDoubleCRLF</span><span class="op" id="4219717">(</span><span class="ident" id="4219718">b</span><span class="op" id="4219719">.</span><span class="ident" id="4219720">r</span><span class="op" id="4219721">)</span>&nbsp;<span class="op" id="4219723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219727">return</span>&nbsp;<span class="ident" id="4219734">errors</span><span class="op" id="4219740">.</span><span class="ident" id="4219741">New</span><span class="op" id="4219744">(</span><span class="string" id="4219745">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="4219797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219804">hdr</span><span class="op" id="4219807">,</span>&nbsp;<span class="ident" id="4219809">err</span>&nbsp;<span class="op" id="4219813">:=</span>&nbsp;<span class="ident" id="4219816">textproto</span><span class="op" id="4219825">.</span><span class="ident" id="4219826">NewReader</span><span class="op" id="4219835">(</span><span class="ident" id="4219836">b</span><span class="op" id="4219837">.</span><span class="ident" id="4219838">r</span><span class="op" id="4219839">)</span><span class="op" id="4219840">.</span><span class="ident" id="4219841">ReadMIMEHeader</span><span class="op" id="4219855">(</span><span class="op" id="4219856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219859">if</span>&nbsp;<span class="ident" id="4219862">err</span>&nbsp;<span class="op" id="4219866">!=</span>&nbsp;<span class="builtintype" id="4219869">nil</span>&nbsp;<span class="op" id="4219873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219877">if</span>&nbsp;<span class="ident" id="4219880">err</span>&nbsp;<span class="op" id="4219884">==</span>&nbsp;<span class="ident" id="4219887">io</span><span class="op" id="4219889">.</span><span class="ident" id="4219890">EOF</span>&nbsp;<span class="op" id="4219894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219899">return</span>&nbsp;<span class="ident" id="4219906">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219922">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219926">return</span>&nbsp;<span class="ident" id="4219933">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219941">switch</span>&nbsp;<span class="ident" id="4219948">rr</span>&nbsp;<span class="op" id="4219951">:=</span>&nbsp;<span class="ident" id="4219954">b</span><span class="op" id="4219955">.</span><span class="ident" id="4219956">hdr</span><span class="op" id="4219959">.</span><span class="op" id="4219960">(</span><span class="keyword" id="4219961">type</span><span class="op" id="4219965">)</span>&nbsp;<span class="op" id="4219967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219970">case</span>&nbsp;<span class="op" id="4219975">*</span><span class="ident" id="4219976">Request</span><span class="op" id="4219983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219987">mergeSetHeader</span><span class="op" id="4220001">(</span><span class="op" id="4220002">&amp;</span><span class="ident" id="4220003">rr</span><span class="op" id="4220005">.</span><span class="ident" id="4220006">Trailer</span><span class="op" id="4220013">,</span>&nbsp;<span class="ident" id="4220015">Header</span><span class="op" id="4220021">(</span><span class="ident" id="4220022">hdr</span><span class="op" id="4220025">)</span><span class="op" id="4220026">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220029">case</span>&nbsp;<span class="op" id="4220034">*</span><span class="ident" id="4220035">Response</span><span class="op" id="4220043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220047">mergeSetHeader</span><span class="op" id="4220061">(</span><span class="op" id="4220062">&amp;</span><span class="ident" id="4220063">rr</span><span class="op" id="4220065">.</span><span class="ident" id="4220066">Trailer</span><span class="op" id="4220073">,</span>&nbsp;<span class="ident" id="4220075">Header</span><span class="op" id="4220081">(</span><span class="ident" id="4220082">hdr</span><span class="op" id="4220085">)</span><span class="op" id="4220086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220092">return</span>&nbsp;<span class="builtintype" id="4220099">nil</span><br>
<span class="lineno"></span><span class="op" id="4220103">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4220106">func</span>&nbsp;<span class="ident" id="4220111">mergeSetHeader</span><span class="op" id="4220125">(</span><span class="ident" id="4220126">dst</span>&nbsp;<span class="op" id="4220130">*</span><span class="ident" id="4220131">Header</span><span class="op" id="4220137">,</span>&nbsp;<span class="ident" id="4220139">src</span>&nbsp;<span class="ident" id="4220143">Header</span><span class="op" id="4220149">)</span>&nbsp;<span class="op" id="4220151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220154">if</span>&nbsp;<span class="op" id="4220157">*</span><span class="ident" id="4220158">dst</span>&nbsp;<span class="op" id="4220162">==</span>&nbsp;<span class="builtintype" id="4220165">nil</span>&nbsp;<span class="op" id="4220169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220173">*</span><span class="ident" id="4220174">dst</span>&nbsp;<span class="op" id="4220178">=</span>&nbsp;<span class="ident" id="4220180">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220186">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220197">for</span>&nbsp;<span class="ident" id="4220201">k</span><span class="op" id="4220202">,</span>&nbsp;<span class="ident" id="4220204">vv</span>&nbsp;<span class="op" id="4220207">:=</span>&nbsp;<span class="keyword" id="4220210">range</span>&nbsp;<span class="ident" id="4220216">src</span>&nbsp;<span class="op" id="4220220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220224">(</span><span class="op" id="4220225">*</span><span class="ident" id="4220226">dst</span><span class="op" id="4220229">)</span><span class="op" id="4220230">[</span><span class="ident" id="4220231">k</span><span class="op" id="4220232">]</span>&nbsp;<span class="op" id="4220234">=</span>&nbsp;<span class="ident" id="4220236">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220240">}</span><br>
<span class="lineno"></span><span class="op" id="4220242">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="4220245">func</span>&nbsp;<span class="op" id="4220250">(</span><span class="ident" id="4220251">b</span>&nbsp;<span class="op" id="4220253">*</span><span class="ident" id="4220254">body</span><span class="op" id="4220258">)</span>&nbsp;<span class="ident" id="4220260">Close</span><span class="op" id="4220265">(</span><span class="op" id="4220266">)</span>&nbsp;<span class="builtintype" id="4220268">error</span>&nbsp;<span class="op" id="4220274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220277">b</span><span class="op" id="4220278">.</span><span class="ident" id="4220279">mu</span><span class="op" id="4220281">.</span><span class="ident" id="4220282">Lock</span><span class="op" id="4220286">(</span><span class="op" id="4220287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220290">defer</span>&nbsp;<span class="ident" id="4220296">b</span><span class="op" id="4220297">.</span><span class="ident" id="4220298">mu</span><span class="op" id="4220300">.</span><span class="ident" id="4220301">Unlock</span><span class="op" id="4220307">(</span><span class="op" id="4220308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220311">if</span>&nbsp;<span class="ident" id="4220314">b</span><span class="op" id="4220315">.</span><span class="ident" id="4220316">closed</span>&nbsp;<span class="op" id="4220323">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220327">return</span>&nbsp;<span class="builtintype" id="4220334">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220342">var</span>&nbsp;<span class="ident" id="4220346">err</span>&nbsp;<span class="builtintype" id="4220350">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220357">switch</span>&nbsp;<span class="op" id="4220364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220367">case</span>&nbsp;<span class="ident" id="4220372">b</span><span class="op" id="4220373">.</span><span class="ident" id="4220374">hdr</span>&nbsp;<span class="op" id="4220378">==</span>&nbsp;<span class="builtintype" id="4220381">nil</span>&nbsp;<span class="op" id="4220385">&amp;&amp;</span>&nbsp;<span class="ident" id="4220388">b</span><span class="op" id="4220389">.</span><span class="ident" id="4220390">closing</span><span class="op" id="4220397">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4220401">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4220450">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220482">default</span><span class="op" id="4220489">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4220493">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4220557">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220610">_</span><span class="op" id="4220611">,</span>&nbsp;<span class="ident" id="4220613">err</span>&nbsp;<span class="op" id="4220617">=</span>&nbsp;<span class="ident" id="4220619">io</span><span class="op" id="4220621">.</span><span class="ident" id="4220622">Copy</span><span class="op" id="4220626">(</span><span class="ident" id="4220627">ioutil</span><span class="op" id="4220633">.</span><span class="ident" id="4220634">Discard</span><span class="op" id="4220641">,</span>&nbsp;<span class="ident" id="4220643">bodyLocked</span><span class="op" id="4220653">{</span><span class="ident" id="4220654">b</span><span class="op" id="4220655">}</span><span class="op" id="4220656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220662">b</span><span class="op" id="4220663">.</span><span class="ident" id="4220664">closed</span>&nbsp;<span class="op" id="4220671">=</span>&nbsp;<span class="builtintype" id="4220673">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220679">return</span>&nbsp;<span class="ident" id="4220686">err</span><br>
<span class="lineno"></span><span class="op" id="4220690">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="4220693">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4220761">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="4220778">type</span>&nbsp;<span class="ident" id="4220783">bodyLocked</span>&nbsp;<span class="keyword" id="4220794">struct</span>&nbsp;<span class="op" id="4220801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220804">b</span>&nbsp;<span class="op" id="4220806">*</span><span class="ident" id="4220807">body</span><br>
<span class="lineno">715</span><span class="op" id="4220812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4220815">func</span>&nbsp;<span class="op" id="4220820">(</span><span class="ident" id="4220821">bl</span>&nbsp;<span class="ident" id="4220824">bodyLocked</span><span class="op" id="4220834">)</span>&nbsp;<span class="ident" id="4220836">Read</span><span class="op" id="4220840">(</span><span class="ident" id="4220841">p</span>&nbsp;<span class="op" id="4220843">[</span><span class="op" id="4220844">]</span><span class="builtintype" id="4220845">byte</span><span class="op" id="4220849">)</span>&nbsp;<span class="op" id="4220851">(</span><span class="ident" id="4220852">n</span>&nbsp;<span class="builtintype" id="4220854">int</span><span class="op" id="4220857">,</span>&nbsp;<span class="ident" id="4220859">err</span>&nbsp;<span class="builtintype" id="4220863">error</span><span class="op" id="4220868">)</span>&nbsp;<span class="op" id="4220870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220873">if</span>&nbsp;<span class="ident" id="4220876">bl</span><span class="op" id="4220878">.</span><span class="ident" id="4220879">b</span><span class="op" id="4220880">.</span><span class="ident" id="4220881">closed</span>&nbsp;<span class="op" id="4220888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220892">return</span>&nbsp;<span class="num" id="4220899">0</span><span class="op" id="4220900">,</span>&nbsp;<span class="ident" id="4220902">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220928">return</span>&nbsp;<span class="ident" id="4220935">bl</span><span class="op" id="4220937">.</span><span class="ident" id="4220938">b</span><span class="op" id="4220939">.</span><span class="ident" id="4220940">readLocked</span><span class="op" id="4220950">(</span><span class="ident" id="4220951">p</span><span class="op" id="4220952">)</span><br>
<span class="lineno"></span><span class="op" id="4220954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4220957">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="4221030">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4221068">func</span>&nbsp;<span class="ident" id="4221073">parseContentLength</span><span class="op" id="4221091">(</span><span class="ident" id="4221092">cl</span>&nbsp;<span class="builtintype" id="4221095">string</span><span class="op" id="4221101">)</span>&nbsp;<span class="op" id="4221103">(</span><span class="ident" id="4221104">int64</span><span class="op" id="4221109">,</span>&nbsp;<span class="builtintype" id="4221111">error</span><span class="op" id="4221116">)</span>&nbsp;<span class="op" id="4221118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221121">cl</span>&nbsp;<span class="op" id="4221124">=</span>&nbsp;<span class="ident" id="4221126">strings</span><span class="op" id="4221133">.</span><span class="ident" id="4221134">TrimSpace</span><span class="op" id="4221143">(</span><span class="ident" id="4221144">cl</span><span class="op" id="4221146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221149">if</span>&nbsp;<span class="ident" id="4221152">cl</span>&nbsp;<span class="op" id="4221155">==</span>&nbsp;<span class="string" id="4221158">&#34;&#34;</span>&nbsp;<span class="op" id="4221161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221165">return</span>&nbsp;<span class="op" id="4221172">-</span><span class="num" id="4221173">1</span><span class="op" id="4221174">,</span>&nbsp;<span class="builtintype" id="4221176">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221184">n</span><span class="op" id="4221185">,</span>&nbsp;<span class="ident" id="4221187">err</span>&nbsp;<span class="op" id="4221191">:=</span>&nbsp;<span class="ident" id="4221194">strconv</span><span class="op" id="4221201">.</span><span class="ident" id="4221202">ParseInt</span><span class="op" id="4221210">(</span><span class="ident" id="4221211">cl</span><span class="op" id="4221213">,</span>&nbsp;<span class="num" id="4221215">10</span><span class="op" id="4221217">,</span>&nbsp;<span class="num" id="4221219">64</span><span class="op" id="4221221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221224">if</span>&nbsp;<span class="ident" id="4221227">err</span>&nbsp;<span class="op" id="4221231">!=</span>&nbsp;<span class="builtintype" id="4221234">nil</span>&nbsp;<span class="op" id="4221238">||</span>&nbsp;<span class="ident" id="4221241">n</span>&nbsp;<span class="op" id="4221243">&lt;</span>&nbsp;<span class="num" id="4221245">0</span>&nbsp;<span class="op" id="4221247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221251">return</span>&nbsp;<span class="num" id="4221258">0</span><span class="op" id="4221259">,</span>&nbsp;<span class="op" id="4221261">&amp;</span><span class="ident" id="4221262">badStringError</span><span class="op" id="4221276">{</span><span class="string" id="4221277">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="4221297">,</span>&nbsp;<span class="ident" id="4221299">cl</span><span class="op" id="4221301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221304">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221307">return</span>&nbsp;<span class="ident" id="4221314">n</span><span class="op" id="4221315">,</span>&nbsp;<span class="builtintype" id="4221317">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4221322">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
