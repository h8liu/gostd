<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5348696">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5348752">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5348806">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5348857">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5348936">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="5349009">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5349074">//</span><br>
<span class="lineno"></span><span class="comment" id="5349077">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="5349135">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="5349186">package</span>&nbsp;<span class="ident" id="5349194">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5349200">import</span>&nbsp;<span class="op" id="5349207">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349210">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349219">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349231">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349250">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349258">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349269">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349280">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349288">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349299">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349310">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349318">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5349329">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5349344">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5349347">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5349390">//</span><br>
<span class="lineno">30</span><span class="comment" id="5349393">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="5349439">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="5349501">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="5349567">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="5349640">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="5349704">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="5349722">//</span><br>
<span class="lineno"></span><span class="comment" id="5349725">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="5349800">//</span><br>
<span class="lineno"></span><span class="comment" id="5349803">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="5349846">//</span><br>
<span class="lineno"></span><span class="comment" id="5349849">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="5349919">//</span><br>
<span class="lineno"></span><span class="comment" id="5349922">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="5349986">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="5350048">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5350119">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="5350186">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="5350252">//</span><br>
<span class="lineno"></span><span class="comment" id="5350255">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="5350316">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="5350378">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5350414">//</span><br>
<span class="lineno"></span><span class="comment" id="5350417">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5350485">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="5350526">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5350560">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="5350632">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5350670">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5350745">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="5350818">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5350893">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="5350972">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="5350998">//</span><br>
<span class="lineno"></span><span class="comment" id="5351001">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="5351043">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5351069">//</span><br>
<span class="lineno"></span><span class="comment" id="5351072">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5351119">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5351150">//</span><br>
<span class="lineno">70</span><span class="comment" id="5351153">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5351203">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="5351271">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="5351297">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5351338">//</span><br>
<span class="lineno">75</span><span class="comment" id="5351341">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="5351405">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="5351444">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="5351476">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5351511">//</span><br>
<span class="lineno">80</span><span class="comment" id="5351514">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5351585">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="5351662">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5351735">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="5351778">//</span><br>
<span class="lineno">85</span><span class="comment" id="5351781">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5351822">//</span><br>
<span class="lineno"></span><span class="comment" id="5351825">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5351895">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="5351966">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="5351994">//</span><br>
<span class="lineno"></span><span class="comment" id="5351997">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="5352080">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="5352165">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="5352204">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="5352281">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="5352331">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="5352408">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="5352463">//</span><br>
<span class="lineno"></span><span class="comment" id="5352466">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="5352537">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5352599">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="5352665">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5352733">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="5352786">//</span><br>
<span class="lineno">105</span><span class="comment" id="5352789">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="5352871">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="5352948">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="5353047">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="5353128">//</span><br>
<span class="lineno">110</span><span class="comment" id="5353131">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="5353188">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5353267">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5353349">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5353371">//</span><br>
<span class="lineno">115</span><span class="comment" id="5353374">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="5353412">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5353484">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="5353500">//</span><br>
<span class="lineno"></span><span class="comment" id="5353503">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="5353553">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5353603">//</span><br>
<span class="lineno"></span><span class="comment" id="5353606">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="5353674">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5353732">//</span><br>
<span class="lineno">125</span><span class="comment" id="5353735">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="5353803">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="5353865">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="5353893">//</span><br>
<span class="lineno"></span><span class="comment" id="5353896">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="5353965">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5354034">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="5354060">//</span><br>
<span class="lineno"></span><span class="keyword" id="5354063">func</span>&nbsp;<span class="ident" id="5354068">Marshal</span><span class="op" id="5354075">(</span><span class="ident" id="5354076">v</span>&nbsp;<span class="keyword" id="5354078">interface</span><span class="op" id="5354087">{</span><span class="op" id="5354088">}</span><span class="op" id="5354089">)</span>&nbsp;<span class="op" id="5354091">(</span><span class="op" id="5354092">[</span><span class="op" id="5354093">]</span><span class="builtintype" id="5354094">byte</span><span class="op" id="5354098">,</span>&nbsp;<span class="builtintype" id="5354100">error</span><span class="op" id="5354105">)</span>&nbsp;<span class="op" id="5354107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354110">e</span>&nbsp;<span class="op" id="5354112">:=</span>&nbsp;<span class="op" id="5354115">&amp;</span><span class="ident" id="5354116">encodeState</span><span class="op" id="5354127">{</span><span class="op" id="5354128">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354131">err</span>&nbsp;<span class="op" id="5354135">:=</span>&nbsp;<span class="ident" id="5354138">e</span><span class="op" id="5354139">.</span><span class="ident" id="5354140">marshal</span><span class="op" id="5354147">(</span><span class="ident" id="5354148">v</span><span class="op" id="5354149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354152">if</span>&nbsp;<span class="ident" id="5354155">err</span>&nbsp;<span class="op" id="5354159">!=</span>&nbsp;<span class="ident" id="5354162">nil</span>&nbsp;<span class="op" id="5354166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354170">return</span>&nbsp;<span class="ident" id="5354177">nil</span><span class="op" id="5354180">,</span>&nbsp;<span class="ident" id="5354182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354190">return</span>&nbsp;<span class="ident" id="5354197">e</span><span class="op" id="5354198">.</span><span class="ident" id="5354199">Bytes</span><span class="op" id="5354204">(</span><span class="op" id="5354205">)</span><span class="op" id="5354206">,</span>&nbsp;<span class="ident" id="5354208">nil</span><br>
<span class="lineno">140</span><span class="op" id="5354212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5354215">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="5354289">func</span>&nbsp;<span class="ident" id="5354294">MarshalIndent</span><span class="op" id="5354307">(</span><span class="ident" id="5354308">v</span>&nbsp;<span class="keyword" id="5354310">interface</span><span class="op" id="5354319">{</span><span class="op" id="5354320">}</span><span class="op" id="5354321">,</span>&nbsp;<span class="ident" id="5354323">prefix</span><span class="op" id="5354329">,</span>&nbsp;<span class="ident" id="5354331">indent</span>&nbsp;<span class="builtintype" id="5354338">string</span><span class="op" id="5354344">)</span>&nbsp;<span class="op" id="5354346">(</span><span class="op" id="5354347">[</span><span class="op" id="5354348">]</span><span class="builtintype" id="5354349">byte</span><span class="op" id="5354353">,</span>&nbsp;<span class="builtintype" id="5354355">error</span><span class="op" id="5354360">)</span>&nbsp;<span class="op" id="5354362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354365">b</span><span class="op" id="5354366">,</span>&nbsp;<span class="ident" id="5354368">err</span>&nbsp;<span class="op" id="5354372">:=</span>&nbsp;<span class="ident" id="5354375">Marshal</span><span class="op" id="5354382">(</span><span class="ident" id="5354383">v</span><span class="op" id="5354384">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354387">if</span>&nbsp;<span class="ident" id="5354390">err</span>&nbsp;<span class="op" id="5354394">!=</span>&nbsp;<span class="ident" id="5354397">nil</span>&nbsp;<span class="op" id="5354401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354405">return</span>&nbsp;<span class="ident" id="5354412">nil</span><span class="op" id="5354415">,</span>&nbsp;<span class="ident" id="5354417">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354425">var</span>&nbsp;<span class="ident" id="5354429">buf</span>&nbsp;<span class="ident" id="5354433">bytes</span><span class="op" id="5354438">.</span><span class="ident" id="5354439">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354447">err</span>&nbsp;<span class="op" id="5354451">=</span>&nbsp;<span class="ident" id="5354453">Indent</span><span class="op" id="5354459">(</span><span class="op" id="5354460">&amp;</span><span class="ident" id="5354461">buf</span><span class="op" id="5354464">,</span>&nbsp;<span class="ident" id="5354466">b</span><span class="op" id="5354467">,</span>&nbsp;<span class="ident" id="5354469">prefix</span><span class="op" id="5354475">,</span>&nbsp;<span class="ident" id="5354477">indent</span><span class="op" id="5354483">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354486">if</span>&nbsp;<span class="ident" id="5354489">err</span>&nbsp;<span class="op" id="5354493">!=</span>&nbsp;<span class="ident" id="5354496">nil</span>&nbsp;<span class="op" id="5354500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354504">return</span>&nbsp;<span class="ident" id="5354511">nil</span><span class="op" id="5354514">,</span>&nbsp;<span class="ident" id="5354516">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354524">return</span>&nbsp;<span class="ident" id="5354531">buf</span><span class="op" id="5354534">.</span><span class="ident" id="5354535">Bytes</span><span class="op" id="5354540">(</span><span class="op" id="5354541">)</span><span class="op" id="5354542">,</span>&nbsp;<span class="ident" id="5354544">nil</span><br>
<span class="lineno"></span><span class="op" id="5354548">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5354551">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="5354633">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="5354720">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="5354789">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="5354855">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5354926">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5354938">func</span>&nbsp;<span class="ident" id="5354943">HTMLEscape</span><span class="op" id="5354953">(</span><span class="ident" id="5354954">dst</span>&nbsp;<span class="op" id="5354958">*</span><span class="ident" id="5354959">bytes</span><span class="op" id="5354964">.</span><span class="ident" id="5354965">Buffer</span><span class="op" id="5354971">,</span>&nbsp;<span class="ident" id="5354973">src</span>&nbsp;<span class="op" id="5354977">[</span><span class="op" id="5354978">]</span><span class="builtintype" id="5354979">byte</span><span class="op" id="5354983">)</span>&nbsp;<span class="op" id="5354985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5354988">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355043">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355091">start</span>&nbsp;<span class="op" id="5355097">:=</span>&nbsp;<span class="num" id="5355100">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355103">for</span>&nbsp;<span class="ident" id="5355107">i</span><span class="op" id="5355108">,</span>&nbsp;<span class="ident" id="5355110">c</span>&nbsp;<span class="op" id="5355112">:=</span>&nbsp;<span class="keyword" id="5355115">range</span>&nbsp;<span class="ident" id="5355121">src</span>&nbsp;<span class="op" id="5355125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355129">if</span>&nbsp;<span class="ident" id="5355132">c</span>&nbsp;<span class="op" id="5355134">==</span>&nbsp;<span class="string" id="5355137">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5355141">||</span>&nbsp;<span class="ident" id="5355144">c</span>&nbsp;<span class="op" id="5355146">==</span>&nbsp;<span class="string" id="5355149">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5355153">||</span>&nbsp;<span class="ident" id="5355156">c</span>&nbsp;<span class="op" id="5355158">==</span>&nbsp;<span class="string" id="5355161">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5355165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355170">if</span>&nbsp;<span class="ident" id="5355173">start</span>&nbsp;<span class="op" id="5355179">&lt;</span>&nbsp;<span class="ident" id="5355181">i</span>&nbsp;<span class="op" id="5355183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355189">dst</span><span class="op" id="5355192">.</span><span class="ident" id="5355193">Write</span><span class="op" id="5355198">(</span><span class="ident" id="5355199">src</span><span class="op" id="5355202">[</span><span class="ident" id="5355203">start</span><span class="op" id="5355208">:</span><span class="ident" id="5355209">i</span><span class="op" id="5355210">]</span><span class="op" id="5355211">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355221">dst</span><span class="op" id="5355224">.</span><span class="ident" id="5355225">WriteString</span><span class="op" id="5355236">(</span><span class="string" id="5355237">`\u00`</span><span class="op" id="5355243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355248">dst</span><span class="op" id="5355251">.</span><span class="ident" id="5355252">WriteByte</span><span class="op" id="5355261">(</span><span class="ident" id="5355262">hex</span><span class="op" id="5355265">[</span><span class="ident" id="5355266">c</span><span class="op" id="5355267">&gt;&gt;</span><span class="num" id="5355269">4</span><span class="op" id="5355270">]</span><span class="op" id="5355271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355276">dst</span><span class="op" id="5355279">.</span><span class="ident" id="5355280">WriteByte</span><span class="op" id="5355289">(</span><span class="ident" id="5355290">hex</span><span class="op" id="5355293">[</span><span class="ident" id="5355294">c</span><span class="op" id="5355295">&amp;</span><span class="num" id="5355296">0xF</span><span class="op" id="5355299">]</span><span class="op" id="5355300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355305">start</span>&nbsp;<span class="op" id="5355311">=</span>&nbsp;<span class="ident" id="5355313">i</span>&nbsp;<span class="op" id="5355315">+</span>&nbsp;<span class="num" id="5355317">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355325">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355381">if</span>&nbsp;<span class="ident" id="5355384">c</span>&nbsp;<span class="op" id="5355386">==</span>&nbsp;<span class="num" id="5355389">0xE2</span>&nbsp;<span class="op" id="5355394">&amp;&amp;</span>&nbsp;<span class="ident" id="5355397">i</span><span class="op" id="5355398">+</span><span class="num" id="5355399">2</span>&nbsp;<span class="op" id="5355401">&lt;</span>&nbsp;<span class="builtinfunc" id="5355403">len</span><span class="op" id="5355406">(</span><span class="ident" id="5355407">src</span><span class="op" id="5355410">)</span>&nbsp;<span class="op" id="5355412">&amp;&amp;</span>&nbsp;<span class="ident" id="5355415">src</span><span class="op" id="5355418">[</span><span class="ident" id="5355419">i</span><span class="op" id="5355420">+</span><span class="num" id="5355421">1</span><span class="op" id="5355422">]</span>&nbsp;<span class="op" id="5355424">==</span>&nbsp;<span class="num" id="5355427">0x80</span>&nbsp;<span class="op" id="5355432">&amp;&amp;</span>&nbsp;<span class="ident" id="5355435">src</span><span class="op" id="5355438">[</span><span class="ident" id="5355439">i</span><span class="op" id="5355440">+</span><span class="num" id="5355441">2</span><span class="op" id="5355442">]</span><span class="op" id="5355443">&amp;^</span><span class="num" id="5355445">1</span>&nbsp;<span class="op" id="5355447">==</span>&nbsp;<span class="num" id="5355450">0xA8</span>&nbsp;<span class="op" id="5355455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355460">if</span>&nbsp;<span class="ident" id="5355463">start</span>&nbsp;<span class="op" id="5355469">&lt;</span>&nbsp;<span class="ident" id="5355471">i</span>&nbsp;<span class="op" id="5355473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355479">dst</span><span class="op" id="5355482">.</span><span class="ident" id="5355483">Write</span><span class="op" id="5355488">(</span><span class="ident" id="5355489">src</span><span class="op" id="5355492">[</span><span class="ident" id="5355493">start</span><span class="op" id="5355498">:</span><span class="ident" id="5355499">i</span><span class="op" id="5355500">]</span><span class="op" id="5355501">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355511">dst</span><span class="op" id="5355514">.</span><span class="ident" id="5355515">WriteString</span><span class="op" id="5355526">(</span><span class="string" id="5355527">`\u202`</span><span class="op" id="5355534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355539">dst</span><span class="op" id="5355542">.</span><span class="ident" id="5355543">WriteByte</span><span class="op" id="5355552">(</span><span class="ident" id="5355553">hex</span><span class="op" id="5355556">[</span><span class="ident" id="5355557">src</span><span class="op" id="5355560">[</span><span class="ident" id="5355561">i</span><span class="op" id="5355562">+</span><span class="num" id="5355563">2</span><span class="op" id="5355564">]</span><span class="op" id="5355565">&amp;</span><span class="num" id="5355566">0xF</span><span class="op" id="5355569">]</span><span class="op" id="5355570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355575">start</span>&nbsp;<span class="op" id="5355581">=</span>&nbsp;<span class="ident" id="5355583">i</span>&nbsp;<span class="op" id="5355585">+</span>&nbsp;<span class="num" id="5355587">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355591">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5355597">if</span>&nbsp;<span class="ident" id="5355600">start</span>&nbsp;<span class="op" id="5355606">&lt;</span>&nbsp;<span class="builtinfunc" id="5355608">len</span><span class="op" id="5355611">(</span><span class="ident" id="5355612">src</span><span class="op" id="5355615">)</span>&nbsp;<span class="op" id="5355617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355621">dst</span><span class="op" id="5355624">.</span><span class="ident" id="5355625">Write</span><span class="op" id="5355630">(</span><span class="ident" id="5355631">src</span><span class="op" id="5355634">[</span><span class="ident" id="5355635">start</span><span class="op" id="5355640">:</span><span class="op" id="5355641">]</span><span class="op" id="5355642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5355645">}</span><br>
<span class="lineno"></span><span class="op" id="5355647">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5355650">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5355708">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5355751">type</span>&nbsp;<span class="ident" id="5355756">Marshaler</span>&nbsp;<span class="keyword" id="5355766">interface</span>&nbsp;<span class="op" id="5355776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355779">MarshalJSON</span><span class="op" id="5355790">(</span><span class="op" id="5355791">)</span>&nbsp;<span class="op" id="5355793">(</span><span class="op" id="5355794">[</span><span class="op" id="5355795">]</span><span class="builtintype" id="5355796">byte</span><span class="op" id="5355800">,</span>&nbsp;<span class="builtintype" id="5355802">error</span><span class="op" id="5355807">)</span><br>
<span class="lineno">195</span><span class="op" id="5355809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5355812">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="5355878">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5355918">type</span>&nbsp;<span class="ident" id="5355923">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="5355944">struct</span>&nbsp;<span class="op" id="5355951">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355954">Type</span>&nbsp;<span class="ident" id="5355959">reflect</span><span class="op" id="5355966">.</span><span class="ident" id="5355967">Type</span><br>
<span class="lineno"></span><span class="op" id="5355972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5355975">func</span>&nbsp;<span class="op" id="5355980">(</span><span class="ident" id="5355981">e</span>&nbsp;<span class="op" id="5355983">*</span><span class="ident" id="5355984">UnsupportedTypeError</span><span class="op" id="5356004">)</span>&nbsp;<span class="ident" id="5356006">Error</span><span class="op" id="5356011">(</span><span class="op" id="5356012">)</span>&nbsp;<span class="builtintype" id="5356014">string</span>&nbsp;<span class="op" id="5356021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356024">return</span>&nbsp;<span class="string" id="5356031">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="5356058">+</span>&nbsp;<span class="ident" id="5356060">e</span><span class="op" id="5356061">.</span><span class="ident" id="5356062">Type</span><span class="op" id="5356066">.</span><span class="ident" id="5356067">String</span><span class="op" id="5356073">(</span><span class="op" id="5356074">)</span><br>
<span class="lineno">205</span><span class="op" id="5356076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5356079">type</span>&nbsp;<span class="ident" id="5356084">UnsupportedValueError</span>&nbsp;<span class="keyword" id="5356106">struct</span>&nbsp;<span class="op" id="5356113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356116">Value</span>&nbsp;<span class="ident" id="5356122">reflect</span><span class="op" id="5356129">.</span><span class="ident" id="5356130">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356137">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5356143">string</span><br>
<span class="lineno">210</span><span class="op" id="5356150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5356153">func</span>&nbsp;<span class="op" id="5356158">(</span><span class="ident" id="5356159">e</span>&nbsp;<span class="op" id="5356161">*</span><span class="ident" id="5356162">UnsupportedValueError</span><span class="op" id="5356183">)</span>&nbsp;<span class="ident" id="5356185">Error</span><span class="op" id="5356190">(</span><span class="op" id="5356191">)</span>&nbsp;<span class="builtintype" id="5356193">string</span>&nbsp;<span class="op" id="5356200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356203">return</span>&nbsp;<span class="string" id="5356210">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="5356238">+</span>&nbsp;<span class="ident" id="5356240">e</span><span class="op" id="5356241">.</span><span class="ident" id="5356242">Str</span><br>
<span class="lineno"></span><span class="op" id="5356246">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5356249">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5356316">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="5356385">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5356455">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="5356524">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="5356601">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5356641">type</span>&nbsp;<span class="ident" id="5356646">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="5356663">struct</span>&nbsp;<span class="op" id="5356670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356673">S</span>&nbsp;<span class="builtintype" id="5356675">string</span>&nbsp;<span class="comment" id="5356682">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="5356730">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="5356733">func</span>&nbsp;<span class="op" id="5356738">(</span><span class="ident" id="5356739">e</span>&nbsp;<span class="op" id="5356741">*</span><span class="ident" id="5356742">InvalidUTF8Error</span><span class="op" id="5356758">)</span>&nbsp;<span class="ident" id="5356760">Error</span><span class="op" id="5356765">(</span><span class="op" id="5356766">)</span>&nbsp;<span class="builtintype" id="5356768">string</span>&nbsp;<span class="op" id="5356775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356778">return</span>&nbsp;<span class="string" id="5356785">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="5356819">+</span>&nbsp;<span class="ident" id="5356821">strconv</span><span class="op" id="5356828">.</span><span class="ident" id="5356829">Quote</span><span class="op" id="5356834">(</span><span class="ident" id="5356835">e</span><span class="op" id="5356836">.</span><span class="ident" id="5356837">S</span><span class="op" id="5356838">)</span><br>
<span class="lineno"></span><span class="op" id="5356840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="5356843">type</span>&nbsp;<span class="ident" id="5356848">MarshalerError</span>&nbsp;<span class="keyword" id="5356863">struct</span>&nbsp;<span class="op" id="5356870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356873">Type</span>&nbsp;<span class="ident" id="5356878">reflect</span><span class="op" id="5356885">.</span><span class="ident" id="5356886">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356892">Err</span>&nbsp;&nbsp;<span class="builtintype" id="5356897">error</span><br>
<span class="lineno"></span><span class="op" id="5356903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="5356906">func</span>&nbsp;<span class="op" id="5356911">(</span><span class="ident" id="5356912">e</span>&nbsp;<span class="op" id="5356914">*</span><span class="ident" id="5356915">MarshalerError</span><span class="op" id="5356929">)</span>&nbsp;<span class="ident" id="5356931">Error</span><span class="op" id="5356936">(</span><span class="op" id="5356937">)</span>&nbsp;<span class="builtintype" id="5356939">string</span>&nbsp;<span class="op" id="5356946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356949">return</span>&nbsp;<span class="string" id="5356956">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5357000">+</span>&nbsp;<span class="ident" id="5357002">e</span><span class="op" id="5357003">.</span><span class="ident" id="5357004">Type</span><span class="op" id="5357008">.</span><span class="ident" id="5357009">String</span><span class="op" id="5357015">(</span><span class="op" id="5357016">)</span>&nbsp;<span class="op" id="5357018">+</span>&nbsp;<span class="string" id="5357020">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="5357025">+</span>&nbsp;<span class="ident" id="5357027">e</span><span class="op" id="5357028">.</span><span class="ident" id="5357029">Err</span><span class="op" id="5357032">.</span><span class="ident" id="5357033">Error</span><span class="op" id="5357038">(</span><span class="op" id="5357039">)</span><br>
<span class="lineno"></span><span class="op" id="5357041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5357044">var</span>&nbsp;<span class="ident" id="5357048">hex</span>&nbsp;<span class="op" id="5357052">=</span>&nbsp;<span class="string" id="5357054">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="5357074">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="5357126">type</span>&nbsp;<span class="ident" id="5357131">encodeState</span>&nbsp;<span class="keyword" id="5357143">struct</span>&nbsp;<span class="op" id="5357150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357153">bytes</span><span class="op" id="5357158">.</span><span class="ident" id="5357159">Buffer</span>&nbsp;<span class="comment" id="5357166">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357189">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5357202">[</span><span class="num" id="5357203">64</span><span class="op" id="5357205">]</span><span class="builtintype" id="5357206">byte</span><br>
<span class="lineno">245</span><span class="op" id="5357211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5357214">var</span>&nbsp;<span class="ident" id="5357218">encodeStatePool</span>&nbsp;<span class="ident" id="5357234">sync</span><span class="op" id="5357238">.</span><span class="ident" id="5357239">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5357245">func</span>&nbsp;<span class="ident" id="5357250">newEncodeState</span><span class="op" id="5357264">(</span><span class="op" id="5357265">)</span>&nbsp;<span class="op" id="5357267">*</span><span class="ident" id="5357268">encodeState</span>&nbsp;<span class="op" id="5357280">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357283">if</span>&nbsp;<span class="ident" id="5357286">v</span>&nbsp;<span class="op" id="5357288">:=</span>&nbsp;<span class="ident" id="5357291">encodeStatePool</span><span class="op" id="5357306">.</span><span class="ident" id="5357307">Get</span><span class="op" id="5357310">(</span><span class="op" id="5357311">)</span><span class="op" id="5357312">;</span>&nbsp;<span class="ident" id="5357314">v</span>&nbsp;<span class="op" id="5357316">!=</span>&nbsp;<span class="ident" id="5357319">nil</span>&nbsp;<span class="op" id="5357323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357327">e</span>&nbsp;<span class="op" id="5357329">:=</span>&nbsp;<span class="ident" id="5357332">v</span><span class="op" id="5357333">.</span><span class="op" id="5357334">(</span><span class="op" id="5357335">*</span><span class="ident" id="5357336">encodeState</span><span class="op" id="5357347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357351">e</span><span class="op" id="5357352">.</span><span class="ident" id="5357353">Reset</span><span class="op" id="5357358">(</span><span class="op" id="5357359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357363">return</span>&nbsp;<span class="ident" id="5357370">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357373">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357376">return</span>&nbsp;<span class="builtinfunc" id="5357383">new</span><span class="op" id="5357386">(</span><span class="ident" id="5357387">encodeState</span><span class="op" id="5357398">)</span><br>
<span class="lineno"></span><span class="op" id="5357400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5357403">func</span>&nbsp;<span class="op" id="5357408">(</span><span class="ident" id="5357409">e</span>&nbsp;<span class="op" id="5357411">*</span><span class="ident" id="5357412">encodeState</span><span class="op" id="5357423">)</span>&nbsp;<span class="ident" id="5357425">marshal</span><span class="op" id="5357432">(</span><span class="ident" id="5357433">v</span>&nbsp;<span class="keyword" id="5357435">interface</span><span class="op" id="5357444">{</span><span class="op" id="5357445">}</span><span class="op" id="5357446">)</span>&nbsp;<span class="op" id="5357448">(</span><span class="ident" id="5357449">err</span>&nbsp;<span class="builtintype" id="5357453">error</span><span class="op" id="5357458">)</span>&nbsp;<span class="op" id="5357460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357463">defer</span>&nbsp;<span class="keyword" id="5357469">func</span><span class="op" id="5357473">(</span><span class="op" id="5357474">)</span>&nbsp;<span class="op" id="5357476">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357480">if</span>&nbsp;<span class="ident" id="5357483">r</span>&nbsp;<span class="op" id="5357485">:=</span>&nbsp;<span class="builtinfunc" id="5357488">recover</span><span class="op" id="5357495">(</span><span class="op" id="5357496">)</span><span class="op" id="5357497">;</span>&nbsp;<span class="ident" id="5357499">r</span>&nbsp;<span class="op" id="5357501">!=</span>&nbsp;<span class="ident" id="5357504">nil</span>&nbsp;<span class="op" id="5357508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357513">if</span>&nbsp;<span class="ident" id="5357516">_</span><span class="op" id="5357517">,</span>&nbsp;<span class="ident" id="5357519">ok</span>&nbsp;<span class="op" id="5357522">:=</span>&nbsp;<span class="ident" id="5357525">r</span><span class="op" id="5357526">.</span><span class="op" id="5357527">(</span><span class="ident" id="5357528">runtime</span><span class="op" id="5357535">.</span><span class="ident" id="5357536">Error</span><span class="op" id="5357541">)</span><span class="op" id="5357542">;</span>&nbsp;<span class="ident" id="5357544">ok</span>&nbsp;<span class="op" id="5357547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5357553">panic</span><span class="op" id="5357558">(</span><span class="ident" id="5357559">r</span><span class="op" id="5357560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357570">if</span>&nbsp;<span class="ident" id="5357573">s</span><span class="op" id="5357574">,</span>&nbsp;<span class="ident" id="5357576">ok</span>&nbsp;<span class="op" id="5357579">:=</span>&nbsp;<span class="ident" id="5357582">r</span><span class="op" id="5357583">.</span><span class="op" id="5357584">(</span><span class="builtintype" id="5357585">string</span><span class="op" id="5357591">)</span><span class="op" id="5357592">;</span>&nbsp;<span class="ident" id="5357594">ok</span>&nbsp;<span class="op" id="5357597">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5357603">panic</span><span class="op" id="5357608">(</span><span class="ident" id="5357609">s</span><span class="op" id="5357610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357620">err</span>&nbsp;<span class="op" id="5357624">=</span>&nbsp;<span class="ident" id="5357626">r</span><span class="op" id="5357627">.</span><span class="op" id="5357628">(</span><span class="builtintype" id="5357629">error</span><span class="op" id="5357634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357641">}</span><span class="op" id="5357642">(</span><span class="op" id="5357643">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357646">e</span><span class="op" id="5357647">.</span><span class="ident" id="5357648">reflectValue</span><span class="op" id="5357660">(</span><span class="ident" id="5357661">reflect</span><span class="op" id="5357668">.</span><span class="ident" id="5357669">ValueOf</span><span class="op" id="5357676">(</span><span class="ident" id="5357677">v</span><span class="op" id="5357678">)</span><span class="op" id="5357679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357682">return</span>&nbsp;<span class="ident" id="5357689">nil</span><br>
<span class="lineno"></span><span class="op" id="5357693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5357696">func</span>&nbsp;<span class="op" id="5357701">(</span><span class="ident" id="5357702">e</span>&nbsp;<span class="op" id="5357704">*</span><span class="ident" id="5357705">encodeState</span><span class="op" id="5357716">)</span>&nbsp;<span class="builtintype" id="5357718">error</span><span class="op" id="5357723">(</span><span class="ident" id="5357724">err</span>&nbsp;<span class="builtintype" id="5357728">error</span><span class="op" id="5357733">)</span>&nbsp;<span class="op" id="5357735">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5357738">panic</span><span class="op" id="5357743">(</span><span class="ident" id="5357744">err</span><span class="op" id="5357747">)</span><br>
<span class="lineno"></span><span class="op" id="5357749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5357752">var</span>&nbsp;<span class="ident" id="5357756">byteSliceType</span>&nbsp;<span class="op" id="5357770">=</span>&nbsp;<span class="ident" id="5357772">reflect</span><span class="op" id="5357779">.</span><span class="ident" id="5357780">TypeOf</span><span class="op" id="5357786">(</span><span class="op" id="5357787">[</span><span class="op" id="5357788">]</span><span class="builtintype" id="5357789">byte</span><span class="op" id="5357793">(</span><span class="ident" id="5357794">nil</span><span class="op" id="5357797">)</span><span class="op" id="5357798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="5357801">func</span>&nbsp;<span class="ident" id="5357806">isEmptyValue</span><span class="op" id="5357818">(</span><span class="ident" id="5357819">v</span>&nbsp;<span class="ident" id="5357821">reflect</span><span class="op" id="5357828">.</span><span class="ident" id="5357829">Value</span><span class="op" id="5357834">)</span>&nbsp;<span class="builtintype" id="5357836">bool</span>&nbsp;<span class="op" id="5357841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357844">switch</span>&nbsp;<span class="ident" id="5357851">v</span><span class="op" id="5357852">.</span><span class="ident" id="5357853">Kind</span><span class="op" id="5357857">(</span><span class="op" id="5357858">)</span>&nbsp;<span class="op" id="5357860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357863">case</span>&nbsp;<span class="ident" id="5357868">reflect</span><span class="op" id="5357875">.</span><span class="ident" id="5357876">Array</span><span class="op" id="5357881">,</span>&nbsp;<span class="ident" id="5357883">reflect</span><span class="op" id="5357890">.</span><span class="ident" id="5357891">Map</span><span class="op" id="5357894">,</span>&nbsp;<span class="ident" id="5357896">reflect</span><span class="op" id="5357903">.</span><span class="ident" id="5357904">Slice</span><span class="op" id="5357909">,</span>&nbsp;<span class="ident" id="5357911">reflect</span><span class="op" id="5357918">.</span><span class="ident" id="5357919">String</span><span class="op" id="5357925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357929">return</span>&nbsp;<span class="ident" id="5357936">v</span><span class="op" id="5357937">.</span><span class="ident" id="5357938">Len</span><span class="op" id="5357941">(</span><span class="op" id="5357942">)</span>&nbsp;<span class="op" id="5357944">==</span>&nbsp;<span class="num" id="5357947">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357950">case</span>&nbsp;<span class="ident" id="5357955">reflect</span><span class="op" id="5357962">.</span><span class="ident" id="5357963">Bool</span><span class="op" id="5357967">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357971">return</span>&nbsp;<span class="op" id="5357978">!</span><span class="ident" id="5357979">v</span><span class="op" id="5357980">.</span><span class="ident" id="5357981">Bool</span><span class="op" id="5357985">(</span><span class="op" id="5357986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357989">case</span>&nbsp;<span class="ident" id="5357994">reflect</span><span class="op" id="5358001">.</span><span class="ident" id="5358002">Int</span><span class="op" id="5358005">,</span>&nbsp;<span class="ident" id="5358007">reflect</span><span class="op" id="5358014">.</span><span class="ident" id="5358015">Int8</span><span class="op" id="5358019">,</span>&nbsp;<span class="ident" id="5358021">reflect</span><span class="op" id="5358028">.</span><span class="ident" id="5358029">Int16</span><span class="op" id="5358034">,</span>&nbsp;<span class="ident" id="5358036">reflect</span><span class="op" id="5358043">.</span><span class="ident" id="5358044">Int32</span><span class="op" id="5358049">,</span>&nbsp;<span class="ident" id="5358051">reflect</span><span class="op" id="5358058">.</span><span class="ident" id="5358059">Int64</span><span class="op" id="5358064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358068">return</span>&nbsp;<span class="ident" id="5358075">v</span><span class="op" id="5358076">.</span><span class="ident" id="5358077">Int</span><span class="op" id="5358080">(</span><span class="op" id="5358081">)</span>&nbsp;<span class="op" id="5358083">==</span>&nbsp;<span class="num" id="5358086">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358089">case</span>&nbsp;<span class="ident" id="5358094">reflect</span><span class="op" id="5358101">.</span><span class="ident" id="5358102">Uint</span><span class="op" id="5358106">,</span>&nbsp;<span class="ident" id="5358108">reflect</span><span class="op" id="5358115">.</span><span class="ident" id="5358116">Uint8</span><span class="op" id="5358121">,</span>&nbsp;<span class="ident" id="5358123">reflect</span><span class="op" id="5358130">.</span><span class="ident" id="5358131">Uint16</span><span class="op" id="5358137">,</span>&nbsp;<span class="ident" id="5358139">reflect</span><span class="op" id="5358146">.</span><span class="ident" id="5358147">Uint32</span><span class="op" id="5358153">,</span>&nbsp;<span class="ident" id="5358155">reflect</span><span class="op" id="5358162">.</span><span class="ident" id="5358163">Uint64</span><span class="op" id="5358169">,</span>&nbsp;<span class="ident" id="5358171">reflect</span><span class="op" id="5358178">.</span><span class="ident" id="5358179">Uintptr</span><span class="op" id="5358186">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358190">return</span>&nbsp;<span class="ident" id="5358197">v</span><span class="op" id="5358198">.</span><span class="ident" id="5358199">Uint</span><span class="op" id="5358203">(</span><span class="op" id="5358204">)</span>&nbsp;<span class="op" id="5358206">==</span>&nbsp;<span class="num" id="5358209">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358212">case</span>&nbsp;<span class="ident" id="5358217">reflect</span><span class="op" id="5358224">.</span><span class="ident" id="5358225">Float32</span><span class="op" id="5358232">,</span>&nbsp;<span class="ident" id="5358234">reflect</span><span class="op" id="5358241">.</span><span class="ident" id="5358242">Float64</span><span class="op" id="5358249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358253">return</span>&nbsp;<span class="ident" id="5358260">v</span><span class="op" id="5358261">.</span><span class="ident" id="5358262">Float</span><span class="op" id="5358267">(</span><span class="op" id="5358268">)</span>&nbsp;<span class="op" id="5358270">==</span>&nbsp;<span class="num" id="5358273">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358276">case</span>&nbsp;<span class="ident" id="5358281">reflect</span><span class="op" id="5358288">.</span><span class="ident" id="5358289">Interface</span><span class="op" id="5358298">,</span>&nbsp;<span class="ident" id="5358300">reflect</span><span class="op" id="5358307">.</span><span class="ident" id="5358308">Ptr</span><span class="op" id="5358311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358315">return</span>&nbsp;<span class="ident" id="5358322">v</span><span class="op" id="5358323">.</span><span class="ident" id="5358324">IsNil</span><span class="op" id="5358329">(</span><span class="op" id="5358330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358333">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358336">return</span>&nbsp;<span class="builtintype" id="5358343">false</span><br>
<span class="lineno"></span><span class="op" id="5358349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5358352">func</span>&nbsp;<span class="op" id="5358357">(</span><span class="ident" id="5358358">e</span>&nbsp;<span class="op" id="5358360">*</span><span class="ident" id="5358361">encodeState</span><span class="op" id="5358372">)</span>&nbsp;<span class="ident" id="5358374">reflectValue</span><span class="op" id="5358386">(</span><span class="ident" id="5358387">v</span>&nbsp;<span class="ident" id="5358389">reflect</span><span class="op" id="5358396">.</span><span class="ident" id="5358397">Value</span><span class="op" id="5358402">)</span>&nbsp;<span class="op" id="5358404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358407">valueEncoder</span><span class="op" id="5358419">(</span><span class="ident" id="5358420">v</span><span class="op" id="5358421">)</span><span class="op" id="5358422">(</span><span class="ident" id="5358423">e</span><span class="op" id="5358424">,</span>&nbsp;<span class="ident" id="5358426">v</span><span class="op" id="5358427">,</span>&nbsp;<span class="builtintype" id="5358429">false</span><span class="op" id="5358434">)</span><br>
<span class="lineno">300</span><span class="op" id="5358436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5358439">type</span>&nbsp;<span class="ident" id="5358444">encoderFunc</span>&nbsp;<span class="keyword" id="5358456">func</span><span class="op" id="5358460">(</span><span class="ident" id="5358461">e</span>&nbsp;<span class="op" id="5358463">*</span><span class="ident" id="5358464">encodeState</span><span class="op" id="5358475">,</span>&nbsp;<span class="ident" id="5358477">v</span>&nbsp;<span class="ident" id="5358479">reflect</span><span class="op" id="5358486">.</span><span class="ident" id="5358487">Value</span><span class="op" id="5358492">,</span>&nbsp;<span class="ident" id="5358494">quoted</span>&nbsp;<span class="builtintype" id="5358501">bool</span><span class="op" id="5358505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5358508">var</span>&nbsp;<span class="ident" id="5358512">encoderCache</span>&nbsp;<span class="keyword" id="5358525">struct</span>&nbsp;<span class="op" id="5358532">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358535">sync</span><span class="op" id="5358539">.</span><span class="ident" id="5358540">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358549">m</span>&nbsp;<span class="keyword" id="5358551">map</span><span class="op" id="5358554">[</span><span class="ident" id="5358555">reflect</span><span class="op" id="5358562">.</span><span class="ident" id="5358563">Type</span><span class="op" id="5358567">]</span><span class="ident" id="5358568">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5358580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5358583">func</span>&nbsp;<span class="ident" id="5358588">valueEncoder</span><span class="op" id="5358600">(</span><span class="ident" id="5358601">v</span>&nbsp;<span class="ident" id="5358603">reflect</span><span class="op" id="5358610">.</span><span class="ident" id="5358611">Value</span><span class="op" id="5358616">)</span>&nbsp;<span class="ident" id="5358618">encoderFunc</span>&nbsp;<span class="op" id="5358630">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358633">if</span>&nbsp;<span class="op" id="5358636">!</span><span class="ident" id="5358637">v</span><span class="op" id="5358638">.</span><span class="ident" id="5358639">IsValid</span><span class="op" id="5358646">(</span><span class="op" id="5358647">)</span>&nbsp;<span class="op" id="5358649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358653">return</span>&nbsp;<span class="ident" id="5358660">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358684">return</span>&nbsp;<span class="ident" id="5358691">typeEncoder</span><span class="op" id="5358702">(</span><span class="ident" id="5358703">v</span><span class="op" id="5358704">.</span><span class="ident" id="5358705">Type</span><span class="op" id="5358709">(</span><span class="op" id="5358710">)</span><span class="op" id="5358711">)</span><br>
<span class="lineno"></span><span class="op" id="5358713">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="5358716">func</span>&nbsp;<span class="ident" id="5358721">typeEncoder</span><span class="op" id="5358732">(</span><span class="ident" id="5358733">t</span>&nbsp;<span class="ident" id="5358735">reflect</span><span class="op" id="5358742">.</span><span class="ident" id="5358743">Type</span><span class="op" id="5358747">)</span>&nbsp;<span class="ident" id="5358749">encoderFunc</span>&nbsp;<span class="op" id="5358761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358764">encoderCache</span><span class="op" id="5358776">.</span><span class="ident" id="5358777">RLock</span><span class="op" id="5358782">(</span><span class="op" id="5358783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358786">f</span>&nbsp;<span class="op" id="5358788">:=</span>&nbsp;<span class="ident" id="5358791">encoderCache</span><span class="op" id="5358803">.</span><span class="ident" id="5358804">m</span><span class="op" id="5358805">[</span><span class="ident" id="5358806">t</span><span class="op" id="5358807">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358810">encoderCache</span><span class="op" id="5358822">.</span><span class="ident" id="5358823">RUnlock</span><span class="op" id="5358830">(</span><span class="op" id="5358831">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358834">if</span>&nbsp;<span class="ident" id="5358837">f</span>&nbsp;<span class="op" id="5358839">!=</span>&nbsp;<span class="ident" id="5358842">nil</span>&nbsp;<span class="op" id="5358846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358850">return</span>&nbsp;<span class="ident" id="5358857">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358864">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358923">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358984">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359048">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359091">encoderCache</span><span class="op" id="5359103">.</span><span class="ident" id="5359104">Lock</span><span class="op" id="5359108">(</span><span class="op" id="5359109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359112">if</span>&nbsp;<span class="ident" id="5359115">encoderCache</span><span class="op" id="5359127">.</span><span class="ident" id="5359128">m</span>&nbsp;<span class="op" id="5359130">==</span>&nbsp;<span class="ident" id="5359133">nil</span>&nbsp;<span class="op" id="5359137">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359141">encoderCache</span><span class="op" id="5359153">.</span><span class="ident" id="5359154">m</span>&nbsp;<span class="op" id="5359156">=</span>&nbsp;<span class="builtinfunc" id="5359158">make</span><span class="op" id="5359162">(</span><span class="keyword" id="5359163">map</span><span class="op" id="5359166">[</span><span class="ident" id="5359167">reflect</span><span class="op" id="5359174">.</span><span class="ident" id="5359175">Type</span><span class="op" id="5359179">]</span><span class="ident" id="5359180">encoderFunc</span><span class="op" id="5359191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359197">var</span>&nbsp;<span class="ident" id="5359201">wg</span>&nbsp;<span class="ident" id="5359204">sync</span><span class="op" id="5359208">.</span><span class="ident" id="5359209">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359220">wg</span><span class="op" id="5359222">.</span><span class="ident" id="5359223">Add</span><span class="op" id="5359226">(</span><span class="num" id="5359227">1</span><span class="op" id="5359228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359231">encoderCache</span><span class="op" id="5359243">.</span><span class="ident" id="5359244">m</span><span class="op" id="5359245">[</span><span class="ident" id="5359246">t</span><span class="op" id="5359247">]</span>&nbsp;<span class="op" id="5359249">=</span>&nbsp;<span class="keyword" id="5359251">func</span><span class="op" id="5359255">(</span><span class="ident" id="5359256">e</span>&nbsp;<span class="op" id="5359258">*</span><span class="ident" id="5359259">encodeState</span><span class="op" id="5359270">,</span>&nbsp;<span class="ident" id="5359272">v</span>&nbsp;<span class="ident" id="5359274">reflect</span><span class="op" id="5359281">.</span><span class="ident" id="5359282">Value</span><span class="op" id="5359287">,</span>&nbsp;<span class="ident" id="5359289">quoted</span>&nbsp;<span class="builtintype" id="5359296">bool</span><span class="op" id="5359300">)</span>&nbsp;<span class="op" id="5359302">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359306">wg</span><span class="op" id="5359308">.</span><span class="ident" id="5359309">Wait</span><span class="op" id="5359313">(</span><span class="op" id="5359314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359318">f</span><span class="op" id="5359319">(</span><span class="ident" id="5359320">e</span><span class="op" id="5359321">,</span>&nbsp;<span class="ident" id="5359323">v</span><span class="op" id="5359324">,</span>&nbsp;<span class="ident" id="5359326">quoted</span><span class="op" id="5359332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359338">encoderCache</span><span class="op" id="5359350">.</span><span class="ident" id="5359351">Unlock</span><span class="op" id="5359357">(</span><span class="op" id="5359358">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359362">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359395">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359462">f</span>&nbsp;<span class="op" id="5359464">=</span>&nbsp;<span class="ident" id="5359466">newTypeEncoder</span><span class="op" id="5359480">(</span><span class="ident" id="5359481">t</span><span class="op" id="5359482">,</span>&nbsp;<span class="builtintype" id="5359484">true</span><span class="op" id="5359488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359491">wg</span><span class="op" id="5359493">.</span><span class="ident" id="5359494">Done</span><span class="op" id="5359498">(</span><span class="op" id="5359499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359502">encoderCache</span><span class="op" id="5359514">.</span><span class="ident" id="5359515">Lock</span><span class="op" id="5359519">(</span><span class="op" id="5359520">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359523">encoderCache</span><span class="op" id="5359535">.</span><span class="ident" id="5359536">m</span><span class="op" id="5359537">[</span><span class="ident" id="5359538">t</span><span class="op" id="5359539">]</span>&nbsp;<span class="op" id="5359541">=</span>&nbsp;<span class="ident" id="5359543">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359546">encoderCache</span><span class="op" id="5359558">.</span><span class="ident" id="5359559">Unlock</span><span class="op" id="5359565">(</span><span class="op" id="5359566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359569">return</span>&nbsp;<span class="ident" id="5359576">f</span><br>
<span class="lineno"></span><span class="op" id="5359578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="5359581">var</span>&nbsp;<span class="op" id="5359585">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359588">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5359606">=</span>&nbsp;<span class="ident" id="5359608">reflect</span><span class="op" id="5359615">.</span><span class="ident" id="5359616">TypeOf</span><span class="op" id="5359622">(</span><span class="builtinfunc" id="5359623">new</span><span class="op" id="5359626">(</span><span class="ident" id="5359627">Marshaler</span><span class="op" id="5359636">)</span><span class="op" id="5359637">)</span><span class="op" id="5359638">.</span><span class="ident" id="5359639">Elem</span><span class="op" id="5359643">(</span><span class="op" id="5359644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359647">textMarshalerType</span>&nbsp;<span class="op" id="5359665">=</span>&nbsp;<span class="ident" id="5359667">reflect</span><span class="op" id="5359674">.</span><span class="ident" id="5359675">TypeOf</span><span class="op" id="5359681">(</span><span class="builtinfunc" id="5359682">new</span><span class="op" id="5359685">(</span><span class="ident" id="5359686">encoding</span><span class="op" id="5359694">.</span><span class="ident" id="5359695">TextMarshaler</span><span class="op" id="5359708">)</span><span class="op" id="5359709">)</span><span class="op" id="5359710">.</span><span class="ident" id="5359711">Elem</span><span class="op" id="5359715">(</span><span class="op" id="5359716">)</span><br>
<span class="lineno"></span><span class="op" id="5359718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="5359721">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5359777">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5359845">func</span>&nbsp;<span class="ident" id="5359850">newTypeEncoder</span><span class="op" id="5359864">(</span><span class="ident" id="5359865">t</span>&nbsp;<span class="ident" id="5359867">reflect</span><span class="op" id="5359874">.</span><span class="ident" id="5359875">Type</span><span class="op" id="5359879">,</span>&nbsp;<span class="ident" id="5359881">allowAddr</span>&nbsp;<span class="builtintype" id="5359891">bool</span><span class="op" id="5359895">)</span>&nbsp;<span class="ident" id="5359897">encoderFunc</span>&nbsp;<span class="op" id="5359909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359912">if</span>&nbsp;<span class="ident" id="5359915">t</span><span class="op" id="5359916">.</span><span class="ident" id="5359917">Implements</span><span class="op" id="5359927">(</span><span class="ident" id="5359928">marshalerType</span><span class="op" id="5359941">)</span>&nbsp;<span class="op" id="5359943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359947">return</span>&nbsp;<span class="ident" id="5359954">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359975">if</span>&nbsp;<span class="ident" id="5359978">t</span><span class="op" id="5359979">.</span><span class="ident" id="5359980">Kind</span><span class="op" id="5359984">(</span><span class="op" id="5359985">)</span>&nbsp;<span class="op" id="5359987">!=</span>&nbsp;<span class="ident" id="5359990">reflect</span><span class="op" id="5359997">.</span><span class="ident" id="5359998">Ptr</span>&nbsp;<span class="op" id="5360002">&amp;&amp;</span>&nbsp;<span class="ident" id="5360005">allowAddr</span>&nbsp;<span class="op" id="5360015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360019">if</span>&nbsp;<span class="ident" id="5360022">reflect</span><span class="op" id="5360029">.</span><span class="ident" id="5360030">PtrTo</span><span class="op" id="5360035">(</span><span class="ident" id="5360036">t</span><span class="op" id="5360037">)</span><span class="op" id="5360038">.</span><span class="ident" id="5360039">Implements</span><span class="op" id="5360049">(</span><span class="ident" id="5360050">marshalerType</span><span class="op" id="5360063">)</span>&nbsp;<span class="op" id="5360065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360070">return</span>&nbsp;<span class="ident" id="5360077">newCondAddrEncoder</span><span class="op" id="5360095">(</span><span class="ident" id="5360096">addrMarshalerEncoder</span><span class="op" id="5360116">,</span>&nbsp;<span class="ident" id="5360118">newTypeEncoder</span><span class="op" id="5360132">(</span><span class="ident" id="5360133">t</span><span class="op" id="5360134">,</span>&nbsp;<span class="builtintype" id="5360136">false</span><span class="op" id="5360141">)</span><span class="op" id="5360142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360146">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360153">if</span>&nbsp;<span class="ident" id="5360156">t</span><span class="op" id="5360157">.</span><span class="ident" id="5360158">Implements</span><span class="op" id="5360168">(</span><span class="ident" id="5360169">textMarshalerType</span><span class="op" id="5360186">)</span>&nbsp;<span class="op" id="5360188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360192">return</span>&nbsp;<span class="ident" id="5360199">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360221">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360224">if</span>&nbsp;<span class="ident" id="5360227">t</span><span class="op" id="5360228">.</span><span class="ident" id="5360229">Kind</span><span class="op" id="5360233">(</span><span class="op" id="5360234">)</span>&nbsp;<span class="op" id="5360236">!=</span>&nbsp;<span class="ident" id="5360239">reflect</span><span class="op" id="5360246">.</span><span class="ident" id="5360247">Ptr</span>&nbsp;<span class="op" id="5360251">&amp;&amp;</span>&nbsp;<span class="ident" id="5360254">allowAddr</span>&nbsp;<span class="op" id="5360264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360268">if</span>&nbsp;<span class="ident" id="5360271">reflect</span><span class="op" id="5360278">.</span><span class="ident" id="5360279">PtrTo</span><span class="op" id="5360284">(</span><span class="ident" id="5360285">t</span><span class="op" id="5360286">)</span><span class="op" id="5360287">.</span><span class="ident" id="5360288">Implements</span><span class="op" id="5360298">(</span><span class="ident" id="5360299">textMarshalerType</span><span class="op" id="5360316">)</span>&nbsp;<span class="op" id="5360318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360323">return</span>&nbsp;<span class="ident" id="5360330">newCondAddrEncoder</span><span class="op" id="5360348">(</span><span class="ident" id="5360349">addrTextMarshalerEncoder</span><span class="op" id="5360373">,</span>&nbsp;<span class="ident" id="5360375">newTypeEncoder</span><span class="op" id="5360389">(</span><span class="ident" id="5360390">t</span><span class="op" id="5360391">,</span>&nbsp;<span class="builtintype" id="5360393">false</span><span class="op" id="5360398">)</span><span class="op" id="5360399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360406">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360410">switch</span>&nbsp;<span class="ident" id="5360417">t</span><span class="op" id="5360418">.</span><span class="ident" id="5360419">Kind</span><span class="op" id="5360423">(</span><span class="op" id="5360424">)</span>&nbsp;<span class="op" id="5360426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360429">case</span>&nbsp;<span class="ident" id="5360434">reflect</span><span class="op" id="5360441">.</span><span class="ident" id="5360442">Bool</span><span class="op" id="5360446">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360450">return</span>&nbsp;<span class="ident" id="5360457">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360470">case</span>&nbsp;<span class="ident" id="5360475">reflect</span><span class="op" id="5360482">.</span><span class="ident" id="5360483">Int</span><span class="op" id="5360486">,</span>&nbsp;<span class="ident" id="5360488">reflect</span><span class="op" id="5360495">.</span><span class="ident" id="5360496">Int8</span><span class="op" id="5360500">,</span>&nbsp;<span class="ident" id="5360502">reflect</span><span class="op" id="5360509">.</span><span class="ident" id="5360510">Int16</span><span class="op" id="5360515">,</span>&nbsp;<span class="ident" id="5360517">reflect</span><span class="op" id="5360524">.</span><span class="ident" id="5360525">Int32</span><span class="op" id="5360530">,</span>&nbsp;<span class="ident" id="5360532">reflect</span><span class="op" id="5360539">.</span><span class="ident" id="5360540">Int64</span><span class="op" id="5360545">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360549">return</span>&nbsp;<span class="ident" id="5360556">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360568">case</span>&nbsp;<span class="ident" id="5360573">reflect</span><span class="op" id="5360580">.</span><span class="ident" id="5360581">Uint</span><span class="op" id="5360585">,</span>&nbsp;<span class="ident" id="5360587">reflect</span><span class="op" id="5360594">.</span><span class="ident" id="5360595">Uint8</span><span class="op" id="5360600">,</span>&nbsp;<span class="ident" id="5360602">reflect</span><span class="op" id="5360609">.</span><span class="ident" id="5360610">Uint16</span><span class="op" id="5360616">,</span>&nbsp;<span class="ident" id="5360618">reflect</span><span class="op" id="5360625">.</span><span class="ident" id="5360626">Uint32</span><span class="op" id="5360632">,</span>&nbsp;<span class="ident" id="5360634">reflect</span><span class="op" id="5360641">.</span><span class="ident" id="5360642">Uint64</span><span class="op" id="5360648">,</span>&nbsp;<span class="ident" id="5360650">reflect</span><span class="op" id="5360657">.</span><span class="ident" id="5360658">Uintptr</span><span class="op" id="5360665">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360669">return</span>&nbsp;<span class="ident" id="5360676">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360689">case</span>&nbsp;<span class="ident" id="5360694">reflect</span><span class="op" id="5360701">.</span><span class="ident" id="5360702">Float32</span><span class="op" id="5360709">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360713">return</span>&nbsp;<span class="ident" id="5360720">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360736">case</span>&nbsp;<span class="ident" id="5360741">reflect</span><span class="op" id="5360748">.</span><span class="ident" id="5360749">Float64</span><span class="op" id="5360756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360760">return</span>&nbsp;<span class="ident" id="5360767">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360783">case</span>&nbsp;<span class="ident" id="5360788">reflect</span><span class="op" id="5360795">.</span><span class="ident" id="5360796">String</span><span class="op" id="5360802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360806">return</span>&nbsp;<span class="ident" id="5360813">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360828">case</span>&nbsp;<span class="ident" id="5360833">reflect</span><span class="op" id="5360840">.</span><span class="ident" id="5360841">Interface</span><span class="op" id="5360850">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360854">return</span>&nbsp;<span class="ident" id="5360861">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360879">case</span>&nbsp;<span class="ident" id="5360884">reflect</span><span class="op" id="5360891">.</span><span class="ident" id="5360892">Struct</span><span class="op" id="5360898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360902">return</span>&nbsp;<span class="ident" id="5360909">newStructEncoder</span><span class="op" id="5360925">(</span><span class="ident" id="5360926">t</span><span class="op" id="5360927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360930">case</span>&nbsp;<span class="ident" id="5360935">reflect</span><span class="op" id="5360942">.</span><span class="ident" id="5360943">Map</span><span class="op" id="5360946">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360950">return</span>&nbsp;<span class="ident" id="5360957">newMapEncoder</span><span class="op" id="5360970">(</span><span class="ident" id="5360971">t</span><span class="op" id="5360972">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360975">case</span>&nbsp;<span class="ident" id="5360980">reflect</span><span class="op" id="5360987">.</span><span class="ident" id="5360988">Slice</span><span class="op" id="5360993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360997">return</span>&nbsp;<span class="ident" id="5361004">newSliceEncoder</span><span class="op" id="5361019">(</span><span class="ident" id="5361020">t</span><span class="op" id="5361021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361024">case</span>&nbsp;<span class="ident" id="5361029">reflect</span><span class="op" id="5361036">.</span><span class="ident" id="5361037">Array</span><span class="op" id="5361042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361046">return</span>&nbsp;<span class="ident" id="5361053">newArrayEncoder</span><span class="op" id="5361068">(</span><span class="ident" id="5361069">t</span><span class="op" id="5361070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361073">case</span>&nbsp;<span class="ident" id="5361078">reflect</span><span class="op" id="5361085">.</span><span class="ident" id="5361086">Ptr</span><span class="op" id="5361089">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361093">return</span>&nbsp;<span class="ident" id="5361100">newPtrEncoder</span><span class="op" id="5361113">(</span><span class="ident" id="5361114">t</span><span class="op" id="5361115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361118">default</span><span class="op" id="5361125">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361129">return</span>&nbsp;<span class="ident" id="5361136">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361160">}</span><br>
<span class="lineno"></span><span class="op" id="5361162">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="5361165">func</span>&nbsp;<span class="ident" id="5361170">invalidValueEncoder</span><span class="op" id="5361189">(</span><span class="ident" id="5361190">e</span>&nbsp;<span class="op" id="5361192">*</span><span class="ident" id="5361193">encodeState</span><span class="op" id="5361204">,</span>&nbsp;<span class="ident" id="5361206">v</span>&nbsp;<span class="ident" id="5361208">reflect</span><span class="op" id="5361215">.</span><span class="ident" id="5361216">Value</span><span class="op" id="5361221">,</span>&nbsp;<span class="ident" id="5361223">quoted</span>&nbsp;<span class="builtintype" id="5361230">bool</span><span class="op" id="5361234">)</span>&nbsp;<span class="op" id="5361236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361239">e</span><span class="op" id="5361240">.</span><span class="ident" id="5361241">WriteString</span><span class="op" id="5361252">(</span><span class="string" id="5361253">&#34;null&#34;</span><span class="op" id="5361259">)</span><br>
<span class="lineno"></span><span class="op" id="5361261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="5361264">func</span>&nbsp;<span class="ident" id="5361269">marshalerEncoder</span><span class="op" id="5361285">(</span><span class="ident" id="5361286">e</span>&nbsp;<span class="op" id="5361288">*</span><span class="ident" id="5361289">encodeState</span><span class="op" id="5361300">,</span>&nbsp;<span class="ident" id="5361302">v</span>&nbsp;<span class="ident" id="5361304">reflect</span><span class="op" id="5361311">.</span><span class="ident" id="5361312">Value</span><span class="op" id="5361317">,</span>&nbsp;<span class="ident" id="5361319">quoted</span>&nbsp;<span class="builtintype" id="5361326">bool</span><span class="op" id="5361330">)</span>&nbsp;<span class="op" id="5361332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361335">if</span>&nbsp;<span class="ident" id="5361338">v</span><span class="op" id="5361339">.</span><span class="ident" id="5361340">Kind</span><span class="op" id="5361344">(</span><span class="op" id="5361345">)</span>&nbsp;<span class="op" id="5361347">==</span>&nbsp;<span class="ident" id="5361350">reflect</span><span class="op" id="5361357">.</span><span class="ident" id="5361358">Ptr</span>&nbsp;<span class="op" id="5361362">&amp;&amp;</span>&nbsp;<span class="ident" id="5361365">v</span><span class="op" id="5361366">.</span><span class="ident" id="5361367">IsNil</span><span class="op" id="5361372">(</span><span class="op" id="5361373">)</span>&nbsp;<span class="op" id="5361375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361379">e</span><span class="op" id="5361380">.</span><span class="ident" id="5361381">WriteString</span><span class="op" id="5361392">(</span><span class="string" id="5361393">&#34;null&#34;</span><span class="op" id="5361399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361403">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361411">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361414">m</span>&nbsp;<span class="op" id="5361416">:=</span>&nbsp;<span class="ident" id="5361419">v</span><span class="op" id="5361420">.</span><span class="ident" id="5361421">Interface</span><span class="op" id="5361430">(</span><span class="op" id="5361431">)</span><span class="op" id="5361432">.</span><span class="op" id="5361433">(</span><span class="ident" id="5361434">Marshaler</span><span class="op" id="5361443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361446">b</span><span class="op" id="5361447">,</span>&nbsp;<span class="ident" id="5361449">err</span>&nbsp;<span class="op" id="5361453">:=</span>&nbsp;<span class="ident" id="5361456">m</span><span class="op" id="5361457">.</span><span class="ident" id="5361458">MarshalJSON</span><span class="op" id="5361469">(</span><span class="op" id="5361470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361473">if</span>&nbsp;<span class="ident" id="5361476">err</span>&nbsp;<span class="op" id="5361480">==</span>&nbsp;<span class="ident" id="5361483">nil</span>&nbsp;<span class="op" id="5361487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5361491">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361538">err</span>&nbsp;<span class="op" id="5361542">=</span>&nbsp;<span class="ident" id="5361544">compact</span><span class="op" id="5361551">(</span><span class="op" id="5361552">&amp;</span><span class="ident" id="5361553">e</span><span class="op" id="5361554">.</span><span class="ident" id="5361555">Buffer</span><span class="op" id="5361561">,</span>&nbsp;<span class="ident" id="5361563">b</span><span class="op" id="5361564">,</span>&nbsp;<span class="builtintype" id="5361566">true</span><span class="op" id="5361570">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361576">if</span>&nbsp;<span class="ident" id="5361579">err</span>&nbsp;<span class="op" id="5361583">!=</span>&nbsp;<span class="ident" id="5361586">nil</span>&nbsp;<span class="op" id="5361590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361594">e</span><span class="op" id="5361595">.</span><span class="builtintype" id="5361596">error</span><span class="op" id="5361601">(</span><span class="op" id="5361602">&amp;</span><span class="ident" id="5361603">MarshalerError</span><span class="op" id="5361617">{</span><span class="ident" id="5361618">v</span><span class="op" id="5361619">.</span><span class="ident" id="5361620">Type</span><span class="op" id="5361624">(</span><span class="op" id="5361625">)</span><span class="op" id="5361626">,</span>&nbsp;<span class="ident" id="5361628">err</span><span class="op" id="5361631">}</span><span class="op" id="5361632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361635">}</span><br>
<span class="lineno"></span><span class="op" id="5361637">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="5361640">func</span>&nbsp;<span class="ident" id="5361645">addrMarshalerEncoder</span><span class="op" id="5361665">(</span><span class="ident" id="5361666">e</span>&nbsp;<span class="op" id="5361668">*</span><span class="ident" id="5361669">encodeState</span><span class="op" id="5361680">,</span>&nbsp;<span class="ident" id="5361682">v</span>&nbsp;<span class="ident" id="5361684">reflect</span><span class="op" id="5361691">.</span><span class="ident" id="5361692">Value</span><span class="op" id="5361697">,</span>&nbsp;<span class="ident" id="5361699">quoted</span>&nbsp;<span class="builtintype" id="5361706">bool</span><span class="op" id="5361710">)</span>&nbsp;<span class="op" id="5361712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361715">va</span>&nbsp;<span class="op" id="5361718">:=</span>&nbsp;<span class="ident" id="5361721">v</span><span class="op" id="5361722">.</span><span class="ident" id="5361723">Addr</span><span class="op" id="5361727">(</span><span class="op" id="5361728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361731">if</span>&nbsp;<span class="ident" id="5361734">va</span><span class="op" id="5361736">.</span><span class="ident" id="5361737">IsNil</span><span class="op" id="5361742">(</span><span class="op" id="5361743">)</span>&nbsp;<span class="op" id="5361745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361749">e</span><span class="op" id="5361750">.</span><span class="ident" id="5361751">WriteString</span><span class="op" id="5361762">(</span><span class="string" id="5361763">&#34;null&#34;</span><span class="op" id="5361769">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361773">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361784">m</span>&nbsp;<span class="op" id="5361786">:=</span>&nbsp;<span class="ident" id="5361789">va</span><span class="op" id="5361791">.</span><span class="ident" id="5361792">Interface</span><span class="op" id="5361801">(</span><span class="op" id="5361802">)</span><span class="op" id="5361803">.</span><span class="op" id="5361804">(</span><span class="ident" id="5361805">Marshaler</span><span class="op" id="5361814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361817">b</span><span class="op" id="5361818">,</span>&nbsp;<span class="ident" id="5361820">err</span>&nbsp;<span class="op" id="5361824">:=</span>&nbsp;<span class="ident" id="5361827">m</span><span class="op" id="5361828">.</span><span class="ident" id="5361829">MarshalJSON</span><span class="op" id="5361840">(</span><span class="op" id="5361841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361844">if</span>&nbsp;<span class="ident" id="5361847">err</span>&nbsp;<span class="op" id="5361851">==</span>&nbsp;<span class="ident" id="5361854">nil</span>&nbsp;<span class="op" id="5361858">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5361862">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361909">err</span>&nbsp;<span class="op" id="5361913">=</span>&nbsp;<span class="ident" id="5361915">compact</span><span class="op" id="5361922">(</span><span class="op" id="5361923">&amp;</span><span class="ident" id="5361924">e</span><span class="op" id="5361925">.</span><span class="ident" id="5361926">Buffer</span><span class="op" id="5361932">,</span>&nbsp;<span class="ident" id="5361934">b</span><span class="op" id="5361935">,</span>&nbsp;<span class="builtintype" id="5361937">true</span><span class="op" id="5361941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361947">if</span>&nbsp;<span class="ident" id="5361950">err</span>&nbsp;<span class="op" id="5361954">!=</span>&nbsp;<span class="ident" id="5361957">nil</span>&nbsp;<span class="op" id="5361961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361965">e</span><span class="op" id="5361966">.</span><span class="builtintype" id="5361967">error</span><span class="op" id="5361972">(</span><span class="op" id="5361973">&amp;</span><span class="ident" id="5361974">MarshalerError</span><span class="op" id="5361988">{</span><span class="ident" id="5361989">v</span><span class="op" id="5361990">.</span><span class="ident" id="5361991">Type</span><span class="op" id="5361995">(</span><span class="op" id="5361996">)</span><span class="op" id="5361997">,</span>&nbsp;<span class="ident" id="5361999">err</span><span class="op" id="5362002">}</span><span class="op" id="5362003">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362006">}</span><br>
<span class="lineno"></span><span class="op" id="5362008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5362011">func</span>&nbsp;<span class="ident" id="5362016">textMarshalerEncoder</span><span class="op" id="5362036">(</span><span class="ident" id="5362037">e</span>&nbsp;<span class="op" id="5362039">*</span><span class="ident" id="5362040">encodeState</span><span class="op" id="5362051">,</span>&nbsp;<span class="ident" id="5362053">v</span>&nbsp;<span class="ident" id="5362055">reflect</span><span class="op" id="5362062">.</span><span class="ident" id="5362063">Value</span><span class="op" id="5362068">,</span>&nbsp;<span class="ident" id="5362070">quoted</span>&nbsp;<span class="builtintype" id="5362077">bool</span><span class="op" id="5362081">)</span>&nbsp;<span class="op" id="5362083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362086">if</span>&nbsp;<span class="ident" id="5362089">v</span><span class="op" id="5362090">.</span><span class="ident" id="5362091">Kind</span><span class="op" id="5362095">(</span><span class="op" id="5362096">)</span>&nbsp;<span class="op" id="5362098">==</span>&nbsp;<span class="ident" id="5362101">reflect</span><span class="op" id="5362108">.</span><span class="ident" id="5362109">Ptr</span>&nbsp;<span class="op" id="5362113">&amp;&amp;</span>&nbsp;<span class="ident" id="5362116">v</span><span class="op" id="5362117">.</span><span class="ident" id="5362118">IsNil</span><span class="op" id="5362123">(</span><span class="op" id="5362124">)</span>&nbsp;<span class="op" id="5362126">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362130">e</span><span class="op" id="5362131">.</span><span class="ident" id="5362132">WriteString</span><span class="op" id="5362143">(</span><span class="string" id="5362144">&#34;null&#34;</span><span class="op" id="5362150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362154">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362165">m</span>&nbsp;<span class="op" id="5362167">:=</span>&nbsp;<span class="ident" id="5362170">v</span><span class="op" id="5362171">.</span><span class="ident" id="5362172">Interface</span><span class="op" id="5362181">(</span><span class="op" id="5362182">)</span><span class="op" id="5362183">.</span><span class="op" id="5362184">(</span><span class="ident" id="5362185">encoding</span><span class="op" id="5362193">.</span><span class="ident" id="5362194">TextMarshaler</span><span class="op" id="5362207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362210">b</span><span class="op" id="5362211">,</span>&nbsp;<span class="ident" id="5362213">err</span>&nbsp;<span class="op" id="5362217">:=</span>&nbsp;<span class="ident" id="5362220">m</span><span class="op" id="5362221">.</span><span class="ident" id="5362222">MarshalText</span><span class="op" id="5362233">(</span><span class="op" id="5362234">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362237">if</span>&nbsp;<span class="ident" id="5362240">err</span>&nbsp;<span class="op" id="5362244">==</span>&nbsp;<span class="ident" id="5362247">nil</span>&nbsp;<span class="op" id="5362251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362255">_</span><span class="op" id="5362256">,</span>&nbsp;<span class="ident" id="5362258">err</span>&nbsp;<span class="op" id="5362262">=</span>&nbsp;<span class="ident" id="5362264">e</span><span class="op" id="5362265">.</span><span class="ident" id="5362266">stringBytes</span><span class="op" id="5362277">(</span><span class="ident" id="5362278">b</span><span class="op" id="5362279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362285">if</span>&nbsp;<span class="ident" id="5362288">err</span>&nbsp;<span class="op" id="5362292">!=</span>&nbsp;<span class="ident" id="5362295">nil</span>&nbsp;<span class="op" id="5362299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362303">e</span><span class="op" id="5362304">.</span><span class="builtintype" id="5362305">error</span><span class="op" id="5362310">(</span><span class="op" id="5362311">&amp;</span><span class="ident" id="5362312">MarshalerError</span><span class="op" id="5362326">{</span><span class="ident" id="5362327">v</span><span class="op" id="5362328">.</span><span class="ident" id="5362329">Type</span><span class="op" id="5362333">(</span><span class="op" id="5362334">)</span><span class="op" id="5362335">,</span>&nbsp;<span class="ident" id="5362337">err</span><span class="op" id="5362340">}</span><span class="op" id="5362341">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362344">}</span><br>
<span class="lineno"></span><span class="op" id="5362346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5362349">func</span>&nbsp;<span class="ident" id="5362354">addrTextMarshalerEncoder</span><span class="op" id="5362378">(</span><span class="ident" id="5362379">e</span>&nbsp;<span class="op" id="5362381">*</span><span class="ident" id="5362382">encodeState</span><span class="op" id="5362393">,</span>&nbsp;<span class="ident" id="5362395">v</span>&nbsp;<span class="ident" id="5362397">reflect</span><span class="op" id="5362404">.</span><span class="ident" id="5362405">Value</span><span class="op" id="5362410">,</span>&nbsp;<span class="ident" id="5362412">quoted</span>&nbsp;<span class="builtintype" id="5362419">bool</span><span class="op" id="5362423">)</span>&nbsp;<span class="op" id="5362425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362428">va</span>&nbsp;<span class="op" id="5362431">:=</span>&nbsp;<span class="ident" id="5362434">v</span><span class="op" id="5362435">.</span><span class="ident" id="5362436">Addr</span><span class="op" id="5362440">(</span><span class="op" id="5362441">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362444">if</span>&nbsp;<span class="ident" id="5362447">va</span><span class="op" id="5362449">.</span><span class="ident" id="5362450">IsNil</span><span class="op" id="5362455">(</span><span class="op" id="5362456">)</span>&nbsp;<span class="op" id="5362458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362462">e</span><span class="op" id="5362463">.</span><span class="ident" id="5362464">WriteString</span><span class="op" id="5362475">(</span><span class="string" id="5362476">&#34;null&#34;</span><span class="op" id="5362482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362486">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362497">m</span>&nbsp;<span class="op" id="5362499">:=</span>&nbsp;<span class="ident" id="5362502">va</span><span class="op" id="5362504">.</span><span class="ident" id="5362505">Interface</span><span class="op" id="5362514">(</span><span class="op" id="5362515">)</span><span class="op" id="5362516">.</span><span class="op" id="5362517">(</span><span class="ident" id="5362518">encoding</span><span class="op" id="5362526">.</span><span class="ident" id="5362527">TextMarshaler</span><span class="op" id="5362540">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362543">b</span><span class="op" id="5362544">,</span>&nbsp;<span class="ident" id="5362546">err</span>&nbsp;<span class="op" id="5362550">:=</span>&nbsp;<span class="ident" id="5362553">m</span><span class="op" id="5362554">.</span><span class="ident" id="5362555">MarshalText</span><span class="op" id="5362566">(</span><span class="op" id="5362567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362570">if</span>&nbsp;<span class="ident" id="5362573">err</span>&nbsp;<span class="op" id="5362577">==</span>&nbsp;<span class="ident" id="5362580">nil</span>&nbsp;<span class="op" id="5362584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362588">_</span><span class="op" id="5362589">,</span>&nbsp;<span class="ident" id="5362591">err</span>&nbsp;<span class="op" id="5362595">=</span>&nbsp;<span class="ident" id="5362597">e</span><span class="op" id="5362598">.</span><span class="ident" id="5362599">stringBytes</span><span class="op" id="5362610">(</span><span class="ident" id="5362611">b</span><span class="op" id="5362612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362618">if</span>&nbsp;<span class="ident" id="5362621">err</span>&nbsp;<span class="op" id="5362625">!=</span>&nbsp;<span class="ident" id="5362628">nil</span>&nbsp;<span class="op" id="5362632">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362636">e</span><span class="op" id="5362637">.</span><span class="builtintype" id="5362638">error</span><span class="op" id="5362643">(</span><span class="op" id="5362644">&amp;</span><span class="ident" id="5362645">MarshalerError</span><span class="op" id="5362659">{</span><span class="ident" id="5362660">v</span><span class="op" id="5362661">.</span><span class="ident" id="5362662">Type</span><span class="op" id="5362666">(</span><span class="op" id="5362667">)</span><span class="op" id="5362668">,</span>&nbsp;<span class="ident" id="5362670">err</span><span class="op" id="5362673">}</span><span class="op" id="5362674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362677">}</span><br>
<span class="lineno"></span><span class="op" id="5362679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5362682">func</span>&nbsp;<span class="ident" id="5362687">boolEncoder</span><span class="op" id="5362698">(</span><span class="ident" id="5362699">e</span>&nbsp;<span class="op" id="5362701">*</span><span class="ident" id="5362702">encodeState</span><span class="op" id="5362713">,</span>&nbsp;<span class="ident" id="5362715">v</span>&nbsp;<span class="ident" id="5362717">reflect</span><span class="op" id="5362724">.</span><span class="ident" id="5362725">Value</span><span class="op" id="5362730">,</span>&nbsp;<span class="ident" id="5362732">quoted</span>&nbsp;<span class="builtintype" id="5362739">bool</span><span class="op" id="5362743">)</span>&nbsp;<span class="op" id="5362745">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362748">if</span>&nbsp;<span class="ident" id="5362751">quoted</span>&nbsp;<span class="op" id="5362758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362762">e</span><span class="op" id="5362763">.</span><span class="ident" id="5362764">WriteByte</span><span class="op" id="5362773">(</span><span class="string" id="5362774">&#39;&#34;&#39;</span><span class="op" id="5362777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362783">if</span>&nbsp;<span class="ident" id="5362786">v</span><span class="op" id="5362787">.</span><span class="ident" id="5362788">Bool</span><span class="op" id="5362792">(</span><span class="op" id="5362793">)</span>&nbsp;<span class="op" id="5362795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362799">e</span><span class="op" id="5362800">.</span><span class="ident" id="5362801">WriteString</span><span class="op" id="5362812">(</span><span class="string" id="5362813">&#34;true&#34;</span><span class="op" id="5362819">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362822">}</span>&nbsp;<span class="keyword" id="5362824">else</span>&nbsp;<span class="op" id="5362829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362833">e</span><span class="op" id="5362834">.</span><span class="ident" id="5362835">WriteString</span><span class="op" id="5362846">(</span><span class="string" id="5362847">&#34;false&#34;</span><span class="op" id="5362854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5362860">if</span>&nbsp;<span class="ident" id="5362863">quoted</span>&nbsp;<span class="op" id="5362870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362874">e</span><span class="op" id="5362875">.</span><span class="ident" id="5362876">WriteByte</span><span class="op" id="5362885">(</span><span class="string" id="5362886">&#39;&#34;&#39;</span><span class="op" id="5362889">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5362892">}</span><br>
<span class="lineno"></span><span class="op" id="5362894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5362897">func</span>&nbsp;<span class="ident" id="5362902">intEncoder</span><span class="op" id="5362912">(</span><span class="ident" id="5362913">e</span>&nbsp;<span class="op" id="5362915">*</span><span class="ident" id="5362916">encodeState</span><span class="op" id="5362927">,</span>&nbsp;<span class="ident" id="5362929">v</span>&nbsp;<span class="ident" id="5362931">reflect</span><span class="op" id="5362938">.</span><span class="ident" id="5362939">Value</span><span class="op" id="5362944">,</span>&nbsp;<span class="ident" id="5362946">quoted</span>&nbsp;<span class="builtintype" id="5362953">bool</span><span class="op" id="5362957">)</span>&nbsp;<span class="op" id="5362959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5362962">b</span>&nbsp;<span class="op" id="5362964">:=</span>&nbsp;<span class="ident" id="5362967">strconv</span><span class="op" id="5362974">.</span><span class="ident" id="5362975">AppendInt</span><span class="op" id="5362984">(</span><span class="ident" id="5362985">e</span><span class="op" id="5362986">.</span><span class="ident" id="5362987">scratch</span><span class="op" id="5362994">[</span><span class="op" id="5362995">:</span><span class="num" id="5362996">0</span><span class="op" id="5362997">]</span><span class="op" id="5362998">,</span>&nbsp;<span class="ident" id="5363000">v</span><span class="op" id="5363001">.</span><span class="ident" id="5363002">Int</span><span class="op" id="5363005">(</span><span class="op" id="5363006">)</span><span class="op" id="5363007">,</span>&nbsp;<span class="num" id="5363009">10</span><span class="op" id="5363011">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363014">if</span>&nbsp;<span class="ident" id="5363017">quoted</span>&nbsp;<span class="op" id="5363024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363028">e</span><span class="op" id="5363029">.</span><span class="ident" id="5363030">WriteByte</span><span class="op" id="5363039">(</span><span class="string" id="5363040">&#39;&#34;&#39;</span><span class="op" id="5363043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363049">e</span><span class="op" id="5363050">.</span><span class="ident" id="5363051">Write</span><span class="op" id="5363056">(</span><span class="ident" id="5363057">b</span><span class="op" id="5363058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363061">if</span>&nbsp;<span class="ident" id="5363064">quoted</span>&nbsp;<span class="op" id="5363071">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363075">e</span><span class="op" id="5363076">.</span><span class="ident" id="5363077">WriteByte</span><span class="op" id="5363086">(</span><span class="string" id="5363087">&#39;&#34;&#39;</span><span class="op" id="5363090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363093">}</span><br>
<span class="lineno"></span><span class="op" id="5363095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5363098">func</span>&nbsp;<span class="ident" id="5363103">uintEncoder</span><span class="op" id="5363114">(</span><span class="ident" id="5363115">e</span>&nbsp;<span class="op" id="5363117">*</span><span class="ident" id="5363118">encodeState</span><span class="op" id="5363129">,</span>&nbsp;<span class="ident" id="5363131">v</span>&nbsp;<span class="ident" id="5363133">reflect</span><span class="op" id="5363140">.</span><span class="ident" id="5363141">Value</span><span class="op" id="5363146">,</span>&nbsp;<span class="ident" id="5363148">quoted</span>&nbsp;<span class="builtintype" id="5363155">bool</span><span class="op" id="5363159">)</span>&nbsp;<span class="op" id="5363161">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363164">b</span>&nbsp;<span class="op" id="5363166">:=</span>&nbsp;<span class="ident" id="5363169">strconv</span><span class="op" id="5363176">.</span><span class="ident" id="5363177">AppendUint</span><span class="op" id="5363187">(</span><span class="ident" id="5363188">e</span><span class="op" id="5363189">.</span><span class="ident" id="5363190">scratch</span><span class="op" id="5363197">[</span><span class="op" id="5363198">:</span><span class="num" id="5363199">0</span><span class="op" id="5363200">]</span><span class="op" id="5363201">,</span>&nbsp;<span class="ident" id="5363203">v</span><span class="op" id="5363204">.</span><span class="ident" id="5363205">Uint</span><span class="op" id="5363209">(</span><span class="op" id="5363210">)</span><span class="op" id="5363211">,</span>&nbsp;<span class="num" id="5363213">10</span><span class="op" id="5363215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363218">if</span>&nbsp;<span class="ident" id="5363221">quoted</span>&nbsp;<span class="op" id="5363228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363232">e</span><span class="op" id="5363233">.</span><span class="ident" id="5363234">WriteByte</span><span class="op" id="5363243">(</span><span class="string" id="5363244">&#39;&#34;&#39;</span><span class="op" id="5363247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363253">e</span><span class="op" id="5363254">.</span><span class="ident" id="5363255">Write</span><span class="op" id="5363260">(</span><span class="ident" id="5363261">b</span><span class="op" id="5363262">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363265">if</span>&nbsp;<span class="ident" id="5363268">quoted</span>&nbsp;<span class="op" id="5363275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363279">e</span><span class="op" id="5363280">.</span><span class="ident" id="5363281">WriteByte</span><span class="op" id="5363290">(</span><span class="string" id="5363291">&#39;&#34;&#39;</span><span class="op" id="5363294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363297">}</span><br>
<span class="lineno"></span><span class="op" id="5363299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="5363302">type</span>&nbsp;<span class="ident" id="5363307">floatEncoder</span>&nbsp;<span class="builtintype" id="5363320">int</span>&nbsp;<span class="comment" id="5363324">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5363343">func</span>&nbsp;<span class="op" id="5363348">(</span><span class="ident" id="5363349">bits</span>&nbsp;<span class="ident" id="5363354">floatEncoder</span><span class="op" id="5363366">)</span>&nbsp;<span class="ident" id="5363368">encode</span><span class="op" id="5363374">(</span><span class="ident" id="5363375">e</span>&nbsp;<span class="op" id="5363377">*</span><span class="ident" id="5363378">encodeState</span><span class="op" id="5363389">,</span>&nbsp;<span class="ident" id="5363391">v</span>&nbsp;<span class="ident" id="5363393">reflect</span><span class="op" id="5363400">.</span><span class="ident" id="5363401">Value</span><span class="op" id="5363406">,</span>&nbsp;<span class="ident" id="5363408">quoted</span>&nbsp;<span class="builtintype" id="5363415">bool</span><span class="op" id="5363419">)</span>&nbsp;<span class="op" id="5363421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363424">f</span>&nbsp;<span class="op" id="5363426">:=</span>&nbsp;<span class="ident" id="5363429">v</span><span class="op" id="5363430">.</span><span class="ident" id="5363431">Float</span><span class="op" id="5363436">(</span><span class="op" id="5363437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363440">if</span>&nbsp;<span class="ident" id="5363443">math</span><span class="op" id="5363447">.</span><span class="ident" id="5363448">IsInf</span><span class="op" id="5363453">(</span><span class="ident" id="5363454">f</span><span class="op" id="5363455">,</span>&nbsp;<span class="num" id="5363457">0</span><span class="op" id="5363458">)</span>&nbsp;<span class="op" id="5363460">||</span>&nbsp;<span class="ident" id="5363463">math</span><span class="op" id="5363467">.</span><span class="ident" id="5363468">IsNaN</span><span class="op" id="5363473">(</span><span class="ident" id="5363474">f</span><span class="op" id="5363475">)</span>&nbsp;<span class="op" id="5363477">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363481">e</span><span class="op" id="5363482">.</span><span class="builtintype" id="5363483">error</span><span class="op" id="5363488">(</span><span class="op" id="5363489">&amp;</span><span class="ident" id="5363490">UnsupportedValueError</span><span class="op" id="5363511">{</span><span class="ident" id="5363512">v</span><span class="op" id="5363513">,</span>&nbsp;<span class="ident" id="5363515">strconv</span><span class="op" id="5363522">.</span><span class="ident" id="5363523">FormatFloat</span><span class="op" id="5363534">(</span><span class="ident" id="5363535">f</span><span class="op" id="5363536">,</span>&nbsp;<span class="string" id="5363538">&#39;g&#39;</span><span class="op" id="5363541">,</span>&nbsp;<span class="op" id="5363543">-</span><span class="num" id="5363544">1</span><span class="op" id="5363545">,</span>&nbsp;<span class="builtintype" id="5363547">int</span><span class="op" id="5363550">(</span><span class="ident" id="5363551">bits</span><span class="op" id="5363555">)</span><span class="op" id="5363556">)</span><span class="op" id="5363557">}</span><span class="op" id="5363558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363564">b</span>&nbsp;<span class="op" id="5363566">:=</span>&nbsp;<span class="ident" id="5363569">strconv</span><span class="op" id="5363576">.</span><span class="ident" id="5363577">AppendFloat</span><span class="op" id="5363588">(</span><span class="ident" id="5363589">e</span><span class="op" id="5363590">.</span><span class="ident" id="5363591">scratch</span><span class="op" id="5363598">[</span><span class="op" id="5363599">:</span><span class="num" id="5363600">0</span><span class="op" id="5363601">]</span><span class="op" id="5363602">,</span>&nbsp;<span class="ident" id="5363604">f</span><span class="op" id="5363605">,</span>&nbsp;<span class="string" id="5363607">&#39;g&#39;</span><span class="op" id="5363610">,</span>&nbsp;<span class="op" id="5363612">-</span><span class="num" id="5363613">1</span><span class="op" id="5363614">,</span>&nbsp;<span class="builtintype" id="5363616">int</span><span class="op" id="5363619">(</span><span class="ident" id="5363620">bits</span><span class="op" id="5363624">)</span><span class="op" id="5363625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363628">if</span>&nbsp;<span class="ident" id="5363631">quoted</span>&nbsp;<span class="op" id="5363638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363642">e</span><span class="op" id="5363643">.</span><span class="ident" id="5363644">WriteByte</span><span class="op" id="5363653">(</span><span class="string" id="5363654">&#39;&#34;&#39;</span><span class="op" id="5363657">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363663">e</span><span class="op" id="5363664">.</span><span class="ident" id="5363665">Write</span><span class="op" id="5363670">(</span><span class="ident" id="5363671">b</span><span class="op" id="5363672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363675">if</span>&nbsp;<span class="ident" id="5363678">quoted</span>&nbsp;<span class="op" id="5363685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363689">e</span><span class="op" id="5363690">.</span><span class="ident" id="5363691">WriteByte</span><span class="op" id="5363700">(</span><span class="string" id="5363701">&#39;&#34;&#39;</span><span class="op" id="5363704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363707">}</span><br>
<span class="lineno">525</span><span class="op" id="5363709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5363712">var</span>&nbsp;<span class="op" id="5363716">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363719">float32Encoder</span>&nbsp;<span class="op" id="5363734">=</span>&nbsp;<span class="op" id="5363736">(</span><span class="ident" id="5363737">floatEncoder</span><span class="op" id="5363749">(</span><span class="num" id="5363750">32</span><span class="op" id="5363752">)</span><span class="op" id="5363753">)</span><span class="op" id="5363754">.</span><span class="ident" id="5363755">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363763">float64Encoder</span>&nbsp;<span class="op" id="5363778">=</span>&nbsp;<span class="op" id="5363780">(</span><span class="ident" id="5363781">floatEncoder</span><span class="op" id="5363793">(</span><span class="num" id="5363794">64</span><span class="op" id="5363796">)</span><span class="op" id="5363797">)</span><span class="op" id="5363798">.</span><span class="ident" id="5363799">encode</span><br>
<span class="lineno">530</span><span class="op" id="5363806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5363809">func</span>&nbsp;<span class="ident" id="5363814">stringEncoder</span><span class="op" id="5363827">(</span><span class="ident" id="5363828">e</span>&nbsp;<span class="op" id="5363830">*</span><span class="ident" id="5363831">encodeState</span><span class="op" id="5363842">,</span>&nbsp;<span class="ident" id="5363844">v</span>&nbsp;<span class="ident" id="5363846">reflect</span><span class="op" id="5363853">.</span><span class="ident" id="5363854">Value</span><span class="op" id="5363859">,</span>&nbsp;<span class="ident" id="5363861">quoted</span>&nbsp;<span class="builtintype" id="5363868">bool</span><span class="op" id="5363872">)</span>&nbsp;<span class="op" id="5363874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363877">if</span>&nbsp;<span class="ident" id="5363880">v</span><span class="op" id="5363881">.</span><span class="ident" id="5363882">Type</span><span class="op" id="5363886">(</span><span class="op" id="5363887">)</span>&nbsp;<span class="op" id="5363889">==</span>&nbsp;<span class="ident" id="5363892">numberType</span>&nbsp;<span class="op" id="5363903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363907">numStr</span>&nbsp;<span class="op" id="5363914">:=</span>&nbsp;<span class="ident" id="5363917">v</span><span class="op" id="5363918">.</span><span class="ident" id="5363919">String</span><span class="op" id="5363925">(</span><span class="op" id="5363926">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5363930">if</span>&nbsp;<span class="ident" id="5363933">numStr</span>&nbsp;<span class="op" id="5363940">==</span>&nbsp;<span class="string" id="5363943">&#34;&#34;</span>&nbsp;<span class="op" id="5363946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363951">numStr</span>&nbsp;<span class="op" id="5363958">=</span>&nbsp;<span class="string" id="5363960">&#34;0&#34;</span>&nbsp;<span class="comment" id="5363964">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5363987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5363991">e</span><span class="op" id="5363992">.</span><span class="ident" id="5363993">WriteString</span><span class="op" id="5364004">(</span><span class="ident" id="5364005">numStr</span><span class="op" id="5364011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364015">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364026">if</span>&nbsp;<span class="ident" id="5364029">quoted</span>&nbsp;<span class="op" id="5364036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364040">sb</span><span class="op" id="5364042">,</span>&nbsp;<span class="ident" id="5364044">err</span>&nbsp;<span class="op" id="5364048">:=</span>&nbsp;<span class="ident" id="5364051">Marshal</span><span class="op" id="5364058">(</span><span class="ident" id="5364059">v</span><span class="op" id="5364060">.</span><span class="ident" id="5364061">String</span><span class="op" id="5364067">(</span><span class="op" id="5364068">)</span><span class="op" id="5364069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364073">if</span>&nbsp;<span class="ident" id="5364076">err</span>&nbsp;<span class="op" id="5364080">!=</span>&nbsp;<span class="ident" id="5364083">nil</span>&nbsp;<span class="op" id="5364087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364092">e</span><span class="op" id="5364093">.</span><span class="builtintype" id="5364094">error</span><span class="op" id="5364099">(</span><span class="ident" id="5364100">err</span><span class="op" id="5364103">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364111">e</span><span class="op" id="5364112">.</span><span class="builtintype" id="5364113">string</span><span class="op" id="5364119">(</span><span class="builtintype" id="5364120">string</span><span class="op" id="5364126">(</span><span class="ident" id="5364127">sb</span><span class="op" id="5364129">)</span><span class="op" id="5364130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364133">}</span>&nbsp;<span class="keyword" id="5364135">else</span>&nbsp;<span class="op" id="5364140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364144">e</span><span class="op" id="5364145">.</span><span class="builtintype" id="5364146">string</span><span class="op" id="5364152">(</span><span class="ident" id="5364153">v</span><span class="op" id="5364154">.</span><span class="ident" id="5364155">String</span><span class="op" id="5364161">(</span><span class="op" id="5364162">)</span><span class="op" id="5364163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364166">}</span><br>
<span class="lineno">550</span><span class="op" id="5364168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5364171">func</span>&nbsp;<span class="ident" id="5364176">interfaceEncoder</span><span class="op" id="5364192">(</span><span class="ident" id="5364193">e</span>&nbsp;<span class="op" id="5364195">*</span><span class="ident" id="5364196">encodeState</span><span class="op" id="5364207">,</span>&nbsp;<span class="ident" id="5364209">v</span>&nbsp;<span class="ident" id="5364211">reflect</span><span class="op" id="5364218">.</span><span class="ident" id="5364219">Value</span><span class="op" id="5364224">,</span>&nbsp;<span class="ident" id="5364226">quoted</span>&nbsp;<span class="builtintype" id="5364233">bool</span><span class="op" id="5364237">)</span>&nbsp;<span class="op" id="5364239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364242">if</span>&nbsp;<span class="ident" id="5364245">v</span><span class="op" id="5364246">.</span><span class="ident" id="5364247">IsNil</span><span class="op" id="5364252">(</span><span class="op" id="5364253">)</span>&nbsp;<span class="op" id="5364255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364259">e</span><span class="op" id="5364260">.</span><span class="ident" id="5364261">WriteString</span><span class="op" id="5364272">(</span><span class="string" id="5364273">&#34;null&#34;</span><span class="op" id="5364279">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364283">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364294">e</span><span class="op" id="5364295">.</span><span class="ident" id="5364296">reflectValue</span><span class="op" id="5364308">(</span><span class="ident" id="5364309">v</span><span class="op" id="5364310">.</span><span class="ident" id="5364311">Elem</span><span class="op" id="5364315">(</span><span class="op" id="5364316">)</span><span class="op" id="5364317">)</span><br>
<span class="lineno"></span><span class="op" id="5364319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="5364322">func</span>&nbsp;<span class="ident" id="5364327">unsupportedTypeEncoder</span><span class="op" id="5364349">(</span><span class="ident" id="5364350">e</span>&nbsp;<span class="op" id="5364352">*</span><span class="ident" id="5364353">encodeState</span><span class="op" id="5364364">,</span>&nbsp;<span class="ident" id="5364366">v</span>&nbsp;<span class="ident" id="5364368">reflect</span><span class="op" id="5364375">.</span><span class="ident" id="5364376">Value</span><span class="op" id="5364381">,</span>&nbsp;<span class="ident" id="5364383">quoted</span>&nbsp;<span class="builtintype" id="5364390">bool</span><span class="op" id="5364394">)</span>&nbsp;<span class="op" id="5364396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364399">e</span><span class="op" id="5364400">.</span><span class="builtintype" id="5364401">error</span><span class="op" id="5364406">(</span><span class="op" id="5364407">&amp;</span><span class="ident" id="5364408">UnsupportedTypeError</span><span class="op" id="5364428">{</span><span class="ident" id="5364429">v</span><span class="op" id="5364430">.</span><span class="ident" id="5364431">Type</span><span class="op" id="5364435">(</span><span class="op" id="5364436">)</span><span class="op" id="5364437">}</span><span class="op" id="5364438">)</span><br>
<span class="lineno"></span><span class="op" id="5364440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5364443">type</span>&nbsp;<span class="ident" id="5364448">structEncoder</span>&nbsp;<span class="keyword" id="5364462">struct</span>&nbsp;<span class="op" id="5364469">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364472">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5364482">[</span><span class="op" id="5364483">]</span><span class="ident" id="5364484">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364491">fieldEncs</span>&nbsp;<span class="op" id="5364501">[</span><span class="op" id="5364502">]</span><span class="ident" id="5364503">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5364515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5364518">func</span>&nbsp;<span class="op" id="5364523">(</span><span class="ident" id="5364524">se</span>&nbsp;<span class="op" id="5364527">*</span><span class="ident" id="5364528">structEncoder</span><span class="op" id="5364541">)</span>&nbsp;<span class="ident" id="5364543">encode</span><span class="op" id="5364549">(</span><span class="ident" id="5364550">e</span>&nbsp;<span class="op" id="5364552">*</span><span class="ident" id="5364553">encodeState</span><span class="op" id="5364564">,</span>&nbsp;<span class="ident" id="5364566">v</span>&nbsp;<span class="ident" id="5364568">reflect</span><span class="op" id="5364575">.</span><span class="ident" id="5364576">Value</span><span class="op" id="5364581">,</span>&nbsp;<span class="ident" id="5364583">quoted</span>&nbsp;<span class="builtintype" id="5364590">bool</span><span class="op" id="5364594">)</span>&nbsp;<span class="op" id="5364596">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364599">e</span><span class="op" id="5364600">.</span><span class="ident" id="5364601">WriteByte</span><span class="op" id="5364610">(</span><span class="string" id="5364611">&#39;{&#39;</span><span class="op" id="5364614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364617">first</span>&nbsp;<span class="op" id="5364623">:=</span>&nbsp;<span class="builtintype" id="5364626">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364632">for</span>&nbsp;<span class="ident" id="5364636">i</span><span class="op" id="5364637">,</span>&nbsp;<span class="ident" id="5364639">f</span>&nbsp;<span class="op" id="5364641">:=</span>&nbsp;<span class="keyword" id="5364644">range</span>&nbsp;<span class="ident" id="5364650">se</span><span class="op" id="5364652">.</span><span class="ident" id="5364653">fields</span>&nbsp;<span class="op" id="5364660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364664">fv</span>&nbsp;<span class="op" id="5364667">:=</span>&nbsp;<span class="ident" id="5364670">fieldByIndex</span><span class="op" id="5364682">(</span><span class="ident" id="5364683">v</span><span class="op" id="5364684">,</span>&nbsp;<span class="ident" id="5364686">f</span><span class="op" id="5364687">.</span><span class="ident" id="5364688">index</span><span class="op" id="5364693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364697">if</span>&nbsp;<span class="op" id="5364700">!</span><span class="ident" id="5364701">fv</span><span class="op" id="5364703">.</span><span class="ident" id="5364704">IsValid</span><span class="op" id="5364711">(</span><span class="op" id="5364712">)</span>&nbsp;<span class="op" id="5364714">||</span>&nbsp;<span class="ident" id="5364717">f</span><span class="op" id="5364718">.</span><span class="ident" id="5364719">omitEmpty</span>&nbsp;<span class="op" id="5364729">&amp;&amp;</span>&nbsp;<span class="ident" id="5364732">isEmptyValue</span><span class="op" id="5364744">(</span><span class="ident" id="5364745">fv</span><span class="op" id="5364747">)</span>&nbsp;<span class="op" id="5364749">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364754">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5364769">if</span>&nbsp;<span class="ident" id="5364772">first</span>&nbsp;<span class="op" id="5364778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364783">first</span>&nbsp;<span class="op" id="5364789">=</span>&nbsp;<span class="builtintype" id="5364791">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364799">}</span>&nbsp;<span class="keyword" id="5364801">else</span>&nbsp;<span class="op" id="5364806">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364811">e</span><span class="op" id="5364812">.</span><span class="ident" id="5364813">WriteByte</span><span class="op" id="5364822">(</span><span class="string" id="5364823">&#39;,&#39;</span><span class="op" id="5364826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364834">e</span><span class="op" id="5364835">.</span><span class="builtintype" id="5364836">string</span><span class="op" id="5364842">(</span><span class="ident" id="5364843">f</span><span class="op" id="5364844">.</span><span class="ident" id="5364845">name</span><span class="op" id="5364849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364853">e</span><span class="op" id="5364854">.</span><span class="ident" id="5364855">WriteByte</span><span class="op" id="5364864">(</span><span class="string" id="5364865">&#39;:&#39;</span><span class="op" id="5364868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364872">se</span><span class="op" id="5364874">.</span><span class="ident" id="5364875">fieldEncs</span><span class="op" id="5364884">[</span><span class="ident" id="5364885">i</span><span class="op" id="5364886">]</span><span class="op" id="5364887">(</span><span class="ident" id="5364888">e</span><span class="op" id="5364889">,</span>&nbsp;<span class="ident" id="5364891">fv</span><span class="op" id="5364893">,</span>&nbsp;<span class="ident" id="5364895">f</span><span class="op" id="5364896">.</span><span class="ident" id="5364897">quoted</span><span class="op" id="5364903">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5364906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364909">e</span><span class="op" id="5364910">.</span><span class="ident" id="5364911">WriteByte</span><span class="op" id="5364920">(</span><span class="string" id="5364921">&#39;}&#39;</span><span class="op" id="5364924">)</span><br>
<span class="lineno"></span><span class="op" id="5364926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5364929">func</span>&nbsp;<span class="ident" id="5364934">newStructEncoder</span><span class="op" id="5364950">(</span><span class="ident" id="5364951">t</span>&nbsp;<span class="ident" id="5364953">reflect</span><span class="op" id="5364960">.</span><span class="ident" id="5364961">Type</span><span class="op" id="5364965">)</span>&nbsp;<span class="ident" id="5364967">encoderFunc</span>&nbsp;<span class="op" id="5364979">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5364982">fields</span>&nbsp;<span class="op" id="5364989">:=</span>&nbsp;<span class="ident" id="5364992">cachedTypeFields</span><span class="op" id="5365008">(</span><span class="ident" id="5365009">t</span><span class="op" id="5365010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365013">se</span>&nbsp;<span class="op" id="5365016">:=</span>&nbsp;<span class="op" id="5365019">&amp;</span><span class="ident" id="5365020">structEncoder</span><span class="op" id="5365033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365037">fields</span><span class="op" id="5365043">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5365048">fields</span><span class="op" id="5365054">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365058">fieldEncs</span><span class="op" id="5365067">:</span>&nbsp;<span class="builtinfunc" id="5365069">make</span><span class="op" id="5365073">(</span><span class="op" id="5365074">[</span><span class="op" id="5365075">]</span><span class="ident" id="5365076">encoderFunc</span><span class="op" id="5365087">,</span>&nbsp;<span class="builtinfunc" id="5365089">len</span><span class="op" id="5365092">(</span><span class="ident" id="5365093">fields</span><span class="op" id="5365099">)</span><span class="op" id="5365100">)</span><span class="op" id="5365101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365104">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365107">for</span>&nbsp;<span class="ident" id="5365111">i</span><span class="op" id="5365112">,</span>&nbsp;<span class="ident" id="5365114">f</span>&nbsp;<span class="op" id="5365116">:=</span>&nbsp;<span class="keyword" id="5365119">range</span>&nbsp;<span class="ident" id="5365125">fields</span>&nbsp;<span class="op" id="5365132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365136">se</span><span class="op" id="5365138">.</span><span class="ident" id="5365139">fieldEncs</span><span class="op" id="5365148">[</span><span class="ident" id="5365149">i</span><span class="op" id="5365150">]</span>&nbsp;<span class="op" id="5365152">=</span>&nbsp;<span class="ident" id="5365154">typeEncoder</span><span class="op" id="5365165">(</span><span class="ident" id="5365166">typeByIndex</span><span class="op" id="5365177">(</span><span class="ident" id="5365178">t</span><span class="op" id="5365179">,</span>&nbsp;<span class="ident" id="5365181">f</span><span class="op" id="5365182">.</span><span class="ident" id="5365183">index</span><span class="op" id="5365188">)</span><span class="op" id="5365189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365195">return</span>&nbsp;<span class="ident" id="5365202">se</span><span class="op" id="5365204">.</span><span class="ident" id="5365205">encode</span><br>
<span class="lineno"></span><span class="op" id="5365212">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="5365215">type</span>&nbsp;<span class="ident" id="5365220">mapEncoder</span>&nbsp;<span class="keyword" id="5365231">struct</span>&nbsp;<span class="op" id="5365238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365241">elemEnc</span>&nbsp;<span class="ident" id="5365249">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5365261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="5365264">func</span>&nbsp;<span class="op" id="5365269">(</span><span class="ident" id="5365270">me</span>&nbsp;<span class="op" id="5365273">*</span><span class="ident" id="5365274">mapEncoder</span><span class="op" id="5365284">)</span>&nbsp;<span class="ident" id="5365286">encode</span><span class="op" id="5365292">(</span><span class="ident" id="5365293">e</span>&nbsp;<span class="op" id="5365295">*</span><span class="ident" id="5365296">encodeState</span><span class="op" id="5365307">,</span>&nbsp;<span class="ident" id="5365309">v</span>&nbsp;<span class="ident" id="5365311">reflect</span><span class="op" id="5365318">.</span><span class="ident" id="5365319">Value</span><span class="op" id="5365324">,</span>&nbsp;<span class="ident" id="5365326">_</span>&nbsp;<span class="builtintype" id="5365328">bool</span><span class="op" id="5365332">)</span>&nbsp;<span class="op" id="5365334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365337">if</span>&nbsp;<span class="ident" id="5365340">v</span><span class="op" id="5365341">.</span><span class="ident" id="5365342">IsNil</span><span class="op" id="5365347">(</span><span class="op" id="5365348">)</span>&nbsp;<span class="op" id="5365350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365354">e</span><span class="op" id="5365355">.</span><span class="ident" id="5365356">WriteString</span><span class="op" id="5365367">(</span><span class="string" id="5365368">&#34;null&#34;</span><span class="op" id="5365374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365378">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365386">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365389">e</span><span class="op" id="5365390">.</span><span class="ident" id="5365391">WriteByte</span><span class="op" id="5365400">(</span><span class="string" id="5365401">&#39;{&#39;</span><span class="op" id="5365404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365407">var</span>&nbsp;<span class="ident" id="5365411">sv</span>&nbsp;<span class="ident" id="5365414">stringValues</span>&nbsp;<span class="op" id="5365427">=</span>&nbsp;<span class="ident" id="5365429">v</span><span class="op" id="5365430">.</span><span class="ident" id="5365431">MapKeys</span><span class="op" id="5365438">(</span><span class="op" id="5365439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365442">sort</span><span class="op" id="5365446">.</span><span class="ident" id="5365447">Sort</span><span class="op" id="5365451">(</span><span class="ident" id="5365452">sv</span><span class="op" id="5365454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365457">for</span>&nbsp;<span class="ident" id="5365461">i</span><span class="op" id="5365462">,</span>&nbsp;<span class="ident" id="5365464">k</span>&nbsp;<span class="op" id="5365466">:=</span>&nbsp;<span class="keyword" id="5365469">range</span>&nbsp;<span class="ident" id="5365475">sv</span>&nbsp;<span class="op" id="5365478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365482">if</span>&nbsp;<span class="ident" id="5365485">i</span>&nbsp;<span class="op" id="5365487">&gt;</span>&nbsp;<span class="num" id="5365489">0</span>&nbsp;<span class="op" id="5365491">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365496">e</span><span class="op" id="5365497">.</span><span class="ident" id="5365498">WriteByte</span><span class="op" id="5365507">(</span><span class="string" id="5365508">&#39;,&#39;</span><span class="op" id="5365511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365519">e</span><span class="op" id="5365520">.</span><span class="builtintype" id="5365521">string</span><span class="op" id="5365527">(</span><span class="ident" id="5365528">k</span><span class="op" id="5365529">.</span><span class="ident" id="5365530">String</span><span class="op" id="5365536">(</span><span class="op" id="5365537">)</span><span class="op" id="5365538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365542">e</span><span class="op" id="5365543">.</span><span class="ident" id="5365544">WriteByte</span><span class="op" id="5365553">(</span><span class="string" id="5365554">&#39;:&#39;</span><span class="op" id="5365557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365561">me</span><span class="op" id="5365563">.</span><span class="ident" id="5365564">elemEnc</span><span class="op" id="5365571">(</span><span class="ident" id="5365572">e</span><span class="op" id="5365573">,</span>&nbsp;<span class="ident" id="5365575">v</span><span class="op" id="5365576">.</span><span class="ident" id="5365577">MapIndex</span><span class="op" id="5365585">(</span><span class="ident" id="5365586">k</span><span class="op" id="5365587">)</span><span class="op" id="5365588">,</span>&nbsp;<span class="builtintype" id="5365590">false</span><span class="op" id="5365595">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365601">e</span><span class="op" id="5365602">.</span><span class="ident" id="5365603">WriteByte</span><span class="op" id="5365612">(</span><span class="string" id="5365613">&#39;}&#39;</span><span class="op" id="5365616">)</span><br>
<span class="lineno"></span><span class="op" id="5365618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5365621">func</span>&nbsp;<span class="ident" id="5365626">newMapEncoder</span><span class="op" id="5365639">(</span><span class="ident" id="5365640">t</span>&nbsp;<span class="ident" id="5365642">reflect</span><span class="op" id="5365649">.</span><span class="ident" id="5365650">Type</span><span class="op" id="5365654">)</span>&nbsp;<span class="ident" id="5365656">encoderFunc</span>&nbsp;<span class="op" id="5365668">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365671">if</span>&nbsp;<span class="ident" id="5365674">t</span><span class="op" id="5365675">.</span><span class="ident" id="5365676">Key</span><span class="op" id="5365679">(</span><span class="op" id="5365680">)</span><span class="op" id="5365681">.</span><span class="ident" id="5365682">Kind</span><span class="op" id="5365686">(</span><span class="op" id="5365687">)</span>&nbsp;<span class="op" id="5365689">!=</span>&nbsp;<span class="ident" id="5365692">reflect</span><span class="op" id="5365699">.</span><span class="ident" id="5365700">String</span>&nbsp;<span class="op" id="5365707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365711">return</span>&nbsp;<span class="ident" id="5365718">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365745">me</span>&nbsp;<span class="op" id="5365748">:=</span>&nbsp;<span class="op" id="5365751">&amp;</span><span class="ident" id="5365752">mapEncoder</span><span class="op" id="5365762">{</span><span class="ident" id="5365763">typeEncoder</span><span class="op" id="5365774">(</span><span class="ident" id="5365775">t</span><span class="op" id="5365776">.</span><span class="ident" id="5365777">Elem</span><span class="op" id="5365781">(</span><span class="op" id="5365782">)</span><span class="op" id="5365783">)</span><span class="op" id="5365784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365787">return</span>&nbsp;<span class="ident" id="5365794">me</span><span class="op" id="5365796">.</span><span class="ident" id="5365797">encode</span><br>
<span class="lineno">630</span><span class="op" id="5365804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5365807">func</span>&nbsp;<span class="ident" id="5365812">encodeByteSlice</span><span class="op" id="5365827">(</span><span class="ident" id="5365828">e</span>&nbsp;<span class="op" id="5365830">*</span><span class="ident" id="5365831">encodeState</span><span class="op" id="5365842">,</span>&nbsp;<span class="ident" id="5365844">v</span>&nbsp;<span class="ident" id="5365846">reflect</span><span class="op" id="5365853">.</span><span class="ident" id="5365854">Value</span><span class="op" id="5365859">,</span>&nbsp;<span class="ident" id="5365861">_</span>&nbsp;<span class="builtintype" id="5365863">bool</span><span class="op" id="5365867">)</span>&nbsp;<span class="op" id="5365869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365872">if</span>&nbsp;<span class="ident" id="5365875">v</span><span class="op" id="5365876">.</span><span class="ident" id="5365877">IsNil</span><span class="op" id="5365882">(</span><span class="op" id="5365883">)</span>&nbsp;<span class="op" id="5365885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365889">e</span><span class="op" id="5365890">.</span><span class="ident" id="5365891">WriteString</span><span class="op" id="5365902">(</span><span class="string" id="5365903">&#34;null&#34;</span><span class="op" id="5365909">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365913">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5365921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365924">s</span>&nbsp;<span class="op" id="5365926">:=</span>&nbsp;<span class="ident" id="5365929">v</span><span class="op" id="5365930">.</span><span class="ident" id="5365931">Bytes</span><span class="op" id="5365936">(</span><span class="op" id="5365937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365940">e</span><span class="op" id="5365941">.</span><span class="ident" id="5365942">WriteByte</span><span class="op" id="5365951">(</span><span class="string" id="5365952">&#39;&#34;&#39;</span><span class="op" id="5365955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5365958">if</span>&nbsp;<span class="builtinfunc" id="5365961">len</span><span class="op" id="5365964">(</span><span class="ident" id="5365965">s</span><span class="op" id="5365966">)</span>&nbsp;<span class="op" id="5365968">&lt;</span>&nbsp;<span class="num" id="5365970">1024</span>&nbsp;<span class="op" id="5365975">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5365979">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366041">dst</span>&nbsp;<span class="op" id="5366045">:=</span>&nbsp;<span class="builtinfunc" id="5366048">make</span><span class="op" id="5366052">(</span><span class="op" id="5366053">[</span><span class="op" id="5366054">]</span><span class="builtintype" id="5366055">byte</span><span class="op" id="5366059">,</span>&nbsp;<span class="ident" id="5366061">base64</span><span class="op" id="5366067">.</span><span class="ident" id="5366068">StdEncoding</span><span class="op" id="5366079">.</span><span class="ident" id="5366080">EncodedLen</span><span class="op" id="5366090">(</span><span class="builtinfunc" id="5366091">len</span><span class="op" id="5366094">(</span><span class="ident" id="5366095">s</span><span class="op" id="5366096">)</span><span class="op" id="5366097">)</span><span class="op" id="5366098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366102">base64</span><span class="op" id="5366108">.</span><span class="ident" id="5366109">StdEncoding</span><span class="op" id="5366120">.</span><span class="ident" id="5366121">Encode</span><span class="op" id="5366127">(</span><span class="ident" id="5366128">dst</span><span class="op" id="5366131">,</span>&nbsp;<span class="ident" id="5366133">s</span><span class="op" id="5366134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366138">e</span><span class="op" id="5366139">.</span><span class="ident" id="5366140">Write</span><span class="op" id="5366145">(</span><span class="ident" id="5366146">dst</span><span class="op" id="5366149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366152">}</span>&nbsp;<span class="keyword" id="5366154">else</span>&nbsp;<span class="op" id="5366159">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5366163">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5366221">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366240">enc</span>&nbsp;<span class="op" id="5366244">:=</span>&nbsp;<span class="ident" id="5366247">base64</span><span class="op" id="5366253">.</span><span class="ident" id="5366254">NewEncoder</span><span class="op" id="5366264">(</span><span class="ident" id="5366265">base64</span><span class="op" id="5366271">.</span><span class="ident" id="5366272">StdEncoding</span><span class="op" id="5366283">,</span>&nbsp;<span class="ident" id="5366285">e</span><span class="op" id="5366286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366290">enc</span><span class="op" id="5366293">.</span><span class="ident" id="5366294">Write</span><span class="op" id="5366299">(</span><span class="ident" id="5366300">s</span><span class="op" id="5366301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366305">enc</span><span class="op" id="5366308">.</span><span class="ident" id="5366309">Close</span><span class="op" id="5366314">(</span><span class="op" id="5366315">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366321">e</span><span class="op" id="5366322">.</span><span class="ident" id="5366323">WriteByte</span><span class="op" id="5366332">(</span><span class="string" id="5366333">&#39;&#34;&#39;</span><span class="op" id="5366336">)</span><br>
<span class="lineno"></span><span class="op" id="5366338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366341">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="5366428">type</span>&nbsp;<span class="ident" id="5366433">sliceEncoder</span>&nbsp;<span class="keyword" id="5366446">struct</span>&nbsp;<span class="op" id="5366453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366456">arrayEnc</span>&nbsp;<span class="ident" id="5366465">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5366477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5366480">func</span>&nbsp;<span class="op" id="5366485">(</span><span class="ident" id="5366486">se</span>&nbsp;<span class="op" id="5366489">*</span><span class="ident" id="5366490">sliceEncoder</span><span class="op" id="5366502">)</span>&nbsp;<span class="ident" id="5366504">encode</span><span class="op" id="5366510">(</span><span class="ident" id="5366511">e</span>&nbsp;<span class="op" id="5366513">*</span><span class="ident" id="5366514">encodeState</span><span class="op" id="5366525">,</span>&nbsp;<span class="ident" id="5366527">v</span>&nbsp;<span class="ident" id="5366529">reflect</span><span class="op" id="5366536">.</span><span class="ident" id="5366537">Value</span><span class="op" id="5366542">,</span>&nbsp;<span class="ident" id="5366544">_</span>&nbsp;<span class="builtintype" id="5366546">bool</span><span class="op" id="5366550">)</span>&nbsp;<span class="op" id="5366552">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366555">if</span>&nbsp;<span class="ident" id="5366558">v</span><span class="op" id="5366559">.</span><span class="ident" id="5366560">IsNil</span><span class="op" id="5366565">(</span><span class="op" id="5366566">)</span>&nbsp;<span class="op" id="5366568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366572">e</span><span class="op" id="5366573">.</span><span class="ident" id="5366574">WriteString</span><span class="op" id="5366585">(</span><span class="string" id="5366586">&#34;null&#34;</span><span class="op" id="5366592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366596">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366607">se</span><span class="op" id="5366609">.</span><span class="ident" id="5366610">arrayEnc</span><span class="op" id="5366618">(</span><span class="ident" id="5366619">e</span><span class="op" id="5366620">,</span>&nbsp;<span class="ident" id="5366622">v</span><span class="op" id="5366623">,</span>&nbsp;<span class="builtintype" id="5366625">false</span><span class="op" id="5366630">)</span><br>
<span class="lineno">665</span><span class="op" id="5366632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5366635">func</span>&nbsp;<span class="ident" id="5366640">newSliceEncoder</span><span class="op" id="5366655">(</span><span class="ident" id="5366656">t</span>&nbsp;<span class="ident" id="5366658">reflect</span><span class="op" id="5366665">.</span><span class="ident" id="5366666">Type</span><span class="op" id="5366670">)</span>&nbsp;<span class="ident" id="5366672">encoderFunc</span>&nbsp;<span class="op" id="5366684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5366687">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366740">if</span>&nbsp;<span class="ident" id="5366743">t</span><span class="op" id="5366744">.</span><span class="ident" id="5366745">Elem</span><span class="op" id="5366749">(</span><span class="op" id="5366750">)</span><span class="op" id="5366751">.</span><span class="ident" id="5366752">Kind</span><span class="op" id="5366756">(</span><span class="op" id="5366757">)</span>&nbsp;<span class="op" id="5366759">==</span>&nbsp;<span class="ident" id="5366762">reflect</span><span class="op" id="5366769">.</span><span class="ident" id="5366770">Uint8</span>&nbsp;<span class="op" id="5366776">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366780">return</span>&nbsp;<span class="ident" id="5366787">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366807">enc</span>&nbsp;<span class="op" id="5366811">:=</span>&nbsp;<span class="op" id="5366814">&amp;</span><span class="ident" id="5366815">sliceEncoder</span><span class="op" id="5366827">{</span><span class="ident" id="5366828">newArrayEncoder</span><span class="op" id="5366843">(</span><span class="ident" id="5366844">t</span><span class="op" id="5366845">)</span><span class="op" id="5366846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366849">return</span>&nbsp;<span class="ident" id="5366856">enc</span><span class="op" id="5366859">.</span><span class="ident" id="5366860">encode</span><br>
<span class="lineno"></span><span class="op" id="5366867">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="5366870">type</span>&nbsp;<span class="ident" id="5366875">arrayEncoder</span>&nbsp;<span class="keyword" id="5366888">struct</span>&nbsp;<span class="op" id="5366895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366898">elemEnc</span>&nbsp;<span class="ident" id="5366906">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5366918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="5366921">func</span>&nbsp;<span class="op" id="5366926">(</span><span class="ident" id="5366927">ae</span>&nbsp;<span class="op" id="5366930">*</span><span class="ident" id="5366931">arrayEncoder</span><span class="op" id="5366943">)</span>&nbsp;<span class="ident" id="5366945">encode</span><span class="op" id="5366951">(</span><span class="ident" id="5366952">e</span>&nbsp;<span class="op" id="5366954">*</span><span class="ident" id="5366955">encodeState</span><span class="op" id="5366966">,</span>&nbsp;<span class="ident" id="5366968">v</span>&nbsp;<span class="ident" id="5366970">reflect</span><span class="op" id="5366977">.</span><span class="ident" id="5366978">Value</span><span class="op" id="5366983">,</span>&nbsp;<span class="ident" id="5366985">_</span>&nbsp;<span class="builtintype" id="5366987">bool</span><span class="op" id="5366991">)</span>&nbsp;<span class="op" id="5366993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366996">e</span><span class="op" id="5366997">.</span><span class="ident" id="5366998">WriteByte</span><span class="op" id="5367007">(</span><span class="string" id="5367008">&#39;[&#39;</span><span class="op" id="5367011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367014">n</span>&nbsp;<span class="op" id="5367016">:=</span>&nbsp;<span class="ident" id="5367019">v</span><span class="op" id="5367020">.</span><span class="ident" id="5367021">Len</span><span class="op" id="5367024">(</span><span class="op" id="5367025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367028">for</span>&nbsp;<span class="ident" id="5367032">i</span>&nbsp;<span class="op" id="5367034">:=</span>&nbsp;<span class="num" id="5367037">0</span><span class="op" id="5367038">;</span>&nbsp;<span class="ident" id="5367040">i</span>&nbsp;<span class="op" id="5367042">&lt;</span>&nbsp;<span class="ident" id="5367044">n</span><span class="op" id="5367045">;</span>&nbsp;<span class="ident" id="5367047">i</span><span class="op" id="5367048">++</span>&nbsp;<span class="op" id="5367051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367055">if</span>&nbsp;<span class="ident" id="5367058">i</span>&nbsp;<span class="op" id="5367060">&gt;</span>&nbsp;<span class="num" id="5367062">0</span>&nbsp;<span class="op" id="5367064">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367069">e</span><span class="op" id="5367070">.</span><span class="ident" id="5367071">WriteByte</span><span class="op" id="5367080">(</span><span class="string" id="5367081">&#39;,&#39;</span><span class="op" id="5367084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367092">ae</span><span class="op" id="5367094">.</span><span class="ident" id="5367095">elemEnc</span><span class="op" id="5367102">(</span><span class="ident" id="5367103">e</span><span class="op" id="5367104">,</span>&nbsp;<span class="ident" id="5367106">v</span><span class="op" id="5367107">.</span><span class="ident" id="5367108">Index</span><span class="op" id="5367113">(</span><span class="ident" id="5367114">i</span><span class="op" id="5367115">)</span><span class="op" id="5367116">,</span>&nbsp;<span class="builtintype" id="5367118">false</span><span class="op" id="5367123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367129">e</span><span class="op" id="5367130">.</span><span class="ident" id="5367131">WriteByte</span><span class="op" id="5367140">(</span><span class="string" id="5367141">&#39;]&#39;</span><span class="op" id="5367144">)</span><br>
<span class="lineno">690</span><span class="op" id="5367146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5367149">func</span>&nbsp;<span class="ident" id="5367154">newArrayEncoder</span><span class="op" id="5367169">(</span><span class="ident" id="5367170">t</span>&nbsp;<span class="ident" id="5367172">reflect</span><span class="op" id="5367179">.</span><span class="ident" id="5367180">Type</span><span class="op" id="5367184">)</span>&nbsp;<span class="ident" id="5367186">encoderFunc</span>&nbsp;<span class="op" id="5367198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367201">enc</span>&nbsp;<span class="op" id="5367205">:=</span>&nbsp;<span class="op" id="5367208">&amp;</span><span class="ident" id="5367209">arrayEncoder</span><span class="op" id="5367221">{</span><span class="ident" id="5367222">typeEncoder</span><span class="op" id="5367233">(</span><span class="ident" id="5367234">t</span><span class="op" id="5367235">.</span><span class="ident" id="5367236">Elem</span><span class="op" id="5367240">(</span><span class="op" id="5367241">)</span><span class="op" id="5367242">)</span><span class="op" id="5367243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367246">return</span>&nbsp;<span class="ident" id="5367253">enc</span><span class="op" id="5367256">.</span><span class="ident" id="5367257">encode</span><br>
<span class="lineno">695</span><span class="op" id="5367264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5367267">type</span>&nbsp;<span class="ident" id="5367272">ptrEncoder</span>&nbsp;<span class="keyword" id="5367283">struct</span>&nbsp;<span class="op" id="5367290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367293">elemEnc</span>&nbsp;<span class="ident" id="5367301">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5367313">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="5367316">func</span>&nbsp;<span class="op" id="5367321">(</span><span class="ident" id="5367322">pe</span>&nbsp;<span class="op" id="5367325">*</span><span class="ident" id="5367326">ptrEncoder</span><span class="op" id="5367336">)</span>&nbsp;<span class="ident" id="5367338">encode</span><span class="op" id="5367344">(</span><span class="ident" id="5367345">e</span>&nbsp;<span class="op" id="5367347">*</span><span class="ident" id="5367348">encodeState</span><span class="op" id="5367359">,</span>&nbsp;<span class="ident" id="5367361">v</span>&nbsp;<span class="ident" id="5367363">reflect</span><span class="op" id="5367370">.</span><span class="ident" id="5367371">Value</span><span class="op" id="5367376">,</span>&nbsp;<span class="ident" id="5367378">quoted</span>&nbsp;<span class="builtintype" id="5367385">bool</span><span class="op" id="5367389">)</span>&nbsp;<span class="op" id="5367391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367394">if</span>&nbsp;<span class="ident" id="5367397">v</span><span class="op" id="5367398">.</span><span class="ident" id="5367399">IsNil</span><span class="op" id="5367404">(</span><span class="op" id="5367405">)</span>&nbsp;<span class="op" id="5367407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367411">e</span><span class="op" id="5367412">.</span><span class="ident" id="5367413">WriteString</span><span class="op" id="5367424">(</span><span class="string" id="5367425">&#34;null&#34;</span><span class="op" id="5367431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367435">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367446">pe</span><span class="op" id="5367448">.</span><span class="ident" id="5367449">elemEnc</span><span class="op" id="5367456">(</span><span class="ident" id="5367457">e</span><span class="op" id="5367458">,</span>&nbsp;<span class="ident" id="5367460">v</span><span class="op" id="5367461">.</span><span class="ident" id="5367462">Elem</span><span class="op" id="5367466">(</span><span class="op" id="5367467">)</span><span class="op" id="5367468">,</span>&nbsp;<span class="ident" id="5367470">quoted</span><span class="op" id="5367476">)</span><br>
<span class="lineno"></span><span class="op" id="5367478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5367481">func</span>&nbsp;<span class="ident" id="5367486">newPtrEncoder</span><span class="op" id="5367499">(</span><span class="ident" id="5367500">t</span>&nbsp;<span class="ident" id="5367502">reflect</span><span class="op" id="5367509">.</span><span class="ident" id="5367510">Type</span><span class="op" id="5367514">)</span>&nbsp;<span class="ident" id="5367516">encoderFunc</span>&nbsp;<span class="op" id="5367528">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367531">enc</span>&nbsp;<span class="op" id="5367535">:=</span>&nbsp;<span class="op" id="5367538">&amp;</span><span class="ident" id="5367539">ptrEncoder</span><span class="op" id="5367549">{</span><span class="ident" id="5367550">typeEncoder</span><span class="op" id="5367561">(</span><span class="ident" id="5367562">t</span><span class="op" id="5367563">.</span><span class="ident" id="5367564">Elem</span><span class="op" id="5367568">(</span><span class="op" id="5367569">)</span><span class="op" id="5367570">)</span><span class="op" id="5367571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367574">return</span>&nbsp;<span class="ident" id="5367581">enc</span><span class="op" id="5367584">.</span><span class="ident" id="5367585">encode</span><br>
<span class="lineno"></span><span class="op" id="5367592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5367595">type</span>&nbsp;<span class="ident" id="5367600">condAddrEncoder</span>&nbsp;<span class="keyword" id="5367616">struct</span>&nbsp;<span class="op" id="5367623">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367626">canAddrEnc</span><span class="op" id="5367636">,</span>&nbsp;<span class="ident" id="5367638">elseEnc</span>&nbsp;<span class="ident" id="5367646">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5367658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5367661">func</span>&nbsp;<span class="op" id="5367666">(</span><span class="ident" id="5367667">ce</span>&nbsp;<span class="op" id="5367670">*</span><span class="ident" id="5367671">condAddrEncoder</span><span class="op" id="5367686">)</span>&nbsp;<span class="ident" id="5367688">encode</span><span class="op" id="5367694">(</span><span class="ident" id="5367695">e</span>&nbsp;<span class="op" id="5367697">*</span><span class="ident" id="5367698">encodeState</span><span class="op" id="5367709">,</span>&nbsp;<span class="ident" id="5367711">v</span>&nbsp;<span class="ident" id="5367713">reflect</span><span class="op" id="5367720">.</span><span class="ident" id="5367721">Value</span><span class="op" id="5367726">,</span>&nbsp;<span class="ident" id="5367728">quoted</span>&nbsp;<span class="builtintype" id="5367735">bool</span><span class="op" id="5367739">)</span>&nbsp;<span class="op" id="5367741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367744">if</span>&nbsp;<span class="ident" id="5367747">v</span><span class="op" id="5367748">.</span><span class="ident" id="5367749">CanAddr</span><span class="op" id="5367756">(</span><span class="op" id="5367757">)</span>&nbsp;<span class="op" id="5367759">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367763">ce</span><span class="op" id="5367765">.</span><span class="ident" id="5367766">canAddrEnc</span><span class="op" id="5367776">(</span><span class="ident" id="5367777">e</span><span class="op" id="5367778">,</span>&nbsp;<span class="ident" id="5367780">v</span><span class="op" id="5367781">,</span>&nbsp;<span class="ident" id="5367783">quoted</span><span class="op" id="5367789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367792">}</span>&nbsp;<span class="keyword" id="5367794">else</span>&nbsp;<span class="op" id="5367799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367803">ce</span><span class="op" id="5367805">.</span><span class="ident" id="5367806">elseEnc</span><span class="op" id="5367813">(</span><span class="ident" id="5367814">e</span><span class="op" id="5367815">,</span>&nbsp;<span class="ident" id="5367817">v</span><span class="op" id="5367818">,</span>&nbsp;<span class="ident" id="5367820">quoted</span><span class="op" id="5367826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367829">}</span><br>
<span class="lineno"></span><span class="op" id="5367831">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5367834">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5367905">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="5367968">func</span>&nbsp;<span class="ident" id="5367973">newCondAddrEncoder</span><span class="op" id="5367991">(</span><span class="ident" id="5367992">canAddrEnc</span><span class="op" id="5368002">,</span>&nbsp;<span class="ident" id="5368004">elseEnc</span>&nbsp;<span class="ident" id="5368012">encoderFunc</span><span class="op" id="5368023">)</span>&nbsp;<span class="ident" id="5368025">encoderFunc</span>&nbsp;<span class="op" id="5368037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368040">enc</span>&nbsp;<span class="op" id="5368044">:=</span>&nbsp;<span class="op" id="5368047">&amp;</span><span class="ident" id="5368048">condAddrEncoder</span><span class="op" id="5368063">{</span><span class="ident" id="5368064">canAddrEnc</span><span class="op" id="5368074">:</span>&nbsp;<span class="ident" id="5368076">canAddrEnc</span><span class="op" id="5368086">,</span>&nbsp;<span class="ident" id="5368088">elseEnc</span><span class="op" id="5368095">:</span>&nbsp;<span class="ident" id="5368097">elseEnc</span><span class="op" id="5368104">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368107">return</span>&nbsp;<span class="ident" id="5368114">enc</span><span class="op" id="5368117">.</span><span class="ident" id="5368118">encode</span><br>
<span class="lineno"></span><span class="op" id="5368125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5368128">func</span>&nbsp;<span class="ident" id="5368133">isValidTag</span><span class="op" id="5368143">(</span><span class="ident" id="5368144">s</span>&nbsp;<span class="builtintype" id="5368146">string</span><span class="op" id="5368152">)</span>&nbsp;<span class="builtintype" id="5368154">bool</span>&nbsp;<span class="op" id="5368159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368162">if</span>&nbsp;<span class="ident" id="5368165">s</span>&nbsp;<span class="op" id="5368167">==</span>&nbsp;<span class="string" id="5368170">&#34;&#34;</span>&nbsp;<span class="op" id="5368173">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368177">return</span>&nbsp;<span class="builtintype" id="5368184">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368194">for</span>&nbsp;<span class="ident" id="5368198">_</span><span class="op" id="5368199">,</span>&nbsp;<span class="ident" id="5368201">c</span>&nbsp;<span class="op" id="5368203">:=</span>&nbsp;<span class="keyword" id="5368206">range</span>&nbsp;<span class="ident" id="5368212">s</span>&nbsp;<span class="op" id="5368214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368218">switch</span>&nbsp;<span class="op" id="5368225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368229">case</span>&nbsp;<span class="ident" id="5368234">strings</span><span class="op" id="5368241">.</span><span class="ident" id="5368242">ContainsRune</span><span class="op" id="5368254">(</span><span class="string" id="5368255">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="5368284">,</span>&nbsp;<span class="ident" id="5368286">c</span><span class="op" id="5368287">)</span><span class="op" id="5368288">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5368293">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5368343">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5368393">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368413">default</span><span class="op" id="5368420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368425">if</span>&nbsp;<span class="op" id="5368428">!</span><span class="ident" id="5368429">unicode</span><span class="op" id="5368436">.</span><span class="ident" id="5368437">IsLetter</span><span class="op" id="5368445">(</span><span class="ident" id="5368446">c</span><span class="op" id="5368447">)</span>&nbsp;<span class="op" id="5368449">&amp;&amp;</span>&nbsp;<span class="op" id="5368452">!</span><span class="ident" id="5368453">unicode</span><span class="op" id="5368460">.</span><span class="ident" id="5368461">IsDigit</span><span class="op" id="5368468">(</span><span class="ident" id="5368469">c</span><span class="op" id="5368470">)</span>&nbsp;<span class="op" id="5368472">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368478">return</span>&nbsp;<span class="builtintype" id="5368485">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368504">return</span>&nbsp;<span class="builtintype" id="5368511">true</span><br>
<span class="lineno">750</span><span class="op" id="5368516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5368519">func</span>&nbsp;<span class="ident" id="5368524">fieldByIndex</span><span class="op" id="5368536">(</span><span class="ident" id="5368537">v</span>&nbsp;<span class="ident" id="5368539">reflect</span><span class="op" id="5368546">.</span><span class="ident" id="5368547">Value</span><span class="op" id="5368552">,</span>&nbsp;<span class="ident" id="5368554">index</span>&nbsp;<span class="op" id="5368560">[</span><span class="op" id="5368561">]</span><span class="builtintype" id="5368562">int</span><span class="op" id="5368565">)</span>&nbsp;<span class="ident" id="5368567">reflect</span><span class="op" id="5368574">.</span><span class="ident" id="5368575">Value</span>&nbsp;<span class="op" id="5368581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368584">for</span>&nbsp;<span class="ident" id="5368588">_</span><span class="op" id="5368589">,</span>&nbsp;<span class="ident" id="5368591">i</span>&nbsp;<span class="op" id="5368593">:=</span>&nbsp;<span class="keyword" id="5368596">range</span>&nbsp;<span class="ident" id="5368602">index</span>&nbsp;<span class="op" id="5368608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368612">if</span>&nbsp;<span class="ident" id="5368615">v</span><span class="op" id="5368616">.</span><span class="ident" id="5368617">Kind</span><span class="op" id="5368621">(</span><span class="op" id="5368622">)</span>&nbsp;<span class="op" id="5368624">==</span>&nbsp;<span class="ident" id="5368627">reflect</span><span class="op" id="5368634">.</span><span class="ident" id="5368635">Ptr</span>&nbsp;<span class="op" id="5368639">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368644">if</span>&nbsp;<span class="ident" id="5368647">v</span><span class="op" id="5368648">.</span><span class="ident" id="5368649">IsNil</span><span class="op" id="5368654">(</span><span class="op" id="5368655">)</span>&nbsp;<span class="op" id="5368657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368663">return</span>&nbsp;<span class="ident" id="5368670">reflect</span><span class="op" id="5368677">.</span><span class="ident" id="5368678">Value</span><span class="op" id="5368683">{</span><span class="op" id="5368684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368694">v</span>&nbsp;<span class="op" id="5368696">=</span>&nbsp;<span class="ident" id="5368698">v</span><span class="op" id="5368699">.</span><span class="ident" id="5368700">Elem</span><span class="op" id="5368704">(</span><span class="op" id="5368705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368709">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368713">v</span>&nbsp;<span class="op" id="5368715">=</span>&nbsp;<span class="ident" id="5368717">v</span><span class="op" id="5368718">.</span><span class="ident" id="5368719">Field</span><span class="op" id="5368724">(</span><span class="ident" id="5368725">i</span><span class="op" id="5368726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368732">return</span>&nbsp;<span class="ident" id="5368739">v</span><br>
<span class="lineno"></span><span class="op" id="5368741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="5368744">func</span>&nbsp;<span class="ident" id="5368749">typeByIndex</span><span class="op" id="5368760">(</span><span class="ident" id="5368761">t</span>&nbsp;<span class="ident" id="5368763">reflect</span><span class="op" id="5368770">.</span><span class="ident" id="5368771">Type</span><span class="op" id="5368775">,</span>&nbsp;<span class="ident" id="5368777">index</span>&nbsp;<span class="op" id="5368783">[</span><span class="op" id="5368784">]</span><span class="builtintype" id="5368785">int</span><span class="op" id="5368788">)</span>&nbsp;<span class="ident" id="5368790">reflect</span><span class="op" id="5368797">.</span><span class="ident" id="5368798">Type</span>&nbsp;<span class="op" id="5368803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368806">for</span>&nbsp;<span class="ident" id="5368810">_</span><span class="op" id="5368811">,</span>&nbsp;<span class="ident" id="5368813">i</span>&nbsp;<span class="op" id="5368815">:=</span>&nbsp;<span class="keyword" id="5368818">range</span>&nbsp;<span class="ident" id="5368824">index</span>&nbsp;<span class="op" id="5368830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368834">if</span>&nbsp;<span class="ident" id="5368837">t</span><span class="op" id="5368838">.</span><span class="ident" id="5368839">Kind</span><span class="op" id="5368843">(</span><span class="op" id="5368844">)</span>&nbsp;<span class="op" id="5368846">==</span>&nbsp;<span class="ident" id="5368849">reflect</span><span class="op" id="5368856">.</span><span class="ident" id="5368857">Ptr</span>&nbsp;<span class="op" id="5368861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368866">t</span>&nbsp;<span class="op" id="5368868">=</span>&nbsp;<span class="ident" id="5368870">t</span><span class="op" id="5368871">.</span><span class="ident" id="5368872">Elem</span><span class="op" id="5368876">(</span><span class="op" id="5368877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368881">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368885">t</span>&nbsp;<span class="op" id="5368887">=</span>&nbsp;<span class="ident" id="5368889">t</span><span class="op" id="5368890">.</span><span class="ident" id="5368891">Field</span><span class="op" id="5368896">(</span><span class="ident" id="5368897">i</span><span class="op" id="5368898">)</span><span class="op" id="5368899">.</span><span class="ident" id="5368900">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368909">return</span>&nbsp;<span class="ident" id="5368916">t</span><br>
<span class="lineno"></span><span class="op" id="5368918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="5368921">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="5368995">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5369043">type</span>&nbsp;<span class="ident" id="5369048">stringValues</span>&nbsp;<span class="op" id="5369061">[</span><span class="op" id="5369062">]</span><span class="ident" id="5369063">reflect</span><span class="op" id="5369070">.</span><span class="ident" id="5369071">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5369078">func</span>&nbsp;<span class="op" id="5369083">(</span><span class="ident" id="5369084">sv</span>&nbsp;<span class="ident" id="5369087">stringValues</span><span class="op" id="5369099">)</span>&nbsp;<span class="ident" id="5369101">Len</span><span class="op" id="5369104">(</span><span class="op" id="5369105">)</span>&nbsp;<span class="builtintype" id="5369107">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5369121">{</span>&nbsp;<span class="keyword" id="5369123">return</span>&nbsp;<span class="builtinfunc" id="5369130">len</span><span class="op" id="5369133">(</span><span class="ident" id="5369134">sv</span><span class="op" id="5369136">)</span>&nbsp;<span class="op" id="5369138">}</span><br>
<span class="lineno">780</span><span class="keyword" id="5369140">func</span>&nbsp;<span class="op" id="5369145">(</span><span class="ident" id="5369146">sv</span>&nbsp;<span class="ident" id="5369149">stringValues</span><span class="op" id="5369161">)</span>&nbsp;<span class="ident" id="5369163">Swap</span><span class="op" id="5369167">(</span><span class="ident" id="5369168">i</span><span class="op" id="5369169">,</span>&nbsp;<span class="ident" id="5369171">j</span>&nbsp;<span class="builtintype" id="5369173">int</span><span class="op" id="5369176">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5369183">{</span>&nbsp;<span class="ident" id="5369185">sv</span><span class="op" id="5369187">[</span><span class="ident" id="5369188">i</span><span class="op" id="5369189">]</span><span class="op" id="5369190">,</span>&nbsp;<span class="ident" id="5369192">sv</span><span class="op" id="5369194">[</span><span class="ident" id="5369195">j</span><span class="op" id="5369196">]</span>&nbsp;<span class="op" id="5369198">=</span>&nbsp;<span class="ident" id="5369200">sv</span><span class="op" id="5369202">[</span><span class="ident" id="5369203">j</span><span class="op" id="5369204">]</span><span class="op" id="5369205">,</span>&nbsp;<span class="ident" id="5369207">sv</span><span class="op" id="5369209">[</span><span class="ident" id="5369210">i</span><span class="op" id="5369211">]</span>&nbsp;<span class="op" id="5369213">}</span><br>
<span class="lineno"></span><span class="keyword" id="5369215">func</span>&nbsp;<span class="op" id="5369220">(</span><span class="ident" id="5369221">sv</span>&nbsp;<span class="ident" id="5369224">stringValues</span><span class="op" id="5369236">)</span>&nbsp;<span class="ident" id="5369238">Less</span><span class="op" id="5369242">(</span><span class="ident" id="5369243">i</span><span class="op" id="5369244">,</span>&nbsp;<span class="ident" id="5369246">j</span>&nbsp;<span class="builtintype" id="5369248">int</span><span class="op" id="5369251">)</span>&nbsp;<span class="builtintype" id="5369253">bool</span>&nbsp;<span class="op" id="5369258">{</span>&nbsp;<span class="keyword" id="5369260">return</span>&nbsp;<span class="ident" id="5369267">sv</span><span class="op" id="5369269">.</span><span class="ident" id="5369270">get</span><span class="op" id="5369273">(</span><span class="ident" id="5369274">i</span><span class="op" id="5369275">)</span>&nbsp;<span class="op" id="5369277">&lt;</span>&nbsp;<span class="ident" id="5369279">sv</span><span class="op" id="5369281">.</span><span class="ident" id="5369282">get</span><span class="op" id="5369285">(</span><span class="ident" id="5369286">j</span><span class="op" id="5369287">)</span>&nbsp;<span class="op" id="5369289">}</span><br>
<span class="lineno"></span><span class="keyword" id="5369291">func</span>&nbsp;<span class="op" id="5369296">(</span><span class="ident" id="5369297">sv</span>&nbsp;<span class="ident" id="5369300">stringValues</span><span class="op" id="5369312">)</span>&nbsp;<span class="ident" id="5369314">get</span><span class="op" id="5369317">(</span><span class="ident" id="5369318">i</span>&nbsp;<span class="builtintype" id="5369320">int</span><span class="op" id="5369323">)</span>&nbsp;<span class="builtintype" id="5369325">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5369334">{</span>&nbsp;<span class="keyword" id="5369336">return</span>&nbsp;<span class="ident" id="5369343">sv</span><span class="op" id="5369345">[</span><span class="ident" id="5369346">i</span><span class="op" id="5369347">]</span><span class="op" id="5369348">.</span><span class="ident" id="5369349">String</span><span class="op" id="5369355">(</span><span class="op" id="5369356">)</span>&nbsp;<span class="op" id="5369358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5369361">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="5369407">func</span>&nbsp;<span class="op" id="5369412">(</span><span class="ident" id="5369413">e</span>&nbsp;<span class="op" id="5369415">*</span><span class="ident" id="5369416">encodeState</span><span class="op" id="5369427">)</span>&nbsp;<span class="builtintype" id="5369429">string</span><span class="op" id="5369435">(</span><span class="ident" id="5369436">s</span>&nbsp;<span class="builtintype" id="5369438">string</span><span class="op" id="5369444">)</span>&nbsp;<span class="op" id="5369446">(</span><span class="builtintype" id="5369447">int</span><span class="op" id="5369450">,</span>&nbsp;<span class="builtintype" id="5369452">error</span><span class="op" id="5369457">)</span>&nbsp;<span class="op" id="5369459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369462">len0</span>&nbsp;<span class="op" id="5369467">:=</span>&nbsp;<span class="ident" id="5369470">e</span><span class="op" id="5369471">.</span><span class="ident" id="5369472">Len</span><span class="op" id="5369475">(</span><span class="op" id="5369476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369479">e</span><span class="op" id="5369480">.</span><span class="ident" id="5369481">WriteByte</span><span class="op" id="5369490">(</span><span class="string" id="5369491">&#39;&#34;&#39;</span><span class="op" id="5369494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369497">start</span>&nbsp;<span class="op" id="5369503">:=</span>&nbsp;<span class="num" id="5369506">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369509">for</span>&nbsp;<span class="ident" id="5369513">i</span>&nbsp;<span class="op" id="5369515">:=</span>&nbsp;<span class="num" id="5369518">0</span><span class="op" id="5369519">;</span>&nbsp;<span class="ident" id="5369521">i</span>&nbsp;<span class="op" id="5369523">&lt;</span>&nbsp;<span class="builtinfunc" id="5369525">len</span><span class="op" id="5369528">(</span><span class="ident" id="5369529">s</span><span class="op" id="5369530">)</span><span class="op" id="5369531">;</span>&nbsp;<span class="op" id="5369533">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369537">if</span>&nbsp;<span class="ident" id="5369540">b</span>&nbsp;<span class="op" id="5369542">:=</span>&nbsp;<span class="ident" id="5369545">s</span><span class="op" id="5369546">[</span><span class="ident" id="5369547">i</span><span class="op" id="5369548">]</span><span class="op" id="5369549">;</span>&nbsp;<span class="ident" id="5369551">b</span>&nbsp;<span class="op" id="5369553">&lt;</span>&nbsp;<span class="ident" id="5369555">utf8</span><span class="op" id="5369559">.</span><span class="ident" id="5369560">RuneSelf</span>&nbsp;<span class="op" id="5369569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369574">if</span>&nbsp;<span class="num" id="5369577">0x20</span>&nbsp;<span class="op" id="5369582">&lt;=</span>&nbsp;<span class="ident" id="5369585">b</span>&nbsp;<span class="op" id="5369587">&amp;&amp;</span>&nbsp;<span class="ident" id="5369590">b</span>&nbsp;<span class="op" id="5369592">!=</span>&nbsp;<span class="string" id="5369595">&#39;\\&#39;</span>&nbsp;<span class="op" id="5369600">&amp;&amp;</span>&nbsp;<span class="ident" id="5369603">b</span>&nbsp;<span class="op" id="5369605">!=</span>&nbsp;<span class="string" id="5369608">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5369612">&amp;&amp;</span>&nbsp;<span class="ident" id="5369615">b</span>&nbsp;<span class="op" id="5369617">!=</span>&nbsp;<span class="string" id="5369620">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5369624">&amp;&amp;</span>&nbsp;<span class="ident" id="5369627">b</span>&nbsp;<span class="op" id="5369629">!=</span>&nbsp;<span class="string" id="5369632">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5369636">&amp;&amp;</span>&nbsp;<span class="ident" id="5369639">b</span>&nbsp;<span class="op" id="5369641">!=</span>&nbsp;<span class="string" id="5369644">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5369648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369654">i</span><span class="op" id="5369655">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369662">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369674">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369679">if</span>&nbsp;<span class="ident" id="5369682">start</span>&nbsp;<span class="op" id="5369688">&lt;</span>&nbsp;<span class="ident" id="5369690">i</span>&nbsp;<span class="op" id="5369692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369698">e</span><span class="op" id="5369699">.</span><span class="ident" id="5369700">WriteString</span><span class="op" id="5369711">(</span><span class="ident" id="5369712">s</span><span class="op" id="5369713">[</span><span class="ident" id="5369714">start</span><span class="op" id="5369719">:</span><span class="ident" id="5369720">i</span><span class="op" id="5369721">]</span><span class="op" id="5369722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369732">switch</span>&nbsp;<span class="ident" id="5369739">b</span>&nbsp;<span class="op" id="5369741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369746">case</span>&nbsp;<span class="string" id="5369751">&#39;\\&#39;</span><span class="op" id="5369755">,</span>&nbsp;<span class="string" id="5369757">&#39;&#34;&#39;</span><span class="op" id="5369760">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369766">e</span><span class="op" id="5369767">.</span><span class="ident" id="5369768">WriteByte</span><span class="op" id="5369777">(</span><span class="string" id="5369778">&#39;\\&#39;</span><span class="op" id="5369782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369788">e</span><span class="op" id="5369789">.</span><span class="ident" id="5369790">WriteByte</span><span class="op" id="5369799">(</span><span class="ident" id="5369800">b</span><span class="op" id="5369801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369806">case</span>&nbsp;<span class="string" id="5369811">&#39;\n&#39;</span><span class="op" id="5369815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369821">e</span><span class="op" id="5369822">.</span><span class="ident" id="5369823">WriteByte</span><span class="op" id="5369832">(</span><span class="string" id="5369833">&#39;\\&#39;</span><span class="op" id="5369837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369843">e</span><span class="op" id="5369844">.</span><span class="ident" id="5369845">WriteByte</span><span class="op" id="5369854">(</span><span class="string" id="5369855">&#39;n&#39;</span><span class="op" id="5369858">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369863">case</span>&nbsp;<span class="string" id="5369868">&#39;\r&#39;</span><span class="op" id="5369872">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369878">e</span><span class="op" id="5369879">.</span><span class="ident" id="5369880">WriteByte</span><span class="op" id="5369889">(</span><span class="string" id="5369890">&#39;\\&#39;</span><span class="op" id="5369894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369900">e</span><span class="op" id="5369901">.</span><span class="ident" id="5369902">WriteByte</span><span class="op" id="5369911">(</span><span class="string" id="5369912">&#39;r&#39;</span><span class="op" id="5369915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369920">case</span>&nbsp;<span class="string" id="5369925">&#39;\t&#39;</span><span class="op" id="5369929">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369935">e</span><span class="op" id="5369936">.</span><span class="ident" id="5369937">WriteByte</span><span class="op" id="5369946">(</span><span class="string" id="5369947">&#39;\\&#39;</span><span class="op" id="5369951">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369957">e</span><span class="op" id="5369958">.</span><span class="ident" id="5369959">WriteByte</span><span class="op" id="5369968">(</span><span class="string" id="5369969">&#39;t&#39;</span><span class="op" id="5369972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369977">default</span><span class="op" id="5369984">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369990">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370045">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370111">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370174">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370233">e</span><span class="op" id="5370234">.</span><span class="ident" id="5370235">WriteString</span><span class="op" id="5370246">(</span><span class="string" id="5370247">`\u00`</span><span class="op" id="5370253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370259">e</span><span class="op" id="5370260">.</span><span class="ident" id="5370261">WriteByte</span><span class="op" id="5370270">(</span><span class="ident" id="5370271">hex</span><span class="op" id="5370274">[</span><span class="ident" id="5370275">b</span><span class="op" id="5370276">&gt;&gt;</span><span class="num" id="5370278">4</span><span class="op" id="5370279">]</span><span class="op" id="5370280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370286">e</span><span class="op" id="5370287">.</span><span class="ident" id="5370288">WriteByte</span><span class="op" id="5370297">(</span><span class="ident" id="5370298">hex</span><span class="op" id="5370301">[</span><span class="ident" id="5370302">b</span><span class="op" id="5370303">&amp;</span><span class="num" id="5370304">0xF</span><span class="op" id="5370307">]</span><span class="op" id="5370308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370313">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370318">i</span><span class="op" id="5370319">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370325">start</span>&nbsp;<span class="op" id="5370331">=</span>&nbsp;<span class="ident" id="5370333">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370338">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370353">c</span><span class="op" id="5370354">,</span>&nbsp;<span class="ident" id="5370356">size</span>&nbsp;<span class="op" id="5370361">:=</span>&nbsp;<span class="ident" id="5370364">utf8</span><span class="op" id="5370368">.</span><span class="ident" id="5370369">DecodeRuneInString</span><span class="op" id="5370387">(</span><span class="ident" id="5370388">s</span><span class="op" id="5370389">[</span><span class="ident" id="5370390">i</span><span class="op" id="5370391">:</span><span class="op" id="5370392">]</span><span class="op" id="5370393">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370397">if</span>&nbsp;<span class="ident" id="5370400">c</span>&nbsp;<span class="op" id="5370402">==</span>&nbsp;<span class="ident" id="5370405">utf8</span><span class="op" id="5370409">.</span><span class="ident" id="5370410">RuneError</span>&nbsp;<span class="op" id="5370420">&amp;&amp;</span>&nbsp;<span class="ident" id="5370423">size</span>&nbsp;<span class="op" id="5370428">==</span>&nbsp;<span class="num" id="5370431">1</span>&nbsp;<span class="op" id="5370433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370438">if</span>&nbsp;<span class="ident" id="5370441">start</span>&nbsp;<span class="op" id="5370447">&lt;</span>&nbsp;<span class="ident" id="5370449">i</span>&nbsp;<span class="op" id="5370451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370457">e</span><span class="op" id="5370458">.</span><span class="ident" id="5370459">WriteString</span><span class="op" id="5370470">(</span><span class="ident" id="5370471">s</span><span class="op" id="5370472">[</span><span class="ident" id="5370473">start</span><span class="op" id="5370478">:</span><span class="ident" id="5370479">i</span><span class="op" id="5370480">]</span><span class="op" id="5370481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370491">e</span><span class="op" id="5370492">.</span><span class="ident" id="5370493">WriteString</span><span class="op" id="5370504">(</span><span class="string" id="5370505">`\ufffd`</span><span class="op" id="5370513">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370518">i</span>&nbsp;<span class="op" id="5370520">+=</span>&nbsp;<span class="ident" id="5370523">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370531">start</span>&nbsp;<span class="op" id="5370537">=</span>&nbsp;<span class="ident" id="5370539">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370544">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370559">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370590">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370626">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370691">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370762">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370825">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370872">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370951">if</span>&nbsp;<span class="ident" id="5370954">c</span>&nbsp;<span class="op" id="5370956">==</span>&nbsp;<span class="string" id="5370959">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="5370968">||</span>&nbsp;<span class="ident" id="5370971">c</span>&nbsp;<span class="op" id="5370973">==</span>&nbsp;<span class="string" id="5370976">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="5370985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370990">if</span>&nbsp;<span class="ident" id="5370993">start</span>&nbsp;<span class="op" id="5370999">&lt;</span>&nbsp;<span class="ident" id="5371001">i</span>&nbsp;<span class="op" id="5371003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371009">e</span><span class="op" id="5371010">.</span><span class="ident" id="5371011">WriteString</span><span class="op" id="5371022">(</span><span class="ident" id="5371023">s</span><span class="op" id="5371024">[</span><span class="ident" id="5371025">start</span><span class="op" id="5371030">:</span><span class="ident" id="5371031">i</span><span class="op" id="5371032">]</span><span class="op" id="5371033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371038">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371043">e</span><span class="op" id="5371044">.</span><span class="ident" id="5371045">WriteString</span><span class="op" id="5371056">(</span><span class="string" id="5371057">`\u202`</span><span class="op" id="5371064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371069">e</span><span class="op" id="5371070">.</span><span class="ident" id="5371071">WriteByte</span><span class="op" id="5371080">(</span><span class="ident" id="5371081">hex</span><span class="op" id="5371084">[</span><span class="ident" id="5371085">c</span><span class="op" id="5371086">&amp;</span><span class="num" id="5371087">0xF</span><span class="op" id="5371090">]</span><span class="op" id="5371091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371096">i</span>&nbsp;<span class="op" id="5371098">+=</span>&nbsp;<span class="ident" id="5371101">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371109">start</span>&nbsp;<span class="op" id="5371115">=</span>&nbsp;<span class="ident" id="5371117">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371122">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371137">i</span>&nbsp;<span class="op" id="5371139">+=</span>&nbsp;<span class="ident" id="5371142">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371151">if</span>&nbsp;<span class="ident" id="5371154">start</span>&nbsp;<span class="op" id="5371160">&lt;</span>&nbsp;<span class="builtinfunc" id="5371162">len</span><span class="op" id="5371165">(</span><span class="ident" id="5371166">s</span><span class="op" id="5371167">)</span>&nbsp;<span class="op" id="5371169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371173">e</span><span class="op" id="5371174">.</span><span class="ident" id="5371175">WriteString</span><span class="op" id="5371186">(</span><span class="ident" id="5371187">s</span><span class="op" id="5371188">[</span><span class="ident" id="5371189">start</span><span class="op" id="5371194">:</span><span class="op" id="5371195">]</span><span class="op" id="5371196">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371202">e</span><span class="op" id="5371203">.</span><span class="ident" id="5371204">WriteByte</span><span class="op" id="5371213">(</span><span class="string" id="5371214">&#39;&#34;&#39;</span><span class="op" id="5371217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371220">return</span>&nbsp;<span class="ident" id="5371227">e</span><span class="op" id="5371228">.</span><span class="ident" id="5371229">Len</span><span class="op" id="5371232">(</span><span class="op" id="5371233">)</span>&nbsp;<span class="op" id="5371235">-</span>&nbsp;<span class="ident" id="5371237">len0</span><span class="op" id="5371241">,</span>&nbsp;<span class="ident" id="5371243">nil</span><br>
<span class="lineno"></span><span class="op" id="5371247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="5371250">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="5371291">func</span>&nbsp;<span class="op" id="5371296">(</span><span class="ident" id="5371297">e</span>&nbsp;<span class="op" id="5371299">*</span><span class="ident" id="5371300">encodeState</span><span class="op" id="5371311">)</span>&nbsp;<span class="ident" id="5371313">stringBytes</span><span class="op" id="5371324">(</span><span class="ident" id="5371325">s</span>&nbsp;<span class="op" id="5371327">[</span><span class="op" id="5371328">]</span><span class="builtintype" id="5371329">byte</span><span class="op" id="5371333">)</span>&nbsp;<span class="op" id="5371335">(</span><span class="builtintype" id="5371336">int</span><span class="op" id="5371339">,</span>&nbsp;<span class="builtintype" id="5371341">error</span><span class="op" id="5371346">)</span>&nbsp;<span class="op" id="5371348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371351">len0</span>&nbsp;<span class="op" id="5371356">:=</span>&nbsp;<span class="ident" id="5371359">e</span><span class="op" id="5371360">.</span><span class="ident" id="5371361">Len</span><span class="op" id="5371364">(</span><span class="op" id="5371365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371368">e</span><span class="op" id="5371369">.</span><span class="ident" id="5371370">WriteByte</span><span class="op" id="5371379">(</span><span class="string" id="5371380">&#39;&#34;&#39;</span><span class="op" id="5371383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371386">start</span>&nbsp;<span class="op" id="5371392">:=</span>&nbsp;<span class="num" id="5371395">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371398">for</span>&nbsp;<span class="ident" id="5371402">i</span>&nbsp;<span class="op" id="5371404">:=</span>&nbsp;<span class="num" id="5371407">0</span><span class="op" id="5371408">;</span>&nbsp;<span class="ident" id="5371410">i</span>&nbsp;<span class="op" id="5371412">&lt;</span>&nbsp;<span class="builtinfunc" id="5371414">len</span><span class="op" id="5371417">(</span><span class="ident" id="5371418">s</span><span class="op" id="5371419">)</span><span class="op" id="5371420">;</span>&nbsp;<span class="op" id="5371422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371426">if</span>&nbsp;<span class="ident" id="5371429">b</span>&nbsp;<span class="op" id="5371431">:=</span>&nbsp;<span class="ident" id="5371434">s</span><span class="op" id="5371435">[</span><span class="ident" id="5371436">i</span><span class="op" id="5371437">]</span><span class="op" id="5371438">;</span>&nbsp;<span class="ident" id="5371440">b</span>&nbsp;<span class="op" id="5371442">&lt;</span>&nbsp;<span class="ident" id="5371444">utf8</span><span class="op" id="5371448">.</span><span class="ident" id="5371449">RuneSelf</span>&nbsp;<span class="op" id="5371458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371463">if</span>&nbsp;<span class="num" id="5371466">0x20</span>&nbsp;<span class="op" id="5371471">&lt;=</span>&nbsp;<span class="ident" id="5371474">b</span>&nbsp;<span class="op" id="5371476">&amp;&amp;</span>&nbsp;<span class="ident" id="5371479">b</span>&nbsp;<span class="op" id="5371481">!=</span>&nbsp;<span class="string" id="5371484">&#39;\\&#39;</span>&nbsp;<span class="op" id="5371489">&amp;&amp;</span>&nbsp;<span class="ident" id="5371492">b</span>&nbsp;<span class="op" id="5371494">!=</span>&nbsp;<span class="string" id="5371497">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5371501">&amp;&amp;</span>&nbsp;<span class="ident" id="5371504">b</span>&nbsp;<span class="op" id="5371506">!=</span>&nbsp;<span class="string" id="5371509">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5371513">&amp;&amp;</span>&nbsp;<span class="ident" id="5371516">b</span>&nbsp;<span class="op" id="5371518">!=</span>&nbsp;<span class="string" id="5371521">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5371525">&amp;&amp;</span>&nbsp;<span class="ident" id="5371528">b</span>&nbsp;<span class="op" id="5371530">!=</span>&nbsp;<span class="string" id="5371533">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5371537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371543">i</span><span class="op" id="5371544">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371551">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371568">if</span>&nbsp;<span class="ident" id="5371571">start</span>&nbsp;<span class="op" id="5371577">&lt;</span>&nbsp;<span class="ident" id="5371579">i</span>&nbsp;<span class="op" id="5371581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371587">e</span><span class="op" id="5371588">.</span><span class="ident" id="5371589">Write</span><span class="op" id="5371594">(</span><span class="ident" id="5371595">s</span><span class="op" id="5371596">[</span><span class="ident" id="5371597">start</span><span class="op" id="5371602">:</span><span class="ident" id="5371603">i</span><span class="op" id="5371604">]</span><span class="op" id="5371605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371615">switch</span>&nbsp;<span class="ident" id="5371622">b</span>&nbsp;<span class="op" id="5371624">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371629">case</span>&nbsp;<span class="string" id="5371634">&#39;\\&#39;</span><span class="op" id="5371638">,</span>&nbsp;<span class="string" id="5371640">&#39;&#34;&#39;</span><span class="op" id="5371643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371649">e</span><span class="op" id="5371650">.</span><span class="ident" id="5371651">WriteByte</span><span class="op" id="5371660">(</span><span class="string" id="5371661">&#39;\\&#39;</span><span class="op" id="5371665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371671">e</span><span class="op" id="5371672">.</span><span class="ident" id="5371673">WriteByte</span><span class="op" id="5371682">(</span><span class="ident" id="5371683">b</span><span class="op" id="5371684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371689">case</span>&nbsp;<span class="string" id="5371694">&#39;\n&#39;</span><span class="op" id="5371698">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371704">e</span><span class="op" id="5371705">.</span><span class="ident" id="5371706">WriteByte</span><span class="op" id="5371715">(</span><span class="string" id="5371716">&#39;\\&#39;</span><span class="op" id="5371720">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371726">e</span><span class="op" id="5371727">.</span><span class="ident" id="5371728">WriteByte</span><span class="op" id="5371737">(</span><span class="string" id="5371738">&#39;n&#39;</span><span class="op" id="5371741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371746">case</span>&nbsp;<span class="string" id="5371751">&#39;\r&#39;</span><span class="op" id="5371755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371761">e</span><span class="op" id="5371762">.</span><span class="ident" id="5371763">WriteByte</span><span class="op" id="5371772">(</span><span class="string" id="5371773">&#39;\\&#39;</span><span class="op" id="5371777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371783">e</span><span class="op" id="5371784">.</span><span class="ident" id="5371785">WriteByte</span><span class="op" id="5371794">(</span><span class="string" id="5371795">&#39;r&#39;</span><span class="op" id="5371798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371803">case</span>&nbsp;<span class="string" id="5371808">&#39;\t&#39;</span><span class="op" id="5371812">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371818">e</span><span class="op" id="5371819">.</span><span class="ident" id="5371820">WriteByte</span><span class="op" id="5371829">(</span><span class="string" id="5371830">&#39;\\&#39;</span><span class="op" id="5371834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371840">e</span><span class="op" id="5371841">.</span><span class="ident" id="5371842">WriteByte</span><span class="op" id="5371851">(</span><span class="string" id="5371852">&#39;t&#39;</span><span class="op" id="5371855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371860">default</span><span class="op" id="5371867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371873">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371928">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371995">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372058">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372117">e</span><span class="op" id="5372118">.</span><span class="ident" id="5372119">WriteString</span><span class="op" id="5372130">(</span><span class="string" id="5372131">`\u00`</span><span class="op" id="5372137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372143">e</span><span class="op" id="5372144">.</span><span class="ident" id="5372145">WriteByte</span><span class="op" id="5372154">(</span><span class="ident" id="5372155">hex</span><span class="op" id="5372158">[</span><span class="ident" id="5372159">b</span><span class="op" id="5372160">&gt;&gt;</span><span class="num" id="5372162">4</span><span class="op" id="5372163">]</span><span class="op" id="5372164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372170">e</span><span class="op" id="5372171">.</span><span class="ident" id="5372172">WriteByte</span><span class="op" id="5372181">(</span><span class="ident" id="5372182">hex</span><span class="op" id="5372185">[</span><span class="ident" id="5372186">b</span><span class="op" id="5372187">&amp;</span><span class="num" id="5372188">0xF</span><span class="op" id="5372191">]</span><span class="op" id="5372192">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372202">i</span><span class="op" id="5372203">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372209">start</span>&nbsp;<span class="op" id="5372215">=</span>&nbsp;<span class="ident" id="5372217">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372222">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372233">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372237">c</span><span class="op" id="5372238">,</span>&nbsp;<span class="ident" id="5372240">size</span>&nbsp;<span class="op" id="5372245">:=</span>&nbsp;<span class="ident" id="5372248">utf8</span><span class="op" id="5372252">.</span><span class="ident" id="5372253">DecodeRune</span><span class="op" id="5372263">(</span><span class="ident" id="5372264">s</span><span class="op" id="5372265">[</span><span class="ident" id="5372266">i</span><span class="op" id="5372267">:</span><span class="op" id="5372268">]</span><span class="op" id="5372269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372273">if</span>&nbsp;<span class="ident" id="5372276">c</span>&nbsp;<span class="op" id="5372278">==</span>&nbsp;<span class="ident" id="5372281">utf8</span><span class="op" id="5372285">.</span><span class="ident" id="5372286">RuneError</span>&nbsp;<span class="op" id="5372296">&amp;&amp;</span>&nbsp;<span class="ident" id="5372299">size</span>&nbsp;<span class="op" id="5372304">==</span>&nbsp;<span class="num" id="5372307">1</span>&nbsp;<span class="op" id="5372309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372314">if</span>&nbsp;<span class="ident" id="5372317">start</span>&nbsp;<span class="op" id="5372323">&lt;</span>&nbsp;<span class="ident" id="5372325">i</span>&nbsp;<span class="op" id="5372327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372333">e</span><span class="op" id="5372334">.</span><span class="ident" id="5372335">Write</span><span class="op" id="5372340">(</span><span class="ident" id="5372341">s</span><span class="op" id="5372342">[</span><span class="ident" id="5372343">start</span><span class="op" id="5372348">:</span><span class="ident" id="5372349">i</span><span class="op" id="5372350">]</span><span class="op" id="5372351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372356">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372361">e</span><span class="op" id="5372362">.</span><span class="ident" id="5372363">WriteString</span><span class="op" id="5372374">(</span><span class="string" id="5372375">`\ufffd`</span><span class="op" id="5372383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372388">i</span>&nbsp;<span class="op" id="5372390">+=</span>&nbsp;<span class="ident" id="5372393">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372401">start</span>&nbsp;<span class="op" id="5372407">=</span>&nbsp;<span class="ident" id="5372409">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372414">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372425">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372429">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372460">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372496">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372561">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372632">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372695">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372742">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372821">if</span>&nbsp;<span class="ident" id="5372824">c</span>&nbsp;<span class="op" id="5372826">==</span>&nbsp;<span class="string" id="5372829">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="5372838">||</span>&nbsp;<span class="ident" id="5372841">c</span>&nbsp;<span class="op" id="5372843">==</span>&nbsp;<span class="string" id="5372846">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="5372855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372860">if</span>&nbsp;<span class="ident" id="5372863">start</span>&nbsp;<span class="op" id="5372869">&lt;</span>&nbsp;<span class="ident" id="5372871">i</span>&nbsp;<span class="op" id="5372873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372879">e</span><span class="op" id="5372880">.</span><span class="ident" id="5372881">Write</span><span class="op" id="5372886">(</span><span class="ident" id="5372887">s</span><span class="op" id="5372888">[</span><span class="ident" id="5372889">start</span><span class="op" id="5372894">:</span><span class="ident" id="5372895">i</span><span class="op" id="5372896">]</span><span class="op" id="5372897">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372907">e</span><span class="op" id="5372908">.</span><span class="ident" id="5372909">WriteString</span><span class="op" id="5372920">(</span><span class="string" id="5372921">`\u202`</span><span class="op" id="5372928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372933">e</span><span class="op" id="5372934">.</span><span class="ident" id="5372935">WriteByte</span><span class="op" id="5372944">(</span><span class="ident" id="5372945">hex</span><span class="op" id="5372948">[</span><span class="ident" id="5372949">c</span><span class="op" id="5372950">&amp;</span><span class="num" id="5372951">0xF</span><span class="op" id="5372954">]</span><span class="op" id="5372955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372960">i</span>&nbsp;<span class="op" id="5372962">+=</span>&nbsp;<span class="ident" id="5372965">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372973">start</span>&nbsp;<span class="op" id="5372979">=</span>&nbsp;<span class="ident" id="5372981">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372986">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373001">i</span>&nbsp;<span class="op" id="5373003">+=</span>&nbsp;<span class="ident" id="5373006">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373015">if</span>&nbsp;<span class="ident" id="5373018">start</span>&nbsp;<span class="op" id="5373024">&lt;</span>&nbsp;<span class="builtinfunc" id="5373026">len</span><span class="op" id="5373029">(</span><span class="ident" id="5373030">s</span><span class="op" id="5373031">)</span>&nbsp;<span class="op" id="5373033">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373037">e</span><span class="op" id="5373038">.</span><span class="ident" id="5373039">Write</span><span class="op" id="5373044">(</span><span class="ident" id="5373045">s</span><span class="op" id="5373046">[</span><span class="ident" id="5373047">start</span><span class="op" id="5373052">:</span><span class="op" id="5373053">]</span><span class="op" id="5373054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373060">e</span><span class="op" id="5373061">.</span><span class="ident" id="5373062">WriteByte</span><span class="op" id="5373071">(</span><span class="string" id="5373072">&#39;&#34;&#39;</span><span class="op" id="5373075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373078">return</span>&nbsp;<span class="ident" id="5373085">e</span><span class="op" id="5373086">.</span><span class="ident" id="5373087">Len</span><span class="op" id="5373090">(</span><span class="op" id="5373091">)</span>&nbsp;<span class="op" id="5373093">-</span>&nbsp;<span class="ident" id="5373095">len0</span><span class="op" id="5373099">,</span>&nbsp;<span class="ident" id="5373101">nil</span><br>
<span class="lineno"></span><span class="op" id="5373105">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="5373108">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5373164">type</span>&nbsp;<span class="ident" id="5373169">field</span>&nbsp;<span class="keyword" id="5373175">struct</span>&nbsp;<span class="op" id="5373182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373185">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5373195">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373203">nameBytes</span>&nbsp;<span class="op" id="5373213">[</span><span class="op" id="5373214">]</span><span class="builtintype" id="5373215">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5373236">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373253">equalFold</span>&nbsp;<span class="keyword" id="5373263">func</span><span class="op" id="5373267">(</span><span class="ident" id="5373268">s</span><span class="op" id="5373269">,</span>&nbsp;<span class="ident" id="5373271">t</span>&nbsp;<span class="op" id="5373273">[</span><span class="op" id="5373274">]</span><span class="builtintype" id="5373275">byte</span><span class="op" id="5373279">)</span>&nbsp;<span class="builtintype" id="5373281">bool</span>&nbsp;<span class="comment" id="5373286">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373321">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5373331">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373337">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5373347">[</span><span class="op" id="5373348">]</span><span class="builtintype" id="5373349">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373354">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5373364">reflect</span><span class="op" id="5373371">.</span><span class="ident" id="5373372">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373378">omitEmpty</span>&nbsp;<span class="builtintype" id="5373388">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373394">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5373404">bool</span><br>
<span class="lineno"></span><span class="op" id="5373409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373412">func</span>&nbsp;<span class="ident" id="5373417">fillField</span><span class="op" id="5373426">(</span><span class="ident" id="5373427">f</span>&nbsp;<span class="ident" id="5373429">field</span><span class="op" id="5373434">)</span>&nbsp;<span class="ident" id="5373436">field</span>&nbsp;<span class="op" id="5373442">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373445">f</span><span class="op" id="5373446">.</span><span class="ident" id="5373447">nameBytes</span>&nbsp;<span class="op" id="5373457">=</span>&nbsp;<span class="op" id="5373459">[</span><span class="op" id="5373460">]</span><span class="builtintype" id="5373461">byte</span><span class="op" id="5373465">(</span><span class="ident" id="5373466">f</span><span class="op" id="5373467">.</span><span class="ident" id="5373468">name</span><span class="op" id="5373472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373475">f</span><span class="op" id="5373476">.</span><span class="ident" id="5373477">equalFold</span>&nbsp;<span class="op" id="5373487">=</span>&nbsp;<span class="ident" id="5373489">foldFunc</span><span class="op" id="5373497">(</span><span class="ident" id="5373498">f</span><span class="op" id="5373499">.</span><span class="ident" id="5373500">nameBytes</span><span class="op" id="5373509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373512">return</span>&nbsp;<span class="ident" id="5373519">f</span><br>
<span class="lineno"></span><span class="op" id="5373521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="5373524">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="5373581">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5373640">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="5373678">type</span>&nbsp;<span class="ident" id="5373683">byName</span>&nbsp;<span class="op" id="5373690">[</span><span class="op" id="5373691">]</span><span class="ident" id="5373692">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="5373699">func</span>&nbsp;<span class="op" id="5373704">(</span><span class="ident" id="5373705">x</span>&nbsp;<span class="ident" id="5373707">byName</span><span class="op" id="5373713">)</span>&nbsp;<span class="ident" id="5373715">Len</span><span class="op" id="5373718">(</span><span class="op" id="5373719">)</span>&nbsp;<span class="builtintype" id="5373721">int</span>&nbsp;<span class="op" id="5373725">{</span>&nbsp;<span class="keyword" id="5373727">return</span>&nbsp;<span class="builtinfunc" id="5373734">len</span><span class="op" id="5373737">(</span><span class="ident" id="5373738">x</span><span class="op" id="5373739">)</span>&nbsp;<span class="op" id="5373741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373744">func</span>&nbsp;<span class="op" id="5373749">(</span><span class="ident" id="5373750">x</span>&nbsp;<span class="ident" id="5373752">byName</span><span class="op" id="5373758">)</span>&nbsp;<span class="ident" id="5373760">Swap</span><span class="op" id="5373764">(</span><span class="ident" id="5373765">i</span><span class="op" id="5373766">,</span>&nbsp;<span class="ident" id="5373768">j</span>&nbsp;<span class="builtintype" id="5373770">int</span><span class="op" id="5373773">)</span>&nbsp;<span class="op" id="5373775">{</span>&nbsp;<span class="ident" id="5373777">x</span><span class="op" id="5373778">[</span><span class="ident" id="5373779">i</span><span class="op" id="5373780">]</span><span class="op" id="5373781">,</span>&nbsp;<span class="ident" id="5373783">x</span><span class="op" id="5373784">[</span><span class="ident" id="5373785">j</span><span class="op" id="5373786">]</span>&nbsp;<span class="op" id="5373788">=</span>&nbsp;<span class="ident" id="5373790">x</span><span class="op" id="5373791">[</span><span class="ident" id="5373792">j</span><span class="op" id="5373793">]</span><span class="op" id="5373794">,</span>&nbsp;<span class="ident" id="5373796">x</span><span class="op" id="5373797">[</span><span class="ident" id="5373798">i</span><span class="op" id="5373799">]</span>&nbsp;<span class="op" id="5373801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373804">func</span>&nbsp;<span class="op" id="5373809">(</span><span class="ident" id="5373810">x</span>&nbsp;<span class="ident" id="5373812">byName</span><span class="op" id="5373818">)</span>&nbsp;<span class="ident" id="5373820">Less</span><span class="op" id="5373824">(</span><span class="ident" id="5373825">i</span><span class="op" id="5373826">,</span>&nbsp;<span class="ident" id="5373828">j</span>&nbsp;<span class="builtintype" id="5373830">int</span><span class="op" id="5373833">)</span>&nbsp;<span class="builtintype" id="5373835">bool</span>&nbsp;<span class="op" id="5373840">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373843">if</span>&nbsp;<span class="ident" id="5373846">x</span><span class="op" id="5373847">[</span><span class="ident" id="5373848">i</span><span class="op" id="5373849">]</span><span class="op" id="5373850">.</span><span class="ident" id="5373851">name</span>&nbsp;<span class="op" id="5373856">!=</span>&nbsp;<span class="ident" id="5373859">x</span><span class="op" id="5373860">[</span><span class="ident" id="5373861">j</span><span class="op" id="5373862">]</span><span class="op" id="5373863">.</span><span class="ident" id="5373864">name</span>&nbsp;<span class="op" id="5373869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373873">return</span>&nbsp;<span class="ident" id="5373880">x</span><span class="op" id="5373881">[</span><span class="ident" id="5373882">i</span><span class="op" id="5373883">]</span><span class="op" id="5373884">.</span><span class="ident" id="5373885">name</span>&nbsp;<span class="op" id="5373890">&lt;</span>&nbsp;<span class="ident" id="5373892">x</span><span class="op" id="5373893">[</span><span class="ident" id="5373894">j</span><span class="op" id="5373895">]</span><span class="op" id="5373896">.</span><span class="ident" id="5373897">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373906">if</span>&nbsp;<span class="builtinfunc" id="5373909">len</span><span class="op" id="5373912">(</span><span class="ident" id="5373913">x</span><span class="op" id="5373914">[</span><span class="ident" id="5373915">i</span><span class="op" id="5373916">]</span><span class="op" id="5373917">.</span><span class="ident" id="5373918">index</span><span class="op" id="5373923">)</span>&nbsp;<span class="op" id="5373925">!=</span>&nbsp;<span class="builtinfunc" id="5373928">len</span><span class="op" id="5373931">(</span><span class="ident" id="5373932">x</span><span class="op" id="5373933">[</span><span class="ident" id="5373934">j</span><span class="op" id="5373935">]</span><span class="op" id="5373936">.</span><span class="ident" id="5373937">index</span><span class="op" id="5373942">)</span>&nbsp;<span class="op" id="5373944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373948">return</span>&nbsp;<span class="builtinfunc" id="5373955">len</span><span class="op" id="5373958">(</span><span class="ident" id="5373959">x</span><span class="op" id="5373960">[</span><span class="ident" id="5373961">i</span><span class="op" id="5373962">]</span><span class="op" id="5373963">.</span><span class="ident" id="5373964">index</span><span class="op" id="5373969">)</span>&nbsp;<span class="op" id="5373971">&lt;</span>&nbsp;<span class="builtinfunc" id="5373973">len</span><span class="op" id="5373976">(</span><span class="ident" id="5373977">x</span><span class="op" id="5373978">[</span><span class="ident" id="5373979">j</span><span class="op" id="5373980">]</span><span class="op" id="5373981">.</span><span class="ident" id="5373982">index</span><span class="op" id="5373987">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373993">if</span>&nbsp;<span class="ident" id="5373996">x</span><span class="op" id="5373997">[</span><span class="ident" id="5373998">i</span><span class="op" id="5373999">]</span><span class="op" id="5374000">.</span><span class="ident" id="5374001">tag</span>&nbsp;<span class="op" id="5374005">!=</span>&nbsp;<span class="ident" id="5374008">x</span><span class="op" id="5374009">[</span><span class="ident" id="5374010">j</span><span class="op" id="5374011">]</span><span class="op" id="5374012">.</span><span class="ident" id="5374013">tag</span>&nbsp;<span class="op" id="5374017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374021">return</span>&nbsp;<span class="ident" id="5374028">x</span><span class="op" id="5374029">[</span><span class="ident" id="5374030">i</span><span class="op" id="5374031">]</span><span class="op" id="5374032">.</span><span class="ident" id="5374033">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374041">return</span>&nbsp;<span class="ident" id="5374048">byIndex</span><span class="op" id="5374055">(</span><span class="ident" id="5374056">x</span><span class="op" id="5374057">)</span><span class="op" id="5374058">.</span><span class="ident" id="5374059">Less</span><span class="op" id="5374063">(</span><span class="ident" id="5374064">i</span><span class="op" id="5374065">,</span>&nbsp;<span class="ident" id="5374067">j</span><span class="op" id="5374068">)</span><br>
<span class="lineno">975</span><span class="op" id="5374070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5374073">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="5374115">type</span>&nbsp;<span class="ident" id="5374120">byIndex</span>&nbsp;<span class="op" id="5374128">[</span><span class="op" id="5374129">]</span><span class="ident" id="5374130">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="5374137">func</span>&nbsp;<span class="op" id="5374142">(</span><span class="ident" id="5374143">x</span>&nbsp;<span class="ident" id="5374145">byIndex</span><span class="op" id="5374152">)</span>&nbsp;<span class="ident" id="5374154">Len</span><span class="op" id="5374157">(</span><span class="op" id="5374158">)</span>&nbsp;<span class="builtintype" id="5374160">int</span>&nbsp;<span class="op" id="5374164">{</span>&nbsp;<span class="keyword" id="5374166">return</span>&nbsp;<span class="builtinfunc" id="5374173">len</span><span class="op" id="5374176">(</span><span class="ident" id="5374177">x</span><span class="op" id="5374178">)</span>&nbsp;<span class="op" id="5374180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5374183">func</span>&nbsp;<span class="op" id="5374188">(</span><span class="ident" id="5374189">x</span>&nbsp;<span class="ident" id="5374191">byIndex</span><span class="op" id="5374198">)</span>&nbsp;<span class="ident" id="5374200">Swap</span><span class="op" id="5374204">(</span><span class="ident" id="5374205">i</span><span class="op" id="5374206">,</span>&nbsp;<span class="ident" id="5374208">j</span>&nbsp;<span class="builtintype" id="5374210">int</span><span class="op" id="5374213">)</span>&nbsp;<span class="op" id="5374215">{</span>&nbsp;<span class="ident" id="5374217">x</span><span class="op" id="5374218">[</span><span class="ident" id="5374219">i</span><span class="op" id="5374220">]</span><span class="op" id="5374221">,</span>&nbsp;<span class="ident" id="5374223">x</span><span class="op" id="5374224">[</span><span class="ident" id="5374225">j</span><span class="op" id="5374226">]</span>&nbsp;<span class="op" id="5374228">=</span>&nbsp;<span class="ident" id="5374230">x</span><span class="op" id="5374231">[</span><span class="ident" id="5374232">j</span><span class="op" id="5374233">]</span><span class="op" id="5374234">,</span>&nbsp;<span class="ident" id="5374236">x</span><span class="op" id="5374237">[</span><span class="ident" id="5374238">i</span><span class="op" id="5374239">]</span>&nbsp;<span class="op" id="5374241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5374244">func</span>&nbsp;<span class="op" id="5374249">(</span><span class="ident" id="5374250">x</span>&nbsp;<span class="ident" id="5374252">byIndex</span><span class="op" id="5374259">)</span>&nbsp;<span class="ident" id="5374261">Less</span><span class="op" id="5374265">(</span><span class="ident" id="5374266">i</span><span class="op" id="5374267">,</span>&nbsp;<span class="ident" id="5374269">j</span>&nbsp;<span class="builtintype" id="5374271">int</span><span class="op" id="5374274">)</span>&nbsp;<span class="builtintype" id="5374276">bool</span>&nbsp;<span class="op" id="5374281">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374284">for</span>&nbsp;<span class="ident" id="5374288">k</span><span class="op" id="5374289">,</span>&nbsp;<span class="ident" id="5374291">xik</span>&nbsp;<span class="op" id="5374295">:=</span>&nbsp;<span class="keyword" id="5374298">range</span>&nbsp;<span class="ident" id="5374304">x</span><span class="op" id="5374305">[</span><span class="ident" id="5374306">i</span><span class="op" id="5374307">]</span><span class="op" id="5374308">.</span><span class="ident" id="5374309">index</span>&nbsp;<span class="op" id="5374315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374319">if</span>&nbsp;<span class="ident" id="5374322">k</span>&nbsp;<span class="op" id="5374324">&gt;=</span>&nbsp;<span class="builtinfunc" id="5374327">len</span><span class="op" id="5374330">(</span><span class="ident" id="5374331">x</span><span class="op" id="5374332">[</span><span class="ident" id="5374333">j</span><span class="op" id="5374334">]</span><span class="op" id="5374335">.</span><span class="ident" id="5374336">index</span><span class="op" id="5374341">)</span>&nbsp;<span class="op" id="5374343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374348">return</span>&nbsp;<span class="builtintype" id="5374355">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374367">if</span>&nbsp;<span class="ident" id="5374370">xik</span>&nbsp;<span class="op" id="5374374">!=</span>&nbsp;<span class="ident" id="5374377">x</span><span class="op" id="5374378">[</span><span class="ident" id="5374379">j</span><span class="op" id="5374380">]</span><span class="op" id="5374381">.</span><span class="ident" id="5374382">index</span><span class="op" id="5374387">[</span><span class="ident" id="5374388">k</span><span class="op" id="5374389">]</span>&nbsp;<span class="op" id="5374391">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374396">return</span>&nbsp;<span class="ident" id="5374403">xik</span>&nbsp;<span class="op" id="5374407">&lt;</span>&nbsp;<span class="ident" id="5374409">x</span><span class="op" id="5374410">[</span><span class="ident" id="5374411">j</span><span class="op" id="5374412">]</span><span class="op" id="5374413">.</span><span class="ident" id="5374414">index</span><span class="op" id="5374419">[</span><span class="ident" id="5374420">k</span><span class="op" id="5374421">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374431">return</span>&nbsp;<span class="builtinfunc" id="5374438">len</span><span class="op" id="5374441">(</span><span class="ident" id="5374442">x</span><span class="op" id="5374443">[</span><span class="ident" id="5374444">i</span><span class="op" id="5374445">]</span><span class="op" id="5374446">.</span><span class="ident" id="5374447">index</span><span class="op" id="5374452">)</span>&nbsp;<span class="op" id="5374454">&lt;</span>&nbsp;<span class="builtinfunc" id="5374456">len</span><span class="op" id="5374459">(</span><span class="ident" id="5374460">x</span><span class="op" id="5374461">[</span><span class="ident" id="5374462">j</span><span class="op" id="5374463">]</span><span class="op" id="5374464">.</span><span class="ident" id="5374465">index</span><span class="op" id="5374470">)</span><br>
<span class="lineno"></span><span class="op" id="5374472">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="5374475">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5374561">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5374654">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="5374699">func</span>&nbsp;<span class="ident" id="5374704">typeFields</span><span class="op" id="5374714">(</span><span class="ident" id="5374715">t</span>&nbsp;<span class="ident" id="5374717">reflect</span><span class="op" id="5374724">.</span><span class="ident" id="5374725">Type</span><span class="op" id="5374729">)</span>&nbsp;<span class="op" id="5374731">[</span><span class="op" id="5374732">]</span><span class="ident" id="5374733">field</span>&nbsp;<span class="op" id="5374739">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374742">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374809">current</span>&nbsp;<span class="op" id="5374817">:=</span>&nbsp;<span class="op" id="5374820">[</span><span class="op" id="5374821">]</span><span class="ident" id="5374822">field</span><span class="op" id="5374827">{</span><span class="op" id="5374828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374831">next</span>&nbsp;<span class="op" id="5374836">:=</span>&nbsp;<span class="op" id="5374839">[</span><span class="op" id="5374840">]</span><span class="ident" id="5374841">field</span><span class="op" id="5374846">{</span><span class="op" id="5374847">{</span><span class="ident" id="5374848">typ</span><span class="op" id="5374851">:</span>&nbsp;<span class="ident" id="5374853">t</span><span class="op" id="5374854">}</span><span class="op" id="5374855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374859">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374917">count</span>&nbsp;<span class="op" id="5374923">:=</span>&nbsp;<span class="keyword" id="5374926">map</span><span class="op" id="5374929">[</span><span class="ident" id="5374930">reflect</span><span class="op" id="5374937">.</span><span class="ident" id="5374938">Type</span><span class="op" id="5374942">]</span><span class="builtintype" id="5374943">int</span><span class="op" id="5374946">{</span><span class="op" id="5374947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374950">nextCount</span>&nbsp;<span class="op" id="5374960">:=</span>&nbsp;<span class="keyword" id="5374963">map</span><span class="op" id="5374966">[</span><span class="ident" id="5374967">reflect</span><span class="op" id="5374974">.</span><span class="ident" id="5374975">Type</span><span class="op" id="5374979">]</span><span class="builtintype" id="5374980">int</span><span class="op" id="5374983">{</span><span class="op" id="5374984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374988">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375035">visited</span>&nbsp;<span class="op" id="5375043">:=</span>&nbsp;<span class="keyword" id="5375046">map</span><span class="op" id="5375049">[</span><span class="ident" id="5375050">reflect</span><span class="op" id="5375057">.</span><span class="ident" id="5375058">Type</span><span class="op" id="5375062">]</span><span class="builtintype" id="5375063">bool</span><span class="op" id="5375067">{</span><span class="op" id="5375068">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375072">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375090">var</span>&nbsp;<span class="ident" id="5375094">fields</span>&nbsp;<span class="op" id="5375101">[</span><span class="op" id="5375102">]</span><span class="ident" id="5375103">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375111">for</span>&nbsp;<span class="builtinfunc" id="5375115">len</span><span class="op" id="5375118">(</span><span class="ident" id="5375119">next</span><span class="op" id="5375123">)</span>&nbsp;<span class="op" id="5375125">&gt;</span>&nbsp;<span class="num" id="5375127">0</span>&nbsp;<span class="op" id="5375129">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375133">current</span><span class="op" id="5375140">,</span>&nbsp;<span class="ident" id="5375142">next</span>&nbsp;<span class="op" id="5375147">=</span>&nbsp;<span class="ident" id="5375149">next</span><span class="op" id="5375153">,</span>&nbsp;<span class="ident" id="5375155">current</span><span class="op" id="5375162">[</span><span class="op" id="5375163">:</span><span class="num" id="5375164">0</span><span class="op" id="5375165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375169">count</span><span class="op" id="5375174">,</span>&nbsp;<span class="ident" id="5375176">nextCount</span>&nbsp;<span class="op" id="5375186">=</span>&nbsp;<span class="ident" id="5375188">nextCount</span><span class="op" id="5375197">,</span>&nbsp;<span class="keyword" id="5375199">map</span><span class="op" id="5375202">[</span><span class="ident" id="5375203">reflect</span><span class="op" id="5375210">.</span><span class="ident" id="5375211">Type</span><span class="op" id="5375215">]</span><span class="builtintype" id="5375216">int</span><span class="op" id="5375219">{</span><span class="op" id="5375220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375225">for</span>&nbsp;<span class="ident" id="5375229">_</span><span class="op" id="5375230">,</span>&nbsp;<span class="ident" id="5375232">f</span>&nbsp;<span class="op" id="5375234">:=</span>&nbsp;<span class="keyword" id="5375237">range</span>&nbsp;<span class="ident" id="5375243">current</span>&nbsp;<span class="op" id="5375251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375256">if</span>&nbsp;<span class="ident" id="5375259">visited</span><span class="op" id="5375266">[</span><span class="ident" id="5375267">f</span><span class="op" id="5375268">.</span><span class="ident" id="5375269">typ</span><span class="op" id="5375272">]</span>&nbsp;<span class="op" id="5375274">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375280">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375297">visited</span><span class="op" id="5375304">[</span><span class="ident" id="5375305">f</span><span class="op" id="5375306">.</span><span class="ident" id="5375307">typ</span><span class="op" id="5375310">]</span>&nbsp;<span class="op" id="5375312">=</span>&nbsp;<span class="builtintype" id="5375314">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375323">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375363">for</span>&nbsp;<span class="ident" id="5375367">i</span>&nbsp;<span class="op" id="5375369">:=</span>&nbsp;<span class="num" id="5375372">0</span><span class="op" id="5375373">;</span>&nbsp;<span class="ident" id="5375375">i</span>&nbsp;<span class="op" id="5375377">&lt;</span>&nbsp;<span class="ident" id="5375379">f</span><span class="op" id="5375380">.</span><span class="ident" id="5375381">typ</span><span class="op" id="5375384">.</span><span class="ident" id="5375385">NumField</span><span class="op" id="5375393">(</span><span class="op" id="5375394">)</span><span class="op" id="5375395">;</span>&nbsp;<span class="ident" id="5375397">i</span><span class="op" id="5375398">++</span>&nbsp;<span class="op" id="5375401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375407">sf</span>&nbsp;<span class="op" id="5375410">:=</span>&nbsp;<span class="ident" id="5375413">f</span><span class="op" id="5375414">.</span><span class="ident" id="5375415">typ</span><span class="op" id="5375418">.</span><span class="ident" id="5375419">Field</span><span class="op" id="5375424">(</span><span class="ident" id="5375425">i</span><span class="op" id="5375426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375432">if</span>&nbsp;<span class="ident" id="5375435">sf</span><span class="op" id="5375437">.</span><span class="ident" id="5375438">PkgPath</span>&nbsp;<span class="op" id="5375446">!=</span>&nbsp;<span class="string" id="5375449">&#34;&#34;</span>&nbsp;<span class="op" id="5375452">{</span>&nbsp;<span class="comment" id="5375454">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375473">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375486">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375492">tag</span>&nbsp;<span class="op" id="5375496">:=</span>&nbsp;<span class="ident" id="5375499">sf</span><span class="op" id="5375501">.</span><span class="ident" id="5375502">Tag</span><span class="op" id="5375505">.</span><span class="ident" id="5375506">Get</span><span class="op" id="5375509">(</span><span class="string" id="5375510">&#34;json&#34;</span><span class="op" id="5375516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375522">if</span>&nbsp;<span class="ident" id="5375525">tag</span>&nbsp;<span class="op" id="5375529">==</span>&nbsp;<span class="string" id="5375532">&#34;-&#34;</span>&nbsp;<span class="op" id="5375536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375543">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375562">name</span><span class="op" id="5375566">,</span>&nbsp;<span class="ident" id="5375568">opts</span>&nbsp;<span class="op" id="5375573">:=</span>&nbsp;<span class="ident" id="5375576">parseTag</span><span class="op" id="5375584">(</span><span class="ident" id="5375585">tag</span><span class="op" id="5375588">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375594">if</span>&nbsp;<span class="op" id="5375597">!</span><span class="ident" id="5375598">isValidTag</span><span class="op" id="5375608">(</span><span class="ident" id="5375609">name</span><span class="op" id="5375613">)</span>&nbsp;<span class="op" id="5375615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375622">name</span>&nbsp;<span class="op" id="5375627">=</span>&nbsp;<span class="string" id="5375629">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375642">index</span>&nbsp;<span class="op" id="5375648">:=</span>&nbsp;<span class="builtinfunc" id="5375651">make</span><span class="op" id="5375655">(</span><span class="op" id="5375656">[</span><span class="op" id="5375657">]</span><span class="builtintype" id="5375658">int</span><span class="op" id="5375661">,</span>&nbsp;<span class="builtinfunc" id="5375663">len</span><span class="op" id="5375666">(</span><span class="ident" id="5375667">f</span><span class="op" id="5375668">.</span><span class="ident" id="5375669">index</span><span class="op" id="5375674">)</span><span class="op" id="5375675">+</span><span class="num" id="5375676">1</span><span class="op" id="5375677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5375683">copy</span><span class="op" id="5375687">(</span><span class="ident" id="5375688">index</span><span class="op" id="5375693">,</span>&nbsp;<span class="ident" id="5375695">f</span><span class="op" id="5375696">.</span><span class="ident" id="5375697">index</span><span class="op" id="5375702">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375708">index</span><span class="op" id="5375713">[</span><span class="builtinfunc" id="5375714">len</span><span class="op" id="5375717">(</span><span class="ident" id="5375718">f</span><span class="op" id="5375719">.</span><span class="ident" id="5375720">index</span><span class="op" id="5375725">)</span><span class="op" id="5375726">]</span>&nbsp;<span class="op" id="5375728">=</span>&nbsp;<span class="ident" id="5375730">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375737">ft</span>&nbsp;<span class="op" id="5375740">:=</span>&nbsp;<span class="ident" id="5375743">sf</span><span class="op" id="5375745">.</span><span class="ident" id="5375746">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375755">if</span>&nbsp;<span class="ident" id="5375758">ft</span><span class="op" id="5375760">.</span><span class="ident" id="5375761">Name</span><span class="op" id="5375765">(</span><span class="op" id="5375766">)</span>&nbsp;<span class="op" id="5375768">==</span>&nbsp;<span class="string" id="5375771">&#34;&#34;</span>&nbsp;<span class="op" id="5375774">&amp;&amp;</span>&nbsp;<span class="ident" id="5375777">ft</span><span class="op" id="5375779">.</span><span class="ident" id="5375780">Kind</span><span class="op" id="5375784">(</span><span class="op" id="5375785">)</span>&nbsp;<span class="op" id="5375787">==</span>&nbsp;<span class="ident" id="5375790">reflect</span><span class="op" id="5375797">.</span><span class="ident" id="5375798">Ptr</span>&nbsp;<span class="op" id="5375802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375809">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375833">ft</span>&nbsp;<span class="op" id="5375836">=</span>&nbsp;<span class="ident" id="5375838">ft</span><span class="op" id="5375840">.</span><span class="ident" id="5375841">Elem</span><span class="op" id="5375845">(</span><span class="op" id="5375846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375859">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375905">if</span>&nbsp;<span class="ident" id="5375908">name</span>&nbsp;<span class="op" id="5375913">!=</span>&nbsp;<span class="string" id="5375916">&#34;&#34;</span>&nbsp;<span class="op" id="5375919">||</span>&nbsp;<span class="op" id="5375922">!</span><span class="ident" id="5375923">sf</span><span class="op" id="5375925">.</span><span class="ident" id="5375926">Anonymous</span>&nbsp;<span class="op" id="5375936">||</span>&nbsp;<span class="ident" id="5375939">ft</span><span class="op" id="5375941">.</span><span class="ident" id="5375942">Kind</span><span class="op" id="5375946">(</span><span class="op" id="5375947">)</span>&nbsp;<span class="op" id="5375949">!=</span>&nbsp;<span class="ident" id="5375952">reflect</span><span class="op" id="5375959">.</span><span class="ident" id="5375960">Struct</span>&nbsp;<span class="op" id="5375967">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375974">tagged</span>&nbsp;<span class="op" id="5375981">:=</span>&nbsp;<span class="ident" id="5375984">name</span>&nbsp;<span class="op" id="5375989">!=</span>&nbsp;<span class="string" id="5375992">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376000">if</span>&nbsp;<span class="ident" id="5376003">name</span>&nbsp;<span class="op" id="5376008">==</span>&nbsp;<span class="string" id="5376011">&#34;&#34;</span>&nbsp;<span class="op" id="5376014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376022">name</span>&nbsp;<span class="op" id="5376027">=</span>&nbsp;<span class="ident" id="5376029">sf</span><span class="op" id="5376031">.</span><span class="ident" id="5376032">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376049">fields</span>&nbsp;<span class="op" id="5376056">=</span>&nbsp;<span class="builtinfunc" id="5376058">append</span><span class="op" id="5376064">(</span><span class="ident" id="5376065">fields</span><span class="op" id="5376071">,</span>&nbsp;<span class="ident" id="5376073">fillField</span><span class="op" id="5376082">(</span><span class="ident" id="5376083">field</span><span class="op" id="5376088">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376096">name</span><span class="op" id="5376100">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376107">name</span><span class="op" id="5376111">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376119">tag</span><span class="op" id="5376122">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376130">tagged</span><span class="op" id="5376136">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376144">index</span><span class="op" id="5376149">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376155">index</span><span class="op" id="5376160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376168">typ</span><span class="op" id="5376171">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376179">ft</span><span class="op" id="5376181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376189">omitEmpty</span><span class="op" id="5376198">:</span>&nbsp;<span class="ident" id="5376200">opts</span><span class="op" id="5376204">.</span><span class="ident" id="5376205">Contains</span><span class="op" id="5376213">(</span><span class="string" id="5376214">&#34;omitempty&#34;</span><span class="op" id="5376225">)</span><span class="op" id="5376226">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376234">quoted</span><span class="op" id="5376240">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5376245">opts</span><span class="op" id="5376249">.</span><span class="ident" id="5376250">Contains</span><span class="op" id="5376258">(</span><span class="string" id="5376259">&#34;string&#34;</span><span class="op" id="5376267">)</span><span class="op" id="5376268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376275">}</span><span class="op" id="5376276">)</span><span class="op" id="5376277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376284">if</span>&nbsp;<span class="ident" id="5376287">count</span><span class="op" id="5376292">[</span><span class="ident" id="5376293">f</span><span class="op" id="5376294">.</span><span class="ident" id="5376295">typ</span><span class="op" id="5376298">]</span>&nbsp;<span class="op" id="5376300">&gt;</span>&nbsp;<span class="num" id="5376302">1</span>&nbsp;<span class="op" id="5376304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376312">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376369">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376430">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376491">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376544">fields</span>&nbsp;<span class="op" id="5376551">=</span>&nbsp;<span class="builtinfunc" id="5376553">append</span><span class="op" id="5376559">(</span><span class="ident" id="5376560">fields</span><span class="op" id="5376566">,</span>&nbsp;<span class="ident" id="5376568">fields</span><span class="op" id="5376574">[</span><span class="builtinfunc" id="5376575">len</span><span class="op" id="5376578">(</span><span class="ident" id="5376579">fields</span><span class="op" id="5376585">)</span><span class="op" id="5376586">-</span><span class="num" id="5376587">1</span><span class="op" id="5376588">]</span><span class="op" id="5376589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376603">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376623">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376684">nextCount</span><span class="op" id="5376693">[</span><span class="ident" id="5376694">ft</span><span class="op" id="5376696">]</span><span class="op" id="5376697">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376704">if</span>&nbsp;<span class="ident" id="5376707">nextCount</span><span class="op" id="5376716">[</span><span class="ident" id="5376717">ft</span><span class="op" id="5376719">]</span>&nbsp;<span class="op" id="5376721">==</span>&nbsp;<span class="num" id="5376724">1</span>&nbsp;<span class="op" id="5376726">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376733">next</span>&nbsp;<span class="op" id="5376738">=</span>&nbsp;<span class="builtinfunc" id="5376740">append</span><span class="op" id="5376746">(</span><span class="ident" id="5376747">next</span><span class="op" id="5376751">,</span>&nbsp;<span class="ident" id="5376753">fillField</span><span class="op" id="5376762">(</span><span class="ident" id="5376763">field</span><span class="op" id="5376768">{</span><span class="ident" id="5376769">name</span><span class="op" id="5376773">:</span>&nbsp;<span class="ident" id="5376775">ft</span><span class="op" id="5376777">.</span><span class="ident" id="5376778">Name</span><span class="op" id="5376782">(</span><span class="op" id="5376783">)</span><span class="op" id="5376784">,</span>&nbsp;<span class="ident" id="5376786">index</span><span class="op" id="5376791">:</span>&nbsp;<span class="ident" id="5376793">index</span><span class="op" id="5376798">,</span>&nbsp;<span class="ident" id="5376800">typ</span><span class="op" id="5376803">:</span>&nbsp;<span class="ident" id="5376805">ft</span><span class="op" id="5376807">}</span><span class="op" id="5376808">)</span><span class="op" id="5376809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376827">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376831">sort</span><span class="op" id="5376835">.</span><span class="ident" id="5376836">Sort</span><span class="op" id="5376840">(</span><span class="ident" id="5376841">byName</span><span class="op" id="5376847">(</span><span class="ident" id="5376848">fields</span><span class="op" id="5376854">)</span><span class="op" id="5376855">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376859">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376934">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376987">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377055">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377121">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377189">out</span>&nbsp;<span class="op" id="5377193">:=</span>&nbsp;<span class="ident" id="5377196">fields</span><span class="op" id="5377202">[</span><span class="op" id="5377203">:</span><span class="num" id="5377204">0</span><span class="op" id="5377205">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377208">for</span>&nbsp;<span class="ident" id="5377212">advance</span><span class="op" id="5377219">,</span>&nbsp;<span class="ident" id="5377221">i</span>&nbsp;<span class="op" id="5377223">:=</span>&nbsp;<span class="num" id="5377226">0</span><span class="op" id="5377227">,</span>&nbsp;<span class="num" id="5377229">0</span><span class="op" id="5377230">;</span>&nbsp;<span class="ident" id="5377232">i</span>&nbsp;<span class="op" id="5377234">&lt;</span>&nbsp;<span class="builtinfunc" id="5377236">len</span><span class="op" id="5377239">(</span><span class="ident" id="5377240">fields</span><span class="op" id="5377246">)</span><span class="op" id="5377247">;</span>&nbsp;<span class="ident" id="5377249">i</span>&nbsp;<span class="op" id="5377251">+=</span>&nbsp;<span class="ident" id="5377254">advance</span>&nbsp;<span class="op" id="5377262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377266">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377295">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377363">fi</span>&nbsp;<span class="op" id="5377366">:=</span>&nbsp;<span class="ident" id="5377369">fields</span><span class="op" id="5377375">[</span><span class="ident" id="5377376">i</span><span class="op" id="5377377">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377381">name</span>&nbsp;<span class="op" id="5377386">:=</span>&nbsp;<span class="ident" id="5377389">fi</span><span class="op" id="5377391">.</span><span class="ident" id="5377392">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377399">for</span>&nbsp;<span class="ident" id="5377403">advance</span>&nbsp;<span class="op" id="5377411">=</span>&nbsp;<span class="num" id="5377413">1</span><span class="op" id="5377414">;</span>&nbsp;<span class="ident" id="5377416">i</span><span class="op" id="5377417">+</span><span class="ident" id="5377418">advance</span>&nbsp;<span class="op" id="5377426">&lt;</span>&nbsp;<span class="builtinfunc" id="5377428">len</span><span class="op" id="5377431">(</span><span class="ident" id="5377432">fields</span><span class="op" id="5377438">)</span><span class="op" id="5377439">;</span>&nbsp;<span class="ident" id="5377441">advance</span><span class="op" id="5377448">++</span>&nbsp;<span class="op" id="5377451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377456">fj</span>&nbsp;<span class="op" id="5377459">:=</span>&nbsp;<span class="ident" id="5377462">fields</span><span class="op" id="5377468">[</span><span class="ident" id="5377469">i</span><span class="op" id="5377470">+</span><span class="ident" id="5377471">advance</span><span class="op" id="5377478">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377483">if</span>&nbsp;<span class="ident" id="5377486">fj</span><span class="op" id="5377488">.</span><span class="ident" id="5377489">name</span>&nbsp;<span class="op" id="5377494">!=</span>&nbsp;<span class="ident" id="5377497">name</span>&nbsp;<span class="op" id="5377502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377508">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377517">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377525">if</span>&nbsp;<span class="ident" id="5377528">advance</span>&nbsp;<span class="op" id="5377536">==</span>&nbsp;<span class="num" id="5377539">1</span>&nbsp;<span class="op" id="5377541">{</span>&nbsp;<span class="comment" id="5377543">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377579">out</span>&nbsp;<span class="op" id="5377583">=</span>&nbsp;<span class="builtinfunc" id="5377585">append</span><span class="op" id="5377591">(</span><span class="ident" id="5377592">out</span><span class="op" id="5377595">,</span>&nbsp;<span class="ident" id="5377597">fi</span><span class="op" id="5377599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377604">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377615">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377619">dominant</span><span class="op" id="5377627">,</span>&nbsp;<span class="ident" id="5377629">ok</span>&nbsp;<span class="op" id="5377632">:=</span>&nbsp;<span class="ident" id="5377635">dominantField</span><span class="op" id="5377648">(</span><span class="ident" id="5377649">fields</span><span class="op" id="5377655">[</span><span class="ident" id="5377656">i</span>&nbsp;<span class="op" id="5377658">:</span>&nbsp;<span class="ident" id="5377660">i</span><span class="op" id="5377661">+</span><span class="ident" id="5377662">advance</span><span class="op" id="5377669">]</span><span class="op" id="5377670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377674">if</span>&nbsp;<span class="ident" id="5377677">ok</span>&nbsp;<span class="op" id="5377680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377685">out</span>&nbsp;<span class="op" id="5377689">=</span>&nbsp;<span class="builtinfunc" id="5377691">append</span><span class="op" id="5377697">(</span><span class="ident" id="5377698">out</span><span class="op" id="5377701">,</span>&nbsp;<span class="ident" id="5377703">dominant</span><span class="op" id="5377711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377718">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377722">fields</span>&nbsp;<span class="op" id="5377729">=</span>&nbsp;<span class="ident" id="5377731">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377736">sort</span><span class="op" id="5377740">.</span><span class="ident" id="5377741">Sort</span><span class="op" id="5377745">(</span><span class="ident" id="5377746">byIndex</span><span class="op" id="5377753">(</span><span class="ident" id="5377754">fields</span><span class="op" id="5377760">)</span><span class="op" id="5377761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377765">return</span>&nbsp;<span class="ident" id="5377772">fields</span><br>
<span class="lineno">1115</span><span class="op" id="5377779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5377782">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5377851">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5377918">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="5377984">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="5378050">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="5378117">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="5378132">func</span>&nbsp;<span class="ident" id="5378137">dominantField</span><span class="op" id="5378150">(</span><span class="ident" id="5378151">fields</span>&nbsp;<span class="op" id="5378158">[</span><span class="op" id="5378159">]</span><span class="ident" id="5378160">field</span><span class="op" id="5378165">)</span>&nbsp;<span class="op" id="5378167">(</span><span class="ident" id="5378168">field</span><span class="op" id="5378173">,</span>&nbsp;<span class="builtintype" id="5378175">bool</span><span class="op" id="5378179">)</span>&nbsp;<span class="op" id="5378181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378184">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378255">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378322">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378382">length</span>&nbsp;<span class="op" id="5378389">:=</span>&nbsp;<span class="builtinfunc" id="5378392">len</span><span class="op" id="5378395">(</span><span class="ident" id="5378396">fields</span><span class="op" id="5378402">[</span><span class="num" id="5378403">0</span><span class="op" id="5378404">]</span><span class="op" id="5378405">.</span><span class="ident" id="5378406">index</span><span class="op" id="5378411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378414">tagged</span>&nbsp;<span class="op" id="5378421">:=</span>&nbsp;<span class="op" id="5378424">-</span><span class="num" id="5378425">1</span>&nbsp;<span class="comment" id="5378427">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378460">for</span>&nbsp;<span class="ident" id="5378464">i</span><span class="op" id="5378465">,</span>&nbsp;<span class="ident" id="5378467">f</span>&nbsp;<span class="op" id="5378469">:=</span>&nbsp;<span class="keyword" id="5378472">range</span>&nbsp;<span class="ident" id="5378478">fields</span>&nbsp;<span class="op" id="5378485">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378489">if</span>&nbsp;<span class="builtinfunc" id="5378492">len</span><span class="op" id="5378495">(</span><span class="ident" id="5378496">f</span><span class="op" id="5378497">.</span><span class="ident" id="5378498">index</span><span class="op" id="5378503">)</span>&nbsp;<span class="op" id="5378505">&gt;</span>&nbsp;<span class="ident" id="5378507">length</span>&nbsp;<span class="op" id="5378514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378519">fields</span>&nbsp;<span class="op" id="5378526">=</span>&nbsp;<span class="ident" id="5378528">fields</span><span class="op" id="5378534">[</span><span class="op" id="5378535">:</span><span class="ident" id="5378536">i</span><span class="op" id="5378537">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378542">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378554">if</span>&nbsp;<span class="ident" id="5378557">f</span><span class="op" id="5378558">.</span><span class="ident" id="5378559">tag</span>&nbsp;<span class="op" id="5378563">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378568">if</span>&nbsp;<span class="ident" id="5378571">tagged</span>&nbsp;<span class="op" id="5378578">&gt;=</span>&nbsp;<span class="num" id="5378581">0</span>&nbsp;<span class="op" id="5378583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378589">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378648">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378672">return</span>&nbsp;<span class="ident" id="5378679">field</span><span class="op" id="5378684">{</span><span class="op" id="5378685">}</span><span class="op" id="5378686">,</span>&nbsp;<span class="builtintype" id="5378688">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378697">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378702">tagged</span>&nbsp;<span class="op" id="5378709">=</span>&nbsp;<span class="ident" id="5378711">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378721">if</span>&nbsp;<span class="ident" id="5378724">tagged</span>&nbsp;<span class="op" id="5378731">&gt;=</span>&nbsp;<span class="num" id="5378734">0</span>&nbsp;<span class="op" id="5378736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378740">return</span>&nbsp;<span class="ident" id="5378747">fields</span><span class="op" id="5378753">[</span><span class="ident" id="5378754">tagged</span><span class="op" id="5378760">]</span><span class="op" id="5378761">,</span>&nbsp;<span class="builtintype" id="5378763">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378772">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378845">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5378916">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378937">if</span>&nbsp;<span class="builtinfunc" id="5378940">len</span><span class="op" id="5378943">(</span><span class="ident" id="5378944">fields</span><span class="op" id="5378950">)</span>&nbsp;<span class="op" id="5378952">&gt;</span>&nbsp;<span class="num" id="5378954">1</span>&nbsp;<span class="op" id="5378956">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378960">return</span>&nbsp;<span class="ident" id="5378967">field</span><span class="op" id="5378972">{</span><span class="op" id="5378973">}</span><span class="op" id="5378974">,</span>&nbsp;<span class="builtintype" id="5378976">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378986">return</span>&nbsp;<span class="ident" id="5378993">fields</span><span class="op" id="5378999">[</span><span class="num" id="5379000">0</span><span class="op" id="5379001">]</span><span class="op" id="5379002">,</span>&nbsp;<span class="builtintype" id="5379004">true</span><br>
<span class="lineno"></span><span class="op" id="5379009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="5379012">var</span>&nbsp;<span class="ident" id="5379016">fieldCache</span>&nbsp;<span class="keyword" id="5379027">struct</span>&nbsp;<span class="op" id="5379034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379037">sync</span><span class="op" id="5379041">.</span><span class="ident" id="5379042">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379051">m</span>&nbsp;<span class="keyword" id="5379053">map</span><span class="op" id="5379056">[</span><span class="ident" id="5379057">reflect</span><span class="op" id="5379064">.</span><span class="ident" id="5379065">Type</span><span class="op" id="5379069">]</span><span class="op" id="5379070">[</span><span class="op" id="5379071">]</span><span class="ident" id="5379072">field</span><br>
<span class="lineno"></span><span class="op" id="5379078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="5379081">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="5379161">func</span>&nbsp;<span class="ident" id="5379166">cachedTypeFields</span><span class="op" id="5379182">(</span><span class="ident" id="5379183">t</span>&nbsp;<span class="ident" id="5379185">reflect</span><span class="op" id="5379192">.</span><span class="ident" id="5379193">Type</span><span class="op" id="5379197">)</span>&nbsp;<span class="op" id="5379199">[</span><span class="op" id="5379200">]</span><span class="ident" id="5379201">field</span>&nbsp;<span class="op" id="5379207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379210">fieldCache</span><span class="op" id="5379220">.</span><span class="ident" id="5379221">RLock</span><span class="op" id="5379226">(</span><span class="op" id="5379227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379230">f</span>&nbsp;<span class="op" id="5379232">:=</span>&nbsp;<span class="ident" id="5379235">fieldCache</span><span class="op" id="5379245">.</span><span class="ident" id="5379246">m</span><span class="op" id="5379247">[</span><span class="ident" id="5379248">t</span><span class="op" id="5379249">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379252">fieldCache</span><span class="op" id="5379262">.</span><span class="ident" id="5379263">RUnlock</span><span class="op" id="5379270">(</span><span class="op" id="5379271">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379274">if</span>&nbsp;<span class="ident" id="5379277">f</span>&nbsp;<span class="op" id="5379279">!=</span>&nbsp;<span class="ident" id="5379282">nil</span>&nbsp;<span class="op" id="5379286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379290">return</span>&nbsp;<span class="ident" id="5379297">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5379304">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5379337">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379404">f</span>&nbsp;<span class="op" id="5379406">=</span>&nbsp;<span class="ident" id="5379408">typeFields</span><span class="op" id="5379418">(</span><span class="ident" id="5379419">t</span><span class="op" id="5379420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379423">if</span>&nbsp;<span class="ident" id="5379426">f</span>&nbsp;<span class="op" id="5379428">==</span>&nbsp;<span class="ident" id="5379431">nil</span>&nbsp;<span class="op" id="5379435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379439">f</span>&nbsp;<span class="op" id="5379441">=</span>&nbsp;<span class="op" id="5379443">[</span><span class="op" id="5379444">]</span><span class="ident" id="5379445">field</span><span class="op" id="5379450">{</span><span class="op" id="5379451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379454">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379458">fieldCache</span><span class="op" id="5379468">.</span><span class="ident" id="5379469">Lock</span><span class="op" id="5379473">(</span><span class="op" id="5379474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379477">if</span>&nbsp;<span class="ident" id="5379480">fieldCache</span><span class="op" id="5379490">.</span><span class="ident" id="5379491">m</span>&nbsp;<span class="op" id="5379493">==</span>&nbsp;<span class="ident" id="5379496">nil</span>&nbsp;<span class="op" id="5379500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379504">fieldCache</span><span class="op" id="5379514">.</span><span class="ident" id="5379515">m</span>&nbsp;<span class="op" id="5379517">=</span>&nbsp;<span class="keyword" id="5379519">map</span><span class="op" id="5379522">[</span><span class="ident" id="5379523">reflect</span><span class="op" id="5379530">.</span><span class="ident" id="5379531">Type</span><span class="op" id="5379535">]</span><span class="op" id="5379536">[</span><span class="op" id="5379537">]</span><span class="ident" id="5379538">field</span><span class="op" id="5379543">{</span><span class="op" id="5379544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379547">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379550">fieldCache</span><span class="op" id="5379560">.</span><span class="ident" id="5379561">m</span><span class="op" id="5379562">[</span><span class="ident" id="5379563">t</span><span class="op" id="5379564">]</span>&nbsp;<span class="op" id="5379566">=</span>&nbsp;<span class="ident" id="5379568">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379571">fieldCache</span><span class="op" id="5379581">.</span><span class="ident" id="5379582">Unlock</span><span class="op" id="5379588">(</span><span class="op" id="5379589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379592">return</span>&nbsp;<span class="ident" id="5379599">f</span><br>
<span class="lineno"></span><span class="op" id="5379601">}</span>
</div>
</body>
</html>
