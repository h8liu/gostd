<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2089509">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2089564">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2089618">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2089669">//&nbsp;Time-related&nbsp;runtime&nbsp;and&nbsp;pieces&nbsp;of&nbsp;package&nbsp;time.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2089722">package</span>&nbsp;<span class="ident" id="2089730">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2089739">import</span>&nbsp;<span class="string" id="2089746">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="2089756">//&nbsp;Package&nbsp;time&nbsp;knows&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="2089808">//&nbsp;If&nbsp;this&nbsp;struct&nbsp;changes,&nbsp;adjust&nbsp;../time/sleep.go:/runtimeTimer.</span><br>
<span class="lineno"></span><span class="comment" id="2089874">//&nbsp;For&nbsp;GOOS=nacl,&nbsp;package&nbsp;syscall&nbsp;knows&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="2089944">//&nbsp;If&nbsp;this&nbsp;struct&nbsp;changes,&nbsp;adjust&nbsp;../syscall/net_nacl.go:/runtimeTimer.</span><br>
<span class="lineno">15</span><span class="keyword" id="2090016">type</span>&nbsp;<span class="ident" id="2090021">timer</span>&nbsp;<span class="keyword" id="2090027">struct</span>&nbsp;<span class="op" id="2090034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090037">i</span>&nbsp;<span class="builtintype" id="2090039">int</span>&nbsp;<span class="comment" id="2090043">//&nbsp;heap&nbsp;index</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2090059">//&nbsp;Timer&nbsp;wakes&nbsp;up&nbsp;at&nbsp;when,&nbsp;and&nbsp;then&nbsp;at&nbsp;when+period,&nbsp;...&nbsp;(period&nbsp;&gt;&nbsp;0&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2090134">//&nbsp;each&nbsp;time&nbsp;calling&nbsp;f(now,&nbsp;arg)&nbsp;in&nbsp;the&nbsp;timer&nbsp;goroutine,&nbsp;so&nbsp;f&nbsp;must&nbsp;be</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2090205">//&nbsp;a&nbsp;well-behaved&nbsp;function&nbsp;and&nbsp;not&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090248">when</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2090255">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090262">period</span>&nbsp;<span class="ident" id="2090269">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090276">f</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2090283">func</span><span class="op" id="2090287">(</span><span class="keyword" id="2090288">interface</span><span class="op" id="2090297">{</span><span class="op" id="2090298">}</span><span class="op" id="2090299">,</span>&nbsp;<span class="builtintype" id="2090301">uintptr</span><span class="op" id="2090308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090311">arg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2090318">interface</span><span class="op" id="2090327">{</span><span class="op" id="2090328">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090331">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2090338">uintptr</span><br>
<span class="lineno"></span><span class="op" id="2090346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2090349">var</span>&nbsp;<span class="ident" id="2090353">timers</span>&nbsp;<span class="keyword" id="2090360">struct</span>&nbsp;<span class="op" id="2090367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090370">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2090383">mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090390">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2090403">*</span><span class="ident" id="2090404">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090407">created</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2090420">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090426">sleeping</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2090439">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090445">rescheduling</span>&nbsp;<span class="builtintype" id="2090458">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090464">waitnote</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2090477">note</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090483">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2090496">[</span><span class="op" id="2090497">]</span><span class="op" id="2090498">*</span><span class="ident" id="2090499">timer</span><br>
<span class="lineno"></span><span class="op" id="2090505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2090508">//&nbsp;nacl&nbsp;fake&nbsp;time&nbsp;support&nbsp;-&nbsp;time&nbsp;in&nbsp;nanoseconds&nbsp;since&nbsp;1970</span><br>
<span class="lineno"></span><span class="keyword" id="2090567">var</span>&nbsp;<span class="ident" id="2090571">faketime</span>&nbsp;<span class="ident" id="2090580">int64</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="2090587">//&nbsp;Package&nbsp;time&nbsp;APIs.</span><br>
<span class="lineno"></span><span class="comment" id="2090609">//&nbsp;Godoc&nbsp;uses&nbsp;the&nbsp;comments&nbsp;in&nbsp;package&nbsp;time,&nbsp;not&nbsp;these.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2090665">//&nbsp;time.now&nbsp;is&nbsp;implemented&nbsp;in&nbsp;assembly.</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="2090706">//&nbsp;Sleep&nbsp;puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;sleep&nbsp;for&nbsp;at&nbsp;least&nbsp;ns&nbsp;nanoseconds.</span><br>
<span class="lineno"></span><span class="keyword" id="2090780">func</span>&nbsp;<span class="ident" id="2090785">timeSleep</span><span class="op" id="2090794">(</span><span class="ident" id="2090795">ns</span>&nbsp;<span class="ident" id="2090798">int64</span><span class="op" id="2090803">)</span>&nbsp;<span class="op" id="2090805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2090808">if</span>&nbsp;<span class="ident" id="2090811">ns</span>&nbsp;<span class="op" id="2090814">&lt;=</span>&nbsp;<span class="num" id="2090817">0</span>&nbsp;<span class="op" id="2090819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2090823">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2090831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090835">t</span>&nbsp;<span class="op" id="2090837">:=</span>&nbsp;<span class="builtinfunc" id="2090840">new</span><span class="op" id="2090843">(</span><span class="ident" id="2090844">timer</span><span class="op" id="2090849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090852">t</span><span class="op" id="2090853">.</span><span class="ident" id="2090854">when</span>&nbsp;<span class="op" id="2090859">=</span>&nbsp;<span class="ident" id="2090861">nanotime</span><span class="op" id="2090869">(</span><span class="op" id="2090870">)</span>&nbsp;<span class="op" id="2090872">+</span>&nbsp;<span class="ident" id="2090874">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090878">t</span><span class="op" id="2090879">.</span><span class="ident" id="2090880">f</span>&nbsp;<span class="op" id="2090882">=</span>&nbsp;<span class="ident" id="2090884">goroutineReady</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090900">t</span><span class="op" id="2090901">.</span><span class="ident" id="2090902">arg</span>&nbsp;<span class="op" id="2090906">=</span>&nbsp;<span class="ident" id="2090908">getg</span><span class="op" id="2090912">(</span><span class="op" id="2090913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090916">lock</span><span class="op" id="2090920">(</span><span class="op" id="2090921">&amp;</span><span class="ident" id="2090922">timers</span><span class="op" id="2090928">.</span><span class="ident" id="2090929">lock</span><span class="op" id="2090933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090936">addtimerLocked</span><span class="op" id="2090950">(</span><span class="ident" id="2090951">t</span><span class="op" id="2090952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2090955">goparkunlock</span><span class="op" id="2090967">(</span><span class="op" id="2090968">&amp;</span><span class="ident" id="2090969">timers</span><span class="op" id="2090975">.</span><span class="ident" id="2090976">lock</span><span class="op" id="2090980">,</span>&nbsp;<span class="string" id="2090982">&#34;sleep&#34;</span><span class="op" id="2090989">)</span><br>
<span class="lineno"></span><span class="op" id="2090991">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="2090994">//&nbsp;startTimer&nbsp;adds&nbsp;t&nbsp;to&nbsp;the&nbsp;timer&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="2091034">func</span>&nbsp;<span class="ident" id="2091039">startTimer</span><span class="op" id="2091049">(</span><span class="ident" id="2091050">t</span>&nbsp;<span class="op" id="2091052">*</span><span class="ident" id="2091053">timer</span><span class="op" id="2091058">)</span>&nbsp;<span class="op" id="2091060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2091063">if</span>&nbsp;<span class="ident" id="2091066">raceenabled</span>&nbsp;<span class="op" id="2091078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091082">racerelease</span><span class="op" id="2091093">(</span><span class="ident" id="2091094">unsafe</span><span class="op" id="2091100">.</span><span class="ident" id="2091101">Pointer</span><span class="op" id="2091108">(</span><span class="ident" id="2091109">t</span><span class="op" id="2091110">)</span><span class="op" id="2091111">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2091114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091117">addtimer</span><span class="op" id="2091125">(</span><span class="ident" id="2091126">t</span><span class="op" id="2091127">)</span><br>
<span class="lineno"></span><span class="op" id="2091129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2091132">//&nbsp;stopTimer&nbsp;removes&nbsp;t&nbsp;from&nbsp;the&nbsp;timer&nbsp;heap&nbsp;if&nbsp;it&nbsp;is&nbsp;there.</span><br>
<span class="lineno">70</span><span class="comment" id="2091191">//&nbsp;It&nbsp;returns&nbsp;true&nbsp;if&nbsp;t&nbsp;was&nbsp;removed,&nbsp;false&nbsp;if&nbsp;t&nbsp;wasn&#39;t&nbsp;even&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="2091258">func</span>&nbsp;<span class="ident" id="2091263">stopTimer</span><span class="op" id="2091272">(</span><span class="ident" id="2091273">t</span>&nbsp;<span class="op" id="2091275">*</span><span class="ident" id="2091276">timer</span><span class="op" id="2091281">)</span>&nbsp;<span class="builtintype" id="2091283">bool</span>&nbsp;<span class="op" id="2091288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2091291">return</span>&nbsp;<span class="ident" id="2091298">deltimer</span><span class="op" id="2091306">(</span><span class="ident" id="2091307">t</span><span class="op" id="2091308">)</span><br>
<span class="lineno"></span><span class="op" id="2091310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="2091313">//&nbsp;Go&nbsp;runtime.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2091329">//&nbsp;Ready&nbsp;the&nbsp;goroutine&nbsp;arg.</span><br>
<span class="lineno"></span><span class="keyword" id="2091357">func</span>&nbsp;<span class="ident" id="2091362">goroutineReady</span><span class="op" id="2091376">(</span><span class="ident" id="2091377">arg</span>&nbsp;<span class="keyword" id="2091381">interface</span><span class="op" id="2091390">{</span><span class="op" id="2091391">}</span><span class="op" id="2091392">,</span>&nbsp;<span class="ident" id="2091394">seq</span>&nbsp;<span class="builtintype" id="2091398">uintptr</span><span class="op" id="2091405">)</span>&nbsp;<span class="op" id="2091407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091410">goready</span><span class="op" id="2091417">(</span><span class="ident" id="2091418">arg</span><span class="op" id="2091421">.</span><span class="op" id="2091422">(</span><span class="op" id="2091423">*</span><span class="ident" id="2091424">g</span><span class="op" id="2091425">)</span><span class="op" id="2091426">)</span><br>
<span class="lineno">80</span><span class="op" id="2091428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2091431">func</span>&nbsp;<span class="ident" id="2091436">addtimer</span><span class="op" id="2091444">(</span><span class="ident" id="2091445">t</span>&nbsp;<span class="op" id="2091447">*</span><span class="ident" id="2091448">timer</span><span class="op" id="2091453">)</span>&nbsp;<span class="op" id="2091455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091458">lock</span><span class="op" id="2091462">(</span><span class="op" id="2091463">&amp;</span><span class="ident" id="2091464">timers</span><span class="op" id="2091470">.</span><span class="ident" id="2091471">lock</span><span class="op" id="2091475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091478">addtimerLocked</span><span class="op" id="2091492">(</span><span class="ident" id="2091493">t</span><span class="op" id="2091494">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091497">unlock</span><span class="op" id="2091503">(</span><span class="op" id="2091504">&amp;</span><span class="ident" id="2091505">timers</span><span class="op" id="2091511">.</span><span class="ident" id="2091512">lock</span><span class="op" id="2091516">)</span><br>
<span class="lineno"></span><span class="op" id="2091518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2091521">//&nbsp;Add&nbsp;a&nbsp;timer&nbsp;to&nbsp;the&nbsp;heap&nbsp;and&nbsp;start&nbsp;or&nbsp;kick&nbsp;the&nbsp;timer&nbsp;proc.</span><br>
<span class="lineno"></span><span class="comment" id="2091582">//&nbsp;If&nbsp;the&nbsp;new&nbsp;timer&nbsp;is&nbsp;earlier&nbsp;than&nbsp;any&nbsp;of&nbsp;the&nbsp;others.</span><br>
<span class="lineno">90</span><span class="comment" id="2091637">//&nbsp;Timers&nbsp;are&nbsp;locked.</span><br>
<span class="lineno"></span><span class="keyword" id="2091659">func</span>&nbsp;<span class="ident" id="2091664">addtimerLocked</span><span class="op" id="2091678">(</span><span class="ident" id="2091679">t</span>&nbsp;<span class="op" id="2091681">*</span><span class="ident" id="2091682">timer</span><span class="op" id="2091687">)</span>&nbsp;<span class="op" id="2091689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2091692">//&nbsp;when&nbsp;must&nbsp;never&nbsp;be&nbsp;negative;&nbsp;otherwise&nbsp;timerproc&nbsp;will&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2091759">//&nbsp;during&nbsp;its&nbsp;delta&nbsp;calculation&nbsp;and&nbsp;never&nbsp;expire&nbsp;other&nbsp;runtime·timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2091832">if</span>&nbsp;<span class="ident" id="2091835">t</span><span class="op" id="2091836">.</span><span class="ident" id="2091837">when</span>&nbsp;<span class="op" id="2091842">&lt;</span>&nbsp;<span class="num" id="2091844">0</span>&nbsp;<span class="op" id="2091846">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091850">t</span><span class="op" id="2091851">.</span><span class="ident" id="2091852">when</span>&nbsp;<span class="op" id="2091857">=</span>&nbsp;<span class="num" id="2091859">1</span><span class="op" id="2091860">&lt;&lt;</span><span class="num" id="2091862">63</span>&nbsp;<span class="op" id="2091865">-</span>&nbsp;<span class="num" id="2091867">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2091870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091873">t</span><span class="op" id="2091874">.</span><span class="ident" id="2091875">i</span>&nbsp;<span class="op" id="2091877">=</span>&nbsp;<span class="builtinfunc" id="2091879">len</span><span class="op" id="2091882">(</span><span class="ident" id="2091883">timers</span><span class="op" id="2091889">.</span><span class="ident" id="2091890">t</span><span class="op" id="2091891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091894">timers</span><span class="op" id="2091900">.</span><span class="ident" id="2091901">t</span>&nbsp;<span class="op" id="2091903">=</span>&nbsp;<span class="builtinfunc" id="2091905">append</span><span class="op" id="2091911">(</span><span class="ident" id="2091912">timers</span><span class="op" id="2091918">.</span><span class="ident" id="2091919">t</span><span class="op" id="2091920">,</span>&nbsp;<span class="ident" id="2091922">t</span><span class="op" id="2091923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2091926">siftupTimer</span><span class="op" id="2091937">(</span><span class="ident" id="2091938">t</span><span class="op" id="2091939">.</span><span class="ident" id="2091940">i</span><span class="op" id="2091941">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2091944">if</span>&nbsp;<span class="ident" id="2091947">t</span><span class="op" id="2091948">.</span><span class="ident" id="2091949">i</span>&nbsp;<span class="op" id="2091951">==</span>&nbsp;<span class="num" id="2091954">0</span>&nbsp;<span class="op" id="2091956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2091960">//&nbsp;siftup&nbsp;moved&nbsp;to&nbsp;top:&nbsp;new&nbsp;earliest&nbsp;deadline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092009">if</span>&nbsp;<span class="ident" id="2092012">timers</span><span class="op" id="2092018">.</span><span class="ident" id="2092019">sleeping</span>&nbsp;<span class="op" id="2092028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092033">timers</span><span class="op" id="2092039">.</span><span class="ident" id="2092040">sleeping</span>&nbsp;<span class="op" id="2092049">=</span>&nbsp;<span class="builtintype" id="2092051">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092060">notewakeup</span><span class="op" id="2092070">(</span><span class="op" id="2092071">&amp;</span><span class="ident" id="2092072">timers</span><span class="op" id="2092078">.</span><span class="ident" id="2092079">waitnote</span><span class="op" id="2092087">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092095">if</span>&nbsp;<span class="ident" id="2092098">timers</span><span class="op" id="2092104">.</span><span class="ident" id="2092105">rescheduling</span>&nbsp;<span class="op" id="2092118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092123">timers</span><span class="op" id="2092129">.</span><span class="ident" id="2092130">rescheduling</span>&nbsp;<span class="op" id="2092143">=</span>&nbsp;<span class="builtintype" id="2092145">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092154">goready</span><span class="op" id="2092161">(</span><span class="ident" id="2092162">timers</span><span class="op" id="2092168">.</span><span class="ident" id="2092169">gp</span><span class="op" id="2092171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092175">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092181">if</span>&nbsp;<span class="op" id="2092184">!</span><span class="ident" id="2092185">timers</span><span class="op" id="2092191">.</span><span class="ident" id="2092192">created</span>&nbsp;<span class="op" id="2092200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092204">timers</span><span class="op" id="2092210">.</span><span class="ident" id="2092211">created</span>&nbsp;<span class="op" id="2092219">=</span>&nbsp;<span class="builtintype" id="2092221">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092228">go</span>&nbsp;<span class="ident" id="2092231">timerproc</span><span class="op" id="2092240">(</span><span class="op" id="2092241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092244">}</span><br>
<span class="lineno">115</span><span class="op" id="2092246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2092249">//&nbsp;Delete&nbsp;timer&nbsp;t&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="comment" id="2092282">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;update&nbsp;the&nbsp;timerproc:&nbsp;if&nbsp;it&nbsp;wakes&nbsp;up&nbsp;early,&nbsp;no&nbsp;big&nbsp;deal.</span><br>
<span class="lineno"></span><span class="keyword" id="2092357">func</span>&nbsp;<span class="ident" id="2092362">deltimer</span><span class="op" id="2092370">(</span><span class="ident" id="2092371">t</span>&nbsp;<span class="op" id="2092373">*</span><span class="ident" id="2092374">timer</span><span class="op" id="2092379">)</span>&nbsp;<span class="builtintype" id="2092381">bool</span>&nbsp;<span class="op" id="2092386">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2092389">//&nbsp;Dereference&nbsp;t&nbsp;so&nbsp;that&nbsp;any&nbsp;panic&nbsp;happens&nbsp;before&nbsp;the&nbsp;lock&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2092458">//&nbsp;Discard&nbsp;result,&nbsp;because&nbsp;t&nbsp;might&nbsp;be&nbsp;moving&nbsp;in&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092517">_</span>&nbsp;<span class="op" id="2092519">=</span>&nbsp;<span class="ident" id="2092521">t</span><span class="op" id="2092522">.</span><span class="ident" id="2092523">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092527">lock</span><span class="op" id="2092531">(</span><span class="op" id="2092532">&amp;</span><span class="ident" id="2092533">timers</span><span class="op" id="2092539">.</span><span class="ident" id="2092540">lock</span><span class="op" id="2092544">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2092547">//&nbsp;t&nbsp;may&nbsp;not&nbsp;be&nbsp;registered&nbsp;anymore&nbsp;and&nbsp;may&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2092596">//&nbsp;a&nbsp;bogus&nbsp;i&nbsp;(typically&nbsp;0,&nbsp;if&nbsp;generated&nbsp;by&nbsp;Go).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2092645">//&nbsp;Verify&nbsp;it&nbsp;before&nbsp;proceeding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092678">i</span>&nbsp;<span class="op" id="2092680">:=</span>&nbsp;<span class="ident" id="2092683">t</span><span class="op" id="2092684">.</span><span class="ident" id="2092685">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092688">last</span>&nbsp;<span class="op" id="2092693">:=</span>&nbsp;<span class="builtinfunc" id="2092696">len</span><span class="op" id="2092699">(</span><span class="ident" id="2092700">timers</span><span class="op" id="2092706">.</span><span class="ident" id="2092707">t</span><span class="op" id="2092708">)</span>&nbsp;<span class="op" id="2092710">-</span>&nbsp;<span class="num" id="2092712">1</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092715">if</span>&nbsp;<span class="ident" id="2092718">i</span>&nbsp;<span class="op" id="2092720">&lt;</span>&nbsp;<span class="num" id="2092722">0</span>&nbsp;<span class="op" id="2092724">||</span>&nbsp;<span class="ident" id="2092727">i</span>&nbsp;<span class="op" id="2092729">&gt;</span>&nbsp;<span class="ident" id="2092731">last</span>&nbsp;<span class="op" id="2092736">||</span>&nbsp;<span class="ident" id="2092739">timers</span><span class="op" id="2092745">.</span><span class="ident" id="2092746">t</span><span class="op" id="2092747">[</span><span class="ident" id="2092748">i</span><span class="op" id="2092749">]</span>&nbsp;<span class="op" id="2092751">!=</span>&nbsp;<span class="ident" id="2092754">t</span>&nbsp;<span class="op" id="2092756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092760">unlock</span><span class="op" id="2092766">(</span><span class="op" id="2092767">&amp;</span><span class="ident" id="2092768">timers</span><span class="op" id="2092774">.</span><span class="ident" id="2092775">lock</span><span class="op" id="2092779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092783">return</span>&nbsp;<span class="builtintype" id="2092790">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092800">if</span>&nbsp;<span class="ident" id="2092803">i</span>&nbsp;<span class="op" id="2092805">!=</span>&nbsp;<span class="ident" id="2092808">last</span>&nbsp;<span class="op" id="2092813">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092817">timers</span><span class="op" id="2092823">.</span><span class="ident" id="2092824">t</span><span class="op" id="2092825">[</span><span class="ident" id="2092826">i</span><span class="op" id="2092827">]</span>&nbsp;<span class="op" id="2092829">=</span>&nbsp;<span class="ident" id="2092831">timers</span><span class="op" id="2092837">.</span><span class="ident" id="2092838">t</span><span class="op" id="2092839">[</span><span class="ident" id="2092840">last</span><span class="op" id="2092844">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092848">timers</span><span class="op" id="2092854">.</span><span class="ident" id="2092855">t</span><span class="op" id="2092856">[</span><span class="ident" id="2092857">i</span><span class="op" id="2092858">]</span><span class="op" id="2092859">.</span><span class="ident" id="2092860">i</span>&nbsp;<span class="op" id="2092862">=</span>&nbsp;<span class="ident" id="2092864">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092870">timers</span><span class="op" id="2092876">.</span><span class="ident" id="2092877">t</span><span class="op" id="2092878">[</span><span class="ident" id="2092879">last</span><span class="op" id="2092883">]</span>&nbsp;<span class="op" id="2092885">=</span>&nbsp;<span class="ident" id="2092887">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092892">timers</span><span class="op" id="2092898">.</span><span class="ident" id="2092899">t</span>&nbsp;<span class="op" id="2092901">=</span>&nbsp;<span class="ident" id="2092903">timers</span><span class="op" id="2092909">.</span><span class="ident" id="2092910">t</span><span class="op" id="2092911">[</span><span class="op" id="2092912">:</span><span class="ident" id="2092913">last</span><span class="op" id="2092917">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092920">if</span>&nbsp;<span class="ident" id="2092923">i</span>&nbsp;<span class="op" id="2092925">!=</span>&nbsp;<span class="ident" id="2092928">last</span>&nbsp;<span class="op" id="2092933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092937">siftupTimer</span><span class="op" id="2092948">(</span><span class="ident" id="2092949">i</span><span class="op" id="2092950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092954">siftdownTimer</span><span class="op" id="2092967">(</span><span class="ident" id="2092968">i</span><span class="op" id="2092969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2092972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2092975">unlock</span><span class="op" id="2092981">(</span><span class="op" id="2092982">&amp;</span><span class="ident" id="2092983">timers</span><span class="op" id="2092989">.</span><span class="ident" id="2092990">lock</span><span class="op" id="2092994">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2092997">return</span>&nbsp;<span class="builtintype" id="2093004">true</span><br>
<span class="lineno"></span><span class="op" id="2093009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2093012">//&nbsp;Timerproc&nbsp;runs&nbsp;the&nbsp;time-driven&nbsp;events.</span><br>
<span class="lineno"></span><span class="comment" id="2093054">//&nbsp;It&nbsp;sleeps&nbsp;until&nbsp;the&nbsp;next&nbsp;event&nbsp;in&nbsp;the&nbsp;timers&nbsp;heap.</span><br>
<span class="lineno">150</span><span class="comment" id="2093108">//&nbsp;If&nbsp;addtimer&nbsp;inserts&nbsp;a&nbsp;new&nbsp;earlier&nbsp;event,&nbsp;addtimer1&nbsp;wakes&nbsp;timerproc&nbsp;early.</span><br>
<span class="lineno"></span><span class="keyword" id="2093185">func</span>&nbsp;<span class="ident" id="2093190">timerproc</span><span class="op" id="2093199">(</span><span class="op" id="2093200">)</span>&nbsp;<span class="op" id="2093202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093205">timers</span><span class="op" id="2093211">.</span><span class="ident" id="2093212">gp</span>&nbsp;<span class="op" id="2093215">=</span>&nbsp;<span class="ident" id="2093217">getg</span><span class="op" id="2093221">(</span><span class="op" id="2093222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093225">timers</span><span class="op" id="2093231">.</span><span class="ident" id="2093232">gp</span><span class="op" id="2093234">.</span><span class="ident" id="2093235">issystem</span>&nbsp;<span class="op" id="2093244">=</span>&nbsp;<span class="builtintype" id="2093246">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093252">for</span>&nbsp;<span class="op" id="2093256">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093260">lock</span><span class="op" id="2093264">(</span><span class="op" id="2093265">&amp;</span><span class="ident" id="2093266">timers</span><span class="op" id="2093272">.</span><span class="ident" id="2093273">lock</span><span class="op" id="2093277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093281">timers</span><span class="op" id="2093287">.</span><span class="ident" id="2093288">sleeping</span>&nbsp;<span class="op" id="2093297">=</span>&nbsp;<span class="builtintype" id="2093299">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093307">now</span>&nbsp;<span class="op" id="2093311">:=</span>&nbsp;<span class="ident" id="2093314">nanotime</span><span class="op" id="2093322">(</span><span class="op" id="2093323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093327">delta</span>&nbsp;<span class="op" id="2093333">:=</span>&nbsp;<span class="ident" id="2093336">int64</span><span class="op" id="2093341">(</span><span class="op" id="2093342">-</span><span class="num" id="2093343">1</span><span class="op" id="2093344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093348">for</span>&nbsp;<span class="op" id="2093352">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093357">if</span>&nbsp;<span class="builtinfunc" id="2093360">len</span><span class="op" id="2093363">(</span><span class="ident" id="2093364">timers</span><span class="op" id="2093370">.</span><span class="ident" id="2093371">t</span><span class="op" id="2093372">)</span>&nbsp;<span class="op" id="2093374">==</span>&nbsp;<span class="num" id="2093377">0</span>&nbsp;<span class="op" id="2093379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093385">delta</span>&nbsp;<span class="op" id="2093391">=</span>&nbsp;<span class="op" id="2093393">-</span><span class="num" id="2093394">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093400">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2093409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093414">t</span>&nbsp;<span class="op" id="2093416">:=</span>&nbsp;<span class="ident" id="2093419">timers</span><span class="op" id="2093425">.</span><span class="ident" id="2093426">t</span><span class="op" id="2093427">[</span><span class="num" id="2093428">0</span><span class="op" id="2093429">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093434">delta</span>&nbsp;<span class="op" id="2093440">=</span>&nbsp;<span class="ident" id="2093442">t</span><span class="op" id="2093443">.</span><span class="ident" id="2093444">when</span>&nbsp;<span class="op" id="2093449">-</span>&nbsp;<span class="ident" id="2093451">now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093458">if</span>&nbsp;<span class="ident" id="2093461">delta</span>&nbsp;<span class="op" id="2093467">&gt;</span>&nbsp;<span class="num" id="2093469">0</span>&nbsp;<span class="op" id="2093471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093477">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2093486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093491">if</span>&nbsp;<span class="ident" id="2093494">t</span><span class="op" id="2093495">.</span><span class="ident" id="2093496">period</span>&nbsp;<span class="op" id="2093503">&gt;</span>&nbsp;<span class="num" id="2093505">0</span>&nbsp;<span class="op" id="2093507">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2093513">//&nbsp;leave&nbsp;in&nbsp;heap&nbsp;but&nbsp;adjust&nbsp;next&nbsp;time&nbsp;to&nbsp;fire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093563">t</span><span class="op" id="2093564">.</span><span class="ident" id="2093565">when</span>&nbsp;<span class="op" id="2093570">+=</span>&nbsp;<span class="ident" id="2093573">t</span><span class="op" id="2093574">.</span><span class="ident" id="2093575">period</span>&nbsp;<span class="op" id="2093582">*</span>&nbsp;<span class="op" id="2093584">(</span><span class="num" id="2093585">1</span>&nbsp;<span class="op" id="2093587">+</span>&nbsp;<span class="op" id="2093589">-</span><span class="ident" id="2093590">delta</span><span class="op" id="2093595">/</span><span class="ident" id="2093596">t</span><span class="op" id="2093597">.</span><span class="ident" id="2093598">period</span><span class="op" id="2093604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093610">siftdownTimer</span><span class="op" id="2093623">(</span><span class="num" id="2093624">0</span><span class="op" id="2093625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2093630">}</span>&nbsp;<span class="keyword" id="2093632">else</span>&nbsp;<span class="op" id="2093637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2093643">//&nbsp;remove&nbsp;from&nbsp;heap</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093667">last</span>&nbsp;<span class="op" id="2093672">:=</span>&nbsp;<span class="builtinfunc" id="2093675">len</span><span class="op" id="2093678">(</span><span class="ident" id="2093679">timers</span><span class="op" id="2093685">.</span><span class="ident" id="2093686">t</span><span class="op" id="2093687">)</span>&nbsp;<span class="op" id="2093689">-</span>&nbsp;<span class="num" id="2093691">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093697">if</span>&nbsp;<span class="ident" id="2093700">last</span>&nbsp;<span class="op" id="2093705">&gt;</span>&nbsp;<span class="num" id="2093707">0</span>&nbsp;<span class="op" id="2093709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093716">timers</span><span class="op" id="2093722">.</span><span class="ident" id="2093723">t</span><span class="op" id="2093724">[</span><span class="num" id="2093725">0</span><span class="op" id="2093726">]</span>&nbsp;<span class="op" id="2093728">=</span>&nbsp;<span class="ident" id="2093730">timers</span><span class="op" id="2093736">.</span><span class="ident" id="2093737">t</span><span class="op" id="2093738">[</span><span class="ident" id="2093739">last</span><span class="op" id="2093743">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093750">timers</span><span class="op" id="2093756">.</span><span class="ident" id="2093757">t</span><span class="op" id="2093758">[</span><span class="num" id="2093759">0</span><span class="op" id="2093760">]</span><span class="op" id="2093761">.</span><span class="ident" id="2093762">i</span>&nbsp;<span class="op" id="2093764">=</span>&nbsp;<span class="num" id="2093766">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2093772">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093778">timers</span><span class="op" id="2093784">.</span><span class="ident" id="2093785">t</span><span class="op" id="2093786">[</span><span class="ident" id="2093787">last</span><span class="op" id="2093791">]</span>&nbsp;<span class="op" id="2093793">=</span>&nbsp;<span class="ident" id="2093795">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093803">timers</span><span class="op" id="2093809">.</span><span class="ident" id="2093810">t</span>&nbsp;<span class="op" id="2093812">=</span>&nbsp;<span class="ident" id="2093814">timers</span><span class="op" id="2093820">.</span><span class="ident" id="2093821">t</span><span class="op" id="2093822">[</span><span class="op" id="2093823">:</span><span class="ident" id="2093824">last</span><span class="op" id="2093828">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093834">if</span>&nbsp;<span class="ident" id="2093837">last</span>&nbsp;<span class="op" id="2093842">&gt;</span>&nbsp;<span class="num" id="2093844">0</span>&nbsp;<span class="op" id="2093846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093853">siftdownTimer</span><span class="op" id="2093866">(</span><span class="num" id="2093867">0</span><span class="op" id="2093868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2093874">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093880">t</span><span class="op" id="2093881">.</span><span class="ident" id="2093882">i</span>&nbsp;<span class="op" id="2093884">=</span>&nbsp;<span class="op" id="2093886">-</span><span class="num" id="2093887">1</span>&nbsp;<span class="comment" id="2093889">//&nbsp;mark&nbsp;as&nbsp;removed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2093911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093916">f</span>&nbsp;<span class="op" id="2093918">:=</span>&nbsp;<span class="ident" id="2093921">t</span><span class="op" id="2093922">.</span><span class="ident" id="2093923">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093928">arg</span>&nbsp;<span class="op" id="2093932">:=</span>&nbsp;<span class="ident" id="2093935">t</span><span class="op" id="2093936">.</span><span class="ident" id="2093937">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093944">seq</span>&nbsp;<span class="op" id="2093948">:=</span>&nbsp;<span class="ident" id="2093951">t</span><span class="op" id="2093952">.</span><span class="ident" id="2093953">seq</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2093960">unlock</span><span class="op" id="2093966">(</span><span class="op" id="2093967">&amp;</span><span class="ident" id="2093968">timers</span><span class="op" id="2093974">.</span><span class="ident" id="2093975">lock</span><span class="op" id="2093979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2093984">if</span>&nbsp;<span class="ident" id="2093987">raceenabled</span>&nbsp;<span class="op" id="2093999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094005">raceacquire</span><span class="op" id="2094016">(</span><span class="ident" id="2094017">unsafe</span><span class="op" id="2094023">.</span><span class="ident" id="2094024">Pointer</span><span class="op" id="2094031">(</span><span class="ident" id="2094032">t</span><span class="op" id="2094033">)</span><span class="op" id="2094034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094044">f</span><span class="op" id="2094045">(</span><span class="ident" id="2094046">arg</span><span class="op" id="2094049">,</span>&nbsp;<span class="ident" id="2094051">seq</span><span class="op" id="2094054">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094059">lock</span><span class="op" id="2094063">(</span><span class="op" id="2094064">&amp;</span><span class="ident" id="2094065">timers</span><span class="op" id="2094071">.</span><span class="ident" id="2094072">lock</span><span class="op" id="2094076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094084">if</span>&nbsp;<span class="ident" id="2094087">delta</span>&nbsp;<span class="op" id="2094093">&lt;</span>&nbsp;<span class="num" id="2094095">0</span>&nbsp;<span class="op" id="2094097">||</span>&nbsp;<span class="ident" id="2094100">faketime</span>&nbsp;<span class="op" id="2094109">&gt;</span>&nbsp;<span class="num" id="2094111">0</span>&nbsp;<span class="op" id="2094113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2094118">//&nbsp;No&nbsp;timers&nbsp;left&nbsp;-&nbsp;put&nbsp;goroutine&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094165">timers</span><span class="op" id="2094171">.</span><span class="ident" id="2094172">rescheduling</span>&nbsp;<span class="op" id="2094185">=</span>&nbsp;<span class="builtintype" id="2094187">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094195">goparkunlock</span><span class="op" id="2094207">(</span><span class="op" id="2094208">&amp;</span><span class="ident" id="2094209">timers</span><span class="op" id="2094215">.</span><span class="ident" id="2094216">lock</span><span class="op" id="2094220">,</span>&nbsp;<span class="string" id="2094222">&#34;timer&nbsp;goroutine&nbsp;(idle)&#34;</span><span class="op" id="2094246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094251">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2094266">//&nbsp;At&nbsp;least&nbsp;one&nbsp;timer&nbsp;pending.&nbsp;&nbsp;Sleep&nbsp;until&nbsp;then.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094318">timers</span><span class="op" id="2094324">.</span><span class="ident" id="2094325">sleeping</span>&nbsp;<span class="op" id="2094334">=</span>&nbsp;<span class="builtintype" id="2094336">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094343">noteclear</span><span class="op" id="2094352">(</span><span class="op" id="2094353">&amp;</span><span class="ident" id="2094354">timers</span><span class="op" id="2094360">.</span><span class="ident" id="2094361">waitnote</span><span class="op" id="2094369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094373">unlock</span><span class="op" id="2094379">(</span><span class="op" id="2094380">&amp;</span><span class="ident" id="2094381">timers</span><span class="op" id="2094387">.</span><span class="ident" id="2094388">lock</span><span class="op" id="2094392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094396">notetsleepg</span><span class="op" id="2094407">(</span><span class="op" id="2094408">&amp;</span><span class="ident" id="2094409">timers</span><span class="op" id="2094415">.</span><span class="ident" id="2094416">waitnote</span><span class="op" id="2094424">,</span>&nbsp;<span class="ident" id="2094426">delta</span><span class="op" id="2094431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094434">}</span><br>
<span class="lineno"></span><span class="op" id="2094436">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="2094439">func</span>&nbsp;<span class="ident" id="2094444">timejump</span><span class="op" id="2094452">(</span><span class="op" id="2094453">)</span>&nbsp;<span class="op" id="2094455">*</span><span class="ident" id="2094456">g</span>&nbsp;<span class="op" id="2094458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094461">if</span>&nbsp;<span class="ident" id="2094464">faketime</span>&nbsp;<span class="op" id="2094473">==</span>&nbsp;<span class="num" id="2094476">0</span>&nbsp;<span class="op" id="2094478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094482">return</span>&nbsp;<span class="ident" id="2094489">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094494">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094498">lock</span><span class="op" id="2094502">(</span><span class="op" id="2094503">&amp;</span><span class="ident" id="2094504">timers</span><span class="op" id="2094510">.</span><span class="ident" id="2094511">lock</span><span class="op" id="2094515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094518">if</span>&nbsp;<span class="op" id="2094521">!</span><span class="ident" id="2094522">timers</span><span class="op" id="2094528">.</span><span class="ident" id="2094529">created</span>&nbsp;<span class="op" id="2094537">||</span>&nbsp;<span class="builtinfunc" id="2094540">len</span><span class="op" id="2094543">(</span><span class="ident" id="2094544">timers</span><span class="op" id="2094550">.</span><span class="ident" id="2094551">t</span><span class="op" id="2094552">)</span>&nbsp;<span class="op" id="2094554">==</span>&nbsp;<span class="num" id="2094557">0</span>&nbsp;<span class="op" id="2094559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094563">unlock</span><span class="op" id="2094569">(</span><span class="op" id="2094570">&amp;</span><span class="ident" id="2094571">timers</span><span class="op" id="2094577">.</span><span class="ident" id="2094578">lock</span><span class="op" id="2094582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094586">return</span>&nbsp;<span class="ident" id="2094593">nil</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094602">var</span>&nbsp;<span class="ident" id="2094606">gp</span>&nbsp;<span class="op" id="2094609">*</span><span class="ident" id="2094610">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094613">if</span>&nbsp;<span class="ident" id="2094616">faketime</span>&nbsp;<span class="op" id="2094625">&lt;</span>&nbsp;<span class="ident" id="2094627">timers</span><span class="op" id="2094633">.</span><span class="ident" id="2094634">t</span><span class="op" id="2094635">[</span><span class="num" id="2094636">0</span><span class="op" id="2094637">]</span><span class="op" id="2094638">.</span><span class="ident" id="2094639">when</span>&nbsp;<span class="op" id="2094644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094648">faketime</span>&nbsp;<span class="op" id="2094657">=</span>&nbsp;<span class="ident" id="2094659">timers</span><span class="op" id="2094665">.</span><span class="ident" id="2094666">t</span><span class="op" id="2094667">[</span><span class="num" id="2094668">0</span><span class="op" id="2094669">]</span><span class="op" id="2094670">.</span><span class="ident" id="2094671">when</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094678">if</span>&nbsp;<span class="ident" id="2094681">timers</span><span class="op" id="2094687">.</span><span class="ident" id="2094688">rescheduling</span>&nbsp;<span class="op" id="2094701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094706">timers</span><span class="op" id="2094712">.</span><span class="ident" id="2094713">rescheduling</span>&nbsp;<span class="op" id="2094726">=</span>&nbsp;<span class="builtintype" id="2094728">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094737">gp</span>&nbsp;<span class="op" id="2094740">=</span>&nbsp;<span class="ident" id="2094742">timers</span><span class="op" id="2094748">.</span><span class="ident" id="2094749">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094757">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094760">unlock</span><span class="op" id="2094766">(</span><span class="op" id="2094767">&amp;</span><span class="ident" id="2094768">timers</span><span class="op" id="2094774">.</span><span class="ident" id="2094775">lock</span><span class="op" id="2094779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094782">return</span>&nbsp;<span class="ident" id="2094789">gp</span><br>
<span class="lineno"></span><span class="op" id="2094792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2094795">//&nbsp;Heap&nbsp;maintenance&nbsp;algorithms.</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="keyword" id="2094828">func</span>&nbsp;<span class="ident" id="2094833">siftupTimer</span><span class="op" id="2094844">(</span><span class="ident" id="2094845">i</span>&nbsp;<span class="builtintype" id="2094847">int</span><span class="op" id="2094850">)</span>&nbsp;<span class="op" id="2094852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094855">t</span>&nbsp;<span class="op" id="2094857">:=</span>&nbsp;<span class="ident" id="2094860">timers</span><span class="op" id="2094866">.</span><span class="ident" id="2094867">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094870">when</span>&nbsp;<span class="op" id="2094875">:=</span>&nbsp;<span class="ident" id="2094878">t</span><span class="op" id="2094879">[</span><span class="ident" id="2094880">i</span><span class="op" id="2094881">]</span><span class="op" id="2094882">.</span><span class="ident" id="2094883">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094889">tmp</span>&nbsp;<span class="op" id="2094893">:=</span>&nbsp;<span class="ident" id="2094896">t</span><span class="op" id="2094897">[</span><span class="ident" id="2094898">i</span><span class="op" id="2094899">]</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094902">for</span>&nbsp;<span class="ident" id="2094906">i</span>&nbsp;<span class="op" id="2094908">&gt;</span>&nbsp;<span class="num" id="2094910">0</span>&nbsp;<span class="op" id="2094912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094916">p</span>&nbsp;<span class="op" id="2094918">:=</span>&nbsp;<span class="op" id="2094921">(</span><span class="ident" id="2094922">i</span>&nbsp;<span class="op" id="2094924">-</span>&nbsp;<span class="num" id="2094926">1</span><span class="op" id="2094927">)</span>&nbsp;<span class="op" id="2094929">/</span>&nbsp;<span class="num" id="2094931">4</span>&nbsp;<span class="comment" id="2094933">//&nbsp;parent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094945">if</span>&nbsp;<span class="ident" id="2094948">when</span>&nbsp;<span class="op" id="2094953">&gt;=</span>&nbsp;<span class="ident" id="2094956">t</span><span class="op" id="2094957">[</span><span class="ident" id="2094958">p</span><span class="op" id="2094959">]</span><span class="op" id="2094960">.</span><span class="ident" id="2094961">when</span>&nbsp;<span class="op" id="2094966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2094971">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2094979">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094983">t</span><span class="op" id="2094984">[</span><span class="ident" id="2094985">i</span><span class="op" id="2094986">]</span>&nbsp;<span class="op" id="2094988">=</span>&nbsp;<span class="ident" id="2094990">t</span><span class="op" id="2094991">[</span><span class="ident" id="2094992">p</span><span class="op" id="2094993">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2094997">t</span><span class="op" id="2094998">[</span><span class="ident" id="2094999">i</span><span class="op" id="2095000">]</span><span class="op" id="2095001">.</span><span class="ident" id="2095002">i</span>&nbsp;<span class="op" id="2095004">=</span>&nbsp;<span class="ident" id="2095006">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095010">t</span><span class="op" id="2095011">[</span><span class="ident" id="2095012">p</span><span class="op" id="2095013">]</span>&nbsp;<span class="op" id="2095015">=</span>&nbsp;<span class="ident" id="2095017">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095023">t</span><span class="op" id="2095024">[</span><span class="ident" id="2095025">p</span><span class="op" id="2095026">]</span><span class="op" id="2095027">.</span><span class="ident" id="2095028">i</span>&nbsp;<span class="op" id="2095030">=</span>&nbsp;<span class="ident" id="2095032">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095036">i</span>&nbsp;<span class="op" id="2095038">=</span>&nbsp;<span class="ident" id="2095040">p</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095043">}</span><br>
<span class="lineno"></span><span class="op" id="2095045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2095048">func</span>&nbsp;<span class="ident" id="2095053">siftdownTimer</span><span class="op" id="2095066">(</span><span class="ident" id="2095067">i</span>&nbsp;<span class="builtintype" id="2095069">int</span><span class="op" id="2095072">)</span>&nbsp;<span class="op" id="2095074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095077">t</span>&nbsp;<span class="op" id="2095079">:=</span>&nbsp;<span class="ident" id="2095082">timers</span><span class="op" id="2095088">.</span><span class="ident" id="2095089">t</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095092">n</span>&nbsp;<span class="op" id="2095094">:=</span>&nbsp;<span class="builtinfunc" id="2095097">len</span><span class="op" id="2095100">(</span><span class="ident" id="2095101">t</span><span class="op" id="2095102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095105">when</span>&nbsp;<span class="op" id="2095110">:=</span>&nbsp;<span class="ident" id="2095113">t</span><span class="op" id="2095114">[</span><span class="ident" id="2095115">i</span><span class="op" id="2095116">]</span><span class="op" id="2095117">.</span><span class="ident" id="2095118">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095124">tmp</span>&nbsp;<span class="op" id="2095128">:=</span>&nbsp;<span class="ident" id="2095131">t</span><span class="op" id="2095132">[</span><span class="ident" id="2095133">i</span><span class="op" id="2095134">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095137">for</span>&nbsp;<span class="op" id="2095141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095145">c</span>&nbsp;<span class="op" id="2095147">:=</span>&nbsp;<span class="ident" id="2095150">i</span><span class="op" id="2095151">*</span><span class="num" id="2095152">4</span>&nbsp;<span class="op" id="2095154">+</span>&nbsp;<span class="num" id="2095156">1</span>&nbsp;<span class="comment" id="2095158">//&nbsp;left&nbsp;child</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095174">c3</span>&nbsp;<span class="op" id="2095177">:=</span>&nbsp;<span class="ident" id="2095180">c</span>&nbsp;<span class="op" id="2095182">+</span>&nbsp;<span class="num" id="2095184">2</span>&nbsp;&nbsp;<span class="comment" id="2095187">//&nbsp;mid&nbsp;child</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095202">if</span>&nbsp;<span class="ident" id="2095205">c</span>&nbsp;<span class="op" id="2095207">&gt;=</span>&nbsp;<span class="ident" id="2095210">n</span>&nbsp;<span class="op" id="2095212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095217">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095229">w</span>&nbsp;<span class="op" id="2095231">:=</span>&nbsp;<span class="ident" id="2095234">t</span><span class="op" id="2095235">[</span><span class="ident" id="2095236">c</span><span class="op" id="2095237">]</span><span class="op" id="2095238">.</span><span class="ident" id="2095239">when</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095246">if</span>&nbsp;<span class="ident" id="2095249">c</span><span class="op" id="2095250">+</span><span class="num" id="2095251">1</span>&nbsp;<span class="op" id="2095253">&lt;</span>&nbsp;<span class="ident" id="2095255">n</span>&nbsp;<span class="op" id="2095257">&amp;&amp;</span>&nbsp;<span class="ident" id="2095260">t</span><span class="op" id="2095261">[</span><span class="ident" id="2095262">c</span><span class="op" id="2095263">+</span><span class="num" id="2095264">1</span><span class="op" id="2095265">]</span><span class="op" id="2095266">.</span><span class="ident" id="2095267">when</span>&nbsp;<span class="op" id="2095272">&lt;</span>&nbsp;<span class="ident" id="2095274">w</span>&nbsp;<span class="op" id="2095276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095281">w</span>&nbsp;<span class="op" id="2095283">=</span>&nbsp;<span class="ident" id="2095285">t</span><span class="op" id="2095286">[</span><span class="ident" id="2095287">c</span><span class="op" id="2095288">+</span><span class="num" id="2095289">1</span><span class="op" id="2095290">]</span><span class="op" id="2095291">.</span><span class="ident" id="2095292">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095300">c</span><span class="op" id="2095301">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095310">if</span>&nbsp;<span class="ident" id="2095313">c3</span>&nbsp;<span class="op" id="2095316">&lt;</span>&nbsp;<span class="ident" id="2095318">n</span>&nbsp;<span class="op" id="2095320">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095325">w3</span>&nbsp;<span class="op" id="2095328">:=</span>&nbsp;<span class="ident" id="2095331">t</span><span class="op" id="2095332">[</span><span class="ident" id="2095333">c3</span><span class="op" id="2095335">]</span><span class="op" id="2095336">.</span><span class="ident" id="2095337">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095345">if</span>&nbsp;<span class="ident" id="2095348">c3</span><span class="op" id="2095350">+</span><span class="num" id="2095351">1</span>&nbsp;<span class="op" id="2095353">&lt;</span>&nbsp;<span class="ident" id="2095355">n</span>&nbsp;<span class="op" id="2095357">&amp;&amp;</span>&nbsp;<span class="ident" id="2095360">t</span><span class="op" id="2095361">[</span><span class="ident" id="2095362">c3</span><span class="op" id="2095364">+</span><span class="num" id="2095365">1</span><span class="op" id="2095366">]</span><span class="op" id="2095367">.</span><span class="ident" id="2095368">when</span>&nbsp;<span class="op" id="2095373">&lt;</span>&nbsp;<span class="ident" id="2095375">w3</span>&nbsp;<span class="op" id="2095378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095384">w3</span>&nbsp;<span class="op" id="2095387">=</span>&nbsp;<span class="ident" id="2095389">t</span><span class="op" id="2095390">[</span><span class="ident" id="2095391">c3</span><span class="op" id="2095393">+</span><span class="num" id="2095394">1</span><span class="op" id="2095395">]</span><span class="op" id="2095396">.</span><span class="ident" id="2095397">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095406">c3</span><span class="op" id="2095408">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095414">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095419">if</span>&nbsp;<span class="ident" id="2095422">w3</span>&nbsp;<span class="op" id="2095425">&lt;</span>&nbsp;<span class="ident" id="2095427">w</span>&nbsp;<span class="op" id="2095429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095435">w</span>&nbsp;<span class="op" id="2095437">=</span>&nbsp;<span class="ident" id="2095439">w3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095446">c</span>&nbsp;<span class="op" id="2095448">=</span>&nbsp;<span class="ident" id="2095450">c3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095460">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095464">if</span>&nbsp;<span class="ident" id="2095467">w</span>&nbsp;<span class="op" id="2095469">&gt;=</span>&nbsp;<span class="ident" id="2095472">when</span>&nbsp;<span class="op" id="2095477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2095482">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095494">t</span><span class="op" id="2095495">[</span><span class="ident" id="2095496">i</span><span class="op" id="2095497">]</span>&nbsp;<span class="op" id="2095499">=</span>&nbsp;<span class="ident" id="2095501">t</span><span class="op" id="2095502">[</span><span class="ident" id="2095503">c</span><span class="op" id="2095504">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095508">t</span><span class="op" id="2095509">[</span><span class="ident" id="2095510">i</span><span class="op" id="2095511">]</span><span class="op" id="2095512">.</span><span class="ident" id="2095513">i</span>&nbsp;<span class="op" id="2095515">=</span>&nbsp;<span class="ident" id="2095517">i</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095521">t</span><span class="op" id="2095522">[</span><span class="ident" id="2095523">c</span><span class="op" id="2095524">]</span>&nbsp;<span class="op" id="2095526">=</span>&nbsp;<span class="ident" id="2095528">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095534">t</span><span class="op" id="2095535">[</span><span class="ident" id="2095536">c</span><span class="op" id="2095537">]</span><span class="op" id="2095538">.</span><span class="ident" id="2095539">i</span>&nbsp;<span class="op" id="2095541">=</span>&nbsp;<span class="ident" id="2095543">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095547">i</span>&nbsp;<span class="op" id="2095549">=</span>&nbsp;<span class="ident" id="2095551">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2095554">}</span><br>
<span class="lineno"></span><span class="op" id="2095556">}</span>
</div>
</body>
</html>
