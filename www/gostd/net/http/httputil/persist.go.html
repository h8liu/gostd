<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4713218">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4713273">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4713327">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4713378">package</span>&nbsp;<span class="ident" id="4713386">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4713396">import</span>&nbsp;<span class="op" id="4713403">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713406">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713415">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713425">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713431">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713438">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713450">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4713467">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4713474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4713477">var</span>&nbsp;<span class="op" id="4713481">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4713484">ErrPersistEOF</span>&nbsp;<span class="op" id="4713498">=</span>&nbsp;<span class="op" id="4713500">&amp;</span><span class="ident" id="4713501">http</span><span class="op" id="4713505">.</span><span class="ident" id="4713506">ProtocolError</span><span class="op" id="4713519">{</span><span class="ident" id="4713520">ErrorString</span><span class="op" id="4713531">:</span>&nbsp;<span class="string" id="4713533">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="4713563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4713566">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4713580">=</span>&nbsp;<span class="op" id="4713582">&amp;</span><span class="ident" id="4713583">http</span><span class="op" id="4713587">.</span><span class="ident" id="4713588">ProtocolError</span><span class="op" id="4713601">{</span><span class="ident" id="4713602">ErrorString</span><span class="op" id="4713613">:</span>&nbsp;<span class="string" id="4713615">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="4713642">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4713645">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4713659">=</span>&nbsp;<span class="op" id="4713661">&amp;</span><span class="ident" id="4713662">http</span><span class="op" id="4713666">.</span><span class="ident" id="4713667">ProtocolError</span><span class="op" id="4713680">{</span><span class="ident" id="4713681">ErrorString</span><span class="op" id="4713692">:</span>&nbsp;<span class="string" id="4713694">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="4713710">}</span><br>
<span class="lineno"></span><span class="op" id="4713712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4713715">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="4713773">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="4713838">var</span>&nbsp;<span class="ident" id="4713842">errClosed</span>&nbsp;<span class="op" id="4713852">=</span>&nbsp;<span class="ident" id="4713854">errors</span><span class="op" id="4713860">.</span><span class="ident" id="4713861">New</span><span class="op" id="4713864">(</span><span class="string" id="4713865">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="4713901">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4713904">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4713974">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="4714048">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="4714117">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="4714192">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4714267">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="4714301">//</span><br>
<span class="lineno"></span><span class="comment" id="4714304">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="4714379">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4714407">type</span>&nbsp;<span class="ident" id="4714412">ServerConn</span>&nbsp;<span class="keyword" id="4714423">struct</span>&nbsp;<span class="op" id="4714430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714433">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4714449">sync</span><span class="op" id="4714453">.</span><span class="ident" id="4714454">Mutex</span>&nbsp;<span class="comment" id="4714460">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714505">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4714521">net</span><span class="op" id="4714524">.</span><span class="ident" id="4714525">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714531">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4714547">*</span><span class="ident" id="4714548">bufio</span><span class="op" id="4714553">.</span><span class="ident" id="4714554">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714562">re</span><span class="op" id="4714564">,</span>&nbsp;<span class="ident" id="4714566">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4714578">error</span>&nbsp;<span class="comment" id="4714584">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714606">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4714622">io</span><span class="op" id="4714624">.</span><span class="ident" id="4714625">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714637">nread</span><span class="op" id="4714642">,</span>&nbsp;<span class="ident" id="4714644">nwritten</span>&nbsp;<span class="builtintype" id="4714653">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714658">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4714674">map</span><span class="op" id="4714677">[</span><span class="op" id="4714678">*</span><span class="ident" id="4714679">http</span><span class="op" id="4714683">.</span><span class="ident" id="4714684">Request</span><span class="op" id="4714691">]</span><span class="builtintype" id="4714692">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714699">pipe</span>&nbsp;<span class="ident" id="4714704">textproto</span><span class="op" id="4714713">.</span><span class="ident" id="4714714">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="4714723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4714726">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4714803">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="4714851">//</span><br>
<span class="lineno"></span><span class="comment" id="4714854">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="4714929">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4714957">func</span>&nbsp;<span class="ident" id="4714962">NewServerConn</span><span class="op" id="4714975">(</span><span class="ident" id="4714976">c</span>&nbsp;<span class="ident" id="4714978">net</span><span class="op" id="4714981">.</span><span class="ident" id="4714982">Conn</span><span class="op" id="4714986">,</span>&nbsp;<span class="ident" id="4714988">r</span>&nbsp;<span class="op" id="4714990">*</span><span class="ident" id="4714991">bufio</span><span class="op" id="4714996">.</span><span class="ident" id="4714997">Reader</span><span class="op" id="4715003">)</span>&nbsp;<span class="op" id="4715005">*</span><span class="ident" id="4715006">ServerConn</span>&nbsp;<span class="op" id="4715017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715020">if</span>&nbsp;<span class="ident" id="4715023">r</span>&nbsp;<span class="op" id="4715025">==</span>&nbsp;<span class="ident" id="4715028">nil</span>&nbsp;<span class="op" id="4715032">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715036">r</span>&nbsp;<span class="op" id="4715038">=</span>&nbsp;<span class="ident" id="4715040">bufio</span><span class="op" id="4715045">.</span><span class="ident" id="4715046">NewReader</span><span class="op" id="4715055">(</span><span class="ident" id="4715056">c</span><span class="op" id="4715057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715063">return</span>&nbsp;<span class="op" id="4715070">&amp;</span><span class="ident" id="4715071">ServerConn</span><span class="op" id="4715081">{</span><span class="ident" id="4715082">c</span><span class="op" id="4715083">:</span>&nbsp;<span class="ident" id="4715085">c</span><span class="op" id="4715086">,</span>&nbsp;<span class="ident" id="4715088">r</span><span class="op" id="4715089">:</span>&nbsp;<span class="ident" id="4715091">r</span><span class="op" id="4715092">,</span>&nbsp;<span class="ident" id="4715094">pipereq</span><span class="op" id="4715101">:</span>&nbsp;<span class="builtinfunc" id="4715103">make</span><span class="op" id="4715107">(</span><span class="keyword" id="4715108">map</span><span class="op" id="4715111">[</span><span class="op" id="4715112">*</span><span class="ident" id="4715113">http</span><span class="op" id="4715117">.</span><span class="ident" id="4715118">Request</span><span class="op" id="4715125">]</span><span class="builtintype" id="4715126">uint</span><span class="op" id="4715130">)</span><span class="op" id="4715131">}</span><br>
<span class="lineno"></span><span class="op" id="4715133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4715136">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="4715216">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4715292">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="4715369">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="4715431">func</span>&nbsp;<span class="op" id="4715436">(</span><span class="ident" id="4715437">sc</span>&nbsp;<span class="op" id="4715440">*</span><span class="ident" id="4715441">ServerConn</span><span class="op" id="4715451">)</span>&nbsp;<span class="ident" id="4715453">Hijack</span><span class="op" id="4715459">(</span><span class="op" id="4715460">)</span>&nbsp;<span class="op" id="4715462">(</span><span class="ident" id="4715463">c</span>&nbsp;<span class="ident" id="4715465">net</span><span class="op" id="4715468">.</span><span class="ident" id="4715469">Conn</span><span class="op" id="4715473">,</span>&nbsp;<span class="ident" id="4715475">r</span>&nbsp;<span class="op" id="4715477">*</span><span class="ident" id="4715478">bufio</span><span class="op" id="4715483">.</span><span class="ident" id="4715484">Reader</span><span class="op" id="4715490">)</span>&nbsp;<span class="op" id="4715492">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715495">sc</span><span class="op" id="4715497">.</span><span class="ident" id="4715498">lk</span><span class="op" id="4715500">.</span><span class="ident" id="4715501">Lock</span><span class="op" id="4715505">(</span><span class="op" id="4715506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715509">defer</span>&nbsp;<span class="ident" id="4715515">sc</span><span class="op" id="4715517">.</span><span class="ident" id="4715518">lk</span><span class="op" id="4715520">.</span><span class="ident" id="4715521">Unlock</span><span class="op" id="4715527">(</span><span class="op" id="4715528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715531">c</span>&nbsp;<span class="op" id="4715533">=</span>&nbsp;<span class="ident" id="4715535">sc</span><span class="op" id="4715537">.</span><span class="ident" id="4715538">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715541">r</span>&nbsp;<span class="op" id="4715543">=</span>&nbsp;<span class="ident" id="4715545">sc</span><span class="op" id="4715547">.</span><span class="ident" id="4715548">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715551">sc</span><span class="op" id="4715553">.</span><span class="ident" id="4715554">c</span>&nbsp;<span class="op" id="4715556">=</span>&nbsp;<span class="ident" id="4715558">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715563">sc</span><span class="op" id="4715565">.</span><span class="ident" id="4715566">r</span>&nbsp;<span class="op" id="4715568">=</span>&nbsp;<span class="ident" id="4715570">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715575">return</span><br>
<span class="lineno"></span><span class="op" id="4715582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4715585">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="4715654">func</span>&nbsp;<span class="op" id="4715659">(</span><span class="ident" id="4715660">sc</span>&nbsp;<span class="op" id="4715663">*</span><span class="ident" id="4715664">ServerConn</span><span class="op" id="4715674">)</span>&nbsp;<span class="ident" id="4715676">Close</span><span class="op" id="4715681">(</span><span class="op" id="4715682">)</span>&nbsp;<span class="builtintype" id="4715684">error</span>&nbsp;<span class="op" id="4715690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715693">c</span><span class="op" id="4715694">,</span>&nbsp;<span class="ident" id="4715696">_</span>&nbsp;<span class="op" id="4715698">:=</span>&nbsp;<span class="ident" id="4715701">sc</span><span class="op" id="4715703">.</span><span class="ident" id="4715704">Hijack</span><span class="op" id="4715710">(</span><span class="op" id="4715711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715714">if</span>&nbsp;<span class="ident" id="4715717">c</span>&nbsp;<span class="op" id="4715719">!=</span>&nbsp;<span class="ident" id="4715722">nil</span>&nbsp;<span class="op" id="4715726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715730">return</span>&nbsp;<span class="ident" id="4715737">c</span><span class="op" id="4715738">.</span><span class="ident" id="4715739">Close</span><span class="op" id="4715744">(</span><span class="op" id="4715745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715748">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715751">return</span>&nbsp;<span class="ident" id="4715758">nil</span><br>
<span class="lineno"></span><span class="op" id="4715762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4715765">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4715843">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="4715922">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4715999">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="4716024">func</span>&nbsp;<span class="op" id="4716029">(</span><span class="ident" id="4716030">sc</span>&nbsp;<span class="op" id="4716033">*</span><span class="ident" id="4716034">ServerConn</span><span class="op" id="4716044">)</span>&nbsp;<span class="ident" id="4716046">Read</span><span class="op" id="4716050">(</span><span class="op" id="4716051">)</span>&nbsp;<span class="op" id="4716053">(</span><span class="ident" id="4716054">req</span>&nbsp;<span class="op" id="4716058">*</span><span class="ident" id="4716059">http</span><span class="op" id="4716063">.</span><span class="ident" id="4716064">Request</span><span class="op" id="4716071">,</span>&nbsp;<span class="ident" id="4716073">err</span>&nbsp;<span class="builtintype" id="4716077">error</span><span class="op" id="4716082">)</span>&nbsp;<span class="op" id="4716084">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716088">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716137">id</span>&nbsp;<span class="op" id="4716140">:=</span>&nbsp;<span class="ident" id="4716143">sc</span><span class="op" id="4716145">.</span><span class="ident" id="4716146">pipe</span><span class="op" id="4716150">.</span><span class="ident" id="4716151">Next</span><span class="op" id="4716155">(</span><span class="op" id="4716156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716159">sc</span><span class="op" id="4716161">.</span><span class="ident" id="4716162">pipe</span><span class="op" id="4716166">.</span><span class="ident" id="4716167">StartRequest</span><span class="op" id="4716179">(</span><span class="ident" id="4716180">id</span><span class="op" id="4716182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716185">defer</span>&nbsp;<span class="keyword" id="4716191">func</span><span class="op" id="4716195">(</span><span class="op" id="4716196">)</span>&nbsp;<span class="op" id="4716198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716202">sc</span><span class="op" id="4716204">.</span><span class="ident" id="4716205">pipe</span><span class="op" id="4716209">.</span><span class="ident" id="4716210">EndRequest</span><span class="op" id="4716220">(</span><span class="ident" id="4716221">id</span><span class="op" id="4716223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716227">if</span>&nbsp;<span class="ident" id="4716230">req</span>&nbsp;<span class="op" id="4716234">==</span>&nbsp;<span class="ident" id="4716237">nil</span>&nbsp;<span class="op" id="4716241">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716246">sc</span><span class="op" id="4716248">.</span><span class="ident" id="4716249">pipe</span><span class="op" id="4716253">.</span><span class="ident" id="4716254">StartResponse</span><span class="op" id="4716267">(</span><span class="ident" id="4716268">id</span><span class="op" id="4716270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716275">sc</span><span class="op" id="4716277">.</span><span class="ident" id="4716278">pipe</span><span class="op" id="4716282">.</span><span class="ident" id="4716283">EndResponse</span><span class="op" id="4716294">(</span><span class="ident" id="4716295">id</span><span class="op" id="4716297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716301">}</span>&nbsp;<span class="keyword" id="4716303">else</span>&nbsp;<span class="op" id="4716308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716313">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716360">sc</span><span class="op" id="4716362">.</span><span class="ident" id="4716363">lk</span><span class="op" id="4716365">.</span><span class="ident" id="4716366">Lock</span><span class="op" id="4716370">(</span><span class="op" id="4716371">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716376">sc</span><span class="op" id="4716378">.</span><span class="ident" id="4716379">pipereq</span><span class="op" id="4716386">[</span><span class="ident" id="4716387">req</span><span class="op" id="4716390">]</span>&nbsp;<span class="op" id="4716392">=</span>&nbsp;<span class="ident" id="4716394">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716400">sc</span><span class="op" id="4716402">.</span><span class="ident" id="4716403">lk</span><span class="op" id="4716405">.</span><span class="ident" id="4716406">Unlock</span><span class="op" id="4716412">(</span><span class="op" id="4716413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716420">}</span><span class="op" id="4716421">(</span><span class="op" id="4716422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716426">sc</span><span class="op" id="4716428">.</span><span class="ident" id="4716429">lk</span><span class="op" id="4716431">.</span><span class="ident" id="4716432">Lock</span><span class="op" id="4716436">(</span><span class="op" id="4716437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716440">if</span>&nbsp;<span class="ident" id="4716443">sc</span><span class="op" id="4716445">.</span><span class="ident" id="4716446">we</span>&nbsp;<span class="op" id="4716449">!=</span>&nbsp;<span class="ident" id="4716452">nil</span>&nbsp;<span class="op" id="4716456">{</span>&nbsp;<span class="comment" id="4716458">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716513">defer</span>&nbsp;<span class="ident" id="4716519">sc</span><span class="op" id="4716521">.</span><span class="ident" id="4716522">lk</span><span class="op" id="4716524">.</span><span class="ident" id="4716525">Unlock</span><span class="op" id="4716531">(</span><span class="op" id="4716532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716536">return</span>&nbsp;<span class="ident" id="4716543">nil</span><span class="op" id="4716546">,</span>&nbsp;<span class="ident" id="4716548">sc</span><span class="op" id="4716550">.</span><span class="ident" id="4716551">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716555">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716558">if</span>&nbsp;<span class="ident" id="4716561">sc</span><span class="op" id="4716563">.</span><span class="ident" id="4716564">re</span>&nbsp;<span class="op" id="4716567">!=</span>&nbsp;<span class="ident" id="4716570">nil</span>&nbsp;<span class="op" id="4716574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716578">defer</span>&nbsp;<span class="ident" id="4716584">sc</span><span class="op" id="4716586">.</span><span class="ident" id="4716587">lk</span><span class="op" id="4716589">.</span><span class="ident" id="4716590">Unlock</span><span class="op" id="4716596">(</span><span class="op" id="4716597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716601">return</span>&nbsp;<span class="ident" id="4716608">nil</span><span class="op" id="4716611">,</span>&nbsp;<span class="ident" id="4716613">sc</span><span class="op" id="4716615">.</span><span class="ident" id="4716616">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716623">if</span>&nbsp;<span class="ident" id="4716626">sc</span><span class="op" id="4716628">.</span><span class="ident" id="4716629">r</span>&nbsp;<span class="op" id="4716631">==</span>&nbsp;<span class="ident" id="4716634">nil</span>&nbsp;<span class="op" id="4716638">{</span>&nbsp;<span class="comment" id="4716640">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716687">defer</span>&nbsp;<span class="ident" id="4716693">sc</span><span class="op" id="4716695">.</span><span class="ident" id="4716696">lk</span><span class="op" id="4716698">.</span><span class="ident" id="4716699">Unlock</span><span class="op" id="4716705">(</span><span class="op" id="4716706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716710">return</span>&nbsp;<span class="ident" id="4716717">nil</span><span class="op" id="4716720">,</span>&nbsp;<span class="ident" id="4716722">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716736">r</span>&nbsp;<span class="op" id="4716738">:=</span>&nbsp;<span class="ident" id="4716741">sc</span><span class="op" id="4716743">.</span><span class="ident" id="4716744">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716747">lastbody</span>&nbsp;<span class="op" id="4716756">:=</span>&nbsp;<span class="ident" id="4716759">sc</span><span class="op" id="4716761">.</span><span class="ident" id="4716762">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716772">sc</span><span class="op" id="4716774">.</span><span class="ident" id="4716775">lastbody</span>&nbsp;<span class="op" id="4716784">=</span>&nbsp;<span class="ident" id="4716786">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716791">sc</span><span class="op" id="4716793">.</span><span class="ident" id="4716794">lk</span><span class="op" id="4716796">.</span><span class="ident" id="4716797">Unlock</span><span class="op" id="4716803">(</span><span class="op" id="4716804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716808">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716884">if</span>&nbsp;<span class="ident" id="4716887">lastbody</span>&nbsp;<span class="op" id="4716896">!=</span>&nbsp;<span class="ident" id="4716899">nil</span>&nbsp;<span class="op" id="4716903">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716907">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716973">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717031">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717046">err</span>&nbsp;<span class="op" id="4717050">=</span>&nbsp;<span class="ident" id="4717052">lastbody</span><span class="op" id="4717060">.</span><span class="ident" id="4717061">Close</span><span class="op" id="4717066">(</span><span class="op" id="4717067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717071">if</span>&nbsp;<span class="ident" id="4717074">err</span>&nbsp;<span class="op" id="4717078">!=</span>&nbsp;<span class="ident" id="4717081">nil</span>&nbsp;<span class="op" id="4717085">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717090">sc</span><span class="op" id="4717092">.</span><span class="ident" id="4717093">lk</span><span class="op" id="4717095">.</span><span class="ident" id="4717096">Lock</span><span class="op" id="4717100">(</span><span class="op" id="4717101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717106">defer</span>&nbsp;<span class="ident" id="4717112">sc</span><span class="op" id="4717114">.</span><span class="ident" id="4717115">lk</span><span class="op" id="4717117">.</span><span class="ident" id="4717118">Unlock</span><span class="op" id="4717124">(</span><span class="op" id="4717125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717130">sc</span><span class="op" id="4717132">.</span><span class="ident" id="4717133">re</span>&nbsp;<span class="op" id="4717136">=</span>&nbsp;<span class="ident" id="4717138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717145">return</span>&nbsp;<span class="ident" id="4717152">nil</span><span class="op" id="4717155">,</span>&nbsp;<span class="ident" id="4717157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717163">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717170">req</span><span class="op" id="4717173">,</span>&nbsp;<span class="ident" id="4717175">err</span>&nbsp;<span class="op" id="4717179">=</span>&nbsp;<span class="ident" id="4717181">http</span><span class="op" id="4717185">.</span><span class="ident" id="4717186">ReadRequest</span><span class="op" id="4717197">(</span><span class="ident" id="4717198">r</span><span class="op" id="4717199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717202">sc</span><span class="op" id="4717204">.</span><span class="ident" id="4717205">lk</span><span class="op" id="4717207">.</span><span class="ident" id="4717208">Lock</span><span class="op" id="4717212">(</span><span class="op" id="4717213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717216">defer</span>&nbsp;<span class="ident" id="4717222">sc</span><span class="op" id="4717224">.</span><span class="ident" id="4717225">lk</span><span class="op" id="4717227">.</span><span class="ident" id="4717228">Unlock</span><span class="op" id="4717234">(</span><span class="op" id="4717235">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717238">if</span>&nbsp;<span class="ident" id="4717241">err</span>&nbsp;<span class="op" id="4717245">!=</span>&nbsp;<span class="ident" id="4717248">nil</span>&nbsp;<span class="op" id="4717252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717256">if</span>&nbsp;<span class="ident" id="4717259">err</span>&nbsp;<span class="op" id="4717263">==</span>&nbsp;<span class="ident" id="4717266">io</span><span class="op" id="4717268">.</span><span class="ident" id="4717269">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="4717286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717291">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717346">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717404">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717433">sc</span><span class="op" id="4717435">.</span><span class="ident" id="4717436">re</span>&nbsp;<span class="op" id="4717439">=</span>&nbsp;<span class="ident" id="4717441">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717458">return</span>&nbsp;<span class="ident" id="4717465">nil</span><span class="op" id="4717468">,</span>&nbsp;<span class="ident" id="4717470">sc</span><span class="op" id="4717472">.</span><span class="ident" id="4717473">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717478">}</span>&nbsp;<span class="keyword" id="4717480">else</span>&nbsp;<span class="op" id="4717485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717490">sc</span><span class="op" id="4717492">.</span><span class="ident" id="4717493">re</span>&nbsp;<span class="op" id="4717496">=</span>&nbsp;<span class="ident" id="4717498">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717505">return</span>&nbsp;<span class="ident" id="4717512">req</span><span class="op" id="4717515">,</span>&nbsp;<span class="ident" id="4717517">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717529">sc</span><span class="op" id="4717531">.</span><span class="ident" id="4717532">lastbody</span>&nbsp;<span class="op" id="4717541">=</span>&nbsp;<span class="ident" id="4717543">req</span><span class="op" id="4717546">.</span><span class="ident" id="4717547">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717553">sc</span><span class="op" id="4717555">.</span><span class="ident" id="4717556">nread</span><span class="op" id="4717561">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717565">if</span>&nbsp;<span class="ident" id="4717568">req</span><span class="op" id="4717571">.</span><span class="ident" id="4717572">Close</span>&nbsp;<span class="op" id="4717578">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717582">sc</span><span class="op" id="4717584">.</span><span class="ident" id="4717585">re</span>&nbsp;<span class="op" id="4717588">=</span>&nbsp;<span class="ident" id="4717590">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717606">return</span>&nbsp;<span class="ident" id="4717613">req</span><span class="op" id="4717616">,</span>&nbsp;<span class="ident" id="4717618">sc</span><span class="op" id="4717620">.</span><span class="ident" id="4717621">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717628">return</span>&nbsp;<span class="ident" id="4717635">req</span><span class="op" id="4717638">,</span>&nbsp;<span class="ident" id="4717640">err</span><br>
<span class="lineno"></span><span class="op" id="4717644">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4717647">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4717700">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4717746">func</span>&nbsp;<span class="op" id="4717751">(</span><span class="ident" id="4717752">sc</span>&nbsp;<span class="op" id="4717755">*</span><span class="ident" id="4717756">ServerConn</span><span class="op" id="4717766">)</span>&nbsp;<span class="ident" id="4717768">Pending</span><span class="op" id="4717775">(</span><span class="op" id="4717776">)</span>&nbsp;<span class="builtintype" id="4717778">int</span>&nbsp;<span class="op" id="4717782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717785">sc</span><span class="op" id="4717787">.</span><span class="ident" id="4717788">lk</span><span class="op" id="4717790">.</span><span class="ident" id="4717791">Lock</span><span class="op" id="4717795">(</span><span class="op" id="4717796">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717799">defer</span>&nbsp;<span class="ident" id="4717805">sc</span><span class="op" id="4717807">.</span><span class="ident" id="4717808">lk</span><span class="op" id="4717810">.</span><span class="ident" id="4717811">Unlock</span><span class="op" id="4717817">(</span><span class="op" id="4717818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717821">return</span>&nbsp;<span class="ident" id="4717828">sc</span><span class="op" id="4717830">.</span><span class="ident" id="4717831">nread</span>&nbsp;<span class="op" id="4717837">-</span>&nbsp;<span class="ident" id="4717839">sc</span><span class="op" id="4717841">.</span><span class="ident" id="4717842">nwritten</span><br>
<span class="lineno"></span><span class="op" id="4717851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4717854">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="4717939">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="4718017">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="4718093">func</span>&nbsp;<span class="op" id="4718098">(</span><span class="ident" id="4718099">sc</span>&nbsp;<span class="op" id="4718102">*</span><span class="ident" id="4718103">ServerConn</span><span class="op" id="4718113">)</span>&nbsp;<span class="ident" id="4718115">Write</span><span class="op" id="4718120">(</span><span class="ident" id="4718121">req</span>&nbsp;<span class="op" id="4718125">*</span><span class="ident" id="4718126">http</span><span class="op" id="4718130">.</span><span class="ident" id="4718131">Request</span><span class="op" id="4718138">,</span>&nbsp;<span class="ident" id="4718140">resp</span>&nbsp;<span class="op" id="4718145">*</span><span class="ident" id="4718146">http</span><span class="op" id="4718150">.</span><span class="ident" id="4718151">Response</span><span class="op" id="4718159">)</span>&nbsp;<span class="builtintype" id="4718161">error</span>&nbsp;<span class="op" id="4718167">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718171">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718230">sc</span><span class="op" id="4718232">.</span><span class="ident" id="4718233">lk</span><span class="op" id="4718235">.</span><span class="ident" id="4718236">Lock</span><span class="op" id="4718240">(</span><span class="op" id="4718241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718244">id</span><span class="op" id="4718246">,</span>&nbsp;<span class="ident" id="4718248">ok</span>&nbsp;<span class="op" id="4718251">:=</span>&nbsp;<span class="ident" id="4718254">sc</span><span class="op" id="4718256">.</span><span class="ident" id="4718257">pipereq</span><span class="op" id="4718264">[</span><span class="ident" id="4718265">req</span><span class="op" id="4718268">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4718271">delete</span><span class="op" id="4718277">(</span><span class="ident" id="4718278">sc</span><span class="op" id="4718280">.</span><span class="ident" id="4718281">pipereq</span><span class="op" id="4718288">,</span>&nbsp;<span class="ident" id="4718290">req</span><span class="op" id="4718293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718296">if</span>&nbsp;<span class="op" id="4718299">!</span><span class="ident" id="4718300">ok</span>&nbsp;<span class="op" id="4718303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718307">sc</span><span class="op" id="4718309">.</span><span class="ident" id="4718310">lk</span><span class="op" id="4718312">.</span><span class="ident" id="4718313">Unlock</span><span class="op" id="4718319">(</span><span class="op" id="4718320">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718324">return</span>&nbsp;<span class="ident" id="4718331">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718347">sc</span><span class="op" id="4718349">.</span><span class="ident" id="4718350">lk</span><span class="op" id="4718352">.</span><span class="ident" id="4718353">Unlock</span><span class="op" id="4718359">(</span><span class="op" id="4718360">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718364">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718390">sc</span><span class="op" id="4718392">.</span><span class="ident" id="4718393">pipe</span><span class="op" id="4718397">.</span><span class="ident" id="4718398">StartResponse</span><span class="op" id="4718411">(</span><span class="ident" id="4718412">id</span><span class="op" id="4718414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718417">defer</span>&nbsp;<span class="ident" id="4718423">sc</span><span class="op" id="4718425">.</span><span class="ident" id="4718426">pipe</span><span class="op" id="4718430">.</span><span class="ident" id="4718431">EndResponse</span><span class="op" id="4718442">(</span><span class="ident" id="4718443">id</span><span class="op" id="4718445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718449">sc</span><span class="op" id="4718451">.</span><span class="ident" id="4718452">lk</span><span class="op" id="4718454">.</span><span class="ident" id="4718455">Lock</span><span class="op" id="4718459">(</span><span class="op" id="4718460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718463">if</span>&nbsp;<span class="ident" id="4718466">sc</span><span class="op" id="4718468">.</span><span class="ident" id="4718469">we</span>&nbsp;<span class="op" id="4718472">!=</span>&nbsp;<span class="ident" id="4718475">nil</span>&nbsp;<span class="op" id="4718479">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718483">defer</span>&nbsp;<span class="ident" id="4718489">sc</span><span class="op" id="4718491">.</span><span class="ident" id="4718492">lk</span><span class="op" id="4718494">.</span><span class="ident" id="4718495">Unlock</span><span class="op" id="4718501">(</span><span class="op" id="4718502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718506">return</span>&nbsp;<span class="ident" id="4718513">sc</span><span class="op" id="4718515">.</span><span class="ident" id="4718516">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718523">if</span>&nbsp;<span class="ident" id="4718526">sc</span><span class="op" id="4718528">.</span><span class="ident" id="4718529">c</span>&nbsp;<span class="op" id="4718531">==</span>&nbsp;<span class="ident" id="4718534">nil</span>&nbsp;<span class="op" id="4718538">{</span>&nbsp;<span class="comment" id="4718540">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718587">defer</span>&nbsp;<span class="ident" id="4718593">sc</span><span class="op" id="4718595">.</span><span class="ident" id="4718596">lk</span><span class="op" id="4718598">.</span><span class="ident" id="4718599">Unlock</span><span class="op" id="4718605">(</span><span class="op" id="4718606">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718610">return</span>&nbsp;<span class="ident" id="4718617">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718631">c</span>&nbsp;<span class="op" id="4718633">:=</span>&nbsp;<span class="ident" id="4718636">sc</span><span class="op" id="4718638">.</span><span class="ident" id="4718639">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718642">if</span>&nbsp;<span class="ident" id="4718645">sc</span><span class="op" id="4718647">.</span><span class="ident" id="4718648">nread</span>&nbsp;<span class="op" id="4718654">&lt;=</span>&nbsp;<span class="ident" id="4718657">sc</span><span class="op" id="4718659">.</span><span class="ident" id="4718660">nwritten</span>&nbsp;<span class="op" id="4718669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718673">defer</span>&nbsp;<span class="ident" id="4718679">sc</span><span class="op" id="4718681">.</span><span class="ident" id="4718682">lk</span><span class="op" id="4718684">.</span><span class="ident" id="4718685">Unlock</span><span class="op" id="4718691">(</span><span class="op" id="4718692">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718696">return</span>&nbsp;<span class="ident" id="4718703">errors</span><span class="op" id="4718709">.</span><span class="ident" id="4718710">New</span><span class="op" id="4718713">(</span><span class="string" id="4718714">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="4718741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718747">if</span>&nbsp;<span class="ident" id="4718750">resp</span><span class="op" id="4718754">.</span><span class="ident" id="4718755">Close</span>&nbsp;<span class="op" id="4718761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718765">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718827">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718890">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718913">sc</span><span class="op" id="4718915">.</span><span class="ident" id="4718916">re</span>&nbsp;<span class="op" id="4718919">=</span>&nbsp;<span class="ident" id="4718921">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718939">sc</span><span class="op" id="4718941">.</span><span class="ident" id="4718942">lk</span><span class="op" id="4718944">.</span><span class="ident" id="4718945">Unlock</span><span class="op" id="4718951">(</span><span class="op" id="4718952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718956">err</span>&nbsp;<span class="op" id="4718960">:=</span>&nbsp;<span class="ident" id="4718963">resp</span><span class="op" id="4718967">.</span><span class="ident" id="4718968">Write</span><span class="op" id="4718973">(</span><span class="ident" id="4718974">c</span><span class="op" id="4718975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718978">sc</span><span class="op" id="4718980">.</span><span class="ident" id="4718981">lk</span><span class="op" id="4718983">.</span><span class="ident" id="4718984">Lock</span><span class="op" id="4718988">(</span><span class="op" id="4718989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718992">defer</span>&nbsp;<span class="ident" id="4718998">sc</span><span class="op" id="4719000">.</span><span class="ident" id="4719001">lk</span><span class="op" id="4719003">.</span><span class="ident" id="4719004">Unlock</span><span class="op" id="4719010">(</span><span class="op" id="4719011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719014">if</span>&nbsp;<span class="ident" id="4719017">err</span>&nbsp;<span class="op" id="4719021">!=</span>&nbsp;<span class="ident" id="4719024">nil</span>&nbsp;<span class="op" id="4719028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719032">sc</span><span class="op" id="4719034">.</span><span class="ident" id="4719035">we</span>&nbsp;<span class="op" id="4719038">=</span>&nbsp;<span class="ident" id="4719040">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719046">return</span>&nbsp;<span class="ident" id="4719053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719061">sc</span><span class="op" id="4719063">.</span><span class="ident" id="4719064">nwritten</span><span class="op" id="4719072">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719077">return</span>&nbsp;<span class="ident" id="4719084">nil</span><br>
<span class="lineno">220</span><span class="op" id="4719088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4719091">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4719161">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="4719230">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="4719285">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="4719359">//</span><br>
<span class="lineno"></span><span class="comment" id="4719362">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="4719430">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4719478">type</span>&nbsp;<span class="ident" id="4719483">ClientConn</span>&nbsp;<span class="keyword" id="4719494">struct</span>&nbsp;<span class="op" id="4719501">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719504">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4719520">sync</span><span class="op" id="4719524">.</span><span class="ident" id="4719525">Mutex</span>&nbsp;<span class="comment" id="4719531">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719576">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4719592">net</span><span class="op" id="4719595">.</span><span class="ident" id="4719596">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719602">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4719618">*</span><span class="ident" id="4719619">bufio</span><span class="op" id="4719624">.</span><span class="ident" id="4719625">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719633">re</span><span class="op" id="4719635">,</span>&nbsp;<span class="ident" id="4719637">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4719649">error</span>&nbsp;<span class="comment" id="4719655">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719677">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4719693">io</span><span class="op" id="4719695">.</span><span class="ident" id="4719696">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719708">nread</span><span class="op" id="4719713">,</span>&nbsp;<span class="ident" id="4719715">nwritten</span>&nbsp;<span class="builtintype" id="4719724">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719729">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4719745">map</span><span class="op" id="4719748">[</span><span class="op" id="4719749">*</span><span class="ident" id="4719750">http</span><span class="op" id="4719754">.</span><span class="ident" id="4719755">Request</span><span class="op" id="4719762">]</span><span class="builtintype" id="4719763">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719770">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4719779">textproto</span><span class="op" id="4719788">.</span><span class="ident" id="4719789">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719799">writeReq</span>&nbsp;<span class="keyword" id="4719808">func</span><span class="op" id="4719812">(</span><span class="op" id="4719813">*</span><span class="ident" id="4719814">http</span><span class="op" id="4719818">.</span><span class="ident" id="4719819">Request</span><span class="op" id="4719826">,</span>&nbsp;<span class="ident" id="4719828">io</span><span class="op" id="4719830">.</span><span class="ident" id="4719831">Writer</span><span class="op" id="4719837">)</span>&nbsp;<span class="builtintype" id="4719839">error</span><br>
<span class="lineno">240</span><span class="op" id="4719845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4719848">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4719926">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="4719974">//</span><br>
<span class="lineno">245</span><span class="comment" id="4719977">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4720047">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4720085">func</span>&nbsp;<span class="ident" id="4720090">NewClientConn</span><span class="op" id="4720103">(</span><span class="ident" id="4720104">c</span>&nbsp;<span class="ident" id="4720106">net</span><span class="op" id="4720109">.</span><span class="ident" id="4720110">Conn</span><span class="op" id="4720114">,</span>&nbsp;<span class="ident" id="4720116">r</span>&nbsp;<span class="op" id="4720118">*</span><span class="ident" id="4720119">bufio</span><span class="op" id="4720124">.</span><span class="ident" id="4720125">Reader</span><span class="op" id="4720131">)</span>&nbsp;<span class="op" id="4720133">*</span><span class="ident" id="4720134">ClientConn</span>&nbsp;<span class="op" id="4720145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720148">if</span>&nbsp;<span class="ident" id="4720151">r</span>&nbsp;<span class="op" id="4720153">==</span>&nbsp;<span class="ident" id="4720156">nil</span>&nbsp;<span class="op" id="4720160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720164">r</span>&nbsp;<span class="op" id="4720166">=</span>&nbsp;<span class="ident" id="4720168">bufio</span><span class="op" id="4720173">.</span><span class="ident" id="4720174">NewReader</span><span class="op" id="4720183">(</span><span class="ident" id="4720184">c</span><span class="op" id="4720185">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720191">return</span>&nbsp;<span class="op" id="4720198">&amp;</span><span class="ident" id="4720199">ClientConn</span><span class="op" id="4720209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720213">c</span><span class="op" id="4720214">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4720223">c</span><span class="op" id="4720224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720228">r</span><span class="op" id="4720229">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4720238">r</span><span class="op" id="4720239">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720243">pipereq</span><span class="op" id="4720250">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="4720253">make</span><span class="op" id="4720257">(</span><span class="keyword" id="4720258">map</span><span class="op" id="4720261">[</span><span class="op" id="4720262">*</span><span class="ident" id="4720263">http</span><span class="op" id="4720267">.</span><span class="ident" id="4720268">Request</span><span class="op" id="4720275">]</span><span class="builtintype" id="4720276">uint</span><span class="op" id="4720280">)</span><span class="op" id="4720281">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720285">writeReq</span><span class="op" id="4720293">:</span>&nbsp;<span class="op" id="4720295">(</span><span class="op" id="4720296">*</span><span class="ident" id="4720297">http</span><span class="op" id="4720301">.</span><span class="ident" id="4720302">Request</span><span class="op" id="4720309">)</span><span class="op" id="4720310">.</span><span class="ident" id="4720311">Write</span><span class="op" id="4720316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720319">}</span><br>
<span class="lineno"></span><span class="op" id="4720321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4720324">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="4720391">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="4720429">//</span><br>
<span class="lineno"></span><span class="comment" id="4720432">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4720493">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4720539">func</span>&nbsp;<span class="ident" id="4720544">NewProxyClientConn</span><span class="op" id="4720562">(</span><span class="ident" id="4720563">c</span>&nbsp;<span class="ident" id="4720565">net</span><span class="op" id="4720568">.</span><span class="ident" id="4720569">Conn</span><span class="op" id="4720573">,</span>&nbsp;<span class="ident" id="4720575">r</span>&nbsp;<span class="op" id="4720577">*</span><span class="ident" id="4720578">bufio</span><span class="op" id="4720583">.</span><span class="ident" id="4720584">Reader</span><span class="op" id="4720590">)</span>&nbsp;<span class="op" id="4720592">*</span><span class="ident" id="4720593">ClientConn</span>&nbsp;<span class="op" id="4720604">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720607">cc</span>&nbsp;<span class="op" id="4720610">:=</span>&nbsp;<span class="ident" id="4720613">NewClientConn</span><span class="op" id="4720626">(</span><span class="ident" id="4720627">c</span><span class="op" id="4720628">,</span>&nbsp;<span class="ident" id="4720630">r</span><span class="op" id="4720631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720634">cc</span><span class="op" id="4720636">.</span><span class="ident" id="4720637">writeReq</span>&nbsp;<span class="op" id="4720646">=</span>&nbsp;<span class="op" id="4720648">(</span><span class="op" id="4720649">*</span><span class="ident" id="4720650">http</span><span class="op" id="4720654">.</span><span class="ident" id="4720655">Request</span><span class="op" id="4720662">)</span><span class="op" id="4720663">.</span><span class="ident" id="4720664">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720676">return</span>&nbsp;<span class="ident" id="4720683">cc</span><br>
<span class="lineno"></span><span class="op" id="4720686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="4720689">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="4720769">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4720845">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="4720919">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="4720997">func</span>&nbsp;<span class="op" id="4721002">(</span><span class="ident" id="4721003">cc</span>&nbsp;<span class="op" id="4721006">*</span><span class="ident" id="4721007">ClientConn</span><span class="op" id="4721017">)</span>&nbsp;<span class="ident" id="4721019">Hijack</span><span class="op" id="4721025">(</span><span class="op" id="4721026">)</span>&nbsp;<span class="op" id="4721028">(</span><span class="ident" id="4721029">c</span>&nbsp;<span class="ident" id="4721031">net</span><span class="op" id="4721034">.</span><span class="ident" id="4721035">Conn</span><span class="op" id="4721039">,</span>&nbsp;<span class="ident" id="4721041">r</span>&nbsp;<span class="op" id="4721043">*</span><span class="ident" id="4721044">bufio</span><span class="op" id="4721049">.</span><span class="ident" id="4721050">Reader</span><span class="op" id="4721056">)</span>&nbsp;<span class="op" id="4721058">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721061">cc</span><span class="op" id="4721063">.</span><span class="ident" id="4721064">lk</span><span class="op" id="4721066">.</span><span class="ident" id="4721067">Lock</span><span class="op" id="4721071">(</span><span class="op" id="4721072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721075">defer</span>&nbsp;<span class="ident" id="4721081">cc</span><span class="op" id="4721083">.</span><span class="ident" id="4721084">lk</span><span class="op" id="4721086">.</span><span class="ident" id="4721087">Unlock</span><span class="op" id="4721093">(</span><span class="op" id="4721094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721097">c</span>&nbsp;<span class="op" id="4721099">=</span>&nbsp;<span class="ident" id="4721101">cc</span><span class="op" id="4721103">.</span><span class="ident" id="4721104">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721107">r</span>&nbsp;<span class="op" id="4721109">=</span>&nbsp;<span class="ident" id="4721111">cc</span><span class="op" id="4721113">.</span><span class="ident" id="4721114">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721117">cc</span><span class="op" id="4721119">.</span><span class="ident" id="4721120">c</span>&nbsp;<span class="op" id="4721122">=</span>&nbsp;<span class="ident" id="4721124">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721129">cc</span><span class="op" id="4721131">.</span><span class="ident" id="4721132">r</span>&nbsp;<span class="op" id="4721134">=</span>&nbsp;<span class="ident" id="4721136">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721141">return</span><br>
<span class="lineno"></span><span class="op" id="4721148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4721151">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="4721220">func</span>&nbsp;<span class="op" id="4721225">(</span><span class="ident" id="4721226">cc</span>&nbsp;<span class="op" id="4721229">*</span><span class="ident" id="4721230">ClientConn</span><span class="op" id="4721240">)</span>&nbsp;<span class="ident" id="4721242">Close</span><span class="op" id="4721247">(</span><span class="op" id="4721248">)</span>&nbsp;<span class="builtintype" id="4721250">error</span>&nbsp;<span class="op" id="4721256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721259">c</span><span class="op" id="4721260">,</span>&nbsp;<span class="ident" id="4721262">_</span>&nbsp;<span class="op" id="4721264">:=</span>&nbsp;<span class="ident" id="4721267">cc</span><span class="op" id="4721269">.</span><span class="ident" id="4721270">Hijack</span><span class="op" id="4721276">(</span><span class="op" id="4721277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721280">if</span>&nbsp;<span class="ident" id="4721283">c</span>&nbsp;<span class="op" id="4721285">!=</span>&nbsp;<span class="ident" id="4721288">nil</span>&nbsp;<span class="op" id="4721292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721296">return</span>&nbsp;<span class="ident" id="4721303">c</span><span class="op" id="4721304">.</span><span class="ident" id="4721305">Close</span><span class="op" id="4721310">(</span><span class="op" id="4721311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721314">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721317">return</span>&nbsp;<span class="ident" id="4721324">nil</span><br>
<span class="lineno"></span><span class="op" id="4721328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4721331">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4721411">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="4721488">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="4721568">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4721643">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="4721720">func</span>&nbsp;<span class="op" id="4721725">(</span><span class="ident" id="4721726">cc</span>&nbsp;<span class="op" id="4721729">*</span><span class="ident" id="4721730">ClientConn</span><span class="op" id="4721740">)</span>&nbsp;<span class="ident" id="4721742">Write</span><span class="op" id="4721747">(</span><span class="ident" id="4721748">req</span>&nbsp;<span class="op" id="4721752">*</span><span class="ident" id="4721753">http</span><span class="op" id="4721757">.</span><span class="ident" id="4721758">Request</span><span class="op" id="4721765">)</span>&nbsp;<span class="op" id="4721767">(</span><span class="ident" id="4721768">err</span>&nbsp;<span class="builtintype" id="4721772">error</span><span class="op" id="4721777">)</span>&nbsp;<span class="op" id="4721779">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721783">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721822">id</span>&nbsp;<span class="op" id="4721825">:=</span>&nbsp;<span class="ident" id="4721828">cc</span><span class="op" id="4721830">.</span><span class="ident" id="4721831">pipe</span><span class="op" id="4721835">.</span><span class="ident" id="4721836">Next</span><span class="op" id="4721840">(</span><span class="op" id="4721841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721844">cc</span><span class="op" id="4721846">.</span><span class="ident" id="4721847">pipe</span><span class="op" id="4721851">.</span><span class="ident" id="4721852">StartRequest</span><span class="op" id="4721864">(</span><span class="ident" id="4721865">id</span><span class="op" id="4721867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721870">defer</span>&nbsp;<span class="keyword" id="4721876">func</span><span class="op" id="4721880">(</span><span class="op" id="4721881">)</span>&nbsp;<span class="op" id="4721883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721887">cc</span><span class="op" id="4721889">.</span><span class="ident" id="4721890">pipe</span><span class="op" id="4721894">.</span><span class="ident" id="4721895">EndRequest</span><span class="op" id="4721905">(</span><span class="ident" id="4721906">id</span><span class="op" id="4721908">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721912">if</span>&nbsp;<span class="ident" id="4721915">err</span>&nbsp;<span class="op" id="4721919">!=</span>&nbsp;<span class="ident" id="4721922">nil</span>&nbsp;<span class="op" id="4721926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721931">cc</span><span class="op" id="4721933">.</span><span class="ident" id="4721934">pipe</span><span class="op" id="4721938">.</span><span class="ident" id="4721939">StartResponse</span><span class="op" id="4721952">(</span><span class="ident" id="4721953">id</span><span class="op" id="4721955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721960">cc</span><span class="op" id="4721962">.</span><span class="ident" id="4721963">pipe</span><span class="op" id="4721967">.</span><span class="ident" id="4721968">EndResponse</span><span class="op" id="4721979">(</span><span class="ident" id="4721980">id</span><span class="op" id="4721982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721986">}</span>&nbsp;<span class="keyword" id="4721988">else</span>&nbsp;<span class="op" id="4721993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721998">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722045">cc</span><span class="op" id="4722047">.</span><span class="ident" id="4722048">lk</span><span class="op" id="4722050">.</span><span class="ident" id="4722051">Lock</span><span class="op" id="4722055">(</span><span class="op" id="4722056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722061">cc</span><span class="op" id="4722063">.</span><span class="ident" id="4722064">pipereq</span><span class="op" id="4722071">[</span><span class="ident" id="4722072">req</span><span class="op" id="4722075">]</span>&nbsp;<span class="op" id="4722077">=</span>&nbsp;<span class="ident" id="4722079">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722085">cc</span><span class="op" id="4722087">.</span><span class="ident" id="4722088">lk</span><span class="op" id="4722090">.</span><span class="ident" id="4722091">Unlock</span><span class="op" id="4722097">(</span><span class="op" id="4722098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722105">}</span><span class="op" id="4722106">(</span><span class="op" id="4722107">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722111">cc</span><span class="op" id="4722113">.</span><span class="ident" id="4722114">lk</span><span class="op" id="4722116">.</span><span class="ident" id="4722117">Lock</span><span class="op" id="4722121">(</span><span class="op" id="4722122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722125">if</span>&nbsp;<span class="ident" id="4722128">cc</span><span class="op" id="4722130">.</span><span class="ident" id="4722131">re</span>&nbsp;<span class="op" id="4722134">!=</span>&nbsp;<span class="ident" id="4722137">nil</span>&nbsp;<span class="op" id="4722141">{</span>&nbsp;<span class="comment" id="4722143">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722195">defer</span>&nbsp;<span class="ident" id="4722201">cc</span><span class="op" id="4722203">.</span><span class="ident" id="4722204">lk</span><span class="op" id="4722206">.</span><span class="ident" id="4722207">Unlock</span><span class="op" id="4722213">(</span><span class="op" id="4722214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722218">return</span>&nbsp;<span class="ident" id="4722225">cc</span><span class="op" id="4722227">.</span><span class="ident" id="4722228">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722235">if</span>&nbsp;<span class="ident" id="4722238">cc</span><span class="op" id="4722240">.</span><span class="ident" id="4722241">we</span>&nbsp;<span class="op" id="4722244">!=</span>&nbsp;<span class="ident" id="4722247">nil</span>&nbsp;<span class="op" id="4722251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722255">defer</span>&nbsp;<span class="ident" id="4722261">cc</span><span class="op" id="4722263">.</span><span class="ident" id="4722264">lk</span><span class="op" id="4722266">.</span><span class="ident" id="4722267">Unlock</span><span class="op" id="4722273">(</span><span class="op" id="4722274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722278">return</span>&nbsp;<span class="ident" id="4722285">cc</span><span class="op" id="4722287">.</span><span class="ident" id="4722288">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722292">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722295">if</span>&nbsp;<span class="ident" id="4722298">cc</span><span class="op" id="4722300">.</span><span class="ident" id="4722301">c</span>&nbsp;<span class="op" id="4722303">==</span>&nbsp;<span class="ident" id="4722306">nil</span>&nbsp;<span class="op" id="4722310">{</span>&nbsp;<span class="comment" id="4722312">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722359">defer</span>&nbsp;<span class="ident" id="4722365">cc</span><span class="op" id="4722367">.</span><span class="ident" id="4722368">lk</span><span class="op" id="4722370">.</span><span class="ident" id="4722371">Unlock</span><span class="op" id="4722377">(</span><span class="op" id="4722378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722382">return</span>&nbsp;<span class="ident" id="4722389">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722403">c</span>&nbsp;<span class="op" id="4722405">:=</span>&nbsp;<span class="ident" id="4722408">cc</span><span class="op" id="4722410">.</span><span class="ident" id="4722411">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722414">if</span>&nbsp;<span class="ident" id="4722417">req</span><span class="op" id="4722420">.</span><span class="ident" id="4722421">Close</span>&nbsp;<span class="op" id="4722427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722431">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722492">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722533">cc</span><span class="op" id="4722535">.</span><span class="ident" id="4722536">we</span>&nbsp;<span class="op" id="4722539">=</span>&nbsp;<span class="ident" id="4722541">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722556">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722559">cc</span><span class="op" id="4722561">.</span><span class="ident" id="4722562">lk</span><span class="op" id="4722564">.</span><span class="ident" id="4722565">Unlock</span><span class="op" id="4722571">(</span><span class="op" id="4722572">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722576">err</span>&nbsp;<span class="op" id="4722580">=</span>&nbsp;<span class="ident" id="4722582">cc</span><span class="op" id="4722584">.</span><span class="ident" id="4722585">writeReq</span><span class="op" id="4722593">(</span><span class="ident" id="4722594">req</span><span class="op" id="4722597">,</span>&nbsp;<span class="ident" id="4722599">c</span><span class="op" id="4722600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722603">cc</span><span class="op" id="4722605">.</span><span class="ident" id="4722606">lk</span><span class="op" id="4722608">.</span><span class="ident" id="4722609">Lock</span><span class="op" id="4722613">(</span><span class="op" id="4722614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722617">defer</span>&nbsp;<span class="ident" id="4722623">cc</span><span class="op" id="4722625">.</span><span class="ident" id="4722626">lk</span><span class="op" id="4722628">.</span><span class="ident" id="4722629">Unlock</span><span class="op" id="4722635">(</span><span class="op" id="4722636">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722639">if</span>&nbsp;<span class="ident" id="4722642">err</span>&nbsp;<span class="op" id="4722646">!=</span>&nbsp;<span class="ident" id="4722649">nil</span>&nbsp;<span class="op" id="4722653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722657">cc</span><span class="op" id="4722659">.</span><span class="ident" id="4722660">we</span>&nbsp;<span class="op" id="4722663">=</span>&nbsp;<span class="ident" id="4722665">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722671">return</span>&nbsp;<span class="ident" id="4722678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722686">cc</span><span class="op" id="4722688">.</span><span class="ident" id="4722689">nwritten</span><span class="op" id="4722697">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722702">return</span>&nbsp;<span class="ident" id="4722709">nil</span><br>
<span class="lineno"></span><span class="op" id="4722713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4722716">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="4722769">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4722811">func</span>&nbsp;<span class="op" id="4722816">(</span><span class="ident" id="4722817">cc</span>&nbsp;<span class="op" id="4722820">*</span><span class="ident" id="4722821">ClientConn</span><span class="op" id="4722831">)</span>&nbsp;<span class="ident" id="4722833">Pending</span><span class="op" id="4722840">(</span><span class="op" id="4722841">)</span>&nbsp;<span class="builtintype" id="4722843">int</span>&nbsp;<span class="op" id="4722847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722850">cc</span><span class="op" id="4722852">.</span><span class="ident" id="4722853">lk</span><span class="op" id="4722855">.</span><span class="ident" id="4722856">Lock</span><span class="op" id="4722860">(</span><span class="op" id="4722861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722864">defer</span>&nbsp;<span class="ident" id="4722870">cc</span><span class="op" id="4722872">.</span><span class="ident" id="4722873">lk</span><span class="op" id="4722875">.</span><span class="ident" id="4722876">Unlock</span><span class="op" id="4722882">(</span><span class="op" id="4722883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722886">return</span>&nbsp;<span class="ident" id="4722893">cc</span><span class="op" id="4722895">.</span><span class="ident" id="4722896">nwritten</span>&nbsp;<span class="op" id="4722905">-</span>&nbsp;<span class="ident" id="4722907">cc</span><span class="op" id="4722909">.</span><span class="ident" id="4722910">nread</span><br>
<span class="lineno">355</span><span class="op" id="4722916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4722919">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4722992">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="4723064">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="4723136">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="4723191">func</span>&nbsp;<span class="op" id="4723196">(</span><span class="ident" id="4723197">cc</span>&nbsp;<span class="op" id="4723200">*</span><span class="ident" id="4723201">ClientConn</span><span class="op" id="4723211">)</span>&nbsp;<span class="ident" id="4723213">Read</span><span class="op" id="4723217">(</span><span class="ident" id="4723218">req</span>&nbsp;<span class="op" id="4723222">*</span><span class="ident" id="4723223">http</span><span class="op" id="4723227">.</span><span class="ident" id="4723228">Request</span><span class="op" id="4723235">)</span>&nbsp;<span class="op" id="4723237">(</span><span class="ident" id="4723238">resp</span>&nbsp;<span class="op" id="4723243">*</span><span class="ident" id="4723244">http</span><span class="op" id="4723248">.</span><span class="ident" id="4723249">Response</span><span class="op" id="4723257">,</span>&nbsp;<span class="ident" id="4723259">err</span>&nbsp;<span class="builtintype" id="4723263">error</span><span class="op" id="4723268">)</span>&nbsp;<span class="op" id="4723270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723273">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723332">cc</span><span class="op" id="4723334">.</span><span class="ident" id="4723335">lk</span><span class="op" id="4723337">.</span><span class="ident" id="4723338">Lock</span><span class="op" id="4723342">(</span><span class="op" id="4723343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723346">id</span><span class="op" id="4723348">,</span>&nbsp;<span class="ident" id="4723350">ok</span>&nbsp;<span class="op" id="4723353">:=</span>&nbsp;<span class="ident" id="4723356">cc</span><span class="op" id="4723358">.</span><span class="ident" id="4723359">pipereq</span><span class="op" id="4723366">[</span><span class="ident" id="4723367">req</span><span class="op" id="4723370">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4723373">delete</span><span class="op" id="4723379">(</span><span class="ident" id="4723380">cc</span><span class="op" id="4723382">.</span><span class="ident" id="4723383">pipereq</span><span class="op" id="4723390">,</span>&nbsp;<span class="ident" id="4723392">req</span><span class="op" id="4723395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723398">if</span>&nbsp;<span class="op" id="4723401">!</span><span class="ident" id="4723402">ok</span>&nbsp;<span class="op" id="4723405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723409">cc</span><span class="op" id="4723411">.</span><span class="ident" id="4723412">lk</span><span class="op" id="4723414">.</span><span class="ident" id="4723415">Unlock</span><span class="op" id="4723421">(</span><span class="op" id="4723422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723426">return</span>&nbsp;<span class="ident" id="4723433">nil</span><span class="op" id="4723436">,</span>&nbsp;<span class="ident" id="4723438">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723451">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723454">cc</span><span class="op" id="4723456">.</span><span class="ident" id="4723457">lk</span><span class="op" id="4723459">.</span><span class="ident" id="4723460">Unlock</span><span class="op" id="4723466">(</span><span class="op" id="4723467">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723471">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723497">cc</span><span class="op" id="4723499">.</span><span class="ident" id="4723500">pipe</span><span class="op" id="4723504">.</span><span class="ident" id="4723505">StartResponse</span><span class="op" id="4723518">(</span><span class="ident" id="4723519">id</span><span class="op" id="4723521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723524">defer</span>&nbsp;<span class="ident" id="4723530">cc</span><span class="op" id="4723532">.</span><span class="ident" id="4723533">pipe</span><span class="op" id="4723537">.</span><span class="ident" id="4723538">EndResponse</span><span class="op" id="4723549">(</span><span class="ident" id="4723550">id</span><span class="op" id="4723552">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723556">cc</span><span class="op" id="4723558">.</span><span class="ident" id="4723559">lk</span><span class="op" id="4723561">.</span><span class="ident" id="4723562">Lock</span><span class="op" id="4723566">(</span><span class="op" id="4723567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723570">if</span>&nbsp;<span class="ident" id="4723573">cc</span><span class="op" id="4723575">.</span><span class="ident" id="4723576">re</span>&nbsp;<span class="op" id="4723579">!=</span>&nbsp;<span class="ident" id="4723582">nil</span>&nbsp;<span class="op" id="4723586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723590">defer</span>&nbsp;<span class="ident" id="4723596">cc</span><span class="op" id="4723598">.</span><span class="ident" id="4723599">lk</span><span class="op" id="4723601">.</span><span class="ident" id="4723602">Unlock</span><span class="op" id="4723608">(</span><span class="op" id="4723609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723613">return</span>&nbsp;<span class="ident" id="4723620">nil</span><span class="op" id="4723623">,</span>&nbsp;<span class="ident" id="4723625">cc</span><span class="op" id="4723627">.</span><span class="ident" id="4723628">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723635">if</span>&nbsp;<span class="ident" id="4723638">cc</span><span class="op" id="4723640">.</span><span class="ident" id="4723641">r</span>&nbsp;<span class="op" id="4723643">==</span>&nbsp;<span class="ident" id="4723646">nil</span>&nbsp;<span class="op" id="4723650">{</span>&nbsp;<span class="comment" id="4723652">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723699">defer</span>&nbsp;<span class="ident" id="4723705">cc</span><span class="op" id="4723707">.</span><span class="ident" id="4723708">lk</span><span class="op" id="4723710">.</span><span class="ident" id="4723711">Unlock</span><span class="op" id="4723717">(</span><span class="op" id="4723718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723722">return</span>&nbsp;<span class="ident" id="4723729">nil</span><span class="op" id="4723732">,</span>&nbsp;<span class="ident" id="4723734">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723745">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723748">r</span>&nbsp;<span class="op" id="4723750">:=</span>&nbsp;<span class="ident" id="4723753">cc</span><span class="op" id="4723755">.</span><span class="ident" id="4723756">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723759">lastbody</span>&nbsp;<span class="op" id="4723768">:=</span>&nbsp;<span class="ident" id="4723771">cc</span><span class="op" id="4723773">.</span><span class="ident" id="4723774">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723784">cc</span><span class="op" id="4723786">.</span><span class="ident" id="4723787">lastbody</span>&nbsp;<span class="op" id="4723796">=</span>&nbsp;<span class="ident" id="4723798">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723803">cc</span><span class="op" id="4723805">.</span><span class="ident" id="4723806">lk</span><span class="op" id="4723808">.</span><span class="ident" id="4723809">Unlock</span><span class="op" id="4723815">(</span><span class="op" id="4723816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723820">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723896">if</span>&nbsp;<span class="ident" id="4723899">lastbody</span>&nbsp;<span class="op" id="4723908">!=</span>&nbsp;<span class="ident" id="4723911">nil</span>&nbsp;<span class="op" id="4723915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723919">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723985">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4724043">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724058">err</span>&nbsp;<span class="op" id="4724062">=</span>&nbsp;<span class="ident" id="4724064">lastbody</span><span class="op" id="4724072">.</span><span class="ident" id="4724073">Close</span><span class="op" id="4724078">(</span><span class="op" id="4724079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724083">if</span>&nbsp;<span class="ident" id="4724086">err</span>&nbsp;<span class="op" id="4724090">!=</span>&nbsp;<span class="ident" id="4724093">nil</span>&nbsp;<span class="op" id="4724097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724102">cc</span><span class="op" id="4724104">.</span><span class="ident" id="4724105">lk</span><span class="op" id="4724107">.</span><span class="ident" id="4724108">Lock</span><span class="op" id="4724112">(</span><span class="op" id="4724113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724118">defer</span>&nbsp;<span class="ident" id="4724124">cc</span><span class="op" id="4724126">.</span><span class="ident" id="4724127">lk</span><span class="op" id="4724129">.</span><span class="ident" id="4724130">Unlock</span><span class="op" id="4724136">(</span><span class="op" id="4724137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724142">cc</span><span class="op" id="4724144">.</span><span class="ident" id="4724145">re</span>&nbsp;<span class="op" id="4724148">=</span>&nbsp;<span class="ident" id="4724150">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724157">return</span>&nbsp;<span class="ident" id="4724164">nil</span><span class="op" id="4724167">,</span>&nbsp;<span class="ident" id="4724169">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724182">resp</span><span class="op" id="4724186">,</span>&nbsp;<span class="ident" id="4724188">err</span>&nbsp;<span class="op" id="4724192">=</span>&nbsp;<span class="ident" id="4724194">http</span><span class="op" id="4724198">.</span><span class="ident" id="4724199">ReadResponse</span><span class="op" id="4724211">(</span><span class="ident" id="4724212">r</span><span class="op" id="4724213">,</span>&nbsp;<span class="ident" id="4724215">req</span><span class="op" id="4724218">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724221">cc</span><span class="op" id="4724223">.</span><span class="ident" id="4724224">lk</span><span class="op" id="4724226">.</span><span class="ident" id="4724227">Lock</span><span class="op" id="4724231">(</span><span class="op" id="4724232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724235">defer</span>&nbsp;<span class="ident" id="4724241">cc</span><span class="op" id="4724243">.</span><span class="ident" id="4724244">lk</span><span class="op" id="4724246">.</span><span class="ident" id="4724247">Unlock</span><span class="op" id="4724253">(</span><span class="op" id="4724254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724257">if</span>&nbsp;<span class="ident" id="4724260">err</span>&nbsp;<span class="op" id="4724264">!=</span>&nbsp;<span class="ident" id="4724267">nil</span>&nbsp;<span class="op" id="4724271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724275">cc</span><span class="op" id="4724277">.</span><span class="ident" id="4724278">re</span>&nbsp;<span class="op" id="4724281">=</span>&nbsp;<span class="ident" id="4724283">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724289">return</span>&nbsp;<span class="ident" id="4724296">resp</span><span class="op" id="4724300">,</span>&nbsp;<span class="ident" id="4724302">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724310">cc</span><span class="op" id="4724312">.</span><span class="ident" id="4724313">lastbody</span>&nbsp;<span class="op" id="4724322">=</span>&nbsp;<span class="ident" id="4724324">resp</span><span class="op" id="4724328">.</span><span class="ident" id="4724329">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724336">cc</span><span class="op" id="4724338">.</span><span class="ident" id="4724339">nread</span><span class="op" id="4724344">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724349">if</span>&nbsp;<span class="ident" id="4724352">resp</span><span class="op" id="4724356">.</span><span class="ident" id="4724357">Close</span>&nbsp;<span class="op" id="4724363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724367">cc</span><span class="op" id="4724369">.</span><span class="ident" id="4724370">re</span>&nbsp;<span class="op" id="4724373">=</span>&nbsp;<span class="ident" id="4724375">ErrPersistEOF</span>&nbsp;<span class="comment" id="4724389">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724423">return</span>&nbsp;<span class="ident" id="4724430">resp</span><span class="op" id="4724434">,</span>&nbsp;<span class="ident" id="4724436">cc</span><span class="op" id="4724438">.</span><span class="ident" id="4724439">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724446">return</span>&nbsp;<span class="ident" id="4724453">resp</span><span class="op" id="4724457">,</span>&nbsp;<span class="ident" id="4724459">err</span><br>
<span class="lineno">420</span><span class="op" id="4724463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4724466">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4724538">func</span>&nbsp;<span class="op" id="4724543">(</span><span class="ident" id="4724544">cc</span>&nbsp;<span class="op" id="4724547">*</span><span class="ident" id="4724548">ClientConn</span><span class="op" id="4724558">)</span>&nbsp;<span class="ident" id="4724560">Do</span><span class="op" id="4724562">(</span><span class="ident" id="4724563">req</span>&nbsp;<span class="op" id="4724567">*</span><span class="ident" id="4724568">http</span><span class="op" id="4724572">.</span><span class="ident" id="4724573">Request</span><span class="op" id="4724580">)</span>&nbsp;<span class="op" id="4724582">(</span><span class="ident" id="4724583">resp</span>&nbsp;<span class="op" id="4724588">*</span><span class="ident" id="4724589">http</span><span class="op" id="4724593">.</span><span class="ident" id="4724594">Response</span><span class="op" id="4724602">,</span>&nbsp;<span class="ident" id="4724604">err</span>&nbsp;<span class="builtintype" id="4724608">error</span><span class="op" id="4724613">)</span>&nbsp;<span class="op" id="4724615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724618">err</span>&nbsp;<span class="op" id="4724622">=</span>&nbsp;<span class="ident" id="4724624">cc</span><span class="op" id="4724626">.</span><span class="ident" id="4724627">Write</span><span class="op" id="4724632">(</span><span class="ident" id="4724633">req</span><span class="op" id="4724636">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724639">if</span>&nbsp;<span class="ident" id="4724642">err</span>&nbsp;<span class="op" id="4724646">!=</span>&nbsp;<span class="ident" id="4724649">nil</span>&nbsp;<span class="op" id="4724653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724657">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724668">return</span>&nbsp;<span class="ident" id="4724675">cc</span><span class="op" id="4724677">.</span><span class="ident" id="4724678">Read</span><span class="op" id="4724682">(</span><span class="ident" id="4724683">req</span><span class="op" id="4724686">)</span><br>
<span class="lineno"></span><span class="op" id="4724688">}</span>
</div>
</body>
</html>
