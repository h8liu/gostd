<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html" class="current">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6542959">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6543015">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6543069">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6543120">package</span>&nbsp;<span class="ident" id="6543128">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6543134">import</span>&nbsp;<span class="op" id="6543141">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543144">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543153">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543166">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543173">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543184">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543195">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="6543205">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6543208">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="6543244">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="6543270">var</span>&nbsp;<span class="ident" id="6543274">streamTest</span>&nbsp;<span class="op" id="6543285">=</span>&nbsp;<span class="op" id="6543287">[</span><span class="op" id="6543288">]</span><span class="keyword" id="6543289">interface</span><span class="op" id="6543298">{</span><span class="op" id="6543299">}</span><span class="op" id="6543300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6543303">0.1</span><span class="op" id="6543306">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6543309">&#34;hello&#34;</span><span class="op" id="6543316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6543319">nil</span><span class="op" id="6543322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="6543325">true</span><span class="op" id="6543329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="6543332">false</span><span class="op" id="6543337">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6543340">[</span><span class="op" id="6543341">]</span><span class="keyword" id="6543342">interface</span><span class="op" id="6543351">{</span><span class="op" id="6543352">}</span><span class="op" id="6543353">{</span><span class="string" id="6543354">&#34;a&#34;</span><span class="op" id="6543357">,</span>&nbsp;<span class="string" id="6543359">&#34;b&#34;</span><span class="op" id="6543362">,</span>&nbsp;<span class="string" id="6543364">&#34;c&#34;</span><span class="op" id="6543367">}</span><span class="op" id="6543368">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6543371">map</span><span class="op" id="6543374">[</span><span class="builtintype" id="6543375">string</span><span class="op" id="6543381">]</span><span class="keyword" id="6543382">interface</span><span class="op" id="6543391">{</span><span class="op" id="6543392">}</span><span class="op" id="6543393">{</span><span class="string" id="6543394">&#34;K&#34;</span><span class="op" id="6543399">:</span>&nbsp;<span class="string" id="6543401">&#34;Kelvin&#34;</span><span class="op" id="6543409">,</span>&nbsp;<span class="string" id="6543411">&#34;ß&#34;</span><span class="op" id="6543415">:</span>&nbsp;<span class="string" id="6543417">&#34;long&nbsp;s&#34;</span><span class="op" id="6543425">}</span><span class="op" id="6543426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6543429">3.14</span><span class="op" id="6543433">,</span>&nbsp;<span class="comment" id="6543435">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="6543490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6543493">var</span>&nbsp;<span class="ident" id="6543497">streamEncoded</span>&nbsp;<span class="op" id="6543511">=</span>&nbsp;<span class="string" id="6543513">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6543595">func</span>&nbsp;<span class="ident" id="6543600">TestEncoder</span><span class="op" id="6543611">(</span><span class="ident" id="6543612">t</span>&nbsp;<span class="op" id="6543614">*</span><span class="ident" id="6543615">testing</span><span class="op" id="6543622">.</span><span class="ident" id="6543623">T</span><span class="op" id="6543624">)</span>&nbsp;<span class="op" id="6543626">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6543629">for</span>&nbsp;<span class="ident" id="6543633">i</span>&nbsp;<span class="op" id="6543635">:=</span>&nbsp;<span class="num" id="6543638">0</span><span class="op" id="6543639">;</span>&nbsp;<span class="ident" id="6543641">i</span>&nbsp;<span class="op" id="6543643">&lt;=</span>&nbsp;<span class="builtinfunc" id="6543646">len</span><span class="op" id="6543649">(</span><span class="ident" id="6543650">streamTest</span><span class="op" id="6543660">)</span><span class="op" id="6543661">;</span>&nbsp;<span class="ident" id="6543663">i</span><span class="op" id="6543664">++</span>&nbsp;<span class="op" id="6543667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6543671">var</span>&nbsp;<span class="ident" id="6543675">buf</span>&nbsp;<span class="ident" id="6543679">bytes</span><span class="op" id="6543684">.</span><span class="ident" id="6543685">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6543694">enc</span>&nbsp;<span class="op" id="6543698">:=</span>&nbsp;<span class="ident" id="6543701">NewEncoder</span><span class="op" id="6543711">(</span><span class="op" id="6543712">&amp;</span><span class="ident" id="6543713">buf</span><span class="op" id="6543716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6543720">for</span>&nbsp;<span class="ident" id="6543724">j</span><span class="op" id="6543725">,</span>&nbsp;<span class="ident" id="6543727">v</span>&nbsp;<span class="op" id="6543729">:=</span>&nbsp;<span class="keyword" id="6543732">range</span>&nbsp;<span class="ident" id="6543738">streamTest</span><span class="op" id="6543748">[</span><span class="num" id="6543749">0</span><span class="op" id="6543750">:</span><span class="ident" id="6543751">i</span><span class="op" id="6543752">]</span>&nbsp;<span class="op" id="6543754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6543759">if</span>&nbsp;<span class="ident" id="6543762">err</span>&nbsp;<span class="op" id="6543766">:=</span>&nbsp;<span class="ident" id="6543769">enc</span><span class="op" id="6543772">.</span><span class="ident" id="6543773">Encode</span><span class="op" id="6543779">(</span><span class="ident" id="6543780">v</span><span class="op" id="6543781">)</span><span class="op" id="6543782">;</span>&nbsp;<span class="ident" id="6543784">err</span>&nbsp;<span class="op" id="6543788">!=</span>&nbsp;<span class="ident" id="6543791">nil</span>&nbsp;<span class="op" id="6543795">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6543801">t</span><span class="op" id="6543802">.</span><span class="ident" id="6543803">Fatalf</span><span class="op" id="6543809">(</span><span class="string" id="6543810">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="6543826">,</span>&nbsp;<span class="ident" id="6543828">j</span><span class="op" id="6543829">,</span>&nbsp;<span class="ident" id="6543831">err</span><span class="op" id="6543834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6543839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6543843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6543847">if</span>&nbsp;<span class="ident" id="6543850">have</span><span class="op" id="6543854">,</span>&nbsp;<span class="ident" id="6543856">want</span>&nbsp;<span class="op" id="6543861">:=</span>&nbsp;<span class="ident" id="6543864">buf</span><span class="op" id="6543867">.</span><span class="ident" id="6543868">String</span><span class="op" id="6543874">(</span><span class="op" id="6543875">)</span><span class="op" id="6543876">,</span>&nbsp;<span class="ident" id="6543878">nlines</span><span class="op" id="6543884">(</span><span class="ident" id="6543885">streamEncoded</span><span class="op" id="6543898">,</span>&nbsp;<span class="ident" id="6543900">i</span><span class="op" id="6543901">)</span><span class="op" id="6543902">;</span>&nbsp;<span class="ident" id="6543904">have</span>&nbsp;<span class="op" id="6543909">!=</span>&nbsp;<span class="ident" id="6543912">want</span>&nbsp;<span class="op" id="6543917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6543922">t</span><span class="op" id="6543923">.</span><span class="ident" id="6543924">Errorf</span><span class="op" id="6543930">(</span><span class="string" id="6543931">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="6543960">,</span>&nbsp;<span class="ident" id="6543962">i</span><span class="op" id="6543963">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6543968">diff</span><span class="op" id="6543972">(</span><span class="ident" id="6543973">t</span><span class="op" id="6543974">,</span>&nbsp;<span class="op" id="6543976">[</span><span class="op" id="6543977">]</span><span class="builtintype" id="6543978">byte</span><span class="op" id="6543982">(</span><span class="ident" id="6543983">have</span><span class="op" id="6543987">)</span><span class="op" id="6543988">,</span>&nbsp;<span class="op" id="6543990">[</span><span class="op" id="6543991">]</span><span class="builtintype" id="6543992">byte</span><span class="op" id="6543996">(</span><span class="ident" id="6543997">want</span><span class="op" id="6544001">)</span><span class="op" id="6544002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544007">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544018">}</span><br>
<span class="lineno"></span><span class="op" id="6544020">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6544023">func</span>&nbsp;<span class="ident" id="6544028">TestDecoder</span><span class="op" id="6544039">(</span><span class="ident" id="6544040">t</span>&nbsp;<span class="op" id="6544042">*</span><span class="ident" id="6544043">testing</span><span class="op" id="6544050">.</span><span class="ident" id="6544051">T</span><span class="op" id="6544052">)</span>&nbsp;<span class="op" id="6544054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544057">for</span>&nbsp;<span class="ident" id="6544061">i</span>&nbsp;<span class="op" id="6544063">:=</span>&nbsp;<span class="num" id="6544066">0</span><span class="op" id="6544067">;</span>&nbsp;<span class="ident" id="6544069">i</span>&nbsp;<span class="op" id="6544071">&lt;=</span>&nbsp;<span class="builtinfunc" id="6544074">len</span><span class="op" id="6544077">(</span><span class="ident" id="6544078">streamTest</span><span class="op" id="6544088">)</span><span class="op" id="6544089">;</span>&nbsp;<span class="ident" id="6544091">i</span><span class="op" id="6544092">++</span>&nbsp;<span class="op" id="6544095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6544099">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6544142">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6544185">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6544244">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6544288">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544325">var</span>&nbsp;<span class="ident" id="6544329">buf</span>&nbsp;<span class="ident" id="6544333">bytes</span><span class="op" id="6544338">.</span><span class="ident" id="6544339">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544348">for</span>&nbsp;<span class="ident" id="6544352">_</span><span class="op" id="6544353">,</span>&nbsp;<span class="ident" id="6544355">c</span>&nbsp;<span class="op" id="6544357">:=</span>&nbsp;<span class="keyword" id="6544360">range</span>&nbsp;<span class="ident" id="6544366">nlines</span><span class="op" id="6544372">(</span><span class="ident" id="6544373">streamEncoded</span><span class="op" id="6544386">,</span>&nbsp;<span class="ident" id="6544388">i</span><span class="op" id="6544389">)</span>&nbsp;<span class="op" id="6544391">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544396">if</span>&nbsp;<span class="ident" id="6544399">c</span>&nbsp;<span class="op" id="6544401">!=</span>&nbsp;<span class="string" id="6544404">&#39;\n&#39;</span>&nbsp;<span class="op" id="6544409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544415">buf</span><span class="op" id="6544418">.</span><span class="ident" id="6544419">WriteRune</span><span class="op" id="6544428">(</span><span class="ident" id="6544429">c</span><span class="op" id="6544430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544443">out</span>&nbsp;<span class="op" id="6544447">:=</span>&nbsp;<span class="builtinfunc" id="6544450">make</span><span class="op" id="6544454">(</span><span class="op" id="6544455">[</span><span class="op" id="6544456">]</span><span class="keyword" id="6544457">interface</span><span class="op" id="6544466">{</span><span class="op" id="6544467">}</span><span class="op" id="6544468">,</span>&nbsp;<span class="ident" id="6544470">i</span><span class="op" id="6544471">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544475">dec</span>&nbsp;<span class="op" id="6544479">:=</span>&nbsp;<span class="ident" id="6544482">NewDecoder</span><span class="op" id="6544492">(</span><span class="op" id="6544493">&amp;</span><span class="ident" id="6544494">buf</span><span class="op" id="6544497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544501">for</span>&nbsp;<span class="ident" id="6544505">j</span>&nbsp;<span class="op" id="6544507">:=</span>&nbsp;<span class="keyword" id="6544510">range</span>&nbsp;<span class="ident" id="6544516">out</span>&nbsp;<span class="op" id="6544520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544525">if</span>&nbsp;<span class="ident" id="6544528">err</span>&nbsp;<span class="op" id="6544532">:=</span>&nbsp;<span class="ident" id="6544535">dec</span><span class="op" id="6544538">.</span><span class="ident" id="6544539">Decode</span><span class="op" id="6544545">(</span><span class="op" id="6544546">&amp;</span><span class="ident" id="6544547">out</span><span class="op" id="6544550">[</span><span class="ident" id="6544551">j</span><span class="op" id="6544552">]</span><span class="op" id="6544553">)</span><span class="op" id="6544554">;</span>&nbsp;<span class="ident" id="6544556">err</span>&nbsp;<span class="op" id="6544560">!=</span>&nbsp;<span class="ident" id="6544563">nil</span>&nbsp;<span class="op" id="6544567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544573">t</span><span class="op" id="6544574">.</span><span class="ident" id="6544575">Fatalf</span><span class="op" id="6544581">(</span><span class="string" id="6544582">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="6544601">,</span>&nbsp;<span class="ident" id="6544603">j</span><span class="op" id="6544604">,</span>&nbsp;<span class="ident" id="6544606">i</span><span class="op" id="6544607">,</span>&nbsp;<span class="ident" id="6544609">err</span><span class="op" id="6544612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544617">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544625">if</span>&nbsp;<span class="op" id="6544628">!</span><span class="ident" id="6544629">reflect</span><span class="op" id="6544636">.</span><span class="ident" id="6544637">DeepEqual</span><span class="op" id="6544646">(</span><span class="ident" id="6544647">out</span><span class="op" id="6544650">,</span>&nbsp;<span class="ident" id="6544652">streamTest</span><span class="op" id="6544662">[</span><span class="num" id="6544663">0</span><span class="op" id="6544664">:</span><span class="ident" id="6544665">i</span><span class="op" id="6544666">]</span><span class="op" id="6544667">)</span>&nbsp;<span class="op" id="6544669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544674">t</span><span class="op" id="6544675">.</span><span class="ident" id="6544676">Errorf</span><span class="op" id="6544682">(</span><span class="string" id="6544683">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="6544712">,</span>&nbsp;<span class="ident" id="6544714">i</span><span class="op" id="6544715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544720">for</span>&nbsp;<span class="ident" id="6544724">j</span>&nbsp;<span class="op" id="6544726">:=</span>&nbsp;<span class="keyword" id="6544729">range</span>&nbsp;<span class="ident" id="6544735">out</span>&nbsp;<span class="op" id="6544739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544745">if</span>&nbsp;<span class="op" id="6544748">!</span><span class="ident" id="6544749">reflect</span><span class="op" id="6544756">.</span><span class="ident" id="6544757">DeepEqual</span><span class="op" id="6544766">(</span><span class="ident" id="6544767">out</span><span class="op" id="6544770">[</span><span class="ident" id="6544771">j</span><span class="op" id="6544772">]</span><span class="op" id="6544773">,</span>&nbsp;<span class="ident" id="6544775">streamTest</span><span class="op" id="6544785">[</span><span class="ident" id="6544786">j</span><span class="op" id="6544787">]</span><span class="op" id="6544788">)</span>&nbsp;<span class="op" id="6544790">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544797">t</span><span class="op" id="6544798">.</span><span class="ident" id="6544799">Errorf</span><span class="op" id="6544805">(</span><span class="string" id="6544806">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6544828">,</span>&nbsp;<span class="ident" id="6544830">j</span><span class="op" id="6544831">,</span>&nbsp;<span class="ident" id="6544833">out</span><span class="op" id="6544836">[</span><span class="ident" id="6544837">j</span><span class="op" id="6544838">]</span><span class="op" id="6544839">,</span>&nbsp;<span class="ident" id="6544841">streamTest</span><span class="op" id="6544851">[</span><span class="ident" id="6544852">j</span><span class="op" id="6544853">]</span><span class="op" id="6544854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544870">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544878">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6544881">}</span><br>
<span class="lineno"></span><span class="op" id="6544883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6544886">func</span>&nbsp;<span class="ident" id="6544891">TestDecoderBuffered</span><span class="op" id="6544910">(</span><span class="ident" id="6544911">t</span>&nbsp;<span class="op" id="6544913">*</span><span class="ident" id="6544914">testing</span><span class="op" id="6544921">.</span><span class="ident" id="6544922">T</span><span class="op" id="6544923">)</span>&nbsp;<span class="op" id="6544925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544928">r</span>&nbsp;<span class="op" id="6544930">:=</span>&nbsp;<span class="ident" id="6544933">strings</span><span class="op" id="6544940">.</span><span class="ident" id="6544941">NewReader</span><span class="op" id="6544950">(</span><span class="string" id="6544951">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="6544978">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6544981">var</span>&nbsp;<span class="ident" id="6544985">m</span>&nbsp;<span class="keyword" id="6544987">struct</span>&nbsp;<span class="op" id="6544994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6544998">Name</span>&nbsp;<span class="builtintype" id="6545003">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545014">d</span>&nbsp;<span class="op" id="6545016">:=</span>&nbsp;<span class="ident" id="6545019">NewDecoder</span><span class="op" id="6545029">(</span><span class="ident" id="6545030">r</span><span class="op" id="6545031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545034">err</span>&nbsp;<span class="op" id="6545038">:=</span>&nbsp;<span class="ident" id="6545041">d</span><span class="op" id="6545042">.</span><span class="ident" id="6545043">Decode</span><span class="op" id="6545049">(</span><span class="op" id="6545050">&amp;</span><span class="ident" id="6545051">m</span><span class="op" id="6545052">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545055">if</span>&nbsp;<span class="ident" id="6545058">err</span>&nbsp;<span class="op" id="6545062">!=</span>&nbsp;<span class="ident" id="6545065">nil</span>&nbsp;<span class="op" id="6545069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545073">t</span><span class="op" id="6545074">.</span><span class="ident" id="6545075">Fatal</span><span class="op" id="6545080">(</span><span class="ident" id="6545081">err</span><span class="op" id="6545084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545090">if</span>&nbsp;<span class="ident" id="6545093">m</span><span class="op" id="6545094">.</span><span class="ident" id="6545095">Name</span>&nbsp;<span class="op" id="6545100">!=</span>&nbsp;<span class="string" id="6545103">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="6545112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545116">t</span><span class="op" id="6545117">.</span><span class="ident" id="6545118">Errorf</span><span class="op" id="6545124">(</span><span class="string" id="6545125">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="6545149">,</span>&nbsp;<span class="ident" id="6545151">m</span><span class="op" id="6545152">.</span><span class="ident" id="6545153">Name</span><span class="op" id="6545157">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545163">rest</span><span class="op" id="6545167">,</span>&nbsp;<span class="ident" id="6545169">err</span>&nbsp;<span class="op" id="6545173">:=</span>&nbsp;<span class="ident" id="6545176">ioutil</span><span class="op" id="6545182">.</span><span class="ident" id="6545183">ReadAll</span><span class="op" id="6545190">(</span><span class="ident" id="6545191">d</span><span class="op" id="6545192">.</span><span class="ident" id="6545193">Buffered</span><span class="op" id="6545201">(</span><span class="op" id="6545202">)</span><span class="op" id="6545203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545206">if</span>&nbsp;<span class="ident" id="6545209">err</span>&nbsp;<span class="op" id="6545213">!=</span>&nbsp;<span class="ident" id="6545216">nil</span>&nbsp;<span class="op" id="6545220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545224">t</span><span class="op" id="6545225">.</span><span class="ident" id="6545226">Fatal</span><span class="op" id="6545231">(</span><span class="ident" id="6545232">err</span><span class="op" id="6545235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545238">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545241">if</span>&nbsp;<span class="ident" id="6545244">g</span><span class="op" id="6545245">,</span>&nbsp;<span class="ident" id="6545247">w</span>&nbsp;<span class="op" id="6545249">:=</span>&nbsp;<span class="builtintype" id="6545252">string</span><span class="op" id="6545258">(</span><span class="ident" id="6545259">rest</span><span class="op" id="6545263">)</span><span class="op" id="6545264">,</span>&nbsp;<span class="string" id="6545266">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="6545275">;</span>&nbsp;<span class="ident" id="6545277">g</span>&nbsp;<span class="op" id="6545279">!=</span>&nbsp;<span class="ident" id="6545282">w</span>&nbsp;<span class="op" id="6545284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545288">t</span><span class="op" id="6545289">.</span><span class="ident" id="6545290">Errorf</span><span class="op" id="6545296">(</span><span class="string" id="6545297">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6545322">,</span>&nbsp;<span class="ident" id="6545324">g</span><span class="op" id="6545325">,</span>&nbsp;<span class="ident" id="6545327">w</span><span class="op" id="6545328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545331">}</span><br>
<span class="lineno"></span><span class="op" id="6545333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6545336">func</span>&nbsp;<span class="ident" id="6545341">nlines</span><span class="op" id="6545347">(</span><span class="ident" id="6545348">s</span>&nbsp;<span class="builtintype" id="6545350">string</span><span class="op" id="6545356">,</span>&nbsp;<span class="ident" id="6545358">n</span>&nbsp;<span class="builtintype" id="6545360">int</span><span class="op" id="6545363">)</span>&nbsp;<span class="builtintype" id="6545365">string</span>&nbsp;<span class="op" id="6545372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545375">if</span>&nbsp;<span class="ident" id="6545378">n</span>&nbsp;<span class="op" id="6545380">&lt;=</span>&nbsp;<span class="num" id="6545383">0</span>&nbsp;<span class="op" id="6545385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545389">return</span>&nbsp;<span class="string" id="6545396">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545403">for</span>&nbsp;<span class="ident" id="6545407">i</span><span class="op" id="6545408">,</span>&nbsp;<span class="ident" id="6545410">c</span>&nbsp;<span class="op" id="6545412">:=</span>&nbsp;<span class="keyword" id="6545415">range</span>&nbsp;<span class="ident" id="6545421">s</span>&nbsp;<span class="op" id="6545423">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545427">if</span>&nbsp;<span class="ident" id="6545430">c</span>&nbsp;<span class="op" id="6545432">==</span>&nbsp;<span class="string" id="6545435">&#39;\n&#39;</span>&nbsp;<span class="op" id="6545440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545445">if</span>&nbsp;<span class="ident" id="6545448">n</span><span class="op" id="6545449">--</span><span class="op" id="6545451">;</span>&nbsp;<span class="ident" id="6545453">n</span>&nbsp;<span class="op" id="6545455">==</span>&nbsp;<span class="num" id="6545458">0</span>&nbsp;<span class="op" id="6545460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545466">return</span>&nbsp;<span class="ident" id="6545473">s</span><span class="op" id="6545474">[</span><span class="num" id="6545475">0</span>&nbsp;<span class="op" id="6545477">:</span>&nbsp;<span class="ident" id="6545479">i</span><span class="op" id="6545480">+</span><span class="num" id="6545481">1</span><span class="op" id="6545482">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545491">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545497">return</span>&nbsp;<span class="ident" id="6545504">s</span><br>
<span class="lineno"></span><span class="op" id="6545506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6545509">func</span>&nbsp;<span class="ident" id="6545514">TestRawMessage</span><span class="op" id="6545528">(</span><span class="ident" id="6545529">t</span>&nbsp;<span class="op" id="6545531">*</span><span class="ident" id="6545532">testing</span><span class="op" id="6545539">.</span><span class="ident" id="6545540">T</span><span class="op" id="6545541">)</span>&nbsp;<span class="op" id="6545543">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6545546">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545598">var</span>&nbsp;<span class="ident" id="6545602">data</span>&nbsp;<span class="keyword" id="6545607">struct</span>&nbsp;<span class="op" id="6545614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545618">X</span>&nbsp;&nbsp;<span class="builtintype" id="6545621">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545631">Id</span>&nbsp;<span class="op" id="6545634">*</span><span class="ident" id="6545635">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545648">Y</span>&nbsp;&nbsp;<span class="builtintype" id="6545651">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545663">const</span>&nbsp;<span class="ident" id="6545669">raw</span>&nbsp;<span class="op" id="6545673">=</span>&nbsp;<span class="string" id="6545675">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545694">const</span>&nbsp;<span class="ident" id="6545700">msg</span>&nbsp;<span class="op" id="6545704">=</span>&nbsp;<span class="string" id="6545706">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545748">err</span>&nbsp;<span class="op" id="6545752">:=</span>&nbsp;<span class="ident" id="6545755">Unmarshal</span><span class="op" id="6545764">(</span><span class="op" id="6545765">[</span><span class="op" id="6545766">]</span><span class="builtintype" id="6545767">byte</span><span class="op" id="6545771">(</span><span class="ident" id="6545772">msg</span><span class="op" id="6545775">)</span><span class="op" id="6545776">,</span>&nbsp;<span class="op" id="6545778">&amp;</span><span class="ident" id="6545779">data</span><span class="op" id="6545783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545786">if</span>&nbsp;<span class="ident" id="6545789">err</span>&nbsp;<span class="op" id="6545793">!=</span>&nbsp;<span class="ident" id="6545796">nil</span>&nbsp;<span class="op" id="6545800">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545804">t</span><span class="op" id="6545805">.</span><span class="ident" id="6545806">Fatalf</span><span class="op" id="6545812">(</span><span class="string" id="6545813">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="6545828">,</span>&nbsp;<span class="ident" id="6545830">err</span><span class="op" id="6545833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545839">if</span>&nbsp;<span class="builtintype" id="6545842">string</span><span class="op" id="6545848">(</span><span class="op" id="6545849">[</span><span class="op" id="6545850">]</span><span class="builtintype" id="6545851">byte</span><span class="op" id="6545855">(</span><span class="op" id="6545856">*</span><span class="ident" id="6545857">data</span><span class="op" id="6545861">.</span><span class="ident" id="6545862">Id</span><span class="op" id="6545864">)</span><span class="op" id="6545865">)</span>&nbsp;<span class="op" id="6545867">!=</span>&nbsp;<span class="ident" id="6545870">raw</span>&nbsp;<span class="op" id="6545874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545878">t</span><span class="op" id="6545879">.</span><span class="ident" id="6545880">Fatalf</span><span class="op" id="6545886">(</span><span class="string" id="6545887">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6545920">,</span>&nbsp;<span class="op" id="6545922">[</span><span class="op" id="6545923">]</span><span class="builtintype" id="6545924">byte</span><span class="op" id="6545928">(</span><span class="op" id="6545929">*</span><span class="ident" id="6545930">data</span><span class="op" id="6545934">.</span><span class="ident" id="6545935">Id</span><span class="op" id="6545937">)</span><span class="op" id="6545938">,</span>&nbsp;<span class="ident" id="6545940">raw</span><span class="op" id="6545943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6545946">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545949">b</span><span class="op" id="6545950">,</span>&nbsp;<span class="ident" id="6545952">err</span>&nbsp;<span class="op" id="6545956">:=</span>&nbsp;<span class="ident" id="6545959">Marshal</span><span class="op" id="6545966">(</span><span class="op" id="6545967">&amp;</span><span class="ident" id="6545968">data</span><span class="op" id="6545972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6545975">if</span>&nbsp;<span class="ident" id="6545978">err</span>&nbsp;<span class="op" id="6545982">!=</span>&nbsp;<span class="ident" id="6545985">nil</span>&nbsp;<span class="op" id="6545989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6545993">t</span><span class="op" id="6545994">.</span><span class="ident" id="6545995">Fatalf</span><span class="op" id="6546001">(</span><span class="string" id="6546002">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="6546015">,</span>&nbsp;<span class="ident" id="6546017">err</span><span class="op" id="6546020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546026">if</span>&nbsp;<span class="builtintype" id="6546029">string</span><span class="op" id="6546035">(</span><span class="ident" id="6546036">b</span><span class="op" id="6546037">)</span>&nbsp;<span class="op" id="6546039">!=</span>&nbsp;<span class="ident" id="6546042">msg</span>&nbsp;<span class="op" id="6546046">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546050">t</span><span class="op" id="6546051">.</span><span class="ident" id="6546052">Fatalf</span><span class="op" id="6546058">(</span><span class="string" id="6546059">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6546087">,</span>&nbsp;<span class="ident" id="6546089">b</span><span class="op" id="6546090">,</span>&nbsp;<span class="ident" id="6546092">msg</span><span class="op" id="6546095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546098">}</span><br>
<span class="lineno"></span><span class="op" id="6546100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6546103">func</span>&nbsp;<span class="ident" id="6546108">TestNullRawMessage</span><span class="op" id="6546126">(</span><span class="ident" id="6546127">t</span>&nbsp;<span class="op" id="6546129">*</span><span class="ident" id="6546130">testing</span><span class="op" id="6546137">.</span><span class="ident" id="6546138">T</span><span class="op" id="6546139">)</span>&nbsp;<span class="op" id="6546141">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6546144">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546196">var</span>&nbsp;<span class="ident" id="6546200">data</span>&nbsp;<span class="keyword" id="6546205">struct</span>&nbsp;<span class="op" id="6546212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546216">X</span>&nbsp;&nbsp;<span class="builtintype" id="6546219">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546229">Id</span>&nbsp;<span class="op" id="6546232">*</span><span class="ident" id="6546233">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546246">Y</span>&nbsp;&nbsp;<span class="builtintype" id="6546249">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546261">data</span><span class="op" id="6546265">.</span><span class="ident" id="6546266">Id</span>&nbsp;<span class="op" id="6546269">=</span>&nbsp;<span class="builtinfunc" id="6546271">new</span><span class="op" id="6546274">(</span><span class="ident" id="6546275">RawMessage</span><span class="op" id="6546285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546288">const</span>&nbsp;<span class="ident" id="6546294">msg</span>&nbsp;<span class="op" id="6546298">=</span>&nbsp;<span class="string" id="6546300">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546331">err</span>&nbsp;<span class="op" id="6546335">:=</span>&nbsp;<span class="ident" id="6546338">Unmarshal</span><span class="op" id="6546347">(</span><span class="op" id="6546348">[</span><span class="op" id="6546349">]</span><span class="builtintype" id="6546350">byte</span><span class="op" id="6546354">(</span><span class="ident" id="6546355">msg</span><span class="op" id="6546358">)</span><span class="op" id="6546359">,</span>&nbsp;<span class="op" id="6546361">&amp;</span><span class="ident" id="6546362">data</span><span class="op" id="6546366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546369">if</span>&nbsp;<span class="ident" id="6546372">err</span>&nbsp;<span class="op" id="6546376">!=</span>&nbsp;<span class="ident" id="6546379">nil</span>&nbsp;<span class="op" id="6546383">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546387">t</span><span class="op" id="6546388">.</span><span class="ident" id="6546389">Fatalf</span><span class="op" id="6546395">(</span><span class="string" id="6546396">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="6546411">,</span>&nbsp;<span class="ident" id="6546413">err</span><span class="op" id="6546416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546422">if</span>&nbsp;<span class="ident" id="6546425">data</span><span class="op" id="6546429">.</span><span class="ident" id="6546430">Id</span>&nbsp;<span class="op" id="6546433">!=</span>&nbsp;<span class="ident" id="6546436">nil</span>&nbsp;<span class="op" id="6546440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546444">t</span><span class="op" id="6546445">.</span><span class="ident" id="6546446">Fatalf</span><span class="op" id="6546452">(</span><span class="string" id="6546453">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="6546491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546494">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546497">b</span><span class="op" id="6546498">,</span>&nbsp;<span class="ident" id="6546500">err</span>&nbsp;<span class="op" id="6546504">:=</span>&nbsp;<span class="ident" id="6546507">Marshal</span><span class="op" id="6546514">(</span><span class="op" id="6546515">&amp;</span><span class="ident" id="6546516">data</span><span class="op" id="6546520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546523">if</span>&nbsp;<span class="ident" id="6546526">err</span>&nbsp;<span class="op" id="6546530">!=</span>&nbsp;<span class="ident" id="6546533">nil</span>&nbsp;<span class="op" id="6546537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546541">t</span><span class="op" id="6546542">.</span><span class="ident" id="6546543">Fatalf</span><span class="op" id="6546549">(</span><span class="string" id="6546550">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="6546563">,</span>&nbsp;<span class="ident" id="6546565">err</span><span class="op" id="6546568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546574">if</span>&nbsp;<span class="builtintype" id="6546577">string</span><span class="op" id="6546583">(</span><span class="ident" id="6546584">b</span><span class="op" id="6546585">)</span>&nbsp;<span class="op" id="6546587">!=</span>&nbsp;<span class="ident" id="6546590">msg</span>&nbsp;<span class="op" id="6546594">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546598">t</span><span class="op" id="6546599">.</span><span class="ident" id="6546600">Fatalf</span><span class="op" id="6546606">(</span><span class="string" id="6546607">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6546635">,</span>&nbsp;<span class="ident" id="6546637">b</span><span class="op" id="6546638">,</span>&nbsp;<span class="ident" id="6546640">msg</span><span class="op" id="6546643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6546646">}</span><br>
<span class="lineno"></span><span class="op" id="6546648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6546651">var</span>&nbsp;<span class="ident" id="6546655">blockingTests</span>&nbsp;<span class="op" id="6546669">=</span>&nbsp;<span class="op" id="6546671">[</span><span class="op" id="6546672">]</span><span class="builtintype" id="6546673">string</span><span class="op" id="6546679">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6546682">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="6546692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6546695">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="6546706">,</span><br>
<span class="lineno"></span><span class="op" id="6546708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6546711">func</span>&nbsp;<span class="ident" id="6546716">TestBlocking</span><span class="op" id="6546728">(</span><span class="ident" id="6546729">t</span>&nbsp;<span class="op" id="6546731">*</span><span class="ident" id="6546732">testing</span><span class="op" id="6546739">.</span><span class="ident" id="6546740">T</span><span class="op" id="6546741">)</span>&nbsp;<span class="op" id="6546743">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546746">for</span>&nbsp;<span class="ident" id="6546750">_</span><span class="op" id="6546751">,</span>&nbsp;<span class="ident" id="6546753">enc</span>&nbsp;<span class="op" id="6546757">:=</span>&nbsp;<span class="keyword" id="6546760">range</span>&nbsp;<span class="ident" id="6546766">blockingTests</span>&nbsp;<span class="op" id="6546780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6546784">r</span><span class="op" id="6546785">,</span>&nbsp;<span class="ident" id="6546787">w</span>&nbsp;<span class="op" id="6546789">:=</span>&nbsp;<span class="ident" id="6546792">net</span><span class="op" id="6546795">.</span><span class="ident" id="6546796">Pipe</span><span class="op" id="6546800">(</span><span class="op" id="6546801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546805">go</span>&nbsp;<span class="ident" id="6546808">w</span><span class="op" id="6546809">.</span><span class="ident" id="6546810">Write</span><span class="op" id="6546815">(</span><span class="op" id="6546816">[</span><span class="op" id="6546817">]</span><span class="builtintype" id="6546818">byte</span><span class="op" id="6546822">(</span><span class="ident" id="6546823">enc</span><span class="op" id="6546826">)</span><span class="op" id="6546827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546831">var</span>&nbsp;<span class="ident" id="6546835">val</span>&nbsp;<span class="keyword" id="6546839">interface</span><span class="op" id="6546848">{</span><span class="op" id="6546849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6546854">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6546909">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6546957">if</span>&nbsp;<span class="ident" id="6546960">err</span>&nbsp;<span class="op" id="6546964">:=</span>&nbsp;<span class="ident" id="6546967">NewDecoder</span><span class="op" id="6546977">(</span><span class="ident" id="6546978">r</span><span class="op" id="6546979">)</span><span class="op" id="6546980">.</span><span class="ident" id="6546981">Decode</span><span class="op" id="6546987">(</span><span class="op" id="6546988">&amp;</span><span class="ident" id="6546989">val</span><span class="op" id="6546992">)</span><span class="op" id="6546993">;</span>&nbsp;<span class="ident" id="6546995">err</span>&nbsp;<span class="op" id="6546999">!=</span>&nbsp;<span class="ident" id="6547002">nil</span>&nbsp;<span class="op" id="6547006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547011">t</span><span class="op" id="6547012">.</span><span class="ident" id="6547013">Errorf</span><span class="op" id="6547019">(</span><span class="string" id="6547020">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="6547037">,</span>&nbsp;<span class="ident" id="6547039">enc</span><span class="op" id="6547042">,</span>&nbsp;<span class="ident" id="6547044">err</span><span class="op" id="6547047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6547051">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547055">r</span><span class="op" id="6547056">.</span><span class="ident" id="6547057">Close</span><span class="op" id="6547062">(</span><span class="op" id="6547063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547067">w</span><span class="op" id="6547068">.</span><span class="ident" id="6547069">Close</span><span class="op" id="6547074">(</span><span class="op" id="6547075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6547078">}</span><br>
<span class="lineno"></span><span class="op" id="6547080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="6547083">func</span>&nbsp;<span class="ident" id="6547088">BenchmarkEncoderEncode</span><span class="op" id="6547110">(</span><span class="ident" id="6547111">b</span>&nbsp;<span class="op" id="6547113">*</span><span class="ident" id="6547114">testing</span><span class="op" id="6547121">.</span><span class="ident" id="6547122">B</span><span class="op" id="6547123">)</span>&nbsp;<span class="op" id="6547125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547128">b</span><span class="op" id="6547129">.</span><span class="ident" id="6547130">ReportAllocs</span><span class="op" id="6547142">(</span><span class="op" id="6547143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6547146">type</span>&nbsp;<span class="ident" id="6547151">T</span>&nbsp;<span class="keyword" id="6547153">struct</span>&nbsp;<span class="op" id="6547160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547164">X</span><span class="op" id="6547165">,</span>&nbsp;<span class="ident" id="6547167">Y</span>&nbsp;<span class="builtintype" id="6547169">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6547177">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547180">v</span>&nbsp;<span class="op" id="6547182">:=</span>&nbsp;<span class="op" id="6547185">&amp;</span><span class="ident" id="6547186">T</span><span class="op" id="6547187">{</span><span class="string" id="6547188">&#34;foo&#34;</span><span class="op" id="6547193">,</span>&nbsp;<span class="string" id="6547195">&#34;bar&#34;</span><span class="op" id="6547200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6547203">for</span>&nbsp;<span class="ident" id="6547207">i</span>&nbsp;<span class="op" id="6547209">:=</span>&nbsp;<span class="num" id="6547212">0</span><span class="op" id="6547213">;</span>&nbsp;<span class="ident" id="6547215">i</span>&nbsp;<span class="op" id="6547217">&lt;</span>&nbsp;<span class="ident" id="6547219">b</span><span class="op" id="6547220">.</span><span class="ident" id="6547221">N</span><span class="op" id="6547222">;</span>&nbsp;<span class="ident" id="6547224">i</span><span class="op" id="6547225">++</span>&nbsp;<span class="op" id="6547228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6547232">if</span>&nbsp;<span class="ident" id="6547235">err</span>&nbsp;<span class="op" id="6547239">:=</span>&nbsp;<span class="ident" id="6547242">NewEncoder</span><span class="op" id="6547252">(</span><span class="ident" id="6547253">ioutil</span><span class="op" id="6547259">.</span><span class="ident" id="6547260">Discard</span><span class="op" id="6547267">)</span><span class="op" id="6547268">.</span><span class="ident" id="6547269">Encode</span><span class="op" id="6547275">(</span><span class="ident" id="6547276">v</span><span class="op" id="6547277">)</span><span class="op" id="6547278">;</span>&nbsp;<span class="ident" id="6547280">err</span>&nbsp;<span class="op" id="6547284">!=</span>&nbsp;<span class="ident" id="6547287">nil</span>&nbsp;<span class="op" id="6547291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6547296">b</span><span class="op" id="6547297">.</span><span class="ident" id="6547298">Fatal</span><span class="op" id="6547303">(</span><span class="ident" id="6547304">err</span><span class="op" id="6547307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6547311">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6547314">}</span><br>
<span class="lineno"></span><span class="op" id="6547316">}</span>
</div>
</body>
</html>
