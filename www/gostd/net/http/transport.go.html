<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html" class="current">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3594921">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3594976">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3595030">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3595081">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3595126">//</span><br>
<span class="lineno"></span><span class="comment" id="3595129">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3595196">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3595242">package</span>&nbsp;<span class="ident" id="3595250">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3595256">import</span>&nbsp;<span class="op" id="3595263">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595266">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595275">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595292">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595306">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595316">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595323">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595329">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595336">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595343">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595354">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595360">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595371">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3595379">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3595386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3595389">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3595459">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3595530">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3595601">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3595669">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3595706">var</span>&nbsp;<span class="ident" id="3595710">DefaultTransport</span>&nbsp;<span class="ident" id="3595727">RoundTripper</span>&nbsp;<span class="op" id="3595740">=</span>&nbsp;<span class="op" id="3595742">&amp;</span><span class="ident" id="3595743">Transport</span><span class="op" id="3595752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595755">Proxy</span><span class="op" id="3595760">:</span>&nbsp;<span class="ident" id="3595762">ProxyFromEnvironment</span><span class="op" id="3595782">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595785">Dial</span><span class="op" id="3595789">:</span>&nbsp;<span class="op" id="3595791">(</span><span class="op" id="3595792">&amp;</span><span class="ident" id="3595793">net</span><span class="op" id="3595796">.</span><span class="ident" id="3595797">Dialer</span><span class="op" id="3595803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595807">Timeout</span><span class="op" id="3595814">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3595818">30</span>&nbsp;<span class="op" id="3595821">*</span>&nbsp;<span class="ident" id="3595823">time</span><span class="op" id="3595827">.</span><span class="ident" id="3595828">Second</span><span class="op" id="3595834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595838">KeepAlive</span><span class="op" id="3595847">:</span>&nbsp;<span class="num" id="3595849">30</span>&nbsp;<span class="op" id="3595852">*</span>&nbsp;<span class="ident" id="3595854">time</span><span class="op" id="3595858">.</span><span class="ident" id="3595859">Second</span><span class="op" id="3595865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595868">}</span><span class="op" id="3595869">)</span><span class="op" id="3595870">.</span><span class="ident" id="3595871">Dial</span><span class="op" id="3595875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3595878">TLSHandshakeTimeout</span><span class="op" id="3595897">:</span>&nbsp;<span class="num" id="3595899">10</span>&nbsp;<span class="op" id="3595902">*</span>&nbsp;<span class="ident" id="3595904">time</span><span class="op" id="3595908">.</span><span class="ident" id="3595909">Second</span><span class="op" id="3595915">,</span><br>
<span class="lineno">40</span><span class="op" id="3595917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3595920">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3595986">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3596010">const</span>&nbsp;<span class="ident" id="3596016">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3596043">=</span>&nbsp;<span class="num" id="3596045">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3596048">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3596118">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3596186">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3596245">type</span>&nbsp;<span class="ident" id="3596250">Transport</span>&nbsp;<span class="keyword" id="3596260">struct</span>&nbsp;<span class="op" id="3596267">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596270">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596281">sync</span><span class="op" id="3596285">.</span><span class="ident" id="3596286">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596293">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3596304">bool</span>&nbsp;<span class="comment" id="3596309">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596356">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3596367">map</span><span class="op" id="3596370">[</span><span class="ident" id="3596371">connectMethodKey</span><span class="op" id="3596387">]</span><span class="op" id="3596388">[</span><span class="op" id="3596389">]</span><span class="op" id="3596390">*</span><span class="ident" id="3596391">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596404">idleConnCh</span>&nbsp;<span class="keyword" id="3596415">map</span><span class="op" id="3596418">[</span><span class="ident" id="3596419">connectMethodKey</span><span class="op" id="3596435">]</span><span class="keyword" id="3596436">chan</span>&nbsp;<span class="op" id="3596441">*</span><span class="ident" id="3596442">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596456">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596468">sync</span><span class="op" id="3596472">.</span><span class="ident" id="3596473">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596480">reqCanceler</span>&nbsp;<span class="keyword" id="3596492">map</span><span class="op" id="3596495">[</span><span class="op" id="3596496">*</span><span class="ident" id="3596497">Request</span><span class="op" id="3596504">]</span><span class="keyword" id="3596505">func</span><span class="op" id="3596509">(</span><span class="op" id="3596510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596514">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596523">sync</span><span class="op" id="3596527">.</span><span class="ident" id="3596528">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596537">altProto</span>&nbsp;<span class="keyword" id="3596546">map</span><span class="op" id="3596549">[</span><span class="builtintype" id="3596550">string</span><span class="op" id="3596556">]</span><span class="ident" id="3596557">RoundTripper</span>&nbsp;<span class="comment" id="3596570">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596616">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596677">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596735">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596783">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3596844">Proxy</span>&nbsp;<span class="keyword" id="3596850">func</span><span class="op" id="3596854">(</span><span class="op" id="3596855">*</span><span class="ident" id="3596856">Request</span><span class="op" id="3596863">)</span>&nbsp;<span class="op" id="3596865">(</span><span class="op" id="3596866">*</span><span class="ident" id="3596867">url</span><span class="op" id="3596870">.</span><span class="ident" id="3596871">URL</span><span class="op" id="3596874">,</span>&nbsp;<span class="builtintype" id="3596876">error</span><span class="op" id="3596881">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596885">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596947">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3596968">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597006">Dial</span>&nbsp;<span class="keyword" id="3597011">func</span><span class="op" id="3597015">(</span><span class="ident" id="3597016">network</span><span class="op" id="3597023">,</span>&nbsp;<span class="ident" id="3597025">addr</span>&nbsp;<span class="builtintype" id="3597030">string</span><span class="op" id="3597036">)</span>&nbsp;<span class="op" id="3597038">(</span><span class="ident" id="3597039">net</span><span class="op" id="3597042">.</span><span class="ident" id="3597043">Conn</span><span class="op" id="3597047">,</span>&nbsp;<span class="builtintype" id="3597049">error</span><span class="op" id="3597054">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597058">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597119">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597171">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597175">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597233">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597237">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597296">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597357">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597421">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597449">DialTLS</span>&nbsp;<span class="keyword" id="3597457">func</span><span class="op" id="3597461">(</span><span class="ident" id="3597462">network</span><span class="op" id="3597469">,</span>&nbsp;<span class="ident" id="3597471">addr</span>&nbsp;<span class="builtintype" id="3597476">string</span><span class="op" id="3597482">)</span>&nbsp;<span class="op" id="3597484">(</span><span class="ident" id="3597485">net</span><span class="op" id="3597488">.</span><span class="ident" id="3597489">Conn</span><span class="op" id="3597493">,</span>&nbsp;<span class="builtintype" id="3597495">error</span><span class="op" id="3597500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597504">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597568">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597627">TLSClientConfig</span>&nbsp;<span class="op" id="3597643">*</span><span class="ident" id="3597644">tls</span><span class="op" id="3597647">.</span><span class="ident" id="3597648">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597657">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597729">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597782">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3597802">time</span><span class="op" id="3597806">.</span><span class="ident" id="3597807">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597818">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597885">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597922">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3597940">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3597947">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598008">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598067">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598124">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598185">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598245">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598300">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598354">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598372">DisableCompression</span>&nbsp;<span class="builtintype" id="3598391">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598398">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598462">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598507">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598547">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3598567">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598573">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598637">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598698">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598757">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3598819">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3598841">time</span><span class="op" id="3598845">.</span><span class="ident" id="3598846">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598857">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3598908">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3598958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3598961">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3599027">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3599087">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3599154">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3599222">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3599235">//</span><br>
<span class="lineno"></span><span class="comment" id="3599238">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3599298">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3599360">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3599418">//</span><br>
<span class="lineno">130</span><span class="comment" id="3599421">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3599491">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3599560">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3599587">//</span><br>
<span class="lineno"></span><span class="comment" id="3599590">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3599660">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3599726">func</span>&nbsp;<span class="ident" id="3599731">ProxyFromEnvironment</span><span class="op" id="3599751">(</span><span class="ident" id="3599752">req</span>&nbsp;<span class="op" id="3599756">*</span><span class="ident" id="3599757">Request</span><span class="op" id="3599764">)</span>&nbsp;<span class="op" id="3599766">(</span><span class="op" id="3599767">*</span><span class="ident" id="3599768">url</span><span class="op" id="3599771">.</span><span class="ident" id="3599772">URL</span><span class="op" id="3599775">,</span>&nbsp;<span class="builtintype" id="3599777">error</span><span class="op" id="3599782">)</span>&nbsp;<span class="op" id="3599784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3599787">var</span>&nbsp;<span class="ident" id="3599791">proxy</span>&nbsp;<span class="builtintype" id="3599797">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3599805">if</span>&nbsp;<span class="ident" id="3599808">req</span><span class="op" id="3599811">.</span><span class="ident" id="3599812">URL</span><span class="op" id="3599815">.</span><span class="ident" id="3599816">Scheme</span>&nbsp;<span class="op" id="3599823">==</span>&nbsp;<span class="string" id="3599826">&#34;https&#34;</span>&nbsp;<span class="op" id="3599834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3599838">proxy</span>&nbsp;<span class="op" id="3599844">=</span>&nbsp;<span class="ident" id="3599846">httpsProxyEnv</span><span class="op" id="3599859">.</span><span class="ident" id="3599860">Get</span><span class="op" id="3599863">(</span><span class="op" id="3599864">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3599867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3599870">if</span>&nbsp;<span class="ident" id="3599873">proxy</span>&nbsp;<span class="op" id="3599879">==</span>&nbsp;<span class="string" id="3599882">&#34;&#34;</span>&nbsp;<span class="op" id="3599885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3599889">proxy</span>&nbsp;<span class="op" id="3599895">=</span>&nbsp;<span class="ident" id="3599897">httpProxyEnv</span><span class="op" id="3599909">.</span><span class="ident" id="3599910">Get</span><span class="op" id="3599913">(</span><span class="op" id="3599914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3599917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3599920">if</span>&nbsp;<span class="ident" id="3599923">proxy</span>&nbsp;<span class="op" id="3599929">==</span>&nbsp;<span class="string" id="3599932">&#34;&#34;</span>&nbsp;<span class="op" id="3599935">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3599939">return</span>&nbsp;<span class="ident" id="3599946">nil</span><span class="op" id="3599949">,</span>&nbsp;<span class="ident" id="3599951">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3599956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3599959">if</span>&nbsp;<span class="op" id="3599962">!</span><span class="ident" id="3599963">useProxy</span><span class="op" id="3599971">(</span><span class="ident" id="3599972">canonicalAddr</span><span class="op" id="3599985">(</span><span class="ident" id="3599986">req</span><span class="op" id="3599989">.</span><span class="ident" id="3599990">URL</span><span class="op" id="3599993">)</span><span class="op" id="3599994">)</span>&nbsp;<span class="op" id="3599996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600000">return</span>&nbsp;<span class="ident" id="3600007">nil</span><span class="op" id="3600010">,</span>&nbsp;<span class="ident" id="3600012">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600017">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600020">proxyURL</span><span class="op" id="3600028">,</span>&nbsp;<span class="ident" id="3600030">err</span>&nbsp;<span class="op" id="3600034">:=</span>&nbsp;<span class="ident" id="3600037">url</span><span class="op" id="3600040">.</span><span class="ident" id="3600041">Parse</span><span class="op" id="3600046">(</span><span class="ident" id="3600047">proxy</span><span class="op" id="3600052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600055">if</span>&nbsp;<span class="ident" id="3600058">err</span>&nbsp;<span class="op" id="3600062">!=</span>&nbsp;<span class="ident" id="3600065">nil</span>&nbsp;<span class="op" id="3600069">||</span>&nbsp;<span class="op" id="3600072">!</span><span class="ident" id="3600073">strings</span><span class="op" id="3600080">.</span><span class="ident" id="3600081">HasPrefix</span><span class="op" id="3600090">(</span><span class="ident" id="3600091">proxyURL</span><span class="op" id="3600099">.</span><span class="ident" id="3600100">Scheme</span><span class="op" id="3600106">,</span>&nbsp;<span class="string" id="3600108">&#34;http&#34;</span><span class="op" id="3600114">)</span>&nbsp;<span class="op" id="3600116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600120">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600177">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600228">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600278">if</span>&nbsp;<span class="ident" id="3600281">proxyURL</span><span class="op" id="3600289">,</span>&nbsp;<span class="ident" id="3600291">err</span>&nbsp;<span class="op" id="3600295">:=</span>&nbsp;<span class="ident" id="3600298">url</span><span class="op" id="3600301">.</span><span class="ident" id="3600302">Parse</span><span class="op" id="3600307">(</span><span class="string" id="3600308">&#34;http://&#34;</span>&nbsp;<span class="op" id="3600318">+</span>&nbsp;<span class="ident" id="3600320">proxy</span><span class="op" id="3600325">)</span><span class="op" id="3600326">;</span>&nbsp;<span class="ident" id="3600328">err</span>&nbsp;<span class="op" id="3600332">==</span>&nbsp;<span class="ident" id="3600335">nil</span>&nbsp;<span class="op" id="3600339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600344">return</span>&nbsp;<span class="ident" id="3600351">proxyURL</span><span class="op" id="3600359">,</span>&nbsp;<span class="ident" id="3600361">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600373">if</span>&nbsp;<span class="ident" id="3600376">err</span>&nbsp;<span class="op" id="3600380">!=</span>&nbsp;<span class="ident" id="3600383">nil</span>&nbsp;<span class="op" id="3600387">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600391">return</span>&nbsp;<span class="ident" id="3600398">nil</span><span class="op" id="3600401">,</span>&nbsp;<span class="ident" id="3600403">fmt</span><span class="op" id="3600406">.</span><span class="ident" id="3600407">Errorf</span><span class="op" id="3600413">(</span><span class="string" id="3600414">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3600444">,</span>&nbsp;<span class="ident" id="3600446">proxy</span><span class="op" id="3600451">,</span>&nbsp;<span class="ident" id="3600453">err</span><span class="op" id="3600456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600462">return</span>&nbsp;<span class="ident" id="3600469">proxyURL</span><span class="op" id="3600477">,</span>&nbsp;<span class="ident" id="3600479">nil</span><br>
<span class="lineno"></span><span class="op" id="3600483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3600486">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3600548">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3600585">func</span>&nbsp;<span class="ident" id="3600590">ProxyURL</span><span class="op" id="3600598">(</span><span class="ident" id="3600599">fixedURL</span>&nbsp;<span class="op" id="3600608">*</span><span class="ident" id="3600609">url</span><span class="op" id="3600612">.</span><span class="ident" id="3600613">URL</span><span class="op" id="3600616">)</span>&nbsp;<span class="keyword" id="3600618">func</span><span class="op" id="3600622">(</span><span class="op" id="3600623">*</span><span class="ident" id="3600624">Request</span><span class="op" id="3600631">)</span>&nbsp;<span class="op" id="3600633">(</span><span class="op" id="3600634">*</span><span class="ident" id="3600635">url</span><span class="op" id="3600638">.</span><span class="ident" id="3600639">URL</span><span class="op" id="3600642">,</span>&nbsp;<span class="builtintype" id="3600644">error</span><span class="op" id="3600649">)</span>&nbsp;<span class="op" id="3600651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600654">return</span>&nbsp;<span class="keyword" id="3600661">func</span><span class="op" id="3600665">(</span><span class="op" id="3600666">*</span><span class="ident" id="3600667">Request</span><span class="op" id="3600674">)</span>&nbsp;<span class="op" id="3600676">(</span><span class="op" id="3600677">*</span><span class="ident" id="3600678">url</span><span class="op" id="3600681">.</span><span class="ident" id="3600682">URL</span><span class="op" id="3600685">,</span>&nbsp;<span class="builtintype" id="3600687">error</span><span class="op" id="3600692">)</span>&nbsp;<span class="op" id="3600694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3600698">return</span>&nbsp;<span class="ident" id="3600705">fixedURL</span><span class="op" id="3600713">,</span>&nbsp;<span class="ident" id="3600715">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600720">}</span><br>
<span class="lineno"></span><span class="op" id="3600722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3600725">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3600786">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3600822">type</span>&nbsp;<span class="ident" id="3600827">transportRequest</span>&nbsp;<span class="keyword" id="3600844">struct</span>&nbsp;<span class="op" id="3600851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3600854">*</span><span class="ident" id="3600855">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3600870">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600910">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3600919">Header</span>&nbsp;<span class="comment" id="3600926">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3600960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3600963">func</span>&nbsp;<span class="op" id="3600968">(</span><span class="ident" id="3600969">tr</span>&nbsp;<span class="op" id="3600972">*</span><span class="ident" id="3600973">transportRequest</span><span class="op" id="3600989">)</span>&nbsp;<span class="ident" id="3600991">extraHeaders</span><span class="op" id="3601003">(</span><span class="op" id="3601004">)</span>&nbsp;<span class="ident" id="3601006">Header</span>&nbsp;<span class="op" id="3601013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601016">if</span>&nbsp;<span class="ident" id="3601019">tr</span><span class="op" id="3601021">.</span><span class="ident" id="3601022">extra</span>&nbsp;<span class="op" id="3601028">==</span>&nbsp;<span class="ident" id="3601031">nil</span>&nbsp;<span class="op" id="3601035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601039">tr</span><span class="op" id="3601041">.</span><span class="ident" id="3601042">extra</span>&nbsp;<span class="op" id="3601048">=</span>&nbsp;<span class="builtinfunc" id="3601050">make</span><span class="op" id="3601054">(</span><span class="ident" id="3601055">Header</span><span class="op" id="3601061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601067">return</span>&nbsp;<span class="ident" id="3601074">tr</span><span class="op" id="3601076">.</span><span class="ident" id="3601077">extra</span><br>
<span class="lineno">185</span><span class="op" id="3601083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3601086">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3601138">//</span><br>
<span class="lineno"></span><span class="comment" id="3601141">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3601210">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3601265">func</span>&nbsp;<span class="op" id="3601270">(</span><span class="ident" id="3601271">t</span>&nbsp;<span class="op" id="3601273">*</span><span class="ident" id="3601274">Transport</span><span class="op" id="3601283">)</span>&nbsp;<span class="ident" id="3601285">RoundTrip</span><span class="op" id="3601294">(</span><span class="ident" id="3601295">req</span>&nbsp;<span class="op" id="3601299">*</span><span class="ident" id="3601300">Request</span><span class="op" id="3601307">)</span>&nbsp;<span class="op" id="3601309">(</span><span class="ident" id="3601310">resp</span>&nbsp;<span class="op" id="3601315">*</span><span class="ident" id="3601316">Response</span><span class="op" id="3601324">,</span>&nbsp;<span class="ident" id="3601326">err</span>&nbsp;<span class="builtintype" id="3601330">error</span><span class="op" id="3601335">)</span>&nbsp;<span class="op" id="3601337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601340">if</span>&nbsp;<span class="ident" id="3601343">req</span><span class="op" id="3601346">.</span><span class="ident" id="3601347">URL</span>&nbsp;<span class="op" id="3601351">==</span>&nbsp;<span class="ident" id="3601354">nil</span>&nbsp;<span class="op" id="3601358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601362">req</span><span class="op" id="3601365">.</span><span class="ident" id="3601366">closeBody</span><span class="op" id="3601375">(</span><span class="op" id="3601376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601380">return</span>&nbsp;<span class="ident" id="3601387">nil</span><span class="op" id="3601390">,</span>&nbsp;<span class="ident" id="3601392">errors</span><span class="op" id="3601398">.</span><span class="ident" id="3601399">New</span><span class="op" id="3601402">(</span><span class="string" id="3601403">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3601426">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601432">if</span>&nbsp;<span class="ident" id="3601435">req</span><span class="op" id="3601438">.</span><span class="ident" id="3601439">Header</span>&nbsp;<span class="op" id="3601446">==</span>&nbsp;<span class="ident" id="3601449">nil</span>&nbsp;<span class="op" id="3601453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601457">req</span><span class="op" id="3601460">.</span><span class="ident" id="3601461">closeBody</span><span class="op" id="3601470">(</span><span class="op" id="3601471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601475">return</span>&nbsp;<span class="ident" id="3601482">nil</span><span class="op" id="3601485">,</span>&nbsp;<span class="ident" id="3601487">errors</span><span class="op" id="3601493">.</span><span class="ident" id="3601494">New</span><span class="op" id="3601497">(</span><span class="string" id="3601498">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3601524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601527">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601530">if</span>&nbsp;<span class="ident" id="3601533">req</span><span class="op" id="3601536">.</span><span class="ident" id="3601537">URL</span><span class="op" id="3601540">.</span><span class="ident" id="3601541">Scheme</span>&nbsp;<span class="op" id="3601548">!=</span>&nbsp;<span class="string" id="3601551">&#34;http&#34;</span>&nbsp;<span class="op" id="3601558">&amp;&amp;</span>&nbsp;<span class="ident" id="3601561">req</span><span class="op" id="3601564">.</span><span class="ident" id="3601565">URL</span><span class="op" id="3601568">.</span><span class="ident" id="3601569">Scheme</span>&nbsp;<span class="op" id="3601576">!=</span>&nbsp;<span class="string" id="3601579">&#34;https&#34;</span>&nbsp;<span class="op" id="3601587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601591">t</span><span class="op" id="3601592">.</span><span class="ident" id="3601593">altMu</span><span class="op" id="3601598">.</span><span class="ident" id="3601599">RLock</span><span class="op" id="3601604">(</span><span class="op" id="3601605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601609">var</span>&nbsp;<span class="ident" id="3601613">rt</span>&nbsp;<span class="ident" id="3601616">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601631">if</span>&nbsp;<span class="ident" id="3601634">t</span><span class="op" id="3601635">.</span><span class="ident" id="3601636">altProto</span>&nbsp;<span class="op" id="3601645">!=</span>&nbsp;<span class="ident" id="3601648">nil</span>&nbsp;<span class="op" id="3601652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601657">rt</span>&nbsp;<span class="op" id="3601660">=</span>&nbsp;<span class="ident" id="3601662">t</span><span class="op" id="3601663">.</span><span class="ident" id="3601664">altProto</span><span class="op" id="3601672">[</span><span class="ident" id="3601673">req</span><span class="op" id="3601676">.</span><span class="ident" id="3601677">URL</span><span class="op" id="3601680">.</span><span class="ident" id="3601681">Scheme</span><span class="op" id="3601687">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601695">t</span><span class="op" id="3601696">.</span><span class="ident" id="3601697">altMu</span><span class="op" id="3601702">.</span><span class="ident" id="3601703">RUnlock</span><span class="op" id="3601710">(</span><span class="op" id="3601711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601715">if</span>&nbsp;<span class="ident" id="3601718">rt</span>&nbsp;<span class="op" id="3601721">==</span>&nbsp;<span class="ident" id="3601724">nil</span>&nbsp;<span class="op" id="3601728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601733">req</span><span class="op" id="3601736">.</span><span class="ident" id="3601737">closeBody</span><span class="op" id="3601746">(</span><span class="op" id="3601747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601752">return</span>&nbsp;<span class="ident" id="3601759">nil</span><span class="op" id="3601762">,</span>&nbsp;<span class="op" id="3601764">&amp;</span><span class="ident" id="3601765">badStringError</span><span class="op" id="3601779">{</span><span class="string" id="3601780">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3601809">,</span>&nbsp;<span class="ident" id="3601811">req</span><span class="op" id="3601814">.</span><span class="ident" id="3601815">URL</span><span class="op" id="3601818">.</span><span class="ident" id="3601819">Scheme</span><span class="op" id="3601825">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601833">return</span>&nbsp;<span class="ident" id="3601840">rt</span><span class="op" id="3601842">.</span><span class="ident" id="3601843">RoundTrip</span><span class="op" id="3601852">(</span><span class="ident" id="3601853">req</span><span class="op" id="3601856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601862">if</span>&nbsp;<span class="ident" id="3601865">req</span><span class="op" id="3601868">.</span><span class="ident" id="3601869">URL</span><span class="op" id="3601872">.</span><span class="ident" id="3601873">Host</span>&nbsp;<span class="op" id="3601878">==</span>&nbsp;<span class="string" id="3601881">&#34;&#34;</span>&nbsp;<span class="op" id="3601884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601888">req</span><span class="op" id="3601891">.</span><span class="ident" id="3601892">closeBody</span><span class="op" id="3601901">(</span><span class="op" id="3601902">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3601906">return</span>&nbsp;<span class="ident" id="3601913">nil</span><span class="op" id="3601916">,</span>&nbsp;<span class="ident" id="3601918">errors</span><span class="op" id="3601924">.</span><span class="ident" id="3601925">New</span><span class="op" id="3601928">(</span><span class="string" id="3601929">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3601959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3601962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3601965">treq</span>&nbsp;<span class="op" id="3601970">:=</span>&nbsp;<span class="op" id="3601973">&amp;</span><span class="ident" id="3601974">transportRequest</span><span class="op" id="3601990">{</span><span class="ident" id="3601991">Request</span><span class="op" id="3601998">:</span>&nbsp;<span class="ident" id="3602000">req</span><span class="op" id="3602003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602006">cm</span><span class="op" id="3602008">,</span>&nbsp;<span class="ident" id="3602010">err</span>&nbsp;<span class="op" id="3602014">:=</span>&nbsp;<span class="ident" id="3602017">t</span><span class="op" id="3602018">.</span><span class="ident" id="3602019">connectMethodForRequest</span><span class="op" id="3602042">(</span><span class="ident" id="3602043">treq</span><span class="op" id="3602047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602050">if</span>&nbsp;<span class="ident" id="3602053">err</span>&nbsp;<span class="op" id="3602057">!=</span>&nbsp;<span class="ident" id="3602060">nil</span>&nbsp;<span class="op" id="3602064">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602068">req</span><span class="op" id="3602071">.</span><span class="ident" id="3602072">closeBody</span><span class="op" id="3602081">(</span><span class="op" id="3602082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602086">return</span>&nbsp;<span class="ident" id="3602093">nil</span><span class="op" id="3602096">,</span>&nbsp;<span class="ident" id="3602098">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3602107">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3602168">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3602232">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3602296">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602321">pconn</span><span class="op" id="3602326">,</span>&nbsp;<span class="ident" id="3602328">err</span>&nbsp;<span class="op" id="3602332">:=</span>&nbsp;<span class="ident" id="3602335">t</span><span class="op" id="3602336">.</span><span class="ident" id="3602337">getConn</span><span class="op" id="3602344">(</span><span class="ident" id="3602345">req</span><span class="op" id="3602348">,</span>&nbsp;<span class="ident" id="3602350">cm</span><span class="op" id="3602352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602355">if</span>&nbsp;<span class="ident" id="3602358">err</span>&nbsp;<span class="op" id="3602362">!=</span>&nbsp;<span class="ident" id="3602365">nil</span>&nbsp;<span class="op" id="3602369">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602373">t</span><span class="op" id="3602374">.</span><span class="ident" id="3602375">setReqCanceler</span><span class="op" id="3602389">(</span><span class="ident" id="3602390">req</span><span class="op" id="3602393">,</span>&nbsp;<span class="ident" id="3602395">nil</span><span class="op" id="3602398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602402">req</span><span class="op" id="3602405">.</span><span class="ident" id="3602406">closeBody</span><span class="op" id="3602415">(</span><span class="op" id="3602416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602420">return</span>&nbsp;<span class="ident" id="3602427">nil</span><span class="op" id="3602430">,</span>&nbsp;<span class="ident" id="3602432">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602441">return</span>&nbsp;<span class="ident" id="3602448">pconn</span><span class="op" id="3602453">.</span><span class="ident" id="3602454">roundTrip</span><span class="op" id="3602463">(</span><span class="ident" id="3602464">treq</span><span class="op" id="3602468">)</span><br>
<span class="lineno"></span><span class="op" id="3602470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3602473">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3602531">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3602597">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3602662">//</span><br>
<span class="lineno"></span><span class="comment" id="3602665">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3602726">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3602787">func</span>&nbsp;<span class="op" id="3602792">(</span><span class="ident" id="3602793">t</span>&nbsp;<span class="op" id="3602795">*</span><span class="ident" id="3602796">Transport</span><span class="op" id="3602805">)</span>&nbsp;<span class="ident" id="3602807">RegisterProtocol</span><span class="op" id="3602823">(</span><span class="ident" id="3602824">scheme</span>&nbsp;<span class="builtintype" id="3602831">string</span><span class="op" id="3602837">,</span>&nbsp;<span class="ident" id="3602839">rt</span>&nbsp;<span class="ident" id="3602842">RoundTripper</span><span class="op" id="3602854">)</span>&nbsp;<span class="op" id="3602856">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602859">if</span>&nbsp;<span class="ident" id="3602862">scheme</span>&nbsp;<span class="op" id="3602869">==</span>&nbsp;<span class="string" id="3602872">&#34;http&#34;</span>&nbsp;<span class="op" id="3602879">||</span>&nbsp;<span class="ident" id="3602882">scheme</span>&nbsp;<span class="op" id="3602889">==</span>&nbsp;<span class="string" id="3602892">&#34;https&#34;</span>&nbsp;<span class="op" id="3602900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3602904">panic</span><span class="op" id="3602909">(</span><span class="string" id="3602910">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3602922">+</span>&nbsp;<span class="ident" id="3602924">scheme</span>&nbsp;<span class="op" id="3602931">+</span>&nbsp;<span class="string" id="3602933">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3602954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3602957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3602960">t</span><span class="op" id="3602961">.</span><span class="ident" id="3602962">altMu</span><span class="op" id="3602967">.</span><span class="ident" id="3602968">Lock</span><span class="op" id="3602972">(</span><span class="op" id="3602973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3602976">defer</span>&nbsp;<span class="ident" id="3602982">t</span><span class="op" id="3602983">.</span><span class="ident" id="3602984">altMu</span><span class="op" id="3602989">.</span><span class="ident" id="3602990">Unlock</span><span class="op" id="3602996">(</span><span class="op" id="3602997">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3603000">if</span>&nbsp;<span class="ident" id="3603003">t</span><span class="op" id="3603004">.</span><span class="ident" id="3603005">altProto</span>&nbsp;<span class="op" id="3603014">==</span>&nbsp;<span class="ident" id="3603017">nil</span>&nbsp;<span class="op" id="3603021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603025">t</span><span class="op" id="3603026">.</span><span class="ident" id="3603027">altProto</span>&nbsp;<span class="op" id="3603036">=</span>&nbsp;<span class="builtinfunc" id="3603038">make</span><span class="op" id="3603042">(</span><span class="keyword" id="3603043">map</span><span class="op" id="3603046">[</span><span class="builtintype" id="3603047">string</span><span class="op" id="3603053">]</span><span class="ident" id="3603054">RoundTripper</span><span class="op" id="3603066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3603069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3603072">if</span>&nbsp;<span class="ident" id="3603075">_</span><span class="op" id="3603076">,</span>&nbsp;<span class="ident" id="3603078">exists</span>&nbsp;<span class="op" id="3603085">:=</span>&nbsp;<span class="ident" id="3603088">t</span><span class="op" id="3603089">.</span><span class="ident" id="3603090">altProto</span><span class="op" id="3603098">[</span><span class="ident" id="3603099">scheme</span><span class="op" id="3603105">]</span><span class="op" id="3603106">;</span>&nbsp;<span class="ident" id="3603108">exists</span>&nbsp;<span class="op" id="3603115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3603119">panic</span><span class="op" id="3603124">(</span><span class="string" id="3603125">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3603137">+</span>&nbsp;<span class="ident" id="3603139">scheme</span>&nbsp;<span class="op" id="3603146">+</span>&nbsp;<span class="string" id="3603148">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3603169">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3603172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603175">t</span><span class="op" id="3603176">.</span><span class="ident" id="3603177">altProto</span><span class="op" id="3603185">[</span><span class="ident" id="3603186">scheme</span><span class="op" id="3603192">]</span>&nbsp;<span class="op" id="3603194">=</span>&nbsp;<span class="ident" id="3603196">rt</span><br>
<span class="lineno"></span><span class="op" id="3603199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3603202">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3603271">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3603335">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3603408">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3603419">func</span>&nbsp;<span class="op" id="3603424">(</span><span class="ident" id="3603425">t</span>&nbsp;<span class="op" id="3603427">*</span><span class="ident" id="3603428">Transport</span><span class="op" id="3603437">)</span>&nbsp;<span class="ident" id="3603439">CloseIdleConnections</span><span class="op" id="3603459">(</span><span class="op" id="3603460">)</span>&nbsp;<span class="op" id="3603462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603465">t</span><span class="op" id="3603466">.</span><span class="ident" id="3603467">idleMu</span><span class="op" id="3603473">.</span><span class="ident" id="3603474">Lock</span><span class="op" id="3603478">(</span><span class="op" id="3603479">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603482">m</span>&nbsp;<span class="op" id="3603484">:=</span>&nbsp;<span class="ident" id="3603487">t</span><span class="op" id="3603488">.</span><span class="ident" id="3603489">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603499">t</span><span class="op" id="3603500">.</span><span class="ident" id="3603501">idleConn</span>&nbsp;<span class="op" id="3603510">=</span>&nbsp;<span class="ident" id="3603512">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603517">t</span><span class="op" id="3603518">.</span><span class="ident" id="3603519">idleConnCh</span>&nbsp;<span class="op" id="3603530">=</span>&nbsp;<span class="ident" id="3603532">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603537">t</span><span class="op" id="3603538">.</span><span class="ident" id="3603539">wantIdle</span>&nbsp;<span class="op" id="3603548">=</span>&nbsp;<span class="builtintype" id="3603550">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603556">t</span><span class="op" id="3603557">.</span><span class="ident" id="3603558">idleMu</span><span class="op" id="3603564">.</span><span class="ident" id="3603565">Unlock</span><span class="op" id="3603571">(</span><span class="op" id="3603572">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3603575">for</span>&nbsp;<span class="ident" id="3603579">_</span><span class="op" id="3603580">,</span>&nbsp;<span class="ident" id="3603582">conns</span>&nbsp;<span class="op" id="3603588">:=</span>&nbsp;<span class="keyword" id="3603591">range</span>&nbsp;<span class="ident" id="3603597">m</span>&nbsp;<span class="op" id="3603599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3603603">for</span>&nbsp;<span class="ident" id="3603607">_</span><span class="op" id="3603608">,</span>&nbsp;<span class="ident" id="3603610">pconn</span>&nbsp;<span class="op" id="3603616">:=</span>&nbsp;<span class="keyword" id="3603619">range</span>&nbsp;<span class="ident" id="3603625">conns</span>&nbsp;<span class="op" id="3603631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603636">pconn</span><span class="op" id="3603641">.</span><span class="builtinfunc" id="3603642">close</span><span class="op" id="3603647">(</span><span class="op" id="3603648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3603652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3603655">}</span><br>
<span class="lineno">275</span><span class="op" id="3603657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3603660">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3603721">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3603736">func</span>&nbsp;<span class="op" id="3603741">(</span><span class="ident" id="3603742">t</span>&nbsp;<span class="op" id="3603744">*</span><span class="ident" id="3603745">Transport</span><span class="op" id="3603754">)</span>&nbsp;<span class="ident" id="3603756">CancelRequest</span><span class="op" id="3603769">(</span><span class="ident" id="3603770">req</span>&nbsp;<span class="op" id="3603774">*</span><span class="ident" id="3603775">Request</span><span class="op" id="3603782">)</span>&nbsp;<span class="op" id="3603784">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603787">t</span><span class="op" id="3603788">.</span><span class="ident" id="3603789">reqMu</span><span class="op" id="3603794">.</span><span class="ident" id="3603795">Lock</span><span class="op" id="3603799">(</span><span class="op" id="3603800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603803">cancel</span>&nbsp;<span class="op" id="3603810">:=</span>&nbsp;<span class="ident" id="3603813">t</span><span class="op" id="3603814">.</span><span class="ident" id="3603815">reqCanceler</span><span class="op" id="3603826">[</span><span class="ident" id="3603827">req</span><span class="op" id="3603830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603833">t</span><span class="op" id="3603834">.</span><span class="ident" id="3603835">reqMu</span><span class="op" id="3603840">.</span><span class="ident" id="3603841">Unlock</span><span class="op" id="3603847">(</span><span class="op" id="3603848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3603851">if</span>&nbsp;<span class="ident" id="3603854">cancel</span>&nbsp;<span class="op" id="3603861">!=</span>&nbsp;<span class="ident" id="3603864">nil</span>&nbsp;<span class="op" id="3603868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603872">cancel</span><span class="op" id="3603878">(</span><span class="op" id="3603879">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3603882">}</span><br>
<span class="lineno"></span><span class="op" id="3603884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3603887">//</span><br>
<span class="lineno"></span><span class="comment" id="3603890">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3603933">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3603937">var</span>&nbsp;<span class="op" id="3603941">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603944">httpProxyEnv</span>&nbsp;<span class="op" id="3603957">=</span>&nbsp;<span class="op" id="3603959">&amp;</span><span class="ident" id="3603960">envOnce</span><span class="op" id="3603967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3603971">names</span><span class="op" id="3603976">:</span>&nbsp;<span class="op" id="3603978">[</span><span class="op" id="3603979">]</span><span class="builtintype" id="3603980">string</span><span class="op" id="3603986">{</span><span class="string" id="3603987">&#34;HTTP_PROXY&#34;</span><span class="op" id="3603999">,</span>&nbsp;<span class="string" id="3604001">&#34;http_proxy&#34;</span><span class="op" id="3604013">}</span><span class="op" id="3604014">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3604017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604020">httpsProxyEnv</span>&nbsp;<span class="op" id="3604034">=</span>&nbsp;<span class="op" id="3604036">&amp;</span><span class="ident" id="3604037">envOnce</span><span class="op" id="3604044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604048">names</span><span class="op" id="3604053">:</span>&nbsp;<span class="op" id="3604055">[</span><span class="op" id="3604056">]</span><span class="builtintype" id="3604057">string</span><span class="op" id="3604063">{</span><span class="string" id="3604064">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3604077">,</span>&nbsp;<span class="string" id="3604079">&#34;https_proxy&#34;</span><span class="op" id="3604092">}</span><span class="op" id="3604093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3604096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604099">noProxyEnv</span>&nbsp;<span class="op" id="3604110">=</span>&nbsp;<span class="op" id="3604112">&amp;</span><span class="ident" id="3604113">envOnce</span><span class="op" id="3604120">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604124">names</span><span class="op" id="3604129">:</span>&nbsp;<span class="op" id="3604131">[</span><span class="op" id="3604132">]</span><span class="builtintype" id="3604133">string</span><span class="op" id="3604139">{</span><span class="string" id="3604140">&#34;NO_PROXY&#34;</span><span class="op" id="3604150">,</span>&nbsp;<span class="string" id="3604152">&#34;no_proxy&#34;</span><span class="op" id="3604162">}</span><span class="op" id="3604163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3604166">}</span><br>
<span class="lineno"></span><span class="op" id="3604168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3604171">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3604239">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3604304">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3604323">type</span>&nbsp;<span class="ident" id="3604328">envOnce</span>&nbsp;<span class="keyword" id="3604336">struct</span>&nbsp;<span class="op" id="3604343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604346">names</span>&nbsp;<span class="op" id="3604352">[</span><span class="op" id="3604353">]</span><span class="builtintype" id="3604354">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604362">once</span>&nbsp;&nbsp;<span class="ident" id="3604368">sync</span><span class="op" id="3604372">.</span><span class="ident" id="3604373">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604379">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3604385">string</span><br>
<span class="lineno"></span><span class="op" id="3604392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3604395">func</span>&nbsp;<span class="op" id="3604400">(</span><span class="ident" id="3604401">e</span>&nbsp;<span class="op" id="3604403">*</span><span class="ident" id="3604404">envOnce</span><span class="op" id="3604411">)</span>&nbsp;<span class="ident" id="3604413">Get</span><span class="op" id="3604416">(</span><span class="op" id="3604417">)</span>&nbsp;<span class="builtintype" id="3604419">string</span>&nbsp;<span class="op" id="3604426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604429">e</span><span class="op" id="3604430">.</span><span class="ident" id="3604431">once</span><span class="op" id="3604435">.</span><span class="ident" id="3604436">Do</span><span class="op" id="3604438">(</span><span class="ident" id="3604439">e</span><span class="op" id="3604440">.</span><span class="ident" id="3604441">init</span><span class="op" id="3604445">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604448">return</span>&nbsp;<span class="ident" id="3604455">e</span><span class="op" id="3604456">.</span><span class="ident" id="3604457">val</span><br>
<span class="lineno"></span><span class="op" id="3604461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3604464">func</span>&nbsp;<span class="op" id="3604469">(</span><span class="ident" id="3604470">e</span>&nbsp;<span class="op" id="3604472">*</span><span class="ident" id="3604473">envOnce</span><span class="op" id="3604480">)</span>&nbsp;<span class="ident" id="3604482">init</span><span class="op" id="3604486">(</span><span class="op" id="3604487">)</span>&nbsp;<span class="op" id="3604489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604492">for</span>&nbsp;<span class="ident" id="3604496">_</span><span class="op" id="3604497">,</span>&nbsp;<span class="ident" id="3604499">n</span>&nbsp;<span class="op" id="3604501">:=</span>&nbsp;<span class="keyword" id="3604504">range</span>&nbsp;<span class="ident" id="3604510">e</span><span class="op" id="3604511">.</span><span class="ident" id="3604512">names</span>&nbsp;<span class="op" id="3604518">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604522">e</span><span class="op" id="3604523">.</span><span class="ident" id="3604524">val</span>&nbsp;<span class="op" id="3604528">=</span>&nbsp;<span class="ident" id="3604530">os</span><span class="op" id="3604532">.</span><span class="ident" id="3604533">Getenv</span><span class="op" id="3604539">(</span><span class="ident" id="3604540">n</span><span class="op" id="3604541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604545">if</span>&nbsp;<span class="ident" id="3604548">e</span><span class="op" id="3604549">.</span><span class="ident" id="3604550">val</span>&nbsp;<span class="op" id="3604554">!=</span>&nbsp;<span class="string" id="3604557">&#34;&#34;</span>&nbsp;<span class="op" id="3604560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604565">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3604574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3604577">}</span><br>
<span class="lineno">325</span><span class="op" id="3604579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3604582">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3604608">func</span>&nbsp;<span class="op" id="3604613">(</span><span class="ident" id="3604614">e</span>&nbsp;<span class="op" id="3604616">*</span><span class="ident" id="3604617">envOnce</span><span class="op" id="3604624">)</span>&nbsp;<span class="ident" id="3604626">reset</span><span class="op" id="3604631">(</span><span class="op" id="3604632">)</span>&nbsp;<span class="op" id="3604634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604637">e</span><span class="op" id="3604638">.</span><span class="ident" id="3604639">once</span>&nbsp;<span class="op" id="3604644">=</span>&nbsp;<span class="ident" id="3604646">sync</span><span class="op" id="3604650">.</span><span class="ident" id="3604651">Once</span><span class="op" id="3604655">{</span><span class="op" id="3604656">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604659">e</span><span class="op" id="3604660">.</span><span class="ident" id="3604661">val</span>&nbsp;<span class="op" id="3604665">=</span>&nbsp;<span class="string" id="3604667">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3604670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3604673">func</span>&nbsp;<span class="op" id="3604678">(</span><span class="ident" id="3604679">t</span>&nbsp;<span class="op" id="3604681">*</span><span class="ident" id="3604682">Transport</span><span class="op" id="3604691">)</span>&nbsp;<span class="ident" id="3604693">connectMethodForRequest</span><span class="op" id="3604716">(</span><span class="ident" id="3604717">treq</span>&nbsp;<span class="op" id="3604722">*</span><span class="ident" id="3604723">transportRequest</span><span class="op" id="3604739">)</span>&nbsp;<span class="op" id="3604741">(</span><span class="ident" id="3604742">cm</span>&nbsp;<span class="ident" id="3604745">connectMethod</span><span class="op" id="3604758">,</span>&nbsp;<span class="ident" id="3604760">err</span>&nbsp;<span class="builtintype" id="3604764">error</span><span class="op" id="3604769">)</span>&nbsp;<span class="op" id="3604771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604774">cm</span><span class="op" id="3604776">.</span><span class="ident" id="3604777">targetScheme</span>&nbsp;<span class="op" id="3604790">=</span>&nbsp;<span class="ident" id="3604792">treq</span><span class="op" id="3604796">.</span><span class="ident" id="3604797">URL</span><span class="op" id="3604800">.</span><span class="ident" id="3604801">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604809">cm</span><span class="op" id="3604811">.</span><span class="ident" id="3604812">targetAddr</span>&nbsp;<span class="op" id="3604823">=</span>&nbsp;<span class="ident" id="3604825">canonicalAddr</span><span class="op" id="3604838">(</span><span class="ident" id="3604839">treq</span><span class="op" id="3604843">.</span><span class="ident" id="3604844">URL</span><span class="op" id="3604847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604850">if</span>&nbsp;<span class="ident" id="3604853">t</span><span class="op" id="3604854">.</span><span class="ident" id="3604855">Proxy</span>&nbsp;<span class="op" id="3604861">!=</span>&nbsp;<span class="ident" id="3604864">nil</span>&nbsp;<span class="op" id="3604868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3604872">cm</span><span class="op" id="3604874">.</span><span class="ident" id="3604875">proxyURL</span><span class="op" id="3604883">,</span>&nbsp;<span class="ident" id="3604885">err</span>&nbsp;<span class="op" id="3604889">=</span>&nbsp;<span class="ident" id="3604891">t</span><span class="op" id="3604892">.</span><span class="ident" id="3604893">Proxy</span><span class="op" id="3604898">(</span><span class="ident" id="3604899">treq</span><span class="op" id="3604903">.</span><span class="ident" id="3604904">Request</span><span class="op" id="3604911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3604914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3604917">return</span>&nbsp;<span class="ident" id="3604924">cm</span><span class="op" id="3604926">,</span>&nbsp;<span class="ident" id="3604928">err</span><br>
<span class="lineno">340</span><span class="op" id="3604932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3604935">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3604994">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3605025">func</span>&nbsp;<span class="op" id="3605030">(</span><span class="ident" id="3605031">cm</span>&nbsp;<span class="op" id="3605034">*</span><span class="ident" id="3605035">connectMethod</span><span class="op" id="3605048">)</span>&nbsp;<span class="ident" id="3605050">proxyAuth</span><span class="op" id="3605059">(</span><span class="op" id="3605060">)</span>&nbsp;<span class="builtintype" id="3605062">string</span>&nbsp;<span class="op" id="3605069">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605072">if</span>&nbsp;<span class="ident" id="3605075">cm</span><span class="op" id="3605077">.</span><span class="ident" id="3605078">proxyURL</span>&nbsp;<span class="op" id="3605087">==</span>&nbsp;<span class="ident" id="3605090">nil</span>&nbsp;<span class="op" id="3605094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605098">return</span>&nbsp;<span class="string" id="3605105">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605112">if</span>&nbsp;<span class="ident" id="3605115">u</span>&nbsp;<span class="op" id="3605117">:=</span>&nbsp;<span class="ident" id="3605120">cm</span><span class="op" id="3605122">.</span><span class="ident" id="3605123">proxyURL</span><span class="op" id="3605131">.</span><span class="ident" id="3605132">User</span><span class="op" id="3605136">;</span>&nbsp;<span class="ident" id="3605138">u</span>&nbsp;<span class="op" id="3605140">!=</span>&nbsp;<span class="ident" id="3605143">nil</span>&nbsp;<span class="op" id="3605147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605151">username</span>&nbsp;<span class="op" id="3605160">:=</span>&nbsp;<span class="ident" id="3605163">u</span><span class="op" id="3605164">.</span><span class="ident" id="3605165">Username</span><span class="op" id="3605173">(</span><span class="op" id="3605174">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605178">password</span><span class="op" id="3605186">,</span>&nbsp;<span class="ident" id="3605188">_</span>&nbsp;<span class="op" id="3605190">:=</span>&nbsp;<span class="ident" id="3605193">u</span><span class="op" id="3605194">.</span><span class="ident" id="3605195">Password</span><span class="op" id="3605203">(</span><span class="op" id="3605204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605208">return</span>&nbsp;<span class="string" id="3605215">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3605224">+</span>&nbsp;<span class="ident" id="3605226">basicAuth</span><span class="op" id="3605235">(</span><span class="ident" id="3605236">username</span><span class="op" id="3605244">,</span>&nbsp;<span class="ident" id="3605246">password</span><span class="op" id="3605254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605260">return</span>&nbsp;<span class="string" id="3605267">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3605270">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3605273">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3605351">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3605369">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3605437">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3605455">func</span>&nbsp;<span class="op" id="3605460">(</span><span class="ident" id="3605461">t</span>&nbsp;<span class="op" id="3605463">*</span><span class="ident" id="3605464">Transport</span><span class="op" id="3605473">)</span>&nbsp;<span class="ident" id="3605475">putIdleConn</span><span class="op" id="3605486">(</span><span class="ident" id="3605487">pconn</span>&nbsp;<span class="op" id="3605493">*</span><span class="ident" id="3605494">persistConn</span><span class="op" id="3605505">)</span>&nbsp;<span class="builtintype" id="3605507">bool</span>&nbsp;<span class="op" id="3605512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605515">if</span>&nbsp;<span class="ident" id="3605518">t</span><span class="op" id="3605519">.</span><span class="ident" id="3605520">DisableKeepAlives</span>&nbsp;<span class="op" id="3605538">||</span>&nbsp;<span class="ident" id="3605541">t</span><span class="op" id="3605542">.</span><span class="ident" id="3605543">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3605563">&lt;</span>&nbsp;<span class="num" id="3605565">0</span>&nbsp;<span class="op" id="3605567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605571">pconn</span><span class="op" id="3605576">.</span><span class="builtinfunc" id="3605577">close</span><span class="op" id="3605582">(</span><span class="op" id="3605583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605587">return</span>&nbsp;<span class="builtintype" id="3605594">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605601">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605604">if</span>&nbsp;<span class="ident" id="3605607">pconn</span><span class="op" id="3605612">.</span><span class="ident" id="3605613">isBroken</span><span class="op" id="3605621">(</span><span class="op" id="3605622">)</span>&nbsp;<span class="op" id="3605624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605628">return</span>&nbsp;<span class="builtintype" id="3605635">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605645">key</span>&nbsp;<span class="op" id="3605649">:=</span>&nbsp;<span class="ident" id="3605652">pconn</span><span class="op" id="3605657">.</span><span class="ident" id="3605658">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605668">max</span>&nbsp;<span class="op" id="3605672">:=</span>&nbsp;<span class="ident" id="3605675">t</span><span class="op" id="3605676">.</span><span class="ident" id="3605677">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605698">if</span>&nbsp;<span class="ident" id="3605701">max</span>&nbsp;<span class="op" id="3605705">==</span>&nbsp;<span class="num" id="3605708">0</span>&nbsp;<span class="op" id="3605710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605714">max</span>&nbsp;<span class="op" id="3605718">=</span>&nbsp;<span class="ident" id="3605720">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3605748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605751">t</span><span class="op" id="3605752">.</span><span class="ident" id="3605753">idleMu</span><span class="op" id="3605759">.</span><span class="ident" id="3605760">Lock</span><span class="op" id="3605764">(</span><span class="op" id="3605765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3605769">waitingDialer</span>&nbsp;<span class="op" id="3605783">:=</span>&nbsp;<span class="ident" id="3605786">t</span><span class="op" id="3605787">.</span><span class="ident" id="3605788">idleConnCh</span><span class="op" id="3605798">[</span><span class="ident" id="3605799">key</span><span class="op" id="3605802">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605805">select</span>&nbsp;<span class="op" id="3605812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3605815">case</span>&nbsp;<span class="ident" id="3605820">waitingDialer</span>&nbsp;<span class="op" id="3605834">&lt;-</span>&nbsp;<span class="ident" id="3605837">pconn</span><span class="op" id="3605842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3605846">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3605899">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3605955">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3606001">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3606058">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606126">t</span><span class="op" id="3606127">.</span><span class="ident" id="3606128">idleMu</span><span class="op" id="3606134">.</span><span class="ident" id="3606135">Unlock</span><span class="op" id="3606141">(</span><span class="op" id="3606142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606146">return</span>&nbsp;<span class="builtintype" id="3606153">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606159">default</span><span class="op" id="3606166">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606170">if</span>&nbsp;<span class="ident" id="3606173">waitingDialer</span>&nbsp;<span class="op" id="3606187">!=</span>&nbsp;<span class="ident" id="3606190">nil</span>&nbsp;<span class="op" id="3606194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3606199">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3606249">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3606297">delete</span><span class="op" id="3606303">(</span><span class="ident" id="3606304">t</span><span class="op" id="3606305">.</span><span class="ident" id="3606306">idleConnCh</span><span class="op" id="3606316">,</span>&nbsp;<span class="ident" id="3606318">key</span><span class="op" id="3606321">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606331">if</span>&nbsp;<span class="ident" id="3606334">t</span><span class="op" id="3606335">.</span><span class="ident" id="3606336">wantIdle</span>&nbsp;<span class="op" id="3606345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606349">t</span><span class="op" id="3606350">.</span><span class="ident" id="3606351">idleMu</span><span class="op" id="3606357">.</span><span class="ident" id="3606358">Unlock</span><span class="op" id="3606364">(</span><span class="op" id="3606365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606369">pconn</span><span class="op" id="3606374">.</span><span class="builtinfunc" id="3606375">close</span><span class="op" id="3606380">(</span><span class="op" id="3606381">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606385">return</span>&nbsp;<span class="builtintype" id="3606392">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606402">if</span>&nbsp;<span class="ident" id="3606405">t</span><span class="op" id="3606406">.</span><span class="ident" id="3606407">idleConn</span>&nbsp;<span class="op" id="3606416">==</span>&nbsp;<span class="ident" id="3606419">nil</span>&nbsp;<span class="op" id="3606423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606427">t</span><span class="op" id="3606428">.</span><span class="ident" id="3606429">idleConn</span>&nbsp;<span class="op" id="3606438">=</span>&nbsp;<span class="builtinfunc" id="3606440">make</span><span class="op" id="3606444">(</span><span class="keyword" id="3606445">map</span><span class="op" id="3606448">[</span><span class="ident" id="3606449">connectMethodKey</span><span class="op" id="3606465">]</span><span class="op" id="3606466">[</span><span class="op" id="3606467">]</span><span class="op" id="3606468">*</span><span class="ident" id="3606469">persistConn</span><span class="op" id="3606480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606483">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606486">if</span>&nbsp;<span class="builtinfunc" id="3606489">len</span><span class="op" id="3606492">(</span><span class="ident" id="3606493">t</span><span class="op" id="3606494">.</span><span class="ident" id="3606495">idleConn</span><span class="op" id="3606503">[</span><span class="ident" id="3606504">key</span><span class="op" id="3606507">]</span><span class="op" id="3606508">)</span>&nbsp;<span class="op" id="3606510">&gt;=</span>&nbsp;<span class="ident" id="3606513">max</span>&nbsp;<span class="op" id="3606517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606521">t</span><span class="op" id="3606522">.</span><span class="ident" id="3606523">idleMu</span><span class="op" id="3606529">.</span><span class="ident" id="3606530">Unlock</span><span class="op" id="3606536">(</span><span class="op" id="3606537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606541">pconn</span><span class="op" id="3606546">.</span><span class="builtinfunc" id="3606547">close</span><span class="op" id="3606552">(</span><span class="op" id="3606553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606557">return</span>&nbsp;<span class="builtintype" id="3606564">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606571">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606574">for</span>&nbsp;<span class="ident" id="3606578">_</span><span class="op" id="3606579">,</span>&nbsp;<span class="ident" id="3606581">exist</span>&nbsp;<span class="op" id="3606587">:=</span>&nbsp;<span class="keyword" id="3606590">range</span>&nbsp;<span class="ident" id="3606596">t</span><span class="op" id="3606597">.</span><span class="ident" id="3606598">idleConn</span><span class="op" id="3606606">[</span><span class="ident" id="3606607">key</span><span class="op" id="3606610">]</span>&nbsp;<span class="op" id="3606612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606616">if</span>&nbsp;<span class="ident" id="3606619">exist</span>&nbsp;<span class="op" id="3606625">==</span>&nbsp;<span class="ident" id="3606628">pconn</span>&nbsp;<span class="op" id="3606634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606639">log</span><span class="op" id="3606642">.</span><span class="ident" id="3606643">Fatalf</span><span class="op" id="3606649">(</span><span class="string" id="3606650">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3606681">,</span>&nbsp;<span class="ident" id="3606683">pconn</span><span class="op" id="3606688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3606695">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606698">t</span><span class="op" id="3606699">.</span><span class="ident" id="3606700">idleConn</span><span class="op" id="3606708">[</span><span class="ident" id="3606709">key</span><span class="op" id="3606712">]</span>&nbsp;<span class="op" id="3606714">=</span>&nbsp;<span class="builtinfunc" id="3606716">append</span><span class="op" id="3606722">(</span><span class="ident" id="3606723">t</span><span class="op" id="3606724">.</span><span class="ident" id="3606725">idleConn</span><span class="op" id="3606733">[</span><span class="ident" id="3606734">key</span><span class="op" id="3606737">]</span><span class="op" id="3606738">,</span>&nbsp;<span class="ident" id="3606740">pconn</span><span class="op" id="3606745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3606748">t</span><span class="op" id="3606749">.</span><span class="ident" id="3606750">idleMu</span><span class="op" id="3606756">.</span><span class="ident" id="3606757">Unlock</span><span class="op" id="3606763">(</span><span class="op" id="3606764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3606767">return</span>&nbsp;<span class="builtintype" id="3606774">true</span><br>
<span class="lineno"></span><span class="op" id="3606779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3606782">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3606844">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3606898">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3606966">func</span>&nbsp;<span class="op" id="3606971">(</span><span class="ident" id="3606972">t</span>&nbsp;<span class="op" id="3606974">*</span><span class="ident" id="3606975">Transport</span><span class="op" id="3606984">)</span>&nbsp;<span class="ident" id="3606986">getIdleConnCh</span><span class="op" id="3606999">(</span><span class="ident" id="3607000">cm</span>&nbsp;<span class="ident" id="3607003">connectMethod</span><span class="op" id="3607016">)</span>&nbsp;<span class="keyword" id="3607018">chan</span>&nbsp;<span class="op" id="3607023">*</span><span class="ident" id="3607024">persistConn</span>&nbsp;<span class="op" id="3607036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607039">if</span>&nbsp;<span class="ident" id="3607042">t</span><span class="op" id="3607043">.</span><span class="ident" id="3607044">DisableKeepAlives</span>&nbsp;<span class="op" id="3607062">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607066">return</span>&nbsp;<span class="ident" id="3607073">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607081">key</span>&nbsp;<span class="op" id="3607085">:=</span>&nbsp;<span class="ident" id="3607088">cm</span><span class="op" id="3607090">.</span><span class="ident" id="3607091">key</span><span class="op" id="3607094">(</span><span class="op" id="3607095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607098">t</span><span class="op" id="3607099">.</span><span class="ident" id="3607100">idleMu</span><span class="op" id="3607106">.</span><span class="ident" id="3607107">Lock</span><span class="op" id="3607111">(</span><span class="op" id="3607112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607115">defer</span>&nbsp;<span class="ident" id="3607121">t</span><span class="op" id="3607122">.</span><span class="ident" id="3607123">idleMu</span><span class="op" id="3607129">.</span><span class="ident" id="3607130">Unlock</span><span class="op" id="3607136">(</span><span class="op" id="3607137">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607140">t</span><span class="op" id="3607141">.</span><span class="ident" id="3607142">wantIdle</span>&nbsp;<span class="op" id="3607151">=</span>&nbsp;<span class="builtintype" id="3607153">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607160">if</span>&nbsp;<span class="ident" id="3607163">t</span><span class="op" id="3607164">.</span><span class="ident" id="3607165">idleConnCh</span>&nbsp;<span class="op" id="3607176">==</span>&nbsp;<span class="ident" id="3607179">nil</span>&nbsp;<span class="op" id="3607183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607187">t</span><span class="op" id="3607188">.</span><span class="ident" id="3607189">idleConnCh</span>&nbsp;<span class="op" id="3607200">=</span>&nbsp;<span class="builtinfunc" id="3607202">make</span><span class="op" id="3607206">(</span><span class="keyword" id="3607207">map</span><span class="op" id="3607210">[</span><span class="ident" id="3607211">connectMethodKey</span><span class="op" id="3607227">]</span><span class="keyword" id="3607228">chan</span>&nbsp;<span class="op" id="3607233">*</span><span class="ident" id="3607234">persistConn</span><span class="op" id="3607245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607251">ch</span><span class="op" id="3607253">,</span>&nbsp;<span class="ident" id="3607255">ok</span>&nbsp;<span class="op" id="3607258">:=</span>&nbsp;<span class="ident" id="3607261">t</span><span class="op" id="3607262">.</span><span class="ident" id="3607263">idleConnCh</span><span class="op" id="3607273">[</span><span class="ident" id="3607274">key</span><span class="op" id="3607277">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607280">if</span>&nbsp;<span class="op" id="3607283">!</span><span class="ident" id="3607284">ok</span>&nbsp;<span class="op" id="3607287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607291">ch</span>&nbsp;<span class="op" id="3607294">=</span>&nbsp;<span class="builtinfunc" id="3607296">make</span><span class="op" id="3607300">(</span><span class="keyword" id="3607301">chan</span>&nbsp;<span class="op" id="3607306">*</span><span class="ident" id="3607307">persistConn</span><span class="op" id="3607318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607322">t</span><span class="op" id="3607323">.</span><span class="ident" id="3607324">idleConnCh</span><span class="op" id="3607334">[</span><span class="ident" id="3607335">key</span><span class="op" id="3607338">]</span>&nbsp;<span class="op" id="3607340">=</span>&nbsp;<span class="ident" id="3607342">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607349">return</span>&nbsp;<span class="ident" id="3607356">ch</span><br>
<span class="lineno">435</span><span class="op" id="3607359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3607362">func</span>&nbsp;<span class="op" id="3607367">(</span><span class="ident" id="3607368">t</span>&nbsp;<span class="op" id="3607370">*</span><span class="ident" id="3607371">Transport</span><span class="op" id="3607380">)</span>&nbsp;<span class="ident" id="3607382">getIdleConn</span><span class="op" id="3607393">(</span><span class="ident" id="3607394">cm</span>&nbsp;<span class="ident" id="3607397">connectMethod</span><span class="op" id="3607410">)</span>&nbsp;<span class="op" id="3607412">(</span><span class="ident" id="3607413">pconn</span>&nbsp;<span class="op" id="3607419">*</span><span class="ident" id="3607420">persistConn</span><span class="op" id="3607431">)</span>&nbsp;<span class="op" id="3607433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607436">key</span>&nbsp;<span class="op" id="3607440">:=</span>&nbsp;<span class="ident" id="3607443">cm</span><span class="op" id="3607445">.</span><span class="ident" id="3607446">key</span><span class="op" id="3607449">(</span><span class="op" id="3607450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607453">t</span><span class="op" id="3607454">.</span><span class="ident" id="3607455">idleMu</span><span class="op" id="3607461">.</span><span class="ident" id="3607462">Lock</span><span class="op" id="3607466">(</span><span class="op" id="3607467">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607470">defer</span>&nbsp;<span class="ident" id="3607476">t</span><span class="op" id="3607477">.</span><span class="ident" id="3607478">idleMu</span><span class="op" id="3607484">.</span><span class="ident" id="3607485">Unlock</span><span class="op" id="3607491">(</span><span class="op" id="3607492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607495">if</span>&nbsp;<span class="ident" id="3607498">t</span><span class="op" id="3607499">.</span><span class="ident" id="3607500">idleConn</span>&nbsp;<span class="op" id="3607509">==</span>&nbsp;<span class="ident" id="3607512">nil</span>&nbsp;<span class="op" id="3607516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607520">return</span>&nbsp;<span class="ident" id="3607527">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607535">for</span>&nbsp;<span class="op" id="3607539">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607543">pconns</span><span class="op" id="3607549">,</span>&nbsp;<span class="ident" id="3607551">ok</span>&nbsp;<span class="op" id="3607554">:=</span>&nbsp;<span class="ident" id="3607557">t</span><span class="op" id="3607558">.</span><span class="ident" id="3607559">idleConn</span><span class="op" id="3607567">[</span><span class="ident" id="3607568">key</span><span class="op" id="3607571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607575">if</span>&nbsp;<span class="op" id="3607578">!</span><span class="ident" id="3607579">ok</span>&nbsp;<span class="op" id="3607582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607587">return</span>&nbsp;<span class="ident" id="3607594">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607604">if</span>&nbsp;<span class="builtinfunc" id="3607607">len</span><span class="op" id="3607610">(</span><span class="ident" id="3607611">pconns</span><span class="op" id="3607617">)</span>&nbsp;<span class="op" id="3607619">==</span>&nbsp;<span class="num" id="3607622">1</span>&nbsp;<span class="op" id="3607624">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607629">pconn</span>&nbsp;<span class="op" id="3607635">=</span>&nbsp;<span class="ident" id="3607637">pconns</span><span class="op" id="3607643">[</span><span class="num" id="3607644">0</span><span class="op" id="3607645">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3607650">delete</span><span class="op" id="3607656">(</span><span class="ident" id="3607657">t</span><span class="op" id="3607658">.</span><span class="ident" id="3607659">idleConn</span><span class="op" id="3607667">,</span>&nbsp;<span class="ident" id="3607669">key</span><span class="op" id="3607672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607676">}</span>&nbsp;<span class="keyword" id="3607678">else</span>&nbsp;<span class="op" id="3607683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3607688">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3607733">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607752">pconn</span>&nbsp;<span class="op" id="3607758">=</span>&nbsp;<span class="ident" id="3607760">pconns</span><span class="op" id="3607766">[</span><span class="builtinfunc" id="3607767">len</span><span class="op" id="3607770">(</span><span class="ident" id="3607771">pconns</span><span class="op" id="3607777">)</span><span class="op" id="3607778">-</span><span class="num" id="3607779">1</span><span class="op" id="3607780">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607785">t</span><span class="op" id="3607786">.</span><span class="ident" id="3607787">idleConn</span><span class="op" id="3607795">[</span><span class="ident" id="3607796">key</span><span class="op" id="3607799">]</span>&nbsp;<span class="op" id="3607801">=</span>&nbsp;<span class="ident" id="3607803">pconns</span><span class="op" id="3607809">[</span><span class="op" id="3607810">:</span><span class="builtinfunc" id="3607811">len</span><span class="op" id="3607814">(</span><span class="ident" id="3607815">pconns</span><span class="op" id="3607821">)</span><span class="op" id="3607822">-</span><span class="num" id="3607823">1</span><span class="op" id="3607824">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607832">if</span>&nbsp;<span class="op" id="3607835">!</span><span class="ident" id="3607836">pconn</span><span class="op" id="3607841">.</span><span class="ident" id="3607842">isBroken</span><span class="op" id="3607850">(</span><span class="op" id="3607851">)</span>&nbsp;<span class="op" id="3607853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607858">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3607870">}</span><br>
<span class="lineno"></span><span class="op" id="3607872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3607875">func</span>&nbsp;<span class="op" id="3607880">(</span><span class="ident" id="3607881">t</span>&nbsp;<span class="op" id="3607883">*</span><span class="ident" id="3607884">Transport</span><span class="op" id="3607893">)</span>&nbsp;<span class="ident" id="3607895">setReqCanceler</span><span class="op" id="3607909">(</span><span class="ident" id="3607910">r</span>&nbsp;<span class="op" id="3607912">*</span><span class="ident" id="3607913">Request</span><span class="op" id="3607920">,</span>&nbsp;<span class="ident" id="3607922">fn</span>&nbsp;<span class="keyword" id="3607925">func</span><span class="op" id="3607929">(</span><span class="op" id="3607930">)</span><span class="op" id="3607931">)</span>&nbsp;<span class="op" id="3607933">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3607936">t</span><span class="op" id="3607937">.</span><span class="ident" id="3607938">reqMu</span><span class="op" id="3607943">.</span><span class="ident" id="3607944">Lock</span><span class="op" id="3607948">(</span><span class="op" id="3607949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607952">defer</span>&nbsp;<span class="ident" id="3607958">t</span><span class="op" id="3607959">.</span><span class="ident" id="3607960">reqMu</span><span class="op" id="3607965">.</span><span class="ident" id="3607966">Unlock</span><span class="op" id="3607972">(</span><span class="op" id="3607973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3607976">if</span>&nbsp;<span class="ident" id="3607979">t</span><span class="op" id="3607980">.</span><span class="ident" id="3607981">reqCanceler</span>&nbsp;<span class="op" id="3607993">==</span>&nbsp;<span class="ident" id="3607996">nil</span>&nbsp;<span class="op" id="3608000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608004">t</span><span class="op" id="3608005">.</span><span class="ident" id="3608006">reqCanceler</span>&nbsp;<span class="op" id="3608018">=</span>&nbsp;<span class="builtinfunc" id="3608020">make</span><span class="op" id="3608024">(</span><span class="keyword" id="3608025">map</span><span class="op" id="3608028">[</span><span class="op" id="3608029">*</span><span class="ident" id="3608030">Request</span><span class="op" id="3608037">]</span><span class="keyword" id="3608038">func</span><span class="op" id="3608042">(</span><span class="op" id="3608043">)</span><span class="op" id="3608044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608047">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608050">if</span>&nbsp;<span class="ident" id="3608053">fn</span>&nbsp;<span class="op" id="3608056">!=</span>&nbsp;<span class="ident" id="3608059">nil</span>&nbsp;<span class="op" id="3608063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608067">t</span><span class="op" id="3608068">.</span><span class="ident" id="3608069">reqCanceler</span><span class="op" id="3608080">[</span><span class="ident" id="3608081">r</span><span class="op" id="3608082">]</span>&nbsp;<span class="op" id="3608084">=</span>&nbsp;<span class="ident" id="3608086">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608090">}</span>&nbsp;<span class="keyword" id="3608092">else</span>&nbsp;<span class="op" id="3608097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3608101">delete</span><span class="op" id="3608107">(</span><span class="ident" id="3608108">t</span><span class="op" id="3608109">.</span><span class="ident" id="3608110">reqCanceler</span><span class="op" id="3608121">,</span>&nbsp;<span class="ident" id="3608123">r</span><span class="op" id="3608124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608127">}</span><br>
<span class="lineno">475</span><span class="op" id="3608129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3608132">func</span>&nbsp;<span class="op" id="3608137">(</span><span class="ident" id="3608138">t</span>&nbsp;<span class="op" id="3608140">*</span><span class="ident" id="3608141">Transport</span><span class="op" id="3608150">)</span>&nbsp;<span class="ident" id="3608152">dial</span><span class="op" id="3608156">(</span><span class="ident" id="3608157">network</span><span class="op" id="3608164">,</span>&nbsp;<span class="ident" id="3608166">addr</span>&nbsp;<span class="builtintype" id="3608171">string</span><span class="op" id="3608177">)</span>&nbsp;<span class="op" id="3608179">(</span><span class="ident" id="3608180">c</span>&nbsp;<span class="ident" id="3608182">net</span><span class="op" id="3608185">.</span><span class="ident" id="3608186">Conn</span><span class="op" id="3608190">,</span>&nbsp;<span class="ident" id="3608192">err</span>&nbsp;<span class="builtintype" id="3608196">error</span><span class="op" id="3608201">)</span>&nbsp;<span class="op" id="3608203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608206">if</span>&nbsp;<span class="ident" id="3608209">t</span><span class="op" id="3608210">.</span><span class="ident" id="3608211">Dial</span>&nbsp;<span class="op" id="3608216">!=</span>&nbsp;<span class="ident" id="3608219">nil</span>&nbsp;<span class="op" id="3608223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608227">return</span>&nbsp;<span class="ident" id="3608234">t</span><span class="op" id="3608235">.</span><span class="ident" id="3608236">Dial</span><span class="op" id="3608240">(</span><span class="ident" id="3608241">network</span><span class="op" id="3608248">,</span>&nbsp;<span class="ident" id="3608250">addr</span><span class="op" id="3608254">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608260">return</span>&nbsp;<span class="ident" id="3608267">net</span><span class="op" id="3608270">.</span><span class="ident" id="3608271">Dial</span><span class="op" id="3608275">(</span><span class="ident" id="3608276">network</span><span class="op" id="3608283">,</span>&nbsp;<span class="ident" id="3608285">addr</span><span class="op" id="3608289">)</span><br>
<span class="lineno"></span><span class="op" id="3608291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608294">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3608312">var</span>&nbsp;<span class="ident" id="3608316">prePendingDial</span><span class="op" id="3608330">,</span>&nbsp;<span class="ident" id="3608332">postPendingDial</span>&nbsp;<span class="keyword" id="3608348">func</span><span class="op" id="3608352">(</span><span class="op" id="3608353">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608356">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3608420">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3608492">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3608568">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3608602">func</span>&nbsp;<span class="op" id="3608607">(</span><span class="ident" id="3608608">t</span>&nbsp;<span class="op" id="3608610">*</span><span class="ident" id="3608611">Transport</span><span class="op" id="3608620">)</span>&nbsp;<span class="ident" id="3608622">getConn</span><span class="op" id="3608629">(</span><span class="ident" id="3608630">req</span>&nbsp;<span class="op" id="3608634">*</span><span class="ident" id="3608635">Request</span><span class="op" id="3608642">,</span>&nbsp;<span class="ident" id="3608644">cm</span>&nbsp;<span class="ident" id="3608647">connectMethod</span><span class="op" id="3608660">)</span>&nbsp;<span class="op" id="3608662">(</span><span class="op" id="3608663">*</span><span class="ident" id="3608664">persistConn</span><span class="op" id="3608675">,</span>&nbsp;<span class="builtintype" id="3608677">error</span><span class="op" id="3608682">)</span>&nbsp;<span class="op" id="3608684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608687">if</span>&nbsp;<span class="ident" id="3608690">pc</span>&nbsp;<span class="op" id="3608693">:=</span>&nbsp;<span class="ident" id="3608696">t</span><span class="op" id="3608697">.</span><span class="ident" id="3608698">getIdleConn</span><span class="op" id="3608709">(</span><span class="ident" id="3608710">cm</span><span class="op" id="3608712">)</span><span class="op" id="3608713">;</span>&nbsp;<span class="ident" id="3608715">pc</span>&nbsp;<span class="op" id="3608718">!=</span>&nbsp;<span class="ident" id="3608721">nil</span>&nbsp;<span class="op" id="3608725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608729">return</span>&nbsp;<span class="ident" id="3608736">pc</span><span class="op" id="3608738">,</span>&nbsp;<span class="ident" id="3608740">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608745">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608749">type</span>&nbsp;<span class="ident" id="3608754">dialRes</span>&nbsp;<span class="keyword" id="3608762">struct</span>&nbsp;<span class="op" id="3608769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608773">pc</span>&nbsp;&nbsp;<span class="op" id="3608777">*</span><span class="ident" id="3608778">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608792">err</span>&nbsp;<span class="builtintype" id="3608796">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608803">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608806">dialc</span>&nbsp;<span class="op" id="3608812">:=</span>&nbsp;<span class="builtinfunc" id="3608815">make</span><span class="op" id="3608819">(</span><span class="keyword" id="3608820">chan</span>&nbsp;<span class="ident" id="3608825">dialRes</span><span class="op" id="3608832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608836">handlePendingDial</span>&nbsp;<span class="op" id="3608854">:=</span>&nbsp;<span class="keyword" id="3608857">func</span><span class="op" id="3608861">(</span><span class="op" id="3608862">)</span>&nbsp;<span class="op" id="3608864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608868">if</span>&nbsp;<span class="ident" id="3608871">prePendingDial</span>&nbsp;<span class="op" id="3608886">!=</span>&nbsp;<span class="ident" id="3608889">nil</span>&nbsp;<span class="op" id="3608893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608898">prePendingDial</span><span class="op" id="3608912">(</span><span class="op" id="3608913">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608921">go</span>&nbsp;<span class="keyword" id="3608924">func</span><span class="op" id="3608928">(</span><span class="op" id="3608929">)</span>&nbsp;<span class="op" id="3608931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3608936">if</span>&nbsp;<span class="ident" id="3608939">v</span>&nbsp;<span class="op" id="3608941">:=</span>&nbsp;<span class="op" id="3608944">&lt;-</span><span class="ident" id="3608946">dialc</span><span class="op" id="3608951">;</span>&nbsp;<span class="ident" id="3608953">v</span><span class="op" id="3608954">.</span><span class="ident" id="3608955">err</span>&nbsp;<span class="op" id="3608959">==</span>&nbsp;<span class="ident" id="3608962">nil</span>&nbsp;<span class="op" id="3608966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3608972">t</span><span class="op" id="3608973">.</span><span class="ident" id="3608974">putIdleConn</span><span class="op" id="3608985">(</span><span class="ident" id="3608986">v</span><span class="op" id="3608987">.</span><span class="ident" id="3608988">pc</span><span class="op" id="3608990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3608995">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609000">if</span>&nbsp;<span class="ident" id="3609003">postPendingDial</span>&nbsp;<span class="op" id="3609019">!=</span>&nbsp;<span class="ident" id="3609022">nil</span>&nbsp;<span class="op" id="3609026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609032">postPendingDial</span><span class="op" id="3609047">(</span><span class="op" id="3609048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609057">}</span><span class="op" id="3609058">(</span><span class="op" id="3609059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609062">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609066">cancelc</span>&nbsp;<span class="op" id="3609074">:=</span>&nbsp;<span class="builtinfunc" id="3609077">make</span><span class="op" id="3609081">(</span><span class="keyword" id="3609082">chan</span>&nbsp;<span class="keyword" id="3609087">struct</span><span class="op" id="3609093">{</span><span class="op" id="3609094">}</span><span class="op" id="3609095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609098">t</span><span class="op" id="3609099">.</span><span class="ident" id="3609100">setReqCanceler</span><span class="op" id="3609114">(</span><span class="ident" id="3609115">req</span><span class="op" id="3609118">,</span>&nbsp;<span class="keyword" id="3609120">func</span><span class="op" id="3609124">(</span><span class="op" id="3609125">)</span>&nbsp;<span class="op" id="3609127">{</span>&nbsp;<span class="builtinfunc" id="3609129">close</span><span class="op" id="3609134">(</span><span class="ident" id="3609135">cancelc</span><span class="op" id="3609142">)</span>&nbsp;<span class="op" id="3609144">}</span><span class="op" id="3609145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609149">go</span>&nbsp;<span class="keyword" id="3609152">func</span><span class="op" id="3609156">(</span><span class="op" id="3609157">)</span>&nbsp;<span class="op" id="3609159">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609163">pc</span><span class="op" id="3609165">,</span>&nbsp;<span class="ident" id="3609167">err</span>&nbsp;<span class="op" id="3609171">:=</span>&nbsp;<span class="ident" id="3609174">t</span><span class="op" id="3609175">.</span><span class="ident" id="3609176">dialConn</span><span class="op" id="3609184">(</span><span class="ident" id="3609185">cm</span><span class="op" id="3609187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609191">dialc</span>&nbsp;<span class="op" id="3609197">&lt;-</span>&nbsp;<span class="ident" id="3609200">dialRes</span><span class="op" id="3609207">{</span><span class="ident" id="3609208">pc</span><span class="op" id="3609210">,</span>&nbsp;<span class="ident" id="3609212">err</span><span class="op" id="3609215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609218">}</span><span class="op" id="3609219">(</span><span class="op" id="3609220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609224">idleConnCh</span>&nbsp;<span class="op" id="3609235">:=</span>&nbsp;<span class="ident" id="3609238">t</span><span class="op" id="3609239">.</span><span class="ident" id="3609240">getIdleConnCh</span><span class="op" id="3609253">(</span><span class="ident" id="3609254">cm</span><span class="op" id="3609256">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609259">select</span>&nbsp;<span class="op" id="3609266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609269">case</span>&nbsp;<span class="ident" id="3609274">v</span>&nbsp;<span class="op" id="3609276">:=</span>&nbsp;<span class="op" id="3609279">&lt;-</span><span class="ident" id="3609281">dialc</span><span class="op" id="3609286">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609290">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609314">return</span>&nbsp;<span class="ident" id="3609321">v</span><span class="op" id="3609322">.</span><span class="ident" id="3609323">pc</span><span class="op" id="3609325">,</span>&nbsp;<span class="ident" id="3609327">v</span><span class="op" id="3609328">.</span><span class="ident" id="3609329">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609334">case</span>&nbsp;<span class="ident" id="3609339">pc</span>&nbsp;<span class="op" id="3609342">:=</span>&nbsp;<span class="op" id="3609345">&lt;-</span><span class="ident" id="3609347">idleConnCh</span><span class="op" id="3609357">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609361">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609414">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609465">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609504">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3609554">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609577">handlePendingDial</span><span class="op" id="3609594">(</span><span class="op" id="3609595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609599">return</span>&nbsp;<span class="ident" id="3609606">pc</span><span class="op" id="3609608">,</span>&nbsp;<span class="ident" id="3609610">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609615">case</span>&nbsp;<span class="op" id="3609620">&lt;-</span><span class="ident" id="3609622">cancelc</span><span class="op" id="3609629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609633">handlePendingDial</span><span class="op" id="3609650">(</span><span class="op" id="3609651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3609655">return</span>&nbsp;<span class="ident" id="3609662">nil</span><span class="op" id="3609665">,</span>&nbsp;<span class="ident" id="3609667">errors</span><span class="op" id="3609673">.</span><span class="ident" id="3609674">New</span><span class="op" id="3609677">(</span><span class="string" id="3609678">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3609735">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3609738">}</span><br>
<span class="lineno"></span><span class="op" id="3609740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3609743">func</span>&nbsp;<span class="op" id="3609748">(</span><span class="ident" id="3609749">t</span>&nbsp;<span class="op" id="3609751">*</span><span class="ident" id="3609752">Transport</span><span class="op" id="3609761">)</span>&nbsp;<span class="ident" id="3609763">dialConn</span><span class="op" id="3609771">(</span><span class="ident" id="3609772">cm</span>&nbsp;<span class="ident" id="3609775">connectMethod</span><span class="op" id="3609788">)</span>&nbsp;<span class="op" id="3609790">(</span><span class="op" id="3609791">*</span><span class="ident" id="3609792">persistConn</span><span class="op" id="3609803">,</span>&nbsp;<span class="builtintype" id="3609805">error</span><span class="op" id="3609810">)</span>&nbsp;<span class="op" id="3609812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609815">pconn</span>&nbsp;<span class="op" id="3609821">:=</span>&nbsp;<span class="op" id="3609824">&amp;</span><span class="ident" id="3609825">persistConn</span><span class="op" id="3609836">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609840">t</span><span class="op" id="3609841">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609852">t</span><span class="op" id="3609853">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609857">cacheKey</span><span class="op" id="3609865">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3609869">cm</span><span class="op" id="3609871">.</span><span class="ident" id="3609872">key</span><span class="op" id="3609875">(</span><span class="op" id="3609876">)</span><span class="op" id="3609877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609881">reqch</span><span class="op" id="3609886">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3609893">make</span><span class="op" id="3609897">(</span><span class="keyword" id="3609898">chan</span>&nbsp;<span class="ident" id="3609903">requestAndChan</span><span class="op" id="3609917">,</span>&nbsp;<span class="num" id="3609919">1</span><span class="op" id="3609920">)</span><span class="op" id="3609921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609925">writech</span><span class="op" id="3609932">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3609937">make</span><span class="op" id="3609941">(</span><span class="keyword" id="3609942">chan</span>&nbsp;<span class="ident" id="3609947">writeRequest</span><span class="op" id="3609959">,</span>&nbsp;<span class="num" id="3609961">1</span><span class="op" id="3609962">)</span><span class="op" id="3609963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3609967">closech</span><span class="op" id="3609974">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3609979">make</span><span class="op" id="3609983">(</span><span class="keyword" id="3609984">chan</span>&nbsp;<span class="keyword" id="3609989">struct</span><span class="op" id="3609995">{</span><span class="op" id="3609996">}</span><span class="op" id="3609997">)</span><span class="op" id="3609998">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610002">writeErrCh</span><span class="op" id="3610012">:</span>&nbsp;<span class="builtinfunc" id="3610014">make</span><span class="op" id="3610018">(</span><span class="keyword" id="3610019">chan</span>&nbsp;<span class="builtintype" id="3610024">error</span><span class="op" id="3610029">,</span>&nbsp;<span class="num" id="3610031">1</span><span class="op" id="3610032">)</span><span class="op" id="3610033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610039">tlsDial</span>&nbsp;<span class="op" id="3610047">:=</span>&nbsp;<span class="ident" id="3610050">t</span><span class="op" id="3610051">.</span><span class="ident" id="3610052">DialTLS</span>&nbsp;<span class="op" id="3610060">!=</span>&nbsp;<span class="ident" id="3610063">nil</span>&nbsp;<span class="op" id="3610067">&amp;&amp;</span>&nbsp;<span class="ident" id="3610070">cm</span><span class="op" id="3610072">.</span><span class="ident" id="3610073">targetScheme</span>&nbsp;<span class="op" id="3610086">==</span>&nbsp;<span class="string" id="3610089">&#34;https&#34;</span>&nbsp;<span class="op" id="3610097">&amp;&amp;</span>&nbsp;<span class="ident" id="3610100">cm</span><span class="op" id="3610102">.</span><span class="ident" id="3610103">proxyURL</span>&nbsp;<span class="op" id="3610112">==</span>&nbsp;<span class="ident" id="3610115">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610120">if</span>&nbsp;<span class="ident" id="3610123">tlsDial</span>&nbsp;<span class="op" id="3610131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610135">var</span>&nbsp;<span class="ident" id="3610139">err</span>&nbsp;<span class="builtintype" id="3610143">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610151">pconn</span><span class="op" id="3610156">.</span><span class="ident" id="3610157">conn</span><span class="op" id="3610161">,</span>&nbsp;<span class="ident" id="3610163">err</span>&nbsp;<span class="op" id="3610167">=</span>&nbsp;<span class="ident" id="3610169">t</span><span class="op" id="3610170">.</span><span class="ident" id="3610171">DialTLS</span><span class="op" id="3610178">(</span><span class="string" id="3610179">&#34;tcp&#34;</span><span class="op" id="3610184">,</span>&nbsp;<span class="ident" id="3610186">cm</span><span class="op" id="3610188">.</span><span class="ident" id="3610189">addr</span><span class="op" id="3610193">(</span><span class="op" id="3610194">)</span><span class="op" id="3610195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610199">if</span>&nbsp;<span class="ident" id="3610202">err</span>&nbsp;<span class="op" id="3610206">!=</span>&nbsp;<span class="ident" id="3610209">nil</span>&nbsp;<span class="op" id="3610213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610218">return</span>&nbsp;<span class="ident" id="3610225">nil</span><span class="op" id="3610228">,</span>&nbsp;<span class="ident" id="3610230">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610240">if</span>&nbsp;<span class="ident" id="3610243">tc</span><span class="op" id="3610245">,</span>&nbsp;<span class="ident" id="3610247">ok</span>&nbsp;<span class="op" id="3610250">:=</span>&nbsp;<span class="ident" id="3610253">pconn</span><span class="op" id="3610258">.</span><span class="ident" id="3610259">conn</span><span class="op" id="3610263">.</span><span class="op" id="3610264">(</span><span class="op" id="3610265">*</span><span class="ident" id="3610266">tls</span><span class="op" id="3610269">.</span><span class="ident" id="3610270">Conn</span><span class="op" id="3610274">)</span><span class="op" id="3610275">;</span>&nbsp;<span class="ident" id="3610277">ok</span>&nbsp;<span class="op" id="3610280">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610285">cs</span>&nbsp;<span class="op" id="3610288">:=</span>&nbsp;<span class="ident" id="3610291">tc</span><span class="op" id="3610293">.</span><span class="ident" id="3610294">ConnectionState</span><span class="op" id="3610309">(</span><span class="op" id="3610310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610315">pconn</span><span class="op" id="3610320">.</span><span class="ident" id="3610321">tlsState</span>&nbsp;<span class="op" id="3610330">=</span>&nbsp;<span class="op" id="3610332">&amp;</span><span class="ident" id="3610333">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610341">}</span>&nbsp;<span class="keyword" id="3610343">else</span>&nbsp;<span class="op" id="3610348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610352">conn</span><span class="op" id="3610356">,</span>&nbsp;<span class="ident" id="3610358">err</span>&nbsp;<span class="op" id="3610362">:=</span>&nbsp;<span class="ident" id="3610365">t</span><span class="op" id="3610366">.</span><span class="ident" id="3610367">dial</span><span class="op" id="3610371">(</span><span class="string" id="3610372">&#34;tcp&#34;</span><span class="op" id="3610377">,</span>&nbsp;<span class="ident" id="3610379">cm</span><span class="op" id="3610381">.</span><span class="ident" id="3610382">addr</span><span class="op" id="3610386">(</span><span class="op" id="3610387">)</span><span class="op" id="3610388">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610392">if</span>&nbsp;<span class="ident" id="3610395">err</span>&nbsp;<span class="op" id="3610399">!=</span>&nbsp;<span class="ident" id="3610402">nil</span>&nbsp;<span class="op" id="3610406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610411">if</span>&nbsp;<span class="ident" id="3610414">cm</span><span class="op" id="3610416">.</span><span class="ident" id="3610417">proxyURL</span>&nbsp;<span class="op" id="3610426">!=</span>&nbsp;<span class="ident" id="3610429">nil</span>&nbsp;<span class="op" id="3610433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610439">err</span>&nbsp;<span class="op" id="3610443">=</span>&nbsp;<span class="ident" id="3610445">fmt</span><span class="op" id="3610448">.</span><span class="ident" id="3610449">Errorf</span><span class="op" id="3610455">(</span><span class="string" id="3610456">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3610496">,</span>&nbsp;<span class="ident" id="3610498">cm</span><span class="op" id="3610500">.</span><span class="ident" id="3610501">proxyURL</span><span class="op" id="3610509">,</span>&nbsp;<span class="ident" id="3610511">err</span><span class="op" id="3610514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610524">return</span>&nbsp;<span class="ident" id="3610531">nil</span><span class="op" id="3610534">,</span>&nbsp;<span class="ident" id="3610536">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610546">pconn</span><span class="op" id="3610551">.</span><span class="ident" id="3610552">conn</span>&nbsp;<span class="op" id="3610557">=</span>&nbsp;<span class="ident" id="3610559">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3610569">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610586">switch</span>&nbsp;<span class="op" id="3610593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610596">case</span>&nbsp;<span class="ident" id="3610601">cm</span><span class="op" id="3610603">.</span><span class="ident" id="3610604">proxyURL</span>&nbsp;<span class="op" id="3610613">==</span>&nbsp;<span class="ident" id="3610616">nil</span><span class="op" id="3610619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3610623">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610658">case</span>&nbsp;<span class="ident" id="3610663">cm</span><span class="op" id="3610665">.</span><span class="ident" id="3610666">targetScheme</span>&nbsp;<span class="op" id="3610679">==</span>&nbsp;<span class="string" id="3610682">&#34;http&#34;</span><span class="op" id="3610688">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610692">pconn</span><span class="op" id="3610697">.</span><span class="ident" id="3610698">isProxy</span>&nbsp;<span class="op" id="3610706">=</span>&nbsp;<span class="builtintype" id="3610708">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610715">if</span>&nbsp;<span class="ident" id="3610718">pa</span>&nbsp;<span class="op" id="3610721">:=</span>&nbsp;<span class="ident" id="3610724">cm</span><span class="op" id="3610726">.</span><span class="ident" id="3610727">proxyAuth</span><span class="op" id="3610736">(</span><span class="op" id="3610737">)</span><span class="op" id="3610738">;</span>&nbsp;<span class="ident" id="3610740">pa</span>&nbsp;<span class="op" id="3610743">!=</span>&nbsp;<span class="string" id="3610746">&#34;&#34;</span>&nbsp;<span class="op" id="3610749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610754">pconn</span><span class="op" id="3610759">.</span><span class="ident" id="3610760">mutateHeaderFunc</span>&nbsp;<span class="op" id="3610777">=</span>&nbsp;<span class="keyword" id="3610779">func</span><span class="op" id="3610783">(</span><span class="ident" id="3610784">h</span>&nbsp;<span class="ident" id="3610786">Header</span><span class="op" id="3610792">)</span>&nbsp;<span class="op" id="3610794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610800">h</span><span class="op" id="3610801">.</span><span class="ident" id="3610802">Set</span><span class="op" id="3610805">(</span><span class="string" id="3610806">&#34;Proxy-Authorization&#34;</span><span class="op" id="3610827">,</span>&nbsp;<span class="ident" id="3610829">pa</span><span class="op" id="3610831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610840">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3610843">case</span>&nbsp;<span class="ident" id="3610848">cm</span><span class="op" id="3610850">.</span><span class="ident" id="3610851">targetScheme</span>&nbsp;<span class="op" id="3610864">==</span>&nbsp;<span class="string" id="3610867">&#34;https&#34;</span><span class="op" id="3610874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610878">conn</span>&nbsp;<span class="op" id="3610883">:=</span>&nbsp;<span class="ident" id="3610886">pconn</span><span class="op" id="3610891">.</span><span class="ident" id="3610892">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610899">connectReq</span>&nbsp;<span class="op" id="3610910">:=</span>&nbsp;<span class="op" id="3610913">&amp;</span><span class="ident" id="3610914">Request</span><span class="op" id="3610921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610926">Method</span><span class="op" id="3610932">:</span>&nbsp;<span class="string" id="3610934">&#34;CONNECT&#34;</span><span class="op" id="3610943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610948">URL</span><span class="op" id="3610951">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3610956">&amp;</span><span class="ident" id="3610957">url</span><span class="op" id="3610960">.</span><span class="ident" id="3610961">URL</span><span class="op" id="3610964">{</span><span class="ident" id="3610965">Opaque</span><span class="op" id="3610971">:</span>&nbsp;<span class="ident" id="3610973">cm</span><span class="op" id="3610975">.</span><span class="ident" id="3610976">targetAddr</span><span class="op" id="3610986">}</span><span class="op" id="3610987">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3610992">Host</span><span class="op" id="3610996">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3611000">cm</span><span class="op" id="3611002">.</span><span class="ident" id="3611003">targetAddr</span><span class="op" id="3611013">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611018">Header</span><span class="op" id="3611024">:</span>&nbsp;<span class="builtinfunc" id="3611026">make</span><span class="op" id="3611030">(</span><span class="ident" id="3611031">Header</span><span class="op" id="3611037">)</span><span class="op" id="3611038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611046">if</span>&nbsp;<span class="ident" id="3611049">pa</span>&nbsp;<span class="op" id="3611052">:=</span>&nbsp;<span class="ident" id="3611055">cm</span><span class="op" id="3611057">.</span><span class="ident" id="3611058">proxyAuth</span><span class="op" id="3611067">(</span><span class="op" id="3611068">)</span><span class="op" id="3611069">;</span>&nbsp;<span class="ident" id="3611071">pa</span>&nbsp;<span class="op" id="3611074">!=</span>&nbsp;<span class="string" id="3611077">&#34;&#34;</span>&nbsp;<span class="op" id="3611080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611085">connectReq</span><span class="op" id="3611095">.</span><span class="ident" id="3611096">Header</span><span class="op" id="3611102">.</span><span class="ident" id="3611103">Set</span><span class="op" id="3611106">(</span><span class="string" id="3611107">&#34;Proxy-Authorization&#34;</span><span class="op" id="3611128">,</span>&nbsp;<span class="ident" id="3611130">pa</span><span class="op" id="3611132">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611140">connectReq</span><span class="op" id="3611150">.</span><span class="ident" id="3611151">Write</span><span class="op" id="3611156">(</span><span class="ident" id="3611157">conn</span><span class="op" id="3611161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3611166">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3611186">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3611245">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611293">br</span>&nbsp;<span class="op" id="3611296">:=</span>&nbsp;<span class="ident" id="3611299">bufio</span><span class="op" id="3611304">.</span><span class="ident" id="3611305">NewReader</span><span class="op" id="3611314">(</span><span class="ident" id="3611315">conn</span><span class="op" id="3611319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611323">resp</span><span class="op" id="3611327">,</span>&nbsp;<span class="ident" id="3611329">err</span>&nbsp;<span class="op" id="3611333">:=</span>&nbsp;<span class="ident" id="3611336">ReadResponse</span><span class="op" id="3611348">(</span><span class="ident" id="3611349">br</span><span class="op" id="3611351">,</span>&nbsp;<span class="ident" id="3611353">connectReq</span><span class="op" id="3611363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611367">if</span>&nbsp;<span class="ident" id="3611370">err</span>&nbsp;<span class="op" id="3611374">!=</span>&nbsp;<span class="ident" id="3611377">nil</span>&nbsp;<span class="op" id="3611381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611386">conn</span><span class="op" id="3611390">.</span><span class="ident" id="3611391">Close</span><span class="op" id="3611396">(</span><span class="op" id="3611397">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611402">return</span>&nbsp;<span class="ident" id="3611409">nil</span><span class="op" id="3611412">,</span>&nbsp;<span class="ident" id="3611414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611424">if</span>&nbsp;<span class="ident" id="3611427">resp</span><span class="op" id="3611431">.</span><span class="ident" id="3611432">StatusCode</span>&nbsp;<span class="op" id="3611443">!=</span>&nbsp;<span class="num" id="3611446">200</span>&nbsp;<span class="op" id="3611450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611455">f</span>&nbsp;<span class="op" id="3611457">:=</span>&nbsp;<span class="ident" id="3611460">strings</span><span class="op" id="3611467">.</span><span class="ident" id="3611468">SplitN</span><span class="op" id="3611474">(</span><span class="ident" id="3611475">resp</span><span class="op" id="3611479">.</span><span class="ident" id="3611480">Status</span><span class="op" id="3611486">,</span>&nbsp;<span class="string" id="3611488">&#34;&nbsp;&#34;</span><span class="op" id="3611491">,</span>&nbsp;<span class="num" id="3611493">2</span><span class="op" id="3611494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611499">conn</span><span class="op" id="3611503">.</span><span class="ident" id="3611504">Close</span><span class="op" id="3611509">(</span><span class="op" id="3611510">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611515">return</span>&nbsp;<span class="ident" id="3611522">nil</span><span class="op" id="3611525">,</span>&nbsp;<span class="ident" id="3611527">errors</span><span class="op" id="3611533">.</span><span class="ident" id="3611534">New</span><span class="op" id="3611537">(</span><span class="ident" id="3611538">f</span><span class="op" id="3611539">[</span><span class="num" id="3611540">1</span><span class="op" id="3611541">]</span><span class="op" id="3611542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611553">if</span>&nbsp;<span class="ident" id="3611556">cm</span><span class="op" id="3611558">.</span><span class="ident" id="3611559">targetScheme</span>&nbsp;<span class="op" id="3611572">==</span>&nbsp;<span class="string" id="3611575">&#34;https&#34;</span>&nbsp;<span class="op" id="3611583">&amp;&amp;</span>&nbsp;<span class="op" id="3611586">!</span><span class="ident" id="3611587">tlsDial</span>&nbsp;<span class="op" id="3611595">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3611599">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611665">cfg</span>&nbsp;<span class="op" id="3611669">:=</span>&nbsp;<span class="ident" id="3611672">t</span><span class="op" id="3611673">.</span><span class="ident" id="3611674">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611692">if</span>&nbsp;<span class="ident" id="3611695">cfg</span>&nbsp;<span class="op" id="3611699">==</span>&nbsp;<span class="ident" id="3611702">nil</span>&nbsp;<span class="op" id="3611706">||</span>&nbsp;<span class="ident" id="3611709">cfg</span><span class="op" id="3611712">.</span><span class="ident" id="3611713">ServerName</span>&nbsp;<span class="op" id="3611724">==</span>&nbsp;<span class="string" id="3611727">&#34;&#34;</span>&nbsp;<span class="op" id="3611730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611735">host</span>&nbsp;<span class="op" id="3611740">:=</span>&nbsp;<span class="ident" id="3611743">cm</span><span class="op" id="3611745">.</span><span class="ident" id="3611746">tlsHost</span><span class="op" id="3611753">(</span><span class="op" id="3611754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3611759">if</span>&nbsp;<span class="ident" id="3611762">cfg</span>&nbsp;<span class="op" id="3611766">==</span>&nbsp;<span class="ident" id="3611769">nil</span>&nbsp;<span class="op" id="3611773">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611779">cfg</span>&nbsp;<span class="op" id="3611783">=</span>&nbsp;<span class="op" id="3611785">&amp;</span><span class="ident" id="3611786">tls</span><span class="op" id="3611789">.</span><span class="ident" id="3611790">Config</span><span class="op" id="3611796">{</span><span class="ident" id="3611797">ServerName</span><span class="op" id="3611807">:</span>&nbsp;<span class="ident" id="3611809">host</span><span class="op" id="3611813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611818">}</span>&nbsp;<span class="keyword" id="3611820">else</span>&nbsp;<span class="op" id="3611825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611831">clone</span>&nbsp;<span class="op" id="3611837">:=</span>&nbsp;<span class="op" id="3611840">*</span><span class="ident" id="3611841">cfg</span>&nbsp;<span class="comment" id="3611845">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611866">clone</span><span class="op" id="3611871">.</span><span class="ident" id="3611872">ServerName</span>&nbsp;<span class="op" id="3611883">=</span>&nbsp;<span class="ident" id="3611885">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611894">cfg</span>&nbsp;<span class="op" id="3611898">=</span>&nbsp;<span class="op" id="3611900">&amp;</span><span class="ident" id="3611901">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3611914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611918">plainConn</span>&nbsp;<span class="op" id="3611928">:=</span>&nbsp;<span class="ident" id="3611931">pconn</span><span class="op" id="3611936">.</span><span class="ident" id="3611937">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611944">tlsConn</span>&nbsp;<span class="op" id="3611952">:=</span>&nbsp;<span class="ident" id="3611955">tls</span><span class="op" id="3611958">.</span><span class="ident" id="3611959">Client</span><span class="op" id="3611965">(</span><span class="ident" id="3611966">plainConn</span><span class="op" id="3611975">,</span>&nbsp;<span class="ident" id="3611977">cfg</span><span class="op" id="3611980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3611984">errc</span>&nbsp;<span class="op" id="3611989">:=</span>&nbsp;<span class="builtinfunc" id="3611992">make</span><span class="op" id="3611996">(</span><span class="keyword" id="3611997">chan</span>&nbsp;<span class="builtintype" id="3612002">error</span><span class="op" id="3612007">,</span>&nbsp;<span class="num" id="3612009">2</span><span class="op" id="3612010">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612014">var</span>&nbsp;<span class="ident" id="3612018">timer</span>&nbsp;<span class="op" id="3612024">*</span><span class="ident" id="3612025">time</span><span class="op" id="3612029">.</span><span class="ident" id="3612030">Timer</span>&nbsp;<span class="comment" id="3612036">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612069">if</span>&nbsp;<span class="ident" id="3612072">d</span>&nbsp;<span class="op" id="3612074">:=</span>&nbsp;<span class="ident" id="3612077">t</span><span class="op" id="3612078">.</span><span class="ident" id="3612079">TLSHandshakeTimeout</span><span class="op" id="3612098">;</span>&nbsp;<span class="ident" id="3612100">d</span>&nbsp;<span class="op" id="3612102">!=</span>&nbsp;<span class="num" id="3612105">0</span>&nbsp;<span class="op" id="3612107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612112">timer</span>&nbsp;<span class="op" id="3612118">=</span>&nbsp;<span class="ident" id="3612120">time</span><span class="op" id="3612124">.</span><span class="ident" id="3612125">AfterFunc</span><span class="op" id="3612134">(</span><span class="ident" id="3612135">d</span><span class="op" id="3612136">,</span>&nbsp;<span class="keyword" id="3612138">func</span><span class="op" id="3612142">(</span><span class="op" id="3612143">)</span>&nbsp;<span class="op" id="3612145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612151">errc</span>&nbsp;<span class="op" id="3612156">&lt;-</span>&nbsp;<span class="ident" id="3612159">tlsHandshakeTimeoutError</span><span class="op" id="3612183">{</span><span class="op" id="3612184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612189">}</span><span class="op" id="3612190">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612198">go</span>&nbsp;<span class="keyword" id="3612201">func</span><span class="op" id="3612205">(</span><span class="op" id="3612206">)</span>&nbsp;<span class="op" id="3612208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612213">err</span>&nbsp;<span class="op" id="3612217">:=</span>&nbsp;<span class="ident" id="3612220">tlsConn</span><span class="op" id="3612227">.</span><span class="ident" id="3612228">Handshake</span><span class="op" id="3612237">(</span><span class="op" id="3612238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612243">if</span>&nbsp;<span class="ident" id="3612246">timer</span>&nbsp;<span class="op" id="3612252">!=</span>&nbsp;<span class="ident" id="3612255">nil</span>&nbsp;<span class="op" id="3612259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612265">timer</span><span class="op" id="3612270">.</span><span class="ident" id="3612271">Stop</span><span class="op" id="3612275">(</span><span class="op" id="3612276">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612286">errc</span>&nbsp;<span class="op" id="3612291">&lt;-</span>&nbsp;<span class="ident" id="3612294">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612300">}</span><span class="op" id="3612301">(</span><span class="op" id="3612302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612306">if</span>&nbsp;<span class="ident" id="3612309">err</span>&nbsp;<span class="op" id="3612313">:=</span>&nbsp;<span class="op" id="3612316">&lt;-</span><span class="ident" id="3612318">errc</span><span class="op" id="3612322">;</span>&nbsp;<span class="ident" id="3612324">err</span>&nbsp;<span class="op" id="3612328">!=</span>&nbsp;<span class="ident" id="3612331">nil</span>&nbsp;<span class="op" id="3612335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612340">plainConn</span><span class="op" id="3612349">.</span><span class="ident" id="3612350">Close</span><span class="op" id="3612355">(</span><span class="op" id="3612356">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612361">return</span>&nbsp;<span class="ident" id="3612368">nil</span><span class="op" id="3612371">,</span>&nbsp;<span class="ident" id="3612373">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612383">if</span>&nbsp;<span class="op" id="3612386">!</span><span class="ident" id="3612387">cfg</span><span class="op" id="3612390">.</span><span class="ident" id="3612391">InsecureSkipVerify</span>&nbsp;<span class="op" id="3612410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612415">if</span>&nbsp;<span class="ident" id="3612418">err</span>&nbsp;<span class="op" id="3612422">:=</span>&nbsp;<span class="ident" id="3612425">tlsConn</span><span class="op" id="3612432">.</span><span class="ident" id="3612433">VerifyHostname</span><span class="op" id="3612447">(</span><span class="ident" id="3612448">cfg</span><span class="op" id="3612451">.</span><span class="ident" id="3612452">ServerName</span><span class="op" id="3612462">)</span><span class="op" id="3612463">;</span>&nbsp;<span class="ident" id="3612465">err</span>&nbsp;<span class="op" id="3612469">!=</span>&nbsp;<span class="ident" id="3612472">nil</span>&nbsp;<span class="op" id="3612476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612482">plainConn</span><span class="op" id="3612491">.</span><span class="ident" id="3612492">Close</span><span class="op" id="3612497">(</span><span class="op" id="3612498">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612504">return</span>&nbsp;<span class="ident" id="3612511">nil</span><span class="op" id="3612514">,</span>&nbsp;<span class="ident" id="3612516">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612531">cs</span>&nbsp;<span class="op" id="3612534">:=</span>&nbsp;<span class="ident" id="3612537">tlsConn</span><span class="op" id="3612544">.</span><span class="ident" id="3612545">ConnectionState</span><span class="op" id="3612560">(</span><span class="op" id="3612561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612565">pconn</span><span class="op" id="3612570">.</span><span class="ident" id="3612571">tlsState</span>&nbsp;<span class="op" id="3612580">=</span>&nbsp;<span class="op" id="3612582">&amp;</span><span class="ident" id="3612583">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612588">pconn</span><span class="op" id="3612593">.</span><span class="ident" id="3612594">conn</span>&nbsp;<span class="op" id="3612599">=</span>&nbsp;<span class="ident" id="3612601">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3612610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612614">pconn</span><span class="op" id="3612619">.</span><span class="ident" id="3612620">br</span>&nbsp;<span class="op" id="3612623">=</span>&nbsp;<span class="ident" id="3612625">bufio</span><span class="op" id="3612630">.</span><span class="ident" id="3612631">NewReader</span><span class="op" id="3612640">(</span><span class="ident" id="3612641">noteEOFReader</span><span class="op" id="3612654">{</span><span class="ident" id="3612655">pconn</span><span class="op" id="3612660">.</span><span class="ident" id="3612661">conn</span><span class="op" id="3612665">,</span>&nbsp;<span class="op" id="3612667">&amp;</span><span class="ident" id="3612668">pconn</span><span class="op" id="3612673">.</span><span class="ident" id="3612674">sawEOF</span><span class="op" id="3612680">}</span><span class="op" id="3612681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3612684">pconn</span><span class="op" id="3612689">.</span><span class="ident" id="3612690">bw</span>&nbsp;<span class="op" id="3612693">=</span>&nbsp;<span class="ident" id="3612695">bufio</span><span class="op" id="3612700">.</span><span class="ident" id="3612701">NewWriter</span><span class="op" id="3612710">(</span><span class="ident" id="3612711">pconn</span><span class="op" id="3612716">.</span><span class="ident" id="3612717">conn</span><span class="op" id="3612721">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612724">go</span>&nbsp;<span class="ident" id="3612727">pconn</span><span class="op" id="3612732">.</span><span class="ident" id="3612733">readLoop</span><span class="op" id="3612741">(</span><span class="op" id="3612742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612745">go</span>&nbsp;<span class="ident" id="3612748">pconn</span><span class="op" id="3612753">.</span><span class="ident" id="3612754">writeLoop</span><span class="op" id="3612763">(</span><span class="op" id="3612764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3612767">return</span>&nbsp;<span class="ident" id="3612774">pconn</span><span class="op" id="3612779">,</span>&nbsp;<span class="ident" id="3612781">nil</span><br>
<span class="lineno"></span><span class="op" id="3612785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3612788">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3612853">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3612916">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3612972">func</span>&nbsp;<span class="ident" id="3612977">useProxy</span><span class="op" id="3612985">(</span><span class="ident" id="3612986">addr</span>&nbsp;<span class="builtintype" id="3612991">string</span><span class="op" id="3612997">)</span>&nbsp;<span class="builtintype" id="3612999">bool</span>&nbsp;<span class="op" id="3613004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613007">if</span>&nbsp;<span class="builtinfunc" id="3613010">len</span><span class="op" id="3613013">(</span><span class="ident" id="3613014">addr</span><span class="op" id="3613018">)</span>&nbsp;<span class="op" id="3613020">==</span>&nbsp;<span class="num" id="3613023">0</span>&nbsp;<span class="op" id="3613025">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613029">return</span>&nbsp;<span class="builtintype" id="3613036">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613045">host</span><span class="op" id="3613049">,</span>&nbsp;<span class="ident" id="3613051">_</span><span class="op" id="3613052">,</span>&nbsp;<span class="ident" id="3613054">err</span>&nbsp;<span class="op" id="3613058">:=</span>&nbsp;<span class="ident" id="3613061">net</span><span class="op" id="3613064">.</span><span class="ident" id="3613065">SplitHostPort</span><span class="op" id="3613078">(</span><span class="ident" id="3613079">addr</span><span class="op" id="3613083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613086">if</span>&nbsp;<span class="ident" id="3613089">err</span>&nbsp;<span class="op" id="3613093">!=</span>&nbsp;<span class="ident" id="3613096">nil</span>&nbsp;<span class="op" id="3613100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613104">return</span>&nbsp;<span class="builtintype" id="3613111">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613121">if</span>&nbsp;<span class="ident" id="3613124">host</span>&nbsp;<span class="op" id="3613129">==</span>&nbsp;<span class="string" id="3613132">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3613144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613148">return</span>&nbsp;<span class="builtintype" id="3613155">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613165">if</span>&nbsp;<span class="ident" id="3613168">ip</span>&nbsp;<span class="op" id="3613171">:=</span>&nbsp;<span class="ident" id="3613174">net</span><span class="op" id="3613177">.</span><span class="ident" id="3613178">ParseIP</span><span class="op" id="3613185">(</span><span class="ident" id="3613186">host</span><span class="op" id="3613190">)</span><span class="op" id="3613191">;</span>&nbsp;<span class="ident" id="3613193">ip</span>&nbsp;<span class="op" id="3613196">!=</span>&nbsp;<span class="ident" id="3613199">nil</span>&nbsp;<span class="op" id="3613203">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613207">if</span>&nbsp;<span class="ident" id="3613210">ip</span><span class="op" id="3613212">.</span><span class="ident" id="3613213">IsLoopback</span><span class="op" id="3613223">(</span><span class="op" id="3613224">)</span>&nbsp;<span class="op" id="3613226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613231">return</span>&nbsp;<span class="builtintype" id="3613238">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613253">no_proxy</span>&nbsp;<span class="op" id="3613262">:=</span>&nbsp;<span class="ident" id="3613265">noProxyEnv</span><span class="op" id="3613275">.</span><span class="ident" id="3613276">Get</span><span class="op" id="3613279">(</span><span class="op" id="3613280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613283">if</span>&nbsp;<span class="ident" id="3613286">no_proxy</span>&nbsp;<span class="op" id="3613295">==</span>&nbsp;<span class="string" id="3613298">&#34;*&#34;</span>&nbsp;<span class="op" id="3613302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613306">return</span>&nbsp;<span class="builtintype" id="3613313">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613324">addr</span>&nbsp;<span class="op" id="3613329">=</span>&nbsp;<span class="ident" id="3613331">strings</span><span class="op" id="3613338">.</span><span class="ident" id="3613339">ToLower</span><span class="op" id="3613346">(</span><span class="ident" id="3613347">strings</span><span class="op" id="3613354">.</span><span class="ident" id="3613355">TrimSpace</span><span class="op" id="3613364">(</span><span class="ident" id="3613365">addr</span><span class="op" id="3613369">)</span><span class="op" id="3613370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613373">if</span>&nbsp;<span class="ident" id="3613376">hasPort</span><span class="op" id="3613383">(</span><span class="ident" id="3613384">addr</span><span class="op" id="3613388">)</span>&nbsp;<span class="op" id="3613390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613394">addr</span>&nbsp;<span class="op" id="3613399">=</span>&nbsp;<span class="ident" id="3613401">addr</span><span class="op" id="3613405">[</span><span class="op" id="3613406">:</span><span class="ident" id="3613407">strings</span><span class="op" id="3613414">.</span><span class="ident" id="3613415">LastIndex</span><span class="op" id="3613424">(</span><span class="ident" id="3613425">addr</span><span class="op" id="3613429">,</span>&nbsp;<span class="string" id="3613431">&#34;:&#34;</span><span class="op" id="3613434">)</span><span class="op" id="3613435">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613442">for</span>&nbsp;<span class="ident" id="3613446">_</span><span class="op" id="3613447">,</span>&nbsp;<span class="ident" id="3613449">p</span>&nbsp;<span class="op" id="3613451">:=</span>&nbsp;<span class="keyword" id="3613454">range</span>&nbsp;<span class="ident" id="3613460">strings</span><span class="op" id="3613467">.</span><span class="ident" id="3613468">Split</span><span class="op" id="3613473">(</span><span class="ident" id="3613474">no_proxy</span><span class="op" id="3613482">,</span>&nbsp;<span class="string" id="3613484">&#34;,&#34;</span><span class="op" id="3613487">)</span>&nbsp;<span class="op" id="3613489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613493">p</span>&nbsp;<span class="op" id="3613495">=</span>&nbsp;<span class="ident" id="3613497">strings</span><span class="op" id="3613504">.</span><span class="ident" id="3613505">ToLower</span><span class="op" id="3613512">(</span><span class="ident" id="3613513">strings</span><span class="op" id="3613520">.</span><span class="ident" id="3613521">TrimSpace</span><span class="op" id="3613530">(</span><span class="ident" id="3613531">p</span><span class="op" id="3613532">)</span><span class="op" id="3613533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613537">if</span>&nbsp;<span class="builtinfunc" id="3613540">len</span><span class="op" id="3613543">(</span><span class="ident" id="3613544">p</span><span class="op" id="3613545">)</span>&nbsp;<span class="op" id="3613547">==</span>&nbsp;<span class="num" id="3613550">0</span>&nbsp;<span class="op" id="3613552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613557">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613568">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613572">if</span>&nbsp;<span class="ident" id="3613575">hasPort</span><span class="op" id="3613582">(</span><span class="ident" id="3613583">p</span><span class="op" id="3613584">)</span>&nbsp;<span class="op" id="3613586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613591">p</span>&nbsp;<span class="op" id="3613593">=</span>&nbsp;<span class="ident" id="3613595">p</span><span class="op" id="3613596">[</span><span class="op" id="3613597">:</span><span class="ident" id="3613598">strings</span><span class="op" id="3613605">.</span><span class="ident" id="3613606">LastIndex</span><span class="op" id="3613615">(</span><span class="ident" id="3613616">p</span><span class="op" id="3613617">,</span>&nbsp;<span class="string" id="3613619">&#34;:&#34;</span><span class="op" id="3613622">)</span><span class="op" id="3613623">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613631">if</span>&nbsp;<span class="ident" id="3613634">addr</span>&nbsp;<span class="op" id="3613639">==</span>&nbsp;<span class="ident" id="3613642">p</span>&nbsp;<span class="op" id="3613644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613649">return</span>&nbsp;<span class="builtintype" id="3613656">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613668">if</span>&nbsp;<span class="ident" id="3613671">p</span><span class="op" id="3613672">[</span><span class="num" id="3613673">0</span><span class="op" id="3613674">]</span>&nbsp;<span class="op" id="3613676">==</span>&nbsp;<span class="string" id="3613679">&#39;.&#39;</span>&nbsp;<span class="op" id="3613683">&amp;&amp;</span>&nbsp;<span class="op" id="3613686">(</span><span class="ident" id="3613687">strings</span><span class="op" id="3613694">.</span><span class="ident" id="3613695">HasSuffix</span><span class="op" id="3613704">(</span><span class="ident" id="3613705">addr</span><span class="op" id="3613709">,</span>&nbsp;<span class="ident" id="3613711">p</span><span class="op" id="3613712">)</span>&nbsp;<span class="op" id="3613714">||</span>&nbsp;<span class="ident" id="3613717">addr</span>&nbsp;<span class="op" id="3613722">==</span>&nbsp;<span class="ident" id="3613725">p</span><span class="op" id="3613726">[</span><span class="num" id="3613727">1</span><span class="op" id="3613728">:</span><span class="op" id="3613729">]</span><span class="op" id="3613730">)</span>&nbsp;<span class="op" id="3613732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3613737">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613798">return</span>&nbsp;<span class="builtintype" id="3613805">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613813">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613817">if</span>&nbsp;<span class="ident" id="3613820">p</span><span class="op" id="3613821">[</span><span class="num" id="3613822">0</span><span class="op" id="3613823">]</span>&nbsp;<span class="op" id="3613825">!=</span>&nbsp;<span class="string" id="3613828">&#39;.&#39;</span>&nbsp;<span class="op" id="3613832">&amp;&amp;</span>&nbsp;<span class="ident" id="3613835">strings</span><span class="op" id="3613842">.</span><span class="ident" id="3613843">HasSuffix</span><span class="op" id="3613852">(</span><span class="ident" id="3613853">addr</span><span class="op" id="3613857">,</span>&nbsp;<span class="ident" id="3613859">p</span><span class="op" id="3613860">)</span>&nbsp;<span class="op" id="3613862">&amp;&amp;</span>&nbsp;<span class="ident" id="3613865">addr</span><span class="op" id="3613869">[</span><span class="builtinfunc" id="3613870">len</span><span class="op" id="3613873">(</span><span class="ident" id="3613874">addr</span><span class="op" id="3613878">)</span><span class="op" id="3613879">-</span><span class="builtinfunc" id="3613880">len</span><span class="op" id="3613883">(</span><span class="ident" id="3613884">p</span><span class="op" id="3613885">)</span><span class="op" id="3613886">-</span><span class="num" id="3613887">1</span><span class="op" id="3613888">]</span>&nbsp;<span class="op" id="3613890">==</span>&nbsp;<span class="string" id="3613893">&#39;.&#39;</span>&nbsp;<span class="op" id="3613897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3613902">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613949">return</span>&nbsp;<span class="builtintype" id="3613956">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613967">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613970">return</span>&nbsp;<span class="builtintype" id="3613977">true</span><br>
<span class="lineno"></span><span class="op" id="3613982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3613985">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3614061">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3614116">//</span><br>
<span class="lineno"></span><span class="comment" id="3614119">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3614170">//</span><br>
<span class="lineno"></span><span class="comment" id="3614173">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3614218">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3614277">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3614344">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3614412">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3614486">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3614564">//</span><br>
<span class="lineno">730</span><span class="comment" id="3614567">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3614614">//</span><br>
<span class="lineno"></span><span class="keyword" id="3614617">type</span>&nbsp;<span class="ident" id="3614622">connectMethod</span>&nbsp;<span class="keyword" id="3614636">struct</span>&nbsp;<span class="op" id="3614643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3614646">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3614659">*</span><span class="ident" id="3614660">url</span><span class="op" id="3614663">.</span><span class="ident" id="3614664">URL</span>&nbsp;<span class="comment" id="3614668">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3614710">targetScheme</span>&nbsp;<span class="builtintype" id="3614723">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3614732">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3614754">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3614767">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3614776">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3614840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3614843">func</span>&nbsp;<span class="op" id="3614848">(</span><span class="ident" id="3614849">cm</span>&nbsp;<span class="op" id="3614852">*</span><span class="ident" id="3614853">connectMethod</span><span class="op" id="3614866">)</span>&nbsp;<span class="ident" id="3614868">key</span><span class="op" id="3614871">(</span><span class="op" id="3614872">)</span>&nbsp;<span class="ident" id="3614874">connectMethodKey</span>&nbsp;<span class="op" id="3614891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3614894">proxyStr</span>&nbsp;<span class="op" id="3614903">:=</span>&nbsp;<span class="string" id="3614906">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3614910">targetAddr</span>&nbsp;<span class="op" id="3614921">:=</span>&nbsp;<span class="ident" id="3614924">cm</span><span class="op" id="3614926">.</span><span class="ident" id="3614927">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3614939">if</span>&nbsp;<span class="ident" id="3614942">cm</span><span class="op" id="3614944">.</span><span class="ident" id="3614945">proxyURL</span>&nbsp;<span class="op" id="3614954">!=</span>&nbsp;<span class="ident" id="3614957">nil</span>&nbsp;<span class="op" id="3614961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3614965">proxyStr</span>&nbsp;<span class="op" id="3614974">=</span>&nbsp;<span class="ident" id="3614976">cm</span><span class="op" id="3614978">.</span><span class="ident" id="3614979">proxyURL</span><span class="op" id="3614987">.</span><span class="ident" id="3614988">String</span><span class="op" id="3614994">(</span><span class="op" id="3614995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3614999">if</span>&nbsp;<span class="ident" id="3615002">cm</span><span class="op" id="3615004">.</span><span class="ident" id="3615005">targetScheme</span>&nbsp;<span class="op" id="3615018">==</span>&nbsp;<span class="string" id="3615021">&#34;http&#34;</span>&nbsp;<span class="op" id="3615028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615033">targetAddr</span>&nbsp;<span class="op" id="3615044">=</span>&nbsp;<span class="string" id="3615046">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3615051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3615054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615057">return</span>&nbsp;<span class="ident" id="3615064">connectMethodKey</span><span class="op" id="3615080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615084">proxy</span><span class="op" id="3615089">:</span>&nbsp;&nbsp;<span class="ident" id="3615092">proxyStr</span><span class="op" id="3615100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615104">scheme</span><span class="op" id="3615110">:</span>&nbsp;<span class="ident" id="3615112">cm</span><span class="op" id="3615114">.</span><span class="ident" id="3615115">targetScheme</span><span class="op" id="3615127">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615131">addr</span><span class="op" id="3615135">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3615139">targetAddr</span><span class="op" id="3615149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3615152">}</span><br>
<span class="lineno"></span><span class="op" id="3615154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3615157">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3615232">func</span>&nbsp;<span class="op" id="3615237">(</span><span class="ident" id="3615238">cm</span>&nbsp;<span class="op" id="3615241">*</span><span class="ident" id="3615242">connectMethod</span><span class="op" id="3615255">)</span>&nbsp;<span class="ident" id="3615257">addr</span><span class="op" id="3615261">(</span><span class="op" id="3615262">)</span>&nbsp;<span class="builtintype" id="3615264">string</span>&nbsp;<span class="op" id="3615271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615274">if</span>&nbsp;<span class="ident" id="3615277">cm</span><span class="op" id="3615279">.</span><span class="ident" id="3615280">proxyURL</span>&nbsp;<span class="op" id="3615289">!=</span>&nbsp;<span class="ident" id="3615292">nil</span>&nbsp;<span class="op" id="3615296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615300">return</span>&nbsp;<span class="ident" id="3615307">canonicalAddr</span><span class="op" id="3615320">(</span><span class="ident" id="3615321">cm</span><span class="op" id="3615323">.</span><span class="ident" id="3615324">proxyURL</span><span class="op" id="3615332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3615335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615338">return</span>&nbsp;<span class="ident" id="3615345">cm</span><span class="op" id="3615347">.</span><span class="ident" id="3615348">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3615359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3615362">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3615423">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3615443">func</span>&nbsp;<span class="op" id="3615448">(</span><span class="ident" id="3615449">cm</span>&nbsp;<span class="op" id="3615452">*</span><span class="ident" id="3615453">connectMethod</span><span class="op" id="3615466">)</span>&nbsp;<span class="ident" id="3615468">tlsHost</span><span class="op" id="3615475">(</span><span class="op" id="3615476">)</span>&nbsp;<span class="builtintype" id="3615478">string</span>&nbsp;<span class="op" id="3615485">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615488">h</span>&nbsp;<span class="op" id="3615490">:=</span>&nbsp;<span class="ident" id="3615493">cm</span><span class="op" id="3615495">.</span><span class="ident" id="3615496">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615508">if</span>&nbsp;<span class="ident" id="3615511">hasPort</span><span class="op" id="3615518">(</span><span class="ident" id="3615519">h</span><span class="op" id="3615520">)</span>&nbsp;<span class="op" id="3615522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615526">h</span>&nbsp;<span class="op" id="3615528">=</span>&nbsp;<span class="ident" id="3615530">h</span><span class="op" id="3615531">[</span><span class="op" id="3615532">:</span><span class="ident" id="3615533">strings</span><span class="op" id="3615540">.</span><span class="ident" id="3615541">LastIndex</span><span class="op" id="3615550">(</span><span class="ident" id="3615551">h</span><span class="op" id="3615552">,</span>&nbsp;<span class="string" id="3615554">&#34;:&#34;</span><span class="op" id="3615557">)</span><span class="op" id="3615558">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3615561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615564">return</span>&nbsp;<span class="ident" id="3615571">h</span><br>
<span class="lineno">770</span><span class="op" id="3615573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3615576">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3615644">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3615715">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3615725">type</span>&nbsp;<span class="ident" id="3615730">connectMethodKey</span>&nbsp;<span class="keyword" id="3615747">struct</span>&nbsp;<span class="op" id="3615754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3615757">proxy</span><span class="op" id="3615762">,</span>&nbsp;<span class="ident" id="3615764">scheme</span><span class="op" id="3615770">,</span>&nbsp;<span class="ident" id="3615772">addr</span>&nbsp;<span class="builtintype" id="3615777">string</span><br>
<span class="lineno"></span><span class="op" id="3615784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3615787">func</span>&nbsp;<span class="op" id="3615792">(</span><span class="ident" id="3615793">k</span>&nbsp;<span class="ident" id="3615795">connectMethodKey</span><span class="op" id="3615811">)</span>&nbsp;<span class="ident" id="3615813">String</span><span class="op" id="3615819">(</span><span class="op" id="3615820">)</span>&nbsp;<span class="builtintype" id="3615822">string</span>&nbsp;<span class="op" id="3615829">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3615832">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3615856">return</span>&nbsp;<span class="ident" id="3615863">fmt</span><span class="op" id="3615866">.</span><span class="ident" id="3615867">Sprintf</span><span class="op" id="3615874">(</span><span class="string" id="3615875">&#34;%s|%s|%s&#34;</span><span class="op" id="3615885">,</span>&nbsp;<span class="ident" id="3615887">k</span><span class="op" id="3615888">.</span><span class="ident" id="3615889">proxy</span><span class="op" id="3615894">,</span>&nbsp;<span class="ident" id="3615896">k</span><span class="op" id="3615897">.</span><span class="ident" id="3615898">scheme</span><span class="op" id="3615904">,</span>&nbsp;<span class="ident" id="3615906">k</span><span class="op" id="3615907">.</span><span class="ident" id="3615908">addr</span><span class="op" id="3615912">)</span><br>
<span class="lineno"></span><span class="op" id="3615914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3615917">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3615977">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3616034">type</span>&nbsp;<span class="ident" id="3616039">persistConn</span>&nbsp;<span class="keyword" id="3616051">struct</span>&nbsp;<span class="op" id="3616058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616061">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3616070">*</span><span class="ident" id="3616071">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616082">cacheKey</span>&nbsp;<span class="ident" id="3616091">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616109">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616118">net</span><span class="op" id="3616121">.</span><span class="ident" id="3616122">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616128">tlsState</span>&nbsp;<span class="op" id="3616137">*</span><span class="ident" id="3616138">tls</span><span class="op" id="3616141">.</span><span class="ident" id="3616142">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616159">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3616168">*</span><span class="ident" id="3616169">bufio</span><span class="op" id="3616174">.</span><span class="ident" id="3616175">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616188">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616202">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3616211">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616231">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616287">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3616296">*</span><span class="ident" id="3616297">bufio</span><span class="op" id="3616302">.</span><span class="ident" id="3616303">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616316">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616328">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3616337">chan</span>&nbsp;<span class="ident" id="3616342">requestAndChan</span>&nbsp;<span class="comment" id="3616357">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616400">writech</span>&nbsp;&nbsp;<span class="keyword" id="3616409">chan</span>&nbsp;<span class="ident" id="3616414">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3616429">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616473">closech</span>&nbsp;&nbsp;<span class="keyword" id="3616482">chan</span>&nbsp;<span class="keyword" id="3616487">struct</span><span class="op" id="3616493">{</span><span class="op" id="3616494">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616502">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616530">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3616539">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616545">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616605">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616667">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3616731">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616790">writeErrCh</span>&nbsp;<span class="keyword" id="3616801">chan</span>&nbsp;<span class="builtintype" id="3616806">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616814">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616835">sync</span><span class="op" id="3616839">.</span><span class="ident" id="3616840">Mutex</span>&nbsp;<span class="comment" id="3616846">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616874">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3616895">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616900">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3616921">bool</span>&nbsp;<span class="comment" id="3616926">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616959">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3616980">bool</span>&nbsp;<span class="comment" id="3616985">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3617065">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3617122">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3617185">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617242">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3617259">func</span><span class="op" id="3617263">(</span><span class="ident" id="3617264">Header</span><span class="op" id="3617270">)</span><br>
<span class="lineno"></span><span class="op" id="3617272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3617275">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3617347">func</span>&nbsp;<span class="op" id="3617352">(</span><span class="ident" id="3617353">pc</span>&nbsp;<span class="op" id="3617356">*</span><span class="ident" id="3617357">persistConn</span><span class="op" id="3617368">)</span>&nbsp;<span class="ident" id="3617370">isBroken</span><span class="op" id="3617378">(</span><span class="op" id="3617379">)</span>&nbsp;<span class="builtintype" id="3617381">bool</span>&nbsp;<span class="op" id="3617386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617389">pc</span><span class="op" id="3617391">.</span><span class="ident" id="3617392">lk</span><span class="op" id="3617394">.</span><span class="ident" id="3617395">Lock</span><span class="op" id="3617399">(</span><span class="op" id="3617400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617403">b</span>&nbsp;<span class="op" id="3617405">:=</span>&nbsp;<span class="ident" id="3617408">pc</span><span class="op" id="3617410">.</span><span class="ident" id="3617411">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617419">pc</span><span class="op" id="3617421">.</span><span class="ident" id="3617422">lk</span><span class="op" id="3617424">.</span><span class="ident" id="3617425">Unlock</span><span class="op" id="3617431">(</span><span class="op" id="3617432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617435">return</span>&nbsp;<span class="ident" id="3617442">b</span><br>
<span class="lineno">820</span><span class="op" id="3617444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617447">func</span>&nbsp;<span class="op" id="3617452">(</span><span class="ident" id="3617453">pc</span>&nbsp;<span class="op" id="3617456">*</span><span class="ident" id="3617457">persistConn</span><span class="op" id="3617468">)</span>&nbsp;<span class="ident" id="3617470">cancelRequest</span><span class="op" id="3617483">(</span><span class="op" id="3617484">)</span>&nbsp;<span class="op" id="3617486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617489">pc</span><span class="op" id="3617491">.</span><span class="ident" id="3617492">conn</span><span class="op" id="3617496">.</span><span class="ident" id="3617497">Close</span><span class="op" id="3617502">(</span><span class="op" id="3617503">)</span><br>
<span class="lineno"></span><span class="op" id="3617505">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3617508">var</span>&nbsp;<span class="ident" id="3617512">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3617533">func</span><span class="op" id="3617537">(</span><span class="builtintype" id="3617538">error</span><span class="op" id="3617543">)</span>&nbsp;<span class="builtintype" id="3617545">bool</span>&nbsp;<span class="comment" id="3617550">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617576">func</span>&nbsp;<span class="ident" id="3617581">remoteSideClosed</span><span class="op" id="3617597">(</span><span class="ident" id="3617598">err</span>&nbsp;<span class="builtintype" id="3617602">error</span><span class="op" id="3617607">)</span>&nbsp;<span class="builtintype" id="3617609">bool</span>&nbsp;<span class="op" id="3617614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617617">if</span>&nbsp;<span class="ident" id="3617620">err</span>&nbsp;<span class="op" id="3617624">==</span>&nbsp;<span class="ident" id="3617627">io</span><span class="op" id="3617629">.</span><span class="ident" id="3617630">EOF</span>&nbsp;<span class="op" id="3617634">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617638">return</span>&nbsp;<span class="builtintype" id="3617645">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3617651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617654">if</span>&nbsp;<span class="ident" id="3617657">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3617678">!=</span>&nbsp;<span class="ident" id="3617681">nil</span>&nbsp;<span class="op" id="3617685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617689">return</span>&nbsp;<span class="ident" id="3617696">remoteSideClosedFunc</span><span class="op" id="3617716">(</span><span class="ident" id="3617717">err</span><span class="op" id="3617720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3617723">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617726">return</span>&nbsp;<span class="builtintype" id="3617733">false</span><br>
<span class="lineno"></span><span class="op" id="3617739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617742">func</span>&nbsp;<span class="op" id="3617747">(</span><span class="ident" id="3617748">pc</span>&nbsp;<span class="op" id="3617751">*</span><span class="ident" id="3617752">persistConn</span><span class="op" id="3617763">)</span>&nbsp;<span class="ident" id="3617765">readLoop</span><span class="op" id="3617773">(</span><span class="op" id="3617774">)</span>&nbsp;<span class="op" id="3617776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617779">alive</span>&nbsp;<span class="op" id="3617785">:=</span>&nbsp;<span class="builtintype" id="3617788">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617795">for</span>&nbsp;<span class="ident" id="3617799">alive</span>&nbsp;<span class="op" id="3617805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617809">pb</span><span class="op" id="3617811">,</span>&nbsp;<span class="ident" id="3617813">err</span>&nbsp;<span class="op" id="3617817">:=</span>&nbsp;<span class="ident" id="3617820">pc</span><span class="op" id="3617822">.</span><span class="ident" id="3617823">br</span><span class="op" id="3617825">.</span><span class="ident" id="3617826">Peek</span><span class="op" id="3617830">(</span><span class="num" id="3617831">1</span><span class="op" id="3617832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617837">pc</span><span class="op" id="3617839">.</span><span class="ident" id="3617840">lk</span><span class="op" id="3617842">.</span><span class="ident" id="3617843">Lock</span><span class="op" id="3617847">(</span><span class="op" id="3617848">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617852">if</span>&nbsp;<span class="ident" id="3617855">pc</span><span class="op" id="3617857">.</span><span class="ident" id="3617858">numExpectedResponses</span>&nbsp;<span class="op" id="3617879">==</span>&nbsp;<span class="num" id="3617882">0</span>&nbsp;<span class="op" id="3617884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617889">if</span>&nbsp;<span class="op" id="3617892">!</span><span class="ident" id="3617893">pc</span><span class="op" id="3617895">.</span><span class="ident" id="3617896">closed</span>&nbsp;<span class="op" id="3617903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617909">pc</span><span class="op" id="3617911">.</span><span class="ident" id="3617912">closeLocked</span><span class="op" id="3617923">(</span><span class="op" id="3617924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3617930">if</span>&nbsp;<span class="builtinfunc" id="3617933">len</span><span class="op" id="3617936">(</span><span class="ident" id="3617937">pb</span><span class="op" id="3617939">)</span>&nbsp;<span class="op" id="3617941">&gt;</span>&nbsp;<span class="num" id="3617943">0</span>&nbsp;<span class="op" id="3617945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617952">log</span><span class="op" id="3617955">.</span><span class="ident" id="3617956">Printf</span><span class="op" id="3617962">(</span><span class="string" id="3617963">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3618040">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3618048">string</span><span class="op" id="3618054">(</span><span class="ident" id="3618055">pb</span><span class="op" id="3618057">)</span><span class="op" id="3618058">,</span>&nbsp;<span class="ident" id="3618060">err</span><span class="op" id="3618063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618079">pc</span><span class="op" id="3618081">.</span><span class="ident" id="3618082">lk</span><span class="op" id="3618084">.</span><span class="ident" id="3618085">Unlock</span><span class="op" id="3618091">(</span><span class="op" id="3618092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618097">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618110">pc</span><span class="op" id="3618112">.</span><span class="ident" id="3618113">lk</span><span class="op" id="3618115">.</span><span class="ident" id="3618116">Unlock</span><span class="op" id="3618122">(</span><span class="op" id="3618123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618128">rc</span>&nbsp;<span class="op" id="3618131">:=</span>&nbsp;<span class="op" id="3618134">&lt;-</span><span class="ident" id="3618136">pc</span><span class="op" id="3618138">.</span><span class="ident" id="3618139">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618148">var</span>&nbsp;<span class="ident" id="3618152">resp</span>&nbsp;<span class="op" id="3618157">*</span><span class="ident" id="3618158">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618169">if</span>&nbsp;<span class="ident" id="3618172">err</span>&nbsp;<span class="op" id="3618176">==</span>&nbsp;<span class="ident" id="3618179">nil</span>&nbsp;<span class="op" id="3618183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618188">resp</span><span class="op" id="3618192">,</span>&nbsp;<span class="ident" id="3618194">err</span>&nbsp;<span class="op" id="3618198">=</span>&nbsp;<span class="ident" id="3618200">ReadResponse</span><span class="op" id="3618212">(</span><span class="ident" id="3618213">pc</span><span class="op" id="3618215">.</span><span class="ident" id="3618216">br</span><span class="op" id="3618218">,</span>&nbsp;<span class="ident" id="3618220">rc</span><span class="op" id="3618222">.</span><span class="ident" id="3618223">req</span><span class="op" id="3618226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618231">if</span>&nbsp;<span class="ident" id="3618234">err</span>&nbsp;<span class="op" id="3618238">==</span>&nbsp;<span class="ident" id="3618241">nil</span>&nbsp;<span class="op" id="3618245">&amp;&amp;</span>&nbsp;<span class="ident" id="3618248">resp</span><span class="op" id="3618252">.</span><span class="ident" id="3618253">StatusCode</span>&nbsp;<span class="op" id="3618264">==</span>&nbsp;<span class="num" id="3618267">100</span>&nbsp;<span class="op" id="3618271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3618277">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3618315">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3618376">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3618436">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3618502">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618550">resp</span><span class="op" id="3618554">,</span>&nbsp;<span class="ident" id="3618556">err</span>&nbsp;<span class="op" id="3618560">=</span>&nbsp;<span class="ident" id="3618562">ReadResponse</span><span class="op" id="3618574">(</span><span class="ident" id="3618575">pc</span><span class="op" id="3618577">.</span><span class="ident" id="3618578">br</span><span class="op" id="3618580">,</span>&nbsp;<span class="ident" id="3618582">rc</span><span class="op" id="3618584">.</span><span class="ident" id="3618585">req</span><span class="op" id="3618588">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618602">if</span>&nbsp;<span class="ident" id="3618605">resp</span>&nbsp;<span class="op" id="3618610">!=</span>&nbsp;<span class="ident" id="3618613">nil</span>&nbsp;<span class="op" id="3618617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618622">resp</span><span class="op" id="3618626">.</span><span class="ident" id="3618627">TLS</span>&nbsp;<span class="op" id="3618631">=</span>&nbsp;<span class="ident" id="3618633">pc</span><span class="op" id="3618635">.</span><span class="ident" id="3618636">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618652">hasBody</span>&nbsp;<span class="op" id="3618660">:=</span>&nbsp;<span class="ident" id="3618663">resp</span>&nbsp;<span class="op" id="3618668">!=</span>&nbsp;<span class="ident" id="3618671">nil</span>&nbsp;<span class="op" id="3618675">&amp;&amp;</span>&nbsp;<span class="ident" id="3618678">rc</span><span class="op" id="3618680">.</span><span class="ident" id="3618681">req</span><span class="op" id="3618684">.</span><span class="ident" id="3618685">Method</span>&nbsp;<span class="op" id="3618692">!=</span>&nbsp;<span class="string" id="3618695">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3618702">&amp;&amp;</span>&nbsp;<span class="ident" id="3618705">resp</span><span class="op" id="3618709">.</span><span class="ident" id="3618710">ContentLength</span>&nbsp;<span class="op" id="3618724">!=</span>&nbsp;<span class="num" id="3618727">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618732">if</span>&nbsp;<span class="ident" id="3618735">err</span>&nbsp;<span class="op" id="3618739">!=</span>&nbsp;<span class="ident" id="3618742">nil</span>&nbsp;<span class="op" id="3618746">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618751">pc</span><span class="op" id="3618753">.</span><span class="builtinfunc" id="3618754">close</span><span class="op" id="3618759">(</span><span class="op" id="3618760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3618764">}</span>&nbsp;<span class="keyword" id="3618766">else</span>&nbsp;<span class="op" id="3618771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3618776">if</span>&nbsp;<span class="ident" id="3618779">rc</span><span class="op" id="3618781">.</span><span class="ident" id="3618782">addedGzip</span>&nbsp;<span class="op" id="3618792">&amp;&amp;</span>&nbsp;<span class="ident" id="3618795">hasBody</span>&nbsp;<span class="op" id="3618803">&amp;&amp;</span>&nbsp;<span class="ident" id="3618806">resp</span><span class="op" id="3618810">.</span><span class="ident" id="3618811">Header</span><span class="op" id="3618817">.</span><span class="ident" id="3618818">Get</span><span class="op" id="3618821">(</span><span class="string" id="3618822">&#34;Content-Encoding&#34;</span><span class="op" id="3618840">)</span>&nbsp;<span class="op" id="3618842">==</span>&nbsp;<span class="string" id="3618845">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3618852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618858">resp</span><span class="op" id="3618862">.</span><span class="ident" id="3618863">Header</span><span class="op" id="3618869">.</span><span class="ident" id="3618870">Del</span><span class="op" id="3618873">(</span><span class="string" id="3618874">&#34;Content-Encoding&#34;</span><span class="op" id="3618892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618898">resp</span><span class="op" id="3618902">.</span><span class="ident" id="3618903">Header</span><span class="op" id="3618909">.</span><span class="ident" id="3618910">Del</span><span class="op" id="3618913">(</span><span class="string" id="3618914">&#34;Content-Length&#34;</span><span class="op" id="3618930">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618936">resp</span><span class="op" id="3618940">.</span><span class="ident" id="3618941">ContentLength</span>&nbsp;<span class="op" id="3618955">=</span>&nbsp;<span class="op" id="3618957">-</span><span class="num" id="3618958">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618964">resp</span><span class="op" id="3618968">.</span><span class="ident" id="3618969">Body</span>&nbsp;<span class="op" id="3618974">=</span>&nbsp;<span class="op" id="3618976">&amp;</span><span class="ident" id="3618977">gzipReader</span><span class="op" id="3618987">{</span><span class="ident" id="3618988">body</span><span class="op" id="3618992">:</span>&nbsp;<span class="ident" id="3618994">resp</span><span class="op" id="3618998">.</span><span class="ident" id="3618999">Body</span><span class="op" id="3619003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619013">resp</span><span class="op" id="3619017">.</span><span class="ident" id="3619018">Body</span>&nbsp;<span class="op" id="3619023">=</span>&nbsp;<span class="op" id="3619025">&amp;</span><span class="ident" id="3619026">bodyEOFSignal</span><span class="op" id="3619039">{</span><span class="ident" id="3619040">body</span><span class="op" id="3619044">:</span>&nbsp;<span class="ident" id="3619046">resp</span><span class="op" id="3619050">.</span><span class="ident" id="3619051">Body</span><span class="op" id="3619055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619059">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3619064">if</span>&nbsp;<span class="ident" id="3619067">err</span>&nbsp;<span class="op" id="3619071">!=</span>&nbsp;<span class="ident" id="3619074">nil</span>&nbsp;<span class="op" id="3619078">||</span>&nbsp;<span class="ident" id="3619081">resp</span><span class="op" id="3619085">.</span><span class="ident" id="3619086">Close</span>&nbsp;<span class="op" id="3619092">||</span>&nbsp;<span class="ident" id="3619095">rc</span><span class="op" id="3619097">.</span><span class="ident" id="3619098">req</span><span class="op" id="3619101">.</span><span class="ident" id="3619102">Close</span>&nbsp;<span class="op" id="3619108">||</span>&nbsp;<span class="ident" id="3619111">resp</span><span class="op" id="3619115">.</span><span class="ident" id="3619116">StatusCode</span>&nbsp;<span class="op" id="3619127">&lt;=</span>&nbsp;<span class="num" id="3619130">199</span>&nbsp;<span class="op" id="3619134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619139">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619208">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619268">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619315">alive</span>&nbsp;<span class="op" id="3619321">=</span>&nbsp;<span class="builtintype" id="3619323">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3619336">var</span>&nbsp;<span class="ident" id="3619340">waitForBodyRead</span>&nbsp;<span class="keyword" id="3619356">chan</span>&nbsp;<span class="builtintype" id="3619361">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3619368">if</span>&nbsp;<span class="ident" id="3619371">hasBody</span>&nbsp;<span class="op" id="3619379">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619384">waitForBodyRead</span>&nbsp;<span class="op" id="3619400">=</span>&nbsp;<span class="builtinfunc" id="3619402">make</span><span class="op" id="3619406">(</span><span class="keyword" id="3619407">chan</span>&nbsp;<span class="builtintype" id="3619412">bool</span><span class="op" id="3619416">,</span>&nbsp;<span class="num" id="3619418">2</span><span class="op" id="3619419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619424">resp</span><span class="op" id="3619428">.</span><span class="ident" id="3619429">Body</span><span class="op" id="3619433">.</span><span class="op" id="3619434">(</span><span class="op" id="3619435">*</span><span class="ident" id="3619436">bodyEOFSignal</span><span class="op" id="3619449">)</span><span class="op" id="3619450">.</span><span class="ident" id="3619451">earlyCloseFn</span>&nbsp;<span class="op" id="3619464">=</span>&nbsp;<span class="keyword" id="3619466">func</span><span class="op" id="3619470">(</span><span class="op" id="3619471">)</span>&nbsp;<span class="builtintype" id="3619473">error</span>&nbsp;<span class="op" id="3619479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619485">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619525">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619564">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619578">waitForBodyRead</span>&nbsp;<span class="op" id="3619594">&lt;-</span>&nbsp;<span class="builtintype" id="3619597">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3619607">return</span>&nbsp;<span class="ident" id="3619614">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619626">resp</span><span class="op" id="3619630">.</span><span class="ident" id="3619631">Body</span><span class="op" id="3619635">.</span><span class="op" id="3619636">(</span><span class="op" id="3619637">*</span><span class="ident" id="3619638">bodyEOFSignal</span><span class="op" id="3619651">)</span><span class="op" id="3619652">.</span><span class="ident" id="3619653">fn</span>&nbsp;<span class="op" id="3619656">=</span>&nbsp;<span class="keyword" id="3619658">func</span><span class="op" id="3619662">(</span><span class="ident" id="3619663">err</span>&nbsp;<span class="builtintype" id="3619667">error</span><span class="op" id="3619672">)</span>&nbsp;<span class="op" id="3619674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619680">waitForBodyRead</span>&nbsp;<span class="op" id="3619696">&lt;-</span>&nbsp;<span class="ident" id="3619699">alive</span>&nbsp;<span class="op" id="3619705">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619713">err</span>&nbsp;<span class="op" id="3619717">==</span>&nbsp;<span class="ident" id="3619720">nil</span>&nbsp;<span class="op" id="3619724">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619732">!</span><span class="ident" id="3619733">pc</span><span class="op" id="3619735">.</span><span class="ident" id="3619736">sawEOF</span>&nbsp;<span class="op" id="3619743">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619751">pc</span><span class="op" id="3619753">.</span><span class="ident" id="3619754">wroteRequest</span><span class="op" id="3619766">(</span><span class="op" id="3619767">)</span>&nbsp;<span class="op" id="3619769">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619777">pc</span><span class="op" id="3619779">.</span><span class="ident" id="3619780">t</span><span class="op" id="3619781">.</span><span class="ident" id="3619782">putIdleConn</span><span class="op" id="3619793">(</span><span class="ident" id="3619794">pc</span><span class="op" id="3619796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619801">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3619810">if</span>&nbsp;<span class="ident" id="3619813">alive</span>&nbsp;<span class="op" id="3619819">&amp;&amp;</span>&nbsp;<span class="op" id="3619822">!</span><span class="ident" id="3619823">hasBody</span>&nbsp;<span class="op" id="3619831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619836">alive</span>&nbsp;<span class="op" id="3619842">=</span>&nbsp;<span class="op" id="3619844">!</span><span class="ident" id="3619845">pc</span><span class="op" id="3619847">.</span><span class="ident" id="3619848">sawEOF</span>&nbsp;<span class="op" id="3619855">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619862">pc</span><span class="op" id="3619864">.</span><span class="ident" id="3619865">wroteRequest</span><span class="op" id="3619877">(</span><span class="op" id="3619878">)</span>&nbsp;<span class="op" id="3619880">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619887">pc</span><span class="op" id="3619889">.</span><span class="ident" id="3619890">t</span><span class="op" id="3619891">.</span><span class="ident" id="3619892">putIdleConn</span><span class="op" id="3619903">(</span><span class="ident" id="3619904">pc</span><span class="op" id="3619906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619915">rc</span><span class="op" id="3619917">.</span><span class="ident" id="3619918">ch</span>&nbsp;<span class="op" id="3619921">&lt;-</span>&nbsp;<span class="ident" id="3619924">responseAndError</span><span class="op" id="3619940">{</span><span class="ident" id="3619941">resp</span><span class="op" id="3619945">,</span>&nbsp;<span class="ident" id="3619947">err</span><span class="op" id="3619950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619955">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3620022">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620083">if</span>&nbsp;<span class="ident" id="3620086">waitForBodyRead</span>&nbsp;<span class="op" id="3620102">!=</span>&nbsp;<span class="ident" id="3620105">nil</span>&nbsp;<span class="op" id="3620109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620114">select</span>&nbsp;<span class="op" id="3620121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620126">case</span>&nbsp;<span class="ident" id="3620131">alive</span>&nbsp;<span class="op" id="3620137">=</span>&nbsp;<span class="op" id="3620139">&lt;-</span><span class="ident" id="3620141">waitForBodyRead</span><span class="op" id="3620156">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620161">case</span>&nbsp;<span class="op" id="3620166">&lt;-</span><span class="ident" id="3620168">pc</span><span class="op" id="3620170">.</span><span class="ident" id="3620171">closech</span><span class="op" id="3620178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620184">alive</span>&nbsp;<span class="op" id="3620190">=</span>&nbsp;<span class="builtintype" id="3620192">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620210">pc</span><span class="op" id="3620212">.</span><span class="ident" id="3620213">t</span><span class="op" id="3620214">.</span><span class="ident" id="3620215">setReqCanceler</span><span class="op" id="3620229">(</span><span class="ident" id="3620230">rc</span><span class="op" id="3620232">.</span><span class="ident" id="3620233">req</span><span class="op" id="3620236">,</span>&nbsp;<span class="ident" id="3620238">nil</span><span class="op" id="3620241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620246">if</span>&nbsp;<span class="op" id="3620249">!</span><span class="ident" id="3620250">alive</span>&nbsp;<span class="op" id="3620256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620261">pc</span><span class="op" id="3620263">.</span><span class="builtinfunc" id="3620264">close</span><span class="op" id="3620269">(</span><span class="op" id="3620270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620274">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620277">}</span><br>
<span class="lineno"></span><span class="op" id="3620279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3620282">func</span>&nbsp;<span class="op" id="3620287">(</span><span class="ident" id="3620288">pc</span>&nbsp;<span class="op" id="3620291">*</span><span class="ident" id="3620292">persistConn</span><span class="op" id="3620303">)</span>&nbsp;<span class="ident" id="3620305">writeLoop</span><span class="op" id="3620314">(</span><span class="op" id="3620315">)</span>&nbsp;<span class="op" id="3620317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620320">for</span>&nbsp;<span class="op" id="3620324">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620328">select</span>&nbsp;<span class="op" id="3620335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620339">case</span>&nbsp;<span class="ident" id="3620344">wr</span>&nbsp;<span class="op" id="3620347">:=</span>&nbsp;<span class="op" id="3620350">&lt;-</span><span class="ident" id="3620352">pc</span><span class="op" id="3620354">.</span><span class="ident" id="3620355">writech</span><span class="op" id="3620362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620367">if</span>&nbsp;<span class="ident" id="3620370">pc</span><span class="op" id="3620372">.</span><span class="ident" id="3620373">isBroken</span><span class="op" id="3620381">(</span><span class="op" id="3620382">)</span>&nbsp;<span class="op" id="3620384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620390">wr</span><span class="op" id="3620392">.</span><span class="ident" id="3620393">ch</span>&nbsp;<span class="op" id="3620396">&lt;-</span>&nbsp;<span class="ident" id="3620399">errors</span><span class="op" id="3620405">.</span><span class="ident" id="3620406">New</span><span class="op" id="3620409">(</span><span class="string" id="3620410">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3620463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620469">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620486">err</span>&nbsp;<span class="op" id="3620490">:=</span>&nbsp;<span class="ident" id="3620493">wr</span><span class="op" id="3620495">.</span><span class="ident" id="3620496">req</span><span class="op" id="3620499">.</span><span class="ident" id="3620500">Request</span><span class="op" id="3620507">.</span><span class="ident" id="3620508">write</span><span class="op" id="3620513">(</span><span class="ident" id="3620514">pc</span><span class="op" id="3620516">.</span><span class="ident" id="3620517">bw</span><span class="op" id="3620519">,</span>&nbsp;<span class="ident" id="3620521">pc</span><span class="op" id="3620523">.</span><span class="ident" id="3620524">isProxy</span><span class="op" id="3620531">,</span>&nbsp;<span class="ident" id="3620533">wr</span><span class="op" id="3620535">.</span><span class="ident" id="3620536">req</span><span class="op" id="3620539">.</span><span class="ident" id="3620540">extra</span><span class="op" id="3620545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620550">if</span>&nbsp;<span class="ident" id="3620553">err</span>&nbsp;<span class="op" id="3620557">==</span>&nbsp;<span class="ident" id="3620560">nil</span>&nbsp;<span class="op" id="3620564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620570">err</span>&nbsp;<span class="op" id="3620574">=</span>&nbsp;<span class="ident" id="3620576">pc</span><span class="op" id="3620578">.</span><span class="ident" id="3620579">bw</span><span class="op" id="3620581">.</span><span class="ident" id="3620582">Flush</span><span class="op" id="3620587">(</span><span class="op" id="3620588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620593">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620598">if</span>&nbsp;<span class="ident" id="3620601">err</span>&nbsp;<span class="op" id="3620605">!=</span>&nbsp;<span class="ident" id="3620608">nil</span>&nbsp;<span class="op" id="3620612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620618">pc</span><span class="op" id="3620620">.</span><span class="ident" id="3620621">markBroken</span><span class="op" id="3620631">(</span><span class="op" id="3620632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620638">wr</span><span class="op" id="3620640">.</span><span class="ident" id="3620641">req</span><span class="op" id="3620644">.</span><span class="ident" id="3620645">Request</span><span class="op" id="3620652">.</span><span class="ident" id="3620653">closeBody</span><span class="op" id="3620662">(</span><span class="op" id="3620663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620673">pc</span><span class="op" id="3620675">.</span><span class="ident" id="3620676">writeErrCh</span>&nbsp;<span class="op" id="3620687">&lt;-</span>&nbsp;<span class="ident" id="3620690">err</span>&nbsp;<span class="comment" id="3620694">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3620743">wr</span><span class="op" id="3620745">.</span><span class="ident" id="3620746">ch</span>&nbsp;<span class="op" id="3620749">&lt;-</span>&nbsp;<span class="ident" id="3620752">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3620764">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620795">case</span>&nbsp;<span class="op" id="3620800">&lt;-</span><span class="ident" id="3620802">pc</span><span class="op" id="3620804">.</span><span class="ident" id="3620805">closech</span><span class="op" id="3620812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3620817">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3620829">}</span><br>
<span class="lineno">965</span><span class="op" id="3620831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3620834">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3620915">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3620970">func</span>&nbsp;<span class="op" id="3620975">(</span><span class="ident" id="3620976">pc</span>&nbsp;<span class="op" id="3620979">*</span><span class="ident" id="3620980">persistConn</span><span class="op" id="3620991">)</span>&nbsp;<span class="ident" id="3620993">wroteRequest</span><span class="op" id="3621005">(</span><span class="op" id="3621006">)</span>&nbsp;<span class="builtintype" id="3621008">bool</span>&nbsp;<span class="op" id="3621013">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621016">select</span>&nbsp;<span class="op" id="3621023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621026">case</span>&nbsp;<span class="ident" id="3621031">err</span>&nbsp;<span class="op" id="3621035">:=</span>&nbsp;<span class="op" id="3621038">&lt;-</span><span class="ident" id="3621040">pc</span><span class="op" id="3621042">.</span><span class="ident" id="3621043">writeErrCh</span><span class="op" id="3621053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621057">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621123">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621152">return</span>&nbsp;<span class="ident" id="3621159">err</span>&nbsp;<span class="op" id="3621163">==</span>&nbsp;<span class="ident" id="3621166">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621171">default</span><span class="op" id="3621178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621182">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621245">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621308">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621375">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621430">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621435">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621499">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621564">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621628">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621692">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621723">select</span>&nbsp;<span class="op" id="3621730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621734">case</span>&nbsp;<span class="ident" id="3621739">err</span>&nbsp;<span class="op" id="3621743">:=</span>&nbsp;<span class="op" id="3621746">&lt;-</span><span class="ident" id="3621748">pc</span><span class="op" id="3621750">.</span><span class="ident" id="3621751">writeErrCh</span><span class="op" id="3621761">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621766">return</span>&nbsp;<span class="ident" id="3621773">err</span>&nbsp;<span class="op" id="3621777">==</span>&nbsp;<span class="ident" id="3621780">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621786">case</span>&nbsp;<span class="op" id="3621791">&lt;-</span><span class="ident" id="3621793">time</span><span class="op" id="3621797">.</span><span class="ident" id="3621798">After</span><span class="op" id="3621803">(</span><span class="num" id="3621804">50</span>&nbsp;<span class="op" id="3621807">*</span>&nbsp;<span class="ident" id="3621809">time</span><span class="op" id="3621813">.</span><span class="ident" id="3621814">Millisecond</span><span class="op" id="3621825">)</span><span class="op" id="3621826">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3621831">return</span>&nbsp;<span class="builtintype" id="3621838">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3621846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3621849">}</span><br>
<span class="lineno"></span><span class="op" id="3621851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3621854">type</span>&nbsp;<span class="ident" id="3621859">responseAndError</span>&nbsp;<span class="keyword" id="3621876">struct</span>&nbsp;<span class="op" id="3621883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3621886">res</span>&nbsp;<span class="op" id="3621890">*</span><span class="ident" id="3621891">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3621901">err</span>&nbsp;<span class="builtintype" id="3621905">error</span><br>
<span class="lineno"></span><span class="op" id="3621911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3621914">type</span>&nbsp;<span class="ident" id="3621919">requestAndChan</span>&nbsp;<span class="keyword" id="3621934">struct</span>&nbsp;<span class="op" id="3621941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3621944">req</span>&nbsp;<span class="op" id="3621948">*</span><span class="ident" id="3621949">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3621958">ch</span>&nbsp;&nbsp;<span class="keyword" id="3621962">chan</span>&nbsp;<span class="ident" id="3621967">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3621986">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3622047">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3622104">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622142">addedGzip</span>&nbsp;<span class="builtintype" id="3622152">bool</span><br>
<span class="lineno"></span><span class="op" id="3622157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3622160">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3622221">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3622285">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3622351">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3622361">type</span>&nbsp;<span class="ident" id="3622366">writeRequest</span>&nbsp;<span class="keyword" id="3622379">struct</span>&nbsp;<span class="op" id="3622386">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622389">req</span>&nbsp;<span class="op" id="3622393">*</span><span class="ident" id="3622394">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622412">ch</span>&nbsp;&nbsp;<span class="keyword" id="3622416">chan</span><span class="op" id="3622420">&lt;-</span>&nbsp;<span class="builtintype" id="3622423">error</span><br>
<span class="lineno"></span><span class="op" id="3622429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622432">type</span>&nbsp;<span class="ident" id="3622437">httpError</span>&nbsp;<span class="keyword" id="3622447">struct</span>&nbsp;<span class="op" id="3622454">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622457">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3622465">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622473">timeout</span>&nbsp;<span class="builtintype" id="3622481">bool</span><br>
<span class="lineno"></span><span class="op" id="3622486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622489">func</span>&nbsp;<span class="op" id="3622494">(</span><span class="ident" id="3622495">e</span>&nbsp;<span class="op" id="3622497">*</span><span class="ident" id="3622498">httpError</span><span class="op" id="3622507">)</span>&nbsp;<span class="ident" id="3622509">Error</span><span class="op" id="3622514">(</span><span class="op" id="3622515">)</span>&nbsp;<span class="builtintype" id="3622517">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3622526">{</span>&nbsp;<span class="keyword" id="3622528">return</span>&nbsp;<span class="ident" id="3622535">e</span><span class="op" id="3622536">.</span><span class="ident" id="3622537">err</span>&nbsp;<span class="op" id="3622541">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3622543">func</span>&nbsp;<span class="op" id="3622548">(</span><span class="ident" id="3622549">e</span>&nbsp;<span class="op" id="3622551">*</span><span class="ident" id="3622552">httpError</span><span class="op" id="3622561">)</span>&nbsp;<span class="ident" id="3622563">Timeout</span><span class="op" id="3622570">(</span><span class="op" id="3622571">)</span>&nbsp;<span class="builtintype" id="3622573">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3622580">{</span>&nbsp;<span class="keyword" id="3622582">return</span>&nbsp;<span class="ident" id="3622589">e</span><span class="op" id="3622590">.</span><span class="ident" id="3622591">timeout</span>&nbsp;<span class="op" id="3622599">}</span><br>
<span class="lineno"></span><span class="keyword" id="3622601">func</span>&nbsp;<span class="op" id="3622606">(</span><span class="ident" id="3622607">e</span>&nbsp;<span class="op" id="3622609">*</span><span class="ident" id="3622610">httpError</span><span class="op" id="3622619">)</span>&nbsp;<span class="ident" id="3622621">Temporary</span><span class="op" id="3622630">(</span><span class="op" id="3622631">)</span>&nbsp;<span class="builtintype" id="3622633">bool</span>&nbsp;<span class="op" id="3622638">{</span>&nbsp;<span class="keyword" id="3622640">return</span>&nbsp;<span class="builtintype" id="3622647">true</span>&nbsp;<span class="op" id="3622652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622655">var</span>&nbsp;<span class="ident" id="3622659">errTimeout</span>&nbsp;<span class="builtintype" id="3622670">error</span>&nbsp;<span class="op" id="3622676">=</span>&nbsp;<span class="op" id="3622678">&amp;</span><span class="ident" id="3622679">httpError</span><span class="op" id="3622688">{</span><span class="ident" id="3622689">err</span><span class="op" id="3622692">:</span>&nbsp;<span class="string" id="3622694">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3622739">,</span>&nbsp;<span class="ident" id="3622741">timeout</span><span class="op" id="3622748">:</span>&nbsp;<span class="builtintype" id="3622750">true</span><span class="op" id="3622754">}</span><br>
<span class="lineno"></span><span class="keyword" id="3622756">var</span>&nbsp;<span class="ident" id="3622760">errClosed</span>&nbsp;<span class="builtintype" id="3622770">error</span>&nbsp;<span class="op" id="3622776">=</span>&nbsp;<span class="op" id="3622778">&amp;</span><span class="ident" id="3622779">httpError</span><span class="op" id="3622788">{</span><span class="ident" id="3622789">err</span><span class="op" id="3622792">:</span>&nbsp;<span class="string" id="3622794">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3622851">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3622854">func</span>&nbsp;<span class="op" id="3622859">(</span><span class="ident" id="3622860">pc</span>&nbsp;<span class="op" id="3622863">*</span><span class="ident" id="3622864">persistConn</span><span class="op" id="3622875">)</span>&nbsp;<span class="ident" id="3622877">roundTrip</span><span class="op" id="3622886">(</span><span class="ident" id="3622887">req</span>&nbsp;<span class="op" id="3622891">*</span><span class="ident" id="3622892">transportRequest</span><span class="op" id="3622908">)</span>&nbsp;<span class="op" id="3622910">(</span><span class="ident" id="3622911">resp</span>&nbsp;<span class="op" id="3622916">*</span><span class="ident" id="3622917">Response</span><span class="op" id="3622925">,</span>&nbsp;<span class="ident" id="3622927">err</span>&nbsp;<span class="builtintype" id="3622931">error</span><span class="op" id="3622936">)</span>&nbsp;<span class="op" id="3622938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622941">pc</span><span class="op" id="3622943">.</span><span class="ident" id="3622944">t</span><span class="op" id="3622945">.</span><span class="ident" id="3622946">setReqCanceler</span><span class="op" id="3622960">(</span><span class="ident" id="3622961">req</span><span class="op" id="3622964">.</span><span class="ident" id="3622965">Request</span><span class="op" id="3622972">,</span>&nbsp;<span class="ident" id="3622974">pc</span><span class="op" id="3622976">.</span><span class="ident" id="3622977">cancelRequest</span><span class="op" id="3622990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3622993">pc</span><span class="op" id="3622995">.</span><span class="ident" id="3622996">lk</span><span class="op" id="3622998">.</span><span class="ident" id="3622999">Lock</span><span class="op" id="3623003">(</span><span class="op" id="3623004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623007">pc</span><span class="op" id="3623009">.</span><span class="ident" id="3623010">numExpectedResponses</span><span class="op" id="3623030">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623034">headerFn</span>&nbsp;<span class="op" id="3623043">:=</span>&nbsp;<span class="ident" id="3623046">pc</span><span class="op" id="3623048">.</span><span class="ident" id="3623049">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623067">pc</span><span class="op" id="3623069">.</span><span class="ident" id="3623070">lk</span><span class="op" id="3623072">.</span><span class="ident" id="3623073">Unlock</span><span class="op" id="3623079">(</span><span class="op" id="3623080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623084">if</span>&nbsp;<span class="ident" id="3623087">headerFn</span>&nbsp;<span class="op" id="3623096">!=</span>&nbsp;<span class="ident" id="3623099">nil</span>&nbsp;<span class="op" id="3623103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623107">headerFn</span><span class="op" id="3623115">(</span><span class="ident" id="3623116">req</span><span class="op" id="3623119">.</span><span class="ident" id="3623120">extraHeaders</span><span class="op" id="3623132">(</span><span class="op" id="3623133">)</span><span class="op" id="3623134">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3623137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623141">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623205">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623259">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623316">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623334">requestedGzip</span>&nbsp;<span class="op" id="3623348">:=</span>&nbsp;<span class="builtintype" id="3623351">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3623358">if</span>&nbsp;<span class="op" id="3623361">!</span><span class="ident" id="3623362">pc</span><span class="op" id="3623364">.</span><span class="ident" id="3623365">t</span><span class="op" id="3623366">.</span><span class="ident" id="3623367">DisableCompression</span>&nbsp;<span class="op" id="3623386">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623391">req</span><span class="op" id="3623394">.</span><span class="ident" id="3623395">Header</span><span class="op" id="3623401">.</span><span class="ident" id="3623402">Get</span><span class="op" id="3623405">(</span><span class="string" id="3623406">&#34;Accept-Encoding&#34;</span><span class="op" id="3623423">)</span>&nbsp;<span class="op" id="3623425">==</span>&nbsp;<span class="string" id="3623428">&#34;&#34;</span>&nbsp;<span class="op" id="3623431">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623436">req</span><span class="op" id="3623439">.</span><span class="ident" id="3623440">Header</span><span class="op" id="3623446">.</span><span class="ident" id="3623447">Get</span><span class="op" id="3623450">(</span><span class="string" id="3623451">&#34;Range&#34;</span><span class="op" id="3623458">)</span>&nbsp;<span class="op" id="3623460">==</span>&nbsp;<span class="string" id="3623463">&#34;&#34;</span>&nbsp;<span class="op" id="3623466">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3623471">req</span><span class="op" id="3623474">.</span><span class="ident" id="3623475">Method</span>&nbsp;<span class="op" id="3623482">!=</span>&nbsp;<span class="string" id="3623485">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3623492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623496">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623558">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623600">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623655">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623660">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623716">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623744">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623790">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623826">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623831">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623895">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3623961">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624007">requestedGzip</span>&nbsp;<span class="op" id="3624021">=</span>&nbsp;<span class="builtintype" id="3624023">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624030">req</span><span class="op" id="3624033">.</span><span class="ident" id="3624034">extraHeaders</span><span class="op" id="3624046">(</span><span class="op" id="3624047">)</span><span class="op" id="3624048">.</span><span class="ident" id="3624049">Set</span><span class="op" id="3624052">(</span><span class="string" id="3624053">&#34;Accept-Encoding&#34;</span><span class="op" id="3624070">,</span>&nbsp;<span class="string" id="3624072">&#34;gzip&#34;</span><span class="op" id="3624078">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624085">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624149">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624213">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624231">writeErrCh</span>&nbsp;<span class="op" id="3624242">:=</span>&nbsp;<span class="builtinfunc" id="3624245">make</span><span class="op" id="3624249">(</span><span class="keyword" id="3624250">chan</span>&nbsp;<span class="builtintype" id="3624255">error</span><span class="op" id="3624260">,</span>&nbsp;<span class="num" id="3624262">1</span><span class="op" id="3624263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624266">pc</span><span class="op" id="3624268">.</span><span class="ident" id="3624269">writech</span>&nbsp;<span class="op" id="3624277">&lt;-</span>&nbsp;<span class="ident" id="3624280">writeRequest</span><span class="op" id="3624292">{</span><span class="ident" id="3624293">req</span><span class="op" id="3624296">,</span>&nbsp;<span class="ident" id="3624298">writeErrCh</span><span class="op" id="3624308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624312">resc</span>&nbsp;<span class="op" id="3624317">:=</span>&nbsp;<span class="builtinfunc" id="3624320">make</span><span class="op" id="3624324">(</span><span class="keyword" id="3624325">chan</span>&nbsp;<span class="ident" id="3624330">responseAndError</span><span class="op" id="3624346">,</span>&nbsp;<span class="num" id="3624348">1</span><span class="op" id="3624349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624352">pc</span><span class="op" id="3624354">.</span><span class="ident" id="3624355">reqch</span>&nbsp;<span class="op" id="3624361">&lt;-</span>&nbsp;<span class="ident" id="3624364">requestAndChan</span><span class="op" id="3624378">{</span><span class="ident" id="3624379">req</span><span class="op" id="3624382">.</span><span class="ident" id="3624383">Request</span><span class="op" id="3624390">,</span>&nbsp;<span class="ident" id="3624392">resc</span><span class="op" id="3624396">,</span>&nbsp;<span class="ident" id="3624398">requestedGzip</span><span class="op" id="3624411">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624415">var</span>&nbsp;<span class="ident" id="3624419">re</span>&nbsp;<span class="ident" id="3624422">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624440">var</span>&nbsp;<span class="ident" id="3624444">pconnDeadCh</span>&nbsp;<span class="op" id="3624456">=</span>&nbsp;<span class="ident" id="3624458">pc</span><span class="op" id="3624460">.</span><span class="ident" id="3624461">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624470">var</span>&nbsp;<span class="ident" id="3624474">failTicker</span>&nbsp;<span class="op" id="3624485">&lt;-</span><span class="keyword" id="3624487">chan</span>&nbsp;<span class="ident" id="3624492">time</span><span class="op" id="3624496">.</span><span class="ident" id="3624497">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624503">var</span>&nbsp;<span class="ident" id="3624507">respHeaderTimer</span>&nbsp;<span class="op" id="3624523">&lt;-</span><span class="keyword" id="3624525">chan</span>&nbsp;<span class="ident" id="3624530">time</span><span class="op" id="3624534">.</span><span class="ident" id="3624535">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3624540">WaitResponse</span><span class="op" id="3624552">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624555">for</span>&nbsp;<span class="op" id="3624559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624563">select</span>&nbsp;<span class="op" id="3624570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624574">case</span>&nbsp;<span class="ident" id="3624579">err</span>&nbsp;<span class="op" id="3624583">:=</span>&nbsp;<span class="op" id="3624586">&lt;-</span><span class="ident" id="3624588">writeErrCh</span><span class="op" id="3624598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624603">if</span>&nbsp;<span class="ident" id="3624606">err</span>&nbsp;<span class="op" id="3624610">!=</span>&nbsp;<span class="ident" id="3624613">nil</span>&nbsp;<span class="op" id="3624617">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624623">re</span>&nbsp;<span class="op" id="3624626">=</span>&nbsp;<span class="ident" id="3624628">responseAndError</span><span class="op" id="3624644">{</span><span class="ident" id="3624645">nil</span><span class="op" id="3624648">,</span>&nbsp;<span class="ident" id="3624650">err</span><span class="op" id="3624653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624659">pc</span><span class="op" id="3624661">.</span><span class="builtinfunc" id="3624662">close</span><span class="op" id="3624667">(</span><span class="op" id="3624668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624674">break</span>&nbsp;<span class="ident" id="3624680">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624701">if</span>&nbsp;<span class="ident" id="3624704">d</span>&nbsp;<span class="op" id="3624706">:=</span>&nbsp;<span class="ident" id="3624709">pc</span><span class="op" id="3624711">.</span><span class="ident" id="3624712">t</span><span class="op" id="3624713">.</span><span class="ident" id="3624714">ResponseHeaderTimeout</span><span class="op" id="3624735">;</span>&nbsp;<span class="ident" id="3624737">d</span>&nbsp;<span class="op" id="3624739">&gt;</span>&nbsp;<span class="num" id="3624741">0</span>&nbsp;<span class="op" id="3624743">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3624749">respHeaderTimer</span>&nbsp;<span class="op" id="3624765">=</span>&nbsp;<span class="ident" id="3624767">time</span><span class="op" id="3624771">.</span><span class="ident" id="3624772">After</span><span class="op" id="3624777">(</span><span class="ident" id="3624778">d</span><span class="op" id="3624779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3624784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3624788">case</span>&nbsp;<span class="op" id="3624793">&lt;-</span><span class="ident" id="3624795">pconnDeadCh</span><span class="op" id="3624806">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624811">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624864">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624924">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3624981">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625035">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625094">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625152">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625209">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625243">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625249">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625314">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625370">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625413">pconnDeadCh</span>&nbsp;<span class="op" id="3625425">=</span>&nbsp;<span class="ident" id="3625427">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3625461">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625482">failTicker</span>&nbsp;<span class="op" id="3625493">=</span>&nbsp;<span class="ident" id="3625495">time</span><span class="op" id="3625499">.</span><span class="ident" id="3625500">After</span><span class="op" id="3625505">(</span><span class="num" id="3625506">100</span>&nbsp;<span class="op" id="3625510">*</span>&nbsp;<span class="ident" id="3625512">time</span><span class="op" id="3625516">.</span><span class="ident" id="3625517">Millisecond</span><span class="op" id="3625528">)</span>&nbsp;<span class="comment" id="3625530">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625567">case</span>&nbsp;<span class="op" id="3625572">&lt;-</span><span class="ident" id="3625574">failTicker</span><span class="op" id="3625584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625589">re</span>&nbsp;<span class="op" id="3625592">=</span>&nbsp;<span class="ident" id="3625594">responseAndError</span><span class="op" id="3625610">{</span><span class="ident" id="3625611">err</span><span class="op" id="3625614">:</span>&nbsp;<span class="ident" id="3625616">errClosed</span><span class="op" id="3625625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625630">break</span>&nbsp;<span class="ident" id="3625636">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625651">case</span>&nbsp;<span class="op" id="3625656">&lt;-</span><span class="ident" id="3625658">respHeaderTimer</span><span class="op" id="3625673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625678">pc</span><span class="op" id="3625680">.</span><span class="builtinfunc" id="3625681">close</span><span class="op" id="3625686">(</span><span class="op" id="3625687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625692">re</span>&nbsp;<span class="op" id="3625695">=</span>&nbsp;<span class="ident" id="3625697">responseAndError</span><span class="op" id="3625713">{</span><span class="ident" id="3625714">err</span><span class="op" id="3625717">:</span>&nbsp;<span class="ident" id="3625719">errTimeout</span><span class="op" id="3625729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625734">break</span>&nbsp;<span class="ident" id="3625740">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625755">case</span>&nbsp;<span class="ident" id="3625760">re</span>&nbsp;<span class="op" id="3625763">=</span>&nbsp;<span class="op" id="3625765">&lt;-</span><span class="ident" id="3625767">resc</span><span class="op" id="3625771">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625776">break</span>&nbsp;<span class="ident" id="3625782">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625804">pc</span><span class="op" id="3625806">.</span><span class="ident" id="3625807">lk</span><span class="op" id="3625809">.</span><span class="ident" id="3625810">Lock</span><span class="op" id="3625814">(</span><span class="op" id="3625815">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625818">pc</span><span class="op" id="3625820">.</span><span class="ident" id="3625821">numExpectedResponses</span><span class="op" id="3625841">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625845">pc</span><span class="op" id="3625847">.</span><span class="ident" id="3625848">lk</span><span class="op" id="3625850">.</span><span class="ident" id="3625851">Unlock</span><span class="op" id="3625857">(</span><span class="op" id="3625858">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625862">if</span>&nbsp;<span class="ident" id="3625865">re</span><span class="op" id="3625867">.</span><span class="ident" id="3625868">err</span>&nbsp;<span class="op" id="3625872">!=</span>&nbsp;<span class="ident" id="3625875">nil</span>&nbsp;<span class="op" id="3625879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3625883">pc</span><span class="op" id="3625885">.</span><span class="ident" id="3625886">t</span><span class="op" id="3625887">.</span><span class="ident" id="3625888">setReqCanceler</span><span class="op" id="3625902">(</span><span class="ident" id="3625903">req</span><span class="op" id="3625906">.</span><span class="ident" id="3625907">Request</span><span class="op" id="3625914">,</span>&nbsp;<span class="ident" id="3625916">nil</span><span class="op" id="3625919">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3625922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3625925">return</span>&nbsp;<span class="ident" id="3625932">re</span><span class="op" id="3625934">.</span><span class="ident" id="3625935">res</span><span class="op" id="3625938">,</span>&nbsp;<span class="ident" id="3625940">re</span><span class="op" id="3625942">.</span><span class="ident" id="3625943">err</span><br>
<span class="lineno"></span><span class="op" id="3625947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3625950">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3626015">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3626080">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3626130">func</span>&nbsp;<span class="op" id="3626135">(</span><span class="ident" id="3626136">pc</span>&nbsp;<span class="op" id="3626139">*</span><span class="ident" id="3626140">persistConn</span><span class="op" id="3626151">)</span>&nbsp;<span class="ident" id="3626153">markBroken</span><span class="op" id="3626163">(</span><span class="op" id="3626164">)</span>&nbsp;<span class="op" id="3626166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626169">pc</span><span class="op" id="3626171">.</span><span class="ident" id="3626172">lk</span><span class="op" id="3626174">.</span><span class="ident" id="3626175">Lock</span><span class="op" id="3626179">(</span><span class="op" id="3626180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626183">defer</span>&nbsp;<span class="ident" id="3626189">pc</span><span class="op" id="3626191">.</span><span class="ident" id="3626192">lk</span><span class="op" id="3626194">.</span><span class="ident" id="3626195">Unlock</span><span class="op" id="3626201">(</span><span class="op" id="3626202">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626205">pc</span><span class="op" id="3626207">.</span><span class="ident" id="3626208">broken</span>&nbsp;<span class="op" id="3626215">=</span>&nbsp;<span class="builtintype" id="3626217">true</span><br>
<span class="lineno"></span><span class="op" id="3626222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3626225">func</span>&nbsp;<span class="op" id="3626230">(</span><span class="ident" id="3626231">pc</span>&nbsp;<span class="op" id="3626234">*</span><span class="ident" id="3626235">persistConn</span><span class="op" id="3626246">)</span>&nbsp;<span class="builtinfunc" id="3626248">close</span><span class="op" id="3626253">(</span><span class="op" id="3626254">)</span>&nbsp;<span class="op" id="3626256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626259">pc</span><span class="op" id="3626261">.</span><span class="ident" id="3626262">lk</span><span class="op" id="3626264">.</span><span class="ident" id="3626265">Lock</span><span class="op" id="3626269">(</span><span class="op" id="3626270">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626273">defer</span>&nbsp;<span class="ident" id="3626279">pc</span><span class="op" id="3626281">.</span><span class="ident" id="3626282">lk</span><span class="op" id="3626284">.</span><span class="ident" id="3626285">Unlock</span><span class="op" id="3626291">(</span><span class="op" id="3626292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626295">pc</span><span class="op" id="3626297">.</span><span class="ident" id="3626298">closeLocked</span><span class="op" id="3626309">(</span><span class="op" id="3626310">)</span><br>
<span class="lineno"></span><span class="op" id="3626312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3626315">func</span>&nbsp;<span class="op" id="3626320">(</span><span class="ident" id="3626321">pc</span>&nbsp;<span class="op" id="3626324">*</span><span class="ident" id="3626325">persistConn</span><span class="op" id="3626336">)</span>&nbsp;<span class="ident" id="3626338">closeLocked</span><span class="op" id="3626349">(</span><span class="op" id="3626350">)</span>&nbsp;<span class="op" id="3626352">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626355">pc</span><span class="op" id="3626357">.</span><span class="ident" id="3626358">broken</span>&nbsp;<span class="op" id="3626365">=</span>&nbsp;<span class="builtintype" id="3626367">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626373">if</span>&nbsp;<span class="op" id="3626376">!</span><span class="ident" id="3626377">pc</span><span class="op" id="3626379">.</span><span class="ident" id="3626380">closed</span>&nbsp;<span class="op" id="3626387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626391">pc</span><span class="op" id="3626393">.</span><span class="ident" id="3626394">conn</span><span class="op" id="3626398">.</span><span class="ident" id="3626399">Close</span><span class="op" id="3626404">(</span><span class="op" id="3626405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626409">pc</span><span class="op" id="3626411">.</span><span class="ident" id="3626412">closed</span>&nbsp;<span class="op" id="3626419">=</span>&nbsp;<span class="builtintype" id="3626421">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3626428">close</span><span class="op" id="3626433">(</span><span class="ident" id="3626434">pc</span><span class="op" id="3626436">.</span><span class="ident" id="3626437">closech</span><span class="op" id="3626444">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626450">pc</span><span class="op" id="3626452">.</span><span class="ident" id="3626453">mutateHeaderFunc</span>&nbsp;<span class="op" id="3626470">=</span>&nbsp;<span class="ident" id="3626472">nil</span><br>
<span class="lineno"></span><span class="op" id="3626476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3626479">var</span>&nbsp;<span class="ident" id="3626483">portMap</span>&nbsp;<span class="op" id="3626491">=</span>&nbsp;<span class="keyword" id="3626493">map</span><span class="op" id="3626496">[</span><span class="builtintype" id="3626497">string</span><span class="op" id="3626503">]</span><span class="builtintype" id="3626504">string</span><span class="op" id="3626510">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3626513">&#34;http&#34;</span><span class="op" id="3626519">:</span>&nbsp;&nbsp;<span class="string" id="3626522">&#34;80&#34;</span><span class="op" id="3626526">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3626529">&#34;https&#34;</span><span class="op" id="3626536">:</span>&nbsp;<span class="string" id="3626538">&#34;443&#34;</span><span class="op" id="3626543">,</span><br>
<span class="lineno"></span><span class="op" id="3626545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3626548">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3626615">func</span>&nbsp;<span class="ident" id="3626620">canonicalAddr</span><span class="op" id="3626633">(</span><span class="ident" id="3626634">url</span>&nbsp;<span class="op" id="3626638">*</span><span class="ident" id="3626639">url</span><span class="op" id="3626642">.</span><span class="ident" id="3626643">URL</span><span class="op" id="3626646">)</span>&nbsp;<span class="builtintype" id="3626648">string</span>&nbsp;<span class="op" id="3626655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3626658">addr</span>&nbsp;<span class="op" id="3626663">:=</span>&nbsp;<span class="ident" id="3626666">url</span><span class="op" id="3626669">.</span><span class="ident" id="3626670">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626676">if</span>&nbsp;<span class="op" id="3626679">!</span><span class="ident" id="3626680">hasPort</span><span class="op" id="3626687">(</span><span class="ident" id="3626688">addr</span><span class="op" id="3626692">)</span>&nbsp;<span class="op" id="3626694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626698">return</span>&nbsp;<span class="ident" id="3626705">addr</span>&nbsp;<span class="op" id="3626710">+</span>&nbsp;<span class="string" id="3626712">&#34;:&#34;</span>&nbsp;<span class="op" id="3626716">+</span>&nbsp;<span class="ident" id="3626718">portMap</span><span class="op" id="3626725">[</span><span class="ident" id="3626726">url</span><span class="op" id="3626729">.</span><span class="ident" id="3626730">Scheme</span><span class="op" id="3626736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3626739">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3626742">return</span>&nbsp;<span class="ident" id="3626749">addr</span><br>
<span class="lineno"></span><span class="op" id="3626754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3626757">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3626826">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3626895">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3626961">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3627026">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3627074">type</span>&nbsp;<span class="ident" id="3627079">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3627093">struct</span>&nbsp;<span class="op" id="3627100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627103">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627116">io</span><span class="op" id="3627118">.</span><span class="ident" id="3627119">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627131">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627144">sync</span><span class="op" id="3627148">.</span><span class="ident" id="3627149">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3627157">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627187">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3627200">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627213">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627247">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3627260">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3627273">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627295">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627308">func</span><span class="op" id="3627312">(</span><span class="builtintype" id="3627313">error</span><span class="op" id="3627318">)</span>&nbsp;&nbsp;<span class="comment" id="3627321">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627358">earlyCloseFn</span>&nbsp;<span class="keyword" id="3627371">func</span><span class="op" id="3627375">(</span><span class="op" id="3627376">)</span>&nbsp;<span class="builtintype" id="3627378">error</span>&nbsp;<span class="comment" id="3627384">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3627435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3627438">func</span>&nbsp;<span class="op" id="3627443">(</span><span class="ident" id="3627444">es</span>&nbsp;<span class="op" id="3627447">*</span><span class="ident" id="3627448">bodyEOFSignal</span><span class="op" id="3627461">)</span>&nbsp;<span class="ident" id="3627463">Read</span><span class="op" id="3627467">(</span><span class="ident" id="3627468">p</span>&nbsp;<span class="op" id="3627470">[</span><span class="op" id="3627471">]</span><span class="builtintype" id="3627472">byte</span><span class="op" id="3627476">)</span>&nbsp;<span class="op" id="3627478">(</span><span class="ident" id="3627479">n</span>&nbsp;<span class="builtintype" id="3627481">int</span><span class="op" id="3627484">,</span>&nbsp;<span class="ident" id="3627486">err</span>&nbsp;<span class="builtintype" id="3627490">error</span><span class="op" id="3627495">)</span>&nbsp;<span class="op" id="3627497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627500">es</span><span class="op" id="3627502">.</span><span class="ident" id="3627503">mu</span><span class="op" id="3627505">.</span><span class="ident" id="3627506">Lock</span><span class="op" id="3627510">(</span><span class="op" id="3627511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627514">closed</span><span class="op" id="3627520">,</span>&nbsp;<span class="ident" id="3627522">rerr</span>&nbsp;<span class="op" id="3627527">:=</span>&nbsp;<span class="ident" id="3627530">es</span><span class="op" id="3627532">.</span><span class="ident" id="3627533">closed</span><span class="op" id="3627539">,</span>&nbsp;<span class="ident" id="3627541">es</span><span class="op" id="3627543">.</span><span class="ident" id="3627544">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627550">es</span><span class="op" id="3627552">.</span><span class="ident" id="3627553">mu</span><span class="op" id="3627555">.</span><span class="ident" id="3627556">Unlock</span><span class="op" id="3627562">(</span><span class="op" id="3627563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627566">if</span>&nbsp;<span class="ident" id="3627569">closed</span>&nbsp;<span class="op" id="3627576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627580">return</span>&nbsp;<span class="num" id="3627587">0</span><span class="op" id="3627588">,</span>&nbsp;<span class="ident" id="3627590">errors</span><span class="op" id="3627596">.</span><span class="ident" id="3627597">New</span><span class="op" id="3627600">(</span><span class="string" id="3627601">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="3627637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627643">if</span>&nbsp;<span class="ident" id="3627646">rerr</span>&nbsp;<span class="op" id="3627651">!=</span>&nbsp;<span class="ident" id="3627654">nil</span>&nbsp;<span class="op" id="3627658">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627662">return</span>&nbsp;<span class="num" id="3627669">0</span><span class="op" id="3627670">,</span>&nbsp;<span class="ident" id="3627672">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627682">n</span><span class="op" id="3627683">,</span>&nbsp;<span class="ident" id="3627685">err</span>&nbsp;<span class="op" id="3627689">=</span>&nbsp;<span class="ident" id="3627691">es</span><span class="op" id="3627693">.</span><span class="ident" id="3627694">body</span><span class="op" id="3627698">.</span><span class="ident" id="3627699">Read</span><span class="op" id="3627703">(</span><span class="ident" id="3627704">p</span><span class="op" id="3627705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627708">if</span>&nbsp;<span class="ident" id="3627711">err</span>&nbsp;<span class="op" id="3627715">!=</span>&nbsp;<span class="ident" id="3627718">nil</span>&nbsp;<span class="op" id="3627722">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627726">es</span><span class="op" id="3627728">.</span><span class="ident" id="3627729">mu</span><span class="op" id="3627731">.</span><span class="ident" id="3627732">Lock</span><span class="op" id="3627736">(</span><span class="op" id="3627737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627741">defer</span>&nbsp;<span class="ident" id="3627747">es</span><span class="op" id="3627749">.</span><span class="ident" id="3627750">mu</span><span class="op" id="3627752">.</span><span class="ident" id="3627753">Unlock</span><span class="op" id="3627759">(</span><span class="op" id="3627760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627764">if</span>&nbsp;<span class="ident" id="3627767">es</span><span class="op" id="3627769">.</span><span class="ident" id="3627770">rerr</span>&nbsp;<span class="op" id="3627775">==</span>&nbsp;<span class="ident" id="3627778">nil</span>&nbsp;<span class="op" id="3627782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627787">es</span><span class="op" id="3627789">.</span><span class="ident" id="3627790">rerr</span>&nbsp;<span class="op" id="3627795">=</span>&nbsp;<span class="ident" id="3627797">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627803">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627807">es</span><span class="op" id="3627809">.</span><span class="ident" id="3627810">condfn</span><span class="op" id="3627816">(</span><span class="ident" id="3627817">err</span><span class="op" id="3627820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627826">return</span><br>
<span class="lineno"></span><span class="op" id="3627833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="3627836">func</span>&nbsp;<span class="op" id="3627841">(</span><span class="ident" id="3627842">es</span>&nbsp;<span class="op" id="3627845">*</span><span class="ident" id="3627846">bodyEOFSignal</span><span class="op" id="3627859">)</span>&nbsp;<span class="ident" id="3627861">Close</span><span class="op" id="3627866">(</span><span class="op" id="3627867">)</span>&nbsp;<span class="builtintype" id="3627869">error</span>&nbsp;<span class="op" id="3627875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627878">es</span><span class="op" id="3627880">.</span><span class="ident" id="3627881">mu</span><span class="op" id="3627883">.</span><span class="ident" id="3627884">Lock</span><span class="op" id="3627888">(</span><span class="op" id="3627889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627892">defer</span>&nbsp;<span class="ident" id="3627898">es</span><span class="op" id="3627900">.</span><span class="ident" id="3627901">mu</span><span class="op" id="3627903">.</span><span class="ident" id="3627904">Unlock</span><span class="op" id="3627910">(</span><span class="op" id="3627911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627914">if</span>&nbsp;<span class="ident" id="3627917">es</span><span class="op" id="3627919">.</span><span class="ident" id="3627920">closed</span>&nbsp;<span class="op" id="3627927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627931">return</span>&nbsp;<span class="ident" id="3627938">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3627943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627946">es</span><span class="op" id="3627948">.</span><span class="ident" id="3627949">closed</span>&nbsp;<span class="op" id="3627956">=</span>&nbsp;<span class="builtintype" id="3627958">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3627964">if</span>&nbsp;<span class="ident" id="3627967">es</span><span class="op" id="3627969">.</span><span class="ident" id="3627970">earlyCloseFn</span>&nbsp;<span class="op" id="3627983">!=</span>&nbsp;<span class="ident" id="3627986">nil</span>&nbsp;<span class="op" id="3627990">&amp;&amp;</span>&nbsp;<span class="ident" id="3627993">es</span><span class="op" id="3627995">.</span><span class="ident" id="3627996">rerr</span>&nbsp;<span class="op" id="3628001">!=</span>&nbsp;<span class="ident" id="3628004">io</span><span class="op" id="3628006">.</span><span class="ident" id="3628007">EOF</span>&nbsp;<span class="op" id="3628011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628015">return</span>&nbsp;<span class="ident" id="3628022">es</span><span class="op" id="3628024">.</span><span class="ident" id="3628025">earlyCloseFn</span><span class="op" id="3628037">(</span><span class="op" id="3628038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628041">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628044">err</span>&nbsp;<span class="op" id="3628048">:=</span>&nbsp;<span class="ident" id="3628051">es</span><span class="op" id="3628053">.</span><span class="ident" id="3628054">body</span><span class="op" id="3628058">.</span><span class="ident" id="3628059">Close</span><span class="op" id="3628064">(</span><span class="op" id="3628065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628068">es</span><span class="op" id="3628070">.</span><span class="ident" id="3628071">condfn</span><span class="op" id="3628077">(</span><span class="ident" id="3628078">err</span><span class="op" id="3628081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628084">return</span>&nbsp;<span class="ident" id="3628091">err</span><br>
<span class="lineno"></span><span class="op" id="3628095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="3628098">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3628125">func</span>&nbsp;<span class="op" id="3628130">(</span><span class="ident" id="3628131">es</span>&nbsp;<span class="op" id="3628134">*</span><span class="ident" id="3628135">bodyEOFSignal</span><span class="op" id="3628148">)</span>&nbsp;<span class="ident" id="3628150">condfn</span><span class="op" id="3628156">(</span><span class="ident" id="3628157">err</span>&nbsp;<span class="builtintype" id="3628161">error</span><span class="op" id="3628166">)</span>&nbsp;<span class="op" id="3628168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628171">if</span>&nbsp;<span class="ident" id="3628174">es</span><span class="op" id="3628176">.</span><span class="ident" id="3628177">fn</span>&nbsp;<span class="op" id="3628180">==</span>&nbsp;<span class="ident" id="3628183">nil</span>&nbsp;<span class="op" id="3628187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628191">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628199">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628202">if</span>&nbsp;<span class="ident" id="3628205">err</span>&nbsp;<span class="op" id="3628209">==</span>&nbsp;<span class="ident" id="3628212">io</span><span class="op" id="3628214">.</span><span class="ident" id="3628215">EOF</span>&nbsp;<span class="op" id="3628219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628223">err</span>&nbsp;<span class="op" id="3628227">=</span>&nbsp;<span class="ident" id="3628229">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628237">es</span><span class="op" id="3628239">.</span><span class="ident" id="3628240">fn</span><span class="op" id="3628242">(</span><span class="ident" id="3628243">err</span><span class="op" id="3628246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628249">es</span><span class="op" id="3628251">.</span><span class="ident" id="3628252">fn</span>&nbsp;<span class="op" id="3628255">=</span>&nbsp;<span class="ident" id="3628257">nil</span><br>
<span class="lineno">1230</span><span class="op" id="3628261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628264">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="3628317">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="3628366">type</span>&nbsp;<span class="ident" id="3628371">gzipReader</span>&nbsp;<span class="keyword" id="3628382">struct</span>&nbsp;<span class="op" id="3628389">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628392">body</span>&nbsp;<span class="ident" id="3628397">io</span><span class="op" id="3628399">.</span><span class="ident" id="3628400">ReadCloser</span>&nbsp;<span class="comment" id="3628411">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628440">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3628445">io</span><span class="op" id="3628447">.</span><span class="ident" id="3628448">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3628459">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="3628493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628496">func</span>&nbsp;<span class="op" id="3628501">(</span><span class="ident" id="3628502">gz</span>&nbsp;<span class="op" id="3628505">*</span><span class="ident" id="3628506">gzipReader</span><span class="op" id="3628516">)</span>&nbsp;<span class="ident" id="3628518">Read</span><span class="op" id="3628522">(</span><span class="ident" id="3628523">p</span>&nbsp;<span class="op" id="3628525">[</span><span class="op" id="3628526">]</span><span class="builtintype" id="3628527">byte</span><span class="op" id="3628531">)</span>&nbsp;<span class="op" id="3628533">(</span><span class="ident" id="3628534">n</span>&nbsp;<span class="builtintype" id="3628536">int</span><span class="op" id="3628539">,</span>&nbsp;<span class="ident" id="3628541">err</span>&nbsp;<span class="builtintype" id="3628545">error</span><span class="op" id="3628550">)</span>&nbsp;<span class="op" id="3628552">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628555">if</span>&nbsp;<span class="ident" id="3628558">gz</span><span class="op" id="3628560">.</span><span class="ident" id="3628561">zr</span>&nbsp;<span class="op" id="3628564">==</span>&nbsp;<span class="ident" id="3628567">nil</span>&nbsp;<span class="op" id="3628571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628575">gz</span><span class="op" id="3628577">.</span><span class="ident" id="3628578">zr</span><span class="op" id="3628580">,</span>&nbsp;<span class="ident" id="3628582">err</span>&nbsp;<span class="op" id="3628586">=</span>&nbsp;<span class="ident" id="3628588">gzip</span><span class="op" id="3628592">.</span><span class="ident" id="3628593">NewReader</span><span class="op" id="3628602">(</span><span class="ident" id="3628603">gz</span><span class="op" id="3628605">.</span><span class="ident" id="3628606">body</span><span class="op" id="3628610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628614">if</span>&nbsp;<span class="ident" id="3628617">err</span>&nbsp;<span class="op" id="3628621">!=</span>&nbsp;<span class="ident" id="3628624">nil</span>&nbsp;<span class="op" id="3628628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628633">return</span>&nbsp;<span class="num" id="3628640">0</span><span class="op" id="3628641">,</span>&nbsp;<span class="ident" id="3628643">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628649">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3628652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628655">return</span>&nbsp;<span class="ident" id="3628662">gz</span><span class="op" id="3628664">.</span><span class="ident" id="3628665">zr</span><span class="op" id="3628667">.</span><span class="ident" id="3628668">Read</span><span class="op" id="3628672">(</span><span class="ident" id="3628673">p</span><span class="op" id="3628674">)</span><br>
<span class="lineno"></span><span class="op" id="3628676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628679">func</span>&nbsp;<span class="op" id="3628684">(</span><span class="ident" id="3628685">gz</span>&nbsp;<span class="op" id="3628688">*</span><span class="ident" id="3628689">gzipReader</span><span class="op" id="3628699">)</span>&nbsp;<span class="ident" id="3628701">Close</span><span class="op" id="3628706">(</span><span class="op" id="3628707">)</span>&nbsp;<span class="builtintype" id="3628709">error</span>&nbsp;<span class="op" id="3628715">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3628718">return</span>&nbsp;<span class="ident" id="3628725">gz</span><span class="op" id="3628727">.</span><span class="ident" id="3628728">body</span><span class="op" id="3628732">.</span><span class="ident" id="3628733">Close</span><span class="op" id="3628738">(</span><span class="op" id="3628739">)</span><br>
<span class="lineno"></span><span class="op" id="3628741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628744">type</span>&nbsp;<span class="ident" id="3628749">readerAndCloser</span>&nbsp;<span class="keyword" id="3628765">struct</span>&nbsp;<span class="op" id="3628772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628775">io</span><span class="op" id="3628777">.</span><span class="ident" id="3628778">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3628786">io</span><span class="op" id="3628788">.</span><span class="ident" id="3628789">Closer</span><br>
<span class="lineno"></span><span class="op" id="3628796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628799">type</span>&nbsp;<span class="ident" id="3628804">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="3628829">struct</span><span class="op" id="3628835">{</span><span class="op" id="3628836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="3628839">func</span>&nbsp;<span class="op" id="3628844">(</span><span class="ident" id="3628845">tlsHandshakeTimeoutError</span><span class="op" id="3628869">)</span>&nbsp;<span class="ident" id="3628871">Timeout</span><span class="op" id="3628878">(</span><span class="op" id="3628879">)</span>&nbsp;<span class="builtintype" id="3628881">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3628888">{</span>&nbsp;<span class="keyword" id="3628890">return</span>&nbsp;<span class="builtintype" id="3628897">true</span>&nbsp;<span class="op" id="3628902">}</span><br>
<span class="lineno"></span><span class="keyword" id="3628904">func</span>&nbsp;<span class="op" id="3628909">(</span><span class="ident" id="3628910">tlsHandshakeTimeoutError</span><span class="op" id="3628934">)</span>&nbsp;<span class="ident" id="3628936">Temporary</span><span class="op" id="3628945">(</span><span class="op" id="3628946">)</span>&nbsp;<span class="builtintype" id="3628948">bool</span>&nbsp;<span class="op" id="3628953">{</span>&nbsp;<span class="keyword" id="3628955">return</span>&nbsp;<span class="builtintype" id="3628962">true</span>&nbsp;<span class="op" id="3628967">}</span><br>
<span class="lineno"></span><span class="keyword" id="3628969">func</span>&nbsp;<span class="op" id="3628974">(</span><span class="ident" id="3628975">tlsHandshakeTimeoutError</span><span class="op" id="3628999">)</span>&nbsp;<span class="ident" id="3629001">Error</span><span class="op" id="3629006">(</span><span class="op" id="3629007">)</span>&nbsp;<span class="builtintype" id="3629009">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3629018">{</span>&nbsp;<span class="keyword" id="3629020">return</span>&nbsp;<span class="string" id="3629027">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="3629061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629064">type</span>&nbsp;<span class="ident" id="3629069">noteEOFReader</span>&nbsp;<span class="keyword" id="3629083">struct</span>&nbsp;<span class="op" id="3629090">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629093">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629100">io</span><span class="op" id="3629102">.</span><span class="ident" id="3629103">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629111">sawEOF</span>&nbsp;<span class="op" id="3629118">*</span><span class="builtintype" id="3629119">bool</span><br>
<span class="lineno"></span><span class="op" id="3629124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629127">func</span>&nbsp;<span class="op" id="3629132">(</span><span class="ident" id="3629133">nr</span>&nbsp;<span class="ident" id="3629136">noteEOFReader</span><span class="op" id="3629149">)</span>&nbsp;<span class="ident" id="3629151">Read</span><span class="op" id="3629155">(</span><span class="ident" id="3629156">p</span>&nbsp;<span class="op" id="3629158">[</span><span class="op" id="3629159">]</span><span class="builtintype" id="3629160">byte</span><span class="op" id="3629164">)</span>&nbsp;<span class="op" id="3629166">(</span><span class="ident" id="3629167">n</span>&nbsp;<span class="builtintype" id="3629169">int</span><span class="op" id="3629172">,</span>&nbsp;<span class="ident" id="3629174">err</span>&nbsp;<span class="builtintype" id="3629178">error</span><span class="op" id="3629183">)</span>&nbsp;<span class="op" id="3629185">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629188">n</span><span class="op" id="3629189">,</span>&nbsp;<span class="ident" id="3629191">err</span>&nbsp;<span class="op" id="3629195">=</span>&nbsp;<span class="ident" id="3629197">nr</span><span class="op" id="3629199">.</span><span class="ident" id="3629200">r</span><span class="op" id="3629201">.</span><span class="ident" id="3629202">Read</span><span class="op" id="3629206">(</span><span class="ident" id="3629207">p</span><span class="op" id="3629208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629211">if</span>&nbsp;<span class="ident" id="3629214">err</span>&nbsp;<span class="op" id="3629218">==</span>&nbsp;<span class="ident" id="3629221">io</span><span class="op" id="3629223">.</span><span class="ident" id="3629224">EOF</span>&nbsp;<span class="op" id="3629228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3629232">*</span><span class="ident" id="3629233">nr</span><span class="op" id="3629235">.</span><span class="ident" id="3629236">sawEOF</span>&nbsp;<span class="op" id="3629243">=</span>&nbsp;<span class="builtintype" id="3629245">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3629251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3629254">return</span><br>
<span class="lineno">1275</span><span class="op" id="3629261">}</span>
</div>
</body>
</html>
