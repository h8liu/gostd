<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6123847">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6123902">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6123956">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6124007">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6124036">package</span>&nbsp;<span class="ident" id="6124044">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6124054">import</span>&nbsp;<span class="op" id="6124061">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124064">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124078">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124086">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124093">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124100">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124112">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6124118">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6124125">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6124128">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="6124199">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="6124262">type</span>&nbsp;<span class="ident" id="6124267">Server</span>&nbsp;<span class="keyword" id="6124274">struct</span>&nbsp;<span class="op" id="6124281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124284">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6124293">string</span>&nbsp;<span class="comment" id="6124300">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124363">Listener</span>&nbsp;<span class="ident" id="6124372">net</span><span class="op" id="6124375">.</span><span class="ident" id="6124376">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124387">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124458">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124530">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124593">TLS</span>&nbsp;<span class="op" id="6124597">*</span><span class="ident" id="6124598">tls</span><span class="op" id="6124601">.</span><span class="ident" id="6124602">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124611">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124674">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124704">Config</span>&nbsp;<span class="op" id="6124711">*</span><span class="ident" id="6124712">http</span><span class="op" id="6124716">.</span><span class="ident" id="6124717">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124726">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6124796">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124846">wg</span>&nbsp;<span class="ident" id="6124849">sync</span><span class="op" id="6124853">.</span><span class="ident" id="6124854">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="6124864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6124867">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="6124932">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="6124945">type</span>&nbsp;<span class="ident" id="6124950">historyListener</span>&nbsp;<span class="keyword" id="6124966">struct</span>&nbsp;<span class="op" id="6124973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124976">net</span><span class="op" id="6124979">.</span><span class="ident" id="6124980">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124990">sync</span><span class="op" id="6124994">.</span><span class="ident" id="6124995">Mutex</span>&nbsp;<span class="comment" id="6125001">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125022">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125033">[</span><span class="op" id="6125034">]</span><span class="ident" id="6125035">net</span><span class="op" id="6125038">.</span><span class="ident" id="6125039">Conn</span><br>
<span class="lineno">45</span><span class="op" id="6125044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6125047">func</span>&nbsp;<span class="op" id="6125052">(</span><span class="ident" id="6125053">hs</span>&nbsp;<span class="op" id="6125056">*</span><span class="ident" id="6125057">historyListener</span><span class="op" id="6125072">)</span>&nbsp;<span class="ident" id="6125074">Accept</span><span class="op" id="6125080">(</span><span class="op" id="6125081">)</span>&nbsp;<span class="op" id="6125083">(</span><span class="ident" id="6125084">c</span>&nbsp;<span class="ident" id="6125086">net</span><span class="op" id="6125089">.</span><span class="ident" id="6125090">Conn</span><span class="op" id="6125094">,</span>&nbsp;<span class="ident" id="6125096">err</span>&nbsp;<span class="builtintype" id="6125100">error</span><span class="op" id="6125105">)</span>&nbsp;<span class="op" id="6125107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125110">c</span><span class="op" id="6125111">,</span>&nbsp;<span class="ident" id="6125113">err</span>&nbsp;<span class="op" id="6125117">=</span>&nbsp;<span class="ident" id="6125119">hs</span><span class="op" id="6125121">.</span><span class="ident" id="6125122">Listener</span><span class="op" id="6125130">.</span><span class="ident" id="6125131">Accept</span><span class="op" id="6125137">(</span><span class="op" id="6125138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125141">if</span>&nbsp;<span class="ident" id="6125144">err</span>&nbsp;<span class="op" id="6125148">==</span>&nbsp;<span class="builtintype" id="6125151">nil</span>&nbsp;<span class="op" id="6125155">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125159">hs</span><span class="op" id="6125161">.</span><span class="ident" id="6125162">Lock</span><span class="op" id="6125166">(</span><span class="op" id="6125167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125171">hs</span><span class="op" id="6125173">.</span><span class="ident" id="6125174">history</span>&nbsp;<span class="op" id="6125182">=</span>&nbsp;<span class="builtinfunc" id="6125184">append</span><span class="op" id="6125190">(</span><span class="ident" id="6125191">hs</span><span class="op" id="6125193">.</span><span class="ident" id="6125194">history</span><span class="op" id="6125201">,</span>&nbsp;<span class="ident" id="6125203">c</span><span class="op" id="6125204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125208">hs</span><span class="op" id="6125210">.</span><span class="ident" id="6125211">Unlock</span><span class="op" id="6125217">(</span><span class="op" id="6125218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125224">return</span><br>
<span class="lineno">55</span><span class="op" id="6125231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6125234">func</span>&nbsp;<span class="ident" id="6125239">newLocalListener</span><span class="op" id="6125255">(</span><span class="op" id="6125256">)</span>&nbsp;<span class="ident" id="6125258">net</span><span class="op" id="6125261">.</span><span class="ident" id="6125262">Listener</span>&nbsp;<span class="op" id="6125271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125274">if</span>&nbsp;<span class="op" id="6125277">*</span><span class="ident" id="6125278">serve</span>&nbsp;<span class="op" id="6125284">!=</span>&nbsp;<span class="string" id="6125287">&#34;&#34;</span>&nbsp;<span class="op" id="6125290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125294">l</span><span class="op" id="6125295">,</span>&nbsp;<span class="ident" id="6125297">err</span>&nbsp;<span class="op" id="6125301">:=</span>&nbsp;<span class="ident" id="6125304">net</span><span class="op" id="6125307">.</span><span class="ident" id="6125308">Listen</span><span class="op" id="6125314">(</span><span class="string" id="6125315">&#34;tcp&#34;</span><span class="op" id="6125320">,</span>&nbsp;<span class="op" id="6125322">*</span><span class="ident" id="6125323">serve</span><span class="op" id="6125328">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125332">if</span>&nbsp;<span class="ident" id="6125335">err</span>&nbsp;<span class="op" id="6125339">!=</span>&nbsp;<span class="builtintype" id="6125342">nil</span>&nbsp;<span class="op" id="6125346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6125351">panic</span><span class="op" id="6125356">(</span><span class="ident" id="6125357">fmt</span><span class="op" id="6125360">.</span><span class="ident" id="6125361">Sprintf</span><span class="op" id="6125368">(</span><span class="string" id="6125369">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="6125407">,</span>&nbsp;<span class="op" id="6125409">*</span><span class="ident" id="6125410">serve</span><span class="op" id="6125415">,</span>&nbsp;<span class="ident" id="6125417">err</span><span class="op" id="6125420">)</span><span class="op" id="6125421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125429">return</span>&nbsp;<span class="ident" id="6125436">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125439">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125442">l</span><span class="op" id="6125443">,</span>&nbsp;<span class="ident" id="6125445">err</span>&nbsp;<span class="op" id="6125449">:=</span>&nbsp;<span class="ident" id="6125452">net</span><span class="op" id="6125455">.</span><span class="ident" id="6125456">Listen</span><span class="op" id="6125462">(</span><span class="string" id="6125463">&#34;tcp&#34;</span><span class="op" id="6125468">,</span>&nbsp;<span class="string" id="6125470">&#34;127.0.0.1:0&#34;</span><span class="op" id="6125483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125486">if</span>&nbsp;<span class="ident" id="6125489">err</span>&nbsp;<span class="op" id="6125493">!=</span>&nbsp;<span class="builtintype" id="6125496">nil</span>&nbsp;<span class="op" id="6125500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125504">if</span>&nbsp;<span class="ident" id="6125507">l</span><span class="op" id="6125508">,</span>&nbsp;<span class="ident" id="6125510">err</span>&nbsp;<span class="op" id="6125514">=</span>&nbsp;<span class="ident" id="6125516">net</span><span class="op" id="6125519">.</span><span class="ident" id="6125520">Listen</span><span class="op" id="6125526">(</span><span class="string" id="6125527">&#34;tcp6&#34;</span><span class="op" id="6125533">,</span>&nbsp;<span class="string" id="6125535">&#34;[::1]:0&#34;</span><span class="op" id="6125544">)</span><span class="op" id="6125545">;</span>&nbsp;<span class="ident" id="6125547">err</span>&nbsp;<span class="op" id="6125551">!=</span>&nbsp;<span class="builtintype" id="6125554">nil</span>&nbsp;<span class="op" id="6125558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6125563">panic</span><span class="op" id="6125568">(</span><span class="ident" id="6125569">fmt</span><span class="op" id="6125572">.</span><span class="ident" id="6125573">Sprintf</span><span class="op" id="6125580">(</span><span class="string" id="6125581">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="6125623">,</span>&nbsp;<span class="ident" id="6125625">err</span><span class="op" id="6125628">)</span><span class="op" id="6125629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125633">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125639">return</span>&nbsp;<span class="ident" id="6125646">l</span><br>
<span class="lineno"></span><span class="op" id="6125648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6125651">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="6125706">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6125732">//&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="6125790">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="6125858">var</span>&nbsp;<span class="ident" id="6125862">serve</span>&nbsp;<span class="op" id="6125868">=</span>&nbsp;<span class="ident" id="6125870">flag</span><span class="op" id="6125874">.</span><span class="ident" id="6125875">String</span><span class="op" id="6125881">(</span><span class="string" id="6125882">&#34;httptest.serve&#34;</span><span class="op" id="6125898">,</span>&nbsp;<span class="string" id="6125900">&#34;&#34;</span><span class="op" id="6125902">,</span>&nbsp;<span class="string" id="6125904">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="6125972">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="6125975">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="6126021">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6126085">func</span>&nbsp;<span class="ident" id="6126090">NewServer</span><span class="op" id="6126099">(</span><span class="ident" id="6126100">handler</span>&nbsp;<span class="ident" id="6126108">http</span><span class="op" id="6126112">.</span><span class="ident" id="6126113">Handler</span><span class="op" id="6126120">)</span>&nbsp;<span class="op" id="6126122">*</span><span class="ident" id="6126123">Server</span>&nbsp;<span class="op" id="6126130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126133">ts</span>&nbsp;<span class="op" id="6126136">:=</span>&nbsp;<span class="ident" id="6126139">NewUnstartedServer</span><span class="op" id="6126157">(</span><span class="ident" id="6126158">handler</span><span class="op" id="6126165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126168">ts</span><span class="op" id="6126170">.</span><span class="ident" id="6126171">Start</span><span class="op" id="6126176">(</span><span class="op" id="6126177">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6126180">return</span>&nbsp;<span class="ident" id="6126187">ts</span><br>
<span class="lineno"></span><span class="op" id="6126190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6126193">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6126258">//</span><br>
<span class="lineno">90</span><span class="comment" id="6126261">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6126330">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="6126343">//</span><br>
<span class="lineno"></span><span class="comment" id="6126346">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6126410">func</span>&nbsp;<span class="ident" id="6126415">NewUnstartedServer</span><span class="op" id="6126433">(</span><span class="ident" id="6126434">handler</span>&nbsp;<span class="ident" id="6126442">http</span><span class="op" id="6126446">.</span><span class="ident" id="6126447">Handler</span><span class="op" id="6126454">)</span>&nbsp;<span class="op" id="6126456">*</span><span class="ident" id="6126457">Server</span>&nbsp;<span class="op" id="6126464">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6126467">return</span>&nbsp;<span class="op" id="6126474">&amp;</span><span class="ident" id="6126475">Server</span><span class="op" id="6126481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126485">Listener</span><span class="op" id="6126493">:</span>&nbsp;<span class="ident" id="6126495">newLocalListener</span><span class="op" id="6126511">(</span><span class="op" id="6126512">)</span><span class="op" id="6126513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126517">Config</span><span class="op" id="6126523">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6126527">&amp;</span><span class="ident" id="6126528">http</span><span class="op" id="6126532">.</span><span class="ident" id="6126533">Server</span><span class="op" id="6126539">{</span><span class="ident" id="6126540">Handler</span><span class="op" id="6126547">:</span>&nbsp;<span class="ident" id="6126549">handler</span><span class="op" id="6126556">}</span><span class="op" id="6126557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6126560">}</span><br>
<span class="lineno"></span><span class="op" id="6126562">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6126565">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6126615">func</span>&nbsp;<span class="op" id="6126620">(</span><span class="ident" id="6126621">s</span>&nbsp;<span class="op" id="6126623">*</span><span class="ident" id="6126624">Server</span><span class="op" id="6126630">)</span>&nbsp;<span class="ident" id="6126632">Start</span><span class="op" id="6126637">(</span><span class="op" id="6126638">)</span>&nbsp;<span class="op" id="6126640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6126643">if</span>&nbsp;<span class="ident" id="6126646">s</span><span class="op" id="6126647">.</span><span class="ident" id="6126648">URL</span>&nbsp;<span class="op" id="6126652">!=</span>&nbsp;<span class="string" id="6126655">&#34;&#34;</span>&nbsp;<span class="op" id="6126658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6126662">panic</span><span class="op" id="6126667">(</span><span class="string" id="6126668">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6126692">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6126695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126698">s</span><span class="op" id="6126699">.</span><span class="ident" id="6126700">Listener</span>&nbsp;<span class="op" id="6126709">=</span>&nbsp;<span class="op" id="6126711">&amp;</span><span class="ident" id="6126712">historyListener</span><span class="op" id="6126727">{</span><span class="ident" id="6126728">Listener</span><span class="op" id="6126736">:</span>&nbsp;<span class="ident" id="6126738">s</span><span class="op" id="6126739">.</span><span class="ident" id="6126740">Listener</span><span class="op" id="6126748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126751">s</span><span class="op" id="6126752">.</span><span class="ident" id="6126753">URL</span>&nbsp;<span class="op" id="6126757">=</span>&nbsp;<span class="string" id="6126759">&#34;http://&#34;</span>&nbsp;<span class="op" id="6126769">+</span>&nbsp;<span class="ident" id="6126771">s</span><span class="op" id="6126772">.</span><span class="ident" id="6126773">Listener</span><span class="op" id="6126781">.</span><span class="ident" id="6126782">Addr</span><span class="op" id="6126786">(</span><span class="op" id="6126787">)</span><span class="op" id="6126788">.</span><span class="ident" id="6126789">String</span><span class="op" id="6126795">(</span><span class="op" id="6126796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126799">s</span><span class="op" id="6126800">.</span><span class="ident" id="6126801">wrapHandler</span><span class="op" id="6126812">(</span><span class="op" id="6126813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6126816">go</span>&nbsp;<span class="ident" id="6126819">s</span><span class="op" id="6126820">.</span><span class="ident" id="6126821">Config</span><span class="op" id="6126827">.</span><span class="ident" id="6126828">Serve</span><span class="op" id="6126833">(</span><span class="ident" id="6126834">s</span><span class="op" id="6126835">.</span><span class="ident" id="6126836">Listener</span><span class="op" id="6126844">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6126847">if</span>&nbsp;<span class="op" id="6126850">*</span><span class="ident" id="6126851">serve</span>&nbsp;<span class="op" id="6126857">!=</span>&nbsp;<span class="string" id="6126860">&#34;&#34;</span>&nbsp;<span class="op" id="6126863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126867">fmt</span><span class="op" id="6126870">.</span><span class="ident" id="6126871">Fprintln</span><span class="op" id="6126879">(</span><span class="ident" id="6126880">os</span><span class="op" id="6126882">.</span><span class="ident" id="6126883">Stderr</span><span class="op" id="6126889">,</span>&nbsp;<span class="string" id="6126891">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="6126913">,</span>&nbsp;<span class="ident" id="6126915">s</span><span class="op" id="6126916">.</span><span class="ident" id="6126917">URL</span><span class="op" id="6126920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6126924">select</span>&nbsp;<span class="op" id="6126931">{</span><span class="op" id="6126932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6126935">}</span><br>
<span class="lineno"></span><span class="op" id="6126937">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6126940">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6127000">func</span>&nbsp;<span class="op" id="6127005">(</span><span class="ident" id="6127006">s</span>&nbsp;<span class="op" id="6127008">*</span><span class="ident" id="6127009">Server</span><span class="op" id="6127015">)</span>&nbsp;<span class="ident" id="6127017">StartTLS</span><span class="op" id="6127025">(</span><span class="op" id="6127026">)</span>&nbsp;<span class="op" id="6127028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127031">if</span>&nbsp;<span class="ident" id="6127034">s</span><span class="op" id="6127035">.</span><span class="ident" id="6127036">URL</span>&nbsp;<span class="op" id="6127040">!=</span>&nbsp;<span class="string" id="6127043">&#34;&#34;</span>&nbsp;<span class="op" id="6127046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6127050">panic</span><span class="op" id="6127055">(</span><span class="string" id="6127056">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6127080">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127086">cert</span><span class="op" id="6127090">,</span>&nbsp;<span class="ident" id="6127092">err</span>&nbsp;<span class="op" id="6127096">:=</span>&nbsp;<span class="ident" id="6127099">tls</span><span class="op" id="6127102">.</span><span class="ident" id="6127103">X509KeyPair</span><span class="op" id="6127114">(</span><span class="ident" id="6127115">localhostCert</span><span class="op" id="6127128">,</span>&nbsp;<span class="ident" id="6127130">localhostKey</span><span class="op" id="6127142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127145">if</span>&nbsp;<span class="ident" id="6127148">err</span>&nbsp;<span class="op" id="6127152">!=</span>&nbsp;<span class="builtintype" id="6127155">nil</span>&nbsp;<span class="op" id="6127159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6127163">panic</span><span class="op" id="6127168">(</span><span class="ident" id="6127169">fmt</span><span class="op" id="6127172">.</span><span class="ident" id="6127173">Sprintf</span><span class="op" id="6127180">(</span><span class="string" id="6127181">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="6127209">,</span>&nbsp;<span class="ident" id="6127211">err</span><span class="op" id="6127214">)</span><span class="op" id="6127215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127218">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127222">existingConfig</span>&nbsp;<span class="op" id="6127237">:=</span>&nbsp;<span class="ident" id="6127240">s</span><span class="op" id="6127241">.</span><span class="ident" id="6127242">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127247">s</span><span class="op" id="6127248">.</span><span class="ident" id="6127249">TLS</span>&nbsp;<span class="op" id="6127253">=</span>&nbsp;<span class="builtinfunc" id="6127255">new</span><span class="op" id="6127258">(</span><span class="ident" id="6127259">tls</span><span class="op" id="6127262">.</span><span class="ident" id="6127263">Config</span><span class="op" id="6127269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127272">if</span>&nbsp;<span class="ident" id="6127275">existingConfig</span>&nbsp;<span class="op" id="6127290">!=</span>&nbsp;<span class="builtintype" id="6127293">nil</span>&nbsp;<span class="op" id="6127297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127301">*</span><span class="ident" id="6127302">s</span><span class="op" id="6127303">.</span><span class="ident" id="6127304">TLS</span>&nbsp;<span class="op" id="6127308">=</span>&nbsp;<span class="op" id="6127310">*</span><span class="ident" id="6127311">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127330">if</span>&nbsp;<span class="ident" id="6127333">s</span><span class="op" id="6127334">.</span><span class="ident" id="6127335">TLS</span><span class="op" id="6127338">.</span><span class="ident" id="6127339">NextProtos</span>&nbsp;<span class="op" id="6127350">==</span>&nbsp;<span class="builtintype" id="6127353">nil</span>&nbsp;<span class="op" id="6127357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127361">s</span><span class="op" id="6127362">.</span><span class="ident" id="6127363">TLS</span><span class="op" id="6127366">.</span><span class="ident" id="6127367">NextProtos</span>&nbsp;<span class="op" id="6127378">=</span>&nbsp;<span class="op" id="6127380">[</span><span class="op" id="6127381">]</span><span class="builtintype" id="6127382">string</span><span class="op" id="6127388">{</span><span class="string" id="6127389">&#34;http/1.1&#34;</span><span class="op" id="6127399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127405">if</span>&nbsp;<span class="builtinfunc" id="6127408">len</span><span class="op" id="6127411">(</span><span class="ident" id="6127412">s</span><span class="op" id="6127413">.</span><span class="ident" id="6127414">TLS</span><span class="op" id="6127417">.</span><span class="ident" id="6127418">Certificates</span><span class="op" id="6127430">)</span>&nbsp;<span class="op" id="6127432">==</span>&nbsp;<span class="num" id="6127435">0</span>&nbsp;<span class="op" id="6127437">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127441">s</span><span class="op" id="6127442">.</span><span class="ident" id="6127443">TLS</span><span class="op" id="6127446">.</span><span class="ident" id="6127447">Certificates</span>&nbsp;<span class="op" id="6127460">=</span>&nbsp;<span class="op" id="6127462">[</span><span class="op" id="6127463">]</span><span class="ident" id="6127464">tls</span><span class="op" id="6127467">.</span><span class="ident" id="6127468">Certificate</span><span class="op" id="6127479">{</span><span class="ident" id="6127480">cert</span><span class="op" id="6127484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127490">tlsListener</span>&nbsp;<span class="op" id="6127502">:=</span>&nbsp;<span class="ident" id="6127505">tls</span><span class="op" id="6127508">.</span><span class="ident" id="6127509">NewListener</span><span class="op" id="6127520">(</span><span class="ident" id="6127521">s</span><span class="op" id="6127522">.</span><span class="ident" id="6127523">Listener</span><span class="op" id="6127531">,</span>&nbsp;<span class="ident" id="6127533">s</span><span class="op" id="6127534">.</span><span class="ident" id="6127535">TLS</span><span class="op" id="6127538">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127542">s</span><span class="op" id="6127543">.</span><span class="ident" id="6127544">Listener</span>&nbsp;<span class="op" id="6127553">=</span>&nbsp;<span class="op" id="6127555">&amp;</span><span class="ident" id="6127556">historyListener</span><span class="op" id="6127571">{</span><span class="ident" id="6127572">Listener</span><span class="op" id="6127580">:</span>&nbsp;<span class="ident" id="6127582">tlsListener</span><span class="op" id="6127593">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127596">s</span><span class="op" id="6127597">.</span><span class="ident" id="6127598">URL</span>&nbsp;<span class="op" id="6127602">=</span>&nbsp;<span class="string" id="6127604">&#34;https://&#34;</span>&nbsp;<span class="op" id="6127615">+</span>&nbsp;<span class="ident" id="6127617">s</span><span class="op" id="6127618">.</span><span class="ident" id="6127619">Listener</span><span class="op" id="6127627">.</span><span class="ident" id="6127628">Addr</span><span class="op" id="6127632">(</span><span class="op" id="6127633">)</span><span class="op" id="6127634">.</span><span class="ident" id="6127635">String</span><span class="op" id="6127641">(</span><span class="op" id="6127642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127645">s</span><span class="op" id="6127646">.</span><span class="ident" id="6127647">wrapHandler</span><span class="op" id="6127658">(</span><span class="op" id="6127659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127662">go</span>&nbsp;<span class="ident" id="6127665">s</span><span class="op" id="6127666">.</span><span class="ident" id="6127667">Config</span><span class="op" id="6127673">.</span><span class="ident" id="6127674">Serve</span><span class="op" id="6127679">(</span><span class="ident" id="6127680">s</span><span class="op" id="6127681">.</span><span class="ident" id="6127682">Listener</span><span class="op" id="6127690">)</span><br>
<span class="lineno"></span><span class="op" id="6127692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6127695">func</span>&nbsp;<span class="op" id="6127700">(</span><span class="ident" id="6127701">s</span>&nbsp;<span class="op" id="6127703">*</span><span class="ident" id="6127704">Server</span><span class="op" id="6127710">)</span>&nbsp;<span class="ident" id="6127712">wrapHandler</span><span class="op" id="6127723">(</span><span class="op" id="6127724">)</span>&nbsp;<span class="op" id="6127726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127729">h</span>&nbsp;<span class="op" id="6127731">:=</span>&nbsp;<span class="ident" id="6127734">s</span><span class="op" id="6127735">.</span><span class="ident" id="6127736">Config</span><span class="op" id="6127742">.</span><span class="ident" id="6127743">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6127752">if</span>&nbsp;<span class="ident" id="6127755">h</span>&nbsp;<span class="op" id="6127757">==</span>&nbsp;<span class="builtintype" id="6127760">nil</span>&nbsp;<span class="op" id="6127764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127768">h</span>&nbsp;<span class="op" id="6127770">=</span>&nbsp;<span class="ident" id="6127772">http</span><span class="op" id="6127776">.</span><span class="ident" id="6127777">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127794">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127797">s</span><span class="op" id="6127798">.</span><span class="ident" id="6127799">Config</span><span class="op" id="6127805">.</span><span class="ident" id="6127806">Handler</span>&nbsp;<span class="op" id="6127814">=</span>&nbsp;<span class="op" id="6127816">&amp;</span><span class="ident" id="6127817">waitGroupHandler</span><span class="op" id="6127833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127837">s</span><span class="op" id="6127838">:</span>&nbsp;<span class="ident" id="6127840">s</span><span class="op" id="6127841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127845">h</span><span class="op" id="6127846">:</span>&nbsp;<span class="ident" id="6127848">h</span><span class="op" id="6127849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127852">}</span><br>
<span class="lineno"></span><span class="op" id="6127854">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6127857">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="6127916">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6127980">func</span>&nbsp;<span class="ident" id="6127985">NewTLSServer</span><span class="op" id="6127997">(</span><span class="ident" id="6127998">handler</span>&nbsp;<span class="ident" id="6128006">http</span><span class="op" id="6128010">.</span><span class="ident" id="6128011">Handler</span><span class="op" id="6128018">)</span>&nbsp;<span class="op" id="6128020">*</span><span class="ident" id="6128021">Server</span>&nbsp;<span class="op" id="6128028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128031">ts</span>&nbsp;<span class="op" id="6128034">:=</span>&nbsp;<span class="ident" id="6128037">NewUnstartedServer</span><span class="op" id="6128055">(</span><span class="ident" id="6128056">handler</span><span class="op" id="6128063">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128066">ts</span><span class="op" id="6128068">.</span><span class="ident" id="6128069">StartTLS</span><span class="op" id="6128077">(</span><span class="op" id="6128078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6128081">return</span>&nbsp;<span class="ident" id="6128088">ts</span><br>
<span class="lineno"></span><span class="op" id="6128091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128094">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="6128158">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="6128201">func</span>&nbsp;<span class="op" id="6128206">(</span><span class="ident" id="6128207">s</span>&nbsp;<span class="op" id="6128209">*</span><span class="ident" id="6128210">Server</span><span class="op" id="6128216">)</span>&nbsp;<span class="ident" id="6128218">Close</span><span class="op" id="6128223">(</span><span class="op" id="6128224">)</span>&nbsp;<span class="op" id="6128226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128229">s</span><span class="op" id="6128230">.</span><span class="ident" id="6128231">Listener</span><span class="op" id="6128239">.</span><span class="ident" id="6128240">Close</span><span class="op" id="6128245">(</span><span class="op" id="6128246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128249">s</span><span class="op" id="6128250">.</span><span class="ident" id="6128251">wg</span><span class="op" id="6128253">.</span><span class="ident" id="6128254">Wait</span><span class="op" id="6128258">(</span><span class="op" id="6128259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128262">s</span><span class="op" id="6128263">.</span><span class="ident" id="6128264">CloseClientConnections</span><span class="op" id="6128286">(</span><span class="op" id="6128287">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6128290">if</span>&nbsp;<span class="ident" id="6128293">t</span><span class="op" id="6128294">,</span>&nbsp;<span class="ident" id="6128296">ok</span>&nbsp;<span class="op" id="6128299">:=</span>&nbsp;<span class="ident" id="6128302">http</span><span class="op" id="6128306">.</span><span class="ident" id="6128307">DefaultTransport</span><span class="op" id="6128323">.</span><span class="op" id="6128324">(</span><span class="op" id="6128325">*</span><span class="ident" id="6128326">http</span><span class="op" id="6128330">.</span><span class="ident" id="6128331">Transport</span><span class="op" id="6128340">)</span><span class="op" id="6128341">;</span>&nbsp;<span class="ident" id="6128343">ok</span>&nbsp;<span class="op" id="6128346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128350">t</span><span class="op" id="6128351">.</span><span class="ident" id="6128352">CloseIdleConnections</span><span class="op" id="6128372">(</span><span class="op" id="6128373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6128376">}</span><br>
<span class="lineno"></span><span class="op" id="6128378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6128381">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="6128450">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="6128473">func</span>&nbsp;<span class="op" id="6128478">(</span><span class="ident" id="6128479">s</span>&nbsp;<span class="op" id="6128481">*</span><span class="ident" id="6128482">Server</span><span class="op" id="6128488">)</span>&nbsp;<span class="ident" id="6128490">CloseClientConnections</span><span class="op" id="6128512">(</span><span class="op" id="6128513">)</span>&nbsp;<span class="op" id="6128515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128518">hl</span><span class="op" id="6128520">,</span>&nbsp;<span class="ident" id="6128522">ok</span>&nbsp;<span class="op" id="6128525">:=</span>&nbsp;<span class="ident" id="6128528">s</span><span class="op" id="6128529">.</span><span class="ident" id="6128530">Listener</span><span class="op" id="6128538">.</span><span class="op" id="6128539">(</span><span class="op" id="6128540">*</span><span class="ident" id="6128541">historyListener</span><span class="op" id="6128556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6128559">if</span>&nbsp;<span class="op" id="6128562">!</span><span class="ident" id="6128563">ok</span>&nbsp;<span class="op" id="6128566">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6128570">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6128578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128581">hl</span><span class="op" id="6128583">.</span><span class="ident" id="6128584">Lock</span><span class="op" id="6128588">(</span><span class="op" id="6128589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6128592">for</span>&nbsp;<span class="ident" id="6128596">_</span><span class="op" id="6128597">,</span>&nbsp;<span class="ident" id="6128599">conn</span>&nbsp;<span class="op" id="6128604">:=</span>&nbsp;<span class="keyword" id="6128607">range</span>&nbsp;<span class="ident" id="6128613">hl</span><span class="op" id="6128615">.</span><span class="ident" id="6128616">history</span>&nbsp;<span class="op" id="6128624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128628">conn</span><span class="op" id="6128632">.</span><span class="ident" id="6128633">Close</span><span class="op" id="6128638">(</span><span class="op" id="6128639">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6128642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128645">hl</span><span class="op" id="6128647">.</span><span class="ident" id="6128648">Unlock</span><span class="op" id="6128654">(</span><span class="op" id="6128655">)</span><br>
<span class="lineno"></span><span class="op" id="6128657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128660">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="6128729">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="6128796">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="6128840">type</span>&nbsp;<span class="ident" id="6128845">waitGroupHandler</span>&nbsp;<span class="keyword" id="6128862">struct</span>&nbsp;<span class="op" id="6128869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128872">s</span>&nbsp;<span class="op" id="6128874">*</span><span class="ident" id="6128875">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128883">h</span>&nbsp;<span class="ident" id="6128885">http</span><span class="op" id="6128889">.</span><span class="ident" id="6128890">Handler</span>&nbsp;<span class="comment" id="6128898">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="6128909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6128912">func</span>&nbsp;<span class="op" id="6128917">(</span><span class="ident" id="6128918">h</span>&nbsp;<span class="op" id="6128920">*</span><span class="ident" id="6128921">waitGroupHandler</span><span class="op" id="6128937">)</span>&nbsp;<span class="ident" id="6128939">ServeHTTP</span><span class="op" id="6128948">(</span><span class="ident" id="6128949">w</span>&nbsp;<span class="ident" id="6128951">http</span><span class="op" id="6128955">.</span><span class="ident" id="6128956">ResponseWriter</span><span class="op" id="6128970">,</span>&nbsp;<span class="ident" id="6128972">r</span>&nbsp;<span class="op" id="6128974">*</span><span class="ident" id="6128975">http</span><span class="op" id="6128979">.</span><span class="ident" id="6128980">Request</span><span class="op" id="6128987">)</span>&nbsp;<span class="op" id="6128989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6128992">h</span><span class="op" id="6128993">.</span><span class="ident" id="6128994">s</span><span class="op" id="6128995">.</span><span class="ident" id="6128996">wg</span><span class="op" id="6128998">.</span><span class="ident" id="6128999">Add</span><span class="op" id="6129002">(</span><span class="num" id="6129003">1</span><span class="op" id="6129004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6129007">defer</span>&nbsp;<span class="ident" id="6129013">h</span><span class="op" id="6129014">.</span><span class="ident" id="6129015">s</span><span class="op" id="6129016">.</span><span class="ident" id="6129017">wg</span><span class="op" id="6129019">.</span><span class="ident" id="6129020">Done</span><span class="op" id="6129024">(</span><span class="op" id="6129025">)</span>&nbsp;<span class="comment" id="6129027">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6129071">h</span><span class="op" id="6129072">.</span><span class="ident" id="6129073">h</span><span class="op" id="6129074">.</span><span class="ident" id="6129075">ServeHTTP</span><span class="op" id="6129084">(</span><span class="ident" id="6129085">w</span><span class="op" id="6129086">,</span>&nbsp;<span class="ident" id="6129088">r</span><span class="op" id="6129089">)</span><br>
<span class="lineno"></span><span class="op" id="6129091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6129094">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="6129150">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="6129223">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6129242">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6129276">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6129412">var</span>&nbsp;<span class="ident" id="6129416">localhostCert</span>&nbsp;<span class="op" id="6129430">=</span>&nbsp;<span class="op" id="6129432">[</span><span class="op" id="6129433">]</span><span class="builtintype" id="6129434">byte</span><span class="op" id="6129438">(</span><span class="string" id="6129439">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6130010">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6130013">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="6130067">var</span>&nbsp;<span class="ident" id="6130071">localhostKey</span>&nbsp;<span class="op" id="6130084">=</span>&nbsp;<span class="op" id="6130086">[</span><span class="op" id="6130087">]</span><span class="builtintype" id="6130088">byte</span><span class="op" id="6130092">(</span><span class="string" id="6130093">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6130591">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
