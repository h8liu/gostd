<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1449248">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1449303">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1449357">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1449408">package</span>&nbsp;<span class="ident" id="1449416">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1449422">import</span>&nbsp;<span class="op" id="1449429">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1449432">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1449447">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1449456">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1449459">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1449522">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1449575">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1449631">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1449688">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1449753">type</span>&nbsp;<span class="ident" id="1449758">WaitGroup</span>&nbsp;<span class="keyword" id="1449768">struct</span>&nbsp;<span class="op" id="1449775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449778">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449786">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449793">counter</span>&nbsp;<span class="builtintype" id="1449801">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449808">waiters</span>&nbsp;<span class="builtintype" id="1449816">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449823">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449831">*</span><span class="builtintype" id="1449832">uint32</span><br>
<span class="lineno"></span><span class="op" id="1449839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1449842">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1449907">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1449960">//</span><br>
<span class="lineno"></span><span class="comment" id="1449963">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1449977">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1449992">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1450064">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1450145">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1450211">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1450262">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1450277">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1450352">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1450420">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1450497">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1450542">//</span><br>
<span class="lineno">40</span><span class="comment" id="1450545">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1450622">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1450697">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1450776">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1450792">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1450869">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1450928">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1450958">func</span>&nbsp;<span class="op" id="1450963">(</span><span class="ident" id="1450964">wg</span>&nbsp;<span class="op" id="1450967">*</span><span class="ident" id="1450968">WaitGroup</span><span class="op" id="1450977">)</span>&nbsp;<span class="ident" id="1450979">Add</span><span class="op" id="1450982">(</span><span class="ident" id="1450983">delta</span>&nbsp;<span class="builtintype" id="1450989">int</span><span class="op" id="1450992">)</span>&nbsp;<span class="op" id="1450994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450997">if</span>&nbsp;<span class="ident" id="1451000">raceenabled</span>&nbsp;<span class="op" id="1451012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451016">_</span>&nbsp;<span class="op" id="1451018">=</span>&nbsp;<span class="ident" id="1451020">wg</span><span class="op" id="1451022">.</span><span class="ident" id="1451023">m</span><span class="op" id="1451024">.</span><span class="ident" id="1451025">state</span>&nbsp;<span class="comment" id="1451031">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451060">if</span>&nbsp;<span class="ident" id="1451063">delta</span>&nbsp;<span class="op" id="1451069">&lt;</span>&nbsp;<span class="num" id="1451071">0</span>&nbsp;<span class="op" id="1451073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451078">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451118">raceReleaseMerge</span><span class="op" id="1451134">(</span><span class="ident" id="1451135">unsafe</span><span class="op" id="1451141">.</span><span class="ident" id="1451142">Pointer</span><span class="op" id="1451149">(</span><span class="ident" id="1451150">wg</span><span class="op" id="1451152">)</span><span class="op" id="1451153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451161">raceDisable</span><span class="op" id="1451172">(</span><span class="op" id="1451173">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451177">defer</span>&nbsp;<span class="ident" id="1451183">raceEnable</span><span class="op" id="1451193">(</span><span class="op" id="1451194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451200">v</span>&nbsp;<span class="op" id="1451202">:=</span>&nbsp;<span class="ident" id="1451205">atomic</span><span class="op" id="1451211">.</span><span class="ident" id="1451212">AddInt32</span><span class="op" id="1451220">(</span><span class="op" id="1451221">&amp;</span><span class="ident" id="1451222">wg</span><span class="op" id="1451224">.</span><span class="ident" id="1451225">counter</span><span class="op" id="1451232">,</span>&nbsp;<span class="builtintype" id="1451234">int32</span><span class="op" id="1451239">(</span><span class="ident" id="1451240">delta</span><span class="op" id="1451245">)</span><span class="op" id="1451246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451249">if</span>&nbsp;<span class="ident" id="1451252">raceenabled</span>&nbsp;<span class="op" id="1451264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451268">if</span>&nbsp;<span class="ident" id="1451271">delta</span>&nbsp;<span class="op" id="1451277">&gt;</span>&nbsp;<span class="num" id="1451279">0</span>&nbsp;<span class="op" id="1451281">&amp;&amp;</span>&nbsp;<span class="ident" id="1451284">v</span>&nbsp;<span class="op" id="1451286">==</span>&nbsp;<span class="builtintype" id="1451289">int32</span><span class="op" id="1451294">(</span><span class="ident" id="1451295">delta</span><span class="op" id="1451300">)</span>&nbsp;<span class="op" id="1451302">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451307">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451365">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451422">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451478">raceRead</span><span class="op" id="1451486">(</span><span class="ident" id="1451487">unsafe</span><span class="op" id="1451493">.</span><span class="ident" id="1451494">Pointer</span><span class="op" id="1451501">(</span><span class="op" id="1451502">&amp;</span><span class="ident" id="1451503">wg</span><span class="op" id="1451505">.</span><span class="ident" id="1451506">sema</span><span class="op" id="1451510">)</span><span class="op" id="1451511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451515">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451521">if</span>&nbsp;<span class="ident" id="1451524">v</span>&nbsp;<span class="op" id="1451526">&lt;</span>&nbsp;<span class="num" id="1451528">0</span>&nbsp;<span class="op" id="1451530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1451534">panic</span><span class="op" id="1451539">(</span><span class="string" id="1451540">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1451574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451580">if</span>&nbsp;<span class="ident" id="1451583">v</span>&nbsp;<span class="op" id="1451585">&gt;</span>&nbsp;<span class="num" id="1451587">0</span>&nbsp;<span class="op" id="1451589">||</span>&nbsp;<span class="ident" id="1451592">atomic</span><span class="op" id="1451598">.</span><span class="ident" id="1451599">LoadInt32</span><span class="op" id="1451608">(</span><span class="op" id="1451609">&amp;</span><span class="ident" id="1451610">wg</span><span class="op" id="1451612">.</span><span class="ident" id="1451613">waiters</span><span class="op" id="1451620">)</span>&nbsp;<span class="op" id="1451622">==</span>&nbsp;<span class="num" id="1451625">0</span>&nbsp;<span class="op" id="1451627">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451631">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451642">wg</span><span class="op" id="1451644">.</span><span class="ident" id="1451645">m</span><span class="op" id="1451646">.</span><span class="ident" id="1451647">Lock</span><span class="op" id="1451651">(</span><span class="op" id="1451652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451655">if</span>&nbsp;<span class="ident" id="1451658">atomic</span><span class="op" id="1451664">.</span><span class="ident" id="1451665">LoadInt32</span><span class="op" id="1451674">(</span><span class="op" id="1451675">&amp;</span><span class="ident" id="1451676">wg</span><span class="op" id="1451678">.</span><span class="ident" id="1451679">counter</span><span class="op" id="1451686">)</span>&nbsp;<span class="op" id="1451688">==</span>&nbsp;<span class="num" id="1451691">0</span>&nbsp;<span class="op" id="1451693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451697">for</span>&nbsp;<span class="ident" id="1451701">i</span>&nbsp;<span class="op" id="1451703">:=</span>&nbsp;<span class="builtintype" id="1451706">int32</span><span class="op" id="1451711">(</span><span class="num" id="1451712">0</span><span class="op" id="1451713">)</span><span class="op" id="1451714">;</span>&nbsp;<span class="ident" id="1451716">i</span>&nbsp;<span class="op" id="1451718">&lt;</span>&nbsp;<span class="ident" id="1451720">wg</span><span class="op" id="1451722">.</span><span class="ident" id="1451723">waiters</span><span class="op" id="1451730">;</span>&nbsp;<span class="ident" id="1451732">i</span><span class="op" id="1451733">++</span>&nbsp;<span class="op" id="1451736">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451741">runtime_Semrelease</span><span class="op" id="1451759">(</span><span class="ident" id="1451760">wg</span><span class="op" id="1451762">.</span><span class="ident" id="1451763">sema</span><span class="op" id="1451767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451775">wg</span><span class="op" id="1451777">.</span><span class="ident" id="1451778">waiters</span>&nbsp;<span class="op" id="1451786">=</span>&nbsp;<span class="num" id="1451788">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451792">wg</span><span class="op" id="1451794">.</span><span class="ident" id="1451795">sema</span>&nbsp;<span class="op" id="1451800">=</span>&nbsp;<span class="ident" id="1451802">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451807">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451810">wg</span><span class="op" id="1451812">.</span><span class="ident" id="1451813">m</span><span class="op" id="1451814">.</span><span class="ident" id="1451815">Unlock</span><span class="op" id="1451821">(</span><span class="op" id="1451822">)</span><br>
<span class="lineno"></span><span class="op" id="1451824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451827">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1451869">func</span>&nbsp;<span class="op" id="1451874">(</span><span class="ident" id="1451875">wg</span>&nbsp;<span class="op" id="1451878">*</span><span class="ident" id="1451879">WaitGroup</span><span class="op" id="1451888">)</span>&nbsp;<span class="ident" id="1451890">Done</span><span class="op" id="1451894">(</span><span class="op" id="1451895">)</span>&nbsp;<span class="op" id="1451897">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451900">wg</span><span class="op" id="1451902">.</span><span class="ident" id="1451903">Add</span><span class="op" id="1451906">(</span><span class="op" id="1451907">-</span><span class="num" id="1451908">1</span><span class="op" id="1451909">)</span><br>
<span class="lineno"></span><span class="op" id="1451911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451914">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1451966">func</span>&nbsp;<span class="op" id="1451971">(</span><span class="ident" id="1451972">wg</span>&nbsp;<span class="op" id="1451975">*</span><span class="ident" id="1451976">WaitGroup</span><span class="op" id="1451985">)</span>&nbsp;<span class="ident" id="1451987">Wait</span><span class="op" id="1451991">(</span><span class="op" id="1451992">)</span>&nbsp;<span class="op" id="1451994">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451997">if</span>&nbsp;<span class="ident" id="1452000">raceenabled</span>&nbsp;<span class="op" id="1452012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452016">_</span>&nbsp;<span class="op" id="1452018">=</span>&nbsp;<span class="ident" id="1452020">wg</span><span class="op" id="1452022">.</span><span class="ident" id="1452023">m</span><span class="op" id="1452024">.</span><span class="ident" id="1452025">state</span>&nbsp;<span class="comment" id="1452031">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452060">raceDisable</span><span class="op" id="1452071">(</span><span class="op" id="1452072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452078">if</span>&nbsp;<span class="ident" id="1452081">atomic</span><span class="op" id="1452087">.</span><span class="ident" id="1452088">LoadInt32</span><span class="op" id="1452097">(</span><span class="op" id="1452098">&amp;</span><span class="ident" id="1452099">wg</span><span class="op" id="1452101">.</span><span class="ident" id="1452102">counter</span><span class="op" id="1452109">)</span>&nbsp;<span class="op" id="1452111">==</span>&nbsp;<span class="num" id="1452114">0</span>&nbsp;<span class="op" id="1452116">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452120">if</span>&nbsp;<span class="ident" id="1452123">raceenabled</span>&nbsp;<span class="op" id="1452135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452140">raceEnable</span><span class="op" id="1452150">(</span><span class="op" id="1452151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452156">raceAcquire</span><span class="op" id="1452167">(</span><span class="ident" id="1452168">unsafe</span><span class="op" id="1452174">.</span><span class="ident" id="1452175">Pointer</span><span class="op" id="1452182">(</span><span class="ident" id="1452183">wg</span><span class="op" id="1452185">)</span><span class="op" id="1452186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452194">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452205">wg</span><span class="op" id="1452207">.</span><span class="ident" id="1452208">m</span><span class="op" id="1452209">.</span><span class="ident" id="1452210">Lock</span><span class="op" id="1452214">(</span><span class="op" id="1452215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452218">w</span>&nbsp;<span class="op" id="1452220">:=</span>&nbsp;<span class="ident" id="1452223">atomic</span><span class="op" id="1452229">.</span><span class="ident" id="1452230">AddInt32</span><span class="op" id="1452238">(</span><span class="op" id="1452239">&amp;</span><span class="ident" id="1452240">wg</span><span class="op" id="1452242">.</span><span class="ident" id="1452243">waiters</span><span class="op" id="1452250">,</span>&nbsp;<span class="num" id="1452252">1</span><span class="op" id="1452253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452256">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452317">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452377">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452447">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452476">if</span>&nbsp;<span class="ident" id="1452479">atomic</span><span class="op" id="1452485">.</span><span class="ident" id="1452486">LoadInt32</span><span class="op" id="1452495">(</span><span class="op" id="1452496">&amp;</span><span class="ident" id="1452497">wg</span><span class="op" id="1452499">.</span><span class="ident" id="1452500">counter</span><span class="op" id="1452507">)</span>&nbsp;<span class="op" id="1452509">==</span>&nbsp;<span class="num" id="1452512">0</span>&nbsp;<span class="op" id="1452514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452518">atomic</span><span class="op" id="1452524">.</span><span class="ident" id="1452525">AddInt32</span><span class="op" id="1452533">(</span><span class="op" id="1452534">&amp;</span><span class="ident" id="1452535">wg</span><span class="op" id="1452537">.</span><span class="ident" id="1452538">waiters</span><span class="op" id="1452545">,</span>&nbsp;<span class="op" id="1452547">-</span><span class="num" id="1452548">1</span><span class="op" id="1452549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452553">if</span>&nbsp;<span class="ident" id="1452556">raceenabled</span>&nbsp;<span class="op" id="1452568">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452573">raceEnable</span><span class="op" id="1452583">(</span><span class="op" id="1452584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452589">raceAcquire</span><span class="op" id="1452600">(</span><span class="ident" id="1452601">unsafe</span><span class="op" id="1452607">.</span><span class="ident" id="1452608">Pointer</span><span class="op" id="1452615">(</span><span class="ident" id="1452616">wg</span><span class="op" id="1452618">)</span><span class="op" id="1452619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452624">raceDisable</span><span class="op" id="1452635">(</span><span class="op" id="1452636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452644">wg</span><span class="op" id="1452646">.</span><span class="ident" id="1452647">m</span><span class="op" id="1452648">.</span><span class="ident" id="1452649">Unlock</span><span class="op" id="1452655">(</span><span class="op" id="1452656">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452660">if</span>&nbsp;<span class="ident" id="1452663">raceenabled</span>&nbsp;<span class="op" id="1452675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452680">raceEnable</span><span class="op" id="1452690">(</span><span class="op" id="1452691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452699">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452707">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452710">if</span>&nbsp;<span class="ident" id="1452713">raceenabled</span>&nbsp;<span class="op" id="1452725">&amp;&amp;</span>&nbsp;<span class="ident" id="1452728">w</span>&nbsp;<span class="op" id="1452730">==</span>&nbsp;<span class="num" id="1452733">1</span>&nbsp;<span class="op" id="1452735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452739">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452790">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452858">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452925">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452984">raceWrite</span><span class="op" id="1452993">(</span><span class="ident" id="1452994">unsafe</span><span class="op" id="1453000">.</span><span class="ident" id="1453001">Pointer</span><span class="op" id="1453008">(</span><span class="op" id="1453009">&amp;</span><span class="ident" id="1453010">wg</span><span class="op" id="1453012">.</span><span class="ident" id="1453013">sema</span><span class="op" id="1453017">)</span><span class="op" id="1453018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453024">if</span>&nbsp;<span class="ident" id="1453027">wg</span><span class="op" id="1453029">.</span><span class="ident" id="1453030">sema</span>&nbsp;<span class="op" id="1453035">==</span>&nbsp;<span class="ident" id="1453038">nil</span>&nbsp;<span class="op" id="1453042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453046">wg</span><span class="op" id="1453048">.</span><span class="ident" id="1453049">sema</span>&nbsp;<span class="op" id="1453054">=</span>&nbsp;<span class="builtinfunc" id="1453056">new</span><span class="op" id="1453059">(</span><span class="builtintype" id="1453060">uint32</span><span class="op" id="1453066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453069">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453072">s</span>&nbsp;<span class="op" id="1453074">:=</span>&nbsp;<span class="ident" id="1453077">wg</span><span class="op" id="1453079">.</span><span class="ident" id="1453080">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453086">wg</span><span class="op" id="1453088">.</span><span class="ident" id="1453089">m</span><span class="op" id="1453090">.</span><span class="ident" id="1453091">Unlock</span><span class="op" id="1453097">(</span><span class="op" id="1453098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453101">runtime_Semacquire</span><span class="op" id="1453119">(</span><span class="ident" id="1453120">s</span><span class="op" id="1453121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453124">if</span>&nbsp;<span class="ident" id="1453127">raceenabled</span>&nbsp;<span class="op" id="1453139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453143">raceEnable</span><span class="op" id="1453153">(</span><span class="op" id="1453154">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453158">raceAcquire</span><span class="op" id="1453169">(</span><span class="ident" id="1453170">unsafe</span><span class="op" id="1453176">.</span><span class="ident" id="1453177">Pointer</span><span class="op" id="1453184">(</span><span class="ident" id="1453185">wg</span><span class="op" id="1453187">)</span><span class="op" id="1453188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453191">}</span><br>
<span class="lineno"></span><span class="op" id="1453193">}</span>
</div>
</body>
</html>
