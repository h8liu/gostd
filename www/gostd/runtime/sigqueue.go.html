<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1664670">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1664725">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1664779">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1664830">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1664891">//</span><br>
<span class="lineno"></span><span class="comment" id="1664894">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1664952">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1665023">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1665082">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1665108">//</span><br>
<span class="lineno"></span><span class="comment" id="1665111">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1665177">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1665254">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1665331">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1665406">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1665485">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1665509">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1665578">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1665625">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1665712">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1665772">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1665848">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1665924">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1665998">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1666017">package</span>&nbsp;<span class="ident" id="1666025">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1666034">import</span>&nbsp;<span class="string" id="1666041">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1666051">var</span>&nbsp;<span class="ident" id="1666055">sig</span>&nbsp;<span class="keyword" id="1666059">struct</span>&nbsp;<span class="op" id="1666066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666069">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1666076">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666082">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1666089">[</span><span class="op" id="1666090">(</span><span class="ident" id="1666091">_NSIG</span>&nbsp;<span class="op" id="1666097">+</span>&nbsp;<span class="num" id="1666099">31</span><span class="op" id="1666101">)</span>&nbsp;<span class="op" id="1666103">/</span>&nbsp;<span class="num" id="1666105">32</span><span class="op" id="1666107">]</span><span class="builtintype" id="1666108">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666116">wanted</span>&nbsp;<span class="op" id="1666123">[</span><span class="op" id="1666124">(</span><span class="ident" id="1666125">_NSIG</span>&nbsp;<span class="op" id="1666131">+</span>&nbsp;<span class="num" id="1666133">31</span><span class="op" id="1666135">)</span>&nbsp;<span class="op" id="1666137">/</span>&nbsp;<span class="num" id="1666139">32</span><span class="op" id="1666141">]</span><span class="builtintype" id="1666142">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666150">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1666157">[</span><span class="op" id="1666158">(</span><span class="ident" id="1666159">_NSIG</span>&nbsp;<span class="op" id="1666165">+</span>&nbsp;<span class="num" id="1666167">31</span><span class="op" id="1666169">)</span>&nbsp;<span class="op" id="1666171">/</span>&nbsp;<span class="num" id="1666173">32</span><span class="op" id="1666175">]</span><span class="builtintype" id="1666176">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666184">state</span>&nbsp;&nbsp;<span class="builtintype" id="1666191">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666199">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1666206">bool</span><br>
<span class="lineno"></span><span class="op" id="1666211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1666214">const</span>&nbsp;<span class="op" id="1666220">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666223">sigIdle</span>&nbsp;<span class="op" id="1666231">=</span>&nbsp;<span class="ident" id="1666233">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666239">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666253">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1666264">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1666267">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1666350">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1666440">func</span>&nbsp;<span class="ident" id="1666445">sigsend</span><span class="op" id="1666452">(</span><span class="ident" id="1666453">s</span>&nbsp;<span class="builtintype" id="1666455">int32</span><span class="op" id="1666460">)</span>&nbsp;<span class="builtintype" id="1666462">bool</span>&nbsp;<span class="op" id="1666467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666470">bit</span>&nbsp;<span class="op" id="1666474">:=</span>&nbsp;<span class="builtintype" id="1666477">uint32</span><span class="op" id="1666483">(</span><span class="num" id="1666484">1</span><span class="op" id="1666485">)</span>&nbsp;<span class="op" id="1666487">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1666490">uint</span><span class="op" id="1666494">(</span><span class="ident" id="1666495">s</span><span class="op" id="1666496">&amp;</span><span class="num" id="1666497">31</span><span class="op" id="1666499">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666502">if</span>&nbsp;<span class="op" id="1666505">!</span><span class="ident" id="1666506">sig</span><span class="op" id="1666509">.</span><span class="ident" id="1666510">inuse</span>&nbsp;<span class="op" id="1666516">||</span>&nbsp;<span class="ident" id="1666519">s</span>&nbsp;<span class="op" id="1666521">&lt;</span>&nbsp;<span class="num" id="1666523">0</span>&nbsp;<span class="op" id="1666525">||</span>&nbsp;<span class="builtintype" id="1666528">int</span><span class="op" id="1666531">(</span><span class="ident" id="1666532">s</span><span class="op" id="1666533">)</span>&nbsp;<span class="op" id="1666535">&gt;=</span>&nbsp;<span class="num" id="1666538">32</span><span class="op" id="1666540">*</span><span class="builtinfunc" id="1666541">len</span><span class="op" id="1666544">(</span><span class="ident" id="1666545">sig</span><span class="op" id="1666548">.</span><span class="ident" id="1666549">wanted</span><span class="op" id="1666555">)</span>&nbsp;<span class="op" id="1666557">||</span>&nbsp;<span class="ident" id="1666560">sig</span><span class="op" id="1666563">.</span><span class="ident" id="1666564">wanted</span><span class="op" id="1666570">[</span><span class="ident" id="1666571">s</span><span class="op" id="1666572">/</span><span class="num" id="1666573">32</span><span class="op" id="1666575">]</span><span class="op" id="1666576">&amp;</span><span class="ident" id="1666577">bit</span>&nbsp;<span class="op" id="1666581">==</span>&nbsp;<span class="num" id="1666584">0</span>&nbsp;<span class="op" id="1666586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666590">return</span>&nbsp;<span class="builtintype" id="1666597">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1666608">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666642">for</span>&nbsp;<span class="op" id="1666646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666650">mask</span>&nbsp;<span class="op" id="1666655">:=</span>&nbsp;<span class="ident" id="1666658">sig</span><span class="op" id="1666661">.</span><span class="ident" id="1666662">mask</span><span class="op" id="1666666">[</span><span class="ident" id="1666667">s</span><span class="op" id="1666668">/</span><span class="num" id="1666669">32</span><span class="op" id="1666671">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666675">if</span>&nbsp;<span class="ident" id="1666678">mask</span><span class="op" id="1666682">&amp;</span><span class="ident" id="1666683">bit</span>&nbsp;<span class="op" id="1666687">!=</span>&nbsp;<span class="num" id="1666690">0</span>&nbsp;<span class="op" id="1666692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666697">return</span>&nbsp;<span class="builtintype" id="1666704">true</span>&nbsp;<span class="comment" id="1666709">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666738">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666742">if</span>&nbsp;<span class="ident" id="1666745">cas</span><span class="op" id="1666748">(</span><span class="op" id="1666749">&amp;</span><span class="ident" id="1666750">sig</span><span class="op" id="1666753">.</span><span class="ident" id="1666754">mask</span><span class="op" id="1666758">[</span><span class="ident" id="1666759">s</span><span class="op" id="1666760">/</span><span class="num" id="1666761">32</span><span class="op" id="1666763">]</span><span class="op" id="1666764">,</span>&nbsp;<span class="ident" id="1666766">mask</span><span class="op" id="1666770">,</span>&nbsp;<span class="ident" id="1666772">mask</span><span class="op" id="1666776">|</span><span class="ident" id="1666777">bit</span><span class="op" id="1666780">)</span>&nbsp;<span class="op" id="1666782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666787">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1666798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1666802">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1666845">Send</span><span class="op" id="1666849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666852">for</span>&nbsp;<span class="op" id="1666856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666860">switch</span>&nbsp;<span class="ident" id="1666867">atomicload</span><span class="op" id="1666877">(</span><span class="op" id="1666878">&amp;</span><span class="ident" id="1666879">sig</span><span class="op" id="1666882">.</span><span class="ident" id="1666883">state</span><span class="op" id="1666888">)</span>&nbsp;<span class="op" id="1666890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666894">default</span><span class="op" id="1666901">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1666906">gothrow</span><span class="op" id="1666913">(</span><span class="string" id="1666914">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1666943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666947">case</span>&nbsp;<span class="ident" id="1666952">sigIdle</span><span class="op" id="1666959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1666964">if</span>&nbsp;<span class="ident" id="1666967">cas</span><span class="op" id="1666970">(</span><span class="op" id="1666971">&amp;</span><span class="ident" id="1666972">sig</span><span class="op" id="1666975">.</span><span class="ident" id="1666976">state</span><span class="op" id="1666981">,</span>&nbsp;<span class="ident" id="1666983">sigIdle</span><span class="op" id="1666990">,</span>&nbsp;<span class="ident" id="1666992">sigSending</span><span class="op" id="1667002">)</span>&nbsp;<span class="op" id="1667004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667010">break</span>&nbsp;<span class="ident" id="1667016">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667024">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667028">case</span>&nbsp;<span class="ident" id="1667033">sigSending</span><span class="op" id="1667043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667048">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667083">break</span>&nbsp;<span class="ident" id="1667089">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667096">case</span>&nbsp;<span class="ident" id="1667101">sigReceiving</span><span class="op" id="1667113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667118">if</span>&nbsp;<span class="ident" id="1667121">cas</span><span class="op" id="1667124">(</span><span class="op" id="1667125">&amp;</span><span class="ident" id="1667126">sig</span><span class="op" id="1667129">.</span><span class="ident" id="1667130">state</span><span class="op" id="1667135">,</span>&nbsp;<span class="ident" id="1667137">sigReceiving</span><span class="op" id="1667149">,</span>&nbsp;<span class="ident" id="1667151">sigIdle</span><span class="op" id="1667158">)</span>&nbsp;<span class="op" id="1667160">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667166">notewakeup</span><span class="op" id="1667176">(</span><span class="op" id="1667177">&amp;</span><span class="ident" id="1667178">sig</span><span class="op" id="1667181">.</span><span class="ident" id="1667182">note</span><span class="op" id="1667186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667192">break</span>&nbsp;<span class="ident" id="1667198">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667213">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667217">return</span>&nbsp;<span class="builtintype" id="1667224">true</span><br>
<span class="lineno"></span><span class="op" id="1667229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1667232">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1667277">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1667335">func</span>&nbsp;<span class="ident" id="1667340">signal_recv</span><span class="op" id="1667351">(</span><span class="op" id="1667352">)</span>&nbsp;<span class="builtintype" id="1667354">uint32</span>&nbsp;<span class="op" id="1667361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667364">for</span>&nbsp;<span class="op" id="1667368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667372">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667412">for</span>&nbsp;<span class="ident" id="1667416">i</span>&nbsp;<span class="op" id="1667418">:=</span>&nbsp;<span class="builtintype" id="1667421">uint32</span><span class="op" id="1667427">(</span><span class="num" id="1667428">0</span><span class="op" id="1667429">)</span><span class="op" id="1667430">;</span>&nbsp;<span class="ident" id="1667432">i</span>&nbsp;<span class="op" id="1667434">&lt;</span>&nbsp;<span class="ident" id="1667436">_NSIG</span><span class="op" id="1667441">;</span>&nbsp;<span class="ident" id="1667443">i</span><span class="op" id="1667444">++</span>&nbsp;<span class="op" id="1667447">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667452">if</span>&nbsp;<span class="ident" id="1667455">sig</span><span class="op" id="1667458">.</span><span class="ident" id="1667459">recv</span><span class="op" id="1667463">[</span><span class="ident" id="1667464">i</span><span class="op" id="1667465">/</span><span class="num" id="1667466">32</span><span class="op" id="1667468">]</span><span class="op" id="1667469">&amp;</span><span class="op" id="1667470">(</span><span class="num" id="1667471">1</span><span class="op" id="1667472">&lt;&lt;</span><span class="op" id="1667474">(</span><span class="ident" id="1667475">i</span><span class="op" id="1667476">&amp;</span><span class="num" id="1667477">31</span><span class="op" id="1667479">)</span><span class="op" id="1667480">)</span>&nbsp;<span class="op" id="1667482">!=</span>&nbsp;<span class="num" id="1667485">0</span>&nbsp;<span class="op" id="1667487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667493">sig</span><span class="op" id="1667496">.</span><span class="ident" id="1667497">recv</span><span class="op" id="1667501">[</span><span class="ident" id="1667502">i</span><span class="op" id="1667503">/</span><span class="num" id="1667504">32</span><span class="op" id="1667506">]</span>&nbsp;<span class="op" id="1667508">&amp;^=</span>&nbsp;<span class="num" id="1667512">1</span>&nbsp;<span class="op" id="1667514">&lt;&lt;</span>&nbsp;<span class="op" id="1667517">(</span><span class="ident" id="1667518">i</span>&nbsp;<span class="op" id="1667520">&amp;</span>&nbsp;<span class="num" id="1667522">31</span><span class="op" id="1667524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667530">return</span>&nbsp;<span class="ident" id="1667537">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667546">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667551">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667608">Receive</span><span class="op" id="1667615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667619">for</span>&nbsp;<span class="op" id="1667623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667628">switch</span>&nbsp;<span class="ident" id="1667635">atomicload</span><span class="op" id="1667645">(</span><span class="op" id="1667646">&amp;</span><span class="ident" id="1667647">sig</span><span class="op" id="1667650">.</span><span class="ident" id="1667651">state</span><span class="op" id="1667656">)</span>&nbsp;<span class="op" id="1667658">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667663">default</span><span class="op" id="1667670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667676">gothrow</span><span class="op" id="1667683">(</span><span class="string" id="1667684">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1667717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667722">case</span>&nbsp;<span class="ident" id="1667727">sigIdle</span><span class="op" id="1667734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667740">if</span>&nbsp;<span class="ident" id="1667743">cas</span><span class="op" id="1667746">(</span><span class="op" id="1667747">&amp;</span><span class="ident" id="1667748">sig</span><span class="op" id="1667751">.</span><span class="ident" id="1667752">state</span><span class="op" id="1667757">,</span>&nbsp;<span class="ident" id="1667759">sigIdle</span><span class="op" id="1667766">,</span>&nbsp;<span class="ident" id="1667768">sigReceiving</span><span class="op" id="1667780">)</span>&nbsp;<span class="op" id="1667782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667789">notetsleepg</span><span class="op" id="1667800">(</span><span class="op" id="1667801">&amp;</span><span class="ident" id="1667802">sig</span><span class="op" id="1667805">.</span><span class="ident" id="1667806">note</span><span class="op" id="1667810">,</span>&nbsp;<span class="op" id="1667812">-</span><span class="num" id="1667813">1</span><span class="op" id="1667814">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1667821">noteclear</span><span class="op" id="1667830">(</span><span class="op" id="1667831">&amp;</span><span class="ident" id="1667832">sig</span><span class="op" id="1667835">.</span><span class="ident" id="1667836">note</span><span class="op" id="1667840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667847">break</span>&nbsp;<span class="ident" id="1667853">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667870">case</span>&nbsp;<span class="ident" id="1667875">sigSending</span><span class="op" id="1667885">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667891">if</span>&nbsp;<span class="ident" id="1667894">cas</span><span class="op" id="1667897">(</span><span class="op" id="1667898">&amp;</span><span class="ident" id="1667899">sig</span><span class="op" id="1667902">.</span><span class="ident" id="1667903">state</span><span class="op" id="1667908">,</span>&nbsp;<span class="ident" id="1667910">sigSending</span><span class="op" id="1667920">,</span>&nbsp;<span class="ident" id="1667922">sigIdle</span><span class="op" id="1667929">)</span>&nbsp;<span class="op" id="1667931">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1667938">break</span>&nbsp;<span class="ident" id="1667944">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1667965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1667970">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668024">for</span>&nbsp;<span class="ident" id="1668028">i</span>&nbsp;<span class="op" id="1668030">:=</span>&nbsp;<span class="keyword" id="1668033">range</span>&nbsp;<span class="ident" id="1668039">sig</span><span class="op" id="1668042">.</span><span class="ident" id="1668043">mask</span>&nbsp;<span class="op" id="1668048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668053">sig</span><span class="op" id="1668056">.</span><span class="ident" id="1668057">recv</span><span class="op" id="1668061">[</span><span class="ident" id="1668062">i</span><span class="op" id="1668063">]</span>&nbsp;<span class="op" id="1668065">=</span>&nbsp;<span class="ident" id="1668067">xchg</span><span class="op" id="1668071">(</span><span class="op" id="1668072">&amp;</span><span class="ident" id="1668073">sig</span><span class="op" id="1668076">.</span><span class="ident" id="1668077">mask</span><span class="op" id="1668081">[</span><span class="ident" id="1668082">i</span><span class="op" id="1668083">]</span><span class="op" id="1668084">,</span>&nbsp;<span class="num" id="1668086">0</span><span class="op" id="1668087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668094">}</span><br>
<span class="lineno">125</span><span class="op" id="1668096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1668099">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1668157">func</span>&nbsp;<span class="ident" id="1668162">signal_enable</span><span class="op" id="1668175">(</span><span class="ident" id="1668176">s</span>&nbsp;<span class="builtintype" id="1668178">uint32</span><span class="op" id="1668184">)</span>&nbsp;<span class="op" id="1668186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668189">if</span>&nbsp;<span class="op" id="1668192">!</span><span class="ident" id="1668193">sig</span><span class="op" id="1668196">.</span><span class="ident" id="1668197">inuse</span>&nbsp;<span class="op" id="1668203">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1668207">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1668254">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1668304">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668334">sig</span><span class="op" id="1668337">.</span><span class="ident" id="1668338">inuse</span>&nbsp;<span class="op" id="1668344">=</span>&nbsp;<span class="builtintype" id="1668346">true</span>&nbsp;<span class="comment" id="1668351">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668400">noteclear</span><span class="op" id="1668409">(</span><span class="op" id="1668410">&amp;</span><span class="ident" id="1668411">sig</span><span class="op" id="1668414">.</span><span class="ident" id="1668415">note</span><span class="op" id="1668419">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668423">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668435">if</span>&nbsp;<span class="builtintype" id="1668438">int</span><span class="op" id="1668441">(</span><span class="ident" id="1668442">s</span><span class="op" id="1668443">)</span>&nbsp;<span class="op" id="1668445">&gt;=</span>&nbsp;<span class="builtinfunc" id="1668448">len</span><span class="op" id="1668451">(</span><span class="ident" id="1668452">sig</span><span class="op" id="1668455">.</span><span class="ident" id="1668456">wanted</span><span class="op" id="1668462">)</span><span class="op" id="1668463">*</span><span class="num" id="1668464">32</span>&nbsp;<span class="op" id="1668467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668471">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668482">sig</span><span class="op" id="1668485">.</span><span class="ident" id="1668486">wanted</span><span class="op" id="1668492">[</span><span class="ident" id="1668493">s</span><span class="op" id="1668494">/</span><span class="num" id="1668495">32</span><span class="op" id="1668497">]</span>&nbsp;<span class="op" id="1668499">|=</span>&nbsp;<span class="num" id="1668502">1</span>&nbsp;<span class="op" id="1668504">&lt;&lt;</span>&nbsp;<span class="op" id="1668507">(</span><span class="ident" id="1668508">s</span>&nbsp;<span class="op" id="1668510">&amp;</span>&nbsp;<span class="num" id="1668512">31</span><span class="op" id="1668514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668517">sigenable_go</span><span class="op" id="1668529">(</span><span class="ident" id="1668530">s</span><span class="op" id="1668531">)</span><br>
<span class="lineno"></span><span class="op" id="1668533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1668536">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1668594">func</span>&nbsp;<span class="ident" id="1668599">signal_disable</span><span class="op" id="1668613">(</span><span class="ident" id="1668614">s</span>&nbsp;<span class="builtintype" id="1668616">uint32</span><span class="op" id="1668622">)</span>&nbsp;<span class="op" id="1668624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668627">if</span>&nbsp;<span class="builtintype" id="1668630">int</span><span class="op" id="1668633">(</span><span class="ident" id="1668634">s</span><span class="op" id="1668635">)</span>&nbsp;<span class="op" id="1668637">&gt;=</span>&nbsp;<span class="builtinfunc" id="1668640">len</span><span class="op" id="1668643">(</span><span class="ident" id="1668644">sig</span><span class="op" id="1668647">.</span><span class="ident" id="1668648">wanted</span><span class="op" id="1668654">)</span><span class="op" id="1668655">*</span><span class="num" id="1668656">32</span>&nbsp;<span class="op" id="1668659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1668663">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1668671">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668674">sig</span><span class="op" id="1668677">.</span><span class="ident" id="1668678">wanted</span><span class="op" id="1668684">[</span><span class="ident" id="1668685">s</span><span class="op" id="1668686">/</span><span class="num" id="1668687">32</span><span class="op" id="1668689">]</span>&nbsp;<span class="op" id="1668691">&amp;^=</span>&nbsp;<span class="num" id="1668695">1</span>&nbsp;<span class="op" id="1668697">&lt;&lt;</span>&nbsp;<span class="op" id="1668700">(</span><span class="ident" id="1668701">s</span>&nbsp;<span class="op" id="1668703">&amp;</span>&nbsp;<span class="num" id="1668705">31</span><span class="op" id="1668707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668710">sigdisable_go</span><span class="op" id="1668723">(</span><span class="ident" id="1668724">s</span><span class="op" id="1668725">)</span><br>
<span class="lineno"></span><span class="op" id="1668727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1668730">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1668801">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1668814">func</span>&nbsp;<span class="ident" id="1668819">badsignal</span><span class="op" id="1668828">(</span><span class="ident" id="1668829">sig</span>&nbsp;<span class="builtintype" id="1668833">uintptr</span><span class="op" id="1668840">)</span>&nbsp;<span class="op" id="1668842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1668845">cgocallback</span><span class="op" id="1668856">(</span><span class="ident" id="1668857">unsafe</span><span class="op" id="1668863">.</span><span class="ident" id="1668864">Pointer</span><span class="op" id="1668871">(</span><span class="ident" id="1668872">funcPC</span><span class="op" id="1668878">(</span><span class="ident" id="1668879">sigsend</span><span class="op" id="1668886">)</span><span class="op" id="1668887">)</span><span class="op" id="1668888">,</span>&nbsp;<span class="ident" id="1668890">noescape</span><span class="op" id="1668898">(</span><span class="ident" id="1668899">unsafe</span><span class="op" id="1668905">.</span><span class="ident" id="1668906">Pointer</span><span class="op" id="1668913">(</span><span class="op" id="1668914">&amp;</span><span class="ident" id="1668915">sig</span><span class="op" id="1668918">)</span><span class="op" id="1668919">)</span><span class="op" id="1668920">,</span>&nbsp;<span class="ident" id="1668922">unsafe</span><span class="op" id="1668928">.</span><span class="ident" id="1668929">Sizeof</span><span class="op" id="1668935">(</span><span class="ident" id="1668936">sig</span><span class="op" id="1668939">)</span><span class="op" id="1668940">)</span><br>
<span class="lineno"></span><span class="op" id="1668942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1668945">func</span>&nbsp;<span class="ident" id="1668950">sigenable_m</span><span class="op" id="1668961">(</span><span class="op" id="1668962">)</span><br>
<span class="lineno"></span><span class="keyword" id="1668964">func</span>&nbsp;<span class="ident" id="1668969">sigdisable_m</span><span class="op" id="1668981">(</span><span class="op" id="1668982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1668985">func</span>&nbsp;<span class="ident" id="1668990">sigenable_go</span><span class="op" id="1669002">(</span><span class="ident" id="1669003">s</span>&nbsp;<span class="builtintype" id="1669005">uint32</span><span class="op" id="1669011">)</span>&nbsp;<span class="op" id="1669013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669016">g</span>&nbsp;<span class="op" id="1669018">:=</span>&nbsp;<span class="ident" id="1669021">getg</span><span class="op" id="1669025">(</span><span class="op" id="1669026">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669029">g</span><span class="op" id="1669030">.</span><span class="ident" id="1669031">m</span><span class="op" id="1669032">.</span><span class="ident" id="1669033">scalararg</span><span class="op" id="1669042">[</span><span class="num" id="1669043">0</span><span class="op" id="1669044">]</span>&nbsp;<span class="op" id="1669046">=</span>&nbsp;<span class="builtintype" id="1669048">uintptr</span><span class="op" id="1669055">(</span><span class="ident" id="1669056">s</span><span class="op" id="1669057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669060">onM</span><span class="op" id="1669063">(</span><span class="ident" id="1669064">sigenable_m</span><span class="op" id="1669075">)</span><br>
<span class="lineno"></span><span class="op" id="1669077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1669080">func</span>&nbsp;<span class="ident" id="1669085">sigdisable_go</span><span class="op" id="1669098">(</span><span class="ident" id="1669099">s</span>&nbsp;<span class="builtintype" id="1669101">uint32</span><span class="op" id="1669107">)</span>&nbsp;<span class="op" id="1669109">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669112">g</span>&nbsp;<span class="op" id="1669114">:=</span>&nbsp;<span class="ident" id="1669117">getg</span><span class="op" id="1669121">(</span><span class="op" id="1669122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669125">g</span><span class="op" id="1669126">.</span><span class="ident" id="1669127">m</span><span class="op" id="1669128">.</span><span class="ident" id="1669129">scalararg</span><span class="op" id="1669138">[</span><span class="num" id="1669139">0</span><span class="op" id="1669140">]</span>&nbsp;<span class="op" id="1669142">=</span>&nbsp;<span class="builtintype" id="1669144">uintptr</span><span class="op" id="1669151">(</span><span class="ident" id="1669152">s</span><span class="op" id="1669153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1669156">onM</span><span class="op" id="1669159">(</span><span class="ident" id="1669160">sigdisable_m</span><span class="op" id="1669172">)</span><br>
<span class="lineno"></span><span class="op" id="1669174">}</span>
</div>
</body>
</html>
