<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6015455">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6015510">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6015564">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6015615">package</span>&nbsp;<span class="ident" id="6015623">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6015628">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="6015647">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6015695">import</span>&nbsp;<span class="op" id="6015702">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015705">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015714">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015724">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015731">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015737">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015743">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015751">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015762">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6015773">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6015780">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6015783">var</span>&nbsp;<span class="op" id="6015787">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015790">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015809">=</span>&nbsp;<span class="ident" id="6015811">errors</span><span class="op" id="6015817">.</span><span class="ident" id="6015818">New</span><span class="op" id="6015821">(</span><span class="string" id="6015822">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="6015851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015854">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015873">=</span>&nbsp;<span class="ident" id="6015875">errors</span><span class="op" id="6015881">.</span><span class="ident" id="6015882">New</span><span class="op" id="6015885">(</span><span class="string" id="6015886">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="6015922">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015925">ErrWriteAfterClose</span>&nbsp;<span class="op" id="6015944">=</span>&nbsp;<span class="ident" id="6015946">errors</span><span class="op" id="6015952">.</span><span class="ident" id="6015953">New</span><span class="op" id="6015956">(</span><span class="string" id="6015957">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="6015989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6015992">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6016011">=</span>&nbsp;<span class="ident" id="6016013">errors</span><span class="op" id="6016019">.</span><span class="ident" id="6016020">New</span><span class="op" id="6016023">(</span><span class="string" id="6016024">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="6016052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016055">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6016074">=</span>&nbsp;<span class="ident" id="6016076">errors</span><span class="op" id="6016082">.</span><span class="ident" id="6016083">New</span><span class="op" id="6016086">(</span><span class="string" id="6016087">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="6016150">)</span><br>
<span class="lineno"></span><span class="op" id="6016152">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="6016155">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6016231">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="6016281">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="6016370">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="6016414">type</span>&nbsp;<span class="ident" id="6016419">Writer</span>&nbsp;<span class="keyword" id="6016426">struct</span>&nbsp;<span class="op" id="6016433">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016436">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016447">io</span><span class="op" id="6016449">.</span><span class="ident" id="6016450">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016458">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6016469">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016476">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016487">int64</span>&nbsp;<span class="comment" id="6016493">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016546">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016557">int64</span>&nbsp;<span class="comment" id="6016563">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016619">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6016630">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016636">usedBinary</span>&nbsp;<span class="builtintype" id="6016647">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6016663">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016719">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="6016730">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6016746">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016798">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6016809">[</span><span class="ident" id="6016810">blockSize</span><span class="op" id="6016819">]</span><span class="builtintype" id="6016820">byte</span>&nbsp;<span class="comment" id="6016825">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6016888">paxHdrBuff</span>&nbsp;<span class="op" id="6016899">[</span><span class="ident" id="6016900">blockSize</span><span class="op" id="6016909">]</span><span class="builtintype" id="6016910">byte</span>&nbsp;<span class="comment" id="6016915">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="6016973">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="6016976">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6017024">func</span>&nbsp;<span class="ident" id="6017029">NewWriter</span><span class="op" id="6017038">(</span><span class="ident" id="6017039">w</span>&nbsp;<span class="ident" id="6017041">io</span><span class="op" id="6017043">.</span><span class="ident" id="6017044">Writer</span><span class="op" id="6017050">)</span>&nbsp;<span class="op" id="6017052">*</span><span class="ident" id="6017053">Writer</span>&nbsp;<span class="op" id="6017060">{</span>&nbsp;<span class="keyword" id="6017062">return</span>&nbsp;<span class="op" id="6017069">&amp;</span><span class="ident" id="6017070">Writer</span><span class="op" id="6017076">{</span><span class="ident" id="6017077">w</span><span class="op" id="6017078">:</span>&nbsp;<span class="ident" id="6017080">w</span><span class="op" id="6017081">}</span>&nbsp;<span class="op" id="6017083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6017086">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="6017141">func</span>&nbsp;<span class="op" id="6017146">(</span><span class="ident" id="6017147">tw</span>&nbsp;<span class="op" id="6017150">*</span><span class="ident" id="6017151">Writer</span><span class="op" id="6017157">)</span>&nbsp;<span class="ident" id="6017159">Flush</span><span class="op" id="6017164">(</span><span class="op" id="6017165">)</span>&nbsp;<span class="builtintype" id="6017167">error</span>&nbsp;<span class="op" id="6017173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017176">if</span>&nbsp;<span class="ident" id="6017179">tw</span><span class="op" id="6017181">.</span><span class="ident" id="6017182">nb</span>&nbsp;<span class="op" id="6017185">&gt;</span>&nbsp;<span class="num" id="6017187">0</span>&nbsp;<span class="op" id="6017189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017193">tw</span><span class="op" id="6017195">.</span><span class="ident" id="6017196">err</span>&nbsp;<span class="op" id="6017200">=</span>&nbsp;<span class="ident" id="6017202">fmt</span><span class="op" id="6017205">.</span><span class="ident" id="6017206">Errorf</span><span class="op" id="6017212">(</span><span class="string" id="6017213">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="6017251">,</span>&nbsp;<span class="ident" id="6017253">tw</span><span class="op" id="6017255">.</span><span class="ident" id="6017256">nb</span><span class="op" id="6017258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017262">return</span>&nbsp;<span class="ident" id="6017269">tw</span><span class="op" id="6017271">.</span><span class="ident" id="6017272">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017277">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017281">n</span>&nbsp;<span class="op" id="6017283">:=</span>&nbsp;<span class="ident" id="6017286">tw</span><span class="op" id="6017288">.</span><span class="ident" id="6017289">nb</span>&nbsp;<span class="op" id="6017292">+</span>&nbsp;<span class="ident" id="6017294">tw</span><span class="op" id="6017296">.</span><span class="ident" id="6017297">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017302">for</span>&nbsp;<span class="ident" id="6017306">n</span>&nbsp;<span class="op" id="6017308">&gt;</span>&nbsp;<span class="num" id="6017310">0</span>&nbsp;<span class="op" id="6017312">&amp;&amp;</span>&nbsp;<span class="ident" id="6017315">tw</span><span class="op" id="6017317">.</span><span class="ident" id="6017318">err</span>&nbsp;<span class="op" id="6017322">==</span>&nbsp;<span class="ident" id="6017325">nil</span>&nbsp;<span class="op" id="6017329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017333">nr</span>&nbsp;<span class="op" id="6017336">:=</span>&nbsp;<span class="ident" id="6017339">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017343">if</span>&nbsp;<span class="ident" id="6017346">nr</span>&nbsp;<span class="op" id="6017349">&gt;</span>&nbsp;<span class="ident" id="6017351">blockSize</span>&nbsp;<span class="op" id="6017361">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017366">nr</span>&nbsp;<span class="op" id="6017369">=</span>&nbsp;<span class="ident" id="6017371">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017387">var</span>&nbsp;<span class="ident" id="6017391">nw</span>&nbsp;<span class="builtintype" id="6017394">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017400">nw</span><span class="op" id="6017402">,</span>&nbsp;<span class="ident" id="6017404">tw</span><span class="op" id="6017406">.</span><span class="ident" id="6017407">err</span>&nbsp;<span class="op" id="6017411">=</span>&nbsp;<span class="ident" id="6017413">tw</span><span class="op" id="6017415">.</span><span class="ident" id="6017416">w</span><span class="op" id="6017417">.</span><span class="ident" id="6017418">Write</span><span class="op" id="6017423">(</span><span class="ident" id="6017424">zeroBlock</span><span class="op" id="6017433">[</span><span class="num" id="6017434">0</span><span class="op" id="6017435">:</span><span class="ident" id="6017436">nr</span><span class="op" id="6017438">]</span><span class="op" id="6017439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017443">n</span>&nbsp;<span class="op" id="6017445">-=</span>&nbsp;<span class="ident" id="6017448">int64</span><span class="op" id="6017453">(</span><span class="ident" id="6017454">nw</span><span class="op" id="6017456">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017462">tw</span><span class="op" id="6017464">.</span><span class="ident" id="6017465">nb</span>&nbsp;<span class="op" id="6017468">=</span>&nbsp;<span class="num" id="6017470">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017473">tw</span><span class="op" id="6017475">.</span><span class="ident" id="6017476">pad</span>&nbsp;<span class="op" id="6017480">=</span>&nbsp;<span class="num" id="6017482">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017485">return</span>&nbsp;<span class="ident" id="6017492">tw</span><span class="op" id="6017494">.</span><span class="ident" id="6017495">err</span><br>
<span class="lineno"></span><span class="op" id="6017499">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6017502">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="6017565">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6017659">func</span>&nbsp;<span class="op" id="6017664">(</span><span class="ident" id="6017665">tw</span>&nbsp;<span class="op" id="6017668">*</span><span class="ident" id="6017669">Writer</span><span class="op" id="6017675">)</span>&nbsp;<span class="ident" id="6017677">cString</span><span class="op" id="6017684">(</span><span class="ident" id="6017685">b</span>&nbsp;<span class="op" id="6017687">[</span><span class="op" id="6017688">]</span><span class="builtintype" id="6017689">byte</span><span class="op" id="6017693">,</span>&nbsp;<span class="ident" id="6017695">s</span>&nbsp;<span class="builtintype" id="6017697">string</span><span class="op" id="6017703">,</span>&nbsp;<span class="ident" id="6017705">allowPax</span>&nbsp;<span class="builtintype" id="6017714">bool</span><span class="op" id="6017718">,</span>&nbsp;<span class="ident" id="6017720">paxKeyword</span>&nbsp;<span class="builtintype" id="6017731">string</span><span class="op" id="6017737">,</span>&nbsp;<span class="ident" id="6017739">paxHeaders</span>&nbsp;<span class="keyword" id="6017750">map</span><span class="op" id="6017753">[</span><span class="builtintype" id="6017754">string</span><span class="op" id="6017760">]</span><span class="builtintype" id="6017761">string</span><span class="op" id="6017767">)</span>&nbsp;<span class="op" id="6017769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017772">needsPaxHeader</span>&nbsp;<span class="op" id="6017787">:=</span>&nbsp;<span class="ident" id="6017790">allowPax</span>&nbsp;<span class="op" id="6017799">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6017802">len</span><span class="op" id="6017805">(</span><span class="ident" id="6017806">s</span><span class="op" id="6017807">)</span>&nbsp;<span class="op" id="6017809">&gt;</span>&nbsp;<span class="builtinfunc" id="6017811">len</span><span class="op" id="6017814">(</span><span class="ident" id="6017815">b</span><span class="op" id="6017816">)</span>&nbsp;<span class="op" id="6017818">||</span>&nbsp;<span class="op" id="6017821">!</span><span class="ident" id="6017822">isASCII</span><span class="op" id="6017829">(</span><span class="ident" id="6017830">s</span><span class="op" id="6017831">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017834">if</span>&nbsp;<span class="ident" id="6017837">needsPaxHeader</span>&nbsp;<span class="op" id="6017852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017856">paxHeaders</span><span class="op" id="6017866">[</span><span class="ident" id="6017867">paxKeyword</span><span class="op" id="6017877">]</span>&nbsp;<span class="op" id="6017879">=</span>&nbsp;<span class="ident" id="6017881">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017885">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017896">if</span>&nbsp;<span class="builtinfunc" id="6017899">len</span><span class="op" id="6017902">(</span><span class="ident" id="6017903">s</span><span class="op" id="6017904">)</span>&nbsp;<span class="op" id="6017906">&gt;</span>&nbsp;<span class="builtinfunc" id="6017908">len</span><span class="op" id="6017911">(</span><span class="ident" id="6017912">b</span><span class="op" id="6017913">)</span>&nbsp;<span class="op" id="6017915">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017919">if</span>&nbsp;<span class="ident" id="6017922">tw</span><span class="op" id="6017924">.</span><span class="ident" id="6017925">err</span>&nbsp;<span class="op" id="6017929">==</span>&nbsp;<span class="ident" id="6017932">nil</span>&nbsp;<span class="op" id="6017936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017941">tw</span><span class="op" id="6017943">.</span><span class="ident" id="6017944">err</span>&nbsp;<span class="op" id="6017948">=</span>&nbsp;<span class="ident" id="6017950">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6017972">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6017980">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6017983">ascii</span>&nbsp;<span class="op" id="6017989">:=</span>&nbsp;<span class="ident" id="6017992">toASCII</span><span class="op" id="6017999">(</span><span class="ident" id="6018000">s</span><span class="op" id="6018001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6018004">copy</span><span class="op" id="6018008">(</span><span class="ident" id="6018009">b</span><span class="op" id="6018010">,</span>&nbsp;<span class="ident" id="6018012">ascii</span><span class="op" id="6018017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018020">if</span>&nbsp;<span class="builtinfunc" id="6018023">len</span><span class="op" id="6018026">(</span><span class="ident" id="6018027">ascii</span><span class="op" id="6018032">)</span>&nbsp;<span class="op" id="6018034">&lt;</span>&nbsp;<span class="builtinfunc" id="6018036">len</span><span class="op" id="6018039">(</span><span class="ident" id="6018040">b</span><span class="op" id="6018041">)</span>&nbsp;<span class="op" id="6018043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018047">b</span><span class="op" id="6018048">[</span><span class="builtinfunc" id="6018049">len</span><span class="op" id="6018052">(</span><span class="ident" id="6018053">ascii</span><span class="op" id="6018058">)</span><span class="op" id="6018059">]</span>&nbsp;<span class="op" id="6018061">=</span>&nbsp;<span class="num" id="6018063">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018066">}</span><br>
<span class="lineno">90</span><span class="op" id="6018068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6018071">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="6018148">func</span>&nbsp;<span class="op" id="6018153">(</span><span class="ident" id="6018154">tw</span>&nbsp;<span class="op" id="6018157">*</span><span class="ident" id="6018158">Writer</span><span class="op" id="6018164">)</span>&nbsp;<span class="ident" id="6018166">octal</span><span class="op" id="6018171">(</span><span class="ident" id="6018172">b</span>&nbsp;<span class="op" id="6018174">[</span><span class="op" id="6018175">]</span><span class="builtintype" id="6018176">byte</span><span class="op" id="6018180">,</span>&nbsp;<span class="ident" id="6018182">x</span>&nbsp;<span class="ident" id="6018184">int64</span><span class="op" id="6018189">)</span>&nbsp;<span class="op" id="6018191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018194">s</span>&nbsp;<span class="op" id="6018196">:=</span>&nbsp;<span class="ident" id="6018199">strconv</span><span class="op" id="6018206">.</span><span class="ident" id="6018207">FormatInt</span><span class="op" id="6018216">(</span><span class="ident" id="6018217">x</span><span class="op" id="6018218">,</span>&nbsp;<span class="num" id="6018220">8</span><span class="op" id="6018221">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018224">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018269">for</span>&nbsp;<span class="builtinfunc" id="6018273">len</span><span class="op" id="6018276">(</span><span class="ident" id="6018277">s</span><span class="op" id="6018278">)</span><span class="op" id="6018279">+</span><span class="num" id="6018280">1</span>&nbsp;<span class="op" id="6018282">&lt;</span>&nbsp;<span class="builtinfunc" id="6018284">len</span><span class="op" id="6018287">(</span><span class="ident" id="6018288">b</span><span class="op" id="6018289">)</span>&nbsp;<span class="op" id="6018291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018295">s</span>&nbsp;<span class="op" id="6018297">=</span>&nbsp;<span class="string" id="6018299">&#34;0&#34;</span>&nbsp;<span class="op" id="6018303">+</span>&nbsp;<span class="ident" id="6018305">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018311">tw</span><span class="op" id="6018313">.</span><span class="ident" id="6018314">cString</span><span class="op" id="6018321">(</span><span class="ident" id="6018322">b</span><span class="op" id="6018323">,</span>&nbsp;<span class="ident" id="6018325">s</span><span class="op" id="6018326">,</span>&nbsp;<span class="builtintype" id="6018328">false</span><span class="op" id="6018333">,</span>&nbsp;<span class="ident" id="6018335">paxNone</span><span class="op" id="6018342">,</span>&nbsp;<span class="ident" id="6018344">nil</span><span class="op" id="6018347">)</span><br>
<span class="lineno">100</span><span class="op" id="6018349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6018352">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="6018425">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6018551">func</span>&nbsp;<span class="op" id="6018556">(</span><span class="ident" id="6018557">tw</span>&nbsp;<span class="op" id="6018560">*</span><span class="ident" id="6018561">Writer</span><span class="op" id="6018567">)</span>&nbsp;<span class="ident" id="6018569">numeric</span><span class="op" id="6018576">(</span><span class="ident" id="6018577">b</span>&nbsp;<span class="op" id="6018579">[</span><span class="op" id="6018580">]</span><span class="builtintype" id="6018581">byte</span><span class="op" id="6018585">,</span>&nbsp;<span class="ident" id="6018587">x</span>&nbsp;<span class="ident" id="6018589">int64</span><span class="op" id="6018594">,</span>&nbsp;<span class="ident" id="6018596">allowPax</span>&nbsp;<span class="builtintype" id="6018605">bool</span><span class="op" id="6018609">,</span>&nbsp;<span class="ident" id="6018611">paxKeyword</span>&nbsp;<span class="builtintype" id="6018622">string</span><span class="op" id="6018628">,</span>&nbsp;<span class="ident" id="6018630">paxHeaders</span>&nbsp;<span class="keyword" id="6018641">map</span><span class="op" id="6018644">[</span><span class="builtintype" id="6018645">string</span><span class="op" id="6018651">]</span><span class="builtintype" id="6018652">string</span><span class="op" id="6018658">)</span>&nbsp;<span class="op" id="6018660">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018663">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018684">s</span>&nbsp;<span class="op" id="6018686">:=</span>&nbsp;<span class="ident" id="6018689">strconv</span><span class="op" id="6018696">.</span><span class="ident" id="6018697">FormatInt</span><span class="op" id="6018706">(</span><span class="ident" id="6018707">x</span><span class="op" id="6018708">,</span>&nbsp;<span class="num" id="6018710">8</span><span class="op" id="6018711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018714">if</span>&nbsp;<span class="builtinfunc" id="6018717">len</span><span class="op" id="6018720">(</span><span class="ident" id="6018721">s</span><span class="op" id="6018722">)</span>&nbsp;<span class="op" id="6018724">&lt;</span>&nbsp;<span class="builtinfunc" id="6018726">len</span><span class="op" id="6018729">(</span><span class="ident" id="6018730">b</span><span class="op" id="6018731">)</span>&nbsp;<span class="op" id="6018733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018737">tw</span><span class="op" id="6018739">.</span><span class="ident" id="6018740">octal</span><span class="op" id="6018745">(</span><span class="ident" id="6018746">b</span><span class="op" id="6018747">,</span>&nbsp;<span class="ident" id="6018749">x</span><span class="op" id="6018750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018754">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018766">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018838">if</span>&nbsp;<span class="ident" id="6018841">allowPax</span>&nbsp;<span class="op" id="6018850">&amp;&amp;</span>&nbsp;<span class="ident" id="6018853">tw</span><span class="op" id="6018855">.</span><span class="ident" id="6018856">preferPax</span>&nbsp;<span class="op" id="6018866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018870">tw</span><span class="op" id="6018872">.</span><span class="ident" id="6018873">octal</span><span class="op" id="6018878">(</span><span class="ident" id="6018879">b</span><span class="op" id="6018880">,</span>&nbsp;<span class="num" id="6018882">0</span><span class="op" id="6018883">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018887">s</span>&nbsp;<span class="op" id="6018889">:=</span>&nbsp;<span class="ident" id="6018892">strconv</span><span class="op" id="6018899">.</span><span class="ident" id="6018900">FormatInt</span><span class="op" id="6018909">(</span><span class="ident" id="6018910">x</span><span class="op" id="6018911">,</span>&nbsp;<span class="num" id="6018913">10</span><span class="op" id="6018915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018919">paxHeaders</span><span class="op" id="6018929">[</span><span class="ident" id="6018930">paxKeyword</span><span class="op" id="6018940">]</span>&nbsp;<span class="op" id="6018942">=</span>&nbsp;<span class="ident" id="6018944">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6018948">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6018956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6018960">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6018998">tw</span><span class="op" id="6019000">.</span><span class="ident" id="6019001">usedBinary</span>&nbsp;<span class="op" id="6019012">=</span>&nbsp;<span class="builtintype" id="6019014">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019020">for</span>&nbsp;<span class="ident" id="6019024">i</span>&nbsp;<span class="op" id="6019026">:=</span>&nbsp;<span class="builtinfunc" id="6019029">len</span><span class="op" id="6019032">(</span><span class="ident" id="6019033">b</span><span class="op" id="6019034">)</span>&nbsp;<span class="op" id="6019036">-</span>&nbsp;<span class="num" id="6019038">1</span><span class="op" id="6019039">;</span>&nbsp;<span class="ident" id="6019041">x</span>&nbsp;<span class="op" id="6019043">&gt;</span>&nbsp;<span class="num" id="6019045">0</span>&nbsp;<span class="op" id="6019047">&amp;&amp;</span>&nbsp;<span class="ident" id="6019050">i</span>&nbsp;<span class="op" id="6019052">&gt;=</span>&nbsp;<span class="num" id="6019055">0</span><span class="op" id="6019056">;</span>&nbsp;<span class="ident" id="6019058">i</span><span class="op" id="6019059">--</span>&nbsp;<span class="op" id="6019062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019066">b</span><span class="op" id="6019067">[</span><span class="ident" id="6019068">i</span><span class="op" id="6019069">]</span>&nbsp;<span class="op" id="6019071">=</span>&nbsp;<span class="builtintype" id="6019073">byte</span><span class="op" id="6019077">(</span><span class="ident" id="6019078">x</span><span class="op" id="6019079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019083">x</span>&nbsp;<span class="op" id="6019085">&gt;&gt;=</span>&nbsp;<span class="num" id="6019089">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019095">b</span><span class="op" id="6019096">[</span><span class="num" id="6019097">0</span><span class="op" id="6019098">]</span>&nbsp;<span class="op" id="6019100">|=</span>&nbsp;<span class="num" id="6019103">0x80</span>&nbsp;<span class="comment" id="6019108">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="6019147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6019150">var</span>&nbsp;<span class="op" id="6019154">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019157">minTime</span>&nbsp;<span class="op" id="6019165">=</span>&nbsp;<span class="ident" id="6019167">time</span><span class="op" id="6019171">.</span><span class="ident" id="6019172">Unix</span><span class="op" id="6019176">(</span><span class="num" id="6019177">0</span><span class="op" id="6019178">,</span>&nbsp;<span class="num" id="6019180">0</span><span class="op" id="6019181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6019184">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019242">maxTime</span>&nbsp;<span class="op" id="6019250">=</span>&nbsp;<span class="ident" id="6019252">minTime</span><span class="op" id="6019259">.</span><span class="ident" id="6019260">Add</span><span class="op" id="6019263">(</span><span class="op" id="6019264">(</span><span class="num" id="6019265">1</span><span class="op" id="6019266">&lt;&lt;</span><span class="num" id="6019268">33</span>&nbsp;<span class="op" id="6019271">-</span>&nbsp;<span class="num" id="6019273">1</span><span class="op" id="6019274">)</span>&nbsp;<span class="op" id="6019276">*</span>&nbsp;<span class="ident" id="6019278">time</span><span class="op" id="6019282">.</span><span class="ident" id="6019283">Second</span><span class="op" id="6019289">)</span><br>
<span class="lineno"></span><span class="op" id="6019291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="6019294">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6019364">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6019422">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="6019479">func</span>&nbsp;<span class="op" id="6019484">(</span><span class="ident" id="6019485">tw</span>&nbsp;<span class="op" id="6019488">*</span><span class="ident" id="6019489">Writer</span><span class="op" id="6019495">)</span>&nbsp;<span class="ident" id="6019497">WriteHeader</span><span class="op" id="6019508">(</span><span class="ident" id="6019509">hdr</span>&nbsp;<span class="op" id="6019513">*</span><span class="ident" id="6019514">Header</span><span class="op" id="6019520">)</span>&nbsp;<span class="builtintype" id="6019522">error</span>&nbsp;<span class="op" id="6019528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019531">return</span>&nbsp;<span class="ident" id="6019538">tw</span><span class="op" id="6019540">.</span><span class="ident" id="6019541">writeHeader</span><span class="op" id="6019552">(</span><span class="ident" id="6019553">hdr</span><span class="op" id="6019556">,</span>&nbsp;<span class="builtintype" id="6019558">true</span><span class="op" id="6019562">)</span><br>
<span class="lineno">140</span><span class="op" id="6019564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6019567">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6019637">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6019695">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="6019752">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6019825">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6019861">func</span>&nbsp;<span class="op" id="6019866">(</span><span class="ident" id="6019867">tw</span>&nbsp;<span class="op" id="6019870">*</span><span class="ident" id="6019871">Writer</span><span class="op" id="6019877">)</span>&nbsp;<span class="ident" id="6019879">writeHeader</span><span class="op" id="6019890">(</span><span class="ident" id="6019891">hdr</span>&nbsp;<span class="op" id="6019895">*</span><span class="ident" id="6019896">Header</span><span class="op" id="6019902">,</span>&nbsp;<span class="ident" id="6019904">allowPax</span>&nbsp;<span class="builtintype" id="6019913">bool</span><span class="op" id="6019917">)</span>&nbsp;<span class="builtintype" id="6019919">error</span>&nbsp;<span class="op" id="6019925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019928">if</span>&nbsp;<span class="ident" id="6019931">tw</span><span class="op" id="6019933">.</span><span class="ident" id="6019934">closed</span>&nbsp;<span class="op" id="6019941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019945">return</span>&nbsp;<span class="ident" id="6019952">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6019972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6019975">if</span>&nbsp;<span class="ident" id="6019978">tw</span><span class="op" id="6019980">.</span><span class="ident" id="6019981">err</span>&nbsp;<span class="op" id="6019985">==</span>&nbsp;<span class="ident" id="6019988">nil</span>&nbsp;<span class="op" id="6019992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6019996">tw</span><span class="op" id="6019998">.</span><span class="ident" id="6019999">Flush</span><span class="op" id="6020004">(</span><span class="op" id="6020005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020011">if</span>&nbsp;<span class="ident" id="6020014">tw</span><span class="op" id="6020016">.</span><span class="ident" id="6020017">err</span>&nbsp;<span class="op" id="6020021">!=</span>&nbsp;<span class="ident" id="6020024">nil</span>&nbsp;<span class="op" id="6020028">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020032">return</span>&nbsp;<span class="ident" id="6020039">tw</span><span class="op" id="6020041">.</span><span class="ident" id="6020042">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020051">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020107">paxHeaders</span>&nbsp;<span class="op" id="6020118">:=</span>&nbsp;<span class="builtinfunc" id="6020121">make</span><span class="op" id="6020125">(</span><span class="keyword" id="6020126">map</span><span class="op" id="6020129">[</span><span class="builtintype" id="6020130">string</span><span class="op" id="6020136">]</span><span class="builtintype" id="6020137">string</span><span class="op" id="6020143">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020147">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020208">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020270">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020315">var</span>&nbsp;<span class="ident" id="6020319">header</span>&nbsp;<span class="op" id="6020326">[</span><span class="op" id="6020327">]</span><span class="builtintype" id="6020328">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020335">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020396">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020462">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020544">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020624">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020701">header</span>&nbsp;<span class="op" id="6020708">=</span>&nbsp;<span class="ident" id="6020710">tw</span><span class="op" id="6020712">.</span><span class="ident" id="6020713">hdrBuff</span><span class="op" id="6020720">[</span><span class="op" id="6020721">:</span><span class="op" id="6020722">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020725">if</span>&nbsp;<span class="op" id="6020728">!</span><span class="ident" id="6020729">allowPax</span>&nbsp;<span class="op" id="6020738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020742">header</span>&nbsp;<span class="op" id="6020749">=</span>&nbsp;<span class="ident" id="6020751">tw</span><span class="op" id="6020753">.</span><span class="ident" id="6020754">paxHdrBuff</span><span class="op" id="6020764">[</span><span class="op" id="6020765">:</span><span class="op" id="6020766">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6020772">copy</span><span class="op" id="6020776">(</span><span class="ident" id="6020777">header</span><span class="op" id="6020783">,</span>&nbsp;<span class="ident" id="6020785">zeroBlock</span><span class="op" id="6020794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020797">s</span>&nbsp;<span class="op" id="6020799">:=</span>&nbsp;<span class="ident" id="6020802">slicer</span><span class="op" id="6020808">(</span><span class="ident" id="6020809">header</span><span class="op" id="6020815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6020819">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020947">pathHeaderBytes</span>&nbsp;<span class="op" id="6020963">:=</span>&nbsp;<span class="ident" id="6020966">s</span><span class="op" id="6020967">.</span><span class="ident" id="6020968">next</span><span class="op" id="6020972">(</span><span class="ident" id="6020973">fileNameSize</span><span class="op" id="6020985">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020989">tw</span><span class="op" id="6020991">.</span><span class="ident" id="6020992">cString</span><span class="op" id="6020999">(</span><span class="ident" id="6021000">pathHeaderBytes</span><span class="op" id="6021015">,</span>&nbsp;<span class="ident" id="6021017">hdr</span><span class="op" id="6021020">.</span><span class="ident" id="6021021">Name</span><span class="op" id="6021025">,</span>&nbsp;<span class="builtintype" id="6021027">true</span><span class="op" id="6021031">,</span>&nbsp;<span class="ident" id="6021033">paxPath</span><span class="op" id="6021040">,</span>&nbsp;<span class="ident" id="6021042">paxHeaders</span><span class="op" id="6021052">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6021056">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6021099">var</span>&nbsp;<span class="ident" id="6021103">modTime</span>&nbsp;<span class="ident" id="6021111">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6021118">if</span>&nbsp;<span class="op" id="6021121">!</span><span class="ident" id="6021122">hdr</span><span class="op" id="6021125">.</span><span class="ident" id="6021126">ModTime</span><span class="op" id="6021133">.</span><span class="ident" id="6021134">Before</span><span class="op" id="6021140">(</span><span class="ident" id="6021141">minTime</span><span class="op" id="6021148">)</span>&nbsp;<span class="op" id="6021150">&amp;&amp;</span>&nbsp;<span class="op" id="6021153">!</span><span class="ident" id="6021154">hdr</span><span class="op" id="6021157">.</span><span class="ident" id="6021158">ModTime</span><span class="op" id="6021165">.</span><span class="ident" id="6021166">After</span><span class="op" id="6021171">(</span><span class="ident" id="6021172">maxTime</span><span class="op" id="6021179">)</span>&nbsp;<span class="op" id="6021181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021185">modTime</span>&nbsp;<span class="op" id="6021193">=</span>&nbsp;<span class="ident" id="6021195">hdr</span><span class="op" id="6021198">.</span><span class="ident" id="6021199">ModTime</span><span class="op" id="6021206">.</span><span class="ident" id="6021207">Unix</span><span class="op" id="6021211">(</span><span class="op" id="6021212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6021215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021219">tw</span><span class="op" id="6021221">.</span><span class="ident" id="6021222">octal</span><span class="op" id="6021227">(</span><span class="ident" id="6021228">s</span><span class="op" id="6021229">.</span><span class="ident" id="6021230">next</span><span class="op" id="6021234">(</span><span class="num" id="6021235">8</span><span class="op" id="6021236">)</span><span class="op" id="6021237">,</span>&nbsp;<span class="ident" id="6021239">hdr</span><span class="op" id="6021242">.</span><span class="ident" id="6021243">Mode</span><span class="op" id="6021247">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6021283">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021295">tw</span><span class="op" id="6021297">.</span><span class="ident" id="6021298">numeric</span><span class="op" id="6021305">(</span><span class="ident" id="6021306">s</span><span class="op" id="6021307">.</span><span class="ident" id="6021308">next</span><span class="op" id="6021312">(</span><span class="num" id="6021313">8</span><span class="op" id="6021314">)</span><span class="op" id="6021315">,</span>&nbsp;<span class="ident" id="6021317">int64</span><span class="op" id="6021322">(</span><span class="ident" id="6021323">hdr</span><span class="op" id="6021326">.</span><span class="ident" id="6021327">Uid</span><span class="op" id="6021330">)</span><span class="op" id="6021331">,</span>&nbsp;<span class="builtintype" id="6021333">true</span><span class="op" id="6021337">,</span>&nbsp;<span class="ident" id="6021339">paxUid</span><span class="op" id="6021345">,</span>&nbsp;<span class="ident" id="6021347">paxHeaders</span><span class="op" id="6021357">)</span>&nbsp;<span class="comment" id="6021359">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021371">tw</span><span class="op" id="6021373">.</span><span class="ident" id="6021374">numeric</span><span class="op" id="6021381">(</span><span class="ident" id="6021382">s</span><span class="op" id="6021383">.</span><span class="ident" id="6021384">next</span><span class="op" id="6021388">(</span><span class="num" id="6021389">8</span><span class="op" id="6021390">)</span><span class="op" id="6021391">,</span>&nbsp;<span class="ident" id="6021393">int64</span><span class="op" id="6021398">(</span><span class="ident" id="6021399">hdr</span><span class="op" id="6021402">.</span><span class="ident" id="6021403">Gid</span><span class="op" id="6021406">)</span><span class="op" id="6021407">,</span>&nbsp;<span class="builtintype" id="6021409">true</span><span class="op" id="6021413">,</span>&nbsp;<span class="ident" id="6021415">paxGid</span><span class="op" id="6021421">,</span>&nbsp;<span class="ident" id="6021423">paxHeaders</span><span class="op" id="6021433">)</span>&nbsp;<span class="comment" id="6021435">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021447">tw</span><span class="op" id="6021449">.</span><span class="ident" id="6021450">numeric</span><span class="op" id="6021457">(</span><span class="ident" id="6021458">s</span><span class="op" id="6021459">.</span><span class="ident" id="6021460">next</span><span class="op" id="6021464">(</span><span class="num" id="6021465">12</span><span class="op" id="6021467">)</span><span class="op" id="6021468">,</span>&nbsp;<span class="ident" id="6021470">hdr</span><span class="op" id="6021473">.</span><span class="ident" id="6021474">Size</span><span class="op" id="6021478">,</span>&nbsp;<span class="builtintype" id="6021480">true</span><span class="op" id="6021484">,</span>&nbsp;<span class="ident" id="6021486">paxSize</span><span class="op" id="6021493">,</span>&nbsp;<span class="ident" id="6021495">paxHeaders</span><span class="op" id="6021505">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6021511">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021523">tw</span><span class="op" id="6021525">.</span><span class="ident" id="6021526">numeric</span><span class="op" id="6021533">(</span><span class="ident" id="6021534">s</span><span class="op" id="6021535">.</span><span class="ident" id="6021536">next</span><span class="op" id="6021540">(</span><span class="num" id="6021541">12</span><span class="op" id="6021543">)</span><span class="op" id="6021544">,</span>&nbsp;<span class="ident" id="6021546">modTime</span><span class="op" id="6021553">,</span>&nbsp;<span class="builtintype" id="6021555">false</span><span class="op" id="6021560">,</span>&nbsp;<span class="ident" id="6021562">paxNone</span><span class="op" id="6021569">,</span>&nbsp;<span class="ident" id="6021571">nil</span><span class="op" id="6021574">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6021587">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021644">s</span><span class="op" id="6021645">.</span><span class="ident" id="6021646">next</span><span class="op" id="6021650">(</span><span class="num" id="6021651">8</span><span class="op" id="6021652">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6021708">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021729">s</span><span class="op" id="6021730">.</span><span class="ident" id="6021731">next</span><span class="op" id="6021735">(</span><span class="num" id="6021736">1</span><span class="op" id="6021737">)</span><span class="op" id="6021738">[</span><span class="num" id="6021739">0</span><span class="op" id="6021740">]</span>&nbsp;<span class="op" id="6021742">=</span>&nbsp;<span class="ident" id="6021744">hdr</span><span class="op" id="6021747">.</span><span class="ident" id="6021748">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6021793">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021806">tw</span><span class="op" id="6021808">.</span><span class="ident" id="6021809">cString</span><span class="op" id="6021816">(</span><span class="ident" id="6021817">s</span><span class="op" id="6021818">.</span><span class="ident" id="6021819">next</span><span class="op" id="6021823">(</span><span class="num" id="6021824">100</span><span class="op" id="6021827">)</span><span class="op" id="6021828">,</span>&nbsp;<span class="ident" id="6021830">hdr</span><span class="op" id="6021833">.</span><span class="ident" id="6021834">Linkname</span><span class="op" id="6021842">,</span>&nbsp;<span class="builtintype" id="6021844">true</span><span class="op" id="6021848">,</span>&nbsp;<span class="ident" id="6021850">paxLinkpath</span><span class="op" id="6021861">,</span>&nbsp;<span class="ident" id="6021863">paxHeaders</span><span class="op" id="6021873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6021877">copy</span><span class="op" id="6021881">(</span><span class="ident" id="6021882">s</span><span class="op" id="6021883">.</span><span class="ident" id="6021884">next</span><span class="op" id="6021888">(</span><span class="num" id="6021889">8</span><span class="op" id="6021890">)</span><span class="op" id="6021891">,</span>&nbsp;<span class="op" id="6021893">[</span><span class="op" id="6021894">]</span><span class="builtintype" id="6021895">byte</span><span class="op" id="6021899">(</span><span class="string" id="6021900">&#34;ustar\x0000&#34;</span><span class="op" id="6021913">)</span><span class="op" id="6021914">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6021939">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021951">tw</span><span class="op" id="6021953">.</span><span class="ident" id="6021954">cString</span><span class="op" id="6021961">(</span><span class="ident" id="6021962">s</span><span class="op" id="6021963">.</span><span class="ident" id="6021964">next</span><span class="op" id="6021968">(</span><span class="num" id="6021969">32</span><span class="op" id="6021971">)</span><span class="op" id="6021972">,</span>&nbsp;<span class="ident" id="6021974">hdr</span><span class="op" id="6021977">.</span><span class="ident" id="6021978">Uname</span><span class="op" id="6021983">,</span>&nbsp;<span class="builtintype" id="6021985">true</span><span class="op" id="6021989">,</span>&nbsp;<span class="ident" id="6021991">paxUname</span><span class="op" id="6021999">,</span>&nbsp;<span class="ident" id="6022001">paxHeaders</span><span class="op" id="6022011">)</span>&nbsp;<span class="comment" id="6022013">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022025">tw</span><span class="op" id="6022027">.</span><span class="ident" id="6022028">cString</span><span class="op" id="6022035">(</span><span class="ident" id="6022036">s</span><span class="op" id="6022037">.</span><span class="ident" id="6022038">next</span><span class="op" id="6022042">(</span><span class="num" id="6022043">32</span><span class="op" id="6022045">)</span><span class="op" id="6022046">,</span>&nbsp;<span class="ident" id="6022048">hdr</span><span class="op" id="6022051">.</span><span class="ident" id="6022052">Gname</span><span class="op" id="6022057">,</span>&nbsp;<span class="builtintype" id="6022059">true</span><span class="op" id="6022063">,</span>&nbsp;<span class="ident" id="6022065">paxGname</span><span class="op" id="6022073">,</span>&nbsp;<span class="ident" id="6022075">paxHeaders</span><span class="op" id="6022085">)</span>&nbsp;<span class="comment" id="6022087">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022099">tw</span><span class="op" id="6022101">.</span><span class="ident" id="6022102">numeric</span><span class="op" id="6022109">(</span><span class="ident" id="6022110">s</span><span class="op" id="6022111">.</span><span class="ident" id="6022112">next</span><span class="op" id="6022116">(</span><span class="num" id="6022117">8</span><span class="op" id="6022118">)</span><span class="op" id="6022119">,</span>&nbsp;<span class="ident" id="6022121">hdr</span><span class="op" id="6022124">.</span><span class="ident" id="6022125">Devmajor</span><span class="op" id="6022133">,</span>&nbsp;<span class="builtintype" id="6022135">false</span><span class="op" id="6022140">,</span>&nbsp;<span class="ident" id="6022142">paxNone</span><span class="op" id="6022149">,</span>&nbsp;<span class="ident" id="6022151">nil</span><span class="op" id="6022154">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6022161">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022173">tw</span><span class="op" id="6022175">.</span><span class="ident" id="6022176">numeric</span><span class="op" id="6022183">(</span><span class="ident" id="6022184">s</span><span class="op" id="6022185">.</span><span class="ident" id="6022186">next</span><span class="op" id="6022190">(</span><span class="num" id="6022191">8</span><span class="op" id="6022192">)</span><span class="op" id="6022193">,</span>&nbsp;<span class="ident" id="6022195">hdr</span><span class="op" id="6022198">.</span><span class="ident" id="6022199">Devminor</span><span class="op" id="6022207">,</span>&nbsp;<span class="builtintype" id="6022209">false</span><span class="op" id="6022214">,</span>&nbsp;<span class="ident" id="6022216">paxNone</span><span class="op" id="6022223">,</span>&nbsp;<span class="ident" id="6022225">nil</span><span class="op" id="6022228">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6022235">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022248">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022374">prefixHeaderBytes</span>&nbsp;<span class="op" id="6022392">:=</span>&nbsp;<span class="ident" id="6022395">s</span><span class="op" id="6022396">.</span><span class="ident" id="6022397">next</span><span class="op" id="6022401">(</span><span class="num" id="6022402">155</span><span class="op" id="6022405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022408">tw</span><span class="op" id="6022410">.</span><span class="ident" id="6022411">cString</span><span class="op" id="6022418">(</span><span class="ident" id="6022419">prefixHeaderBytes</span><span class="op" id="6022436">,</span>&nbsp;<span class="string" id="6022438">&#34;&#34;</span><span class="op" id="6022440">,</span>&nbsp;<span class="builtintype" id="6022442">false</span><span class="op" id="6022447">,</span>&nbsp;<span class="ident" id="6022449">paxNone</span><span class="op" id="6022456">,</span>&nbsp;<span class="ident" id="6022458">nil</span><span class="op" id="6022461">)</span>&nbsp;<span class="comment" id="6022463">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022484">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022560">if</span>&nbsp;<span class="ident" id="6022563">tw</span><span class="op" id="6022565">.</span><span class="ident" id="6022566">usedBinary</span>&nbsp;<span class="op" id="6022577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6022581">copy</span><span class="op" id="6022585">(</span><span class="ident" id="6022586">header</span><span class="op" id="6022592">[</span><span class="num" id="6022593">257</span><span class="op" id="6022596">:</span><span class="num" id="6022597">265</span><span class="op" id="6022600">]</span><span class="op" id="6022601">,</span>&nbsp;<span class="op" id="6022603">[</span><span class="op" id="6022604">]</span><span class="builtintype" id="6022605">byte</span><span class="op" id="6022609">(</span><span class="string" id="6022610">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="6022623">)</span><span class="op" id="6022624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6022627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022631">_</span><span class="op" id="6022632">,</span>&nbsp;<span class="ident" id="6022634">paxPathUsed</span>&nbsp;<span class="op" id="6022646">:=</span>&nbsp;<span class="ident" id="6022649">paxHeaders</span><span class="op" id="6022659">[</span><span class="ident" id="6022660">paxPath</span><span class="op" id="6022667">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022670">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022731">if</span>&nbsp;<span class="op" id="6022734">!</span><span class="ident" id="6022735">tw</span><span class="op" id="6022737">.</span><span class="ident" id="6022738">preferPax</span>&nbsp;<span class="op" id="6022748">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6022751">len</span><span class="op" id="6022754">(</span><span class="ident" id="6022755">paxHeaders</span><span class="op" id="6022765">)</span>&nbsp;<span class="op" id="6022767">==</span>&nbsp;<span class="num" id="6022770">1</span>&nbsp;<span class="op" id="6022772">&amp;&amp;</span>&nbsp;<span class="ident" id="6022775">paxPathUsed</span>&nbsp;<span class="op" id="6022787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022791">suffix</span>&nbsp;<span class="op" id="6022798">:=</span>&nbsp;<span class="ident" id="6022801">hdr</span><span class="op" id="6022804">.</span><span class="ident" id="6022805">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022812">prefix</span>&nbsp;<span class="op" id="6022819">:=</span>&nbsp;<span class="string" id="6022822">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022827">if</span>&nbsp;<span class="builtinfunc" id="6022830">len</span><span class="op" id="6022833">(</span><span class="ident" id="6022834">hdr</span><span class="op" id="6022837">.</span><span class="ident" id="6022838">Name</span><span class="op" id="6022842">)</span>&nbsp;<span class="op" id="6022844">&gt;</span>&nbsp;<span class="ident" id="6022846">fileNameSize</span>&nbsp;<span class="op" id="6022859">&amp;&amp;</span>&nbsp;<span class="ident" id="6022862">isASCII</span><span class="op" id="6022869">(</span><span class="ident" id="6022870">hdr</span><span class="op" id="6022873">.</span><span class="ident" id="6022874">Name</span><span class="op" id="6022878">)</span>&nbsp;<span class="op" id="6022880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022885">var</span>&nbsp;<span class="ident" id="6022889">err</span>&nbsp;<span class="builtintype" id="6022893">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022902">prefix</span><span class="op" id="6022908">,</span>&nbsp;<span class="ident" id="6022910">suffix</span><span class="op" id="6022916">,</span>&nbsp;<span class="ident" id="6022918">err</span>&nbsp;<span class="op" id="6022922">=</span>&nbsp;<span class="ident" id="6022924">tw</span><span class="op" id="6022926">.</span><span class="ident" id="6022927">splitUSTARLongName</span><span class="op" id="6022945">(</span><span class="ident" id="6022946">hdr</span><span class="op" id="6022949">.</span><span class="ident" id="6022950">Name</span><span class="op" id="6022954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022959">if</span>&nbsp;<span class="ident" id="6022962">err</span>&nbsp;<span class="op" id="6022966">==</span>&nbsp;<span class="ident" id="6022969">nil</span>&nbsp;<span class="op" id="6022973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022979">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023058">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6023142">delete</span><span class="op" id="6023148">(</span><span class="ident" id="6023149">paxHeaders</span><span class="op" id="6023159">,</span>&nbsp;<span class="ident" id="6023161">paxPath</span><span class="op" id="6023168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023175">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023205">tw</span><span class="op" id="6023207">.</span><span class="ident" id="6023208">cString</span><span class="op" id="6023215">(</span><span class="ident" id="6023216">pathHeaderBytes</span><span class="op" id="6023231">,</span>&nbsp;<span class="ident" id="6023233">suffix</span><span class="op" id="6023239">,</span>&nbsp;<span class="builtintype" id="6023241">false</span><span class="op" id="6023246">,</span>&nbsp;<span class="ident" id="6023248">paxNone</span><span class="op" id="6023255">,</span>&nbsp;<span class="ident" id="6023257">nil</span><span class="op" id="6023260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023266">tw</span><span class="op" id="6023268">.</span><span class="ident" id="6023269">cString</span><span class="op" id="6023276">(</span><span class="ident" id="6023277">prefixHeaderBytes</span><span class="op" id="6023294">,</span>&nbsp;<span class="ident" id="6023296">prefix</span><span class="op" id="6023302">,</span>&nbsp;<span class="builtintype" id="6023304">false</span><span class="op" id="6023309">,</span>&nbsp;<span class="ident" id="6023311">paxNone</span><span class="op" id="6023318">,</span>&nbsp;<span class="ident" id="6023320">nil</span><span class="op" id="6023323">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023330">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023386">if</span>&nbsp;<span class="builtinfunc" id="6023389">len</span><span class="op" id="6023392">(</span><span class="ident" id="6023393">prefix</span><span class="op" id="6023399">)</span>&nbsp;<span class="op" id="6023401">&gt;</span>&nbsp;<span class="num" id="6023403">0</span>&nbsp;<span class="op" id="6023405">&amp;&amp;</span>&nbsp;<span class="op" id="6023408">!</span><span class="ident" id="6023409">tw</span><span class="op" id="6023411">.</span><span class="ident" id="6023412">usedBinary</span>&nbsp;<span class="op" id="6023423">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6023430">copy</span><span class="op" id="6023434">(</span><span class="ident" id="6023435">header</span><span class="op" id="6023441">[</span><span class="num" id="6023442">257</span><span class="op" id="6023445">:</span><span class="num" id="6023446">265</span><span class="op" id="6023449">]</span><span class="op" id="6023450">,</span>&nbsp;<span class="op" id="6023452">[</span><span class="op" id="6023453">]</span><span class="builtintype" id="6023454">byte</span><span class="op" id="6023458">(</span><span class="string" id="6023459">&#34;ustar\x00&#34;</span><span class="op" id="6023470">)</span><span class="op" id="6023471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023489">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023493">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023550">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023601">chksum</span><span class="op" id="6023607">,</span>&nbsp;<span class="ident" id="6023609">_</span>&nbsp;<span class="op" id="6023611">:=</span>&nbsp;<span class="ident" id="6023614">checksum</span><span class="op" id="6023622">(</span><span class="ident" id="6023623">header</span><span class="op" id="6023629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023632">tw</span><span class="op" id="6023634">.</span><span class="ident" id="6023635">octal</span><span class="op" id="6023640">(</span><span class="ident" id="6023641">header</span><span class="op" id="6023647">[</span><span class="num" id="6023648">148</span><span class="op" id="6023651">:</span><span class="num" id="6023652">155</span><span class="op" id="6023655">]</span><span class="op" id="6023656">,</span>&nbsp;<span class="ident" id="6023658">chksum</span><span class="op" id="6023664">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023667">header</span><span class="op" id="6023673">[</span><span class="num" id="6023674">155</span><span class="op" id="6023677">]</span>&nbsp;<span class="op" id="6023679">=</span>&nbsp;<span class="string" id="6023681">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023687">if</span>&nbsp;<span class="ident" id="6023690">tw</span><span class="op" id="6023692">.</span><span class="ident" id="6023693">err</span>&nbsp;<span class="op" id="6023697">!=</span>&nbsp;<span class="ident" id="6023700">nil</span>&nbsp;<span class="op" id="6023704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023708">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023772">return</span>&nbsp;<span class="ident" id="6023779">tw</span><span class="op" id="6023781">.</span><span class="ident" id="6023782">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023791">if</span>&nbsp;<span class="ident" id="6023794">allowPax</span>&nbsp;<span class="op" id="6023803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023807">for</span>&nbsp;<span class="ident" id="6023811">k</span><span class="op" id="6023812">,</span>&nbsp;<span class="ident" id="6023814">v</span>&nbsp;<span class="op" id="6023816">:=</span>&nbsp;<span class="keyword" id="6023819">range</span>&nbsp;<span class="ident" id="6023825">hdr</span><span class="op" id="6023828">.</span><span class="ident" id="6023829">Xattrs</span>&nbsp;<span class="op" id="6023836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023841">paxHeaders</span><span class="op" id="6023851">[</span><span class="ident" id="6023852">paxXattr</span><span class="op" id="6023860">+</span><span class="ident" id="6023861">k</span><span class="op" id="6023862">]</span>&nbsp;<span class="op" id="6023864">=</span>&nbsp;<span class="ident" id="6023866">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023877">if</span>&nbsp;<span class="builtinfunc" id="6023880">len</span><span class="op" id="6023883">(</span><span class="ident" id="6023884">paxHeaders</span><span class="op" id="6023894">)</span>&nbsp;<span class="op" id="6023896">&gt;</span>&nbsp;<span class="num" id="6023898">0</span>&nbsp;<span class="op" id="6023900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023904">if</span>&nbsp;<span class="op" id="6023907">!</span><span class="ident" id="6023908">allowPax</span>&nbsp;<span class="op" id="6023917">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023922">return</span>&nbsp;<span class="ident" id="6023929">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023952">if</span>&nbsp;<span class="ident" id="6023955">err</span>&nbsp;<span class="op" id="6023959">:=</span>&nbsp;<span class="ident" id="6023962">tw</span><span class="op" id="6023964">.</span><span class="ident" id="6023965">writePAXHeader</span><span class="op" id="6023979">(</span><span class="ident" id="6023980">hdr</span><span class="op" id="6023983">,</span>&nbsp;<span class="ident" id="6023985">paxHeaders</span><span class="op" id="6023995">)</span><span class="op" id="6023996">;</span>&nbsp;<span class="ident" id="6023998">err</span>&nbsp;<span class="op" id="6024002">!=</span>&nbsp;<span class="ident" id="6024005">nil</span>&nbsp;<span class="op" id="6024009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024014">return</span>&nbsp;<span class="ident" id="6024021">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024027">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024033">tw</span><span class="op" id="6024035">.</span><span class="ident" id="6024036">nb</span>&nbsp;<span class="op" id="6024039">=</span>&nbsp;<span class="ident" id="6024041">int64</span><span class="op" id="6024046">(</span><span class="ident" id="6024047">hdr</span><span class="op" id="6024050">.</span><span class="ident" id="6024051">Size</span><span class="op" id="6024055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024058">tw</span><span class="op" id="6024060">.</span><span class="ident" id="6024061">pad</span>&nbsp;<span class="op" id="6024065">=</span>&nbsp;<span class="op" id="6024067">(</span><span class="ident" id="6024068">blockSize</span>&nbsp;<span class="op" id="6024078">-</span>&nbsp;<span class="op" id="6024080">(</span><span class="ident" id="6024081">tw</span><span class="op" id="6024083">.</span><span class="ident" id="6024084">nb</span>&nbsp;<span class="op" id="6024087">%</span>&nbsp;<span class="ident" id="6024089">blockSize</span><span class="op" id="6024098">)</span><span class="op" id="6024099">)</span>&nbsp;<span class="op" id="6024101">%</span>&nbsp;<span class="ident" id="6024103">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024115">_</span><span class="op" id="6024116">,</span>&nbsp;<span class="ident" id="6024118">tw</span><span class="op" id="6024120">.</span><span class="ident" id="6024121">err</span>&nbsp;<span class="op" id="6024125">=</span>&nbsp;<span class="ident" id="6024127">tw</span><span class="op" id="6024129">.</span><span class="ident" id="6024130">w</span><span class="op" id="6024131">.</span><span class="ident" id="6024132">Write</span><span class="op" id="6024137">(</span><span class="ident" id="6024138">header</span><span class="op" id="6024144">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024147">return</span>&nbsp;<span class="ident" id="6024154">tw</span><span class="op" id="6024156">.</span><span class="ident" id="6024157">err</span><br>
<span class="lineno"></span><span class="op" id="6024161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6024164">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="6024221">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="6024282">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="6024337">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="6024368">func</span>&nbsp;<span class="op" id="6024373">(</span><span class="ident" id="6024374">tw</span>&nbsp;<span class="op" id="6024377">*</span><span class="ident" id="6024378">Writer</span><span class="op" id="6024384">)</span>&nbsp;<span class="ident" id="6024386">splitUSTARLongName</span><span class="op" id="6024404">(</span><span class="ident" id="6024405">name</span>&nbsp;<span class="builtintype" id="6024410">string</span><span class="op" id="6024416">)</span>&nbsp;<span class="op" id="6024418">(</span><span class="ident" id="6024419">prefix</span><span class="op" id="6024425">,</span>&nbsp;<span class="ident" id="6024427">suffix</span>&nbsp;<span class="builtintype" id="6024434">string</span><span class="op" id="6024440">,</span>&nbsp;<span class="ident" id="6024442">err</span>&nbsp;<span class="builtintype" id="6024446">error</span><span class="op" id="6024451">)</span>&nbsp;<span class="op" id="6024453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024456">length</span>&nbsp;<span class="op" id="6024463">:=</span>&nbsp;<span class="builtinfunc" id="6024466">len</span><span class="op" id="6024469">(</span><span class="ident" id="6024470">name</span><span class="op" id="6024474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024477">if</span>&nbsp;<span class="ident" id="6024480">length</span>&nbsp;<span class="op" id="6024487">&gt;</span>&nbsp;<span class="ident" id="6024489">fileNamePrefixSize</span><span class="op" id="6024507">+</span><span class="num" id="6024508">1</span>&nbsp;<span class="op" id="6024510">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024514">length</span>&nbsp;<span class="op" id="6024521">=</span>&nbsp;<span class="ident" id="6024523">fileNamePrefixSize</span>&nbsp;<span class="op" id="6024542">+</span>&nbsp;<span class="num" id="6024544">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024547">}</span>&nbsp;<span class="keyword" id="6024549">else</span>&nbsp;<span class="keyword" id="6024554">if</span>&nbsp;<span class="ident" id="6024557">name</span><span class="op" id="6024561">[</span><span class="ident" id="6024562">length</span><span class="op" id="6024568">-</span><span class="num" id="6024569">1</span><span class="op" id="6024570">]</span>&nbsp;<span class="op" id="6024572">==</span>&nbsp;<span class="string" id="6024575">&#39;/&#39;</span>&nbsp;<span class="op" id="6024579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024583">length</span><span class="op" id="6024589">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024596">i</span>&nbsp;<span class="op" id="6024598">:=</span>&nbsp;<span class="ident" id="6024601">strings</span><span class="op" id="6024608">.</span><span class="ident" id="6024609">LastIndex</span><span class="op" id="6024618">(</span><span class="ident" id="6024619">name</span><span class="op" id="6024623">[</span><span class="op" id="6024624">:</span><span class="ident" id="6024625">length</span><span class="op" id="6024631">]</span><span class="op" id="6024632">,</span>&nbsp;<span class="string" id="6024634">&#34;/&#34;</span><span class="op" id="6024637">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6024640">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6024698">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024758">nlen</span>&nbsp;<span class="op" id="6024763">:=</span>&nbsp;<span class="builtinfunc" id="6024766">len</span><span class="op" id="6024769">(</span><span class="ident" id="6024770">name</span><span class="op" id="6024774">)</span>&nbsp;<span class="op" id="6024776">-</span>&nbsp;<span class="ident" id="6024778">i</span>&nbsp;<span class="op" id="6024780">-</span>&nbsp;<span class="num" id="6024782">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024785">plen</span>&nbsp;<span class="op" id="6024790">:=</span>&nbsp;<span class="ident" id="6024793">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024796">if</span>&nbsp;<span class="ident" id="6024799">i</span>&nbsp;<span class="op" id="6024801">&lt;=</span>&nbsp;<span class="num" id="6024804">0</span>&nbsp;<span class="op" id="6024806">||</span>&nbsp;<span class="ident" id="6024809">nlen</span>&nbsp;<span class="op" id="6024814">&gt;</span>&nbsp;<span class="ident" id="6024816">fileNameSize</span>&nbsp;<span class="op" id="6024829">||</span>&nbsp;<span class="ident" id="6024832">nlen</span>&nbsp;<span class="op" id="6024837">==</span>&nbsp;<span class="num" id="6024840">0</span>&nbsp;<span class="op" id="6024842">||</span>&nbsp;<span class="ident" id="6024845">plen</span>&nbsp;<span class="op" id="6024850">&gt;</span>&nbsp;<span class="ident" id="6024852">fileNamePrefixSize</span>&nbsp;<span class="op" id="6024871">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024875">err</span>&nbsp;<span class="op" id="6024879">=</span>&nbsp;<span class="ident" id="6024881">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024898">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024909">prefix</span><span class="op" id="6024915">,</span>&nbsp;<span class="ident" id="6024917">suffix</span>&nbsp;<span class="op" id="6024924">=</span>&nbsp;<span class="ident" id="6024926">name</span><span class="op" id="6024930">[</span><span class="op" id="6024931">:</span><span class="ident" id="6024932">i</span><span class="op" id="6024933">]</span><span class="op" id="6024934">,</span>&nbsp;<span class="ident" id="6024936">name</span><span class="op" id="6024940">[</span><span class="ident" id="6024941">i</span><span class="op" id="6024942">+</span><span class="num" id="6024943">1</span><span class="op" id="6024944">:</span><span class="op" id="6024945">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024948">return</span><br>
<span class="lineno">295</span><span class="op" id="6024955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6024958">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6025013">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="6025025">func</span>&nbsp;<span class="op" id="6025030">(</span><span class="ident" id="6025031">tw</span>&nbsp;<span class="op" id="6025034">*</span><span class="ident" id="6025035">Writer</span><span class="op" id="6025041">)</span>&nbsp;<span class="ident" id="6025043">writePAXHeader</span><span class="op" id="6025057">(</span><span class="ident" id="6025058">hdr</span>&nbsp;<span class="op" id="6025062">*</span><span class="ident" id="6025063">Header</span><span class="op" id="6025069">,</span>&nbsp;<span class="ident" id="6025071">paxHeaders</span>&nbsp;<span class="keyword" id="6025082">map</span><span class="op" id="6025085">[</span><span class="builtintype" id="6025086">string</span><span class="op" id="6025092">]</span><span class="builtintype" id="6025093">string</span><span class="op" id="6025099">)</span>&nbsp;<span class="builtintype" id="6025101">error</span>&nbsp;<span class="op" id="6025107">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6025110">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025138">ext</span>&nbsp;<span class="op" id="6025142">:=</span>&nbsp;<span class="builtinfunc" id="6025145">new</span><span class="op" id="6025148">(</span><span class="ident" id="6025149">Header</span><span class="op" id="6025155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025158">ext</span><span class="op" id="6025161">.</span><span class="ident" id="6025162">Typeflag</span>&nbsp;<span class="op" id="6025171">=</span>&nbsp;<span class="ident" id="6025173">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6025186">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6025240">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025280">ext</span><span class="op" id="6025283">.</span><span class="ident" id="6025284">ModTime</span>&nbsp;<span class="op" id="6025292">=</span>&nbsp;<span class="ident" id="6025294">hdr</span><span class="op" id="6025297">.</span><span class="ident" id="6025298">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6025307">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6025360">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025386">pid</span>&nbsp;<span class="op" id="6025390">:=</span>&nbsp;<span class="ident" id="6025393">os</span><span class="op" id="6025395">.</span><span class="ident" id="6025396">Getpid</span><span class="op" id="6025402">(</span><span class="op" id="6025403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025406">dir</span><span class="op" id="6025409">,</span>&nbsp;<span class="ident" id="6025411">file</span>&nbsp;<span class="op" id="6025416">:=</span>&nbsp;<span class="ident" id="6025419">path</span><span class="op" id="6025423">.</span><span class="ident" id="6025424">Split</span><span class="op" id="6025429">(</span><span class="ident" id="6025430">hdr</span><span class="op" id="6025433">.</span><span class="ident" id="6025434">Name</span><span class="op" id="6025438">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025441">fullName</span>&nbsp;<span class="op" id="6025450">:=</span>&nbsp;<span class="ident" id="6025453">path</span><span class="op" id="6025457">.</span><span class="ident" id="6025458">Join</span><span class="op" id="6025462">(</span><span class="ident" id="6025463">dir</span><span class="op" id="6025466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025470">fmt</span><span class="op" id="6025473">.</span><span class="ident" id="6025474">Sprintf</span><span class="op" id="6025481">(</span><span class="string" id="6025482">&#34;PaxHeaders.%d&#34;</span><span class="op" id="6025497">,</span>&nbsp;<span class="ident" id="6025499">pid</span><span class="op" id="6025502">)</span><span class="op" id="6025503">,</span>&nbsp;<span class="ident" id="6025505">file</span><span class="op" id="6025509">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025513">ascii</span>&nbsp;<span class="op" id="6025519">:=</span>&nbsp;<span class="ident" id="6025522">toASCII</span><span class="op" id="6025529">(</span><span class="ident" id="6025530">fullName</span><span class="op" id="6025538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025541">if</span>&nbsp;<span class="builtinfunc" id="6025544">len</span><span class="op" id="6025547">(</span><span class="ident" id="6025548">ascii</span><span class="op" id="6025553">)</span>&nbsp;<span class="op" id="6025555">&gt;</span>&nbsp;<span class="num" id="6025557">100</span>&nbsp;<span class="op" id="6025561">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025565">ascii</span>&nbsp;<span class="op" id="6025571">=</span>&nbsp;<span class="ident" id="6025573">ascii</span><span class="op" id="6025578">[</span><span class="op" id="6025579">:</span><span class="num" id="6025580">100</span><span class="op" id="6025583">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025589">ext</span><span class="op" id="6025592">.</span><span class="ident" id="6025593">Name</span>&nbsp;<span class="op" id="6025598">=</span>&nbsp;<span class="ident" id="6025600">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6025607">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025630">var</span>&nbsp;<span class="ident" id="6025634">buf</span>&nbsp;<span class="ident" id="6025638">bytes</span><span class="op" id="6025643">.</span><span class="ident" id="6025644">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025653">for</span>&nbsp;<span class="ident" id="6025657">k</span><span class="op" id="6025658">,</span>&nbsp;<span class="ident" id="6025660">v</span>&nbsp;<span class="op" id="6025662">:=</span>&nbsp;<span class="keyword" id="6025665">range</span>&nbsp;<span class="ident" id="6025671">paxHeaders</span>&nbsp;<span class="op" id="6025682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025686">fmt</span><span class="op" id="6025689">.</span><span class="ident" id="6025690">Fprint</span><span class="op" id="6025696">(</span><span class="op" id="6025697">&amp;</span><span class="ident" id="6025698">buf</span><span class="op" id="6025701">,</span>&nbsp;<span class="ident" id="6025703">paxHeader</span><span class="op" id="6025712">(</span><span class="ident" id="6025713">k</span><span class="op" id="6025714">+</span><span class="string" id="6025715">&#34;=&#34;</span><span class="op" id="6025718">+</span><span class="ident" id="6025719">v</span><span class="op" id="6025720">)</span><span class="op" id="6025721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025728">ext</span><span class="op" id="6025731">.</span><span class="ident" id="6025732">Size</span>&nbsp;<span class="op" id="6025737">=</span>&nbsp;<span class="ident" id="6025739">int64</span><span class="op" id="6025744">(</span><span class="builtinfunc" id="6025745">len</span><span class="op" id="6025748">(</span><span class="ident" id="6025749">buf</span><span class="op" id="6025752">.</span><span class="ident" id="6025753">Bytes</span><span class="op" id="6025758">(</span><span class="op" id="6025759">)</span><span class="op" id="6025760">)</span><span class="op" id="6025761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025764">if</span>&nbsp;<span class="ident" id="6025767">err</span>&nbsp;<span class="op" id="6025771">:=</span>&nbsp;<span class="ident" id="6025774">tw</span><span class="op" id="6025776">.</span><span class="ident" id="6025777">writeHeader</span><span class="op" id="6025788">(</span><span class="ident" id="6025789">ext</span><span class="op" id="6025792">,</span>&nbsp;<span class="builtintype" id="6025794">false</span><span class="op" id="6025799">)</span><span class="op" id="6025800">;</span>&nbsp;<span class="ident" id="6025802">err</span>&nbsp;<span class="op" id="6025806">!=</span>&nbsp;<span class="ident" id="6025809">nil</span>&nbsp;<span class="op" id="6025813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025817">return</span>&nbsp;<span class="ident" id="6025824">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025832">if</span>&nbsp;<span class="ident" id="6025835">_</span><span class="op" id="6025836">,</span>&nbsp;<span class="ident" id="6025838">err</span>&nbsp;<span class="op" id="6025842">:=</span>&nbsp;<span class="ident" id="6025845">tw</span><span class="op" id="6025847">.</span><span class="ident" id="6025848">Write</span><span class="op" id="6025853">(</span><span class="ident" id="6025854">buf</span><span class="op" id="6025857">.</span><span class="ident" id="6025858">Bytes</span><span class="op" id="6025863">(</span><span class="op" id="6025864">)</span><span class="op" id="6025865">)</span><span class="op" id="6025866">;</span>&nbsp;<span class="ident" id="6025868">err</span>&nbsp;<span class="op" id="6025872">!=</span>&nbsp;<span class="ident" id="6025875">nil</span>&nbsp;<span class="op" id="6025879">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025883">return</span>&nbsp;<span class="ident" id="6025890">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025898">if</span>&nbsp;<span class="ident" id="6025901">err</span>&nbsp;<span class="op" id="6025905">:=</span>&nbsp;<span class="ident" id="6025908">tw</span><span class="op" id="6025910">.</span><span class="ident" id="6025911">Flush</span><span class="op" id="6025916">(</span><span class="op" id="6025917">)</span><span class="op" id="6025918">;</span>&nbsp;<span class="ident" id="6025920">err</span>&nbsp;<span class="op" id="6025924">!=</span>&nbsp;<span class="ident" id="6025927">nil</span>&nbsp;<span class="op" id="6025931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025935">return</span>&nbsp;<span class="ident" id="6025942">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025947">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025950">return</span>&nbsp;<span class="ident" id="6025957">nil</span><br>
<span class="lineno"></span><span class="op" id="6025961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6025964">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="6026047">func</span>&nbsp;<span class="ident" id="6026052">paxHeader</span><span class="op" id="6026061">(</span><span class="ident" id="6026062">msg</span>&nbsp;<span class="builtintype" id="6026066">string</span><span class="op" id="6026072">)</span>&nbsp;<span class="builtintype" id="6026074">string</span>&nbsp;<span class="op" id="6026081">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026084">const</span>&nbsp;<span class="ident" id="6026090">padding</span>&nbsp;<span class="op" id="6026098">=</span>&nbsp;<span class="num" id="6026100">2</span>&nbsp;<span class="comment" id="6026102">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026142">size</span>&nbsp;<span class="op" id="6026147">:=</span>&nbsp;<span class="builtinfunc" id="6026150">len</span><span class="op" id="6026153">(</span><span class="ident" id="6026154">msg</span><span class="op" id="6026157">)</span>&nbsp;<span class="op" id="6026159">+</span>&nbsp;<span class="ident" id="6026161">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026170">size</span>&nbsp;<span class="op" id="6026175">+=</span>&nbsp;<span class="builtinfunc" id="6026178">len</span><span class="op" id="6026181">(</span><span class="ident" id="6026182">strconv</span><span class="op" id="6026189">.</span><span class="ident" id="6026190">Itoa</span><span class="op" id="6026194">(</span><span class="ident" id="6026195">size</span><span class="op" id="6026199">)</span><span class="op" id="6026200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026203">record</span>&nbsp;<span class="op" id="6026210">:=</span>&nbsp;<span class="ident" id="6026213">fmt</span><span class="op" id="6026216">.</span><span class="ident" id="6026217">Sprintf</span><span class="op" id="6026224">(</span><span class="string" id="6026225">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6026234">,</span>&nbsp;<span class="ident" id="6026236">size</span><span class="op" id="6026240">,</span>&nbsp;<span class="ident" id="6026242">msg</span><span class="op" id="6026245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026248">if</span>&nbsp;<span class="builtinfunc" id="6026251">len</span><span class="op" id="6026254">(</span><span class="ident" id="6026255">record</span><span class="op" id="6026261">)</span>&nbsp;<span class="op" id="6026263">!=</span>&nbsp;<span class="ident" id="6026266">size</span>&nbsp;<span class="op" id="6026271">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6026275">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6026322">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026356">size</span>&nbsp;<span class="op" id="6026361">=</span>&nbsp;<span class="builtinfunc" id="6026363">len</span><span class="op" id="6026366">(</span><span class="ident" id="6026367">record</span><span class="op" id="6026373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026377">record</span>&nbsp;<span class="op" id="6026384">=</span>&nbsp;<span class="ident" id="6026386">fmt</span><span class="op" id="6026389">.</span><span class="ident" id="6026390">Sprintf</span><span class="op" id="6026397">(</span><span class="string" id="6026398">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6026407">,</span>&nbsp;<span class="ident" id="6026409">size</span><span class="op" id="6026413">,</span>&nbsp;<span class="ident" id="6026415">msg</span><span class="op" id="6026418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026421">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026424">return</span>&nbsp;<span class="ident" id="6026431">record</span><br>
<span class="lineno"></span><span class="op" id="6026438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6026441">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="6026498">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="6026554">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="6026603">func</span>&nbsp;<span class="op" id="6026608">(</span><span class="ident" id="6026609">tw</span>&nbsp;<span class="op" id="6026612">*</span><span class="ident" id="6026613">Writer</span><span class="op" id="6026619">)</span>&nbsp;<span class="ident" id="6026621">Write</span><span class="op" id="6026626">(</span><span class="ident" id="6026627">b</span>&nbsp;<span class="op" id="6026629">[</span><span class="op" id="6026630">]</span><span class="builtintype" id="6026631">byte</span><span class="op" id="6026635">)</span>&nbsp;<span class="op" id="6026637">(</span><span class="ident" id="6026638">n</span>&nbsp;<span class="builtintype" id="6026640">int</span><span class="op" id="6026643">,</span>&nbsp;<span class="ident" id="6026645">err</span>&nbsp;<span class="builtintype" id="6026649">error</span><span class="op" id="6026654">)</span>&nbsp;<span class="op" id="6026656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026659">if</span>&nbsp;<span class="ident" id="6026662">tw</span><span class="op" id="6026664">.</span><span class="ident" id="6026665">closed</span>&nbsp;<span class="op" id="6026672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026676">err</span>&nbsp;<span class="op" id="6026680">=</span>&nbsp;<span class="ident" id="6026682">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026700">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026711">overwrite</span>&nbsp;<span class="op" id="6026721">:=</span>&nbsp;<span class="builtintype" id="6026724">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026731">if</span>&nbsp;<span class="ident" id="6026734">int64</span><span class="op" id="6026739">(</span><span class="builtinfunc" id="6026740">len</span><span class="op" id="6026743">(</span><span class="ident" id="6026744">b</span><span class="op" id="6026745">)</span><span class="op" id="6026746">)</span>&nbsp;<span class="op" id="6026748">&gt;</span>&nbsp;<span class="ident" id="6026750">tw</span><span class="op" id="6026752">.</span><span class="ident" id="6026753">nb</span>&nbsp;<span class="op" id="6026756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026760">b</span>&nbsp;<span class="op" id="6026762">=</span>&nbsp;<span class="ident" id="6026764">b</span><span class="op" id="6026765">[</span><span class="num" id="6026766">0</span><span class="op" id="6026767">:</span><span class="ident" id="6026768">tw</span><span class="op" id="6026770">.</span><span class="ident" id="6026771">nb</span><span class="op" id="6026773">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026777">overwrite</span>&nbsp;<span class="op" id="6026787">=</span>&nbsp;<span class="builtintype" id="6026789">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026798">n</span><span class="op" id="6026799">,</span>&nbsp;<span class="ident" id="6026801">err</span>&nbsp;<span class="op" id="6026805">=</span>&nbsp;<span class="ident" id="6026807">tw</span><span class="op" id="6026809">.</span><span class="ident" id="6026810">w</span><span class="op" id="6026811">.</span><span class="ident" id="6026812">Write</span><span class="op" id="6026817">(</span><span class="ident" id="6026818">b</span><span class="op" id="6026819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026822">tw</span><span class="op" id="6026824">.</span><span class="ident" id="6026825">nb</span>&nbsp;<span class="op" id="6026828">-=</span>&nbsp;<span class="ident" id="6026831">int64</span><span class="op" id="6026836">(</span><span class="ident" id="6026837">n</span><span class="op" id="6026838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026841">if</span>&nbsp;<span class="ident" id="6026844">err</span>&nbsp;<span class="op" id="6026848">==</span>&nbsp;<span class="ident" id="6026851">nil</span>&nbsp;<span class="op" id="6026855">&amp;&amp;</span>&nbsp;<span class="ident" id="6026858">overwrite</span>&nbsp;<span class="op" id="6026868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026872">err</span>&nbsp;<span class="op" id="6026876">=</span>&nbsp;<span class="ident" id="6026878">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026896">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026907">tw</span><span class="op" id="6026909">.</span><span class="ident" id="6026910">err</span>&nbsp;<span class="op" id="6026914">=</span>&nbsp;<span class="ident" id="6026916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026921">return</span><br>
<span class="lineno"></span><span class="op" id="6026928">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="6026931">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="6026987">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6027021">func</span>&nbsp;<span class="op" id="6027026">(</span><span class="ident" id="6027027">tw</span>&nbsp;<span class="op" id="6027030">*</span><span class="ident" id="6027031">Writer</span><span class="op" id="6027037">)</span>&nbsp;<span class="ident" id="6027039">Close</span><span class="op" id="6027044">(</span><span class="op" id="6027045">)</span>&nbsp;<span class="builtintype" id="6027047">error</span>&nbsp;<span class="op" id="6027053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027056">if</span>&nbsp;<span class="ident" id="6027059">tw</span><span class="op" id="6027061">.</span><span class="ident" id="6027062">err</span>&nbsp;<span class="op" id="6027066">!=</span>&nbsp;<span class="ident" id="6027069">nil</span>&nbsp;<span class="op" id="6027073">||</span>&nbsp;<span class="ident" id="6027076">tw</span><span class="op" id="6027078">.</span><span class="ident" id="6027079">closed</span>&nbsp;<span class="op" id="6027086">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027090">return</span>&nbsp;<span class="ident" id="6027097">tw</span><span class="op" id="6027099">.</span><span class="ident" id="6027100">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027108">tw</span><span class="op" id="6027110">.</span><span class="ident" id="6027111">Flush</span><span class="op" id="6027116">(</span><span class="op" id="6027117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027120">tw</span><span class="op" id="6027122">.</span><span class="ident" id="6027123">closed</span>&nbsp;<span class="op" id="6027130">=</span>&nbsp;<span class="builtintype" id="6027132">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027138">if</span>&nbsp;<span class="ident" id="6027141">tw</span><span class="op" id="6027143">.</span><span class="ident" id="6027144">err</span>&nbsp;<span class="op" id="6027148">!=</span>&nbsp;<span class="ident" id="6027151">nil</span>&nbsp;<span class="op" id="6027155">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027159">return</span>&nbsp;<span class="ident" id="6027166">tw</span><span class="op" id="6027168">.</span><span class="ident" id="6027169">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6027178">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027207">for</span>&nbsp;<span class="ident" id="6027211">i</span>&nbsp;<span class="op" id="6027213">:=</span>&nbsp;<span class="num" id="6027216">0</span><span class="op" id="6027217">;</span>&nbsp;<span class="ident" id="6027219">i</span>&nbsp;<span class="op" id="6027221">&lt;</span>&nbsp;<span class="num" id="6027223">2</span><span class="op" id="6027224">;</span>&nbsp;<span class="ident" id="6027226">i</span><span class="op" id="6027227">++</span>&nbsp;<span class="op" id="6027230">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027234">_</span><span class="op" id="6027235">,</span>&nbsp;<span class="ident" id="6027237">tw</span><span class="op" id="6027239">.</span><span class="ident" id="6027240">err</span>&nbsp;<span class="op" id="6027244">=</span>&nbsp;<span class="ident" id="6027246">tw</span><span class="op" id="6027248">.</span><span class="ident" id="6027249">w</span><span class="op" id="6027250">.</span><span class="ident" id="6027251">Write</span><span class="op" id="6027256">(</span><span class="ident" id="6027257">zeroBlock</span><span class="op" id="6027266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027270">if</span>&nbsp;<span class="ident" id="6027273">tw</span><span class="op" id="6027275">.</span><span class="ident" id="6027276">err</span>&nbsp;<span class="op" id="6027280">!=</span>&nbsp;<span class="ident" id="6027283">nil</span>&nbsp;<span class="op" id="6027287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027292">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027303">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027306">return</span>&nbsp;<span class="ident" id="6027313">tw</span><span class="op" id="6027315">.</span><span class="ident" id="6027316">err</span><br>
<span class="lineno"></span><span class="op" id="6027320">}</span>
</div>
</body>
</html>
