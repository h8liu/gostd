<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html" class="current">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1614135">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1614190">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1614244">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1614295">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1614338">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1614384">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1614436">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1614476">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1614527">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1614565">//</span><br>
<span class="lineno"></span><span class="comment" id="1614568">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1614616">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1614672">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1614729">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1614792">//</span><br>
<span class="lineno"></span><span class="comment" id="1614795">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1614847">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1614882">package</span>&nbsp;<span class="ident" id="1614890">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1614899">import</span>&nbsp;<span class="string" id="1614906">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1614916">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1614959">type</span>&nbsp;<span class="ident" id="1614964">semaRoot</span>&nbsp;<span class="keyword" id="1614973">struct</span>&nbsp;<span class="op" id="1614980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1614983">lock</span>&nbsp;&nbsp;<span class="ident" id="1614989">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1614996">head</span>&nbsp;&nbsp;<span class="op" id="1615002">*</span><span class="ident" id="1615003">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615010">tail</span>&nbsp;&nbsp;<span class="op" id="1615016">*</span><span class="ident" id="1615017">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615024">nwait</span>&nbsp;<span class="builtintype" id="1615030">uint32</span>&nbsp;<span class="comment" id="1615037">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1615078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1615081">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1615131">const</span>&nbsp;<span class="ident" id="1615137">semTabSize</span>&nbsp;<span class="op" id="1615148">=</span>&nbsp;<span class="num" id="1615150">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1615155">var</span>&nbsp;<span class="ident" id="1615159">semtable</span>&nbsp;<span class="op" id="1615168">[</span><span class="ident" id="1615169">semTabSize</span><span class="op" id="1615179">]</span><span class="keyword" id="1615180">struct</span>&nbsp;<span class="op" id="1615187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615190">root</span>&nbsp;<span class="ident" id="1615195">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615205">pad</span>&nbsp;&nbsp;<span class="op" id="1615210">[</span><span class="ident" id="1615211">_CacheLineSize</span>&nbsp;<span class="op" id="1615226">-</span>&nbsp;<span class="ident" id="1615228">unsafe</span><span class="op" id="1615234">.</span><span class="ident" id="1615235">Sizeof</span><span class="op" id="1615241">(</span><span class="ident" id="1615242">semaRoot</span><span class="op" id="1615250">{</span><span class="op" id="1615251">}</span><span class="op" id="1615252">)</span><span class="op" id="1615253">]</span><span class="builtintype" id="1615254">byte</span><br>
<span class="lineno"></span><span class="op" id="1615259">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1615262">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1615296">func</span>&nbsp;<span class="ident" id="1615301">asyncsemacquire</span><span class="op" id="1615316">(</span><span class="ident" id="1615317">addr</span>&nbsp;<span class="op" id="1615322">*</span><span class="builtintype" id="1615323">uint32</span><span class="op" id="1615329">)</span>&nbsp;<span class="op" id="1615331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615334">semacquire</span><span class="op" id="1615344">(</span><span class="ident" id="1615345">addr</span><span class="op" id="1615349">,</span>&nbsp;<span class="builtintype" id="1615351">true</span><span class="op" id="1615355">)</span><br>
<span class="lineno"></span><span class="op" id="1615357">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1615360">func</span>&nbsp;<span class="ident" id="1615365">asyncsemrelease</span><span class="op" id="1615380">(</span><span class="ident" id="1615381">addr</span>&nbsp;<span class="op" id="1615386">*</span><span class="builtintype" id="1615387">uint32</span><span class="op" id="1615393">)</span>&nbsp;<span class="op" id="1615395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615398">semrelease</span><span class="op" id="1615408">(</span><span class="ident" id="1615409">addr</span><span class="op" id="1615413">)</span><br>
<span class="lineno"></span><span class="op" id="1615415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1615418">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1615442">func</span>&nbsp;<span class="ident" id="1615447">semacquire</span><span class="op" id="1615457">(</span><span class="ident" id="1615458">addr</span>&nbsp;<span class="op" id="1615463">*</span><span class="builtintype" id="1615464">uint32</span><span class="op" id="1615470">,</span>&nbsp;<span class="ident" id="1615472">profile</span>&nbsp;<span class="builtintype" id="1615480">bool</span><span class="op" id="1615484">)</span>&nbsp;<span class="op" id="1615486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615489">gp</span>&nbsp;<span class="op" id="1615492">:=</span>&nbsp;<span class="ident" id="1615495">getg</span><span class="op" id="1615499">(</span><span class="op" id="1615500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1615503">if</span>&nbsp;<span class="ident" id="1615506">gp</span>&nbsp;<span class="op" id="1615509">!=</span>&nbsp;<span class="ident" id="1615512">gp</span><span class="op" id="1615514">.</span><span class="ident" id="1615515">m</span><span class="op" id="1615516">.</span><span class="ident" id="1615517">curg</span>&nbsp;<span class="op" id="1615522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615526">gothrow</span><span class="op" id="1615533">(</span><span class="string" id="1615534">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1615565">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615572">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1615587">if</span>&nbsp;<span class="ident" id="1615590">cansemacquire</span><span class="op" id="1615603">(</span><span class="ident" id="1615604">addr</span><span class="op" id="1615608">)</span>&nbsp;<span class="op" id="1615610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1615614">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615626">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615643">//&nbsp;&nbsp;&nbsp;&nbsp;increment&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615670">//&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615727">//&nbsp;&nbsp;&nbsp;&nbsp;enqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615758">//&nbsp;&nbsp;&nbsp;&nbsp;sleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1615768">//&nbsp;&nbsp;&nbsp;&nbsp;(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615816">s</span>&nbsp;<span class="op" id="1615818">:=</span>&nbsp;<span class="ident" id="1615821">acquireSudog</span><span class="op" id="1615833">(</span><span class="op" id="1615834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615837">root</span>&nbsp;<span class="op" id="1615842">:=</span>&nbsp;<span class="ident" id="1615845">semroot</span><span class="op" id="1615852">(</span><span class="ident" id="1615853">addr</span><span class="op" id="1615857">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615860">t0</span>&nbsp;<span class="op" id="1615863">:=</span>&nbsp;<span class="builtintype" id="1615866">int64</span><span class="op" id="1615871">(</span><span class="num" id="1615872">0</span><span class="op" id="1615873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615876">s</span><span class="op" id="1615877">.</span><span class="ident" id="1615878">releasetime</span>&nbsp;<span class="op" id="1615890">=</span>&nbsp;<span class="num" id="1615892">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1615895">if</span>&nbsp;<span class="ident" id="1615898">profile</span>&nbsp;<span class="op" id="1615906">&amp;&amp;</span>&nbsp;<span class="ident" id="1615909">blockprofilerate</span>&nbsp;<span class="op" id="1615926">&gt;</span>&nbsp;<span class="num" id="1615928">0</span>&nbsp;<span class="op" id="1615930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615934">t0</span>&nbsp;<span class="op" id="1615937">=</span>&nbsp;<span class="ident" id="1615939">cputicks</span><span class="op" id="1615947">(</span><span class="op" id="1615948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615952">s</span><span class="op" id="1615953">.</span><span class="ident" id="1615954">releasetime</span>&nbsp;<span class="op" id="1615966">=</span>&nbsp;<span class="op" id="1615968">-</span><span class="num" id="1615969">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1615975">for</span>&nbsp;<span class="op" id="1615979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1615983">lock</span><span class="op" id="1615987">(</span><span class="op" id="1615988">&amp;</span><span class="ident" id="1615989">root</span><span class="op" id="1615993">.</span><span class="ident" id="1615994">lock</span><span class="op" id="1615998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616002">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616068">xadd</span><span class="op" id="1616072">(</span><span class="op" id="1616073">&amp;</span><span class="ident" id="1616074">root</span><span class="op" id="1616078">.</span><span class="ident" id="1616079">nwait</span><span class="op" id="1616084">,</span>&nbsp;<span class="num" id="1616086">1</span><span class="op" id="1616087">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616091">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616140">if</span>&nbsp;<span class="ident" id="1616143">cansemacquire</span><span class="op" id="1616156">(</span><span class="ident" id="1616157">addr</span><span class="op" id="1616161">)</span>&nbsp;<span class="op" id="1616163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616168">xadd</span><span class="op" id="1616172">(</span><span class="op" id="1616173">&amp;</span><span class="ident" id="1616174">root</span><span class="op" id="1616178">.</span><span class="ident" id="1616179">nwait</span><span class="op" id="1616184">,</span>&nbsp;<span class="op" id="1616186">-</span><span class="num" id="1616187">1</span><span class="op" id="1616188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616193">unlock</span><span class="op" id="1616199">(</span><span class="op" id="1616200">&amp;</span><span class="ident" id="1616201">root</span><span class="op" id="1616205">.</span><span class="ident" id="1616206">lock</span><span class="op" id="1616210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616215">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1616223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616227">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616291">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616334">root</span><span class="op" id="1616338">.</span><span class="ident" id="1616339">queue</span><span class="op" id="1616344">(</span><span class="ident" id="1616345">addr</span><span class="op" id="1616349">,</span>&nbsp;<span class="ident" id="1616351">s</span><span class="op" id="1616352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616356">goparkunlock</span><span class="op" id="1616368">(</span><span class="op" id="1616369">&amp;</span><span class="ident" id="1616370">root</span><span class="op" id="1616374">.</span><span class="ident" id="1616375">lock</span><span class="op" id="1616379">,</span>&nbsp;<span class="string" id="1616381">&#34;semacquire&#34;</span><span class="op" id="1616393">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616397">if</span>&nbsp;<span class="ident" id="1616400">cansemacquire</span><span class="op" id="1616413">(</span><span class="ident" id="1616414">addr</span><span class="op" id="1616418">)</span>&nbsp;<span class="op" id="1616420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616425">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1616433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1616436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616439">if</span>&nbsp;<span class="ident" id="1616442">s</span><span class="op" id="1616443">.</span><span class="ident" id="1616444">releasetime</span>&nbsp;<span class="op" id="1616456">&gt;</span>&nbsp;<span class="num" id="1616458">0</span>&nbsp;<span class="op" id="1616460">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616464">blockevent</span><span class="op" id="1616474">(</span><span class="builtintype" id="1616475">int64</span><span class="op" id="1616480">(</span><span class="ident" id="1616481">s</span><span class="op" id="1616482">.</span><span class="ident" id="1616483">releasetime</span><span class="op" id="1616494">)</span><span class="op" id="1616495">-</span><span class="ident" id="1616496">t0</span><span class="op" id="1616498">,</span>&nbsp;<span class="num" id="1616500">3</span><span class="op" id="1616501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1616504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616507">releaseSudog</span><span class="op" id="1616519">(</span><span class="ident" id="1616520">s</span><span class="op" id="1616521">)</span><br>
<span class="lineno"></span><span class="op" id="1616523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1616526">func</span>&nbsp;<span class="ident" id="1616531">semrelease</span><span class="op" id="1616541">(</span><span class="ident" id="1616542">addr</span>&nbsp;<span class="op" id="1616547">*</span><span class="builtintype" id="1616548">uint32</span><span class="op" id="1616554">)</span>&nbsp;<span class="op" id="1616556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616559">root</span>&nbsp;<span class="op" id="1616564">:=</span>&nbsp;<span class="ident" id="1616567">semroot</span><span class="op" id="1616574">(</span><span class="ident" id="1616575">addr</span><span class="op" id="1616579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616582">xadd</span><span class="op" id="1616586">(</span><span class="ident" id="1616587">addr</span><span class="op" id="1616591">,</span>&nbsp;<span class="num" id="1616593">1</span><span class="op" id="1616594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616598">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616625">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616693">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616723">if</span>&nbsp;<span class="ident" id="1616726">atomicload</span><span class="op" id="1616736">(</span><span class="op" id="1616737">&amp;</span><span class="ident" id="1616738">root</span><span class="op" id="1616742">.</span><span class="ident" id="1616743">nwait</span><span class="op" id="1616748">)</span>&nbsp;<span class="op" id="1616750">==</span>&nbsp;<span class="num" id="1616753">0</span>&nbsp;<span class="op" id="1616755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616759">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1616767">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616771">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616821">lock</span><span class="op" id="1616825">(</span><span class="op" id="1616826">&amp;</span><span class="ident" id="1616827">root</span><span class="op" id="1616831">.</span><span class="ident" id="1616832">lock</span><span class="op" id="1616836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616839">if</span>&nbsp;<span class="ident" id="1616842">atomicload</span><span class="op" id="1616852">(</span><span class="op" id="1616853">&amp;</span><span class="ident" id="1616854">root</span><span class="op" id="1616858">.</span><span class="ident" id="1616859">nwait</span><span class="op" id="1616864">)</span>&nbsp;<span class="op" id="1616866">==</span>&nbsp;<span class="num" id="1616869">0</span>&nbsp;<span class="op" id="1616871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616875">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1616932">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1616978">unlock</span><span class="op" id="1616984">(</span><span class="op" id="1616985">&amp;</span><span class="ident" id="1616986">root</span><span class="op" id="1616990">.</span><span class="ident" id="1616991">lock</span><span class="op" id="1616995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1616999">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617010">s</span>&nbsp;<span class="op" id="1617012">:=</span>&nbsp;<span class="ident" id="1617015">root</span><span class="op" id="1617019">.</span><span class="ident" id="1617020">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617026">for</span>&nbsp;<span class="op" id="1617030">;</span>&nbsp;<span class="ident" id="1617032">s</span>&nbsp;<span class="op" id="1617034">!=</span>&nbsp;<span class="builtintype" id="1617037">nil</span><span class="op" id="1617040">;</span>&nbsp;<span class="ident" id="1617042">s</span>&nbsp;<span class="op" id="1617044">=</span>&nbsp;<span class="ident" id="1617046">s</span><span class="op" id="1617047">.</span><span class="ident" id="1617048">next</span>&nbsp;<span class="op" id="1617053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617057">if</span>&nbsp;<span class="ident" id="1617060">s</span><span class="op" id="1617061">.</span><span class="ident" id="1617062">elem</span>&nbsp;<span class="op" id="1617067">==</span>&nbsp;<span class="ident" id="1617070">unsafe</span><span class="op" id="1617076">.</span><span class="ident" id="1617077">Pointer</span><span class="op" id="1617084">(</span><span class="ident" id="1617085">addr</span><span class="op" id="1617089">)</span>&nbsp;<span class="op" id="1617091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617096">xadd</span><span class="op" id="1617100">(</span><span class="op" id="1617101">&amp;</span><span class="ident" id="1617102">root</span><span class="op" id="1617106">.</span><span class="ident" id="1617107">nwait</span><span class="op" id="1617112">,</span>&nbsp;<span class="op" id="1617114">-</span><span class="num" id="1617115">1</span><span class="op" id="1617116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617121">root</span><span class="op" id="1617125">.</span><span class="ident" id="1617126">dequeue</span><span class="op" id="1617133">(</span><span class="ident" id="1617134">s</span><span class="op" id="1617135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617140">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617154">unlock</span><span class="op" id="1617160">(</span><span class="op" id="1617161">&amp;</span><span class="ident" id="1617162">root</span><span class="op" id="1617166">.</span><span class="ident" id="1617167">lock</span><span class="op" id="1617171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617174">if</span>&nbsp;<span class="ident" id="1617177">s</span>&nbsp;<span class="op" id="1617179">!=</span>&nbsp;<span class="builtintype" id="1617182">nil</span>&nbsp;<span class="op" id="1617186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617190">if</span>&nbsp;<span class="ident" id="1617193">s</span><span class="op" id="1617194">.</span><span class="ident" id="1617195">releasetime</span>&nbsp;<span class="op" id="1617207">!=</span>&nbsp;<span class="num" id="1617210">0</span>&nbsp;<span class="op" id="1617212">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617217">s</span><span class="op" id="1617218">.</span><span class="ident" id="1617219">releasetime</span>&nbsp;<span class="op" id="1617231">=</span>&nbsp;<span class="ident" id="1617233">cputicks</span><span class="op" id="1617241">(</span><span class="op" id="1617242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617250">goready</span><span class="op" id="1617257">(</span><span class="ident" id="1617258">s</span><span class="op" id="1617259">.</span><span class="ident" id="1617260">g</span><span class="op" id="1617261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617264">}</span><br>
<span class="lineno"></span><span class="op" id="1617266">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1617269">func</span>&nbsp;<span class="ident" id="1617274">semroot</span><span class="op" id="1617281">(</span><span class="ident" id="1617282">addr</span>&nbsp;<span class="op" id="1617287">*</span><span class="builtintype" id="1617288">uint32</span><span class="op" id="1617294">)</span>&nbsp;<span class="op" id="1617296">*</span><span class="ident" id="1617297">semaRoot</span>&nbsp;<span class="op" id="1617306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617309">return</span>&nbsp;<span class="op" id="1617316">&amp;</span><span class="ident" id="1617317">semtable</span><span class="op" id="1617325">[</span><span class="op" id="1617326">(</span><span class="builtintype" id="1617327">uintptr</span><span class="op" id="1617334">(</span><span class="ident" id="1617335">unsafe</span><span class="op" id="1617341">.</span><span class="ident" id="1617342">Pointer</span><span class="op" id="1617349">(</span><span class="ident" id="1617350">addr</span><span class="op" id="1617354">)</span><span class="op" id="1617355">)</span><span class="op" id="1617356">&gt;&gt;</span><span class="num" id="1617358">3</span><span class="op" id="1617359">)</span><span class="op" id="1617360">%</span><span class="ident" id="1617361">semTabSize</span><span class="op" id="1617371">]</span><span class="op" id="1617372">.</span><span class="ident" id="1617373">root</span><br>
<span class="lineno"></span><span class="op" id="1617378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1617381">func</span>&nbsp;<span class="ident" id="1617386">cansemacquire</span><span class="op" id="1617399">(</span><span class="ident" id="1617400">addr</span>&nbsp;<span class="op" id="1617405">*</span><span class="builtintype" id="1617406">uint32</span><span class="op" id="1617412">)</span>&nbsp;<span class="builtintype" id="1617414">bool</span>&nbsp;<span class="op" id="1617419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617422">for</span>&nbsp;<span class="op" id="1617426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617430">v</span>&nbsp;<span class="op" id="1617432">:=</span>&nbsp;<span class="ident" id="1617435">atomicload</span><span class="op" id="1617445">(</span><span class="ident" id="1617446">addr</span><span class="op" id="1617450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617454">if</span>&nbsp;<span class="ident" id="1617457">v</span>&nbsp;<span class="op" id="1617459">==</span>&nbsp;<span class="num" id="1617462">0</span>&nbsp;<span class="op" id="1617464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617469">return</span>&nbsp;<span class="builtintype" id="1617476">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617488">if</span>&nbsp;<span class="ident" id="1617491">cas</span><span class="op" id="1617494">(</span><span class="ident" id="1617495">addr</span><span class="op" id="1617499">,</span>&nbsp;<span class="ident" id="1617501">v</span><span class="op" id="1617502">,</span>&nbsp;<span class="ident" id="1617504">v</span><span class="op" id="1617505">-</span><span class="num" id="1617506">1</span><span class="op" id="1617507">)</span>&nbsp;<span class="op" id="1617509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617514">return</span>&nbsp;<span class="builtintype" id="1617521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617531">}</span><br>
<span class="lineno">150</span><span class="op" id="1617533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1617536">func</span>&nbsp;<span class="op" id="1617541">(</span><span class="ident" id="1617542">root</span>&nbsp;<span class="op" id="1617547">*</span><span class="ident" id="1617548">semaRoot</span><span class="op" id="1617556">)</span>&nbsp;<span class="ident" id="1617558">queue</span><span class="op" id="1617563">(</span><span class="ident" id="1617564">addr</span>&nbsp;<span class="op" id="1617569">*</span><span class="builtintype" id="1617570">uint32</span><span class="op" id="1617576">,</span>&nbsp;<span class="ident" id="1617578">s</span>&nbsp;<span class="op" id="1617580">*</span><span class="ident" id="1617581">sudog</span><span class="op" id="1617586">)</span>&nbsp;<span class="op" id="1617588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617591">s</span><span class="op" id="1617592">.</span><span class="ident" id="1617593">g</span>&nbsp;<span class="op" id="1617595">=</span>&nbsp;<span class="ident" id="1617597">getg</span><span class="op" id="1617601">(</span><span class="op" id="1617602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617605">s</span><span class="op" id="1617606">.</span><span class="ident" id="1617607">elem</span>&nbsp;<span class="op" id="1617612">=</span>&nbsp;<span class="ident" id="1617614">unsafe</span><span class="op" id="1617620">.</span><span class="ident" id="1617621">Pointer</span><span class="op" id="1617628">(</span><span class="ident" id="1617629">addr</span><span class="op" id="1617633">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617636">s</span><span class="op" id="1617637">.</span><span class="ident" id="1617638">next</span>&nbsp;<span class="op" id="1617643">=</span>&nbsp;<span class="builtintype" id="1617645">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617650">s</span><span class="op" id="1617651">.</span><span class="ident" id="1617652">prev</span>&nbsp;<span class="op" id="1617657">=</span>&nbsp;<span class="ident" id="1617659">root</span><span class="op" id="1617663">.</span><span class="ident" id="1617664">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617670">if</span>&nbsp;<span class="ident" id="1617673">root</span><span class="op" id="1617677">.</span><span class="ident" id="1617678">tail</span>&nbsp;<span class="op" id="1617683">!=</span>&nbsp;<span class="builtintype" id="1617686">nil</span>&nbsp;<span class="op" id="1617690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617694">root</span><span class="op" id="1617698">.</span><span class="ident" id="1617699">tail</span><span class="op" id="1617703">.</span><span class="ident" id="1617704">next</span>&nbsp;<span class="op" id="1617709">=</span>&nbsp;<span class="ident" id="1617711">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617714">}</span>&nbsp;<span class="keyword" id="1617716">else</span>&nbsp;<span class="op" id="1617721">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617725">root</span><span class="op" id="1617729">.</span><span class="ident" id="1617730">head</span>&nbsp;<span class="op" id="1617735">=</span>&nbsp;<span class="ident" id="1617737">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617743">root</span><span class="op" id="1617747">.</span><span class="ident" id="1617748">tail</span>&nbsp;<span class="op" id="1617753">=</span>&nbsp;<span class="ident" id="1617755">s</span><br>
<span class="lineno"></span><span class="op" id="1617757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1617760">func</span>&nbsp;<span class="op" id="1617765">(</span><span class="ident" id="1617766">root</span>&nbsp;<span class="op" id="1617771">*</span><span class="ident" id="1617772">semaRoot</span><span class="op" id="1617780">)</span>&nbsp;<span class="ident" id="1617782">dequeue</span><span class="op" id="1617789">(</span><span class="ident" id="1617790">s</span>&nbsp;<span class="op" id="1617792">*</span><span class="ident" id="1617793">sudog</span><span class="op" id="1617798">)</span>&nbsp;<span class="op" id="1617800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617803">if</span>&nbsp;<span class="ident" id="1617806">s</span><span class="op" id="1617807">.</span><span class="ident" id="1617808">next</span>&nbsp;<span class="op" id="1617813">!=</span>&nbsp;<span class="builtintype" id="1617816">nil</span>&nbsp;<span class="op" id="1617820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617824">s</span><span class="op" id="1617825">.</span><span class="ident" id="1617826">next</span><span class="op" id="1617830">.</span><span class="ident" id="1617831">prev</span>&nbsp;<span class="op" id="1617836">=</span>&nbsp;<span class="ident" id="1617838">s</span><span class="op" id="1617839">.</span><span class="ident" id="1617840">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617846">}</span>&nbsp;<span class="keyword" id="1617848">else</span>&nbsp;<span class="op" id="1617853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617857">root</span><span class="op" id="1617861">.</span><span class="ident" id="1617862">tail</span>&nbsp;<span class="op" id="1617867">=</span>&nbsp;<span class="ident" id="1617869">s</span><span class="op" id="1617870">.</span><span class="ident" id="1617871">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617880">if</span>&nbsp;<span class="ident" id="1617883">s</span><span class="op" id="1617884">.</span><span class="ident" id="1617885">prev</span>&nbsp;<span class="op" id="1617890">!=</span>&nbsp;<span class="builtintype" id="1617893">nil</span>&nbsp;<span class="op" id="1617897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617901">s</span><span class="op" id="1617902">.</span><span class="ident" id="1617903">prev</span><span class="op" id="1617907">.</span><span class="ident" id="1617908">next</span>&nbsp;<span class="op" id="1617913">=</span>&nbsp;<span class="ident" id="1617915">s</span><span class="op" id="1617916">.</span><span class="ident" id="1617917">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617923">}</span>&nbsp;<span class="keyword" id="1617925">else</span>&nbsp;<span class="op" id="1617930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617934">root</span><span class="op" id="1617938">.</span><span class="ident" id="1617939">head</span>&nbsp;<span class="op" id="1617944">=</span>&nbsp;<span class="ident" id="1617946">s</span><span class="op" id="1617947">.</span><span class="ident" id="1617948">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1617954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617957">s</span><span class="op" id="1617958">.</span><span class="ident" id="1617959">elem</span>&nbsp;<span class="op" id="1617964">=</span>&nbsp;<span class="builtintype" id="1617966">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617971">s</span><span class="op" id="1617972">.</span><span class="ident" id="1617973">next</span>&nbsp;<span class="op" id="1617978">=</span>&nbsp;<span class="builtintype" id="1617980">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617985">s</span><span class="op" id="1617986">.</span><span class="ident" id="1617987">prev</span>&nbsp;<span class="op" id="1617992">=</span>&nbsp;<span class="builtintype" id="1617994">nil</span><br>
<span class="lineno"></span><span class="op" id="1617998">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1618001">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1618041">type</span>&nbsp;<span class="ident" id="1618046">syncSema</span>&nbsp;<span class="keyword" id="1618055">struct</span>&nbsp;<span class="op" id="1618062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618065">lock</span>&nbsp;<span class="ident" id="1618070">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618077">head</span>&nbsp;<span class="op" id="1618082">*</span><span class="ident" id="1618083">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618090">tail</span>&nbsp;<span class="op" id="1618095">*</span><span class="ident" id="1618096">sudog</span><br>
<span class="lineno"></span><span class="op" id="1618102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618105">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1618183">func</span>&nbsp;<span class="ident" id="1618188">syncsemacquire</span><span class="op" id="1618202">(</span><span class="ident" id="1618203">s</span>&nbsp;<span class="op" id="1618205">*</span><span class="ident" id="1618206">syncSema</span><span class="op" id="1618214">)</span>&nbsp;<span class="op" id="1618216">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618219">lock</span><span class="op" id="1618223">(</span><span class="op" id="1618224">&amp;</span><span class="ident" id="1618225">s</span><span class="op" id="1618226">.</span><span class="ident" id="1618227">lock</span><span class="op" id="1618231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618234">if</span>&nbsp;<span class="ident" id="1618237">s</span><span class="op" id="1618238">.</span><span class="ident" id="1618239">head</span>&nbsp;<span class="op" id="1618244">!=</span>&nbsp;<span class="builtintype" id="1618247">nil</span>&nbsp;<span class="op" id="1618251">&amp;&amp;</span>&nbsp;<span class="ident" id="1618254">s</span><span class="op" id="1618255">.</span><span class="ident" id="1618256">head</span><span class="op" id="1618260">.</span><span class="ident" id="1618261">nrelease</span>&nbsp;<span class="op" id="1618270">&gt;</span>&nbsp;<span class="num" id="1618272">0</span>&nbsp;<span class="op" id="1618274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618278">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618317">var</span>&nbsp;<span class="ident" id="1618321">wake</span>&nbsp;<span class="op" id="1618326">*</span><span class="ident" id="1618327">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618335">s</span><span class="op" id="1618336">.</span><span class="ident" id="1618337">head</span><span class="op" id="1618341">.</span><span class="ident" id="1618342">nrelease</span><span class="op" id="1618350">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618355">if</span>&nbsp;<span class="ident" id="1618358">s</span><span class="op" id="1618359">.</span><span class="ident" id="1618360">head</span><span class="op" id="1618364">.</span><span class="ident" id="1618365">nrelease</span>&nbsp;<span class="op" id="1618374">==</span>&nbsp;<span class="num" id="1618377">0</span>&nbsp;<span class="op" id="1618379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618384">wake</span>&nbsp;<span class="op" id="1618389">=</span>&nbsp;<span class="ident" id="1618391">s</span><span class="op" id="1618392">.</span><span class="ident" id="1618393">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618401">s</span><span class="op" id="1618402">.</span><span class="ident" id="1618403">head</span>&nbsp;<span class="op" id="1618408">=</span>&nbsp;<span class="ident" id="1618410">wake</span><span class="op" id="1618414">.</span><span class="ident" id="1618415">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618423">if</span>&nbsp;<span class="ident" id="1618426">s</span><span class="op" id="1618427">.</span><span class="ident" id="1618428">head</span>&nbsp;<span class="op" id="1618433">==</span>&nbsp;<span class="builtintype" id="1618436">nil</span>&nbsp;<span class="op" id="1618440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618446">s</span><span class="op" id="1618447">.</span><span class="ident" id="1618448">tail</span>&nbsp;<span class="op" id="1618453">=</span>&nbsp;<span class="builtintype" id="1618455">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618470">unlock</span><span class="op" id="1618476">(</span><span class="op" id="1618477">&amp;</span><span class="ident" id="1618478">s</span><span class="op" id="1618479">.</span><span class="ident" id="1618480">lock</span><span class="op" id="1618484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618488">if</span>&nbsp;<span class="ident" id="1618491">wake</span>&nbsp;<span class="op" id="1618496">!=</span>&nbsp;<span class="builtintype" id="1618499">nil</span>&nbsp;<span class="op" id="1618503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618508">wake</span><span class="op" id="1618512">.</span><span class="ident" id="1618513">next</span>&nbsp;<span class="op" id="1618518">=</span>&nbsp;<span class="builtintype" id="1618520">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618527">goready</span><span class="op" id="1618534">(</span><span class="ident" id="1618535">wake</span><span class="op" id="1618539">.</span><span class="ident" id="1618540">g</span><span class="op" id="1618541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618548">}</span>&nbsp;<span class="keyword" id="1618550">else</span>&nbsp;<span class="op" id="1618555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618559">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618580">w</span>&nbsp;<span class="op" id="1618582">:=</span>&nbsp;<span class="ident" id="1618585">acquireSudog</span><span class="op" id="1618597">(</span><span class="op" id="1618598">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618602">w</span><span class="op" id="1618603">.</span><span class="ident" id="1618604">g</span>&nbsp;<span class="op" id="1618606">=</span>&nbsp;<span class="ident" id="1618608">getg</span><span class="op" id="1618612">(</span><span class="op" id="1618613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618617">w</span><span class="op" id="1618618">.</span><span class="ident" id="1618619">nrelease</span>&nbsp;<span class="op" id="1618628">=</span>&nbsp;<span class="op" id="1618630">-</span><span class="num" id="1618631">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618635">w</span><span class="op" id="1618636">.</span><span class="ident" id="1618637">next</span>&nbsp;<span class="op" id="1618642">=</span>&nbsp;<span class="builtintype" id="1618644">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618650">w</span><span class="op" id="1618651">.</span><span class="ident" id="1618652">releasetime</span>&nbsp;<span class="op" id="1618664">=</span>&nbsp;<span class="num" id="1618666">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618670">t0</span>&nbsp;<span class="op" id="1618673">:=</span>&nbsp;<span class="builtintype" id="1618676">int64</span><span class="op" id="1618681">(</span><span class="num" id="1618682">0</span><span class="op" id="1618683">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618687">if</span>&nbsp;<span class="ident" id="1618690">blockprofilerate</span>&nbsp;<span class="op" id="1618707">&gt;</span>&nbsp;<span class="num" id="1618709">0</span>&nbsp;<span class="op" id="1618711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618716">t0</span>&nbsp;<span class="op" id="1618719">=</span>&nbsp;<span class="ident" id="1618721">cputicks</span><span class="op" id="1618729">(</span><span class="op" id="1618730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618735">w</span><span class="op" id="1618736">.</span><span class="ident" id="1618737">releasetime</span>&nbsp;<span class="op" id="1618749">=</span>&nbsp;<span class="op" id="1618751">-</span><span class="num" id="1618752">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618760">if</span>&nbsp;<span class="ident" id="1618763">s</span><span class="op" id="1618764">.</span><span class="ident" id="1618765">tail</span>&nbsp;<span class="op" id="1618770">==</span>&nbsp;<span class="builtintype" id="1618773">nil</span>&nbsp;<span class="op" id="1618777">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618782">s</span><span class="op" id="1618783">.</span><span class="ident" id="1618784">head</span>&nbsp;<span class="op" id="1618789">=</span>&nbsp;<span class="ident" id="1618791">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618795">}</span>&nbsp;<span class="keyword" id="1618797">else</span>&nbsp;<span class="op" id="1618802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618807">s</span><span class="op" id="1618808">.</span><span class="ident" id="1618809">tail</span><span class="op" id="1618813">.</span><span class="ident" id="1618814">next</span>&nbsp;<span class="op" id="1618819">=</span>&nbsp;<span class="ident" id="1618821">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618829">s</span><span class="op" id="1618830">.</span><span class="ident" id="1618831">tail</span>&nbsp;<span class="op" id="1618836">=</span>&nbsp;<span class="ident" id="1618838">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618842">goparkunlock</span><span class="op" id="1618854">(</span><span class="op" id="1618855">&amp;</span><span class="ident" id="1618856">s</span><span class="op" id="1618857">.</span><span class="ident" id="1618858">lock</span><span class="op" id="1618862">,</span>&nbsp;<span class="string" id="1618864">&#34;semacquire&#34;</span><span class="op" id="1618876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618880">if</span>&nbsp;<span class="ident" id="1618883">t0</span>&nbsp;<span class="op" id="1618886">!=</span>&nbsp;<span class="num" id="1618889">0</span>&nbsp;<span class="op" id="1618891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618896">blockevent</span><span class="op" id="1618906">(</span><span class="builtintype" id="1618907">int64</span><span class="op" id="1618912">(</span><span class="ident" id="1618913">w</span><span class="op" id="1618914">.</span><span class="ident" id="1618915">releasetime</span><span class="op" id="1618926">)</span><span class="op" id="1618927">-</span><span class="ident" id="1618928">t0</span><span class="op" id="1618930">,</span>&nbsp;<span class="num" id="1618932">2</span><span class="op" id="1618933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618941">releaseSudog</span><span class="op" id="1618953">(</span><span class="ident" id="1618954">w</span><span class="op" id="1618955">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618958">}</span><br>
<span class="lineno"></span><span class="op" id="1618960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618963">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1619041">func</span>&nbsp;<span class="ident" id="1619046">syncsemrelease</span><span class="op" id="1619060">(</span><span class="ident" id="1619061">s</span>&nbsp;<span class="op" id="1619063">*</span><span class="ident" id="1619064">syncSema</span><span class="op" id="1619072">,</span>&nbsp;<span class="ident" id="1619074">n</span>&nbsp;<span class="builtintype" id="1619076">uint32</span><span class="op" id="1619082">)</span>&nbsp;<span class="op" id="1619084">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619087">lock</span><span class="op" id="1619091">(</span><span class="op" id="1619092">&amp;</span><span class="ident" id="1619093">s</span><span class="op" id="1619094">.</span><span class="ident" id="1619095">lock</span><span class="op" id="1619099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619102">for</span>&nbsp;<span class="ident" id="1619106">n</span>&nbsp;<span class="op" id="1619108">&gt;</span>&nbsp;<span class="num" id="1619110">0</span>&nbsp;<span class="op" id="1619112">&amp;&amp;</span>&nbsp;<span class="ident" id="1619115">s</span><span class="op" id="1619116">.</span><span class="ident" id="1619117">head</span>&nbsp;<span class="op" id="1619122">!=</span>&nbsp;<span class="builtintype" id="1619125">nil</span>&nbsp;<span class="op" id="1619129">&amp;&amp;</span>&nbsp;<span class="ident" id="1619132">s</span><span class="op" id="1619133">.</span><span class="ident" id="1619134">head</span><span class="op" id="1619138">.</span><span class="ident" id="1619139">nrelease</span>&nbsp;<span class="op" id="1619148">&lt;</span>&nbsp;<span class="num" id="1619150">0</span>&nbsp;<span class="op" id="1619152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1619156">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619195">wake</span>&nbsp;<span class="op" id="1619200">:=</span>&nbsp;<span class="ident" id="1619203">s</span><span class="op" id="1619204">.</span><span class="ident" id="1619205">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619212">s</span><span class="op" id="1619213">.</span><span class="ident" id="1619214">head</span>&nbsp;<span class="op" id="1619219">=</span>&nbsp;<span class="ident" id="1619221">wake</span><span class="op" id="1619225">.</span><span class="ident" id="1619226">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619233">if</span>&nbsp;<span class="ident" id="1619236">s</span><span class="op" id="1619237">.</span><span class="ident" id="1619238">head</span>&nbsp;<span class="op" id="1619243">==</span>&nbsp;<span class="builtintype" id="1619246">nil</span>&nbsp;<span class="op" id="1619250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619255">s</span><span class="op" id="1619256">.</span><span class="ident" id="1619257">tail</span>&nbsp;<span class="op" id="1619262">=</span>&nbsp;<span class="builtintype" id="1619264">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619274">if</span>&nbsp;<span class="ident" id="1619277">wake</span><span class="op" id="1619281">.</span><span class="ident" id="1619282">releasetime</span>&nbsp;<span class="op" id="1619294">!=</span>&nbsp;<span class="num" id="1619297">0</span>&nbsp;<span class="op" id="1619299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619304">wake</span><span class="op" id="1619308">.</span><span class="ident" id="1619309">releasetime</span>&nbsp;<span class="op" id="1619321">=</span>&nbsp;<span class="ident" id="1619323">cputicks</span><span class="op" id="1619331">(</span><span class="op" id="1619332">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619340">wake</span><span class="op" id="1619344">.</span><span class="ident" id="1619345">next</span>&nbsp;<span class="op" id="1619350">=</span>&nbsp;<span class="builtintype" id="1619352">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619358">goready</span><span class="op" id="1619365">(</span><span class="ident" id="1619366">wake</span><span class="op" id="1619370">.</span><span class="ident" id="1619371">g</span><span class="op" id="1619372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619376">n</span><span class="op" id="1619377">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619381">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619384">if</span>&nbsp;<span class="ident" id="1619387">n</span>&nbsp;<span class="op" id="1619389">&gt;</span>&nbsp;<span class="num" id="1619391">0</span>&nbsp;<span class="op" id="1619393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1619397">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619417">w</span>&nbsp;<span class="op" id="1619419">:=</span>&nbsp;<span class="ident" id="1619422">acquireSudog</span><span class="op" id="1619434">(</span><span class="op" id="1619435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619439">w</span><span class="op" id="1619440">.</span><span class="ident" id="1619441">g</span>&nbsp;<span class="op" id="1619443">=</span>&nbsp;<span class="ident" id="1619445">getg</span><span class="op" id="1619449">(</span><span class="op" id="1619450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619454">w</span><span class="op" id="1619455">.</span><span class="ident" id="1619456">nrelease</span>&nbsp;<span class="op" id="1619465">=</span>&nbsp;<span class="builtintype" id="1619467">int32</span><span class="op" id="1619472">(</span><span class="ident" id="1619473">n</span><span class="op" id="1619474">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619478">w</span><span class="op" id="1619479">.</span><span class="ident" id="1619480">next</span>&nbsp;<span class="op" id="1619485">=</span>&nbsp;<span class="builtintype" id="1619487">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619493">w</span><span class="op" id="1619494">.</span><span class="ident" id="1619495">releasetime</span>&nbsp;<span class="op" id="1619507">=</span>&nbsp;<span class="num" id="1619509">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619513">if</span>&nbsp;<span class="ident" id="1619516">s</span><span class="op" id="1619517">.</span><span class="ident" id="1619518">tail</span>&nbsp;<span class="op" id="1619523">==</span>&nbsp;<span class="builtintype" id="1619526">nil</span>&nbsp;<span class="op" id="1619530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619535">s</span><span class="op" id="1619536">.</span><span class="ident" id="1619537">head</span>&nbsp;<span class="op" id="1619542">=</span>&nbsp;<span class="ident" id="1619544">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619548">}</span>&nbsp;<span class="keyword" id="1619550">else</span>&nbsp;<span class="op" id="1619555">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619560">s</span><span class="op" id="1619561">.</span><span class="ident" id="1619562">tail</span><span class="op" id="1619566">.</span><span class="ident" id="1619567">next</span>&nbsp;<span class="op" id="1619572">=</span>&nbsp;<span class="ident" id="1619574">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619582">s</span><span class="op" id="1619583">.</span><span class="ident" id="1619584">tail</span>&nbsp;<span class="op" id="1619589">=</span>&nbsp;<span class="ident" id="1619591">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619595">goparkunlock</span><span class="op" id="1619607">(</span><span class="op" id="1619608">&amp;</span><span class="ident" id="1619609">s</span><span class="op" id="1619610">.</span><span class="ident" id="1619611">lock</span><span class="op" id="1619615">,</span>&nbsp;<span class="string" id="1619617">&#34;semarelease&#34;</span><span class="op" id="1619630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619634">releaseSudog</span><span class="op" id="1619646">(</span><span class="ident" id="1619647">w</span><span class="op" id="1619648">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619651">}</span>&nbsp;<span class="keyword" id="1619653">else</span>&nbsp;<span class="op" id="1619658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619662">unlock</span><span class="op" id="1619668">(</span><span class="op" id="1619669">&amp;</span><span class="ident" id="1619670">s</span><span class="op" id="1619671">.</span><span class="ident" id="1619672">lock</span><span class="op" id="1619676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619679">}</span><br>
<span class="lineno"></span><span class="op" id="1619681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1619684">func</span>&nbsp;<span class="ident" id="1619689">syncsemcheck</span><span class="op" id="1619701">(</span><span class="ident" id="1619702">sz</span>&nbsp;<span class="builtintype" id="1619705">uintptr</span><span class="op" id="1619712">)</span>&nbsp;<span class="op" id="1619714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619717">if</span>&nbsp;<span class="ident" id="1619720">sz</span>&nbsp;<span class="op" id="1619723">!=</span>&nbsp;<span class="ident" id="1619726">unsafe</span><span class="op" id="1619732">.</span><span class="ident" id="1619733">Sizeof</span><span class="op" id="1619739">(</span><span class="ident" id="1619740">syncSema</span><span class="op" id="1619748">{</span><span class="op" id="1619749">}</span><span class="op" id="1619750">)</span>&nbsp;<span class="op" id="1619752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1619756">print</span><span class="op" id="1619761">(</span><span class="string" id="1619762">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1619798">,</span>&nbsp;<span class="ident" id="1619800">sz</span><span class="op" id="1619802">,</span>&nbsp;<span class="string" id="1619804">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1619815">,</span>&nbsp;<span class="ident" id="1619817">unsafe</span><span class="op" id="1619823">.</span><span class="ident" id="1619824">Sizeof</span><span class="op" id="1619830">(</span><span class="ident" id="1619831">syncSema</span><span class="op" id="1619839">{</span><span class="op" id="1619840">}</span><span class="op" id="1619841">)</span><span class="op" id="1619842">,</span>&nbsp;<span class="string" id="1619844">&#34;\n&#34;</span><span class="op" id="1619848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619852">gothrow</span><span class="op" id="1619859">(</span><span class="string" id="1619860">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1619879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619882">}</span><br>
<span class="lineno">275</span><span class="op" id="1619884">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
