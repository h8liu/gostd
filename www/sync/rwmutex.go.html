<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1685576">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1685631">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1685685">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1685736">package</span>&nbsp;<span class="ident" id="1685744">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1685750">import</span>&nbsp;<span class="op" id="1685757">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1685760">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1685775">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1685784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1685787">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1685843">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1685901">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1685924">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1685969">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1686016">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1686038">type</span>&nbsp;<span class="ident" id="1686043">RWMutex</span>&nbsp;<span class="keyword" id="1686051">struct</span>&nbsp;<span class="op" id="1686058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686061">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686073"><a href="/sync/mutex.go.html#1673941">Mutex</a></span>&nbsp;&nbsp;<span class="comment" id="1686080">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686118">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1686130">uint32</span>&nbsp;<span class="comment" id="1686137">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686194">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1686206">uint32</span>&nbsp;<span class="comment" id="1686213">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686270">readerCount</span>&nbsp;<span class="builtintype" id="1686282">int32</span>&nbsp;&nbsp;<span class="comment" id="1686289">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686319">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1686331">int32</span>&nbsp;&nbsp;<span class="comment" id="1686338">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1686369">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1686372">const</span>&nbsp;<span class="ident" id="1686378">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1686396">=</span>&nbsp;<span class="num" id="1686398">1</span>&nbsp;<span class="op" id="1686400">&lt;&lt;</span>&nbsp;<span class="num" id="1686403">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1686407">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1686438">func</span>&nbsp;<span class="op" id="1686443">(</span><span class="ident" id="1686444">rw</span>&nbsp;<span class="op" id="1686447">*</span><span class="ident" id="1686448"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1686455">)</span>&nbsp;<span class="ident" id="1686457">RLock</span><span class="op" id="1686462">(</span><span class="op" id="1686463">)</span>&nbsp;<span class="op" id="1686465">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686468">if</span>&nbsp;<span class="ident" id="1686471"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1686483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686487">_</span>&nbsp;<span class="op" id="1686489">=</span>&nbsp;<span class="ident" id="1686491"><a href="/sync/rwmutex.go.html#1686444">rw</a></span><span class="op" id="1686493">.</span><span class="ident" id="1686494">w</span><span class="op" id="1686495">.</span><span class="ident" id="1686496">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686504"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1686515">(</span><span class="op" id="1686516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686522">if</span>&nbsp;<span class="ident" id="1686525"><a href="/sync/rwmutex.go.html#1685760">atomic</a></span><span class="op" id="1686531">.</span><span class="ident" id="1686532">AddInt32</span><span class="op" id="1686540">(</span><span class="op" id="1686541">&amp;</span><span class="ident" id="1686542"><a href="/sync/rwmutex.go.html#1686444">rw</a></span><span class="op" id="1686544">.</span><span class="ident" id="1686545">readerCount</span><span class="op" id="1686556">,</span>&nbsp;<span class="num" id="1686558">1</span><span class="op" id="1686559">)</span>&nbsp;<span class="op" id="1686561">&lt;</span>&nbsp;<span class="num" id="1686563">0</span>&nbsp;<span class="op" id="1686565">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1686569">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686608"><a href="/sync/runtime.go.html#1684726">runtime_Semacquire</a></span><span class="op" id="1686626">(</span><span class="op" id="1686627">&amp;</span><span class="ident" id="1686628"><a href="/sync/rwmutex.go.html#1686444">rw</a></span><span class="op" id="1686630">.</span><span class="ident" id="1686631">readerSem</span><span class="op" id="1686640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686646">if</span>&nbsp;<span class="ident" id="1686649"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1686661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686665"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1686675">(</span><span class="op" id="1686676">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686680"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1686691">(</span><span class="ident" id="1686692"><a href="/sync/rwmutex.go.html#1685775">unsafe</a></span><span class="op" id="1686698">.</span><span class="ident" id="1686699">Pointer</span><span class="op" id="1686706">(</span><span class="op" id="1686707">&amp;</span><span class="ident" id="1686708"><a href="/sync/rwmutex.go.html#1686444">rw</a></span><span class="op" id="1686710">.</span><span class="ident" id="1686711">readerSem</span><span class="op" id="1686720">)</span><span class="op" id="1686721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686724">}</span><br>
<span class="lineno"></span><span class="op" id="1686726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1686729">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1686768">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1686818">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1686876">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1686900">func</span>&nbsp;<span class="op" id="1686905">(</span><span class="ident" id="1686906">rw</span>&nbsp;<span class="op" id="1686909">*</span><span class="ident" id="1686910"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1686917">)</span>&nbsp;<span class="ident" id="1686919">RUnlock</span><span class="op" id="1686926">(</span><span class="op" id="1686927">)</span>&nbsp;<span class="op" id="1686929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686932">if</span>&nbsp;<span class="ident" id="1686935"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1686947">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686951">_</span>&nbsp;<span class="op" id="1686953">=</span>&nbsp;<span class="ident" id="1686955"><a href="/sync/rwmutex.go.html#1686906">rw</a></span><span class="op" id="1686957">.</span><span class="ident" id="1686958">w</span><span class="op" id="1686959">.</span><span class="ident" id="1686960">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686968"><a href="/sync/race0.go.html#1684138">raceReleaseMerge</a></span><span class="op" id="1686984">(</span><span class="ident" id="1686985"><a href="/sync/rwmutex.go.html#1685775">unsafe</a></span><span class="op" id="1686991">.</span><span class="ident" id="1686992">Pointer</span><span class="op" id="1686999">(</span><span class="op" id="1687000">&amp;</span><span class="ident" id="1687001"><a href="/sync/rwmutex.go.html#1686906">rw</a></span><span class="op" id="1687003">.</span><span class="ident" id="1687004">writerSem</span><span class="op" id="1687013">)</span><span class="op" id="1687014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687018"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1687029">(</span><span class="op" id="1687030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687036">if</span>&nbsp;<span class="ident" id="1687039">r</span>&nbsp;<span class="op" id="1687041">:=</span>&nbsp;<span class="ident" id="1687044"><a href="/sync/rwmutex.go.html#1685760">atomic</a></span><span class="op" id="1687050">.</span><span class="ident" id="1687051">AddInt32</span><span class="op" id="1687059">(</span><span class="op" id="1687060">&amp;</span><span class="ident" id="1687061"><a href="/sync/rwmutex.go.html#1686906">rw</a></span><span class="op" id="1687063">.</span><span class="ident" id="1687064">readerCount</span><span class="op" id="1687075">,</span>&nbsp;<span class="op" id="1687077">-</span><span class="num" id="1687078">1</span><span class="op" id="1687079">)</span><span class="op" id="1687080">;</span>&nbsp;<span class="ident" id="1687082"><a href="/sync/rwmutex.go.html#1687039">r</a></span>&nbsp;<span class="op" id="1687084">&lt;</span>&nbsp;<span class="num" id="1687086">0</span>&nbsp;<span class="op" id="1687088">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687092">if</span>&nbsp;<span class="ident" id="1687095"><a href="/sync/rwmutex.go.html#1687039">r</a></span><span class="op" id="1687096">+</span><span class="num" id="1687097">1</span>&nbsp;<span class="op" id="1687099">==</span>&nbsp;<span class="num" id="1687102">0</span>&nbsp;<span class="op" id="1687104">||</span>&nbsp;<span class="ident" id="1687107"><a href="/sync/rwmutex.go.html#1687039">r</a></span><span class="op" id="1687108">+</span><span class="num" id="1687109">1</span>&nbsp;<span class="op" id="1687111">==</span>&nbsp;<span class="op" id="1687114">-</span><span class="ident" id="1687115"><a href="/sync/rwmutex.go.html#1686378">rwmutexMaxReaders</a></span>&nbsp;<span class="op" id="1687133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687138"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1687148">(</span><span class="op" id="1687149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1687154">panic</span><span class="op" id="1687159">(</span><span class="string" id="1687160">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1687195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687203">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687229">if</span>&nbsp;<span class="ident" id="1687232"><a href="/sync/rwmutex.go.html#1685760">atomic</a></span><span class="op" id="1687238">.</span><span class="ident" id="1687239">AddInt32</span><span class="op" id="1687247">(</span><span class="op" id="1687248">&amp;</span><span class="ident" id="1687249"><a href="/sync/rwmutex.go.html#1686906">rw</a></span><span class="op" id="1687251">.</span><span class="ident" id="1687252">readerWait</span><span class="op" id="1687262">,</span>&nbsp;<span class="op" id="1687264">-</span><span class="num" id="1687265">1</span><span class="op" id="1687266">)</span>&nbsp;<span class="op" id="1687268">==</span>&nbsp;<span class="num" id="1687271">0</span>&nbsp;<span class="op" id="1687273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687278">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687321"><a href="/sync/runtime.go.html#1684992">runtime_Semrelease</a></span><span class="op" id="1687339">(</span><span class="op" id="1687340">&amp;</span><span class="ident" id="1687341"><a href="/sync/rwmutex.go.html#1686906">rw</a></span><span class="op" id="1687343">.</span><span class="ident" id="1687344">writerSem</span><span class="op" id="1687353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687360">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687363">if</span>&nbsp;<span class="ident" id="1687366"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1687378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687382"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1687392">(</span><span class="op" id="1687393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687396">}</span><br>
<span class="lineno"></span><span class="op" id="1687398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1687401">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1687431">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1687488">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1687532">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1687589">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1687648">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1687661">func</span>&nbsp;<span class="op" id="1687666">(</span><span class="ident" id="1687667">rw</span>&nbsp;<span class="op" id="1687670">*</span><span class="ident" id="1687671"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1687678">)</span>&nbsp;<span class="ident" id="1687680">Lock</span><span class="op" id="1687684">(</span><span class="op" id="1687685">)</span>&nbsp;<span class="op" id="1687687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687690">if</span>&nbsp;<span class="ident" id="1687693"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1687705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687709">_</span>&nbsp;<span class="op" id="1687711">=</span>&nbsp;<span class="ident" id="1687713"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1687715">.</span><span class="ident" id="1687716">w</span><span class="op" id="1687717">.</span><span class="ident" id="1687718">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687726"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1687737">(</span><span class="op" id="1687738">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687744">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687795"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1687797">.</span><span class="ident" id="1687798">w</span><span class="op" id="1687799">.</span><span class="ident" id="1687800">Lock</span><span class="op" id="1687804">(</span><span class="op" id="1687805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687808">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687859">r</span>&nbsp;<span class="op" id="1687861">:=</span>&nbsp;<span class="ident" id="1687864"><a href="/sync/rwmutex.go.html#1685760">atomic</a></span><span class="op" id="1687870">.</span><span class="ident" id="1687871">AddInt32</span><span class="op" id="1687879">(</span><span class="op" id="1687880">&amp;</span><span class="ident" id="1687881"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1687883">.</span><span class="ident" id="1687884">readerCount</span><span class="op" id="1687895">,</span>&nbsp;<span class="op" id="1687897">-</span><span class="ident" id="1687898"><a href="/sync/rwmutex.go.html#1686378">rwmutexMaxReaders</a></span><span class="op" id="1687915">)</span>&nbsp;<span class="op" id="1687917">+</span>&nbsp;<span class="ident" id="1687919"><a href="/sync/rwmutex.go.html#1686378">rwmutexMaxReaders</a></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687938">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687967">if</span>&nbsp;<span class="ident" id="1687970"><a href="/sync/rwmutex.go.html#1687859">r</a></span>&nbsp;<span class="op" id="1687972">!=</span>&nbsp;<span class="num" id="1687975">0</span>&nbsp;<span class="op" id="1687977">&amp;&amp;</span>&nbsp;<span class="ident" id="1687980"><a href="/sync/rwmutex.go.html#1685760">atomic</a></span><span class="op" id="1687986">.</span><span class="ident" id="1687987">AddInt32</span><span class="op" id="1687995">(</span><span class="op" id="1687996">&amp;</span><span class="ident" id="1687997"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1687999">.</span><span class="ident" id="1688000">readerWait</span><span class="op" id="1688010">,</span>&nbsp;<span class="ident" id="1688012"><a href="/sync/rwmutex.go.html#1687859">r</a></span><span class="op" id="1688013">)</span>&nbsp;<span class="op" id="1688015">!=</span>&nbsp;<span class="num" id="1688018">0</span>&nbsp;<span class="op" id="1688020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688024"><a href="/sync/runtime.go.html#1684726">runtime_Semacquire</a></span><span class="op" id="1688042">(</span><span class="op" id="1688043">&amp;</span><span class="ident" id="1688044"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1688046">.</span><span class="ident" id="1688047">writerSem</span><span class="op" id="1688056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688062">if</span>&nbsp;<span class="ident" id="1688065"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1688077">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688081"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1688091">(</span><span class="op" id="1688092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688096"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1688107">(</span><span class="ident" id="1688108"><a href="/sync/rwmutex.go.html#1685775">unsafe</a></span><span class="op" id="1688114">.</span><span class="ident" id="1688115">Pointer</span><span class="op" id="1688122">(</span><span class="op" id="1688123">&amp;</span><span class="ident" id="1688124"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1688126">.</span><span class="ident" id="1688127">readerSem</span><span class="op" id="1688136">)</span><span class="op" id="1688137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688141"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1688152">(</span><span class="ident" id="1688153"><a href="/sync/rwmutex.go.html#1685775">unsafe</a></span><span class="op" id="1688159">.</span><span class="ident" id="1688160">Pointer</span><span class="op" id="1688167">(</span><span class="op" id="1688168">&amp;</span><span class="ident" id="1688169"><a href="/sync/rwmutex.go.html#1687667">rw</a></span><span class="op" id="1688171">.</span><span class="ident" id="1688172">writerSem</span><span class="op" id="1688181">)</span><span class="op" id="1688182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688185">}</span><br>
<span class="lineno"></span><span class="op" id="1688187">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1688190">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1688257">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1688303">//</span><br>
<span class="lineno"></span><span class="comment" id="1688306">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1688379">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1688445">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1688502">func</span>&nbsp;<span class="op" id="1688507">(</span><span class="ident" id="1688508">rw</span>&nbsp;<span class="op" id="1688511">*</span><span class="ident" id="1688512"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1688519">)</span>&nbsp;<span class="ident" id="1688521">Unlock</span><span class="op" id="1688527">(</span><span class="op" id="1688528">)</span>&nbsp;<span class="op" id="1688530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688533">if</span>&nbsp;<span class="ident" id="1688536"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1688548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688552">_</span>&nbsp;<span class="op" id="1688554">=</span>&nbsp;<span class="ident" id="1688556"><a href="/sync/rwmutex.go.html#1688508">rw</a></span><span class="op" id="1688558">.</span><span class="ident" id="1688559">w</span><span class="op" id="1688560">.</span><span class="ident" id="1688561">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688569"><a href="/sync/race0.go.html#1684095">raceRelease</a></span><span class="op" id="1688580">(</span><span class="ident" id="1688581"><a href="/sync/rwmutex.go.html#1685775">unsafe</a></span><span class="op" id="1688587">.</span><span class="ident" id="1688588">Pointer</span><span class="op" id="1688595">(</span><span class="op" id="1688596">&amp;</span><span class="ident" id="1688597"><a href="/sync/rwmutex.go.html#1688508">rw</a></span><span class="op" id="1688599">.</span><span class="ident" id="1688600">readerSem</span><span class="op" id="1688609">)</span><span class="op" id="1688610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688614"><a href="/sync/race0.go.html#1684095">raceRelease</a></span><span class="op" id="1688625">(</span><span class="ident" id="1688626"><a href="/sync/rwmutex.go.html#1685775">unsafe</a></span><span class="op" id="1688632">.</span><span class="ident" id="1688633">Pointer</span><span class="op" id="1688640">(</span><span class="op" id="1688641">&amp;</span><span class="ident" id="1688642"><a href="/sync/rwmutex.go.html#1688508">rw</a></span><span class="op" id="1688644">.</span><span class="ident" id="1688645">writerSem</span><span class="op" id="1688654">)</span><span class="op" id="1688655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688659"><a href="/sync/race0.go.html#1684186">raceDisable</a></span><span class="op" id="1688670">(</span><span class="op" id="1688671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688678">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688729">r</span>&nbsp;<span class="op" id="1688731">:=</span>&nbsp;<span class="ident" id="1688734"><a href="/sync/rwmutex.go.html#1685760">atomic</a></span><span class="op" id="1688740">.</span><span class="ident" id="1688741">AddInt32</span><span class="op" id="1688749">(</span><span class="op" id="1688750">&amp;</span><span class="ident" id="1688751"><a href="/sync/rwmutex.go.html#1688508">rw</a></span><span class="op" id="1688753">.</span><span class="ident" id="1688754">readerCount</span><span class="op" id="1688765">,</span>&nbsp;<span class="ident" id="1688767"><a href="/sync/rwmutex.go.html#1686378">rwmutexMaxReaders</a></span><span class="op" id="1688784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688787">if</span>&nbsp;<span class="ident" id="1688790"><a href="/sync/rwmutex.go.html#1688729">r</a></span>&nbsp;<span class="op" id="1688792">&gt;=</span>&nbsp;<span class="ident" id="1688795"><a href="/sync/rwmutex.go.html#1686378">rwmutexMaxReaders</a></span>&nbsp;<span class="op" id="1688813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688817"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1688827">(</span><span class="op" id="1688828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1688832">panic</span><span class="op" id="1688837">(</span><span class="string" id="1688838">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1688872">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688878">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688915">for</span>&nbsp;<span class="ident" id="1688919">i</span>&nbsp;<span class="op" id="1688921">:=</span>&nbsp;<span class="num" id="1688924">0</span><span class="op" id="1688925">;</span>&nbsp;<span class="ident" id="1688927"><a href="/sync/rwmutex.go.html#1688919">i</a></span>&nbsp;<span class="op" id="1688929">&lt;</span>&nbsp;<span class="builtintype" id="1688931">int</span><span class="op" id="1688934">(</span><span class="ident" id="1688935"><a href="/sync/rwmutex.go.html#1688729">r</a></span><span class="op" id="1688936">)</span><span class="op" id="1688937">;</span>&nbsp;<span class="ident" id="1688939"><a href="/sync/rwmutex.go.html#1688919">i</a></span><span class="op" id="1688940">++</span>&nbsp;<span class="op" id="1688943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688947"><a href="/sync/runtime.go.html#1684992">runtime_Semrelease</a></span><span class="op" id="1688965">(</span><span class="op" id="1688966">&amp;</span><span class="ident" id="1688967"><a href="/sync/rwmutex.go.html#1688508">rw</a></span><span class="op" id="1688969">.</span><span class="ident" id="1688970">readerSem</span><span class="op" id="1688979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688982">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688985">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689021"><a href="/sync/rwmutex.go.html#1688508">rw</a></span><span class="op" id="1689023">.</span><span class="ident" id="1689024">w</span><span class="op" id="1689025">.</span><span class="ident" id="1689026">Unlock</span><span class="op" id="1689032">(</span><span class="op" id="1689033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689036">if</span>&nbsp;<span class="ident" id="1689039"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1689051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689055"><a href="/sync/race0.go.html#1684210">raceEnable</a></span><span class="op" id="1689065">(</span><span class="op" id="1689066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689069">}</span><br>
<span class="lineno">125</span><span class="op" id="1689071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1689074">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1689128">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1689195">func</span>&nbsp;<span class="op" id="1689200">(</span><span class="ident" id="1689201">rw</span>&nbsp;<span class="op" id="1689204">*</span><span class="ident" id="1689205"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1689212">)</span>&nbsp;<span class="ident" id="1689214">RLocker</span><span class="op" id="1689221">(</span><span class="op" id="1689222">)</span>&nbsp;<span class="ident" id="1689224"><a href="/sync/mutex.go.html#1674057">Locker</a></span>&nbsp;<span class="op" id="1689231">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689234">return</span>&nbsp;<span class="op" id="1689241">(</span><span class="op" id="1689242">*</span><span class="ident" id="1689243"><a href="/sync/rwmutex.go.html#1689264">rlocker</a></span><span class="op" id="1689250">)</span><span class="op" id="1689251">(</span><span class="ident" id="1689252"><a href="/sync/rwmutex.go.html#1689201">rw</a></span><span class="op" id="1689254">)</span><br>
<span class="lineno"></span><span class="op" id="1689256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1689259">type</span>&nbsp;<span class="ident" id="1689264">rlocker</span>&nbsp;<span class="ident" id="1689272"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1689281">func</span>&nbsp;<span class="op" id="1689286">(</span><span class="ident" id="1689287">r</span>&nbsp;<span class="op" id="1689289">*</span><span class="ident" id="1689290"><a href="/sync/rwmutex.go.html#1689264">rlocker</a></span><span class="op" id="1689297">)</span>&nbsp;<span class="ident" id="1689299">Lock</span><span class="op" id="1689303">(</span><span class="op" id="1689304">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1689308">{</span>&nbsp;<span class="op" id="1689310">(</span><span class="op" id="1689311">*</span><span class="ident" id="1689312"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1689319">)</span><span class="op" id="1689320">(</span><span class="ident" id="1689321"><a href="/sync/rwmutex.go.html#1689287">r</a></span><span class="op" id="1689322">)</span><span class="op" id="1689323">.</span><span class="ident" id="1689324">RLock</span><span class="op" id="1689329">(</span><span class="op" id="1689330">)</span>&nbsp;<span class="op" id="1689332">}</span><br>
<span class="lineno"></span><span class="keyword" id="1689334">func</span>&nbsp;<span class="op" id="1689339">(</span><span class="ident" id="1689340">r</span>&nbsp;<span class="op" id="1689342">*</span><span class="ident" id="1689343"><a href="/sync/rwmutex.go.html#1689264">rlocker</a></span><span class="op" id="1689350">)</span>&nbsp;<span class="ident" id="1689352">Unlock</span><span class="op" id="1689358">(</span><span class="op" id="1689359">)</span>&nbsp;<span class="op" id="1689361">{</span>&nbsp;<span class="op" id="1689363">(</span><span class="op" id="1689364">*</span><span class="ident" id="1689365"><a href="/sync/rwmutex.go.html#1686043">RWMutex</a></span><span class="op" id="1689372">)</span><span class="op" id="1689373">(</span><span class="ident" id="1689374"><a href="/sync/rwmutex.go.html#1689340">r</a></span><span class="op" id="1689375">)</span><span class="op" id="1689376">.</span><span class="ident" id="1689377">RUnlock</span><span class="op" id="1689384">(</span><span class="op" id="1689385">)</span>&nbsp;<span class="op" id="1689387">}</span>
</div>
</body>
</html>
