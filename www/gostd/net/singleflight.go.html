<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html" class="current">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3830888">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3830944">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3830998">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3831049">package</span>&nbsp;<span class="ident" id="3831057">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3831062">import</span>&nbsp;<span class="string" id="3831069">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3831077">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3831135">type</span>&nbsp;<span class="ident" id="3831140">call</span>&nbsp;<span class="keyword" id="3831145">struct</span>&nbsp;<span class="op" id="3831152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831155">wg</span>&nbsp;<span class="ident" id="3831158">sync</span><span class="op" id="3831162">.</span><span class="ident" id="3831163">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831175">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831238">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831289">val</span>&nbsp;<span class="keyword" id="3831293">interface</span><span class="op" id="3831302">{</span><span class="op" id="3831303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831306">err</span>&nbsp;<span class="builtintype" id="3831310">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831318">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831378">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831440">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831485">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3831491">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831496">chans</span>&nbsp;<span class="op" id="3831502">[</span><span class="op" id="3831503">]</span><span class="keyword" id="3831504">chan</span><span class="op" id="3831508">&lt;-</span>&nbsp;<span class="ident" id="3831511">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3831530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3831533">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3831601">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3831668">type</span>&nbsp;<span class="ident" id="3831673">singleflight</span>&nbsp;<span class="keyword" id="3831686">struct</span>&nbsp;<span class="op" id="3831693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831696">mu</span>&nbsp;<span class="ident" id="3831699">sync</span><span class="op" id="3831703">.</span><span class="ident" id="3831704">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831716">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831731">m</span>&nbsp;&nbsp;<span class="keyword" id="3831734">map</span><span class="op" id="3831737">[</span><span class="builtintype" id="3831738">string</span><span class="op" id="3831744">]</span><span class="op" id="3831745">*</span><span class="ident" id="3831746">call</span>&nbsp;<span class="comment" id="3831751">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3831773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3831776">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3831845">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3831862">type</span>&nbsp;<span class="ident" id="3831867">singleflightResult</span>&nbsp;<span class="keyword" id="3831886">struct</span>&nbsp;<span class="op" id="3831893">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831896">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831903">interface</span><span class="op" id="3831912">{</span><span class="op" id="3831913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831916">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3831923">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831930">shared</span>&nbsp;<span class="builtintype" id="3831937">bool</span><br>
<span class="lineno"></span><span class="op" id="3831942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3831945">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3832014">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3832080">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3832149">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3832204">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3832282">func</span>&nbsp;<span class="op" id="3832287">(</span><span class="ident" id="3832288">g</span>&nbsp;<span class="op" id="3832290">*</span><span class="ident" id="3832291">singleflight</span><span class="op" id="3832303">)</span>&nbsp;<span class="ident" id="3832305">Do</span><span class="op" id="3832307">(</span><span class="ident" id="3832308">key</span>&nbsp;<span class="builtintype" id="3832312">string</span><span class="op" id="3832318">,</span>&nbsp;<span class="ident" id="3832320">fn</span>&nbsp;<span class="keyword" id="3832323">func</span><span class="op" id="3832327">(</span><span class="op" id="3832328">)</span>&nbsp;<span class="op" id="3832330">(</span><span class="keyword" id="3832331">interface</span><span class="op" id="3832340">{</span><span class="op" id="3832341">}</span><span class="op" id="3832342">,</span>&nbsp;<span class="builtintype" id="3832344">error</span><span class="op" id="3832349">)</span><span class="op" id="3832350">)</span>&nbsp;<span class="op" id="3832352">(</span><span class="ident" id="3832353">v</span>&nbsp;<span class="keyword" id="3832355">interface</span><span class="op" id="3832364">{</span><span class="op" id="3832365">}</span><span class="op" id="3832366">,</span>&nbsp;<span class="ident" id="3832368">err</span>&nbsp;<span class="builtintype" id="3832372">error</span><span class="op" id="3832377">,</span>&nbsp;<span class="ident" id="3832379">shared</span>&nbsp;<span class="builtintype" id="3832386">bool</span><span class="op" id="3832390">)</span>&nbsp;<span class="op" id="3832392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832395">g</span><span class="op" id="3832396">.</span><span class="ident" id="3832397">mu</span><span class="op" id="3832399">.</span><span class="ident" id="3832400">Lock</span><span class="op" id="3832404">(</span><span class="op" id="3832405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832408">if</span>&nbsp;<span class="ident" id="3832411">g</span><span class="op" id="3832412">.</span><span class="ident" id="3832413">m</span>&nbsp;<span class="op" id="3832415">==</span>&nbsp;<span class="builtintype" id="3832418">nil</span>&nbsp;<span class="op" id="3832422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832426">g</span><span class="op" id="3832427">.</span><span class="ident" id="3832428">m</span>&nbsp;<span class="op" id="3832430">=</span>&nbsp;<span class="builtinfunc" id="3832432">make</span><span class="op" id="3832436">(</span><span class="keyword" id="3832437">map</span><span class="op" id="3832440">[</span><span class="builtintype" id="3832441">string</span><span class="op" id="3832447">]</span><span class="op" id="3832448">*</span><span class="ident" id="3832449">call</span><span class="op" id="3832453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832456">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832459">if</span>&nbsp;<span class="ident" id="3832462">c</span><span class="op" id="3832463">,</span>&nbsp;<span class="ident" id="3832465">ok</span>&nbsp;<span class="op" id="3832468">:=</span>&nbsp;<span class="ident" id="3832471">g</span><span class="op" id="3832472">.</span><span class="ident" id="3832473">m</span><span class="op" id="3832474">[</span><span class="ident" id="3832475">key</span><span class="op" id="3832478">]</span><span class="op" id="3832479">;</span>&nbsp;<span class="ident" id="3832481">ok</span>&nbsp;<span class="op" id="3832484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832488">c</span><span class="op" id="3832489">.</span><span class="ident" id="3832490">dups</span><span class="op" id="3832494">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832499">g</span><span class="op" id="3832500">.</span><span class="ident" id="3832501">mu</span><span class="op" id="3832503">.</span><span class="ident" id="3832504">Unlock</span><span class="op" id="3832510">(</span><span class="op" id="3832511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832515">c</span><span class="op" id="3832516">.</span><span class="ident" id="3832517">wg</span><span class="op" id="3832519">.</span><span class="ident" id="3832520">Wait</span><span class="op" id="3832524">(</span><span class="op" id="3832525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832529">return</span>&nbsp;<span class="ident" id="3832536">c</span><span class="op" id="3832537">.</span><span class="ident" id="3832538">val</span><span class="op" id="3832541">,</span>&nbsp;<span class="ident" id="3832543">c</span><span class="op" id="3832544">.</span><span class="ident" id="3832545">err</span><span class="op" id="3832548">,</span>&nbsp;<span class="builtintype" id="3832550">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832559">c</span>&nbsp;<span class="op" id="3832561">:=</span>&nbsp;<span class="builtinfunc" id="3832564">new</span><span class="op" id="3832567">(</span><span class="ident" id="3832568">call</span><span class="op" id="3832572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832575">c</span><span class="op" id="3832576">.</span><span class="ident" id="3832577">wg</span><span class="op" id="3832579">.</span><span class="ident" id="3832580">Add</span><span class="op" id="3832583">(</span><span class="num" id="3832584">1</span><span class="op" id="3832585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832588">g</span><span class="op" id="3832589">.</span><span class="ident" id="3832590">m</span><span class="op" id="3832591">[</span><span class="ident" id="3832592">key</span><span class="op" id="3832595">]</span>&nbsp;<span class="op" id="3832597">=</span>&nbsp;<span class="ident" id="3832599">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832602">g</span><span class="op" id="3832603">.</span><span class="ident" id="3832604">mu</span><span class="op" id="3832606">.</span><span class="ident" id="3832607">Unlock</span><span class="op" id="3832613">(</span><span class="op" id="3832614">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832618">g</span><span class="op" id="3832619">.</span><span class="ident" id="3832620">doCall</span><span class="op" id="3832626">(</span><span class="ident" id="3832627">c</span><span class="op" id="3832628">,</span>&nbsp;<span class="ident" id="3832630">key</span><span class="op" id="3832633">,</span>&nbsp;<span class="ident" id="3832635">fn</span><span class="op" id="3832637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832640">return</span>&nbsp;<span class="ident" id="3832647">c</span><span class="op" id="3832648">.</span><span class="ident" id="3832649">val</span><span class="op" id="3832652">,</span>&nbsp;<span class="ident" id="3832654">c</span><span class="op" id="3832655">.</span><span class="ident" id="3832656">err</span><span class="op" id="3832659">,</span>&nbsp;<span class="ident" id="3832661">c</span><span class="op" id="3832662">.</span><span class="ident" id="3832663">dups</span>&nbsp;<span class="op" id="3832668">&gt;</span>&nbsp;<span class="num" id="3832670">0</span><br>
<span class="lineno"></span><span class="op" id="3832672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3832675">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3832740">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3832772">func</span>&nbsp;<span class="op" id="3832777">(</span><span class="ident" id="3832778">g</span>&nbsp;<span class="op" id="3832780">*</span><span class="ident" id="3832781">singleflight</span><span class="op" id="3832793">)</span>&nbsp;<span class="ident" id="3832795">DoChan</span><span class="op" id="3832801">(</span><span class="ident" id="3832802">key</span>&nbsp;<span class="builtintype" id="3832806">string</span><span class="op" id="3832812">,</span>&nbsp;<span class="ident" id="3832814">fn</span>&nbsp;<span class="keyword" id="3832817">func</span><span class="op" id="3832821">(</span><span class="op" id="3832822">)</span>&nbsp;<span class="op" id="3832824">(</span><span class="keyword" id="3832825">interface</span><span class="op" id="3832834">{</span><span class="op" id="3832835">}</span><span class="op" id="3832836">,</span>&nbsp;<span class="builtintype" id="3832838">error</span><span class="op" id="3832843">)</span><span class="op" id="3832844">)</span>&nbsp;<span class="op" id="3832846">&lt;-</span><span class="keyword" id="3832848">chan</span>&nbsp;<span class="ident" id="3832853">singleflightResult</span>&nbsp;<span class="op" id="3832872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832875">ch</span>&nbsp;<span class="op" id="3832878">:=</span>&nbsp;<span class="builtinfunc" id="3832881">make</span><span class="op" id="3832885">(</span><span class="keyword" id="3832886">chan</span>&nbsp;<span class="ident" id="3832891">singleflightResult</span><span class="op" id="3832909">,</span>&nbsp;<span class="num" id="3832911">1</span><span class="op" id="3832912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832915">g</span><span class="op" id="3832916">.</span><span class="ident" id="3832917">mu</span><span class="op" id="3832919">.</span><span class="ident" id="3832920">Lock</span><span class="op" id="3832924">(</span><span class="op" id="3832925">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832928">if</span>&nbsp;<span class="ident" id="3832931">g</span><span class="op" id="3832932">.</span><span class="ident" id="3832933">m</span>&nbsp;<span class="op" id="3832935">==</span>&nbsp;<span class="builtintype" id="3832938">nil</span>&nbsp;<span class="op" id="3832942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832946">g</span><span class="op" id="3832947">.</span><span class="ident" id="3832948">m</span>&nbsp;<span class="op" id="3832950">=</span>&nbsp;<span class="builtinfunc" id="3832952">make</span><span class="op" id="3832956">(</span><span class="keyword" id="3832957">map</span><span class="op" id="3832960">[</span><span class="builtintype" id="3832961">string</span><span class="op" id="3832967">]</span><span class="op" id="3832968">*</span><span class="ident" id="3832969">call</span><span class="op" id="3832973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832979">if</span>&nbsp;<span class="ident" id="3832982">c</span><span class="op" id="3832983">,</span>&nbsp;<span class="ident" id="3832985">ok</span>&nbsp;<span class="op" id="3832988">:=</span>&nbsp;<span class="ident" id="3832991">g</span><span class="op" id="3832992">.</span><span class="ident" id="3832993">m</span><span class="op" id="3832994">[</span><span class="ident" id="3832995">key</span><span class="op" id="3832998">]</span><span class="op" id="3832999">;</span>&nbsp;<span class="ident" id="3833001">ok</span>&nbsp;<span class="op" id="3833004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833008">c</span><span class="op" id="3833009">.</span><span class="ident" id="3833010">dups</span><span class="op" id="3833014">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833019">c</span><span class="op" id="3833020">.</span><span class="ident" id="3833021">chans</span>&nbsp;<span class="op" id="3833027">=</span>&nbsp;<span class="builtinfunc" id="3833029">append</span><span class="op" id="3833035">(</span><span class="ident" id="3833036">c</span><span class="op" id="3833037">.</span><span class="ident" id="3833038">chans</span><span class="op" id="3833043">,</span>&nbsp;<span class="ident" id="3833045">ch</span><span class="op" id="3833047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833051">g</span><span class="op" id="3833052">.</span><span class="ident" id="3833053">mu</span><span class="op" id="3833055">.</span><span class="ident" id="3833056">Unlock</span><span class="op" id="3833062">(</span><span class="op" id="3833063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833067">return</span>&nbsp;<span class="ident" id="3833074">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833081">c</span>&nbsp;<span class="op" id="3833083">:=</span>&nbsp;<span class="op" id="3833086">&amp;</span><span class="ident" id="3833087">call</span><span class="op" id="3833091">{</span><span class="ident" id="3833092">chans</span><span class="op" id="3833097">:</span>&nbsp;<span class="op" id="3833099">[</span><span class="op" id="3833100">]</span><span class="keyword" id="3833101">chan</span><span class="op" id="3833105">&lt;-</span>&nbsp;<span class="ident" id="3833108">singleflightResult</span><span class="op" id="3833126">{</span><span class="ident" id="3833127">ch</span><span class="op" id="3833129">}</span><span class="op" id="3833130">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833133">c</span><span class="op" id="3833134">.</span><span class="ident" id="3833135">wg</span><span class="op" id="3833137">.</span><span class="ident" id="3833138">Add</span><span class="op" id="3833141">(</span><span class="num" id="3833142">1</span><span class="op" id="3833143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833146">g</span><span class="op" id="3833147">.</span><span class="ident" id="3833148">m</span><span class="op" id="3833149">[</span><span class="ident" id="3833150">key</span><span class="op" id="3833153">]</span>&nbsp;<span class="op" id="3833155">=</span>&nbsp;<span class="ident" id="3833157">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833160">g</span><span class="op" id="3833161">.</span><span class="ident" id="3833162">mu</span><span class="op" id="3833164">.</span><span class="ident" id="3833165">Unlock</span><span class="op" id="3833171">(</span><span class="op" id="3833172">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833176">go</span>&nbsp;<span class="ident" id="3833179">g</span><span class="op" id="3833180">.</span><span class="ident" id="3833181">doCall</span><span class="op" id="3833187">(</span><span class="ident" id="3833188">c</span><span class="op" id="3833189">,</span>&nbsp;<span class="ident" id="3833191">key</span><span class="op" id="3833194">,</span>&nbsp;<span class="ident" id="3833196">fn</span><span class="op" id="3833198">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833202">return</span>&nbsp;<span class="ident" id="3833209">ch</span><br>
<span class="lineno"></span><span class="op" id="3833212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833215">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3833260">func</span>&nbsp;<span class="op" id="3833265">(</span><span class="ident" id="3833266">g</span>&nbsp;<span class="op" id="3833268">*</span><span class="ident" id="3833269">singleflight</span><span class="op" id="3833281">)</span>&nbsp;<span class="ident" id="3833283">doCall</span><span class="op" id="3833289">(</span><span class="ident" id="3833290">c</span>&nbsp;<span class="op" id="3833292">*</span><span class="ident" id="3833293">call</span><span class="op" id="3833297">,</span>&nbsp;<span class="ident" id="3833299">key</span>&nbsp;<span class="builtintype" id="3833303">string</span><span class="op" id="3833309">,</span>&nbsp;<span class="ident" id="3833311">fn</span>&nbsp;<span class="keyword" id="3833314">func</span><span class="op" id="3833318">(</span><span class="op" id="3833319">)</span>&nbsp;<span class="op" id="3833321">(</span><span class="keyword" id="3833322">interface</span><span class="op" id="3833331">{</span><span class="op" id="3833332">}</span><span class="op" id="3833333">,</span>&nbsp;<span class="builtintype" id="3833335">error</span><span class="op" id="3833340">)</span><span class="op" id="3833341">)</span>&nbsp;<span class="op" id="3833343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833346">c</span><span class="op" id="3833347">.</span><span class="ident" id="3833348">val</span><span class="op" id="3833351">,</span>&nbsp;<span class="ident" id="3833353">c</span><span class="op" id="3833354">.</span><span class="ident" id="3833355">err</span>&nbsp;<span class="op" id="3833359">=</span>&nbsp;<span class="ident" id="3833361">fn</span><span class="op" id="3833363">(</span><span class="op" id="3833364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833367">c</span><span class="op" id="3833368">.</span><span class="ident" id="3833369">wg</span><span class="op" id="3833371">.</span><span class="ident" id="3833372">Done</span><span class="op" id="3833376">(</span><span class="op" id="3833377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833381">g</span><span class="op" id="3833382">.</span><span class="ident" id="3833383">mu</span><span class="op" id="3833385">.</span><span class="ident" id="3833386">Lock</span><span class="op" id="3833390">(</span><span class="op" id="3833391">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3833394">delete</span><span class="op" id="3833400">(</span><span class="ident" id="3833401">g</span><span class="op" id="3833402">.</span><span class="ident" id="3833403">m</span><span class="op" id="3833404">,</span>&nbsp;<span class="ident" id="3833406">key</span><span class="op" id="3833409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833412">for</span>&nbsp;<span class="ident" id="3833416">_</span><span class="op" id="3833417">,</span>&nbsp;<span class="ident" id="3833419">ch</span>&nbsp;<span class="op" id="3833422">:=</span>&nbsp;<span class="keyword" id="3833425">range</span>&nbsp;<span class="ident" id="3833431">c</span><span class="op" id="3833432">.</span><span class="ident" id="3833433">chans</span>&nbsp;<span class="op" id="3833439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833443">ch</span>&nbsp;<span class="op" id="3833446">&lt;-</span>&nbsp;<span class="ident" id="3833449">singleflightResult</span><span class="op" id="3833467">{</span><span class="ident" id="3833468">c</span><span class="op" id="3833469">.</span><span class="ident" id="3833470">val</span><span class="op" id="3833473">,</span>&nbsp;<span class="ident" id="3833475">c</span><span class="op" id="3833476">.</span><span class="ident" id="3833477">err</span><span class="op" id="3833480">,</span>&nbsp;<span class="ident" id="3833482">c</span><span class="op" id="3833483">.</span><span class="ident" id="3833484">dups</span>&nbsp;<span class="op" id="3833489">&gt;</span>&nbsp;<span class="num" id="3833491">0</span><span class="op" id="3833492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833498">g</span><span class="op" id="3833499">.</span><span class="ident" id="3833500">mu</span><span class="op" id="3833502">.</span><span class="ident" id="3833503">Unlock</span><span class="op" id="3833509">(</span><span class="op" id="3833510">)</span><br>
<span class="lineno">100</span><span class="op" id="3833512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833515">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3833585">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3833654">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3833686">func</span>&nbsp;<span class="op" id="3833691">(</span><span class="ident" id="3833692">g</span>&nbsp;<span class="op" id="3833694">*</span><span class="ident" id="3833695">singleflight</span><span class="op" id="3833707">)</span>&nbsp;<span class="ident" id="3833709">Forget</span><span class="op" id="3833715">(</span><span class="ident" id="3833716">key</span>&nbsp;<span class="builtintype" id="3833720">string</span><span class="op" id="3833726">)</span>&nbsp;<span class="op" id="3833728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833731">g</span><span class="op" id="3833732">.</span><span class="ident" id="3833733">mu</span><span class="op" id="3833735">.</span><span class="ident" id="3833736">Lock</span><span class="op" id="3833740">(</span><span class="op" id="3833741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3833744">delete</span><span class="op" id="3833750">(</span><span class="ident" id="3833751">g</span><span class="op" id="3833752">.</span><span class="ident" id="3833753">m</span><span class="op" id="3833754">,</span>&nbsp;<span class="ident" id="3833756">key</span><span class="op" id="3833759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833762">g</span><span class="op" id="3833763">.</span><span class="ident" id="3833764">mu</span><span class="op" id="3833766">.</span><span class="ident" id="3833767">Unlock</span><span class="op" id="3833773">(</span><span class="op" id="3833774">)</span><br>
<span class="lineno"></span><span class="op" id="3833776">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
