<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html" class="current">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3866574">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3866629">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3866683">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3866734">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="3866805">package</span>&nbsp;<span class="ident" id="3866813">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3866818">import</span>&nbsp;<span class="op" id="3866825">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866828">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866838">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866854">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866868">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866883">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866899">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866909">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866922">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866929">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3866940">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3866947">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3866950">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3867001">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3867044">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3867102">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="3867131">func</span>&nbsp;<span class="ident" id="3867136">Server</span><span class="op" id="3867142">(</span><span class="ident" id="3867143">conn</span>&nbsp;<span class="ident" id="3867148">net</span><span class="op" id="3867151">.</span><span class="ident" id="3867152">Conn</span><span class="op" id="3867156">,</span>&nbsp;<span class="ident" id="3867158">config</span>&nbsp;<span class="op" id="3867165">*</span><span class="ident" id="3867166">Config</span><span class="op" id="3867172">)</span>&nbsp;<span class="op" id="3867174">*</span><span class="ident" id="3867175">Conn</span>&nbsp;<span class="op" id="3867180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3867183">return</span>&nbsp;<span class="op" id="3867190">&amp;</span><span class="ident" id="3867191">Conn</span><span class="op" id="3867195">{</span><span class="ident" id="3867196">conn</span><span class="op" id="3867200">:</span>&nbsp;<span class="ident" id="3867202">conn</span><span class="op" id="3867206">,</span>&nbsp;<span class="ident" id="3867208">config</span><span class="op" id="3867214">:</span>&nbsp;<span class="ident" id="3867216">config</span><span class="op" id="3867222">}</span><br>
<span class="lineno"></span><span class="op" id="3867224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867227">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="3867278">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="3867321">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3867386">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="3867423">func</span>&nbsp;<span class="ident" id="3867428">Client</span><span class="op" id="3867434">(</span><span class="ident" id="3867435">conn</span>&nbsp;<span class="ident" id="3867440">net</span><span class="op" id="3867443">.</span><span class="ident" id="3867444">Conn</span><span class="op" id="3867448">,</span>&nbsp;<span class="ident" id="3867450">config</span>&nbsp;<span class="op" id="3867457">*</span><span class="ident" id="3867458">Config</span><span class="op" id="3867464">)</span>&nbsp;<span class="op" id="3867466">*</span><span class="ident" id="3867467">Conn</span>&nbsp;<span class="op" id="3867472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3867475">return</span>&nbsp;<span class="op" id="3867482">&amp;</span><span class="ident" id="3867483">Conn</span><span class="op" id="3867487">{</span><span class="ident" id="3867488">conn</span><span class="op" id="3867492">:</span>&nbsp;<span class="ident" id="3867494">conn</span><span class="op" id="3867498">,</span>&nbsp;<span class="ident" id="3867500">config</span><span class="op" id="3867506">:</span>&nbsp;<span class="ident" id="3867508">config</span><span class="op" id="3867514">,</span>&nbsp;<span class="ident" id="3867516">isClient</span><span class="op" id="3867524">:</span>&nbsp;<span class="builtintype" id="3867526">true</span><span class="op" id="3867530">}</span><br>
<span class="lineno">35</span><span class="op" id="3867532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867535">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3867615">type</span>&nbsp;<span class="ident" id="3867620">listener</span>&nbsp;<span class="keyword" id="3867629">struct</span>&nbsp;<span class="op" id="3867636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867639">net</span><span class="op" id="3867642">.</span><span class="ident" id="3867643">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867653">config</span>&nbsp;<span class="op" id="3867660">*</span><span class="ident" id="3867661">Config</span><br>
<span class="lineno"></span><span class="op" id="3867668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867671">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3867737">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="3867782">func</span>&nbsp;<span class="op" id="3867787">(</span><span class="ident" id="3867788">l</span>&nbsp;<span class="op" id="3867790">*</span><span class="ident" id="3867791">listener</span><span class="op" id="3867799">)</span>&nbsp;<span class="ident" id="3867801">Accept</span><span class="op" id="3867807">(</span><span class="op" id="3867808">)</span>&nbsp;<span class="op" id="3867810">(</span><span class="ident" id="3867811">c</span>&nbsp;<span class="ident" id="3867813">net</span><span class="op" id="3867816">.</span><span class="ident" id="3867817">Conn</span><span class="op" id="3867821">,</span>&nbsp;<span class="ident" id="3867823">err</span>&nbsp;<span class="builtintype" id="3867827">error</span><span class="op" id="3867832">)</span>&nbsp;<span class="op" id="3867834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867837">c</span><span class="op" id="3867838">,</span>&nbsp;<span class="ident" id="3867840">err</span>&nbsp;<span class="op" id="3867844">=</span>&nbsp;<span class="ident" id="3867846">l</span><span class="op" id="3867847">.</span><span class="ident" id="3867848">Listener</span><span class="op" id="3867856">.</span><span class="ident" id="3867857">Accept</span><span class="op" id="3867863">(</span><span class="op" id="3867864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3867867">if</span>&nbsp;<span class="ident" id="3867870">err</span>&nbsp;<span class="op" id="3867874">!=</span>&nbsp;<span class="builtintype" id="3867877">nil</span>&nbsp;<span class="op" id="3867881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3867885">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3867893">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3867896">c</span>&nbsp;<span class="op" id="3867898">=</span>&nbsp;<span class="ident" id="3867900">Server</span><span class="op" id="3867906">(</span><span class="ident" id="3867907">c</span><span class="op" id="3867908">,</span>&nbsp;<span class="ident" id="3867910">l</span><span class="op" id="3867911">.</span><span class="ident" id="3867912">config</span><span class="op" id="3867918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3867921">return</span><br>
<span class="lineno"></span><span class="op" id="3867928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867931">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="3868005">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="3868056">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3868114">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3868143">func</span>&nbsp;<span class="ident" id="3868148">NewListener</span><span class="op" id="3868159">(</span><span class="ident" id="3868160">inner</span>&nbsp;<span class="ident" id="3868166">net</span><span class="op" id="3868169">.</span><span class="ident" id="3868170">Listener</span><span class="op" id="3868178">,</span>&nbsp;<span class="ident" id="3868180">config</span>&nbsp;<span class="op" id="3868187">*</span><span class="ident" id="3868188">Config</span><span class="op" id="3868194">)</span>&nbsp;<span class="ident" id="3868196">net</span><span class="op" id="3868199">.</span><span class="ident" id="3868200">Listener</span>&nbsp;<span class="op" id="3868209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3868212">l</span>&nbsp;<span class="op" id="3868214">:=</span>&nbsp;<span class="builtinfunc" id="3868217">new</span><span class="op" id="3868220">(</span><span class="ident" id="3868221">listener</span><span class="op" id="3868229">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3868232">l</span><span class="op" id="3868233">.</span><span class="ident" id="3868234">Listener</span>&nbsp;<span class="op" id="3868243">=</span>&nbsp;<span class="ident" id="3868245">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3868252">l</span><span class="op" id="3868253">.</span><span class="ident" id="3868254">config</span>&nbsp;<span class="op" id="3868261">=</span>&nbsp;<span class="ident" id="3868263">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3868271">return</span>&nbsp;<span class="ident" id="3868278">l</span><br>
<span class="lineno"></span><span class="op" id="3868280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3868283">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3868345">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="3868388">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3868446">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3868475">func</span>&nbsp;<span class="ident" id="3868480">Listen</span><span class="op" id="3868486">(</span><span class="ident" id="3868487">network</span><span class="op" id="3868494">,</span>&nbsp;<span class="ident" id="3868496">laddr</span>&nbsp;<span class="builtintype" id="3868502">string</span><span class="op" id="3868508">,</span>&nbsp;<span class="ident" id="3868510">config</span>&nbsp;<span class="op" id="3868517">*</span><span class="ident" id="3868518">Config</span><span class="op" id="3868524">)</span>&nbsp;<span class="op" id="3868526">(</span><span class="ident" id="3868527">net</span><span class="op" id="3868530">.</span><span class="ident" id="3868531">Listener</span><span class="op" id="3868539">,</span>&nbsp;<span class="builtintype" id="3868541">error</span><span class="op" id="3868546">)</span>&nbsp;<span class="op" id="3868548">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3868551">if</span>&nbsp;<span class="ident" id="3868554">config</span>&nbsp;<span class="op" id="3868561">==</span>&nbsp;<span class="builtintype" id="3868564">nil</span>&nbsp;<span class="op" id="3868568">||</span>&nbsp;<span class="builtinfunc" id="3868571">len</span><span class="op" id="3868574">(</span><span class="ident" id="3868575">config</span><span class="op" id="3868581">.</span><span class="ident" id="3868582">Certificates</span><span class="op" id="3868594">)</span>&nbsp;<span class="op" id="3868596">==</span>&nbsp;<span class="num" id="3868599">0</span>&nbsp;<span class="op" id="3868601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3868605">return</span>&nbsp;<span class="builtintype" id="3868612">nil</span><span class="op" id="3868615">,</span>&nbsp;<span class="ident" id="3868617">errors</span><span class="op" id="3868623">.</span><span class="ident" id="3868624">New</span><span class="op" id="3868627">(</span><span class="string" id="3868628">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="3868674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3868677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3868680">l</span><span class="op" id="3868681">,</span>&nbsp;<span class="ident" id="3868683">err</span>&nbsp;<span class="op" id="3868687">:=</span>&nbsp;<span class="ident" id="3868690">net</span><span class="op" id="3868693">.</span><span class="ident" id="3868694">Listen</span><span class="op" id="3868700">(</span><span class="ident" id="3868701">network</span><span class="op" id="3868708">,</span>&nbsp;<span class="ident" id="3868710">laddr</span><span class="op" id="3868715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3868718">if</span>&nbsp;<span class="ident" id="3868721">err</span>&nbsp;<span class="op" id="3868725">!=</span>&nbsp;<span class="builtintype" id="3868728">nil</span>&nbsp;<span class="op" id="3868732">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3868736">return</span>&nbsp;<span class="builtintype" id="3868743">nil</span><span class="op" id="3868746">,</span>&nbsp;<span class="ident" id="3868748">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3868753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3868756">return</span>&nbsp;<span class="ident" id="3868763">NewListener</span><span class="op" id="3868774">(</span><span class="ident" id="3868775">l</span><span class="op" id="3868776">,</span>&nbsp;<span class="ident" id="3868778">config</span><span class="op" id="3868784">)</span><span class="op" id="3868785">,</span>&nbsp;<span class="builtintype" id="3868787">nil</span><br>
<span class="lineno"></span><span class="op" id="3868791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3868794">type</span>&nbsp;<span class="ident" id="3868799">timeoutError</span>&nbsp;<span class="keyword" id="3868812">struct</span><span class="op" id="3868818">{</span><span class="op" id="3868819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3868822">func</span>&nbsp;<span class="op" id="3868827">(</span><span class="ident" id="3868828">timeoutError</span><span class="op" id="3868840">)</span>&nbsp;<span class="ident" id="3868842">Error</span><span class="op" id="3868847">(</span><span class="op" id="3868848">)</span>&nbsp;<span class="builtintype" id="3868850">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3868859">{</span>&nbsp;<span class="keyword" id="3868861">return</span>&nbsp;<span class="string" id="3868868">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="3868900">}</span><br>
<span class="lineno"></span><span class="keyword" id="3868902">func</span>&nbsp;<span class="op" id="3868907">(</span><span class="ident" id="3868908">timeoutError</span><span class="op" id="3868920">)</span>&nbsp;<span class="ident" id="3868922">Timeout</span><span class="op" id="3868929">(</span><span class="op" id="3868930">)</span>&nbsp;<span class="builtintype" id="3868932">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3868939">{</span>&nbsp;<span class="keyword" id="3868941">return</span>&nbsp;<span class="builtintype" id="3868948">true</span>&nbsp;<span class="op" id="3868953">}</span><br>
<span class="lineno"></span><span class="keyword" id="3868955">func</span>&nbsp;<span class="op" id="3868960">(</span><span class="ident" id="3868961">timeoutError</span><span class="op" id="3868973">)</span>&nbsp;<span class="ident" id="3868975">Temporary</span><span class="op" id="3868984">(</span><span class="op" id="3868985">)</span>&nbsp;<span class="builtintype" id="3868987">bool</span>&nbsp;<span class="op" id="3868992">{</span>&nbsp;<span class="keyword" id="3868994">return</span>&nbsp;<span class="builtintype" id="3869001">true</span>&nbsp;<span class="op" id="3869006">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3869009">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3869087">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="3869166">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="3869237">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="3869262">//</span><br>
<span class="lineno"></span><span class="comment" id="3869265">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="3869340">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3869408">func</span>&nbsp;<span class="ident" id="3869413">DialWithDialer</span><span class="op" id="3869427">(</span><span class="ident" id="3869428">dialer</span>&nbsp;<span class="op" id="3869435">*</span><span class="ident" id="3869436">net</span><span class="op" id="3869439">.</span><span class="ident" id="3869440">Dialer</span><span class="op" id="3869446">,</span>&nbsp;<span class="ident" id="3869448">network</span><span class="op" id="3869455">,</span>&nbsp;<span class="ident" id="3869457">addr</span>&nbsp;<span class="builtintype" id="3869462">string</span><span class="op" id="3869468">,</span>&nbsp;<span class="ident" id="3869470">config</span>&nbsp;<span class="op" id="3869477">*</span><span class="ident" id="3869478">Config</span><span class="op" id="3869484">)</span>&nbsp;<span class="op" id="3869486">(</span><span class="op" id="3869487">*</span><span class="ident" id="3869488">Conn</span><span class="op" id="3869492">,</span>&nbsp;<span class="builtintype" id="3869494">error</span><span class="op" id="3869499">)</span>&nbsp;<span class="op" id="3869501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3869504">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3869573">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3869645">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3869688">timeout</span>&nbsp;<span class="op" id="3869696">:=</span>&nbsp;<span class="ident" id="3869699">dialer</span><span class="op" id="3869705">.</span><span class="ident" id="3869706">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3869716">if</span>&nbsp;<span class="op" id="3869719">!</span><span class="ident" id="3869720">dialer</span><span class="op" id="3869726">.</span><span class="ident" id="3869727">Deadline</span><span class="op" id="3869735">.</span><span class="ident" id="3869736">IsZero</span><span class="op" id="3869742">(</span><span class="op" id="3869743">)</span>&nbsp;<span class="op" id="3869745">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3869749">deadlineTimeout</span>&nbsp;<span class="op" id="3869765">:=</span>&nbsp;<span class="ident" id="3869768">dialer</span><span class="op" id="3869774">.</span><span class="ident" id="3869775">Deadline</span><span class="op" id="3869783">.</span><span class="ident" id="3869784">Sub</span><span class="op" id="3869787">(</span><span class="ident" id="3869788">time</span><span class="op" id="3869792">.</span><span class="ident" id="3869793">Now</span><span class="op" id="3869796">(</span><span class="op" id="3869797">)</span><span class="op" id="3869798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3869802">if</span>&nbsp;<span class="ident" id="3869805">timeout</span>&nbsp;<span class="op" id="3869813">==</span>&nbsp;<span class="num" id="3869816">0</span>&nbsp;<span class="op" id="3869818">||</span>&nbsp;<span class="ident" id="3869821">deadlineTimeout</span>&nbsp;<span class="op" id="3869837">&lt;</span>&nbsp;<span class="ident" id="3869839">timeout</span>&nbsp;<span class="op" id="3869847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3869852">timeout</span>&nbsp;<span class="op" id="3869860">=</span>&nbsp;<span class="ident" id="3869862">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3869880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3869883">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3869887">var</span>&nbsp;<span class="ident" id="3869891">errChannel</span>&nbsp;<span class="keyword" id="3869902">chan</span>&nbsp;<span class="builtintype" id="3869907">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3869915">if</span>&nbsp;<span class="ident" id="3869918">timeout</span>&nbsp;<span class="op" id="3869926">!=</span>&nbsp;<span class="num" id="3869929">0</span>&nbsp;<span class="op" id="3869931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3869935">errChannel</span>&nbsp;<span class="op" id="3869946">=</span>&nbsp;<span class="builtinfunc" id="3869948">make</span><span class="op" id="3869952">(</span><span class="keyword" id="3869953">chan</span>&nbsp;<span class="builtintype" id="3869958">error</span><span class="op" id="3869963">,</span>&nbsp;<span class="num" id="3869965">2</span><span class="op" id="3869966">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3869970">time</span><span class="op" id="3869974">.</span><span class="ident" id="3869975">AfterFunc</span><span class="op" id="3869984">(</span><span class="ident" id="3869985">timeout</span><span class="op" id="3869992">,</span>&nbsp;<span class="keyword" id="3869994">func</span><span class="op" id="3869998">(</span><span class="op" id="3869999">)</span>&nbsp;<span class="op" id="3870001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870006">errChannel</span>&nbsp;<span class="op" id="3870017">&lt;-</span>&nbsp;<span class="ident" id="3870020">timeoutError</span><span class="op" id="3870032">{</span><span class="op" id="3870033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870037">}</span><span class="op" id="3870038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870045">rawConn</span><span class="op" id="3870052">,</span>&nbsp;<span class="ident" id="3870054">err</span>&nbsp;<span class="op" id="3870058">:=</span>&nbsp;<span class="ident" id="3870061">dialer</span><span class="op" id="3870067">.</span><span class="ident" id="3870068">Dial</span><span class="op" id="3870072">(</span><span class="ident" id="3870073">network</span><span class="op" id="3870080">,</span>&nbsp;<span class="ident" id="3870082">addr</span><span class="op" id="3870086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870089">if</span>&nbsp;<span class="ident" id="3870092">err</span>&nbsp;<span class="op" id="3870096">!=</span>&nbsp;<span class="builtintype" id="3870099">nil</span>&nbsp;<span class="op" id="3870103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870107">return</span>&nbsp;<span class="builtintype" id="3870114">nil</span><span class="op" id="3870117">,</span>&nbsp;<span class="ident" id="3870119">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870128">colonPos</span>&nbsp;<span class="op" id="3870137">:=</span>&nbsp;<span class="ident" id="3870140">strings</span><span class="op" id="3870147">.</span><span class="ident" id="3870148">LastIndex</span><span class="op" id="3870157">(</span><span class="ident" id="3870158">addr</span><span class="op" id="3870162">,</span>&nbsp;<span class="string" id="3870164">&#34;:&#34;</span><span class="op" id="3870167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870170">if</span>&nbsp;<span class="ident" id="3870173">colonPos</span>&nbsp;<span class="op" id="3870182">==</span>&nbsp;<span class="op" id="3870185">-</span><span class="num" id="3870186">1</span>&nbsp;<span class="op" id="3870188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870192">colonPos</span>&nbsp;<span class="op" id="3870201">=</span>&nbsp;<span class="builtinfunc" id="3870203">len</span><span class="op" id="3870206">(</span><span class="ident" id="3870207">addr</span><span class="op" id="3870211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870217">hostname</span>&nbsp;<span class="op" id="3870226">:=</span>&nbsp;<span class="ident" id="3870229">addr</span><span class="op" id="3870233">[</span><span class="op" id="3870234">:</span><span class="ident" id="3870235">colonPos</span><span class="op" id="3870243">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870247">if</span>&nbsp;<span class="ident" id="3870250">config</span>&nbsp;<span class="op" id="3870257">==</span>&nbsp;<span class="builtintype" id="3870260">nil</span>&nbsp;<span class="op" id="3870264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870268">config</span>&nbsp;<span class="op" id="3870275">=</span>&nbsp;<span class="ident" id="3870277">defaultConfig</span><span class="op" id="3870290">(</span><span class="op" id="3870291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3870297">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3870347">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870390">if</span>&nbsp;<span class="ident" id="3870393">config</span><span class="op" id="3870399">.</span><span class="ident" id="3870400">ServerName</span>&nbsp;<span class="op" id="3870411">==</span>&nbsp;<span class="string" id="3870414">&#34;&#34;</span>&nbsp;<span class="op" id="3870417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3870421">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870478">c</span>&nbsp;<span class="op" id="3870480">:=</span>&nbsp;<span class="op" id="3870483">*</span><span class="ident" id="3870484">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870493">c</span><span class="op" id="3870494">.</span><span class="ident" id="3870495">ServerName</span>&nbsp;<span class="op" id="3870506">=</span>&nbsp;<span class="ident" id="3870508">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870519">config</span>&nbsp;<span class="op" id="3870526">=</span>&nbsp;<span class="op" id="3870528">&amp;</span><span class="ident" id="3870529">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870536">conn</span>&nbsp;<span class="op" id="3870541">:=</span>&nbsp;<span class="ident" id="3870544">Client</span><span class="op" id="3870550">(</span><span class="ident" id="3870551">rawConn</span><span class="op" id="3870558">,</span>&nbsp;<span class="ident" id="3870560">config</span><span class="op" id="3870566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870570">if</span>&nbsp;<span class="ident" id="3870573">timeout</span>&nbsp;<span class="op" id="3870581">==</span>&nbsp;<span class="num" id="3870584">0</span>&nbsp;<span class="op" id="3870586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870590">err</span>&nbsp;<span class="op" id="3870594">=</span>&nbsp;<span class="ident" id="3870596">conn</span><span class="op" id="3870600">.</span><span class="ident" id="3870601">Handshake</span><span class="op" id="3870610">(</span><span class="op" id="3870611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870614">}</span>&nbsp;<span class="keyword" id="3870616">else</span>&nbsp;<span class="op" id="3870621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870625">go</span>&nbsp;<span class="keyword" id="3870628">func</span><span class="op" id="3870632">(</span><span class="op" id="3870633">)</span>&nbsp;<span class="op" id="3870635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870640">errChannel</span>&nbsp;<span class="op" id="3870651">&lt;-</span>&nbsp;<span class="ident" id="3870654">conn</span><span class="op" id="3870658">.</span><span class="ident" id="3870659">Handshake</span><span class="op" id="3870668">(</span><span class="op" id="3870669">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870673">}</span><span class="op" id="3870674">(</span><span class="op" id="3870675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870680">err</span>&nbsp;<span class="op" id="3870684">=</span>&nbsp;<span class="op" id="3870686">&lt;-</span><span class="ident" id="3870688">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870704">if</span>&nbsp;<span class="ident" id="3870707">err</span>&nbsp;<span class="op" id="3870711">!=</span>&nbsp;<span class="builtintype" id="3870714">nil</span>&nbsp;<span class="op" id="3870718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3870722">rawConn</span><span class="op" id="3870729">.</span><span class="ident" id="3870730">Close</span><span class="op" id="3870735">(</span><span class="op" id="3870736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870740">return</span>&nbsp;<span class="builtintype" id="3870747">nil</span><span class="op" id="3870750">,</span>&nbsp;<span class="ident" id="3870752">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3870757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3870761">return</span>&nbsp;<span class="ident" id="3870768">conn</span><span class="op" id="3870772">,</span>&nbsp;<span class="builtintype" id="3870774">nil</span><br>
<span class="lineno"></span><span class="op" id="3870778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3870781">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="3870842">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="3870905">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3870924">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3870980">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="3871039">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="3871060">func</span>&nbsp;<span class="ident" id="3871065">Dial</span><span class="op" id="3871069">(</span><span class="ident" id="3871070">network</span><span class="op" id="3871077">,</span>&nbsp;<span class="ident" id="3871079">addr</span>&nbsp;<span class="builtintype" id="3871084">string</span><span class="op" id="3871090">,</span>&nbsp;<span class="ident" id="3871092">config</span>&nbsp;<span class="op" id="3871099">*</span><span class="ident" id="3871100">Config</span><span class="op" id="3871106">)</span>&nbsp;<span class="op" id="3871108">(</span><span class="op" id="3871109">*</span><span class="ident" id="3871110">Conn</span><span class="op" id="3871114">,</span>&nbsp;<span class="builtintype" id="3871116">error</span><span class="op" id="3871121">)</span>&nbsp;<span class="op" id="3871123">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871126">return</span>&nbsp;<span class="ident" id="3871133">DialWithDialer</span><span class="op" id="3871147">(</span><span class="builtinfunc" id="3871148">new</span><span class="op" id="3871151">(</span><span class="ident" id="3871152">net</span><span class="op" id="3871155">.</span><span class="ident" id="3871156">Dialer</span><span class="op" id="3871162">)</span><span class="op" id="3871163">,</span>&nbsp;<span class="ident" id="3871165">network</span><span class="op" id="3871172">,</span>&nbsp;<span class="ident" id="3871174">addr</span><span class="op" id="3871178">,</span>&nbsp;<span class="ident" id="3871180">config</span><span class="op" id="3871186">)</span><br>
<span class="lineno"></span><span class="op" id="3871188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3871191">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3871268">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="3871319">func</span>&nbsp;<span class="ident" id="3871324">LoadX509KeyPair</span><span class="op" id="3871339">(</span><span class="ident" id="3871340">certFile</span><span class="op" id="3871348">,</span>&nbsp;<span class="ident" id="3871350">keyFile</span>&nbsp;<span class="builtintype" id="3871358">string</span><span class="op" id="3871364">)</span>&nbsp;<span class="op" id="3871366">(</span><span class="ident" id="3871367">cert</span>&nbsp;<span class="ident" id="3871372">Certificate</span><span class="op" id="3871383">,</span>&nbsp;<span class="ident" id="3871385">err</span>&nbsp;<span class="builtintype" id="3871389">error</span><span class="op" id="3871394">)</span>&nbsp;<span class="op" id="3871396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3871399">certPEMBlock</span><span class="op" id="3871411">,</span>&nbsp;<span class="ident" id="3871413">err</span>&nbsp;<span class="op" id="3871417">:=</span>&nbsp;<span class="ident" id="3871420">ioutil</span><span class="op" id="3871426">.</span><span class="ident" id="3871427">ReadFile</span><span class="op" id="3871435">(</span><span class="ident" id="3871436">certFile</span><span class="op" id="3871444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871447">if</span>&nbsp;<span class="ident" id="3871450">err</span>&nbsp;<span class="op" id="3871454">!=</span>&nbsp;<span class="builtintype" id="3871457">nil</span>&nbsp;<span class="op" id="3871461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871465">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3871473">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3871476">keyPEMBlock</span><span class="op" id="3871487">,</span>&nbsp;<span class="ident" id="3871489">err</span>&nbsp;<span class="op" id="3871493">:=</span>&nbsp;<span class="ident" id="3871496">ioutil</span><span class="op" id="3871502">.</span><span class="ident" id="3871503">ReadFile</span><span class="op" id="3871511">(</span><span class="ident" id="3871512">keyFile</span><span class="op" id="3871519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871522">if</span>&nbsp;<span class="ident" id="3871525">err</span>&nbsp;<span class="op" id="3871529">!=</span>&nbsp;<span class="builtintype" id="3871532">nil</span>&nbsp;<span class="op" id="3871536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871540">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3871548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871551">return</span>&nbsp;<span class="ident" id="3871558">X509KeyPair</span><span class="op" id="3871569">(</span><span class="ident" id="3871570">certPEMBlock</span><span class="op" id="3871582">,</span>&nbsp;<span class="ident" id="3871584">keyPEMBlock</span><span class="op" id="3871595">)</span><br>
<span class="lineno">180</span><span class="op" id="3871597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3871600">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3871663">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3871684">func</span>&nbsp;<span class="ident" id="3871689">X509KeyPair</span><span class="op" id="3871700">(</span><span class="ident" id="3871701">certPEMBlock</span><span class="op" id="3871713">,</span>&nbsp;<span class="ident" id="3871715">keyPEMBlock</span>&nbsp;<span class="op" id="3871727">[</span><span class="op" id="3871728">]</span><span class="builtintype" id="3871729">byte</span><span class="op" id="3871733">)</span>&nbsp;<span class="op" id="3871735">(</span><span class="ident" id="3871736">cert</span>&nbsp;<span class="ident" id="3871741">Certificate</span><span class="op" id="3871752">,</span>&nbsp;<span class="ident" id="3871754">err</span>&nbsp;<span class="builtintype" id="3871758">error</span><span class="op" id="3871763">)</span>&nbsp;<span class="op" id="3871765">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871768">var</span>&nbsp;<span class="ident" id="3871772">certDERBlock</span>&nbsp;<span class="op" id="3871785">*</span><span class="ident" id="3871786">pem</span><span class="op" id="3871789">.</span><span class="ident" id="3871790">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871797">for</span>&nbsp;<span class="op" id="3871801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3871805">certDERBlock</span><span class="op" id="3871817">,</span>&nbsp;<span class="ident" id="3871819">certPEMBlock</span>&nbsp;<span class="op" id="3871832">=</span>&nbsp;<span class="ident" id="3871834">pem</span><span class="op" id="3871837">.</span><span class="ident" id="3871838">Decode</span><span class="op" id="3871844">(</span><span class="ident" id="3871845">certPEMBlock</span><span class="op" id="3871857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871861">if</span>&nbsp;<span class="ident" id="3871864">certDERBlock</span>&nbsp;<span class="op" id="3871877">==</span>&nbsp;<span class="builtintype" id="3871880">nil</span>&nbsp;<span class="op" id="3871884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871889">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3871897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3871901">if</span>&nbsp;<span class="ident" id="3871904">certDERBlock</span><span class="op" id="3871916">.</span><span class="ident" id="3871917">Type</span>&nbsp;<span class="op" id="3871922">==</span>&nbsp;<span class="string" id="3871925">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="3871939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3871944">cert</span><span class="op" id="3871948">.</span><span class="ident" id="3871949">Certificate</span>&nbsp;<span class="op" id="3871961">=</span>&nbsp;<span class="builtinfunc" id="3871963">append</span><span class="op" id="3871969">(</span><span class="ident" id="3871970">cert</span><span class="op" id="3871974">.</span><span class="ident" id="3871975">Certificate</span><span class="op" id="3871986">,</span>&nbsp;<span class="ident" id="3871988">certDERBlock</span><span class="op" id="3872000">.</span><span class="ident" id="3872001">Bytes</span><span class="op" id="3872006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872013">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872017">if</span>&nbsp;<span class="builtinfunc" id="3872020">len</span><span class="op" id="3872023">(</span><span class="ident" id="3872024">cert</span><span class="op" id="3872028">.</span><span class="ident" id="3872029">Certificate</span><span class="op" id="3872040">)</span>&nbsp;<span class="op" id="3872042">==</span>&nbsp;<span class="num" id="3872045">0</span>&nbsp;<span class="op" id="3872047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872051">err</span>&nbsp;<span class="op" id="3872055">=</span>&nbsp;<span class="ident" id="3872057">errors</span><span class="op" id="3872063">.</span><span class="ident" id="3872064">New</span><span class="op" id="3872067">(</span><span class="string" id="3872068">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3872118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872130">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872134">var</span>&nbsp;<span class="ident" id="3872138">keyDERBlock</span>&nbsp;<span class="op" id="3872150">*</span><span class="ident" id="3872151">pem</span><span class="op" id="3872154">.</span><span class="ident" id="3872155">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872162">for</span>&nbsp;<span class="op" id="3872166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872170">keyDERBlock</span><span class="op" id="3872181">,</span>&nbsp;<span class="ident" id="3872183">keyPEMBlock</span>&nbsp;<span class="op" id="3872195">=</span>&nbsp;<span class="ident" id="3872197">pem</span><span class="op" id="3872200">.</span><span class="ident" id="3872201">Decode</span><span class="op" id="3872207">(</span><span class="ident" id="3872208">keyPEMBlock</span><span class="op" id="3872219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872223">if</span>&nbsp;<span class="ident" id="3872226">keyDERBlock</span>&nbsp;<span class="op" id="3872238">==</span>&nbsp;<span class="builtintype" id="3872241">nil</span>&nbsp;<span class="op" id="3872245">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872250">err</span>&nbsp;<span class="op" id="3872254">=</span>&nbsp;<span class="ident" id="3872256">errors</span><span class="op" id="3872262">.</span><span class="ident" id="3872263">New</span><span class="op" id="3872266">(</span><span class="string" id="3872267">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="3872309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872314">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872327">if</span>&nbsp;<span class="ident" id="3872330">keyDERBlock</span><span class="op" id="3872341">.</span><span class="ident" id="3872342">Type</span>&nbsp;<span class="op" id="3872347">==</span>&nbsp;<span class="string" id="3872350">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="3872364">||</span>&nbsp;<span class="ident" id="3872367">strings</span><span class="op" id="3872374">.</span><span class="ident" id="3872375">HasSuffix</span><span class="op" id="3872384">(</span><span class="ident" id="3872385">keyDERBlock</span><span class="op" id="3872396">.</span><span class="ident" id="3872397">Type</span><span class="op" id="3872401">,</span>&nbsp;<span class="string" id="3872403">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="3872417">)</span>&nbsp;<span class="op" id="3872419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872424">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872439">cert</span><span class="op" id="3872443">.</span><span class="ident" id="3872444">PrivateKey</span><span class="op" id="3872454">,</span>&nbsp;<span class="ident" id="3872456">err</span>&nbsp;<span class="op" id="3872460">=</span>&nbsp;<span class="ident" id="3872462">parsePrivateKey</span><span class="op" id="3872477">(</span><span class="ident" id="3872478">keyDERBlock</span><span class="op" id="3872489">.</span><span class="ident" id="3872490">Bytes</span><span class="op" id="3872495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872498">if</span>&nbsp;<span class="ident" id="3872501">err</span>&nbsp;<span class="op" id="3872505">!=</span>&nbsp;<span class="builtintype" id="3872508">nil</span>&nbsp;<span class="op" id="3872512">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872516">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3872528">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3872599">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872660">x509Cert</span><span class="op" id="3872668">,</span>&nbsp;<span class="ident" id="3872670">err</span>&nbsp;<span class="op" id="3872674">:=</span>&nbsp;<span class="ident" id="3872677">x509</span><span class="op" id="3872681">.</span><span class="ident" id="3872682">ParseCertificate</span><span class="op" id="3872698">(</span><span class="ident" id="3872699">cert</span><span class="op" id="3872703">.</span><span class="ident" id="3872704">Certificate</span><span class="op" id="3872715">[</span><span class="num" id="3872716">0</span><span class="op" id="3872717">]</span><span class="op" id="3872718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872721">if</span>&nbsp;<span class="ident" id="3872724">err</span>&nbsp;<span class="op" id="3872728">!=</span>&nbsp;<span class="builtintype" id="3872731">nil</span>&nbsp;<span class="op" id="3872735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872739">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872751">switch</span>&nbsp;<span class="ident" id="3872758">pub</span>&nbsp;<span class="op" id="3872762">:=</span>&nbsp;<span class="ident" id="3872765">x509Cert</span><span class="op" id="3872773">.</span><span class="ident" id="3872774">PublicKey</span><span class="op" id="3872783">.</span><span class="op" id="3872784">(</span><span class="keyword" id="3872785">type</span><span class="op" id="3872789">)</span>&nbsp;<span class="op" id="3872791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872794">case</span>&nbsp;<span class="op" id="3872799">*</span><span class="ident" id="3872800">rsa</span><span class="op" id="3872803">.</span><span class="ident" id="3872804">PublicKey</span><span class="op" id="3872813">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872817">priv</span><span class="op" id="3872821">,</span>&nbsp;<span class="ident" id="3872823">ok</span>&nbsp;<span class="op" id="3872826">:=</span>&nbsp;<span class="ident" id="3872829">cert</span><span class="op" id="3872833">.</span><span class="ident" id="3872834">PrivateKey</span><span class="op" id="3872844">.</span><span class="op" id="3872845">(</span><span class="op" id="3872846">*</span><span class="ident" id="3872847">rsa</span><span class="op" id="3872850">.</span><span class="ident" id="3872851">PrivateKey</span><span class="op" id="3872861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872865">if</span>&nbsp;<span class="op" id="3872868">!</span><span class="ident" id="3872869">ok</span>&nbsp;<span class="op" id="3872872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872877">err</span>&nbsp;<span class="op" id="3872881">=</span>&nbsp;<span class="ident" id="3872883">errors</span><span class="op" id="3872889">.</span><span class="ident" id="3872890">New</span><span class="op" id="3872893">(</span><span class="string" id="3872894">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3872955">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872960">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3872973">if</span>&nbsp;<span class="ident" id="3872976">pub</span><span class="op" id="3872979">.</span><span class="ident" id="3872980">N</span><span class="op" id="3872981">.</span><span class="ident" id="3872982">Cmp</span><span class="op" id="3872985">(</span><span class="ident" id="3872986">priv</span><span class="op" id="3872990">.</span><span class="ident" id="3872991">N</span><span class="op" id="3872992">)</span>&nbsp;<span class="op" id="3872994">!=</span>&nbsp;<span class="num" id="3872997">0</span>&nbsp;<span class="op" id="3872999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3873004">err</span>&nbsp;<span class="op" id="3873008">=</span>&nbsp;<span class="ident" id="3873010">errors</span><span class="op" id="3873016">.</span><span class="ident" id="3873017">New</span><span class="op" id="3873020">(</span><span class="string" id="3873021">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3873072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873077">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3873086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873089">case</span>&nbsp;<span class="op" id="3873094">*</span><span class="ident" id="3873095">ecdsa</span><span class="op" id="3873100">.</span><span class="ident" id="3873101">PublicKey</span><span class="op" id="3873110">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3873114">priv</span><span class="op" id="3873118">,</span>&nbsp;<span class="ident" id="3873120">ok</span>&nbsp;<span class="op" id="3873123">:=</span>&nbsp;<span class="ident" id="3873126">cert</span><span class="op" id="3873130">.</span><span class="ident" id="3873131">PrivateKey</span><span class="op" id="3873141">.</span><span class="op" id="3873142">(</span><span class="op" id="3873143">*</span><span class="ident" id="3873144">ecdsa</span><span class="op" id="3873149">.</span><span class="ident" id="3873150">PrivateKey</span><span class="op" id="3873160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873164">if</span>&nbsp;<span class="op" id="3873167">!</span><span class="ident" id="3873168">ok</span>&nbsp;<span class="op" id="3873171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3873176">err</span>&nbsp;<span class="op" id="3873180">=</span>&nbsp;<span class="ident" id="3873182">errors</span><span class="op" id="3873188">.</span><span class="ident" id="3873189">New</span><span class="op" id="3873192">(</span><span class="string" id="3873193">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="3873254">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873259">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3873269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873273">if</span>&nbsp;<span class="ident" id="3873276">pub</span><span class="op" id="3873279">.</span><span class="ident" id="3873280">X</span><span class="op" id="3873281">.</span><span class="ident" id="3873282">Cmp</span><span class="op" id="3873285">(</span><span class="ident" id="3873286">priv</span><span class="op" id="3873290">.</span><span class="ident" id="3873291">X</span><span class="op" id="3873292">)</span>&nbsp;<span class="op" id="3873294">!=</span>&nbsp;<span class="num" id="3873297">0</span>&nbsp;<span class="op" id="3873299">||</span>&nbsp;<span class="ident" id="3873302">pub</span><span class="op" id="3873305">.</span><span class="ident" id="3873306">Y</span><span class="op" id="3873307">.</span><span class="ident" id="3873308">Cmp</span><span class="op" id="3873311">(</span><span class="ident" id="3873312">priv</span><span class="op" id="3873316">.</span><span class="ident" id="3873317">Y</span><span class="op" id="3873318">)</span>&nbsp;<span class="op" id="3873320">!=</span>&nbsp;<span class="num" id="3873323">0</span>&nbsp;<span class="op" id="3873325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3873330">err</span>&nbsp;<span class="op" id="3873334">=</span>&nbsp;<span class="ident" id="3873336">errors</span><span class="op" id="3873342">.</span><span class="ident" id="3873343">New</span><span class="op" id="3873346">(</span><span class="string" id="3873347">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="3873398">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873403">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3873412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873415">default</span><span class="op" id="3873422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3873426">err</span>&nbsp;<span class="op" id="3873430">=</span>&nbsp;<span class="ident" id="3873432">errors</span><span class="op" id="3873438">.</span><span class="ident" id="3873439">New</span><span class="op" id="3873442">(</span><span class="string" id="3873443">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="3873485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873489">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3873497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873501">return</span><br>
<span class="lineno"></span><span class="op" id="3873508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="3873511">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="3873588">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3873666">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="3873745">func</span>&nbsp;<span class="ident" id="3873750">parsePrivateKey</span><span class="op" id="3873765">(</span><span class="ident" id="3873766">der</span>&nbsp;<span class="op" id="3873770">[</span><span class="op" id="3873771">]</span><span class="builtintype" id="3873772">byte</span><span class="op" id="3873776">)</span>&nbsp;<span class="op" id="3873778">(</span><span class="ident" id="3873779">crypto</span><span class="op" id="3873785">.</span><span class="ident" id="3873786">PrivateKey</span><span class="op" id="3873796">,</span>&nbsp;<span class="builtintype" id="3873798">error</span><span class="op" id="3873803">)</span>&nbsp;<span class="op" id="3873805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873808">if</span>&nbsp;<span class="ident" id="3873811">key</span><span class="op" id="3873814">,</span>&nbsp;<span class="ident" id="3873816">err</span>&nbsp;<span class="op" id="3873820">:=</span>&nbsp;<span class="ident" id="3873823">x509</span><span class="op" id="3873827">.</span><span class="ident" id="3873828">ParsePKCS1PrivateKey</span><span class="op" id="3873848">(</span><span class="ident" id="3873849">der</span><span class="op" id="3873852">)</span><span class="op" id="3873853">;</span>&nbsp;<span class="ident" id="3873855">err</span>&nbsp;<span class="op" id="3873859">==</span>&nbsp;<span class="builtintype" id="3873862">nil</span>&nbsp;<span class="op" id="3873866">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873870">return</span>&nbsp;<span class="ident" id="3873877">key</span><span class="op" id="3873880">,</span>&nbsp;<span class="builtintype" id="3873882">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3873887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873890">if</span>&nbsp;<span class="ident" id="3873893">key</span><span class="op" id="3873896">,</span>&nbsp;<span class="ident" id="3873898">err</span>&nbsp;<span class="op" id="3873902">:=</span>&nbsp;<span class="ident" id="3873905">x509</span><span class="op" id="3873909">.</span><span class="ident" id="3873910">ParsePKCS8PrivateKey</span><span class="op" id="3873930">(</span><span class="ident" id="3873931">der</span><span class="op" id="3873934">)</span><span class="op" id="3873935">;</span>&nbsp;<span class="ident" id="3873937">err</span>&nbsp;<span class="op" id="3873941">==</span>&nbsp;<span class="builtintype" id="3873944">nil</span>&nbsp;<span class="op" id="3873948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873952">switch</span>&nbsp;<span class="ident" id="3873959">key</span>&nbsp;<span class="op" id="3873963">:=</span>&nbsp;<span class="ident" id="3873966">key</span><span class="op" id="3873969">.</span><span class="op" id="3873970">(</span><span class="keyword" id="3873971">type</span><span class="op" id="3873975">)</span>&nbsp;<span class="op" id="3873977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3873981">case</span>&nbsp;<span class="op" id="3873986">*</span><span class="ident" id="3873987">rsa</span><span class="op" id="3873990">.</span><span class="ident" id="3873991">PrivateKey</span><span class="op" id="3874001">,</span>&nbsp;<span class="op" id="3874003">*</span><span class="ident" id="3874004">ecdsa</span><span class="op" id="3874009">.</span><span class="ident" id="3874010">PrivateKey</span><span class="op" id="3874020">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3874025">return</span>&nbsp;<span class="ident" id="3874032">key</span><span class="op" id="3874035">,</span>&nbsp;<span class="builtintype" id="3874037">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3874043">default</span><span class="op" id="3874050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3874055">return</span>&nbsp;<span class="builtintype" id="3874062">nil</span><span class="op" id="3874065">,</span>&nbsp;<span class="ident" id="3874067">errors</span><span class="op" id="3874073">.</span><span class="ident" id="3874074">New</span><span class="op" id="3874077">(</span><span class="string" id="3874078">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="3874141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3874145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3874148">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3874151">if</span>&nbsp;<span class="ident" id="3874154">key</span><span class="op" id="3874157">,</span>&nbsp;<span class="ident" id="3874159">err</span>&nbsp;<span class="op" id="3874163">:=</span>&nbsp;<span class="ident" id="3874166">x509</span><span class="op" id="3874170">.</span><span class="ident" id="3874171">ParseECPrivateKey</span><span class="op" id="3874188">(</span><span class="ident" id="3874189">der</span><span class="op" id="3874192">)</span><span class="op" id="3874193">;</span>&nbsp;<span class="ident" id="3874195">err</span>&nbsp;<span class="op" id="3874199">==</span>&nbsp;<span class="builtintype" id="3874202">nil</span>&nbsp;<span class="op" id="3874206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3874210">return</span>&nbsp;<span class="ident" id="3874217">key</span><span class="op" id="3874220">,</span>&nbsp;<span class="builtintype" id="3874222">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3874227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3874231">return</span>&nbsp;<span class="builtintype" id="3874238">nil</span><span class="op" id="3874241">,</span>&nbsp;<span class="ident" id="3874243">errors</span><span class="op" id="3874249">.</span><span class="ident" id="3874250">New</span><span class="op" id="3874253">(</span><span class="string" id="3874254">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="3874295">)</span><br>
<span class="lineno">275</span><span class="op" id="3874297">}</span>
</div>
</body>
</html>
