<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4995603">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4995658">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4995712">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4995763">package</span>&nbsp;<span class="ident" id="4995771">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4995776">import</span>&nbsp;<span class="op" id="4995783">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4995786">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4995795">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4995802">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4995814">&#34;sort&#34;</span><br>
<span class="lineno"></span><span class="op" id="4995821">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4995824">type</span>&nbsp;<span class="ident" id="4995829">byPos</span>&nbsp;<span class="op" id="4995835">[</span><span class="op" id="4995836">]</span><span class="op" id="4995837">*</span><span class="ident" id="4995838">CommentGroup</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4995852">func</span>&nbsp;<span class="op" id="4995857">(</span><span class="ident" id="4995858">a</span>&nbsp;<span class="ident" id="4995860">byPos</span><span class="op" id="4995865">)</span>&nbsp;<span class="ident" id="4995867">Len</span><span class="op" id="4995870">(</span><span class="op" id="4995871">)</span>&nbsp;<span class="builtintype" id="4995873">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4995887">{</span>&nbsp;<span class="keyword" id="4995889">return</span>&nbsp;<span class="builtinfunc" id="4995896">len</span><span class="op" id="4995899">(</span><span class="ident" id="4995900">a</span><span class="op" id="4995901">)</span>&nbsp;<span class="op" id="4995903">}</span><br>
<span class="lineno"></span><span class="keyword" id="4995905">func</span>&nbsp;<span class="op" id="4995910">(</span><span class="ident" id="4995911">a</span>&nbsp;<span class="ident" id="4995913">byPos</span><span class="op" id="4995918">)</span>&nbsp;<span class="ident" id="4995920">Less</span><span class="op" id="4995924">(</span><span class="ident" id="4995925">i</span><span class="op" id="4995926">,</span>&nbsp;<span class="ident" id="4995928">j</span>&nbsp;<span class="builtintype" id="4995930">int</span><span class="op" id="4995933">)</span>&nbsp;<span class="builtintype" id="4995935">bool</span>&nbsp;<span class="op" id="4995940">{</span>&nbsp;<span class="keyword" id="4995942">return</span>&nbsp;<span class="ident" id="4995949">a</span><span class="op" id="4995950">[</span><span class="ident" id="4995951">i</span><span class="op" id="4995952">]</span><span class="op" id="4995953">.</span><span class="ident" id="4995954">Pos</span><span class="op" id="4995957">(</span><span class="op" id="4995958">)</span>&nbsp;<span class="op" id="4995960">&lt;</span>&nbsp;<span class="ident" id="4995962">a</span><span class="op" id="4995963">[</span><span class="ident" id="4995964">j</span><span class="op" id="4995965">]</span><span class="op" id="4995966">.</span><span class="ident" id="4995967">Pos</span><span class="op" id="4995970">(</span><span class="op" id="4995971">)</span>&nbsp;<span class="op" id="4995973">}</span><br>
<span class="lineno"></span><span class="keyword" id="4995975">func</span>&nbsp;<span class="op" id="4995980">(</span><span class="ident" id="4995981">a</span>&nbsp;<span class="ident" id="4995983">byPos</span><span class="op" id="4995988">)</span>&nbsp;<span class="ident" id="4995990">Swap</span><span class="op" id="4995994">(</span><span class="ident" id="4995995">i</span><span class="op" id="4995996">,</span>&nbsp;<span class="ident" id="4995998">j</span>&nbsp;<span class="builtintype" id="4996000">int</span><span class="op" id="4996003">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4996010">{</span>&nbsp;<span class="ident" id="4996012">a</span><span class="op" id="4996013">[</span><span class="ident" id="4996014">i</span><span class="op" id="4996015">]</span><span class="op" id="4996016">,</span>&nbsp;<span class="ident" id="4996018">a</span><span class="op" id="4996019">[</span><span class="ident" id="4996020">j</span><span class="op" id="4996021">]</span>&nbsp;<span class="op" id="4996023">=</span>&nbsp;<span class="ident" id="4996025">a</span><span class="op" id="4996026">[</span><span class="ident" id="4996027">j</span><span class="op" id="4996028">]</span><span class="op" id="4996029">,</span>&nbsp;<span class="ident" id="4996031">a</span><span class="op" id="4996032">[</span><span class="ident" id="4996033">i</span><span class="op" id="4996034">]</span>&nbsp;<span class="op" id="4996036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4996039">//&nbsp;sortComments&nbsp;sorts&nbsp;the&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups&nbsp;in&nbsp;source&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="4996105">//</span><br>
<span class="lineno"></span><span class="keyword" id="4996108">func</span>&nbsp;<span class="ident" id="4996113">sortComments</span><span class="op" id="4996125">(</span><span class="ident" id="4996126">list</span>&nbsp;<span class="op" id="4996131">[</span><span class="op" id="4996132">]</span><span class="op" id="4996133">*</span><span class="ident" id="4996134">CommentGroup</span><span class="op" id="4996146">)</span>&nbsp;<span class="op" id="4996148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996151">//&nbsp;TODO(gri):&nbsp;Does&nbsp;it&nbsp;make&nbsp;sense&nbsp;to&nbsp;check&nbsp;for&nbsp;sorted-ness</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996210">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first&nbsp;(because&nbsp;we&nbsp;know&nbsp;that&nbsp;sorted-ness&nbsp;is</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996268">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;very&nbsp;likely)?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996297">if</span>&nbsp;<span class="ident" id="4996300">orderedList</span>&nbsp;<span class="op" id="4996312">:=</span>&nbsp;<span class="ident" id="4996315">byPos</span><span class="op" id="4996320">(</span><span class="ident" id="4996321">list</span><span class="op" id="4996325">)</span><span class="op" id="4996326">;</span>&nbsp;<span class="op" id="4996328">!</span><span class="ident" id="4996329">sort</span><span class="op" id="4996333">.</span><span class="ident" id="4996334">IsSorted</span><span class="op" id="4996342">(</span><span class="ident" id="4996343">orderedList</span><span class="op" id="4996354">)</span>&nbsp;<span class="op" id="4996356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996360">sort</span><span class="op" id="4996364">.</span><span class="ident" id="4996365">Sort</span><span class="op" id="4996369">(</span><span class="ident" id="4996370">orderedList</span><span class="op" id="4996381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996384">}</span><br>
<span class="lineno"></span><span class="op" id="4996386">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4996389">//&nbsp;A&nbsp;CommentMap&nbsp;maps&nbsp;an&nbsp;AST&nbsp;node&nbsp;to&nbsp;a&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups</span><br>
<span class="lineno"></span><span class="comment" id="4996450">//&nbsp;associated&nbsp;with&nbsp;it.&nbsp;See&nbsp;NewCommentMap&nbsp;for&nbsp;a&nbsp;description&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4996512">//&nbsp;the&nbsp;association.</span><br>
<span class="lineno"></span><span class="comment" id="4996532">//</span><br>
<span class="lineno">35</span><span class="keyword" id="4996535">type</span>&nbsp;<span class="ident" id="4996540">CommentMap</span>&nbsp;<span class="keyword" id="4996551">map</span><span class="op" id="4996554">[</span><span class="ident" id="4996555">Node</span><span class="op" id="4996559">]</span><span class="op" id="4996560">[</span><span class="op" id="4996561">]</span><span class="op" id="4996562">*</span><span class="ident" id="4996563">CommentGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996577">func</span>&nbsp;<span class="op" id="4996582">(</span><span class="ident" id="4996583">cmap</span>&nbsp;<span class="ident" id="4996588">CommentMap</span><span class="op" id="4996598">)</span>&nbsp;<span class="ident" id="4996600">addComment</span><span class="op" id="4996610">(</span><span class="ident" id="4996611">n</span>&nbsp;<span class="ident" id="4996613">Node</span><span class="op" id="4996617">,</span>&nbsp;<span class="ident" id="4996619">c</span>&nbsp;<span class="op" id="4996621">*</span><span class="ident" id="4996622">CommentGroup</span><span class="op" id="4996634">)</span>&nbsp;<span class="op" id="4996636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996639">list</span>&nbsp;<span class="op" id="4996644">:=</span>&nbsp;<span class="ident" id="4996647">cmap</span><span class="op" id="4996651">[</span><span class="ident" id="4996652">n</span><span class="op" id="4996653">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996656">if</span>&nbsp;<span class="builtinfunc" id="4996659">len</span><span class="op" id="4996662">(</span><span class="ident" id="4996663">list</span><span class="op" id="4996667">)</span>&nbsp;<span class="op" id="4996669">==</span>&nbsp;<span class="num" id="4996672">0</span>&nbsp;<span class="op" id="4996674">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996678">list</span>&nbsp;<span class="op" id="4996683">=</span>&nbsp;<span class="op" id="4996685">[</span><span class="op" id="4996686">]</span><span class="op" id="4996687">*</span><span class="ident" id="4996688">CommentGroup</span><span class="op" id="4996700">{</span><span class="ident" id="4996701">c</span><span class="op" id="4996702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996705">}</span>&nbsp;<span class="keyword" id="4996707">else</span>&nbsp;<span class="op" id="4996712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996716">list</span>&nbsp;<span class="op" id="4996721">=</span>&nbsp;<span class="builtinfunc" id="4996723">append</span><span class="op" id="4996729">(</span><span class="ident" id="4996730">list</span><span class="op" id="4996734">,</span>&nbsp;<span class="ident" id="4996736">c</span><span class="op" id="4996737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996743">cmap</span><span class="op" id="4996747">[</span><span class="ident" id="4996748">n</span><span class="op" id="4996749">]</span>&nbsp;<span class="op" id="4996751">=</span>&nbsp;<span class="ident" id="4996753">list</span><br>
<span class="lineno">45</span><span class="op" id="4996758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996761">type</span>&nbsp;<span class="ident" id="4996766">byInterval</span>&nbsp;<span class="op" id="4996777">[</span><span class="op" id="4996778">]</span><span class="ident" id="4996779">Node</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996785">func</span>&nbsp;<span class="op" id="4996790">(</span><span class="ident" id="4996791">a</span>&nbsp;<span class="ident" id="4996793">byInterval</span><span class="op" id="4996803">)</span>&nbsp;<span class="ident" id="4996805">Len</span><span class="op" id="4996808">(</span><span class="op" id="4996809">)</span>&nbsp;<span class="builtintype" id="4996811">int</span>&nbsp;<span class="op" id="4996815">{</span>&nbsp;<span class="keyword" id="4996817">return</span>&nbsp;<span class="builtinfunc" id="4996824">len</span><span class="op" id="4996827">(</span><span class="ident" id="4996828">a</span><span class="op" id="4996829">)</span>&nbsp;<span class="op" id="4996831">}</span><br>
<span class="lineno">50</span><span class="keyword" id="4996833">func</span>&nbsp;<span class="op" id="4996838">(</span><span class="ident" id="4996839">a</span>&nbsp;<span class="ident" id="4996841">byInterval</span><span class="op" id="4996851">)</span>&nbsp;<span class="ident" id="4996853">Less</span><span class="op" id="4996857">(</span><span class="ident" id="4996858">i</span><span class="op" id="4996859">,</span>&nbsp;<span class="ident" id="4996861">j</span>&nbsp;<span class="builtintype" id="4996863">int</span><span class="op" id="4996866">)</span>&nbsp;<span class="builtintype" id="4996868">bool</span>&nbsp;<span class="op" id="4996873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996876">pi</span><span class="op" id="4996878">,</span>&nbsp;<span class="ident" id="4996880">pj</span>&nbsp;<span class="op" id="4996883">:=</span>&nbsp;<span class="ident" id="4996886">a</span><span class="op" id="4996887">[</span><span class="ident" id="4996888">i</span><span class="op" id="4996889">]</span><span class="op" id="4996890">.</span><span class="ident" id="4996891">Pos</span><span class="op" id="4996894">(</span><span class="op" id="4996895">)</span><span class="op" id="4996896">,</span>&nbsp;<span class="ident" id="4996898">a</span><span class="op" id="4996899">[</span><span class="ident" id="4996900">j</span><span class="op" id="4996901">]</span><span class="op" id="4996902">.</span><span class="ident" id="4996903">Pos</span><span class="op" id="4996906">(</span><span class="op" id="4996907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996910">return</span>&nbsp;<span class="ident" id="4996917">pi</span>&nbsp;<span class="op" id="4996920">&lt;</span>&nbsp;<span class="ident" id="4996922">pj</span>&nbsp;<span class="op" id="4996925">||</span>&nbsp;<span class="ident" id="4996928">pi</span>&nbsp;<span class="op" id="4996931">==</span>&nbsp;<span class="ident" id="4996934">pj</span>&nbsp;<span class="op" id="4996937">&amp;&amp;</span>&nbsp;<span class="ident" id="4996940">a</span><span class="op" id="4996941">[</span><span class="ident" id="4996942">i</span><span class="op" id="4996943">]</span><span class="op" id="4996944">.</span><span class="ident" id="4996945">End</span><span class="op" id="4996948">(</span><span class="op" id="4996949">)</span>&nbsp;<span class="op" id="4996951">&gt;</span>&nbsp;<span class="ident" id="4996953">a</span><span class="op" id="4996954">[</span><span class="ident" id="4996955">j</span><span class="op" id="4996956">]</span><span class="op" id="4996957">.</span><span class="ident" id="4996958">End</span><span class="op" id="4996961">(</span><span class="op" id="4996962">)</span><br>
<span class="lineno"></span><span class="op" id="4996964">}</span><br>
<span class="lineno"></span><span class="keyword" id="4996966">func</span>&nbsp;<span class="op" id="4996971">(</span><span class="ident" id="4996972">a</span>&nbsp;<span class="ident" id="4996974">byInterval</span><span class="op" id="4996984">)</span>&nbsp;<span class="ident" id="4996986">Swap</span><span class="op" id="4996990">(</span><span class="ident" id="4996991">i</span><span class="op" id="4996992">,</span>&nbsp;<span class="ident" id="4996994">j</span>&nbsp;<span class="builtintype" id="4996996">int</span><span class="op" id="4996999">)</span>&nbsp;<span class="op" id="4997001">{</span>&nbsp;<span class="ident" id="4997003">a</span><span class="op" id="4997004">[</span><span class="ident" id="4997005">i</span><span class="op" id="4997006">]</span><span class="op" id="4997007">,</span>&nbsp;<span class="ident" id="4997009">a</span><span class="op" id="4997010">[</span><span class="ident" id="4997011">j</span><span class="op" id="4997012">]</span>&nbsp;<span class="op" id="4997014">=</span>&nbsp;<span class="ident" id="4997016">a</span><span class="op" id="4997017">[</span><span class="ident" id="4997018">j</span><span class="op" id="4997019">]</span><span class="op" id="4997020">,</span>&nbsp;<span class="ident" id="4997022">a</span><span class="op" id="4997023">[</span><span class="ident" id="4997024">i</span><span class="op" id="4997025">]</span>&nbsp;<span class="op" id="4997027">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="4997030">//&nbsp;nodeList&nbsp;returns&nbsp;the&nbsp;list&nbsp;of&nbsp;nodes&nbsp;of&nbsp;the&nbsp;AST&nbsp;n&nbsp;in&nbsp;source&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="4997098">//</span><br>
<span class="lineno"></span><span class="keyword" id="4997101">func</span>&nbsp;<span class="ident" id="4997106">nodeList</span><span class="op" id="4997114">(</span><span class="ident" id="4997115">n</span>&nbsp;<span class="ident" id="4997117">Node</span><span class="op" id="4997121">)</span>&nbsp;<span class="op" id="4997123">[</span><span class="op" id="4997124">]</span><span class="ident" id="4997125">Node</span>&nbsp;<span class="op" id="4997130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997133">var</span>&nbsp;<span class="ident" id="4997137">list</span>&nbsp;<span class="op" id="4997142">[</span><span class="op" id="4997143">]</span><span class="ident" id="4997144">Node</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997150">Inspect</span><span class="op" id="4997157">(</span><span class="ident" id="4997158">n</span><span class="op" id="4997159">,</span>&nbsp;<span class="keyword" id="4997161">func</span><span class="op" id="4997165">(</span><span class="ident" id="4997166">n</span>&nbsp;<span class="ident" id="4997168">Node</span><span class="op" id="4997172">)</span>&nbsp;<span class="builtintype" id="4997174">bool</span>&nbsp;<span class="op" id="4997179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997183">//&nbsp;don&#39;t&nbsp;collect&nbsp;comments</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997211">switch</span>&nbsp;<span class="ident" id="4997218">n</span><span class="op" id="4997219">.</span><span class="op" id="4997220">(</span><span class="keyword" id="4997221">type</span><span class="op" id="4997225">)</span>&nbsp;<span class="op" id="4997227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997231">case</span>&nbsp;<span class="ident" id="4997236">nil</span><span class="op" id="4997239">,</span>&nbsp;<span class="op" id="4997241">*</span><span class="ident" id="4997242">CommentGroup</span><span class="op" id="4997254">,</span>&nbsp;<span class="op" id="4997256">*</span><span class="ident" id="4997257">Comment</span><span class="op" id="4997264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997269">return</span>&nbsp;<span class="ident" id="4997276">false</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997288">list</span>&nbsp;<span class="op" id="4997293">=</span>&nbsp;<span class="builtinfunc" id="4997295">append</span><span class="op" id="4997301">(</span><span class="ident" id="4997302">list</span><span class="op" id="4997306">,</span>&nbsp;<span class="ident" id="4997308">n</span><span class="op" id="4997309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997313">return</span>&nbsp;<span class="ident" id="4997320">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997326">}</span><span class="op" id="4997327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997330">//&nbsp;Note:&nbsp;The&nbsp;current&nbsp;implementation&nbsp;assumes&nbsp;that&nbsp;Inspect&nbsp;traverses&nbsp;the</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997402">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AST&nbsp;in&nbsp;depth-first&nbsp;and&nbsp;thus&nbsp;_source_&nbsp;order.&nbsp;If&nbsp;AST&nbsp;traversal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997473">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;does&nbsp;not&nbsp;follow&nbsp;source&nbsp;order,&nbsp;the&nbsp;sorting&nbsp;call&nbsp;below&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997544">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997564">//&nbsp;sort.Sort(byInterval(list))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997596">return</span>&nbsp;<span class="ident" id="4997603">list</span><br>
<span class="lineno">75</span><span class="op" id="4997608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4997611">//&nbsp;A&nbsp;commentListReader&nbsp;helps&nbsp;iterating&nbsp;through&nbsp;a&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups.</span><br>
<span class="lineno"></span><span class="comment" id="4997684">//</span><br>
<span class="lineno"></span><span class="keyword" id="4997687">type</span>&nbsp;<span class="ident" id="4997692">commentListReader</span>&nbsp;<span class="keyword" id="4997710">struct</span>&nbsp;<span class="op" id="4997717">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997720">fset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997729">*</span><span class="ident" id="4997730">token</span><span class="op" id="4997735">.</span><span class="ident" id="4997736">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997745">list</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997754">[</span><span class="op" id="4997755">]</span><span class="op" id="4997756">*</span><span class="ident" id="4997757">CommentGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997771">index</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4997780">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997785">comment</span>&nbsp;&nbsp;<span class="op" id="4997794">*</span><span class="ident" id="4997795">CommentGroup</span>&nbsp;&nbsp;<span class="comment" id="4997809">//&nbsp;comment&nbsp;group&nbsp;at&nbsp;current&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997844">pos</span><span class="op" id="4997847">,</span>&nbsp;<span class="ident" id="4997849">end</span>&nbsp;<span class="ident" id="4997853">token</span><span class="op" id="4997858">.</span><span class="ident" id="4997859">Position</span>&nbsp;<span class="comment" id="4997868">//&nbsp;source&nbsp;interval&nbsp;of&nbsp;comment&nbsp;group&nbsp;at&nbsp;current&nbsp;index</span><br>
<span class="lineno">85</span><span class="op" id="4997921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4997924">func</span>&nbsp;<span class="op" id="4997929">(</span><span class="ident" id="4997930">r</span>&nbsp;<span class="op" id="4997932">*</span><span class="ident" id="4997933">commentListReader</span><span class="op" id="4997950">)</span>&nbsp;<span class="ident" id="4997952">eol</span><span class="op" id="4997955">(</span><span class="op" id="4997956">)</span>&nbsp;<span class="builtintype" id="4997958">bool</span>&nbsp;<span class="op" id="4997963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997966">return</span>&nbsp;<span class="ident" id="4997973">r</span><span class="op" id="4997974">.</span><span class="ident" id="4997975">index</span>&nbsp;<span class="op" id="4997981">&gt;=</span>&nbsp;<span class="builtinfunc" id="4997984">len</span><span class="op" id="4997987">(</span><span class="ident" id="4997988">r</span><span class="op" id="4997989">.</span><span class="ident" id="4997990">list</span><span class="op" id="4997994">)</span><br>
<span class="lineno"></span><span class="op" id="4997996">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="4997999">func</span>&nbsp;<span class="op" id="4998004">(</span><span class="ident" id="4998005">r</span>&nbsp;<span class="op" id="4998007">*</span><span class="ident" id="4998008">commentListReader</span><span class="op" id="4998025">)</span>&nbsp;<span class="ident" id="4998027">next</span><span class="op" id="4998031">(</span><span class="op" id="4998032">)</span>&nbsp;<span class="op" id="4998034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998037">if</span>&nbsp;<span class="op" id="4998040">!</span><span class="ident" id="4998041">r</span><span class="op" id="4998042">.</span><span class="ident" id="4998043">eol</span><span class="op" id="4998046">(</span><span class="op" id="4998047">)</span>&nbsp;<span class="op" id="4998049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998053">r</span><span class="op" id="4998054">.</span><span class="ident" id="4998055">comment</span>&nbsp;<span class="op" id="4998063">=</span>&nbsp;<span class="ident" id="4998065">r</span><span class="op" id="4998066">.</span><span class="ident" id="4998067">list</span><span class="op" id="4998071">[</span><span class="ident" id="4998072">r</span><span class="op" id="4998073">.</span><span class="ident" id="4998074">index</span><span class="op" id="4998079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998083">r</span><span class="op" id="4998084">.</span><span class="ident" id="4998085">pos</span>&nbsp;<span class="op" id="4998089">=</span>&nbsp;<span class="ident" id="4998091">r</span><span class="op" id="4998092">.</span><span class="ident" id="4998093">fset</span><span class="op" id="4998097">.</span><span class="ident" id="4998098">Position</span><span class="op" id="4998106">(</span><span class="ident" id="4998107">r</span><span class="op" id="4998108">.</span><span class="ident" id="4998109">comment</span><span class="op" id="4998116">.</span><span class="ident" id="4998117">Pos</span><span class="op" id="4998120">(</span><span class="op" id="4998121">)</span><span class="op" id="4998122">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998126">r</span><span class="op" id="4998127">.</span><span class="ident" id="4998128">end</span>&nbsp;<span class="op" id="4998132">=</span>&nbsp;<span class="ident" id="4998134">r</span><span class="op" id="4998135">.</span><span class="ident" id="4998136">fset</span><span class="op" id="4998140">.</span><span class="ident" id="4998141">Position</span><span class="op" id="4998149">(</span><span class="ident" id="4998150">r</span><span class="op" id="4998151">.</span><span class="ident" id="4998152">comment</span><span class="op" id="4998159">.</span><span class="ident" id="4998160">End</span><span class="op" id="4998163">(</span><span class="op" id="4998164">)</span><span class="op" id="4998165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998169">r</span><span class="op" id="4998170">.</span><span class="ident" id="4998171">index</span><span class="op" id="4998176">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998180">}</span><br>
<span class="lineno"></span><span class="op" id="4998182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4998185">//&nbsp;A&nbsp;nodeStack&nbsp;keeps&nbsp;track&nbsp;of&nbsp;nested&nbsp;nodes.</span><br>
<span class="lineno"></span><span class="comment" id="4998229">//&nbsp;A&nbsp;node&nbsp;lower&nbsp;on&nbsp;the&nbsp;stack&nbsp;lexically&nbsp;contains&nbsp;the&nbsp;nodes&nbsp;higher&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="4998308">//</span><br>
<span class="lineno"></span><span class="keyword" id="4998311">type</span>&nbsp;<span class="ident" id="4998316">nodeStack</span>&nbsp;<span class="op" id="4998326">[</span><span class="op" id="4998327">]</span><span class="ident" id="4998328">Node</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4998334">//&nbsp;push&nbsp;pops&nbsp;all&nbsp;nodes&nbsp;that&nbsp;appear&nbsp;lexically&nbsp;before&nbsp;n</span><br>
<span class="lineno"></span><span class="comment" id="4998388">//&nbsp;and&nbsp;then&nbsp;pushes&nbsp;n&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="4998423">//</span><br>
<span class="lineno"></span><span class="keyword" id="4998426">func</span>&nbsp;<span class="op" id="4998431">(</span><span class="ident" id="4998432">s</span>&nbsp;<span class="op" id="4998434">*</span><span class="ident" id="4998435">nodeStack</span><span class="op" id="4998444">)</span>&nbsp;<span class="ident" id="4998446">push</span><span class="op" id="4998450">(</span><span class="ident" id="4998451">n</span>&nbsp;<span class="ident" id="4998453">Node</span><span class="op" id="4998457">)</span>&nbsp;<span class="op" id="4998459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998462">s</span><span class="op" id="4998463">.</span><span class="ident" id="4998464">pop</span><span class="op" id="4998467">(</span><span class="ident" id="4998468">n</span><span class="op" id="4998469">.</span><span class="ident" id="4998470">Pos</span><span class="op" id="4998473">(</span><span class="op" id="4998474">)</span><span class="op" id="4998475">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998478">*</span><span class="ident" id="4998479">s</span>&nbsp;<span class="op" id="4998481">=</span>&nbsp;<span class="builtinfunc" id="4998483">append</span><span class="op" id="4998489">(</span><span class="op" id="4998490">(</span><span class="op" id="4998491">*</span><span class="ident" id="4998492">s</span><span class="op" id="4998493">)</span><span class="op" id="4998494">,</span>&nbsp;<span class="ident" id="4998496">n</span><span class="op" id="4998497">)</span><br>
<span class="lineno"></span><span class="op" id="4998499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4998502">//&nbsp;pop&nbsp;pops&nbsp;all&nbsp;nodes&nbsp;that&nbsp;appear&nbsp;lexically&nbsp;before&nbsp;pos</span><br>
<span class="lineno"></span><span class="comment" id="4998557">//&nbsp;(i.e.,&nbsp;whose&nbsp;lexical&nbsp;extent&nbsp;has&nbsp;ended&nbsp;before&nbsp;or&nbsp;at&nbsp;pos).</span><br>
<span class="lineno">115</span><span class="comment" id="4998617">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;last&nbsp;node&nbsp;popped.</span><br>
<span class="lineno"></span><span class="comment" id="4998653">//</span><br>
<span class="lineno"></span><span class="keyword" id="4998656">func</span>&nbsp;<span class="op" id="4998661">(</span><span class="ident" id="4998662">s</span>&nbsp;<span class="op" id="4998664">*</span><span class="ident" id="4998665">nodeStack</span><span class="op" id="4998674">)</span>&nbsp;<span class="ident" id="4998676">pop</span><span class="op" id="4998679">(</span><span class="ident" id="4998680">pos</span>&nbsp;<span class="ident" id="4998684">token</span><span class="op" id="4998689">.</span><span class="ident" id="4998690">Pos</span><span class="op" id="4998693">)</span>&nbsp;<span class="op" id="4998695">(</span><span class="ident" id="4998696">top</span>&nbsp;<span class="ident" id="4998700">Node</span><span class="op" id="4998704">)</span>&nbsp;<span class="op" id="4998706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998709">i</span>&nbsp;<span class="op" id="4998711">:=</span>&nbsp;<span class="builtinfunc" id="4998714">len</span><span class="op" id="4998717">(</span><span class="op" id="4998718">*</span><span class="ident" id="4998719">s</span><span class="op" id="4998720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998723">for</span>&nbsp;<span class="ident" id="4998727">i</span>&nbsp;<span class="op" id="4998729">&gt;</span>&nbsp;<span class="num" id="4998731">0</span>&nbsp;<span class="op" id="4998733">&amp;&amp;</span>&nbsp;<span class="op" id="4998736">(</span><span class="op" id="4998737">*</span><span class="ident" id="4998738">s</span><span class="op" id="4998739">)</span><span class="op" id="4998740">[</span><span class="ident" id="4998741">i</span><span class="op" id="4998742">-</span><span class="num" id="4998743">1</span><span class="op" id="4998744">]</span><span class="op" id="4998745">.</span><span class="ident" id="4998746">End</span><span class="op" id="4998749">(</span><span class="op" id="4998750">)</span>&nbsp;<span class="op" id="4998752">&lt;=</span>&nbsp;<span class="ident" id="4998755">pos</span>&nbsp;<span class="op" id="4998759">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998763">top</span>&nbsp;<span class="op" id="4998767">=</span>&nbsp;<span class="op" id="4998769">(</span><span class="op" id="4998770">*</span><span class="ident" id="4998771">s</span><span class="op" id="4998772">)</span><span class="op" id="4998773">[</span><span class="ident" id="4998774">i</span><span class="op" id="4998775">-</span><span class="num" id="4998776">1</span><span class="op" id="4998777">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998781">i</span><span class="op" id="4998782">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998789">*</span><span class="ident" id="4998790">s</span>&nbsp;<span class="op" id="4998792">=</span>&nbsp;<span class="op" id="4998794">(</span><span class="op" id="4998795">*</span><span class="ident" id="4998796">s</span><span class="op" id="4998797">)</span><span class="op" id="4998798">[</span><span class="num" id="4998799">0</span><span class="op" id="4998800">:</span><span class="ident" id="4998801">i</span><span class="op" id="4998802">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998805">return</span>&nbsp;<span class="ident" id="4998812">top</span><br>
<span class="lineno">125</span><span class="op" id="4998816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4998819">//&nbsp;NewCommentMap&nbsp;creates&nbsp;a&nbsp;new&nbsp;comment&nbsp;map&nbsp;by&nbsp;associating&nbsp;comment&nbsp;groups</span><br>
<span class="lineno"></span><span class="comment" id="4998892">//&nbsp;of&nbsp;the&nbsp;comments&nbsp;list&nbsp;with&nbsp;the&nbsp;nodes&nbsp;of&nbsp;the&nbsp;AST&nbsp;specified&nbsp;by&nbsp;node.</span><br>
<span class="lineno"></span><span class="comment" id="4998961">//</span><br>
<span class="lineno">130</span><span class="comment" id="4998964">//&nbsp;A&nbsp;comment&nbsp;group&nbsp;g&nbsp;is&nbsp;associated&nbsp;with&nbsp;a&nbsp;node&nbsp;n&nbsp;if:</span><br>
<span class="lineno"></span><span class="comment" id="4999017">//</span><br>
<span class="lineno"></span><span class="comment" id="4999020">//&nbsp;&nbsp;&nbsp;-&nbsp;g&nbsp;starts&nbsp;on&nbsp;the&nbsp;same&nbsp;line&nbsp;as&nbsp;n&nbsp;ends</span><br>
<span class="lineno"></span><span class="comment" id="4999063">//&nbsp;&nbsp;&nbsp;-&nbsp;g&nbsp;starts&nbsp;on&nbsp;the&nbsp;line&nbsp;immediately&nbsp;following&nbsp;n,&nbsp;and&nbsp;there&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4999129">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;least&nbsp;one&nbsp;empty&nbsp;line&nbsp;after&nbsp;g&nbsp;and&nbsp;before&nbsp;the&nbsp;next&nbsp;node</span><br>
<span class="lineno">135</span><span class="comment" id="4999193">//&nbsp;&nbsp;&nbsp;-&nbsp;g&nbsp;starts&nbsp;before&nbsp;n&nbsp;and&nbsp;is&nbsp;not&nbsp;associated&nbsp;to&nbsp;the&nbsp;node&nbsp;before&nbsp;n</span><br>
<span class="lineno"></span><span class="comment" id="4999261">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;via&nbsp;the&nbsp;previous&nbsp;rules</span><br>
<span class="lineno"></span><span class="comment" id="4999291">//</span><br>
<span class="lineno"></span><span class="comment" id="4999294">//&nbsp;NewCommentMap&nbsp;tries&nbsp;to&nbsp;associate&nbsp;a&nbsp;comment&nbsp;group&nbsp;to&nbsp;the&nbsp;&#34;largest&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4999363">//&nbsp;node&nbsp;possible:&nbsp;For&nbsp;instance,&nbsp;if&nbsp;the&nbsp;comment&nbsp;is&nbsp;a&nbsp;line&nbsp;comment</span><br>
<span class="lineno">140</span><span class="comment" id="4999428">//&nbsp;trailing&nbsp;an&nbsp;assignment,&nbsp;the&nbsp;comment&nbsp;is&nbsp;associated&nbsp;with&nbsp;the&nbsp;entire</span><br>
<span class="lineno"></span><span class="comment" id="4999497">//&nbsp;assignment&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;last&nbsp;operand&nbsp;in&nbsp;the&nbsp;assignment.</span><br>
<span class="lineno"></span><span class="comment" id="4999564">//</span><br>
<span class="lineno"></span><span class="keyword" id="4999567">func</span>&nbsp;<span class="ident" id="4999572">NewCommentMap</span><span class="op" id="4999585">(</span><span class="ident" id="4999586">fset</span>&nbsp;<span class="op" id="4999591">*</span><span class="ident" id="4999592">token</span><span class="op" id="4999597">.</span><span class="ident" id="4999598">FileSet</span><span class="op" id="4999605">,</span>&nbsp;<span class="ident" id="4999607">node</span>&nbsp;<span class="ident" id="4999612">Node</span><span class="op" id="4999616">,</span>&nbsp;<span class="ident" id="4999618">comments</span>&nbsp;<span class="op" id="4999627">[</span><span class="op" id="4999628">]</span><span class="op" id="4999629">*</span><span class="ident" id="4999630">CommentGroup</span><span class="op" id="4999642">)</span>&nbsp;<span class="ident" id="4999644">CommentMap</span>&nbsp;<span class="op" id="4999655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999658">if</span>&nbsp;<span class="builtinfunc" id="4999661">len</span><span class="op" id="4999664">(</span><span class="ident" id="4999665">comments</span><span class="op" id="4999673">)</span>&nbsp;<span class="op" id="4999675">==</span>&nbsp;<span class="num" id="4999678">0</span>&nbsp;<span class="op" id="4999680">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999684">return</span>&nbsp;<span class="ident" id="4999691">nil</span>&nbsp;<span class="comment" id="4999695">//&nbsp;no&nbsp;comments&nbsp;to&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999722">cmap</span>&nbsp;<span class="op" id="4999727">:=</span>&nbsp;<span class="builtinfunc" id="4999730">make</span><span class="op" id="4999734">(</span><span class="ident" id="4999735">CommentMap</span><span class="op" id="4999745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999749">//&nbsp;set&nbsp;up&nbsp;comment&nbsp;reader&nbsp;r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999777">tmp</span>&nbsp;<span class="op" id="4999781">:=</span>&nbsp;<span class="builtinfunc" id="4999784">make</span><span class="op" id="4999788">(</span><span class="op" id="4999789">[</span><span class="op" id="4999790">]</span><span class="op" id="4999791">*</span><span class="ident" id="4999792">CommentGroup</span><span class="op" id="4999804">,</span>&nbsp;<span class="builtinfunc" id="4999806">len</span><span class="op" id="4999809">(</span><span class="ident" id="4999810">comments</span><span class="op" id="4999818">)</span><span class="op" id="4999819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4999822">copy</span><span class="op" id="4999826">(</span><span class="ident" id="4999827">tmp</span><span class="op" id="4999830">,</span>&nbsp;<span class="ident" id="4999832">comments</span><span class="op" id="4999840">)</span>&nbsp;<span class="comment" id="4999842">//&nbsp;don&#39;t&nbsp;change&nbsp;incoming&nbsp;comments</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999877">sortComments</span><span class="op" id="4999889">(</span><span class="ident" id="4999890">tmp</span><span class="op" id="4999893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999896">r</span>&nbsp;<span class="op" id="4999898">:=</span>&nbsp;<span class="ident" id="4999901">commentListReader</span><span class="op" id="4999918">{</span><span class="ident" id="4999919">fset</span><span class="op" id="4999923">:</span>&nbsp;<span class="ident" id="4999925">fset</span><span class="op" id="4999929">,</span>&nbsp;<span class="ident" id="4999931">list</span><span class="op" id="4999935">:</span>&nbsp;<span class="ident" id="4999937">tmp</span><span class="op" id="4999940">}</span>&nbsp;<span class="comment" id="4999942">//&nbsp;!r.eol()&nbsp;because&nbsp;len(comments)&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999981">r</span><span class="op" id="4999982">.</span><span class="ident" id="4999983">next</span><span class="op" id="4999987">(</span><span class="op" id="4999988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999992">//&nbsp;create&nbsp;node&nbsp;list&nbsp;in&nbsp;lexical&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000030">nodes</span>&nbsp;<span class="op" id="5000036">:=</span>&nbsp;<span class="ident" id="5000039">nodeList</span><span class="op" id="5000047">(</span><span class="ident" id="5000048">node</span><span class="op" id="5000052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000055">nodes</span>&nbsp;<span class="op" id="5000061">=</span>&nbsp;<span class="builtinfunc" id="5000063">append</span><span class="op" id="5000069">(</span><span class="ident" id="5000070">nodes</span><span class="op" id="5000075">,</span>&nbsp;<span class="ident" id="5000077">nil</span><span class="op" id="5000080">)</span>&nbsp;<span class="comment" id="5000082">//&nbsp;append&nbsp;sentinel</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000103">//&nbsp;set&nbsp;up&nbsp;iteration&nbsp;variables</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000134">var</span>&nbsp;<span class="op" id="5000138">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000142">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5000148">Node</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5000163">//&nbsp;previous&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000182">pend</span>&nbsp;&nbsp;<span class="ident" id="5000188">token</span><span class="op" id="5000193">.</span><span class="ident" id="5000194">Position</span>&nbsp;<span class="comment" id="5000203">//&nbsp;end&nbsp;of&nbsp;p</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000217">pg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5000223">Node</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5000238">//&nbsp;previous&nbsp;node&nbsp;group&nbsp;(enclosing&nbsp;nodes&nbsp;of&nbsp;&#34;importance&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000297">pgend</span>&nbsp;<span class="ident" id="5000303">token</span><span class="op" id="5000308">.</span><span class="ident" id="5000309">Position</span>&nbsp;<span class="comment" id="5000318">//&nbsp;end&nbsp;of&nbsp;pg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000333">stack</span>&nbsp;<span class="ident" id="5000339">nodeStack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5000354">//&nbsp;stack&nbsp;of&nbsp;node&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000383">for</span>&nbsp;<span class="ident" id="5000387">_</span><span class="op" id="5000388">,</span>&nbsp;<span class="ident" id="5000390">q</span>&nbsp;<span class="op" id="5000392">:=</span>&nbsp;<span class="keyword" id="5000395">range</span>&nbsp;<span class="ident" id="5000401">nodes</span>&nbsp;<span class="op" id="5000407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000411">var</span>&nbsp;<span class="ident" id="5000415">qpos</span>&nbsp;<span class="ident" id="5000420">token</span><span class="op" id="5000425">.</span><span class="ident" id="5000426">Position</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000437">if</span>&nbsp;<span class="ident" id="5000440">q</span>&nbsp;<span class="op" id="5000442">!=</span>&nbsp;<span class="ident" id="5000445">nil</span>&nbsp;<span class="op" id="5000449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000454">qpos</span>&nbsp;<span class="op" id="5000459">=</span>&nbsp;<span class="ident" id="5000461">fset</span><span class="op" id="5000465">.</span><span class="ident" id="5000466">Position</span><span class="op" id="5000474">(</span><span class="ident" id="5000475">q</span><span class="op" id="5000476">.</span><span class="ident" id="5000477">Pos</span><span class="op" id="5000480">(</span><span class="op" id="5000481">)</span><span class="op" id="5000482">)</span>&nbsp;<span class="comment" id="5000484">//&nbsp;current&nbsp;node&nbsp;position</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000511">}</span>&nbsp;<span class="keyword" id="5000513">else</span>&nbsp;<span class="op" id="5000518">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000523">//&nbsp;set&nbsp;fake&nbsp;sentinel&nbsp;position&nbsp;to&nbsp;infinity&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000576">//&nbsp;all&nbsp;comments&nbsp;get&nbsp;processed&nbsp;before&nbsp;the&nbsp;sentinel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000629">const</span>&nbsp;<span class="ident" id="5000635">infinity</span>&nbsp;<span class="op" id="5000644">=</span>&nbsp;<span class="num" id="5000646">1</span>&nbsp;<span class="op" id="5000648">&lt;&lt;</span>&nbsp;<span class="num" id="5000651">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000657">qpos</span><span class="op" id="5000661">.</span><span class="ident" id="5000662">Offset</span>&nbsp;<span class="op" id="5000669">=</span>&nbsp;<span class="ident" id="5000671">infinity</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000683">qpos</span><span class="op" id="5000687">.</span><span class="ident" id="5000688">Line</span>&nbsp;<span class="op" id="5000693">=</span>&nbsp;<span class="ident" id="5000695">infinity</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000711">//&nbsp;process&nbsp;comments&nbsp;before&nbsp;current&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000753">for</span>&nbsp;<span class="ident" id="5000757">r</span><span class="op" id="5000758">.</span><span class="ident" id="5000759">end</span><span class="op" id="5000762">.</span><span class="ident" id="5000763">Offset</span>&nbsp;<span class="op" id="5000770">&lt;=</span>&nbsp;<span class="ident" id="5000773">qpos</span><span class="op" id="5000777">.</span><span class="ident" id="5000778">Offset</span>&nbsp;<span class="op" id="5000785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000790">//&nbsp;determine&nbsp;recent&nbsp;node&nbsp;group</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000824">if</span>&nbsp;<span class="ident" id="5000827">top</span>&nbsp;<span class="op" id="5000831">:=</span>&nbsp;<span class="ident" id="5000834">stack</span><span class="op" id="5000839">.</span><span class="ident" id="5000840">pop</span><span class="op" id="5000843">(</span><span class="ident" id="5000844">r</span><span class="op" id="5000845">.</span><span class="ident" id="5000846">comment</span><span class="op" id="5000853">.</span><span class="ident" id="5000854">Pos</span><span class="op" id="5000857">(</span><span class="op" id="5000858">)</span><span class="op" id="5000859">)</span><span class="op" id="5000860">;</span>&nbsp;<span class="ident" id="5000862">top</span>&nbsp;<span class="op" id="5000866">!=</span>&nbsp;<span class="ident" id="5000869">nil</span>&nbsp;<span class="op" id="5000873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000879">pg</span>&nbsp;<span class="op" id="5000882">=</span>&nbsp;<span class="ident" id="5000884">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000892">pgend</span>&nbsp;<span class="op" id="5000898">=</span>&nbsp;<span class="ident" id="5000900">fset</span><span class="op" id="5000904">.</span><span class="ident" id="5000905">Position</span><span class="op" id="5000913">(</span><span class="ident" id="5000914">pg</span><span class="op" id="5000916">.</span><span class="ident" id="5000917">End</span><span class="op" id="5000920">(</span><span class="op" id="5000921">)</span><span class="op" id="5000922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000932">//&nbsp;Try&nbsp;to&nbsp;associate&nbsp;a&nbsp;comment&nbsp;first&nbsp;with&nbsp;a&nbsp;node&nbsp;group</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000989">//&nbsp;(i.e.,&nbsp;a&nbsp;node&nbsp;of&nbsp;&#34;importance&#34;&nbsp;such&nbsp;as&nbsp;a&nbsp;declaration);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001049">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;try&nbsp;to&nbsp;associate&nbsp;it&nbsp;with&nbsp;the&nbsp;most&nbsp;recent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001111">//&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001123">//&nbsp;TODO(gri)&nbsp;try&nbsp;to&nbsp;simplify&nbsp;the&nbsp;logic&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001171">var</span>&nbsp;<span class="ident" id="5001175">assoc</span>&nbsp;<span class="ident" id="5001181">Node</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001189">switch</span>&nbsp;<span class="op" id="5001196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001201">case</span>&nbsp;<span class="ident" id="5001206">pg</span>&nbsp;<span class="op" id="5001209">!=</span>&nbsp;<span class="ident" id="5001212">nil</span>&nbsp;<span class="op" id="5001216">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001223">(</span><span class="ident" id="5001224">pgend</span><span class="op" id="5001229">.</span><span class="ident" id="5001230">Line</span>&nbsp;<span class="op" id="5001235">==</span>&nbsp;<span class="ident" id="5001238">r</span><span class="op" id="5001239">.</span><span class="ident" id="5001240">pos</span><span class="op" id="5001243">.</span><span class="ident" id="5001244">Line</span>&nbsp;<span class="op" id="5001249">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001257">pgend</span><span class="op" id="5001262">.</span><span class="ident" id="5001263">Line</span><span class="op" id="5001267">+</span><span class="num" id="5001268">1</span>&nbsp;<span class="op" id="5001270">==</span>&nbsp;<span class="ident" id="5001273">r</span><span class="op" id="5001274">.</span><span class="ident" id="5001275">pos</span><span class="op" id="5001278">.</span><span class="ident" id="5001279">Line</span>&nbsp;<span class="op" id="5001284">&amp;&amp;</span>&nbsp;<span class="ident" id="5001287">r</span><span class="op" id="5001288">.</span><span class="ident" id="5001289">end</span><span class="op" id="5001292">.</span><span class="ident" id="5001293">Line</span><span class="op" id="5001297">+</span><span class="num" id="5001298">1</span>&nbsp;<span class="op" id="5001300">&lt;</span>&nbsp;<span class="ident" id="5001302">qpos</span><span class="op" id="5001306">.</span><span class="ident" id="5001307">Line</span><span class="op" id="5001311">)</span><span class="op" id="5001312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001318">//&nbsp;1)&nbsp;comment&nbsp;starts&nbsp;on&nbsp;same&nbsp;line&nbsp;as&nbsp;previous&nbsp;node&nbsp;group&nbsp;ends,&nbsp;or</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001388">//&nbsp;2)&nbsp;comment&nbsp;starts&nbsp;on&nbsp;the&nbsp;line&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001447">//&nbsp;&nbsp;&nbsp;&nbsp;previous&nbsp;node&nbsp;group&nbsp;and&nbsp;there&nbsp;is&nbsp;an&nbsp;empty&nbsp;line&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001511">//&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;current&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001538">//&nbsp;=&gt;&nbsp;associate&nbsp;comment&nbsp;with&nbsp;previous&nbsp;node&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001591">assoc</span>&nbsp;<span class="op" id="5001597">=</span>&nbsp;<span class="ident" id="5001599">pg</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001605">case</span>&nbsp;<span class="ident" id="5001610">p</span>&nbsp;<span class="op" id="5001612">!=</span>&nbsp;<span class="ident" id="5001615">nil</span>&nbsp;<span class="op" id="5001619">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001626">(</span><span class="ident" id="5001627">pend</span><span class="op" id="5001631">.</span><span class="ident" id="5001632">Line</span>&nbsp;<span class="op" id="5001637">==</span>&nbsp;<span class="ident" id="5001640">r</span><span class="op" id="5001641">.</span><span class="ident" id="5001642">pos</span><span class="op" id="5001645">.</span><span class="ident" id="5001646">Line</span>&nbsp;<span class="op" id="5001651">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001659">pend</span><span class="op" id="5001663">.</span><span class="ident" id="5001664">Line</span><span class="op" id="5001668">+</span><span class="num" id="5001669">1</span>&nbsp;<span class="op" id="5001671">==</span>&nbsp;<span class="ident" id="5001674">r</span><span class="op" id="5001675">.</span><span class="ident" id="5001676">pos</span><span class="op" id="5001679">.</span><span class="ident" id="5001680">Line</span>&nbsp;<span class="op" id="5001685">&amp;&amp;</span>&nbsp;<span class="ident" id="5001688">r</span><span class="op" id="5001689">.</span><span class="ident" id="5001690">end</span><span class="op" id="5001693">.</span><span class="ident" id="5001694">Line</span><span class="op" id="5001698">+</span><span class="num" id="5001699">1</span>&nbsp;<span class="op" id="5001701">&lt;</span>&nbsp;<span class="ident" id="5001703">qpos</span><span class="op" id="5001707">.</span><span class="ident" id="5001708">Line</span>&nbsp;<span class="op" id="5001713">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001721">q</span>&nbsp;<span class="op" id="5001723">==</span>&nbsp;<span class="ident" id="5001726">nil</span><span class="op" id="5001729">)</span><span class="op" id="5001730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001736">//&nbsp;same&nbsp;rules&nbsp;apply&nbsp;as&nbsp;above&nbsp;for&nbsp;p&nbsp;rather&nbsp;than&nbsp;pg,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001791">//&nbsp;but&nbsp;also&nbsp;associate&nbsp;with&nbsp;p&nbsp;if&nbsp;we&nbsp;are&nbsp;at&nbsp;the&nbsp;end&nbsp;(q&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001856">assoc</span>&nbsp;<span class="op" id="5001862">=</span>&nbsp;<span class="ident" id="5001864">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001869">default</span><span class="op" id="5001876">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001882">//&nbsp;otherwise,&nbsp;associate&nbsp;comment&nbsp;with&nbsp;current&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001936">if</span>&nbsp;<span class="ident" id="5001939">q</span>&nbsp;<span class="op" id="5001941">==</span>&nbsp;<span class="ident" id="5001944">nil</span>&nbsp;<span class="op" id="5001948">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001955">//&nbsp;we&nbsp;can&nbsp;only&nbsp;reach&nbsp;here&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002004">//&nbsp;which&nbsp;would&nbsp;imply&nbsp;that&nbsp;there&nbsp;were&nbsp;no&nbsp;nodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5002055">panic</span><span class="op" id="5002060">(</span><span class="string" id="5002061">&#34;internal&nbsp;error:&nbsp;no&nbsp;comments&nbsp;should&nbsp;be&nbsp;associated&nbsp;with&nbsp;sentinel&#34;</span><span class="op" id="5002125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002137">assoc</span>&nbsp;<span class="op" id="5002143">=</span>&nbsp;<span class="ident" id="5002145">q</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002155">cmap</span><span class="op" id="5002159">.</span><span class="ident" id="5002160">addComment</span><span class="op" id="5002170">(</span><span class="ident" id="5002171">assoc</span><span class="op" id="5002176">,</span>&nbsp;<span class="ident" id="5002178">r</span><span class="op" id="5002179">.</span><span class="ident" id="5002180">comment</span><span class="op" id="5002187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002192">if</span>&nbsp;<span class="ident" id="5002195">r</span><span class="op" id="5002196">.</span><span class="ident" id="5002197">eol</span><span class="op" id="5002200">(</span><span class="op" id="5002201">)</span>&nbsp;<span class="op" id="5002203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002209">return</span>&nbsp;<span class="ident" id="5002216">cmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002224">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002229">r</span><span class="op" id="5002230">.</span><span class="ident" id="5002231">next</span><span class="op" id="5002235">(</span><span class="op" id="5002236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002245">//&nbsp;update&nbsp;previous&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002271">p</span>&nbsp;<span class="op" id="5002273">=</span>&nbsp;<span class="ident" id="5002275">q</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002279">pend</span>&nbsp;<span class="op" id="5002284">=</span>&nbsp;<span class="ident" id="5002286">fset</span><span class="op" id="5002290">.</span><span class="ident" id="5002291">Position</span><span class="op" id="5002299">(</span><span class="ident" id="5002300">p</span><span class="op" id="5002301">.</span><span class="ident" id="5002302">End</span><span class="op" id="5002305">(</span><span class="op" id="5002306">)</span><span class="op" id="5002307">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002312">//&nbsp;update&nbsp;previous&nbsp;node&nbsp;group&nbsp;if&nbsp;we&nbsp;see&nbsp;an&nbsp;&#34;important&#34;&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002374">switch</span>&nbsp;<span class="ident" id="5002381">q</span><span class="op" id="5002382">.</span><span class="op" id="5002383">(</span><span class="keyword" id="5002384">type</span><span class="op" id="5002388">)</span>&nbsp;<span class="op" id="5002390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002394">case</span>&nbsp;<span class="op" id="5002399">*</span><span class="ident" id="5002400">File</span><span class="op" id="5002404">,</span>&nbsp;<span class="op" id="5002406">*</span><span class="ident" id="5002407">Field</span><span class="op" id="5002412">,</span>&nbsp;<span class="ident" id="5002414">Decl</span><span class="op" id="5002418">,</span>&nbsp;<span class="ident" id="5002420">Spec</span><span class="op" id="5002424">,</span>&nbsp;<span class="ident" id="5002426">Stmt</span><span class="op" id="5002430">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002435">stack</span><span class="op" id="5002440">.</span><span class="ident" id="5002441">push</span><span class="op" id="5002445">(</span><span class="ident" id="5002446">q</span><span class="op" id="5002447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002458">return</span>&nbsp;<span class="ident" id="5002465">cmap</span><br>
<span class="lineno">240</span><span class="op" id="5002470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5002473">//&nbsp;Update&nbsp;replaces&nbsp;an&nbsp;old&nbsp;node&nbsp;in&nbsp;the&nbsp;comment&nbsp;map&nbsp;with&nbsp;the&nbsp;new&nbsp;node</span><br>
<span class="lineno"></span><span class="comment" id="5002541">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;node.&nbsp;Comments&nbsp;that&nbsp;were&nbsp;associated&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5002609">//&nbsp;old&nbsp;node&nbsp;are&nbsp;associated&nbsp;with&nbsp;the&nbsp;new&nbsp;node.</span><br>
<span class="lineno">245</span><span class="comment" id="5002655">//</span><br>
<span class="lineno"></span><span class="keyword" id="5002658">func</span>&nbsp;<span class="op" id="5002663">(</span><span class="ident" id="5002664">cmap</span>&nbsp;<span class="ident" id="5002669">CommentMap</span><span class="op" id="5002679">)</span>&nbsp;<span class="ident" id="5002681">Update</span><span class="op" id="5002687">(</span><span class="ident" id="5002688">old</span><span class="op" id="5002691">,</span>&nbsp;<span class="builtinfunc" id="5002693">new</span>&nbsp;<span class="ident" id="5002697">Node</span><span class="op" id="5002701">)</span>&nbsp;<span class="ident" id="5002703">Node</span>&nbsp;<span class="op" id="5002708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002711">if</span>&nbsp;<span class="ident" id="5002714">list</span>&nbsp;<span class="op" id="5002719">:=</span>&nbsp;<span class="ident" id="5002722">cmap</span><span class="op" id="5002726">[</span><span class="ident" id="5002727">old</span><span class="op" id="5002730">]</span><span class="op" id="5002731">;</span>&nbsp;<span class="builtinfunc" id="5002733">len</span><span class="op" id="5002736">(</span><span class="ident" id="5002737">list</span><span class="op" id="5002741">)</span>&nbsp;<span class="op" id="5002743">&gt;</span>&nbsp;<span class="num" id="5002745">0</span>&nbsp;<span class="op" id="5002747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5002751">delete</span><span class="op" id="5002757">(</span><span class="ident" id="5002758">cmap</span><span class="op" id="5002762">,</span>&nbsp;<span class="ident" id="5002764">old</span><span class="op" id="5002767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002771">cmap</span><span class="op" id="5002775">[</span><span class="builtinfunc" id="5002776">new</span><span class="op" id="5002779">]</span>&nbsp;<span class="op" id="5002781">=</span>&nbsp;<span class="builtinfunc" id="5002783">append</span><span class="op" id="5002789">(</span><span class="ident" id="5002790">cmap</span><span class="op" id="5002794">[</span><span class="builtinfunc" id="5002795">new</span><span class="op" id="5002798">]</span><span class="op" id="5002799">,</span>&nbsp;<span class="ident" id="5002801">list</span><span class="op" id="5002805">...</span><span class="op" id="5002808">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002814">return</span>&nbsp;<span class="builtinfunc" id="5002821">new</span><br>
<span class="lineno"></span><span class="op" id="5002825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5002828">//&nbsp;Filter&nbsp;returns&nbsp;a&nbsp;new&nbsp;comment&nbsp;map&nbsp;consisting&nbsp;of&nbsp;only&nbsp;those</span><br>
<span class="lineno">255</span><span class="comment" id="5002889">//&nbsp;entries&nbsp;of&nbsp;cmap&nbsp;for&nbsp;which&nbsp;a&nbsp;corresponding&nbsp;node&nbsp;exists&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5002949">//&nbsp;the&nbsp;AST&nbsp;specified&nbsp;by&nbsp;node.</span><br>
<span class="lineno"></span><span class="comment" id="5002979">//</span><br>
<span class="lineno"></span><span class="keyword" id="5002982">func</span>&nbsp;<span class="op" id="5002987">(</span><span class="ident" id="5002988">cmap</span>&nbsp;<span class="ident" id="5002993">CommentMap</span><span class="op" id="5003003">)</span>&nbsp;<span class="ident" id="5003005">Filter</span><span class="op" id="5003011">(</span><span class="ident" id="5003012">node</span>&nbsp;<span class="ident" id="5003017">Node</span><span class="op" id="5003021">)</span>&nbsp;<span class="ident" id="5003023">CommentMap</span>&nbsp;<span class="op" id="5003034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003037">umap</span>&nbsp;<span class="op" id="5003042">:=</span>&nbsp;<span class="builtinfunc" id="5003045">make</span><span class="op" id="5003049">(</span><span class="ident" id="5003050">CommentMap</span><span class="op" id="5003060">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003063">Inspect</span><span class="op" id="5003070">(</span><span class="ident" id="5003071">node</span><span class="op" id="5003075">,</span>&nbsp;<span class="keyword" id="5003077">func</span><span class="op" id="5003081">(</span><span class="ident" id="5003082">n</span>&nbsp;<span class="ident" id="5003084">Node</span><span class="op" id="5003088">)</span>&nbsp;<span class="builtintype" id="5003090">bool</span>&nbsp;<span class="op" id="5003095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003099">if</span>&nbsp;<span class="ident" id="5003102">g</span>&nbsp;<span class="op" id="5003104">:=</span>&nbsp;<span class="ident" id="5003107">cmap</span><span class="op" id="5003111">[</span><span class="ident" id="5003112">n</span><span class="op" id="5003113">]</span><span class="op" id="5003114">;</span>&nbsp;<span class="builtinfunc" id="5003116">len</span><span class="op" id="5003119">(</span><span class="ident" id="5003120">g</span><span class="op" id="5003121">)</span>&nbsp;<span class="op" id="5003123">&gt;</span>&nbsp;<span class="num" id="5003125">0</span>&nbsp;<span class="op" id="5003127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003132">umap</span><span class="op" id="5003136">[</span><span class="ident" id="5003137">n</span><span class="op" id="5003138">]</span>&nbsp;<span class="op" id="5003140">=</span>&nbsp;<span class="ident" id="5003142">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003150">return</span>&nbsp;<span class="ident" id="5003157">true</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003163">}</span><span class="op" id="5003164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003167">return</span>&nbsp;<span class="ident" id="5003174">umap</span><br>
<span class="lineno"></span><span class="op" id="5003179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5003182">//&nbsp;Comments&nbsp;returns&nbsp;the&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups&nbsp;in&nbsp;the&nbsp;comment&nbsp;map.</span><br>
<span class="lineno">270</span><span class="comment" id="5003249">//&nbsp;The&nbsp;result&nbsp;is&nbsp;sorted&nbsp;is&nbsp;source&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5003290">//</span><br>
<span class="lineno"></span><span class="keyword" id="5003293">func</span>&nbsp;<span class="op" id="5003298">(</span><span class="ident" id="5003299">cmap</span>&nbsp;<span class="ident" id="5003304">CommentMap</span><span class="op" id="5003314">)</span>&nbsp;<span class="ident" id="5003316">Comments</span><span class="op" id="5003324">(</span><span class="op" id="5003325">)</span>&nbsp;<span class="op" id="5003327">[</span><span class="op" id="5003328">]</span><span class="op" id="5003329">*</span><span class="ident" id="5003330">CommentGroup</span>&nbsp;<span class="op" id="5003343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003346">list</span>&nbsp;<span class="op" id="5003351">:=</span>&nbsp;<span class="builtinfunc" id="5003354">make</span><span class="op" id="5003358">(</span><span class="op" id="5003359">[</span><span class="op" id="5003360">]</span><span class="op" id="5003361">*</span><span class="ident" id="5003362">CommentGroup</span><span class="op" id="5003374">,</span>&nbsp;<span class="num" id="5003376">0</span><span class="op" id="5003377">,</span>&nbsp;<span class="builtinfunc" id="5003379">len</span><span class="op" id="5003382">(</span><span class="ident" id="5003383">cmap</span><span class="op" id="5003387">)</span><span class="op" id="5003388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003391">for</span>&nbsp;<span class="ident" id="5003395">_</span><span class="op" id="5003396">,</span>&nbsp;<span class="ident" id="5003398">e</span>&nbsp;<span class="op" id="5003400">:=</span>&nbsp;<span class="keyword" id="5003403">range</span>&nbsp;<span class="ident" id="5003409">cmap</span>&nbsp;<span class="op" id="5003414">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003418">list</span>&nbsp;<span class="op" id="5003423">=</span>&nbsp;<span class="builtinfunc" id="5003425">append</span><span class="op" id="5003431">(</span><span class="ident" id="5003432">list</span><span class="op" id="5003436">,</span>&nbsp;<span class="ident" id="5003438">e</span><span class="op" id="5003439">...</span><span class="op" id="5003442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003448">sortComments</span><span class="op" id="5003460">(</span><span class="ident" id="5003461">list</span><span class="op" id="5003465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003468">return</span>&nbsp;<span class="ident" id="5003475">list</span><br>
<span class="lineno"></span><span class="op" id="5003480">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="keyword" id="5003483">func</span>&nbsp;<span class="ident" id="5003488">summary</span><span class="op" id="5003495">(</span><span class="ident" id="5003496">list</span>&nbsp;<span class="op" id="5003501">[</span><span class="op" id="5003502">]</span><span class="op" id="5003503">*</span><span class="ident" id="5003504">CommentGroup</span><span class="op" id="5003516">)</span>&nbsp;<span class="builtintype" id="5003518">string</span>&nbsp;<span class="op" id="5003525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003528">const</span>&nbsp;<span class="ident" id="5003534">maxLen</span>&nbsp;<span class="op" id="5003541">=</span>&nbsp;<span class="num" id="5003543">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003547">var</span>&nbsp;<span class="ident" id="5003551">buf</span>&nbsp;<span class="ident" id="5003555">bytes</span><span class="op" id="5003560">.</span><span class="ident" id="5003561">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003570">//&nbsp;collect&nbsp;comments&nbsp;text</span><br>
<span class="lineno"></span><span class="ident" id="5003595">loop</span><span class="op" id="5003599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003602">for</span>&nbsp;<span class="ident" id="5003606">_</span><span class="op" id="5003607">,</span>&nbsp;<span class="ident" id="5003609">group</span>&nbsp;<span class="op" id="5003615">:=</span>&nbsp;<span class="keyword" id="5003618">range</span>&nbsp;<span class="ident" id="5003624">list</span>&nbsp;<span class="op" id="5003629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003633">//&nbsp;Note:&nbsp;CommentGroup.Text()&nbsp;does&nbsp;too&nbsp;much&nbsp;work&nbsp;for&nbsp;what&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003695">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;need&nbsp;and&nbsp;would&nbsp;only&nbsp;replace&nbsp;this&nbsp;innermost&nbsp;loop.</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003755">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Just&nbsp;do&nbsp;it&nbsp;explicitly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003789">for</span>&nbsp;<span class="ident" id="5003793">_</span><span class="op" id="5003794">,</span>&nbsp;<span class="ident" id="5003796">comment</span>&nbsp;<span class="op" id="5003804">:=</span>&nbsp;<span class="keyword" id="5003807">range</span>&nbsp;<span class="ident" id="5003813">group</span><span class="op" id="5003818">.</span><span class="ident" id="5003819">List</span>&nbsp;<span class="op" id="5003824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003829">if</span>&nbsp;<span class="ident" id="5003832">buf</span><span class="op" id="5003835">.</span><span class="ident" id="5003836">Len</span><span class="op" id="5003839">(</span><span class="op" id="5003840">)</span>&nbsp;<span class="op" id="5003842">&gt;=</span>&nbsp;<span class="ident" id="5003845">maxLen</span>&nbsp;<span class="op" id="5003852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003858">break</span>&nbsp;<span class="ident" id="5003864">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003872">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003877">buf</span><span class="op" id="5003880">.</span><span class="ident" id="5003881">WriteString</span><span class="op" id="5003892">(</span><span class="ident" id="5003893">comment</span><span class="op" id="5003900">.</span><span class="ident" id="5003901">Text</span><span class="op" id="5003905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003916">//&nbsp;truncate&nbsp;if&nbsp;too&nbsp;long</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003941">if</span>&nbsp;<span class="ident" id="5003944">buf</span><span class="op" id="5003947">.</span><span class="ident" id="5003948">Len</span><span class="op" id="5003951">(</span><span class="op" id="5003952">)</span>&nbsp;<span class="op" id="5003954">&gt;</span>&nbsp;<span class="ident" id="5003956">maxLen</span>&nbsp;<span class="op" id="5003963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003967">buf</span><span class="op" id="5003970">.</span><span class="ident" id="5003971">Truncate</span><span class="op" id="5003979">(</span><span class="ident" id="5003980">maxLen</span>&nbsp;<span class="op" id="5003987">-</span>&nbsp;<span class="num" id="5003989">3</span><span class="op" id="5003990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003994">buf</span><span class="op" id="5003997">.</span><span class="ident" id="5003998">WriteString</span><span class="op" id="5004009">(</span><span class="string" id="5004010">&#34;...&#34;</span><span class="op" id="5004015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004022">//&nbsp;replace&nbsp;any&nbsp;invisibles&nbsp;with&nbsp;blanks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004061">bytes</span>&nbsp;<span class="op" id="5004067">:=</span>&nbsp;<span class="ident" id="5004070">buf</span><span class="op" id="5004073">.</span><span class="ident" id="5004074">Bytes</span><span class="op" id="5004079">(</span><span class="op" id="5004080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004083">for</span>&nbsp;<span class="ident" id="5004087">i</span><span class="op" id="5004088">,</span>&nbsp;<span class="ident" id="5004090">b</span>&nbsp;<span class="op" id="5004092">:=</span>&nbsp;<span class="keyword" id="5004095">range</span>&nbsp;<span class="ident" id="5004101">bytes</span>&nbsp;<span class="op" id="5004107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004111">switch</span>&nbsp;<span class="ident" id="5004118">b</span>&nbsp;<span class="op" id="5004120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004124">case</span>&nbsp;<span class="string" id="5004129">&#39;\t&#39;</span><span class="op" id="5004133">,</span>&nbsp;<span class="string" id="5004135">&#39;\n&#39;</span><span class="op" id="5004139">,</span>&nbsp;<span class="string" id="5004141">&#39;\r&#39;</span><span class="op" id="5004145">:</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004150">bytes</span><span class="op" id="5004155">[</span><span class="ident" id="5004156">i</span><span class="op" id="5004157">]</span>&nbsp;<span class="op" id="5004159">=</span>&nbsp;<span class="string" id="5004161">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004174">return</span>&nbsp;<span class="builtintype" id="5004181">string</span><span class="op" id="5004187">(</span><span class="ident" id="5004188">bytes</span><span class="op" id="5004193">)</span><br>
<span class="lineno">315</span><span class="op" id="5004195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5004198">func</span>&nbsp;<span class="op" id="5004203">(</span><span class="ident" id="5004204">cmap</span>&nbsp;<span class="ident" id="5004209">CommentMap</span><span class="op" id="5004219">)</span>&nbsp;<span class="ident" id="5004221">String</span><span class="op" id="5004227">(</span><span class="op" id="5004228">)</span>&nbsp;<span class="builtintype" id="5004230">string</span>&nbsp;<span class="op" id="5004237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004240">var</span>&nbsp;<span class="ident" id="5004244">buf</span>&nbsp;<span class="ident" id="5004248">bytes</span><span class="op" id="5004253">.</span><span class="ident" id="5004254">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004262">fmt</span><span class="op" id="5004265">.</span><span class="ident" id="5004266">Fprintln</span><span class="op" id="5004274">(</span><span class="op" id="5004275">&amp;</span><span class="ident" id="5004276">buf</span><span class="op" id="5004279">,</span>&nbsp;<span class="string" id="5004281">&#34;CommentMap&nbsp;{&#34;</span><span class="op" id="5004295">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004298">for</span>&nbsp;<span class="ident" id="5004302">node</span><span class="op" id="5004306">,</span>&nbsp;<span class="ident" id="5004308">comment</span>&nbsp;<span class="op" id="5004316">:=</span>&nbsp;<span class="keyword" id="5004319">range</span>&nbsp;<span class="ident" id="5004325">cmap</span>&nbsp;<span class="op" id="5004330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004334">//&nbsp;print&nbsp;name&nbsp;of&nbsp;identifiers;&nbsp;print&nbsp;node&nbsp;type&nbsp;for&nbsp;other&nbsp;nodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004398">var</span>&nbsp;<span class="ident" id="5004402">s</span>&nbsp;<span class="builtintype" id="5004404">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004413">if</span>&nbsp;<span class="ident" id="5004416">ident</span><span class="op" id="5004421">,</span>&nbsp;<span class="ident" id="5004423">ok</span>&nbsp;<span class="op" id="5004426">:=</span>&nbsp;<span class="ident" id="5004429">node</span><span class="op" id="5004433">.</span><span class="op" id="5004434">(</span><span class="op" id="5004435">*</span><span class="ident" id="5004436">Ident</span><span class="op" id="5004441">)</span><span class="op" id="5004442">;</span>&nbsp;<span class="ident" id="5004444">ok</span>&nbsp;<span class="op" id="5004447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004452">s</span>&nbsp;<span class="op" id="5004454">=</span>&nbsp;<span class="ident" id="5004456">ident</span><span class="op" id="5004461">.</span><span class="ident" id="5004462">Name</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004469">}</span>&nbsp;<span class="keyword" id="5004471">else</span>&nbsp;<span class="op" id="5004476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004481">s</span>&nbsp;<span class="op" id="5004483">=</span>&nbsp;<span class="ident" id="5004485">fmt</span><span class="op" id="5004488">.</span><span class="ident" id="5004489">Sprintf</span><span class="op" id="5004496">(</span><span class="string" id="5004497">&#34;%T&#34;</span><span class="op" id="5004501">,</span>&nbsp;<span class="ident" id="5004503">node</span><span class="op" id="5004507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004515">fmt</span><span class="op" id="5004518">.</span><span class="ident" id="5004519">Fprintf</span><span class="op" id="5004526">(</span><span class="op" id="5004527">&amp;</span><span class="ident" id="5004528">buf</span><span class="op" id="5004531">,</span>&nbsp;<span class="string" id="5004533">&#34;\t%p&nbsp;&nbsp;%20s:&nbsp;&nbsp;%s\n&#34;</span><span class="op" id="5004552">,</span>&nbsp;<span class="ident" id="5004554">node</span><span class="op" id="5004558">,</span>&nbsp;<span class="ident" id="5004560">s</span><span class="op" id="5004561">,</span>&nbsp;<span class="ident" id="5004563">summary</span><span class="op" id="5004570">(</span><span class="ident" id="5004571">comment</span><span class="op" id="5004578">)</span><span class="op" id="5004579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004582">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004585">fmt</span><span class="op" id="5004588">.</span><span class="ident" id="5004589">Fprintln</span><span class="op" id="5004597">(</span><span class="op" id="5004598">&amp;</span><span class="ident" id="5004599">buf</span><span class="op" id="5004602">,</span>&nbsp;<span class="string" id="5004604">&#34;}&#34;</span><span class="op" id="5004607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004610">return</span>&nbsp;<span class="ident" id="5004617">buf</span><span class="op" id="5004620">.</span><span class="ident" id="5004621">String</span><span class="op" id="5004627">(</span><span class="op" id="5004628">)</span><br>
<span class="lineno"></span><span class="op" id="5004630">}</span>
</div>
</body>
</html>
