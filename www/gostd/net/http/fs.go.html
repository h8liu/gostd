<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5035441">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5035496">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5035550">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5035601">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5035638">package</span>&nbsp;<span class="ident" id="5035646">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5035652">import</span>&nbsp;<span class="op" id="5035659">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035662">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035672">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035679">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035685">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035693">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035711">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035728">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035739">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035745">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035753">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035770">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035781">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5035792">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5035799">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5035802">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5035878">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="5035906">//</span><br>
<span class="lineno"></span><span class="comment" id="5035909">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5035987">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="5036067">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="5036122">//</span><br>
<span class="lineno"></span><span class="comment" id="5036125">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5036160">type</span>&nbsp;<span class="ident" id="5036165">Dir</span>&nbsp;<span class="builtintype" id="5036169">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5036177">func</span>&nbsp;<span class="op" id="5036182">(</span><span class="ident" id="5036183">d</span>&nbsp;<span class="ident" id="5036185">Dir</span><span class="op" id="5036188">)</span>&nbsp;<span class="ident" id="5036190">Open</span><span class="op" id="5036194">(</span><span class="ident" id="5036195">name</span>&nbsp;<span class="builtintype" id="5036200">string</span><span class="op" id="5036206">)</span>&nbsp;<span class="op" id="5036208">(</span><span class="ident" id="5036209">File</span><span class="op" id="5036213">,</span>&nbsp;<span class="builtintype" id="5036215">error</span><span class="op" id="5036220">)</span>&nbsp;<span class="op" id="5036222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036225">if</span>&nbsp;<span class="ident" id="5036228">filepath</span><span class="op" id="5036236">.</span><span class="ident" id="5036237">Separator</span>&nbsp;<span class="op" id="5036247">!=</span>&nbsp;<span class="string" id="5036250">&#39;/&#39;</span>&nbsp;<span class="op" id="5036254">&amp;&amp;</span>&nbsp;<span class="ident" id="5036257">strings</span><span class="op" id="5036264">.</span><span class="ident" id="5036265">IndexRune</span><span class="op" id="5036274">(</span><span class="ident" id="5036275">name</span><span class="op" id="5036279">,</span>&nbsp;<span class="ident" id="5036281">filepath</span><span class="op" id="5036289">.</span><span class="ident" id="5036290">Separator</span><span class="op" id="5036299">)</span>&nbsp;<span class="op" id="5036301">&gt;=</span>&nbsp;<span class="num" id="5036304">0</span>&nbsp;<span class="op" id="5036306">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036311">strings</span><span class="op" id="5036318">.</span><span class="ident" id="5036319">Contains</span><span class="op" id="5036327">(</span><span class="ident" id="5036328">name</span><span class="op" id="5036332">,</span>&nbsp;<span class="string" id="5036334">&#34;\x00&#34;</span><span class="op" id="5036340">)</span>&nbsp;<span class="op" id="5036342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036346">return</span>&nbsp;<span class="ident" id="5036353">nil</span><span class="op" id="5036356">,</span>&nbsp;<span class="ident" id="5036358">errors</span><span class="op" id="5036364">.</span><span class="ident" id="5036365">New</span><span class="op" id="5036368">(</span><span class="string" id="5036369">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="5036407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036410">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036413">dir</span>&nbsp;<span class="op" id="5036417">:=</span>&nbsp;<span class="builtintype" id="5036420">string</span><span class="op" id="5036426">(</span><span class="ident" id="5036427">d</span><span class="op" id="5036428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036431">if</span>&nbsp;<span class="ident" id="5036434">dir</span>&nbsp;<span class="op" id="5036438">==</span>&nbsp;<span class="string" id="5036441">&#34;&#34;</span>&nbsp;<span class="op" id="5036444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036448">dir</span>&nbsp;<span class="op" id="5036452">=</span>&nbsp;<span class="string" id="5036454">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036462">f</span><span class="op" id="5036463">,</span>&nbsp;<span class="ident" id="5036465">err</span>&nbsp;<span class="op" id="5036469">:=</span>&nbsp;<span class="ident" id="5036472">os</span><span class="op" id="5036474">.</span><span class="ident" id="5036475">Open</span><span class="op" id="5036479">(</span><span class="ident" id="5036480">filepath</span><span class="op" id="5036488">.</span><span class="ident" id="5036489">Join</span><span class="op" id="5036493">(</span><span class="ident" id="5036494">dir</span><span class="op" id="5036497">,</span>&nbsp;<span class="ident" id="5036499">filepath</span><span class="op" id="5036507">.</span><span class="ident" id="5036508">FromSlash</span><span class="op" id="5036517">(</span><span class="ident" id="5036518">path</span><span class="op" id="5036522">.</span><span class="ident" id="5036523">Clean</span><span class="op" id="5036528">(</span><span class="string" id="5036529">&#34;/&#34;</span><span class="op" id="5036532">+</span><span class="ident" id="5036533">name</span><span class="op" id="5036537">)</span><span class="op" id="5036538">)</span><span class="op" id="5036539">)</span><span class="op" id="5036540">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036543">if</span>&nbsp;<span class="ident" id="5036546">err</span>&nbsp;<span class="op" id="5036550">!=</span>&nbsp;<span class="ident" id="5036553">nil</span>&nbsp;<span class="op" id="5036557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036561">return</span>&nbsp;<span class="ident" id="5036568">nil</span><span class="op" id="5036571">,</span>&nbsp;<span class="ident" id="5036573">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036581">return</span>&nbsp;<span class="ident" id="5036588">f</span><span class="op" id="5036589">,</span>&nbsp;<span class="ident" id="5036591">nil</span><br>
<span class="lineno"></span><span class="op" id="5036595">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="5036598">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5036664">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="5036732">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="5036795">type</span>&nbsp;<span class="ident" id="5036800">FileSystem</span>&nbsp;<span class="keyword" id="5036811">interface</span>&nbsp;<span class="op" id="5036821">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036824">Open</span><span class="op" id="5036828">(</span><span class="ident" id="5036829">name</span>&nbsp;<span class="builtintype" id="5036834">string</span><span class="op" id="5036840">)</span>&nbsp;<span class="op" id="5036842">(</span><span class="ident" id="5036843">File</span><span class="op" id="5036847">,</span>&nbsp;<span class="builtintype" id="5036849">error</span><span class="op" id="5036854">)</span><br>
<span class="lineno"></span><span class="op" id="5036856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5036859">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5036922">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="5036966">//</span><br>
<span class="lineno"></span><span class="comment" id="5036969">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="5037032">type</span>&nbsp;<span class="ident" id="5037037">File</span>&nbsp;<span class="keyword" id="5037042">interface</span>&nbsp;<span class="op" id="5037052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037055">io</span><span class="op" id="5037057">.</span><span class="ident" id="5037058">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037066">io</span><span class="op" id="5037068">.</span><span class="ident" id="5037069">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037077">Readdir</span><span class="op" id="5037084">(</span><span class="ident" id="5037085">count</span>&nbsp;<span class="builtintype" id="5037091">int</span><span class="op" id="5037094">)</span>&nbsp;<span class="op" id="5037096">(</span><span class="op" id="5037097">[</span><span class="op" id="5037098">]</span><span class="ident" id="5037099">os</span><span class="op" id="5037101">.</span><span class="ident" id="5037102">FileInfo</span><span class="op" id="5037110">,</span>&nbsp;<span class="builtintype" id="5037112">error</span><span class="op" id="5037117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037120">Seek</span><span class="op" id="5037124">(</span><span class="ident" id="5037125">offset</span>&nbsp;<span class="ident" id="5037132">int64</span><span class="op" id="5037137">,</span>&nbsp;<span class="ident" id="5037139">whence</span>&nbsp;<span class="builtintype" id="5037146">int</span><span class="op" id="5037149">)</span>&nbsp;<span class="op" id="5037151">(</span><span class="ident" id="5037152">int64</span><span class="op" id="5037157">,</span>&nbsp;<span class="builtintype" id="5037159">error</span><span class="op" id="5037164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037167">Stat</span><span class="op" id="5037171">(</span><span class="op" id="5037172">)</span>&nbsp;<span class="op" id="5037174">(</span><span class="ident" id="5037175">os</span><span class="op" id="5037177">.</span><span class="ident" id="5037178">FileInfo</span><span class="op" id="5037186">,</span>&nbsp;<span class="builtintype" id="5037188">error</span><span class="op" id="5037193">)</span><br>
<span class="lineno"></span><span class="op" id="5037195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="5037198">func</span>&nbsp;<span class="ident" id="5037203">dirList</span><span class="op" id="5037210">(</span><span class="ident" id="5037211">w</span>&nbsp;<span class="ident" id="5037213">ResponseWriter</span><span class="op" id="5037227">,</span>&nbsp;<span class="ident" id="5037229">f</span>&nbsp;<span class="ident" id="5037231">File</span><span class="op" id="5037235">)</span>&nbsp;<span class="op" id="5037237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037240">w</span><span class="op" id="5037241">.</span><span class="ident" id="5037242">Header</span><span class="op" id="5037248">(</span><span class="op" id="5037249">)</span><span class="op" id="5037250">.</span><span class="ident" id="5037251">Set</span><span class="op" id="5037254">(</span><span class="string" id="5037255">&#34;Content-Type&#34;</span><span class="op" id="5037269">,</span>&nbsp;<span class="string" id="5037271">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5037297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037300">fmt</span><span class="op" id="5037303">.</span><span class="ident" id="5037304">Fprintf</span><span class="op" id="5037311">(</span><span class="ident" id="5037312">w</span><span class="op" id="5037313">,</span>&nbsp;<span class="string" id="5037315">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="5037324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037327">for</span>&nbsp;<span class="op" id="5037331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037335">dirs</span><span class="op" id="5037339">,</span>&nbsp;<span class="ident" id="5037341">err</span>&nbsp;<span class="op" id="5037345">:=</span>&nbsp;<span class="ident" id="5037348">f</span><span class="op" id="5037349">.</span><span class="ident" id="5037350">Readdir</span><span class="op" id="5037357">(</span><span class="num" id="5037358">100</span><span class="op" id="5037361">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037365">if</span>&nbsp;<span class="ident" id="5037368">err</span>&nbsp;<span class="op" id="5037372">!=</span>&nbsp;<span class="ident" id="5037375">nil</span>&nbsp;<span class="op" id="5037379">||</span>&nbsp;<span class="builtinfunc" id="5037382">len</span><span class="op" id="5037385">(</span><span class="ident" id="5037386">dirs</span><span class="op" id="5037390">)</span>&nbsp;<span class="op" id="5037392">==</span>&nbsp;<span class="num" id="5037395">0</span>&nbsp;<span class="op" id="5037397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037402">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037414">for</span>&nbsp;<span class="ident" id="5037418">_</span><span class="op" id="5037419">,</span>&nbsp;<span class="ident" id="5037421">d</span>&nbsp;<span class="op" id="5037423">:=</span>&nbsp;<span class="keyword" id="5037426">range</span>&nbsp;<span class="ident" id="5037432">dirs</span>&nbsp;<span class="op" id="5037437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037442">name</span>&nbsp;<span class="op" id="5037447">:=</span>&nbsp;<span class="ident" id="5037450">d</span><span class="op" id="5037451">.</span><span class="ident" id="5037452">Name</span><span class="op" id="5037456">(</span><span class="op" id="5037457">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037462">if</span>&nbsp;<span class="ident" id="5037465">d</span><span class="op" id="5037466">.</span><span class="ident" id="5037467">IsDir</span><span class="op" id="5037472">(</span><span class="op" id="5037473">)</span>&nbsp;<span class="op" id="5037475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037481">name</span>&nbsp;<span class="op" id="5037486">+=</span>&nbsp;<span class="string" id="5037489">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037501">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037568">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5037634">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037660">url</span>&nbsp;<span class="op" id="5037664">:=</span>&nbsp;<span class="ident" id="5037667">url</span><span class="op" id="5037670">.</span><span class="ident" id="5037671">URL</span><span class="op" id="5037674">{</span><span class="ident" id="5037675">Path</span><span class="op" id="5037679">:</span>&nbsp;<span class="ident" id="5037681">name</span><span class="op" id="5037685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037690">fmt</span><span class="op" id="5037693">.</span><span class="ident" id="5037694">Fprintf</span><span class="op" id="5037701">(</span><span class="ident" id="5037702">w</span><span class="op" id="5037703">,</span>&nbsp;<span class="string" id="5037705">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="5037730">,</span>&nbsp;<span class="ident" id="5037732">url</span><span class="op" id="5037735">.</span><span class="ident" id="5037736">String</span><span class="op" id="5037742">(</span><span class="op" id="5037743">)</span><span class="op" id="5037744">,</span>&nbsp;<span class="ident" id="5037746">htmlReplacer</span><span class="op" id="5037758">.</span><span class="ident" id="5037759">Replace</span><span class="op" id="5037766">(</span><span class="ident" id="5037767">name</span><span class="op" id="5037771">)</span><span class="op" id="5037772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037779">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037782">fmt</span><span class="op" id="5037785">.</span><span class="ident" id="5037786">Fprintf</span><span class="op" id="5037793">(</span><span class="ident" id="5037794">w</span><span class="op" id="5037795">,</span>&nbsp;<span class="string" id="5037797">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="5037807">)</span><br>
<span class="lineno"></span><span class="op" id="5037809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5037812">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5037876">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="5037947">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5038018">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="5038057">//</span><br>
<span class="lineno"></span><span class="comment" id="5038060">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="5038126">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="5038192">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="5038263">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="5038303">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5038373">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="5038404">//</span><br>
<span class="lineno">105</span><span class="comment" id="5038407">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5038473">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5038542">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="5038607">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="5038655">//</span><br>
<span class="lineno">110</span><span class="comment" id="5038658">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5038716">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="5038775">//</span><br>
<span class="lineno"></span><span class="comment" id="5038778">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5038844">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="5038897">//</span><br>
<span class="lineno"></span><span class="comment" id="5038900">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5038962">func</span>&nbsp;<span class="ident" id="5038967">ServeContent</span><span class="op" id="5038979">(</span><span class="ident" id="5038980">w</span>&nbsp;<span class="ident" id="5038982">ResponseWriter</span><span class="op" id="5038996">,</span>&nbsp;<span class="ident" id="5038998">req</span>&nbsp;<span class="op" id="5039002">*</span><span class="ident" id="5039003">Request</span><span class="op" id="5039010">,</span>&nbsp;<span class="ident" id="5039012">name</span>&nbsp;<span class="builtintype" id="5039017">string</span><span class="op" id="5039023">,</span>&nbsp;<span class="ident" id="5039025">modtime</span>&nbsp;<span class="ident" id="5039033">time</span><span class="op" id="5039037">.</span><span class="ident" id="5039038">Time</span><span class="op" id="5039042">,</span>&nbsp;<span class="ident" id="5039044">content</span>&nbsp;<span class="ident" id="5039052">io</span><span class="op" id="5039054">.</span><span class="ident" id="5039055">ReadSeeker</span><span class="op" id="5039065">)</span>&nbsp;<span class="op" id="5039067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5039070">sizeFunc</span>&nbsp;<span class="op" id="5039079">:=</span>&nbsp;<span class="keyword" id="5039082">func</span><span class="op" id="5039086">(</span><span class="op" id="5039087">)</span>&nbsp;<span class="op" id="5039089">(</span><span class="ident" id="5039090">int64</span><span class="op" id="5039095">,</span>&nbsp;<span class="builtintype" id="5039097">error</span><span class="op" id="5039102">)</span>&nbsp;<span class="op" id="5039104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5039108">size</span><span class="op" id="5039112">,</span>&nbsp;<span class="ident" id="5039114">err</span>&nbsp;<span class="op" id="5039118">:=</span>&nbsp;<span class="ident" id="5039121">content</span><span class="op" id="5039128">.</span><span class="ident" id="5039129">Seek</span><span class="op" id="5039133">(</span><span class="num" id="5039134">0</span><span class="op" id="5039135">,</span>&nbsp;<span class="ident" id="5039137">os</span><span class="op" id="5039139">.</span><span class="ident" id="5039140">SEEK_END</span><span class="op" id="5039148">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5039152">if</span>&nbsp;<span class="ident" id="5039155">err</span>&nbsp;<span class="op" id="5039159">!=</span>&nbsp;<span class="ident" id="5039162">nil</span>&nbsp;<span class="op" id="5039166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5039171">return</span>&nbsp;<span class="num" id="5039178">0</span><span class="op" id="5039179">,</span>&nbsp;<span class="ident" id="5039181">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5039193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5039197">_</span><span class="op" id="5039198">,</span>&nbsp;<span class="ident" id="5039200">err</span>&nbsp;<span class="op" id="5039204">=</span>&nbsp;<span class="ident" id="5039206">content</span><span class="op" id="5039213">.</span><span class="ident" id="5039214">Seek</span><span class="op" id="5039218">(</span><span class="num" id="5039219">0</span><span class="op" id="5039220">,</span>&nbsp;<span class="ident" id="5039222">os</span><span class="op" id="5039224">.</span><span class="ident" id="5039225">SEEK_SET</span><span class="op" id="5039233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5039237">if</span>&nbsp;<span class="ident" id="5039240">err</span>&nbsp;<span class="op" id="5039244">!=</span>&nbsp;<span class="ident" id="5039247">nil</span>&nbsp;<span class="op" id="5039251">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5039256">return</span>&nbsp;<span class="num" id="5039263">0</span><span class="op" id="5039264">,</span>&nbsp;<span class="ident" id="5039266">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5039278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5039282">return</span>&nbsp;<span class="ident" id="5039289">size</span><span class="op" id="5039293">,</span>&nbsp;<span class="ident" id="5039295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5039300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5039303">serveContent</span><span class="op" id="5039315">(</span><span class="ident" id="5039316">w</span><span class="op" id="5039317">,</span>&nbsp;<span class="ident" id="5039319">req</span><span class="op" id="5039322">,</span>&nbsp;<span class="ident" id="5039324">name</span><span class="op" id="5039328">,</span>&nbsp;<span class="ident" id="5039330">modtime</span><span class="op" id="5039337">,</span>&nbsp;<span class="ident" id="5039339">sizeFunc</span><span class="op" id="5039347">,</span>&nbsp;<span class="ident" id="5039349">content</span><span class="op" id="5039356">)</span><br>
<span class="lineno">130</span><span class="op" id="5039358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5039361">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="5039430">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="5039497">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="5039565">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="5039575">var</span>&nbsp;<span class="ident" id="5039579">errSeeker</span>&nbsp;<span class="op" id="5039589">=</span>&nbsp;<span class="ident" id="5039591">errors</span><span class="op" id="5039597">.</span><span class="ident" id="5039598">New</span><span class="op" id="5039601">(</span><span class="string" id="5039602">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="5039621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5039624">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="5039704">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="5039748">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="5039804">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5039893">func</span>&nbsp;<span class="ident" id="5039898">serveContent</span><span class="op" id="5039910">(</span><span class="ident" id="5039911">w</span>&nbsp;<span class="ident" id="5039913">ResponseWriter</span><span class="op" id="5039927">,</span>&nbsp;<span class="ident" id="5039929">r</span>&nbsp;<span class="op" id="5039931">*</span><span class="ident" id="5039932">Request</span><span class="op" id="5039939">,</span>&nbsp;<span class="ident" id="5039941">name</span>&nbsp;<span class="builtintype" id="5039946">string</span><span class="op" id="5039952">,</span>&nbsp;<span class="ident" id="5039954">modtime</span>&nbsp;<span class="ident" id="5039962">time</span><span class="op" id="5039966">.</span><span class="ident" id="5039967">Time</span><span class="op" id="5039971">,</span>&nbsp;<span class="ident" id="5039973">sizeFunc</span>&nbsp;<span class="keyword" id="5039982">func</span><span class="op" id="5039986">(</span><span class="op" id="5039987">)</span>&nbsp;<span class="op" id="5039989">(</span><span class="ident" id="5039990">int64</span><span class="op" id="5039995">,</span>&nbsp;<span class="builtintype" id="5039997">error</span><span class="op" id="5040002">)</span><span class="op" id="5040003">,</span>&nbsp;<span class="ident" id="5040005">content</span>&nbsp;<span class="ident" id="5040013">io</span><span class="op" id="5040015">.</span><span class="ident" id="5040016">ReadSeeker</span><span class="op" id="5040026">)</span>&nbsp;<span class="op" id="5040028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040031">if</span>&nbsp;<span class="ident" id="5040034">checkLastModified</span><span class="op" id="5040051">(</span><span class="ident" id="5040052">w</span><span class="op" id="5040053">,</span>&nbsp;<span class="ident" id="5040055">r</span><span class="op" id="5040056">,</span>&nbsp;<span class="ident" id="5040058">modtime</span><span class="op" id="5040065">)</span>&nbsp;<span class="op" id="5040067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040071">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040082">rangeReq</span><span class="op" id="5040090">,</span>&nbsp;<span class="ident" id="5040092">done</span>&nbsp;<span class="op" id="5040097">:=</span>&nbsp;<span class="ident" id="5040100">checkETag</span><span class="op" id="5040109">(</span><span class="ident" id="5040110">w</span><span class="op" id="5040111">,</span>&nbsp;<span class="ident" id="5040113">r</span><span class="op" id="5040114">,</span>&nbsp;<span class="ident" id="5040116">modtime</span><span class="op" id="5040123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040126">if</span>&nbsp;<span class="ident" id="5040129">done</span>&nbsp;<span class="op" id="5040134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040138">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040146">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040150">code</span>&nbsp;<span class="op" id="5040155">:=</span>&nbsp;<span class="ident" id="5040158">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5040169">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5040241">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040309">ctypes</span><span class="op" id="5040315">,</span>&nbsp;<span class="ident" id="5040317">haveType</span>&nbsp;<span class="op" id="5040326">:=</span>&nbsp;<span class="ident" id="5040329">w</span><span class="op" id="5040330">.</span><span class="ident" id="5040331">Header</span><span class="op" id="5040337">(</span><span class="op" id="5040338">)</span><span class="op" id="5040339">[</span><span class="string" id="5040340">&#34;Content-Type&#34;</span><span class="op" id="5040354">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040357">var</span>&nbsp;<span class="ident" id="5040361">ctype</span>&nbsp;<span class="builtintype" id="5040367">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040375">if</span>&nbsp;<span class="op" id="5040378">!</span><span class="ident" id="5040379">haveType</span>&nbsp;<span class="op" id="5040388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040392">ctype</span>&nbsp;<span class="op" id="5040398">=</span>&nbsp;<span class="ident" id="5040400">mime</span><span class="op" id="5040404">.</span><span class="ident" id="5040405">TypeByExtension</span><span class="op" id="5040420">(</span><span class="ident" id="5040421">filepath</span><span class="op" id="5040429">.</span><span class="ident" id="5040430">Ext</span><span class="op" id="5040433">(</span><span class="ident" id="5040434">name</span><span class="op" id="5040438">)</span><span class="op" id="5040439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040443">if</span>&nbsp;<span class="ident" id="5040446">ctype</span>&nbsp;<span class="op" id="5040452">==</span>&nbsp;<span class="string" id="5040455">&#34;&#34;</span>&nbsp;<span class="op" id="5040458">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5040463">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040522">var</span>&nbsp;<span class="ident" id="5040526">buf</span>&nbsp;<span class="op" id="5040530">[</span><span class="ident" id="5040531">sniffLen</span><span class="op" id="5040539">]</span><span class="builtintype" id="5040540">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040548">n</span><span class="op" id="5040549">,</span>&nbsp;<span class="ident" id="5040551">_</span>&nbsp;<span class="op" id="5040553">:=</span>&nbsp;<span class="ident" id="5040556">io</span><span class="op" id="5040558">.</span><span class="ident" id="5040559">ReadFull</span><span class="op" id="5040567">(</span><span class="ident" id="5040568">content</span><span class="op" id="5040575">,</span>&nbsp;<span class="ident" id="5040577">buf</span><span class="op" id="5040580">[</span><span class="op" id="5040581">:</span><span class="op" id="5040582">]</span><span class="op" id="5040583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040588">ctype</span>&nbsp;<span class="op" id="5040594">=</span>&nbsp;<span class="ident" id="5040596">DetectContentType</span><span class="op" id="5040613">(</span><span class="ident" id="5040614">buf</span><span class="op" id="5040617">[</span><span class="op" id="5040618">:</span><span class="ident" id="5040619">n</span><span class="op" id="5040620">]</span><span class="op" id="5040621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040626">_</span><span class="op" id="5040627">,</span>&nbsp;<span class="ident" id="5040629">err</span>&nbsp;<span class="op" id="5040633">:=</span>&nbsp;<span class="ident" id="5040636">content</span><span class="op" id="5040643">.</span><span class="ident" id="5040644">Seek</span><span class="op" id="5040648">(</span><span class="num" id="5040649">0</span><span class="op" id="5040650">,</span>&nbsp;<span class="ident" id="5040652">os</span><span class="op" id="5040654">.</span><span class="ident" id="5040655">SEEK_SET</span><span class="op" id="5040663">)</span>&nbsp;<span class="comment" id="5040665">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040699">if</span>&nbsp;<span class="ident" id="5040702">err</span>&nbsp;<span class="op" id="5040706">!=</span>&nbsp;<span class="ident" id="5040709">nil</span>&nbsp;<span class="op" id="5040713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040719">Error</span><span class="op" id="5040724">(</span><span class="ident" id="5040725">w</span><span class="op" id="5040726">,</span>&nbsp;<span class="string" id="5040728">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="5040747">,</span>&nbsp;<span class="ident" id="5040749">StatusInternalServerError</span><span class="op" id="5040774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040780">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040794">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040798">w</span><span class="op" id="5040799">.</span><span class="ident" id="5040800">Header</span><span class="op" id="5040806">(</span><span class="op" id="5040807">)</span><span class="op" id="5040808">.</span><span class="ident" id="5040809">Set</span><span class="op" id="5040812">(</span><span class="string" id="5040813">&#34;Content-Type&#34;</span><span class="op" id="5040827">,</span>&nbsp;<span class="ident" id="5040829">ctype</span><span class="op" id="5040834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040837">}</span>&nbsp;<span class="keyword" id="5040839">else</span>&nbsp;<span class="keyword" id="5040844">if</span>&nbsp;<span class="builtinfunc" id="5040847">len</span><span class="op" id="5040850">(</span><span class="ident" id="5040851">ctypes</span><span class="op" id="5040857">)</span>&nbsp;<span class="op" id="5040859">&gt;</span>&nbsp;<span class="num" id="5040861">0</span>&nbsp;<span class="op" id="5040863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040867">ctype</span>&nbsp;<span class="op" id="5040873">=</span>&nbsp;<span class="ident" id="5040875">ctypes</span><span class="op" id="5040881">[</span><span class="num" id="5040882">0</span><span class="op" id="5040883">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040890">size</span><span class="op" id="5040894">,</span>&nbsp;<span class="ident" id="5040896">err</span>&nbsp;<span class="op" id="5040900">:=</span>&nbsp;<span class="ident" id="5040903">sizeFunc</span><span class="op" id="5040911">(</span><span class="op" id="5040912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040915">if</span>&nbsp;<span class="ident" id="5040918">err</span>&nbsp;<span class="op" id="5040922">!=</span>&nbsp;<span class="ident" id="5040925">nil</span>&nbsp;<span class="op" id="5040929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5040933">Error</span><span class="op" id="5040938">(</span><span class="ident" id="5040939">w</span><span class="op" id="5040940">,</span>&nbsp;<span class="ident" id="5040942">err</span><span class="op" id="5040945">.</span><span class="ident" id="5040946">Error</span><span class="op" id="5040951">(</span><span class="op" id="5040952">)</span><span class="op" id="5040953">,</span>&nbsp;<span class="ident" id="5040955">StatusInternalServerError</span><span class="op" id="5040980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5040984">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5040992">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5040996">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5041029">sendSize</span>&nbsp;<span class="op" id="5041038">:=</span>&nbsp;<span class="ident" id="5041041">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041047">var</span>&nbsp;<span class="ident" id="5041051">sendContent</span>&nbsp;<span class="ident" id="5041063">io</span><span class="op" id="5041065">.</span><span class="ident" id="5041066">Reader</span>&nbsp;<span class="op" id="5041073">=</span>&nbsp;<span class="ident" id="5041075">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041084">if</span>&nbsp;<span class="ident" id="5041087">size</span>&nbsp;<span class="op" id="5041092">&gt;=</span>&nbsp;<span class="num" id="5041095">0</span>&nbsp;<span class="op" id="5041097">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5041101">ranges</span><span class="op" id="5041107">,</span>&nbsp;<span class="ident" id="5041109">err</span>&nbsp;<span class="op" id="5041113">:=</span>&nbsp;<span class="ident" id="5041116">parseRange</span><span class="op" id="5041126">(</span><span class="ident" id="5041127">rangeReq</span><span class="op" id="5041135">,</span>&nbsp;<span class="ident" id="5041137">size</span><span class="op" id="5041141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041145">if</span>&nbsp;<span class="ident" id="5041148">err</span>&nbsp;<span class="op" id="5041152">!=</span>&nbsp;<span class="ident" id="5041155">nil</span>&nbsp;<span class="op" id="5041159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5041164">Error</span><span class="op" id="5041169">(</span><span class="ident" id="5041170">w</span><span class="op" id="5041171">,</span>&nbsp;<span class="ident" id="5041173">err</span><span class="op" id="5041176">.</span><span class="ident" id="5041177">Error</span><span class="op" id="5041182">(</span><span class="op" id="5041183">)</span><span class="op" id="5041184">,</span>&nbsp;<span class="ident" id="5041186">StatusRequestedRangeNotSatisfiable</span><span class="op" id="5041220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5041234">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041238">if</span>&nbsp;<span class="ident" id="5041241">sumRangesSize</span><span class="op" id="5041254">(</span><span class="ident" id="5041255">ranges</span><span class="op" id="5041261">)</span>&nbsp;<span class="op" id="5041263">&gt;</span>&nbsp;<span class="ident" id="5041265">size</span>&nbsp;<span class="op" id="5041270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041275">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041325">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041370">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041420">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5041466">ranges</span>&nbsp;<span class="op" id="5041473">=</span>&nbsp;<span class="ident" id="5041475">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5041481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041485">switch</span>&nbsp;<span class="op" id="5041492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5041496">case</span>&nbsp;<span class="builtinfunc" id="5041501">len</span><span class="op" id="5041504">(</span><span class="ident" id="5041505">ranges</span><span class="op" id="5041511">)</span>&nbsp;<span class="op" id="5041513">==</span>&nbsp;<span class="num" id="5041516">1</span><span class="op" id="5041517">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041522">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041553">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041614">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041670">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041726">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041781">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041834">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041890">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041918">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041928">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5041986">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042044">ra</span>&nbsp;<span class="op" id="5042047">:=</span>&nbsp;<span class="ident" id="5042050">ranges</span><span class="op" id="5042056">[</span><span class="num" id="5042057">0</span><span class="op" id="5042058">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042063">if</span>&nbsp;<span class="ident" id="5042066">_</span><span class="op" id="5042067">,</span>&nbsp;<span class="ident" id="5042069">err</span>&nbsp;<span class="op" id="5042073">:=</span>&nbsp;<span class="ident" id="5042076">content</span><span class="op" id="5042083">.</span><span class="ident" id="5042084">Seek</span><span class="op" id="5042088">(</span><span class="ident" id="5042089">ra</span><span class="op" id="5042091">.</span><span class="ident" id="5042092">start</span><span class="op" id="5042097">,</span>&nbsp;<span class="ident" id="5042099">os</span><span class="op" id="5042101">.</span><span class="ident" id="5042102">SEEK_SET</span><span class="op" id="5042110">)</span><span class="op" id="5042111">;</span>&nbsp;<span class="ident" id="5042113">err</span>&nbsp;<span class="op" id="5042117">!=</span>&nbsp;<span class="ident" id="5042120">nil</span>&nbsp;<span class="op" id="5042124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042130">Error</span><span class="op" id="5042135">(</span><span class="ident" id="5042136">w</span><span class="op" id="5042137">,</span>&nbsp;<span class="ident" id="5042139">err</span><span class="op" id="5042142">.</span><span class="ident" id="5042143">Error</span><span class="op" id="5042148">(</span><span class="op" id="5042149">)</span><span class="op" id="5042150">,</span>&nbsp;<span class="ident" id="5042152">StatusRequestedRangeNotSatisfiable</span><span class="op" id="5042186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042192">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5042202">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042207">sendSize</span>&nbsp;<span class="op" id="5042216">=</span>&nbsp;<span class="ident" id="5042218">ra</span><span class="op" id="5042220">.</span><span class="ident" id="5042221">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042231">code</span>&nbsp;<span class="op" id="5042236">=</span>&nbsp;<span class="ident" id="5042238">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042262">w</span><span class="op" id="5042263">.</span><span class="ident" id="5042264">Header</span><span class="op" id="5042270">(</span><span class="op" id="5042271">)</span><span class="op" id="5042272">.</span><span class="ident" id="5042273">Set</span><span class="op" id="5042276">(</span><span class="string" id="5042277">&#34;Content-Range&#34;</span><span class="op" id="5042292">,</span>&nbsp;<span class="ident" id="5042294">ra</span><span class="op" id="5042296">.</span><span class="ident" id="5042297">contentRange</span><span class="op" id="5042309">(</span><span class="ident" id="5042310">size</span><span class="op" id="5042314">)</span><span class="op" id="5042315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042319">case</span>&nbsp;<span class="builtinfunc" id="5042324">len</span><span class="op" id="5042327">(</span><span class="ident" id="5042328">ranges</span><span class="op" id="5042334">)</span>&nbsp;<span class="op" id="5042336">&gt;</span>&nbsp;<span class="num" id="5042338">1</span><span class="op" id="5042339">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042344">sendSize</span>&nbsp;<span class="op" id="5042353">=</span>&nbsp;<span class="ident" id="5042355">rangesMIMESize</span><span class="op" id="5042369">(</span><span class="ident" id="5042370">ranges</span><span class="op" id="5042376">,</span>&nbsp;<span class="ident" id="5042378">ctype</span><span class="op" id="5042383">,</span>&nbsp;<span class="ident" id="5042385">size</span><span class="op" id="5042389">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042394">code</span>&nbsp;<span class="op" id="5042399">=</span>&nbsp;<span class="ident" id="5042401">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042426">pr</span><span class="op" id="5042428">,</span>&nbsp;<span class="ident" id="5042430">pw</span>&nbsp;<span class="op" id="5042433">:=</span>&nbsp;<span class="ident" id="5042436">io</span><span class="op" id="5042438">.</span><span class="ident" id="5042439">Pipe</span><span class="op" id="5042443">(</span><span class="op" id="5042444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042449">mw</span>&nbsp;<span class="op" id="5042452">:=</span>&nbsp;<span class="ident" id="5042455">multipart</span><span class="op" id="5042464">.</span><span class="ident" id="5042465">NewWriter</span><span class="op" id="5042474">(</span><span class="ident" id="5042475">pw</span><span class="op" id="5042477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042482">w</span><span class="op" id="5042483">.</span><span class="ident" id="5042484">Header</span><span class="op" id="5042490">(</span><span class="op" id="5042491">)</span><span class="op" id="5042492">.</span><span class="ident" id="5042493">Set</span><span class="op" id="5042496">(</span><span class="string" id="5042497">&#34;Content-Type&#34;</span><span class="op" id="5042511">,</span>&nbsp;<span class="string" id="5042513">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="5042546">+</span><span class="ident" id="5042547">mw</span><span class="op" id="5042549">.</span><span class="ident" id="5042550">Boundary</span><span class="op" id="5042558">(</span><span class="op" id="5042559">)</span><span class="op" id="5042560">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042565">sendContent</span>&nbsp;<span class="op" id="5042577">=</span>&nbsp;<span class="ident" id="5042579">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042585">defer</span>&nbsp;<span class="ident" id="5042591">pr</span><span class="op" id="5042593">.</span><span class="ident" id="5042594">Close</span><span class="op" id="5042599">(</span><span class="op" id="5042600">)</span>&nbsp;<span class="comment" id="5042602">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042674">go</span>&nbsp;<span class="keyword" id="5042677">func</span><span class="op" id="5042681">(</span><span class="op" id="5042682">)</span>&nbsp;<span class="op" id="5042684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042690">for</span>&nbsp;<span class="ident" id="5042694">_</span><span class="op" id="5042695">,</span>&nbsp;<span class="ident" id="5042697">ra</span>&nbsp;<span class="op" id="5042700">:=</span>&nbsp;<span class="keyword" id="5042703">range</span>&nbsp;<span class="ident" id="5042709">ranges</span>&nbsp;<span class="op" id="5042716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042723">part</span><span class="op" id="5042727">,</span>&nbsp;<span class="ident" id="5042729">err</span>&nbsp;<span class="op" id="5042733">:=</span>&nbsp;<span class="ident" id="5042736">mw</span><span class="op" id="5042738">.</span><span class="ident" id="5042739">CreatePart</span><span class="op" id="5042749">(</span><span class="ident" id="5042750">ra</span><span class="op" id="5042752">.</span><span class="ident" id="5042753">mimeHeader</span><span class="op" id="5042763">(</span><span class="ident" id="5042764">ctype</span><span class="op" id="5042769">,</span>&nbsp;<span class="ident" id="5042771">size</span><span class="op" id="5042775">)</span><span class="op" id="5042776">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042783">if</span>&nbsp;<span class="ident" id="5042786">err</span>&nbsp;<span class="op" id="5042790">!=</span>&nbsp;<span class="ident" id="5042793">nil</span>&nbsp;<span class="op" id="5042797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042805">pw</span><span class="op" id="5042807">.</span><span class="ident" id="5042808">CloseWithError</span><span class="op" id="5042822">(</span><span class="ident" id="5042823">err</span><span class="op" id="5042826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042834">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5042846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042853">if</span>&nbsp;<span class="ident" id="5042856">_</span><span class="op" id="5042857">,</span>&nbsp;<span class="ident" id="5042859">err</span>&nbsp;<span class="op" id="5042863">:=</span>&nbsp;<span class="ident" id="5042866">content</span><span class="op" id="5042873">.</span><span class="ident" id="5042874">Seek</span><span class="op" id="5042878">(</span><span class="ident" id="5042879">ra</span><span class="op" id="5042881">.</span><span class="ident" id="5042882">start</span><span class="op" id="5042887">,</span>&nbsp;<span class="ident" id="5042889">os</span><span class="op" id="5042891">.</span><span class="ident" id="5042892">SEEK_SET</span><span class="op" id="5042900">)</span><span class="op" id="5042901">;</span>&nbsp;<span class="ident" id="5042903">err</span>&nbsp;<span class="op" id="5042907">!=</span>&nbsp;<span class="ident" id="5042910">nil</span>&nbsp;<span class="op" id="5042914">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5042922">pw</span><span class="op" id="5042924">.</span><span class="ident" id="5042925">CloseWithError</span><span class="op" id="5042939">(</span><span class="ident" id="5042940">err</span><span class="op" id="5042943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042951">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5042963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5042970">if</span>&nbsp;<span class="ident" id="5042973">_</span><span class="op" id="5042974">,</span>&nbsp;<span class="ident" id="5042976">err</span>&nbsp;<span class="op" id="5042980">:=</span>&nbsp;<span class="ident" id="5042983">io</span><span class="op" id="5042985">.</span><span class="ident" id="5042986">CopyN</span><span class="op" id="5042991">(</span><span class="ident" id="5042992">part</span><span class="op" id="5042996">,</span>&nbsp;<span class="ident" id="5042998">content</span><span class="op" id="5043005">,</span>&nbsp;<span class="ident" id="5043007">ra</span><span class="op" id="5043009">.</span><span class="ident" id="5043010">length</span><span class="op" id="5043016">)</span><span class="op" id="5043017">;</span>&nbsp;<span class="ident" id="5043019">err</span>&nbsp;<span class="op" id="5043023">!=</span>&nbsp;<span class="ident" id="5043026">nil</span>&nbsp;<span class="op" id="5043030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043038">pw</span><span class="op" id="5043040">.</span><span class="ident" id="5043041">CloseWithError</span><span class="op" id="5043055">(</span><span class="ident" id="5043056">err</span><span class="op" id="5043059">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5043067">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043091">mw</span><span class="op" id="5043093">.</span><span class="ident" id="5043094">Close</span><span class="op" id="5043099">(</span><span class="op" id="5043100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043106">pw</span><span class="op" id="5043108">.</span><span class="ident" id="5043109">Close</span><span class="op" id="5043114">(</span><span class="op" id="5043115">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043120">}</span><span class="op" id="5043121">(</span><span class="op" id="5043122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043131">w</span><span class="op" id="5043132">.</span><span class="ident" id="5043133">Header</span><span class="op" id="5043139">(</span><span class="op" id="5043140">)</span><span class="op" id="5043141">.</span><span class="ident" id="5043142">Set</span><span class="op" id="5043145">(</span><span class="string" id="5043146">&#34;Accept-Ranges&#34;</span><span class="op" id="5043161">,</span>&nbsp;<span class="string" id="5043163">&#34;bytes&#34;</span><span class="op" id="5043170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5043174">if</span>&nbsp;<span class="ident" id="5043177">w</span><span class="op" id="5043178">.</span><span class="ident" id="5043179">Header</span><span class="op" id="5043185">(</span><span class="op" id="5043186">)</span><span class="op" id="5043187">.</span><span class="ident" id="5043188">Get</span><span class="op" id="5043191">(</span><span class="string" id="5043192">&#34;Content-Encoding&#34;</span><span class="op" id="5043210">)</span>&nbsp;<span class="op" id="5043212">==</span>&nbsp;<span class="string" id="5043215">&#34;&#34;</span>&nbsp;<span class="op" id="5043218">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043223">w</span><span class="op" id="5043224">.</span><span class="ident" id="5043225">Header</span><span class="op" id="5043231">(</span><span class="op" id="5043232">)</span><span class="op" id="5043233">.</span><span class="ident" id="5043234">Set</span><span class="op" id="5043237">(</span><span class="string" id="5043238">&#34;Content-Length&#34;</span><span class="op" id="5043254">,</span>&nbsp;<span class="ident" id="5043256">strconv</span><span class="op" id="5043263">.</span><span class="ident" id="5043264">FormatInt</span><span class="op" id="5043273">(</span><span class="ident" id="5043274">sendSize</span><span class="op" id="5043282">,</span>&nbsp;<span class="num" id="5043284">10</span><span class="op" id="5043286">)</span><span class="op" id="5043287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043298">w</span><span class="op" id="5043299">.</span><span class="ident" id="5043300">WriteHeader</span><span class="op" id="5043311">(</span><span class="ident" id="5043312">code</span><span class="op" id="5043316">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5043320">if</span>&nbsp;<span class="ident" id="5043323">r</span><span class="op" id="5043324">.</span><span class="ident" id="5043325">Method</span>&nbsp;<span class="op" id="5043332">!=</span>&nbsp;<span class="string" id="5043335">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5043342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043346">io</span><span class="op" id="5043348">.</span><span class="ident" id="5043349">CopyN</span><span class="op" id="5043354">(</span><span class="ident" id="5043355">w</span><span class="op" id="5043356">,</span>&nbsp;<span class="ident" id="5043358">sendContent</span><span class="op" id="5043369">,</span>&nbsp;<span class="ident" id="5043371">sendSize</span><span class="op" id="5043379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043382">}</span><br>
<span class="lineno"></span><span class="op" id="5043384">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5043387">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="5043466">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="5043523">func</span>&nbsp;<span class="ident" id="5043528">checkLastModified</span><span class="op" id="5043545">(</span><span class="ident" id="5043546">w</span>&nbsp;<span class="ident" id="5043548">ResponseWriter</span><span class="op" id="5043562">,</span>&nbsp;<span class="ident" id="5043564">r</span>&nbsp;<span class="op" id="5043566">*</span><span class="ident" id="5043567">Request</span><span class="op" id="5043574">,</span>&nbsp;<span class="ident" id="5043576">modtime</span>&nbsp;<span class="ident" id="5043584">time</span><span class="op" id="5043588">.</span><span class="ident" id="5043589">Time</span><span class="op" id="5043593">)</span>&nbsp;<span class="builtintype" id="5043595">bool</span>&nbsp;<span class="op" id="5043600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5043603">if</span>&nbsp;<span class="ident" id="5043606">modtime</span><span class="op" id="5043613">.</span><span class="ident" id="5043614">IsZero</span><span class="op" id="5043620">(</span><span class="op" id="5043621">)</span>&nbsp;<span class="op" id="5043623">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5043627">return</span>&nbsp;<span class="builtintype" id="5043634">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5043641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5043645">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5043709">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5043777">if</span>&nbsp;<span class="ident" id="5043780">t</span><span class="op" id="5043781">,</span>&nbsp;<span class="ident" id="5043783">err</span>&nbsp;<span class="op" id="5043787">:=</span>&nbsp;<span class="ident" id="5043790">time</span><span class="op" id="5043794">.</span><span class="ident" id="5043795">Parse</span><span class="op" id="5043800">(</span><span class="ident" id="5043801">TimeFormat</span><span class="op" id="5043811">,</span>&nbsp;<span class="ident" id="5043813">r</span><span class="op" id="5043814">.</span><span class="ident" id="5043815">Header</span><span class="op" id="5043821">.</span><span class="ident" id="5043822">Get</span><span class="op" id="5043825">(</span><span class="string" id="5043826">&#34;If-Modified-Since&#34;</span><span class="op" id="5043845">)</span><span class="op" id="5043846">)</span><span class="op" id="5043847">;</span>&nbsp;<span class="ident" id="5043849">err</span>&nbsp;<span class="op" id="5043853">==</span>&nbsp;<span class="ident" id="5043856">nil</span>&nbsp;<span class="op" id="5043860">&amp;&amp;</span>&nbsp;<span class="ident" id="5043863">modtime</span><span class="op" id="5043870">.</span><span class="ident" id="5043871">Before</span><span class="op" id="5043877">(</span><span class="ident" id="5043878">t</span><span class="op" id="5043879">.</span><span class="ident" id="5043880">Add</span><span class="op" id="5043883">(</span><span class="num" id="5043884">1</span><span class="op" id="5043885">*</span><span class="ident" id="5043886">time</span><span class="op" id="5043890">.</span><span class="ident" id="5043891">Second</span><span class="op" id="5043897">)</span><span class="op" id="5043898">)</span>&nbsp;<span class="op" id="5043900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043904">h</span>&nbsp;<span class="op" id="5043906">:=</span>&nbsp;<span class="ident" id="5043909">w</span><span class="op" id="5043910">.</span><span class="ident" id="5043911">Header</span><span class="op" id="5043917">(</span><span class="op" id="5043918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5043922">delete</span><span class="op" id="5043928">(</span><span class="ident" id="5043929">h</span><span class="op" id="5043930">,</span>&nbsp;<span class="string" id="5043932">&#34;Content-Type&#34;</span><span class="op" id="5043946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5043950">delete</span><span class="op" id="5043956">(</span><span class="ident" id="5043957">h</span><span class="op" id="5043958">,</span>&nbsp;<span class="string" id="5043960">&#34;Content-Length&#34;</span><span class="op" id="5043976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5043980">w</span><span class="op" id="5043981">.</span><span class="ident" id="5043982">WriteHeader</span><span class="op" id="5043993">(</span><span class="ident" id="5043994">StatusNotModified</span><span class="op" id="5044011">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5044015">return</span>&nbsp;<span class="builtintype" id="5044022">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5044028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5044031">w</span><span class="op" id="5044032">.</span><span class="ident" id="5044033">Header</span><span class="op" id="5044039">(</span><span class="op" id="5044040">)</span><span class="op" id="5044041">.</span><span class="ident" id="5044042">Set</span><span class="op" id="5044045">(</span><span class="string" id="5044046">&#34;Last-Modified&#34;</span><span class="op" id="5044061">,</span>&nbsp;<span class="ident" id="5044063">modtime</span><span class="op" id="5044070">.</span><span class="ident" id="5044071">UTC</span><span class="op" id="5044074">(</span><span class="op" id="5044075">)</span><span class="op" id="5044076">.</span><span class="ident" id="5044077">Format</span><span class="op" id="5044083">(</span><span class="ident" id="5044084">TimeFormat</span><span class="op" id="5044094">)</span><span class="op" id="5044095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5044098">return</span>&nbsp;<span class="builtintype" id="5044105">false</span><br>
<span class="lineno"></span><span class="op" id="5044111">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5044114">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="5044173">//</span><br>
<span class="lineno"></span><span class="comment" id="5044176">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5044236">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="5044305">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="5044363">//</span><br>
<span class="lineno"></span><span class="comment" id="5044366">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5044437">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="5044485">func</span>&nbsp;<span class="ident" id="5044490">checkETag</span><span class="op" id="5044499">(</span><span class="ident" id="5044500">w</span>&nbsp;<span class="ident" id="5044502">ResponseWriter</span><span class="op" id="5044516">,</span>&nbsp;<span class="ident" id="5044518">r</span>&nbsp;<span class="op" id="5044520">*</span><span class="ident" id="5044521">Request</span><span class="op" id="5044528">,</span>&nbsp;<span class="ident" id="5044530">modtime</span>&nbsp;<span class="ident" id="5044538">time</span><span class="op" id="5044542">.</span><span class="ident" id="5044543">Time</span><span class="op" id="5044547">)</span>&nbsp;<span class="op" id="5044549">(</span><span class="ident" id="5044550">rangeReq</span>&nbsp;<span class="builtintype" id="5044559">string</span><span class="op" id="5044565">,</span>&nbsp;<span class="ident" id="5044567">done</span>&nbsp;<span class="builtintype" id="5044572">bool</span><span class="op" id="5044576">)</span>&nbsp;<span class="op" id="5044578">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5044581">etag</span>&nbsp;<span class="op" id="5044586">:=</span>&nbsp;<span class="ident" id="5044589">w</span><span class="op" id="5044590">.</span><span class="ident" id="5044591">Header</span><span class="op" id="5044597">(</span><span class="op" id="5044598">)</span><span class="op" id="5044599">.</span><span class="ident" id="5044600">get</span><span class="op" id="5044603">(</span><span class="string" id="5044604">&#34;Etag&#34;</span><span class="op" id="5044610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5044613">rangeReq</span>&nbsp;<span class="op" id="5044622">=</span>&nbsp;<span class="ident" id="5044624">r</span><span class="op" id="5044625">.</span><span class="ident" id="5044626">Header</span><span class="op" id="5044632">.</span><span class="ident" id="5044633">get</span><span class="op" id="5044636">(</span><span class="string" id="5044637">&#34;Range&#34;</span><span class="op" id="5044644">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5044648">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5044717">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5044747">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5044830">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5044849">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5044884">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5044947">if</span>&nbsp;<span class="ident" id="5044950">ir</span>&nbsp;<span class="op" id="5044953">:=</span>&nbsp;<span class="ident" id="5044956">r</span><span class="op" id="5044957">.</span><span class="ident" id="5044958">Header</span><span class="op" id="5044964">.</span><span class="ident" id="5044965">get</span><span class="op" id="5044968">(</span><span class="string" id="5044969">&#34;If-Range&#34;</span><span class="op" id="5044979">)</span><span class="op" id="5044980">;</span>&nbsp;<span class="ident" id="5044982">ir</span>&nbsp;<span class="op" id="5044985">!=</span>&nbsp;<span class="string" id="5044988">&#34;&#34;</span>&nbsp;<span class="op" id="5044991">&amp;&amp;</span>&nbsp;<span class="ident" id="5044994">ir</span>&nbsp;<span class="op" id="5044997">!=</span>&nbsp;<span class="ident" id="5045000">etag</span>&nbsp;<span class="op" id="5045005">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045009">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045081">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5045131">timeMatches</span>&nbsp;<span class="op" id="5045143">:=</span>&nbsp;<span class="builtintype" id="5045146">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045154">if</span>&nbsp;<span class="op" id="5045157">!</span><span class="ident" id="5045158">modtime</span><span class="op" id="5045165">.</span><span class="ident" id="5045166">IsZero</span><span class="op" id="5045172">(</span><span class="op" id="5045173">)</span>&nbsp;<span class="op" id="5045175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045180">if</span>&nbsp;<span class="ident" id="5045183">t</span><span class="op" id="5045184">,</span>&nbsp;<span class="ident" id="5045186">err</span>&nbsp;<span class="op" id="5045190">:=</span>&nbsp;<span class="ident" id="5045193">ParseTime</span><span class="op" id="5045202">(</span><span class="ident" id="5045203">ir</span><span class="op" id="5045205">)</span><span class="op" id="5045206">;</span>&nbsp;<span class="ident" id="5045208">err</span>&nbsp;<span class="op" id="5045212">==</span>&nbsp;<span class="ident" id="5045215">nil</span>&nbsp;<span class="op" id="5045219">&amp;&amp;</span>&nbsp;<span class="ident" id="5045222">t</span><span class="op" id="5045223">.</span><span class="ident" id="5045224">Unix</span><span class="op" id="5045228">(</span><span class="op" id="5045229">)</span>&nbsp;<span class="op" id="5045231">==</span>&nbsp;<span class="ident" id="5045234">modtime</span><span class="op" id="5045241">.</span><span class="ident" id="5045242">Unix</span><span class="op" id="5045246">(</span><span class="op" id="5045247">)</span>&nbsp;<span class="op" id="5045249">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5045255">timeMatches</span>&nbsp;<span class="op" id="5045267">=</span>&nbsp;<span class="builtintype" id="5045269">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5045277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5045281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045285">if</span>&nbsp;<span class="op" id="5045288">!</span><span class="ident" id="5045289">timeMatches</span>&nbsp;<span class="op" id="5045301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5045306">rangeReq</span>&nbsp;<span class="op" id="5045315">=</span>&nbsp;<span class="string" id="5045317">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5045322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5045325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045329">if</span>&nbsp;<span class="ident" id="5045332">inm</span>&nbsp;<span class="op" id="5045336">:=</span>&nbsp;<span class="ident" id="5045339">r</span><span class="op" id="5045340">.</span><span class="ident" id="5045341">Header</span><span class="op" id="5045347">.</span><span class="ident" id="5045348">get</span><span class="op" id="5045351">(</span><span class="string" id="5045352">&#34;If-None-Match&#34;</span><span class="op" id="5045367">)</span><span class="op" id="5045368">;</span>&nbsp;<span class="ident" id="5045370">inm</span>&nbsp;<span class="op" id="5045374">!=</span>&nbsp;<span class="string" id="5045377">&#34;&#34;</span>&nbsp;<span class="op" id="5045380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045384">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045405">if</span>&nbsp;<span class="ident" id="5045408">etag</span>&nbsp;<span class="op" id="5045413">==</span>&nbsp;<span class="string" id="5045416">&#34;&#34;</span>&nbsp;<span class="op" id="5045419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045424">return</span>&nbsp;<span class="ident" id="5045431">rangeReq</span><span class="op" id="5045439">,</span>&nbsp;<span class="builtintype" id="5045441">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5045449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045454">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045516">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045569">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045629">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045689">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045744">if</span>&nbsp;<span class="ident" id="5045747">r</span><span class="op" id="5045748">.</span><span class="ident" id="5045749">Method</span>&nbsp;<span class="op" id="5045756">!=</span>&nbsp;<span class="string" id="5045759">&#34;GET&#34;</span>&nbsp;<span class="op" id="5045765">&amp;&amp;</span>&nbsp;<span class="ident" id="5045768">r</span><span class="op" id="5045769">.</span><span class="ident" id="5045770">Method</span>&nbsp;<span class="op" id="5045777">!=</span>&nbsp;<span class="string" id="5045780">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5045787">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045792">return</span>&nbsp;<span class="ident" id="5045799">rangeReq</span><span class="op" id="5045807">,</span>&nbsp;<span class="builtintype" id="5045809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5045817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045822">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045888">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5045955">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5045983">if</span>&nbsp;<span class="ident" id="5045986">inm</span>&nbsp;<span class="op" id="5045990">==</span>&nbsp;<span class="ident" id="5045993">etag</span>&nbsp;<span class="op" id="5045998">||</span>&nbsp;<span class="ident" id="5046001">inm</span>&nbsp;<span class="op" id="5046005">==</span>&nbsp;<span class="string" id="5046008">&#34;*&#34;</span>&nbsp;<span class="op" id="5046012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046017">h</span>&nbsp;<span class="op" id="5046019">:=</span>&nbsp;<span class="ident" id="5046022">w</span><span class="op" id="5046023">.</span><span class="ident" id="5046024">Header</span><span class="op" id="5046030">(</span><span class="op" id="5046031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5046036">delete</span><span class="op" id="5046042">(</span><span class="ident" id="5046043">h</span><span class="op" id="5046044">,</span>&nbsp;<span class="string" id="5046046">&#34;Content-Type&#34;</span><span class="op" id="5046060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5046065">delete</span><span class="op" id="5046071">(</span><span class="ident" id="5046072">h</span><span class="op" id="5046073">,</span>&nbsp;<span class="string" id="5046075">&#34;Content-Length&#34;</span><span class="op" id="5046091">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046096">w</span><span class="op" id="5046097">.</span><span class="ident" id="5046098">WriteHeader</span><span class="op" id="5046109">(</span><span class="ident" id="5046110">StatusNotModified</span><span class="op" id="5046127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046132">return</span>&nbsp;<span class="string" id="5046139">&#34;&#34;</span><span class="op" id="5046141">,</span>&nbsp;<span class="builtintype" id="5046143">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5046150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5046153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046156">return</span>&nbsp;<span class="ident" id="5046163">rangeReq</span><span class="op" id="5046171">,</span>&nbsp;<span class="builtintype" id="5046173">false</span><br>
<span class="lineno">340</span><span class="op" id="5046179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5046182">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="5046232">func</span>&nbsp;<span class="ident" id="5046237">serveFile</span><span class="op" id="5046246">(</span><span class="ident" id="5046247">w</span>&nbsp;<span class="ident" id="5046249">ResponseWriter</span><span class="op" id="5046263">,</span>&nbsp;<span class="ident" id="5046265">r</span>&nbsp;<span class="op" id="5046267">*</span><span class="ident" id="5046268">Request</span><span class="op" id="5046275">,</span>&nbsp;<span class="ident" id="5046277">fs</span>&nbsp;<span class="ident" id="5046280">FileSystem</span><span class="op" id="5046290">,</span>&nbsp;<span class="ident" id="5046292">name</span>&nbsp;<span class="builtintype" id="5046297">string</span><span class="op" id="5046303">,</span>&nbsp;<span class="ident" id="5046305">redirect</span>&nbsp;<span class="builtintype" id="5046314">bool</span><span class="op" id="5046318">)</span>&nbsp;<span class="op" id="5046320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046323">const</span>&nbsp;<span class="ident" id="5046329">indexPage</span>&nbsp;<span class="op" id="5046339">=</span>&nbsp;<span class="string" id="5046341">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046357">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046393">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046461">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046516">if</span>&nbsp;<span class="ident" id="5046519">strings</span><span class="op" id="5046526">.</span><span class="ident" id="5046527">HasSuffix</span><span class="op" id="5046536">(</span><span class="ident" id="5046537">r</span><span class="op" id="5046538">.</span><span class="ident" id="5046539">URL</span><span class="op" id="5046542">.</span><span class="ident" id="5046543">Path</span><span class="op" id="5046547">,</span>&nbsp;<span class="ident" id="5046549">indexPage</span><span class="op" id="5046558">)</span>&nbsp;<span class="op" id="5046560">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046564">localRedirect</span><span class="op" id="5046577">(</span><span class="ident" id="5046578">w</span><span class="op" id="5046579">,</span>&nbsp;<span class="ident" id="5046581">r</span><span class="op" id="5046582">,</span>&nbsp;<span class="string" id="5046584">&#34;./&#34;</span><span class="op" id="5046588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046592">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5046600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046604">f</span><span class="op" id="5046605">,</span>&nbsp;<span class="ident" id="5046607">err</span>&nbsp;<span class="op" id="5046611">:=</span>&nbsp;<span class="ident" id="5046614">fs</span><span class="op" id="5046616">.</span><span class="ident" id="5046617">Open</span><span class="op" id="5046621">(</span><span class="ident" id="5046622">name</span><span class="op" id="5046626">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046629">if</span>&nbsp;<span class="ident" id="5046632">err</span>&nbsp;<span class="op" id="5046636">!=</span>&nbsp;<span class="ident" id="5046639">nil</span>&nbsp;<span class="op" id="5046643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046647">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046678">NotFound</span><span class="op" id="5046686">(</span><span class="ident" id="5046687">w</span><span class="op" id="5046688">,</span>&nbsp;<span class="ident" id="5046690">r</span><span class="op" id="5046691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046695">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5046703">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046706">defer</span>&nbsp;<span class="ident" id="5046712">f</span><span class="op" id="5046713">.</span><span class="ident" id="5046714">Close</span><span class="op" id="5046719">(</span><span class="op" id="5046720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046724">d</span><span class="op" id="5046725">,</span>&nbsp;<span class="ident" id="5046727">err1</span>&nbsp;<span class="op" id="5046732">:=</span>&nbsp;<span class="ident" id="5046735">f</span><span class="op" id="5046736">.</span><span class="ident" id="5046737">Stat</span><span class="op" id="5046741">(</span><span class="op" id="5046742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046745">if</span>&nbsp;<span class="ident" id="5046748">err1</span>&nbsp;<span class="op" id="5046753">!=</span>&nbsp;<span class="ident" id="5046756">nil</span>&nbsp;<span class="op" id="5046760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046764">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046795">NotFound</span><span class="op" id="5046803">(</span><span class="ident" id="5046804">w</span><span class="op" id="5046805">,</span>&nbsp;<span class="ident" id="5046807">r</span><span class="op" id="5046808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046812">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5046820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046824">if</span>&nbsp;<span class="ident" id="5046827">redirect</span>&nbsp;<span class="op" id="5046836">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046840">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5046899">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046936">url</span>&nbsp;<span class="op" id="5046940">:=</span>&nbsp;<span class="ident" id="5046943">r</span><span class="op" id="5046944">.</span><span class="ident" id="5046945">URL</span><span class="op" id="5046948">.</span><span class="ident" id="5046949">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046956">if</span>&nbsp;<span class="ident" id="5046959">d</span><span class="op" id="5046960">.</span><span class="ident" id="5046961">IsDir</span><span class="op" id="5046966">(</span><span class="op" id="5046967">)</span>&nbsp;<span class="op" id="5046969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5046974">if</span>&nbsp;<span class="ident" id="5046977">url</span><span class="op" id="5046980">[</span><span class="builtinfunc" id="5046981">len</span><span class="op" id="5046984">(</span><span class="ident" id="5046985">url</span><span class="op" id="5046988">)</span><span class="op" id="5046989">-</span><span class="num" id="5046990">1</span><span class="op" id="5046991">]</span>&nbsp;<span class="op" id="5046993">!=</span>&nbsp;<span class="string" id="5046996">&#39;/&#39;</span>&nbsp;<span class="op" id="5047000">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047006">localRedirect</span><span class="op" id="5047019">(</span><span class="ident" id="5047020">w</span><span class="op" id="5047021">,</span>&nbsp;<span class="ident" id="5047023">r</span><span class="op" id="5047024">,</span>&nbsp;<span class="ident" id="5047026">path</span><span class="op" id="5047030">.</span><span class="ident" id="5047031">Base</span><span class="op" id="5047035">(</span><span class="ident" id="5047036">url</span><span class="op" id="5047039">)</span><span class="op" id="5047040">+</span><span class="string" id="5047041">&#34;/&#34;</span><span class="op" id="5047044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047050">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047064">}</span>&nbsp;<span class="keyword" id="5047066">else</span>&nbsp;<span class="op" id="5047071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047076">if</span>&nbsp;<span class="ident" id="5047079">url</span><span class="op" id="5047082">[</span><span class="builtinfunc" id="5047083">len</span><span class="op" id="5047086">(</span><span class="ident" id="5047087">url</span><span class="op" id="5047090">)</span><span class="op" id="5047091">-</span><span class="num" id="5047092">1</span><span class="op" id="5047093">]</span>&nbsp;<span class="op" id="5047095">==</span>&nbsp;<span class="string" id="5047098">&#39;/&#39;</span>&nbsp;<span class="op" id="5047102">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047108">localRedirect</span><span class="op" id="5047121">(</span><span class="ident" id="5047122">w</span><span class="op" id="5047123">,</span>&nbsp;<span class="ident" id="5047125">r</span><span class="op" id="5047126">,</span>&nbsp;<span class="string" id="5047128">&#34;../&#34;</span><span class="op" id="5047133">+</span><span class="ident" id="5047134">path</span><span class="op" id="5047138">.</span><span class="ident" id="5047139">Base</span><span class="op" id="5047143">(</span><span class="ident" id="5047144">url</span><span class="op" id="5047147">)</span><span class="op" id="5047148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047154">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047171">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5047175">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047232">if</span>&nbsp;<span class="ident" id="5047235">d</span><span class="op" id="5047236">.</span><span class="ident" id="5047237">IsDir</span><span class="op" id="5047242">(</span><span class="op" id="5047243">)</span>&nbsp;<span class="op" id="5047245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047249">index</span>&nbsp;<span class="op" id="5047255">:=</span>&nbsp;<span class="ident" id="5047258">strings</span><span class="op" id="5047265">.</span><span class="ident" id="5047266">TrimSuffix</span><span class="op" id="5047276">(</span><span class="ident" id="5047277">name</span><span class="op" id="5047281">,</span>&nbsp;<span class="string" id="5047283">&#34;/&#34;</span><span class="op" id="5047286">)</span>&nbsp;<span class="op" id="5047288">+</span>&nbsp;<span class="ident" id="5047290">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047302">ff</span><span class="op" id="5047304">,</span>&nbsp;<span class="ident" id="5047306">err</span>&nbsp;<span class="op" id="5047310">:=</span>&nbsp;<span class="ident" id="5047313">fs</span><span class="op" id="5047315">.</span><span class="ident" id="5047316">Open</span><span class="op" id="5047320">(</span><span class="ident" id="5047321">index</span><span class="op" id="5047326">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047330">if</span>&nbsp;<span class="ident" id="5047333">err</span>&nbsp;<span class="op" id="5047337">==</span>&nbsp;<span class="ident" id="5047340">nil</span>&nbsp;<span class="op" id="5047344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047349">defer</span>&nbsp;<span class="ident" id="5047355">ff</span><span class="op" id="5047357">.</span><span class="ident" id="5047358">Close</span><span class="op" id="5047363">(</span><span class="op" id="5047364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047369">dd</span><span class="op" id="5047371">,</span>&nbsp;<span class="ident" id="5047373">err</span>&nbsp;<span class="op" id="5047377">:=</span>&nbsp;<span class="ident" id="5047380">ff</span><span class="op" id="5047382">.</span><span class="ident" id="5047383">Stat</span><span class="op" id="5047387">(</span><span class="op" id="5047388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047393">if</span>&nbsp;<span class="ident" id="5047396">err</span>&nbsp;<span class="op" id="5047400">==</span>&nbsp;<span class="ident" id="5047403">nil</span>&nbsp;<span class="op" id="5047407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047413">name</span>&nbsp;<span class="op" id="5047418">=</span>&nbsp;<span class="ident" id="5047420">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047430">d</span>&nbsp;<span class="op" id="5047432">=</span>&nbsp;<span class="ident" id="5047434">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047441">f</span>&nbsp;<span class="op" id="5047443">=</span>&nbsp;<span class="ident" id="5047445">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047458">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5047462">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047521">if</span>&nbsp;<span class="ident" id="5047524">d</span><span class="op" id="5047525">.</span><span class="ident" id="5047526">IsDir</span><span class="op" id="5047531">(</span><span class="op" id="5047532">)</span>&nbsp;<span class="op" id="5047534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047538">if</span>&nbsp;<span class="ident" id="5047541">checkLastModified</span><span class="op" id="5047558">(</span><span class="ident" id="5047559">w</span><span class="op" id="5047560">,</span>&nbsp;<span class="ident" id="5047562">r</span><span class="op" id="5047563">,</span>&nbsp;<span class="ident" id="5047565">d</span><span class="op" id="5047566">.</span><span class="ident" id="5047567">ModTime</span><span class="op" id="5047574">(</span><span class="op" id="5047575">)</span><span class="op" id="5047576">)</span>&nbsp;<span class="op" id="5047578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047583">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047596">dirList</span><span class="op" id="5047603">(</span><span class="ident" id="5047604">w</span><span class="op" id="5047605">,</span>&nbsp;<span class="ident" id="5047607">f</span><span class="op" id="5047608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047612">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5047624">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047670">sizeFunc</span>&nbsp;<span class="op" id="5047679">:=</span>&nbsp;<span class="keyword" id="5047682">func</span><span class="op" id="5047686">(</span><span class="op" id="5047687">)</span>&nbsp;<span class="op" id="5047689">(</span><span class="ident" id="5047690">int64</span><span class="op" id="5047695">,</span>&nbsp;<span class="builtintype" id="5047697">error</span><span class="op" id="5047702">)</span>&nbsp;<span class="op" id="5047704">{</span>&nbsp;<span class="keyword" id="5047706">return</span>&nbsp;<span class="ident" id="5047713">d</span><span class="op" id="5047714">.</span><span class="ident" id="5047715">Size</span><span class="op" id="5047719">(</span><span class="op" id="5047720">)</span><span class="op" id="5047721">,</span>&nbsp;<span class="ident" id="5047723">nil</span>&nbsp;<span class="op" id="5047727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047730">serveContent</span><span class="op" id="5047742">(</span><span class="ident" id="5047743">w</span><span class="op" id="5047744">,</span>&nbsp;<span class="ident" id="5047746">r</span><span class="op" id="5047747">,</span>&nbsp;<span class="ident" id="5047749">d</span><span class="op" id="5047750">.</span><span class="ident" id="5047751">Name</span><span class="op" id="5047755">(</span><span class="op" id="5047756">)</span><span class="op" id="5047757">,</span>&nbsp;<span class="ident" id="5047759">d</span><span class="op" id="5047760">.</span><span class="ident" id="5047761">ModTime</span><span class="op" id="5047768">(</span><span class="op" id="5047769">)</span><span class="op" id="5047770">,</span>&nbsp;<span class="ident" id="5047772">sizeFunc</span><span class="op" id="5047780">,</span>&nbsp;<span class="ident" id="5047782">f</span><span class="op" id="5047783">)</span><br>
<span class="lineno"></span><span class="op" id="5047785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="5047788">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="5047841">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="5047917">func</span>&nbsp;<span class="ident" id="5047922">localRedirect</span><span class="op" id="5047935">(</span><span class="ident" id="5047936">w</span>&nbsp;<span class="ident" id="5047938">ResponseWriter</span><span class="op" id="5047952">,</span>&nbsp;<span class="ident" id="5047954">r</span>&nbsp;<span class="op" id="5047956">*</span><span class="ident" id="5047957">Request</span><span class="op" id="5047964">,</span>&nbsp;<span class="ident" id="5047966">newPath</span>&nbsp;<span class="builtintype" id="5047974">string</span><span class="op" id="5047980">)</span>&nbsp;<span class="op" id="5047982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047985">if</span>&nbsp;<span class="ident" id="5047988">q</span>&nbsp;<span class="op" id="5047990">:=</span>&nbsp;<span class="ident" id="5047993">r</span><span class="op" id="5047994">.</span><span class="ident" id="5047995">URL</span><span class="op" id="5047998">.</span><span class="ident" id="5047999">RawQuery</span><span class="op" id="5048007">;</span>&nbsp;<span class="ident" id="5048009">q</span>&nbsp;<span class="op" id="5048011">!=</span>&nbsp;<span class="string" id="5048014">&#34;&#34;</span>&nbsp;<span class="op" id="5048017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048021">newPath</span>&nbsp;<span class="op" id="5048029">+=</span>&nbsp;<span class="string" id="5048032">&#34;?&#34;</span>&nbsp;<span class="op" id="5048036">+</span>&nbsp;<span class="ident" id="5048038">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5048041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048044">w</span><span class="op" id="5048045">.</span><span class="ident" id="5048046">Header</span><span class="op" id="5048052">(</span><span class="op" id="5048053">)</span><span class="op" id="5048054">.</span><span class="ident" id="5048055">Set</span><span class="op" id="5048058">(</span><span class="string" id="5048059">&#34;Location&#34;</span><span class="op" id="5048069">,</span>&nbsp;<span class="ident" id="5048071">newPath</span><span class="op" id="5048078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048081">w</span><span class="op" id="5048082">.</span><span class="ident" id="5048083">WriteHeader</span><span class="op" id="5048094">(</span><span class="ident" id="5048095">StatusMovedPermanently</span><span class="op" id="5048117">)</span><br>
<span class="lineno"></span><span class="op" id="5048119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="5048122">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="5048208">func</span>&nbsp;<span class="ident" id="5048213">ServeFile</span><span class="op" id="5048222">(</span><span class="ident" id="5048223">w</span>&nbsp;<span class="ident" id="5048225">ResponseWriter</span><span class="op" id="5048239">,</span>&nbsp;<span class="ident" id="5048241">r</span>&nbsp;<span class="op" id="5048243">*</span><span class="ident" id="5048244">Request</span><span class="op" id="5048251">,</span>&nbsp;<span class="ident" id="5048253">name</span>&nbsp;<span class="builtintype" id="5048258">string</span><span class="op" id="5048264">)</span>&nbsp;<span class="op" id="5048266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048269">dir</span><span class="op" id="5048272">,</span>&nbsp;<span class="ident" id="5048274">file</span>&nbsp;<span class="op" id="5048279">:=</span>&nbsp;<span class="ident" id="5048282">filepath</span><span class="op" id="5048290">.</span><span class="ident" id="5048291">Split</span><span class="op" id="5048296">(</span><span class="ident" id="5048297">name</span><span class="op" id="5048301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048304">serveFile</span><span class="op" id="5048313">(</span><span class="ident" id="5048314">w</span><span class="op" id="5048315">,</span>&nbsp;<span class="ident" id="5048317">r</span><span class="op" id="5048318">,</span>&nbsp;<span class="ident" id="5048320">Dir</span><span class="op" id="5048323">(</span><span class="ident" id="5048324">dir</span><span class="op" id="5048327">)</span><span class="op" id="5048328">,</span>&nbsp;<span class="ident" id="5048330">file</span><span class="op" id="5048334">,</span>&nbsp;<span class="builtintype" id="5048336">false</span><span class="op" id="5048341">)</span><br>
<span class="lineno"></span><span class="op" id="5048343">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5048346">type</span>&nbsp;<span class="ident" id="5048351">fileHandler</span>&nbsp;<span class="keyword" id="5048363">struct</span>&nbsp;<span class="op" id="5048370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048373">root</span>&nbsp;<span class="ident" id="5048378">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="5048389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="5048392">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5048450">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="5048506">//</span><br>
<span class="lineno"></span><span class="comment" id="5048509">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="5048570">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="5048587">//</span><br>
<span class="lineno"></span><span class="comment" id="5048590">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="5048649">func</span>&nbsp;<span class="ident" id="5048654">FileServer</span><span class="op" id="5048664">(</span><span class="ident" id="5048665">root</span>&nbsp;<span class="ident" id="5048670">FileSystem</span><span class="op" id="5048680">)</span>&nbsp;<span class="ident" id="5048682">Handler</span>&nbsp;<span class="op" id="5048690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048693">return</span>&nbsp;<span class="op" id="5048700">&amp;</span><span class="ident" id="5048701">fileHandler</span><span class="op" id="5048712">{</span><span class="ident" id="5048713">root</span><span class="op" id="5048717">}</span><br>
<span class="lineno"></span><span class="op" id="5048719">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="5048722">func</span>&nbsp;<span class="op" id="5048727">(</span><span class="ident" id="5048728">f</span>&nbsp;<span class="op" id="5048730">*</span><span class="ident" id="5048731">fileHandler</span><span class="op" id="5048742">)</span>&nbsp;<span class="ident" id="5048744">ServeHTTP</span><span class="op" id="5048753">(</span><span class="ident" id="5048754">w</span>&nbsp;<span class="ident" id="5048756">ResponseWriter</span><span class="op" id="5048770">,</span>&nbsp;<span class="ident" id="5048772">r</span>&nbsp;<span class="op" id="5048774">*</span><span class="ident" id="5048775">Request</span><span class="op" id="5048782">)</span>&nbsp;<span class="op" id="5048784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048787">upath</span>&nbsp;<span class="op" id="5048793">:=</span>&nbsp;<span class="ident" id="5048796">r</span><span class="op" id="5048797">.</span><span class="ident" id="5048798">URL</span><span class="op" id="5048801">.</span><span class="ident" id="5048802">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048808">if</span>&nbsp;<span class="op" id="5048811">!</span><span class="ident" id="5048812">strings</span><span class="op" id="5048819">.</span><span class="ident" id="5048820">HasPrefix</span><span class="op" id="5048829">(</span><span class="ident" id="5048830">upath</span><span class="op" id="5048835">,</span>&nbsp;<span class="string" id="5048837">&#34;/&#34;</span><span class="op" id="5048840">)</span>&nbsp;<span class="op" id="5048842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048846">upath</span>&nbsp;<span class="op" id="5048852">=</span>&nbsp;<span class="string" id="5048854">&#34;/&#34;</span>&nbsp;<span class="op" id="5048858">+</span>&nbsp;<span class="ident" id="5048860">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048868">r</span><span class="op" id="5048869">.</span><span class="ident" id="5048870">URL</span><span class="op" id="5048873">.</span><span class="ident" id="5048874">Path</span>&nbsp;<span class="op" id="5048879">=</span>&nbsp;<span class="ident" id="5048881">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5048888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048891">serveFile</span><span class="op" id="5048900">(</span><span class="ident" id="5048901">w</span><span class="op" id="5048902">,</span>&nbsp;<span class="ident" id="5048904">r</span><span class="op" id="5048905">,</span>&nbsp;<span class="ident" id="5048907">f</span><span class="op" id="5048908">.</span><span class="ident" id="5048909">root</span><span class="op" id="5048913">,</span>&nbsp;<span class="ident" id="5048915">path</span><span class="op" id="5048919">.</span><span class="ident" id="5048920">Clean</span><span class="op" id="5048925">(</span><span class="ident" id="5048926">upath</span><span class="op" id="5048931">)</span><span class="op" id="5048932">,</span>&nbsp;<span class="builtintype" id="5048934">true</span><span class="op" id="5048938">)</span><br>
<span class="lineno"></span><span class="op" id="5048940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="5048943">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="5049007">type</span>&nbsp;<span class="ident" id="5049012">httpRange</span>&nbsp;<span class="keyword" id="5049022">struct</span>&nbsp;<span class="op" id="5049029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049032">start</span><span class="op" id="5049037">,</span>&nbsp;<span class="ident" id="5049039">length</span>&nbsp;<span class="ident" id="5049046">int64</span><br>
<span class="lineno"></span><span class="op" id="5049052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="5049055">func</span>&nbsp;<span class="op" id="5049060">(</span><span class="ident" id="5049061">r</span>&nbsp;<span class="ident" id="5049063">httpRange</span><span class="op" id="5049072">)</span>&nbsp;<span class="ident" id="5049074">contentRange</span><span class="op" id="5049086">(</span><span class="ident" id="5049087">size</span>&nbsp;<span class="ident" id="5049092">int64</span><span class="op" id="5049097">)</span>&nbsp;<span class="builtintype" id="5049099">string</span>&nbsp;<span class="op" id="5049106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049109">return</span>&nbsp;<span class="ident" id="5049116">fmt</span><span class="op" id="5049119">.</span><span class="ident" id="5049120">Sprintf</span><span class="op" id="5049127">(</span><span class="string" id="5049128">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="5049144">,</span>&nbsp;<span class="ident" id="5049146">r</span><span class="op" id="5049147">.</span><span class="ident" id="5049148">start</span><span class="op" id="5049153">,</span>&nbsp;<span class="ident" id="5049155">r</span><span class="op" id="5049156">.</span><span class="ident" id="5049157">start</span><span class="op" id="5049162">+</span><span class="ident" id="5049163">r</span><span class="op" id="5049164">.</span><span class="ident" id="5049165">length</span><span class="op" id="5049171">-</span><span class="num" id="5049172">1</span><span class="op" id="5049173">,</span>&nbsp;<span class="ident" id="5049175">size</span><span class="op" id="5049179">)</span><br>
<span class="lineno"></span><span class="op" id="5049181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5049184">func</span>&nbsp;<span class="op" id="5049189">(</span><span class="ident" id="5049190">r</span>&nbsp;<span class="ident" id="5049192">httpRange</span><span class="op" id="5049201">)</span>&nbsp;<span class="ident" id="5049203">mimeHeader</span><span class="op" id="5049213">(</span><span class="ident" id="5049214">contentType</span>&nbsp;<span class="builtintype" id="5049226">string</span><span class="op" id="5049232">,</span>&nbsp;<span class="ident" id="5049234">size</span>&nbsp;<span class="ident" id="5049239">int64</span><span class="op" id="5049244">)</span>&nbsp;<span class="ident" id="5049246">textproto</span><span class="op" id="5049255">.</span><span class="ident" id="5049256">MIMEHeader</span>&nbsp;<span class="op" id="5049267">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049270">return</span>&nbsp;<span class="ident" id="5049277">textproto</span><span class="op" id="5049286">.</span><span class="ident" id="5049287">MIMEHeader</span><span class="op" id="5049297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049301">&#34;Content-Range&#34;</span><span class="op" id="5049316">:</span>&nbsp;<span class="op" id="5049318">{</span><span class="ident" id="5049319">r</span><span class="op" id="5049320">.</span><span class="ident" id="5049321">contentRange</span><span class="op" id="5049333">(</span><span class="ident" id="5049334">size</span><span class="op" id="5049338">)</span><span class="op" id="5049339">}</span><span class="op" id="5049340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5049344">&#34;Content-Type&#34;</span><span class="op" id="5049358">:</span>&nbsp;&nbsp;<span class="op" id="5049361">{</span><span class="ident" id="5049362">contentType</span><span class="op" id="5049373">}</span><span class="op" id="5049374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049377">}</span><br>
<span class="lineno"></span><span class="op" id="5049379">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="5049382">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="5049442">func</span>&nbsp;<span class="ident" id="5049447">parseRange</span><span class="op" id="5049457">(</span><span class="ident" id="5049458">s</span>&nbsp;<span class="builtintype" id="5049460">string</span><span class="op" id="5049466">,</span>&nbsp;<span class="ident" id="5049468">size</span>&nbsp;<span class="ident" id="5049473">int64</span><span class="op" id="5049478">)</span>&nbsp;<span class="op" id="5049480">(</span><span class="op" id="5049481">[</span><span class="op" id="5049482">]</span><span class="ident" id="5049483">httpRange</span><span class="op" id="5049492">,</span>&nbsp;<span class="builtintype" id="5049494">error</span><span class="op" id="5049499">)</span>&nbsp;<span class="op" id="5049501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049504">if</span>&nbsp;<span class="ident" id="5049507">s</span>&nbsp;<span class="op" id="5049509">==</span>&nbsp;<span class="string" id="5049512">&#34;&#34;</span>&nbsp;<span class="op" id="5049515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049519">return</span>&nbsp;<span class="ident" id="5049526">nil</span><span class="op" id="5049529">,</span>&nbsp;<span class="ident" id="5049531">nil</span>&nbsp;<span class="comment" id="5049535">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049561">const</span>&nbsp;<span class="ident" id="5049567">b</span>&nbsp;<span class="op" id="5049569">=</span>&nbsp;<span class="string" id="5049571">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049581">if</span>&nbsp;<span class="op" id="5049584">!</span><span class="ident" id="5049585">strings</span><span class="op" id="5049592">.</span><span class="ident" id="5049593">HasPrefix</span><span class="op" id="5049602">(</span><span class="ident" id="5049603">s</span><span class="op" id="5049604">,</span>&nbsp;<span class="ident" id="5049606">b</span><span class="op" id="5049607">)</span>&nbsp;<span class="op" id="5049609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049613">return</span>&nbsp;<span class="ident" id="5049620">nil</span><span class="op" id="5049623">,</span>&nbsp;<span class="ident" id="5049625">errors</span><span class="op" id="5049631">.</span><span class="ident" id="5049632">New</span><span class="op" id="5049635">(</span><span class="string" id="5049636">&#34;invalid&nbsp;range&#34;</span><span class="op" id="5049651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049654">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049657">var</span>&nbsp;<span class="ident" id="5049661">ranges</span>&nbsp;<span class="op" id="5049668">[</span><span class="op" id="5049669">]</span><span class="ident" id="5049670">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049681">for</span>&nbsp;<span class="ident" id="5049685">_</span><span class="op" id="5049686">,</span>&nbsp;<span class="ident" id="5049688">ra</span>&nbsp;<span class="op" id="5049691">:=</span>&nbsp;<span class="keyword" id="5049694">range</span>&nbsp;<span class="ident" id="5049700">strings</span><span class="op" id="5049707">.</span><span class="ident" id="5049708">Split</span><span class="op" id="5049713">(</span><span class="ident" id="5049714">s</span><span class="op" id="5049715">[</span><span class="builtinfunc" id="5049716">len</span><span class="op" id="5049719">(</span><span class="ident" id="5049720">b</span><span class="op" id="5049721">)</span><span class="op" id="5049722">:</span><span class="op" id="5049723">]</span><span class="op" id="5049724">,</span>&nbsp;<span class="string" id="5049726">&#34;,&#34;</span><span class="op" id="5049729">)</span>&nbsp;<span class="op" id="5049731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049735">ra</span>&nbsp;<span class="op" id="5049738">=</span>&nbsp;<span class="ident" id="5049740">strings</span><span class="op" id="5049747">.</span><span class="ident" id="5049748">TrimSpace</span><span class="op" id="5049757">(</span><span class="ident" id="5049758">ra</span><span class="op" id="5049760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049764">if</span>&nbsp;<span class="ident" id="5049767">ra</span>&nbsp;<span class="op" id="5049770">==</span>&nbsp;<span class="string" id="5049773">&#34;&#34;</span>&nbsp;<span class="op" id="5049776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049781">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049796">i</span>&nbsp;<span class="op" id="5049798">:=</span>&nbsp;<span class="ident" id="5049801">strings</span><span class="op" id="5049808">.</span><span class="ident" id="5049809">Index</span><span class="op" id="5049814">(</span><span class="ident" id="5049815">ra</span><span class="op" id="5049817">,</span>&nbsp;<span class="string" id="5049819">&#34;-&#34;</span><span class="op" id="5049822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049826">if</span>&nbsp;<span class="ident" id="5049829">i</span>&nbsp;<span class="op" id="5049831">&lt;</span>&nbsp;<span class="num" id="5049833">0</span>&nbsp;<span class="op" id="5049835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049840">return</span>&nbsp;<span class="ident" id="5049847">nil</span><span class="op" id="5049850">,</span>&nbsp;<span class="ident" id="5049852">errors</span><span class="op" id="5049858">.</span><span class="ident" id="5049859">New</span><span class="op" id="5049862">(</span><span class="string" id="5049863">&#34;invalid&nbsp;range&#34;</span><span class="op" id="5049878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049882">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049886">start</span><span class="op" id="5049891">,</span>&nbsp;<span class="ident" id="5049893">end</span>&nbsp;<span class="op" id="5049897">:=</span>&nbsp;<span class="ident" id="5049900">strings</span><span class="op" id="5049907">.</span><span class="ident" id="5049908">TrimSpace</span><span class="op" id="5049917">(</span><span class="ident" id="5049918">ra</span><span class="op" id="5049920">[</span><span class="op" id="5049921">:</span><span class="ident" id="5049922">i</span><span class="op" id="5049923">]</span><span class="op" id="5049924">)</span><span class="op" id="5049925">,</span>&nbsp;<span class="ident" id="5049927">strings</span><span class="op" id="5049934">.</span><span class="ident" id="5049935">TrimSpace</span><span class="op" id="5049944">(</span><span class="ident" id="5049945">ra</span><span class="op" id="5049947">[</span><span class="ident" id="5049948">i</span><span class="op" id="5049949">+</span><span class="num" id="5049950">1</span><span class="op" id="5049951">:</span><span class="op" id="5049952">]</span><span class="op" id="5049953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049957">var</span>&nbsp;<span class="ident" id="5049961">r</span>&nbsp;<span class="ident" id="5049963">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049975">if</span>&nbsp;<span class="ident" id="5049978">start</span>&nbsp;<span class="op" id="5049984">==</span>&nbsp;<span class="string" id="5049987">&#34;&#34;</span>&nbsp;<span class="op" id="5049990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5049995">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5050045">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050096">i</span><span class="op" id="5050097">,</span>&nbsp;<span class="ident" id="5050099">err</span>&nbsp;<span class="op" id="5050103">:=</span>&nbsp;<span class="ident" id="5050106">strconv</span><span class="op" id="5050113">.</span><span class="ident" id="5050114">ParseInt</span><span class="op" id="5050122">(</span><span class="ident" id="5050123">end</span><span class="op" id="5050126">,</span>&nbsp;<span class="num" id="5050128">10</span><span class="op" id="5050130">,</span>&nbsp;<span class="num" id="5050132">64</span><span class="op" id="5050134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050139">if</span>&nbsp;<span class="ident" id="5050142">err</span>&nbsp;<span class="op" id="5050146">!=</span>&nbsp;<span class="ident" id="5050149">nil</span>&nbsp;<span class="op" id="5050153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050159">return</span>&nbsp;<span class="ident" id="5050166">nil</span><span class="op" id="5050169">,</span>&nbsp;<span class="ident" id="5050171">errors</span><span class="op" id="5050177">.</span><span class="ident" id="5050178">New</span><span class="op" id="5050181">(</span><span class="string" id="5050182">&#34;invalid&nbsp;range&#34;</span><span class="op" id="5050197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050207">if</span>&nbsp;<span class="ident" id="5050210">i</span>&nbsp;<span class="op" id="5050212">&gt;</span>&nbsp;<span class="ident" id="5050214">size</span>&nbsp;<span class="op" id="5050219">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050225">i</span>&nbsp;<span class="op" id="5050227">=</span>&nbsp;<span class="ident" id="5050229">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050242">r</span><span class="op" id="5050243">.</span><span class="ident" id="5050244">start</span>&nbsp;<span class="op" id="5050250">=</span>&nbsp;<span class="ident" id="5050252">size</span>&nbsp;<span class="op" id="5050257">-</span>&nbsp;<span class="ident" id="5050259">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050264">r</span><span class="op" id="5050265">.</span><span class="ident" id="5050266">length</span>&nbsp;<span class="op" id="5050273">=</span>&nbsp;<span class="ident" id="5050275">size</span>&nbsp;<span class="op" id="5050280">-</span>&nbsp;<span class="ident" id="5050282">r</span><span class="op" id="5050283">.</span><span class="ident" id="5050284">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050292">}</span>&nbsp;<span class="keyword" id="5050294">else</span>&nbsp;<span class="op" id="5050299">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050304">i</span><span class="op" id="5050305">,</span>&nbsp;<span class="ident" id="5050307">err</span>&nbsp;<span class="op" id="5050311">:=</span>&nbsp;<span class="ident" id="5050314">strconv</span><span class="op" id="5050321">.</span><span class="ident" id="5050322">ParseInt</span><span class="op" id="5050330">(</span><span class="ident" id="5050331">start</span><span class="op" id="5050336">,</span>&nbsp;<span class="num" id="5050338">10</span><span class="op" id="5050340">,</span>&nbsp;<span class="num" id="5050342">64</span><span class="op" id="5050344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050349">if</span>&nbsp;<span class="ident" id="5050352">err</span>&nbsp;<span class="op" id="5050356">!=</span>&nbsp;<span class="ident" id="5050359">nil</span>&nbsp;<span class="op" id="5050363">||</span>&nbsp;<span class="ident" id="5050366">i</span>&nbsp;<span class="op" id="5050368">&gt;</span>&nbsp;<span class="ident" id="5050370">size</span>&nbsp;<span class="op" id="5050375">||</span>&nbsp;<span class="ident" id="5050378">i</span>&nbsp;<span class="op" id="5050380">&lt;</span>&nbsp;<span class="num" id="5050382">0</span>&nbsp;<span class="op" id="5050384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050390">return</span>&nbsp;<span class="ident" id="5050397">nil</span><span class="op" id="5050400">,</span>&nbsp;<span class="ident" id="5050402">errors</span><span class="op" id="5050408">.</span><span class="ident" id="5050409">New</span><span class="op" id="5050412">(</span><span class="string" id="5050413">&#34;invalid&nbsp;range&#34;</span><span class="op" id="5050428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050438">r</span><span class="op" id="5050439">.</span><span class="ident" id="5050440">start</span>&nbsp;<span class="op" id="5050446">=</span>&nbsp;<span class="ident" id="5050448">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050453">if</span>&nbsp;<span class="ident" id="5050456">end</span>&nbsp;<span class="op" id="5050460">==</span>&nbsp;<span class="string" id="5050463">&#34;&#34;</span>&nbsp;<span class="op" id="5050466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5050472">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050537">r</span><span class="op" id="5050538">.</span><span class="ident" id="5050539">length</span>&nbsp;<span class="op" id="5050546">=</span>&nbsp;<span class="ident" id="5050548">size</span>&nbsp;<span class="op" id="5050553">-</span>&nbsp;<span class="ident" id="5050555">r</span><span class="op" id="5050556">.</span><span class="ident" id="5050557">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050566">}</span>&nbsp;<span class="keyword" id="5050568">else</span>&nbsp;<span class="op" id="5050573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050579">i</span><span class="op" id="5050580">,</span>&nbsp;<span class="ident" id="5050582">err</span>&nbsp;<span class="op" id="5050586">:=</span>&nbsp;<span class="ident" id="5050589">strconv</span><span class="op" id="5050596">.</span><span class="ident" id="5050597">ParseInt</span><span class="op" id="5050605">(</span><span class="ident" id="5050606">end</span><span class="op" id="5050609">,</span>&nbsp;<span class="num" id="5050611">10</span><span class="op" id="5050613">,</span>&nbsp;<span class="num" id="5050615">64</span><span class="op" id="5050617">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050623">if</span>&nbsp;<span class="ident" id="5050626">err</span>&nbsp;<span class="op" id="5050630">!=</span>&nbsp;<span class="ident" id="5050633">nil</span>&nbsp;<span class="op" id="5050637">||</span>&nbsp;<span class="ident" id="5050640">r</span><span class="op" id="5050641">.</span><span class="ident" id="5050642">start</span>&nbsp;<span class="op" id="5050648">&gt;</span>&nbsp;<span class="ident" id="5050650">i</span>&nbsp;<span class="op" id="5050652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050659">return</span>&nbsp;<span class="ident" id="5050666">nil</span><span class="op" id="5050669">,</span>&nbsp;<span class="ident" id="5050671">errors</span><span class="op" id="5050677">.</span><span class="ident" id="5050678">New</span><span class="op" id="5050681">(</span><span class="string" id="5050682">&#34;invalid&nbsp;range&#34;</span><span class="op" id="5050697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050709">if</span>&nbsp;<span class="ident" id="5050712">i</span>&nbsp;<span class="op" id="5050714">&gt;=</span>&nbsp;<span class="ident" id="5050717">size</span>&nbsp;<span class="op" id="5050722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050729">i</span>&nbsp;<span class="op" id="5050731">=</span>&nbsp;<span class="ident" id="5050733">size</span>&nbsp;<span class="op" id="5050738">-</span>&nbsp;<span class="num" id="5050740">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050752">r</span><span class="op" id="5050753">.</span><span class="ident" id="5050754">length</span>&nbsp;<span class="op" id="5050761">=</span>&nbsp;<span class="ident" id="5050763">i</span>&nbsp;<span class="op" id="5050765">-</span>&nbsp;<span class="ident" id="5050767">r</span><span class="op" id="5050768">.</span><span class="ident" id="5050769">start</span>&nbsp;<span class="op" id="5050775">+</span>&nbsp;<span class="num" id="5050777">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050790">ranges</span>&nbsp;<span class="op" id="5050797">=</span>&nbsp;<span class="builtinfunc" id="5050799">append</span><span class="op" id="5050805">(</span><span class="ident" id="5050806">ranges</span><span class="op" id="5050812">,</span>&nbsp;<span class="ident" id="5050814">r</span><span class="op" id="5050815">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050821">return</span>&nbsp;<span class="ident" id="5050828">ranges</span><span class="op" id="5050834">,</span>&nbsp;<span class="ident" id="5050836">nil</span><br>
<span class="lineno"></span><span class="op" id="5050840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5050843">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="5050908">type</span>&nbsp;<span class="ident" id="5050913">countingWriter</span>&nbsp;<span class="ident" id="5050928">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5050935">func</span>&nbsp;<span class="op" id="5050940">(</span><span class="ident" id="5050941">w</span>&nbsp;<span class="op" id="5050943">*</span><span class="ident" id="5050944">countingWriter</span><span class="op" id="5050958">)</span>&nbsp;<span class="ident" id="5050960">Write</span><span class="op" id="5050965">(</span><span class="ident" id="5050966">p</span>&nbsp;<span class="op" id="5050968">[</span><span class="op" id="5050969">]</span><span class="builtintype" id="5050970">byte</span><span class="op" id="5050974">)</span>&nbsp;<span class="op" id="5050976">(</span><span class="ident" id="5050977">n</span>&nbsp;<span class="builtintype" id="5050979">int</span><span class="op" id="5050982">,</span>&nbsp;<span class="ident" id="5050984">err</span>&nbsp;<span class="builtintype" id="5050988">error</span><span class="op" id="5050993">)</span>&nbsp;<span class="op" id="5050995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050998">*</span><span class="ident" id="5050999">w</span>&nbsp;<span class="op" id="5051001">+=</span>&nbsp;<span class="ident" id="5051004">countingWriter</span><span class="op" id="5051018">(</span><span class="builtinfunc" id="5051019">len</span><span class="op" id="5051022">(</span><span class="ident" id="5051023">p</span><span class="op" id="5051024">)</span><span class="op" id="5051025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5051028">return</span>&nbsp;<span class="builtinfunc" id="5051035">len</span><span class="op" id="5051038">(</span><span class="ident" id="5051039">p</span><span class="op" id="5051040">)</span><span class="op" id="5051041">,</span>&nbsp;<span class="ident" id="5051043">nil</span><br>
<span class="lineno">535</span><span class="op" id="5051047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5051050">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5051119">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5051163">func</span>&nbsp;<span class="ident" id="5051168">rangesMIMESize</span><span class="op" id="5051182">(</span><span class="ident" id="5051183">ranges</span>&nbsp;<span class="op" id="5051190">[</span><span class="op" id="5051191">]</span><span class="ident" id="5051192">httpRange</span><span class="op" id="5051201">,</span>&nbsp;<span class="ident" id="5051203">contentType</span>&nbsp;<span class="builtintype" id="5051215">string</span><span class="op" id="5051221">,</span>&nbsp;<span class="ident" id="5051223">contentSize</span>&nbsp;<span class="ident" id="5051235">int64</span><span class="op" id="5051240">)</span>&nbsp;<span class="op" id="5051242">(</span><span class="ident" id="5051243">encSize</span>&nbsp;<span class="ident" id="5051251">int64</span><span class="op" id="5051256">)</span>&nbsp;<span class="op" id="5051258">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5051261">var</span>&nbsp;<span class="ident" id="5051265">w</span>&nbsp;<span class="ident" id="5051267">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051283">mw</span>&nbsp;<span class="op" id="5051286">:=</span>&nbsp;<span class="ident" id="5051289">multipart</span><span class="op" id="5051298">.</span><span class="ident" id="5051299">NewWriter</span><span class="op" id="5051308">(</span><span class="op" id="5051309">&amp;</span><span class="ident" id="5051310">w</span><span class="op" id="5051311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5051314">for</span>&nbsp;<span class="ident" id="5051318">_</span><span class="op" id="5051319">,</span>&nbsp;<span class="ident" id="5051321">ra</span>&nbsp;<span class="op" id="5051324">:=</span>&nbsp;<span class="keyword" id="5051327">range</span>&nbsp;<span class="ident" id="5051333">ranges</span>&nbsp;<span class="op" id="5051340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051344">mw</span><span class="op" id="5051346">.</span><span class="ident" id="5051347">CreatePart</span><span class="op" id="5051357">(</span><span class="ident" id="5051358">ra</span><span class="op" id="5051360">.</span><span class="ident" id="5051361">mimeHeader</span><span class="op" id="5051371">(</span><span class="ident" id="5051372">contentType</span><span class="op" id="5051383">,</span>&nbsp;<span class="ident" id="5051385">contentSize</span><span class="op" id="5051396">)</span><span class="op" id="5051397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051401">encSize</span>&nbsp;<span class="op" id="5051409">+=</span>&nbsp;<span class="ident" id="5051412">ra</span><span class="op" id="5051414">.</span><span class="ident" id="5051415">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5051423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051426">mw</span><span class="op" id="5051428">.</span><span class="ident" id="5051429">Close</span><span class="op" id="5051434">(</span><span class="op" id="5051435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051438">encSize</span>&nbsp;<span class="op" id="5051446">+=</span>&nbsp;<span class="ident" id="5051449">int64</span><span class="op" id="5051454">(</span><span class="ident" id="5051455">w</span><span class="op" id="5051456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5051459">return</span><br>
<span class="lineno"></span><span class="op" id="5051466">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="5051469">func</span>&nbsp;<span class="ident" id="5051474">sumRangesSize</span><span class="op" id="5051487">(</span><span class="ident" id="5051488">ranges</span>&nbsp;<span class="op" id="5051495">[</span><span class="op" id="5051496">]</span><span class="ident" id="5051497">httpRange</span><span class="op" id="5051506">)</span>&nbsp;<span class="op" id="5051508">(</span><span class="ident" id="5051509">size</span>&nbsp;<span class="ident" id="5051514">int64</span><span class="op" id="5051519">)</span>&nbsp;<span class="op" id="5051521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5051524">for</span>&nbsp;<span class="ident" id="5051528">_</span><span class="op" id="5051529">,</span>&nbsp;<span class="ident" id="5051531">ra</span>&nbsp;<span class="op" id="5051534">:=</span>&nbsp;<span class="keyword" id="5051537">range</span>&nbsp;<span class="ident" id="5051543">ranges</span>&nbsp;<span class="op" id="5051550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5051554">size</span>&nbsp;<span class="op" id="5051559">+=</span>&nbsp;<span class="ident" id="5051562">ra</span><span class="op" id="5051564">.</span><span class="ident" id="5051565">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5051573">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5051576">return</span><br>
<span class="lineno"></span><span class="op" id="5051583">}</span>
</div>
</body>
</html>
