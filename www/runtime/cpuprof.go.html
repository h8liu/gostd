<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1495439">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1495495">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1495549">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1495600">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1495618">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1495669">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1495716">//</span><br>
<span class="lineno"></span><span class="comment" id="1495719">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1495785">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1495856">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1495925">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1495964">//</span><br>
<span class="lineno"></span><span class="comment" id="1495967">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1496041">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1496113">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1496182">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1496254">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1496321">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1496397">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1496469">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1496543">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1496621">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1496699">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1496779">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1496850">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1496928">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1497001">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1497023">//</span><br>
<span class="lineno">30</span><span class="comment" id="1497026">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1497098">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1497179">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1497256">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1497326">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1497399">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1497475">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1497549">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1497630">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1497714">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1497796">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1497835">//</span><br>
<span class="lineno"></span><span class="comment" id="1497838">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1497899">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1497977">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1498043">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1498116">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1498190">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1498263">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1498339">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1498404">package</span>&nbsp;<span class="ident" id="1498412">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1498421">import</span>&nbsp;<span class="string" id="1498428">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1498438">const</span>&nbsp;<span class="op" id="1498444">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498447">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498463">=</span>&nbsp;<span class="num" id="1498465">1</span>&nbsp;<span class="op" id="1498467">&lt;&lt;</span>&nbsp;<span class="num" id="1498470">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498474">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498490">=</span>&nbsp;<span class="num" id="1498492">1</span>&nbsp;<span class="op" id="1498494">&lt;&lt;</span>&nbsp;<span class="num" id="1498497">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498501">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498517">=</span>&nbsp;<span class="num" id="1498519">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498522">maxCPUProfStack</span>&nbsp;<span class="op" id="1498538">=</span>&nbsp;<span class="num" id="1498540">64</span><br>
<span class="lineno">60</span><span class="op" id="1498543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1498546">type</span>&nbsp;<span class="ident" id="1498551">cpuprofEntry</span>&nbsp;<span class="keyword" id="1498564">struct</span>&nbsp;<span class="op" id="1498571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498574">count</span>&nbsp;<span class="builtintype" id="1498580">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498589">depth</span>&nbsp;<span class="builtintype" id="1498595">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498604">stack</span>&nbsp;<span class="op" id="1498610">[</span><span class="ident" id="1498611">maxCPUProfStack</span><span class="op" id="1498626">]</span><span class="builtintype" id="1498627">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1498635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1498638">type</span>&nbsp;<span class="ident" id="1498643">cpuProfile</span>&nbsp;<span class="keyword" id="1498654">struct</span>&nbsp;<span class="op" id="1498661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498664">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1498671">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498679">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498699">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1498706">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498714">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498739">count</span>&nbsp;&nbsp;<span class="builtintype" id="1498746">uintptr</span>&nbsp;<span class="comment" id="1498754">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498769">evicts</span>&nbsp;<span class="builtintype" id="1498776">uintptr</span>&nbsp;<span class="comment" id="1498784">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498803">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1498810">uintptr</span>&nbsp;<span class="comment" id="1498818">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498857">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498889">hash</span>&nbsp;<span class="op" id="1498894">[</span><span class="ident" id="1498895">numBuckets</span><span class="op" id="1498905">]</span><span class="keyword" id="1498906">struct</span>&nbsp;<span class="op" id="1498913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498917">entry</span>&nbsp;<span class="op" id="1498923">[</span><span class="ident" id="1498924">assoc</span><span class="op" id="1498929">]</span><span class="ident" id="1498930">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498948">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498985">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499035">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499085">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499093">[</span><span class="num" id="1499094">2</span><span class="op" id="1499095">]</span><span class="op" id="1499096">[</span><span class="ident" id="1499097">logSize</span>&nbsp;<span class="op" id="1499105">/</span>&nbsp;<span class="num" id="1499107">2</span><span class="op" id="1499108">]</span><span class="builtintype" id="1499109">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499118">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1499126">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499135">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1499143">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499150">handoff</span>&nbsp;<span class="builtintype" id="1499158">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499167">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499185">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499236">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499276">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1499285">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499293">wholding</span>&nbsp;<span class="builtintype" id="1499302">bool</span>&nbsp;<span class="comment" id="1499307">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499348">flushing</span>&nbsp;<span class="builtintype" id="1499357">bool</span>&nbsp;<span class="comment" id="1499362">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499404">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1499413">bool</span>&nbsp;<span class="comment" id="1499418">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1499466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1499469">var</span>&nbsp;<span class="op" id="1499473">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499476">cpuprofLock</span>&nbsp;<span class="ident" id="1499488">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499495">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499507">*</span><span class="ident" id="1499508">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499521">eod</span>&nbsp;<span class="op" id="1499525">=</span>&nbsp;<span class="op" id="1499527">[</span><span class="num" id="1499528">3</span><span class="op" id="1499529">]</span><span class="builtintype" id="1499530">uintptr</span><span class="op" id="1499537">{</span><span class="num" id="1499538">0</span><span class="op" id="1499539">,</span>&nbsp;<span class="num" id="1499541">1</span><span class="op" id="1499542">,</span>&nbsp;<span class="num" id="1499544">0</span><span class="op" id="1499545">}</span><br>
<span class="lineno"></span><span class="op" id="1499547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1499550">func</span>&nbsp;<span class="ident" id="1499555">setcpuprofilerate_m</span><span class="op" id="1499574">(</span><span class="op" id="1499575">)</span>&nbsp;<span class="comment" id="1499577">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1499588">func</span>&nbsp;<span class="ident" id="1499593">setcpuprofilerate</span><span class="op" id="1499610">(</span><span class="ident" id="1499611">hz</span>&nbsp;<span class="builtintype" id="1499614">int32</span><span class="op" id="1499619">)</span>&nbsp;<span class="op" id="1499621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499624">g</span>&nbsp;<span class="op" id="1499626">:=</span>&nbsp;<span class="ident" id="1499629">getg</span><span class="op" id="1499633">(</span><span class="op" id="1499634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499637">g</span><span class="op" id="1499638">.</span><span class="ident" id="1499639">m</span><span class="op" id="1499640">.</span><span class="ident" id="1499641">scalararg</span><span class="op" id="1499650">[</span><span class="num" id="1499651">0</span><span class="op" id="1499652">]</span>&nbsp;<span class="op" id="1499654">=</span>&nbsp;<span class="builtintype" id="1499656">uintptr</span><span class="op" id="1499663">(</span><span class="ident" id="1499664">hz</span><span class="op" id="1499666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499669">onM</span><span class="op" id="1499672">(</span><span class="ident" id="1499673">setcpuprofilerate_m</span><span class="op" id="1499692">)</span><br>
<span class="lineno">110</span><span class="op" id="1499694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1499697">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1499753">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1499811">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1499850">func</span>&nbsp;<span class="ident" id="1499855">lostProfileData</span><span class="op" id="1499870">(</span><span class="op" id="1499871">)</span>&nbsp;<span class="op" id="1499873">{</span><span class="op" id="1499874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1499877">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1499952">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1500006">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1500089">//</span><br>
<span class="lineno"></span><span class="comment" id="1500092">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1500148">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1500214">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1500245">func</span>&nbsp;<span class="ident" id="1500250">SetCPUProfileRate</span><span class="op" id="1500267">(</span><span class="ident" id="1500268">hz</span>&nbsp;<span class="builtintype" id="1500271">int</span><span class="op" id="1500274">)</span>&nbsp;<span class="op" id="1500276">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1500279">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500317">if</span>&nbsp;<span class="ident" id="1500320">hz</span>&nbsp;<span class="op" id="1500323">&lt;</span>&nbsp;<span class="num" id="1500325">0</span>&nbsp;<span class="op" id="1500327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500331">hz</span>&nbsp;<span class="op" id="1500334">=</span>&nbsp;<span class="num" id="1500336">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500342">if</span>&nbsp;<span class="ident" id="1500345">hz</span>&nbsp;<span class="op" id="1500348">&gt;</span>&nbsp;<span class="num" id="1500350">1000000</span>&nbsp;<span class="op" id="1500358">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500362">hz</span>&nbsp;<span class="op" id="1500365">=</span>&nbsp;<span class="num" id="1500367">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500380">lock</span><span class="op" id="1500384">(</span><span class="op" id="1500385">&amp;</span><span class="ident" id="1500386">cpuprofLock</span><span class="op" id="1500397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500400">if</span>&nbsp;<span class="ident" id="1500403">hz</span>&nbsp;<span class="op" id="1500406">&gt;</span>&nbsp;<span class="num" id="1500408">0</span>&nbsp;<span class="op" id="1500410">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500414">if</span>&nbsp;<span class="ident" id="1500417">cpuprof</span>&nbsp;<span class="op" id="1500425">==</span>&nbsp;<span class="ident" id="1500428">nil</span>&nbsp;<span class="op" id="1500432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500437">cpuprof</span>&nbsp;<span class="op" id="1500445">=</span>&nbsp;<span class="op" id="1500447">(</span><span class="op" id="1500448">*</span><span class="ident" id="1500449">cpuProfile</span><span class="op" id="1500459">)</span><span class="op" id="1500460">(</span><span class="ident" id="1500461">sysAlloc</span><span class="op" id="1500469">(</span><span class="ident" id="1500470">unsafe</span><span class="op" id="1500476">.</span><span class="ident" id="1500477">Sizeof</span><span class="op" id="1500483">(</span><span class="ident" id="1500484">cpuProfile</span><span class="op" id="1500494">{</span><span class="op" id="1500495">}</span><span class="op" id="1500496">)</span><span class="op" id="1500497">,</span>&nbsp;<span class="op" id="1500499">&amp;</span><span class="ident" id="1500500">memstats</span><span class="op" id="1500508">.</span><span class="ident" id="1500509">other_sys</span><span class="op" id="1500518">)</span><span class="op" id="1500519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500524">if</span>&nbsp;<span class="ident" id="1500527">cpuprof</span>&nbsp;<span class="op" id="1500535">==</span>&nbsp;<span class="ident" id="1500538">nil</span>&nbsp;<span class="op" id="1500542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1500548">print</span><span class="op" id="1500553">(</span><span class="string" id="1500554">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1500603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500609">unlock</span><span class="op" id="1500615">(</span><span class="op" id="1500616">&amp;</span><span class="ident" id="1500617">cpuprofLock</span><span class="op" id="1500628">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500634">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500652">if</span>&nbsp;<span class="ident" id="1500655">cpuprof</span><span class="op" id="1500662">.</span><span class="ident" id="1500663">on</span>&nbsp;<span class="op" id="1500666">||</span>&nbsp;<span class="ident" id="1500669">cpuprof</span><span class="op" id="1500676">.</span><span class="ident" id="1500677">handoff</span>&nbsp;<span class="op" id="1500685">!=</span>&nbsp;<span class="num" id="1500688">0</span>&nbsp;<span class="op" id="1500690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1500695">print</span><span class="op" id="1500700">(</span><span class="string" id="1500701">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1500778">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500783">unlock</span><span class="op" id="1500789">(</span><span class="op" id="1500790">&amp;</span><span class="ident" id="1500791">cpuprofLock</span><span class="op" id="1500802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500807">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500821">cpuprof</span><span class="op" id="1500828">.</span><span class="ident" id="1500829">on</span>&nbsp;<span class="op" id="1500832">=</span>&nbsp;<span class="ident" id="1500834">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1500841">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1500874">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500964">p</span>&nbsp;<span class="op" id="1500966">:=</span>&nbsp;<span class="op" id="1500969">&amp;</span><span class="ident" id="1500970">cpuprof</span><span class="op" id="1500977">.</span><span class="ident" id="1500978">log</span><span class="op" id="1500981">[</span><span class="num" id="1500982">0</span><span class="op" id="1500983">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500987">p</span><span class="op" id="1500988">[</span><span class="num" id="1500989">0</span><span class="op" id="1500990">]</span>&nbsp;<span class="op" id="1500992">=</span>&nbsp;<span class="num" id="1500994">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501012">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501034">p</span><span class="op" id="1501035">[</span><span class="num" id="1501036">1</span><span class="op" id="1501037">]</span>&nbsp;<span class="op" id="1501039">=</span>&nbsp;<span class="num" id="1501041">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501059">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501081">p</span><span class="op" id="1501082">[</span><span class="num" id="1501083">2</span><span class="op" id="1501084">]</span>&nbsp;<span class="op" id="1501086">=</span>&nbsp;<span class="num" id="1501088">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1501106">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501126">p</span><span class="op" id="1501127">[</span><span class="num" id="1501128">3</span><span class="op" id="1501129">]</span>&nbsp;<span class="op" id="1501131">=</span>&nbsp;<span class="builtintype" id="1501133">uintptr</span><span class="op" id="1501140">(</span><span class="num" id="1501141">1e6</span>&nbsp;<span class="op" id="1501145">/</span>&nbsp;<span class="ident" id="1501147">hz</span><span class="op" id="1501149">)</span>&nbsp;<span class="comment" id="1501151">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501178">p</span><span class="op" id="1501179">[</span><span class="num" id="1501180">4</span><span class="op" id="1501181">]</span>&nbsp;<span class="op" id="1501183">=</span>&nbsp;<span class="num" id="1501185">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501189">cpuprof</span><span class="op" id="1501196">.</span><span class="ident" id="1501197">nlog</span>&nbsp;<span class="op" id="1501202">=</span>&nbsp;<span class="num" id="1501204">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501208">cpuprof</span><span class="op" id="1501215">.</span><span class="ident" id="1501216">toggle</span>&nbsp;<span class="op" id="1501223">=</span>&nbsp;<span class="num" id="1501225">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501229">cpuprof</span><span class="op" id="1501236">.</span><span class="ident" id="1501237">wholding</span>&nbsp;<span class="op" id="1501246">=</span>&nbsp;<span class="ident" id="1501248">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501256">cpuprof</span><span class="op" id="1501263">.</span><span class="ident" id="1501264">wtoggle</span>&nbsp;<span class="op" id="1501272">=</span>&nbsp;<span class="num" id="1501274">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501278">cpuprof</span><span class="op" id="1501285">.</span><span class="ident" id="1501286">flushing</span>&nbsp;<span class="op" id="1501295">=</span>&nbsp;<span class="ident" id="1501297">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501305">cpuprof</span><span class="op" id="1501312">.</span><span class="ident" id="1501313">eodSent</span>&nbsp;<span class="op" id="1501321">=</span>&nbsp;<span class="ident" id="1501323">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501331">noteclear</span><span class="op" id="1501340">(</span><span class="op" id="1501341">&amp;</span><span class="ident" id="1501342">cpuprof</span><span class="op" id="1501349">.</span><span class="ident" id="1501350">wait</span><span class="op" id="1501354">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501359">setcpuprofilerate</span><span class="op" id="1501376">(</span><span class="builtintype" id="1501377">int32</span><span class="op" id="1501382">(</span><span class="ident" id="1501383">hz</span><span class="op" id="1501385">)</span><span class="op" id="1501386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501389">}</span>&nbsp;<span class="keyword" id="1501391">else</span>&nbsp;<span class="keyword" id="1501396">if</span>&nbsp;<span class="ident" id="1501399">cpuprof</span>&nbsp;<span class="op" id="1501407">!=</span>&nbsp;<span class="ident" id="1501410">nil</span>&nbsp;<span class="op" id="1501414">&amp;&amp;</span>&nbsp;<span class="ident" id="1501417">cpuprof</span><span class="op" id="1501424">.</span><span class="ident" id="1501425">on</span>&nbsp;<span class="op" id="1501428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501432">setcpuprofilerate</span><span class="op" id="1501449">(</span><span class="num" id="1501450">0</span><span class="op" id="1501451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501455">cpuprof</span><span class="op" id="1501462">.</span><span class="ident" id="1501463">on</span>&nbsp;<span class="op" id="1501466">=</span>&nbsp;<span class="ident" id="1501468">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501477">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501550">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501609">for</span>&nbsp;<span class="op" id="1501613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501618">n</span>&nbsp;<span class="op" id="1501620">:=</span>&nbsp;<span class="ident" id="1501623">cpuprof</span><span class="op" id="1501630">.</span><span class="ident" id="1501631">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501642">if</span>&nbsp;<span class="ident" id="1501645">n</span><span class="op" id="1501646">&amp;</span><span class="num" id="1501647">0x80000000</span>&nbsp;<span class="op" id="1501658">!=</span>&nbsp;<span class="num" id="1501661">0</span>&nbsp;<span class="op" id="1501663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1501669">print</span><span class="op" id="1501674">(</span><span class="string" id="1501675">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1501712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501722">if</span>&nbsp;<span class="ident" id="1501725">cas</span><span class="op" id="1501728">(</span><span class="op" id="1501729">&amp;</span><span class="ident" id="1501730">cpuprof</span><span class="op" id="1501737">.</span><span class="ident" id="1501738">handoff</span><span class="op" id="1501745">,</span>&nbsp;<span class="ident" id="1501747">n</span><span class="op" id="1501748">,</span>&nbsp;<span class="ident" id="1501750">n</span><span class="op" id="1501751">|</span><span class="num" id="1501752">0x80000000</span><span class="op" id="1501762">)</span>&nbsp;<span class="op" id="1501764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501770">if</span>&nbsp;<span class="ident" id="1501773">n</span>&nbsp;<span class="op" id="1501775">==</span>&nbsp;<span class="num" id="1501778">0</span>&nbsp;<span class="op" id="1501780">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501787">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501857">notewakeup</span><span class="op" id="1501867">(</span><span class="op" id="1501868">&amp;</span><span class="ident" id="1501869">cpuprof</span><span class="op" id="1501876">.</span><span class="ident" id="1501877">wait</span><span class="op" id="1501881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501893">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501902">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501912">unlock</span><span class="op" id="1501918">(</span><span class="op" id="1501919">&amp;</span><span class="ident" id="1501920">cpuprofLock</span><span class="op" id="1501931">)</span><br>
<span class="lineno"></span><span class="op" id="1501933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1501936">func</span>&nbsp;<span class="ident" id="1501941">cpuproftick</span><span class="op" id="1501952">(</span><span class="ident" id="1501953">pc</span>&nbsp;<span class="op" id="1501956">*</span><span class="builtintype" id="1501957">uintptr</span><span class="op" id="1501964">,</span>&nbsp;<span class="ident" id="1501966">n</span>&nbsp;<span class="builtintype" id="1501968">int32</span><span class="op" id="1501973">)</span>&nbsp;<span class="op" id="1501975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501978">if</span>&nbsp;<span class="ident" id="1501981">n</span>&nbsp;<span class="op" id="1501983">&gt;</span>&nbsp;<span class="ident" id="1501985">maxCPUProfStack</span>&nbsp;<span class="op" id="1502001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502005">n</span>&nbsp;<span class="op" id="1502007">=</span>&nbsp;<span class="ident" id="1502009">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502029">s</span>&nbsp;<span class="op" id="1502031">:=</span>&nbsp;<span class="op" id="1502034">(</span><span class="op" id="1502035">*</span><span class="op" id="1502036">[</span><span class="ident" id="1502037">maxCPUProfStack</span><span class="op" id="1502052">]</span><span class="builtintype" id="1502053">uintptr</span><span class="op" id="1502060">)</span><span class="op" id="1502061">(</span><span class="ident" id="1502062">unsafe</span><span class="op" id="1502068">.</span><span class="ident" id="1502069">Pointer</span><span class="op" id="1502076">(</span><span class="ident" id="1502077">pc</span><span class="op" id="1502079">)</span><span class="op" id="1502080">)</span><span class="op" id="1502081">[</span><span class="op" id="1502082">:</span><span class="ident" id="1502083">n</span><span class="op" id="1502084">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502087">cpuprof</span><span class="op" id="1502094">.</span><span class="ident" id="1502095">add</span><span class="op" id="1502098">(</span><span class="ident" id="1502099">s</span><span class="op" id="1502100">)</span><br>
<span class="lineno"></span><span class="op" id="1502102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1502105">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1502149">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1502217">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1502278">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1502348">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1502391">func</span>&nbsp;<span class="op" id="1502396">(</span><span class="ident" id="1502397">p</span>&nbsp;<span class="op" id="1502399">*</span><span class="ident" id="1502400">cpuProfile</span><span class="op" id="1502410">)</span>&nbsp;<span class="ident" id="1502412">add</span><span class="op" id="1502415">(</span><span class="ident" id="1502416">pc</span>&nbsp;<span class="op" id="1502419">[</span><span class="op" id="1502420">]</span><span class="builtintype" id="1502421">uintptr</span><span class="op" id="1502428">)</span>&nbsp;<span class="op" id="1502430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502433">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502451">h</span>&nbsp;<span class="op" id="1502453">:=</span>&nbsp;<span class="builtintype" id="1502456">uintptr</span><span class="op" id="1502463">(</span><span class="num" id="1502464">0</span><span class="op" id="1502465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502468">for</span>&nbsp;<span class="ident" id="1502472">_</span><span class="op" id="1502473">,</span>&nbsp;<span class="ident" id="1502475">x</span>&nbsp;<span class="op" id="1502477">:=</span>&nbsp;<span class="keyword" id="1502480">range</span>&nbsp;<span class="ident" id="1502486">pc</span>&nbsp;<span class="op" id="1502489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502493">h</span>&nbsp;<span class="op" id="1502495">=</span>&nbsp;<span class="ident" id="1502497">h</span><span class="op" id="1502498">&lt;&lt;</span><span class="num" id="1502500">8</span>&nbsp;<span class="op" id="1502502">|</span>&nbsp;<span class="op" id="1502504">(</span><span class="ident" id="1502505">h</span>&nbsp;<span class="op" id="1502507">&gt;&gt;</span>&nbsp;<span class="op" id="1502510">(</span><span class="num" id="1502511">8</span>&nbsp;<span class="op" id="1502513">*</span>&nbsp;<span class="op" id="1502515">(</span><span class="ident" id="1502516">unsafe</span><span class="op" id="1502522">.</span><span class="ident" id="1502523">Sizeof</span><span class="op" id="1502529">(</span><span class="ident" id="1502530">h</span><span class="op" id="1502531">)</span>&nbsp;<span class="op" id="1502533">-</span>&nbsp;<span class="num" id="1502535">1</span><span class="op" id="1502536">)</span><span class="op" id="1502537">)</span><span class="op" id="1502538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502542">h</span>&nbsp;<span class="op" id="1502544">+=</span>&nbsp;<span class="ident" id="1502547">x</span><span class="op" id="1502548">*</span><span class="num" id="1502549">31</span>&nbsp;<span class="op" id="1502552">+</span>&nbsp;<span class="ident" id="1502554">x</span><span class="op" id="1502555">*</span><span class="num" id="1502556">7</span>&nbsp;<span class="op" id="1502558">+</span>&nbsp;<span class="ident" id="1502560">x</span><span class="op" id="1502561">*</span><span class="num" id="1502562">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502565">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502568">p</span><span class="op" id="1502569">.</span><span class="ident" id="1502570">count</span><span class="op" id="1502575">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502580">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502632">b</span>&nbsp;<span class="op" id="1502634">:=</span>&nbsp;<span class="op" id="1502637">&amp;</span><span class="ident" id="1502638">p</span><span class="op" id="1502639">.</span><span class="ident" id="1502640">hash</span><span class="op" id="1502644">[</span><span class="ident" id="1502645">h</span><span class="op" id="1502646">%</span><span class="ident" id="1502647">numBuckets</span><span class="op" id="1502657">]</span><br>
<span class="lineno"></span><span class="ident" id="1502659">Assoc</span><span class="op" id="1502664">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502667">for</span>&nbsp;<span class="ident" id="1502671">i</span>&nbsp;<span class="op" id="1502673">:=</span>&nbsp;<span class="keyword" id="1502676">range</span>&nbsp;<span class="ident" id="1502682">b</span><span class="op" id="1502683">.</span><span class="ident" id="1502684">entry</span>&nbsp;<span class="op" id="1502690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502694">e</span>&nbsp;<span class="op" id="1502696">:=</span>&nbsp;<span class="op" id="1502699">&amp;</span><span class="ident" id="1502700">b</span><span class="op" id="1502701">.</span><span class="ident" id="1502702">entry</span><span class="op" id="1502707">[</span><span class="ident" id="1502708">i</span><span class="op" id="1502709">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502713">if</span>&nbsp;<span class="ident" id="1502716">e</span><span class="op" id="1502717">.</span><span class="ident" id="1502718">depth</span>&nbsp;<span class="op" id="1502724">!=</span>&nbsp;<span class="builtintype" id="1502727">uintptr</span><span class="op" id="1502734">(</span><span class="builtinfunc" id="1502735">len</span><span class="op" id="1502738">(</span><span class="ident" id="1502739">pc</span><span class="op" id="1502741">)</span><span class="op" id="1502742">)</span>&nbsp;<span class="op" id="1502744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502749">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502760">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502764">for</span>&nbsp;<span class="ident" id="1502768">j</span>&nbsp;<span class="op" id="1502770">:=</span>&nbsp;<span class="keyword" id="1502773">range</span>&nbsp;<span class="ident" id="1502779">pc</span>&nbsp;<span class="op" id="1502782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502787">if</span>&nbsp;<span class="ident" id="1502790">e</span><span class="op" id="1502791">.</span><span class="ident" id="1502792">stack</span><span class="op" id="1502797">[</span><span class="ident" id="1502798">j</span><span class="op" id="1502799">]</span>&nbsp;<span class="op" id="1502801">!=</span>&nbsp;<span class="ident" id="1502804">pc</span><span class="op" id="1502806">[</span><span class="ident" id="1502807">j</span><span class="op" id="1502808">]</span>&nbsp;<span class="op" id="1502810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502816">continue</span>&nbsp;<span class="ident" id="1502825">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502838">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502842">e</span><span class="op" id="1502843">.</span><span class="ident" id="1502844">count</span><span class="op" id="1502849">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502854">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502866">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502903">var</span>&nbsp;<span class="ident" id="1502907">e</span>&nbsp;<span class="op" id="1502909">*</span><span class="ident" id="1502910">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502924">for</span>&nbsp;<span class="ident" id="1502928">i</span>&nbsp;<span class="op" id="1502930">:=</span>&nbsp;<span class="keyword" id="1502933">range</span>&nbsp;<span class="ident" id="1502939">b</span><span class="op" id="1502940">.</span><span class="ident" id="1502941">entry</span>&nbsp;<span class="op" id="1502947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502951">if</span>&nbsp;<span class="ident" id="1502954">e</span>&nbsp;<span class="op" id="1502956">==</span>&nbsp;<span class="ident" id="1502959">nil</span>&nbsp;<span class="op" id="1502963">||</span>&nbsp;<span class="ident" id="1502966">b</span><span class="op" id="1502967">.</span><span class="ident" id="1502968">entry</span><span class="op" id="1502973">[</span><span class="ident" id="1502974">i</span><span class="op" id="1502975">]</span><span class="op" id="1502976">.</span><span class="ident" id="1502977">count</span>&nbsp;<span class="op" id="1502983">&lt;</span>&nbsp;<span class="ident" id="1502985">e</span><span class="op" id="1502986">.</span><span class="ident" id="1502987">count</span>&nbsp;<span class="op" id="1502993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502998">e</span>&nbsp;<span class="op" id="1503000">=</span>&nbsp;<span class="op" id="1503002">&amp;</span><span class="ident" id="1503003">b</span><span class="op" id="1503004">.</span><span class="ident" id="1503005">entry</span><span class="op" id="1503010">[</span><span class="ident" id="1503011">i</span><span class="op" id="1503012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503016">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503022">if</span>&nbsp;<span class="ident" id="1503025">e</span><span class="op" id="1503026">.</span><span class="ident" id="1503027">count</span>&nbsp;<span class="op" id="1503033">&gt;</span>&nbsp;<span class="num" id="1503035">0</span>&nbsp;<span class="op" id="1503037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503041">if</span>&nbsp;<span class="op" id="1503044">!</span><span class="ident" id="1503045">p</span><span class="op" id="1503046">.</span><span class="ident" id="1503047">evict</span><span class="op" id="1503052">(</span><span class="ident" id="1503053">e</span><span class="op" id="1503054">)</span>&nbsp;<span class="op" id="1503056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503061">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503110">p</span><span class="op" id="1503111">.</span><span class="ident" id="1503112">lost</span><span class="op" id="1503116">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503135">p</span><span class="op" id="1503136">.</span><span class="ident" id="1503137">evicts</span><span class="op" id="1503143">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503151">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503186">e</span><span class="op" id="1503187">.</span><span class="ident" id="1503188">depth</span>&nbsp;<span class="op" id="1503194">=</span>&nbsp;<span class="builtintype" id="1503196">uintptr</span><span class="op" id="1503203">(</span><span class="builtinfunc" id="1503204">len</span><span class="op" id="1503207">(</span><span class="ident" id="1503208">pc</span><span class="op" id="1503210">)</span><span class="op" id="1503211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503214">e</span><span class="op" id="1503215">.</span><span class="ident" id="1503216">count</span>&nbsp;<span class="op" id="1503222">=</span>&nbsp;<span class="num" id="1503224">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1503227">copy</span><span class="op" id="1503231">(</span><span class="ident" id="1503232">e</span><span class="op" id="1503233">.</span><span class="ident" id="1503234">stack</span><span class="op" id="1503239">[</span><span class="op" id="1503240">:</span><span class="op" id="1503241">]</span><span class="op" id="1503242">,</span>&nbsp;<span class="ident" id="1503244">pc</span><span class="op" id="1503246">)</span><br>
<span class="lineno"></span><span class="op" id="1503248">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1503251">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1503312">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1503373">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1503436">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1503495">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1503553">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1503594">func</span>&nbsp;<span class="op" id="1503599">(</span><span class="ident" id="1503600">p</span>&nbsp;<span class="op" id="1503602">*</span><span class="ident" id="1503603">cpuProfile</span><span class="op" id="1503613">)</span>&nbsp;<span class="ident" id="1503615">evict</span><span class="op" id="1503620">(</span><span class="ident" id="1503621">e</span>&nbsp;<span class="op" id="1503623">*</span><span class="ident" id="1503624">cpuprofEntry</span><span class="op" id="1503636">)</span>&nbsp;<span class="builtintype" id="1503638">bool</span>&nbsp;<span class="op" id="1503643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503646">d</span>&nbsp;<span class="op" id="1503648">:=</span>&nbsp;<span class="ident" id="1503651">e</span><span class="op" id="1503652">.</span><span class="ident" id="1503653">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503660">nslot</span>&nbsp;<span class="op" id="1503666">:=</span>&nbsp;<span class="ident" id="1503669">d</span>&nbsp;<span class="op" id="1503671">+</span>&nbsp;<span class="num" id="1503673">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503676">log</span>&nbsp;<span class="op" id="1503680">:=</span>&nbsp;<span class="op" id="1503683">&amp;</span><span class="ident" id="1503684">p</span><span class="op" id="1503685">.</span><span class="ident" id="1503686">log</span><span class="op" id="1503689">[</span><span class="ident" id="1503690">p</span><span class="op" id="1503691">.</span><span class="ident" id="1503692">toggle</span><span class="op" id="1503698">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503701">if</span>&nbsp;<span class="ident" id="1503704">p</span><span class="op" id="1503705">.</span><span class="ident" id="1503706">nlog</span><span class="op" id="1503710">+</span><span class="ident" id="1503711">nslot</span>&nbsp;<span class="op" id="1503717">&gt;</span>&nbsp;<span class="builtintype" id="1503719">uintptr</span><span class="op" id="1503726">(</span><span class="builtinfunc" id="1503727">len</span><span class="op" id="1503730">(</span><span class="ident" id="1503731">p</span><span class="op" id="1503732">.</span><span class="ident" id="1503733">log</span><span class="op" id="1503736">[</span><span class="num" id="1503737">0</span><span class="op" id="1503738">]</span><span class="op" id="1503739">)</span><span class="op" id="1503740">)</span>&nbsp;<span class="op" id="1503742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503746">if</span>&nbsp;<span class="op" id="1503749">!</span><span class="ident" id="1503750">p</span><span class="op" id="1503751">.</span><span class="ident" id="1503752">flushlog</span><span class="op" id="1503760">(</span><span class="op" id="1503761">)</span>&nbsp;<span class="op" id="1503763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503768">return</span>&nbsp;<span class="ident" id="1503775">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503783">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503787">log</span>&nbsp;<span class="op" id="1503791">=</span>&nbsp;<span class="op" id="1503793">&amp;</span><span class="ident" id="1503794">p</span><span class="op" id="1503795">.</span><span class="ident" id="1503796">log</span><span class="op" id="1503799">[</span><span class="ident" id="1503800">p</span><span class="op" id="1503801">.</span><span class="ident" id="1503802">toggle</span><span class="op" id="1503808">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503815">q</span>&nbsp;<span class="op" id="1503817">:=</span>&nbsp;<span class="ident" id="1503820">p</span><span class="op" id="1503821">.</span><span class="ident" id="1503822">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503828">log</span><span class="op" id="1503831">[</span><span class="ident" id="1503832">q</span><span class="op" id="1503833">]</span>&nbsp;<span class="op" id="1503835">=</span>&nbsp;<span class="ident" id="1503837">e</span><span class="op" id="1503838">.</span><span class="ident" id="1503839">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503846">q</span><span class="op" id="1503847">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503851">log</span><span class="op" id="1503854">[</span><span class="ident" id="1503855">q</span><span class="op" id="1503856">]</span>&nbsp;<span class="op" id="1503858">=</span>&nbsp;<span class="ident" id="1503860">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503863">q</span><span class="op" id="1503864">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1503868">copy</span><span class="op" id="1503872">(</span><span class="ident" id="1503873">log</span><span class="op" id="1503876">[</span><span class="ident" id="1503877">q</span><span class="op" id="1503878">:</span><span class="op" id="1503879">]</span><span class="op" id="1503880">,</span>&nbsp;<span class="ident" id="1503882">e</span><span class="op" id="1503883">.</span><span class="ident" id="1503884">stack</span><span class="op" id="1503889">[</span><span class="op" id="1503890">:</span><span class="ident" id="1503891">d</span><span class="op" id="1503892">]</span><span class="op" id="1503893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503896">q</span>&nbsp;<span class="op" id="1503898">+=</span>&nbsp;<span class="ident" id="1503901">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503904">p</span><span class="op" id="1503905">.</span><span class="ident" id="1503906">nlog</span>&nbsp;<span class="op" id="1503911">=</span>&nbsp;<span class="ident" id="1503913">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503916">e</span><span class="op" id="1503917">.</span><span class="ident" id="1503918">count</span>&nbsp;<span class="op" id="1503924">=</span>&nbsp;<span class="num" id="1503926">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503929">return</span>&nbsp;<span class="ident" id="1503936">true</span><br>
<span class="lineno"></span><span class="op" id="1503941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1503944">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1504016">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1504099">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1504171">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1504250">func</span>&nbsp;<span class="op" id="1504255">(</span><span class="ident" id="1504256">p</span>&nbsp;<span class="op" id="1504258">*</span><span class="ident" id="1504259">cpuProfile</span><span class="op" id="1504269">)</span>&nbsp;<span class="ident" id="1504271">flushlog</span><span class="op" id="1504279">(</span><span class="op" id="1504280">)</span>&nbsp;<span class="builtintype" id="1504282">bool</span>&nbsp;<span class="op" id="1504287">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504290">if</span>&nbsp;<span class="op" id="1504293">!</span><span class="ident" id="1504294">cas</span><span class="op" id="1504297">(</span><span class="op" id="1504298">&amp;</span><span class="ident" id="1504299">p</span><span class="op" id="1504300">.</span><span class="ident" id="1504301">handoff</span><span class="op" id="1504308">,</span>&nbsp;<span class="num" id="1504310">0</span><span class="op" id="1504311">,</span>&nbsp;<span class="builtintype" id="1504313">uint32</span><span class="op" id="1504319">(</span><span class="ident" id="1504320">p</span><span class="op" id="1504321">.</span><span class="ident" id="1504322">nlog</span><span class="op" id="1504326">)</span><span class="op" id="1504327">)</span>&nbsp;<span class="op" id="1504329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504333">return</span>&nbsp;<span class="ident" id="1504340">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504350">notewakeup</span><span class="op" id="1504360">(</span><span class="op" id="1504361">&amp;</span><span class="ident" id="1504362">p</span><span class="op" id="1504363">.</span><span class="ident" id="1504364">wait</span><span class="op" id="1504368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504372">p</span><span class="op" id="1504373">.</span><span class="ident" id="1504374">toggle</span>&nbsp;<span class="op" id="1504381">=</span>&nbsp;<span class="num" id="1504383">1</span>&nbsp;<span class="op" id="1504385">-</span>&nbsp;<span class="ident" id="1504387">p</span><span class="op" id="1504388">.</span><span class="ident" id="1504389">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504397">log</span>&nbsp;<span class="op" id="1504401">:=</span>&nbsp;<span class="op" id="1504404">&amp;</span><span class="ident" id="1504405">p</span><span class="op" id="1504406">.</span><span class="ident" id="1504407">log</span><span class="op" id="1504410">[</span><span class="ident" id="1504411">p</span><span class="op" id="1504412">.</span><span class="ident" id="1504413">toggle</span><span class="op" id="1504419">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504422">q</span>&nbsp;<span class="op" id="1504424">:=</span>&nbsp;<span class="builtintype" id="1504427">uintptr</span><span class="op" id="1504434">(</span><span class="num" id="1504435">0</span><span class="op" id="1504436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504439">if</span>&nbsp;<span class="ident" id="1504442">p</span><span class="op" id="1504443">.</span><span class="ident" id="1504444">lost</span>&nbsp;<span class="op" id="1504449">&gt;</span>&nbsp;<span class="num" id="1504451">0</span>&nbsp;<span class="op" id="1504453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504457">lostPC</span>&nbsp;<span class="op" id="1504464">:=</span>&nbsp;<span class="ident" id="1504467">funcPC</span><span class="op" id="1504473">(</span><span class="ident" id="1504474">lostProfileData</span><span class="op" id="1504489">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504493">log</span><span class="op" id="1504496">[</span><span class="num" id="1504497">0</span><span class="op" id="1504498">]</span>&nbsp;<span class="op" id="1504500">=</span>&nbsp;<span class="ident" id="1504502">p</span><span class="op" id="1504503">.</span><span class="ident" id="1504504">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504511">log</span><span class="op" id="1504514">[</span><span class="num" id="1504515">1</span><span class="op" id="1504516">]</span>&nbsp;<span class="op" id="1504518">=</span>&nbsp;<span class="num" id="1504520">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504524">log</span><span class="op" id="1504527">[</span><span class="num" id="1504528">2</span><span class="op" id="1504529">]</span>&nbsp;<span class="op" id="1504531">=</span>&nbsp;<span class="ident" id="1504533">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504542">q</span>&nbsp;<span class="op" id="1504544">=</span>&nbsp;<span class="num" id="1504546">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504550">p</span><span class="op" id="1504551">.</span><span class="ident" id="1504552">lost</span>&nbsp;<span class="op" id="1504557">=</span>&nbsp;<span class="num" id="1504559">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504565">p</span><span class="op" id="1504566">.</span><span class="ident" id="1504567">nlog</span>&nbsp;<span class="op" id="1504572">=</span>&nbsp;<span class="ident" id="1504574">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504577">return</span>&nbsp;<span class="ident" id="1504584">true</span><br>
<span class="lineno"></span><span class="op" id="1504589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1504592">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1504665">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1504738">func</span>&nbsp;<span class="op" id="1504743">(</span><span class="ident" id="1504744">p</span>&nbsp;<span class="op" id="1504746">*</span><span class="ident" id="1504747">cpuProfile</span><span class="op" id="1504757">)</span>&nbsp;<span class="ident" id="1504759">getprofile</span><span class="op" id="1504769">(</span><span class="op" id="1504770">)</span>&nbsp;<span class="op" id="1504772">[</span><span class="op" id="1504773">]</span><span class="builtintype" id="1504774">byte</span>&nbsp;<span class="op" id="1504779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504782">if</span>&nbsp;<span class="ident" id="1504785">p</span>&nbsp;<span class="op" id="1504787">==</span>&nbsp;<span class="ident" id="1504790">nil</span>&nbsp;<span class="op" id="1504794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504798">return</span>&nbsp;<span class="ident" id="1504805">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504814">if</span>&nbsp;<span class="ident" id="1504817">p</span><span class="op" id="1504818">.</span><span class="ident" id="1504819">wholding</span>&nbsp;<span class="op" id="1504828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504832">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504883">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504945">for</span>&nbsp;<span class="op" id="1504949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504954">n</span>&nbsp;<span class="op" id="1504956">:=</span>&nbsp;<span class="ident" id="1504959">p</span><span class="op" id="1504960">.</span><span class="ident" id="1504961">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504972">if</span>&nbsp;<span class="ident" id="1504975">n</span>&nbsp;<span class="op" id="1504977">==</span>&nbsp;<span class="num" id="1504980">0</span>&nbsp;<span class="op" id="1504982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1504988">print</span><span class="op" id="1504993">(</span><span class="string" id="1504994">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1505045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505051">return</span>&nbsp;<span class="ident" id="1505058">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505070">if</span>&nbsp;<span class="ident" id="1505073">n</span><span class="op" id="1505074">&amp;</span><span class="num" id="1505075">0x80000000</span>&nbsp;<span class="op" id="1505086">!=</span>&nbsp;<span class="num" id="1505089">0</span>&nbsp;<span class="op" id="1505091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505097">p</span><span class="op" id="1505098">.</span><span class="ident" id="1505099">wtoggle</span>&nbsp;<span class="op" id="1505107">=</span>&nbsp;<span class="num" id="1505109">1</span>&nbsp;<span class="op" id="1505111">-</span>&nbsp;<span class="ident" id="1505113">p</span><span class="op" id="1505114">.</span><span class="ident" id="1505115">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505127">p</span><span class="op" id="1505128">.</span><span class="ident" id="1505129">wholding</span>&nbsp;<span class="op" id="1505138">=</span>&nbsp;<span class="ident" id="1505140">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505150">p</span><span class="op" id="1505151">.</span><span class="ident" id="1505152">flushing</span>&nbsp;<span class="op" id="1505161">=</span>&nbsp;<span class="ident" id="1505163">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505172">goto</span>&nbsp;<span class="ident" id="1505177">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505191">if</span>&nbsp;<span class="ident" id="1505194">cas</span><span class="op" id="1505197">(</span><span class="op" id="1505198">&amp;</span><span class="ident" id="1505199">p</span><span class="op" id="1505200">.</span><span class="ident" id="1505201">handoff</span><span class="op" id="1505208">,</span>&nbsp;<span class="ident" id="1505210">n</span><span class="op" id="1505211">,</span>&nbsp;<span class="num" id="1505213">0</span><span class="op" id="1505214">)</span>&nbsp;<span class="op" id="1505216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505222">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505231">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505239">p</span><span class="op" id="1505240">.</span><span class="ident" id="1505241">wtoggle</span>&nbsp;<span class="op" id="1505249">=</span>&nbsp;<span class="num" id="1505251">1</span>&nbsp;<span class="op" id="1505253">-</span>&nbsp;<span class="ident" id="1505255">p</span><span class="op" id="1505256">.</span><span class="ident" id="1505257">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505267">p</span><span class="op" id="1505268">.</span><span class="ident" id="1505269">wholding</span>&nbsp;<span class="op" id="1505278">=</span>&nbsp;<span class="ident" id="1505280">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505291">if</span>&nbsp;<span class="ident" id="1505294">p</span><span class="op" id="1505295">.</span><span class="ident" id="1505296">flushing</span>&nbsp;<span class="op" id="1505305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505309">goto</span>&nbsp;<span class="ident" id="1505314">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505325">if</span>&nbsp;<span class="op" id="1505328">!</span><span class="ident" id="1505329">p</span><span class="op" id="1505330">.</span><span class="ident" id="1505331">on</span>&nbsp;<span class="op" id="1505334">&amp;&amp;</span>&nbsp;<span class="ident" id="1505337">p</span><span class="op" id="1505338">.</span><span class="ident" id="1505339">handoff</span>&nbsp;<span class="op" id="1505347">==</span>&nbsp;<span class="num" id="1505350">0</span>&nbsp;<span class="op" id="1505352">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505356">return</span>&nbsp;<span class="ident" id="1505363">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505372">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505394">notetsleepg</span><span class="op" id="1505405">(</span><span class="op" id="1505406">&amp;</span><span class="ident" id="1505407">p</span><span class="op" id="1505408">.</span><span class="ident" id="1505409">wait</span><span class="op" id="1505413">,</span>&nbsp;<span class="op" id="1505415">-</span><span class="num" id="1505416">1</span><span class="op" id="1505417">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505420">noteclear</span><span class="op" id="1505429">(</span><span class="op" id="1505430">&amp;</span><span class="ident" id="1505431">p</span><span class="op" id="1505432">.</span><span class="ident" id="1505433">wait</span><span class="op" id="1505437">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505441">switch</span>&nbsp;<span class="ident" id="1505448">n</span>&nbsp;<span class="op" id="1505450">:=</span>&nbsp;<span class="ident" id="1505453">p</span><span class="op" id="1505454">.</span><span class="ident" id="1505455">handoff</span><span class="op" id="1505462">;</span>&nbsp;<span class="op" id="1505464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505467">case</span>&nbsp;<span class="ident" id="1505472">n</span>&nbsp;<span class="op" id="1505474">==</span>&nbsp;<span class="num" id="1505477">0</span><span class="op" id="1505478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1505482">print</span><span class="op" id="1505487">(</span><span class="string" id="1505488">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1505536">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505540">return</span>&nbsp;<span class="ident" id="1505547">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505552">case</span>&nbsp;<span class="ident" id="1505557">n</span>&nbsp;<span class="op" id="1505559">==</span>&nbsp;<span class="num" id="1505562">0x80000000</span><span class="op" id="1505572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505576">p</span><span class="op" id="1505577">.</span><span class="ident" id="1505578">flushing</span>&nbsp;<span class="op" id="1505587">=</span>&nbsp;<span class="ident" id="1505589">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505596">goto</span>&nbsp;<span class="ident" id="1505601">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505608">default</span><span class="op" id="1505615">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505619">n</span>&nbsp;<span class="op" id="1505621">&amp;^=</span>&nbsp;<span class="num" id="1505625">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505639">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505670">p</span><span class="op" id="1505671">.</span><span class="ident" id="1505672">wholding</span>&nbsp;<span class="op" id="1505681">=</span>&nbsp;<span class="ident" id="1505683">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505691">return</span>&nbsp;<span class="ident" id="1505698">uintptrBytes</span><span class="op" id="1505710">(</span><span class="ident" id="1505711">p</span><span class="op" id="1505712">.</span><span class="ident" id="1505713">log</span><span class="op" id="1505716">[</span><span class="ident" id="1505717">p</span><span class="op" id="1505718">.</span><span class="ident" id="1505719">wtoggle</span><span class="op" id="1505726">]</span><span class="op" id="1505727">[</span><span class="op" id="1505728">:</span><span class="ident" id="1505729">n</span><span class="op" id="1505730">]</span><span class="op" id="1505731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505738">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505757">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505809">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505874">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1505926">Flush</span><span class="op" id="1505931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505934">for</span>&nbsp;<span class="ident" id="1505938">i</span>&nbsp;<span class="op" id="1505940">:=</span>&nbsp;<span class="keyword" id="1505943">range</span>&nbsp;<span class="ident" id="1505949">p</span><span class="op" id="1505950">.</span><span class="ident" id="1505951">hash</span>&nbsp;<span class="op" id="1505956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505960">b</span>&nbsp;<span class="op" id="1505962">:=</span>&nbsp;<span class="op" id="1505965">&amp;</span><span class="ident" id="1505966">p</span><span class="op" id="1505967">.</span><span class="ident" id="1505968">hash</span><span class="op" id="1505972">[</span><span class="ident" id="1505973">i</span><span class="op" id="1505974">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505978">for</span>&nbsp;<span class="ident" id="1505982">j</span>&nbsp;<span class="op" id="1505984">:=</span>&nbsp;<span class="keyword" id="1505987">range</span>&nbsp;<span class="ident" id="1505993">b</span><span class="op" id="1505994">.</span><span class="ident" id="1505995">entry</span>&nbsp;<span class="op" id="1506001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506006">e</span>&nbsp;<span class="op" id="1506008">:=</span>&nbsp;<span class="op" id="1506011">&amp;</span><span class="ident" id="1506012">b</span><span class="op" id="1506013">.</span><span class="ident" id="1506014">entry</span><span class="op" id="1506019">[</span><span class="ident" id="1506020">j</span><span class="op" id="1506021">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506026">if</span>&nbsp;<span class="ident" id="1506029">e</span><span class="op" id="1506030">.</span><span class="ident" id="1506031">count</span>&nbsp;<span class="op" id="1506037">&gt;</span>&nbsp;<span class="num" id="1506039">0</span>&nbsp;<span class="op" id="1506041">&amp;&amp;</span>&nbsp;<span class="op" id="1506044">!</span><span class="ident" id="1506045">p</span><span class="op" id="1506046">.</span><span class="ident" id="1506047">evict</span><span class="op" id="1506052">(</span><span class="ident" id="1506053">e</span><span class="op" id="1506054">)</span>&nbsp;<span class="op" id="1506056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506062">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506127">break</span>&nbsp;<span class="ident" id="1506133">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506153">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506182">if</span>&nbsp;<span class="ident" id="1506185">p</span><span class="op" id="1506186">.</span><span class="ident" id="1506187">nlog</span>&nbsp;<span class="op" id="1506192">&gt;</span>&nbsp;<span class="num" id="1506194">0</span>&nbsp;<span class="op" id="1506196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506200">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506252">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506300">n</span>&nbsp;<span class="op" id="1506302">:=</span>&nbsp;<span class="ident" id="1506305">p</span><span class="op" id="1506306">.</span><span class="ident" id="1506307">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506314">p</span><span class="op" id="1506315">.</span><span class="ident" id="1506316">nlog</span>&nbsp;<span class="op" id="1506321">=</span>&nbsp;<span class="num" id="1506323">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506327">return</span>&nbsp;<span class="ident" id="1506334">uintptrBytes</span><span class="op" id="1506346">(</span><span class="ident" id="1506347">p</span><span class="op" id="1506348">.</span><span class="ident" id="1506349">log</span><span class="op" id="1506352">[</span><span class="ident" id="1506353">p</span><span class="op" id="1506354">.</span><span class="ident" id="1506355">toggle</span><span class="op" id="1506361">]</span><span class="op" id="1506362">[</span><span class="op" id="1506363">:</span><span class="ident" id="1506364">n</span><span class="op" id="1506365">]</span><span class="op" id="1506366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506373">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506436">if</span>&nbsp;<span class="op" id="1506439">!</span><span class="ident" id="1506440">p</span><span class="op" id="1506441">.</span><span class="ident" id="1506442">eodSent</span>&nbsp;<span class="op" id="1506450">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506454">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506520">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506585">p</span><span class="op" id="1506586">.</span><span class="ident" id="1506587">eodSent</span>&nbsp;<span class="op" id="1506595">=</span>&nbsp;<span class="ident" id="1506597">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506604">return</span>&nbsp;<span class="ident" id="1506611">uintptrBytes</span><span class="op" id="1506623">(</span><span class="ident" id="1506624">eod</span><span class="op" id="1506627">[</span><span class="op" id="1506628">:</span><span class="op" id="1506629">]</span><span class="op" id="1506630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506633">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506637">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506681">p</span><span class="op" id="1506682">.</span><span class="ident" id="1506683">flushing</span>&nbsp;<span class="op" id="1506692">=</span>&nbsp;<span class="ident" id="1506694">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506701">if</span>&nbsp;<span class="op" id="1506704">!</span><span class="ident" id="1506705">cas</span><span class="op" id="1506708">(</span><span class="op" id="1506709">&amp;</span><span class="ident" id="1506710">p</span><span class="op" id="1506711">.</span><span class="ident" id="1506712">handoff</span><span class="op" id="1506719">,</span>&nbsp;<span class="ident" id="1506721">p</span><span class="op" id="1506722">.</span><span class="ident" id="1506723">handoff</span><span class="op" id="1506730">,</span>&nbsp;<span class="num" id="1506732">0</span><span class="op" id="1506733">)</span>&nbsp;<span class="op" id="1506735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1506739">print</span><span class="op" id="1506744">(</span><span class="string" id="1506745">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1506793">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506799">return</span>&nbsp;<span class="ident" id="1506806">nil</span><br>
<span class="lineno"></span><span class="op" id="1506810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1506813">func</span>&nbsp;<span class="ident" id="1506818">uintptrBytes</span><span class="op" id="1506830">(</span><span class="ident" id="1506831">p</span>&nbsp;<span class="op" id="1506833">[</span><span class="op" id="1506834">]</span><span class="builtintype" id="1506835">uintptr</span><span class="op" id="1506842">)</span>&nbsp;<span class="op" id="1506844">(</span><span class="ident" id="1506845">ret</span>&nbsp;<span class="op" id="1506849">[</span><span class="op" id="1506850">]</span><span class="builtintype" id="1506851">byte</span><span class="op" id="1506855">)</span>&nbsp;<span class="op" id="1506857">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506860">pp</span>&nbsp;<span class="op" id="1506863">:=</span>&nbsp;<span class="op" id="1506866">(</span><span class="op" id="1506867">*</span><span class="ident" id="1506868">sliceStruct</span><span class="op" id="1506879">)</span><span class="op" id="1506880">(</span><span class="ident" id="1506881">unsafe</span><span class="op" id="1506887">.</span><span class="ident" id="1506888">Pointer</span><span class="op" id="1506895">(</span><span class="op" id="1506896">&amp;</span><span class="ident" id="1506897">p</span><span class="op" id="1506898">)</span><span class="op" id="1506899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506902">rp</span>&nbsp;<span class="op" id="1506905">:=</span>&nbsp;<span class="op" id="1506908">(</span><span class="op" id="1506909">*</span><span class="ident" id="1506910">sliceStruct</span><span class="op" id="1506921">)</span><span class="op" id="1506922">(</span><span class="ident" id="1506923">unsafe</span><span class="op" id="1506929">.</span><span class="ident" id="1506930">Pointer</span><span class="op" id="1506937">(</span><span class="op" id="1506938">&amp;</span><span class="ident" id="1506939">ret</span><span class="op" id="1506942">)</span><span class="op" id="1506943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506947">rp</span><span class="op" id="1506949">.</span><span class="ident" id="1506950">array</span>&nbsp;<span class="op" id="1506956">=</span>&nbsp;<span class="ident" id="1506958">pp</span><span class="op" id="1506960">.</span><span class="ident" id="1506961">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506968">rp</span><span class="op" id="1506970">.</span><span class="builtinfunc" id="1506971">len</span>&nbsp;<span class="op" id="1506975">=</span>&nbsp;<span class="ident" id="1506977">pp</span><span class="op" id="1506979">.</span><span class="builtinfunc" id="1506980">len</span>&nbsp;<span class="op" id="1506984">*</span>&nbsp;<span class="builtintype" id="1506986">int</span><span class="op" id="1506989">(</span><span class="ident" id="1506990">unsafe</span><span class="op" id="1506996">.</span><span class="ident" id="1506997">Sizeof</span><span class="op" id="1507003">(</span><span class="ident" id="1507004">p</span><span class="op" id="1507005">[</span><span class="num" id="1507006">0</span><span class="op" id="1507007">]</span><span class="op" id="1507008">)</span><span class="op" id="1507009">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507012">rp</span><span class="op" id="1507014">.</span><span class="builtinfunc" id="1507015">cap</span>&nbsp;<span class="op" id="1507019">=</span>&nbsp;<span class="ident" id="1507021">rp</span><span class="op" id="1507023">.</span><span class="builtinfunc" id="1507024">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507030">return</span><br>
<span class="lineno"></span><span class="op" id="1507037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1507040">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1507119">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1507204">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1507283">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1507358">//</span><br>
<span class="lineno">420</span><span class="comment" id="1507361">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1507417">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1507483">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1507507">func</span>&nbsp;<span class="ident" id="1507512">CPUProfile</span><span class="op" id="1507522">(</span><span class="op" id="1507523">)</span>&nbsp;<span class="op" id="1507525">[</span><span class="op" id="1507526">]</span><span class="builtintype" id="1507527">byte</span>&nbsp;<span class="op" id="1507532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507535">return</span>&nbsp;<span class="ident" id="1507542">cpuprof</span><span class="op" id="1507549">.</span><span class="ident" id="1507550">getprofile</span><span class="op" id="1507560">(</span><span class="op" id="1507561">)</span><br>
<span class="lineno">425</span><span class="op" id="1507563">}</span>
</div>
</body>
</html>
