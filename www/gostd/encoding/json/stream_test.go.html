<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7647636">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7647692">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7647746">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7647797">package</span>&nbsp;<span class="ident" id="7647805">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7647811">import</span>&nbsp;<span class="op" id="7647818">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647821">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647830">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647843">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647850">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647861">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647872">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7647882">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="7647885">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="7647921">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="7647947">var</span>&nbsp;<span class="ident" id="7647951">streamTest</span>&nbsp;<span class="op" id="7647962">=</span>&nbsp;<span class="op" id="7647964">[</span><span class="op" id="7647965">]</span><span class="keyword" id="7647966">interface</span><span class="op" id="7647975">{</span><span class="op" id="7647976">}</span><span class="op" id="7647977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7647980">0.1</span><span class="op" id="7647983">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7647986">&#34;hello&#34;</span><span class="op" id="7647993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647996">nil</span><span class="op" id="7647999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="7648002">true</span><span class="op" id="7648006">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="7648009">false</span><span class="op" id="7648014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648017">[</span><span class="op" id="7648018">]</span><span class="keyword" id="7648019">interface</span><span class="op" id="7648028">{</span><span class="op" id="7648029">}</span><span class="op" id="7648030">{</span><span class="string" id="7648031">&#34;a&#34;</span><span class="op" id="7648034">,</span>&nbsp;<span class="string" id="7648036">&#34;b&#34;</span><span class="op" id="7648039">,</span>&nbsp;<span class="string" id="7648041">&#34;c&#34;</span><span class="op" id="7648044">}</span><span class="op" id="7648045">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648048">map</span><span class="op" id="7648051">[</span><span class="builtintype" id="7648052">string</span><span class="op" id="7648058">]</span><span class="keyword" id="7648059">interface</span><span class="op" id="7648068">{</span><span class="op" id="7648069">}</span><span class="op" id="7648070">{</span><span class="string" id="7648071">&#34;K&#34;</span><span class="op" id="7648076">:</span>&nbsp;<span class="string" id="7648078">&#34;Kelvin&#34;</span><span class="op" id="7648086">,</span>&nbsp;<span class="string" id="7648088">&#34;ß&#34;</span><span class="op" id="7648092">:</span>&nbsp;<span class="string" id="7648094">&#34;long&nbsp;s&#34;</span><span class="op" id="7648102">}</span><span class="op" id="7648103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="7648106">3.14</span><span class="op" id="7648110">,</span>&nbsp;<span class="comment" id="7648112">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="7648167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7648170">var</span>&nbsp;<span class="ident" id="7648174">streamEncoded</span>&nbsp;<span class="op" id="7648188">=</span>&nbsp;<span class="string" id="7648190">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7648272">func</span>&nbsp;<span class="ident" id="7648277">TestEncoder</span><span class="op" id="7648288">(</span><span class="ident" id="7648289">t</span>&nbsp;<span class="op" id="7648291">*</span><span class="ident" id="7648292">testing</span><span class="op" id="7648299">.</span><span class="ident" id="7648300">T</span><span class="op" id="7648301">)</span>&nbsp;<span class="op" id="7648303">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648306">for</span>&nbsp;<span class="ident" id="7648310">i</span>&nbsp;<span class="op" id="7648312">:=</span>&nbsp;<span class="num" id="7648315">0</span><span class="op" id="7648316">;</span>&nbsp;<span class="ident" id="7648318">i</span>&nbsp;<span class="op" id="7648320">&lt;=</span>&nbsp;<span class="builtinfunc" id="7648323">len</span><span class="op" id="7648326">(</span><span class="ident" id="7648327">streamTest</span><span class="op" id="7648337">)</span><span class="op" id="7648338">;</span>&nbsp;<span class="ident" id="7648340">i</span><span class="op" id="7648341">++</span>&nbsp;<span class="op" id="7648344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648348">var</span>&nbsp;<span class="ident" id="7648352">buf</span>&nbsp;<span class="ident" id="7648356">bytes</span><span class="op" id="7648361">.</span><span class="ident" id="7648362">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648371">enc</span>&nbsp;<span class="op" id="7648375">:=</span>&nbsp;<span class="ident" id="7648378">NewEncoder</span><span class="op" id="7648388">(</span><span class="op" id="7648389">&amp;</span><span class="ident" id="7648390">buf</span><span class="op" id="7648393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648397">for</span>&nbsp;<span class="ident" id="7648401">j</span><span class="op" id="7648402">,</span>&nbsp;<span class="ident" id="7648404">v</span>&nbsp;<span class="op" id="7648406">:=</span>&nbsp;<span class="keyword" id="7648409">range</span>&nbsp;<span class="ident" id="7648415">streamTest</span><span class="op" id="7648425">[</span><span class="num" id="7648426">0</span><span class="op" id="7648427">:</span><span class="ident" id="7648428">i</span><span class="op" id="7648429">]</span>&nbsp;<span class="op" id="7648431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648436">if</span>&nbsp;<span class="ident" id="7648439">err</span>&nbsp;<span class="op" id="7648443">:=</span>&nbsp;<span class="ident" id="7648446">enc</span><span class="op" id="7648449">.</span><span class="ident" id="7648450">Encode</span><span class="op" id="7648456">(</span><span class="ident" id="7648457">v</span><span class="op" id="7648458">)</span><span class="op" id="7648459">;</span>&nbsp;<span class="ident" id="7648461">err</span>&nbsp;<span class="op" id="7648465">!=</span>&nbsp;<span class="ident" id="7648468">nil</span>&nbsp;<span class="op" id="7648472">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648478">t</span><span class="op" id="7648479">.</span><span class="ident" id="7648480">Fatalf</span><span class="op" id="7648486">(</span><span class="string" id="7648487">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7648503">,</span>&nbsp;<span class="ident" id="7648505">j</span><span class="op" id="7648506">,</span>&nbsp;<span class="ident" id="7648508">err</span><span class="op" id="7648511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648524">if</span>&nbsp;<span class="ident" id="7648527">have</span><span class="op" id="7648531">,</span>&nbsp;<span class="ident" id="7648533">want</span>&nbsp;<span class="op" id="7648538">:=</span>&nbsp;<span class="ident" id="7648541">buf</span><span class="op" id="7648544">.</span><span class="ident" id="7648545">String</span><span class="op" id="7648551">(</span><span class="op" id="7648552">)</span><span class="op" id="7648553">,</span>&nbsp;<span class="ident" id="7648555">nlines</span><span class="op" id="7648561">(</span><span class="ident" id="7648562">streamEncoded</span><span class="op" id="7648575">,</span>&nbsp;<span class="ident" id="7648577">i</span><span class="op" id="7648578">)</span><span class="op" id="7648579">;</span>&nbsp;<span class="ident" id="7648581">have</span>&nbsp;<span class="op" id="7648586">!=</span>&nbsp;<span class="ident" id="7648589">want</span>&nbsp;<span class="op" id="7648594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648599">t</span><span class="op" id="7648600">.</span><span class="ident" id="7648601">Errorf</span><span class="op" id="7648607">(</span><span class="string" id="7648608">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="7648637">,</span>&nbsp;<span class="ident" id="7648639">i</span><span class="op" id="7648640">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648645">diff</span><span class="op" id="7648649">(</span><span class="ident" id="7648650">t</span><span class="op" id="7648651">,</span>&nbsp;<span class="op" id="7648653">[</span><span class="op" id="7648654">]</span><span class="builtintype" id="7648655">byte</span><span class="op" id="7648659">(</span><span class="ident" id="7648660">have</span><span class="op" id="7648664">)</span><span class="op" id="7648665">,</span>&nbsp;<span class="op" id="7648667">[</span><span class="op" id="7648668">]</span><span class="builtintype" id="7648669">byte</span><span class="op" id="7648673">(</span><span class="ident" id="7648674">want</span><span class="op" id="7648678">)</span><span class="op" id="7648679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648684">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648695">}</span><br>
<span class="lineno"></span><span class="op" id="7648697">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7648700">func</span>&nbsp;<span class="ident" id="7648705">TestDecoder</span><span class="op" id="7648716">(</span><span class="ident" id="7648717">t</span>&nbsp;<span class="op" id="7648719">*</span><span class="ident" id="7648720">testing</span><span class="op" id="7648727">.</span><span class="ident" id="7648728">T</span><span class="op" id="7648729">)</span>&nbsp;<span class="op" id="7648731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648734">for</span>&nbsp;<span class="ident" id="7648738">i</span>&nbsp;<span class="op" id="7648740">:=</span>&nbsp;<span class="num" id="7648743">0</span><span class="op" id="7648744">;</span>&nbsp;<span class="ident" id="7648746">i</span>&nbsp;<span class="op" id="7648748">&lt;=</span>&nbsp;<span class="builtinfunc" id="7648751">len</span><span class="op" id="7648754">(</span><span class="ident" id="7648755">streamTest</span><span class="op" id="7648765">)</span><span class="op" id="7648766">;</span>&nbsp;<span class="ident" id="7648768">i</span><span class="op" id="7648769">++</span>&nbsp;<span class="op" id="7648772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648776">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648819">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648862">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648921">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648965">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649002">var</span>&nbsp;<span class="ident" id="7649006">buf</span>&nbsp;<span class="ident" id="7649010">bytes</span><span class="op" id="7649015">.</span><span class="ident" id="7649016">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649025">for</span>&nbsp;<span class="ident" id="7649029">_</span><span class="op" id="7649030">,</span>&nbsp;<span class="ident" id="7649032">c</span>&nbsp;<span class="op" id="7649034">:=</span>&nbsp;<span class="keyword" id="7649037">range</span>&nbsp;<span class="ident" id="7649043">nlines</span><span class="op" id="7649049">(</span><span class="ident" id="7649050">streamEncoded</span><span class="op" id="7649063">,</span>&nbsp;<span class="ident" id="7649065">i</span><span class="op" id="7649066">)</span>&nbsp;<span class="op" id="7649068">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649073">if</span>&nbsp;<span class="ident" id="7649076">c</span>&nbsp;<span class="op" id="7649078">!=</span>&nbsp;<span class="string" id="7649081">&#39;\n&#39;</span>&nbsp;<span class="op" id="7649086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649092">buf</span><span class="op" id="7649095">.</span><span class="ident" id="7649096">WriteRune</span><span class="op" id="7649105">(</span><span class="ident" id="7649106">c</span><span class="op" id="7649107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649120">out</span>&nbsp;<span class="op" id="7649124">:=</span>&nbsp;<span class="builtinfunc" id="7649127">make</span><span class="op" id="7649131">(</span><span class="op" id="7649132">[</span><span class="op" id="7649133">]</span><span class="keyword" id="7649134">interface</span><span class="op" id="7649143">{</span><span class="op" id="7649144">}</span><span class="op" id="7649145">,</span>&nbsp;<span class="ident" id="7649147">i</span><span class="op" id="7649148">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649152">dec</span>&nbsp;<span class="op" id="7649156">:=</span>&nbsp;<span class="ident" id="7649159">NewDecoder</span><span class="op" id="7649169">(</span><span class="op" id="7649170">&amp;</span><span class="ident" id="7649171">buf</span><span class="op" id="7649174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649178">for</span>&nbsp;<span class="ident" id="7649182">j</span>&nbsp;<span class="op" id="7649184">:=</span>&nbsp;<span class="keyword" id="7649187">range</span>&nbsp;<span class="ident" id="7649193">out</span>&nbsp;<span class="op" id="7649197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649202">if</span>&nbsp;<span class="ident" id="7649205">err</span>&nbsp;<span class="op" id="7649209">:=</span>&nbsp;<span class="ident" id="7649212">dec</span><span class="op" id="7649215">.</span><span class="ident" id="7649216">Decode</span><span class="op" id="7649222">(</span><span class="op" id="7649223">&amp;</span><span class="ident" id="7649224">out</span><span class="op" id="7649227">[</span><span class="ident" id="7649228">j</span><span class="op" id="7649229">]</span><span class="op" id="7649230">)</span><span class="op" id="7649231">;</span>&nbsp;<span class="ident" id="7649233">err</span>&nbsp;<span class="op" id="7649237">!=</span>&nbsp;<span class="ident" id="7649240">nil</span>&nbsp;<span class="op" id="7649244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649250">t</span><span class="op" id="7649251">.</span><span class="ident" id="7649252">Fatalf</span><span class="op" id="7649258">(</span><span class="string" id="7649259">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="7649278">,</span>&nbsp;<span class="ident" id="7649280">j</span><span class="op" id="7649281">,</span>&nbsp;<span class="ident" id="7649283">i</span><span class="op" id="7649284">,</span>&nbsp;<span class="ident" id="7649286">err</span><span class="op" id="7649289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649294">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649302">if</span>&nbsp;<span class="op" id="7649305">!</span><span class="ident" id="7649306">reflect</span><span class="op" id="7649313">.</span><span class="ident" id="7649314">DeepEqual</span><span class="op" id="7649323">(</span><span class="ident" id="7649324">out</span><span class="op" id="7649327">,</span>&nbsp;<span class="ident" id="7649329">streamTest</span><span class="op" id="7649339">[</span><span class="num" id="7649340">0</span><span class="op" id="7649341">:</span><span class="ident" id="7649342">i</span><span class="op" id="7649343">]</span><span class="op" id="7649344">)</span>&nbsp;<span class="op" id="7649346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649351">t</span><span class="op" id="7649352">.</span><span class="ident" id="7649353">Errorf</span><span class="op" id="7649359">(</span><span class="string" id="7649360">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="7649389">,</span>&nbsp;<span class="ident" id="7649391">i</span><span class="op" id="7649392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649397">for</span>&nbsp;<span class="ident" id="7649401">j</span>&nbsp;<span class="op" id="7649403">:=</span>&nbsp;<span class="keyword" id="7649406">range</span>&nbsp;<span class="ident" id="7649412">out</span>&nbsp;<span class="op" id="7649416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649422">if</span>&nbsp;<span class="op" id="7649425">!</span><span class="ident" id="7649426">reflect</span><span class="op" id="7649433">.</span><span class="ident" id="7649434">DeepEqual</span><span class="op" id="7649443">(</span><span class="ident" id="7649444">out</span><span class="op" id="7649447">[</span><span class="ident" id="7649448">j</span><span class="op" id="7649449">]</span><span class="op" id="7649450">,</span>&nbsp;<span class="ident" id="7649452">streamTest</span><span class="op" id="7649462">[</span><span class="ident" id="7649463">j</span><span class="op" id="7649464">]</span><span class="op" id="7649465">)</span>&nbsp;<span class="op" id="7649467">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649474">t</span><span class="op" id="7649475">.</span><span class="ident" id="7649476">Errorf</span><span class="op" id="7649482">(</span><span class="string" id="7649483">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7649505">,</span>&nbsp;<span class="ident" id="7649507">j</span><span class="op" id="7649508">,</span>&nbsp;<span class="ident" id="7649510">out</span><span class="op" id="7649513">[</span><span class="ident" id="7649514">j</span><span class="op" id="7649515">]</span><span class="op" id="7649516">,</span>&nbsp;<span class="ident" id="7649518">streamTest</span><span class="op" id="7649528">[</span><span class="ident" id="7649529">j</span><span class="op" id="7649530">]</span><span class="op" id="7649531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649547">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649555">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649558">}</span><br>
<span class="lineno"></span><span class="op" id="7649560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7649563">func</span>&nbsp;<span class="ident" id="7649568">TestDecoderBuffered</span><span class="op" id="7649587">(</span><span class="ident" id="7649588">t</span>&nbsp;<span class="op" id="7649590">*</span><span class="ident" id="7649591">testing</span><span class="op" id="7649598">.</span><span class="ident" id="7649599">T</span><span class="op" id="7649600">)</span>&nbsp;<span class="op" id="7649602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649605">r</span>&nbsp;<span class="op" id="7649607">:=</span>&nbsp;<span class="ident" id="7649610">strings</span><span class="op" id="7649617">.</span><span class="ident" id="7649618">NewReader</span><span class="op" id="7649627">(</span><span class="string" id="7649628">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="7649655">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649658">var</span>&nbsp;<span class="ident" id="7649662">m</span>&nbsp;<span class="keyword" id="7649664">struct</span>&nbsp;<span class="op" id="7649671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649675">Name</span>&nbsp;<span class="builtintype" id="7649680">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649691">d</span>&nbsp;<span class="op" id="7649693">:=</span>&nbsp;<span class="ident" id="7649696">NewDecoder</span><span class="op" id="7649706">(</span><span class="ident" id="7649707">r</span><span class="op" id="7649708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649711">err</span>&nbsp;<span class="op" id="7649715">:=</span>&nbsp;<span class="ident" id="7649718">d</span><span class="op" id="7649719">.</span><span class="ident" id="7649720">Decode</span><span class="op" id="7649726">(</span><span class="op" id="7649727">&amp;</span><span class="ident" id="7649728">m</span><span class="op" id="7649729">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649732">if</span>&nbsp;<span class="ident" id="7649735">err</span>&nbsp;<span class="op" id="7649739">!=</span>&nbsp;<span class="ident" id="7649742">nil</span>&nbsp;<span class="op" id="7649746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649750">t</span><span class="op" id="7649751">.</span><span class="ident" id="7649752">Fatal</span><span class="op" id="7649757">(</span><span class="ident" id="7649758">err</span><span class="op" id="7649761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649767">if</span>&nbsp;<span class="ident" id="7649770">m</span><span class="op" id="7649771">.</span><span class="ident" id="7649772">Name</span>&nbsp;<span class="op" id="7649777">!=</span>&nbsp;<span class="string" id="7649780">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="7649789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649793">t</span><span class="op" id="7649794">.</span><span class="ident" id="7649795">Errorf</span><span class="op" id="7649801">(</span><span class="string" id="7649802">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="7649826">,</span>&nbsp;<span class="ident" id="7649828">m</span><span class="op" id="7649829">.</span><span class="ident" id="7649830">Name</span><span class="op" id="7649834">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649840">rest</span><span class="op" id="7649844">,</span>&nbsp;<span class="ident" id="7649846">err</span>&nbsp;<span class="op" id="7649850">:=</span>&nbsp;<span class="ident" id="7649853">ioutil</span><span class="op" id="7649859">.</span><span class="ident" id="7649860">ReadAll</span><span class="op" id="7649867">(</span><span class="ident" id="7649868">d</span><span class="op" id="7649869">.</span><span class="ident" id="7649870">Buffered</span><span class="op" id="7649878">(</span><span class="op" id="7649879">)</span><span class="op" id="7649880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649883">if</span>&nbsp;<span class="ident" id="7649886">err</span>&nbsp;<span class="op" id="7649890">!=</span>&nbsp;<span class="ident" id="7649893">nil</span>&nbsp;<span class="op" id="7649897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649901">t</span><span class="op" id="7649902">.</span><span class="ident" id="7649903">Fatal</span><span class="op" id="7649908">(</span><span class="ident" id="7649909">err</span><span class="op" id="7649912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649915">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649918">if</span>&nbsp;<span class="ident" id="7649921">g</span><span class="op" id="7649922">,</span>&nbsp;<span class="ident" id="7649924">w</span>&nbsp;<span class="op" id="7649926">:=</span>&nbsp;<span class="builtintype" id="7649929">string</span><span class="op" id="7649935">(</span><span class="ident" id="7649936">rest</span><span class="op" id="7649940">)</span><span class="op" id="7649941">,</span>&nbsp;<span class="string" id="7649943">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="7649952">;</span>&nbsp;<span class="ident" id="7649954">g</span>&nbsp;<span class="op" id="7649956">!=</span>&nbsp;<span class="ident" id="7649959">w</span>&nbsp;<span class="op" id="7649961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649965">t</span><span class="op" id="7649966">.</span><span class="ident" id="7649967">Errorf</span><span class="op" id="7649973">(</span><span class="string" id="7649974">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7649999">,</span>&nbsp;<span class="ident" id="7650001">g</span><span class="op" id="7650002">,</span>&nbsp;<span class="ident" id="7650004">w</span><span class="op" id="7650005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650008">}</span><br>
<span class="lineno"></span><span class="op" id="7650010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="7650013">func</span>&nbsp;<span class="ident" id="7650018">nlines</span><span class="op" id="7650024">(</span><span class="ident" id="7650025">s</span>&nbsp;<span class="builtintype" id="7650027">string</span><span class="op" id="7650033">,</span>&nbsp;<span class="ident" id="7650035">n</span>&nbsp;<span class="builtintype" id="7650037">int</span><span class="op" id="7650040">)</span>&nbsp;<span class="builtintype" id="7650042">string</span>&nbsp;<span class="op" id="7650049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650052">if</span>&nbsp;<span class="ident" id="7650055">n</span>&nbsp;<span class="op" id="7650057">&lt;=</span>&nbsp;<span class="num" id="7650060">0</span>&nbsp;<span class="op" id="7650062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650066">return</span>&nbsp;<span class="string" id="7650073">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650080">for</span>&nbsp;<span class="ident" id="7650084">i</span><span class="op" id="7650085">,</span>&nbsp;<span class="ident" id="7650087">c</span>&nbsp;<span class="op" id="7650089">:=</span>&nbsp;<span class="keyword" id="7650092">range</span>&nbsp;<span class="ident" id="7650098">s</span>&nbsp;<span class="op" id="7650100">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650104">if</span>&nbsp;<span class="ident" id="7650107">c</span>&nbsp;<span class="op" id="7650109">==</span>&nbsp;<span class="string" id="7650112">&#39;\n&#39;</span>&nbsp;<span class="op" id="7650117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650122">if</span>&nbsp;<span class="ident" id="7650125">n</span><span class="op" id="7650126">--</span><span class="op" id="7650128">;</span>&nbsp;<span class="ident" id="7650130">n</span>&nbsp;<span class="op" id="7650132">==</span>&nbsp;<span class="num" id="7650135">0</span>&nbsp;<span class="op" id="7650137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650143">return</span>&nbsp;<span class="ident" id="7650150">s</span><span class="op" id="7650151">[</span><span class="num" id="7650152">0</span>&nbsp;<span class="op" id="7650154">:</span>&nbsp;<span class="ident" id="7650156">i</span><span class="op" id="7650157">+</span><span class="num" id="7650158">1</span><span class="op" id="7650159">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650168">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650174">return</span>&nbsp;<span class="ident" id="7650181">s</span><br>
<span class="lineno"></span><span class="op" id="7650183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7650186">func</span>&nbsp;<span class="ident" id="7650191">TestRawMessage</span><span class="op" id="7650205">(</span><span class="ident" id="7650206">t</span>&nbsp;<span class="op" id="7650208">*</span><span class="ident" id="7650209">testing</span><span class="op" id="7650216">.</span><span class="ident" id="7650217">T</span><span class="op" id="7650218">)</span>&nbsp;<span class="op" id="7650220">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7650223">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650275">var</span>&nbsp;<span class="ident" id="7650279">data</span>&nbsp;<span class="keyword" id="7650284">struct</span>&nbsp;<span class="op" id="7650291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650295">X</span>&nbsp;&nbsp;<span class="builtintype" id="7650298">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650308">Id</span>&nbsp;<span class="op" id="7650311">*</span><span class="ident" id="7650312">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650325">Y</span>&nbsp;&nbsp;<span class="builtintype" id="7650328">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650340">const</span>&nbsp;<span class="ident" id="7650346">raw</span>&nbsp;<span class="op" id="7650350">=</span>&nbsp;<span class="string" id="7650352">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650371">const</span>&nbsp;<span class="ident" id="7650377">msg</span>&nbsp;<span class="op" id="7650381">=</span>&nbsp;<span class="string" id="7650383">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650425">err</span>&nbsp;<span class="op" id="7650429">:=</span>&nbsp;<span class="ident" id="7650432">Unmarshal</span><span class="op" id="7650441">(</span><span class="op" id="7650442">[</span><span class="op" id="7650443">]</span><span class="builtintype" id="7650444">byte</span><span class="op" id="7650448">(</span><span class="ident" id="7650449">msg</span><span class="op" id="7650452">)</span><span class="op" id="7650453">,</span>&nbsp;<span class="op" id="7650455">&amp;</span><span class="ident" id="7650456">data</span><span class="op" id="7650460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650463">if</span>&nbsp;<span class="ident" id="7650466">err</span>&nbsp;<span class="op" id="7650470">!=</span>&nbsp;<span class="ident" id="7650473">nil</span>&nbsp;<span class="op" id="7650477">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650481">t</span><span class="op" id="7650482">.</span><span class="ident" id="7650483">Fatalf</span><span class="op" id="7650489">(</span><span class="string" id="7650490">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="7650505">,</span>&nbsp;<span class="ident" id="7650507">err</span><span class="op" id="7650510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650516">if</span>&nbsp;<span class="builtintype" id="7650519">string</span><span class="op" id="7650525">(</span><span class="op" id="7650526">[</span><span class="op" id="7650527">]</span><span class="builtintype" id="7650528">byte</span><span class="op" id="7650532">(</span><span class="op" id="7650533">*</span><span class="ident" id="7650534">data</span><span class="op" id="7650538">.</span><span class="ident" id="7650539">Id</span><span class="op" id="7650541">)</span><span class="op" id="7650542">)</span>&nbsp;<span class="op" id="7650544">!=</span>&nbsp;<span class="ident" id="7650547">raw</span>&nbsp;<span class="op" id="7650551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650555">t</span><span class="op" id="7650556">.</span><span class="ident" id="7650557">Fatalf</span><span class="op" id="7650563">(</span><span class="string" id="7650564">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="7650597">,</span>&nbsp;<span class="op" id="7650599">[</span><span class="op" id="7650600">]</span><span class="builtintype" id="7650601">byte</span><span class="op" id="7650605">(</span><span class="op" id="7650606">*</span><span class="ident" id="7650607">data</span><span class="op" id="7650611">.</span><span class="ident" id="7650612">Id</span><span class="op" id="7650614">)</span><span class="op" id="7650615">,</span>&nbsp;<span class="ident" id="7650617">raw</span><span class="op" id="7650620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650623">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650626">b</span><span class="op" id="7650627">,</span>&nbsp;<span class="ident" id="7650629">err</span>&nbsp;<span class="op" id="7650633">:=</span>&nbsp;<span class="ident" id="7650636">Marshal</span><span class="op" id="7650643">(</span><span class="op" id="7650644">&amp;</span><span class="ident" id="7650645">data</span><span class="op" id="7650649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650652">if</span>&nbsp;<span class="ident" id="7650655">err</span>&nbsp;<span class="op" id="7650659">!=</span>&nbsp;<span class="ident" id="7650662">nil</span>&nbsp;<span class="op" id="7650666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650670">t</span><span class="op" id="7650671">.</span><span class="ident" id="7650672">Fatalf</span><span class="op" id="7650678">(</span><span class="string" id="7650679">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="7650692">,</span>&nbsp;<span class="ident" id="7650694">err</span><span class="op" id="7650697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650703">if</span>&nbsp;<span class="builtintype" id="7650706">string</span><span class="op" id="7650712">(</span><span class="ident" id="7650713">b</span><span class="op" id="7650714">)</span>&nbsp;<span class="op" id="7650716">!=</span>&nbsp;<span class="ident" id="7650719">msg</span>&nbsp;<span class="op" id="7650723">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650727">t</span><span class="op" id="7650728">.</span><span class="ident" id="7650729">Fatalf</span><span class="op" id="7650735">(</span><span class="string" id="7650736">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="7650764">,</span>&nbsp;<span class="ident" id="7650766">b</span><span class="op" id="7650767">,</span>&nbsp;<span class="ident" id="7650769">msg</span><span class="op" id="7650772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650775">}</span><br>
<span class="lineno"></span><span class="op" id="7650777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7650780">func</span>&nbsp;<span class="ident" id="7650785">TestNullRawMessage</span><span class="op" id="7650803">(</span><span class="ident" id="7650804">t</span>&nbsp;<span class="op" id="7650806">*</span><span class="ident" id="7650807">testing</span><span class="op" id="7650814">.</span><span class="ident" id="7650815">T</span><span class="op" id="7650816">)</span>&nbsp;<span class="op" id="7650818">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7650821">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650873">var</span>&nbsp;<span class="ident" id="7650877">data</span>&nbsp;<span class="keyword" id="7650882">struct</span>&nbsp;<span class="op" id="7650889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650893">X</span>&nbsp;&nbsp;<span class="builtintype" id="7650896">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650906">Id</span>&nbsp;<span class="op" id="7650909">*</span><span class="ident" id="7650910">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650923">Y</span>&nbsp;&nbsp;<span class="builtintype" id="7650926">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650938">data</span><span class="op" id="7650942">.</span><span class="ident" id="7650943">Id</span>&nbsp;<span class="op" id="7650946">=</span>&nbsp;<span class="builtinfunc" id="7650948">new</span><span class="op" id="7650951">(</span><span class="ident" id="7650952">RawMessage</span><span class="op" id="7650962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650965">const</span>&nbsp;<span class="ident" id="7650971">msg</span>&nbsp;<span class="op" id="7650975">=</span>&nbsp;<span class="string" id="7650977">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651008">err</span>&nbsp;<span class="op" id="7651012">:=</span>&nbsp;<span class="ident" id="7651015">Unmarshal</span><span class="op" id="7651024">(</span><span class="op" id="7651025">[</span><span class="op" id="7651026">]</span><span class="builtintype" id="7651027">byte</span><span class="op" id="7651031">(</span><span class="ident" id="7651032">msg</span><span class="op" id="7651035">)</span><span class="op" id="7651036">,</span>&nbsp;<span class="op" id="7651038">&amp;</span><span class="ident" id="7651039">data</span><span class="op" id="7651043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651046">if</span>&nbsp;<span class="ident" id="7651049">err</span>&nbsp;<span class="op" id="7651053">!=</span>&nbsp;<span class="ident" id="7651056">nil</span>&nbsp;<span class="op" id="7651060">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651064">t</span><span class="op" id="7651065">.</span><span class="ident" id="7651066">Fatalf</span><span class="op" id="7651072">(</span><span class="string" id="7651073">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="7651088">,</span>&nbsp;<span class="ident" id="7651090">err</span><span class="op" id="7651093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651099">if</span>&nbsp;<span class="ident" id="7651102">data</span><span class="op" id="7651106">.</span><span class="ident" id="7651107">Id</span>&nbsp;<span class="op" id="7651110">!=</span>&nbsp;<span class="ident" id="7651113">nil</span>&nbsp;<span class="op" id="7651117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651121">t</span><span class="op" id="7651122">.</span><span class="ident" id="7651123">Fatalf</span><span class="op" id="7651129">(</span><span class="string" id="7651130">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7651168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651171">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651174">b</span><span class="op" id="7651175">,</span>&nbsp;<span class="ident" id="7651177">err</span>&nbsp;<span class="op" id="7651181">:=</span>&nbsp;<span class="ident" id="7651184">Marshal</span><span class="op" id="7651191">(</span><span class="op" id="7651192">&amp;</span><span class="ident" id="7651193">data</span><span class="op" id="7651197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651200">if</span>&nbsp;<span class="ident" id="7651203">err</span>&nbsp;<span class="op" id="7651207">!=</span>&nbsp;<span class="ident" id="7651210">nil</span>&nbsp;<span class="op" id="7651214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651218">t</span><span class="op" id="7651219">.</span><span class="ident" id="7651220">Fatalf</span><span class="op" id="7651226">(</span><span class="string" id="7651227">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="7651240">,</span>&nbsp;<span class="ident" id="7651242">err</span><span class="op" id="7651245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651251">if</span>&nbsp;<span class="builtintype" id="7651254">string</span><span class="op" id="7651260">(</span><span class="ident" id="7651261">b</span><span class="op" id="7651262">)</span>&nbsp;<span class="op" id="7651264">!=</span>&nbsp;<span class="ident" id="7651267">msg</span>&nbsp;<span class="op" id="7651271">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651275">t</span><span class="op" id="7651276">.</span><span class="ident" id="7651277">Fatalf</span><span class="op" id="7651283">(</span><span class="string" id="7651284">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="7651312">,</span>&nbsp;<span class="ident" id="7651314">b</span><span class="op" id="7651315">,</span>&nbsp;<span class="ident" id="7651317">msg</span><span class="op" id="7651320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651323">}</span><br>
<span class="lineno"></span><span class="op" id="7651325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7651328">var</span>&nbsp;<span class="ident" id="7651332">blockingTests</span>&nbsp;<span class="op" id="7651346">=</span>&nbsp;<span class="op" id="7651348">[</span><span class="op" id="7651349">]</span><span class="builtintype" id="7651350">string</span><span class="op" id="7651356">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7651359">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="7651369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7651372">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="7651383">,</span><br>
<span class="lineno"></span><span class="op" id="7651385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7651388">func</span>&nbsp;<span class="ident" id="7651393">TestBlocking</span><span class="op" id="7651405">(</span><span class="ident" id="7651406">t</span>&nbsp;<span class="op" id="7651408">*</span><span class="ident" id="7651409">testing</span><span class="op" id="7651416">.</span><span class="ident" id="7651417">T</span><span class="op" id="7651418">)</span>&nbsp;<span class="op" id="7651420">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651423">for</span>&nbsp;<span class="ident" id="7651427">_</span><span class="op" id="7651428">,</span>&nbsp;<span class="ident" id="7651430">enc</span>&nbsp;<span class="op" id="7651434">:=</span>&nbsp;<span class="keyword" id="7651437">range</span>&nbsp;<span class="ident" id="7651443">blockingTests</span>&nbsp;<span class="op" id="7651457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651461">r</span><span class="op" id="7651462">,</span>&nbsp;<span class="ident" id="7651464">w</span>&nbsp;<span class="op" id="7651466">:=</span>&nbsp;<span class="ident" id="7651469">net</span><span class="op" id="7651472">.</span><span class="ident" id="7651473">Pipe</span><span class="op" id="7651477">(</span><span class="op" id="7651478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651482">go</span>&nbsp;<span class="ident" id="7651485">w</span><span class="op" id="7651486">.</span><span class="ident" id="7651487">Write</span><span class="op" id="7651492">(</span><span class="op" id="7651493">[</span><span class="op" id="7651494">]</span><span class="builtintype" id="7651495">byte</span><span class="op" id="7651499">(</span><span class="ident" id="7651500">enc</span><span class="op" id="7651503">)</span><span class="op" id="7651504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651508">var</span>&nbsp;<span class="ident" id="7651512">val</span>&nbsp;<span class="keyword" id="7651516">interface</span><span class="op" id="7651525">{</span><span class="op" id="7651526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7651531">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7651586">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651634">if</span>&nbsp;<span class="ident" id="7651637">err</span>&nbsp;<span class="op" id="7651641">:=</span>&nbsp;<span class="ident" id="7651644">NewDecoder</span><span class="op" id="7651654">(</span><span class="ident" id="7651655">r</span><span class="op" id="7651656">)</span><span class="op" id="7651657">.</span><span class="ident" id="7651658">Decode</span><span class="op" id="7651664">(</span><span class="op" id="7651665">&amp;</span><span class="ident" id="7651666">val</span><span class="op" id="7651669">)</span><span class="op" id="7651670">;</span>&nbsp;<span class="ident" id="7651672">err</span>&nbsp;<span class="op" id="7651676">!=</span>&nbsp;<span class="ident" id="7651679">nil</span>&nbsp;<span class="op" id="7651683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651688">t</span><span class="op" id="7651689">.</span><span class="ident" id="7651690">Errorf</span><span class="op" id="7651696">(</span><span class="string" id="7651697">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7651714">,</span>&nbsp;<span class="ident" id="7651716">enc</span><span class="op" id="7651719">,</span>&nbsp;<span class="ident" id="7651721">err</span><span class="op" id="7651724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651728">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651732">r</span><span class="op" id="7651733">.</span><span class="ident" id="7651734">Close</span><span class="op" id="7651739">(</span><span class="op" id="7651740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651744">w</span><span class="op" id="7651745">.</span><span class="ident" id="7651746">Close</span><span class="op" id="7651751">(</span><span class="op" id="7651752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651755">}</span><br>
<span class="lineno"></span><span class="op" id="7651757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="7651760">func</span>&nbsp;<span class="ident" id="7651765">BenchmarkEncoderEncode</span><span class="op" id="7651787">(</span><span class="ident" id="7651788">b</span>&nbsp;<span class="op" id="7651790">*</span><span class="ident" id="7651791">testing</span><span class="op" id="7651798">.</span><span class="ident" id="7651799">B</span><span class="op" id="7651800">)</span>&nbsp;<span class="op" id="7651802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651805">b</span><span class="op" id="7651806">.</span><span class="ident" id="7651807">ReportAllocs</span><span class="op" id="7651819">(</span><span class="op" id="7651820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651823">type</span>&nbsp;<span class="ident" id="7651828">T</span>&nbsp;<span class="keyword" id="7651830">struct</span>&nbsp;<span class="op" id="7651837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651841">X</span><span class="op" id="7651842">,</span>&nbsp;<span class="ident" id="7651844">Y</span>&nbsp;<span class="builtintype" id="7651846">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651854">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651857">v</span>&nbsp;<span class="op" id="7651859">:=</span>&nbsp;<span class="op" id="7651862">&amp;</span><span class="ident" id="7651863">T</span><span class="op" id="7651864">{</span><span class="string" id="7651865">&#34;foo&#34;</span><span class="op" id="7651870">,</span>&nbsp;<span class="string" id="7651872">&#34;bar&#34;</span><span class="op" id="7651877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651880">for</span>&nbsp;<span class="ident" id="7651884">i</span>&nbsp;<span class="op" id="7651886">:=</span>&nbsp;<span class="num" id="7651889">0</span><span class="op" id="7651890">;</span>&nbsp;<span class="ident" id="7651892">i</span>&nbsp;<span class="op" id="7651894">&lt;</span>&nbsp;<span class="ident" id="7651896">b</span><span class="op" id="7651897">.</span><span class="ident" id="7651898">N</span><span class="op" id="7651899">;</span>&nbsp;<span class="ident" id="7651901">i</span><span class="op" id="7651902">++</span>&nbsp;<span class="op" id="7651905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7651909">if</span>&nbsp;<span class="ident" id="7651912">err</span>&nbsp;<span class="op" id="7651916">:=</span>&nbsp;<span class="ident" id="7651919">NewEncoder</span><span class="op" id="7651929">(</span><span class="ident" id="7651930">ioutil</span><span class="op" id="7651936">.</span><span class="ident" id="7651937">Discard</span><span class="op" id="7651944">)</span><span class="op" id="7651945">.</span><span class="ident" id="7651946">Encode</span><span class="op" id="7651952">(</span><span class="ident" id="7651953">v</span><span class="op" id="7651954">)</span><span class="op" id="7651955">;</span>&nbsp;<span class="ident" id="7651957">err</span>&nbsp;<span class="op" id="7651961">!=</span>&nbsp;<span class="ident" id="7651964">nil</span>&nbsp;<span class="op" id="7651968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651973">b</span><span class="op" id="7651974">.</span><span class="ident" id="7651975">Fatal</span><span class="op" id="7651980">(</span><span class="ident" id="7651981">err</span><span class="op" id="7651984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651988">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651991">}</span><br>
<span class="lineno"></span><span class="op" id="7651993">}</span>
</div>
</body>
</html>
