<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3379289">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3379345">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3379399">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3379450">package</span>&nbsp;<span class="ident" id="3379458">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3379463">import</span>&nbsp;<span class="string" id="3379470">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3379478">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3379536">type</span>&nbsp;<span class="ident" id="3379541">call</span>&nbsp;<span class="keyword" id="3379546">struct</span>&nbsp;<span class="op" id="3379553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379556">wg</span>&nbsp;<span class="ident" id="3379559">sync</span><span class="op" id="3379563">.</span><span class="ident" id="3379564">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379576">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379639">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379690">val</span>&nbsp;<span class="keyword" id="3379694">interface</span><span class="op" id="3379703">{</span><span class="op" id="3379704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379707">err</span>&nbsp;<span class="builtintype" id="3379711">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379719">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379779">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379841">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379886">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3379892">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379897">chans</span>&nbsp;<span class="op" id="3379903">[</span><span class="op" id="3379904">]</span><span class="keyword" id="3379905">chan</span><span class="op" id="3379909">&lt;-</span>&nbsp;<span class="ident" id="3379912">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3379931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3379934">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3380002">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3380069">type</span>&nbsp;<span class="ident" id="3380074">singleflight</span>&nbsp;<span class="keyword" id="3380087">struct</span>&nbsp;<span class="op" id="3380094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380097">mu</span>&nbsp;<span class="ident" id="3380100">sync</span><span class="op" id="3380104">.</span><span class="ident" id="3380105">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3380117">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380132">m</span>&nbsp;&nbsp;<span class="keyword" id="3380135">map</span><span class="op" id="3380138">[</span><span class="builtintype" id="3380139">string</span><span class="op" id="3380145">]</span><span class="op" id="3380146">*</span><span class="ident" id="3380147">call</span>&nbsp;<span class="comment" id="3380152">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3380174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3380177">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3380246">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3380263">type</span>&nbsp;<span class="ident" id="3380268">singleflightResult</span>&nbsp;<span class="keyword" id="3380287">struct</span>&nbsp;<span class="op" id="3380294">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380297">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3380304">interface</span><span class="op" id="3380313">{</span><span class="op" id="3380314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380317">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3380324">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380331">shared</span>&nbsp;<span class="builtintype" id="3380338">bool</span><br>
<span class="lineno"></span><span class="op" id="3380343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3380346">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3380415">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3380481">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3380550">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3380605">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3380683">func</span>&nbsp;<span class="op" id="3380688">(</span><span class="ident" id="3380689">g</span>&nbsp;<span class="op" id="3380691">*</span><span class="ident" id="3380692">singleflight</span><span class="op" id="3380704">)</span>&nbsp;<span class="ident" id="3380706">Do</span><span class="op" id="3380708">(</span><span class="ident" id="3380709">key</span>&nbsp;<span class="builtintype" id="3380713">string</span><span class="op" id="3380719">,</span>&nbsp;<span class="ident" id="3380721">fn</span>&nbsp;<span class="keyword" id="3380724">func</span><span class="op" id="3380728">(</span><span class="op" id="3380729">)</span>&nbsp;<span class="op" id="3380731">(</span><span class="keyword" id="3380732">interface</span><span class="op" id="3380741">{</span><span class="op" id="3380742">}</span><span class="op" id="3380743">,</span>&nbsp;<span class="builtintype" id="3380745">error</span><span class="op" id="3380750">)</span><span class="op" id="3380751">)</span>&nbsp;<span class="op" id="3380753">(</span><span class="ident" id="3380754">v</span>&nbsp;<span class="keyword" id="3380756">interface</span><span class="op" id="3380765">{</span><span class="op" id="3380766">}</span><span class="op" id="3380767">,</span>&nbsp;<span class="ident" id="3380769">err</span>&nbsp;<span class="builtintype" id="3380773">error</span><span class="op" id="3380778">,</span>&nbsp;<span class="ident" id="3380780">shared</span>&nbsp;<span class="builtintype" id="3380787">bool</span><span class="op" id="3380791">)</span>&nbsp;<span class="op" id="3380793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380796">g</span><span class="op" id="3380797">.</span><span class="ident" id="3380798">mu</span><span class="op" id="3380800">.</span><span class="ident" id="3380801">Lock</span><span class="op" id="3380805">(</span><span class="op" id="3380806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380809">if</span>&nbsp;<span class="ident" id="3380812">g</span><span class="op" id="3380813">.</span><span class="ident" id="3380814">m</span>&nbsp;<span class="op" id="3380816">==</span>&nbsp;<span class="ident" id="3380819">nil</span>&nbsp;<span class="op" id="3380823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380827">g</span><span class="op" id="3380828">.</span><span class="ident" id="3380829">m</span>&nbsp;<span class="op" id="3380831">=</span>&nbsp;<span class="builtinfunc" id="3380833">make</span><span class="op" id="3380837">(</span><span class="keyword" id="3380838">map</span><span class="op" id="3380841">[</span><span class="builtintype" id="3380842">string</span><span class="op" id="3380848">]</span><span class="op" id="3380849">*</span><span class="ident" id="3380850">call</span><span class="op" id="3380854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380857">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380860">if</span>&nbsp;<span class="ident" id="3380863">c</span><span class="op" id="3380864">,</span>&nbsp;<span class="ident" id="3380866">ok</span>&nbsp;<span class="op" id="3380869">:=</span>&nbsp;<span class="ident" id="3380872">g</span><span class="op" id="3380873">.</span><span class="ident" id="3380874">m</span><span class="op" id="3380875">[</span><span class="ident" id="3380876">key</span><span class="op" id="3380879">]</span><span class="op" id="3380880">;</span>&nbsp;<span class="ident" id="3380882">ok</span>&nbsp;<span class="op" id="3380885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380889">c</span><span class="op" id="3380890">.</span><span class="ident" id="3380891">dups</span><span class="op" id="3380895">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380900">g</span><span class="op" id="3380901">.</span><span class="ident" id="3380902">mu</span><span class="op" id="3380904">.</span><span class="ident" id="3380905">Unlock</span><span class="op" id="3380911">(</span><span class="op" id="3380912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380916">c</span><span class="op" id="3380917">.</span><span class="ident" id="3380918">wg</span><span class="op" id="3380920">.</span><span class="ident" id="3380921">Wait</span><span class="op" id="3380925">(</span><span class="op" id="3380926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380930">return</span>&nbsp;<span class="ident" id="3380937">c</span><span class="op" id="3380938">.</span><span class="ident" id="3380939">val</span><span class="op" id="3380942">,</span>&nbsp;<span class="ident" id="3380944">c</span><span class="op" id="3380945">.</span><span class="ident" id="3380946">err</span><span class="op" id="3380949">,</span>&nbsp;<span class="builtintype" id="3380951">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380960">c</span>&nbsp;<span class="op" id="3380962">:=</span>&nbsp;<span class="builtinfunc" id="3380965">new</span><span class="op" id="3380968">(</span><span class="ident" id="3380969">call</span><span class="op" id="3380973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380976">c</span><span class="op" id="3380977">.</span><span class="ident" id="3380978">wg</span><span class="op" id="3380980">.</span><span class="ident" id="3380981">Add</span><span class="op" id="3380984">(</span><span class="num" id="3380985">1</span><span class="op" id="3380986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380989">g</span><span class="op" id="3380990">.</span><span class="ident" id="3380991">m</span><span class="op" id="3380992">[</span><span class="ident" id="3380993">key</span><span class="op" id="3380996">]</span>&nbsp;<span class="op" id="3380998">=</span>&nbsp;<span class="ident" id="3381000">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381003">g</span><span class="op" id="3381004">.</span><span class="ident" id="3381005">mu</span><span class="op" id="3381007">.</span><span class="ident" id="3381008">Unlock</span><span class="op" id="3381014">(</span><span class="op" id="3381015">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381019">g</span><span class="op" id="3381020">.</span><span class="ident" id="3381021">doCall</span><span class="op" id="3381027">(</span><span class="ident" id="3381028">c</span><span class="op" id="3381029">,</span>&nbsp;<span class="ident" id="3381031">key</span><span class="op" id="3381034">,</span>&nbsp;<span class="ident" id="3381036">fn</span><span class="op" id="3381038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381041">return</span>&nbsp;<span class="ident" id="3381048">c</span><span class="op" id="3381049">.</span><span class="ident" id="3381050">val</span><span class="op" id="3381053">,</span>&nbsp;<span class="ident" id="3381055">c</span><span class="op" id="3381056">.</span><span class="ident" id="3381057">err</span><span class="op" id="3381060">,</span>&nbsp;<span class="ident" id="3381062">c</span><span class="op" id="3381063">.</span><span class="ident" id="3381064">dups</span>&nbsp;<span class="op" id="3381069">&gt;</span>&nbsp;<span class="num" id="3381071">0</span><br>
<span class="lineno"></span><span class="op" id="3381073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3381076">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3381141">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3381173">func</span>&nbsp;<span class="op" id="3381178">(</span><span class="ident" id="3381179">g</span>&nbsp;<span class="op" id="3381181">*</span><span class="ident" id="3381182">singleflight</span><span class="op" id="3381194">)</span>&nbsp;<span class="ident" id="3381196">DoChan</span><span class="op" id="3381202">(</span><span class="ident" id="3381203">key</span>&nbsp;<span class="builtintype" id="3381207">string</span><span class="op" id="3381213">,</span>&nbsp;<span class="ident" id="3381215">fn</span>&nbsp;<span class="keyword" id="3381218">func</span><span class="op" id="3381222">(</span><span class="op" id="3381223">)</span>&nbsp;<span class="op" id="3381225">(</span><span class="keyword" id="3381226">interface</span><span class="op" id="3381235">{</span><span class="op" id="3381236">}</span><span class="op" id="3381237">,</span>&nbsp;<span class="builtintype" id="3381239">error</span><span class="op" id="3381244">)</span><span class="op" id="3381245">)</span>&nbsp;<span class="op" id="3381247">&lt;-</span><span class="keyword" id="3381249">chan</span>&nbsp;<span class="ident" id="3381254">singleflightResult</span>&nbsp;<span class="op" id="3381273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381276">ch</span>&nbsp;<span class="op" id="3381279">:=</span>&nbsp;<span class="builtinfunc" id="3381282">make</span><span class="op" id="3381286">(</span><span class="keyword" id="3381287">chan</span>&nbsp;<span class="ident" id="3381292">singleflightResult</span><span class="op" id="3381310">,</span>&nbsp;<span class="num" id="3381312">1</span><span class="op" id="3381313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381316">g</span><span class="op" id="3381317">.</span><span class="ident" id="3381318">mu</span><span class="op" id="3381320">.</span><span class="ident" id="3381321">Lock</span><span class="op" id="3381325">(</span><span class="op" id="3381326">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381329">if</span>&nbsp;<span class="ident" id="3381332">g</span><span class="op" id="3381333">.</span><span class="ident" id="3381334">m</span>&nbsp;<span class="op" id="3381336">==</span>&nbsp;<span class="ident" id="3381339">nil</span>&nbsp;<span class="op" id="3381343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381347">g</span><span class="op" id="3381348">.</span><span class="ident" id="3381349">m</span>&nbsp;<span class="op" id="3381351">=</span>&nbsp;<span class="builtinfunc" id="3381353">make</span><span class="op" id="3381357">(</span><span class="keyword" id="3381358">map</span><span class="op" id="3381361">[</span><span class="builtintype" id="3381362">string</span><span class="op" id="3381368">]</span><span class="op" id="3381369">*</span><span class="ident" id="3381370">call</span><span class="op" id="3381374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381380">if</span>&nbsp;<span class="ident" id="3381383">c</span><span class="op" id="3381384">,</span>&nbsp;<span class="ident" id="3381386">ok</span>&nbsp;<span class="op" id="3381389">:=</span>&nbsp;<span class="ident" id="3381392">g</span><span class="op" id="3381393">.</span><span class="ident" id="3381394">m</span><span class="op" id="3381395">[</span><span class="ident" id="3381396">key</span><span class="op" id="3381399">]</span><span class="op" id="3381400">;</span>&nbsp;<span class="ident" id="3381402">ok</span>&nbsp;<span class="op" id="3381405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381409">c</span><span class="op" id="3381410">.</span><span class="ident" id="3381411">dups</span><span class="op" id="3381415">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381420">c</span><span class="op" id="3381421">.</span><span class="ident" id="3381422">chans</span>&nbsp;<span class="op" id="3381428">=</span>&nbsp;<span class="builtinfunc" id="3381430">append</span><span class="op" id="3381436">(</span><span class="ident" id="3381437">c</span><span class="op" id="3381438">.</span><span class="ident" id="3381439">chans</span><span class="op" id="3381444">,</span>&nbsp;<span class="ident" id="3381446">ch</span><span class="op" id="3381448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381452">g</span><span class="op" id="3381453">.</span><span class="ident" id="3381454">mu</span><span class="op" id="3381456">.</span><span class="ident" id="3381457">Unlock</span><span class="op" id="3381463">(</span><span class="op" id="3381464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381468">return</span>&nbsp;<span class="ident" id="3381475">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381482">c</span>&nbsp;<span class="op" id="3381484">:=</span>&nbsp;<span class="op" id="3381487">&amp;</span><span class="ident" id="3381488">call</span><span class="op" id="3381492">{</span><span class="ident" id="3381493">chans</span><span class="op" id="3381498">:</span>&nbsp;<span class="op" id="3381500">[</span><span class="op" id="3381501">]</span><span class="keyword" id="3381502">chan</span><span class="op" id="3381506">&lt;-</span>&nbsp;<span class="ident" id="3381509">singleflightResult</span><span class="op" id="3381527">{</span><span class="ident" id="3381528">ch</span><span class="op" id="3381530">}</span><span class="op" id="3381531">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381534">c</span><span class="op" id="3381535">.</span><span class="ident" id="3381536">wg</span><span class="op" id="3381538">.</span><span class="ident" id="3381539">Add</span><span class="op" id="3381542">(</span><span class="num" id="3381543">1</span><span class="op" id="3381544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381547">g</span><span class="op" id="3381548">.</span><span class="ident" id="3381549">m</span><span class="op" id="3381550">[</span><span class="ident" id="3381551">key</span><span class="op" id="3381554">]</span>&nbsp;<span class="op" id="3381556">=</span>&nbsp;<span class="ident" id="3381558">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381561">g</span><span class="op" id="3381562">.</span><span class="ident" id="3381563">mu</span><span class="op" id="3381565">.</span><span class="ident" id="3381566">Unlock</span><span class="op" id="3381572">(</span><span class="op" id="3381573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381577">go</span>&nbsp;<span class="ident" id="3381580">g</span><span class="op" id="3381581">.</span><span class="ident" id="3381582">doCall</span><span class="op" id="3381588">(</span><span class="ident" id="3381589">c</span><span class="op" id="3381590">,</span>&nbsp;<span class="ident" id="3381592">key</span><span class="op" id="3381595">,</span>&nbsp;<span class="ident" id="3381597">fn</span><span class="op" id="3381599">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381603">return</span>&nbsp;<span class="ident" id="3381610">ch</span><br>
<span class="lineno"></span><span class="op" id="3381613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3381616">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3381661">func</span>&nbsp;<span class="op" id="3381666">(</span><span class="ident" id="3381667">g</span>&nbsp;<span class="op" id="3381669">*</span><span class="ident" id="3381670">singleflight</span><span class="op" id="3381682">)</span>&nbsp;<span class="ident" id="3381684">doCall</span><span class="op" id="3381690">(</span><span class="ident" id="3381691">c</span>&nbsp;<span class="op" id="3381693">*</span><span class="ident" id="3381694">call</span><span class="op" id="3381698">,</span>&nbsp;<span class="ident" id="3381700">key</span>&nbsp;<span class="builtintype" id="3381704">string</span><span class="op" id="3381710">,</span>&nbsp;<span class="ident" id="3381712">fn</span>&nbsp;<span class="keyword" id="3381715">func</span><span class="op" id="3381719">(</span><span class="op" id="3381720">)</span>&nbsp;<span class="op" id="3381722">(</span><span class="keyword" id="3381723">interface</span><span class="op" id="3381732">{</span><span class="op" id="3381733">}</span><span class="op" id="3381734">,</span>&nbsp;<span class="builtintype" id="3381736">error</span><span class="op" id="3381741">)</span><span class="op" id="3381742">)</span>&nbsp;<span class="op" id="3381744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381747">c</span><span class="op" id="3381748">.</span><span class="ident" id="3381749">val</span><span class="op" id="3381752">,</span>&nbsp;<span class="ident" id="3381754">c</span><span class="op" id="3381755">.</span><span class="ident" id="3381756">err</span>&nbsp;<span class="op" id="3381760">=</span>&nbsp;<span class="ident" id="3381762">fn</span><span class="op" id="3381764">(</span><span class="op" id="3381765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381768">c</span><span class="op" id="3381769">.</span><span class="ident" id="3381770">wg</span><span class="op" id="3381772">.</span><span class="ident" id="3381773">Done</span><span class="op" id="3381777">(</span><span class="op" id="3381778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381782">g</span><span class="op" id="3381783">.</span><span class="ident" id="3381784">mu</span><span class="op" id="3381786">.</span><span class="ident" id="3381787">Lock</span><span class="op" id="3381791">(</span><span class="op" id="3381792">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3381795">delete</span><span class="op" id="3381801">(</span><span class="ident" id="3381802">g</span><span class="op" id="3381803">.</span><span class="ident" id="3381804">m</span><span class="op" id="3381805">,</span>&nbsp;<span class="ident" id="3381807">key</span><span class="op" id="3381810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381813">for</span>&nbsp;<span class="ident" id="3381817">_</span><span class="op" id="3381818">,</span>&nbsp;<span class="ident" id="3381820">ch</span>&nbsp;<span class="op" id="3381823">:=</span>&nbsp;<span class="keyword" id="3381826">range</span>&nbsp;<span class="ident" id="3381832">c</span><span class="op" id="3381833">.</span><span class="ident" id="3381834">chans</span>&nbsp;<span class="op" id="3381840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381844">ch</span>&nbsp;<span class="op" id="3381847">&lt;-</span>&nbsp;<span class="ident" id="3381850">singleflightResult</span><span class="op" id="3381868">{</span><span class="ident" id="3381869">c</span><span class="op" id="3381870">.</span><span class="ident" id="3381871">val</span><span class="op" id="3381874">,</span>&nbsp;<span class="ident" id="3381876">c</span><span class="op" id="3381877">.</span><span class="ident" id="3381878">err</span><span class="op" id="3381881">,</span>&nbsp;<span class="ident" id="3381883">c</span><span class="op" id="3381884">.</span><span class="ident" id="3381885">dups</span>&nbsp;<span class="op" id="3381890">&gt;</span>&nbsp;<span class="num" id="3381892">0</span><span class="op" id="3381893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381899">g</span><span class="op" id="3381900">.</span><span class="ident" id="3381901">mu</span><span class="op" id="3381903">.</span><span class="ident" id="3381904">Unlock</span><span class="op" id="3381910">(</span><span class="op" id="3381911">)</span><br>
<span class="lineno">100</span><span class="op" id="3381913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3381916">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3381986">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3382055">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3382087">func</span>&nbsp;<span class="op" id="3382092">(</span><span class="ident" id="3382093">g</span>&nbsp;<span class="op" id="3382095">*</span><span class="ident" id="3382096">singleflight</span><span class="op" id="3382108">)</span>&nbsp;<span class="ident" id="3382110">Forget</span><span class="op" id="3382116">(</span><span class="ident" id="3382117">key</span>&nbsp;<span class="builtintype" id="3382121">string</span><span class="op" id="3382127">)</span>&nbsp;<span class="op" id="3382129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382132">g</span><span class="op" id="3382133">.</span><span class="ident" id="3382134">mu</span><span class="op" id="3382136">.</span><span class="ident" id="3382137">Lock</span><span class="op" id="3382141">(</span><span class="op" id="3382142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3382145">delete</span><span class="op" id="3382151">(</span><span class="ident" id="3382152">g</span><span class="op" id="3382153">.</span><span class="ident" id="3382154">m</span><span class="op" id="3382155">,</span>&nbsp;<span class="ident" id="3382157">key</span><span class="op" id="3382160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382163">g</span><span class="op" id="3382164">.</span><span class="ident" id="3382165">mu</span><span class="op" id="3382167">.</span><span class="ident" id="3382168">Unlock</span><span class="op" id="3382174">(</span><span class="op" id="3382175">)</span><br>
<span class="lineno"></span><span class="op" id="3382177">}</span>
</div>
</body>
</html>
