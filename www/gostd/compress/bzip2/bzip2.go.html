<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6220435">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6220490">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6220544">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6220595">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="6220644">package</span>&nbsp;<span class="ident" id="6220652">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6220659">import</span>&nbsp;<span class="string" id="6220666">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6220672">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="6220751">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="6220802">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="6220858">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="6220906">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6220974">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="6221000">type</span>&nbsp;<span class="ident" id="6221005">StructuralError</span>&nbsp;<span class="builtintype" id="6221021">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6221029">func</span>&nbsp;<span class="op" id="6221034">(</span><span class="ident" id="6221035">s</span>&nbsp;<span class="ident" id="6221037">StructuralError</span><span class="op" id="6221052">)</span>&nbsp;<span class="ident" id="6221054">Error</span><span class="op" id="6221059">(</span><span class="op" id="6221060">)</span>&nbsp;<span class="builtintype" id="6221062">string</span>&nbsp;<span class="op" id="6221069">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6221072">return</span>&nbsp;<span class="string" id="6221079">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="6221102">+</span>&nbsp;<span class="builtintype" id="6221104">string</span><span class="op" id="6221110">(</span><span class="ident" id="6221111">s</span><span class="op" id="6221112">)</span><br>
<span class="lineno"></span><span class="op" id="6221114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6221117">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6221165">type</span>&nbsp;<span class="ident" id="6221170">reader</span>&nbsp;<span class="keyword" id="6221177">struct</span>&nbsp;<span class="op" id="6221184">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221187">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6221200">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221211">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221224">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221232">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221245">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221253">wantBlockCRC</span>&nbsp;<span class="builtintype" id="6221266">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221274">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221287">bool</span>&nbsp;<span class="comment" id="6221292">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221337">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221350">int</span>&nbsp;&nbsp;<span class="comment" id="6221355">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221396">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221409">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221415">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221428">[</span><span class="op" id="6221429">]</span><span class="builtintype" id="6221430">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221438">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221483">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221496">[</span><span class="num" id="6221497">256</span><span class="op" id="6221500">]</span><span class="builtintype" id="6221501">uint</span>&nbsp;<span class="comment" id="6221506">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221545">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221558">[</span><span class="op" id="6221559">]</span><span class="builtintype" id="6221560">uint32</span>&nbsp;&nbsp;<span class="comment" id="6221568">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221662">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221675">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221685">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221727">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6221739">[</span><span class="op" id="6221740">]</span><span class="builtintype" id="6221741">uint32</span>&nbsp;<span class="comment" id="6221748">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221797">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="6221809">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221818">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221856">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221868">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221877">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221907">byteRepeats</span>&nbsp;<span class="builtintype" id="6221919">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221928">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6221972">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6221984">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6221993">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="6222040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6222043">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="6222115">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="6222162">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6222224">func</span>&nbsp;<span class="ident" id="6222229">NewReader</span><span class="op" id="6222238">(</span><span class="ident" id="6222239">r</span>&nbsp;<span class="ident" id="6222241">io</span><span class="op" id="6222243">.</span><span class="ident" id="6222244">Reader</span><span class="op" id="6222250">)</span>&nbsp;<span class="ident" id="6222252">io</span><span class="op" id="6222254">.</span><span class="ident" id="6222255">Reader</span>&nbsp;<span class="op" id="6222262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222265">bz2</span>&nbsp;<span class="op" id="6222269">:=</span>&nbsp;<span class="builtinfunc" id="6222272">new</span><span class="op" id="6222275">(</span><span class="ident" id="6222276">reader</span><span class="op" id="6222282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222285">bz2</span><span class="op" id="6222288">.</span><span class="ident" id="6222289">br</span>&nbsp;<span class="op" id="6222292">=</span>&nbsp;<span class="ident" id="6222294">newBitReader</span><span class="op" id="6222306">(</span><span class="ident" id="6222307">r</span><span class="op" id="6222308">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222311">return</span>&nbsp;<span class="ident" id="6222318">bz2</span><br>
<span class="lineno"></span><span class="op" id="6222322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6222325">const</span>&nbsp;<span class="ident" id="6222331">bzip2FileMagic</span>&nbsp;<span class="op" id="6222346">=</span>&nbsp;<span class="num" id="6222348">0x425a</span>&nbsp;<span class="comment" id="6222355">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6222363">const</span>&nbsp;<span class="ident" id="6222369">bzip2BlockMagic</span>&nbsp;<span class="op" id="6222385">=</span>&nbsp;<span class="num" id="6222387">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="6222402">const</span>&nbsp;<span class="ident" id="6222408">bzip2FinalMagic</span>&nbsp;<span class="op" id="6222424">=</span>&nbsp;<span class="num" id="6222426">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6222442">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6222476">func</span>&nbsp;<span class="op" id="6222481">(</span><span class="ident" id="6222482">bz2</span>&nbsp;<span class="op" id="6222486">*</span><span class="ident" id="6222487">reader</span><span class="op" id="6222493">)</span>&nbsp;<span class="ident" id="6222495">setup</span><span class="op" id="6222500">(</span><span class="ident" id="6222501">needMagic</span>&nbsp;<span class="builtintype" id="6222511">bool</span><span class="op" id="6222515">)</span>&nbsp;<span class="builtintype" id="6222517">error</span>&nbsp;<span class="op" id="6222523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222526">br</span>&nbsp;<span class="op" id="6222529">:=</span>&nbsp;<span class="op" id="6222532">&amp;</span><span class="ident" id="6222533">bz2</span><span class="op" id="6222536">.</span><span class="ident" id="6222537">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222542">if</span>&nbsp;<span class="ident" id="6222545">needMagic</span>&nbsp;<span class="op" id="6222555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222559">magic</span>&nbsp;<span class="op" id="6222565">:=</span>&nbsp;<span class="ident" id="6222568">br</span><span class="op" id="6222570">.</span><span class="ident" id="6222571">ReadBits</span><span class="op" id="6222579">(</span><span class="num" id="6222580">16</span><span class="op" id="6222582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222586">if</span>&nbsp;<span class="ident" id="6222589">magic</span>&nbsp;<span class="op" id="6222595">!=</span>&nbsp;<span class="ident" id="6222598">bzip2FileMagic</span>&nbsp;<span class="op" id="6222613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222618">return</span>&nbsp;<span class="ident" id="6222625">StructuralError</span><span class="op" id="6222640">(</span><span class="string" id="6222641">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="6222658">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6222662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6222665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222669">t</span>&nbsp;<span class="op" id="6222671">:=</span>&nbsp;<span class="ident" id="6222674">br</span><span class="op" id="6222676">.</span><span class="ident" id="6222677">ReadBits</span><span class="op" id="6222685">(</span><span class="num" id="6222686">8</span><span class="op" id="6222687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222690">if</span>&nbsp;<span class="ident" id="6222693">t</span>&nbsp;<span class="op" id="6222695">!=</span>&nbsp;<span class="string" id="6222698">&#39;h&#39;</span>&nbsp;<span class="op" id="6222702">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222706">return</span>&nbsp;<span class="ident" id="6222713">StructuralError</span><span class="op" id="6222728">(</span><span class="string" id="6222729">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="6222759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6222762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222766">level</span>&nbsp;<span class="op" id="6222772">:=</span>&nbsp;<span class="ident" id="6222775">br</span><span class="op" id="6222777">.</span><span class="ident" id="6222778">ReadBits</span><span class="op" id="6222786">(</span><span class="num" id="6222787">8</span><span class="op" id="6222788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222791">if</span>&nbsp;<span class="ident" id="6222794">level</span>&nbsp;<span class="op" id="6222800">&lt;</span>&nbsp;<span class="string" id="6222802">&#39;1&#39;</span>&nbsp;<span class="op" id="6222806">||</span>&nbsp;<span class="ident" id="6222809">level</span>&nbsp;<span class="op" id="6222815">&gt;</span>&nbsp;<span class="string" id="6222817">&#39;9&#39;</span>&nbsp;<span class="op" id="6222821">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222825">return</span>&nbsp;<span class="ident" id="6222832">StructuralError</span><span class="op" id="6222847">(</span><span class="string" id="6222848">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="6222875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6222878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222882">bz2</span><span class="op" id="6222885">.</span><span class="ident" id="6222886">fileCRC</span>&nbsp;<span class="op" id="6222894">=</span>&nbsp;<span class="num" id="6222896">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222899">bz2</span><span class="op" id="6222902">.</span><span class="ident" id="6222903">blockSize</span>&nbsp;<span class="op" id="6222913">=</span>&nbsp;<span class="num" id="6222915">100</span>&nbsp;<span class="op" id="6222919">*</span>&nbsp;<span class="num" id="6222921">1024</span>&nbsp;<span class="op" id="6222926">*</span>&nbsp;<span class="op" id="6222928">(</span><span class="builtintype" id="6222929">int</span><span class="op" id="6222932">(</span><span class="ident" id="6222933">level</span><span class="op" id="6222938">)</span>&nbsp;<span class="op" id="6222940">-</span>&nbsp;<span class="string" id="6222942">&#39;0&#39;</span><span class="op" id="6222945">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6222948">if</span>&nbsp;<span class="ident" id="6222951">bz2</span><span class="op" id="6222954">.</span><span class="ident" id="6222955">blockSize</span>&nbsp;<span class="op" id="6222965">&gt;</span>&nbsp;<span class="builtinfunc" id="6222967">len</span><span class="op" id="6222970">(</span><span class="ident" id="6222971">bz2</span><span class="op" id="6222974">.</span><span class="ident" id="6222975">tt</span><span class="op" id="6222977">)</span>&nbsp;<span class="op" id="6222979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6222983">bz2</span><span class="op" id="6222986">.</span><span class="ident" id="6222987">tt</span>&nbsp;<span class="op" id="6222990">=</span>&nbsp;<span class="builtinfunc" id="6222992">make</span><span class="op" id="6222996">(</span><span class="op" id="6222997">[</span><span class="op" id="6222998">]</span><span class="builtintype" id="6222999">uint32</span><span class="op" id="6223005">,</span>&nbsp;<span class="ident" id="6223007">bz2</span><span class="op" id="6223010">.</span><span class="ident" id="6223011">blockSize</span><span class="op" id="6223020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6223023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223026">return</span>&nbsp;<span class="ident" id="6223033">nil</span><br>
<span class="lineno"></span><span class="op" id="6223037">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="6223040">func</span>&nbsp;<span class="op" id="6223045">(</span><span class="ident" id="6223046">bz2</span>&nbsp;<span class="op" id="6223050">*</span><span class="ident" id="6223051">reader</span><span class="op" id="6223057">)</span>&nbsp;<span class="ident" id="6223059">Read</span><span class="op" id="6223063">(</span><span class="ident" id="6223064">buf</span>&nbsp;<span class="op" id="6223068">[</span><span class="op" id="6223069">]</span><span class="builtintype" id="6223070">byte</span><span class="op" id="6223074">)</span>&nbsp;<span class="op" id="6223076">(</span><span class="ident" id="6223077">n</span>&nbsp;<span class="builtintype" id="6223079">int</span><span class="op" id="6223082">,</span>&nbsp;<span class="ident" id="6223084">err</span>&nbsp;<span class="builtintype" id="6223088">error</span><span class="op" id="6223093">)</span>&nbsp;<span class="op" id="6223095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223098">if</span>&nbsp;<span class="ident" id="6223101">bz2</span><span class="op" id="6223104">.</span><span class="ident" id="6223105">eof</span>&nbsp;<span class="op" id="6223109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223113">return</span>&nbsp;<span class="num" id="6223120">0</span><span class="op" id="6223121">,</span>&nbsp;<span class="ident" id="6223123">io</span><span class="op" id="6223125">.</span><span class="ident" id="6223126">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6223131">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223135">if</span>&nbsp;<span class="op" id="6223138">!</span><span class="ident" id="6223139">bz2</span><span class="op" id="6223142">.</span><span class="ident" id="6223143">setupDone</span>&nbsp;<span class="op" id="6223153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223157">err</span>&nbsp;<span class="op" id="6223161">=</span>&nbsp;<span class="ident" id="6223163">bz2</span><span class="op" id="6223166">.</span><span class="ident" id="6223167">setup</span><span class="op" id="6223172">(</span><span class="builtintype" id="6223173">true</span><span class="op" id="6223177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223181">brErr</span>&nbsp;<span class="op" id="6223187">:=</span>&nbsp;<span class="ident" id="6223190">bz2</span><span class="op" id="6223193">.</span><span class="ident" id="6223194">br</span><span class="op" id="6223196">.</span><span class="ident" id="6223197">Err</span><span class="op" id="6223200">(</span><span class="op" id="6223201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223205">if</span>&nbsp;<span class="ident" id="6223208">brErr</span>&nbsp;<span class="op" id="6223214">!=</span>&nbsp;<span class="ident" id="6223217">nil</span>&nbsp;<span class="op" id="6223221">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223226">err</span>&nbsp;<span class="op" id="6223230">=</span>&nbsp;<span class="ident" id="6223232">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6223240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223244">if</span>&nbsp;<span class="ident" id="6223247">err</span>&nbsp;<span class="op" id="6223251">!=</span>&nbsp;<span class="ident" id="6223254">nil</span>&nbsp;<span class="op" id="6223258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223263">return</span>&nbsp;<span class="num" id="6223270">0</span><span class="op" id="6223271">,</span>&nbsp;<span class="ident" id="6223273">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6223279">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223283">bz2</span><span class="op" id="6223286">.</span><span class="ident" id="6223287">setupDone</span>&nbsp;<span class="op" id="6223297">=</span>&nbsp;<span class="builtintype" id="6223299">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6223305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223309">n</span><span class="op" id="6223310">,</span>&nbsp;<span class="ident" id="6223312">err</span>&nbsp;<span class="op" id="6223316">=</span>&nbsp;<span class="ident" id="6223318">bz2</span><span class="op" id="6223321">.</span><span class="ident" id="6223322">read</span><span class="op" id="6223326">(</span><span class="ident" id="6223327">buf</span><span class="op" id="6223330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223333">brErr</span>&nbsp;<span class="op" id="6223339">:=</span>&nbsp;<span class="ident" id="6223342">bz2</span><span class="op" id="6223345">.</span><span class="ident" id="6223346">br</span><span class="op" id="6223348">.</span><span class="ident" id="6223349">Err</span><span class="op" id="6223352">(</span><span class="op" id="6223353">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223356">if</span>&nbsp;<span class="ident" id="6223359">brErr</span>&nbsp;<span class="op" id="6223365">!=</span>&nbsp;<span class="ident" id="6223368">nil</span>&nbsp;<span class="op" id="6223372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223376">err</span>&nbsp;<span class="op" id="6223380">=</span>&nbsp;<span class="ident" id="6223382">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6223389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223392">return</span><br>
<span class="lineno"></span><span class="op" id="6223399">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="6223402">func</span>&nbsp;<span class="op" id="6223407">(</span><span class="ident" id="6223408">bz2</span>&nbsp;<span class="op" id="6223412">*</span><span class="ident" id="6223413">reader</span><span class="op" id="6223419">)</span>&nbsp;<span class="ident" id="6223421">readFromBlock</span><span class="op" id="6223434">(</span><span class="ident" id="6223435">buf</span>&nbsp;<span class="op" id="6223439">[</span><span class="op" id="6223440">]</span><span class="builtintype" id="6223441">byte</span><span class="op" id="6223445">)</span>&nbsp;<span class="builtintype" id="6223447">int</span>&nbsp;<span class="op" id="6223451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223454">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223525">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223590">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223658">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223727">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223797">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6223842">n</span>&nbsp;<span class="op" id="6223844">:=</span>&nbsp;<span class="num" id="6223847">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6223850">for</span>&nbsp;<span class="op" id="6223854">(</span><span class="ident" id="6223855">bz2</span><span class="op" id="6223858">.</span><span class="ident" id="6223859">repeats</span>&nbsp;<span class="op" id="6223867">&gt;</span>&nbsp;<span class="num" id="6223869">0</span>&nbsp;<span class="op" id="6223871">||</span>&nbsp;<span class="ident" id="6223874">bz2</span><span class="op" id="6223877">.</span><span class="ident" id="6223878">preRLEUsed</span>&nbsp;<span class="op" id="6223889">&lt;</span>&nbsp;<span class="builtinfunc" id="6223891">len</span><span class="op" id="6223894">(</span><span class="ident" id="6223895">bz2</span><span class="op" id="6223898">.</span><span class="ident" id="6223899">preRLE</span><span class="op" id="6223905">)</span><span class="op" id="6223906">)</span>&nbsp;<span class="op" id="6223908">&amp;&amp;</span>&nbsp;<span class="ident" id="6223911">n</span>&nbsp;<span class="op" id="6223913">&lt;</span>&nbsp;<span class="builtinfunc" id="6223915">len</span><span class="op" id="6223918">(</span><span class="ident" id="6223919">buf</span><span class="op" id="6223922">)</span>&nbsp;<span class="op" id="6223924">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223928">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6223960">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6224006">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6224068">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6224131">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6224197">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6224258">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224272">if</span>&nbsp;<span class="ident" id="6224275">bz2</span><span class="op" id="6224278">.</span><span class="ident" id="6224279">repeats</span>&nbsp;<span class="op" id="6224287">&gt;</span>&nbsp;<span class="num" id="6224289">0</span>&nbsp;<span class="op" id="6224291">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224296">buf</span><span class="op" id="6224299">[</span><span class="ident" id="6224300">n</span><span class="op" id="6224301">]</span>&nbsp;<span class="op" id="6224303">=</span>&nbsp;<span class="builtintype" id="6224305">byte</span><span class="op" id="6224309">(</span><span class="ident" id="6224310">bz2</span><span class="op" id="6224313">.</span><span class="ident" id="6224314">lastByte</span><span class="op" id="6224322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224327">n</span><span class="op" id="6224328">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224334">bz2</span><span class="op" id="6224337">.</span><span class="ident" id="6224338">repeats</span><span class="op" id="6224345">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224351">if</span>&nbsp;<span class="ident" id="6224354">bz2</span><span class="op" id="6224357">.</span><span class="ident" id="6224358">repeats</span>&nbsp;<span class="op" id="6224366">==</span>&nbsp;<span class="num" id="6224369">0</span>&nbsp;<span class="op" id="6224371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224377">bz2</span><span class="op" id="6224380">.</span><span class="ident" id="6224381">lastByte</span>&nbsp;<span class="op" id="6224390">=</span>&nbsp;<span class="op" id="6224392">-</span><span class="num" id="6224393">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224403">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224419">bz2</span><span class="op" id="6224422">.</span><span class="ident" id="6224423">tPos</span>&nbsp;<span class="op" id="6224428">=</span>&nbsp;<span class="ident" id="6224430">bz2</span><span class="op" id="6224433">.</span><span class="ident" id="6224434">preRLE</span><span class="op" id="6224440">[</span><span class="ident" id="6224441">bz2</span><span class="op" id="6224444">.</span><span class="ident" id="6224445">tPos</span><span class="op" id="6224449">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224453">b</span>&nbsp;<span class="op" id="6224455">:=</span>&nbsp;<span class="builtintype" id="6224458">byte</span><span class="op" id="6224462">(</span><span class="ident" id="6224463">bz2</span><span class="op" id="6224466">.</span><span class="ident" id="6224467">tPos</span><span class="op" id="6224471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224475">bz2</span><span class="op" id="6224478">.</span><span class="ident" id="6224479">tPos</span>&nbsp;<span class="op" id="6224484">&gt;&gt;=</span>&nbsp;<span class="num" id="6224488">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224492">bz2</span><span class="op" id="6224495">.</span><span class="ident" id="6224496">preRLEUsed</span><span class="op" id="6224506">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224512">if</span>&nbsp;<span class="ident" id="6224515">bz2</span><span class="op" id="6224518">.</span><span class="ident" id="6224519">byteRepeats</span>&nbsp;<span class="op" id="6224531">==</span>&nbsp;<span class="num" id="6224534">3</span>&nbsp;<span class="op" id="6224536">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224541">bz2</span><span class="op" id="6224544">.</span><span class="ident" id="6224545">repeats</span>&nbsp;<span class="op" id="6224553">=</span>&nbsp;<span class="builtintype" id="6224555">uint</span><span class="op" id="6224559">(</span><span class="ident" id="6224560">b</span><span class="op" id="6224561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224566">bz2</span><span class="op" id="6224569">.</span><span class="ident" id="6224570">byteRepeats</span>&nbsp;<span class="op" id="6224582">=</span>&nbsp;<span class="num" id="6224584">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224589">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224605">if</span>&nbsp;<span class="ident" id="6224608">bz2</span><span class="op" id="6224611">.</span><span class="ident" id="6224612">lastByte</span>&nbsp;<span class="op" id="6224621">==</span>&nbsp;<span class="builtintype" id="6224624">int</span><span class="op" id="6224627">(</span><span class="ident" id="6224628">b</span><span class="op" id="6224629">)</span>&nbsp;<span class="op" id="6224631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224636">bz2</span><span class="op" id="6224639">.</span><span class="ident" id="6224640">byteRepeats</span><span class="op" id="6224651">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224656">}</span>&nbsp;<span class="keyword" id="6224658">else</span>&nbsp;<span class="op" id="6224663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224668">bz2</span><span class="op" id="6224671">.</span><span class="ident" id="6224672">byteRepeats</span>&nbsp;<span class="op" id="6224684">=</span>&nbsp;<span class="num" id="6224686">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224690">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224694">bz2</span><span class="op" id="6224697">.</span><span class="ident" id="6224698">lastByte</span>&nbsp;<span class="op" id="6224707">=</span>&nbsp;<span class="builtintype" id="6224709">int</span><span class="op" id="6224712">(</span><span class="ident" id="6224713">b</span><span class="op" id="6224714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224719">buf</span><span class="op" id="6224722">[</span><span class="ident" id="6224723">n</span><span class="op" id="6224724">]</span>&nbsp;<span class="op" id="6224726">=</span>&nbsp;<span class="ident" id="6224728">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224732">n</span><span class="op" id="6224733">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224737">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224741">return</span>&nbsp;<span class="ident" id="6224748">n</span><br>
<span class="lineno"></span><span class="op" id="6224750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6224753">func</span>&nbsp;<span class="op" id="6224758">(</span><span class="ident" id="6224759">bz2</span>&nbsp;<span class="op" id="6224763">*</span><span class="ident" id="6224764">reader</span><span class="op" id="6224770">)</span>&nbsp;<span class="ident" id="6224772">read</span><span class="op" id="6224776">(</span><span class="ident" id="6224777">buf</span>&nbsp;<span class="op" id="6224781">[</span><span class="op" id="6224782">]</span><span class="builtintype" id="6224783">byte</span><span class="op" id="6224787">)</span>&nbsp;<span class="op" id="6224789">(</span><span class="builtintype" id="6224790">int</span><span class="op" id="6224793">,</span>&nbsp;<span class="builtintype" id="6224795">error</span><span class="op" id="6224800">)</span>&nbsp;<span class="op" id="6224802">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224805">for</span>&nbsp;<span class="op" id="6224809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224813">n</span>&nbsp;<span class="op" id="6224815">:=</span>&nbsp;<span class="ident" id="6224818">bz2</span><span class="op" id="6224821">.</span><span class="ident" id="6224822">readFromBlock</span><span class="op" id="6224835">(</span><span class="ident" id="6224836">buf</span><span class="op" id="6224839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224843">if</span>&nbsp;<span class="ident" id="6224846">n</span>&nbsp;<span class="op" id="6224848">&gt;</span>&nbsp;<span class="num" id="6224850">0</span>&nbsp;<span class="op" id="6224852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6224857">bz2</span><span class="op" id="6224860">.</span><span class="ident" id="6224861">blockCRC</span>&nbsp;<span class="op" id="6224870">=</span>&nbsp;<span class="ident" id="6224872">updateCRC</span><span class="op" id="6224881">(</span><span class="ident" id="6224882">bz2</span><span class="op" id="6224885">.</span><span class="ident" id="6224886">blockCRC</span><span class="op" id="6224894">,</span>&nbsp;<span class="ident" id="6224896">buf</span><span class="op" id="6224899">[</span><span class="op" id="6224900">:</span><span class="ident" id="6224901">n</span><span class="op" id="6224902">]</span><span class="op" id="6224903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224908">return</span>&nbsp;<span class="ident" id="6224915">n</span><span class="op" id="6224916">,</span>&nbsp;<span class="ident" id="6224918">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6224924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6224929">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6224959">if</span>&nbsp;<span class="ident" id="6224962">bz2</span><span class="op" id="6224965">.</span><span class="ident" id="6224966">blockCRC</span>&nbsp;<span class="op" id="6224975">!=</span>&nbsp;<span class="ident" id="6224978">bz2</span><span class="op" id="6224981">.</span><span class="ident" id="6224982">wantBlockCRC</span>&nbsp;<span class="op" id="6224995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225000">bz2</span><span class="op" id="6225003">.</span><span class="ident" id="6225004">br</span><span class="op" id="6225006">.</span><span class="ident" id="6225007">err</span>&nbsp;<span class="op" id="6225011">=</span>&nbsp;<span class="ident" id="6225013">StructuralError</span><span class="op" id="6225028">(</span><span class="string" id="6225029">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6225054">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225059">return</span>&nbsp;<span class="num" id="6225066">0</span><span class="op" id="6225067">,</span>&nbsp;<span class="ident" id="6225069">bz2</span><span class="op" id="6225072">.</span><span class="ident" id="6225073">br</span><span class="op" id="6225075">.</span><span class="ident" id="6225076">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6225087">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225109">br</span>&nbsp;<span class="op" id="6225112">:=</span>&nbsp;<span class="op" id="6225115">&amp;</span><span class="ident" id="6225116">bz2</span><span class="op" id="6225119">.</span><span class="ident" id="6225120">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225125">switch</span>&nbsp;<span class="ident" id="6225132">br</span><span class="op" id="6225134">.</span><span class="ident" id="6225135">ReadBits64</span><span class="op" id="6225145">(</span><span class="num" id="6225146">48</span><span class="op" id="6225148">)</span>&nbsp;<span class="op" id="6225150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225154">default</span><span class="op" id="6225161">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225166">return</span>&nbsp;<span class="num" id="6225173">0</span><span class="op" id="6225174">,</span>&nbsp;<span class="ident" id="6225176">StructuralError</span><span class="op" id="6225191">(</span><span class="string" id="6225192">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="6225215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225220">case</span>&nbsp;<span class="ident" id="6225225">bzip2BlockMagic</span><span class="op" id="6225240">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6225245">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225267">err</span>&nbsp;<span class="op" id="6225271">:=</span>&nbsp;<span class="ident" id="6225274">bz2</span><span class="op" id="6225277">.</span><span class="ident" id="6225278">readBlock</span><span class="op" id="6225287">(</span><span class="op" id="6225288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225293">if</span>&nbsp;<span class="ident" id="6225296">err</span>&nbsp;<span class="op" id="6225300">!=</span>&nbsp;<span class="ident" id="6225303">nil</span>&nbsp;<span class="op" id="6225307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225313">return</span>&nbsp;<span class="num" id="6225320">0</span><span class="op" id="6225321">,</span>&nbsp;<span class="ident" id="6225323">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225330">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225335">case</span>&nbsp;<span class="ident" id="6225340">bzip2FinalMagic</span><span class="op" id="6225355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6225360">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225389">wantFileCRC</span>&nbsp;<span class="op" id="6225401">:=</span>&nbsp;<span class="builtintype" id="6225404">uint32</span><span class="op" id="6225410">(</span><span class="ident" id="6225411">br</span><span class="op" id="6225413">.</span><span class="ident" id="6225414">ReadBits64</span><span class="op" id="6225424">(</span><span class="num" id="6225425">32</span><span class="op" id="6225427">)</span><span class="op" id="6225428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225433">if</span>&nbsp;<span class="ident" id="6225436">br</span><span class="op" id="6225438">.</span><span class="ident" id="6225439">err</span>&nbsp;<span class="op" id="6225443">!=</span>&nbsp;<span class="ident" id="6225446">nil</span>&nbsp;<span class="op" id="6225450">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225456">return</span>&nbsp;<span class="num" id="6225463">0</span><span class="op" id="6225464">,</span>&nbsp;<span class="ident" id="6225466">br</span><span class="op" id="6225468">.</span><span class="ident" id="6225469">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225481">if</span>&nbsp;<span class="ident" id="6225484">bz2</span><span class="op" id="6225487">.</span><span class="ident" id="6225488">fileCRC</span>&nbsp;<span class="op" id="6225496">!=</span>&nbsp;<span class="ident" id="6225499">wantFileCRC</span>&nbsp;<span class="op" id="6225511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225517">br</span><span class="op" id="6225519">.</span><span class="ident" id="6225520">err</span>&nbsp;<span class="op" id="6225524">=</span>&nbsp;<span class="ident" id="6225526">StructuralError</span><span class="op" id="6225541">(</span><span class="string" id="6225542">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6225566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225572">return</span>&nbsp;<span class="num" id="6225579">0</span><span class="op" id="6225580">,</span>&nbsp;<span class="ident" id="6225582">br</span><span class="op" id="6225584">.</span><span class="ident" id="6225585">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6225598">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6225633">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6225681">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225711">if</span>&nbsp;<span class="ident" id="6225714">br</span><span class="op" id="6225716">.</span><span class="ident" id="6225717">bits</span><span class="op" id="6225721">%</span><span class="num" id="6225722">8</span>&nbsp;<span class="op" id="6225724">!=</span>&nbsp;<span class="num" id="6225727">0</span>&nbsp;<span class="op" id="6225729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225735">br</span><span class="op" id="6225737">.</span><span class="ident" id="6225738">ReadBits</span><span class="op" id="6225746">(</span><span class="ident" id="6225747">br</span><span class="op" id="6225749">.</span><span class="ident" id="6225750">bits</span>&nbsp;<span class="op" id="6225755">%</span>&nbsp;<span class="num" id="6225757">8</span><span class="op" id="6225758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225768">b</span><span class="op" id="6225769">,</span>&nbsp;<span class="ident" id="6225771">err</span>&nbsp;<span class="op" id="6225775">:=</span>&nbsp;<span class="ident" id="6225778">br</span><span class="op" id="6225780">.</span><span class="ident" id="6225781">r</span><span class="op" id="6225782">.</span><span class="ident" id="6225783">ReadByte</span><span class="op" id="6225791">(</span><span class="op" id="6225792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225797">if</span>&nbsp;<span class="ident" id="6225800">err</span>&nbsp;<span class="op" id="6225804">==</span>&nbsp;<span class="ident" id="6225807">io</span><span class="op" id="6225809">.</span><span class="ident" id="6225810">EOF</span>&nbsp;<span class="op" id="6225814">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225820">br</span><span class="op" id="6225822">.</span><span class="ident" id="6225823">err</span>&nbsp;<span class="op" id="6225827">=</span>&nbsp;<span class="ident" id="6225829">io</span><span class="op" id="6225831">.</span><span class="ident" id="6225832">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225840">bz2</span><span class="op" id="6225843">.</span><span class="ident" id="6225844">eof</span>&nbsp;<span class="op" id="6225848">=</span>&nbsp;<span class="builtintype" id="6225850">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225859">return</span>&nbsp;<span class="num" id="6225866">0</span><span class="op" id="6225867">,</span>&nbsp;<span class="ident" id="6225869">io</span><span class="op" id="6225871">.</span><span class="ident" id="6225872">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225884">if</span>&nbsp;<span class="ident" id="6225887">err</span>&nbsp;<span class="op" id="6225891">!=</span>&nbsp;<span class="ident" id="6225894">nil</span>&nbsp;<span class="op" id="6225898">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225904">br</span><span class="op" id="6225906">.</span><span class="ident" id="6225907">err</span>&nbsp;<span class="op" id="6225911">=</span>&nbsp;<span class="ident" id="6225913">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225921">return</span>&nbsp;<span class="num" id="6225928">0</span><span class="op" id="6225929">,</span>&nbsp;<span class="ident" id="6225931">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6225938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6225943">z</span><span class="op" id="6225944">,</span>&nbsp;<span class="ident" id="6225946">err</span>&nbsp;<span class="op" id="6225950">:=</span>&nbsp;<span class="ident" id="6225953">br</span><span class="op" id="6225955">.</span><span class="ident" id="6225956">r</span><span class="op" id="6225957">.</span><span class="ident" id="6225958">ReadByte</span><span class="op" id="6225966">(</span><span class="op" id="6225967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225972">if</span>&nbsp;<span class="ident" id="6225975">err</span>&nbsp;<span class="op" id="6225979">!=</span>&nbsp;<span class="ident" id="6225982">nil</span>&nbsp;<span class="op" id="6225986">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6225992">if</span>&nbsp;<span class="ident" id="6225995">err</span>&nbsp;<span class="op" id="6225999">==</span>&nbsp;<span class="ident" id="6226002">io</span><span class="op" id="6226004">.</span><span class="ident" id="6226005">EOF</span>&nbsp;<span class="op" id="6226009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226016">err</span>&nbsp;<span class="op" id="6226020">=</span>&nbsp;<span class="ident" id="6226022">io</span><span class="op" id="6226024">.</span><span class="ident" id="6226025">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226052">br</span><span class="op" id="6226054">.</span><span class="ident" id="6226055">err</span>&nbsp;<span class="op" id="6226059">=</span>&nbsp;<span class="ident" id="6226061">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226069">return</span>&nbsp;<span class="num" id="6226076">0</span><span class="op" id="6226077">,</span>&nbsp;<span class="ident" id="6226079">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226091">if</span>&nbsp;<span class="ident" id="6226094">b</span>&nbsp;<span class="op" id="6226096">!=</span>&nbsp;<span class="string" id="6226099">&#39;B&#39;</span>&nbsp;<span class="op" id="6226103">||</span>&nbsp;<span class="ident" id="6226106">z</span>&nbsp;<span class="op" id="6226108">!=</span>&nbsp;<span class="string" id="6226111">&#39;Z&#39;</span>&nbsp;<span class="op" id="6226115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226121">return</span>&nbsp;<span class="num" id="6226128">0</span><span class="op" id="6226129">,</span>&nbsp;<span class="ident" id="6226131">StructuralError</span><span class="op" id="6226146">(</span><span class="string" id="6226147">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="6226185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226195">if</span>&nbsp;<span class="ident" id="6226198">err</span>&nbsp;<span class="op" id="6226202">:=</span>&nbsp;<span class="ident" id="6226205">bz2</span><span class="op" id="6226208">.</span><span class="ident" id="6226209">setup</span><span class="op" id="6226214">(</span><span class="builtintype" id="6226215">false</span><span class="op" id="6226220">)</span><span class="op" id="6226221">;</span>&nbsp;<span class="ident" id="6226223">err</span>&nbsp;<span class="op" id="6226227">!=</span>&nbsp;<span class="ident" id="6226230">nil</span>&nbsp;<span class="op" id="6226234">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226240">return</span>&nbsp;<span class="num" id="6226247">0</span><span class="op" id="6226248">,</span>&nbsp;<span class="ident" id="6226250">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226264">}</span><br>
<span class="lineno"></span><span class="op" id="6226266">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="6226269">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="6226355">func</span>&nbsp;<span class="op" id="6226360">(</span><span class="ident" id="6226361">bz2</span>&nbsp;<span class="op" id="6226365">*</span><span class="ident" id="6226366">reader</span><span class="op" id="6226372">)</span>&nbsp;<span class="ident" id="6226374">readBlock</span><span class="op" id="6226383">(</span><span class="op" id="6226384">)</span>&nbsp;<span class="op" id="6226386">(</span><span class="ident" id="6226387">err</span>&nbsp;<span class="builtintype" id="6226391">error</span><span class="op" id="6226396">)</span>&nbsp;<span class="op" id="6226398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226401">br</span>&nbsp;<span class="op" id="6226404">:=</span>&nbsp;<span class="op" id="6226407">&amp;</span><span class="ident" id="6226408">bz2</span><span class="op" id="6226411">.</span><span class="ident" id="6226412">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226416">bz2</span><span class="op" id="6226419">.</span><span class="ident" id="6226420">wantBlockCRC</span>&nbsp;<span class="op" id="6226433">=</span>&nbsp;<span class="builtintype" id="6226435">uint32</span><span class="op" id="6226441">(</span><span class="ident" id="6226442">br</span><span class="op" id="6226444">.</span><span class="ident" id="6226445">ReadBits64</span><span class="op" id="6226455">(</span><span class="num" id="6226456">32</span><span class="op" id="6226458">)</span><span class="op" id="6226459">)</span>&nbsp;<span class="comment" id="6226461">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226528">bz2</span><span class="op" id="6226531">.</span><span class="ident" id="6226532">blockCRC</span>&nbsp;<span class="op" id="6226541">=</span>&nbsp;<span class="num" id="6226543">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226546">bz2</span><span class="op" id="6226549">.</span><span class="ident" id="6226550">fileCRC</span>&nbsp;<span class="op" id="6226558">=</span>&nbsp;<span class="op" id="6226560">(</span><span class="ident" id="6226561">bz2</span><span class="op" id="6226564">.</span><span class="ident" id="6226565">fileCRC</span><span class="op" id="6226572">&lt;&lt;</span><span class="num" id="6226574">1</span>&nbsp;<span class="op" id="6226576">|</span>&nbsp;<span class="ident" id="6226578">bz2</span><span class="op" id="6226581">.</span><span class="ident" id="6226582">fileCRC</span><span class="op" id="6226589">&gt;&gt;</span><span class="num" id="6226591">31</span><span class="op" id="6226593">)</span>&nbsp;<span class="op" id="6226595">^</span>&nbsp;<span class="ident" id="6226597">bz2</span><span class="op" id="6226600">.</span><span class="ident" id="6226601">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226615">randomized</span>&nbsp;<span class="op" id="6226626">:=</span>&nbsp;<span class="ident" id="6226629">br</span><span class="op" id="6226631">.</span><span class="ident" id="6226632">ReadBits</span><span class="op" id="6226640">(</span><span class="num" id="6226641">1</span><span class="op" id="6226642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226645">if</span>&nbsp;<span class="ident" id="6226648">randomized</span>&nbsp;<span class="op" id="6226659">!=</span>&nbsp;<span class="num" id="6226662">0</span>&nbsp;<span class="op" id="6226664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6226668">return</span>&nbsp;<span class="ident" id="6226675">StructuralError</span><span class="op" id="6226690">(</span><span class="string" id="6226691">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="6226720">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6226723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226726">origPtr</span>&nbsp;<span class="op" id="6226734">:=</span>&nbsp;<span class="builtintype" id="6226737">uint</span><span class="op" id="6226741">(</span><span class="ident" id="6226742">br</span><span class="op" id="6226744">.</span><span class="ident" id="6226745">ReadBits</span><span class="op" id="6226753">(</span><span class="num" id="6226754">24</span><span class="op" id="6226756">)</span><span class="op" id="6226757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6226761">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6226833">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6226897">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226926">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="6226948">:=</span>&nbsp;<span class="ident" id="6226951">br</span><span class="op" id="6226953">.</span><span class="ident" id="6226954">ReadBits</span><span class="op" id="6226962">(</span><span class="num" id="6226963">16</span><span class="op" id="6226965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6226968">symbolPresent</span>&nbsp;<span class="op" id="6226982">:=</span>&nbsp;<span class="builtinfunc" id="6226985">make</span><span class="op" id="6226989">(</span><span class="op" id="6226990">[</span><span class="op" id="6226991">]</span><span class="builtintype" id="6226992">bool</span><span class="op" id="6226996">,</span>&nbsp;<span class="num" id="6226998">256</span><span class="op" id="6227001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227004">numSymbols</span>&nbsp;<span class="op" id="6227015">:=</span>&nbsp;<span class="num" id="6227018">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227021">for</span>&nbsp;<span class="ident" id="6227025">symRange</span>&nbsp;<span class="op" id="6227034">:=</span>&nbsp;<span class="builtintype" id="6227037">uint</span><span class="op" id="6227041">(</span><span class="num" id="6227042">0</span><span class="op" id="6227043">)</span><span class="op" id="6227044">;</span>&nbsp;<span class="ident" id="6227046">symRange</span>&nbsp;<span class="op" id="6227055">&lt;</span>&nbsp;<span class="num" id="6227057">16</span><span class="op" id="6227059">;</span>&nbsp;<span class="ident" id="6227061">symRange</span><span class="op" id="6227069">++</span>&nbsp;<span class="op" id="6227072">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227076">if</span>&nbsp;<span class="ident" id="6227079">symbolRangeUsedBitmap</span><span class="op" id="6227100">&amp;</span><span class="op" id="6227101">(</span><span class="num" id="6227102">1</span><span class="op" id="6227103">&lt;&lt;</span><span class="op" id="6227105">(</span><span class="num" id="6227106">15</span><span class="op" id="6227108">-</span><span class="ident" id="6227109">symRange</span><span class="op" id="6227117">)</span><span class="op" id="6227118">)</span>&nbsp;<span class="op" id="6227120">!=</span>&nbsp;<span class="num" id="6227123">0</span>&nbsp;<span class="op" id="6227125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227130">bits</span>&nbsp;<span class="op" id="6227135">:=</span>&nbsp;<span class="ident" id="6227138">br</span><span class="op" id="6227140">.</span><span class="ident" id="6227141">ReadBits</span><span class="op" id="6227149">(</span><span class="num" id="6227150">16</span><span class="op" id="6227152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227157">for</span>&nbsp;<span class="ident" id="6227161">symbol</span>&nbsp;<span class="op" id="6227168">:=</span>&nbsp;<span class="builtintype" id="6227171">uint</span><span class="op" id="6227175">(</span><span class="num" id="6227176">0</span><span class="op" id="6227177">)</span><span class="op" id="6227178">;</span>&nbsp;<span class="ident" id="6227180">symbol</span>&nbsp;<span class="op" id="6227187">&lt;</span>&nbsp;<span class="num" id="6227189">16</span><span class="op" id="6227191">;</span>&nbsp;<span class="ident" id="6227193">symbol</span><span class="op" id="6227199">++</span>&nbsp;<span class="op" id="6227202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227208">if</span>&nbsp;<span class="ident" id="6227211">bits</span><span class="op" id="6227215">&amp;</span><span class="op" id="6227216">(</span><span class="num" id="6227217">1</span><span class="op" id="6227218">&lt;&lt;</span><span class="op" id="6227220">(</span><span class="num" id="6227221">15</span><span class="op" id="6227223">-</span><span class="ident" id="6227224">symbol</span><span class="op" id="6227230">)</span><span class="op" id="6227231">)</span>&nbsp;<span class="op" id="6227233">!=</span>&nbsp;<span class="num" id="6227236">0</span>&nbsp;<span class="op" id="6227238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227245">symbolPresent</span><span class="op" id="6227258">[</span><span class="num" id="6227259">16</span><span class="op" id="6227261">*</span><span class="ident" id="6227262">symRange</span><span class="op" id="6227270">+</span><span class="ident" id="6227271">symbol</span><span class="op" id="6227277">]</span>&nbsp;<span class="op" id="6227279">=</span>&nbsp;<span class="builtintype" id="6227281">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227291">numSymbols</span><span class="op" id="6227301">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6227308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6227313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6227317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6227320">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227324">if</span>&nbsp;<span class="ident" id="6227327">numSymbols</span>&nbsp;<span class="op" id="6227338">==</span>&nbsp;<span class="num" id="6227341">0</span>&nbsp;<span class="op" id="6227343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6227347">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227381">return</span>&nbsp;<span class="ident" id="6227388">StructuralError</span><span class="op" id="6227403">(</span><span class="string" id="6227404">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="6227425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6227428">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6227432">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227494">numHuffmanTrees</span>&nbsp;<span class="op" id="6227510">:=</span>&nbsp;<span class="ident" id="6227513">br</span><span class="op" id="6227515">.</span><span class="ident" id="6227516">ReadBits</span><span class="op" id="6227524">(</span><span class="num" id="6227525">3</span><span class="op" id="6227526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227529">if</span>&nbsp;<span class="ident" id="6227532">numHuffmanTrees</span>&nbsp;<span class="op" id="6227548">&lt;</span>&nbsp;<span class="num" id="6227550">2</span>&nbsp;<span class="op" id="6227552">||</span>&nbsp;<span class="ident" id="6227555">numHuffmanTrees</span>&nbsp;<span class="op" id="6227571">&gt;</span>&nbsp;<span class="num" id="6227573">6</span>&nbsp;<span class="op" id="6227575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6227579">return</span>&nbsp;<span class="ident" id="6227586">StructuralError</span><span class="op" id="6227601">(</span><span class="string" id="6227602">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="6227635">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6227638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6227642">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6227712">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227784">numSelectors</span>&nbsp;<span class="op" id="6227797">:=</span>&nbsp;<span class="ident" id="6227800">br</span><span class="op" id="6227802">.</span><span class="ident" id="6227803">ReadBits</span><span class="op" id="6227811">(</span><span class="num" id="6227812">15</span><span class="op" id="6227814">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227817">treeIndexes</span>&nbsp;<span class="op" id="6227829">:=</span>&nbsp;<span class="builtinfunc" id="6227832">make</span><span class="op" id="6227836">(</span><span class="op" id="6227837">[</span><span class="op" id="6227838">]</span><span class="builtintype" id="6227839">uint8</span><span class="op" id="6227844">,</span>&nbsp;<span class="ident" id="6227846">numSelectors</span><span class="op" id="6227858">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6227862">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6227933">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6227946">mtfTreeDecoder</span>&nbsp;<span class="op" id="6227961">:=</span>&nbsp;<span class="ident" id="6227964">newMTFDecoderWithRange</span><span class="op" id="6227986">(</span><span class="ident" id="6227987">numHuffmanTrees</span><span class="op" id="6228002">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228005">for</span>&nbsp;<span class="ident" id="6228009">i</span>&nbsp;<span class="op" id="6228011">:=</span>&nbsp;<span class="keyword" id="6228014">range</span>&nbsp;<span class="ident" id="6228020">treeIndexes</span>&nbsp;<span class="op" id="6228032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228036">c</span>&nbsp;<span class="op" id="6228038">:=</span>&nbsp;<span class="num" id="6228041">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228045">for</span>&nbsp;<span class="op" id="6228049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228054">inc</span>&nbsp;<span class="op" id="6228058">:=</span>&nbsp;<span class="ident" id="6228061">br</span><span class="op" id="6228063">.</span><span class="ident" id="6228064">ReadBits</span><span class="op" id="6228072">(</span><span class="num" id="6228073">1</span><span class="op" id="6228074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228079">if</span>&nbsp;<span class="ident" id="6228082">inc</span>&nbsp;<span class="op" id="6228086">==</span>&nbsp;<span class="num" id="6228089">0</span>&nbsp;<span class="op" id="6228091">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228097">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228111">c</span><span class="op" id="6228112">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228121">if</span>&nbsp;<span class="ident" id="6228124">c</span>&nbsp;<span class="op" id="6228126">&gt;=</span>&nbsp;<span class="ident" id="6228129">numHuffmanTrees</span>&nbsp;<span class="op" id="6228145">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228150">return</span>&nbsp;<span class="ident" id="6228157">StructuralError</span><span class="op" id="6228172">(</span><span class="string" id="6228173">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="6228195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228203">treeIndexes</span><span class="op" id="6228214">[</span><span class="ident" id="6228215">i</span><span class="op" id="6228216">]</span>&nbsp;<span class="op" id="6228218">=</span>&nbsp;<span class="builtintype" id="6228220">uint8</span><span class="op" id="6228225">(</span><span class="ident" id="6228226">mtfTreeDecoder</span><span class="op" id="6228240">.</span><span class="ident" id="6228241">Decode</span><span class="op" id="6228247">(</span><span class="ident" id="6228248">c</span><span class="op" id="6228249">)</span><span class="op" id="6228250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6228257">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6228327">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228369">symbols</span>&nbsp;<span class="op" id="6228377">:=</span>&nbsp;<span class="builtinfunc" id="6228380">make</span><span class="op" id="6228384">(</span><span class="op" id="6228385">[</span><span class="op" id="6228386">]</span><span class="builtintype" id="6228387">byte</span><span class="op" id="6228391">,</span>&nbsp;<span class="ident" id="6228393">numSymbols</span><span class="op" id="6228403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228406">nextSymbol</span>&nbsp;<span class="op" id="6228417">:=</span>&nbsp;<span class="num" id="6228420">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228423">for</span>&nbsp;<span class="ident" id="6228427">i</span>&nbsp;<span class="op" id="6228429">:=</span>&nbsp;<span class="num" id="6228432">0</span><span class="op" id="6228433">;</span>&nbsp;<span class="ident" id="6228435">i</span>&nbsp;<span class="op" id="6228437">&lt;</span>&nbsp;<span class="num" id="6228439">256</span><span class="op" id="6228442">;</span>&nbsp;<span class="ident" id="6228444">i</span><span class="op" id="6228445">++</span>&nbsp;<span class="op" id="6228448">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228452">if</span>&nbsp;<span class="ident" id="6228455">symbolPresent</span><span class="op" id="6228468">[</span><span class="ident" id="6228469">i</span><span class="op" id="6228470">]</span>&nbsp;<span class="op" id="6228472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228477">symbols</span><span class="op" id="6228484">[</span><span class="ident" id="6228485">nextSymbol</span><span class="op" id="6228495">]</span>&nbsp;<span class="op" id="6228497">=</span>&nbsp;<span class="builtintype" id="6228499">byte</span><span class="op" id="6228503">(</span><span class="ident" id="6228504">i</span><span class="op" id="6228505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228510">nextSymbol</span><span class="op" id="6228520">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228528">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228531">mtf</span>&nbsp;<span class="op" id="6228535">:=</span>&nbsp;<span class="ident" id="6228538">newMTFDecoder</span><span class="op" id="6228551">(</span><span class="ident" id="6228552">symbols</span><span class="op" id="6228559">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228563">numSymbols</span>&nbsp;<span class="op" id="6228574">+=</span>&nbsp;<span class="num" id="6228577">2</span>&nbsp;<span class="comment" id="6228579">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228620">huffmanTrees</span>&nbsp;<span class="op" id="6228633">:=</span>&nbsp;<span class="builtinfunc" id="6228636">make</span><span class="op" id="6228640">(</span><span class="op" id="6228641">[</span><span class="op" id="6228642">]</span><span class="ident" id="6228643">huffmanTree</span><span class="op" id="6228654">,</span>&nbsp;<span class="ident" id="6228656">numHuffmanTrees</span><span class="op" id="6228671">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6228675">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228735">lengths</span>&nbsp;<span class="op" id="6228743">:=</span>&nbsp;<span class="builtinfunc" id="6228746">make</span><span class="op" id="6228750">(</span><span class="op" id="6228751">[</span><span class="op" id="6228752">]</span><span class="builtintype" id="6228753">uint8</span><span class="op" id="6228758">,</span>&nbsp;<span class="ident" id="6228760">numSymbols</span><span class="op" id="6228770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228773">for</span>&nbsp;<span class="ident" id="6228777">i</span>&nbsp;<span class="op" id="6228779">:=</span>&nbsp;<span class="keyword" id="6228782">range</span>&nbsp;<span class="ident" id="6228788">huffmanTrees</span>&nbsp;<span class="op" id="6228801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6228805">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228870">length</span>&nbsp;<span class="op" id="6228877">:=</span>&nbsp;<span class="ident" id="6228880">br</span><span class="op" id="6228882">.</span><span class="ident" id="6228883">ReadBits</span><span class="op" id="6228891">(</span><span class="num" id="6228892">5</span><span class="op" id="6228893">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228897">for</span>&nbsp;<span class="ident" id="6228901">j</span>&nbsp;<span class="op" id="6228903">:=</span>&nbsp;<span class="keyword" id="6228906">range</span>&nbsp;<span class="ident" id="6228912">lengths</span>&nbsp;<span class="op" id="6228920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228925">for</span>&nbsp;<span class="op" id="6228929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228935">if</span>&nbsp;<span class="op" id="6228938">!</span><span class="ident" id="6228939">br</span><span class="op" id="6228941">.</span><span class="ident" id="6228942">ReadBit</span><span class="op" id="6228949">(</span><span class="op" id="6228950">)</span>&nbsp;<span class="op" id="6228952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228959">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6228969">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6228975">if</span>&nbsp;<span class="ident" id="6228978">br</span><span class="op" id="6228980">.</span><span class="ident" id="6228981">ReadBit</span><span class="op" id="6228988">(</span><span class="op" id="6228989">)</span>&nbsp;<span class="op" id="6228991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6228998">length</span><span class="op" id="6229004">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229011">}</span>&nbsp;<span class="keyword" id="6229013">else</span>&nbsp;<span class="op" id="6229018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229025">length</span><span class="op" id="6229031">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229038">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229048">if</span>&nbsp;<span class="ident" id="6229051">length</span>&nbsp;<span class="op" id="6229058">&lt;</span>&nbsp;<span class="num" id="6229060">0</span>&nbsp;<span class="op" id="6229062">||</span>&nbsp;<span class="ident" id="6229065">length</span>&nbsp;<span class="op" id="6229072">&gt;</span>&nbsp;<span class="num" id="6229074">20</span>&nbsp;<span class="op" id="6229077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229083">return</span>&nbsp;<span class="ident" id="6229090">StructuralError</span><span class="op" id="6229105">(</span><span class="string" id="6229106">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6229135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229145">lengths</span><span class="op" id="6229152">[</span><span class="ident" id="6229153">j</span><span class="op" id="6229154">]</span>&nbsp;<span class="op" id="6229156">=</span>&nbsp;<span class="builtintype" id="6229158">uint8</span><span class="op" id="6229163">(</span><span class="ident" id="6229164">length</span><span class="op" id="6229170">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229178">huffmanTrees</span><span class="op" id="6229190">[</span><span class="ident" id="6229191">i</span><span class="op" id="6229192">]</span><span class="op" id="6229193">,</span>&nbsp;<span class="ident" id="6229195">err</span>&nbsp;<span class="op" id="6229199">=</span>&nbsp;<span class="ident" id="6229201">newHuffmanTree</span><span class="op" id="6229215">(</span><span class="ident" id="6229216">lengths</span><span class="op" id="6229223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229227">if</span>&nbsp;<span class="ident" id="6229230">err</span>&nbsp;<span class="op" id="6229234">!=</span>&nbsp;<span class="ident" id="6229237">nil</span>&nbsp;<span class="op" id="6229241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229246">return</span>&nbsp;<span class="ident" id="6229253">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229259">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229266">selectorIndex</span>&nbsp;<span class="op" id="6229280">:=</span>&nbsp;<span class="num" id="6229283">1</span>&nbsp;<span class="comment" id="6229285">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229316">if</span>&nbsp;<span class="builtinfunc" id="6229319">len</span><span class="op" id="6229322">(</span><span class="ident" id="6229323">treeIndexes</span><span class="op" id="6229334">)</span>&nbsp;<span class="op" id="6229336">==</span>&nbsp;<span class="num" id="6229339">0</span>&nbsp;<span class="op" id="6229341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229345">return</span>&nbsp;<span class="ident" id="6229352">StructuralError</span><span class="op" id="6229367">(</span><span class="string" id="6229368">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="6229393">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229399">if</span>&nbsp;<span class="builtintype" id="6229402">int</span><span class="op" id="6229405">(</span><span class="ident" id="6229406">treeIndexes</span><span class="op" id="6229417">[</span><span class="num" id="6229418">0</span><span class="op" id="6229419">]</span><span class="op" id="6229420">)</span>&nbsp;<span class="op" id="6229422">&gt;=</span>&nbsp;<span class="builtinfunc" id="6229425">len</span><span class="op" id="6229428">(</span><span class="ident" id="6229429">huffmanTrees</span><span class="op" id="6229441">)</span>&nbsp;<span class="op" id="6229443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229447">return</span>&nbsp;<span class="ident" id="6229454">StructuralError</span><span class="op" id="6229469">(</span><span class="string" id="6229470">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6229498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229504">currentHuffmanTree</span>&nbsp;<span class="op" id="6229523">:=</span>&nbsp;<span class="ident" id="6229526">huffmanTrees</span><span class="op" id="6229538">[</span><span class="ident" id="6229539">treeIndexes</span><span class="op" id="6229550">[</span><span class="num" id="6229551">0</span><span class="op" id="6229552">]</span><span class="op" id="6229553">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229556">bufIndex</span>&nbsp;<span class="op" id="6229565">:=</span>&nbsp;<span class="num" id="6229568">0</span>&nbsp;<span class="comment" id="6229570">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6229610">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6229682">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6229749">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6229819">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229832">repeat</span>&nbsp;<span class="op" id="6229839">:=</span>&nbsp;<span class="num" id="6229842">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229845">repeat_power</span>&nbsp;<span class="op" id="6229858">:=</span>&nbsp;<span class="num" id="6229861">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6229865">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6229939">for</span>&nbsp;<span class="ident" id="6229943">i</span>&nbsp;<span class="op" id="6229945">:=</span>&nbsp;<span class="keyword" id="6229948">range</span>&nbsp;<span class="ident" id="6229954">bz2</span><span class="op" id="6229957">.</span><span class="ident" id="6229958">c</span>&nbsp;<span class="op" id="6229960">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229964">bz2</span><span class="op" id="6229967">.</span><span class="ident" id="6229968">c</span><span class="op" id="6229969">[</span><span class="ident" id="6229970">i</span><span class="op" id="6229971">]</span>&nbsp;<span class="op" id="6229973">=</span>&nbsp;<span class="num" id="6229975">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6229978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6229982">decoded</span>&nbsp;<span class="op" id="6229990">:=</span>&nbsp;<span class="num" id="6229993">0</span>&nbsp;<span class="comment" id="6229995">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230057">for</span>&nbsp;<span class="op" id="6230061">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230065">if</span>&nbsp;<span class="ident" id="6230068">decoded</span>&nbsp;<span class="op" id="6230076">==</span>&nbsp;<span class="num" id="6230079">50</span>&nbsp;<span class="op" id="6230082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230087">if</span>&nbsp;<span class="ident" id="6230090">selectorIndex</span>&nbsp;<span class="op" id="6230104">&gt;=</span>&nbsp;<span class="ident" id="6230107">numSelectors</span>&nbsp;<span class="op" id="6230120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230126">return</span>&nbsp;<span class="ident" id="6230133">StructuralError</span><span class="op" id="6230148">(</span><span class="string" id="6230149">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="6230202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230212">if</span>&nbsp;<span class="builtintype" id="6230215">int</span><span class="op" id="6230218">(</span><span class="ident" id="6230219">treeIndexes</span><span class="op" id="6230230">[</span><span class="ident" id="6230231">selectorIndex</span><span class="op" id="6230244">]</span><span class="op" id="6230245">)</span>&nbsp;<span class="op" id="6230247">&gt;=</span>&nbsp;<span class="builtinfunc" id="6230250">len</span><span class="op" id="6230253">(</span><span class="ident" id="6230254">huffmanTrees</span><span class="op" id="6230266">)</span>&nbsp;<span class="op" id="6230268">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230274">return</span>&nbsp;<span class="ident" id="6230281">StructuralError</span><span class="op" id="6230296">(</span><span class="string" id="6230297">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6230325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230335">currentHuffmanTree</span>&nbsp;<span class="op" id="6230354">=</span>&nbsp;<span class="ident" id="6230356">huffmanTrees</span><span class="op" id="6230368">[</span><span class="ident" id="6230369">treeIndexes</span><span class="op" id="6230380">[</span><span class="ident" id="6230381">selectorIndex</span><span class="op" id="6230394">]</span><span class="op" id="6230395">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230400">selectorIndex</span><span class="op" id="6230413">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230419">decoded</span>&nbsp;<span class="op" id="6230427">=</span>&nbsp;<span class="num" id="6230429">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230438">v</span>&nbsp;<span class="op" id="6230440">:=</span>&nbsp;<span class="ident" id="6230443">currentHuffmanTree</span><span class="op" id="6230461">.</span><span class="ident" id="6230462">Decode</span><span class="op" id="6230468">(</span><span class="ident" id="6230469">br</span><span class="op" id="6230471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230475">decoded</span><span class="op" id="6230482">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230488">if</span>&nbsp;<span class="ident" id="6230491">v</span>&nbsp;<span class="op" id="6230493">&lt;</span>&nbsp;<span class="num" id="6230495">2</span>&nbsp;<span class="op" id="6230497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6230502">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230548">if</span>&nbsp;<span class="ident" id="6230551">repeat</span>&nbsp;<span class="op" id="6230558">==</span>&nbsp;<span class="num" id="6230561">0</span>&nbsp;<span class="op" id="6230563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230569">repeat_power</span>&nbsp;<span class="op" id="6230582">=</span>&nbsp;<span class="num" id="6230584">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230589">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230594">repeat</span>&nbsp;<span class="op" id="6230601">+=</span>&nbsp;<span class="ident" id="6230604">repeat_power</span>&nbsp;<span class="op" id="6230617">&lt;&lt;</span>&nbsp;<span class="ident" id="6230620">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6230625">repeat_power</span>&nbsp;<span class="op" id="6230638">&lt;&lt;=</span>&nbsp;<span class="num" id="6230642">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6230648">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6230706">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230755">if</span>&nbsp;<span class="ident" id="6230758">repeat</span>&nbsp;<span class="op" id="6230765">&gt;</span>&nbsp;<span class="num" id="6230767">2</span><span class="op" id="6230768">*</span><span class="num" id="6230769">1024</span><span class="op" id="6230773">*</span><span class="num" id="6230774">1024</span>&nbsp;<span class="op" id="6230779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230785">return</span>&nbsp;<span class="ident" id="6230792">StructuralError</span><span class="op" id="6230807">(</span><span class="string" id="6230808">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="6230832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230842">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6230853">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230858">if</span>&nbsp;<span class="ident" id="6230861">repeat</span>&nbsp;<span class="op" id="6230868">&gt;</span>&nbsp;<span class="num" id="6230870">0</span>&nbsp;<span class="op" id="6230872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6230877">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6230935">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6230975">if</span>&nbsp;<span class="ident" id="6230978">repeat</span>&nbsp;<span class="op" id="6230985">&gt;</span>&nbsp;<span class="ident" id="6230987">bz2</span><span class="op" id="6230990">.</span><span class="ident" id="6230991">blockSize</span><span class="op" id="6231000">-</span><span class="ident" id="6231001">bufIndex</span>&nbsp;<span class="op" id="6231010">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231016">return</span>&nbsp;<span class="ident" id="6231023">StructuralError</span><span class="op" id="6231038">(</span><span class="string" id="6231039">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="6231066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6231071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231076">for</span>&nbsp;<span class="ident" id="6231080">i</span>&nbsp;<span class="op" id="6231082">:=</span>&nbsp;<span class="num" id="6231085">0</span><span class="op" id="6231086">;</span>&nbsp;<span class="ident" id="6231088">i</span>&nbsp;<span class="op" id="6231090">&lt;</span>&nbsp;<span class="ident" id="6231092">repeat</span><span class="op" id="6231098">;</span>&nbsp;<span class="ident" id="6231100">i</span><span class="op" id="6231101">++</span>&nbsp;<span class="op" id="6231104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231110">b</span>&nbsp;<span class="op" id="6231112">:=</span>&nbsp;<span class="builtintype" id="6231115">byte</span><span class="op" id="6231119">(</span><span class="ident" id="6231120">mtf</span><span class="op" id="6231123">.</span><span class="ident" id="6231124">First</span><span class="op" id="6231129">(</span><span class="op" id="6231130">)</span><span class="op" id="6231131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231137">bz2</span><span class="op" id="6231140">.</span><span class="ident" id="6231141">tt</span><span class="op" id="6231143">[</span><span class="ident" id="6231144">bufIndex</span><span class="op" id="6231152">]</span>&nbsp;<span class="op" id="6231154">=</span>&nbsp;<span class="builtintype" id="6231156">uint32</span><span class="op" id="6231162">(</span><span class="ident" id="6231163">b</span><span class="op" id="6231164">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231170">bz2</span><span class="op" id="6231173">.</span><span class="ident" id="6231174">c</span><span class="op" id="6231175">[</span><span class="ident" id="6231176">b</span><span class="op" id="6231177">]</span><span class="op" id="6231178">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231185">bufIndex</span><span class="op" id="6231193">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6231199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231204">repeat</span>&nbsp;<span class="op" id="6231211">=</span>&nbsp;<span class="num" id="6231213">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6231217">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231222">if</span>&nbsp;<span class="builtintype" id="6231225">int</span><span class="op" id="6231228">(</span><span class="ident" id="6231229">v</span><span class="op" id="6231230">)</span>&nbsp;<span class="op" id="6231232">==</span>&nbsp;<span class="ident" id="6231235">numSymbols</span><span class="op" id="6231245">-</span><span class="num" id="6231246">1</span>&nbsp;<span class="op" id="6231248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231253">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231310">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231368">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231414">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6231422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231427">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231491">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231552">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231618">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231677">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6231739">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231750">b</span>&nbsp;<span class="op" id="6231752">:=</span>&nbsp;<span class="builtintype" id="6231755">byte</span><span class="op" id="6231759">(</span><span class="ident" id="6231760">mtf</span><span class="op" id="6231763">.</span><span class="ident" id="6231764">Decode</span><span class="op" id="6231770">(</span><span class="builtintype" id="6231771">int</span><span class="op" id="6231774">(</span><span class="ident" id="6231775">v</span>&nbsp;<span class="op" id="6231777">-</span>&nbsp;<span class="num" id="6231779">1</span><span class="op" id="6231780">)</span><span class="op" id="6231781">)</span><span class="op" id="6231782">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231786">if</span>&nbsp;<span class="ident" id="6231789">bufIndex</span>&nbsp;<span class="op" id="6231798">&gt;=</span>&nbsp;<span class="ident" id="6231801">bz2</span><span class="op" id="6231804">.</span><span class="ident" id="6231805">blockSize</span>&nbsp;<span class="op" id="6231815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231820">return</span>&nbsp;<span class="ident" id="6231827">StructuralError</span><span class="op" id="6231842">(</span><span class="string" id="6231843">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="6231868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6231872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231876">bz2</span><span class="op" id="6231879">.</span><span class="ident" id="6231880">tt</span><span class="op" id="6231882">[</span><span class="ident" id="6231883">bufIndex</span><span class="op" id="6231891">]</span>&nbsp;<span class="op" id="6231893">=</span>&nbsp;<span class="builtintype" id="6231895">uint32</span><span class="op" id="6231901">(</span><span class="ident" id="6231902">b</span><span class="op" id="6231903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231907">bz2</span><span class="op" id="6231910">.</span><span class="ident" id="6231911">c</span><span class="op" id="6231912">[</span><span class="ident" id="6231913">b</span><span class="op" id="6231914">]</span><span class="op" id="6231915">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6231920">bufIndex</span><span class="op" id="6231928">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6231932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231936">if</span>&nbsp;<span class="ident" id="6231939">origPtr</span>&nbsp;<span class="op" id="6231947">&gt;=</span>&nbsp;<span class="builtintype" id="6231950">uint</span><span class="op" id="6231954">(</span><span class="ident" id="6231955">bufIndex</span><span class="op" id="6231963">)</span>&nbsp;<span class="op" id="6231965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6231969">return</span>&nbsp;<span class="ident" id="6231976">StructuralError</span><span class="op" id="6231991">(</span><span class="string" id="6231992">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="6232015">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6232018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232022">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6232089">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232131">bz2</span><span class="op" id="6232134">.</span><span class="ident" id="6232135">preRLE</span>&nbsp;<span class="op" id="6232142">=</span>&nbsp;<span class="ident" id="6232144">bz2</span><span class="op" id="6232147">.</span><span class="ident" id="6232148">tt</span><span class="op" id="6232150">[</span><span class="op" id="6232151">:</span><span class="ident" id="6232152">bufIndex</span><span class="op" id="6232160">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232163">bz2</span><span class="op" id="6232166">.</span><span class="ident" id="6232167">preRLEUsed</span>&nbsp;<span class="op" id="6232178">=</span>&nbsp;<span class="num" id="6232180">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232183">bz2</span><span class="op" id="6232186">.</span><span class="ident" id="6232187">tPos</span>&nbsp;<span class="op" id="6232192">=</span>&nbsp;<span class="ident" id="6232194">inverseBWT</span><span class="op" id="6232204">(</span><span class="ident" id="6232205">bz2</span><span class="op" id="6232208">.</span><span class="ident" id="6232209">preRLE</span><span class="op" id="6232215">,</span>&nbsp;<span class="ident" id="6232217">origPtr</span><span class="op" id="6232224">,</span>&nbsp;<span class="ident" id="6232226">bz2</span><span class="op" id="6232229">.</span><span class="ident" id="6232230">c</span><span class="op" id="6232231">[</span><span class="op" id="6232232">:</span><span class="op" id="6232233">]</span><span class="op" id="6232234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232237">bz2</span><span class="op" id="6232240">.</span><span class="ident" id="6232241">lastByte</span>&nbsp;<span class="op" id="6232250">=</span>&nbsp;<span class="op" id="6232252">-</span><span class="num" id="6232253">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232256">bz2</span><span class="op" id="6232259">.</span><span class="ident" id="6232260">byteRepeats</span>&nbsp;<span class="op" id="6232272">=</span>&nbsp;<span class="num" id="6232274">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232277">bz2</span><span class="op" id="6232280">.</span><span class="ident" id="6232281">repeats</span>&nbsp;<span class="op" id="6232289">=</span>&nbsp;<span class="num" id="6232291">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232295">return</span>&nbsp;<span class="ident" id="6232302">nil</span><br>
<span class="lineno"></span><span class="op" id="6232306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6232309">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="6232388">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="6232465">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6232541">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="6232619">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="6232654">//</span><br>
<span class="lineno">455</span><span class="comment" id="6232657">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="6232734">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6232814">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6232891">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6232904">func</span>&nbsp;<span class="ident" id="6232909">inverseBWT</span><span class="op" id="6232919">(</span><span class="ident" id="6232920">tt</span>&nbsp;<span class="op" id="6232923">[</span><span class="op" id="6232924">]</span><span class="builtintype" id="6232925">uint32</span><span class="op" id="6232931">,</span>&nbsp;<span class="ident" id="6232933">origPtr</span>&nbsp;<span class="builtintype" id="6232941">uint</span><span class="op" id="6232945">,</span>&nbsp;<span class="ident" id="6232947">c</span>&nbsp;<span class="op" id="6232949">[</span><span class="op" id="6232950">]</span><span class="builtintype" id="6232951">uint</span><span class="op" id="6232955">)</span>&nbsp;<span class="builtintype" id="6232957">uint32</span>&nbsp;<span class="op" id="6232964">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6232967">sum</span>&nbsp;<span class="op" id="6232971">:=</span>&nbsp;<span class="builtintype" id="6232974">uint</span><span class="op" id="6232978">(</span><span class="num" id="6232979">0</span><span class="op" id="6232980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6232983">for</span>&nbsp;<span class="ident" id="6232987">i</span>&nbsp;<span class="op" id="6232989">:=</span>&nbsp;<span class="num" id="6232992">0</span><span class="op" id="6232993">;</span>&nbsp;<span class="ident" id="6232995">i</span>&nbsp;<span class="op" id="6232997">&lt;</span>&nbsp;<span class="num" id="6232999">256</span><span class="op" id="6233002">;</span>&nbsp;<span class="ident" id="6233004">i</span><span class="op" id="6233005">++</span>&nbsp;<span class="op" id="6233008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233012">sum</span>&nbsp;<span class="op" id="6233016">+=</span>&nbsp;<span class="ident" id="6233019">c</span><span class="op" id="6233020">[</span><span class="ident" id="6233021">i</span><span class="op" id="6233022">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233026">c</span><span class="op" id="6233027">[</span><span class="ident" id="6233028">i</span><span class="op" id="6233029">]</span>&nbsp;<span class="op" id="6233031">=</span>&nbsp;<span class="ident" id="6233033">sum</span>&nbsp;<span class="op" id="6233037">-</span>&nbsp;<span class="ident" id="6233039">c</span><span class="op" id="6233040">[</span><span class="ident" id="6233041">i</span><span class="op" id="6233042">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233045">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233049">for</span>&nbsp;<span class="ident" id="6233053">i</span>&nbsp;<span class="op" id="6233055">:=</span>&nbsp;<span class="keyword" id="6233058">range</span>&nbsp;<span class="ident" id="6233064">tt</span>&nbsp;<span class="op" id="6233067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233071">b</span>&nbsp;<span class="op" id="6233073">:=</span>&nbsp;<span class="ident" id="6233076">tt</span><span class="op" id="6233078">[</span><span class="ident" id="6233079">i</span><span class="op" id="6233080">]</span>&nbsp;<span class="op" id="6233082">&amp;</span>&nbsp;<span class="num" id="6233084">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233091">tt</span><span class="op" id="6233093">[</span><span class="ident" id="6233094">c</span><span class="op" id="6233095">[</span><span class="ident" id="6233096">b</span><span class="op" id="6233097">]</span><span class="op" id="6233098">]</span>&nbsp;<span class="op" id="6233100">|=</span>&nbsp;<span class="builtintype" id="6233103">uint32</span><span class="op" id="6233109">(</span><span class="ident" id="6233110">i</span><span class="op" id="6233111">)</span>&nbsp;<span class="op" id="6233113">&lt;&lt;</span>&nbsp;<span class="num" id="6233116">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233120">c</span><span class="op" id="6233121">[</span><span class="ident" id="6233122">b</span><span class="op" id="6233123">]</span><span class="op" id="6233124">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233132">return</span>&nbsp;<span class="ident" id="6233139">tt</span><span class="op" id="6233141">[</span><span class="ident" id="6233142">origPtr</span><span class="op" id="6233149">]</span>&nbsp;<span class="op" id="6233151">&gt;&gt;</span>&nbsp;<span class="num" id="6233154">8</span><br>
<span class="lineno"></span><span class="op" id="6233156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="6233159">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="6233247">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6233332">var</span>&nbsp;<span class="ident" id="6233336">crctab</span>&nbsp;<span class="op" id="6233343">[</span><span class="num" id="6233344">256</span><span class="op" id="6233347">]</span><span class="builtintype" id="6233348">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="6233356">func</span>&nbsp;<span class="ident" id="6233361">init</span><span class="op" id="6233365">(</span><span class="op" id="6233366">)</span>&nbsp;<span class="op" id="6233368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233371">const</span>&nbsp;<span class="ident" id="6233377">poly</span>&nbsp;<span class="op" id="6233382">=</span>&nbsp;<span class="num" id="6233384">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233396">for</span>&nbsp;<span class="ident" id="6233400">i</span>&nbsp;<span class="op" id="6233402">:=</span>&nbsp;<span class="keyword" id="6233405">range</span>&nbsp;<span class="ident" id="6233411">crctab</span>&nbsp;<span class="op" id="6233418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233422">crc</span>&nbsp;<span class="op" id="6233426">:=</span>&nbsp;<span class="builtintype" id="6233429">uint32</span><span class="op" id="6233435">(</span><span class="ident" id="6233436">i</span><span class="op" id="6233437">)</span>&nbsp;<span class="op" id="6233439">&lt;&lt;</span>&nbsp;<span class="num" id="6233442">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233447">for</span>&nbsp;<span class="ident" id="6233451">j</span>&nbsp;<span class="op" id="6233453">:=</span>&nbsp;<span class="num" id="6233456">0</span><span class="op" id="6233457">;</span>&nbsp;<span class="ident" id="6233459">j</span>&nbsp;<span class="op" id="6233461">&lt;</span>&nbsp;<span class="num" id="6233463">8</span><span class="op" id="6233464">;</span>&nbsp;<span class="ident" id="6233466">j</span><span class="op" id="6233467">++</span>&nbsp;<span class="op" id="6233470">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233475">if</span>&nbsp;<span class="ident" id="6233478">crc</span><span class="op" id="6233481">&amp;</span><span class="num" id="6233482">0x80000000</span>&nbsp;<span class="op" id="6233493">!=</span>&nbsp;<span class="num" id="6233496">0</span>&nbsp;<span class="op" id="6233498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233504">crc</span>&nbsp;<span class="op" id="6233508">=</span>&nbsp;<span class="op" id="6233510">(</span><span class="ident" id="6233511">crc</span>&nbsp;<span class="op" id="6233515">&lt;&lt;</span>&nbsp;<span class="num" id="6233518">1</span><span class="op" id="6233519">)</span>&nbsp;<span class="op" id="6233521">^</span>&nbsp;<span class="ident" id="6233523">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233531">}</span>&nbsp;<span class="keyword" id="6233533">else</span>&nbsp;<span class="op" id="6233538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233544">crc</span>&nbsp;<span class="op" id="6233548">&lt;&lt;=</span>&nbsp;<span class="num" id="6233552">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233557">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233565">crctab</span><span class="op" id="6233571">[</span><span class="ident" id="6233572">i</span><span class="op" id="6233573">]</span>&nbsp;<span class="op" id="6233575">=</span>&nbsp;<span class="ident" id="6233577">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233582">}</span><br>
<span class="lineno"></span><span class="op" id="6233584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6233587">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="6233652">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="6233679">func</span>&nbsp;<span class="ident" id="6233684">updateCRC</span><span class="op" id="6233693">(</span><span class="ident" id="6233694">val</span>&nbsp;<span class="builtintype" id="6233698">uint32</span><span class="op" id="6233704">,</span>&nbsp;<span class="ident" id="6233706">b</span>&nbsp;<span class="op" id="6233708">[</span><span class="op" id="6233709">]</span><span class="builtintype" id="6233710">byte</span><span class="op" id="6233714">)</span>&nbsp;<span class="builtintype" id="6233716">uint32</span>&nbsp;<span class="op" id="6233723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233726">crc</span>&nbsp;<span class="op" id="6233730">:=</span>&nbsp;<span class="op" id="6233733">^</span><span class="ident" id="6233734">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233739">for</span>&nbsp;<span class="ident" id="6233743">_</span><span class="op" id="6233744">,</span>&nbsp;<span class="ident" id="6233746">v</span>&nbsp;<span class="op" id="6233748">:=</span>&nbsp;<span class="keyword" id="6233751">range</span>&nbsp;<span class="ident" id="6233757">b</span>&nbsp;<span class="op" id="6233759">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6233763">crc</span>&nbsp;<span class="op" id="6233767">=</span>&nbsp;<span class="ident" id="6233769">crctab</span><span class="op" id="6233775">[</span><span class="builtintype" id="6233776">byte</span><span class="op" id="6233780">(</span><span class="ident" id="6233781">crc</span><span class="op" id="6233784">&gt;&gt;</span><span class="num" id="6233786">24</span><span class="op" id="6233788">)</span><span class="op" id="6233789">^</span><span class="ident" id="6233790">v</span><span class="op" id="6233791">]</span>&nbsp;<span class="op" id="6233793">^</span>&nbsp;<span class="op" id="6233795">(</span><span class="ident" id="6233796">crc</span>&nbsp;<span class="op" id="6233800">&lt;&lt;</span>&nbsp;<span class="num" id="6233803">8</span><span class="op" id="6233804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6233807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6233810">return</span>&nbsp;<span class="op" id="6233817">^</span><span class="ident" id="6233818">crc</span><br>
<span class="lineno"></span><span class="op" id="6233822">}</span>
</div>
</body>
</html>
