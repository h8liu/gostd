<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5028247">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5028302">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5028356">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5028407">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5028444">package</span>&nbsp;<span class="ident" id="5028452">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5028457">import</span>&nbsp;<span class="op" id="5028464">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5028467">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5028474">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5028488">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5028500">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="5028510">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="5028513">type</span>&nbsp;<span class="ident" id="5028518">pkgBuilder</span>&nbsp;<span class="keyword" id="5028529">struct</span>&nbsp;<span class="op" id="5028536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028539">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5028546">*</span><span class="ident" id="5028547">token</span><span class="op" id="5028552">.</span><span class="ident" id="5028553">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028562">errors</span>&nbsp;<span class="ident" id="5028569">scanner</span><span class="op" id="5028576">.</span><span class="ident" id="5028577">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="5028587">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5028590">func</span>&nbsp;<span class="op" id="5028595">(</span><span class="ident" id="5028596">p</span>&nbsp;<span class="op" id="5028598">*</span><span class="ident" id="5028599">pkgBuilder</span><span class="op" id="5028609">)</span>&nbsp;<span class="builtintype" id="5028611">error</span><span class="op" id="5028616">(</span><span class="ident" id="5028617">pos</span>&nbsp;<span class="ident" id="5028621">token</span><span class="op" id="5028626">.</span><span class="ident" id="5028627">Pos</span><span class="op" id="5028630">,</span>&nbsp;<span class="ident" id="5028632">msg</span>&nbsp;<span class="builtintype" id="5028636">string</span><span class="op" id="5028642">)</span>&nbsp;<span class="op" id="5028644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028647">p</span><span class="op" id="5028648">.</span><span class="ident" id="5028649">errors</span><span class="op" id="5028655">.</span><span class="ident" id="5028656">Add</span><span class="op" id="5028659">(</span><span class="ident" id="5028660">p</span><span class="op" id="5028661">.</span><span class="ident" id="5028662">fset</span><span class="op" id="5028666">.</span><span class="ident" id="5028667">Position</span><span class="op" id="5028675">(</span><span class="ident" id="5028676">pos</span><span class="op" id="5028679">)</span><span class="op" id="5028680">,</span>&nbsp;<span class="ident" id="5028682">msg</span><span class="op" id="5028685">)</span><br>
<span class="lineno"></span><span class="op" id="5028687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5028690">func</span>&nbsp;<span class="op" id="5028695">(</span><span class="ident" id="5028696">p</span>&nbsp;<span class="op" id="5028698">*</span><span class="ident" id="5028699">pkgBuilder</span><span class="op" id="5028709">)</span>&nbsp;<span class="ident" id="5028711">errorf</span><span class="op" id="5028717">(</span><span class="ident" id="5028718">pos</span>&nbsp;<span class="ident" id="5028722">token</span><span class="op" id="5028727">.</span><span class="ident" id="5028728">Pos</span><span class="op" id="5028731">,</span>&nbsp;<span class="ident" id="5028733">format</span>&nbsp;<span class="builtintype" id="5028740">string</span><span class="op" id="5028746">,</span>&nbsp;<span class="ident" id="5028748">args</span>&nbsp;<span class="op" id="5028753">...</span><span class="keyword" id="5028756">interface</span><span class="op" id="5028765">{</span><span class="op" id="5028766">}</span><span class="op" id="5028767">)</span>&nbsp;<span class="op" id="5028769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028772">p</span><span class="op" id="5028773">.</span><span class="builtintype" id="5028774">error</span><span class="op" id="5028779">(</span><span class="ident" id="5028780">pos</span><span class="op" id="5028783">,</span>&nbsp;<span class="ident" id="5028785">fmt</span><span class="op" id="5028788">.</span><span class="ident" id="5028789">Sprintf</span><span class="op" id="5028796">(</span><span class="ident" id="5028797">format</span><span class="op" id="5028803">,</span>&nbsp;<span class="ident" id="5028805">args</span><span class="op" id="5028809">...</span><span class="op" id="5028812">)</span><span class="op" id="5028813">)</span><br>
<span class="lineno"></span><span class="op" id="5028815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5028818">func</span>&nbsp;<span class="op" id="5028823">(</span><span class="ident" id="5028824">p</span>&nbsp;<span class="op" id="5028826">*</span><span class="ident" id="5028827">pkgBuilder</span><span class="op" id="5028837">)</span>&nbsp;<span class="ident" id="5028839">declare</span><span class="op" id="5028846">(</span><span class="ident" id="5028847">scope</span><span class="op" id="5028852">,</span>&nbsp;<span class="ident" id="5028854">altScope</span>&nbsp;<span class="op" id="5028863">*</span><span class="ident" id="5028864">Scope</span><span class="op" id="5028869">,</span>&nbsp;<span class="ident" id="5028871">obj</span>&nbsp;<span class="op" id="5028875">*</span><span class="ident" id="5028876">Object</span><span class="op" id="5028882">)</span>&nbsp;<span class="op" id="5028884">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028887">alt</span>&nbsp;<span class="op" id="5028891">:=</span>&nbsp;<span class="ident" id="5028894">scope</span><span class="op" id="5028899">.</span><span class="ident" id="5028900">Insert</span><span class="op" id="5028906">(</span><span class="ident" id="5028907">obj</span><span class="op" id="5028910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028913">if</span>&nbsp;<span class="ident" id="5028916">alt</span>&nbsp;<span class="op" id="5028920">==</span>&nbsp;<span class="ident" id="5028923">nil</span>&nbsp;<span class="op" id="5028927">&amp;&amp;</span>&nbsp;<span class="ident" id="5028930">altScope</span>&nbsp;<span class="op" id="5028939">!=</span>&nbsp;<span class="ident" id="5028942">nil</span>&nbsp;<span class="op" id="5028946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5028950">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029009">alt</span>&nbsp;<span class="op" id="5029013">=</span>&nbsp;<span class="ident" id="5029015">altScope</span><span class="op" id="5029023">.</span><span class="ident" id="5029024">Lookup</span><span class="op" id="5029030">(</span><span class="ident" id="5029031">obj</span><span class="op" id="5029034">.</span><span class="ident" id="5029035">Name</span><span class="op" id="5029039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029042">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029045">if</span>&nbsp;<span class="ident" id="5029048">alt</span>&nbsp;<span class="op" id="5029052">!=</span>&nbsp;<span class="ident" id="5029055">nil</span>&nbsp;<span class="op" id="5029059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029063">prevDecl</span>&nbsp;<span class="op" id="5029072">:=</span>&nbsp;<span class="string" id="5029075">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029080">if</span>&nbsp;<span class="ident" id="5029083">pos</span>&nbsp;<span class="op" id="5029087">:=</span>&nbsp;<span class="ident" id="5029090">alt</span><span class="op" id="5029093">.</span><span class="ident" id="5029094">Pos</span><span class="op" id="5029097">(</span><span class="op" id="5029098">)</span><span class="op" id="5029099">;</span>&nbsp;<span class="ident" id="5029101">pos</span><span class="op" id="5029104">.</span><span class="ident" id="5029105">IsValid</span><span class="op" id="5029112">(</span><span class="op" id="5029113">)</span>&nbsp;<span class="op" id="5029115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029120">prevDecl</span>&nbsp;<span class="op" id="5029129">=</span>&nbsp;<span class="ident" id="5029131">fmt</span><span class="op" id="5029134">.</span><span class="ident" id="5029135">Sprintf</span><span class="op" id="5029142">(</span><span class="string" id="5029143">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="5029175">,</span>&nbsp;<span class="ident" id="5029177">p</span><span class="op" id="5029178">.</span><span class="ident" id="5029179">fset</span><span class="op" id="5029183">.</span><span class="ident" id="5029184">Position</span><span class="op" id="5029192">(</span><span class="ident" id="5029193">pos</span><span class="op" id="5029196">)</span><span class="op" id="5029197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029201">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029205">p</span><span class="op" id="5029206">.</span><span class="builtintype" id="5029207">error</span><span class="op" id="5029212">(</span><span class="ident" id="5029213">obj</span><span class="op" id="5029216">.</span><span class="ident" id="5029217">Pos</span><span class="op" id="5029220">(</span><span class="op" id="5029221">)</span><span class="op" id="5029222">,</span>&nbsp;<span class="ident" id="5029224">fmt</span><span class="op" id="5029227">.</span><span class="ident" id="5029228">Sprintf</span><span class="op" id="5029235">(</span><span class="string" id="5029236">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="5029267">,</span>&nbsp;<span class="ident" id="5029269">obj</span><span class="op" id="5029272">.</span><span class="ident" id="5029273">Name</span><span class="op" id="5029277">,</span>&nbsp;<span class="ident" id="5029279">prevDecl</span><span class="op" id="5029287">)</span><span class="op" id="5029288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029291">}</span><br>
<span class="lineno"></span><span class="op" id="5029293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5029296">func</span>&nbsp;<span class="ident" id="5029301">resolve</span><span class="op" id="5029308">(</span><span class="ident" id="5029309">scope</span>&nbsp;<span class="op" id="5029315">*</span><span class="ident" id="5029316">Scope</span><span class="op" id="5029321">,</span>&nbsp;<span class="ident" id="5029323">ident</span>&nbsp;<span class="op" id="5029329">*</span><span class="ident" id="5029330">Ident</span><span class="op" id="5029335">)</span>&nbsp;<span class="builtintype" id="5029337">bool</span>&nbsp;<span class="op" id="5029342">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029345">for</span>&nbsp;<span class="op" id="5029349">;</span>&nbsp;<span class="ident" id="5029351">scope</span>&nbsp;<span class="op" id="5029357">!=</span>&nbsp;<span class="ident" id="5029360">nil</span><span class="op" id="5029363">;</span>&nbsp;<span class="ident" id="5029365">scope</span>&nbsp;<span class="op" id="5029371">=</span>&nbsp;<span class="ident" id="5029373">scope</span><span class="op" id="5029378">.</span><span class="ident" id="5029379">Outer</span>&nbsp;<span class="op" id="5029385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029389">if</span>&nbsp;<span class="ident" id="5029392">obj</span>&nbsp;<span class="op" id="5029396">:=</span>&nbsp;<span class="ident" id="5029399">scope</span><span class="op" id="5029404">.</span><span class="ident" id="5029405">Lookup</span><span class="op" id="5029411">(</span><span class="ident" id="5029412">ident</span><span class="op" id="5029417">.</span><span class="ident" id="5029418">Name</span><span class="op" id="5029422">)</span><span class="op" id="5029423">;</span>&nbsp;<span class="ident" id="5029425">obj</span>&nbsp;<span class="op" id="5029429">!=</span>&nbsp;<span class="ident" id="5029432">nil</span>&nbsp;<span class="op" id="5029436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029441">ident</span><span class="op" id="5029446">.</span><span class="ident" id="5029447">Obj</span>&nbsp;<span class="op" id="5029451">=</span>&nbsp;<span class="ident" id="5029453">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029460">return</span>&nbsp;<span class="ident" id="5029467">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029474">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029480">return</span>&nbsp;<span class="ident" id="5029487">false</span><br>
<span class="lineno"></span><span class="op" id="5029493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5029496">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="5029553">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="5029611">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="5029661">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5029721">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5029790">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="5029855">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="5029920">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5029984">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="5029999">type</span>&nbsp;<span class="ident" id="5030004">Importer</span>&nbsp;<span class="keyword" id="5030013">func</span><span class="op" id="5030017">(</span><span class="ident" id="5030018">imports</span>&nbsp;<span class="keyword" id="5030026">map</span><span class="op" id="5030029">[</span><span class="builtintype" id="5030030">string</span><span class="op" id="5030036">]</span><span class="op" id="5030037">*</span><span class="ident" id="5030038">Object</span><span class="op" id="5030044">,</span>&nbsp;<span class="ident" id="5030046">path</span>&nbsp;<span class="builtintype" id="5030051">string</span><span class="op" id="5030057">)</span>&nbsp;<span class="op" id="5030059">(</span><span class="ident" id="5030060">pkg</span>&nbsp;<span class="op" id="5030064">*</span><span class="ident" id="5030065">Object</span><span class="op" id="5030071">,</span>&nbsp;<span class="ident" id="5030073">err</span>&nbsp;<span class="builtintype" id="5030077">error</span><span class="op" id="5030082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5030085">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="5030164">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="5030243">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5030323">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="5030400">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="5030477">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5030554">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5030612">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="5030690">//</span><br>
<span class="lineno"></span><span class="keyword" id="5030693">func</span>&nbsp;<span class="ident" id="5030698">NewPackage</span><span class="op" id="5030708">(</span><span class="ident" id="5030709">fset</span>&nbsp;<span class="op" id="5030714">*</span><span class="ident" id="5030715">token</span><span class="op" id="5030720">.</span><span class="ident" id="5030721">FileSet</span><span class="op" id="5030728">,</span>&nbsp;<span class="ident" id="5030730">files</span>&nbsp;<span class="keyword" id="5030736">map</span><span class="op" id="5030739">[</span><span class="builtintype" id="5030740">string</span><span class="op" id="5030746">]</span><span class="op" id="5030747">*</span><span class="ident" id="5030748">File</span><span class="op" id="5030752">,</span>&nbsp;<span class="ident" id="5030754">importer</span>&nbsp;<span class="ident" id="5030763">Importer</span><span class="op" id="5030771">,</span>&nbsp;<span class="ident" id="5030773">universe</span>&nbsp;<span class="op" id="5030782">*</span><span class="ident" id="5030783">Scope</span><span class="op" id="5030788">)</span>&nbsp;<span class="op" id="5030790">(</span><span class="op" id="5030791">*</span><span class="ident" id="5030792">Package</span><span class="op" id="5030799">,</span>&nbsp;<span class="builtintype" id="5030801">error</span><span class="op" id="5030806">)</span>&nbsp;<span class="op" id="5030808">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5030811">var</span>&nbsp;<span class="ident" id="5030815">p</span>&nbsp;<span class="ident" id="5030817">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030829">p</span><span class="op" id="5030830">.</span><span class="ident" id="5030831">fset</span>&nbsp;<span class="op" id="5030836">=</span>&nbsp;<span class="ident" id="5030838">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5030845">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030872">pkgName</span>&nbsp;<span class="op" id="5030880">:=</span>&nbsp;<span class="string" id="5030883">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030887">pkgScope</span>&nbsp;<span class="op" id="5030896">:=</span>&nbsp;<span class="ident" id="5030899">NewScope</span><span class="op" id="5030907">(</span><span class="ident" id="5030908">universe</span><span class="op" id="5030916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5030919">for</span>&nbsp;<span class="ident" id="5030923">_</span><span class="op" id="5030924">,</span>&nbsp;<span class="ident" id="5030926">file</span>&nbsp;<span class="op" id="5030931">:=</span>&nbsp;<span class="keyword" id="5030934">range</span>&nbsp;<span class="ident" id="5030940">files</span>&nbsp;<span class="op" id="5030946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5030950">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5030980">switch</span>&nbsp;<span class="ident" id="5030987">name</span>&nbsp;<span class="op" id="5030992">:=</span>&nbsp;<span class="ident" id="5030995">file</span><span class="op" id="5030999">.</span><span class="ident" id="5031000">Name</span><span class="op" id="5031004">.</span><span class="ident" id="5031005">Name</span><span class="op" id="5031009">;</span>&nbsp;<span class="op" id="5031011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031015">case</span>&nbsp;<span class="ident" id="5031020">pkgName</span>&nbsp;<span class="op" id="5031028">==</span>&nbsp;<span class="string" id="5031031">&#34;&#34;</span><span class="op" id="5031033">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031038">pkgName</span>&nbsp;<span class="op" id="5031046">=</span>&nbsp;<span class="ident" id="5031048">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031055">case</span>&nbsp;<span class="ident" id="5031060">name</span>&nbsp;<span class="op" id="5031065">!=</span>&nbsp;<span class="ident" id="5031068">pkgName</span><span class="op" id="5031075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031080">p</span><span class="op" id="5031081">.</span><span class="ident" id="5031082">errorf</span><span class="op" id="5031088">(</span><span class="ident" id="5031089">file</span><span class="op" id="5031093">.</span><span class="ident" id="5031094">Package</span><span class="op" id="5031101">,</span>&nbsp;<span class="string" id="5031103">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="5031128">,</span>&nbsp;<span class="ident" id="5031130">name</span><span class="op" id="5031134">,</span>&nbsp;<span class="ident" id="5031136">pkgName</span><span class="op" id="5031143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031148">continue</span>&nbsp;<span class="comment" id="5031157">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5031179">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031184">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031237">for</span>&nbsp;<span class="ident" id="5031241">_</span><span class="op" id="5031242">,</span>&nbsp;<span class="ident" id="5031244">obj</span>&nbsp;<span class="op" id="5031248">:=</span>&nbsp;<span class="keyword" id="5031251">range</span>&nbsp;<span class="ident" id="5031257">file</span><span class="op" id="5031261">.</span><span class="ident" id="5031262">Scope</span><span class="op" id="5031267">.</span><span class="ident" id="5031268">Objects</span>&nbsp;<span class="op" id="5031276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031281">p</span><span class="op" id="5031282">.</span><span class="ident" id="5031283">declare</span><span class="op" id="5031290">(</span><span class="ident" id="5031291">pkgScope</span><span class="op" id="5031299">,</span>&nbsp;<span class="ident" id="5031301">nil</span><span class="op" id="5031304">,</span>&nbsp;<span class="ident" id="5031306">obj</span><span class="op" id="5031309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5031313">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5031316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031320">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031390">imports</span>&nbsp;<span class="op" id="5031398">:=</span>&nbsp;<span class="builtinfunc" id="5031401">make</span><span class="op" id="5031405">(</span><span class="keyword" id="5031406">map</span><span class="op" id="5031409">[</span><span class="builtintype" id="5031410">string</span><span class="op" id="5031416">]</span><span class="op" id="5031417">*</span><span class="ident" id="5031418">Object</span><span class="op" id="5031424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031428">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031490">for</span>&nbsp;<span class="ident" id="5031494">_</span><span class="op" id="5031495">,</span>&nbsp;<span class="ident" id="5031497">file</span>&nbsp;<span class="op" id="5031502">:=</span>&nbsp;<span class="keyword" id="5031505">range</span>&nbsp;<span class="ident" id="5031511">files</span>&nbsp;<span class="op" id="5031517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031521">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031575">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031614">if</span>&nbsp;<span class="ident" id="5031617">file</span><span class="op" id="5031621">.</span><span class="ident" id="5031622">Name</span><span class="op" id="5031626">.</span><span class="ident" id="5031627">Name</span>&nbsp;<span class="op" id="5031632">!=</span>&nbsp;<span class="ident" id="5031635">pkgName</span>&nbsp;<span class="op" id="5031643">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031648">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5031659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031664">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031712">importErrors</span>&nbsp;<span class="op" id="5031725">:=</span>&nbsp;<span class="ident" id="5031728">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031736">fileScope</span>&nbsp;<span class="op" id="5031746">:=</span>&nbsp;<span class="ident" id="5031749">NewScope</span><span class="op" id="5031757">(</span><span class="ident" id="5031758">pkgScope</span><span class="op" id="5031766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031770">for</span>&nbsp;<span class="ident" id="5031774">_</span><span class="op" id="5031775">,</span>&nbsp;<span class="ident" id="5031777">spec</span>&nbsp;<span class="op" id="5031782">:=</span>&nbsp;<span class="keyword" id="5031785">range</span>&nbsp;<span class="ident" id="5031791">file</span><span class="op" id="5031795">.</span><span class="ident" id="5031796">Imports</span>&nbsp;<span class="op" id="5031804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031809">if</span>&nbsp;<span class="ident" id="5031812">importer</span>&nbsp;<span class="op" id="5031821">==</span>&nbsp;<span class="ident" id="5031824">nil</span>&nbsp;<span class="op" id="5031828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031834">importErrors</span>&nbsp;<span class="op" id="5031847">=</span>&nbsp;<span class="ident" id="5031849">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031858">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5031870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031875">path</span><span class="op" id="5031879">,</span>&nbsp;<span class="ident" id="5031881">_</span>&nbsp;<span class="op" id="5031883">:=</span>&nbsp;<span class="ident" id="5031886">strconv</span><span class="op" id="5031893">.</span><span class="ident" id="5031894">Unquote</span><span class="op" id="5031901">(</span><span class="ident" id="5031902">spec</span><span class="op" id="5031906">.</span><span class="ident" id="5031907">Path</span><span class="op" id="5031911">.</span><span class="ident" id="5031912">Value</span><span class="op" id="5031917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031922">pkg</span><span class="op" id="5031925">,</span>&nbsp;<span class="ident" id="5031927">err</span>&nbsp;<span class="op" id="5031931">:=</span>&nbsp;<span class="ident" id="5031934">importer</span><span class="op" id="5031942">(</span><span class="ident" id="5031943">imports</span><span class="op" id="5031950">,</span>&nbsp;<span class="ident" id="5031952">path</span><span class="op" id="5031956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031961">if</span>&nbsp;<span class="ident" id="5031964">err</span>&nbsp;<span class="op" id="5031968">!=</span>&nbsp;<span class="ident" id="5031971">nil</span>&nbsp;<span class="op" id="5031975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031981">p</span><span class="op" id="5031982">.</span><span class="ident" id="5031983">errorf</span><span class="op" id="5031989">(</span><span class="ident" id="5031990">spec</span><span class="op" id="5031994">.</span><span class="ident" id="5031995">Path</span><span class="op" id="5031999">.</span><span class="ident" id="5032000">Pos</span><span class="op" id="5032003">(</span><span class="op" id="5032004">)</span><span class="op" id="5032005">,</span>&nbsp;<span class="string" id="5032007">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="5032033">,</span>&nbsp;<span class="ident" id="5032035">path</span><span class="op" id="5032039">,</span>&nbsp;<span class="ident" id="5032041">err</span><span class="op" id="5032044">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032050">importErrors</span>&nbsp;<span class="op" id="5032063">=</span>&nbsp;<span class="ident" id="5032065">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032074">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032091">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032151">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032212">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032275">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032324">name</span>&nbsp;<span class="op" id="5032329">:=</span>&nbsp;<span class="ident" id="5032332">pkg</span><span class="op" id="5032335">.</span><span class="ident" id="5032336">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032344">if</span>&nbsp;<span class="ident" id="5032347">spec</span><span class="op" id="5032351">.</span><span class="ident" id="5032352">Name</span>&nbsp;<span class="op" id="5032357">!=</span>&nbsp;<span class="ident" id="5032360">nil</span>&nbsp;<span class="op" id="5032364">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032370">name</span>&nbsp;<span class="op" id="5032375">=</span>&nbsp;<span class="ident" id="5032377">spec</span><span class="op" id="5032381">.</span><span class="ident" id="5032382">Name</span><span class="op" id="5032386">.</span><span class="ident" id="5032387">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032401">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032432">if</span>&nbsp;<span class="ident" id="5032435">name</span>&nbsp;<span class="op" id="5032440">==</span>&nbsp;<span class="string" id="5032443">&#34;.&#34;</span>&nbsp;<span class="op" id="5032447">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032453">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032497">for</span>&nbsp;<span class="ident" id="5032501">_</span><span class="op" id="5032502">,</span>&nbsp;<span class="ident" id="5032504">obj</span>&nbsp;<span class="op" id="5032508">:=</span>&nbsp;<span class="keyword" id="5032511">range</span>&nbsp;<span class="ident" id="5032517">pkg</span><span class="op" id="5032520">.</span><span class="ident" id="5032521">Data</span><span class="op" id="5032525">.</span><span class="op" id="5032526">(</span><span class="op" id="5032527">*</span><span class="ident" id="5032528">Scope</span><span class="op" id="5032533">)</span><span class="op" id="5032534">.</span><span class="ident" id="5032535">Objects</span>&nbsp;<span class="op" id="5032543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032550">p</span><span class="op" id="5032551">.</span><span class="ident" id="5032552">declare</span><span class="op" id="5032559">(</span><span class="ident" id="5032560">fileScope</span><span class="op" id="5032569">,</span>&nbsp;<span class="ident" id="5032571">pkgScope</span><span class="op" id="5032579">,</span>&nbsp;<span class="ident" id="5032581">obj</span><span class="op" id="5032584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032595">}</span>&nbsp;<span class="keyword" id="5032597">else</span>&nbsp;<span class="keyword" id="5032602">if</span>&nbsp;<span class="ident" id="5032605">name</span>&nbsp;<span class="op" id="5032610">!=</span>&nbsp;<span class="string" id="5032613">&#34;_&#34;</span>&nbsp;<span class="op" id="5032617">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032623">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032676">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032731">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032788">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032816">obj</span>&nbsp;<span class="op" id="5032820">:=</span>&nbsp;<span class="ident" id="5032823">NewObj</span><span class="op" id="5032829">(</span><span class="ident" id="5032830">Pkg</span><span class="op" id="5032833">,</span>&nbsp;<span class="ident" id="5032835">name</span><span class="op" id="5032839">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032845">obj</span><span class="op" id="5032848">.</span><span class="ident" id="5032849">Decl</span>&nbsp;<span class="op" id="5032854">=</span>&nbsp;<span class="ident" id="5032856">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032865">obj</span><span class="op" id="5032868">.</span><span class="ident" id="5032869">Data</span>&nbsp;<span class="op" id="5032874">=</span>&nbsp;<span class="ident" id="5032876">pkg</span><span class="op" id="5032879">.</span><span class="ident" id="5032880">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032889">p</span><span class="op" id="5032890">.</span><span class="ident" id="5032891">declare</span><span class="op" id="5032898">(</span><span class="ident" id="5032899">fileScope</span><span class="op" id="5032908">,</span>&nbsp;<span class="ident" id="5032910">pkgScope</span><span class="op" id="5032918">,</span>&nbsp;<span class="ident" id="5032920">obj</span><span class="op" id="5032923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032932">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032937">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032962">if</span>&nbsp;<span class="ident" id="5032965">importErrors</span>&nbsp;<span class="op" id="5032978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032983">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033042">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033101">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033160">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033199">pkgScope</span><span class="op" id="5033207">.</span><span class="ident" id="5033208">Outer</span>&nbsp;<span class="op" id="5033214">=</span>&nbsp;<span class="ident" id="5033216">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033226">i</span>&nbsp;<span class="op" id="5033228">:=</span>&nbsp;<span class="num" id="5033231">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033235">for</span>&nbsp;<span class="ident" id="5033239">_</span><span class="op" id="5033240">,</span>&nbsp;<span class="ident" id="5033242">ident</span>&nbsp;<span class="op" id="5033248">:=</span>&nbsp;<span class="keyword" id="5033251">range</span>&nbsp;<span class="ident" id="5033257">file</span><span class="op" id="5033261">.</span><span class="ident" id="5033262">Unresolved</span>&nbsp;<span class="op" id="5033273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033278">if</span>&nbsp;<span class="op" id="5033281">!</span><span class="ident" id="5033282">resolve</span><span class="op" id="5033289">(</span><span class="ident" id="5033290">fileScope</span><span class="op" id="5033299">,</span>&nbsp;<span class="ident" id="5033301">ident</span><span class="op" id="5033306">)</span>&nbsp;<span class="op" id="5033308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033314">p</span><span class="op" id="5033315">.</span><span class="ident" id="5033316">errorf</span><span class="op" id="5033322">(</span><span class="ident" id="5033323">ident</span><span class="op" id="5033328">.</span><span class="ident" id="5033329">Pos</span><span class="op" id="5033332">(</span><span class="op" id="5033333">)</span><span class="op" id="5033334">,</span>&nbsp;<span class="string" id="5033336">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="5033357">,</span>&nbsp;<span class="ident" id="5033359">ident</span><span class="op" id="5033364">.</span><span class="ident" id="5033365">Name</span><span class="op" id="5033369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033375">file</span><span class="op" id="5033379">.</span><span class="ident" id="5033380">Unresolved</span><span class="op" id="5033390">[</span><span class="ident" id="5033391">i</span><span class="op" id="5033392">]</span>&nbsp;<span class="op" id="5033394">=</span>&nbsp;<span class="ident" id="5033396">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033406">i</span><span class="op" id="5033407">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033422">file</span><span class="op" id="5033426">.</span><span class="ident" id="5033427">Unresolved</span>&nbsp;<span class="op" id="5033438">=</span>&nbsp;<span class="ident" id="5033440">file</span><span class="op" id="5033444">.</span><span class="ident" id="5033445">Unresolved</span><span class="op" id="5033455">[</span><span class="num" id="5033456">0</span><span class="op" id="5033457">:</span><span class="ident" id="5033458">i</span><span class="op" id="5033459">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033463">pkgScope</span><span class="op" id="5033471">.</span><span class="ident" id="5033472">Outer</span>&nbsp;<span class="op" id="5033478">=</span>&nbsp;<span class="ident" id="5033480">universe</span>&nbsp;<span class="comment" id="5033489">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033518">p</span><span class="op" id="5033519">.</span><span class="ident" id="5033520">errors</span><span class="op" id="5033526">.</span><span class="ident" id="5033527">Sort</span><span class="op" id="5033531">(</span><span class="op" id="5033532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033535">return</span>&nbsp;<span class="op" id="5033542">&amp;</span><span class="ident" id="5033543">Package</span><span class="op" id="5033550">{</span><span class="ident" id="5033551">pkgName</span><span class="op" id="5033558">,</span>&nbsp;<span class="ident" id="5033560">pkgScope</span><span class="op" id="5033568">,</span>&nbsp;<span class="ident" id="5033570">imports</span><span class="op" id="5033577">,</span>&nbsp;<span class="ident" id="5033579">files</span><span class="op" id="5033584">}</span><span class="op" id="5033585">,</span>&nbsp;<span class="ident" id="5033587">p</span><span class="op" id="5033588">.</span><span class="ident" id="5033589">errors</span><span class="op" id="5033595">.</span><span class="ident" id="5033596">Err</span><span class="op" id="5033599">(</span><span class="op" id="5033600">)</span><br>
<span class="lineno"></span><span class="op" id="5033602">}</span>
</div>
</body>
</html>
