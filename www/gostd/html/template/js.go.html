<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html" class="current">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3542308">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3542363">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3542417">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3542468">package</span>&nbsp;<span class="ident" id="3542476">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3542486">import</span>&nbsp;<span class="op" id="3542493">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3542496">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3542505">&#34;encoding/json&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3542522">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3542529">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3542540">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3542551">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3542566">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3542569">//&nbsp;nextJSCtx&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;determines&nbsp;whether&nbsp;a&nbsp;slash&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3542644">//&nbsp;given&nbsp;run&nbsp;of&nbsp;tokens&nbsp;starts&nbsp;a&nbsp;regular&nbsp;expression&nbsp;instead&nbsp;of&nbsp;a&nbsp;division</span><br>
<span class="lineno"></span><span class="comment" id="3542717">//&nbsp;operator:&nbsp;/&nbsp;or&nbsp;/=.</span><br>
<span class="lineno"></span><span class="comment" id="3542739">//</span><br>
<span class="lineno">20</span><span class="comment" id="3542742">//&nbsp;This&nbsp;assumes&nbsp;that&nbsp;the&nbsp;token&nbsp;run&nbsp;does&nbsp;not&nbsp;include&nbsp;any&nbsp;string&nbsp;tokens,&nbsp;comment</span><br>
<span class="lineno"></span><span class="comment" id="3542821">//&nbsp;tokens,&nbsp;regular&nbsp;expression&nbsp;literal&nbsp;tokens,&nbsp;or&nbsp;division&nbsp;operators.</span><br>
<span class="lineno"></span><span class="comment" id="3542890">//</span><br>
<span class="lineno"></span><span class="comment" id="3542893">//&nbsp;This&nbsp;fails&nbsp;on&nbsp;some&nbsp;valid&nbsp;but&nbsp;nonsensical&nbsp;JavaScript&nbsp;programs&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="3542962">//&nbsp;&#34;x&nbsp;=&nbsp;++/foo/i&#34;&nbsp;which&nbsp;is&nbsp;quite&nbsp;different&nbsp;than&nbsp;&#34;x++/foo/i&#34;,&nbsp;but&nbsp;is&nbsp;not&nbsp;known&nbsp;to</span><br>
<span class="lineno">25</span><span class="comment" id="3543043">//&nbsp;fail&nbsp;on&nbsp;any&nbsp;known&nbsp;useful&nbsp;programs.&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;draft</span><br>
<span class="lineno"></span><span class="comment" id="3543106">//&nbsp;JavaScript&nbsp;2.0&nbsp;lexical&nbsp;grammar&nbsp;and&nbsp;requires&nbsp;one&nbsp;token&nbsp;of&nbsp;lookbehind:</span><br>
<span class="lineno"></span><span class="comment" id="3543178">//&nbsp;http://www.mozilla.org/js/language/js20-2000-07/rationale/syntax.html</span><br>
<span class="lineno"></span><span class="keyword" id="3543251">func</span>&nbsp;<span class="ident" id="3543256">nextJSCtx</span><span class="op" id="3543265">(</span><span class="ident" id="3543266">s</span>&nbsp;<span class="op" id="3543268">[</span><span class="op" id="3543269">]</span><span class="builtintype" id="3543270">byte</span><span class="op" id="3543274">,</span>&nbsp;<span class="ident" id="3543276">preceding</span>&nbsp;<span class="ident" id="3543286">jsCtx</span><span class="op" id="3543291">)</span>&nbsp;<span class="ident" id="3543293">jsCtx</span>&nbsp;<span class="op" id="3543299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3543302">s</span>&nbsp;<span class="op" id="3543304">=</span>&nbsp;<span class="ident" id="3543306">bytes</span><span class="op" id="3543311">.</span><span class="ident" id="3543312">TrimRight</span><span class="op" id="3543321">(</span><span class="ident" id="3543322">s</span><span class="op" id="3543323">,</span>&nbsp;<span class="string" id="3543325">&#34;\t\n\f\r&nbsp;\u2028\u2029&#34;</span><span class="op" id="3543348">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543351">if</span>&nbsp;<span class="builtinfunc" id="3543354">len</span><span class="op" id="3543357">(</span><span class="ident" id="3543358">s</span><span class="op" id="3543359">)</span>&nbsp;<span class="op" id="3543361">==</span>&nbsp;<span class="num" id="3543364">0</span>&nbsp;<span class="op" id="3543366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543370">return</span>&nbsp;<span class="ident" id="3543377">preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543392">//&nbsp;All&nbsp;cases&nbsp;below&nbsp;are&nbsp;in&nbsp;the&nbsp;single-byte&nbsp;UTF-8&nbsp;group.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543448">switch</span>&nbsp;<span class="ident" id="3543455">c</span><span class="op" id="3543456">,</span>&nbsp;<span class="ident" id="3543458">n</span>&nbsp;<span class="op" id="3543460">:=</span>&nbsp;<span class="ident" id="3543463">s</span><span class="op" id="3543464">[</span><span class="builtinfunc" id="3543465">len</span><span class="op" id="3543468">(</span><span class="ident" id="3543469">s</span><span class="op" id="3543470">)</span><span class="op" id="3543471">-</span><span class="num" id="3543472">1</span><span class="op" id="3543473">]</span><span class="op" id="3543474">,</span>&nbsp;<span class="builtinfunc" id="3543476">len</span><span class="op" id="3543479">(</span><span class="ident" id="3543480">s</span><span class="op" id="3543481">)</span><span class="op" id="3543482">;</span>&nbsp;<span class="ident" id="3543484">c</span>&nbsp;<span class="op" id="3543486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543489">case</span>&nbsp;<span class="string" id="3543494">&#39;+&#39;</span><span class="op" id="3543497">,</span>&nbsp;<span class="string" id="3543499">&#39;-&#39;</span><span class="op" id="3543502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543506">//&nbsp;++&nbsp;and&nbsp;--&nbsp;are&nbsp;not&nbsp;regexp&nbsp;preceders,&nbsp;but&nbsp;+&nbsp;and&nbsp;-&nbsp;are&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543571">//&nbsp;they&nbsp;are&nbsp;used&nbsp;as&nbsp;infix&nbsp;or&nbsp;prefix&nbsp;operators.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3543620">start</span>&nbsp;<span class="op" id="3543626">:=</span>&nbsp;<span class="ident" id="3543629">n</span>&nbsp;<span class="op" id="3543631">-</span>&nbsp;<span class="num" id="3543633">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543637">//&nbsp;Count&nbsp;the&nbsp;number&nbsp;of&nbsp;adjacent&nbsp;dashes&nbsp;or&nbsp;pluses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543689">for</span>&nbsp;<span class="ident" id="3543693">start</span>&nbsp;<span class="op" id="3543699">&gt;</span>&nbsp;<span class="num" id="3543701">0</span>&nbsp;<span class="op" id="3543703">&amp;&amp;</span>&nbsp;<span class="ident" id="3543706">s</span><span class="op" id="3543707">[</span><span class="ident" id="3543708">start</span><span class="op" id="3543713">-</span><span class="num" id="3543714">1</span><span class="op" id="3543715">]</span>&nbsp;<span class="op" id="3543717">==</span>&nbsp;<span class="ident" id="3543720">c</span>&nbsp;<span class="op" id="3543722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3543727">start</span><span class="op" id="3543732">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543741">if</span>&nbsp;<span class="op" id="3543744">(</span><span class="ident" id="3543745">n</span><span class="op" id="3543746">-</span><span class="ident" id="3543747">start</span><span class="op" id="3543752">)</span><span class="op" id="3543753">&amp;</span><span class="num" id="3543754">1</span>&nbsp;<span class="op" id="3543756">==</span>&nbsp;<span class="num" id="3543759">1</span>&nbsp;<span class="op" id="3543761">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543766">//&nbsp;Reached&nbsp;for&nbsp;trailing&nbsp;minus&nbsp;signs&nbsp;since&nbsp;&#34;---&#34;&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543824">//&nbsp;same&nbsp;as&nbsp;&#34;--&nbsp;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543846">return</span>&nbsp;<span class="ident" id="3543853">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543871">return</span>&nbsp;<span class="ident" id="3543878">jsCtxDivOp</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543890">case</span>&nbsp;<span class="string" id="3543895">&#39;.&#39;</span><span class="op" id="3543898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543902">//&nbsp;Handle&nbsp;&#34;42.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543920">if</span>&nbsp;<span class="ident" id="3543923">n</span>&nbsp;<span class="op" id="3543925">!=</span>&nbsp;<span class="num" id="3543928">1</span>&nbsp;<span class="op" id="3543930">&amp;&amp;</span>&nbsp;<span class="string" id="3543933">&#39;0&#39;</span>&nbsp;<span class="op" id="3543937">&lt;=</span>&nbsp;<span class="ident" id="3543940">s</span><span class="op" id="3543941">[</span><span class="ident" id="3543942">n</span><span class="op" id="3543943">-</span><span class="num" id="3543944">2</span><span class="op" id="3543945">]</span>&nbsp;<span class="op" id="3543947">&amp;&amp;</span>&nbsp;<span class="ident" id="3543950">s</span><span class="op" id="3543951">[</span><span class="ident" id="3543952">n</span><span class="op" id="3543953">-</span><span class="num" id="3543954">2</span><span class="op" id="3543955">]</span>&nbsp;<span class="op" id="3543957">&lt;=</span>&nbsp;<span class="string" id="3543960">&#39;9&#39;</span>&nbsp;<span class="op" id="3543964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543969">return</span>&nbsp;<span class="ident" id="3543976">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543989">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543993">return</span>&nbsp;<span class="ident" id="3544000">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544013">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544084">//&nbsp;that&nbsp;only&nbsp;end&nbsp;binary&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544138">case</span>&nbsp;<span class="string" id="3544143">&#39;,&#39;</span><span class="op" id="3544146">,</span>&nbsp;<span class="string" id="3544148">&#39;&lt;&#39;</span><span class="op" id="3544151">,</span>&nbsp;<span class="string" id="3544153">&#39;&gt;&#39;</span><span class="op" id="3544156">,</span>&nbsp;<span class="string" id="3544158">&#39;=&#39;</span><span class="op" id="3544161">,</span>&nbsp;<span class="string" id="3544163">&#39;*&#39;</span><span class="op" id="3544166">,</span>&nbsp;<span class="string" id="3544168">&#39;%&#39;</span><span class="op" id="3544171">,</span>&nbsp;<span class="string" id="3544173">&#39;&amp;&#39;</span><span class="op" id="3544176">,</span>&nbsp;<span class="string" id="3544178">&#39;|&#39;</span><span class="op" id="3544181">,</span>&nbsp;<span class="string" id="3544183">&#39;^&#39;</span><span class="op" id="3544186">,</span>&nbsp;<span class="string" id="3544188">&#39;?&#39;</span><span class="op" id="3544191">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544195">return</span>&nbsp;<span class="ident" id="3544202">jsCtxRegexp</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544215">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544286">//&nbsp;that&nbsp;are&nbsp;prefix&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544335">case</span>&nbsp;<span class="string" id="3544340">&#39;!&#39;</span><span class="op" id="3544343">,</span>&nbsp;<span class="string" id="3544345">&#39;~&#39;</span><span class="op" id="3544348">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544352">return</span>&nbsp;<span class="ident" id="3544359">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544372">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544442">//&nbsp;that&nbsp;are&nbsp;open&nbsp;brackets&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544488">case</span>&nbsp;<span class="string" id="3544493">&#39;(&#39;</span><span class="op" id="3544496">,</span>&nbsp;<span class="string" id="3544498">&#39;[&#39;</span><span class="op" id="3544501">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544505">return</span>&nbsp;<span class="ident" id="3544512">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544525">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544595">//&nbsp;that&nbsp;precede&nbsp;expression&nbsp;starts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544631">case</span>&nbsp;<span class="string" id="3544636">&#39;:&#39;</span><span class="op" id="3544639">,</span>&nbsp;<span class="string" id="3544641">&#39;;&#39;</span><span class="op" id="3544644">,</span>&nbsp;<span class="string" id="3544646">&#39;{&#39;</span><span class="op" id="3544649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544653">return</span>&nbsp;<span class="ident" id="3544660">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544673">//&nbsp;CAVEAT:&nbsp;the&nbsp;close&nbsp;punctuators&nbsp;(&#39;}&#39;,&nbsp;&#39;]&#39;,&nbsp;&#39;)&#39;)&nbsp;precede&nbsp;div&nbsp;ops&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544743">//&nbsp;are&nbsp;handled&nbsp;in&nbsp;the&nbsp;default&nbsp;except&nbsp;for&nbsp;&#39;}&#39;&nbsp;which&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544809">//&nbsp;division&nbsp;op&nbsp;as&nbsp;in</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544831">//&nbsp;&nbsp;&nbsp;&nbsp;({&nbsp;valueOf:&nbsp;function&nbsp;()&nbsp;{&nbsp;return&nbsp;42&nbsp;}&nbsp;}&nbsp;/&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544882">//&nbsp;which&nbsp;is&nbsp;valid,&nbsp;but,&nbsp;in&nbsp;practice,&nbsp;developers&nbsp;don&#39;t&nbsp;divide&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3544951">//&nbsp;literals,&nbsp;so&nbsp;our&nbsp;heuristic&nbsp;works&nbsp;well&nbsp;for&nbsp;code&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545007">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;()&nbsp;{&nbsp;...&nbsp;}&nbsp;&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;sideEffect();</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545066">//&nbsp;The&nbsp;&#39;)&#39;&nbsp;punctuator&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression&nbsp;as&nbsp;in</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545128">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b)&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545164">//&nbsp;but&nbsp;this&nbsp;is&nbsp;much&nbsp;less&nbsp;likely&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545202">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a&nbsp;+&nbsp;b)&nbsp;/&nbsp;c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545222">case</span>&nbsp;<span class="string" id="3545227">&#39;}&#39;</span><span class="op" id="3545230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545234">return</span>&nbsp;<span class="ident" id="3545241">jsCtxRegexp</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545254">default</span><span class="op" id="3545261">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545265">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;IdentifierName&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;keyword&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545329">//&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545368">j</span>&nbsp;<span class="op" id="3545370">:=</span>&nbsp;<span class="ident" id="3545373">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545377">for</span>&nbsp;<span class="ident" id="3545381">j</span>&nbsp;<span class="op" id="3545383">&gt;</span>&nbsp;<span class="num" id="3545385">0</span>&nbsp;<span class="op" id="3545387">&amp;&amp;</span>&nbsp;<span class="ident" id="3545390">isJSIdentPart</span><span class="op" id="3545403">(</span><span class="builtintype" id="3545404">rune</span><span class="op" id="3545408">(</span><span class="ident" id="3545409">s</span><span class="op" id="3545410">[</span><span class="ident" id="3545411">j</span><span class="op" id="3545412">-</span><span class="num" id="3545413">1</span><span class="op" id="3545414">]</span><span class="op" id="3545415">)</span><span class="op" id="3545416">)</span>&nbsp;<span class="op" id="3545418">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545423">j</span><span class="op" id="3545424">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3545429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545433">if</span>&nbsp;<span class="ident" id="3545436">regexpPrecederKeywords</span><span class="op" id="3545458">[</span><span class="builtintype" id="3545459">string</span><span class="op" id="3545465">(</span><span class="ident" id="3545466">s</span><span class="op" id="3545467">[</span><span class="ident" id="3545468">j</span><span class="op" id="3545469">:</span><span class="op" id="3545470">]</span><span class="op" id="3545471">)</span><span class="op" id="3545472">]</span>&nbsp;<span class="op" id="3545474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545479">return</span>&nbsp;<span class="ident" id="3545486">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3545500">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3545503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545506">//&nbsp;Otherwise&nbsp;is&nbsp;a&nbsp;punctuator&nbsp;not&nbsp;listed&nbsp;above,&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545557">//&nbsp;a&nbsp;string&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op,&nbsp;or&nbsp;an&nbsp;identifier</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545612">//&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545641">return</span>&nbsp;<span class="ident" id="3545648">jsCtxDivOp</span><br>
<span class="lineno">100</span><span class="op" id="3545659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3545662">//&nbsp;regexpPrecederKeywords&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;reserved&nbsp;JS&nbsp;keywords&nbsp;that&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3545740">//&nbsp;regular&nbsp;expression&nbsp;in&nbsp;JS&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="3545776">var</span>&nbsp;<span class="ident" id="3545780">regexpPrecederKeywords</span>&nbsp;<span class="op" id="3545803">=</span>&nbsp;<span class="keyword" id="3545805">map</span><span class="op" id="3545808">[</span><span class="builtintype" id="3545809">string</span><span class="op" id="3545815">]</span><span class="builtintype" id="3545816">bool</span><span class="op" id="3545820">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545823">&#34;break&#34;</span><span class="op" id="3545830">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545837">true</span><span class="op" id="3545841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545844">&#34;case&#34;</span><span class="op" id="3545850">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545858">true</span><span class="op" id="3545862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545865">&#34;continue&#34;</span><span class="op" id="3545875">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545879">true</span><span class="op" id="3545883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545886">&#34;delete&#34;</span><span class="op" id="3545894">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545900">true</span><span class="op" id="3545904">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545907">&#34;do&#34;</span><span class="op" id="3545911">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545921">true</span><span class="op" id="3545925">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545928">&#34;else&#34;</span><span class="op" id="3545934">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545942">true</span><span class="op" id="3545946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545949">&#34;finally&#34;</span><span class="op" id="3545958">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545963">true</span><span class="op" id="3545967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545970">&#34;in&#34;</span><span class="op" id="3545974">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545984">true</span><span class="op" id="3545988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3545991">&#34;instanceof&#34;</span><span class="op" id="3546003">:</span>&nbsp;<span class="builtintype" id="3546005">true</span><span class="op" id="3546009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3546012">&#34;return&#34;</span><span class="op" id="3546020">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546026">true</span><span class="op" id="3546030">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3546033">&#34;throw&#34;</span><span class="op" id="3546040">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546047">true</span><span class="op" id="3546051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3546054">&#34;try&#34;</span><span class="op" id="3546059">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546068">true</span><span class="op" id="3546072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3546075">&#34;typeof&#34;</span><span class="op" id="3546083">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546089">true</span><span class="op" id="3546093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3546096">&#34;void&#34;</span><span class="op" id="3546102">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546110">true</span><span class="op" id="3546114">,</span><br>
<span class="lineno"></span><span class="op" id="3546116">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="3546119">var</span>&nbsp;<span class="ident" id="3546123">jsonMarshalType</span>&nbsp;<span class="op" id="3546139">=</span>&nbsp;<span class="ident" id="3546141">reflect</span><span class="op" id="3546148">.</span><span class="ident" id="3546149">TypeOf</span><span class="op" id="3546155">(</span><span class="op" id="3546156">(</span><span class="op" id="3546157">*</span><span class="ident" id="3546158">json</span><span class="op" id="3546162">.</span><span class="ident" id="3546163">Marshaler</span><span class="op" id="3546172">)</span><span class="op" id="3546173">(</span><span class="ident" id="3546174">nil</span><span class="op" id="3546177">)</span><span class="op" id="3546178">)</span><span class="op" id="3546179">.</span><span class="ident" id="3546180">Elem</span><span class="op" id="3546184">(</span><span class="op" id="3546185">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546188">//&nbsp;indirectToJSONMarshaler&nbsp;returns&nbsp;the&nbsp;value,&nbsp;after&nbsp;dereferencing&nbsp;as&nbsp;many&nbsp;times</span><br>
<span class="lineno"></span><span class="comment" id="3546268">//&nbsp;as&nbsp;necessary&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type&nbsp;(or&nbsp;nil)&nbsp;or&nbsp;an&nbsp;implementation&nbsp;of&nbsp;json.Marshal.</span><br>
<span class="lineno">125</span><span class="keyword" id="3546354">func</span>&nbsp;<span class="ident" id="3546359">indirectToJSONMarshaler</span><span class="op" id="3546382">(</span><span class="ident" id="3546383">a</span>&nbsp;<span class="keyword" id="3546385">interface</span><span class="op" id="3546394">{</span><span class="op" id="3546395">}</span><span class="op" id="3546396">)</span>&nbsp;<span class="keyword" id="3546398">interface</span><span class="op" id="3546407">{</span><span class="op" id="3546408">}</span>&nbsp;<span class="op" id="3546410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546413">v</span>&nbsp;<span class="op" id="3546415">:=</span>&nbsp;<span class="ident" id="3546418">reflect</span><span class="op" id="3546425">.</span><span class="ident" id="3546426">ValueOf</span><span class="op" id="3546433">(</span><span class="ident" id="3546434">a</span><span class="op" id="3546435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546438">for</span>&nbsp;<span class="op" id="3546442">!</span><span class="ident" id="3546443">v</span><span class="op" id="3546444">.</span><span class="ident" id="3546445">Type</span><span class="op" id="3546449">(</span><span class="op" id="3546450">)</span><span class="op" id="3546451">.</span><span class="ident" id="3546452">Implements</span><span class="op" id="3546462">(</span><span class="ident" id="3546463">jsonMarshalType</span><span class="op" id="3546478">)</span>&nbsp;<span class="op" id="3546480">&amp;&amp;</span>&nbsp;<span class="ident" id="3546483">v</span><span class="op" id="3546484">.</span><span class="ident" id="3546485">Kind</span><span class="op" id="3546489">(</span><span class="op" id="3546490">)</span>&nbsp;<span class="op" id="3546492">==</span>&nbsp;<span class="ident" id="3546495">reflect</span><span class="op" id="3546502">.</span><span class="ident" id="3546503">Ptr</span>&nbsp;<span class="op" id="3546507">&amp;&amp;</span>&nbsp;<span class="op" id="3546510">!</span><span class="ident" id="3546511">v</span><span class="op" id="3546512">.</span><span class="ident" id="3546513">IsNil</span><span class="op" id="3546518">(</span><span class="op" id="3546519">)</span>&nbsp;<span class="op" id="3546521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546525">v</span>&nbsp;<span class="op" id="3546527">=</span>&nbsp;<span class="ident" id="3546529">v</span><span class="op" id="3546530">.</span><span class="ident" id="3546531">Elem</span><span class="op" id="3546535">(</span><span class="op" id="3546536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3546539">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546542">return</span>&nbsp;<span class="ident" id="3546549">v</span><span class="op" id="3546550">.</span><span class="ident" id="3546551">Interface</span><span class="op" id="3546560">(</span><span class="op" id="3546561">)</span><br>
<span class="lineno"></span><span class="op" id="3546563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546566">//&nbsp;jsValEscaper&nbsp;escapes&nbsp;its&nbsp;inputs&nbsp;to&nbsp;a&nbsp;JS&nbsp;Expression&nbsp;(section&nbsp;11.14)&nbsp;that&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3546645">//&nbsp;neither&nbsp;side-effects&nbsp;nor&nbsp;free&nbsp;variables&nbsp;outside&nbsp;(NaN,&nbsp;Infinity).</span><br>
<span class="lineno">135</span><span class="keyword" id="3546713">func</span>&nbsp;<span class="ident" id="3546718">jsValEscaper</span><span class="op" id="3546730">(</span><span class="ident" id="3546731">args</span>&nbsp;<span class="op" id="3546736">...</span><span class="keyword" id="3546739">interface</span><span class="op" id="3546748">{</span><span class="op" id="3546749">}</span><span class="op" id="3546750">)</span>&nbsp;<span class="builtintype" id="3546752">string</span>&nbsp;<span class="op" id="3546759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546762">var</span>&nbsp;<span class="ident" id="3546766">a</span>&nbsp;<span class="keyword" id="3546768">interface</span><span class="op" id="3546777">{</span><span class="op" id="3546778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546781">if</span>&nbsp;<span class="builtinfunc" id="3546784">len</span><span class="op" id="3546787">(</span><span class="ident" id="3546788">args</span><span class="op" id="3546792">)</span>&nbsp;<span class="op" id="3546794">==</span>&nbsp;<span class="num" id="3546797">1</span>&nbsp;<span class="op" id="3546799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546803">a</span>&nbsp;<span class="op" id="3546805">=</span>&nbsp;<span class="ident" id="3546807">indirectToJSONMarshaler</span><span class="op" id="3546830">(</span><span class="ident" id="3546831">args</span><span class="op" id="3546835">[</span><span class="num" id="3546836">0</span><span class="op" id="3546837">]</span><span class="op" id="3546838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546842">switch</span>&nbsp;<span class="ident" id="3546849">t</span>&nbsp;<span class="op" id="3546851">:=</span>&nbsp;<span class="ident" id="3546854">a</span><span class="op" id="3546855">.</span><span class="op" id="3546856">(</span><span class="keyword" id="3546857">type</span><span class="op" id="3546861">)</span>&nbsp;<span class="op" id="3546863">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546867">case</span>&nbsp;<span class="ident" id="3546872">JS</span><span class="op" id="3546874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546879">return</span>&nbsp;<span class="builtintype" id="3546886">string</span><span class="op" id="3546892">(</span><span class="ident" id="3546893">t</span><span class="op" id="3546894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546898">case</span>&nbsp;<span class="ident" id="3546903">JSStr</span><span class="op" id="3546908">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546913">//&nbsp;TODO:&nbsp;normalize&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546943">return</span>&nbsp;<span class="string" id="3546950">`&#34;`</span>&nbsp;<span class="op" id="3546954">+</span>&nbsp;<span class="builtintype" id="3546956">string</span><span class="op" id="3546962">(</span><span class="ident" id="3546963">t</span><span class="op" id="3546964">)</span>&nbsp;<span class="op" id="3546966">+</span>&nbsp;<span class="string" id="3546968">`&#34;`</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546974">case</span>&nbsp;<span class="ident" id="3546979">json</span><span class="op" id="3546983">.</span><span class="ident" id="3546984">Marshaler</span><span class="op" id="3546993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546998">//&nbsp;Do&nbsp;not&nbsp;treat&nbsp;as&nbsp;a&nbsp;Stringer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547031">case</span>&nbsp;<span class="ident" id="3547036">fmt</span><span class="op" id="3547039">.</span><span class="ident" id="3547040">Stringer</span><span class="op" id="3547048">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547053">a</span>&nbsp;<span class="op" id="3547055">=</span>&nbsp;<span class="ident" id="3547057">t</span><span class="op" id="3547058">.</span><span class="ident" id="3547059">String</span><span class="op" id="3547065">(</span><span class="op" id="3547066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547070">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547073">}</span>&nbsp;<span class="keyword" id="3547075">else</span>&nbsp;<span class="op" id="3547080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547084">for</span>&nbsp;<span class="ident" id="3547088">i</span><span class="op" id="3547089">,</span>&nbsp;<span class="ident" id="3547091">arg</span>&nbsp;<span class="op" id="3547095">:=</span>&nbsp;<span class="keyword" id="3547098">range</span>&nbsp;<span class="ident" id="3547104">args</span>&nbsp;<span class="op" id="3547109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547114">args</span><span class="op" id="3547118">[</span><span class="ident" id="3547119">i</span><span class="op" id="3547120">]</span>&nbsp;<span class="op" id="3547122">=</span>&nbsp;<span class="ident" id="3547124">indirectToJSONMarshaler</span><span class="op" id="3547147">(</span><span class="ident" id="3547148">arg</span><span class="op" id="3547151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547159">a</span>&nbsp;<span class="op" id="3547161">=</span>&nbsp;<span class="ident" id="3547163">fmt</span><span class="op" id="3547166">.</span><span class="ident" id="3547167">Sprint</span><span class="op" id="3547173">(</span><span class="ident" id="3547174">args</span><span class="op" id="3547178">...</span><span class="op" id="3547181">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547187">//&nbsp;TODO:&nbsp;detect&nbsp;cycles&nbsp;before&nbsp;calling&nbsp;Marshal&nbsp;which&nbsp;loops&nbsp;infinitely&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547260">//&nbsp;cyclic&nbsp;data.&nbsp;This&nbsp;may&nbsp;be&nbsp;an&nbsp;unacceptable&nbsp;DoS&nbsp;risk.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547316">b</span><span class="op" id="3547317">,</span>&nbsp;<span class="ident" id="3547319">err</span>&nbsp;<span class="op" id="3547323">:=</span>&nbsp;<span class="ident" id="3547326">json</span><span class="op" id="3547330">.</span><span class="ident" id="3547331">Marshal</span><span class="op" id="3547338">(</span><span class="ident" id="3547339">a</span><span class="op" id="3547340">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547343">if</span>&nbsp;<span class="ident" id="3547346">err</span>&nbsp;<span class="op" id="3547350">!=</span>&nbsp;<span class="ident" id="3547353">nil</span>&nbsp;<span class="op" id="3547357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547361">//&nbsp;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;comment&nbsp;so&nbsp;that&nbsp;if&nbsp;it&nbsp;is&nbsp;flush&nbsp;against</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547424">//&nbsp;a&nbsp;division&nbsp;operator&nbsp;it&nbsp;is&nbsp;not&nbsp;turned&nbsp;into&nbsp;a&nbsp;line&nbsp;comment:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547487">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x/{{y}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547504">//&nbsp;turning&nbsp;into</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547522">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x//*&nbsp;error&nbsp;marshalling&nbsp;y:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547557">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;line&nbsp;of&nbsp;error&nbsp;message&nbsp;*/null</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547607">return</span>&nbsp;<span class="ident" id="3547614">fmt</span><span class="op" id="3547617">.</span><span class="ident" id="3547618">Sprintf</span><span class="op" id="3547625">(</span><span class="string" id="3547626">&#34;&nbsp;/*&nbsp;%s&nbsp;*/null&nbsp;&#34;</span><span class="op" id="3547642">,</span>&nbsp;<span class="ident" id="3547644">strings</span><span class="op" id="3547651">.</span><span class="ident" id="3547652">Replace</span><span class="op" id="3547659">(</span><span class="ident" id="3547660">err</span><span class="op" id="3547663">.</span><span class="ident" id="3547664">Error</span><span class="op" id="3547669">(</span><span class="op" id="3547670">)</span><span class="op" id="3547671">,</span>&nbsp;<span class="string" id="3547673">&#34;*/&#34;</span><span class="op" id="3547677">,</span>&nbsp;<span class="string" id="3547679">&#34;*&nbsp;/&#34;</span><span class="op" id="3547684">,</span>&nbsp;<span class="op" id="3547686">-</span><span class="num" id="3547687">1</span><span class="op" id="3547688">)</span><span class="op" id="3547689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547696">//&nbsp;TODO:&nbsp;maybe&nbsp;post-process&nbsp;output&nbsp;to&nbsp;prevent&nbsp;it&nbsp;from&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547762">//&nbsp;&#34;&lt;!--&#34;,&nbsp;&#34;--&gt;&#34;,&nbsp;&#34;&lt;![CDATA[&#34;,&nbsp;&#34;]]&gt;&#34;,&nbsp;or&nbsp;&#34;&lt;/script&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547815">//&nbsp;in&nbsp;case&nbsp;custom&nbsp;marshallers&nbsp;produce&nbsp;output&nbsp;containing&nbsp;those.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547880">//&nbsp;TODO:&nbsp;Maybe&nbsp;abbreviate&nbsp;\u00ab&nbsp;to&nbsp;\xab&nbsp;to&nbsp;produce&nbsp;more&nbsp;compact&nbsp;output.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547954">if</span>&nbsp;<span class="builtinfunc" id="3547957">len</span><span class="op" id="3547960">(</span><span class="ident" id="3547961">b</span><span class="op" id="3547962">)</span>&nbsp;<span class="op" id="3547964">==</span>&nbsp;<span class="num" id="3547967">0</span>&nbsp;<span class="op" id="3547969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547973">//&nbsp;In,&nbsp;`x=y/{{.}}*z`&nbsp;a&nbsp;json.Marshaler&nbsp;that&nbsp;produces&nbsp;&#34;&#34;&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548037">//&nbsp;not&nbsp;cause&nbsp;the&nbsp;output&nbsp;`x=y/*z`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548073">return</span>&nbsp;<span class="string" id="3548080">&#34;&nbsp;null&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548090">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548093">first</span><span class="op" id="3548098">,</span>&nbsp;<span class="ident" id="3548100">_</span>&nbsp;<span class="op" id="3548102">:=</span>&nbsp;<span class="ident" id="3548105">utf8</span><span class="op" id="3548109">.</span><span class="ident" id="3548110">DecodeRune</span><span class="op" id="3548120">(</span><span class="ident" id="3548121">b</span><span class="op" id="3548122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548125">last</span><span class="op" id="3548129">,</span>&nbsp;<span class="ident" id="3548131">_</span>&nbsp;<span class="op" id="3548133">:=</span>&nbsp;<span class="ident" id="3548136">utf8</span><span class="op" id="3548140">.</span><span class="ident" id="3548141">DecodeLastRune</span><span class="op" id="3548155">(</span><span class="ident" id="3548156">b</span><span class="op" id="3548157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548160">var</span>&nbsp;<span class="ident" id="3548164">buf</span>&nbsp;<span class="ident" id="3548168">bytes</span><span class="op" id="3548173">.</span><span class="ident" id="3548174">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548182">//&nbsp;Prevent&nbsp;IdentifierNames&nbsp;and&nbsp;NumericLiterals&nbsp;from&nbsp;running&nbsp;into</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548248">//&nbsp;keywords:&nbsp;in,&nbsp;instanceof,&nbsp;typeof,&nbsp;void</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548291">pad</span>&nbsp;<span class="op" id="3548295">:=</span>&nbsp;<span class="ident" id="3548298">isJSIdentPart</span><span class="op" id="3548311">(</span><span class="ident" id="3548312">first</span><span class="op" id="3548317">)</span>&nbsp;<span class="op" id="3548319">||</span>&nbsp;<span class="ident" id="3548322">isJSIdentPart</span><span class="op" id="3548335">(</span><span class="ident" id="3548336">last</span><span class="op" id="3548340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548343">if</span>&nbsp;<span class="ident" id="3548346">pad</span>&nbsp;<span class="op" id="3548350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548354">buf</span><span class="op" id="3548357">.</span><span class="ident" id="3548358">WriteByte</span><span class="op" id="3548367">(</span><span class="string" id="3548368">&#39;&nbsp;&#39;</span><span class="op" id="3548371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548377">written</span>&nbsp;<span class="op" id="3548385">:=</span>&nbsp;<span class="num" id="3548388">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548391">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;json.Marshal&nbsp;escapes&nbsp;codepoints&nbsp;U+2028&nbsp;&amp;&nbsp;U+2029</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548458">//&nbsp;so&nbsp;it&nbsp;falls&nbsp;within&nbsp;the&nbsp;subset&nbsp;of&nbsp;JSON&nbsp;which&nbsp;is&nbsp;valid&nbsp;JS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548519">for</span>&nbsp;<span class="ident" id="3548523">i</span>&nbsp;<span class="op" id="3548525">:=</span>&nbsp;<span class="num" id="3548528">0</span><span class="op" id="3548529">;</span>&nbsp;<span class="ident" id="3548531">i</span>&nbsp;<span class="op" id="3548533">&lt;</span>&nbsp;<span class="builtinfunc" id="3548535">len</span><span class="op" id="3548538">(</span><span class="ident" id="3548539">b</span><span class="op" id="3548540">)</span><span class="op" id="3548541">;</span>&nbsp;<span class="op" id="3548543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3548547">rune</span><span class="op" id="3548551">,</span>&nbsp;<span class="ident" id="3548553">n</span>&nbsp;<span class="op" id="3548555">:=</span>&nbsp;<span class="ident" id="3548558">utf8</span><span class="op" id="3548562">.</span><span class="ident" id="3548563">DecodeRune</span><span class="op" id="3548573">(</span><span class="ident" id="3548574">b</span><span class="op" id="3548575">[</span><span class="ident" id="3548576">i</span><span class="op" id="3548577">:</span><span class="op" id="3548578">]</span><span class="op" id="3548579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548583">repl</span>&nbsp;<span class="op" id="3548588">:=</span>&nbsp;<span class="string" id="3548591">&#34;&#34;</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548596">if</span>&nbsp;<span class="builtintype" id="3548599">rune</span>&nbsp;<span class="op" id="3548604">==</span>&nbsp;<span class="num" id="3548607">0x2028</span>&nbsp;<span class="op" id="3548614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548619">repl</span>&nbsp;<span class="op" id="3548624">=</span>&nbsp;<span class="string" id="3548626">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548637">}</span>&nbsp;<span class="keyword" id="3548639">else</span>&nbsp;<span class="keyword" id="3548644">if</span>&nbsp;<span class="builtintype" id="3548647">rune</span>&nbsp;<span class="op" id="3548652">==</span>&nbsp;<span class="num" id="3548655">0x2029</span>&nbsp;<span class="op" id="3548662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548667">repl</span>&nbsp;<span class="op" id="3548672">=</span>&nbsp;<span class="string" id="3548674">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548685">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548689">if</span>&nbsp;<span class="ident" id="3548692">repl</span>&nbsp;<span class="op" id="3548697">!=</span>&nbsp;<span class="string" id="3548700">&#34;&#34;</span>&nbsp;<span class="op" id="3548703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548708">buf</span><span class="op" id="3548711">.</span><span class="ident" id="3548712">Write</span><span class="op" id="3548717">(</span><span class="ident" id="3548718">b</span><span class="op" id="3548719">[</span><span class="ident" id="3548720">written</span><span class="op" id="3548727">:</span><span class="ident" id="3548728">i</span><span class="op" id="3548729">]</span><span class="op" id="3548730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548735">buf</span><span class="op" id="3548738">.</span><span class="ident" id="3548739">WriteString</span><span class="op" id="3548750">(</span><span class="ident" id="3548751">repl</span><span class="op" id="3548755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548760">written</span>&nbsp;<span class="op" id="3548768">=</span>&nbsp;<span class="ident" id="3548770">i</span>&nbsp;<span class="op" id="3548772">+</span>&nbsp;<span class="ident" id="3548774">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548778">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548782">i</span>&nbsp;<span class="op" id="3548784">+=</span>&nbsp;<span class="ident" id="3548787">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548793">if</span>&nbsp;<span class="ident" id="3548796">buf</span><span class="op" id="3548799">.</span><span class="ident" id="3548800">Len</span><span class="op" id="3548803">(</span><span class="op" id="3548804">)</span>&nbsp;<span class="op" id="3548806">!=</span>&nbsp;<span class="num" id="3548809">0</span>&nbsp;<span class="op" id="3548811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548815">buf</span><span class="op" id="3548818">.</span><span class="ident" id="3548819">Write</span><span class="op" id="3548824">(</span><span class="ident" id="3548825">b</span><span class="op" id="3548826">[</span><span class="ident" id="3548827">written</span><span class="op" id="3548834">:</span><span class="op" id="3548835">]</span><span class="op" id="3548836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548840">if</span>&nbsp;<span class="ident" id="3548843">pad</span>&nbsp;<span class="op" id="3548847">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548852">buf</span><span class="op" id="3548855">.</span><span class="ident" id="3548856">WriteByte</span><span class="op" id="3548865">(</span><span class="string" id="3548866">&#39;&nbsp;&#39;</span><span class="op" id="3548869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548877">b</span>&nbsp;<span class="op" id="3548879">=</span>&nbsp;<span class="ident" id="3548881">buf</span><span class="op" id="3548884">.</span><span class="ident" id="3548885">Bytes</span><span class="op" id="3548890">(</span><span class="op" id="3548891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548897">return</span>&nbsp;<span class="builtintype" id="3548904">string</span><span class="op" id="3548910">(</span><span class="ident" id="3548911">b</span><span class="op" id="3548912">)</span><br>
<span class="lineno">215</span><span class="op" id="3548914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3548917">//&nbsp;jsStrEscaper&nbsp;produces&nbsp;a&nbsp;string&nbsp;that&nbsp;can&nbsp;be&nbsp;included&nbsp;between&nbsp;quotes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3548990">//&nbsp;JavaScript&nbsp;source,&nbsp;in&nbsp;JavaScript&nbsp;embedded&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;&lt;script&gt;&nbsp;element,</span><br>
<span class="lineno"></span><span class="comment" id="3549065">//&nbsp;or&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;event&nbsp;handler&nbsp;attribute&nbsp;such&nbsp;as&nbsp;onclick.</span><br>
<span class="lineno">220</span><span class="keyword" id="3549124">func</span>&nbsp;<span class="ident" id="3549129">jsStrEscaper</span><span class="op" id="3549141">(</span><span class="ident" id="3549142">args</span>&nbsp;<span class="op" id="3549147">...</span><span class="keyword" id="3549150">interface</span><span class="op" id="3549159">{</span><span class="op" id="3549160">}</span><span class="op" id="3549161">)</span>&nbsp;<span class="builtintype" id="3549163">string</span>&nbsp;<span class="op" id="3549170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549173">s</span><span class="op" id="3549174">,</span>&nbsp;<span class="ident" id="3549176">t</span>&nbsp;<span class="op" id="3549178">:=</span>&nbsp;<span class="ident" id="3549181">stringify</span><span class="op" id="3549190">(</span><span class="ident" id="3549191">args</span><span class="op" id="3549195">...</span><span class="op" id="3549198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549201">if</span>&nbsp;<span class="ident" id="3549204">t</span>&nbsp;<span class="op" id="3549206">==</span>&nbsp;<span class="ident" id="3549209">contentTypeJSStr</span>&nbsp;<span class="op" id="3549226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549230">return</span>&nbsp;<span class="ident" id="3549237">replace</span><span class="op" id="3549244">(</span><span class="ident" id="3549245">s</span><span class="op" id="3549246">,</span>&nbsp;<span class="ident" id="3549248">jsStrNormReplacementTable</span><span class="op" id="3549273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549276">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549279">return</span>&nbsp;<span class="ident" id="3549286">replace</span><span class="op" id="3549293">(</span><span class="ident" id="3549294">s</span><span class="op" id="3549295">,</span>&nbsp;<span class="ident" id="3549297">jsStrReplacementTable</span><span class="op" id="3549318">)</span><br>
<span class="lineno"></span><span class="op" id="3549320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3549323">//&nbsp;jsRegexpEscaper&nbsp;behaves&nbsp;like&nbsp;jsStrEscaper&nbsp;but&nbsp;escapes&nbsp;regular&nbsp;expression</span><br>
<span class="lineno"></span><span class="comment" id="3549399">//&nbsp;specials&nbsp;so&nbsp;the&nbsp;result&nbsp;is&nbsp;treated&nbsp;literally&nbsp;when&nbsp;included&nbsp;in&nbsp;a&nbsp;regular</span><br>
<span class="lineno">230</span><span class="comment" id="3549473">//&nbsp;expression&nbsp;literal.&nbsp;/foo{{.X}}bar/&nbsp;matches&nbsp;the&nbsp;string&nbsp;&#34;foo&#34;&nbsp;followed&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3549548">//&nbsp;the&nbsp;literal&nbsp;text&nbsp;of&nbsp;{{.X}}&nbsp;followed&nbsp;by&nbsp;the&nbsp;string&nbsp;&#34;bar&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3549608">func</span>&nbsp;<span class="ident" id="3549613">jsRegexpEscaper</span><span class="op" id="3549628">(</span><span class="ident" id="3549629">args</span>&nbsp;<span class="op" id="3549634">...</span><span class="keyword" id="3549637">interface</span><span class="op" id="3549646">{</span><span class="op" id="3549647">}</span><span class="op" id="3549648">)</span>&nbsp;<span class="builtintype" id="3549650">string</span>&nbsp;<span class="op" id="3549657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549660">s</span><span class="op" id="3549661">,</span>&nbsp;<span class="ident" id="3549663">_</span>&nbsp;<span class="op" id="3549665">:=</span>&nbsp;<span class="ident" id="3549668">stringify</span><span class="op" id="3549677">(</span><span class="ident" id="3549678">args</span><span class="op" id="3549682">...</span><span class="op" id="3549685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549688">s</span>&nbsp;<span class="op" id="3549690">=</span>&nbsp;<span class="ident" id="3549692">replace</span><span class="op" id="3549699">(</span><span class="ident" id="3549700">s</span><span class="op" id="3549701">,</span>&nbsp;<span class="ident" id="3549703">jsRegexpReplacementTable</span><span class="op" id="3549727">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549730">if</span>&nbsp;<span class="ident" id="3549733">s</span>&nbsp;<span class="op" id="3549735">==</span>&nbsp;<span class="string" id="3549738">&#34;&#34;</span>&nbsp;<span class="op" id="3549741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3549745">//&nbsp;/{{.X}}/&nbsp;should&nbsp;not&nbsp;produce&nbsp;a&nbsp;line&nbsp;comment&nbsp;when&nbsp;.X&nbsp;==&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549808">return</span>&nbsp;<span class="string" id="3549815">&#34;(?:)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549826">return</span>&nbsp;<span class="ident" id="3549833">s</span><br>
<span class="lineno">240</span><span class="op" id="3549835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3549838">//&nbsp;replace&nbsp;replaces&nbsp;each&nbsp;rune&nbsp;r&nbsp;of&nbsp;s&nbsp;with&nbsp;replacementTable[r],&nbsp;provided&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3549915">//&nbsp;r&nbsp;&lt;&nbsp;len(replacementTable).&nbsp;If&nbsp;replacementTable[r]&nbsp;is&nbsp;the&nbsp;empty&nbsp;string&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3549993">//&nbsp;no&nbsp;replacement&nbsp;is&nbsp;made.</span><br>
<span class="lineno">245</span><span class="comment" id="3550020">//&nbsp;It&nbsp;also&nbsp;replaces&nbsp;runes&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;with&nbsp;the&nbsp;raw&nbsp;strings&nbsp;`\u2028`&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3550098">//&nbsp;`\u2029`.</span><br>
<span class="lineno"></span><span class="keyword" id="3550111">func</span>&nbsp;<span class="ident" id="3550116">replace</span><span class="op" id="3550123">(</span><span class="ident" id="3550124">s</span>&nbsp;<span class="builtintype" id="3550126">string</span><span class="op" id="3550132">,</span>&nbsp;<span class="ident" id="3550134">replacementTable</span>&nbsp;<span class="op" id="3550151">[</span><span class="op" id="3550152">]</span><span class="builtintype" id="3550153">string</span><span class="op" id="3550159">)</span>&nbsp;<span class="builtintype" id="3550161">string</span>&nbsp;<span class="op" id="3550168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550171">var</span>&nbsp;<span class="ident" id="3550175">b</span>&nbsp;<span class="ident" id="3550177">bytes</span><span class="op" id="3550182">.</span><span class="ident" id="3550183">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550191">written</span>&nbsp;<span class="op" id="3550199">:=</span>&nbsp;<span class="num" id="3550202">0</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550205">for</span>&nbsp;<span class="ident" id="3550209">i</span><span class="op" id="3550210">,</span>&nbsp;<span class="ident" id="3550212">r</span>&nbsp;<span class="op" id="3550214">:=</span>&nbsp;<span class="keyword" id="3550217">range</span>&nbsp;<span class="ident" id="3550223">s</span>&nbsp;<span class="op" id="3550225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550229">var</span>&nbsp;<span class="ident" id="3550233">repl</span>&nbsp;<span class="builtintype" id="3550238">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550247">switch</span>&nbsp;<span class="op" id="3550254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550258">case</span>&nbsp;<span class="builtintype" id="3550263">int</span><span class="op" id="3550266">(</span><span class="ident" id="3550267">r</span><span class="op" id="3550268">)</span>&nbsp;<span class="op" id="3550270">&lt;</span>&nbsp;<span class="builtinfunc" id="3550272">len</span><span class="op" id="3550275">(</span><span class="ident" id="3550276">replacementTable</span><span class="op" id="3550292">)</span>&nbsp;<span class="op" id="3550294">&amp;&amp;</span>&nbsp;<span class="ident" id="3550297">replacementTable</span><span class="op" id="3550313">[</span><span class="ident" id="3550314">r</span><span class="op" id="3550315">]</span>&nbsp;<span class="op" id="3550317">!=</span>&nbsp;<span class="string" id="3550320">&#34;&#34;</span><span class="op" id="3550322">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550327">repl</span>&nbsp;<span class="op" id="3550332">=</span>&nbsp;<span class="ident" id="3550334">replacementTable</span><span class="op" id="3550350">[</span><span class="ident" id="3550351">r</span><span class="op" id="3550352">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550356">case</span>&nbsp;<span class="ident" id="3550361">r</span>&nbsp;<span class="op" id="3550363">==</span>&nbsp;<span class="string" id="3550366">&#39;\u2028&#39;</span><span class="op" id="3550374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550379">repl</span>&nbsp;<span class="op" id="3550384">=</span>&nbsp;<span class="string" id="3550386">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550397">case</span>&nbsp;<span class="ident" id="3550402">r</span>&nbsp;<span class="op" id="3550404">==</span>&nbsp;<span class="string" id="3550407">&#39;\u2029&#39;</span><span class="op" id="3550415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550420">repl</span>&nbsp;<span class="op" id="3550425">=</span>&nbsp;<span class="string" id="3550427">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550438">default</span><span class="op" id="3550445">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550450">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550465">b</span><span class="op" id="3550466">.</span><span class="ident" id="3550467">WriteString</span><span class="op" id="3550478">(</span><span class="ident" id="3550479">s</span><span class="op" id="3550480">[</span><span class="ident" id="3550481">written</span><span class="op" id="3550488">:</span><span class="ident" id="3550489">i</span><span class="op" id="3550490">]</span><span class="op" id="3550491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550495">b</span><span class="op" id="3550496">.</span><span class="ident" id="3550497">WriteString</span><span class="op" id="3550508">(</span><span class="ident" id="3550509">repl</span><span class="op" id="3550513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550517">written</span>&nbsp;<span class="op" id="3550525">=</span>&nbsp;<span class="ident" id="3550527">i</span>&nbsp;<span class="op" id="3550529">+</span>&nbsp;<span class="ident" id="3550531">utf8</span><span class="op" id="3550535">.</span><span class="ident" id="3550536">RuneLen</span><span class="op" id="3550543">(</span><span class="ident" id="3550544">r</span><span class="op" id="3550545">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550551">if</span>&nbsp;<span class="ident" id="3550554">written</span>&nbsp;<span class="op" id="3550562">==</span>&nbsp;<span class="num" id="3550565">0</span>&nbsp;<span class="op" id="3550567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550571">return</span>&nbsp;<span class="ident" id="3550578">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550584">b</span><span class="op" id="3550585">.</span><span class="ident" id="3550586">WriteString</span><span class="op" id="3550597">(</span><span class="ident" id="3550598">s</span><span class="op" id="3550599">[</span><span class="ident" id="3550600">written</span><span class="op" id="3550607">:</span><span class="op" id="3550608">]</span><span class="op" id="3550609">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550612">return</span>&nbsp;<span class="ident" id="3550619">b</span><span class="op" id="3550620">.</span><span class="ident" id="3550621">String</span><span class="op" id="3550627">(</span><span class="op" id="3550628">)</span><br>
<span class="lineno"></span><span class="op" id="3550630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3550633">var</span>&nbsp;<span class="ident" id="3550637">jsStrReplacementTable</span>&nbsp;<span class="op" id="3550659">=</span>&nbsp;<span class="op" id="3550661">[</span><span class="op" id="3550662">]</span><span class="builtintype" id="3550663">string</span><span class="op" id="3550669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3550672">0</span><span class="op" id="3550673">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3550678">`\0`</span><span class="op" id="3550682">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550685">&#39;\t&#39;</span><span class="op" id="3550689">:</span>&nbsp;<span class="string" id="3550691">`\t`</span><span class="op" id="3550695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550698">&#39;\n&#39;</span><span class="op" id="3550702">:</span>&nbsp;<span class="string" id="3550704">`\n`</span><span class="op" id="3550708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550711">&#39;\v&#39;</span><span class="op" id="3550715">:</span>&nbsp;<span class="string" id="3550717">`\x0b`</span><span class="op" id="3550723">,</span>&nbsp;<span class="comment" id="3550725">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550750">&#39;\f&#39;</span><span class="op" id="3550754">:</span>&nbsp;<span class="string" id="3550756">`\f`</span><span class="op" id="3550760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550763">&#39;\r&#39;</span><span class="op" id="3550767">:</span>&nbsp;<span class="string" id="3550769">`\r`</span><span class="op" id="3550773">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550776">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550838">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550887">&#39;&#34;&#39;</span><span class="op" id="3550890">:</span>&nbsp;&nbsp;<span class="string" id="3550893">`\x22`</span><span class="op" id="3550899">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550902">&#39;&amp;&#39;</span><span class="op" id="3550905">:</span>&nbsp;&nbsp;<span class="string" id="3550908">`\x26`</span><span class="op" id="3550914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550917">&#39;\&#39;&#39;</span><span class="op" id="3550921">:</span>&nbsp;<span class="string" id="3550923">`\x27`</span><span class="op" id="3550929">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550932">&#39;+&#39;</span><span class="op" id="3550935">:</span>&nbsp;&nbsp;<span class="string" id="3550938">`\x2b`</span><span class="op" id="3550944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550947">&#39;/&#39;</span><span class="op" id="3550950">:</span>&nbsp;&nbsp;<span class="string" id="3550953">`\/`</span><span class="op" id="3550957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550960">&#39;&lt;&#39;</span><span class="op" id="3550963">:</span>&nbsp;&nbsp;<span class="string" id="3550966">`\x3c`</span><span class="op" id="3550972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550975">&#39;&gt;&#39;</span><span class="op" id="3550978">:</span>&nbsp;&nbsp;<span class="string" id="3550981">`\x3e`</span><span class="op" id="3550987">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3550990">&#39;\\&#39;</span><span class="op" id="3550994">:</span>&nbsp;<span class="string" id="3550996">`\\`</span><span class="op" id="3551000">,</span><br>
<span class="lineno">290</span><span class="op" id="3551002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3551005">//&nbsp;jsStrNormReplacementTable&nbsp;is&nbsp;like&nbsp;jsStrReplacementTable&nbsp;but&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3551077">//&nbsp;overencode&nbsp;existing&nbsp;escapes&nbsp;since&nbsp;this&nbsp;table&nbsp;has&nbsp;no&nbsp;entry&nbsp;for&nbsp;`\`.</span><br>
<span class="lineno"></span><span class="keyword" id="3551147">var</span>&nbsp;<span class="ident" id="3551151">jsStrNormReplacementTable</span>&nbsp;<span class="op" id="3551177">=</span>&nbsp;<span class="op" id="3551179">[</span><span class="op" id="3551180">]</span><span class="builtintype" id="3551181">string</span><span class="op" id="3551187">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3551190">0</span><span class="op" id="3551191">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3551196">`\0`</span><span class="op" id="3551200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551203">&#39;\t&#39;</span><span class="op" id="3551207">:</span>&nbsp;<span class="string" id="3551209">`\t`</span><span class="op" id="3551213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551216">&#39;\n&#39;</span><span class="op" id="3551220">:</span>&nbsp;<span class="string" id="3551222">`\n`</span><span class="op" id="3551226">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551229">&#39;\v&#39;</span><span class="op" id="3551233">:</span>&nbsp;<span class="string" id="3551235">`\x0b`</span><span class="op" id="3551241">,</span>&nbsp;<span class="comment" id="3551243">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551268">&#39;\f&#39;</span><span class="op" id="3551272">:</span>&nbsp;<span class="string" id="3551274">`\f`</span><span class="op" id="3551278">,</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551281">&#39;\r&#39;</span><span class="op" id="3551285">:</span>&nbsp;<span class="string" id="3551287">`\r`</span><span class="op" id="3551291">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551294">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551356">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551405">&#39;&#34;&#39;</span><span class="op" id="3551408">:</span>&nbsp;&nbsp;<span class="string" id="3551411">`\x22`</span><span class="op" id="3551417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551420">&#39;&amp;&#39;</span><span class="op" id="3551423">:</span>&nbsp;&nbsp;<span class="string" id="3551426">`\x26`</span><span class="op" id="3551432">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551435">&#39;\&#39;&#39;</span><span class="op" id="3551439">:</span>&nbsp;<span class="string" id="3551441">`\x27`</span><span class="op" id="3551447">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551450">&#39;+&#39;</span><span class="op" id="3551453">:</span>&nbsp;&nbsp;<span class="string" id="3551456">`\x2b`</span><span class="op" id="3551462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551465">&#39;/&#39;</span><span class="op" id="3551468">:</span>&nbsp;&nbsp;<span class="string" id="3551471">`\/`</span><span class="op" id="3551475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551478">&#39;&lt;&#39;</span><span class="op" id="3551481">:</span>&nbsp;&nbsp;<span class="string" id="3551484">`\x3c`</span><span class="op" id="3551490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551493">&#39;&gt;&#39;</span><span class="op" id="3551496">:</span>&nbsp;&nbsp;<span class="string" id="3551499">`\x3e`</span><span class="op" id="3551505">,</span><br>
<span class="lineno">310</span><span class="op" id="3551507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3551510">var</span>&nbsp;<span class="ident" id="3551514">jsRegexpReplacementTable</span>&nbsp;<span class="op" id="3551539">=</span>&nbsp;<span class="op" id="3551541">[</span><span class="op" id="3551542">]</span><span class="builtintype" id="3551543">string</span><span class="op" id="3551549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3551552">0</span><span class="op" id="3551553">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3551558">`\0`</span><span class="op" id="3551562">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551565">&#39;\t&#39;</span><span class="op" id="3551569">:</span>&nbsp;<span class="string" id="3551571">`\t`</span><span class="op" id="3551575">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551578">&#39;\n&#39;</span><span class="op" id="3551582">:</span>&nbsp;<span class="string" id="3551584">`\n`</span><span class="op" id="3551588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551591">&#39;\v&#39;</span><span class="op" id="3551595">:</span>&nbsp;<span class="string" id="3551597">`\x0b`</span><span class="op" id="3551603">,</span>&nbsp;<span class="comment" id="3551605">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551630">&#39;\f&#39;</span><span class="op" id="3551634">:</span>&nbsp;<span class="string" id="3551636">`\f`</span><span class="op" id="3551640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551643">&#39;\r&#39;</span><span class="op" id="3551647">:</span>&nbsp;<span class="string" id="3551649">`\r`</span><span class="op" id="3551653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551656">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551718">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551767">&#39;&#34;&#39;</span><span class="op" id="3551770">:</span>&nbsp;&nbsp;<span class="string" id="3551773">`\x22`</span><span class="op" id="3551779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551782">&#39;$&#39;</span><span class="op" id="3551785">:</span>&nbsp;&nbsp;<span class="string" id="3551788">`\$`</span><span class="op" id="3551792">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551795">&#39;&amp;&#39;</span><span class="op" id="3551798">:</span>&nbsp;&nbsp;<span class="string" id="3551801">`\x26`</span><span class="op" id="3551807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551810">&#39;\&#39;&#39;</span><span class="op" id="3551814">:</span>&nbsp;<span class="string" id="3551816">`\x27`</span><span class="op" id="3551822">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551825">&#39;(&#39;</span><span class="op" id="3551828">:</span>&nbsp;&nbsp;<span class="string" id="3551831">`\(`</span><span class="op" id="3551835">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551838">&#39;)&#39;</span><span class="op" id="3551841">:</span>&nbsp;&nbsp;<span class="string" id="3551844">`\)`</span><span class="op" id="3551848">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551851">&#39;*&#39;</span><span class="op" id="3551854">:</span>&nbsp;&nbsp;<span class="string" id="3551857">`\*`</span><span class="op" id="3551861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551864">&#39;+&#39;</span><span class="op" id="3551867">:</span>&nbsp;&nbsp;<span class="string" id="3551870">`\x2b`</span><span class="op" id="3551876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551879">&#39;-&#39;</span><span class="op" id="3551882">:</span>&nbsp;&nbsp;<span class="string" id="3551885">`\-`</span><span class="op" id="3551889">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551892">&#39;.&#39;</span><span class="op" id="3551895">:</span>&nbsp;&nbsp;<span class="string" id="3551898">`\.`</span><span class="op" id="3551902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551905">&#39;/&#39;</span><span class="op" id="3551908">:</span>&nbsp;&nbsp;<span class="string" id="3551911">`\/`</span><span class="op" id="3551915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551918">&#39;&lt;&#39;</span><span class="op" id="3551921">:</span>&nbsp;&nbsp;<span class="string" id="3551924">`\x3c`</span><span class="op" id="3551930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551933">&#39;&gt;&#39;</span><span class="op" id="3551936">:</span>&nbsp;&nbsp;<span class="string" id="3551939">`\x3e`</span><span class="op" id="3551945">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551948">&#39;?&#39;</span><span class="op" id="3551951">:</span>&nbsp;&nbsp;<span class="string" id="3551954">`\?`</span><span class="op" id="3551958">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551961">&#39;[&#39;</span><span class="op" id="3551964">:</span>&nbsp;&nbsp;<span class="string" id="3551967">`\[`</span><span class="op" id="3551971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551974">&#39;\\&#39;</span><span class="op" id="3551978">:</span>&nbsp;<span class="string" id="3551980">`\\`</span><span class="op" id="3551984">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3551987">&#39;]&#39;</span><span class="op" id="3551990">:</span>&nbsp;&nbsp;<span class="string" id="3551993">`\]`</span><span class="op" id="3551997">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3552000">&#39;^&#39;</span><span class="op" id="3552003">:</span>&nbsp;&nbsp;<span class="string" id="3552006">`\^`</span><span class="op" id="3552010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3552013">&#39;{&#39;</span><span class="op" id="3552016">:</span>&nbsp;&nbsp;<span class="string" id="3552019">`\{`</span><span class="op" id="3552023">,</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3552026">&#39;|&#39;</span><span class="op" id="3552029">:</span>&nbsp;&nbsp;<span class="string" id="3552032">`\|`</span><span class="op" id="3552036">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3552039">&#39;}&#39;</span><span class="op" id="3552042">:</span>&nbsp;&nbsp;<span class="string" id="3552045">`\}`</span><span class="op" id="3552049">,</span><br>
<span class="lineno"></span><span class="op" id="3552051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3552054">//&nbsp;isJSIdentPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;given&nbsp;rune&nbsp;is&nbsp;a&nbsp;JS&nbsp;identifier&nbsp;part.</span><br>
<span class="lineno">345</span><span class="comment" id="3552127">//&nbsp;It&nbsp;does&nbsp;not&nbsp;handle&nbsp;all&nbsp;the&nbsp;non-Latin&nbsp;letters,&nbsp;joiners,&nbsp;and&nbsp;combining&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="3552206">//&nbsp;but&nbsp;it&nbsp;does&nbsp;handle&nbsp;every&nbsp;codepoint&nbsp;that&nbsp;can&nbsp;occur&nbsp;in&nbsp;a&nbsp;numeric&nbsp;literal&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3552283">//&nbsp;a&nbsp;keyword.</span><br>
<span class="lineno"></span><span class="keyword" id="3552297">func</span>&nbsp;<span class="ident" id="3552302">isJSIdentPart</span><span class="op" id="3552315">(</span><span class="ident" id="3552316">r</span>&nbsp;<span class="builtintype" id="3552318">rune</span><span class="op" id="3552322">)</span>&nbsp;<span class="builtintype" id="3552324">bool</span>&nbsp;<span class="op" id="3552329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552332">switch</span>&nbsp;<span class="op" id="3552339">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552342">case</span>&nbsp;<span class="ident" id="3552347">r</span>&nbsp;<span class="op" id="3552349">==</span>&nbsp;<span class="string" id="3552352">&#39;$&#39;</span><span class="op" id="3552355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552359">return</span>&nbsp;<span class="builtintype" id="3552366">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552372">case</span>&nbsp;<span class="string" id="3552377">&#39;0&#39;</span>&nbsp;<span class="op" id="3552381">&lt;=</span>&nbsp;<span class="ident" id="3552384">r</span>&nbsp;<span class="op" id="3552386">&amp;&amp;</span>&nbsp;<span class="ident" id="3552389">r</span>&nbsp;<span class="op" id="3552391">&lt;=</span>&nbsp;<span class="string" id="3552394">&#39;9&#39;</span><span class="op" id="3552397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552401">return</span>&nbsp;<span class="builtintype" id="3552408">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552414">case</span>&nbsp;<span class="string" id="3552419">&#39;A&#39;</span>&nbsp;<span class="op" id="3552423">&lt;=</span>&nbsp;<span class="ident" id="3552426">r</span>&nbsp;<span class="op" id="3552428">&amp;&amp;</span>&nbsp;<span class="ident" id="3552431">r</span>&nbsp;<span class="op" id="3552433">&lt;=</span>&nbsp;<span class="string" id="3552436">&#39;Z&#39;</span><span class="op" id="3552439">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552443">return</span>&nbsp;<span class="builtintype" id="3552450">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552456">case</span>&nbsp;<span class="ident" id="3552461">r</span>&nbsp;<span class="op" id="3552463">==</span>&nbsp;<span class="string" id="3552466">&#39;_&#39;</span><span class="op" id="3552469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552473">return</span>&nbsp;<span class="builtintype" id="3552480">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552486">case</span>&nbsp;<span class="string" id="3552491">&#39;a&#39;</span>&nbsp;<span class="op" id="3552495">&lt;=</span>&nbsp;<span class="ident" id="3552498">r</span>&nbsp;<span class="op" id="3552500">&amp;&amp;</span>&nbsp;<span class="ident" id="3552503">r</span>&nbsp;<span class="op" id="3552505">&lt;=</span>&nbsp;<span class="string" id="3552508">&#39;z&#39;</span><span class="op" id="3552511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552515">return</span>&nbsp;<span class="builtintype" id="3552522">true</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3552528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552531">return</span>&nbsp;<span class="builtintype" id="3552538">false</span><br>
<span class="lineno"></span><span class="op" id="3552544">}</span>
</div>
</body>
</html>
